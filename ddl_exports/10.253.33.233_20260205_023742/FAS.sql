-- DDL Export
-- Server: 10.253.33.233
-- Database: FAS
-- Exported: 2026-02-05T02:37:50.640584

USE FAS;
GO

-- --------------------------------------------------
-- CHECK dbo.acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[acmast] ADD CONSTRAINT [CHKCONSCLTCODE] CHECK (isnull([CLTCODE],'')<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_ACCAT_AML] CHECK (ltrim(rtrim([ACCAT]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_ACNAME_AML] CHECK (ltrim(rtrim([ACNAME]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_ACTYP_AML] CHECK (ltrim(rtrim([ACTYP]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_BRANCHCODE_AML] CHECK (ltrim(rtrim([BRANCHCODE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_CLTCODE_AML] CHECK (ltrim(rtrim([CLTCODE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_GRPCODE_AML] CHECK (ltrim(rtrim([GRPCODE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_LONGNAME_AML] CHECK (ltrim(rtrim([LONGNAME]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_ACCAT_AML] CHECK ([ACCAT] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_ACNAME_AML] CHECK ([ACNAME] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_ACTYP_AML] CHECK ([ACTYP] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_BRANCHCODE_AML] CHECK ([BRANCHCODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_CLTCODE_AML] CHECK ([CLTCODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_GRPCODE_AML] CHECK ([GRPCODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_LONGNAME_AML] CHECK ([LONGNAME] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_TLOG
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_TLOG] ADD CONSTRAINT [ACMAST_DBACTION] CHECK ([DBACTION]='R' OR ([DBACTION]='D' OR ([DBACTION]='N' OR ([DBACTION]='A' OR ([DBACTION]='I' OR ([DBACTION]='E' OR ([DBACTION]='M' OR [DBACTION]='U')))))))

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_ACNAME_SL] CHECK (ltrim(rtrim([ACNAME]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_BOOKTYPE_SL] CHECK (ltrim(rtrim([BOOKTYPE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_CLTCODE_SL] CHECK (ltrim(rtrim([CLTCODE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_DRCR_SL] CHECK (ltrim(rtrim([DRCR]))='D' OR ltrim(rtrim([DRCR]))='C')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_EDT_SL] CHECK ([EDT]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_VDT_SL] CHECK ([VDT]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_VNO_SL] CHECK (ltrim(rtrim([VNO]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_ZERO_VTYP_SL] CHECK ([VTYP]<>(0))

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_ACNAME_SL] CHECK ([ACNAME] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_BOOKTYPE_SL] CHECK ([BOOKTYPE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_CLTCODE_SL] CHECK ([CLTCODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_EDT_SL] CHECK ([EDT] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_VDT_SL] CHECK ([VDT] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_VNO_SL] CHECK ([VNO] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_VTYP_SL] CHECK ([VTYP] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NON_BLANK_BOOKTYPE_L1] CHECK (ltrim(rtrim([BOOKTYPE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NON_BLANK_DRCR_L1] CHECK (ltrim(rtrim([DRCR]))='D' OR ltrim(rtrim([DRCR]))='C')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NON_BLANK_VNO_L1] CHECK (ltrim(rtrim([VNO]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NON_ZERO_VTYP_L1] CHECK ([VTYP]<>(0))

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NOT_NULL_BOOKTYPE_L1] CHECK ([BOOKTYPE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NOT_NULL_VNO_L1] CHECK ([VNO] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NOT_NULL_VTYP_L1] CHECK ([VTYP] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_BOOKTYPE_ML] CHECK (ltrim(rtrim([BOOKTYPE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_DRCR_ML] CHECK (ltrim(rtrim([DRCR]))='D' OR ltrim(rtrim([DRCR]))='C')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_MCLTCODE_SL] CHECK (ltrim(rtrim([MCLTCODE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_PARTYCODE_ML] CHECK (ltrim(rtrim([PARTY_CODE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_VDT_ML] CHECK ([VDT]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_VNO_ML] CHECK (ltrim(rtrim([VNO]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_VTYP_ML] CHECK ([VTYP]<>(0))

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_BOOKTYPE_ML] CHECK ([BOOKTYPE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_MCLTCODE_ML] CHECK ([MCLTCODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_PARTYCODE_ML] CHECK ([PARTY_CODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_VDT_ML] CHECK ([VDT] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_VNO_ML] CHECK ([VNO] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_VTYP_ML] CHECK ([VTYP] IS NOT NULL)

GO

-- --------------------------------------------------
-- FUNCTION dbo.fnMax
-- --------------------------------------------------
Create  Function [dbo].[fnMax](@Value1 money, @Value2 Money )   
Returns Money As  
Begin  
 Declare @Return Money  
 if @Value1  > @Value2  
  Begin  
   Set @Return =  @Value1   
  End  
 else  
  Begin  
   Set @Return =  @Value2  
  End  
 Return @Return  
  
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.fnMin
-- --------------------------------------------------
Create  Function [dbo].[fnMin](@Value1 money, @Value2 Money )   
Returns Money As  
Begin  
 Declare @Return Money  
 if @Value1  < @Value2  
  Begin  
   Set @Return =  @Value1   
  End  
 else  
  Begin  
   Set @Return =  @Value2  
  End  
 Return @Return  
  
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_SPLITSTRING
-- --------------------------------------------------

create  FUNCTION [dbo].[FUN_SPLITSTRING](
                @SPLITSTRING VARCHAR(8000),
                @DELIMITER   VARCHAR(3))
RETURNS @SPLITTED TABLE (
    [SNO] [INT] IDENTITY(1,1) NOT NULL, 
    [SPLITTED_VALUE] [VARCHAR](100) NOT NULL)

AS

/* Split the String and get splitted values in the result-set. Delimiter upto 3 characters long can be used for splitting */
BEGIN   
  DECLARE  @STRING         VARCHAR(8000),
           @POSITION       INT,
           @START_LOCATION INT,
           @STRING_LENGTH  INT
                           
  SET @STRING = @SPLITSTRING
                
  SET @POSITION = 0
                  
  SET @START_LOCATION = 0
                        
  SET @STRING_LENGTH = LEN(@STRING)
                       
  WHILE @STRING_LENGTH > 0
    BEGIN
    
      SET @POSITION = CHARINDEX(@DELIMITER,@STRING,@START_LOCATION)
                      
      IF @POSITION = 0
        BEGIN
          INSERT INTO @SPLITTED
          SELECT @STRING
                 
          SET @STRING_LENGTH = 0
                               
        END
      ELSE
        BEGIN
          INSERT INTO @SPLITTED
          SELECT LEFT(@STRING,@POSITION - 1)
                 
          SET @STRING = RIGHT(@STRING,@STRING_LENGTH - @POSITION)
                        
          SET @STRING_LENGTH = LEN(@STRING)
        END
        
    END

  RETURN 

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetGrouplevels
-- --------------------------------------------------
CREATE Function [dbo].[GetGrouplevels](@Group_code varchar(20)) returns integer
as
begin
	declare @@Group_code VARCHAR(20),
	@@lastGroup_code VARCHAR(20),
	@@Level int

	Set @@Group_code = @Group_code 
	Set @@lastGroup_code = @Group_code 

	Set @@Level = 1
	While ltrim(rtrim(@@Group_code))  <> ''
	begin

		select @@Group_code = Main_group from PLgroup_mstr 
		where Group_Code = @@lastGroup_code and group_code <> Main_group
		if ltrim(rtrim(@@Group_code)) <> ''
		begin
			Set @@Level = @@Level + 1
		end
		set @@lastGroup_code = @@Group_code
	end


	return @@Level
	

end

GO

-- --------------------------------------------------
-- FUNCTION dbo.REMOVE_ZERO
-- --------------------------------------------------
--SELECT .DBO.REMOVE_ZERO('234031230', '0')      
    
    
CREATE FUNCTION [dbo].[REMOVE_ZERO]      
(        
 @STRING NVARCHAR(4000),         
 @DELIMITER CHAR(1)      
)        
        
RETURNS VARCHAR(100)        
        
AS        
        
/*        
 RETURNS SPECIFIC ITEM        
 SELECT * FROM SPLIT_SP('A/BODY/CAT', '/', 0)        
*/        
        
BEGIN        
 DECLARE @INDEX INT        
 DECLARE @COUNTER TINYINT    
    
 SELECT @INDEX = 1    
 SELECT @COUNTER = LEN(@STRING)     
       
 IF @STRING IS NULL RETURN '0'        
    
 WHILE @COUNTER > 2    
 BEGIN    
  -- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT_SP CHARACTER        
  SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)        
  -- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE        
  IF @INDEX = 1    
  BEGIN    
   SELECT @STRING = RIGHT(@STRING, LEN(@STRING) - 1)    
  END    
  ELSE    
  BEGIN    
   RETURN @STRING        
   BREAK             
  END    
  SELECT @COUNTER = @COUNTER - 1    
 END    
 RETURN '0'     
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.ReplaceServerName
-- --------------------------------------------------


Create   Function [dbo].[ReplaceServerName](@ServerName  Varchar(100)) 
Returns Varchar(100) As
Begin
	Select @ServerName = Replace(Replace(@ServerName,'[',''),']','')   

Return @ServerName 
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ReplaceTradeNo
-- --------------------------------------------------
CREATE Function [dbo].[ReplaceTradeNo](@TradeNo  Varchar(16))   
Returns Varchar(16) As  
Begin  
declare @Flag Varchar(1)  
  
 Select @Flag = '0'  
 while @Flag <> '1'  
 Begin  
  Select @Flag = Left(Upper(@TradeNo),1)  
  if @Flag >= 'A' And @Flag <= 'Z'  
   Select @TradeNo = Replace(@TradeNo, @Flag, '')  
  Else  
   Select @Flag = '1'  
 End  
Return @TradeNo   
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.RoundedToThousand
-- --------------------------------------------------
CREATE Function [dbo].[RoundedToThousand](@Amt Numeric(18,4))  
Returns Numeric(18,4)  
As  
Begin    
if @Amt > 0    
 select @Amt = ((convert(numeric(18,2),@Amt/10000) - Right(convert(numeric(18,2),@Amt/10000),3))+1)*10000  
Else   
 select @Amt = @Amt  
  
Return @Amt   
  
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.RoundedTurnover
-- --------------------------------------------------


CREATE   Function [dbo].[RoundedTurnover](@Amt Numeric(18,4), @roundingAmt Numeric(18,4))
Returns Numeric(18,4)
As
Begin  
	if @Amt > 0 AND @roundingAmt > 0 
		Select @Amt = (Case When @Amt - Convert(BigInt,@Amt/@roundingAmt)*@roundingAmt = 0 
		                    Then @Amt 
				    Else (Convert(BigInt,@Amt/@roundingAmt)+1)*@roundingAmt 
			       End)
	Else 
		select @Amt = @Amt
	
	Return @Amt
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.SPLIT_SP
-- --------------------------------------------------
CREATE FUNCTION [dbo].[SPLIT_SP]
(
	@STRING NVARCHAR(4000), 
	@DELIMITER CHAR(1),
	@COUNTER_SP TINYINT
)

RETURNS @RESULTS  TABLE (ITEMS NVARCHAR(4000))

AS

/*
	RETURNS SPECIFIC ITEM
	SELECT * FROM SPLIT_SP('A/BODY/CAT', '/', 0)
*/

BEGIN
    DECLARE @INDEX INT
    DECLARE @SLICE NVARCHAR(4000)
	 DECLARE @COUNTER TINYINT
	 SET @COUNTER = 0
    SELECT @INDEX = 1
    IF @STRING IS NULL RETURN
    WHILE @INDEX !=0

        BEGIN	
        	-- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT_SP CHARACTER
        	SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)
        	-- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE
        	IF @INDEX !=0
				IF @COUNTER = @COUNTER_SP
				BEGIN
        			SELECT @SLICE = LEFT(@STRING,@INDEX - 1)
					-- PUT THE ITEM INTO THE RESULTS SET
		        	INSERT INTO @RESULTS(ITEMS) VALUES(@SLICE)
					BREAK					
				END
				ELSE
					SELECT @SLICE = @STRING
        	ELSE
				BEGIN
	        		SELECT @SLICE = @STRING
					-- PUT THE ITEM INTO THE RESULTS SET
			      INSERT INTO @RESULTS(ITEMS) VALUES(@SLICE)
				END
        	
        	-- CHOP THE ITEM REMOVED OFF THE MAIN STRING
        	SELECT @STRING = RIGHT(@STRING,LEN(@STRING) - @INDEX)
        	-- BREAK OUT IF WE ARE DONE
        	IF LEN(@STRING) = 0 BREAK
			SET @COUNTER = @COUNTER + 1
    END
    RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.SPLIT_SP1
-- --------------------------------------------------
CREATE FUNCTION [dbo].[SPLIT_SP1]
(
	@STRING NVARCHAR(4000), 
	@DELIMITER CHAR(1),
	@COUNTER_SP TINYINT
)

RETURNS VARCHAR(100)

AS

/*
	RETURNS SPECIFIC ITEM
	SELECT * FROM SPLIT_SP('A/BODY/CAT', '/', 0)
*/

BEGIN
    DECLARE @INDEX INT
    DECLARE @SLICE NVARCHAR(4000)
	 DECLARE @COUNTER TINYINT
	 SET @COUNTER = 0
    SELECT @INDEX = 1
    IF @STRING IS NULL RETURN '123'
    WHILE @INDEX !=0

        BEGIN	
        	-- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT_SP CHARACTER
        	SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)
        	-- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE
        	IF @INDEX !=0
			IF @COUNTER = @COUNTER_SP
				BEGIN
        			SELECT @SLICE = LEFT(@STRING,@INDEX - 1)
					-- PUT THE ITEM INTO THE RESULTS SET
		        	--INSERT INTO @RESULTS(ITEMS) VALUES(@SLICE)
				RETURN @SLICE
					BREAK					
				END
				ELSE
				BEGIN
					SELECT @SLICE = @STRING
				END
        	ELSE
				BEGIN
	        		SELECT @SLICE = @STRING
				RETURN @SLICE
					BREAK					
					-- PUT THE ITEM INTO THE RESULTS SET
--			      INSERT INTO @RESULTS(ITEMS) VALUES(@SLICE)
				END
        	
        	-- CHOP THE ITEM REMOVED OFF THE MAIN STRING
        	SELECT @STRING = RIGHT(@STRING,LEN(@STRING) - @INDEX)
        	-- BREAK OUT IF WE ARE DONE
        	IF LEN(@STRING) = 0 BREAK
			SET @COUNTER = @COUNTER + 1
    END
    RETURN ''
END

GO

-- --------------------------------------------------
-- INDEX dbo.accountscategory
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Cat_clt] ON [dbo].[accountscategory] ([Cltcode], [Category])

GO

-- --------------------------------------------------
-- INDEX dbo.Bankreco
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Bnkrco] ON [dbo].[Bankreco] ([Amount], [Drcr], [Referenceno], [Micrno])

GO

-- --------------------------------------------------
-- INDEX dbo.Bankreco
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [RecoIDx] ON [dbo].[Bankreco] ([Cltcode], [Amount], [Drcr], [Micrno], [Referenceno])

GO

-- --------------------------------------------------
-- INDEX dbo.Billmatch
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [vnoidx] ON [dbo].[Billmatch] ([Vno], [Vtype], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Category
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Cat] ON [dbo].[Category] ([Catcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableIndex] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableListing] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.Costmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [cstinx] ON [dbo].[Costmast] ([Costname], [Costcode], [Catcode])

GO

-- --------------------------------------------------
-- INDEX dbo.grpmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Grpcode] ON [dbo].[grpmast] ([Grpcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [LED2IND] ON [dbo].[Ledger] ([Vdt], [Vno], [Vtyp])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ledger3] ON [dbo].[Ledger] ([Vtyp], [Vno], [Lno], [Vdt], [Cltcode], [Booktype], [Drcr], [Acname])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ledger5] ON [dbo].[Ledger] ([Vdt], [Vtyp], [Edt], [Drcr], [Vamt], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ledind] ON [dbo].[Ledger] ([Vno], [Vtyp], [Vdt], [Cltcode], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Partyvdt] ON [dbo].[Ledger] ([Vno], [Vtyp], [Booktype], [Vdt], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxldgr] ON [dbo].[Ledger1] ([Vtyp], [Vno], [Booktype], [Lno], [Ddno])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [vnoidx] ON [dbo].[Ledger1] ([Vno], [Vtyp], [Booktype], [Drcr], [Relamt], [Ddno], [Slipno], [Micrno], [Refno], [Reldt], [Dddt])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Vtypno] ON [dbo].[Ledger1] ([Vno], [Vtyp], [Booktype], [Drcr], [Ddno], [Relamt], [Micrno], [Slipno])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [cltcode] ON [dbo].[Ledger2] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Led2] ON [dbo].[Ledger2] ([Vno], [Vtype], [Booktype], [Lno], [Drcr])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [typeno] ON [dbo].[Ledger2] ([Vno], [Vtype], [Booktype], [Lno], [Costcode], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [vno] ON [dbo].[Ledger2] ([Vno], [Vtype], [Drcr], [Booktype], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger3
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ld3] ON [dbo].[ledger3] ([Vno], [Vtyp], [Naratno], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger3
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Ledger314] ON [dbo].[ledger3] ([Vtyp])

GO

-- --------------------------------------------------
-- INDEX dbo.Marginledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [KLED] ON [dbo].[Marginledger] ([Vno], [Vtyp], [Vdt], [Party_code], [Drcr])

GO

-- --------------------------------------------------
-- INDEX dbo.Parameter
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Curyear] ON [dbo].[Parameter] ([Curyear])

GO

-- --------------------------------------------------
-- INDEX dbo.Parameter
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [SDTCUR] ON [dbo].[Parameter] ([Sdtcur], [Ldtcur])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_GLReport
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Partyvdt] ON [dbo].[Tbl_GLReport] ([vno], [vtyp], [booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [billtypeidx] ON [dbo].[Tempbilldetails] ([Billvtype])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [drcridx] ON [dbo].[Tempbilldetails] ([Drcr])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [excidx] ON [dbo].[Tempbilldetails] ([Exchange])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [partycdidx] ON [dbo].[Tempbilldetails] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [sessionidx] ON [dbo].[Tempbilldetails] ([Sessionid], [Vtype], [Booktype], [Billvno])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_ACCOUNTBALANCES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [_dta_index_V2_ACCOUNTBALANCES_5_310292165__K4_K1_K2_K3_6_7] ON [dbo].[V2_ACCOUNTBALANCES] ([VDT], [CLTCODE], [SEGMENTCODE], [LEDTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_ACCOUNTBALANCES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [_dta_index_V2_ACCOUNTBALANCES_5_310292165__K5_K4_K1_K2_K3_6_7] ON [dbo].[V2_ACCOUNTBALANCES] ([EDT], [VDT], [CLTCODE], [SEGMENTCODE], [LEDTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_FOUT_LEDGERBALANCES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [FoutIdx] ON [dbo].[V2_FOUT_LEDGERBALANCES] ([Party_Code], [Family_Code], [Branch_Code], [Trader], [SubBroker_Code], [Area_Code], [Region_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_INTEREST
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [_dta_index_V2_INTEREST_5_342292279__K10_1_6_9] ON [dbo].[V2_INTEREST] ([INTDATE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_INTEREST
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [MAINIDX] ON [dbo].[V2_INTEREST] ([INTDATE], [CLTCODE], [SEGMENTCODE], [LEDTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LastVno
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [VNoIdx] ON [dbo].[V2_LastVno] ([Vtyp], [Booktype], [Vdt], [VnoFlag], [FinYear])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Offline_Ledger_Entries
-- --------------------------------------------------
CREATE CLUSTERED INDEX [V2_Offline_Ledger_Entries1] ON [dbo].[V2_Offline_Ledger_Entries] ([ApprovalFlag], [RowState], [VoucherNo])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_RUNNINGBALANCES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [MAINIDX] ON [dbo].[V2_RUNNINGBALANCES] ([BALDATE], [CLTCODE], [SEGMENTCODE], [LEDTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_RUNNINGBALANCES_TMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [MAINIDX] ON [dbo].[V2_RUNNINGBALANCES_TMP] ([BALDATE], [CLTCODE], [SEGMENTCODE], [LEDTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.Vmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Typedesc] ON [dbo].[Vmast] ([Vtype], [Vdesc])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[acmast] ADD CONSTRAINT [PK_acmast] PRIMARY KEY ([cltcode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [PK_ACMAST_LEDGER] PRIMARY KEY ([CLTCODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Branchaccounts
-- --------------------------------------------------
ALTER TABLE [dbo].[Branchaccounts] ADD CONSTRAINT [Pk_branchaccounts] PRIMARY KEY ([Branchname])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Branches
-- --------------------------------------------------
ALTER TABLE [dbo].[Branches] ADD CONSTRAINT [Pk_Branches] PRIMARY KEY ([Short_Name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CANNED_LEDGERBALANCE
-- --------------------------------------------------
ALTER TABLE [dbo].[CANNED_LEDGERBALANCE] ADD CONSTRAINT [PK_CANNED_LEDGERBALANCE] PRIMARY KEY ([CLTCODE], [ENTRYTYPE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Client_Brok_Details
-- --------------------------------------------------
ALTER TABLE [dbo].[Client_Brok_Details] ADD CONSTRAINT [PK_Client_Brok_Details] PRIMARY KEY ([Cl_Code], [Exchange], [Segment])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Client_Details
-- --------------------------------------------------
ALTER TABLE [dbo].[Client_Details] ADD CONSTRAINT [PK_Client_Details] PRIMARY KEY ([cl_code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.client1
-- --------------------------------------------------
ALTER TABLE [dbo].[client1] ADD CONSTRAINT [PK_client1] PRIMARY KEY ([Cl_Code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.client2
-- --------------------------------------------------
ALTER TABLE [dbo].[client2] ADD CONSTRAINT [PK_client2_1] PRIMARY KEY ([Party_code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Clientmaster
-- --------------------------------------------------
ALTER TABLE [dbo].[Clientmaster] ADD CONSTRAINT [Pk_Clientmaster] PRIMARY KEY ([Party_Code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [PK_Ledger] PRIMARY KEY ([Vtyp], [Vno], [Lno], [Booktype])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.SettPayout
-- --------------------------------------------------
ALTER TABLE [dbo].[SettPayout] ADD CONSTRAINT [PK_SettPayout] PRIMARY KEY ([SrNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Subbrokers
-- --------------------------------------------------
ALTER TABLE [dbo].[Subbrokers] ADD CONSTRAINT [Pk_Subbrokers] PRIMARY KEY ([Sub_Broker])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_AGEINGDATA
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_AGEINGDATA] ADD CONSTRAINT [PK_V2_AGEINGDATA] PRIMARY KEY ([BALDATETYPE], [CLTCODE], [SEGMENTCODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_AGEINGFINAL
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_AGEINGFINAL] ADD CONSTRAINT [PK_V2_AGEINGFINAL] PRIMARY KEY ([BALDATETYPE], [CLTCODE], [SEGMENTCODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_LastVno
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_LastVno] ADD CONSTRAINT [PK_V2_LastVno] PRIMARY KEY ([FldAuto])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_SETTPAYOUT_ALL
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_SETTPAYOUT_ALL] ADD CONSTRAINT [PK_V2_SETTPAYOUT_ALL] PRIMARY KEY ([SRNO])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_acwisereport
-- --------------------------------------------------
Create Proc [dbo].[Acc_acwisereport]
@Reptype Varchar(7), 
@Grplen Tinyint, 
@Grpcode Varchar(10), 
@Fdate Varchar(11), 
@Tdate Varchar(11), 
@Faccode Varchar(10), 
@Taccode Varchar(10), 
@Costcode Smallint
As
Declare 
@@Grpchars As Int
Select @@Grpchars = (Select Len(Rtrim(@Grpcode)) )
If Len(Rtrim(@Faccode)) = 0
Begin
   Select @Faccode = ( Select Min(Cltcode) From Acmast )
End
If Len(Rtrim(@Taccode)) = 0
Begin
   Select @Taccode = ( Select Max(Cltcode) From Acmast )
End
If Rtrim(@Reptype) = 'Account'
Begin
   If @Grplen = 0 
      Begin
 Select L2.Cltcode, A.Acname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Ledger L
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59' And Accat = 3
        And L2.Cltcode > = @Faccode And L2.Cltcode < = @Taccode
 Group By L2.Cltcode, A.Acname
 Order By L2.Cltcode, A.Acname
      End
   Else
   If @Grplen = 2
   Begin
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C, Category Cc
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And L2.Cltcode = Rtrim(@Faccode)
 Group By Category, Left(Grpcode, @Grplen)
 Order By Category, Left(Grpcode, @Grplen)
   End
   Else
   If @Grplen = 10
      Begin
 Select L2.Costcode, Costname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Grpcode Like Rtrim(@Grpcode)+'%'
        And L2.Cltcode > = @Faccode And L2.Cltcode < = @Taccode
 Group By L2.Costcode, Costname
 Order By L2.Costcode, Costname
      End
   Else   
      Begin
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C, Category Cc
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And Left(Grpcode, 2) = Rtrim(@Grpcode)
 And L2.Cltcode = Rtrim(@Faccode)
 Group By Category, Left(Grpcode, @Grplen)
 Order By Category, Left(Grpcode, @Grplen)
     End
End
Else
Begin
 Select Vdate = Convert(Varchar, L.Vdt, 103) , Shortdesc, L2.Vtype, L2.Booktype, L2.Vno, L2.Lno, 
 L2.Cltcode, A.Acname, L2.Drcr, L2.Camt, L.Narration, 
 Chqno = Isnull((Select Ddno From Ledger1 L1 Where L1.Vtyp = L2.Vtype And L1.Booktype = L2.Booktype And L1.Vno = L2.Vno And L1.Lno = L2.Lno), '')
 From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Ledger L, Vmast V
 Where L2.Cltcode = Rtrim(@Faccode) And  L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate + ' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = @Costcode And L2.Vtype = V.Vtype
 Order By L2.Cltcode, A.Acname
End
/*
Else
   Begin
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C, Category Cc
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And Left(Grpcode, 2) = Rtrim(@Grpcode)
 Group By Category, Left(Grpcode, @Grplen)
 Order By Category, Left(Grpcode, @Grplen)
   End
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_addacmast1
-- --------------------------------------------------
Create Procedure [dbo].[Acc_addacmast1] As   
Select Grpname, Grpcode , Grpmain ,   
Maingrpname = (Case   
  When  Left(Grpmain, 2) = 'A0' Then (Select Grpname From Grpmast Where Grpcode = 'A0000000000')   
         Else  
          (Case When  Left(Grpmain, 2) = 'L0' Then (Select Grpname From Grpmast Where Grpcode = 'L0000000000')    
   Else   
    (Case When  Left(Grpmain, 2) = 'N0' Then (Select Grpname From Grpmast Where Grpcode = 'N0000000000')  
    Else   
     (Case When  Left(Grpmain, 2) = 'X0' Then (Select Grpname From Grpmast Where Grpcode = 'X0000000000')  
      End)  
      End)     
    End )   
      End)  
From Grpmast Order By Grpcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_BankSlipReprint
-- --------------------------------------------------
/*Cahnged by amit to display the acname and accode */       
/****** Object:  Stored Procedure dbo.acc_BankSlipReprint    Script Date: 04/07/2003 12:28:25 PM ******/      
/****** Object:  Stored Procedure dbo.BankSlipReprint    Script Date: 10/16/2002 4:40:54 PM ******/      
CREATE proc [dbo].[acc_BankSlipReprint]      
@cltcode  varchar(10),      
@booktype varchar(2),      
@startslip int,      
@endslip int
As      
      
/*      
select  SlipNo, ddno, slipdate, acname, bnkname, brnname, relamt, cltcode, l1.vno, l1.lno      
from ledger l , ledger1 l1       
where l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype = l1.booktype  and l.vtyp in ( '2', '19')      
and l.booktype = @booktype and slipno >= @startslip and slipno <= @endslip and l.cltcode = @cltcode      
order By SlipNo, Slipdate, l1.vno, l1.lno      
*/      
      
select  SlipNo, ddno, slipdate, acname, bnkname, brnname, relamt, cltcode, l1.vno, l1.lno      
from ledger l , ledger1 l1       
where l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype = l1.booktype  and l.vtyp in ( '2', '19')      
and l.booktype = @booktype and slipno >= @startslip and slipno <= @endslip and l.cltcode <> @cltcode      
and l.vno in  (select vno from ledger l2 where  cltcode =@cltcode and l.vtyp=l2.vtyp and l.booktype = l2.booktype )      
order By SlipNo, Slipdate, l1.vno, l1.lno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_CANNEDMONEYPAYOUT_FN
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[ACC_CANNEDMONEYPAYOUT_FN]  
 @SDATE VARCHAR(11),  
 @STATUSNAME VARCHAR(30),  
 @BANKCODE VARCHAR(10),  
 @BOOKTYPE VARCHAR(2),  
 @PAYMODE VARCHAR(1),  
 @LDATE VARCHAR(11),  
 @DISPLAY VARCHAR(1) = 'A',  
 @DISPREC VARCHAR(5) = 'ALL',  
 @FCODE VARCHAR(10) = '0000000000',  
 @TCODE VARCHAR(10) = 'ZZZZZZZZZZ',  
 @FILTER TINYINT = 0,  
 @FORNEXT TINYINT = 0  
AS  
/*  
 EXEC ACC_CANNEDMONEYPAYOUT 'APR  1 2006', 'ARSL', '1111111', '01', '', 'MAR 31 2007', 'A', 'ALL', '0', 'ZZZ', 2  
 EXEC ACC_CANNEDMONEYPAYOUT 'Apr 1 2006', 'ebroking', '1111111', '', '', 'Mar 31 2007', 'A', '100', '0', 'z', 2  
*/  
DECLARE  
 @@LDATE AS VARCHAR(11),  
 @@SQL AS VARCHAR(2000)  
 SET NOCOUNT ON  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  

/*===================================================================================================
	START :: PATCH ADDED FOR ENABLING AREA LOGIN REQUEST
===================================================================================================*/
IF UPPER(@STATUSNAME) <> 'BROKER'  
BEGIN  
	SELECT BRANCH_CODE INTO #BRANCH FROM BRANCH WHERE 1=2
	
	IF (SELECT COUNT(1) FROM BRANCH WHERE BRANCH_CODE = @STATUSNAME) <> 0 
	BEGIN
		INSERT INTO #BRANCH SELECT @STATUSNAME 
	END
	ELSE
	BEGIN
		INSERT INTO #BRANCH SELECT BRANCH_CODE FROM AREA WHERE AREACODE = @STATUSNAME
	END
END
/*===================================================================================================
	END :: PATCH ADDED FOR ENABLING AREA LOGIN REQUEST
===================================================================================================*/

IF UPPER(@STATUSNAME) = 'BROKER'  
 BEGIN  
  IF CONVERT(DATETIME,@LDATE + ' 23:59:59' ) >= GETDATE()  
   BEGIN  
    SELECT @@SQL = "DELETE FROM HOPAYOUT WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "INSERT INTO HOPAYOUT "  
    SELECT @@SQL = @@SQL + "SELECT    "  
    IF @DISPREC <> 'ALL'  
     BEGIN  
      SELECT @@SQL = @@SQL + " TOP " + @DISPREC + " "  
     END  
    SELECT @@SQL = @@SQL + " L.CLTCODE,    "  
    SELECT @@SQL = @@SQL + " ACNAME = (A.LONGNAME),    "  
    SELECT @@SQL = @@SQL + " CHEQUENAME =A.LONGNAME,    "  
    SELECT @@SQL = @@SQL + " A.BRANCHCODE,    "  
    SELECT @@SQL = @@SQL + " A.ACCAT,    "  
    SELECT @@SQL = @@SQL + " A.BTOBPAYMENT,    "  
    SELECT @@SQL = @@SQL + " EFFECTIVEBALANCE = SUM(CASE WHEN EDT <= LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59'  AND    "  
    SELECT @@SQL = @@SQL + "       EDT >='" + @SDATE  + "' THEN  (CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN DRCR = 'D' THEN VAMT ELSE - VAMT END END) ELSE 0 END ),    "  
    SELECT @@SQL = @@SQL + " LEDGERBALANCE = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE - VAMT END),    "  
    SELECT @@SQL = @@SQL + " BILLAMT = SUM(CASE WHEN (EDT LIKE LEFT(CONVERT(VARCHAR,GETDATE(),109),11) +'%'  AND L.VTYP='15') THEN    "  
    SELECT @@SQL = @@SQL + "    (CASE WHEN DRCR = 'D' THEN 0 ELSE - VAMT END) ELSE 0 END ),    "  
    SELECT @@SQL = @@SQL + " FUTUREPAYOUT =0,    "  
    SELECT @@SQL = @@SQL + " SHORTAGE=0,    "  
    SELECT @@SQL = @@SQL + " AMOUNTTOBEPAID = ISNULL(AMOUNTTOBEPAID,0), "  
    SELECT @@SQL = @@SQL + " SNO = ISNULL(P.SNO, 0),  "  
    SELECT @@SQL = @@SQL + " PAYMODE = ISNULL(A.PAYMODE, ''),  "  
    SELECT @@SQL = @@SQL + " EXPAY = 0, "  
    SELECT @@SQL = @@SQL + " SPID = @@SPID  "  
    SELECT @@SQL = @@SQL + "FROM    "  
    SELECT @@SQL = @@SQL + " PAYMENTMARKING P WITH(INDEX(MONEYPAYOUTIDX)),    "  
    SELECT @@SQL = @@SQL + " LEDGER L (NOLOCK) ,ACMAST A (NOLOCK)    "  
    SELECT @@SQL = @@SQL + "WHERE    "  
    SELECT @@SQL = @@SQL + " A.CLTCODE = P.CLTCODE    "  
    SELECT @@SQL = @@SQL + " AND P.CLTCODE = L.CLTCODE    "  
    SELECT @@SQL = @@SQL + "  AND P.CLTCODE BETWEEN '" + @FCODE + "' AND '" + @TCODE + "' "  
    SELECT @@SQL = @@SQL + " AND HOAPPROVAL = '0'    "  
    SELECT @@SQL = @@SQL + " AND VDT >= '" + @SDATE + "'    "  
    SELECT @@SQL = @@SQL + " AND VDT <= LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59'    "  
    SELECT @@SQL = @@SQL + " AND A.PAYMODE LIKE '" + @PAYMODE + "%'    "  
    SELECT @@SQL = @@SQL + " AND A.POBANKCODE = '" + @BANKCODE + "'    "  
    SELECT @@SQL = @@SQL + " AND PAYMENTDATE LIKE LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + '%'    "  
    IF @DISPLAY = 'B'  
     BEGIN  
      SELECT @@SQL = @@SQL + " AND A.BTOBPAYMENT = '1'    "  
     END  
    ELSE IF @DISPLAY = 'N'  
     BEGIN  
      SELECT @@SQL = @@SQL + " AND A.BTOBPAYMENT <> '1'    "  
     END  
    SELECT @@SQL = @@SQL + "GROUP BY    "  
    SELECT @@SQL = @@SQL + " L.CLTCODE,    "  
    SELECT @@SQL = @@SQL + "A.LONGNAME,    "  
    SELECT @@SQL = @@SQL + " A.LONGNAME,    "  
    SELECT @@SQL = @@SQL + " A.BRANCHCODE,    "  
    SELECT @@SQL = @@SQL + " A.ACCAT,    "  
    SELECT @@SQL = @@SQL + " A.BTOBPAYMENT,    "  
    SELECT @@SQL = @@SQL + " ISNULL(AMOUNTTOBEPAID,0), "  
    SELECT @@SQL = @@SQL + " ISNULL(P.SNO, 0), "  
    SELECT @@SQL = @@SQL + " ISNULL(A.PAYMODE, '')  "  
   END  
  ELSE  
   BEGIN  
    SELECT @@SQL = "DELETE FROM HOPAYOUT WHERE SPID = @@SPID  "  
    SELECT @@SQL = @@SQL + "INSERT INTO HOPAYOUT "  
    SELECT @@SQL = @@SQL + "SELECT     "  
    IF @DISPREC <> 'ALL'  
     BEGIN  
      SELECT @@SQL = @@SQL + " TOP " + @DISPREC + " "  
     END  
    SELECT @@SQL = @@SQL + " L.CLTCODE,     "  
    SELECT @@SQL = @@SQL + " ACNAME = (A.LONGNAME),     "  
    SELECT @@SQL = @@SQL + " CHEQUENAME = A.LONGNAME,     "  
    SELECT @@SQL = @@SQL + " A.BRANCHCODE,     "  
    SELECT @@SQL = @@SQL + " A.ACCAT,     "  
    SELECT @@SQL = @@SQL + " A.BTOBPAYMENT,     "  
    SELECT @@SQL = @@SQL + " EFFECTIVEBALANCE = SUM(CASE WHEN EDT <= '" + @LDATE + "' + ' 23:59'  AND     "  
    SELECT @@SQL = @@SQL + "       EDT >= '" + @SDATE + "'  THEN  (CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN DRCR = 'D' THEN VAMT ELSE - VAMT END END) ELSE 0 END ),     "  
    SELECT @@SQL = @@SQL + " LEDGERBALANCE = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE - VAMT END),     "  
    SELECT @@SQL = @@SQL + " BILLAMT = SUM(CASE WHEN (EDT LIKE '" + @LDATE + "%'  AND L.VTYP='15') THEN     "  
    SELECT @@SQL = @@SQL + "    (CASE WHEN DRCR = 'D' THEN 0 ELSE - VAMT END) ELSE 0 END),     "  
    SELECT @@SQL = @@SQL + " FUTUREPAYOUT = 0,     "  
    SELECT @@SQL = @@SQL + " SHORTAGE = 0,     "  
    SELECT @@SQL = @@SQL + " AMOUNTTOBEPAID = ISNULL(AMOUNTTOBEPAID,0),     "  
    SELECT @@SQL = @@SQL + " PAYMODE = ISNULL(A.PAYMODE, ''),  "  
    SELECT @@SQL = @@SQL + " EXPAY = 0 "  
    SELECT @@SQL = @@SQL + "FROM     "  
    SELECT @@SQL = @@SQL + " PAYMENTMARKING P WITH(INDEX(MONEYPAYOUTIDX)),     "  
    SELECT @@SQL = @@SQL + " LEDGER L (NOLOCK),     "  
    SELECT @@SQL = @@SQL + " ACMAST A  (NOLOCK)     "  
    SELECT @@SQL = @@SQL + "WHERE     "  
    SELECT @@SQL = @@SQL + " A.CLTCODE = P.CLTCODE     "  
    SELECT @@SQL = @@SQL + " AND P.CLTCODE = L.CLTCODE     "  
    SELECT @@SQL = @@SQL + "  AND P.CLTCODE BETWEEN '" + @FCODE + "' AND '" + @TCODE + "' "  
    SELECT @@SQL = @@SQL + " AND HOAPPROVAL = '0'     "  
    SELECT @@SQL = @@SQL + " AND VDT >='" + @SDATE + "'     "  
    SELECT @@SQL = @@SQL + " AND VDT <='" + @LDATE + " 23:59'     "  
    SELECT @@SQL = @@SQL + " AND A.PAYMODE LIKE '" + @PAYMODE + "%'     "  
    SELECT @@SQL = @@SQL + " AND A.POBANKCODE = '" + @BANKCODE + "'     "  
    SELECT @@SQL = @@SQL + " AND PAYMENTDATE LIKE '" + @LDATE + "%'     "  
    IF @DISPLAY = 'B'  
     BEGIN  
      SELECT @@SQL = @@SQL + " AND A.BTOBPAYMENT = '1'    "  
     END  
    ELSE IF @DISPLAY = 'N'  
     BEGIN  
      SELECT @@SQL = @@SQL + " AND A.BTOBPAYMENT <> '1'    "  
     END  
    SELECT @@SQL = @@SQL + "GROUP BY     "  
    SELECT @@SQL = @@SQL + " L.CLTCODE,     "  
    SELECT @@SQL = @@SQL + " L.LONGNAME,     "  
    SELECT @@SQL = @@SQL + " A.LONGNAME,     "  
    SELECT @@SQL = @@SQL + " A.BRANCHCODE,     "  
    SELECT @@SQL = @@SQL + " A.ACCAT,     "  
    SELECT @@SQL = @@SQL + " A.BTOBPAYMENT,     "  
    SELECT @@SQL = @@SQL + " ISNULL(AMOUNTTOBEPAID,0),     "  
    SELECT @@SQL = @@SQL + " ISNULL(A.PAYMODE, '')  "  
   END  
--  PRINT @@SQL  
  EXEC (@@SQL)  
  SELECT  
   L.CLTCODE,  
   EFFECTIVEREV = SUM(CASE WHEN L.DRCR = 'D' THEN -L.VAMT ELSE L.VAMT END)  
  INTO  
   #HOPAYOUT  
  FROM  
   HOPAYOUT H,  
   LEDGER L  
  WHERE  
   H.CLTCODE = L.CLTCODE  
   AND L.VDT < @SDATE  
   AND L.EDT >= @SDATE  
   AND L.EDT <= @LDATE + ' 23:59'  
   AND H.SPID = @@SPID  
  GROUP BY  
   L.CLTCODE  
  
  UPDATE H SET EFFECTIVEBALANCE = EFFECTIVEBALANCE - HH.EFFECTIVEREV FROM HOPAYOUT H, #HOPAYOUT HH WHERE H.CLTCODE = HH.CLTCODE AND H.SPID = @@SPID  
  
  SELECT @@SQL = "UPDATE HOPAYOUT SET EXPAY = 1 WHERE AMOUNTTOBEPAID > ABS(EFFECTIVEBALANCE) AND AMOUNTTOBEPAID > ABS(LEDGERBALANCE) AND AMOUNTTOBEPAID > ABS(BILLAMT) AND SPID = @@SPID "  
  EXEC (@@SQL)  
  SELECT @@SQL = "SELECT * FROM HOPAYOUT WHERE SPID = @@SPID ORDER BY EXPAY, CLTCODE, BRANCHCODE"  
  EXEC (@@SQL)  
  SELECT @@SQL = "DELETE FROM HOPAYOUT WHERE SPID = @@SPID "  
  EXEC (@@SQL)  
 END  
ELSE  
 BEGIN  
  IF CONVERT(DATETIME,@LDATE + ' 23:59:59' ) >= GETDATE()  
   BEGIN  
    SELECT @@LDATE = CONVERT(VARCHAR(11), GETDATE(), 109)  
   END  
  ELSE  
   BEGIN  
    SELECT @@LDATE = @LDATE  
   END  
  SELECT @@SQL = "SELECT "  
  IF @DISPREC <> 'ALL'  
   BEGIN  
    SELECT @@SQL = @@SQL + " TOP " + @DISPREC + " "  
   END  
   SELECT @@SQL = @@SQL + "  F.CLTCODE,    "  
   SELECT @@SQL = @@SQL + "  F.ACNAME,    "  
   SELECT @@SQL = @@SQL + "  F.CHEQUENAME,    "  
   SELECT @@SQL = @@SQL + "  F.BRANCHCODE,    "  
   SELECT @@SQL = @@SQL + "  F.ACCAT,    "  
   SELECT @@SQL = @@SQL + "  F.BTOBPAYMENT,    "  
   SELECT @@SQL = @@SQL + "  EFFECTIVEBALANCE = ROUND(F.EFFECTIVEBALANCE, 2),    "  
   SELECT @@SQL = @@SQL + "  LEDGERBALANCE = ROUND(F.LEDGERBALANCE, 2),    "  
   SELECT @@SQL = @@SQL + "  F.BILLAMT,    "  
   SELECT @@SQL = @@SQL + "  F.FUTUREPAYOUT,    "  
   SELECT @@SQL = @@SQL + "  F.SHORTAGE,    "  
   SELECT @@SQL = @@SQL + "  AMOUNTTOBEPAID = ISNULL(P.AMOUNTTOBEPAID, 0), "  
   SELECT @@SQL = @@SQL + "  SNO = ISNULL(P.SNO, 0), "  
   SELECT @@SQL = @@SQL + "  EXPAY = 0 "  
   SELECT @@SQL = @@SQL + " FROM    "  
   SELECT @@SQL = @@SQL + "  FILLED_MONEYPAYOUT F LEFT OUTER JOIN PAYMENTMARKING P WITH(INDEX(MONEYPAYOUTIDX))    "  
   SELECT @@SQL = @@SQL + "  ON ( F.CLTCODE = P.CLTCODE    "  
   SELECT @@SQL = @@SQL + "  AND P.HOAPPROVAL = '0' "  
   SELECT @@SQL = @@SQL + "  AND CONVERT(VARCHAR(11), P.PAYMENTDATE, 109) = '" + @@LDATE + "') "  

/*===================================================================================================
	START :: CHANGES MADE FOR ENABLING AREA LOGIN REQUEST
===================================================================================================*/

   SELECT @@SQL = @@SQL + "  , #BRANCH B "  
   SELECT @@SQL = @@SQL + " WHERE    "  
--   SELECT @@SQL = @@SQL + "  F.BRANCHCODE = '" + @STATUSNAME    + "' "  
   SELECT @@SQL = @@SQL + "  F.BRANCHCODE = B.BRANCH_CODE "  

/*===================================================================================================
	START :: CHANGES MADE FOR ENABLING AREA LOGIN REQUEST
===================================================================================================*/

   SELECT @@SQL = @@SQL + "  AND CONVERT(VARCHAR(11), PROC_DATE, 109) = '" + @@LDATE    + "' "  
   SELECT @@SQL = @@SQL + "  AND F.LEDGERBALANCE <> 0    "  
   IF @FORNEXT = 0  
    BEGIN  
     SELECT @@SQL = @@SQL + "  AND F.CLTCODE BETWEEN '" + @FCODE + "' AND '" + @TCODE + "' "  
    END  
   ELSE  
    BEGIN  
     SELECT @@SQL = @@SQL + "  AND F.CLTCODE > '" + @FCODE + "' AND F.CLTCODE <= '" + @TCODE + "' "  
    END  
   IF @FILTER = 1  
    BEGIN  
     SELECT @@SQL = @@SQL + "  AND ISNULL(P.AMOUNTTOBEPAID, 0) = 0 "  
    END  
   ELSE IF @FILTER = 2  
    BEGIN  
     SELECT @@SQL = @@SQL + "  AND ISNULL(P.AMOUNTTOBEPAID, 0) > 0 "  
    END  
   SELECT @@SQL = @@SQL + "  ORDER BY    "  
   SELECT @@SQL = @@SQL + "   F.CLTCODE,    "  
   SELECT @@SQL = @@SQL + "   F.BRANCHCODE    "  
   --PRINT (@@SQL)  
   EXEC (@@SQL)  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_costaccodewisedtl
-- --------------------------------------------------
Create Proc [dbo].[Acc_costaccodewisedtl]
@Costcode Smallint, 
@Accode   Varchar(10), 
@Fdate Varchar(11), 
@Tdate Varchar(11)
As
Select Vdate = Convert(Varchar, L.Vdt, 103) , Shortdesc, L2.Vtype, L2.Booktype, L2.Vno, L2.Lno, 
L2.Cltcode, A.Acname, L2.Drcr, L2.Camt, L.Narration, 
Chqno = Isnull((Select Ddno From Ledger1 L1 Where L1.Vtyp = L2.Vtype And L1.Booktype = L2.Booktype And L1.Vno = L2.Vno And L1.Lno = L2.Lno), '')
From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Ledger L, Vmast V
Where L2.Cltcode = Rtrim(@Accode) And  L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
And L.Vdt > = @Fdate + ' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
And L2.Costcode = @Costcode And L2.Vtype = V.Vtype
Order By L2.Cltcode, A.Acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_costaccodewisesum
-- --------------------------------------------------
Create Proc [dbo].[Acc_costaccodewisesum]
@Costcode Smallint, 
@Fdate Varchar(11), 
@Tdate Varchar(11)
As
Select L2.Costcode, Costname, L2.Cltcode, A.Acname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
From Ledger2 L2, Ledger L, Costmast C, Acmast A
Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
And L2.Costcode = C.Costcode And L2.Costcode = @Costcode And L2.Cltcode = A.Cltcode
Group By L2.Costcode, Costname, L2.Cltcode, A.Acname
Order By L2.Costcode, Costname, L2.Cltcode, A.Acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_costwisereport
-- --------------------------------------------------
Create Proc [dbo].[Acc_costwisereport]
@Grplen Tinyint, 
@Grpcode Varchar(10), 
@Fdate Varchar(11), 
@Tdate Varchar(11)
As
Declare 
@@Grpchars As Int
Select @@Grpchars = (Select Len(Rtrim(@Grpcode)) )
If @Grplen = 2
   Begin
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C, Category Cc
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode
 Group By Category, Left(Grpcode, @Grplen)
 Order By Category, Left(Grpcode, @Grplen)
   End
Else
If @Grplen = 10
   Begin
 Select L2.Costcode, Costname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And Left(Grpcode, @@Grpchars) = Rtrim(@Grpcode)
 Group By L2.Costcode, Costname
 Order By L2.Costcode, Costname
   End
Else
   Begin
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C, Category Cc
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And Left(Grpcode, 2) = Rtrim(@Grpcode)
 Group By Category, Left(Grpcode, @Grplen)
 Order By Category, Left(Grpcode, @Grplen)
   End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_DELVOUCHER
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[ACC_DELVOUCHER]      
@VNO VARCHAR(12),       
@VTYP  SMALLINT,       
@BOOKTYPE VARCHAR(2),       
@EMODE CHAR(1),       
@STATUS CHAR(6),       
@EDITNAME VARCHAR(15),       
@VDT VARCHAR(11)      
AS      
DECLARE      
@@VDT1 AS DATETIME      

SELECT @@VDT1 = CONVERT(DATETIME, @VDT+' '+CONVERT(VARCHAR, GETDATE(), 114))      
INSERT INTO LEDGER_LOG       
SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION,@EMODE,@@VDT1,@EDITNAME,@STATUS FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
INSERT INTO LEDGER1_LOG      
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE,@EMODE FROM LEDGER1  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
INSERT INTO LEDGER2_LOG       
SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE,@EMODE FROM LEDGER2  WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
INSERT INTO LEDGER3_LOG      
SELECT NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE,@EMODE FROM LEDGER3  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
INSERT INTO MATCHDETAILS_LOG      
SELECT *, @EMODE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO       
INSERT INTO MARGINLEDGER_LOG      
SELECT *, @EMODE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE    

DELETE FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
DELETE FROM LEDGER1 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
DELETE FROM LEDGER2 WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
DELETE FROM LEDGER3 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
DELETE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
DELETE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO       
DELETE FROM PAYADV WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_DIAGNOSTICS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[ACC_DIAGNOSTICS]
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@SELECTION VARCHAR(100),
	@UNAME VARCHAR(25),
	@CSV VARCHAR(1) = 'N'
AS

/*
	SP CREATED BY	:	YATIN
	SP CREATED ON	:	AUG 1, 2006
	SP CREATED TO GET VARIOUS MISMATCHES IN ACCOUNT DATABASE.
	MAINLY RELATED TO LEDGER, LEDGER1, LEDGER2, COSTMAST, BRANCHACCOUNTS, ACMAST
	TRUNCATE TABLE DIAG_RESULT
	TRUNCATE TABLE DIAG_LOG
	EXEC ACC_DIAGNOSTICS 'APR  1 2006', 'MAR 31 2007', 'Y,N,N,N,N,N,N,N,N,N', 'SYSTEM', 'Y'
	SELECT * FROM DIAG_LOG
	TABLES REQUIRED DIAG_RESULT AND DIAG_LOG
	DROP TABLE SYSTEM_20060907141734870
Exec ACC_DIAGNOSTICS 'Apr  1 2006', 'Mar 31 2007', 'Y,N,N,N,N,N,N,N,N', 'nirupamah', 'Y'
BEGIN TRAN
Exec ACC_DIAGNOSTICS 'Apr  1 2006', 'Mar 31 2007', 'N,N,N,N,N,N,N,Y,N', 'nirupamah', 'N'
Exec ACC_DIAGNOSTICS 'Apr  1 2006', 'Mar 31 2007', 'N,N,N,N,N,Y,N,N,N', 'jaydeep', 'N'
ROLLBACK


*/

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @@ERROR_COUNT AS INT, @@SQL AS VARCHAR(2000), @@SHAREDB AS VARCHAR(25), @TNAME AS VARCHAR(50)
/*------------------------FIND DUPLICATE VOUCHERS----------------------------------*/
IF SUBSTRING(@SELECTION, 1, 1) = 'Y'
	BEGIN
		SELECT 
			RESULT = 'VNO :' + VNO + ', VTYP :' + CONVERT(VARCHAR, VTYP) + ', BOOKTYPE :' + BOOKTYPE + ', NOS = ' + CONVERT(VARCHAR, COUNT(1))
		INTO
			#LEDGER
		FROM 
			LEDGER 
		WHERE 
			LNO = 2 
		GROUP BY 
			VNO, 
			VTYP, 
			BOOKTYPE 
		HAVING 
			COUNT(1) > 1
		
		SELECT @@ERROR_COUNT = 0
		SELECT @@ERROR_COUNT = COUNT(1) FROM #LEDGER
		IF @@ERROR_COUNT > 0
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT = 'DUPLICATE VOUCHER NOS. FOUND~', PROCID = @@SPID
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT, PROCID = @@SPID FROM #LEDGER
			END
		ELSE
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID) VALUES ('NO VOUCHER FOUND AS DUPLICATED~', @@SPID)
			END
		DROP TABLE #LEDGER
	END
/*------------------------FIND DIFFERENT VOUCHERS WITH SAMEDATA----------------------------------*/

IF SUBSTRING(@SELECTION, 3, 1) = 'Y'
	BEGIN
		SELECT
			RESULT = 'CLTCODE :' + (L.CLTCODE + ', VDT :' + CONVERT(VARCHAR(10), L.VDT, 103) + ', VNO :' + L.VNO + ', VTYP :' + CONVERT(VARCHAR, L.VTYP) + ', BOOKTYPE :' + L.BOOKTYPE + ', DRCR :' + L.DRCR + ', ' + 'Rs.' + CONVERT(VARCHAR, L.VAMT) + ', NARRATION :' + REPLACE(L.NARRATION, '~', '`'))
		INTO #LEDGER1
		FROM LEDGER L (NOLOCK),
			(
				SELECT  LED.VTYP, LED.BOOKTYPE, LED.CLTCODE, VDT = CONVERT(VARCHAR(11), VDT), DDNO, NARRATION, LED.DRCR, LED.VAMT
				FROM LEDGER LED (NOLOCK),
				LEDGER1 LED1 (NOLOCK),
				ACMAST A (NOLOCK)
				WHERE LED.VNO = LED1.VNO AND LED.VTYP = LED1.VTYP AND LED.BOOKTYPE = LED1.BOOKTYPE AND LED.LNO = LED1.LNO
				AND LED.CLTCODE = A.CLTCODE
				AND ACCAT = 4
				AND DDNO <> '0' AND DDNO <> ''
				GROUP BY VAMT, LED.VTYP, LED.BOOKTYPE, LED.CLTCODE, CONVERT(VARCHAR(11), VDT), DDNO, NARRATION, LED.DRCR
				HAVING COUNT(1) > 1
			) DUP
		WHERE
		L.VAMT = DUP.VAMT
		AND L.VTYP = DUP.VTYP
		AND L.BOOKTYPE = DUP.BOOKTYPE
		AND L.DRCR = DUP.DRCR
		AND LEFT(CONVERT(VARCHAR, L.VDT,109),11) =  DUP.VDT
		AND L.CLTCODE = DUP.CLTCODE
		ORDER BY L.CLTCODE, L.VDT, L.DRCR, L.VAMT, L.VNO, L.BOOKTYPE, L.NARRATION
		
		SELECT @@ERROR_COUNT = 0
		SELECT @@ERROR_COUNT = COUNT(1) FROM #LEDGER1
		IF @@ERROR_COUNT > 0
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT = 'VOUCHERS FOUND WITH DIFFERENT VNOs. BUT SAME KIND OF DATA.(USER NEEDS TO VERIFY THIS DATA)~', PROCID = @@SPID
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT = 'COLUMNS SERIES = CLTCODE, VDT, VNO, VTYP, BOOKTYPE, DRCR, AMOUNT, NARRATION~', PROCID = @@SPID
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT, PROCID = @@SPID FROM #LEDGER1
			END
		ELSE
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID) VALUES ('NO VOUCHER FOUND AS DIFFERENT VNOs BUT SAME KIND OF DATA~', @@SPID)
			END
		DROP TABLE #LEDGER1
	END

/*------------------------------------------------TRIAL BALANCE MISMATCH QUERIES------------------------------------------*/
/*------------------------FIND DRCR MISMATCH----------------------------------*/
	IF SUBSTRING(@SELECTION, 5, 1) = 'Y'
		BEGIN
			DECLARE
				@@DIFF AS MONEY,
				@@COUNTER AS INT
			CREATE TABLE #LEDGERMISMATCH
				(
					PARTICULARS VARCHAR(30),
					DIFF MONEY,
					REMARK VARCHAR(100)
				)
			
			INSERT INTO #LEDGERMISMATCH
			SELECT 
				PARTICULARS = 'LEDGER TOTALS', 
				DIFF = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
				REMARK = ''
			FROM
				LEDGER
			WHERE 
				VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
			
			SELECT @@DIFF = DIFF FROM #LEDGERMISMATCH
			
			IF ISNULL(@@DIFF, 0) <> 0
				BEGIN
					CREATE TABLE #MISSVNO
						(
							VNO VARCHAR(12),
							VTYP SMALLINT,
							BOOKTYPE VARCHAR(2)
						)
					INSERT INTO #MISSVNO
					SELECT 
						VNO, 
						VTYP, 
						BOOKTYPE
					FROM
						LEDGER
					WHERE 
						VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
					GROUP BY
						VNO, 
						VTYP, 
						BOOKTYPE
					HAVING
						SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) <> 0
			
					SELECT 
						@@COUNTER = COUNT(1) 
					FROM 
						#MISSVNO
					IF @@COUNTER > 0
						BEGIN
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT 
								RESULT = 'VOUCHERS WITH DEBIT AND CREDIT MISMATCHES~', PROCID = @@SPID
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT 
								RESULT = 'VNO :' + VNO + ', VTYP :' + CONVERT(VARCHAR, VTYP) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
							FROM 
								#MISSVNO
						END
					DROP TABLE #MISSVNO
				END
			
				DROP TABLE #LEDGERMISMATCH
			
			/*------------------------FIND MULTIPLE VDTs----------------------------------*/
				CREATE TABLE #MISSDATES
					(
						VNO VARCHAR(12),
						VTYP SMALLINT,
						BOOKTYPE VARCHAR(2)
					)
				INSERT INTO #MISSDATES
					(	
						VNO,
						VTYP,
						BOOKTYPE
					)
				SELECT
					VNO,
					VTYP,
					BOOKTYPE
				FROM
					(
						SELECT
							VNO,
							VTYP,
							BOOKTYPE
						FROM
							LEDGER
						WHERE
							VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
						GROUP BY
							VNO,
							VTYP,
							BOOKTYPE,
							CONVERT(VARCHAR(11), VDT, 109)
					) A
				GROUP BY
					VNO,
					VTYP,
					BOOKTYPE
				HAVING
					COUNT(1) > 1
			
			
				SELECT
					@@COUNTER = COUNT(1)
				FROM
					#MISSDATES
			
				IF @@COUNTER > 0
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'VOUCHER(S) FOUND WITH DIFFERENT VOUCHER DATES~', PROCID = @@SPID
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT 
							RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
						FROM
							#MISSDATES
					END
				ELSE
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'NO VOUCHER(S) FOUND WITH MULTIPLE VOUCHER DATES~', PROCID = @@SPID
					END
			
			
				TRUNCATE TABLE #MISSDATES
			/*------------------------FIND MULTIPLE EDTs----------------------------------*/
			
				INSERT INTO #MISSDATES
					(	
						VNO,
						VTYP,
						BOOKTYPE
					)
				SELECT
					VNO,
					VTYP,
					BOOKTYPE
				FROM
					(
						SELECT
							VNO,
							VTYP,
							BOOKTYPE
						FROM
							LEDGER
						WHERE
							EDT BETWEEN @FDATE AND @TDATE + ' 23:59'
						GROUP BY
							VNO,
							VTYP,
							BOOKTYPE,
							CONVERT(VARCHAR(11), EDT, 109)
					) A
				GROUP BY
					VNO,
					VTYP,
					BOOKTYPE
				HAVING
					COUNT(1) > 1
			
			
				SELECT
					@@COUNTER = COUNT(1)
				FROM
					#MISSDATES
			
				IF @@COUNTER > 0
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'VOUCHER(S) FOUND WITH DIFFERENT EFFECTIVE DATES~', PROCID = @@SPID
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT 
							RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
						FROM
							#MISSDATES
					END
				ELSE
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'NO VOUCHER(S) FOUND WITH MULTIPLE EFFECTIVE DATES~', PROCID = @@SPID
					END
				DROP TABLE #MISSDATES
			
			/*------------------------FIND MISSING CLIENT CODES FROM ACMAST----------------------------------*/
			
				SELECT @@COUNTER = 0
				CREATE TABLE #MISSCLTS
					(
						CLTCODE VARCHAR(10),
						VNO VARCHAR(12),
						VTYP SMALLINT,
						BOOKTYPE VARCHAR(2)
					)
				INSERT INTO #MISSCLTS (CLTCODE, VNO, VTYP, BOOKTYPE)
				SELECT L.CLTCODE, L.VNO, L.VTYP, L.BOOKTYPE FROM LEDGER L WHERE NOT EXISTS (SELECT CLTCODE FROM ACMAST A WHERE L.CLTCODE = A.CLTCODE)
				
				SELECT
					@@COUNTER = COUNT(1)
				FROM
					#MISSCLTS
			
				IF @@COUNTER > 0
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'FOLLOWING CLTCODEs DO NOT EXIST IN ACMAST.~', PROCID = @@SPID
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT DISTINCT
							RESULT = 'CLTCODE :' + CLTCODE + ', VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
						FROM
							#MISSCLTS
					END
				ELSE
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'CLTCODE MISMATCH NOT FOUND.~', PROCID = @@SPID
					END
				DROP TABLE #MISSCLTS
		END
/*------------------------FIND MISSING ENTRIES FROM LEDGER2----------------------------------*/

	IF SUBSTRING(@SELECTION, 7, 1) = 'Y'
		BEGIN
			CREATE TABLE #MISSL2
				(
					VNO VARCHAR(12),
					VTYP SMALLINT,
					BOOKTYPE VARCHAR(2)
				)
		
			INSERT INTO #MISSL2
				(
					VNO,
					VTYP,
					BOOKTYPE
				)
			SELECT
				VNO,
				VTYP,
				BOOKTYPE
			FROM
				LEDGER L
			WHERE
				VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
				AND
				NOT EXISTS
				(
					SELECT
						VNO,
						VTYPE,
						BOOKTYPE
					FROM
						LEDGER2 L2
					WHERE
						L.VNO = L2.VNO
						AND L.VTYP = L2.VTYPE
						AND L.BOOKTYPE = L2.BOOKTYPE
				)
			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSL2
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING VOUCHERS DO NOT EXIST IN LEDGER2 BUT POSTED IN LEDGER.~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT DISTINCT
						RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
					FROM
						#MISSL2
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO VOUCHERS FOUND AS MISSING IN LEDGER2.~', PROCID = @@SPID
				END
			DROP TABLE #MISSL2
		END

/*------------------------FIND BILLS YET TO BE POSTED----------------------------------*/

	IF SUBSTRING(@SELECTION, 9, 1) = 'Y'
		BEGIN
			SELECT TOP 1
				@@SHAREDB = SHAREDB
			FROM
				OWNER
		
			CREATE TABLE #ACCBILL
				(
					SETT_NO VARCHAR(7),
					SETT_TYPE VARCHAR(2)
				)
		
			CREATE TABLE #BILLMATCH
				(
					SETT_NO VARCHAR(7),
					SETT_TYPE VARCHAR(2)
				)
		
			SELECT @@SQL = "INSERT INTO #ACCBILL (SETT_NO, SETT_TYPE) "
			SELECT @@SQL = @@SQL + "SELECT DISTINCT "
			SELECT @@SQL = @@SQL + "	SETT_NO, "
			SELECT @@SQL = @@SQL + "	SETT_TYPE "
			SELECT @@SQL = @@SQL + "FROM "
			SELECT @@SQL = @@SQL + "	" + @@SHAREDB + ".DBO.ACCBILL "
		
			EXEC(@@SQL)
		
			INSERT INTO #BILLMATCH (SETT_NO, SETT_TYPE)
			SELECT DISTINCT
				SETT_NO,
				SETT_TYPE
			FROM
				BILLMATCH
		
			SELECT
				A.SETT_NO,
				A.SETT_TYPE
			INTO
				#MISSBILLS
			FROM
				#ACCBILL A
			WHERE
				NOT EXISTS
				(
					SELECT
						SETT_NO,
						SETT_TYPE
					FROM
						#BILLMATCH B
					WHERE
						A.SETT_NO = B.SETT_NO
						AND A.SETT_TYPE = B.SETT_TYPE
				)
		
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSBILLS
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'BILLS FOR THE FOLLOWING SETTLEMENTS ARE NOT YET POSTED IN LEDGER.~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'SETT.NO.:-' + SETT_NO + ', SETT. TYPE.:' + SETT_TYPE, PROCID = @@SPID
					FROM
						#MISSBILLS
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO BILLS FOUND AS UNPOSTED.~', PROCID = @@SPID
				END
			DROP TABLE #MISSBILLS
		END
	
/*------------------------FIND BRANCH AND COSTMASTER MISMATCHES----------------------------------*/

	IF SUBSTRING(@SELECTION, 11, 1) = 'Y'
		BEGIN
			SELECT TOP 1
				@@SHAREDB=SHAREDB
			FROM
				OWNER
			CREATE TABLE #BRANCHES
			(
				BRANCH_CODE VARCHAR(20)
			)
			SELECT @@SQL = ''
			SELECT @@SQL = "INSERT INTO #BRANCHES (BRANCH_CODE) "
			SELECT @@SQL = @@SQL + "SELECT DISTINCT "
			SELECT @@SQL = @@SQL + "	BRANCH_CODE "
			SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.BRANCH B "
			SELECT @@SQL = @@SQL + "WHERE "
			SELECT @@SQL = @@SQL + "	NOT EXISTS "
			SELECT @@SQL = @@SQL + "	( "
			SELECT @@SQL = @@SQL + "		SELECT DISTINCT COSTNAME FROM COSTMAST C "
			SELECT @@SQL = @@SQL + "		WHERE B.BRANCH_CODE = C.COSTNAME "
			SELECT @@SQL = @@SQL + "	) "
			PRINT @@SQL
			EXEC(@@SQL)
		
			SELECT @@COUNTER = 0
		
			SELECT @@COUNTER = COUNT(1) FROM #BRANCHES
		
			IF @@COUNTER > 0
				BEGIN
					DECLARE @@MAXCOST AS INT
					SELECT @@MAXCOST = ISNULL(MAX(COSTCODE), 0) FROM COSTMAST
					IF ISNULL(@@MAXCOST, 0 ) = 0
						BEGIN
							SELECT @@MAXCOST = 1
						END
					ELSE
						BEGIN
							SELECT @@MAXCOST = @@MAXCOST + 1
						END
					CREATE TABLE #COSTMAST
					(
						COSTNAME VARCHAR(20),
						CATCODE SMALLINT,
						GRPCODE VARCHAR(20)
					)
					SELECT @@SQL = "ALTER TABLE #COSTMAST "
					SELECT @@SQL = @@SQL + "ADD COSTCODE INT IDENTITY (" + CONVERT(VARCHAR, @@MAXCOST) + ", 1) "
					EXEC (@@SQL)
					INSERT INTO #COSTMAST (COSTNAME, CATCODE, GRPCODE)
					SELECT
						BRANCH_CODE,
						CATCODE = 1,
						GRPCODE = 'A0000000000'
					FROM
						#BRANCHES
					INSERT INTO COSTMAST (COSTNAME, COSTCODE, CATCODE, GRPCODE)
					SELECT COSTNAME, COSTCODE, CATCODE, GRPCODE FROM #COSTMAST
		
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING COST MAST ENTRIES HAVE BEEN UPDATED...~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'BRANCHNAME : ' + COSTNAME + ', COSTCODE : ' + LTRIM(RTRIM(CONVERT(VARCHAR, COSTCODE))), PROCID = @@SPID
					FROM
						#COSTMAST
					DROP TABLE #COSTMAST
				END
		
			TRUNCATE TABLE #BRANCHES


			INSERT INTO #BRANCHES (BRANCH_CODE)
			SELECT DISTINCT
				COSTNAME
			FROM
				COSTMAST C
			WHERE
				NOT EXISTS
				(
					SELECT DISTINCT
						BRANCHNAME
					FROM
						BRANCHACCOUNTS B
					WHERE
						C.COSTNAME = B.BRANCHNAME
				)
		
			SELECT @@COUNTER = 0
		
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#BRANCHES
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO
						BRANCHACCOUNTS (BRANCHNAME, BRCONTROLAC, MAINCONTROLAC, DEFAULTAC)
					SELECT
						BRANCH_CODE,
						BRCONTROLAC = LEFT(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL', 10),
						MAINCONTROLAC = 'HOCTRL',
						DEFAULTAC = 0
					FROM
						#BRANCHES
					WHERE
						LEN(LTRIM(RTRIM(BRANCH_CODE))) <= 10
						AND LEN(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL') <= 10

		
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING BRANCHACCOUNTS ENTRIES HAVE BEEN UPDATED...~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'BRANCHNAME : ' + BRANCH_CODE + ', BRCONTROLAC : ' + LEFT(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL', 10), PROCID = @@SPID
					FROM
						#BRANCHES
					WHERE
						LEN(LTRIM(RTRIM(BRANCH_CODE))) <= 10
					SELECT @@COUNTER = 0
					SELECT
						@@COUNTER = COUNT(1)
					FROM
						#BRANCHES
					WHERE
						LEN(LTRIM(RTRIM(BRANCH_CODE))) > 10
						OR LEN(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL') > 10
					IF @@COUNTER > 0
						BEGIN
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'FOLLOWING BRANCHACCOUNTS ENTRIES HAVE NOT BEEN UPDATED AS LENGTH OF BRANCH CODE OR BRANCHCONTROL ACCOUNTS IS EXCEEDING ...~', PROCID = @@SPID
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'BRANCHNAME : ' + BRANCH_CODE + ', BRCONTROLAC : ' + LEFT(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL', 10), PROCID = @@SPID
							FROM
								#BRANCHES
							WHERE
								LEN(LTRIM(RTRIM(BRANCH_CODE))) > 10
								OR LEN(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL') > 10
						END
				END
			DROP TABLE #BRANCHES
		
		/*------------------------FIND BRANCHACCOUNTS AND ACMAST MISMATCHES----------------------------------*/
			CREATE TABLE #BRANCHES1
			(
				BRANCH_CODE VARCHAR(10),
				BRCONTROLAC VARCHAR(10)
			)
		
			INSERT INTO #BRANCHES1 (BRANCH_CODE, BRCONTROLAC)
			SELECT DISTINCT
				BRANCHNAME,
				BRCONTROLAC
			FROM
				BRANCHACCOUNTS B
			WHERE
				NOT EXISTS
				(
					SELECT DISTINCT
						CLTCODE
					FROM
						ACMAST A
					WHERE
						B.BRCONTROLAC = A.CLTCODE
				)
		
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#BRANCHES1
		
			IF @@COUNTER > 0
				BEGIN
					CREATE TABLE #DUPLICATEBRS
					(
						BRCONTROLAC VARCHAR(10),
						ACNAME VARCHAR(100)
					)
					CREATE TABLE #DUPLICATEBRS1
					(
						BRCONTROLAC VARCHAR(10)
					)

					INSERT INTO
						#DUPLICATEBRS
					SELECT
						CLTCODE,
						LONGNAME
					FROM
						ACMAST A
					WHERE
						EXISTS
							(SELECT DISTINCT
								BRCONTROLAC
							FROM
								#BRANCHES1 B
							WHERE
								B.BRCONTROLAC = A.CLTCODE
							)

					INSERT INTO
						#DUPLICATEBRS
						(BRCONTROLAC)
					SELECT
						BRCONTROLAC
					FROM
						#BRANCHES1
					GROUP BY
						BRCONTROLAC
					HAVING
						COUNT(1) > 1

					DELETE B
					FROM
						#BRANCHES1 B,
						#DUPLICATEBRS D
					WHERE
						B.BRCONTROLAC = D.BRCONTROLAC

					INSERT INTO ACMAST (ACNAME, LONGNAME, ACTYP, ACCAT, FAMILYCD, CLTCODE, ACCDTLS, GRPCODE, BOOKTYPE, MICRNO, BRANCHCODE, BTOBPAYMENT, PAYMODE, POBANKNAME, POBRANCH, POBANKCODE)
					SELECT
						ACNAME = BRANCH_CODE + 'CONTROL A/C',
						LONGNAME = BRANCH_CODE + 'CONTROL A/C',
						ACTYP = 'ASSETS',
						ACCAT = 3,
						FAMILYCD = '',
						CLTCODE = BRCONTROLAC,
						ACCDTLS = '',
						GRPCODE = 'A0000000001',
						BOOKTYPE = '',
						MICRNO = 0,
						BRANCHCODE = BRANCH_CODE,
						BTOBPAYMENT = 0,
						PAYMODE = 'P',
						POBANKNAME = '',
						POBRANCH = '',
						POBANKCODE = ''
					FROM
						#BRANCHES1
		
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING CONTROL ACCOUNT ENTRIES HAVE BEEN UPDATED IN ACMAST~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'CLTCODE : ' + BRCONTROLAC + ', BRANCH : ' + BRANCH_CODE, PROCID = @@SPID
					FROM
						#BRANCHES1
					SELECT @@COUNTER = 0
					SELECT
						@@COUNTER = COUNT(1)
					FROM
						#DUPLICATEBRS
					IF @@COUNTER > 0
						BEGIN
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'FOLLOWING CONTROL ACCOUNT ENTRIES HAVE NOT BEEN ADDED IN ACMAST AS FOLLOWING ENTRIES FOUND OR MIGHT BE DUPLICATE ENTRIES WITH SAME CODE~', PROCID = @@SPID
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'CLTCODE : ' + ISNULL(BRCONTROLAC, '') + ', LONG NAME : ' + ISNULL(ACNAME, ''), PROCID = @@SPID
							FROM
								#DUPLICATEBRS
						END
					DROP TABLE #DUPLICATEBRS
				END
			DROP TABLE #BRANCHES1
		END

/*------------------------VALIDATING LEDGER AND LASTVNO CONSISTANCY----------------------------------*/
	IF SUBSTRING(@SELECTION, 13, 1) = 'Y'
		BEGIN
			DECLARE @@PARA AS CURSOR, @@SDTCUR AS VARCHAR(11), @@LDTCUR AS VARCHAR(11), @@VNOFLAG AS SMALLINT
			CREATE TABLE #LDVNO
			(
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				VNO VARCHAR(12)
			)
		
			CREATE TABLE #LTVNO
			(
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				VNO VARCHAR(12)
			)
		
			CREATE TABLE #MISSVNOS
			(
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				LDVNO VARCHAR(12),
				LTVNO VARCHAR(12),
				FINYEAR VARCHAR(30)
			)
		
			SET @@PARA = CURSOR FOR
				SELECT
					SDTCUR	= CONVERT(VARCHAR(11), SDTCUR, 109),
					LDTCUR		= CONVERT(VARCHAR(11), LDTCUR, 109),
					VNOFLAG	= VNOFLAG
				FROM
					PARAMETER
				ORDER BY
					SDTCUR
			OPEN @@PARA
			FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
			WHILE @@FETCH_STATUS = 0
				BEGIN
					SELECT @@SQL = "INSERT INTO #LDVNO (VTYP, BOOKTYPE, VNO) "
					SELECT @@SQL = @@SQL + "SELECT VTYP, BOOKTYPE, VNO = MAX(VNO) "
					SELECT @@SQL = @@SQL + "FROM LEDGER "
					SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @@SDTCUR + "' AND '" + @@LDTCUR + " 23:59' "
					SELECT @@SQL = @@SQL + "GROUP BY VTYP, BOOKTYPE"
					IF @@VNOFLAG = 1
						BEGIN
							SELECT @@SQL = @@SQL + ", CONVERT(VARCHAR(11), VDT, 109) "
						END
					ELSE IF @@VNOFLAG = 2
						BEGIN
							SELECT @@SQL = @@SQL + ", MONTH(VDT), YEAR(VDT)"
						END
					EXEC (@@SQL)
		
					SELECT @@SQL = "INSERT INTO #LTVNO (VTYP, BOOKTYPE, VNO) "
					SELECT @@SQL = @@SQL + "SELECT VTYP, BOOKTYPE, VNO = MAX(LASTVNO) "
					SELECT @@SQL = @@SQL + "FROM LASTVNO "
					SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @@SDTCUR + "' AND '" + @@LDTCUR + " 23:59' "
					SELECT @@SQL = @@SQL + "GROUP BY VTYP, BOOKTYPE"
					IF @@VNOFLAG = 1
						BEGIN
							SELECT @@SQL = @@SQL + ", CONVERT(VARCHAR(11), VDT, 109) "
						END
					ELSE IF @@VNOFLAG = 2
						BEGIN
							SELECT @@SQL = @@SQL + ", MONTH(VDT), YEAR(VDT)"
						END
					EXEC (@@SQL)
		
					INSERT INTO #MISSVNOS (VTYP, BOOKTYPE, LTVNO, LDVNO, FINYEAR)
					SELECT LT.VTYP, LT.BOOKTYPE, LT.VNO, LDVNO = ISNULL(LD.VNO, '000000000000'), FINYEAR = @@SDTCUR + ' - ' + @@LDTCUR
					FROM #LTVNO LT LEFT JOIN #LDVNO LD ON LT.VTYP = LD.VTYP AND LT.BOOKTYPE = LD.BOOKTYPE
					WHERE CONVERT(NUMERIC, LT.VNO) < CONVERT(NUMERIC, ISNULL(LD.VNO, '000000000000'))
					TRUNCATE TABLE #LDVNO
					TRUNCATE TABLE #LTVNO
					FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
				END
			CLOSE @@PARA
			DEALLOCATE @@PARA

			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSVNOS
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING VTYPEs AND BOOKTYPEs ARE HAVING MISMATCH IN VNO GENERATION INTO LEDGER AND LASTVNO~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE + 'LASTVNO : ' + LTVNO + ', LEDGER VNO : ' + LDVNO + ', FINANCIAL YEAR : ' + FINYEAR,
						PROCID = @@SPID
					FROM
						#MISSVNOS
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO MISMATCH FOUND IN VNO GENERATION INTO LEDGER AND LASTVNO.~', PROCID = @@SPID
				END
			DROP TABLE #MISSVNOS
			DROP TABLE #LDVNO
			DROP TABLE #LTVNO
		END

/*------------------------VALIDATING VALID VNO SERIES IN YEARLY VNO GENERATION----------------------------------*/

	IF SUBSTRING(@SELECTION, 15, 1) = 'Y'
		BEGIN
			CREATE TABLE #MISSSRS
			(
				FINYEAR VARCHAR(30),
				PROPERSR VARCHAR(4),
				INVALIDSR VARCHAR(4)
			)
			SET @@PARA = CURSOR FOR
				SELECT
					SDTCUR	= CONVERT(VARCHAR(11), SDTCUR, 109),
					LDTCUR		= CONVERT(VARCHAR(11), LDTCUR, 109),
					VNOFLAG	= VNOFLAG
				FROM
					PARAMETER
				ORDER BY
					SDTCUR
			OPEN @@PARA
			FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
			WHILE @@FETCH_STATUS = 0
				BEGIN
					IF @@VNOFLAG = 0
						BEGIN
							INSERT INTO #MISSSRS (FINYEAR, PROPERSR, INVALIDSR)
							SELECT DISTINCT
								FINYEAR = @@SDTCUR + ' - ' + @@LDTCUR,
								PROPERSR = CONVERT(VARCHAR(4), YEAR(CONVERT(DATETIME, @@SDTCUR, 109))),
								INVALIDSR = LEFT(VNO, 4)
							FROM
								LEDGER
							WHERE
								VDT BETWEEN @@SDTCUR AND @@LDTCUR + ' 23:59'
								AND LEFT(VNO, 4) <> CONVERT(VARCHAR(4), YEAR(CONVERT(DATETIME, @@SDTCUR, 109)))
						END
					FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
				END
			CLOSE @@PARA
			DEALLOCATE @@PARA
		
			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSSRS
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'IN FOLLOWING FINANCIAL YEAR(S), THE VNO SERIES IS MISMATCHED.~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FINANCIAL YEAR :' + FINYEAR + ', ' + 'PROPER SERIES SHOULD START FROM :' + PROPERSR + ', SERIES STARTING WITH :' + INVALIDSR,
						PROCID = @@SPID
					FROM
						#MISSSRS
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO MISMATCH FOUND IN VNO SERIES GENERATION.~', PROCID = @@SPID
				END
		END

/*------------------------VALIDATING EFFECTIVE DATE WITH REALISATION DATE IN RECEIPT VOUCHERS----------------------------------*/

	IF SUBSTRING(@SELECTION, 17, 1) = 'Y'
		BEGIN
			CREATE TABLE #MISSEFFDT
			(
				VNO VARCHAR(12),
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				EDT DATETIME,
				RELDT DATETIME
			)
		
			INSERT INTO #MISSEFFDT (VNO, VTYP, BOOKTYPE, EDT, RELDT)
			SELECT
				VNO = L.VNO,
				VTYP = L.VTYP,
				BOOKTYPE = L.BOOKTYPE,
				EDT = CONVERT(VARCHAR(11), L.EDT, 109),
				RELDT = CONVERT(VARCHAR(11), L1.RELDT, 109)
			FROM
				LEDGER L,
				LEDGER1 L1
			WHERE
				L.VNO = L1.VNO
				AND L.VTYP = L1.VTYP
				AND L.BOOKTYPE = L1.BOOKTYPE
				AND L.LNO = L1.LNO
				AND L.VTYP = 2
				AND (L1.RELDT IS NOT NULL AND L1.RELDT <> '')
				AND CONVERT(VARCHAR(11), L.EDT, 109) = 'DEC 31 2049'
		
			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSEFFDT
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'THE CHEQUES/DDs ARE REALISED BUT EFFECTIVE DATE IS NOT UPDATED FROM DEC 31 2049 IN FOLLOWING VOUCHERS~',
						PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE + ', REALISED ON :' + CONVERT(VARCHAR(10), RELDT, 103) + ', EFFECTIVE ON :' + CONVERT(VARCHAR(10), EDT, 103),
						PROCID = @@SPID
					FROM
						#MISSEFFDT
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO MISMATCH FOUND IN REALISATION AND EFFECTIVE DATES IN RECEIPT VOUCHERS.~', PROCID = @@SPID
				END
		END

	INSERT INTO DIAG_LOG (ACTIONDATE, COMP_NAME, APPLICATION, USERNAME, OPTIONS, PERIOD, RESULT, PROCID)
	SELECT
		ACTIONDATE = GETDATE(),
		COMP_NAME = HOST_NAME(),
		APPLICATION = APP_NAME(),
		USERNAME = @UNAME,
		OPTIONS = REPLACE(REPLACE(REPLACE(@SELECTION, 'Y', '1'), 'N', '0'), ',', ''),
		PERIOD = @FDATE + ' - ' + @TDATE,
		RESULT,
		PROCID = @@SPID
	FROM
		DIAG_RESULT
	WHERE
		PROCID = @@SPID
	ORDER BY
		SNO
	INSERT INTO DIAG_RESULT (RESULT, PROCID)
	SELECT
		RESULT = '*^*REPORT EXECUTED ON : ' + CONVERT(VARCHAR, GETDATE(), 121) + ' WITH PROCESS ID :' + CONVERT(VARCHAR, @@SPID), PROCID = @@SPID

	IF @CSV = 'N'
		BEGIN
			SELECT RESULT FROM DIAG_RESULT WHERE PROCID = @@SPID ORDER BY SNO
			DELETE FROM DIAG_RESULT WHERE PROCID = @@SPID
		END
	ELSE
		BEGIN
			SELECT @TNAME = @UNAME + '_' + REPLACE(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, GETDATE(), 121), '-', ''), ':', ''), '.', ''), ' ', '')
			SELECT @@SQL = "CREATE TABLE " + @TNAME
			SELECT @@SQL = @@SQL + "( "
			SELECT @@SQL = @@SQL + "	RESULT VARCHAR(2000), SNO INT IDENTITY(1,1) "
			SELECT @@SQL = @@SQL + ") "
			EXEC (@@SQL)
			SELECT @@SQL = "INSERT INTO " + @TNAME
			SELECT @@SQL = @@SQL + "(RESULT) "
			SELECT @@SQL = @@SQL + "SELECT RESULT FROM DIAG_RESULT WHERE PROCID = " + LTRIM(RTRIM(CONVERT(VARCHAR, @@SPID))) + " ORDER BY SNO"
			EXEC (@@SQL)
			DELETE FROM DIAG_RESULT WHERE PROCID = @@SPID
			SELECT SUCCESS = 1, TABLENAME = @TNAME
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_EDITVOUCHER
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[ACC_EDITVOUCHER]  
@VNO VARCHAR(12),   
@VTYP  SMALLINT,   
@BOOKTYPE VARCHAR(2),   
@EMODE CHAR(1),   
@STATUS CHAR(6),   
@EDITNAME VARCHAR(15),   
@VDT VARCHAR(11)  
AS  
DECLARE  
@@VDT1 AS DATETIME  
    
SELECT @@VDT1 = CONVERT(DATETIME, @VDT+' '+CONVERT(VARCHAR, GETDATE(), 114))  

INSERT INTO LEDGER_LOG   
SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION,@EMODE,@@VDT1,@EDITNAME,@STATUS FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER1_LOG  
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE,@EMODE FROM LEDGER1  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER2_LOG   
SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE,@EMODE FROM LEDGER2  WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER3_LOG  
SELECT NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE,@EMODE FROM LEDGER3  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO MATCHDETAILS_LOG  
SELECT *, @EMODE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO   
INSERT INTO MARGINLEDGER_LOG  
SELECT *, @EMODE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  

DELETE FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER1 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER2 WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER3 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO   
DELETE FROM PAYADV WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_GenVno
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.V2_Acc_GenVNo    Script Date: 09/30/2005 12:23:51 ******/          
          
/*        
-------------------------------------        
New Procedure to Generate VNO        
-------------------------------------        
        
Author            : Uppili Krishnan        
Date               : Sep 30 2005        
Reviewed By   :        
Review Date   :        
Tested By       :           
Tested Date    :        
        
-------------------------------------        
        
                
      Flags:        
            VnoFlag = 0 Yearly        
            VnoFlag = 1 Daily        
            VnoFlag = 2 Monthly        
        
Logic:        
 Generates 1 record per day for the combination of VnoFlag, VoucherDate, Financial Year Combination        
 if for the above combination record is not present in V2_LastVno table then a new record is inserted        
 else existing record is updated        
        
        
                                 
*/          
          
CREATE PROC [dbo].[Acc_GenVno]
@vdt      varchar(11),  /* dd/mm/yyyy */                
@vtyp     smallint,                
@booktype varchar(2),                
@sdtcur   varchar(11),                
@ldtcur   varchar(11),      
@noofrecords int = 1      
/* @vnoflag  int */                
as                
                
                
                
Declare @@voudt  as datetime                
Declare @@maxvno as numeric(12,0)                
Declare @@vnoflag as tinyint                
Declare @@vno as varchar(12)                
Declare @@rcnt as int                
Declare @@FldAuto bigint                
Declare @@YearlyVdt varchar(11)              
Declare @@DailyVDt Varchar(11)                
Declare @@MonthlyVdt varchar(11)                
Declare @@UpdtVdt varchar(11)                
Declare @@FinYear smallint              
      
Declare @@ReturnVno as varchar(12)      
                
--SET NOCOUNT ON                
set Xact_abort on                
                
begin transaction                
        
Select         
      @sdtcur = LEFT(SDTCUR,11),         
      @ldtcur = LEFT(LDTCUR,11),         
      @@vnoflag = vnoflag,               
      @@FinYear = FldAuto                
from         
      Parameter         
where          
      convert(datetime,@vdt) BETWEEN sdtcur and ldtcur         
        
/*        
Select               
from               
      Parameter               
where                
      sdtcur like @sdtcur + '%'               
      and ldtcur like @ldtcur + '%'              
*/              
              
/*               
Reinitialising the Dates to be posted in the table.                
      For Daily, the Voucher Date is taken              
      For Monthly, the 1st Day of the Month  is Taken              
      For Yearly, the first Day of the year is taken              
*/              
              
select               
      @@voudt = (select convert(datetime,@vdt)),               
      @@MonthlyVdt = left(@Vdt,4)+' 1 '+right(@Vdt,4),               
      @@DailyVdt = @Vdt,               
      @@YearlyVdt = LEFT(@SDTCUR,4) + ' 1 '+ right(@SDTCUR,4)              
          
-- Doing Yearly Voucher Gen                
if @@vnoflag = 0                
   begin                
      select               
            @@FldAuto = isnull(FldAuto,0) ,               
            @@maxvno = convert(NUMERIC,isnull(lastvno,0))               
      from               
            V2_LastVno WITH (INDEX(VNOIDX),TABLOCKX,HOLDLOCK)               
      where               
            vtyp = @vtyp               
            and booktype = @booktype               
            and vdt = @@YearlyVdt + ' 00:00:00'               
            and VnoFlag = @@VnoFlag               
            and FinYear = @@FinYear              
              
              
      if @@ROWCOUNT=0              
         begin                
            -- If No Record Present, then Insert              
           select               
                  @@FldAuto=0,               
          @@UpdtVdt = @@YearlyVdt,               
                  @@ReturnVno = Right(@@YearlyVdt,4) + '00000001',                
  @@Vno = Right(@@YearlyVdt,4) + Replicate('0', 8-len(@noofrecords)) + cast(@noofrecords as varchar)                  
 end                
         else                
         begin                
           select               
            -- If record is Present, then Update              
                  @@UpdtVdt = @@YearlyVdt,               
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1))  ,              
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                
         end                
   end                
              
-- Doing Daily Voucher Gen                
else if @@vnoflag = 1                
        begin                
              
          select               
                  @@FldAuto = isnull(FldAuto,0) ,                
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))               
            from           
                  V2_LastVno WITH (Index(VnoIdx), TABLOCKX,HOLDLOCK)               
            where               
                  vtyp = @vtyp               
                  and booktype = @booktype               
                  and vdt = @@DailyVDt + ' 00:00:00'                
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear              
              
              
          if  @@ROWCOUNT=0              
             begin                
            -- If No Record Present, then Insert              
                select               
                  @@FldAuto=0,               
                  @@UpdtVdt = @@DailyVdt,               
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+'0001'          ,      
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+ Replicate('0', 4-len(@noofrecords)) + cast(@noofrecords as varchar)      
      
             end                
          else                
             begin                
            -- If record is Present, then Update              
               select               
                  @@UpdtVdt = @@DailyVdt,               
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),                
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                
      
             end                
        end                
              
-- Doing Monthly Voucher Gen                
else if @@vnoflag = 2                
        begin                
          select               
                  @@FldAuto = isnull(FldAuto,0) ,               
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))               
            from               
                  V2_LastVno WITH (index(VNoIdx), TABLOCKX,HOLDLOCK)               
            where               
                  vtyp = @vtyp               
                  and booktype = @booktype               
                  and vdt = @@MonthlyVDt + ' 00:00:00'                
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear              
              
              
          if  @@ROWCOUNT=0              
             begin                
            -- If No Record Present, then Insert              
                select               
                  @@FldAuto=0,               
                  @@UpdtVdt = @@MonthlyVdt,               
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+'000001',                
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+ Replicate('0', 6-len(@noofrecords)) + cast(@noofrecords as varchar)      
      
             end                
         else                
       begin                
            -- If record is Present, then Update              
               select               
                  @@UpdtVdt = @@MonthlyVdt,               
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),                
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                
      
             end                
        end        
              
                
if @@error <> 0                 
begin                
 rollback transaction                
 select vno = ''                
 return                
end                 
else                
begin                
       if isnull(@@vno,'') <> ''                 
       begin                
                  if isnull(@@FldAuto,0) = 0                
                  begin                
                    -- If No Record Present, then Insert              
                        insert into V2_LastVno               
                        (Vtyp, BookType, Vdt, LastVno, VnoFlag, FinYear)              
                        values               
                        (@vtyp,@booktype,@@UpdtVdt,@@vno, @@VnoFlag, @@FinYear)                
                  end                
                  else                
                  begin                
                        -- If record is Present, then Update              
                        Update               
                              V2_LastVno               
                        set               
                              Lastvno = @@Vno               
                        where               
                              FldAuto = @@FldAuto                
                  end               
       
                        commit transaction                
      
                        select vno = @@Returnvno                
                        return                
       end                 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_GenVno_new
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.V2_Acc_GenVNo    Script Date: 09/30/2005 12:23:51 ******/        
        
/*      
-------------------------------------      
New Procedure to Generate VNO      
-------------------------------------      
      
Author            : Uppili Krishnan      
Date               : Sep 30 2005      
Reviewed By   :      
Review Date   :      
Tested By       :         
Tested Date    :      
      
-------------------------------------      
      
              
      Flags:      
            VnoFlag = 0 Yearly      
            VnoFlag = 1 Daily      
            VnoFlag = 2 Monthly      
      
Logic:      
 Generates 1 record per day for the combination of VnoFlag, VoucherDate, Financial Year Combination      
 if for the above combination record is not present in V2_LastVno table then a new record is inserted      
 else existing record is updated      
      
      
                               
*/        
        
CREATE PROC [dbo].[Acc_GenVno_new]  
@vdt      varchar(11),  /* dd/mm/yyyy */              
@vtyp     smallint,              
@booktype varchar(2),              
@sdtcur   varchar(11),              
@ldtcur   varchar(11),    
@noofrecords int = 1    
/* @vnoflag  int */              
as              
              
              
              
Declare @@voudt  as datetime              
Declare @@maxvno as numeric(12,0)              
Declare @@vnoflag as tinyint              
Declare @@vno as varchar(12)              
Declare @@rcnt as int              
Declare @@FldAuto bigint              
Declare @@YearlyVdt varchar(11)            
Declare @@DailyVDt Varchar(11)              
Declare @@MonthlyVdt varchar(11)              
Declare @@UpdtVdt varchar(11)              
Declare @@FinYear smallint            
    
Declare @@ReturnVno as varchar(12)    
              
--SET NOCOUNT ON              
set Xact_abort on              
              
begin transaction              
      
Select       
      @sdtcur = LEFT(SDTCUR,11),       
      @ldtcur = LEFT(LDTCUR,11),       
      @@vnoflag = vnoflag,             
      @@FinYear = FldAuto              
from       
      Parameter       
where        
      convert(datetime,@vdt) BETWEEN sdtcur and ldtcur       
      
/*      
Select             
from             
      Parameter             
where              
      sdtcur like @sdtcur + '%'             
      and ldtcur like @ldtcur + '%'            
*/            
            
/*             
Reinitialising the Dates to be posted in the table.              
      For Daily, the Voucher Date is taken            
      For Monthly, the 1st Day of the Month  is Taken            
      For Yearly, the first Day of the year is taken            
*/            
            
select             
      @@voudt = (select convert(datetime,@vdt)),             
      @@MonthlyVdt = left(@Vdt,4)+' 1 '+right(@Vdt,4),             
      @@DailyVdt = @Vdt,             
      @@YearlyVdt = LEFT(@SDTCUR,4) + ' 1 '+ right(@SDTCUR,4)            
        
-- Doing Yearly Voucher Gen              
if @@vnoflag = 0              
   begin              
      select             
            @@FldAuto = isnull(FldAuto,0) ,             
            @@maxvno = convert(NUMERIC,isnull(lastvno,0))             
      from             
            V2_LastVno WITH (INDEX(VNOIDX),TABLOCKX,HOLDLOCK)             
      where             
            vtyp = @vtyp             
            and booktype = @booktype             
            and vdt = @@YearlyVdt + ' 00:00:00'             
            and VnoFlag = @@VnoFlag             
            and FinYear = @@FinYear            
            
            
      if @@ROWCOUNT=0            
         begin              
            -- If No Record Present, then Insert            
           select             
                  @@FldAuto=0,             
                  @@UpdtVdt = @@YearlyVdt,             
                  @@ReturnVno = Right(@@YearlyVdt,4) + '00000001',              
  @@Vno = Right(@@YearlyVdt,4) + Replicate('0', 8-len(@noofrecords)) + cast(@noofrecords as varchar)                
 end              
         else              
         begin              
           select             
            -- If record is Present, then Update            
                  @@UpdtVdt = @@YearlyVdt,             
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1))  ,            
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))              
         end              
   end              
            
-- Doing Daily Voucher Gen              
else if @@vnoflag = 1              
        begin              
            
          select             
                  @@FldAuto = isnull(FldAuto,0) ,              
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))             
            from         
                  V2_LastVno WITH (Index(VnoIdx), TABLOCKX,HOLDLOCK)             
            where             
                  vtyp = @vtyp             
                  and booktype = @booktype             
                  and vdt = @@DailyVDt + ' 00:00:00'              
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear            
            
            
          if  @@ROWCOUNT=0            
             begin              
            -- If No Record Present, then Insert            
                select             
                  @@FldAuto=0,             
                  @@UpdtVdt = @@DailyVdt,             
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+'0001'          ,    
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+ Replicate('0', 4-len(@noofrecords)) + cast(@noofrecords as varchar)    
    
             end              
          else              
             begin              
            -- If record is Present, then Update            
               select             
                  @@UpdtVdt = @@DailyVdt,             
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),              
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))              
    
             end              
        end              
            
-- Doing Monthly Voucher Gen              
else if @@vnoflag = 2              
        begin              
          select             
                  @@FldAuto = isnull(FldAuto,0) ,             
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))             
            from             
                  V2_LastVno WITH (index(VNoIdx), TABLOCKX,HOLDLOCK)             
            where             
                  vtyp = @vtyp             
                  and booktype = @booktype             
                  and vdt = @@MonthlyVDt + ' 00:00:00'              
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear            
            
            
          if  @@ROWCOUNT=0            
             begin              
            -- If No Record Present, then Insert            
                select             
                  @@FldAuto=0,             
                  @@UpdtVdt = @@MonthlyVdt,             
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+'000001',              
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+ Replicate('0', 6-len(@noofrecords)) + cast(@noofrecords as varchar)    
    
             end              
         else              
             begin              
            -- If record is Present, then Update            
               select             
                  @@UpdtVdt = @@MonthlyVdt,             
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),              
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))              
    
             end              
        end      
            
              
if @@error <> 0               
begin              
 rollback transaction              
 select vno = ''              
 return              
end               
else              
begin              
       if isnull(@@vno,'') <> ''               
       begin              
                  if isnull(@@FldAuto,0) = 0              
                  begin              
                    -- If No Record Present, then Insert            
                        insert into V2_LastVno             
                        (Vtyp, BookType, Vdt, LastVno, VnoFlag, FinYear)            
                        values             
                        (@vtyp,@booktype,@@UpdtVdt,@@vno, @@VnoFlag, @@FinYear)              
                  end              
                  else              
                  begin              
                        -- If record is Present, then Update            
                        Update             
                              V2_LastVno             
                        set             
                              Lastvno = @@Vno             
                        where             
                              FldAuto = @@FldAuto              
                  end             
     
                        commit transaction              
    
                        select vno = @@Returnvno              
                        return              
       end               
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_GenVno_new_ForMo
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.V2_Acc_GenVNo    Script Date: 09/30/2005 12:23:51 ******/          
          
/*        
-------------------------------------        
New Procedure to Generate VNO        
-------------------------------------        
        
Author            : Uppili Krishnan        
Date               : Sep 30 2005        
Reviewed By   :        
Review Date   :        
Tested By       :           
Tested Date    :        
        
-------------------------------------        
        
                
      Flags:        
            VnoFlag = 0 Yearly        
            VnoFlag = 1 Daily        
            VnoFlag = 2 Monthly        
        
Logic:        
      Generates 1 record per day for the combination of VnoFlag, VoucherDate, Financial Year Combination        
      if for the above combination record is not present in V2_LastVno table then a new record is inserted        
            else existing record is updated        
        
        
                                 
*/          
          
CREATE PROC [dbo].[Acc_GenVno_new_ForMo]
@vdt      varchar(11),  /* dd/mm/yyyy */          
@vtyp     smallint,          
@booktype varchar(2),          
@sdtcur   varchar(11),          
@ldtcur   varchar(11)          
/* @vnoflag  int */          
as          
          
          
          
Declare @@voudt  as datetime          
Declare @@maxvno as numeric(12,0)          
Declare @@vnoflag as tinyint          
Declare @@vno as varchar(12)          
Declare @@rcnt as int          
Declare @@FldAuto bigint          
Declare @@YearlyVdt varchar(11)        
Declare @@DailyVDt Varchar(11)          
Declare @@MonthlyVdt varchar(11)          
Declare @@UpdtVdt varchar(11)          
Declare @@FinYear smallint        
          
--SET NOCOUNT ON          
set Xact_abort on          
          
begin transaction          
  
Select   
      @sdtcur = LEFT(SDTCUR,11),   
      @ldtcur = LEFT(LDTCUR,11),   
      @@vnoflag = vnoflag,         
      @@FinYear = FldAuto          
from   
      Parameter   
where    
      convert(datetime,@vdt) BETWEEN sdtcur and ldtcur   
  
/*  
Select         
from         
      Parameter         
where          
      sdtcur like @sdtcur + '%'         
      and ldtcur like @ldtcur + '%'        
*/        
        
/*         
Reinitialising the Dates to be posted in the table.          
      For Daily, the Voucher Date is taken        
      For Monthly, the 1st Day of the Month  is Taken        
      For Yearly, the first Day of the year is taken        
*/        
        
select         
      @@voudt = (select convert(datetime,@vdt)),         
      @@MonthlyVdt = left(@Vdt,4)+' 1 '+right(@Vdt,4),         
      @@DailyVdt = @Vdt,         
      @@YearlyVdt = LEFT(@SDTCUR,4) + ' 1 '+ right(@SDTCUR,4)        
    
-- Doing Yearly Voucher Gen          
if @@vnoflag = 0          
   begin          
      select         
            @@FldAuto = isnull(FldAuto,0) ,         
            @@maxvno = convert(NUMERIC,isnull(lastvno,0))         
      from         
            V2_LastVno WITH (INDEX(VNOIDX),TABLOCKX,HOLDLOCK)         
      where         
            vtyp = @vtyp         
            and booktype = @booktype         
            and vdt = @@YearlyVdt + ' 00:00:00'         
            and VnoFlag = @@VnoFlag         
            and FinYear = @@FinYear        
        
        
      if @@ROWCOUNT=0        
         begin          
            -- If No Record Present, then Insert        
           select         
                  @@FldAuto=0,         
                  @@UpdtVdt = @@YearlyVdt,         
                  @@vno = Right(@@YearlyVdt,4) + '00000001'          
         end          
         else          
         begin          
           select         
            -- If record is Present, then Update        
                  @@UpdtVdt = @@YearlyVdt,         
                  @@vno = rtrim(convert(varchar,@@maxvno + 1))          
         end          
   end          
        
-- Doing Daily Voucher Gen          
else if @@vnoflag = 1          
        begin      
        
          select         
                  @@FldAuto = isnull(FldAuto,0) ,          
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))         
            from         
                  V2_LastVno WITH (Index(VnoIdx), TABLOCKX,HOLDLOCK)         
            where         
                  vtyp = @vtyp         
                  and booktype = @booktype         
                  and vdt = @@DailyVDt + ' 00:00:00'          
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear        
        
        
          if  @@ROWCOUNT=0        
             begin          
            -- If No Record Present, then Insert        
                select         
                  @@FldAuto=0,         
                  @@UpdtVdt = @@DailyVdt,         
                  @@vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+'0001'          
             end          
          else          
             begin          
            -- If record is Present, then Update        
               select         
                  @@UpdtVdt = @@DailyVdt,         
                  @@vno = rtrim(convert(varchar,@@maxvno + 1))          
             end          
        end          
        
-- Doing Monthly Voucher Gen          
else if @@vnoflag = 2          
        begin          
          select         
                  @@FldAuto = isnull(FldAuto,0) ,         
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))         
            from         
                  V2_LastVno WITH (index(VNoIdx), TABLOCKX,HOLDLOCK)         
            where         
                  vtyp = @vtyp         
                  and booktype = @booktype         
                  and vdt = @@MonthlyVDt + ' 00:00:00'          
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear        
        
        
          if  @@ROWCOUNT=0        
             begin          
            -- If No Record Present, then Insert        
                select         
                  @@FldAuto=0,         
                  @@UpdtVdt = @@MonthlyVdt,         
                  @@vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+'000001'          
             end          
         else          
             begin          
            -- If record is Present, then Update        
               select         
                  @@UpdtVdt = @@MonthlyVdt,         
                  @@vno = rtrim(convert(varchar,@@maxvno + 1))          
             end          
        end          
        
          
if @@error <> 0           
begin          
 rollback transaction          
 select vno = ''          
 return          
end           
else          
begin          
       if isnull(@@vno,'') <> ''           
       begin          
                  if isnull(@@FldAuto,0) = 0          
                  begin          
                        -- If No Record Present, then Insert        
                        insert into V2_LastVno         
                        (Vtyp, BookType, Vdt, LastVno, VnoFlag, FinYear)        
                        values         
                        (@vtyp,@booktype,@@UpdtVdt,@@vno, @@VnoFlag, @@FinYear)          
                  end          
                  else          
                  begin          
                        -- If record is Present, then Update        
                        Update         
                              V2_LastVno         
                        set         
                              Lastvno = @@Vno         
                        where         
                              FldAuto = @@FldAuto          
                  end          
                        commit transaction          
                        select vno = @@vno          
                        return          
       end           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_GetSlipNo
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.acc_GetSlipNo    Script Date: 06/24/2004 8:32:35 PM ******/    
    
/****** Object:  Stored Procedure dbo.acc_GetSlipNo    Script Date: 05/10/2004 5:29:36 PM ******/    
    
/****** Object:  Stored Procedure dbo.acc_GetSlipNo    Script Date: 04/07/2003 12:28:25 PM ******/    
CREATE PROCEDURE  [dbo].[acc_GetSlipNo]    
@cltcode varchar(10),    
@booktype varchar(2),    
@flag integer    
AS    
/*    
select distinct convert(integer,slipno) slipno from slipreceipt order by slipno     
*/    
    
if @flag = 1    
begin    
 select distinct slipno     
 from ledger1 l1, ledger l    
 where l1.vtyp = l.vtyp and l1.booktype= l.booktype and l1.vno = l.vno     
 and l.cltcode = @cltcode and l1.vtyp in (2,19) and l1.booktype = @booktype and slipno <> 0    
 order by slipno    
end    
else    
begin    
 select distinct convert(varchar,slipdate,103)  slipdate from ledger1 l    
 where l.vtyp in (2,19) and l.booktype =@booktype  and slipno <> 0    
 order by convert(varchar,slipdate,103)    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_opbal
-- --------------------------------------------------
CREATE Procedure [dbo].[Acc_opbal]
@Sdate Varchar(11),            /* As Mmm Dd Yyyy */
@Edate Varchar(11),            /* As Mmm Dd Yyyy */
@Fdate Varchar(11),            /* As Mmm Dd Yyyy */
@Tdate Varchar(11),            /* As Mmm Dd Yyyy */
@Fcode Varchar(10), 
@Tcode Varchar(10), 
@Statusid Varchar(30), 
@Statusname Varchar(30), 
@Branch Varchar(10), 
@Selectionby Varchar(3), 
@Groupby Varchar(10), 
@Sortby Varchar(50), 
@Reportname Varchar(30), 
@Reportopt Varchar(10), 
@Fld1 Varchar(10), 
@Fld2 Varchar(10), 
@Fld3 Varchar(10)
As
Declare
@@Opendate   As Varchar(11)
/* -------------------------------------------------------------------------- */
If Len(Rtrim(@Fdate)) = 10 
Begin
   Select @Fdate = Left(@Fdate, 3) + ' ' + Substring(@Fdate, 4, 7)
End
If Len(Rtrim(@Sdate)) = 10 
Begin
   Select @Sdate = Left(@Sdate, 3) + ' ' + Substring(@Sdate, 4, 7)
End
If Len(Rtrim(@Tdate)) = 10 
Begin
   Select @Tdate = Left(@Tdate, 3) + ' ' + Substring(@Tdate, 4, 7)
End
If Len(Rtrim(@Edate)) = 10 
Begin
   Select @Edate = Left(@Edate, 3) + ' ' + Substring(@Edate, 4, 7)
End
If @Fdate = ''
Begin
   Select @Fdate = @Sdate
End
If @Tdate = ''
Begin
   Select @Tdate = @Edate
End
If @Reportname <> 'Marginledger'
Begin
/* Get Opendate From Sdate, Fdate Received As Parameter */
   If Upper(@Selectionby) = 'Vdt'
      Begin
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Ledger Where Vtyp = 18 And Vdt < = @Fdate )
      End
   Else
      Begin
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11) From Ledger Where Vtyp = 18 And Edt < = @Fdate )
   End
/* -------------------------------------------------------------------------- */     
   If Upper(@Selectionby) = 'Vdt'
      Begin
         If @Sdate = @Fdate
            Begin
  If @@Opendate = @Fdate 
  Begin
                Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)
                From Ledger 
                Where Cltcode = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18
                Group By Cltcode
  End
  Else
  Begin
                Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)
                From Ledger 
                Where Cltcode = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate 
                Group By Cltcode
  End
            End
         Else
            Begin
               Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)
               From Ledger 
               Where Cltcode = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate 
               Group By Cltcode
            End
      End
   Else
      Begin
         If @Sdate = @Fdate And @@Opendate = @Fdate
            Begin
               Select Cltcode, Opbal = Sum(Balamt)
               From Ledger 
               Where Cltcode = @Fcode And Edt Like @@Opendate + '%' And Vtyp = 18
               Group By Cltcode
            End
         Else
            Begin
               Select Cltcode, Opbal = Sum(Opbal)
               From
               ( Select Cltcode, Opbal = Sum(Balamt)
                 From Ledger 
                 Where Cltcode = @Fcode And Edt Like @@Opendate + '%' And Vtyp = 18
                 Group By Cltcode
                 Union All
                 Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)
                 From Ledger 
                 Where Cltcode = @Fcode And Edt > = @@Opendate + ' 00:00:00' And Edt < @Fdate And Vtyp <> 18
                 Group By Cltcode ) T
               Group By Cltcode
            End
      End
End
If @Reportname = 'Marginledger'
Begin
/* Get Opendate From Sdate, Fdate Received As Parameter */
   If Upper(@Selectionby) = 'Vdt'
      Begin
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Marginledger Where Vtyp = 18 And Vdt < = @Fdate )
      End
   Else
      Begin
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Marginledger Where Vtyp = 18 And Vdt < = @Fdate )
   End
/* -------------------------------------------------------------------------- */     
   If Upper(@Selectionby) = 'Vdt'
      Begin
         If @Sdate = @Fdate
            Begin
  If @@Opendate = @Fdate 
  Begin
                Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)
                From Marginledger 
                Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18
                Group By Party_code
  End
  Else
  Begin
      Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)
                From Marginledger 
                Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate 
                Group By Party_code
  End
            End
         Else
            Begin
     Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)
               From Marginledger 
               Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate 
               Group By Party_code
            End
      End
   Else
      Begin
         If @Sdate = @Fdate And @@Opendate = @Fdate
            Begin
               Select Cltcode = Party_code, Opbal = Sum(Sett_no)
               From Marginledger 
               Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18
               Group By Party_code
            End
         Else
            Begin
               Select Cltcode, Opbal = Sum(Opbal)
               From
               ( Select Cltcode = Party_code, Opbal = Sum(Sett_no)
                 From Marginledger 
                 Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18
                 Group By Party_code
                 Union All
                 Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)
                 From Marginledger 
                 Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate And Vtyp <> 18
                 Group By Party_code) T
               Group By Cltcode
            End
      End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_PrintReconcile
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.acc_PrintReconcile    Script Date: 01/18/2006 16:45:54 ******/
--sp_helptext acc_printreconcile

/****** Object:  Stored Procedure dbo.acc_PrintReconcile    Script Date: 03/15/2003 11:24:48 AM ******/
CREATE PROCEDURE [dbo].[acc_PrintReconcile]
@code varchar(10),
@reporttype varchar(10),
@tdate  datetime,
@fdate  datetime
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

if upper(@reporttype) = 'STATEMENT'
begin
	select distinct vtyp, booktype, vno, lno into #tblbankreco from ledger where cltcode = @code

	select l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,
	isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then relamt else 0 end ),
	Cramt= (case when upper(l.drcr) = 'C' then relamt else 0 end ),
	treldt=isnull(convert(varchar, reldt , 103),''), l1.refno
	From ledger l left outer join LEDGER1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno,
	#tblbankreco t
	WHERE l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype
	and cltcode <> @code and vdt <=@tdate --and l.vtyp not in ( 16, 17) and l1.clear_mode not in ('C', 'R')
	and rtrim(l1.ddno) + convert(varchar,relamt) + convert(varchar(11),dddt,109)
	not in(select rtrim(ddno) + convert(varchar,relamt) + convert(varchar(11),dddt,109) from ledger1 l12, ledger l2 where l12.vno=l2.vno and l12.vtyp=l2.vtyp
	and l12.booktype=l2.booktype and l12.vtyp='16' and l2.vdt < @tdate and cltcode= @code)
	and (reldt ='1900-01-01 00:00:00.000' or reldt > @tdate )
	order by l.drcr, vdt, l.vtyp, l.vno
end

else
begin
	select l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,
	isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end ),
	Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),
	treldt=isnull(convert(varchar, reldt , 103),''), l1.refno
	From ledger l left outer join LEDGER1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno,
	(select distinct vtyp, booktype, vno, lno from ledger where cltcode = @code) t
	WHERE l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype
	and cltcode <> @code and vdt >= @fdate and vdt <= @tdate
	order by l.drcr, vdt, l.vtyp, l.vno
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_reports
-- --------------------------------------------------
CREATE procedure [dbo].[acc_reports] 
@sdate varchar(11),            /* As mmm dd yyyy */
@edate varchar(11),            /* As mmm dd yyyy */
@fdate varchar(11),            /* As mmm dd yyyy */
@tdate varchar(11),            /* As mmm dd yyyy */
@fcode varchar(10),
@tcode varchar(10),
@statusId varchar(30),
@statusname varchar(30),
@branch varchar(10),
@selectionby varchar(3),
@GroupBy varchar(10),
@Sortby varchar(50),
@reportname varchar(30),
@reportopt varchar(10),
@fld1 varchar(50),		/*  To be used for Sharedb in case of Party Ledger */
@fld2 varchar(10),
@fld3 varchar(10)

as
declare
@@opendate   as varchar(11),         
@@selectqury as varchar(8000),
@@fromtables as varchar(2000),
@@wherepart  as varchar(8000),
@@Groupby    as varchar(200),
@@sortby     as varchar(200),
@@uall       as varchar(20),
@@Uselectqury as varchar(8000),
@@Ufromtables as varchar(2000),
@@Uwherepart  as varchar(8000),
@@UGroupby    as varchar(200),
@@Usortby     varchar(200),
@@datefilter as varchar(500),
@@ReportFrom as varchar(1)

/* -------------------------------------------------------------------------- */
if @fdate = " " 
begin
   select @fdate = @sdate
end

if @tdate = " "
begin
   select @tdate = @edate
end

/* Get filter condition on dates based on the value of @selectionby */

if @selectionby = 'vdt'
begin
   select @@datefilter = " Where l.vdt >= '" + @fdate + " 00:00:00' and l.vdt <= '" + @tdate +" 23:59:59'"
end
else if @selectionby = 'edt'
begin
   select @@datefilter = " Where l.edt >= '" + @fdate + " 00:00:00' and l.edt <= '" + @tdate +" 23:59:59'"
end
/* -------------------------------------------------------------------------- */     

if @Reportname = 'Cash Book' 
begin

   if upper(@Sortby) = 'VDT'
         select @@sortby = " order by voudt, l.vtyp, l.vno"
   else if upper(@sortby) = 'EDT'
         select @@sortby = " order by effdt, l.vtyp, l.vno"
	   else if upper(@sortby) = 'VTYPE'
	         select @@sortby = " order by l.vtyp, l.vdt, l.vno"
		else if upper(@sortby) = 'ACCODE'
		     select @@sortby = " order by l.cltcode, l.vdt, l.vtyp, l.vno"
			else if upper(@sortby) = 'ACNAME'
			     select @@sortby = " order by l.acname, l.vdt, l.vtyp, l.vno"
			   else if upper(@sortby) = 'BOOKTYPE'
	        		 select @@sortby = " order by l.booktype, l.vdt, l.vtyp, l.vno"
				   else if upper(@sortby) = 'VNO'
		        		 select @@sortby = " order by l.vno, l.vdt, l.vtyp"
					   else if upper(@sortby) = 'DRCR'
	        				 select @@sortby = " order by l.drcr, l.vdt, l.vtyp, l.vno"
						   else if upper(@sortby) = 'AMOUNT'
	        					 select @@sortby = " order by l.vamt, l.vdt, l.vtyp, l.vno"



   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
         select @@selectqury = "Select l.booktype, l.vtyp, l.vno, vdt=convert(varchar,vdt,103), Edt = convert(varchar,l.edt,103), cltcode, Acname=isnull(acname,''), voudt=l.vdt, effdt=l.edt, Debit = (Case When upper(l.DRCR) = 'C' Then  Vamt  Else  0 End), Credit = (Case When upper(l.DRCR) = 'D' Then  Vamt   Else  0 End), l.narration , l.drcr"
         select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where cltcode = '" + @fcode + "') t, ledger l "
         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype "
         select @@groupby = " "
      end
   else
      begin
         select @@selectqury = "Select l.booktype, l.vtyp, l.vno, vdt=convert(varchar,vdt,103), Edt = convert(varchar,l.edt,103), cltcode=l2.cltcode, Acname=isnull(l.acname,''),voudt=l.vdt, effdt=l.edt, Debit = (Case When upper(l2.DRCR) = 'C' Then  camt Else  0 End), Credit = (Case When upper(l2.DRCR) = 'D' Then  camt   Else  0 End), l.narration, l2.drcr"
	 select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where cltcode = '" + @fcode + "') t, ledger2 l2, costmast c, ledger l "
         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode =l.cltcode "
         select @@groupby = " "
      end
end

if @Reportname = 'Bank Book' 
begin
   if upper(@Sortby) = 'VDT'
         select @@sortby = " order by voudt, l.vtyp, l.vno"
   else if upper(@sortby) = 'EDT'
         select @@sortby = " order by effdt, l.vtyp, l.vno"
	   else if upper(@sortby) = 'VTYPE'
	         select @@sortby = " order by l.vtyp, l.vdt, l.vno"
		else if upper(@sortby) = 'ACCODE'
		     select @@sortby = " order by l.cltcode, l.vdt, l.vtyp, l.vno"
			else if upper(@sortby) = 'ACNAME'
			     select @@sortby = " order by l.acname, l.vdt, l.vtyp, l.vno"
			   else if upper(@sortby) = 'BOOKTYPE'
	        		 select @@sortby = " order by l.booktype, l.vdt, l.vtyp, l.vno"
				   else if upper(@sortby) = 'VNO'
		        		 select @@sortby = " order by l.vno, l.vdt, l.vtyp"
					   else if upper(@sortby) = 'DRCR'
	        				 select @@sortby = " order by l.drcr, l.vdt, l.vtyp, l.vno"
						   else if upper(@sortby) = 'AMOUNT'
	        					 select @@sortby = " order by l.vamt, l.vdt, l.vtyp, l.vno"

   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
         select @@selectqury = "SELECT l.booktype, Vdt = convert(varchar,l.vdt,103), effdt = l.edt, Edt = convert(varchar,l.edt,103), cltcode, acname, L.VNO, l.vtyp, voudt=l.vdt, ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), Debit = (Case When upper(l.DRCR) = 'C' Then  Vamt  Else  0 End), Credit = (Case When upper(l.DRCR) ='D' Then  Vamt   Else  0 End), l.Narration "
         select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where " + @@datefilter + " and cltcode = '" + @fcode + "') t, ledger l "
         select @@wherepart =  " l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype "
         select @@groupby = " "
      end
   else
      begin
/*         select @@selectqury = "SELECT l.booktype, Vdt = convert(varchar,l.vdt,103), effdt = l.edt, Edt = convert(varchar,l.edt,103), l2.cltcode, acname, L.VNO, l.vtyp, voudt=l.vdt, ddno= isnull((select ddno from ledger1 l1 where l1.vno=l.vno and l1.vty

p=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), Debit = (Case When upper(l2.DRCR) = 'C' Then  camt  Else  0 End), Credit = (Case When upper(l2.DRCR) ='D' Then  camt   Else  0 End), l.Narration "
         select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where cltcode = '" + @fcode + "') t, ledger2 l2, costmast c, ledger l " */
/*         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype 

and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode not in ( select brcontrolac from branchaccounts ) " */
/*         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype 

and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode =l.cltcode " 
         select @@groupby = " " */
         select @@selectqury = "SELECT l.booktype, Vdt = convert(varchar,l.vdt,103), effdt = l.edt, Edt = convert(varchar,l.edt,103), l2.cltcode, acname, L.VNO, l.vtyp, voudt=l.vdt, ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), Debit = (Case When upper(l2.DRCR) = 'C' Then  camt  Else  0 End), Credit = (Case When upper(l2.DRCR) ='D' Then  camt   Else  0 End), l.Narration "
         select @@fromtables = " From (select distinct vtype, vno, booktype from ledger2 where cltcode = '" + @fcode + "') t, ledger2 l2, costmast c, ledger l " 
/*         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype 

and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode not in ( select brcontrolac from branchaccounts ) " */
         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode <> '" + @fcode + "' and l.vtyp = t.vtype and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode " 
         select @@groupby = " " 
      end
end

if @Reportname = 'GL' 
begin

/* Assign From and To account codes. */
   if @fcode = "" 
      begin
         select @fcode = (select min(cltcode) from acmast where accat <> 4)
      end

   if @tcode = "" 
      begin
         select @tcode = (select max(cltcode) from acmast where accat <> 4)
   end

   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
        select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno, l.narration, ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp, l.booktype, vdt = convert(varchar,l.vdt,103), edt = convert(varchar,l.edt,103), accat "
        select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode ,vmast v "
        select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode >= '" + @fcode + "' and l.cltcode <= '" + @tcode + "' And vtyp = vtype and a.cltcode = l.cltcode and a.accat <> '4' "
        select @@groupby = " "
        select @@sortby = " order by l.cltcode, voudt, l.vtyp desc, l.vno"  
      end
   else
      begin
        select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),  cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end), l.vno, l.narration, ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp, l.booktype, vdt = convert(varchar,l.vdt,103), edt = convert(varchar,l.edt,103), accat "
        select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c  "
        select @@wherepart = @@datefilter + " and l2.vtype <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat <> '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode "
        select @@groupby = " "
        select @@sortby = " order by l2.cltcode, voudt, l.vtyp desc, l.vno"  
      end
end

if @Reportname = 'PartyLedger'
begin

 select @@sortby = " voudt, l.vtyp desc, l.vno" 
 if upper(@Sortby) = 'VDT'
    select @@sortby = " voudt, l.vtyp desc, l.vno" 
   else if upper(@sortby) = 'EDT'
           select @@sortby = " effdt, l.vtyp desc, l.vno" 

 if rtrim(@branch) = '' or rtrim(@branch) = '%' 
	select @@sortby = " l.cltcode," + @@sortby
 else
	select @@sortby = " l2.cltcode," + @@sortby

 if upper(rtrim(@groupby)) = 'FAMILY'
    select @@sortby = " order by cm.family, " + @@sortby
 else if upper(rtrim(@groupby)) = 'SUBBROKER'
       select @@sortby = " order by c1.Sub_Broker, " + @@sortby

 if left(@@sortby,6) <> ' order' 
    select @@sortby = " order by " + @@sortby
      
   if upper(rtrim(@groupby)) = 'FAMILY'
   begin
      if rtrim(@branch) = '' or rtrim(@branch) = '%' 
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast, clientmaster cm " 
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode = a.cltcode and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype and l.cltcode = cm.party_code"
            select @@groupby = " "
         end
      else
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c, clientmaster cm   "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat = '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode = cm.party_code "
            select @@groupby = " "
         end  
   end
   else if upper(rtrim(@groupby)) = 'SUBBROKER'
   begin
      if rtrim(@branch) = '' or rtrim(@branch) = '%' 
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast, " + rtrim(@fld1) + ".dbo.client1 c1, " + rtrim(@fld1) + ".dbo.client2 c2 "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode = a.cltcode and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype and l.cltcode = c2.party_code and c2.cl_code = c1.cl_code "

            select @@groupby = " "
         end
      else
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c,  " + rtrim(@fld1) + ".dbo.client1 c1, " + rtrim(@fld1) + ".dbo.client2 c2 "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat = '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode = c2.party_code and c2.cl_code = c1.cl_code "
            select @@groupby = " "
         end  
   end
   else
   begin
   if upper(@statusid) = 'BROKER' or upper(@statusid) = 'BRANCH' 
   begin
      if rtrim(@branch) = '' or rtrim(@branch) = '%' 
         begin
         select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode = a.cltcode and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype "
            select @@groupby = " "
         end
      else
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c  "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat = '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode "
            select @@groupby = " "
            select @@sortby = " order by l2.cltcode, voudt, l.vtyp desc, l.vno"
         end
   end
   else
   if upper(@statusid) = 'SUBBROKER'
   begin
      select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast, client1 c1, client2 c2 "
      select @@wherepart = @@datefilter + " and l.vtyp <> 18 and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.cltcode = c2.party_code and c2.cl_code = c1.cl_code and upper(Sub_Broker) = upper(@statusname) and l.vtyp = vtype "
      select @@groupby = " "
   end
   else
   begin
      select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast "
      select @@wherepart = @@datefilter + " and l.vtyp <> 18 and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype "
      select @@groupby = " "
   end
   end
end

if @Reportname = 'MarginLedger'
begin
   if @selectionby = 'vdt'
      begin
         select @@sortby = " order by l.cltcode, voudt, l.vtyp desc, l.vno"
      end
   else
      begin
         select @@sortby = " order by l.cltcode, effdt, l.vtyp desc, l.vno"
      end
   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
         select @@selectqury = "select m.booktype, voudt=m.vdt, effdt=l.edt, l.Acname, isnull(shortdesc,'') shortdesc, drMargin = (case when upper(m.drcr) = 'D' then amount else 0 end ), crMargin = (case when upper(m.drcr) = 'C' then amount else 0 end ), m.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=m.vno and l1.vtyp=m.vtyp and l1.booktype=m.booktype and l1.lno = m.lno),''), l.Narration, m.party_code, a.longname, m.vtyp, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt "


         select @@fromtables = " from marginledger m left outer join ledger l on m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and m.lno = l.lno left outer join acmast a on m.party_code = a.cltcode , vmast v "
         select @@wherepart = @@datefilter + " and m.party_code >= '" + @fcode + "' and m.party_code <= '" + @tcode + "' and m.vtyp <> 18 and accat = '4' and m.vtyp = v.vtype "
         select @@groupby = " "
         select @@sortby = " order by m.party_code, voudt, m.vtyp desc, m.vno"
      end
   else
      begin
         select @@selectqury = "select m.booktype, voudt=m.vdt, effdt=l.edt, l.Acname, isnull(shortdesc,'') shortdesc, drMargin = (case when upper(m.drcr) = 'D' then amount else 0 end ), crMargin = (case when upper(m.drcr) = 'C' then amount else 0 end ), m.vno, ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=m.vno and l1.vtyp=m.vtyp and l1.booktype=m.booktype and l1.lno = m.lno),''), l.Narration, m.party_code, a.longname, m.vtyp, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt "

         select @@fromtables = " from ledger l, costmast c, marginledger m left outer join ledger2 l2 on m.vtyp = l2.vtype and m.booktype = l2.booktype and m.vno = l2.vno and m.lno = l2.lno left outer join acmast a on m.party_code = a.cltcode , vmast  v "

         select @@wherepart = @@datefilter + " and m.party_code >= '" + @fcode + "' and m.party_code <= '" + @tcode + "' and m.vtyp <> 18 and accat = '4' and m.vtyp = v.vtype and m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and m.lno = l.lno and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode "
         select @@groupby = " "
         select @@sortby = " order by m.party_code, voudt, l.vtyp desc, l.vno"
      end
end

Print @@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby 


exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_reports_bak
-- --------------------------------------------------
CREATE procedure [dbo].[acc_reports_bak] 
@sdate varchar(11),            /* As mmm dd yyyy */
@edate varchar(11),            /* As mmm dd yyyy */
@fdate varchar(11),            /* As mmm dd yyyy */
@tdate varchar(11),            /* As mmm dd yyyy */
@fcode varchar(10),
@tcode varchar(10),
@statusId varchar(30),
@statusname varchar(30),
@branch varchar(10),
@selectionby varchar(3),
@GroupBy varchar(10),
@Sortby varchar(50),
@reportname varchar(30),
@reportopt varchar(10),
@fld1 varchar(50),		/*  To be used for Sharedb in case of Party Ledger */
@fld2 varchar(10),
@fld3 varchar(10)

as
declare
@@opendate   as varchar(11),         
@@selectqury as varchar(8000),
@@fromtables as varchar(2000),
@@wherepart  as varchar(8000),
@@Groupby    as varchar(200),
@@sortby     as varchar(200),
@@uall       as varchar(20),
@@Uselectqury as varchar(8000),
@@Ufromtables as varchar(2000),
@@Uwherepart  as varchar(8000),
@@UGroupby    as varchar(200),
@@Usortby     varchar(200),
@@datefilter as varchar(500),
@@ReportFrom as varchar(1)

/* -------------------------------------------------------------------------- */
if @fdate = " " 
begin
   select @fdate = @sdate
end

if @tdate = " "
begin
   select @tdate = @edate
end

/* Get filter condition on dates based on the value of @selectionby */

if @selectionby = 'vdt'
begin
   select @@datefilter = " Where l.vdt >= '" + @fdate + " 00:00:00' and l.vdt <= '" + @tdate +" 23:59:59'"
end
else if @selectionby = 'edt'
begin
   select @@datefilter = " Where l.edt >= '" + @fdate + " 00:00:00' and l.edt <= '" + @tdate +" 23:59:59'"
end
/* -------------------------------------------------------------------------- */     

if @Reportname = 'Cash Book' 
begin

   if upper(@Sortby) = 'VDT'
         select @@sortby = " order by voudt, l.vtyp, l.vno"
   else if upper(@sortby) = 'EDT'
         select @@sortby = " order by effdt, l.vtyp, l.vno"
	   else if upper(@sortby) = 'VTYPE'
	         select @@sortby = " order by l.vtyp, l.vdt, l.vno"
		else if upper(@sortby) = 'ACCODE'
		     select @@sortby = " order by l.cltcode, l.vdt, l.vtyp, l.vno"
			else if upper(@sortby) = 'ACNAME'
			     select @@sortby = " order by l.acname, l.vdt, l.vtyp, l.vno"
			   else if upper(@sortby) = 'BOOKTYPE'
	        		 select @@sortby = " order by l.booktype, l.vdt, l.vtyp, l.vno"
				   else if upper(@sortby) = 'VNO'
		        		 select @@sortby = " order by l.vno, l.vdt, l.vtyp"
					   else if upper(@sortby) = 'DRCR'
	        				 select @@sortby = " order by l.drcr, l.vdt, l.vtyp, l.vno"
						   else if upper(@sortby) = 'AMOUNT'
	        					 select @@sortby = " order by l.vamt, l.vdt, l.vtyp, l.vno"



   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
         select @@selectqury = "Select l.booktype, l.vtyp, l.vno, vdt=convert(varchar,vdt,103), Edt = convert(varchar,l.edt,103), cltcode, Acname=isnull(acname,''), voudt=l.vdt, effdt=l.edt, Debit = (Case When upper(l.DRCR) = 'C' Then  Vamt  Else  0 End), Credit = (Case When upper(l.DRCR) = 'D' Then  Vamt   Else  0 End), l.narration , l.drcr"
         select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where cltcode = '" + @fcode + "') t, ledger l "
         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype "
         select @@groupby = " "
      end
   else
      begin
         select @@selectqury = "Select l.booktype, l.vtyp, l.vno, vdt=convert(varchar,vdt,103), Edt = convert(varchar,l.edt,103), cltcode=l2.cltcode, Acname=isnull(l.acname,''),voudt=l.vdt, effdt=l.edt, Debit = (Case When upper(l2.DRCR) = 'C' Then  camt Else  0 End), Credit = (Case When upper(l2.DRCR) = 'D' Then  camt   Else  0 End), l.narration, l2.drcr"
	 select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where cltcode = '" + @fcode + "') t, ledger2 l2, costmast c, ledger l "
         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode =l.cltcode "
         select @@groupby = " "
      end
end

if @Reportname = 'Bank Book' 
begin
   if upper(@Sortby) = 'VDT'
         select @@sortby = " order by voudt, l.vtyp, l.vno"
   else if upper(@sortby) = 'EDT'
         select @@sortby = " order by effdt, l.vtyp, l.vno"
	   else if upper(@sortby) = 'VTYPE'
	         select @@sortby = " order by l.vtyp, l.vdt, l.vno"
		else if upper(@sortby) = 'ACCODE'
		     select @@sortby = " order by l.cltcode, l.vdt, l.vtyp, l.vno"
			else if upper(@sortby) = 'ACNAME'
			     select @@sortby = " order by l.acname, l.vdt, l.vtyp, l.vno"
			   else if upper(@sortby) = 'BOOKTYPE'
	        		 select @@sortby = " order by l.booktype, l.vdt, l.vtyp, l.vno"
				   else if upper(@sortby) = 'VNO'
		        		 select @@sortby = " order by l.vno, l.vdt, l.vtyp"
					   else if upper(@sortby) = 'DRCR'
	        				 select @@sortby = " order by l.drcr, l.vdt, l.vtyp, l.vno"
						   else if upper(@sortby) = 'AMOUNT'
	        					 select @@sortby = " order by l.vamt, l.vdt, l.vtyp, l.vno"

   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
         select @@selectqury = "SELECT l.booktype, Vdt = convert(varchar,l.vdt,103), effdt = l.edt, Edt = convert(varchar,l.edt,103), cltcode, acname, L.VNO, l.vtyp, voudt=l.vdt, ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), Debit = (Case When upper(l.DRCR) = 'C' Then  Vamt  Else  0 End), Credit = (Case When upper(l.DRCR) ='D' Then  Vamt   Else  0 End), l.Narration "
         select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where '" + @@datefilter + "' and cltcode = '" + @fcode + "') t, ledger l "
         select @@wherepart =  " l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype "
         select @@groupby = " "
      end
   else
      begin
/*         select @@selectqury = "SELECT l.booktype, Vdt = convert(varchar,l.vdt,103), effdt = l.edt, Edt = convert(varchar,l.edt,103), l2.cltcode, acname, L.VNO, l.vtyp, voudt=l.vdt, ddno= isnull((select ddno from ledger1 l1 where l1.vno=l.vno and l1.vty

p=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), Debit = (Case When upper(l2.DRCR) = 'C' Then  camt  Else  0 End), Credit = (Case When upper(l2.DRCR) ='D' Then  camt   Else  0 End), l.Narration "
         select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where cltcode = '" + @fcode + "') t, ledger2 l2, costmast c, ledger l " */
/*         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype 

and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode not in ( select brcontrolac from branchaccounts ) " */
/*         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype 

and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode =l.cltcode " 
         select @@groupby = " " */
         select @@selectqury = "SELECT l.booktype, Vdt = convert(varchar,l.vdt,103), effdt = l.edt, Edt = convert(varchar,l.edt,103), l2.cltcode, acname, L.VNO, l.vtyp, voudt=l.vdt, ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), Debit = (Case When upper(l2.DRCR) = 'C' Then  camt  Else  0 End), Credit = (Case When upper(l2.DRCR) ='D' Then  camt   Else  0 End), l.Narration "
         select @@fromtables = " From (select distinct vtype, vno, booktype from ledger2 where cltcode = '" + @fcode + "') t, ledger2 l2, costmast c, ledger l " 
/*         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype 

and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode not in ( select brcontrolac from branchaccounts ) " */
         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode <> '" + @fcode + "' and l.vtyp = t.vtype and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode " 
         select @@groupby = " " 
      end
end

if @Reportname = 'GL' 
begin

/* Assign From and To account codes. */
   if @fcode = "" 
      begin
         select @fcode = (select min(cltcode) from acmast where accat <> 4)
      end

   if @tcode = "" 
      begin
         select @tcode = (select max(cltcode) from acmast where accat <> 4)
   end

   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
        select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno, l.narration, ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp, l.booktype, vdt = convert(varchar,l.vdt,103), edt = convert(varchar,l.edt,103), accat "
        select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode ,vmast v "
        select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode >= '" + @fcode + "' and l.cltcode <= '" + @tcode + "' And vtyp = vtype and a.cltcode = l.cltcode and a.accat <> '4' "
        select @@groupby = " "
        select @@sortby = " order by l.cltcode, voudt, l.vtyp desc, l.vno"  
      end
   else
      begin
        select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),  cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end), l.vno, l.narration, ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp, l.booktype, vdt = convert(varchar,l.vdt,103), edt = convert(varchar,l.edt,103), accat "
        select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c  "
        select @@wherepart = @@datefilter + " and l2.vtype <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat <> '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode "
        select @@groupby = " "
        select @@sortby = " order by l2.cltcode, voudt, l.vtyp desc, l.vno"  
      end
end

if @Reportname = 'PartyLedger'
begin

 select @@sortby = " voudt, l.vtyp desc, l.vno" 
 if upper(@Sortby) = 'VDT'
    select @@sortby = " voudt, l.vtyp desc, l.vno" 
   else if upper(@sortby) = 'EDT'
           select @@sortby = " effdt, l.vtyp desc, l.vno" 

 if rtrim(@branch) = '' or rtrim(@branch) = '%' 
	select @@sortby = " l.cltcode," + @@sortby
 else
	select @@sortby = " l2.cltcode," + @@sortby

 if upper(rtrim(@groupby)) = 'FAMILY'
    select @@sortby = " order by cm.family, " + @@sortby
 else if upper(rtrim(@groupby)) = 'SUBBROKER'
       select @@sortby = " order by c1.Sub_Broker, " + @@sortby

 if left(@@sortby,6) <> ' order' 
    select @@sortby = " order by " + @@sortby
      
   if upper(rtrim(@groupby)) = 'FAMILY'
   begin
      if rtrim(@branch) = '' or rtrim(@branch) = '%' 
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast, clientmaster cm " 
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode = a.cltcode and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype and l.cltcode = cm.party_code"
            select @@groupby = " "
         end
      else
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c, clientmaster cm   "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat = '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode = cm.party_code "
            select @@groupby = " "
         end  
   end
   else if upper(rtrim(@groupby)) = 'SUBBROKER'
   begin
      if rtrim(@branch) = '' or rtrim(@branch) = '%' 
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast, " + rtrim(@fld1) + ".dbo.client1 c1, " + rtrim(@fld1) + ".dbo.client2 c2 "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode = a.cltcode and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype and l.cltcode = c2.party_code and c2.cl_code = c1.cl_code "

            select @@groupby = " "
         end
      else
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c,  " + rtrim(@fld1) + ".dbo.client1 c1, " + rtrim(@fld1) + ".dbo.client2 c2 "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat = '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode = c2.party_code and c2.cl_code = c1.cl_code "
            select @@groupby = " "
         end  
   end
   else
   begin
   if upper(@statusid) = 'BROKER' or upper(@statusid) = 'BRANCH' 
   begin
      if rtrim(@branch) = '' or rtrim(@branch) = '%' 
         begin
         select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode = a.cltcode and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype "
            select @@groupby = " "
         end
      else
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c  "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat = '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode "
            select @@groupby = " "
            select @@sortby = " order by l2.cltcode, voudt, l.vtyp desc, l.vno"
         end
   end
   else
   if upper(@statusid) = 'SUBBROKER'
   begin
      select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast, client1 c1, client2 c2 "
      select @@wherepart = @@datefilter + " and l.vtyp <> 18 and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.cltcode = c2.party_code and c2.cl_code = c1.cl_code and upper(Sub_Broker) = upper(@statusname) and l.vtyp = vtype "
      select @@groupby = " "
   end
   else
   begin
      select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast "
      select @@wherepart = @@datefilter + " and l.vtyp <> 18 and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype "
      select @@groupby = " "
   end
   end
end

if @Reportname = 'MarginLedger'
begin
   if @selectionby = 'vdt'
      begin
         select @@sortby = " order by l.cltcode, voudt, l.vtyp desc, l.vno"
      end
   else
      begin
         select @@sortby = " order by l.cltcode, effdt, l.vtyp desc, l.vno"
      end
   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
         select @@selectqury = "select m.booktype, voudt=m.vdt, effdt=l.edt, l.Acname, isnull(shortdesc,'') shortdesc, drMargin = (case when upper(m.drcr) = 'D' then amount else 0 end ), crMargin = (case when upper(m.drcr) = 'C' then amount else 0 end ), m.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=m.vno and l1.vtyp=m.vtyp and l1.booktype=m.booktype and l1.lno = m.lno),''), l.Narration, m.party_code, a.longname, m.vtyp, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt "


         select @@fromtables = " from marginledger m left outer join ledger l on m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and m.lno = l.lno left outer join acmast a on m.party_code = a.cltcode , vmast v "
         select @@wherepart = @@datefilter + " and m.party_code >= '" + @fcode + "' and m.party_code <= '" + @tcode + "' and m.vtyp <> 18 and accat = '4' and m.vtyp = v.vtype "
         select @@groupby = " "
         select @@sortby = " order by m.party_code, voudt, m.vtyp desc, m.vno"
      end
   else
      begin
         select @@selectqury = "select m.booktype, voudt=m.vdt, effdt=l.edt, l.Acname, isnull(shortdesc,'') shortdesc, drMargin = (case when upper(m.drcr) = 'D' then amount else 0 end ), crMargin = (case when upper(m.drcr) = 'C' then amount else 0 end ), m.vno, ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=m.vno and l1.vtyp=m.vtyp and l1.booktype=m.booktype and l1.lno = m.lno),''), l.Narration, m.party_code, a.longname, m.vtyp, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt "

         select @@fromtables = " from ledger l, costmast c, marginledger m left outer join ledger2 l2 on m.vtyp = l2.vtype and m.booktype = l2.booktype and m.vno = l2.vno and m.lno = l2.lno left outer join acmast a on m.party_code = a.cltcode , vmast  v "

         select @@wherepart = @@datefilter + " and m.party_code >= '" + @fcode + "' and m.party_code <= '" + @tcode + "' and m.vtyp <> 18 and accat = '4' and m.vtyp = v.vtype and m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and m.lno = l.lno and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode "
         select @@groupby = " "
         select @@sortby = " order by m.party_code, voudt, l.vtyp desc, l.vno"
      end
end

Print @@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby 


exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_valansum
-- --------------------------------------------------
CREATE Proc [dbo].[Acc_valansum]  
@Branchcd As Varchar(10),   
@Opendate As Varchar(11),   
@Closdate As Varchar(11),   
@Vtyp As Varchar(2),   
@Booktype Varchar(2),   
@Vno  Varchar(12),   
@Reportoption Char(1),   
@Baloption Char(1),   
@Sortby Varchar(10)  
As  
  
Declare   
@@Opbaldt As Varchar(11),   
@@Wherepart As Varchar(200),   
@@Frompart  As Varchar(300),   
@@Selectpart As Varchar(1000),   
@@Clbalpart  As Varchar(1000),   
@@Addwhere   As Varchar(100),   
@@Orderbypart As Varchar(100)  
  
Select @@Opbaldt = (Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Ledger L   
                    Where Vtyp = 18 And Vdt <= @Opendate)  
  
If @Reportoption = 'P'  
   Begin  
      Select @@Addwhere = " And A.Accat In ('4', '104')"  
   End  
Else If @Reportoption = 'O'  
   Begin  
      Select @@Addwhere = " And A.Accat Not In ('4', '104')"  
   End  
Else  
   Begin  
      Select @@Addwhere = " "  
   End  
  
If Rtrim(@Branchcd) = '%'   
   Begin  
 Select @@Selectpart = "Select L.Cltcode, A.Acname, Dramt = Isnull((Case When Upper(Drcr) = 'D' Then Vamt Else 0 End ), 0), Cramt = Isnull((Case When Upper(Drcr) = 'C' Then Vamt Else 0 End ), 0), Left(Convert(Varchar, Vdt, 103), 10) Vdt, "  
 Select @@Clbalpart = " Clbal = 0"  
 Select @@Frompart = " From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode "  
 Select @@Wherepart = " Where L.Vtyp = " + @Vtyp + " And L.Booktype = '" + @Booktype + "' And L.Vno = '" + @Vno + "'"  
        If Upper(Rtrim(@Sortby)) = 'Accode'  
       Select @@Orderbypart = " Order By L.Cltcode "  
        Else If Upper(Rtrim(@Sortby)) = 'Acname'  
        Select @@Orderbypart = " Order By A.Acname "  
             Else If Upper(Rtrim(@Sortby)) = 'Drcr'  
        Select @@Orderbypart = " Order By L.Drcr "  
   End  
Else  
   Begin  
 Select @@Selectpart = " Select L2.Cltcode, A.Acname, Dramt = Isnull((Case When Upper(Drcr) = 'D' Then Camt Else 0 End ), 0), Cramt = Isnull((Case When Upper(Drcr) = 'C' Then Camt Else 0 End ), 0), "  
 Select @@Clbalpart = " Clbal =  0"  
 Select @@Frompart = " From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Costmast C "  
 Select @@Wherepart = " Where L2.Vtype = " + @Vtyp + " And L2.Booktype = '" + @Booktype + "' And L2.Vno = '" + @Vno + "'"  
 Select @@Addwhere = @@Addwhere + " And L2.Costcode = C.Costcode And C.Costname = '" + Rtrim(@Branchcd) + "' "  
        If Upper(Rtrim(@Sortby)) = 'Accode'  
       Select @@Orderbypart = " Order By L2.Cltcode "  
        Else If Upper(Rtrim(@Sortby)) = 'Acname'  
        Select @@Orderbypart = " Order By A.Acname "  
             Else If Upper(Rtrim(@Sortby)) = 'Drcr'  
        Select @@Orderbypart = " Order By L2.Drcr "  
   End  
  
Print @@Selectpart + @@Clbalpart + @@Frompart + @@Wherepart + @@Addwhere + @@Orderbypart  
  
Exec (@@Selectpart + @@Clbalpart + @@Frompart + @@Wherepart + @@Addwhere + @@Orderbypart )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_valansumpartytotal
-- --------------------------------------------------
Create Proc [dbo].[Acc_valansumpartytotal]  
@Branchcd As Varchar(10),   
@Opendate As Varchar(11),   
@Closdate As Varchar(11),   
@Vtyp Smallint,   
@Booktype Varchar(2),   
@Vno  Varchar(12),   
@Reportoption Char(1),   
@Baloption Char(1),   
@Sortby Varchar(10)  
As  
If Rtrim(@Branchcd) = '%'   
   Begin  
 Select Dramt = Isnull(Sum((Case When Upper(Drcr) = 'D' Then Vamt Else 0 End )), 0),   
 Cramt = Isnull(Sum((Case When Upper(Drcr) = 'C' Then Vamt Else 0 End )), 0)   
 From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode   
 Where ( A.Accat = '4'  Or A.Accat = '104' )  
 And L.Vtyp = @Vtyp And L.Booktype = @Booktype And L.Vno = @Vno   
   End  
Else  
   Begin  
 Select Dramt = Isnull(Sum((Case When Upper(Drcr) = 'D' Then Camt Else 0 End )), 0),   
 Cramt = Isnull(Sum((Case When Upper(Drcr) = 'C' Then Camt Else 0 End )), 0)   
 From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Costmast C   
 Where A.Accat = '4'   
 And L2.Vtype = @Vtyp And L2.Booktype = @Booktype And L2.Vno = @Vno   
 And L2.Costcode = C.Costcode And C.Costname = Rtrim(@Branchcd)  
   End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AcnameSelect
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 05/10/2004 5:10:42 PM ******/  
  
/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 02/26/1980 1:57:20 AM ******/  
  
/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 01/04/1980 1:40:35 AM ******/  
  
  
  
/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 11/28/2001 12:23:39 PM ******/  
  
/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 11/24/2001 10:30:11 AM ******/  
/* Modified by Vaishali on 05/11/2001 Added flags from 4 to 6*/  
/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 10/08/2001 3:11:54 AM ******/  
CREATE Proc [dbo].[AcnameSelect]  
@flag integer  
As  
If @flag = 1   
begin    
 Select acname,a.accat,actyp,catname,cltcode from acmast a,  
        catmast c where c.accat = a.accat and c.accat not in  ('1','2','14')   
        order by acname   
end  
else if @flag = 2  
begin  
 Select acname,a.accat,actyp,catname,cltcode from acmast a,  
         catmast c where c.accat = a.accat and c.accat not in  ('14')   
         order by acname   
end    
else if @flag = 3  
begin  
        Select acname,a.accat,actyp,catname,cltcode from acmast a,  
        catmast c where c.accat = a.accat and c.accat  in  ('4')   
        order by acname   
end    
  
else if @flag = 4  /* For selecting Cash name and code*/  
begin  
 Select acname,cltcode from acmast   
         where  accat  =  '1'            
end  
  
else if @flag = 5 /* For selecting Bank name and code*/  
begin  
 Select acname,cltcode from acmast   
         where  accat  =  '2'            
end  
  
else if @flag = 6   /* For selecting Party name and code*/  
begin  
 Select acname,cltcode from acmast   
         where  accat  =  '4'            
end  
  
else if @flag = 7   /* For selecting all accounts other than party */  
begin  
 Select acname,cltcode from acmast   
         where  accat <> '4'            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Insert
-- --------------------------------------------------
CREATE Proc [dbo].[Add_Client_Account_Proc_Insert] (
@Exchange Varchar(3), 
@Segment Varchar(7), 
@Branch_Cd Varchar(10), 
@FromParty Varchar(10),
@ToParty Varchar(10),
@MainDate Varchar(30),
@DetDate Varchar(30)
) As

Update Owner Set Companyname = companyname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ageingcursor_NEW1_MO_BRANCH
-- --------------------------------------------------
CREATE Procedure [dbo].[Ageingcursor_NEW1_MO_BRANCH]   
@fromparty varchar(10),   
@toparty varchar(10),    
@opendate varchar(11),   
@todate varchar(11),   
@Reporttype varchar(15),   
@Branch varchar(10),   
@family varchar(10),   
@amoutgtthan money,        
@ageoption varchar(1),  
@dttype varchar(3),                                
@statusid varchar(10),                                
@statusname varchar(25),                        
@days1 int,                        
@days2 int,                        
@days3 int,                        
@days4 int,                        
@days5 int                        
   
as   
   
declare    
@@partycur as cursor,   
@@balcur as cursor,   
@@baldate as varchar(11),   
@@openbaldt as varchar(11),   
@@openbaldtmin as varchar(11),   
@@balamt as money,   
@@ocltcode as varchar(10),   
@@vtyp as smallint,   
@@vno varchar(12),           
@@EVdt as DATETIME,   
@@vamt as money,   
@@closbal as money,   
@@acname varchar(100),      
@@cltcode as varchar(10),   
@@Branchcode as varchar(25),   
@@area as varchar(25),
@@trader as varchar(25),
@@drcr    as varchar(1),   
@@startdt as datetime           
      
               
Set nocount on   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                           
            
Select @@startdt = ( select left(convert(varchar,dateadd(mm,-12,convert(datetime,@todate)),109),11) )   
                              
select @@branchcode = ''    
   
if upper(@statusid) = 'BROKER'   
begin        
if @Branch = ''                                
begin                        
   select @@branchcode = '%'   
   select @@area = '%'                
   select @@trader = '%'
end                         
else                        
begin                        
 select @@branchcode = @Branch                        
 select @@area = '%'   
 select @@trader = '%'
end                        
                        
end   
else if upper(@statusid) = 'BRANCH'   
begin        
   select @@branchcode = rtrim(@statusname)   
   select @@area = '%'   
   select @@trader = '%'
end      
else if upper(@statusid) = 'AREA'   
begin   
   select @@branchcode = '%'                                
   select @@area = rtrim(@statusname)                                
   select @@trader = '%'
end      
else if upper(@statusid) = 'TRADER'   
begin   
   select @@branchcode = '%'                                
   select @@area = '%'
   select @@trader = rtrim(@statusname)
end      
  
                              
  
    
CREATE TABLE [dbo].[#CloseBal]   
(    
  [CltCode] [varchar] (10) ,    
  [closbal] [money] NULL   
) ON [PRIMARY]    
  
CREATE   INDEX [indxtmp] ON [dbo].[#CloseBal] ([cltcode])               
                                  
    
CREATE TABLE [dbo].[#LedgerTran]   
(    
  [CltCode] [varchar] (10) ,    
  [VTyp] [smallint] NOT NULL ,    
  [Vno] [int]  NOT NULL ,    
  [EVdt] [datetime] NULL ,    
  [Vamt] [money] NULL ,    
  [ClosBal] [money] NULL ,  
  [RunningBal] [money] NULL   
) ON [PRIMARY]    
                
CREATE   INDEX [indxtmp1] ON [dbo].[#LedgerTran] ([cltcode])               
  
  
CREATE TABLE [dbo].[#fintempageing]   
(    
  [CltCode] [varchar] (10) ,    
  [BalAmt] [money] NULL ,    
  [AgeDays] [int] NULL ,    
  [DrCr] [char] (1)  ,    
)  
  
CREATE   INDEX [indxtmp3] ON [dbo].[#fintempageing] ([agedays])  
  
select @@openbaldtmin =  left(convert(varchar,isnull(min(vdt),0),109),11) from Ledger_Temp_New l      
where vtyp = 18 and vdt < = @opendate                            
  
                            
if @dttype='vdt'                                
 Begin  
   /* --------------     Getting  Closing Bal     ---------*/  
   select @@openbaldt=left(convert(varchar,isnull(max(vdt),0),109),11) from Ledger_Temp_New      
   where vtyp = '18' and vdt < = @opendate                                 
   if upper(@Reporttype) = 'PARTY'                                
   begin                                
    insert   into #CloseBal  
    select l.cltcode,  
    closbal = sum( case when drcr = 'd' then vamt else -vamt end)  
    from Ledger_Temp_New l WITH (INDEX(LEDIND_TEMP)) where vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'  
    and l.cltcode >= @fromparty and l.cltcode <= @toparty and branch_cd like @@branchcode+'%' and trader like @@trader + '%' 
    group by l.cltcode  
    having ABS(sum( case when drcr = 'd' then vamt else -vamt end)) > @amoutgtthan  
   end  
   else if upper(@Reporttype) = 'FAMILY'  
   begin  
    insert   into #CloseBal  
    Select Family as cltcode,  
    closbal = sum( case when drcr = 'd' then vamt else -vamt end)  
    from Ledger_Temp_New WITH (INDEX(LEDIND_TEMP)) where vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'  
    and family >= @fromparty and family <= @toparty  
    and Branch_cd like @@branchcode+'%'  and trader like @@trader + '%'  
    group by family  
    having ABS(sum( case when drcr = 'd' then vamt else -vamt end)) > @amoutgtthan  
   end  
   else if upper(@Reporttype) = 'FAMILYPARTY'  
   begin  
            insert   into #CloseBal          
            select l.cltcode,  
     closbal = sum( case when drcr = 'd' then vamt else -vamt end)  
            from Ledger_Temp_New l WITH (INDEX(LEDIND_TEMP)) where vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'  
            and l.cltcode >= @fromparty and l.cltcode <= @toparty     
            and Branch_cd like @@branchcode+'%'  and trader like @@trader + '%'  
            and family = @family         
            group by l.cltcode   
     having ABS(sum( case when drcr = 'd' then vamt else -vamt end)) > @amoutgtthan                
    end                                
  
  /* --------------     Getting Trans Data       ---------*/  
   if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'   
    begin   
        if upper(rtrim(@ageoption)) = 'D'                                
       begin                                
     insert into #LedgerTran  
     select l.cltcode, vtyp, vno, vdt, vamt, closbal,0  
     from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))   
     where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )  
     and l.cltcode = a.cltcode  
     and vdt <= @todate  + ' 23:59:59'           
     and vdt > DateAdd(month,-12,@@openbaldt)  
     and vtyp <> '18'   
       
     insert into #LedgerTran  
     select l.cltcode, vtyp, vno, vdt, vamt, closbal,0  
     from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))   
     where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )  
     and l.cltcode = a.cltcode  
     and vdt like @@openbaldtmin  + ' %'  
     and vtyp = 18      
       end  
       else if upper(rtrim(@ageoption)) = 'C'  
       begin  
     insert into #LedgerTran  
     select l.cltcode, vtyp, vno, vdt, vamt, closbal,0  
     from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))   
     where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )  
     and l.cltcode = a.cltcode  
     and vdt <= @todate  + ' 23:59:59'  
     and vdt > DateAdd(month,-12,@@openbaldt)  
     and vtyp <> '18'  
       
     insert into #LedgerTran  
     select l.cltcode, vtyp, vno, vdt, vamt, closbal,0  
     from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))   
     where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )   
     and l.cltcode = a.cltcode   
     and vdt like @@openbaldtmin  + ' %'       
     and vtyp = 18  
       end  
       else                                
       begin                                
     insert into #LedgerTran  
     select l.cltcode, vtyp, vno, vdt, vamt, closbal,0  
     from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))  
     where drcr = ( case when closbal >= 0 then 'd' else 'c' end )  
     and l.cltcode = a.cltcode   
     and vdt <= @todate  + ' 23:59:59'   
     and vdt > DateAdd(month,-12,@@openbaldt)  
     and vtyp <> '18'   
       
     insert into #LedgerTran  
     select l.cltcode, vtyp, vno, vdt, vamt, closbal,0  
     from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))       
     where drcr = ( case when closbal >= 0 then 'd' else 'c' end )  
     and l.cltcode = a.cltcode   
     and vdt like @@openbaldtmin  + ' %'       
     and vtyp = 18  
       end  
    end  
    else   
    begin   
        if upper(rtrim(@ageoption)) = 'D'    
            begin                             
     insert into #LedgerTran  
     select cltcode=family, vtyp, vno, vdt, vamt, closbal, 0  
     from #Ledger l , #tempageing a  with(index(indxtmp)) where a.cltcode = family  
     and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )    
     and vdt <= @todate  + ' 23:59:59'    
     and vdt > DateAdd(month,-12,@@openbaldt)  
     and family >= @fromparty and family <= @toparty    
     and vtyp <> '18'   
       
     insert into #LedgerTran  
     select cltcode=family, vtyp, vno, vdt, vamt, closbal, 0  
     from #Ledger l , #tempageing a  with(index(indxtmp)) where a.cltcode = family  
     and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )    
     and family >= @fromparty and family <= @toparty    
     and vdt like @@openbaldtmin  + ' %'       
     and vtyp = 18                                 
       end                                
       else if upper(rtrim(@ageoption)) = 'C'                      
       begin                                
     insert into #LedgerTran  
     select cltcode=family, vtyp, vno, vdt, vamt, closbal, 0  
     from #Ledger l , #tempageing a  with(index(indxtmp)) where  a.cltcode = family   
     and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )        
     and vdt <= @todate  + ' 23:59:59'    
     and vdt > DateAdd(month,-12,@@openbaldt)  
     and family >= @fromparty and family <= @toparty    
     and vtyp <> '18'   
                                 
     insert into #LedgerTran  
     select cltcode=family, vtyp, vno, vdt, vamt, closbal, 0  
     from #Ledger l , #tempageing a  with(index(indxtmp)) where  a.cltcode = family  
     and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )    
     and family >= @fromparty and family <= @toparty    
     and vdt like @@openbaldtmin  + ' %'                        
     and vtyp = 18           
       end                                
       else                               
       begin                                
     insert into #LedgerTran  
     select cltcode=family, vtyp, vno, vdt, vamt, closbal, 0  
     from #Ledger l , #tempageing a  with(index(indxtmp)) where a.cltcode = family   
     and drcr = ( case when closbal >= 0 then 'd' else 'c' end )    
     and vdt <= @todate  + ' 23:59:59'    
     and vdt > DateAdd(month,-12,@@openbaldt)  
     and l.cltcode = a.cltcode and family >= @fromparty and family <= @toparty    
     and vtyp <> '18'   
                      
     insert into #LedgerTran  
     select cltcode=family, vtyp, vno, vdt, vamt, closbal, 0  
     from #Ledger l , #tempageing a  with(index(indxtmp)) where a.cltcode = family   
     and drcr = ( case when closbal >= 0 then 'd' else 'c' end )          
     and family >= @fromparty and family <= @toparty    
     and vdt like @@openbaldtmin  + ' %'       
     and vtyp = 18           
       end                                
    end  
  End   
Else      /* -----------           Report by EDT --------------*/                        
 begin                                
  /* --------------     Getting  Closing Bal     ---------*/  
    select @@openbaldt=left(convert(varchar,isnull(max(edt),0),109),11) from Ledger_Temp_New      
    where vtyp = '18' and edt < = @opendate    
  
    if upper(@Reporttype) = 'PARTY'                                
     begin                                
           insert   into #CloseBal         
            select l.cltcode,   
            closbal = sum( case when drcr = 'd' then vamt else -vamt end)  
            from Ledger_Temp_New l with(index(LED2IND_EDT_TEMP)) where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'    
            and l.cltcode >= @fromparty and l.cltcode <= @toparty and branch_cd like @@branchcode+'%'   and trader like @@trader + '%'     
            group by l.cltcode   
     having ABS(sum( case when drcr = 'd' then vamt else -vamt end)) > @amoutgtthan         
     end                                
    else if upper(@Reporttype) = 'FAMILY'                                
     begin                                
            insert   into #CloseBal        
            Select Family as cltcode,  
            closbal = sum( case when drcr = 'd' then vamt else -vamt end)  
            from Ledger_Temp_New l with(index(LED2IND_EDT_TEMP))      
            where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'   
            and family >= @fromparty and family <= @toparty   
            and Branch_cd like @@branchcode+'%'  and trader like @@trader + '%'     
            group by family    
     having ABS(sum( case when drcr = 'd' then vamt else -vamt end)) > @amoutgtthan                
     end                                
    else if upper(@Reporttype) = 'FAMILYPARTY'                                
     begin                                
            insert   into #CloseBal          
            select l.cltcode,  
            closbal = sum( case when drcr = 'd' then vamt else -vamt end)  
            from Ledger_Temp_New l  with(index(LED2IND_EDT_TEMP))  
            where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'    
            and l.cltcode >= @fromparty and l.cltcode <= @toparty     
            and Branch_cd like @@branchcode+'%' and trader like @@trader + '%'                 
            and family = @family    
            group by l.cltcode  
     having ABS(sum( case when drcr = 'd' then vamt else -vamt end)) > @amoutgtthan                
     end                        
   
  /* --------------     Getting Trans Data       ---------*/                                
    if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'   
    begin   
       if upper(rtrim(@ageoption)) = 'D'                                
   begin                             
    insert into #LedgerTran  
    select l.cltcode, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))   
    where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )   
    and l.cltcode = a.cltcode  
    and edt <= @todate  + ' 23:59:59'    
    and edt > DateAdd(month,-12,@@openbaldt)  
    and vtyp <> '18'   
      
    insert into #LedgerTran        
    select l.cltcode, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))   
    where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )   
    and l.cltcode = a.cltcode  
    and edt like @@openbaldtmin  + ' %'       
    and vtyp = 18   
   end                                
      else if upper(rtrim(@ageoption)) = 'C'                                
   begin                                
    insert into #LedgerTran  
    select l.cltcode, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))                     
    where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )   
    and l.cltcode = a.cltcode   
    and edt <= @todate  + ' 23:59:59'   
    and edt > DateAdd(month,-12,@@openbaldt)  
    and vtyp <> '18'   
                    
    insert into #LedgerTran  
    select l.cltcode, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))   
    where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )   
    and l.cltcode = a.cltcode   
    and edt like @@openbaldtmin  + ' %'       
    and vtyp = 18   
   end                                
      else                                
   begin                                
    insert into #LedgerTran  
    select l.cltcode, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))   
    where drcr = ( case when closbal >= 0 then 'd' else 'c' end )   
    and l.cltcode = a.cltcode   
    and edt <= @todate  + ' 23:59:59'   
    and edt > DateAdd(month,-12,@@openbaldt)  
    and vtyp <> '18'   
              
    insert into #LedgerTran  
    select l.cltcode, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp))   
    where drcr = ( case when closbal >= 0 then 'd' else 'c' end )   
    and l.cltcode = a.cltcode   
    and edt like @@openbaldtmin  + ' %'       
    and vtyp = 18   
   end                                
    end                                
   else   
    begin   
       if upper(rtrim(@ageoption)) = 'D'    
   begin                                
    insert into #LedgerTran  
    select cltcode=family, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l,  #CloseBal a where a.cltcode = family   
    and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )    
    and edt <= @todate  + ' 23:59:59'    
    and edt > DateAdd(month,-12,@@openbaldt)  
    and family >= @fromparty and family <= @toparty    
    and vtyp <> '18'                          
                    
    insert into #LedgerTran  
    select cltcode=family, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l,  #CloseBal a where a.cltcode = family   
    and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )    
    and edt like @@openbaldtmin  + ' %'       
    and family >= @fromparty and family <= @toparty    
    and vtyp = 18   
   end                                
    else if upper(rtrim(@ageoption)) = 'C'                                
   begin                                
    insert into #LedgerTran                       
    select cltcode=family, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp)) where  a.cltcode = family   
    and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )    
    and edt <= @todate  + ' 23:59:59'                           
    and edt > DateAdd(month,-12,@@openbaldt)  
    and family >= @fromparty and family <= @toparty    
    and vtyp <> '18'   
                
    insert into #LedgerTran  
    select cltcode=family, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp)) where  a.cltcode = family   
    and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )    
    and family >= @fromparty and family <= @toparty    
    and edt like @@openbaldtmin  + ' %'       
    and vtyp = 18   
   end                                
    else                                
   begin                                
    insert into #LedgerTran                          
    select cltcode=family, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp)) where a.cltcode = family   
    and drcr = ( case when closbal >= 0 then 'd' else 'c' end )    
    and edt <= @todate  + ' 23:59:59'    
    and edt like @@openbaldtmin  + ' %'       
    and family >= @fromparty and family <= @toparty    
    and vtyp <> '18'   
      
    insert into #LedgerTran  
    select cltcode=family, vtyp, vno, edt, vamt, closbal, 0  
    from Ledger_Temp_New l , #CloseBal a  with(index(indxtmp)) where a.cltcode = family   
    and drcr = ( case when closbal >= 0 then 'd' else 'c' end )    
    and family >= @fromparty and family <= @toparty    
    and edt like @@openbaldtmin  + ' %'       
    and vtyp = 18   
   end                                
    end                                
 end   
     
  
  
 /*Updating Running Balance*/   
  
 Set @@partycur = cursor for  
 Select Distinct cltcode  From #LedgerTran  
 Open @@partycur  
 Fetch next from @@partycur into @@cltcode  
 While @@fetch_status = 0  
 Begin  
  
   set @@balcur = cursor for  
   select vtyp, vno, EVdt, vamt, closbal   from #LedgerTran  
   where cltcode = @@cltcode  
   order by EVdt desc, vtyp, vno                                              
  
   open @@balcur  
   fetch next from @@balcur into  @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal  
                                   
   while @@fetch_status = 0                      
   begin                  
    select @@ocltcode = @@cltcode       
        select @@balamt = abs(@@closbal)                                            
       if @@closbal >= 0                                                 
          begin                                                
             select @@drcr = 'd'                                                
          end                                       
       else                                                
          begin                                                
              select @@drcr = 'c'                                                
          end                                                        
       while @@fetch_status = 0 and @@ocltcode = @@cltcode  and @@balamt > 0                                    
       begin                              
            if @@balamt >= @@vamt                                
            begin                                                                
     insert into #fintempageing                                    
     select @@cltcode, @@vamt, datediff(day,@@EVdt,@todate), @@drcr                                           
     select @@balamt = @@balamt - @@vamt                                                
           end                                          
           else  
            begin  
      insert into #fintempageing  
      select @@cltcode, @@balamt, datediff(day,@@EVdt,@todate), @@drcr   
      select @@balamt = @@balamt - @@vamt  
            end   
            fetch next from @@balcur into   @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal  
       end  
        if @@balamt > 0  
           begin  
               insert into #fintempageing  
               select @@ocltcode, @@balamt, @days5, @@drcr  
               select @@balamt = @@balamt - @@vamt  
          end  
    Break  
   end                                                
   close @@balcur                                                
   deallocate @@balcur  
  
  Fetch next from @@partycur into @@cltcode  
 End   
  
 select upper(cltcode) as cltcode, balance=sum(balamt), agedays = @days1, drcr  into #ageinglist                                          
 from #fintempageing                                          
 where agedays >= 0 and agedays <= @days1                                         
 group by upper(cltcode), drcr  
   
 CREATE   INDEX [indxtmp5] ON [dbo].[#ageinglist] ([cltcode])   
  
 insert into #ageinglist       
 select upper(cltcode) as cltcode, balance=sum(balamt), agedays = @days2, drcr         
 from #fintempageing        
 where agedays >= (@days1 + 1) and agedays <= @days2        
 group by upper(cltcode), drcr  
   
 insert into #ageinglist        
 select upper(cltcode) as cltcode, balance=sum(balamt), agedays = @days3, drcr         
 from #fintempageing        
 where agedays >= (@days2 + 1) and agedays <= @days3         
 group by upper(cltcode), drcr  
                                 
 insert into #ageinglist        
 select upper(cltcode) as cltcode, balance=sum(balamt), agedays = @days4, drcr     
 from #fintempageing        
 where agedays >= (@days3 + 1) and agedays <= @days4         
 group by upper(cltcode), drcr  
                               
                               
 insert into #ageinglist     
 select upper(cltcode) as cltcode, balance=sum(balamt), agedays = @days5, drcr         
 from #fintempageing      
 where agedays >= @days5                        
 group by upper(cltcode), drcr  
   
               
IF UPPER(@statusid) = 'SUBBROKER'                
BEGIN                              
 Select a1.CLTCODE, short_name = left(a2.SHORT_NAME,18), a2.branch_CD as branchcode,balance, agedays, a1.drcr   
 from #ageinglist a1 with(index(indxtmp5)) , CLIENT1 a2   
 where              
 a1.cltcode = a2.cl_CODE  and sub_broker = @statusname                
 order by a2.cL_CODE, a2.SHORT_NAME                
END                
ELSE                
BEGIN                
 Select a1.cltcode, short_name = left(a2.acname,18), a2.branchCODE, balance, agedays, a1.drcr   
  
  
 from #ageinglist a1 with(index(indxtmp5)) ,   ACMAST a2  
 where    
 a1.cltcode = a2.cltcode  
 order by a1.cltcode,a2.acname      
END                
        
drop table #CloseBal  
drop table #LedgerTran      
drop table #fintempageing            
drop table #ageinglist

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ageingcursor_NEW1_SB
-- --------------------------------------------------
--exec Ageingcursor_NEW1_SB '10100000', '10100010', 'Apr  1 2004', 'Nov 19 2004','party','',0, 'A','edt','broker','broker', 6,26,90,160,161,'101', 'VALSAD'  
CREATE Procedure [dbo].[Ageingcursor_NEW1_SB]
@fromparty varchar(10),      
@toparty varchar(10),       
@opendate varchar(11),      
@todate varchar(11),      
@Reporttype varchar(15),      
@family varchar(10),      
@amoutgtthan money,      
@ageoption varchar(1),      
@dttype varchar(3),  
@statusid varchar(10),  
@statusname varchar(25),  
@Days1 Int = 6,  
@Days2 Int = 29,  
@Days3 Int = 90,  
@Days4 Int = 180,  
@Days5 Int = 181,  
@FrSb Varchar(10) = '0',  
@ToSb Varchar(10) = 'ZZZZ'  
  
  
  
as  
  
declare  
@@balcur as cursor,      
@@baldate as varchar(11),      
@@openbaldt as varchar(11),      
@@balamt as money,      
@@ocltcode as varchar(10),      
@@vtyp as smallint,      
@@vno varchar(12),      
@@EVdt as DATETIME,      
@@vamt as money,      
@@closbal as money,      
@@cltcode as varchar(10),      
@@Branchcode as varchar(25),      
@@area as varchar(25),  
@@drcr    as varchar(1),      
@@startdt as datetime  
    
Print 'Strated '     
Print convert(datetime,getdate(),113)    
    
Set nocount on      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
Select @@startdt = ( select left(convert(varchar,dateadd(mm,-12,convert(datetime,@todate)),109),11) )      
      
      
if upper(@statusid) = 'BROKER'      
begin       
 select @@branchcode = '%'       
 select @@area = '%'       
end      
else if upper(@statusid) = 'BRANCH'      
begin      
 select @@branchcode = rtrim(@statusname)      
 select @@area = '%'       
end   
else if upper(@statusid) = 'AREA'      
begin      
 select @@branchcode = '%'  
 select @@area = rtrim(@statusname)  
end   
      
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing  from Ledger where 1=2    
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing1  from Ledger where 1=2    
  
Select * into #Ledger from Ledger where 1=2  
  
Select cltcode,vtyp,vno,edt as EVdt,vamt,vamt closbal into #LedgerCursor from Ledger where 1=2  
      
if @dttype='vdt'  
begin  
 select @@openbaldt=left(convert(varchar,isnull(max(vdt),0),109),11) from Ledger where vtyp = '18' and vdt < = @opendate   
   
 if upper(@Reporttype) = 'PARTY'  
 begin  
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, client1 c1, client2 c2 where l.cltcode = c2.party_code  
  and c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode       
/*    
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where l.cltcode = c2.party_code  
  and c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode       
    
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, nsefo.dbo.client1 c1, nsefo.dbo.client2 c2 where l.cltcode = c2.party_code  
  and c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode       
*/    
    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode       
 end  
  
 else if upper(@Reporttype) = 'FAMILY'  
 begin  
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l,  client1 c1, client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by family       
  order by family  
/*    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by family       
  order by family  
    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l,  nsefo.dbo.client1 c1, nsefo.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by family       
  order by family  
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
   closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode       
  order by cltcode  
    
 end  
  
 else if upper(@Reporttype) = 'FAMILYPARTY'  
 begin  
  insert   into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, client1 c1, client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and l.cltcode = c2.party_code and c1.family = @family  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
/*    
  insert   into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and l.cltcode = c2.party_code and c1.family = @family  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
    
  insert   into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, nsefo.dbo.client1 c1, nsefo.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and l.cltcode = c2.party_code and c1.family = @family  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
   closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode      
    
 end  
  
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 BEGIN      
  insert into #Ledger   
  select * from Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)       
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)       
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)       */
 END      
  
 else      
 BEGIN      
  insert into #Ledger   
  select * from Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from client2 c2, client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)       
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from bsedb.dbo.client2 c2, bsedb.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'  
  and cltcode in (select party_code from nsefo.dbo.client2 c2, nsefo.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */
 END      
   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 begin      
  if upper(rtrim(@ageoption)) = 'D'       
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode     
   and vdt <= @todate  + ' 23:59:59'       
   --  
   and vtyp <> '18'      
   order by l.cltcode, vdt desc, vtyp, vno  
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and vdt <= @todate  + ' 23:59:59'      
   --  
   and vtyp <> '18'    
   order by l.cltcode, vdt desc, vtyp, vno       
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, #tempageing a  
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and vdt <= @todate  + ' 23:59:59'      
   --  
   and vtyp <> '18'   
   order by l.cltcode, vdt desc, vtyp, vno       
  end  
 end  
   
 else      
 begin      
  if upper(rtrim(@ageoption)) = 'D'       
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, clientmaster c,  #tempageing a where a.cltcode = family      
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and vdt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, vdt desc, vtyp, vno      
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal   
   from #Ledger l, clientmaster c, #tempageing a where  a.cltcode = family      
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and vdt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, vdt desc, vtyp, vno      
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, clientmaster c, #tempageing a where a.cltcode = family      
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and vdt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, vdt desc, vtyp, vno      
  end  
 end  
  
end  
  
else  
begin  
 select @@openbaldt=left(convert(varchar,isnull(max(edt),0),109),11) from Ledger where vtyp = '18' and edt < = @opendate  
  
 if upper(@Reporttype) = 'PARTY'  
 begin  
  insert   into #tempageing1   
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, acmast a, client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'       
  and a.accat = 4  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
/*       
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, accountbse.dbo.acmast a, bsedb.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'       
  and a.accat = 4  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
    
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, accountfo.dbo.acmast a, nsefo.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'       
  and a.accat = 4  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode   
    
 end  
  
 else if upper(@Reporttype) = 'FAMILY'  
 begin  
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l,  client1 c --clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty      
  and c.Branch_cd like @@branchcode+'%'   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by family       
  order by family  
/*    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c--bsedb.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty      
  and c.Branch_cd like @@branchcode+'%'   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by family       
  order by family  
    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l,  nsefo.dbo.client1 c--nsefo.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty      
  and c.Branch_cd like @@branchcode+'%'   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by family       
  order by family  
*/    
    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode   
    
 end  
   
 else if upper(@Reporttype) = 'FAMILYPARTY'  
 begin  
  insert into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, client1 c--clientmaster c    
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'  
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c.Branch_cd like @@branchcode+'%'  
  and l.cltcode = c.cl_code and c.family = @family       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
/*    
  insert into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c--bsedb.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c.Branch_cd like @@branchcode+'%'  
  and l.cltcode = c.cl_code and c.family = @family       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode           
    
  insert into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, nsefo.dbo.client1 c--nsefo.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c.Branch_cd like @@branchcode+'%'  
  and l.cltcode = c.cl_code and c.family = @family       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode   
   
 end  
   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 BEGIN      
  insert into #Ledger   
  select * from Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)      
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)      
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)     */
 END  
       
 else      
 BEGIN      
  insert into #Ledger   
  select * from Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from client2 c2, client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from client2 c2, client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from client2 c2, client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */
 END      
   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 begin      
  if upper(rtrim(@ageoption)) = 'D'  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode     
   and edt <= @todate  + ' 23:59:59'       
   --  
   and vtyp <> '18'      
   order by l.cltcode, edt desc, vtyp, vno      
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, edt, vamt, closbal      
   from #Ledgeredt l, #tempageing a      
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and edt <= @todate  + ' 23:59:59'      
   --  
   and vtyp <> '18'      
   order by l.cltcode, edt desc, vtyp, vno    
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and edt <= @todate  + ' 23:59:59'      
   --   
   and vtyp <> '18'      
   order by l.cltcode, edt desc, vtyp, vno   
  end  
 end  
   
 else      
 begin      
  if upper(rtrim(@ageoption)) = 'D'       
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, clientmaster c,  #tempageing a where a.cltcode = family      
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and edt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, edt desc, vtyp, vno      
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, edt, vamt, closbal   
   from #Ledger l, clientmaster c, #tempageing a where  a.cltcode = family      
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and edt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, edt desc, vtyp, vno      
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, clientmaster c, #tempageing a where a.cltcode = family      
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and edt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, edt desc, vtyp, vno      
  end  
 end  
end  
      
      
Print 'Filled LedgerCursor'     
Print convert(datetime,getdate(),113)    
    
set @@balcur = cursor for      
select cltcode, vtyp, vno, EVdt, vamt, closbal  from #LedgerCursor order by cltcode, EVdt desc, vtyp, vno    
select cltcode,vamt balamt,0 agedays,drcr into #fintempageing from #Ledger where 1= 2      
      
print 'opening cursor'      
      
open @@balcur  
fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal       
  
while @@fetch_status = 0     
begin       
 select @@ocltcode = @@cltcode       
  select @@balamt = abs(@@closbal)      
 if @@closbal >= 0       
 begin      
  select @@drcr = 'd'      
 end   
     else      
 begin      
       select @@drcr = 'c'      
 end  
  
 while @@fetch_status = 0 and @@ocltcode = @@cltcode  and @@balamt > 0      
 begin      
  if @@balamt >= @@vamt       
  begin    
   insert into #fintempageing      
   select @@cltcode, @@vamt, datediff(day,@@EVdt,@todate), @@drcr       
   select @@balamt = @@balamt - @@vamt     
  end      
  
  else      
  begin      
   insert into #fintempageing      
   select @@cltcode, @@balamt, datediff(day,@@EVdt,@todate), @@drcr       
   select @@balamt = @@balamt - @@vamt       
  end      
  
  fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal       
 end      
  
 if @@balamt > 0      
 begin    
   insert into #fintempageing      
   select @@ocltcode, @@balamt, 181, @@drcr       
   select @@balamt = @@balamt - @@vamt      
 end      
  
 while @@fetch_status = 0 and @@ocltcode = @@cltcode  
 begin    
     fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal      
 end      
end  
      
close @@balcur      
deallocate @@balcur      
      
print 'cursor closed'      
Print convert(datetime,getdate(),113)    
      
select cltcode, balance=sum(balamt), agedays = @Days1, drcr into #ageinglist      
from #fintempageing   
where agedays >= 0 and agedays <= @Days1  
group by cltcode, drcr      
order by cltcode, drcr      
      
insert into #ageinglist     
select cltcode, balance=sum(balamt), agedays = @Days2, drcr       
from #fintempageing      
where agedays >= @Days1+1 and agedays <= @Days2  
group by cltcode, drcr       
order by cltcode, drcr      
      
insert into #ageinglist      
select cltcode, balance=sum(balamt), agedays = @Days3, drcr       
from #fintempageing      
where agedays >= @Days2+1 and agedays <= @Days3  
group by cltcode, drcr       
order by cltcode, drcr       
  
insert into #ageinglist      
select cltcode, balance=sum(balamt), agedays = @Days4, drcr       
from #fintempageing      
where agedays >= @Days3+1 and agedays <= @Days4  
group by cltcode, drcr       
order by cltcode, drcr       
      
insert into #ageinglist      
select cltcode, balance=sum(balamt), agedays = @Days5, drcr       
from #fintempageing      
where agedays >= @Days5  
group by cltcode, drcr       
order by cltcode, drcr       
  
print 'done'      
Print convert(datetime,getdate(),113)    
      
Select a1.cltcode, short_name = a2.Short_Name, balance, agedays, drcr, a2.branch_cd, a2.sub_broker, b.branch, s.name  
from #ageinglist a1, client1 a2, subbrokers s, branch b--clientmaster a2--acmast  a2       
where balance >= @amoutgtthan and       
a1.cltcode = a2.cl_code  
and a2.branch_cd = b.branch_code  
and a2.sub_broker = s.sub_broker  
order by a2.branch_cd, a2.sub_broker, a1.cltcode, a2.Short_Name  
      
drop table #tempageing      
drop table #Ledger      
drop table #LedgerCursor       
drop table #ageinglist      
drop table #fintempageing

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ageingcursor_NEW1_SB_angel_FAS
-- --------------------------------------------------
CREATE Procedure Ageingcursor_NEW1_SB_angel_FAS                  
@fromparty varchar(10),                                
@toparty varchar(10),                                 
@opendate varchar(11),                                
@todate varchar(11),                                
@Reporttype varchar(15),                                
@family varchar(10),                                
@amoutgtthan money,                                
@ageoption varchar(1),                                
@dttype varchar(3),                            
@statusid varchar(10) ,                            
@statusname varchar(25),                            
@Days1 Int = 29,                            
@Days2 Int = 60,                            
@Days3 Int = 90,                            
@Days4 Int = 180,                            
@Days5 Int = 360,                            
@FrSb Varchar(10) = '0',                            
@ToSb Varchar(10) = 'ZZZZ'                            
                            
                            
                            
as                            
                          
------------------------------------------------                          
/*                          
declare                          
@fromparty varchar(10),                                
@toparty varchar(10),                                 
@opendate varchar(11),                                
@todate varchar(11),                                
@Reporttype varchar(15),                                
@family varchar(10),                                
@amoutgtthan money,                                
@ageoption varchar(1),                                
@dttype varchar(3),                            
@statusid varchar(10) ,                            
@statusname varchar(25),                            
@Days1 Int,                            
@Days2 Int,                            
@Days3 Int,                            
@Days4 Int,                            
@Days5 Int,                            
@FrSb Varchar(10),                            
@ToSb Varchar(10)                          
                          
set @fromparty ='K9550'                          
set @toparty ='K9550'                          
set @opendate='Apr  1 2006'                          
set @todate = 'Mar 31 2007'                          
set @Reporttype ='party'                          
set @family =''                          
set @amoutgtthan =0                          
set @ageoption='D'                          
set @dttype ='vdt'                          
set @statusid= 'broker'                          
set @statusname = 'broker'                          
set @Days1=29                          
set @Days2=60                          
set @Days3=90                          
set @Days4=180                          
set @Days5=360                          
set @FrSb ='0'                          
set @ToSb  = 'ZZZZ'                          
                          
*/                          
                          
                            
declare                            
@@balcur as cursor,                                
@@baldate as varchar(11),                                
@@openbaldt as varchar(11),                                
@@balamt as money,                                
@@ocltcode as varchar(10),                                
@@vtyp as smallint,                                
@@vno varchar(12),                                
@@EVdt as DATETIME,                                
@@vamt as money,                                
@@closbal as money,                                
@@cltcode as varchar(10),                                
@@Branchcode as varchar(25),                                
@@area as varchar(25),                            
@@drcr    as varchar(1),                                
@@startdt as datetime                            
                              
                          
--PRINT 'Strated '                               
--PRINT convert(datetime,getdate(),113)                              
                              
Set nocount on                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                               
                              
Select @@startdt = ( select left(convert(varchar,dateadd(mm,-12,convert(datetime,@todate)),109),11) )             
                                
                                
if upper(@statusid) = 'BROKER'                                
begin                                 
 select @@branchcode = '%'                              
 select @@area = '%'                                 
end                                
else if upper(@statusid) = 'BRANCH'                                
begin                                
 select @@branchcode = rtrim(@statusname)                                
 select @@area = '%'                                 
end                             
else if upper(@statusid) = 'AREA'                                
begin                                
 select @@branchcode = '%'                            
 select @@area = rtrim(@statusname)                            
end                             
                                
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing  from dbo.ledger where 1=2      
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing1  from dbo.ledger where 1=2                              
       
Select * into #Ledger from dbo.ledger where 1=2                            
                           
Select cltcode,vtyp,vno,edt as EVdt,vamt,vamt closbal into #LedgerCursor from dbo.ledger where 1=2                           
                                
if @dttype='vdt'                            
begin                            
 select @@openbaldt=left(convert(varchar,isnull(max(vdt),0),109),11) from dbo.ledger where vtyp = '18'         
and vdt < = @opendate                             
                             
 if upper(@Reporttype) = 'PARTY'                            
 begin                            
  insert   into #tempageing1                                 
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from dbo.ledger l, intranet.risk.dbo.client_details c2 where l.cltcode = c2.party_code                            
  --and c1.cl_code = c2.cl_code                            
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c2.branch_cd like @@branchcode+'%' --and area like @@area+'%'                            
  and c2.sub_broker >= @FrSb and c2.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                                 
/*                              
  insert   into #tempageing1                                 
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where l.cltcode = c2.party_code                            
  and c1.cl_code = c2.cl_code                            
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'                            
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                                 
                              
  insert   into #tempageing1                                 
  select l.cltcode, baldate=@todate,                           
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountfo.dbo.Ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 where l.cltcode = c2.party_code                            
  and c1.cl_code = c2.cl_code         
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'                            
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                                 
*/                              
                              
  insert   into #tempageing                              
  select cltcode, baldate=@todate,                              
  closbal = sum(closbal),agedays=0                                
  from #tempageing1                                
  group by cltcode                                
  order by cltcode                                 
 end                       
                           
 else if upper(@Reporttype) = 'FAMILY'                            
 begin                            
  insert   into #tempageing1                                
  Select Family as cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from dbo.ledger l,  intranet.risk.dbo.client_details c2 where --c1.cl_code = c2.cl_code and                      
   vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                                
  and l.cltcode = c2.party_code and c2.family >= @fromparty and c2.family <= @toparty                                
  and c2.Branch_cd like @@branchcode+'%' --and area like @@area+'%'                            
  and c2.sub_broker >= @FrSb and c2.sub_broker <= @ToSb                            
  group by family               
  order by family                            
/*                              
  insert   into #tempageing1                                
  Select Family as cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code                            
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                                
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty                                
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'                            
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                            
  group by family                                 
  order by family                            
                              
  insert   into #tempageing1                                
  Select Family as cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountfo.dbo.Ledger l,  ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 where c1.cl_code = c2.cl_code                            
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                                
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty                                
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'                            
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                            
  group by family                                 
  order by family                            
*/                              
  insert   into #tempageing                              
  select cltcode, baldate=@todate,                    
   closbal = sum(closbal),agedays=0                                
  from #tempageing1                                
  group by cltcode                                 
  order by cltcode                            
                              
 end                            
                            
 else if upper(@Reporttype) = 'FAMILYPARTY'                      
 begin                            
  insert   into #tempageing1                            
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from dbo.ledger l, intranet.risk.dbo.client_details c2 where --c1.cl_code = c2.cl_code and                           
   vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                             
  and c2.Branch_cd like @@branchcode+'%' --and area like @@area+'%'                            
  and l.cltcode = c2.party_code and c2.family = @family                            
  and c2.sub_broker >= @FrSb and c2.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                                
/*                              
  insert   into #tempageing1                            
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code                            
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                             
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'                            
  and l.cltcode = c2.party_code and c1.family = @family                            
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode              
                              
  insert   into #tempageing1                            
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountfo.dbo.Ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 where c1.cl_code = c2.cl_code                            
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                             
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'                            
  and l.cltcode = c2.party_code and c1.family = @family                            
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                                
*/                              
  insert   into #tempageing                              
  select cltcode, baldate=@todate,                                 
   closbal = sum(closbal),agedays=0                                
  from #tempageing1                                
  group by cltcode                                
  order by cltcode                                
                              
 end                            
                            
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'                                
 BEGIN                                
  insert into #Ledger                             
  select * from dbo.ledger where vdt <= @todate  + ' 23:59:59'                             
  and cltcode in (Select distinct cltcode from #tempageing)                 
/*                              
  insert into #Ledger                   
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'                             
  and cltcode in (Select distinct cltcode from #tempageing)                                 
                              
  insert into #Ledger                             
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'                             
  and cltcode in (Select distinct cltcode from #tempageing)       */                          
 END                                
                            
 else                                
 BEGIN                                
  insert into #Ledger                             
  select * from dbo.ledger where vdt <= @todate  + ' 23:59:59'                      
  and cltcode in (select party_code from client_detials c1 where family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)                                 
/*                              
  insert into #Ledger                             
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'                             
  and cltcode in (select party_code from bsedb.dbo.client2 c2, bsedb.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)                            
                              
  insert into #Ledger                             
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'                            
  and cltcode in (select party_code from ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */                          
 END                                
                      
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'                                
 begin                                
  if upper(rtrim(@ageoption)) = 'D'                                 
  begin                            
   insert into #LedgerCursor                              
   select l.cltcode, vtyp, vno, vdt, vamt, closbal                                
   from #Ledger l, #tempageing a                                
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and l.cltcode = a.cltcode                               
   and vdt <= @todate  + ' 23:59:59'                                 
   --                            
   --and vtyp <> '18'                                
   order by l.cltcode, vdt desc, vtyp, vno                            
  end                            
                             
  else if upper(rtrim(@ageoption)) = 'C'                            
  begin                            
   insert into #LedgerCursor                               
   select l.cltcode, vtyp, vno, vdt, vamt, closbal                                
   from #Ledger l, #tempageing a                                
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and l.cltcode = a.cltcode                                
   and vdt <= @todate  + ' 23:59:59'                                
   --                            
   --and vtyp <> '18'                              
   order by l.cltcode, vdt desc, vtyp, vno                                 
  end                            
                     
  else                            
  begin                            
   insert into #LedgerCursor                               
   select l.cltcode, vtyp, vno, vdt, vamt, closbal                                
   from #Ledger l, #tempageing a                            
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and l.cltcode = a.cltcode                                
   and vdt <= @todate  + ' 23:59:59'                                
   --                            
   --and vtyp <> '18'                             
   order by l.cltcode, vdt desc, vtyp, vno                                 
  end                            
 end                            
                             
 else                                
 begin                                
  if upper(rtrim(@ageoption)) = 'D'            
      
  begin                            
   insert into #LedgerCursor                               
   select cltcode=family, vtyp, vno, vdt, vamt, closbal                                
   from #Ledger l, intranet.risk.dbo.client_details c (nolock),  #tempageing a where a.cltcode = family                                
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and vdt <= @todate  + ' 23:59:59'                                 
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                                 
   --                            
   --and vtyp <> '18'                                
   order by cltcode, vdt desc, vtyp, vno                                
  end                            
                             
  else if upper(rtrim(@ageoption)) = 'C'                            
  begin                            
   insert into #LedgerCursor                               
   select cltcode=family, vtyp, vno, vdt, vamt, closbal                             
   from #Ledger l, intranet.risk.dbo.client_details c (nolock), #tempageing a where  a.cltcode = family                                
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and vdt <= @todate  + ' 23:59:59'                                 
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                                 
   --                            
   --and vtyp <> '18'                                
   order by cltcode, vdt desc, vtyp, vno                                
  end                            
                             
  else                            
  begin                            
   insert into #LedgerCursor                               
   select cltcode=family, vtyp, vno, vdt, vamt, closbal                                
   from #Ledger l, intranet.risk.dbo.client_details c, #tempageing a where a.cltcode = family                                
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and vdt <= @todate  + ' 23:59:59'                                 
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                                 
   --                            
   --and vtyp <> '18'                                
   order by cltcode, vdt desc, vtyp, vno                                
  end                            
 end                            
                            
end                            
                            
else                            
begin                            
 select @@openbaldt=left(convert(varchar,isnull(max(edt),0),109),11) from dbo.ledger where vtyp = '18' and edt < = @opendate                            
                            
 if upper(@Reporttype) = 'PARTY'                            
 begin                            
  insert   into #tempageing1                             
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from dbo.ledger l, acmast a, intranet.risk.dbo.client_details c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code                            
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'               
  and a.accat = 4                            
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                            
/*                                 
  insert   into #tempageing1                                 
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountbse.dbo.Ledger l, accountbse.dbo.acmast a, bsedb.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code                            
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'                                 
  and a.accat = 4                            
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                            
                              
  insert   into #tempageing1                                 
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountfo.dbo.Ledger l, accountfo.dbo.acmast a, ncdx.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code               
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'                                 
  and a.accat = 4                            
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                            
*/                              
  insert   into #tempageing                              
  select cltcode, baldate=@todate,                                 
  closbal = sum(closbal),agedays=0                                
  from #tempageing1                                
  group by cltcode                                
  order by cltcode         
                              
 end                            
                            
 else if upper(@Reporttype) = 'FAMILY'                            
 begin                   
  insert   into #tempageing1                                
  Select Family as cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from dbo.ledger l,  intranet.risk.dbo.client_details c (nolock) /*intranet.risk.dbo.client_details c */      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                                
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty                                
  and c.Branch_cd like @@branchcode+'%'                             
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                            
  group by family                                 
  order by family                            
/*                              
  insert   into #tempageing1                                
  Select Family as cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c--bsedb.dbo.clientmaster c                                
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                                
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty                                
  and c.Branch_cd like @@branchcode+'%'                             
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                            
  group by family                                 
  order by family                            
                              
  insert   into #tempageing1                                
  Select Family as cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountfo.dbo.Ledger l,  ncdx.dbo.client1 c--intranet.risk.dbo.client_details c                                
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                                
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty                                
  and c.Branch_cd like @@branchcode+'%'                             
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                            
  group by family                                 
  order by family                            
*/                              
                              
  insert   into #tempageing                              
  select cltcode, baldate=@todate,                                 
  closbal = sum(closbal),agedays=0                                
  from #tempageing1                      group by cltcode                                
  order by cltcode                             
                              
 end                            
                             
 else if upper(@Reporttype) = 'FAMILYPARTY'                            
 begin                            
  insert into #tempageing1                            
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                           
  from dbo.ledger l, intranet.risk.dbo.client_details c (nolock) --intranet.risk.dbo.client_details c                              
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                            
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                             
  and c.Branch_cd like @@branchcode+'%'                            
  and l.cltcode = c.cl_code and c.family = @family                                 
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                                
/*                              
  insert into #tempageing1                            
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c--bsedb.dbo.clientmaster c                                
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                             
  and c.Branch_cd like @@branchcode+'%'                            
  and l.cltcode = c.cl_code and c.family = @family                                 
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                                     
                              
  insert into #tempageing1                            
  select l.cltcode, baldate=@todate,                                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                                
  from Accountfo.dbo.Ledger l, ncdx.dbo.client1 c--intranet.risk.dbo.client_details c                           
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                                 
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                             
  and c.Branch_cd like @@branchcode+'%'                            
  and l.cltcode = c.cl_code and c.family = @family     
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                            
  group by l.cltcode                                
  order by l.cltcode                            
*/                              
  insert   into #tempageing                              
  select cltcode, baldate=@todate,                                 
  closbal = sum(closbal),agedays=0                                
  from #tempageing1                                
  group by cltcode                                
  order by cltcode                             
                             
 end                            
                             
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'                                
 BEGIN                                
  insert into #Ledger                             
  select * from dbo.ledger where edt <= @todate  + ' 23:59:59'                             
  and cltcode in (Select distinct cltcode from #tempageing)                                
/*                              
  insert into #Ledger                             
  select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'                             
  and cltcode in (Select distinct cltcode from #tempageing)                                
                              
  insert into #Ledger                             
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'                             
  and cltcode in (Select distinct cltcode from #tempageing)     */                          
 END                            
                                 
 else                                
 BEGIN                                
  insert into #Ledger                             
  select * from dbo.ledger where edt <= @todate  + ' 23:59:59'                             
  and cltcode in (select party_code from intranet.risk.dbo.client_details c1 where family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)                            
/*                              
  insert into #Ledger                             
select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'                             
  and cltcode in (select party_code from ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)                            
                              
  insert into #Ledger                             
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'                             
  and cltcode in (select party_code from ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */                          
 END                                
                             
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'                           begin                                
  if upper(rtrim(@ageoption)) = 'D'                            
  begin                            
   insert into #LedgerCursor                               
   select l.cltcode, vtyp, vno, edt, vamt, closbal                                
   from #Ledger l, #tempageing a                                
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and l.cltcode = a.cltcode                               
   and edt <= @todate  + ' 23:59:59'                                 
   --                            
   --and vtyp <> '18'                                
   order by l.cltcode, edt desc, vtyp, vno                                
  end                            
                     
  else if upper(rtrim(@ageoption)) = 'C'                            
  begin                            
   insert into #LedgerCursor            
   select l.cltcode, vtyp, vno, edt, vamt, closbal                                
   from #Ledgeredt l, #tempageing a                                
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and l.cltcode = a.cltcode                                
   and edt <= @todate  + ' 23:59:59'                                
   --                            
   --and vtyp <> '18'                                
   order by l.cltcode, edt desc, vtyp, vno                              
  end                            
                             
  else                            
  begin                            
   insert into #LedgerCursor                               
   select l.cltcode, vtyp, vno, edt, vamt, closbal                                
   from #Ledger l, #tempageing a                           
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and l.cltcode = a.cltcode                                
   and edt <= @todate  + ' 23:59:59'                       
   --                             
   --and vtyp <> '18'                                
   order by l.cltcode, edt desc, vtyp, vno                             
  end                            
 end                            
                             
 else                                
 begin                                
  if upper(rtrim(@ageoption)) = 'D'                                 
  begin                            
   insert into #LedgerCursor                               
   select cltcode=family, vtyp, vno, edt, vamt, closbal                                
   from #Ledger l, intranet.risk.dbo.client_details c,  #tempageing a where a.cltcode = family                                
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and edt <= @todate  + ' 23:59:59'                                 
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                                 
   --                            
   --and vtyp <> '18'                                
   order by cltcode, edt desc, vtyp, vno                                
  end                          
                             
  else if upper(rtrim(@ageoption)) = 'C'                            
  begin                            
   insert into #LedgerCursor                               
   select cltcode=family, vtyp, vno, edt, vamt, closbal                             
   from #Ledger l, intranet.risk.dbo.client_details c, #tempageing a where  a.cltcode = family                                
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and edt <= @todate  + ' 23:59:59'                                 
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                                 
   --                 
   --and vtyp <> '18'                                
   order by cltcode, edt desc, vtyp, vno                                
  end                            
                             
  else                            
  begin                            
   insert into #LedgerCursor                               
   select cltcode=family, vtyp, vno, edt, vamt, closbal                                
   from #Ledger l, intranet.risk.dbo.client_details c, #tempageing a where a.cltcode = family                       
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                                 
   and edt <= @todate  + ' 23:59:59'                                 
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                                 
   --                            
   --and vtyp <> '18'                                
   order by cltcode, edt desc, vtyp, vno                                
  end                            
 end                            
end                            
                               
                                
--PRINT 'Filled LedgerCursor'                               
--PRINT convert(datetime,getdate(),113)                              
                              
set @@balcur = cursor for                                
select cltcode, vtyp, vno, EVdt, vamt, closbal  from #LedgerCursor order by cltcode, EVdt desc, vtyp, vno                     
select cltcode,vamt balamt,0 agedays,drcr into #fintempageing from #Ledger where 1= 2                                
                                
--PRINT 'opening cursor'                                
                                
open @@balcur                            
fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal                                 
                            
while @@fetch_status = 0                               
begin                                 
 select @@ocltcode = @@cltcode                                 
  select @@balamt = abs(@@closbal)                                
 if @@closbal >= 0                                 
 begin                                
  select @@drcr = 'd'                                
 end                             
  else                                
 begin                                
       select @@drcr = 'c'                                
 end                            
                            
 while @@fetch_status = 0 and @@ocltcode = @@cltcode  and @@balamt > 0                                
 begin                                
  if @@balamt >= @@vamt                                 
  begin                              
   insert into #fintempageing                                
   select @@cltcode, @@vamt, datediff(day,@@EVdt,@todate), @@drcr                                 
   select @@balamt = @@balamt - @@vamt                               
  end                                
                            
  else                                
  begin                                
   insert into #fintempageing                                
   select @@cltcode, @@balamt, datediff(day,@@EVdt,@todate), @@drcr                                 
   select @@balamt = @@balamt - @@vamt                                 
  end                                
                            
  fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal                                 
 end                                
                            
 if @@balamt > 0                 
 begin                              
   insert into #fintempageing                                
   select @@ocltcode, @@balamt, 181, @@drcr                                 
   select @@balamt = @@balamt - @@vamt                                
 end                                
                            
 while @@fetch_status = 0 and @@ocltcode = @@cltcode                            
 begin                              
     fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal                                
 end                                
end                            
                                
close @@balcur                                
deallocate @@balcur                                
                                
--PRINT 'cursor closed'                                
--PRINT convert(datetime,getdate(),113)                              
                                
                          
                          
select cltcode, balance=sum(balamt), agedays = @Days1, drcr into #ageinglist                                
from #fintempageing                             
where agedays >= 0 and agedays <= @Days1                            
group by cltcode, drcr                                
--order by cltcode, drcr                                
                                
insert into #ageinglist                               
select cltcode, balance=sum(balamt), agedays = @Days2, drcr                      
from #fintempageing                                
where agedays >= @Days1+1 and agedays <= @Days2                            
group by cltcode, drcr                                 
--order by cltcode, drcr                                
                                
insert into #ageinglist                                
select cltcode, balance=sum(balamt), agedays = @Days3, drcr                                 
from #fintempageing                                
where agedays >= @Days2+1 and agedays <= @Days3                            
group by cltcode, drcr                                 
--order by cltcode, drcr                                 
                            
insert into #ageinglist                                
select cltcode, balance=sum(balamt), agedays = @Days4, drcr                                 
from #fintempageing                                
where agedays >= @Days3+1 and agedays <= @Days4                            
group by cltcode, drcr                                 
--order by cltcode, drcr                                 
                                
                          
insert into #ageinglist                                
select cltcode, balance=sum(balamt), agedays = @Days5, drcr                                 
from #fintempageing                                
--where agedays >= @Days5                       
where agedays >= @Days4+1 and agedays <= @Days5                            
group by cltcode, drcr                                 
--order by cltcode, drcr                                 
                          
                            
--PRINT 'done'                                
--PRINT convert(datetime,getdate(),113)                              
                          
                          
Select a1.cltcode, short_name = a2.Short_Name, balance, agedays, drcr, a2.branch_cd, a2.sub_broker, branch=' ', name=' '                            
into #filex                          
from #ageinglist a1, intranet.risk.dbo.client_details a2                        
--, ncdx.dbo.subbrokers s, ncdx.dbo.branch b                        
--intranet.risk.dbo.client_details a2--account.dbo.acmast  a2                                 
where balance >= @amoutgtthan and                                 
a1.cltcode = a2.cl_code                            
--and a2.branch_cd = b.branch_code                            
--and a2.sub_broker = s.sub_broker                            
--order by a2.branch_cd, a2.sub_broker, a1.cltcode, a2.Short_Name                            
                          
--truncate table Angel_Ageing                                
--insert into Angel_Ageing                                
                          
select party_code=a.cltcode,a.baldate,a.closbal,b.* into #AgeFinal                           
from (select * from #tempageing where closbal <> 0 )a left outer join #filex b on a.cltcode=b.cltcode                               
                          
                          
select PARTY_cODE,branch_cd,branch,sub_Broker,name,cltcode,short_name,balDate,ClosBal,                          
Day_30=sum(case                           
when agedays=29 and drcr='d' then balance                           
when agedays=29 and drcr='c' then -balance                           
else 0 end),                          
Day_60=sum(case                          
when agedays=60 and drcr='d' then balance                           
when agedays=60 and drcr='c' then -balance                           
else 0 end),                          
Day_90=sum(case                          
when agedays=90 and drcr='d' then balance                           
when agedays=90 and drcr='c' then -balance                           
else 0 end),                          
Day_180=sum(case                           
when agedays=180 and drcr='d' then balance                           
when agedays=180 and drcr='c' then -balance                           
else 0 end),                          
Day_360=sum(case                           
when agedays=360 and drcr='d' then balance                           
when agedays=360 and drcr='c' then -balance                           
else 0 end)                          
into #fINAL                          
from #AgeFinal                           
group by PARTY_cODE,branch_cd,branch,sub_Broker,name,cltcode,short_name,balDate,ClosBal                          
--order by cltcode                    
                  
select a.*,last_trade_date=isnull(convert(varchar(11),vdt),'-') into #fINAL1 from #fINAL a                  
left outer join                  
(              
--select cltcode,vdt=max(vdt) from dbo.ledger (nolock) group by cltcode              
 select cltcode,vdt=max(vdt) from dbo.ledger           
 where vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59' and vtyp=15                          
 group by cltcode              
) b                  
on a.party_code=b.cltcode                                 
                      
update #fINAL1 set branch_cd=b.branch_Cd,sub_Broker=b.sub_broker from                       
(select party_code,branch_cd,sub_broker from intranet.risk.dbo.client_details b ) b                      
where #fINAL1.party_code=b.party_code                      
                      
if @ageoption='D'                          
begin                           
 SELECT *, DAYS_361_PLUS=ClosBal-ISNULL(DAY_30,0)-ISNULL(DAY_60,0)-ISNULL(DAY_90,0)-ISNULL(DAY_180,0)-ISNULL(DAY_360,0)                           
 FROM #fINAL1                           
 where closBal > 0                    
 order by cltcode                          
end                          
if @ageoption='C'                          
begin                           
 SELECT *, DAYS_361_PLUS=ClosBal-ISNULL(DAY_30,0)-ISNULL(DAY_60,0)-ISNULL(DAY_90,0)-ISNULL(DAY_180,0)-ISNULL(DAY_360,0)                           
 FROM #fINAL1                           
 where closBal < 0                          
 order by cltcode                          
end                          
if @ageoption='A'                          
begin                           
 SELECT *, DAYS_361_PLUS=ClosBal-ISNULL(DAY_30,0)-ISNULL(DAY_60,0)-ISNULL(DAY_90,0)-ISNULL(DAY_180,0)-ISNULL(DAY_360,0)                           
 FROM #fINAL1                           
 order by cltcode                          
end                          
                          
                          
drop table #tempageing                                
drop table #tempageing1                                
drop table #Ledger                                
drop table #LedgerCursor                                 
drop table #ageinglist                      
drop table #fintempageing

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost1
-- --------------------------------------------------
CREATE procedure angel_getledger_cost1(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11),@segment as varchar(11))        
as        
        
set transaction isolation level read uncommitted        
        
set nocount on        
        
/*        
Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'        
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)        
set @cltcode='a108'        
set @fdate='Apr 01 2004'        
set @tdate='Jan 05 2006'        
*/        
        
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')        
into #abl_cost        
from         
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'        
) a left outer join        
(select l2.camt,l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')         
from ledger2 l2         
left outer join costmast cm         
on l2.costcode=cm.costcode) b         
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode        
        
        
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],         
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=(case when drcr = 'C' then n.vamt else 0 end),         
balamt=convert(money,0.00),n.camt,n.costname,Segment=@segment,n.acname,@cltcode as accountcode,n.lno as [LineNo]  from #abl_cost n left outer join         
vmast v on vtyp=vtype        
order by n.vno,n.lno        
        
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost2
-- --------------------------------------------------
CREATE  procedure angel_getledger_cost2(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))      
as      
      
set transaction isolation level read uncommitted      
      
set nocount on      
      
    
--Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'      
/*    
drop table #abl_cost_a    
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)      
set @cltcode='70000014 '      
set @fdate='Apr 01 2004'      
set @tdate='Dec 30 2004'      
*/    
    
set transaction isolation level read uncommitted      
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')      
into #abl_cost_a      
from       
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'      
) a left outer join      
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')       
from ledger2 l2 (nolock)      
left outer join costmast cm (nolock)      
on l2.costcode=cm.costcode) b       
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode      
    
set transaction isolation level read uncommitted    
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname    
into #file1    
from ledger (nolock)    
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'      
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%' or cltcode like '31%' or cltcode like '38%')     
and vno in (select vno from #abl_cost_a) and vtyp<>18    
    
    
    
set transaction isolation level read uncommitted    
select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)    
into #abl_cost    
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp     
    
set transaction isolation level read uncommitted     
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],       
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),       
balamt=convert(money,0.00),n.camt,n.costname,n.lno,alt_cltcode,alt_acname,alt_vamt    
from #abl_cost n left outer join       
vmast v (nolock) on vtyp=vtype      
order by n.vno,n.lno      
      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost2_test
-- --------------------------------------------------
CREATE procedure angel_getledger_cost2_test(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))      
as      
      
set transaction isolation level read uncommitted      
      
set nocount on      
      
    
--Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'      
/*    
drop table #abl_cost_a    
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)      
set @cltcode='70000014 '      
set @fdate='Apr 01 2004'      
set @tdate='Dec 30 2004'      
*/    
    
set transaction isolation level read uncommitted      
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')      
into #abl_cost_a      
from       
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'      
) a left outer join      
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')       
from ledger2 l2 (nolock)      
left outer join costmast cm (nolock)      
on l2.costcode=cm.costcode) b       
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode      
    
set transaction isolation level read uncommitted    
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname    
into #file1    
from ledger (nolock)    
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'      
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%')     
and vno in (select vno from #abl_cost_a) and vtyp<>18    
    
    
  
set transaction isolation level read uncommitted    
select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)    
into #abl_cost    
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp     
    
set transaction isolation level read uncommitted     
select n.costname,r.regioncode,alt_acname,       
Debit=(case when drcr = 'D' then n.vamt else 0 end)--Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),  
from #abl_cost n left outer join       
vmast v (nolock)on vtyp=vtype     left outer join NCDX.dbo.region  r on n.costname = r.branch_code  

order by n.narration,n.vno,n.lno
      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost3
-- --------------------------------------------------
CREATE procedure angel_getledger_cost3(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))              
as              
              
set transaction isolation level read uncommitted              
              
set nocount on              
              
            
--Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'              
/*          
drop table #abl_cost_a            
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)              
set @cltcode='26100010'              
set @fdate='Jun 01 2007'              
set @tdate='Jun 30 2007'              
*/          
            
set transaction isolation level read uncommitted              
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')              
into #abl_cost_a              
from               
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'              
) a left outer join              
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')               
from ledger2 l2 (nolock)              
left outer join costmast cm (nolock)              
on l2.costcode=cm.costcode) b               
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode              
            
set transaction isolation level read uncommitted            
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname            
into #file1            
from ledger (nolock)            
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'              
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%' or cltcode like '35%'or cltcode like '31%' or cltcode like '32%' or cltcode like '38%')             
and vno in (select vno from #abl_cost_a) and vtyp<>18            
            
            
            
set transaction isolation level read uncommitted            
select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)            
into #abl_cost            
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp             
            
set transaction isolation level read uncommitted             
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],               
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),               
balamt=convert(money,0.00),n.camt,n.costname,n.lno,alt_cltcode,alt_acname,alt_vamt            
into #temp1          
from #abl_cost n left outer join               
vmast v (nolock) on vtyp=vtype              
          
delete from #temp1 where credit <= 0          
          
select vdt,vtyp,vno,credit,costname,alt_cltcode,alt_acname,alt_vamt,          
narration=          
CASE WHEN NARR LIKE 'TDS on remisier share of%' THEN          
SUBSTRING(replace(narr,'TDS on remisier share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on remisier share of ',''),1))           
ELSE          
NARR          
END          
into #tempa          
from #temp1          
where alt_vamt < 0          
          
          
insert into #tempa          
select vdt,vtyp,vno,credit,costname,alt_cltcode,alt_acname,alt_vamt,          
narration=          
CASE WHEN NARR LIKE 'TDS on remisier share of%' THEN          
SUBSTRING(replace(narr,'TDS on remisier share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on remisier share of ',''),1))           
ELSE          
NARR          
END          
from #temp1          
where vno not in (select vno from #tempa)          
          
select a.*,state=isnull(b.state,''),Pan_no=isnull(b.pan_no,'')          
from #tempa a left outer join mis.sb_comp.dbo.SB_State_pan b on a.costname=b.sub_BRoker order by vno          
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ANGEL_GLAgeing_New
-- --------------------------------------------------
create procedure ANGEL_GLAgeing_New          
(          
@GLcodefrom as varchar(10),@GLcodeto as varchar(10),          
@fromdate as varchar(11),@todate as varchar(11)          
)          
as          
 --This is the rectified query by sachin dewoolkar  & alok Jain on 12/06/2009 (cr Caluclation logic has been change to reverse of dr.)    
--before any modification contact to Sachin dewoolkar or alok jain.  
set nocount on          
          
declare @fdate as datetime,@tdate as datetime          
set @fdate=convert(datetime,@fromdate+' 00:00')          
set @tdate=convert(datetime,@todate+' 23:59')          
          
          
select cltcode,value=sum(Case when drcr='D' then vamt else -vamt end),          
Bal0to30=convert(money,0),          
Bal31to60=convert(money,0),          
Bal61to90=convert(money,0),          
Bal90to180=convert(money,0),          
Bal181to360=convert(money,0),          
Bal361above=convert(money,0)          
into #ageing          
from ledger where vdt >=@fdate and vdt <=@tdate          
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto          
group by cltcode          
          
          
          
select cltcode,vdt=convert(datetime,convert(varchar(11),vdt)),          
value=sum(Case when drcr='D' then vamt else -vamt end)          
into #file1          
from ledger where vdt >=@fdate and vdt <=@tdate          
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto          
group by cltcode,convert(datetime,convert(varchar(11),vdt))          
          
--print @tdate-30          
update #ageing set Bal0to30=b.bal30days from          
(select cltcode,Bal30days=sum(value) from #file1 where Vdt <= @tdate and vdt >=@tdate-30          
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
          
update #ageing set Bal31to60=b.bal60days from          
(select cltcode,Bal60days=sum(value) from #file1 where Vdt <= @tdate-30 and vdt >=@tdate-60          
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
          
update #ageing set Bal61to90=b.bal90days from          
(select cltcode,Bal90days=sum(value) from #file1 where Vdt <= @tdate-60 and vdt >=@tdate-90          
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
          
update #ageing set Bal90to180=b.bal180days from          
(select cltcode,Bal180days=sum(value) from #file1 where Vdt <= @tdate-90 and vdt >=@tdate-180          
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
          
update #ageing set Bal181to360=b.bal360days from          
(select cltcode,Bal360days=sum(value) from #file1 where Vdt <= @tdate-180 and vdt >=@tdate-360          
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
          
update #ageing set Bal361above=b.bal361days from          
(select cltcode,Bal361days=sum(value) from #file1 where Vdt <= @tdate-360           
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
        
update #ageing set bal0to30=0 where value < 0 and bal0to30 > 0        
update #ageing set bal31to60=0 where value < 0 and bal31to60 > 0        
update #ageing set bal61to90=0 where value < 0 and bal61to90 > 0        
update #ageing set bal90to180=0 where value < 0 and bal90to180 > 0        
update #ageing set bal181to360=0 where value < 0 and bal181to360 > 0        
update #ageing set bal361above=0 where value < 0 and bal361above > 0        
  
  
  
update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0        
where value < 0 and bal0to30 <= value and bal0to30 < 0        
  
update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0        
where value < 0 and bal0to30+bal31to60 <= value and bal31to60 < 0        
  
update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0        
where value < 0 and (bal0to30+bal31to60+bal61to90) <= value and bal61to90 < 0        
  
update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0       
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) <= value and bal90to180 < 0        
  
update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0        
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) <= value         
and bal181to360 < 0        
  
update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)        
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) <= value         
and bal361above < 0     
        
        
------------------- Debit Balance        
        
update #ageing set bal0to30=0 where value > 0 and bal0to30 < 0        
update #ageing set bal31to60=0 where value > 0 and bal31to60 < 0        
update #ageing set bal61to90=0 where value > 0 and bal61to90 < 0        
update #ageing set bal90to180=0 where value > 0 and bal90to180 < 0        
update #ageing set bal181to360=0 where value > 0 and bal181to360 < 0        
update #ageing set bal361above=0 where value > 0 and bal361above < 0        
        
        
        
update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0        
where value > 0 and bal0to30 >= value and bal0to30 > 0        
        
update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0        
where value > 0 and bal0to30+bal31to60 >= value and bal31to60 > 0        
        
update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0        
where value > 0 and (bal0to30+bal31to60+bal61to90) >= value and bal61to90 > 0        
        
update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0        
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) >= value and bal90to180 > 0        
        
        
update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0        
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) >= value         
and bal181to360 > 0        
        
update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)        
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) >= value         
and bal361above > 0        
        
        
        
select x.*,SBcode=isnull(y.sbcode,'') from          
(select a.*,acname,branchcode from #ageing a, acmast b (nolock) where a.cltcode=b.cltcode) x          
left outer join           
(select  top 10 * from mis.remisior.dbo.remi_ledcode where coname='ACPLMCX') y           
on x.cltcode=y.ledgercode          
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE]    
@FILENAME VARCHAR(100),    
@UNAME VARCHAR(100),    
@BANKCODE VARCHAR(10),    
@STATUSID VARCHAR(10),    
@STATUSNAME VARCHAR(100)    
    
    
AS    
  
--EXEC AUTORECOUPDATE 'D:\BackOffice\UTIRECO\UTI.CSV', 'NIKHIL','TRI0000002','BROKER','BROKER'  
    
DECLARE     
@@SQL_QUERY AS VARCHAR(1000),    
@@CROSSREFERENCENO INT,    
@@TABLE_EXIST VARCHAR(20),      
@@RECORD_COUNT TINYINT,      
@@RECO_STATUS CHAR(1),    
@@FILE_EXIST INT,    
@@CLTCODE_EXIST INT,  
@@MICRNO VARCHAR(20)    
    
SET NOCOUNT ON       
    
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2  
    
IF @@CLTCODE_EXIST = 0    
BEGIN    
 SELECT 'Bank code dose not exist.'      
 RETURN      
END    
  
SELECT @@MICRNO = MICRNO  
FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2  
    
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/       
DECLARE       
@@ERROR_COUNT INT       
SELECT       
@@ERROR_COUNT = COUNT(1)       
FROM       
(      
 SELECT       
  U_FILENAME       
 FROM      
  V2_UPLOADED_FILES       
 WHERE      
  U_FILENAME = @FILENAME    
  AND U_MODULE = 'UTI_RECO UPLOAD'      
) A      
IF @@ERROR_COUNT > 0      
BEGIN       
 SELECT       
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'  
 RETURN       
END       
  
SELECT @@CROSSREFERENCENO = MAX(CROSSREFERENCENO) FROM BANKRECO     
    
CREATE       
TABLE #UTIRECO       
 (       
  BOOKDATE VARCHAR(10),    
  [DESCRIPTION] VARCHAR(100),    
  LEDGER_BALANCE VARCHAR(20),    
  CREDIT VARCHAR(20),    
  DEBIT VARCHAR(20),    
  VALUEDATE VARCHAR(10),    
  REFERENCE_NO VARCHAR(15),    
  BRANCH VARCHAR(25)    
 )       
    
    
CREATE       
TABLE [#BANKRECOSAVE_TEMP]       
 (       
  CLTCODE VARCHAR(10),    
  BOOKDATE DATETIME,     
  [DESCRIPTION] VARCHAR(50),    
  AMOUNT VARCHAR(20),     
  DRCR VARCHAR(1),    
  VALUEDATE DATETIME,    
  REFERENCENO VARCHAR(30),    
  STATUSID VARCHAR(15),    
  STATUSNAME VARCHAR(25),     
  LOGINNAME VARCHAR(25),     
  STATUS VARCHAR(9),    
  MICRNO INT,    
  DUMMY1 VARCHAR(15) ,    
  DUMMY2 VARCHAR(15),     
  AMOUNTLEDGR1 VARCHAR(20),      
  CROSSREFERENCENO [int] IDENTITY (1, 1) NOT NULL     
 )       
ON [PRIMARY]     
    
CREATE       
TABLE [#BANKRECOSAVE]       
 (       
  CLTCODE VARCHAR(10),    
  BOOKDATE DATETIME,     
  [DESCRIPTION] VARCHAR(50),    
  AMOUNT MONEY,     
  DRCR VARCHAR(1),    
  VALUEDATE DATETIME,    
  REFERENCENO VARCHAR(30),    
  STATUSID VARCHAR(15),    
  STATUSNAME VARCHAR(25),     
  LOGINNAME VARCHAR(25),     
  CROSSREFERENCENO [int],     
  STATUS VARCHAR(9),    
  MICRNO INT,    
  DUMMY1 VARCHAR(15) ,    
  DUMMY2 VARCHAR(15),     
  AMOUNTLEDGR1 MONEY      
 )       
ON [PRIMARY]     
    
    
SELECT @@SQL_QUERY = " BULK INSERT "    
SELECT @@SQL_QUERY = @@SQL_QUERY + "#UTIRECO "    
SELECT @@SQL_QUERY = @@SQL_QUERY + "FROM  "    
SELECT @@SQL_QUERY = @@SQL_QUERY +  "'" + @FILENAME   + "'"    
SELECT @@SQL_QUERY = @@SQL_QUERY + " WITH"    
SELECT @@SQL_QUERY = @@SQL_QUERY + " ("    
SELECT @@SQL_QUERY = @@SQL_QUERY + " FIELDTERMINATOR = ',',   "    
SELECT @@SQL_QUERY = @@SQL_QUERY +  "FIRSTROW = 4   "    
SELECT @@SQL_QUERY = @@SQL_QUERY + ")"    
    
EXEC (@@SQL_QUERY)    
    
DELETE FROM #UTIRECO WHERE BOOKDATE LIKE  '-%'

INSERT INTO #BANKRECOSAVE_TEMP    
SELECT    
 @BANKCODE,    
 BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),    
 [DESCRIPTION],    
 AMOUNT = (CASE WHEN CREDIT <> '' THEN CREDIT ELSE DEBIT END),    
 DRCR = (CASE WHEN CREDIT <> '' THEN 'C' ELSE 'D' END),    
 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),    
 REFERENCE_NO,    
 @STATUSID,    
 @STATUSNAME,    
 @UNAME,    
 'UNMATCHED',    
 @@MICRNO,    
 '',    
 '',    
 ''    
FROM     
 #UTIRECO    
    
    
INSERT INTO #BANKRECOSAVE    
SELECT    
 @BANKCODE,    
 BOOKDATE,     
 [DESCRIPTION],    
 CONVERT(MONEY,AMOUNT),     
 DRCR,     
 VALUEDATE,     
 REFERENCENO,    
 @STATUSID,    
 @STATUSNAME,    
 @UNAME,    
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),    
 'UNMATCHED',    
 @@MICRNO,    
 '',    
 '',    
 0  
FROM     
 #BANKRECOSAVE_TEMP    
  
SELECT  
 @@ERROR_COUNT = COUNT(1)   
FROM BANKRECO  
WHERE  
 BOOKDATE IN(SELECT DISTINCT BOOKDATE FROM #BANKRECOSAVE_TEMP)  
 AND CLTCODE = @BANKCODE
  
IF @@ERROR_COUNT <> 0  
BEGIN  
 SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED.'  
 RETURN  
END  
    
  
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'      
      
IF @@TABLE_EXIST = ''      
BEGIN       
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
/*SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS      
      
IF @@RECORD_COUNT = 0       
BEGIN      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS      
      
IF @@RECO_STATUS = 'N'       
BEGIN      
BEGIN TRAN  
 UPDATE RECOPROCESS SET INPROCESS = 'Y'      
END      
ELSE      
BEGIN      
 SELECT 'Bank Reco Upload Process is already Running From some other Terminal. Please try again later.'      
 RETURN      
END    */  
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE LEDGER_UPDATES      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE BANKRECOCOMP      
END      
      
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)      
  
INSERT       
INTO      
 V2_UPLOADED_FILES       
SELECT       
 @FILENAME,       
 @FILENAME,       
 COUNT(1),       
 'B',       
 GETDATE(),       
 @UNAME,       
 'UTI_RECO UPLOAD'       
  
    
UPDATE       
 #BANKRECOSAVE       
SET       
 STATUS ='MATCHED'       
FROM       
 LEDGER1        
WHERE       
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20' )       
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)         
 AND CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      

 
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND   REFERENCENO  <> '0'       
    
     
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
INSERT INTO       
 LEDGER_UPDATES       
SELECT       
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE       
FROM       
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' )       
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE       
 AND LEDGER1.VNO = LEDGER.VNO       
 AND LEDGER1.VTYP = LEDGER.VTYP       
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE       
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)       
 AND DDNO =  REFERENCENO       
 AND RELDT = ''       
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO         
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)        
 AND   REFERENCENO  <> '0'        
      
      
UPDATE       
 LEDGER1       
SET       
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO       
FROM       
 #BANKRECOSAVE, LEDGER (NOLOCK)       
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' )       
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)       
 AND DDNO =  REFERENCENO       
 AND RELDT = ''       
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO         
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      

 
 AND REFERENCENO  <> '0'        
 AND LEDGER.VNO = LEDGER1.VNO       
 AND LEDGER.VTYP = LEDGER1.VTYP       
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE       
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE       
      
      
SELECT       
 SUM(RELAMT) AS AMOUNT,    
 SLIPNO AS SLIPNO,    
 UPPER(DRCR) AS DRCR,    
 MICRNO        
INTO       
 BANKRECOCOMP        
FROM       
 LEDGER1         
WHERE       
 MICRNO = @@MICRNO         
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )     
 AND SLIPNO <>''       
GROUP BY       
 SLIPNO,    
 DRCR,    
 MICRNO       
      
      
UPDATE       
 #BANKRECOSAVE       
SET       
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'       
FROM       
 BANKRECOCOMP        
WHERE         
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)        
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)         
  AND #BANKRECOSAVE.MICRNO = @@MICRNO      
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT       
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO        
  AND REFERENCENO  <> '0'       
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
INSERT INTO LEDGER_UPDATES       
SELECT       
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE       
FROM       
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE         
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )       
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)       
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''       
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE       
 AND LEDGER1.VNO = LEDGER.VNO       
 AND LEDGER1.VTYP = LEDGER.VTYP       
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE       
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO           
 AND #BANKRECOSAVE.REFERENCENO  <> '0'       
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
      
      
UPDATE       
 LEDGER1       
SET       
 RELDT = VALUEDATE ,       
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO       
FROM       
 #BANKRECOSAVE, LEDGER  (NOLOCK)        
WHERE         
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )       
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)       
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''       
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO       
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO           
 AND #BANKRECOSAVE.REFERENCENO  <> '0'       
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
 AND LEDGER.VNO = LEDGER1.VNO       
 AND LEDGER.VTYP = LEDGER1.VTYP       
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE       
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE       
      
UPDATE        
 L       
SET       
 EDT = VALUEDATE       
FROM       
 LEDGER L, LEDGER_UPDATES LU       
WHERE       
 LU.VNO=L.VNO       
 AND LU.VTYP=L.VTYP       
 AND LU.BOOKTYPE=L.BOOKTYPE       
 AND EDT LIKE 'DEC 31 2049%'      
    
      
DROP TABLE BANKRECOCOMP      
DROP TABLE LEDGER_UPDATES      
      
INSERT INTO       
 BANKRECO       
SELECT   
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,      
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'       
FROM       
 #BANKRECOSAVE B       
      
      
UPDATE RECOPROCESS SET INPROCESS = 'N'      
      
--COMMIT TRAN      
      
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_ALLBANKS
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_ALLBANKS]  
 @FILENAME VARCHAR(100),        
 @UNAME VARCHAR(100),        
 @BANKCODE VARCHAR(10),        
 @STATUSID VARCHAR(10),        
 @STATUSNAME VARCHAR(100),  
 @BANK_TYPE VARCHAR(10),  
 @STAT_TYPE VARCHAR(10),  
 @LOGIN VARCHAR(10),  
 @PWD VARCHAR(15),  
 @PROCESS_STATUS BIT = 0    
    
        
AS        
        
/*      
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'        
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'        
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'    
SELECT TOP 1 * FROM BANKRECO    
*/      
DECLARE        
 @@SQL_QUERY AS VARCHAR(1000),        
 @@CROSSREFERENCENO INT,        
 @@TABLE_EXIST VARCHAR(20),        
 @@RECORD_COUNT TINYINT,        
 @@RECO_STATUS CHAR(1),        
 @@FILE_EXIST INT,        
 @@CLTCODE_EXIST INT,        
 @@MICRNO VARCHAR(20)        
        
SET NOCOUNT ON        
        
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2        
        
IF @@CLTCODE_EXIST = 0        
 BEGIN        
  SELECT 'BANK CODE DOSE NOT EXIST.'        
  RETURN        
 END        
        
SELECT @@MICRNO = ISNULL(MICRNO, 0) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2        
        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/        
DECLARE        
 @@ERROR_COUNT SMALLINT,    
 @@EXIST_COUNT_BEFORE SMALLINT,    
 @@EXIST_COUNT_AFTER SMALLINT    
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT        
   U_FILENAME        
  FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FILENAME        
   AND U_MODULE = 'HDFC_RECO UPLOAD'        
 ) A        
/*IF @@ERROR_COUNT > 0        
BEGIN        
 SELECT        
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'        
 RETURN        
END       */        
        
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO        
  
CREATE TABLE #HDFCRECO    
(  
 BOOKDATE VARCHAR(11)  
)  
  
CREATE TABLE #ICICIRECO    
(  
 SR_NO INT,  
 TXN_ID VARCHAR(25),  
 BOOKDATE VARCHAR(11)  
)  
  
  
  
IF @BANK_TYPE = 'CITYRECO'  
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"  
END  
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'   
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(100)"  
END  
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'BNK')
BEGIN
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(100)"    
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'  
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(100),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"  
END  
ELSE IF @BANK_TYPE = 'ICICIRECO'   
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"  
  
END  
  
ELSE IF @BANK_TYPE = 'SCRECO'   
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11)"  
  
END  
  
ELSE IF @BANK_TYPE = 'SBIRECO'   
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(200),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20)"   
END  
  
EXEC (@@SQL_QUERY)  
  
IF @BANK_TYPE = 'ICICIRECO'   
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD [DESCRIPTION] VARCHAR(100), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"  
  
 EXEC (@@SQL_QUERY)  
END  
  
  
  
CREATE TABLE [#BANKRECOSAVE_TEMP]        
 (        
  CLTCODE VARCHAR(10),        
  BOOKDATE DATETIME,        
  [DESCRIPTION] VARCHAR(100),        
  AMOUNT VARCHAR(20),        
  DRCR VARCHAR(1),        
  VALUEDATE DATETIME,        
  REFERENCENO VARCHAR(30),        
  STATUSID VARCHAR(15),        
  STATUSNAME VARCHAR(25),        
  LOGINNAME VARCHAR(25),        
  STATUS VARCHAR(9),        
  MICRNO INT,        
  DUMMY1 VARCHAR(15) ,        
  DUMMY2 VARCHAR(15),        
  AMOUNTLEDGR1 VARCHAR(20),        
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL        
 )        
ON [PRIMARY]        
        
CREATE TABLE [#BANKRECOSAVE]        
 (        
  CLTCODE VARCHAR(10),        
  BOOKDATE DATETIME,        
  [DESCRIPTION] VARCHAR(100),        
  AMOUNT MONEY,        
  DRCR VARCHAR(1),        
  VALUEDATE DATETIME,        
  REFERENCENO VARCHAR(30),        
  STATUSID VARCHAR(15),        
  STATUSNAME VARCHAR(25),        
  LOGINNAME VARCHAR(25),        
  CROSSREFERENCENO [INT],        
  STATUS VARCHAR(9),        
  MICRNO INT,        
  DUMMY1 VARCHAR(15) ,        
  DUMMY2 VARCHAR(15),        
  AMOUNTLEDGR1 MONEY        
 )        
ON [PRIMARY]       
  
CREATE TABLE #TESTIMPORT                  
(                  
 OneRow Varchar(2000),                
 SNO INT IDENTITY(1,1)                
)     
  
IF @BANK_TYPE = 'ICICIRECO'  
BEGIN  
 SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"  
   
END  
ELSE IF @BANK_TYPE <> 'CANARARECO'  
BEGIN  
 SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"  
END  
  
EXEC (@@SQL_QUERY)   
  
IF @BANK_TYPE = 'CITYRECO'  
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"  
END  
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'   
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "  
END  
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'BNK')
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20)," 
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "  
END  
ELSE IF @BANK_TYPE = 'SCRECO'   
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(100)"  
END  
ELSE IF @BANK_TYPE = 'SBIRECO'   
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(100)"  
END  
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'  
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"  
END  
ELSE IF @BANK_TYPE = 'ICICIRECO'  
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "  
END  
ELSE  
BEGIN  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "  
END  
  
  
EXEC (@@SQL_QUERY)  

SELECT * INTO HDFCRECO FROM #HDFCRECO  
 
IF @BANK_TYPE = 'CITYRECO'  
BEGIN  
 UPDATE HDFCRECO SET [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE', VALUEDATE = BOOKDATE  
END  
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND (@STAT_TYPE = 'TAB' OR @STAT_TYPE = 'BNK')) OR @BANK_TYPE = 'UTIRECO' OR @BANK_TYPE = 'SCRECO'  
BEGIN  
 UPDATE HDFCRECO SET AMOUNT = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN CREDIT ELSE DEBIT END, DRCR = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN 'C' ELSE 'D' END  
END  
ELSE IF @BANK_TYPE = 'SBIRECO'  
BEGIN  
 UPDATE HDFCRECO SET AMOUNT = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN CREDIT ELSE DEBIT END, DRCR = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN 'C' ELSE 'D' END  
 UPDATE HDFCRECO SET REFERENCE_NO = LTRIM(RTRIM(.DBO.SPLIT_SP1(REFERENCE_NO, '/', 1)))   
END  
ELSE IF @BANK_TYPE = 'ICICIRECO'   
BEGIN  
 UPDATE HDFCRECO SET VALUEDATE = BOOKDATE, DRCR = CASE WHEN DRCR = 'DR' THEN 'D' ELSE 'C' END  
END  
  
IF @BANK_TYPE = 'CANARARECO'   
BEGIN  
 SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"  
   EXEC(@@SQL_QUERY)                  
  
 DELETE FROM #TESTIMPORT WHERE OneRow IS NULL  
 DELETE FROM #TESTIMPORT WHERE OneRow LIKE '****%'  
  
 INSERT INTO #BANKRECOSAVE_TEMP        
 SELECT        
  @BANKCODE,        
  BOOKDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),        
  [DESCRIPTION] = SUBSTRING(OneRow, 18, 23),        
  AMOUNT = SUBSTRING(OneRow, 41, 14),        
  DRCR = SUBSTRING(OneRow, 17, 1),        
  VALUEDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),        
  REFERENCE_NO = SUBSTRING(OneRow, 9, 8),        
  @STATUSID,        
  @STATUSNAME,        
  @UNAME,        
  'UNMATCHED',        
  @@MICRNO,        
  '',        
  '',        
  ''        
 FROM        
  #TESTIMPORT    
END  
ELSE IF @BANK_TYPE = 'ICICIRECO'  
BEGIN  
 INSERT INTO #BANKRECOSAVE_TEMP        
 SELECT        
  @BANKCODE,        
  BOOKDATE = CONVERT(DATETIME,  (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 101),        
  [DESCRIPTION],        
  AMOUNT,        
  DRCR,        
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE, 2) + '-' + SUBSTRING(VALUEDATE, 4, 2)),        
  REFERENCE_NO,        
  @STATUSID,        
  @STATUSNAME,        
  @UNAME,        
  'UNMATCHED',        
  @@MICRNO,        
  '',        
  '',        
  ''        
 FROM        
  HDFCRECO    
  
END  
ELSE  
BEGIN  
 INSERT INTO #BANKRECOSAVE_TEMP     
 SELECT      
  @BANKCODE,       
  BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),        
  [DESCRIPTION],        
  AMOUNT,        
  DRCR,        
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),        
  REFERENCE_NO,        
  @STATUSID,        
  @STATUSNAME,        
  @UNAME,        
  'UNMATCHED',        
  @@MICRNO,        
  '',        
  '',        
  ''        
 FROM        
  HDFCRECO    
END  
  
DROP TABLE HDFCRECO  
  
  
INSERT INTO #BANKRECOSAVE        
SELECT        
 @BANKCODE,        
 BOOKDATE,      
 [DESCRIPTION],        
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,        
 DRCR,        
 VALUEDATE,        
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),        
 @STATUSID,        
 @STATUSNAME,        
 @UNAME,        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),        
 'UNMATCHED',        
 @@MICRNO,        
 '',        
 '',        
 0        
FROM        
 #BANKRECOSAVE_TEMP        
WHERE   
 REFERENCENO NOT LIKE '%[A-Z]%'  
  
INSERT INTO #BANKRECOSAVE        
SELECT        
 @BANKCODE,        
 BOOKDATE,      
 [DESCRIPTION],        
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,        
 DRCR,        
 VALUEDATE,        
 REFERENCENO,        
 @STATUSID,        
 @STATUSNAME,        
 @UNAME,        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),        
 'UNMATCHED',        
 @@MICRNO,        
 '',        
 '',        
 0        
FROM        
 #BANKRECOSAVE_TEMP        
WHERE   
 REFERENCENO LIKE '%[A-Z]%'  
  
INSERT INTO #BANKRECOSAVE        
SELECT        
 @BANKCODE,        
 BOOKDATE,      
 [DESCRIPTION],       
AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,        
 DRCR,        
 VALUEDATE,        
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),        
 @STATUSID,        
 @STATUSNAME,        
 @UNAME,        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),        
 'UNMATCHED',        
 @@MICRNO,        
 '',        
 '',        
 0        
FROM        
 #BANKRECOSAVE_TEMP        
WHERE   
 REFERENCENO IS NULL

  
  
  
IF @BANK_TYPE = 'CANARARECO'  
BEGIN  
 UPDATE #BANKRECOSAVE SET AMOUNT = CONVERT(MONEY, AMOUNT / 100)   
END  
  
  
/*CREATE TABLE #BANKRECOSAVE_DELETE        
(        
 [DESCRIPTION] VARCHAR(250),        
 AMOUNT MONEY,        
 DRCR CHAR(1),        
 REFERENCENO VARCHAR(25),        
CROSSREFERENCENO INT        
) */       
    
DECLARE     
@@AMOUNTDIFF MONEY,    
@@STAMOUNTDIFF MONEY,    
@@BOOKDATE_MIN DATETIME,    
@@BOOKDATE_MAX DATETIME    
    
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE     
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE     
    
    
CREATE TABLE #RECODUPS     
(    
 BOOKDATE VARCHAR(11),     
 REFERENCENO VARCHAR(25),     
 AMOUNT MONEY,     
 DESCRIPTION VARCHAR(200),     
 STATUS VARCHAR(10),     
CROSSREFERENCENO INT    
)    
    
SET @@EXIST_COUNT_BEFORE = 0    
SET @@EXIST_COUNT_AFTER = 0    
    
DECLARE     
@CLTCODE VARCHAR(10),     
@BOOKDATE DATETIME,     
@AMOUNT MONEY,     
@DRCR CHAR(1),     
@VALUEDATE DATETIME,     
@REFERENCENO VARCHAR(20),    
@DESCRIPTION VARCHAR(200)    
    
DECLARE CUR_CHECCK CURSOR FOR    
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0    
    
OPEN CUR_CHECCK    
    
FETCH NEXT FROM CUR_CHECCK    
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION    
    
WHILE @@FETCH_STATUS = 0    
BEGIN    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
 IF @PROCESS_STATUS = 0     
 BEGIN    
  SELECT @@ERROR_COUNT = 0    
      
  SELECT      
   @@EXIST_COUNT_BEFORE = COUNT(1)    
  FROM     
   BANKRECO    
  WHERE    
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)    
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')    
    
    
      
 /* IF @@ERROR_COUNT > 0    
   BEGIN    
    SELECT      
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS    
    FROM     
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,     
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B    
    WHERE    
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)    
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO    
      
    RETURN    
   END */    
 END    
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
    
     
         
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)    
 FROM #BANKRECOSAVE    
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0        
     
 DELETE BR FROM #BANKRECOSAVE BR    
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO    
     
     
 IF @PROCESS_STATUS = 0     
 BEGIN    
  SELECT     
   @@EXIST_COUNT_AFTER = COUNT(1)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR     
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0        
      
      
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER    
   BEGIN    
    INSERT INTO #RECODUPS    
    SELECT      
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO    
    FROM     
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR    
    WHERE    
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)    
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')    
      
   END     
  SET @@EXIST_COUNT_BEFORE = 0    
  SET @@EXIST_COUNT_AFTER = 0    
 END     
 FETCH NEXT FROM CUR_CHECCK    
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION    
END    

    
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0        
    
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS    
    
IF @@ERROR_COUNT > 0    
BEGIN    
 SELECT * FROM #RECODUPS    
 RETURN    
END    
  

   
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
DELETE BR FROM      
 BANKRECO B, #BANKRECOSAVE BR      
WHERE       
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))      
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')    
    
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL    
  
    
IF @@ERROR_COUNT = 0    
BEGIN     
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'     
 RETURN    
END    
      
SELECT     
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)     
FROM    
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,    
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1    
    
    
IF @PROCESS_STATUS = 1    
BEGIN    
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))    
 FROM     
 (    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   BANKRECO    
  WHERE     
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE    
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)    
  UNION ALL    
SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   VALUEDATE IS NOT NULL    
      
      
 )B    
END     
ELSE    
BEGIN     
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))    
 FROM     
 (    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   BANKRECO    
  WHERE     
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE    
  UNION ALL    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   VALUEDATE IS NOT NULL    
      
      
 )B    
END    
    
    
/*IF @@AMOUNTDIFF <> @@STAMOUNTDIFF    
BEGIN    
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'    
 RETURN    
END    */
    
 DELETE FROM     
  #BANKRECOSAVE    
 WHERE     
  VALUEDATE IS NULL    
    
    
    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'        
        
IF @@TABLE_EXIST = ''        
BEGIN        
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS        
        
IF @@RECORD_COUNT = 0        
BEGIN        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS        
        
IF @@RECO_STATUS = 'N'        
BEGIN        
 BEGIN TRAN        
 UPDATE RECOPROCESS SET INPROCESS = 'Y'        
END        
ELSE        
BEGIN        
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'        
 RETURN        
END        
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'        
IF @@TABLE_EXIST <> ''        
BEGIN        
 DROP TABLE LEDGER_UPDATES        
END        
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'        
IF @@TABLE_EXIST <> ''        
BEGIN        
 DROP TABLE BANKRECOCOMP        
END        
        
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)        
        
INSERT        
INTO        
 V2_UPLOADED_FILES        
SELECT        
 @FILENAME,        
 @FILENAME,        
 COUNT(1),        
 'B',        
 GETDATE(),        
 @UNAME,        
 'HDFC_RECO UPLOAD'        
        
        
UPDATE        
 #BANKRECOSAVE        
SET        
 STATUS ='MATCHED'        
FROM        
 LEDGER1        
WHERE        
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)        
 AND CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109) >= CONVERT(VARCHAR(11), VDT, 109))       
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND   REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
INSERT INTO        
 LEDGER_UPDATES        
SELECT       
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE        
FROM        
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE        
 AND LEDGER1.VNO = LEDGER.VNO        
 AND LEDGER1.VTYP = LEDGER.VTYP        
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND DDNO =  REFERENCENO        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)        
 AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109) >= CONVERT(VARCHAR(11), LEDGER.VDT, 109)  
 AND   REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
UPDATE        
 LEDGER1        
SET        
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO        
FROM        
 #BANKRECOSAVE, LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND DDNO =  REFERENCENO        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      


  
  
  
  
  
  
  
 AND REFERENCENO  <> '0'        
 AND LEDGER.VNO = LEDGER1.VNO        
 AND LEDGER.VTYP = LEDGER1.VTYP      
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE        
 AND CONVERT(VARCHAR(11), LEDGER.VDT, 109) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109)  
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
SELECT        
 SUM(RELAMT) AS AMOUNT,        
 SLIPNO AS SLIPNO,        
 UPPER(DRCR) AS DRCR,        
 MICRNO        
INTO        
 BANKRECOCOMP        
FROM        
 LEDGER1        
WHERE        
 MICRNO = @@MICRNO        
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )        
 AND SLIPNO <>''        
GROUP BY        
 SLIPNO,        
 DRCR,        
 MICRNO        
        
        
UPDATE        
 #BANKRECOSAVE        
SET        
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'        
FROM        
 BANKRECOCOMP        
WHERE        
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)        
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)        
  AND #BANKRECOSAVE.MICRNO = @@MICRNO        
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT        
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO        
  AND REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
INSERT INTO LEDGER_UPDATES        
SELECT        
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE        
FROM        
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE        
 AND LEDGER1.VNO = LEDGER.VNO        
 AND LEDGER1.VTYP = LEDGER.VTYP        
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.REFERENCENO  <> '0'        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
UPDATE        
 LEDGER1        
SET        
 RELDT = VALUEDATE ,        
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO        
FROM        
 #BANKRECOSAVE, LEDGER  (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.REFERENCENO  <> '0'        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)        
 AND LEDGER.VNO = LEDGER1.VNO        
 AND LEDGER.VTYP = LEDGER1.VTYP        
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
UPDATE        
 L        
SET        
 EDT = VALUEDATE        
FROM        
 LEDGER L, LEDGER_UPDATES LU        
WHERE        
 LU.VNO=L.VNO        
 AND LU.VTYP=L.VTYP        
 AND LU.BOOKTYPE=L.BOOKTYPE        
 AND EDT LIKE 'DEC 31 2049%'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'        
 ROLLBACK TRAN        
 RETURN        
END     
        
UPDATE        
 L        
SET        
 EDT = VDT        
FROM        
 LEDGER L, LEDGER_UPDATES LU        
WHERE        
 LU.VNO=L.VNO        
 AND LU.VTYP=L.VTYP        
 AND LU.BOOKTYPE=L.BOOKTYPE        
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
IF @PROCESS_STATUS = 1    
BEGIN    
 DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)    
END    
        
INSERT INTO        
 BANKRECO    
(Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,Status,Micrno,Dummy1,Dummy2)      
SELECT        
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,        
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'        
FROM        
 #BANKRECOSAVE B      
  
  
INSERT INTO        
 BANKRECO_LOG        
SELECT        
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,        
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0', 0, 'AUTO', GETDATE(), 'MATCHED'   
FROM        
 #BANKRECOSAVE B      
WHERE  
 B.STATUS = 'MATCHED'  
  
  
  
INSERT INTO LEDGER1_BANKRECO_LOG  
SELECT L1.*, 'AUTO', GETDATE(), 'MATCHED'   
FROM LEDGER1 L1, LEDGER_UPDATES LU  
WHERE L1.VNO = LU.VNO AND L1.VTYP = LU.VTYP AND L1.BOOKTYPE = LU.BOOKTYPE  
  
DROP TABLE BANKRECOCOMP        
DROP TABLE LEDGER_UPDATES      
  
UPDATE RECOPROCESS SET INPROCESS = 'N'        
        
COMMIT TRAN        
        
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_HDFC]      
 @FILENAME VARCHAR(100),      
 @UNAME VARCHAR(100),      
 @BANKCODE VARCHAR(10),      
 @STATUSID VARCHAR(10),      
 @STATUSNAME VARCHAR(100),    
 @USERNAME VARCHAR(20),
 @PWD VARCHAR(20),  
 @PROCESS_STATUS BIT = 0  
  
      
AS      
      
/*    
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'      
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'      
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'  
SELECT TOP 1 * FROM BANKRECO  
*/    
DECLARE      
 @@SQL_QUERY AS VARCHAR(1000),      
 @@CROSSREFERENCENO INT,      
 @@TABLE_EXIST VARCHAR(20),      
 @@RECORD_COUNT TINYINT,      
 @@RECO_STATUS CHAR(1),      
 @@FILE_EXIST INT,      
 @@CLTCODE_EXIST INT,      
 @@MICRNO VARCHAR(20)      
      
SET NOCOUNT ON      
      
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
IF @@CLTCODE_EXIST = 0      
 BEGIN      
  SELECT 'BANK CODE DOSE NOT EXIST.'      
  RETURN      
 END      
      
SELECT @@MICRNO = MICRNO FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
DECLARE      
 @@ERROR_COUNT SMALLINT,  
 @@EXIST_COUNT_BEFORE SMALLINT,  
 @@EXIST_COUNT_AFTER SMALLINT  
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT      
   U_FILENAME      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FILENAME      
   AND U_MODULE = 'HDFC_RECO UPLOAD'      
 ) A      
/*IF @@ERROR_COUNT > 0      
BEGIN      
 SELECT      
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'      
 RETURN      
END       */      
      
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO      
      
CREATE TABLE #HDFCRECO      
 (      
  BOOKDATE VARCHAR(10),      
  [DESCRIPTION] VARCHAR(100),      
  LEDGER_BALANCE VARCHAR(20),      
  CREDIT VARCHAR(20),      
  DEBIT VARCHAR(20),      
  VALUEDATE VARCHAR(10),      
  REFERENCE_NO VARCHAR(20),      
  BRANCH VARCHAR(25)      
 )      
      
      
CREATE TABLE [#BANKRECOSAVE_TEMP]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(100),      
  AMOUNT VARCHAR(20),      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 VARCHAR(20),      
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL      
 )      
ON [PRIMARY]      
      
CREATE TABLE [#BANKRECOSAVE]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(100),      
  AMOUNT MONEY,      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  CROSSREFERENCENO [INT],      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 MONEY      
 )      
ON [PRIMARY]      
      
      
SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO '" + @FILENAME + "',  '#HDFCRECO','" + @USERNAME + "','" + @PWD + "'"
EXEC (@@SQL_QUERY)   


  
INSERT INTO #BANKRECOSAVE_TEMP      
SELECT      
 @BANKCODE,      
 BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),      
 [DESCRIPTION],      
 AMOUNT = (CASE WHEN ([DESCRIPTION] = 'Opening balance' OR [DESCRIPTION] = 'Closing balance') THEN LEDGER_BALANCE ELSE (CASE WHEN CREDIT <> '0' THEN CREDIT ELSE DEBIT END) END) ,      
 DRCR = (CASE WHEN CREDIT <> '0' THEN 'C' ELSE 'D' END),      
 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),      
 REFERENCE_NO,      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 'UNMATCHED',      
 @@MICRNO,       '',      
 '',      
 ''      
FROM      
 #HDFCRECO   

INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 CONVERT(MONEY,AMOUNT),      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = ISNULL(REFERENCENO, 0),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
  REFERENCENO LIKE '%[A-Z]%'

DELETE FROM #BANKRECOSAVE_TEMP 
WHERE 
  REFERENCENO LIKE '%[A-Z]%'


  
INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 CONVERT(MONEY,AMOUNT),      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP    


/*CREATE TABLE #BANKRECOSAVE_DELETE      
(      
 [DESCRIPTION] VARCHAR(250),      
 AMOUNT MONEY,      
 DRCR CHAR(1),      
 REFERENCENO VARCHAR(25),      
CROSSREFERENCENO INT      
) */     

DECLARE   
@@AMOUNTDIFF MONEY,  
@@STAMOUNTDIFF MONEY,  
@@BOOKDATE_MIN DATETIME,  
@@BOOKDATE_MAX DATETIME  
  
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE   
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE   

CREATE TABLE #RECODUPS   
(  
 BOOKDATE VARCHAR(11),   
 REFERENCENO VARCHAR(25),   
 AMOUNT MONEY,   
 DESCRIPTION VARCHAR(200),   
 STATUS VARCHAR(10),   
 CROSSREFERENCENO INT  
)  
  
SET @@EXIST_COUNT_BEFORE = 0  
SET @@EXIST_COUNT_AFTER = 0  
  
DECLARE   
@CLTCODE VARCHAR(10),   
@BOOKDATE DATETIME,   
@AMOUNT MONEY,   
@DRCR CHAR(1),   
@VALUEDATE DATETIME,   
@REFERENCENO VARCHAR(20),  
@DESCRIPTION VARCHAR(200)  
  
DECLARE CUR_CHECCK CURSOR FOR  
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0  
  
OPEN CUR_CHECCK  
  
FETCH NEXT FROM CUR_CHECCK  
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
 IF @PROCESS_STATUS = 0   
 BEGIN  
  SELECT @@ERROR_COUNT = 0  
    
  SELECT    
   @@EXIST_COUNT_BEFORE = COUNT(1)  
  FROM   
   BANKRECO  
  WHERE  
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)  
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')  
  
  
    
 /* IF @@ERROR_COUNT > 0  
   BEGIN  
    SELECT    
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS  
    FROM   
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,   
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B  
    WHERE  
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)  
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO  
    
    RETURN  
   END */  
 END  
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
  
   
       
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)  
 FROM #BANKRECOSAVE  
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0      
   
 DELETE BR FROM #BANKRECOSAVE BR  
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO  
   
   
 IF @PROCESS_STATUS = 0   
 BEGIN  
  SELECT   
   @@EXIST_COUNT_AFTER = COUNT(1)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR   
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0      
    
    
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER  
   BEGIN  
    INSERT INTO #RECODUPS  
    SELECT    
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO  
    FROM   
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR  
    WHERE  
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)  
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')  
    
   END   
  SET @@EXIST_COUNT_BEFORE = 0  
  SET @@EXIST_COUNT_AFTER = 0  
 END   
 FETCH NEXT FROM CUR_CHECCK  
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION  
END  
  
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0      
  
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS  
  
IF @@ERROR_COUNT > 0  
BEGIN  
 SELECT * FROM #RECODUPS  
 RETURN  
END  
  
  
  
  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
DELETE BR FROM    
 BANKRECO B, #BANKRECOSAVE BR    
WHERE     
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))    
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')  
  
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL  
  
IF @@ERROR_COUNT = 0  
BEGIN   
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'   
 RETURN  
END  
    
SELECT   
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)   
FROM  
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE' AND BOOKDATE LIKE CONVERT(VARCHAR(11), @@BOOKDATE_MIN) + '%') BR,  
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1  

IF @PROCESS_STATUS = 1  
BEGIN  
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))  
 FROM   
 (  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   BANKRECO  
  WHERE   
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE  
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)  
  UNION ALL  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   VALUEDATE IS NOT NULL  
    
    
 )B  
END   
ELSE  
BEGIN   
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))  
 FROM   
 (  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   BANKRECO  
  WHERE   
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE  
  UNION ALL  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   VALUEDATE IS NOT NULL  
    
    
 )B  
END  

IF @@AMOUNTDIFF <> @@STAMOUNTDIFF  
BEGIN  
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'  
 RETURN  
END  
  
 DELETE FROM   
  #BANKRECOSAVE  
 WHERE   
  VALUEDATE IS NULL  
  

  DELETE #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE' 
  DELETE FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE'
  
  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'      
      
IF @@TABLE_EXIST = ''      
BEGIN      
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS      
      
IF @@RECORD_COUNT = 0      
BEGIN      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS      
      
IF @@RECO_STATUS = 'N'      
BEGIN      
 BEGIN TRAN      
 UPDATE RECOPROCESS SET INPROCESS = 'Y'      
END      
ELSE      
BEGIN      
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'      
 RETURN      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE LEDGER_UPDATES      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE BANKRECOCOMP      
END      
      
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)      
      
INSERT      
INTO      
 V2_UPLOADED_FILES      
SELECT      
 @FILENAME,      
 @FILENAME,      
 COUNT(1),      
 'B',      
 GETDATE(),      
 @UNAME,      
 'HDFC_RECO UPLOAD'      
      
      
UPDATE      
 #BANKRECOSAVE      
SET      
 STATUS ='MATCHED'      
FROM      
 LEDGER1      
WHERE      
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)      
 AND CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
  
  
  
  
  
  
  
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO      
 AND   REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
INSERT INTO      
 LEDGER_UPDATES      
SELECT     
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE      
FROM      
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' )      
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE      
 AND LEDGER1.VNO = LEDGER.VNO      
 AND LEDGER1.VTYP = LEDGER.VTYP      
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND DDNO =  REFERENCENO      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
 AND   REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
UPDATE      
 LEDGER1      
SET      
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
FROM      
 #BANKRECOSAVE, LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND DDNO =  REFERENCENO      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
  
  
  
  
  
  
  
  
  
 AND REFERENCENO  <> '0'      
 AND LEDGER.VNO = LEDGER1.VNO      
 AND LEDGER.VTYP = LEDGER1.VTYP      
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE      
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
SELECT      
 SUM(RELAMT) AS AMOUNT,      
 SLIPNO AS SLIPNO,      
 UPPER(DRCR) AS DRCR,      
 MICRNO      
INTO      
 BANKRECOCOMP      
FROM      
 LEDGER1      
WHERE      
 MICRNO = @@MICRNO      
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )      
 AND SLIPNO <>''      
GROUP BY      
 SLIPNO,      
 DRCR,      
 MICRNO      
      
      
UPDATE      
 #BANKRECOSAVE      
SET      
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'      
FROM      
 BANKRECOCOMP      
WHERE      
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)      
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)      
  AND #BANKRECOSAVE.MICRNO = @@MICRNO      
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT      
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO      
  AND REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
INSERT INTO LEDGER_UPDATES      
SELECT      
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE      
FROM      
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE      
 AND LEDGER1.VNO = LEDGER.VNO      
 AND LEDGER1.VTYP = LEDGER.VTYP      
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO      
 AND #BANKRECOSAVE.REFERENCENO  <> '0'      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
UPDATE      
 LEDGER1      
SET      
 RELDT = VALUEDATE ,      
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
FROM      
 #BANKRECOSAVE, LEDGER  (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO      
 AND #BANKRECOSAVE.REFERENCENO  <> '0'      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
 AND LEDGER.VNO = LEDGER1.VNO      
 AND LEDGER.VTYP = LEDGER1.VTYP      
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE      
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
UPDATE      
 L      
SET      
 EDT = VALUEDATE      
FROM      
 LEDGER L, LEDGER_UPDATES LU      
WHERE      
 LU.VNO=L.VNO      
 AND LU.VTYP=L.VTYP      
 AND LU.BOOKTYPE=L.BOOKTYPE      
 AND EDT LIKE 'DEC 31 2049%'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'      
 ROLLBACK TRAN      
 RETURN      
END      
      
UPDATE      
 L      
SET      
 EDT = VDT      
FROM      
 LEDGER L, LEDGER_UPDATES LU      
WHERE      
 LU.VNO=L.VNO      
 AND LU.VTYP=L.VTYP      
 AND LU.BOOKTYPE=L.BOOKTYPE      
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
DROP TABLE BANKRECOCOMP      
DROP TABLE LEDGER_UPDATES      
  
IF @PROCESS_STATUS = 1  
BEGIN  
 DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)  
END  
      
INSERT INTO      
 BANKRECO      
SELECT      
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,      
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'      
FROM      
 #BANKRECOSAVE B      
      
      
UPDATE RECOPROCESS SET INPROCESS = 'N'      
      
COMMIT TRAN      
      
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_ALLBANKS
-- --------------------------------------------------

CREATE PROC [dbo].[AUTORECOUPDATE_HDFC_ALLBANKS](            
           @FILENAME       VARCHAR(100),            
           @UNAME          VARCHAR(100),            
           @BANKCODE       VARCHAR(10),            
           @STATUSID       VARCHAR(10),            
           @STATUSNAME     VARCHAR(100),            
           @BANK_TYPE      VARCHAR(10),            
           @STAT_TYPE      VARCHAR(10),            
           @LOGIN          VARCHAR(10),            
           @PWD            VARCHAR(15),            
           @PROCESS_STATUS BIT  = 0)            
            
AS
DECLARE  @@SQL_QUERY         AS VARCHAR(1000),            
           @@CROSSREFERENCENO INT,            
           @@TABLE_EXIST      VARCHAR(20),            
           @@RECORD_COUNT     TINYINT,            
           @@RECO_STATUS      CHAR(1),            
           @@FILE_EXIST       INT,            
           @@CLTCODE_EXIST    INT,            
           @@MICRNO           VARCHAR(20)            
                                        
  SET NOCOUNT ON            
              
  SELECT @@CLTCODE_EXIST = COUNT(1)            
  FROM   ACMAST WITH(NOLOCK)             
  WHERE  CLTCODE = @BANKCODE            
         AND ACCAT = 2            
                                 
  IF @@CLTCODE_EXIST = 0            
    BEGIN            
      SELECT 'BANK CODE DOSE NOT EXIST.'            
                  
      RETURN            
    END            
        
               
  SELECT @@MICRNO = ISNULL(MICRNO,0)            
  FROM   ACMAST WITH(NOLOCK)             
  WHERE  CLTCODE = @BANKCODE            
         AND ACCAT = 2            
                                 
  /*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/            
  DECLARE  @@ERROR_COUNT        SMALLINT,            
           @@EXIST_COUNT_BEFORE SMALLINT,            
           @@EXIST_COUNT_AFTER  SMALLINT            
              
  SELECT @@ERROR_COUNT = COUNT(1)            
  FROM   (SELECT U_FILENAME            
          FROM   V2_UPLOADED_FILES WITH(NOLOCK)             
          WHERE  U_FILENAME = @FILENAME            
                 AND U_MODULE = 'HDFC_RECO UPLOAD') A            
              
  SELECT @@CROSSREFERENCENO = ISNULL(MAX(CONVERT(NUMERIC,CROSSREFERENCENO)),0)            
  FROM   BANKRECO WITH(NOLOCK)             
                     
  CREATE TABLE #HDFCRECO (            
    BOOKDATE VARCHAR(11))            
              
  CREATE TABLE #ICICIRECO (            
    SR_NO    INT,            
    TXN_ID   VARCHAR(25),            
    BOOKDATE VARCHAR(11))            
              
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'         
  BEGIN            
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"            
  END            
  ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR (@BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'             
  BEGIN            
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"            
  END            
  ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'            
  BEGIN            
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"            
  END            
  ELSE IF @BANK_TYPE = 'ICICIRECO'             
  BEGIN            
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"            
             
  END            
              
  EXEC (@@SQL_QUERY)               
              
  IF @BANK_TYPE = 'ICICIRECO'             
  BEGIN            
   SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD [DESCRIPTION] VARCHAR(100), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"            
              
   EXEC (@@SQL_QUERY)            
  END            
              
  CREATE TABLE [#BANKRECOSAVE_TEMP]                  
   (                  
    CLTCODE VARCHAR(10),                  
    BOOKDATE DATETIME,                  
    [DESCRIPTION] VARCHAR(50),                  
    AMOUNT VARCHAR(20),                  
    DRCR VARCHAR(1),                  
    VALUEDATE DATETIME,                  
    REFERENCENO VARCHAR(30),                  
    STATUSID VARCHAR(15),                  
    STATUSNAME VARCHAR(25),                  
    LOGINNAME VARCHAR(25),                  
    STATUS VARCHAR(9),                  
    MICRNO INT,                  
    DUMMY1 VARCHAR(15) ,                  
    DUMMY2 VARCHAR(15),                  
    AMOUNTLEDGR1 VARCHAR(20),                  
    CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL                  
   )                  
  ON [PRIMARY]                  
                    
  CREATE TABLE [#BANKRECOSAVE]                  
   (                  
    CLTCODE VARCHAR(10),                  
    BOOKDATE DATETIME,                  
    [DESCRIPTION] VARCHAR(50),                  
    AMOUNT MONEY,                  
    DRCR VARCHAR(1),                  
    VALUEDATE DATETIME,                  
    REFERENCENO VARCHAR(30),                  
    STATUSID VARCHAR(15),                  
    STATUSNAME VARCHAR(25),                  
    LOGINNAME VARCHAR(25),                  
    CROSSREFERENCENO [INT],                  
    STATUS VARCHAR(9),                  
    MICRNO INT,                  
    DUMMY1 VARCHAR(15) ,                  
    DUMMY2 VARCHAR(15),                  
    AMOUNTLEDGR1 MONEY,             
    L1_SNO INT,             
    VTYP SMALLINT,             
    BOOKTYPE CHAR(2),             
    VNO VARCHAR(12),             
    SLIPNO INT             
   )                  
  ON [PRIMARY]                 
              
  CREATE TABLE #TESTIMPORT                            
  (                            
   OneRow Varchar(2000),                          
   SNO INT IDENTITY(1,1)                          
  )               
              
  IF @BANK_TYPE = 'ICICIRECO'            
  BEGIN            
   SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"            
               
  END            
  ELSE IF @BANK_TYPE <> 'CANARARECO'            
  BEGIN            
   SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"            
  END        
              
  --PRINT @@SQL_QUERY            
  EXEC (@@SQL_QUERY)             
              
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'           
  BEGIN            
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"            
  END            
  ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR (@BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'             
  BEGIN            
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "            
  END            
  ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'            
  BEGIN            
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"            
  END            
  ELSE IF @BANK_TYPE = 'ICICIRECO'            
  BEGIN            
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "            
  END            
  ELSE            
  BEGIN            
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "            
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "            
  END            
              
              
  EXEC (@@SQL_QUERY)            
              
  SELECT * INTO   HDFCRECO  FROM   #HDFCRECO            
                     
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'          
    BEGIN            
      UPDATE HDFCRECO            
      SET    [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE',            
             VALUEDATE = BOOKDATE            
    END            
  ELSE            
    IF (@BANK_TYPE = 'HDFCRECO'            
        AND @STAT_TYPE = 'TAB')            
        OR @BANK_TYPE = 'UTIRECO'            
      BEGIN            
        UPDATE HDFCRECO            
        SET    AMOUNT = CASE             
                          WHEN (DEBIT IS NULL             
                                 OR CONVERT(MONEY,DEBIT) = 0) THEN CREDIT            
                          ELSE DEBIT            
                        END,            
               DRCR = CASE             
                        WHEN (DEBIT IS NULL             
                               OR CONVERT(MONEY,DEBIT) = 0) THEN 'C'            
                        ELSE 'D'            
                      END            
      END            
    ELSE            
      IF @BANK_TYPE = 'ICICIRECO'            
        BEGIN            
          UPDATE HDFCRECO            
          SET    VALUEDATE = BOOKDATE,            
                 DRCR = (CASE             
                           WHEN DRCR = 'DR' THEN 'D'            
                           ELSE 'C'            
                         END)            
        END            
              
  IF @BANK_TYPE = 'CANARARECO'            
    BEGIN            
   SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"            
     EXEC(@@SQL_QUERY)                            
              
      DELETE FROM #TESTIMPORT            
      WHERE       ONEROW IS NULL            
                              
      DELETE FROM #TESTIMPORT            
      WHERE       ONEROW LIKE '****%'            
                                          
      INSERT INTO #BANKRECOSAVE_TEMP            
      SELECT @BANKCODE,            
             BOOKDATE = CONVERT(DATETIME,SUBSTRING(SUBSTRING(ONEROW,1,8),7,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),5,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),1,4),            
                                103),            
             [DESCRIPTION] = SUBSTRING(ONEROW,18,23),            
             AMOUNT = SUBSTRING(ONEROW,41,14),            
             DRCR = SUBSTRING(ONEROW,17,1),            
             VALUEDATE = CONVERT(DATETIME,SUBSTRING(SUBSTRING(ONEROW,1,8),7,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),5,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),1,4),            
                                 103),            
             REFERENCE_NO = SUBSTRING(ONEROW,9,8),            
             @STATUSID,            
             @STATUSNAME,            
             @UNAME,            
             'UNMATCHED',            
             @@MICRNO,            
             '',            
             '',            
             ''                         
      FROM   #TESTIMPORT            
                         
    END            
  ELSE            
    IF @BANK_TYPE = 'ICICIRECO'            
      BEGIN      
    
        INSERT INTO #BANKRECOSAVE_TEMP            
        SELECT @BANKCODE,            
               BOOKDATE = CONVERT(DATETIME,(LEFT(BOOKDATE,2) + '/' + SUBSTRING(BOOKDATE,4,2) + '/' + RIGHT(BOOKDATE,4)),            
                              101),            
               [DESCRIPTION],            
               AMOUNT,            
               DRCR,            
               VALUEDATE = CONVERT(DATETIME,RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE,2) + '-' + SUBSTRING(VALUEDATE,4,2)),            
               REFERENCE_NO,            
               @STATUSID,            
               @STATUSNAME,            
               @UNAME,            
               'UNMATCHED',            
               @@MICRNO,            
               '',            
               '',            
               ''            
        FROM   HDFCRECO            
                           
      END            
    ELSE            
      BEGIN   
         
        INSERT INTO #BANKRECOSAVE_TEMP            
        SELECT @BANKCODE,            
               BOOKDATE = CONVERT(DATETIME,(LEFT(BOOKDATE,2) + '/' + SUBSTRING(BOOKDATE,4,2) + '/' + RIGHT(BOOKDATE,4)),103),            
               [DESCRIPTION],            
               AMOUNT,            
               DRCR,            
               VALUEDATE = CONVERT(DATETIME,RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE,4,2) + '-' + LEFT(VALUEDATE,2)),            
               REFERENCE_NO,            
               @STATUSID,            
               @STATUSNAME,            
               @UNAME,            
               'UNMATCHED',            
               @@MICRNO,            
               '',            
               '',            
               ''            
        FROM   HDFCRECO            
      END            
                  
  DROP TABLE HDFCRECO            
  
--select *  from #BANKRECOSAVE_TEMP  
--return   
        
  INSERT INTO #BANKRECOSAVE            
SELECT @BANKCODE,            
 BOOKDATE,            
 [DESCRIPTION],            
 AMOUNT = CASE             
            WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))            
            ELSE CONVERT(MONEY,AMOUNT)            
          END,            
 DRCR,            
 VALUEDATE,            
 REFERENCENO = CONVERT(VARCHAR,CONVERT(BIGINT,REFERENCENO)),            
 @STATUSID,            
 @STATUSNAME,           
 @UNAME,            
 CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),            
 'UNMATCHED',            
 @@MICRNO,            
 '',            
 '',            
 0,             
 0,             
 0,             
 '',             
 '',             
 0             
  FROM   #BANKRECOSAVE_TEMP            
  WHERE  REFERENCENO NOT LIKE '%[A-Z]%'            
                                          
  INSERT INTO #BANKRECOSAVE            
  SELECT @BANKCODE,            
         BOOKDATE,            
         [DESCRIPTION],            
         AMOUNT = CASE             
                    WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))            
                    ELSE CONVERT(MONEY,AMOUNT)            
                  END,            
         DRCR,            
         VALUEDATE,            
         REFERENCENO,            
         @STATUSID,            
         @STATUSNAME,            
         @UNAME,            
         CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),            
         'UNMATCHED',            
         @@MICRNO,            
         '',            
         '',            
         0,             
         0,             
         0,             
         '',             
         '',             
         0             
  FROM   #BANKRECOSAVE_TEMP            
  WHERE  REFERENCENO LIKE '%[A-Z]%'            
                                      
  INSERT INTO #BANKRECOSAVE            
  SELECT @BANKCODE,            
         BOOKDATE,            
         [DESCRIPTION],            
         AMOUNT = CASE             
                    WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))            
                    ELSE CONVERT(MONEY,AMOUNT)            
                  END,            
         DRCR,            
         VALUEDATE,            
         REFERENCENO = ISNULL(CONVERT(VARCHAR,CONVERT(BIGINT,REFERENCENO)),            
                              0),            
         @STATUSID,            
         @STATUSNAME,            
         @UNAME,            
         CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),            
         'UNMATCHED',            
         @@MICRNO,            
         '',            
         '',            
         0,             
         0,             
         0,             
         '',             
         '',             
         0             
  FROM   #BANKRECOSAVE_TEMP            
  WHERE  REFERENCENO IS NULL            
                     
  IF @BANK_TYPE = 'CANARARECO'            
    BEGIN            
      UPDATE #BANKRECOSAVE            
      SET    AMOUNT = CONVERT(MONEY,AMOUNT / 100)            
    END            
                
  /*CREATE TABLE #BANKRECOSAVE_DELETE                  
  (                  
   [DESCRIPTION] VARCHAR(250),                  
   AMOUNT MONEY,                  
   DRCR CHAR(1),                  
   REFERENCENO VARCHAR(25),                  
  CROSSREFERENCENO INT                  
  ) */            
  DECLARE  @@AMOUNTDIFF   MONEY,            
           @@STAMOUNTDIFF MONEY,            
           @@BOOKDATE_MIN DATETIME,            
           @@BOOKDATE_MAX DATETIME            
                                      
  SELECT @@BOOKDATE_MIN = MIN(BOOKDATE)            
  FROM   #BANKRECOSAVE            
                     
  SELECT @@BOOKDATE_MAX = MAX(BOOKDATE)            
  FROM   #BANKRECOSAVE            
                     
  CREATE TABLE #RECODUPS (            
    BOOKDATE         VARCHAR(11),            
    REFERENCENO      VARCHAR(25),            
    AMOUNT           MONEY,            
    DESCRIPTION      VARCHAR(200),            
    STATUS           VARCHAR(10),            
    CROSSREFERENCENO INT)            
              
  SET @@EXIST_COUNT_BEFORE = 0            
                                         
  SET @@EXIST_COUNT_AFTER = 0            
                                        
  DECLARE  @CLTCODE VARCHAR(10),            
           @BOOKDATE    DATETIME,            
           @AMOUNT      MONEY,            
           @DRCR        CHAR(1),            
           @VALUEDATE   DATETIME,            
           @REFERENCENO VARCHAR(20),            
           @DESCRIPTION VARCHAR(200)            
                                    
  DECLARE CUR_CHECCK CURSOR  FOR            
  SELECT CLTCODE,            
         BOOKDATE,            
         AMOUNT,            
         DRCR,            
         VALUEDATE,            
         REFERENCENO,            
         [DESCRIPTION]            
  FROM   #BANKRECOSAVE            
  WHERE  AMOUNT < 0            
                              
  OPEN CUR_CHECCK            
              
  FETCH NEXT FROM CUR_CHECCK            
  INTO @CLTCODE,            
       @BOOKDATE,            
       @AMOUNT,            
       @DRCR,            
       @VALUEDATE,            
       @REFERENCENO,            
       @DESCRIPTION            
                   
  WHILE @@FETCH_STATUS = 0            
    BEGIN            
      /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */            
      IF @PROCESS_STATUS = 0            
        BEGIN            
          SELECT @@ERROR_COUNT = 0            
                                             
          SELECT @@EXIST_COUNT_BEFORE = COUNT(1)            
          FROM   BANKRECO WITH(NOLOCK)            
          WHERE  CLTCODE = @CLTCODE            
                 AND BOOKDATE = @BOOKDATE            
                 AND AMOUNT = ABS(@AMOUNT)            
                 AND DRCR = @DRCR            
                 AND VALUEDATE = @VALUEDATE            
                 AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')            
        END            
                    
      /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */            
      SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)            
      FROM   #BANKRECOSAVE            
      WHERE  [DESCRIPTION] = @DESCRIPTION            
             AND AMOUNT = ABS(@AMOUNT)            
             AND DRCR = @DRCR            
             AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')            
             AND AMOUNT > 0            
                                      
      DELETE BR            
      FROM   #BANKRECOSAVE BR            
      WHERE  BR.CROSSREFERENCENO = @@CROSSREFERENCENO            
                                               
      IF @PROCESS_STATUS = 0            
        BEGIN            
          SELECT @@EXIST_COUNT_AFTER = COUNT(1)            
          FROM   #BANKRECOSAVE            
          WHERE  [DESCRIPTION] = @DESCRIPTION            
                 AND AMOUNT = ABS(@AMOUNT)            
                 AND DRCR = @DRCR            
                 AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')            
                 AND AMOUNT > 0            
                                          
          IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER            
            BEGIN            
              INSERT INTO #RECODUPS            
              SELECT BOOKDATE = CONVERT(VARCHAR(11),BR.BOOKDATE,103),            
                     BR.REFERENCENO,          
                     BR.AMOUNT,            
                     BR.[DESCRIPTION],            
                     BR.STATUS,            
                     BR.CROSSREFERENCENO            
              FROM   (SELECT *            
                      FROM   BANKRECO WITH(NOLOCK)            
                      WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59'            
                             AND CLTCODE = @BANKCODE) BR            
              WHERE  CLTCODE = @CLTCODE            
                     AND BOOKDATE = @BOOKDATE            
                     AND AMOUNT = ABS(@AMOUNT)            
                     AND DRCR = @DRCR            
                     AND VALUEDATE = @VALUEDATE            
                     AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')            
            END            
                        
          SET @@EXIST_COUNT_BEFORE = 0            
                                                 
          SET @@EXIST_COUNT_AFTER = 0            
        END            
                    
      FETCH NEXT FROM CUR_CHECCK            
      INTO @CLTCODE,            
           @BOOKDATE,            
           @AMOUNT,            
           @DRCR,            
           @VALUEDATE,            
           @REFERENCENO,            
           @DESCRIPTION            
    END            
                
  DELETE FROM #BANKRECOSAVE            
  WHERE       AMOUNT < 0            
                                   
  SELECT @@ERROR_COUNT = COUNT(1)            
  FROM   #RECODUPS            
                     
  IF @@ERROR_COUNT > 0            
    BEGIN            
      SELECT *            
      FROM   #RECODUPS            
                         
      RETURN            
    END            
                
  /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */            
  DELETE BR            
  FROM   BANKRECO B WITH(ROWLOCK),            
         #BANKRECOSAVE BR            
  WHERE  LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE))            
         AND CONVERT(VARCHAR(11),B.BOOKDATE,109) = CONVERT(VARCHAR(11),BR.BOOKDATE,109)            
         AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))            
         AND B.AMOUNT = BR.AMOUNT            
         AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR))            
         AND CONVERT(VARCHAR(11),B.VALUEDATE,109) = CONVERT(VARCHAR(11),BR.VALUEDATE,109)            
         AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)),'') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)),'')            
                                                                  
  SELECT @@ERROR_COUNT = COUNT(1)            
  FROM   #BANKRECOSAVE            
  WHERE  VALUEDATE IS NOT NULL            
                     
  IF @@ERROR_COUNT = 0            
    BEGIN            
      SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'            
                
      RETURN            
    END            
                
  SELECT @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)            
  FROM   (SELECT AMOUNT            
          FROM   #BANKRECOSAVE            
          WHERE  [DESCRIPTION] = 'OPENING BALANCE') BR,        
        (SELECT AMOUNT            
          FROM   #BANKRECOSAVE            
          WHERE  [DESCRIPTION] = 'CLOSING BALANCE') BR1            
                     
  IF @PROCESS_STATUS = 1            
    BEGIN            
      SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))            
      FROM   (SELECT AMOUNT = (CASE DRCR             
                                    WHEN 'D' THEN SUM(AMOUNT)            
                                    ELSE -SUM(AMOUNT)            
                                  END)            
              FROM   BANKRECO B WITH (NOLOCK)            
              WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX            
                     AND CLTCODE = @BANKCODE            
                     AND NOT EXISTS (SELECT CROSSNO            
                                                  FROM   RECODUPS1 R WHERE R.CROSSNO = B.CROSSREFERENCENO)            
              GROUP BY DRCR             
              UNION ALL            
              SELECT AMOUNT = (CASE DRCR             
                                    WHEN 'D' THEN SUM(AMOUNT)            
                                    ELSE -SUM(AMOUNT)            
                                  END)            
              FROM   #BANKRECOSAVE            
              WHERE  VALUEDATE IS NOT NULL            
              GROUP BY DRCR) B            
 END            
  ELSE            
    BEGIN            
      SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))            
      FROM   (SELECT AMOUNT = (CASE DRCR             
                                    WHEN 'D' THEN SUM(AMOUNT)            
                                    ELSE -SUM(AMOUNT)            
                                  END)            
              FROM   BANKRECO B WITH (NOLOCK)            
              WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX            
                     AND CLTCODE = @BANKCODE            
              GROUP BY DRCR             
              UNION ALL            
              SELECT AMOUNT = (CASE DRCR             
                                    WHEN 'D' THEN SUM(AMOUNT)            
                                    ELSE -SUM(AMOUNT)            
                                  END)            
              FROM   #BANKRECOSAVE            
              WHERE  VALUEDATE IS NOT NULL            
              GROUP BY DRCR) B            
    END            
                
  IF @@AMOUNTDIFF <> @@STAMOUNTDIFF            
    BEGIN            
      SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'            
                         
      RETURN            
    END            
                
  DELETE FROM #BANKRECOSAVE            
  WHERE       VALUEDATE IS NULL            
                          
  /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */            
  SET @@TABLE_EXIST = ''            
                                
  SELECT @@TABLE_EXIST = NAME            
  FROM   SYSOBJECTS            
  WHERE  NAME = 'RECOPROCESS'            
                            
  IF @@TABLE_EXIST = ''            
    BEGIN            
      CREATE TABLE RECOPROCESS (            
        INPROCESS VARCHAR(1))            
                  
      INSERT INTO RECOPROCESS            
                 (INPROCESS)            
      VALUES     ('N')            
    END            
                
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED            
              
    SELECT @@RECORD_COUNT = COUNT(* )            
  FROM   RECOPROCESS            
                     
  IF @@RECORD_COUNT = 0            
    BEGIN            
      INSERT INTO RECOPROCESS            
                 (INPROCESS)            
      VALUES     ('N')            
    END            
                
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED            
              
  SELECT TOP 1 @@RECO_STATUS = INPROCESS            
  FROM   RECOPROCESS WITH (NOLOCK)            
                     
  IF @@RECO_STATUS = 'N'            
    BEGIN            
      BEGIN TRAN            
                  
      UPDATE RECOPROCESS            
      SET    INPROCESS = 'Y'            
    END            
  ELSE            
    BEGIN            
      SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'            
                         
      RETURN            
    END            
                
  INSERT INTO V2_UPLOADED_FILES            
  SELECT @FILENAME,            
         @FILENAME,            
         COUNT(1),            
         'B',            
         GETDATE(),            
         @UNAME,            
         'HDFC_RECO UPLOAD'            
                     
  UPDATE #BANKRECOSAVE            
  SET    STATUS = 'MATCHED',             
         L1_SNO = LEDGER1.L1_SNO,             
         VTYP = LEDGER1.VTYP,             
         BOOKTYPE = LEDGER1.BOOKTYPE,             
         VNO = LEDGER1.VNO             
  FROM   LEDGER1 WITH (NOLOCK)            
  WHERE  (LEDGER1.VTYP = 2            
           OR LEDGER1.VTYP = 3            
           OR LEDGER1.VTYP = 5            
           OR LEDGER1.VTYP = 17            
           OR LEDGER1.VTYP = 19            
           OR LEDGER1.VTYP = 20)            
         AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
         AND RTRIM(DDNO) = RTRIM(REFERENCENO)            
         AND CLTCODE = @BANKCODE            
         AND #BANKRECOSAVE.MICRNO = @@MICRNO          
         AND LEDGER1.RELDT = ''        
   AND #BANKRECOSAVE.AMOUNT = LEDGER1.RELAMT      
         AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT)            
                                     FROM   LEDGER1 L1 WITH(NOLOCK),            
                                            LEDGER L2 WITH(NOLOCK)            
                                     WHERE  L2.VNO = L1.VNO            
                                            AND L2.VTYP = L1.VTYP            
                                            AND L2.BOOKTYPE = L1.BOOKTYPE            
                                            AND RELDT = ''            
                                            AND CLTCODE = @BANKCODE            
                                            AND #BANKRECOSAVE.REFERENCENO = DDNO            
                                            AND #BANKRECOSAVE.DRCR = L1.DRCR            
                                            AND CONVERT(DATETIME, CONVERT(VARCHAR(11),#BANKRECOSAVE.VALUEDATE,101)) >= CONVERT(DATETIME, CONVERT(VARCHAR(11),VDT,101)))            
         AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO,0)            
         AND REFERENCENO <> '0'            
                                        
  IF @@ERROR <> 0            
    BEGIN            
      SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'            
                         
      ROLLBACK TRAN            
                  
      RETURN            
    END            
                
  IF @@ERROR <> 0            
    BEGIN            
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'            
                         
      ROLLBACK TRAN            
           
      RETURN            
    END            
            
  UPDATE LEDGER1 WITH (ROWLOCK)            
  SET    RELDT = VALUEDATE,            
         REFNO = #BANKRECOSAVE.CROSSREFERENCENO            
  FROM   #BANKRECOSAVE              
  WHERE  #BANKRECOSAVE.L1_SNO <> 0             
         AND LEDGER1.L1_SNO = #BANKRECOSAVE.L1_SNO             
            
                                                                
  IF @@ERROR <> 0            
    BEGIN            
      SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'            
                         
      ROLLBACK TRAN            
                  
      RETURN            
    END            
                
  UPDATE #BANKRECOSAVE            
  SET    AMOUNTLEDGR1 = BANKRECOCOMP.AMOUNT,            
         STATUS = 'MATCHED',             
         SLIPNO = BANKRECOCOMP.SLIPNO             
  FROM   (SELECT   SUM(RELAMT)   AS AMOUNT,            
                   SLIPNO        AS SLIPNO,            
                   UPPER(DRCR)   AS DRCR,            
                   MICRNO            
          FROM     LEDGER1 WITH(NOLOCK)            
          WHERE    MICRNO = @@MICRNO            
                   AND (VTYP = 2            
                         OR VTYP = 19            
                         OR VTYP = 5)            
                   AND SLIPNO <> ''            
                   AND RELDT = ''             
          GROUP BY SLIPNO,DRCR,MICRNO) BANKRECOCOMP            
  WHERE  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)            
         AND RTRIM(BANKRECOCOMP.SLIPNO) = RTRIM(REFERENCENO)            
         AND #BANKRECOSAVE.MICRNO = @@MICRNO            
         AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT            
   AND #BANKRECOSAVE.MICRNO = BANKRECOCOMP.MICRNO            
         AND REFERENCENO <> '0'            
                                        
  IF @@ERROR <> 0            
    BEGIN            
      SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'            
                         
      ROLLBACK TRAN            
                  
      RETURN            
    END            
            
  SELECT L1.VTYP,             
         L1.BOOKTYPE,             
         L1.VNO,             
         L1.L1_SNO,             
         #BANKRECOSAVE.VALUEDATE,             
         #BANKRECOSAVE.CROSSREFERENCENO             
  INTO   #LEDGER_UPDATES_FOR_SLIPS             
  FROM   #BANKRECOSAVE,             
         LEDGER1 L1 WITH(NOLOCK)         
  WHERE  L1.MICRNO = @@MICRNO               
         AND L1.SLIPNO = #BANKRECOSAVE.SLIPNO             
         AND #BANKRECOSAVE.SLIPNO <> 0             
            
  IF @@ERROR <> 0            
    BEGIN            
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'            
                         
      ROLLBACK TRAN            
                  
      RETURN            
    END            
                
  UPDATE LEDGER1 WITH (ROWLOCK)            
  SET    RELDT = VALUEDATE,            
         REFNO = #LEDGER_UPDATES_FOR_SLIPS.CROSSREFERENCENO            
  FROM   #LEDGER_UPDATES_FOR_SLIPS            
  WHERE  #LEDGER_UPDATES_FOR_SLIPS.L1_SNO <> 0             
         AND LEDGER1.L1_SNO = #LEDGER_UPDATES_FOR_SLIPS.L1_SNO             
                                          
  IF @@ERROR <> 0            
    BEGIN            
      SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'            
                         
      ROLLBACK TRAN            
                  
      RETURN            
    END            
                
  UPDATE L            
  SET    EDT = (CASE             
                  WHEN CONVERT(DATETIME,(CONVERT(VARCHAR(11),VALUEDATE,109))) < CONVERT(DATETIME,(CONVERT(VARCHAR(11),VDT,109))) THEN VDT            
                  ELSE VALUEDATE            
                END)            
  FROM   LEDGER L WITH (ROWLOCK),            
         (SELECT VTYP,            
                 BOOKTYPE,            
                 VNO,            
                 VALUEDATE            
          FROM   #BANKRECOSAVE            
          WHERE  VNO <> ''            
          UNION             
          SELECT VTYP,            
                 BOOKTYPE,            
                 VNO,            
                 VALUEDATE            
          FROM   #LEDGER_UPDATES_FOR_SLIPS            
          WHERE  VNO <> '') LU            
  WHERE  LU.VNO = L.VNO            
         AND LU.VTYP = L.VTYP            
         AND LU.BOOKTYPE = L.BOOKTYPE            
         AND EDT LIKE 'DEC 31 2049%'            
                                  
  IF @@ERROR <> 0            
    BEGIN            
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'            
                         
      ROLLBACK TRAN            
                  
      RETURN            
    END            
                
  IF @@ERROR <> 0            
    BEGIN            
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'            
                         
      ROLLBACK TRAN            
                  
      RETURN            
    END            
                
  IF @PROCESS_STATUS = 1            
    BEGIN            
      DELETE FROM BANKRECO WITH (ROWLOCK)            
      WHERE       CLTCODE = @BANKCODE            
                  AND CROSSREFERENCENO IN (SELECT CROSSNO            
                                           FROM   RECODUPS1)            
    END            
                
  INSERT INTO BANKRECO            
             (CLTCODE,            
              BOOKDATE,            
              DESCRIPTION,            
              AMOUNT,            
              DRCR,            
              VALUEDATE,            
              REFERENCENO,            
              STATUSID,            
              STATUSNAME,            
              LOGINNAME,            
              CROSSREFERENCENO,            
              STATUS,            
              MICRNO,            
              DUMMY1,            
              DUMMY2)            
  SELECT B.CLTCODE,            
         B.BOOKDATE,            
         B.DESCRIPTION,            
         B.AMOUNT,            
         B.DRCR,            
         B.VALUEDATE,            
         B.REFERENCENO,            
         B.STATUSID,       
         B.STATUSNAME,         
         B.LOGINNAME,            
         B.CROSSREFERENCENO,            
         B.STATUS,            
         @@MICRNO,            
         '0',            
         '0'            
  FROM   #BANKRECOSAVE B            
                     
 INSERT INTO BANKRECO_LOG            
  SELECT B.CLTCODE,            
         B.BOOKDATE,            
         B.DESCRIPTION,            
         B.AMOUNT,            
         B.DRCR,            
         B.VALUEDATE,            
         B.REFERENCENO,            
         B.STATUSID,            
         B.STATUSNAME,            
         B.LOGINNAME,            
         B.CROSSREFERENCENO,            
         B.STATUS,            
         @@MICRNO,            
         '0',            
         '0',            
         0,            
         'AUTO',            
         GETDATE(),            
         'MATCHED'            
  FROM   #BANKRECOSAVE B            
  WHERE  B.STATUS = 'MATCHED'            
                                
  INSERT INTO LEDGER1_BANKRECO_LOG            
  SELECT L1.*,            
         'AUTO',            
         GETDATE(),            
         'MATCHED'            
  FROM   LEDGER1 L1 WITH (NOLOCK),            
         (SELECT VTYP,            
                 BOOKTYPE,            
                 VNO            
          FROM   #BANKRECOSAVE            
          WHERE  VNO <> ''            
          UNION             
          SELECT VTYP,            
                 BOOKTYPE,            
                 VNO            
          FROM   #LEDGER_UPDATES_FOR_SLIPS            
          WHERE  VNO <> '') LU            
  WHERE  L1.VNO = LU.VNO            
         AND L1.VTYP = LU.VTYP            
         AND L1.BOOKTYPE = LU.BOOKTYPE            
                                       
  UPDATE RECOPROCESS            
  SET    INPROCESS = 'N'            
                                 
  COMMIT TRAN            
              
  SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_ALLBANKS_bak_oct122011
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_HDFC_ALLBANKS_bak_oct122011]
 @FILENAME VARCHAR(100),      
 @UNAME VARCHAR(100),      
 @BANKCODE VARCHAR(10),      
 @STATUSID VARCHAR(10),      
 @STATUSNAME VARCHAR(100),
 @BANK_TYPE VARCHAR(10),
 @STAT_TYPE VARCHAR(10),
 @LOGIN VARCHAR(10),
 @PWD VARCHAR(15),
 @PROCESS_STATUS BIT = 0  
  
      
AS      
      
/*    
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'      
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'      
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'  
SELECT TOP 1 * FROM BANKRECO  
*/    
DECLARE      
 @@SQL_QUERY AS VARCHAR(1000),      
 @@CROSSREFERENCENO INT,      
 @@TABLE_EXIST VARCHAR(20),      
 @@RECORD_COUNT TINYINT,      
 @@RECO_STATUS CHAR(1),      
 @@FILE_EXIST INT,      
 @@CLTCODE_EXIST INT,      
 @@MICRNO VARCHAR(20)      
      
SET NOCOUNT ON      
      
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
IF @@CLTCODE_EXIST = 0      
 BEGIN      
  SELECT 'BANK CODE DOSE NOT EXIST.'      
  RETURN      
 END      
      
SELECT @@MICRNO = ISNULL(MICRNO, 0) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
DECLARE      
 @@ERROR_COUNT SMALLINT,  
 @@EXIST_COUNT_BEFORE SMALLINT,  
 @@EXIST_COUNT_AFTER SMALLINT  
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT      
   U_FILENAME      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FILENAME      
   AND U_MODULE = 'HDFC_RECO UPLOAD'      
 ) A      
/*IF @@ERROR_COUNT > 0      
BEGIN      
 SELECT      
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'      
 RETURN      
END       */      
      
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO      

CREATE TABLE #HDFCRECO  
(
	BOOKDATE VARCHAR(11)
)

CREATE TABLE #ICICIRECO  
(
	SR_NO INT,
	TXN_ID VARCHAR(25),
	BOOKDATE VARCHAR(11)
)

IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"  
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"

END

EXEC (@@SQL_QUERY)

IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"

	EXEC (@@SQL_QUERY)
END

CREATE TABLE [#BANKRECOSAVE_TEMP]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(100),      
  AMOUNT VARCHAR(20),      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 VARCHAR(20),      
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL      
 )      
ON [PRIMARY]      
      
CREATE TABLE [#BANKRECOSAVE]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(100),      
  AMOUNT MONEY,      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  CROSSREFERENCENO [INT],      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 MONEY      
 )      
ON [PRIMARY]     

CREATE TABLE #TESTIMPORT                
(                
	OneRow Varchar(2000),              
	SNO INT IDENTITY(1,1)              
)   

IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"
	
END
ELSE IF @BANK_TYPE <> 'CANARARECO'
BEGIN
	SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"
END

--PRINT @@SQL_QUERY
EXEC (@@SQL_QUERY) 




IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "
END
ELSE
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "
END


EXEC (@@SQL_QUERY)

SELECT * INTO HDFCRECO FROM #HDFCRECO
IF @BANK_TYPE = 'CITYRECO'
BEGIN
	UPDATE HDFCRECO SET [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE', VALUEDATE = BOOKDATE
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	UPDATE HDFCRECO SET AMOUNT = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN CREDIT ELSE DEBIT END, DRCR = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN 'C' ELSE 'D' END
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	UPDATE HDFCRECO SET VALUEDATE = BOOKDATE, DRCR = CASE WHEN DRCR = 'DR' THEN 'D' ELSE 'C' END
END

IF @BANK_TYPE = 'CANARARECO' 
BEGIN
	SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"
  	EXEC(@@SQL_QUERY)                

	DELETE FROM #TESTIMPORT WHERE OneRow IS NULL
	DELETE FROM #TESTIMPORT WHERE OneRow LIKE '****%'

	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 @BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),      
	 [DESCRIPTION] = SUBSTRING(OneRow, 18, 23),      
	 AMOUNT = SUBSTRING(OneRow, 41, 14),      
	 DRCR = SUBSTRING(OneRow, 17, 1),      
	 VALUEDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),      
	 REFERENCE_NO = SUBSTRING(OneRow, 9, 8),      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 @@MICRNO,      
	 '',      
	 '',      
	 ''      
	FROM      
	 #TESTIMPORT  
END
ELSE IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 @BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME,  (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 101),      
	 [DESCRIPTION],      
	 AMOUNT,      
	 DRCR,      
	 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE, 2) + '-' + SUBSTRING(VALUEDATE, 4, 2)),      
	 REFERENCE_NO,      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 @@MICRNO,      
	 '',      
	 '',      
	 ''      
	FROM      
	 HDFCRECO  

END
ELSE
BEGIN
	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 @BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),      
	 [DESCRIPTION],      
	 AMOUNT,      
	 DRCR,      
	 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),      
	 REFERENCE_NO,      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 @@MICRNO,      
	 '',      
	 '',      
	 ''      
	FROM      
	 HDFCRECO  
END

DROP TABLE HDFCRECO



INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO NOT LIKE '%[A-Z]%'

INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO,      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO LIKE '%[A-Z]%'

INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],     
AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO IS NULL



IF @BANK_TYPE = 'CANARARECO'
BEGIN
	UPDATE #BANKRECOSAVE SET AMOUNT = CONVERT(MONEY, AMOUNT / 100)	
END



/*CREATE TABLE #BANKRECOSAVE_DELETE      
(      
 [DESCRIPTION] VARCHAR(250),      
 AMOUNT MONEY,      
 DRCR CHAR(1),      
 REFERENCENO VARCHAR(25),      
CROSSREFERENCENO INT      
) */     
  
DECLARE   
@@AMOUNTDIFF MONEY,  
@@STAMOUNTDIFF MONEY,  
@@BOOKDATE_MIN DATETIME,  
@@BOOKDATE_MAX DATETIME  
  
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE   
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE   
  
  
CREATE TABLE #RECODUPS   
(  
 BOOKDATE VARCHAR(11),   
 REFERENCENO VARCHAR(25),   
 AMOUNT MONEY,   
 DESCRIPTION VARCHAR(200),   
 STATUS VARCHAR(10),   
 CROSSREFERENCENO INT  
)  
  
SET @@EXIST_COUNT_BEFORE = 0  
SET @@EXIST_COUNT_AFTER = 0  
  
DECLARE   
@CLTCODE VARCHAR(10),   
@BOOKDATE DATETIME,   
@AMOUNT MONEY,   
@DRCR CHAR(1),   
@VALUEDATE DATETIME,   
@REFERENCENO VARCHAR(20),  
@DESCRIPTION VARCHAR(200)  
  
DECLARE CUR_CHECCK CURSOR FOR  
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0  
  
OPEN CUR_CHECCK  
  
FETCH NEXT FROM CUR_CHECCK  
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
 IF @PROCESS_STATUS = 0   
 BEGIN  
  SELECT @@ERROR_COUNT = 0  
    
  SELECT    
   @@EXIST_COUNT_BEFORE = COUNT(1)  
  FROM   
   BANKRECO  
  WHERE  
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)  
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')  
  
  
    
 /* IF @@ERROR_COUNT > 0  
   BEGIN  
    SELECT    
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS  
    FROM   
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,   
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B  
    WHERE  
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)  
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO  
    
    RETURN  
   END */  
 END  
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
  
   
       
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)  
 FROM #BANKRECOSAVE  
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0      
   
 DELETE BR FROM #BANKRECOSAVE BR  
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO  
   
   
 IF @PROCESS_STATUS = 0   
 BEGIN  
  SELECT   
   @@EXIST_COUNT_AFTER = COUNT(1)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR   
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0      
    
    
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER  
   BEGIN  
    INSERT INTO #RECODUPS  
    SELECT    
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO  
    FROM   
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR  
    WHERE  
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)  
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')  
    
   END   
  SET @@EXIST_COUNT_BEFORE = 0  
  SET @@EXIST_COUNT_AFTER = 0  
 END   
 FETCH NEXT FROM CUR_CHECCK  
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION  
END  
  
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0      
  
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS  
  
IF @@ERROR_COUNT > 0  
BEGIN  
 SELECT * FROM #RECODUPS  
 RETURN  
END  
  
  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
DELETE BR FROM    
 BANKRECO B, #BANKRECOSAVE BR    
WHERE     
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))    
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')  
  
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL  

  
IF @@ERROR_COUNT = 0  
BEGIN   
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'   
 RETURN  
END  
    
SELECT   
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)   
FROM  
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,  
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1  
  
  
IF @PROCESS_STATUS = 1  
BEGIN  
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))  
 FROM   
 (  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   BANKRECO  
  WHERE   
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE  
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)  
  UNION ALL  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   VALUEDATE IS NOT NULL  
    
    
 )B  
END   
ELSE  
BEGIN   
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))  
 FROM   
 (  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   BANKRECO  
  WHERE   
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE  
  UNION ALL  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   VALUEDATE IS NOT NULL  
    
    
 )B  
END  
  
  
IF @@AMOUNTDIFF <> @@STAMOUNTDIFF  
BEGIN  
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'  
 RETURN  
END  
  
 DELETE FROM   
  #BANKRECOSAVE  
 WHERE   
  VALUEDATE IS NULL  
  
  
  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'      
      
IF @@TABLE_EXIST = ''      
BEGIN      
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS      
      
IF @@RECORD_COUNT = 0      
BEGIN      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS      
      
IF @@RECO_STATUS = 'N'      
BEGIN      
 BEGIN TRAN      
 UPDATE RECOPROCESS SET INPROCESS = 'Y'      
END      
ELSE      
BEGIN      
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'      
 RETURN      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE LEDGER_UPDATES      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE BANKRECOCOMP      
END      
      
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)      
      
INSERT      
INTO      
 V2_UPLOADED_FILES      
SELECT      
 @FILENAME,      
 @FILENAME,      
 COUNT(1),      
 'B',      
 GETDATE(),      
 @UNAME,      
 'HDFC_RECO UPLOAD'      
      
      
UPDATE      
 #BANKRECOSAVE      
SET      
 STATUS ='MATCHED'      
FROM      
 LEDGER1      
WHERE      
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)      
 AND CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109) >= CONVERT(VARCHAR(11), VDT, 109))     
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND   REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
INSERT INTO      
 LEDGER_UPDATES      
SELECT     
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE      
FROM      
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')      
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE      
 AND LEDGER1.VNO = LEDGER.VNO      
 AND LEDGER1.VTYP = LEDGER.VTYP      
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND DDNO =  REFERENCENO      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
 AND CONVERT(VARCHAR(11), #BANKRECOSAVE.AMOUNT, 109) >= CONVERT(VARCHAR(11), LEDGER.VDT, 109)
 AND   REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
UPDATE      
 LEDGER1      
SET      
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
FROM      
 #BANKRECOSAVE, LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND DDNO =  REFERENCENO      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      



 AND REFERENCENO  <> '0'      
 AND LEDGER.VNO = LEDGER1.VNO      
 AND LEDGER.VTYP = LEDGER1.VTYP    
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE      
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE      
 AND CONVERT(VARCHAR(11), LEDGER.VDT, 109) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109)
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
SELECT      
 SUM(RELAMT) AS AMOUNT,      
 SLIPNO AS SLIPNO,      
 UPPER(DRCR) AS DRCR,      
 MICRNO      
INTO      
 BANKRECOCOMP      
FROM      
 LEDGER1      
WHERE      
 MICRNO = @@MICRNO      
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )      
 AND SLIPNO <>''      
GROUP BY      
 SLIPNO,      
 DRCR,      
 MICRNO      
      
      
UPDATE      
 #BANKRECOSAVE      
SET      
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'      
FROM      
 BANKRECOCOMP      
WHERE      
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)      
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)      
  AND #BANKRECOSAVE.MICRNO = @@MICRNO      
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT      
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO      
  AND REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
INSERT INTO LEDGER_UPDATES      
SELECT      
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE      
FROM      
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE      
 AND LEDGER1.VNO = LEDGER.VNO      
 AND LEDGER1.VTYP = LEDGER.VTYP      
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.REFERENCENO  <> '0'      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
UPDATE      
 LEDGER1      
SET      
 RELDT = VALUEDATE ,      
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
FROM      
 #BANKRECOSAVE, LEDGER  (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.REFERENCENO  <> '0'      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
 AND LEDGER.VNO = LEDGER1.VNO      
 AND LEDGER.VTYP = LEDGER1.VTYP      
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE      
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
UPDATE      
 L      
SET      
 EDT = VALUEDATE      
FROM      
 LEDGER L, LEDGER_UPDATES LU      
WHERE      
 LU.VNO=L.VNO      
 AND LU.VTYP=L.VTYP      
 AND LU.BOOKTYPE=L.BOOKTYPE      
 AND EDT LIKE 'DEC 31 2049%'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'      
 ROLLBACK TRAN      
 RETURN      
END      
      
UPDATE      
 L      
SET      
 EDT = VDT      
FROM      
 LEDGER L, LEDGER_UPDATES LU      
WHERE      
 LU.VNO=L.VNO      
 AND LU.VTYP=L.VTYP      
 AND LU.BOOKTYPE=L.BOOKTYPE      
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
IF @PROCESS_STATUS = 1  
BEGIN  
 DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)  
END  
      
INSERT INTO      
 BANKRECO  
(Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,Status,Micrno,Dummy1,Dummy2)    
SELECT      
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,      
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'      
FROM      
 #BANKRECOSAVE B    

INSERT INTO      
 BANKRECO_LOG      
SELECT      
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,      
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0', 0, 'AUTO', GETDATE(), 'MATCHED' 
FROM      
 #BANKRECOSAVE B    
WHERE
 B.STATUS = 'MATCHED'



INSERT INTO LEDGER1_BANKRECO_LOG
SELECT L1.*, 'AUTO', GETDATE(), 'MATCHED' 
FROM LEDGER1 L1, LEDGER_UPDATES LU
WHERE L1.VNO = LU.VNO AND L1.VTYP = LU.VTYP AND L1.BOOKTYPE = LU.BOOKTYPE

DROP TABLE BANKRECOCOMP      
DROP TABLE LEDGER_UPDATES    

UPDATE RECOPROCESS SET INPROCESS = 'N'      
      
COMMIT TRAN      
      
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_ALLBANKS_TEST
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_HDFC_ALLBANKS_TEST]
 @FILENAME VARCHAR(100),      
 @UNAME VARCHAR(100),      
 @BANKCODE VARCHAR(10),      
 @STATUSID VARCHAR(10),      
 @STATUSNAME VARCHAR(100),
 @BANK_TYPE VARCHAR(10),
 @STAT_TYPE VARCHAR(10),
 @LOGIN VARCHAR(10),
 @PWD VARCHAR(15),
 @PROCESS_STATUS BIT = 0  
  
      
AS      
      
/*    
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'      
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'      
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'  
SELECT TOP 1 * FROM BANKRECO  
*/    
DECLARE      
 @@SQL_QUERY AS VARCHAR(1000),      
 @@CROSSREFERENCENO INT,      
 @@TABLE_EXIST VARCHAR(20),      
 @@RECORD_COUNT TINYINT,      
 @@RECO_STATUS CHAR(1),      
 @@FILE_EXIST INT,      
 @@CLTCODE_EXIST INT,      
 @@MICRNO VARCHAR(20)      
      
SET NOCOUNT ON      
      
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
IF @@CLTCODE_EXIST = 0      
 BEGIN      
  SELECT 'BANK CODE DOSE NOT EXIST.'      
  RETURN      
 END      
      
SELECT @@MICRNO = ISNULL(MICRNO, 0) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
DECLARE      
 @@ERROR_COUNT SMALLINT,  
 @@EXIST_COUNT_BEFORE SMALLINT,  
 @@EXIST_COUNT_AFTER SMALLINT  
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT      
   U_FILENAME      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FILENAME      
   AND U_MODULE = 'HDFC_RECO UPLOAD'      
 ) A      
/*IF @@ERROR_COUNT > 0      
BEGIN      
 SELECT      
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'      
 RETURN      
END       */      
      
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO      

CREATE TABLE #HDFCRECO  
(
	BOOKDATE VARCHAR(11)
)

IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"  
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"
END

EXEC (@@SQL_QUERY)


CREATE TABLE [#BANKRECOSAVE_TEMP]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(50),      
  AMOUNT VARCHAR(20),      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 VARCHAR(20),      
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL      
 )      
ON [PRIMARY]      
      
CREATE TABLE [#BANKRECOSAVE]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(50),      
  AMOUNT MONEY,      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  CROSSREFERENCENO [INT],      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 MONEY      
 )      
ON [PRIMARY]     

CREATE TABLE #TESTIMPORT                
(                
	OneRow Varchar(2000),              
	SNO INT IDENTITY(1,1)              
)   

IF @BANK_TYPE <> 'CANARARECO'
BEGIN
	SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"
END

EXEC (@@SQL_QUERY) 

SELECT * FROM #HDFCRECO


IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "

END
ELSE
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "
END

EXEC (@@SQL_QUERY)
SELECT * INTO HDFCRECO FROM #HDFCRECO

IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	UPDATE HDFCRECO SET VALUEDATE = BOOKDATE
END
SELECT * FROM HDFCRECO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_ANAGRAM
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_HDFC_ANAGRAM]
 @FILENAME VARCHAR(100),        
 @UNAME VARCHAR(100),        
 @BANKCODE VARCHAR(10),        
 @STATUSID VARCHAR(10),        
 @STATUSNAME VARCHAR(100),        
 @PROCESS_STATUS BIT = 0    
    
        
AS        
        
/*      
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'        
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'        
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'    
SELECT TOP 1 * FROM BANKRECO    
*/      
DECLARE        
 @@SQL_QUERY AS VARCHAR(1000),        
 @@CROSSREFERENCENO INT,        
 @@TABLE_EXIST VARCHAR(20),        
 @@RECORD_COUNT TINYINT,        
 @@RECO_STATUS CHAR(1),        
 @@FILE_EXIST INT,        
 @@CLTCODE_EXIST INT,        
 @@MICRNO VARCHAR(20)        
        
SET NOCOUNT ON        
        
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2        
        
IF @@CLTCODE_EXIST = 0        
 BEGIN        
  SELECT 'BANK CODE DOSE NOT EXIST.'        
  RETURN        
 END        
        
SELECT @@MICRNO = MICRNO FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2        
        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/        
DECLARE        
 @@ERROR_COUNT SMALLINT,    
 @@EXIST_COUNT_BEFORE SMALLINT,    
 @@EXIST_COUNT_AFTER SMALLINT    
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT        
   U_FILENAME        
  FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FILENAME        
   AND U_MODULE = 'HDFC_RECO UPLOAD'        
 ) A        
/*IF @@ERROR_COUNT > 0        
BEGIN        
 SELECT        
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'        
 RETURN        
END       */        
        
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO        
        
CREATE TABLE #HDFCRECO        
 (        
  BOOKDATE VARCHAR(10),        
  [DESCRIPTION] VARCHAR(50),        
  LEDGER_BALANCE VARCHAR(20),        
  CREDIT VARCHAR(20),        
  DEBIT VARCHAR(20),        
  VALUEDATE VARCHAR(10),        
  REFERENCE_NO VARCHAR(15),        
  BRANCH VARCHAR(25)        
 )        
        
        
CREATE TABLE [#BANKRECOSAVE_TEMP]        
 (        
  CLTCODE VARCHAR(10),        
  BOOKDATE DATETIME,        
  [DESCRIPTION] VARCHAR(50),        
  AMOUNT VARCHAR(20),        
  DRCR VARCHAR(1),        
  VALUEDATE DATETIME,        
  REFERENCENO VARCHAR(30),        
  STATUSID VARCHAR(15),        
  STATUSNAME VARCHAR(25),        
  LOGINNAME VARCHAR(25),        
  STATUS VARCHAR(9),        
  MICRNO INT,        
  DUMMY1 VARCHAR(15) ,        
  DUMMY2 VARCHAR(15),        
  AMOUNTLEDGR1 VARCHAR(20),        
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL        
 )        
ON [PRIMARY]        
        
CREATE TABLE [#BANKRECOSAVE]        
 (        
  CLTCODE VARCHAR(10),        
  BOOKDATE DATETIME,        
  [DESCRIPTION] VARCHAR(50),        
  AMOUNT MONEY,        
  DRCR VARCHAR(1),        
  VALUEDATE DATETIME,        
  REFERENCENO VARCHAR(30),        
  STATUSID VARCHAR(15),        
  STATUSNAME VARCHAR(25),        
  LOGINNAME VARCHAR(25),        
  CROSSREFERENCENO [INT],        
  STATUS VARCHAR(9),        
  MICRNO INT,        
  DUMMY1 VARCHAR(15) ,        
  DUMMY2 VARCHAR(15),        
  AMOUNTLEDGR1 MONEY        
 )        
ON [PRIMARY]        
        
        
SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ANAGRAM '" + @FILENAME + "',  '#HDFCRECO'"        
EXEC (@@SQL_QUERY)        
    
INSERT INTO #BANKRECOSAVE_TEMP        
SELECT        
 @BANKCODE,        
 BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),        
 [DESCRIPTION],        
 AMOUNT = (CASE WHEN ([DESCRIPTION] = 'Opening balance' OR [DESCRIPTION] = 'Closing balance') THEN LEDGER_BALANCE ELSE (CASE WHEN CREDIT <> '0' THEN CREDIT ELSE DEBIT END) END) ,        
 DRCR = (CASE WHEN CREDIT <> '0' THEN 'C' ELSE 'D' END),        
 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),        
 REFERENCE_NO,        
 @STATUSID,        
 @STATUSNAME,        
 @UNAME,        
 'UNMATCHED',        
 @@MICRNO,       
 '',        
 '',        
 ''        
FROM        
 #HDFCRECO     
  
    
INSERT INTO #BANKRECOSAVE        
SELECT        
 @BANKCODE,        
 BOOKDATE,      
 [DESCRIPTION],        
 CONVERT(MONEY,AMOUNT),        
 DRCR,        
 VALUEDATE,        
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),        
 @STATUSID,        
 @STATUSNAME,        
 @UNAME,        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),        
 'UNMATCHED',        
 @@MICRNO,        
 '',        
 '',        
 0        
FROM        
 #BANKRECOSAVE_TEMP    
WHERE   
 REFERENCENO NOT LIKE '%[A-Z]%'  
  
INSERT INTO #BANKRECOSAVE        
SELECT        
 @BANKCODE,        
 BOOKDATE,      
 [DESCRIPTION],        
 CONVERT(MONEY,AMOUNT),        
 DRCR,        
 VALUEDATE,        
 REFERENCENO,        
 @STATUSID,        
 @STATUSNAME,        
 @UNAME,        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),        
 'UNMATCHED',        
 @@MICRNO,        
 '',        
 '',        
 0        
FROM        
 #BANKRECOSAVE_TEMP    
WHERE   
 REFERENCENO LIKE '%[A-Z]%'  

INSERT INTO #BANKRECOSAVE        
SELECT        
 @BANKCODE,        
 BOOKDATE,      
 [DESCRIPTION],        
 CONVERT(MONEY,AMOUNT),        
 DRCR,        
 VALUEDATE,        
 ISNULL(REFERENCENO, 0),
 @STATUSID,        
 @STATUSNAME,        
 @UNAME,        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),        
 'UNMATCHED',        
 @@MICRNO,        
 '',        
 '',        
 0        
FROM        
 #BANKRECOSAVE_TEMP    
WHERE   
 REFERENCENO IS NULL

SELECT * FROM #BANKRECOSAVE WHERE AMOUNT = 911
RETURN

  
/*CREATE TABLE #BANKRECOSAVE_DELETE        
(        
 [DESCRIPTION] VARCHAR(250),        
 AMOUNT MONEY,        
 DRCR CHAR(1),        
 REFERENCENO VARCHAR(25),        
CROSSREFERENCENO INT        
) */       
    
DECLARE     
@@AMOUNTDIFF MONEY,    
@@STAMOUNTDIFF MONEY,    
@@BOOKDATE_MIN DATETIME,    
@@BOOKDATE_MAX DATETIME    
    
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE     
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE     
    
    
CREATE TABLE #RECODUPS     
(    
 BOOKDATE VARCHAR(11),     
 REFERENCENO VARCHAR(25),     
 AMOUNT MONEY,     
 DESCRIPTION VARCHAR(200),     
 STATUS VARCHAR(10),     
 CROSSREFERENCENO INT    
)    
    
SET @@EXIST_COUNT_BEFORE = 0    
SET @@EXIST_COUNT_AFTER = 0    
    
DECLARE     
@CLTCODE VARCHAR(10),     
@BOOKDATE DATETIME,     
@AMOUNT MONEY,     
@DRCR CHAR(1),     
@VALUEDATE DATETIME,     
@REFERENCENO VARCHAR(20),    
@DESCRIPTION VARCHAR(200)    
    
DECLARE CUR_CHECCK CURSOR FOR    
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0    
    
OPEN CUR_CHECCK    
    
FETCH NEXT FROM CUR_CHECCK    
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION    
    
WHILE @@FETCH_STATUS = 0    
BEGIN    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
 IF @PROCESS_STATUS = 0     
 BEGIN    
  SELECT @@ERROR_COUNT = 0    
      
  SELECT      
   @@EXIST_COUNT_BEFORE = COUNT(1)    
  FROM     
   BANKRECO    
  WHERE    
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)    
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')    
    
    
      
 /* IF @@ERROR_COUNT > 0    
   BEGIN    
    SELECT      
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS    
    FROM     
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,     
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B    
    WHERE    
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)    
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO    
      
    RETURN    
   END */    
 END    
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
    
     
         
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)    
 FROM #BANKRECOSAVE    
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0        
     
 DELETE BR FROM #BANKRECOSAVE BR    
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO    
     
     
 IF @PROCESS_STATUS = 0     
 BEGIN    
  SELECT     
   @@EXIST_COUNT_AFTER = COUNT(1)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR     
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0        
      
      
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER    
   BEGIN    
 INSERT INTO #RECODUPS    
    SELECT      
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO    
    FROM     
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR    
    WHERE    
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)    
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')    
      
   END     
  SET @@EXIST_COUNT_BEFORE = 0    
  SET @@EXIST_COUNT_AFTER = 0    
 END     
 FETCH NEXT FROM CUR_CHECCK    
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION    
END    
    
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0        
    
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS    
    
IF @@ERROR_COUNT > 0    
BEGIN    
 SELECT * FROM #RECODUPS    
 RETURN    
END    
    
    
    
    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
DELETE BR FROM      
 BANKRECO B, #BANKRECOSAVE BR      
WHERE       
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))      
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')    
    
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL    
    
IF @@ERROR_COUNT = 0    
BEGIN     
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'     
 RETURN    
END    
      
SELECT     
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)     
FROM    
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,    
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1    
    
    
IF @PROCESS_STATUS = 1    
BEGIN    
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))    
 FROM     
 (    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   BANKRECO    
  WHERE     
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE    
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)    
  UNION ALL    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   VALUEDATE IS NOT NULL    
      
      
 )B    
END     
ELSE    
BEGIN     
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))    
 FROM     
 (    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   BANKRECO    
  WHERE     
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE    
  UNION ALL    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   VALUEDATE IS NOT NULL    
      
      
 )B    
END    
    
    
IF @@AMOUNTDIFF <> @@STAMOUNTDIFF    
BEGIN    
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'    
 RETURN    
END    
    
 DELETE FROM     
  #BANKRECOSAVE    
 WHERE     
  VALUEDATE IS NULL    
    
    
    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'        
        
IF @@TABLE_EXIST = ''        
BEGIN        
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS        
        
IF @@RECORD_COUNT = 0        
BEGIN        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS        
        
IF @@RECO_STATUS = 'N'        
BEGIN        
 BEGIN TRAN        
 UPDATE RECOPROCESS SET INPROCESS = 'Y'        
END        
ELSE        
BEGIN        
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'        
 RETURN        
END        
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'        
IF @@TABLE_EXIST <> ''        
BEGIN        
 DROP TABLE LEDGER_UPDATES        
END        
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'        
IF @@TABLE_EXIST <> ''        
BEGIN        
 DROP TABLE BANKRECOCOMP        
END        
        
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)        
        
INSERT        
INTO        
 V2_UPLOADED_FILES        
SELECT        
 @FILENAME,        
 @FILENAME,        
 COUNT(1),        
 'B',        
 GETDATE(),        
 @UNAME,        
 'HDFC_RECO UPLOAD'        
        
        
UPDATE        
 #BANKRECOSAVE        
SET        
 STATUS ='MATCHED'        
FROM        
 LEDGER1        
WHERE        
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)        
 AND CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      

  
   
   
    
    
    
    
    
    
    
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND   REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
INSERT INTO        
 LEDGER_UPDATES        
SELECT       
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE        
FROM        
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' )        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE        
 AND LEDGER1.VNO = LEDGER.VNO        
 AND LEDGER1.VTYP = LEDGER.VTYP        
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND DDNO =  REFERENCENO        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)        
 AND   REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
UPDATE        
 LEDGER1        
SET        
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO        
FROM        
 #BANKRECOSAVE, LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND DDNO =  REFERENCENO        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      

  
  
    
    
    
    
    
    
    
    
    
 AND REFERENCENO  <> '0'        
 AND LEDGER.VNO = LEDGER1.VNO        
 AND LEDGER.VTYP = LEDGER1.VTYP        
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
SELECT        
 SUM(RELAMT) AS AMOUNT,        
 SLIPNO AS SLIPNO,        
 UPPER(DRCR) AS DRCR,        
 MICRNO        
INTO        
 BANKRECOCOMP        
FROM        
 LEDGER1        
WHERE        
 MICRNO = @@MICRNO        
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )        
 AND SLIPNO <>''        
GROUP BY        
 SLIPNO,        
 DRCR,        
 MICRNO        
        
        
UPDATE        
 #BANKRECOSAVE        
SET        
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'        
FROM        
 BANKRECOCOMP        
WHERE        
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)        
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)        
  AND #BANKRECOSAVE.MICRNO = @@MICRNO        
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT        
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO        
  AND REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
INSERT INTO LEDGER_UPDATES        
SELECT        
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE        
FROM        
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE        
 AND LEDGER1.VNO = LEDGER.VNO        
 AND LEDGER1.VTYP = LEDGER.VTYP        
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE     
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND #BANKRECOSAVE.REFERENCENO  <> '0'        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
UPDATE        
 LEDGER1        
SET        
 RELDT = VALUEDATE ,        
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO        
FROM        
 #BANKRECOSAVE, LEDGER  (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND #BANKRECOSAVE.REFERENCENO  <> '0'        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)        
 AND LEDGER.VNO = LEDGER1.VNO        
 AND LEDGER.VTYP = LEDGER1.VTYP        
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
UPDATE        
 L        
SET        
 EDT = VALUEDATE        
FROM        
 LEDGER L, LEDGER_UPDATES LU        
WHERE        
 LU.VNO=L.VNO        
 AND LU.VTYP=L.VTYP        
 AND LU.BOOKTYPE=L.BOOKTYPE        
 AND EDT LIKE 'DEC 31 2049%'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'        
 ROLLBACK TRAN        
 RETURN        
END        
        
UPDATE        
 L        
SET        
 EDT = VDT        
FROM        
 LEDGER L, LEDGER_UPDATES LU        
WHERE        
 LU.VNO=L.VNO        
 AND LU.VTYP=L.VTYP        
 AND LU.BOOKTYPE=L.BOOKTYPE        
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
DROP TABLE BANKRECOCOMP        
DROP TABLE LEDGER_UPDATES        
    
IF @PROCESS_STATUS = 1    
BEGIN    
 DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)    
END    
    
INSERT INTO     
BANKRECO_MISMATCH_LOG    
SELECT        
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,        
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0', GETDATE()        
FROM        
 #BANKRECOSAVE B     
WHERE    
 STATUS ='MATCHED'     
        
INSERT INTO        
 BANKRECO        
SELECT        
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,        
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'        
FROM        
 #BANKRECOSAVE B        
        
        
UPDATE RECOPROCESS SET INPROCESS = 'N'        
        
COMMIT TRAN        
        
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_COMBINED
-- --------------------------------------------------
--EXEC AUTORECOUPDATE_HDFC_COMBINED 'D:\BackOffice\Reco\HDFCRECO\Merged_c067_a001.txt', 'ashoks','','broker','broker','HDFCRECO','COMBINED','sa','ms'
CREATE PROC [dbo].[AUTORECOUPDATE_HDFC_COMBINED]  
 @FILENAME VARCHAR(100),        
 @UNAME VARCHAR(100),        
-- @BANKCODE VARCHAR(10),        
 @STATUSID VARCHAR(10),        
 @STATUSNAME VARCHAR(100),  
 @BANK_TYPE VARCHAR(10),  
 @STAT_TYPE VARCHAR(10),  
 @LOGIN VARCHAR(10),  
 @PWD VARCHAR(15),  
 @PROCESS_STATUS BIT = 0    
    
        
AS        
        
/*      
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'        
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'        
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'    
SELECT TOP 1 * FROM BANKRECO    
*/      
DECLARE        
 @@SQL_QUERY AS VARCHAR(1000),        
 @@CROSSREFERENCENO INT,        
 @@TABLE_EXIST VARCHAR(20),        
 @@RECORD_COUNT TINYINT,        
 @@RECO_STATUS CHAR(1),        
 @@FILE_EXIST INT,        
 @@CLTCODE_EXIST INT        
-- @@MICRNO VARCHAR(20)        
        
SET NOCOUNT ON        
        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/        
DECLARE        
 @@ERROR_COUNT SMALLINT,    
 @@EXIST_COUNT_BEFORE SMALLINT,    
 @@EXIST_COUNT_AFTER SMALLINT    
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT        
   U_FILENAME        
  FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FILENAME        
   AND U_MODULE = 'HDFC_RECO UPLOAD'        
 ) A        
/*IF @@ERROR_COUNT > 0        
BEGIN        
 SELECT        
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'        
 RETURN        
END       */        
        
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO        
  
CREATE TABLE #HDFCRECO    
(  
 BOOKDATE VARCHAR(11), 
 VALUEDATE VARCHAR(11), 
 AMOUNT VARCHAR(20),
 DRCR CHAR(1),
 [DESCRIPTION] VARCHAR(100),
 REFERENCE_NO VARCHAR(20), 
 TRANSACTION_BRANCH VARCHAR(30),
 RUNNING_BAL VARCHAR(20),
 BANK_CODE VARCHAR(10)
)  
  

CREATE TABLE [#BANKRECOSAVE_TEMP]        
 (        
  CLTCODE VARCHAR(10),        
  BOOKDATE DATETIME,        
  [DESCRIPTION] VARCHAR(50),        
  AMOUNT VARCHAR(20),        
  DRCR VARCHAR(1),        
  VALUEDATE DATETIME,        
  REFERENCENO VARCHAR(30),        
  STATUSID VARCHAR(15),        
  STATUSNAME VARCHAR(25),        
  LOGINNAME VARCHAR(25),        
  STATUS VARCHAR(9),        
  MICRNO INT,        
  DUMMY1 VARCHAR(15) ,        
  DUMMY2 VARCHAR(15),        
  AMOUNTLEDGR1 VARCHAR(20),        
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL        
 )        
ON [PRIMARY]        
        
CREATE TABLE [#BANKRECOSAVE]        
 (        
  CLTCODE VARCHAR(10),        
  BOOKDATE DATETIME,        
  [DESCRIPTION] VARCHAR(50),        
  AMOUNT MONEY,        
  DRCR VARCHAR(1),        
  VALUEDATE DATETIME,        
  REFERENCENO VARCHAR(30),        
  STATUSID VARCHAR(15),        
  STATUSNAME VARCHAR(25),        
  LOGINNAME VARCHAR(25),        
  CROSSREFERENCENO [INT],        
  STATUS VARCHAR(9),        
  MICRNO INT,        
  DUMMY1 VARCHAR(15) ,        
  DUMMY2 VARCHAR(15),        
  AMOUNTLEDGR1 MONEY        
 )        
ON [PRIMARY]       
  
/*CREATE TABLE #TESTIMPORT                  
(                  
 OneRow Varchar(2000),                
 SNO INT IDENTITY(1,1)                
) */    
  
 SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_COMBINED '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"  
  

EXEC (@@SQL_QUERY)   
  

SELECT * INTO HDFCRECO FROM #HDFCRECO  

  
 INSERT INTO #BANKRECOSAVE_TEMP        
 SELECT        
  BANK_CODE,        
  BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),        
  [DESCRIPTION],        
  AMOUNT,        
  DRCR,        
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),        
  REFERENCE_NO,        
  @STATUSID,        
  @STATUSNAME,        
  @UNAME,        
  'UNMATCHED',        
  '',        
  '',        
  '',        
  ''        
 FROM        
  HDFCRECO    

--return
  
DROP TABLE HDFCRECO  

INSERT INTO #BANKRECOSAVE        
SELECT        
 CLTCODE,        
 BOOKDATE,      
 [DESCRIPTION],        
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,        
 DRCR,        
 VALUEDATE,        
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),        
 @STATUSID,        
 @STATUSNAME,        
 @UNAME,        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),        
 'UNMATCHED',        
 '',        
 '',        
 '',        
 0        
FROM        
 #BANKRECOSAVE_TEMP        
WHERE   
 REFERENCENO NOT LIKE '%[A-Z]%'  
  
INSERT INTO #BANKRECOSAVE        
SELECT        
 CLTCODE,        
 BOOKDATE,      
 [DESCRIPTION],        
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,        
 DRCR,        
 VALUEDATE,        
 REFERENCENO,        
 @STATUSID,        
 @STATUSNAME,        
 @UNAME,        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),        
 'UNMATCHED',        
 '',        
 '',        
 '',        
 0        
FROM        
 #BANKRECOSAVE_TEMP        
WHERE   
 REFERENCENO LIKE '%[A-Z]%'  
  
INSERT INTO #BANKRECOSAVE        
SELECT        
 CLTCODE,        
 BOOKDATE,      
 [DESCRIPTION],       
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,        
 DRCR,        
 VALUEDATE,        
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),        
 @STATUSID,        
 @STATUSNAME,        
 @UNAME,        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),        
 'UNMATCHED',        
 '',        
 '',        
 '',        
 0        
FROM        
 #BANKRECOSAVE_TEMP        
WHERE   
 REFERENCENO IS NULL  



Update B 
set B.MICRNO = A.MICRNO
From #BANKRECOSAVE B Join ACMAST A ON (B.cltcode =  A.cltcode) AND A.ACCAT = 2  

---------------------------------------------------------------------------------------------
--SELECT * FROM #BANKRECOSAVE

  


/*CREATE TABLE #BANKRECOSAVE_DELETE        
(        
 [DESCRIPTION] VARCHAR(250),        
 AMOUNT MONEY,        
 DRCR CHAR(1),        
 REFERENCENO VARCHAR(25),        
CROSSREFERENCENO INT        
) */       
    
DECLARE     
@@AMOUNTDIFF MONEY,    
@@STAMOUNTDIFF MONEY,    
@@BOOKDATE_MIN DATETIME,    
@@BOOKDATE_MAX DATETIME    
    
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE     
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE     
    
    
CREATE TABLE #RECODUPS     
(    
 BOOKDATE VARCHAR(11),     
 REFERENCENO VARCHAR(25),     
 AMOUNT MONEY,     
 DESCRIPTION VARCHAR(200),     
 STATUS VARCHAR(10),     
 CROSSREFERENCENO INT    
)    
    
SET @@EXIST_COUNT_BEFORE = 0    
SET @@EXIST_COUNT_AFTER = 0    
    
DECLARE     
@CLTCODE VARCHAR(10),     
@BOOKDATE DATETIME,     
@AMOUNT MONEY,     
@DRCR CHAR(1),     
@VALUEDATE DATETIME,     
@REFERENCENO VARCHAR(20),    
@DESCRIPTION VARCHAR(200)    
    
DECLARE CUR_CHECCK CURSOR FOR    
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0    
  
OPEN CUR_CHECCK    
    
FETCH NEXT FROM CUR_CHECCK    
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION    
  ---------------------------------------------------------  
WHILE @@FETCH_STATUS = 0    
BEGIN    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
 IF @PROCESS_STATUS = 0     
 BEGIN    
  SELECT @@ERROR_COUNT = 0    
      
  SELECT      
   @@EXIST_COUNT_BEFORE = COUNT(1)    
  FROM     
   BANKRECO    
  WHERE    
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)    
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')    
    
    
      
 /* IF @@ERROR_COUNT > 0    
   BEGIN    
    SELECT      
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS    
    FROM     
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,     
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B    
    WHERE    
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)    
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO    
      
    RETURN    
   END */    
 END    
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
    
     
         
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)    
 FROM #BANKRECOSAVE    
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0        
     
 DELETE BR FROM #BANKRECOSAVE BR    
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO    
     
     
 IF @PROCESS_STATUS = 0     
 BEGIN    
  SELECT     
   @@EXIST_COUNT_AFTER = COUNT(1)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR     
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0        
      
      
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER    
   BEGIN    
    INSERT INTO #RECODUPS    
    SELECT      
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO    
    FROM     
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59'  
	 --AND CLTCODE = @BANKCODE
     ) BR    
    WHERE    
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)    
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')    
      
   END     
  SET @@EXIST_COUNT_BEFORE = 0    
  SET @@EXIST_COUNT_AFTER = 0    
 END     
 FETCH NEXT FROM CUR_CHECCK    
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION    
END    

DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0        
    
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS    
    
IF @@ERROR_COUNT > 0    
BEGIN    
 SELECT * FROM #RECODUPS    
    

 RETURN    
END    

    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
DELETE BR FROM      
 BANKRECO B, #BANKRECOSAVE BR      
WHERE       
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))      
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')    

    
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL    

  
    
IF @@ERROR_COUNT = 0    
BEGIN     
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'     
 RETURN    
END    

      
/*SELECT     
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)     
 FROM    
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,    
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1    
    
    
IF @PROCESS_STATUS = 1    
BEGIN    
SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))    
 FROM     
 (    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   BANKRECO    
  WHERE     
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE    
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)    
  UNION ALL    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   VALUEDATE IS NOT NULL    
      
      
 )B    
END     
ELSE    
BEGIN     
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))    
 FROM     
(    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   BANKRECO    
  WHERE     
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE    
  UNION ALL    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   VALUEDATE IS NOT NULL    
      
      
 )B    
END    
    
    
IF @@AMOUNTDIFF <> @@STAMOUNTDIFF    
BEGIN    
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'    
 RETURN    
END  */  
    
 DELETE FROM     
  #BANKRECOSAVE    
 WHERE     
  VALUEDATE IS NULL    


    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'        
        
IF @@TABLE_EXIST = ''        
BEGIN        
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS        
        
IF @@RECORD_COUNT = 0        
BEGIN        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS        
PRINT "test " + @@RECO_STATUS    
IF @@RECO_STATUS = 'N'        
BEGIN        
 BEGIN TRAN        
 UPDATE RECOPROCESS SET INPROCESS = 'Y'        
END        
ELSE        
BEGIN        
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'        
 RETURN        
END        
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES1'        
IF @@TABLE_EXIST <> ''        
BEGIN        
 DROP TABLE LEDGER_UPDATES1        
END        
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'        
IF @@TABLE_EXIST <> ''        
BEGIN        
 DROP TABLE BANKRECOCOMP        
END        

INSERT        
INTO        
 V2_UPLOADED_FILES        
SELECT        
 @FILENAME,        
 @FILENAME,        
 COUNT(1),        
 'B',        
 GETDATE(),        
 @UNAME,        
 'HDFC_RECO UPLOAD'



--DROP TABLE LEDGER_UPDATES          
CREATE TABLE LEDGER_UPDATES1 (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)        
------------------------------------------------
DECLARE   
 @bank_code varchar(10),
 @micr_no VARCHAR(20)

Declare cur_bank cursor for
   select distinct CLTCODE,micrno from #BANKRECOSAVE
	open cur_bank

	fetch next from  cur_bank
	into @bank_code, @micr_no

	while @@fetch_status = 0
	Begin



-----------------------------------------------------------------------------------    
        
        
        
UPDATE        
 #BANKRECOSAVE        
SET        
 STATUS ='MATCHED'        
FROM        
 LEDGER1        
WHERE        
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)        
 AND CLTCODE = @bank_code       
 AND #BANKRECOSAVE.MICRNO = @micr_no        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @bank_code AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109) >= CONVERT(VARCHAR(11), VDT, 109))       
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND   REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
----------- CODE TO BE ADD HERE ----------------------
/*Declare cur_bank cursor for
   select distinct CLTCODE,micrno from #BANKRECOSAVE
	open cur_bank

	fetch next from  cur_bank
	into @bank_code, @micr_no

	while @@fetch_status = 0
	Begin
*/
--------------------------------------------------------
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
INSERT INTO        
 LEDGER_UPDATES1        
SELECT       
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE        
FROM        
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE        
 AND LEDGER1.VNO = LEDGER.VNO        
 AND LEDGER1.VTYP = LEDGER.VTYP        
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND DDNO =  REFERENCENO        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @bank_code       
 AND #BANKRECOSAVE.MICRNO = @micr_no        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @bank_code AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)        
 AND CONVERT(VARCHAR(11), #BANKRECOSAVE.AMOUNT, 109) >= CONVERT(VARCHAR(11), LEDGER.VDT, 109)  
 AND   REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
UPDATE        
 LEDGER1        
SET        
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO        
FROM        
 #BANKRECOSAVE, LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND DDNO =  REFERENCENO        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @bank_code       
 AND #BANKRECOSAVE.MICRNO = @micr_no        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @bank_code AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
  
  
 AND REFERENCENO  <> '0'        
 AND LEDGER.VNO = LEDGER1.VNO        
 AND LEDGER.VTYP = LEDGER1.VTYP      
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE        
 AND CONVERT(VARCHAR(11), LEDGER.VDT, 109) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109)  
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
SELECT        
 SUM(RELAMT) AS AMOUNT,        
 SLIPNO AS SLIPNO,        
 UPPER(DRCR) AS DRCR,        
 MICRNO        
INTO        
 BANKRECOCOMP        
FROM        
 LEDGER1        
WHERE        
 MICRNO = @micr_no
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )        
 AND SLIPNO <>''        
GROUP BY        
 SLIPNO,        
 DRCR,        
 MICRNO        
        
        
UPDATE        
 #BANKRECOSAVE        
SET        
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'        
FROM        
 BANKRECOCOMP        
WHERE        
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)        
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)        
  AND #BANKRECOSAVE.MICRNO = @micr_no        
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT        
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO        
  AND REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
INSERT INTO LEDGER_UPDATES1        
SELECT        
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE        
FROM        
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE        
 AND LEDGER1.VNO = LEDGER.VNO        
 AND LEDGER1.VTYP = LEDGER.VTYP        
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE        
 AND #BANKRECOSAVE.CLTCODE = @bank_code        
 AND #BANKRECOSAVE.MICRNO = @micr_no        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.REFERENCENO  <> '0'        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @micr_no)        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
UPDATE        
 LEDGER1        
SET        
 RELDT = VALUEDATE ,        
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO        
FROM        
 #BANKRECOSAVE, LEDGER  (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @bank_code        
 AND #BANKRECOSAVE.MICRNO = @micr_no    
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.REFERENCENO  <> '0'        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @micr_no)        
 AND LEDGER.VNO = LEDGER1.VNO        
 AND LEDGER.VTYP = LEDGER1.VTYP        
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
UPDATE        
 L        
SET        
 EDT = VALUEDATE        
FROM        
 LEDGER L, LEDGER_UPDATES1 LU        
WHERE        
 LU.VNO=L.VNO        
 AND LU.VTYP=L.VTYP        
 AND LU.BOOKTYPE=L.BOOKTYPE        
 AND EDT LIKE 'DEC 31 2049%'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'        
 ROLLBACK TRAN        
 RETURN        
END        
        
UPDATE        
 L        
SET        
 EDT = VDT        
FROM        
 LEDGER L, LEDGER_UPDATES1 LU        
WHERE        
 LU.VNO=L.VNO        
 AND LU.VTYP=L.VTYP        
 AND LU.BOOKTYPE=L.BOOKTYPE        
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
IF @PROCESS_STATUS = 1    
BEGIN    
 DELETE FROM BANKRECO WHERE CLTCODE = @bank_code AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)    
END    
  
-----------------------------------------------------------------------------------------------
INSERT INTO        
BANKRECO    
(Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,Status,Micrno,Dummy1,Dummy2)      
SELECT        
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,        
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@micr_no,'0','0'        
FROM        
 #BANKRECOSAVE B where cltcode = @bank_code and  Micrno = @micr_no      

       
  
INSERT INTO        
 BANKRECO_LOG        
SELECT        
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,        
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@micr_no,'0','0', 0, 'AUTO', GETDATE(), 'MATCHED'   
FROM        
 #BANKRECOSAVE B      
WHERE  
 B.STATUS = 'MATCHED'  
  
  
  
INSERT INTO LEDGER1_BANKRECO_LOG  
SELECT L1.*, 'AUTO', GETDATE(), 'MATCHED'   
FROM LEDGER1 L1, LEDGER_UPDATES1 LU  
WHERE L1.VNO = LU.VNO AND L1.VTYP = LU.VTYP AND L1.BOOKTYPE = LU.BOOKTYPE  
  
       
  
       
DROP TABLE BANKRECOCOMP
-----------------------
fetch next from  cur_bank
into @bank_code, @micr_no
END


close cur_bank
deallocate cur_bank


UPDATE RECOPROCESS SET INPROCESS = 'N' 
--DROP TABLE BANKRECOCOMP
DROP TABLE LEDGER_UPDATES1      
      
COMMIT TRAN        
--close cur_bank     
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_COMBINED_LSE
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_HDFC_COMBINED_LSE]    
 @FILENAME VARCHAR(100),          
 @UNAME VARCHAR(100),          
-- @BANKCODE VARCHAR(10),          
 @STATUSID VARCHAR(10),          
 @STATUSNAME VARCHAR(100),    
 @BANK_TYPE VARCHAR(10),    
 @STAT_TYPE VARCHAR(10),    
 @LOGIN VARCHAR(10),    
 @PWD VARCHAR(15),    
 @PROCESS_STATUS BIT = 0      
      
          
AS          
          
/*        
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'          
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'          
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'      
SELECT TOP 1 * FROM BANKRECO      
*/        
DECLARE          
 @@SQL_QUERY AS VARCHAR(1000),          
 @@CROSSREFERENCENO INT,          
 @@TABLE_EXIST VARCHAR(20),          
 @@RECORD_COUNT TINYINT,          
 @@RECO_STATUS CHAR(1),          
 @@FILE_EXIST INT,          
 @@CLTCODE_EXIST INT          
-- @@MICRNO VARCHAR(20)          
          
SET NOCOUNT ON          
          
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/          
DECLARE          
 @@ERROR_COUNT SMALLINT,      
 @@EXIST_COUNT_BEFORE SMALLINT,      
 @@EXIST_COUNT_AFTER SMALLINT      
SELECT          
 @@ERROR_COUNT = COUNT(1)          
FROM          
 (          
  SELECT          
   U_FILENAME          
  FROM          
   V2_UPLOADED_FILES          
  WHERE          
   U_FILENAME = @FILENAME          
   AND U_MODULE = 'HDFC_RECO UPLOAD'          
 ) A          
/*IF @@ERROR_COUNT > 0          
BEGIN          
 SELECT          
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'          
 RETURN          
END       */          
          
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO          
    
CREATE TABLE #HDFCRECO      
(    
 BOOKDATE VARCHAR(11),   
 [DESCRIPTION] VARCHAR(100),  
 DRCR CHAR(1),  
 AMOUNT VARCHAR(20),  
 VALUEDATE VARCHAR(11),   
 REFERENCE_NO VARCHAR(20),   
 TRANSACTION_BRANCH VARCHAR(30),  
 BANK_CODE VARCHAR(20)  
)    
    
  
CREATE TABLE [#BANKRECOSAVE_TEMP]          
 (          
  CLTCODE VARCHAR(10),          
  BOOKDATE DATETIME,          
  [DESCRIPTION] VARCHAR(50),          
  AMOUNT VARCHAR(20),          
  DRCR VARCHAR(1),          
  VALUEDATE DATETIME,          
  REFERENCENO VARCHAR(30),          
  STATUSID VARCHAR(15),          
  STATUSNAME VARCHAR(25),          
  LOGINNAME VARCHAR(25),          
  STATUS VARCHAR(9),          
  MICRNO INT,          
  DUMMY1 VARCHAR(15) ,          
  DUMMY2 VARCHAR(15),          
  AMOUNTLEDGR1 VARCHAR(20),          
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL          
 )          
ON [PRIMARY]          
          
CREATE TABLE [#BANKRECOSAVE]          
 (          
  CLTCODE VARCHAR(10),          
  BOOKDATE DATETIME,          
  [DESCRIPTION] VARCHAR(50),          
  AMOUNT MONEY,          
  DRCR VARCHAR(1),          
  VALUEDATE DATETIME,          
  REFERENCENO VARCHAR(30),          
  STATUSID VARCHAR(15),          
  STATUSNAME VARCHAR(25),          
  LOGINNAME VARCHAR(25),          
  CROSSREFERENCENO [INT],          
  STATUS VARCHAR(9),          
  MICRNO INT,          
  DUMMY1 VARCHAR(15) ,          
  DUMMY2 VARCHAR(15),          
  AMOUNTLEDGR1 MONEY          
 )          
ON [PRIMARY]         
    
CREATE TABLE #TESTIMPORT                    
(                    
 OneRow Varchar(2000),                  
 SNO INT IDENTITY(1,1)                  
)       
    
 SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_COMBINED '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"    
    
  
EXEC (@@SQL_QUERY)     
    
  
SELECT * INTO HDFCRECO FROM #HDFCRECO 


UPDATE H SET H.BANK_CODE = MP.BANKCODE
FROM HDFCRECO H, MPI_PAYIN MP WHERE H.BANK_CODE = MP.BANKAC



    
 INSERT INTO #BANKRECOSAVE_TEMP          
 SELECT          
  BANK_CODE,          
  BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),          
  [DESCRIPTION],          
  AMOUNT,          
  DRCR,          
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),          
  REFERENCE_NO,          
  @STATUSID,          
  @STATUSNAME,          
  @UNAME,          
  'UNMATCHED',          
  '',          
  '',          
  '',          
  ''          
 FROM          
  HDFCRECO      
  
    
SELECT * FROM HDFCRECO
DROP TABLE HDFCRECO   
RETURN 

  
INSERT INTO #BANKRECOSAVE          
SELECT          
 CLTCODE,          
 BOOKDATE,        
 [DESCRIPTION],          
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,          
 DRCR,          
 VALUEDATE,          
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),          
 @STATUSID,          
 @STATUSNAME,          
 @UNAME,          
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),          
 'UNMATCHED',          
 '',          
 '',          
 '',          
 0          
FROM          
 #BANKRECOSAVE_TEMP          
WHERE     
 REFERENCENO NOT LIKE '%[A-Z]%'    
    
INSERT INTO #BANKRECOSAVE          
SELECT          
 CLTCODE,          
 BOOKDATE,        
 [DESCRIPTION],          
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,          
 DRCR,          
 VALUEDATE,          
 REFERENCENO,          
 @STATUSID,          
 @STATUSNAME,          
 @UNAME,          
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),          
 'UNMATCHED',          
 '',          
 '',          
 '',          
 0          
FROM          
 #BANKRECOSAVE_TEMP          
WHERE     
 REFERENCENO LIKE '%[A-Z]%'    
    
INSERT INTO #BANKRECOSAVE          
SELECT          
 CLTCODE,          
 BOOKDATE,        
 [DESCRIPTION],         
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,          
 DRCR,          
 VALUEDATE,          
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),          
 @STATUSID,          
 @STATUSNAME,          
 @UNAME,          
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),          
 'UNMATCHED',          
 '',          
 '',          
 '',          
 0          
FROM          
 #BANKRECOSAVE_TEMP          
WHERE     
 REFERENCENO IS NULL    
  
  
  
Update B   
set B.MICRNO = A.MICRNO  
From #BANKRECOSAVE B Join ACMAST A ON (B.cltcode =  A.cltcode) AND A.ACCAT = 2    
  
---------------------------------------------------------------------------------------------  
--SELECT * FROM #BANKRECOSAVE  
  
    
  
  
/*CREATE TABLE #BANKRECOSAVE_DELETE          
(          
 [DESCRIPTION] VARCHAR(250),          
 AMOUNT MONEY,          
 DRCR CHAR(1),          
 REFERENCENO VARCHAR(25),          
CROSSREFERENCENO INT          
) */         
      
DECLARE       
@@AMOUNTDIFF MONEY,      
@@STAMOUNTDIFF MONEY,      
@@BOOKDATE_MIN DATETIME,      
@@BOOKDATE_MAX DATETIME      
      
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE       
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE       
      
      
CREATE TABLE #RECODUPS       
(      
 BOOKDATE VARCHAR(11),       
 REFERENCENO VARCHAR(25),       
 AMOUNT MONEY,       
 DESCRIPTION VARCHAR(200),       
 STATUS VARCHAR(10),       
 CROSSREFERENCENO INT      
)      
      
SET @@EXIST_COUNT_BEFORE = 0      
SET @@EXIST_COUNT_AFTER = 0      
      
DECLARE       
@CLTCODE VARCHAR(10),       
@BOOKDATE DATETIME,       
@AMOUNT MONEY,       
@DRCR CHAR(1),       
@VALUEDATE DATETIME,       
@REFERENCENO VARCHAR(20),      
@DESCRIPTION VARCHAR(200)      
      
DECLARE CUR_CHECCK CURSOR FOR      
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0      
    
OPEN CUR_CHECCK      
      
FETCH NEXT FROM CUR_CHECCK      
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION      
  ---------------------------------------------------------    
WHILE @@FETCH_STATUS = 0      
BEGIN      
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
 IF @PROCESS_STATUS = 0       
 BEGIN      
  SELECT @@ERROR_COUNT = 0      
        
  SELECT        
   @@EXIST_COUNT_BEFORE = COUNT(1)      
  FROM       
   BANKRECO      
  WHERE      
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)      
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')      
      
      
        
 /* IF @@ERROR_COUNT > 0      
   BEGIN      
    SELECT        
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS      
    FROM       
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,       
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B      
    WHERE      
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)      
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO      
        
    RETURN      
   END */      
 END      
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
      
       
           
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)      
 FROM #BANKRECOSAVE      
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0          
       
 DELETE BR FROM #BANKRECOSAVE BR      
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO      
       
       
 IF @PROCESS_STATUS = 0       
 BEGIN      
  SELECT       
   @@EXIST_COUNT_AFTER = COUNT(1)      
  FROM       
   #BANKRECOSAVE      
  WHERE       
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR       
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0          
        
        
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER      
   BEGIN      
    INSERT INTO #RECODUPS      
    SELECT        
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO      
    FROM       
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59'    
  --AND CLTCODE = @BANKCODE  
     ) BR      
    WHERE      
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)      
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')      
        
   END       
  SET @@EXIST_COUNT_BEFORE = 0      
  SET @@EXIST_COUNT_AFTER = 0      
 END       
 FETCH NEXT FROM CUR_CHECCK      
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION      
END      
  
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0          
      
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS      
      
IF @@ERROR_COUNT > 0      
BEGIN      
 SELECT * FROM #RECODUPS      
      
  
 RETURN      
END      
  
      
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
DELETE BR FROM        
 BANKRECO B, #BANKRECOSAVE BR        
WHERE         
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))        
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')      
  
      
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL      
  
    
      
IF @@ERROR_COUNT = 0      
BEGIN       
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'       
 RETURN      
END      
  
        
/*SELECT       
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)       
 FROM      
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,      
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1      
      
      
IF @PROCESS_STATUS = 1      
BEGIN      
SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))      
 FROM       
 (      
  SELECT       
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)      
  FROM       
   BANKRECO      
  WHERE       
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE      
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)      
  UNION ALL      
  SELECT       
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)      
  FROM       
   #BANKRECOSAVE      
  WHERE       
   VALUEDATE IS NOT NULL      
        
        
 )B      
END       
ELSE      
BEGIN       
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))      
 FROM       
(      
  SELECT       
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)      
  FROM       
   BANKRECO      
  WHERE       
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE      
  UNION ALL      
  SELECT       
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)      
  FROM       
   #BANKRECOSAVE      
  WHERE       
   VALUEDATE IS NOT NULL      
        
        
 )B      
END      
      
      
IF @@AMOUNTDIFF <> @@STAMOUNTDIFF      
BEGIN      
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'      
 RETURN      
END  */    
      
 DELETE FROM       
  #BANKRECOSAVE      
 WHERE       
  VALUEDATE IS NULL      
  
  
      
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
          
SET @@TABLE_EXIST = ''          
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'          
          
IF @@TABLE_EXIST = ''          
BEGIN          
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))          
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')          
END          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS          
          
IF @@RECORD_COUNT = 0          
BEGIN          
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')          
END          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS          
PRINT "test " + @@RECO_STATUS      
IF @@RECO_STATUS = 'N'          
BEGIN          
 BEGIN TRAN          
 UPDATE RECOPROCESS SET INPROCESS = 'Y'          
END          
ELSE          
BEGIN          
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'          
 RETURN          
END          
          
SET @@TABLE_EXIST = ''          
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES1'          
IF @@TABLE_EXIST <> ''          
BEGIN          
 DROP TABLE LEDGER_UPDATES1          
END          
          
SET @@TABLE_EXIST = ''          
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'          
IF @@TABLE_EXIST <> ''          
BEGIN          
 DROP TABLE BANKRECOCOMP          
END          
  
INSERT          
INTO          
 V2_UPLOADED_FILES          
SELECT          
 @FILENAME,          
 @FILENAME,          
 COUNT(1),          
 'B',          
 GETDATE(),          
 @UNAME,          
 'HDFC_RECO UPLOAD'  
  
  
  
--DROP TABLE LEDGER_UPDATES            
CREATE TABLE LEDGER_UPDATES1 (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)          
------------------------------------------------  
DECLARE     
 @bank_code varchar(10),  
 @micr_no VARCHAR(20)  
  
Declare cur_bank cursor for  
   select distinct CLTCODE,micrno from #BANKRECOSAVE  
 open cur_bank  
  
 fetch next from  cur_bank  
 into @bank_code, @micr_no  
  
 while @@fetch_status = 0  
 Begin  
  
  
  
-----------------------------------------------------------------------------------      
     
          
          
UPDATE          
 #BANKRECOSAVE          
SET          
 STATUS ='MATCHED'          
FROM          
 LEDGER1          
WHERE          
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )          
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)          
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)          
 AND CLTCODE = @bank_code         
 AND #BANKRECOSAVE.MICRNO = @micr_no          
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @bank_code AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109) >= CONVERT(VARCHAR(11), VDT, 109))         
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)    
 AND   REFERENCENO  <> '0'          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'          
 ROLLBACK TRAN          
 RETURN          
END          
          
----------- CODE TO BE ADD HERE ----------------------  
/*Declare cur_bank cursor for  
   select distinct CLTCODE,micrno from #BANKRECOSAVE  
 open cur_bank  
  
 fetch next from  cur_bank  
 into @bank_code, @micr_no  
  
 while @@fetch_status = 0  
 Begin  
*/  
--------------------------------------------------------  
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO          
 LEDGER_UPDATES1          
SELECT         
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE          
FROM          
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)          
WHERE          
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')          
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE          
 AND LEDGER1.VNO = LEDGER.VNO          
 AND LEDGER1.VTYP = LEDGER.VTYP          
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE          
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)          
 AND DDNO =  REFERENCENO          
 AND RELDT = ''          
 AND #BANKRECOSAVE.CLTCODE = @bank_code         
 AND #BANKRECOSAVE.MICRNO = @micr_no          
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)    
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @bank_code AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)          
 AND CONVERT(VARCHAR(11), #BANKRECOSAVE.AMOUNT, 109) >= CONVERT(VARCHAR(11), LEDGER.VDT, 109)    
 AND   REFERENCENO  <> '0'          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'          
 ROLLBACK TRAN          
 RETURN          
END          
          
          
UPDATE          
 LEDGER1          
SET          
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO          
FROM          
 #BANKRECOSAVE, LEDGER (NOLOCK)          
WHERE          
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')          
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)          
 AND DDNO =  REFERENCENO          
 AND RELDT = ''          
 AND #BANKRECOSAVE.CLTCODE = @bank_code         
 AND #BANKRECOSAVE.MICRNO = @micr_no          
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)    
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @bank_code AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)     
   
    
    
 AND REFERENCENO  <> '0'          
 AND LEDGER.VNO = LEDGER1.VNO          
 AND LEDGER.VTYP = LEDGER1.VTYP        
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE          
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE          
 AND CONVERT(VARCHAR(11), LEDGER.VDT, 109) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109)    
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'          
 ROLLBACK TRAN          
 RETURN          
END          
          
          
SELECT          
 SUM(RELAMT) AS AMOUNT,          
 SLIPNO AS SLIPNO,          
 UPPER(DRCR) AS DRCR,          
 MICRNO          
INTO          
 BANKRECOCOMP          
FROM          
 LEDGER1          
WHERE          
 MICRNO = @micr_no  
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )          
 AND SLIPNO <>''          
GROUP BY          
 SLIPNO,          
 DRCR,          
 MICRNO          
          
          
UPDATE          
 #BANKRECOSAVE          
SET          
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'          
FROM          
 BANKRECOCOMP          
WHERE          
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)          
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)          
  AND #BANKRECOSAVE.MICRNO = @micr_no          
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT          
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO          
  AND REFERENCENO  <> '0'          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'          
 ROLLBACK TRAN          
 RETURN          
END          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO LEDGER_UPDATES1          
SELECT          
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE          
FROM          
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)          
WHERE          
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )          
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)          
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)          
 AND RELDT = ''          
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE          
 AND LEDGER1.VNO = LEDGER.VNO          
 AND LEDGER1.VTYP = LEDGER.VTYP          
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE          
 AND #BANKRECOSAVE.CLTCODE = @bank_code          
 AND #BANKRECOSAVE.MICRNO = @micr_no          
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)    
 AND #BANKRECOSAVE.REFERENCENO  <> '0'          
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @micr_no)          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'          
 ROLLBACK TRAN          
 RETURN          
END          
          
          
UPDATE          
 LEDGER1          
SET          
 RELDT = VALUEDATE ,          
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO          
FROM          
 #BANKRECOSAVE, LEDGER  (NOLOCK)          
WHERE          
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )          
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)          
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)          
 AND RELDT = ''          
 AND #BANKRECOSAVE.CLTCODE = @bank_code          
 AND #BANKRECOSAVE.MICRNO = @micr_no      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)    
 AND #BANKRECOSAVE.REFERENCENO  <> '0'          
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @micr_no)          
 AND LEDGER.VNO = LEDGER1.VNO          
 AND LEDGER.VTYP = LEDGER1.VTYP          
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE          
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'          
 ROLLBACK TRAN          
 RETURN          
END          
          
UPDATE          
 L          
SET          
 EDT = VALUEDATE          
FROM          
 LEDGER L, LEDGER_UPDATES1 LU          
WHERE          
 LU.VNO=L.VNO          
 AND LU.VTYP=L.VTYP          
 AND LU.BOOKTYPE=L.BOOKTYPE          
 AND EDT LIKE 'DEC 31 2049%'          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'          
 ROLLBACK TRAN          
 RETURN          
END          
          
UPDATE          
 L          
SET          
 EDT = VDT          
FROM          
 LEDGER L, LEDGER_UPDATES1 LU          
WHERE          
 LU.VNO=L.VNO          
 AND LU.VTYP=L.VTYP          
 AND LU.BOOKTYPE=L.BOOKTYPE          
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'          
 ROLLBACK TRAN          
 RETURN          
END          
          
IF @PROCESS_STATUS = 1      
BEGIN      
 DELETE FROM BANKRECO WHERE CLTCODE = @bank_code AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)      
END      
    
-----------------------------------------------------------------------------------------------  
INSERT INTO          
BANKRECO      
(Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,Status,Micrno,Dummy1,Dummy2)        
SELECT          
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,          
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@micr_no,'0','0'          
FROM          
 #BANKRECOSAVE B where cltcode = @bank_code and  Micrno = @micr_no        
  
         
    
INSERT INTO          
 BANKRECO_LOG          
SELECT          
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,          
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@micr_no,'0','0', 0, 'AUTO', GETDATE(), 'MATCHED'     
FROM          
 #BANKRECOSAVE B        
WHERE    
 B.STATUS = 'MATCHED'    
    
    
    
INSERT INTO LEDGER1_BANKRECO_LOG    
SELECT L1.*, 'AUTO', GETDATE(), 'MATCHED'     
FROM LEDGER1 L1, LEDGER_UPDATES1 LU    
WHERE L1.VNO = LU.VNO AND L1.VTYP = LU.VTYP AND L1.BOOKTYPE = LU.BOOKTYPE    
    
         
    
         
DROP TABLE BANKRECOCOMP  
-----------------------  
fetch next from  cur_bank  
into @bank_code, @micr_no  
END  
  
  
close cur_bank  
deallocate cur_bank  
  
  
UPDATE RECOPROCESS SET INPROCESS = 'N'   
--DROP TABLE BANKRECOCOMP  
DROP TABLE LEDGER_UPDATES1        
        
COMMIT TRAN          
--close cur_bank       
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_COMBINED_NEW
-- --------------------------------------------------
--EXEC AUTORECOUPDATE_HDFC_COMBINED 'D:\BackOffice\Reco\HDFCRECO\Merged_c067_a001.txt', 'ashoks','','broker','broker','HDFCRECO','COMBINED','sa','ms'
CREATE PROC [dbo].[AUTORECOUPDATE_HDFC_COMBINED_NEW]  
 @FILENAME VARCHAR(100),      
 @UNAME VARCHAR(100),      
 --@BANKCODE VARCHAR(10),      
 @STATUSID VARCHAR(10),      
 @STATUSNAME VARCHAR(100),
 @BANK_TYPE VARCHAR(10),
 @STAT_TYPE VARCHAR(10),
 @LOGIN VARCHAR(10),
 @PWD VARCHAR(15),
 @PROCESS_STATUS BIT = 0  
  
      
AS      
      
/*    
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'      
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'      
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'  
SELECT TOP 1 * FROM BANKRECO  
*/    
DECLARE      
 @@SQL_QUERY AS VARCHAR(1000),      
 @@CROSSREFERENCENO INT,      
 @@TABLE_EXIST VARCHAR(20),      
 @@RECORD_COUNT TINYINT,      
 @@RECO_STATUS CHAR(1),      
 @@FILE_EXIST INT,      
 @@CLTCODE_EXIST INT      
-- @@MICRNO VARCHAR(20)      
      
SET NOCOUNT ON      
      
--SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
--IF @@CLTCODE_EXIST = 0      
-- BEGIN      
 -- SELECT 'BANK CODE DOSE NOT EXIST.'      
  --RETURN      
 --END      
      
--SELECT @@MICRNO = ISNULL(MICRNO, 0) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
DECLARE      
 @@ERROR_COUNT SMALLINT,  
 @@EXIST_COUNT_BEFORE SMALLINT,  
 @@EXIST_COUNT_AFTER SMALLINT  
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT      
   U_FILENAME      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FILENAME      
   AND U_MODULE = 'HDFC_RECO UPLOAD'      
 ) A      
/*IF @@ERROR_COUNT > 0      
BEGIN      
 SELECT      
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'      
 RETURN      
END       */      
      
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO      

CREATE TABLE #HDFCRECO  
(
	BOOKDATE VARCHAR(11)
)

CREATE TABLE #ICICIRECO  
(
	SR_NO INT,
	TXN_ID VARCHAR(25),
	BOOKDATE VARCHAR(11)
)

IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " BANK_CODE VARCHAR(10)"

END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"  
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " BANK_CODE VARCHAR(10)"
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " BANK_CODE VARCHAR(10)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " BANK_CODE VARCHAR(10)"

END

EXEC (@@SQL_QUERY)

IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " BANK_CODE VARCHAR(10)"

	EXEC (@@SQL_QUERY)
END

CREATE TABLE [#BANKRECOSAVE_TEMP]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(50),      
  AMOUNT VARCHAR(20),      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 VARCHAR(20),      
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL,
  BANK_CODE VARCHAR(10)    
 )      
ON [PRIMARY]      
      
CREATE TABLE [#BANKRECOSAVE]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(50),      
  AMOUNT MONEY,      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  CROSSREFERENCENO [INT],      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 MONEY,
  BANK_CODE VARCHAR(10)          
 )      
ON [PRIMARY]     

CREATE TABLE #TESTIMPORT                
(                
	OneRow Varchar(2000),              
	SNO INT IDENTITY(1,1)              
)   

IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"
	
END
ELSE IF @BANK_TYPE <> 'CANARARECO'
BEGIN
	SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"
END

--PRINT @@SQL_QUERY
EXEC (@@SQL_QUERY) 




IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "
END
ELSE
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "
END


EXEC (@@SQL_QUERY)

SELECT * INTO HDFCRECO FROM #HDFCRECO


IF @BANK_TYPE = 'CITYRECO'
BEGIN
	UPDATE HDFCRECO SET [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE', VALUEDATE = BOOKDATE
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	UPDATE HDFCRECO SET AMOUNT = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN CREDIT ELSE DEBIT END, DRCR = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN 'C' ELSE 'D' END
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	UPDATE HDFCRECO SET VALUEDATE = BOOKDATE, DRCR = CASE WHEN DRCR = 'DR' THEN 'D' ELSE 'C' END
END

IF @BANK_TYPE = 'CANARARECO' 
BEGIN
	SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"
  	EXEC(@@SQL_QUERY)                

	DELETE FROM #TESTIMPORT WHERE OneRow IS NULL
	DELETE FROM #TESTIMPORT WHERE OneRow LIKE '****%'

	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),      
	 [DESCRIPTION] = SUBSTRING(OneRow, 18, 23),      
	 AMOUNT = SUBSTRING(OneRow, 41, 14),      
	 DRCR = SUBSTRING(OneRow, 17, 1),      
	 VALUEDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),      
	 REFERENCE_NO = SUBSTRING(OneRow, 9, 8),      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 '',      
	 '',      
	 '',      
	 ''      
	FROM      
	 #TESTIMPORT  
END
ELSE IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME,  (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 101),      
	 [DESCRIPTION],      
	 AMOUNT,      
	 DRCR,      
	 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE, 2) + '-' + SUBSTRING(VALUEDATE, 4, 2)),      
	 REFERENCE_NO,      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 '',      
	 '',      
	 '',      
	 ''      
	FROM      
	 HDFCRECO  

END
ELSE
BEGIN
	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),      
	 [DESCRIPTION],      
	 AMOUNT,      
	 DRCR,      
	 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),      
	 REFERENCE_NO,      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 '',      
	 '',      
	 '',      
	 ''      
	FROM      
	 HDFCRECO  
END


DROP TABLE HDFCRECO


INSERT INTO #BANKRECOSAVE      
SELECT      
 BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 '',      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO NOT LIKE '%[A-Z]%'

INSERT INTO #BANKRECOSAVE      
SELECT      
 BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO,      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 '',      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO LIKE '%[A-Z]%'

INSERT INTO #BANKRECOSAVE      
SELECT      
 BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],     
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 '',      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO IS NULL


IF @BANK_TYPE = 'CANARARECO'
BEGIN
	UPDATE #BANKRECOSAVE SET AMOUNT = CONVERT(MONEY, AMOUNT / 100)	
END
---------------------------------------------------------------



Update B 
set B.MICRNO = A.MICRNO
From #BANKRECOSAVE B Join ACMAST A ON (B.cltcode =  A.cltcode) AND A.ACCAT = 2  


SELECT * FROM #BANKRECOSAVE
RETURN
  


/*CREATE TABLE #BANKRECOSAVE_DELETE        
(        
 [DESCRIPTION] VARCHAR(250),        
 AMOUNT MONEY,        
 DRCR CHAR(1),        
 REFERENCENO VARCHAR(25),        
CROSSREFERENCENO INT        
) */       
    
DECLARE     
@@AMOUNTDIFF MONEY,    
@@STAMOUNTDIFF MONEY,    
@@BOOKDATE_MIN DATETIME,    
@@BOOKDATE_MAX DATETIME    
    
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE     
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE     
    
    
CREATE TABLE #RECODUPS     
(    
 BOOKDATE VARCHAR(11),     
 REFERENCENO VARCHAR(25),     
 AMOUNT MONEY,     
 DESCRIPTION VARCHAR(200),     
 STATUS VARCHAR(10),     
 CROSSREFERENCENO INT    
)    
    
SET @@EXIST_COUNT_BEFORE = 0    
SET @@EXIST_COUNT_AFTER = 0    
    
DECLARE     
@CLTCODE VARCHAR(10),     
@BOOKDATE DATETIME,     
@AMOUNT MONEY,     
@DRCR CHAR(1),     
@VALUEDATE DATETIME,     
@REFERENCENO VARCHAR(20),    
@DESCRIPTION VARCHAR(200)    
    
DECLARE CUR_CHECCK CURSOR FOR    
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0    
    
OPEN CUR_CHECCK    
    
FETCH NEXT FROM CUR_CHECCK    
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION    
    
WHILE @@FETCH_STATUS = 0    
BEGIN    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
 IF @PROCESS_STATUS = 0     
 BEGIN    
  SELECT @@ERROR_COUNT = 0    
      
  SELECT      
   @@EXIST_COUNT_BEFORE = COUNT(1)    
  FROM     
   BANKRECO    
  WHERE    
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)    
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')    
    
    
      
 /* IF @@ERROR_COUNT > 0    
   BEGIN    
    SELECT      
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS    
    FROM     
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,     
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B    
    WHERE    
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)    
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO    
      
    RETURN    
   END */    
 END    
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
    
     
         
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)    
 FROM #BANKRECOSAVE    
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0        
     
 DELETE BR FROM #BANKRECOSAVE BR    
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO    
     
     
 IF @PROCESS_STATUS = 0     
 BEGIN    
  SELECT     
   @@EXIST_COUNT_AFTER = COUNT(1)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR     
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0        
      
      
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER    
   BEGIN    
    INSERT INTO #RECODUPS    
    SELECT      
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO    
    FROM     
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59'  
	 --AND CLTCODE = @BANKCODE
     ) BR    
    WHERE    
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)    
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')    
      
   END     
  SET @@EXIST_COUNT_BEFORE = 0    
  SET @@EXIST_COUNT_AFTER = 0    
 END     
 FETCH NEXT FROM CUR_CHECCK    
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION    
END    
    
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0        
    
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS    
    
IF @@ERROR_COUNT > 0    
BEGIN    
 SELECT * FROM #RECODUPS    
    

 RETURN    
END    
    
    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
DELETE BR FROM      
 BANKRECO B, #BANKRECOSAVE BR      
WHERE       
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))      
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')    
    
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL    
  
    
IF @@ERROR_COUNT = 0    
BEGIN     
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'     
 RETURN    
END    
      
/*SELECT     
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)     
 FROM    
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,    
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1    
    
    
IF @PROCESS_STATUS = 1    
BEGIN    
SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))    
 FROM     
 (    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   BANKRECO    
  WHERE     
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE    
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)    
  UNION ALL    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   VALUEDATE IS NOT NULL    
      
      
 )B    
END     
ELSE    
BEGIN     
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))    
 FROM     
(    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   BANKRECO    
  WHERE     
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE    
  UNION ALL    
  SELECT     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM     
   #BANKRECOSAVE    
  WHERE     
   VALUEDATE IS NOT NULL    
      
      
 )B    
END    
    
    
IF @@AMOUNTDIFF <> @@STAMOUNTDIFF    
BEGIN    
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'    
 RETURN    
END  */  
    
 DELETE FROM     
  #BANKRECOSAVE    
 WHERE     
  VALUEDATE IS NULL    
    
    
    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */    
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'        
        
IF @@TABLE_EXIST = ''        
BEGIN        
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS        
        
IF @@RECORD_COUNT = 0        
BEGIN        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS        
PRINT "test " + @@RECO_STATUS    
IF @@RECO_STATUS = 'N'        
BEGIN        
 BEGIN TRAN        
 UPDATE RECOPROCESS SET INPROCESS = 'Y'        
END        
ELSE        
BEGIN        
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'        
 RETURN        
END        
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES1'        
IF @@TABLE_EXIST <> ''        
BEGIN        
 DROP TABLE LEDGER_UPDATES1        
END        
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'        
IF @@TABLE_EXIST <> ''        
BEGIN        
 DROP TABLE BANKRECOCOMP        
END        

INSERT        
INTO        
 V2_UPLOADED_FILES        
SELECT        
 @FILENAME,        
 @FILENAME,        
 COUNT(1),        
 'B',        
 GETDATE(),        
 @UNAME,        
 'HDFC_RECO UPLOAD'

--DROP TABLE LEDGER_UPDATES          
CREATE TABLE LEDGER_UPDATES1 (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)        
--------------------------------------
DECLARE   
 @bank_code varchar(10),
 @micr_no VARCHAR(20)

Declare cur_bank cursor for
   select distinct CLTCODE,micrno from #BANKRECOSAVE
	open cur_bank

	fetch next from  cur_bank
	into @bank_code, @micr_no

	while @@fetch_status = 0
	Begin


        
        
        
        
UPDATE        
 #BANKRECOSAVE        
SET        
 STATUS ='MATCHED'        
FROM        
 LEDGER1        
WHERE        
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)        
 AND CLTCODE = @bank_code       
 AND #BANKRECOSAVE.MICRNO = @micr_no        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @bank_code AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109) >= CONVERT(VARCHAR(11), VDT, 109))       
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND   REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
----------- CODE TO BE ADD HERE ----------------------
/*Declare cur_bank cursor for
   select distinct CLTCODE,micrno from #BANKRECOSAVE
	open cur_bank

	fetch next from  cur_bank
	into @bank_code, @micr_no

	while @@fetch_status = 0
	Begin
*/
--------------------------------------------------------
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
INSERT INTO        
 LEDGER_UPDATES1        
SELECT       
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE        
FROM        
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE        
 AND LEDGER1.VNO = LEDGER.VNO        
 AND LEDGER1.VTYP = LEDGER.VTYP        
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND DDNO =  REFERENCENO        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @bank_code       
 AND #BANKRECOSAVE.MICRNO = @micr_no        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @bank_code AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)        
 AND CONVERT(VARCHAR(11), #BANKRECOSAVE.AMOUNT, 109) >= CONVERT(VARCHAR(11), LEDGER.VDT, 109)  
 AND   REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
UPDATE        
 LEDGER1        
SET        
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO        
FROM        
 #BANKRECOSAVE, LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND DDNO =  REFERENCENO        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @bank_code       
 AND #BANKRECOSAVE.MICRNO = @micr_no        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @bank_code AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
  
  
 AND REFERENCENO  <> '0'        
 AND LEDGER.VNO = LEDGER1.VNO        
 AND LEDGER.VTYP = LEDGER1.VTYP      
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE        
 AND CONVERT(VARCHAR(11), LEDGER.VDT, 109) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109)  
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
SELECT        
 SUM(RELAMT) AS AMOUNT,        
 SLIPNO AS SLIPNO,        
 UPPER(DRCR) AS DRCR,        
 MICRNO        
INTO        
 BANKRECOCOMP        
FROM        
 LEDGER1        
WHERE        
 MICRNO = @micr_no
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )        
 AND SLIPNO <>''        
GROUP BY        
 SLIPNO,        
 DRCR,        
 MICRNO        
        
        
UPDATE        
 #BANKRECOSAVE        
SET        
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'        
FROM        
 BANKRECOCOMP        
WHERE        
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)        
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)        
  AND #BANKRECOSAVE.MICRNO = @micr_no        
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT        
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO        
  AND REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
INSERT INTO LEDGER_UPDATES1        
SELECT        
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE        
FROM        
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE        
 AND LEDGER1.VNO = LEDGER.VNO        
 AND LEDGER1.VTYP = LEDGER.VTYP        
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE        
 AND #BANKRECOSAVE.CLTCODE = @bank_code        
 AND #BANKRECOSAVE.MICRNO = @micr_no        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.REFERENCENO  <> '0'        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @micr_no)        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
UPDATE        
 LEDGER1        
SET        
 RELDT = VALUEDATE ,        
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO        
FROM        
 #BANKRECOSAVE, LEDGER  (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @bank_code        
 AND #BANKRECOSAVE.MICRNO = @micr_no    
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)  
 AND #BANKRECOSAVE.REFERENCENO  <> '0'        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @micr_no)        
 AND LEDGER.VNO = LEDGER1.VNO        
 AND LEDGER.VTYP = LEDGER1.VTYP        
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
UPDATE        
 L        
SET        
 EDT = VALUEDATE        
FROM        
 LEDGER L, LEDGER_UPDATES1 LU        
WHERE        
 LU.VNO=L.VNO        
 AND LU.VTYP=L.VTYP        
 AND LU.BOOKTYPE=L.BOOKTYPE        
 AND EDT LIKE 'DEC 31 2049%'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'        
 ROLLBACK TRAN        
 RETURN        
END        
        
UPDATE        
 L        
SET        
 EDT = VDT        
FROM        
 LEDGER L, LEDGER_UPDATES1 LU        
WHERE        
 LU.VNO=L.VNO        
 AND LU.VTYP=L.VTYP        
 AND LU.BOOKTYPE=L.BOOKTYPE        
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
IF @PROCESS_STATUS = 1    
BEGIN    
 DELETE FROM BANKRECO WHERE CLTCODE = @bank_code AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)    
END    
        
INSERT INTO        
 BANKRECO    
(Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,Status,Micrno,Dummy1,Dummy2)      
SELECT        
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,        
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@micr_no,'0','0'        
FROM        
 #BANKRECOSAVE B      
  
INSERT INTO        
 BANKRECO_LOG        
SELECT        
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,        
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@micr_no,'0','0', 0, 'AUTO', GETDATE(), 'MATCHED'   
FROM        
 #BANKRECOSAVE B      
WHERE  
 B.STATUS = 'MATCHED'  
  
  
  
INSERT INTO LEDGER1_BANKRECO_LOG  
SELECT L1.*, 'AUTO', GETDATE(), 'MATCHED'   
FROM LEDGER1 L1, LEDGER_UPDATES1 LU  
WHERE L1.VNO = LU.VNO AND L1.VTYP = LU.VTYP AND L1.BOOKTYPE = LU.BOOKTYPE  
  
       
  
       
DROP TABLE BANKRECOCOMP

fetch next from  cur_bank
into @bank_code, @micr_no
END
UPDATE RECOPROCESS SET INPROCESS = 'N' 
--DROP TABLE BANKRECOCOMP
DROP TABLE LEDGER_UPDATES1      
      
COMMIT TRAN        
close cur_bank     
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_NEW
-- --------------------------------------------------
CREATE  PROC [dbo].[AUTORECOUPDATE_HDFC_NEW]    
 @FILENAME VARCHAR(100),    
 @UNAME VARCHAR(100),    
 @BANKCODE VARCHAR(10),    
 @STATUSID VARCHAR(10),    
 @STATUSNAME VARCHAR(100),    
 @PROCESS_STATUS BIT = 0

    
AS    
    
/*  
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'    
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'    
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'
SELECT TOP 1 * FROM BANKRECO
*/  
DECLARE    
 @@SQL_QUERY AS VARCHAR(1000),    
 @@CROSSREFERENCENO INT,    
 @@TABLE_EXIST VARCHAR(20),    
 @@RECORD_COUNT TINYINT,    
 @@RECO_STATUS CHAR(1),    
 @@FILE_EXIST INT,    
 @@CLTCODE_EXIST INT,    
 @@MICRNO VARCHAR(20)    
    
SET NOCOUNT ON    
    
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2    
    
IF @@CLTCODE_EXIST = 0    
 BEGIN    
  SELECT 'BANK CODE DOSE NOT EXIST.'    
  RETURN    
 END    
    
SELECT @@MICRNO = MICRNO FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2    
    
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/    
DECLARE    
 @@ERROR_COUNT SMALLINT,
 @@EXIST_COUNT_BEFORE SMALLINT,
 @@EXIST_COUNT_AFTER SMALLINT
SELECT    
 @@ERROR_COUNT = COUNT(1)    
FROM    
 (    
  SELECT    
   U_FILENAME    
  FROM    
   V2_UPLOADED_FILES    
  WHERE    
   U_FILENAME = @FILENAME    
   AND U_MODULE = 'HDFC_RECO UPLOAD'    
 ) A    
/*IF @@ERROR_COUNT > 0    
BEGIN    
 SELECT    
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'    
 RETURN    
END       */    
    
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO    
    
CREATE TABLE #HDFCRECO
(
	BOOKDATE VARCHAR(11),
	VALUEDATE VARCHAR(11),
	AMOUNT VARCHAR(20),
	DRCR CHAR(1),
	[DESCRIPTION] VARCHAR(100),
	REFERENCE_NO VARCHAR(20),
	TRANSACTION_BRANCH VARCHAR(30),
	RUNNING_BAL VARCHAR(20)
)     
    
    
CREATE TABLE [#BANKRECOSAVE_TEMP]    
 (    
  CLTCODE VARCHAR(10),    
  BOOKDATE DATETIME,    
  [DESCRIPTION] VARCHAR(50),    
  AMOUNT VARCHAR(20),    
  DRCR VARCHAR(1),    
  VALUEDATE DATETIME,    
  REFERENCENO VARCHAR(30),    
  STATUSID VARCHAR(15),    
  STATUSNAME VARCHAR(25),    
  LOGINNAME VARCHAR(25),    
  STATUS VARCHAR(9),    
  MICRNO INT,    
  DUMMY1 VARCHAR(15) ,    
  DUMMY2 VARCHAR(15),    
  AMOUNTLEDGR1 VARCHAR(20),    
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL    
 )    
ON [PRIMARY]    
    
CREATE TABLE [#BANKRECOSAVE]    
 (    
  CLTCODE VARCHAR(10),    
  BOOKDATE DATETIME,    
  [DESCRIPTION] VARCHAR(50),    
  AMOUNT MONEY,    
  DRCR VARCHAR(1),    
  VALUEDATE DATETIME,    
  REFERENCENO VARCHAR(30),    
  STATUSID VARCHAR(15),    
  STATUSNAME VARCHAR(25),    
  LOGINNAME VARCHAR(25),    
  CROSSREFERENCENO [INT],    
  STATUS VARCHAR(9),    
  MICRNO INT,    
  DUMMY1 VARCHAR(15) ,    
  DUMMY2 VARCHAR(15),    
  AMOUNTLEDGR1 MONEY    
 )    
ON [PRIMARY]    
    
    
SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_NEW '" + @FILENAME + "',  '#HDFCRECO'"    
EXEC (@@SQL_QUERY)    

INSERT INTO #BANKRECOSAVE_TEMP    
SELECT    
 @BANKCODE,    
 BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),    
 [DESCRIPTION],    
 AMOUNT,    
 DRCR,    
 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),    
 REFERENCE_NO,    
 @STATUSID,    
 @STATUSNAME,    
 @UNAME,    
 'UNMATCHED',    
 @@MICRNO,    
 '',    
 '',    
 ''    
FROM    
 #HDFCRECO    

INSERT INTO #BANKRECOSAVE    
SELECT    
 @BANKCODE,    
 BOOKDATE,  
 [DESCRIPTION],    
 CONVERT(MONEY,AMOUNT),    
 DRCR,    
 VALUEDATE,    
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),    
 @STATUSID,    
 @STATUSNAME,    
 @UNAME,    
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),    
 'UNMATCHED',    
 @@MICRNO,    
 '',    
 '',    
 0    
FROM    
 #BANKRECOSAVE_TEMP    


    
/*CREATE TABLE #BANKRECOSAVE_DELETE    
(    
 [DESCRIPTION] VARCHAR(250),    
 AMOUNT MONEY,    
 DRCR CHAR(1),    
 REFERENCENO VARCHAR(25),    
CROSSREFERENCENO INT    
) */   

DECLARE 
@@AMOUNTDIFF MONEY,
@@STAMOUNTDIFF MONEY,
@@BOOKDATE_MIN DATETIME,
@@BOOKDATE_MAX DATETIME

SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE 
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE 


CREATE TABLE #RECODUPS 
(
	BOOKDATE VARCHAR(11), 
	REFERENCENO VARCHAR(25), 
	AMOUNT MONEY, 
	DESCRIPTION VARCHAR(200), 
	STATUS VARCHAR(10), 
	CROSSREFERENCENO INT
)

SET @@EXIST_COUNT_BEFORE = 0
SET @@EXIST_COUNT_AFTER = 0

DECLARE 
@CLTCODE VARCHAR(10), 
@BOOKDATE DATETIME, 
@AMOUNT MONEY, 
@DRCR CHAR(1), 
@VALUEDATE DATETIME, 
@REFERENCENO VARCHAR(20),
@DESCRIPTION VARCHAR(200)

DECLARE CUR_CHECCK CURSOR FOR
	SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0

OPEN CUR_CHECCK

FETCH NEXT FROM CUR_CHECCK
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION

WHILE @@FETCH_STATUS = 0
BEGIN
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */
	IF @PROCESS_STATUS = 0 
	BEGIN
		SELECT @@ERROR_COUNT = 0
		
		SELECT 	
			@@EXIST_COUNT_BEFORE = COUNT(1)
		FROM 
			BANKRECO
		WHERE
			CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)
			AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')


		
	/*	IF @@ERROR_COUNT > 0
			BEGIN
				SELECT 	
					BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS
				FROM 
					(SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR, 
					(SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B
				WHERE
					BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)
					AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO
		
				RETURN
			END */
	END
	/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */

	
	    
	SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)
	FROM #BANKRECOSAVE
	WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0    
	
	DELETE BR FROM #BANKRECOSAVE BR
	WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO
	
	
	IF @PROCESS_STATUS = 0 
	BEGIN
		SELECT 
			@@EXIST_COUNT_AFTER = COUNT(1)
		FROM 
			#BANKRECOSAVE
		WHERE 
			[DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR 
			AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0    
		
		
		IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER
			BEGIN
				INSERT INTO #RECODUPS
				SELECT 	
					BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO
				FROM 
					(SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR
				WHERE
					CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)
					AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')
		
			END 
		SET @@EXIST_COUNT_BEFORE = 0
		SET @@EXIST_COUNT_AFTER = 0
	END 
	FETCH NEXT FROM CUR_CHECCK
	INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION
END

DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0    

SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS

IF @@ERROR_COUNT > 0
BEGIN
	SELECT * FROM #RECODUPS
	RETURN
END




/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */
DELETE BR FROM  
 BANKRECO B, #BANKRECOSAVE BR  
WHERE   
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))  
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')

SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL

IF @@ERROR_COUNT = 0
BEGIN 
	SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'	
	RETURN
END
  
SELECT 
	@@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT) 
FROM
	(SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,
	(SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1


IF @PROCESS_STATUS = 1
BEGIN
	SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))
	FROM 
	(
		SELECT 
			AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM 
			BANKRECO
		WHERE 
			BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE
			AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)
		UNION ALL
		SELECT 
			AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM 
			#BANKRECOSAVE
		WHERE 
			VALUEDATE IS NOT NULL
		
		
	)B
END 
ELSE
BEGIN 
	SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))
	FROM 
	(
		SELECT 
			AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM 
			BANKRECO
		WHERE 
			BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE
		UNION ALL
		SELECT 
			AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM 
			#BANKRECOSAVE
		WHERE 
			VALUEDATE IS NOT NULL
		
		
	)B
END


IF @@AMOUNTDIFF <> @@STAMOUNTDIFF
BEGIN
	SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'
	RETURN
END

	DELETE	FROM 
		#BANKRECOSAVE
	WHERE 
		VALUEDATE IS NULL



/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */
    
SET @@TABLE_EXIST = ''    
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'    
    
IF @@TABLE_EXIST = ''    
BEGIN    
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))    
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')    
END    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS    
    
IF @@RECORD_COUNT = 0    
BEGIN    
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')    
END    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS    
    
IF @@RECO_STATUS = 'N'    
BEGIN    
 BEGIN TRAN    
 UPDATE RECOPROCESS SET INPROCESS = 'Y'    
END    
ELSE    
BEGIN    
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'    
 RETURN    
END    
    
SET @@TABLE_EXIST = ''    
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'    
IF @@TABLE_EXIST <> ''    
BEGIN    
 DROP TABLE LEDGER_UPDATES    
END    
    
SET @@TABLE_EXIST = ''    
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'    
IF @@TABLE_EXIST <> ''    
BEGIN    
 DROP TABLE BANKRECOCOMP    
END    
    
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)    
    
INSERT    
INTO    
 V2_UPLOADED_FILES    
SELECT    
 @FILENAME,    
 @FILENAME,    
 COUNT(1),    
 'B',    
 GETDATE(),    
 @UNAME,    
 'HDFC_RECO UPLOAD'    
    
    
UPDATE    
 #BANKRECOSAVE    
SET    
 STATUS ='MATCHED'    
FROM    
 LEDGER1    
WHERE    
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20' )    
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)    
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)    
 AND CLTCODE = @BANKCODE    
 AND #BANKRECOSAVE.MICRNO = @@MICRNO    
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)    







 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO    
 AND   REFERENCENO  <> '0'    
    
IF @@ERROR <> 0    
BEGIN    
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'    
 ROLLBACK TRAN    
 RETURN    
END    
    
    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
INSERT INTO    
 LEDGER_UPDATES    
SELECT   
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE    
FROM    
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)    
WHERE    
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' )    
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE    
 AND LEDGER1.VNO = LEDGER.VNO    
 AND LEDGER1.VTYP = LEDGER.VTYP    
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE    
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)    
 AND DDNO =  REFERENCENO    
 AND RELDT = ''    
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE    
 AND #BANKRECOSAVE.MICRNO = @@MICRNO    
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO    
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)    
 AND   REFERENCENO  <> '0'    
    
IF @@ERROR <> 0    
BEGIN    
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'    
 ROLLBACK TRAN    
 RETURN    
END    
    
    
UPDATE    
 LEDGER1    
SET    
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO    
FROM    
 #BANKRECOSAVE, LEDGER (NOLOCK)    
WHERE    
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' )    
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)    
 AND DDNO =  REFERENCENO    
 AND RELDT = ''    
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE    
 AND #BANKRECOSAVE.MICRNO = @@MICRNO    
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO    
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)    









 AND REFERENCENO  <> '0'    
 AND LEDGER.VNO = LEDGER1.VNO    
 AND LEDGER.VTYP = LEDGER1.VTYP    
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE    
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE    
    
IF @@ERROR <> 0    
BEGIN    
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'    
 ROLLBACK TRAN    
 RETURN    
END    
    
    
SELECT    
 SUM(RELAMT) AS AMOUNT,    
 SLIPNO AS SLIPNO,    
 UPPER(DRCR) AS DRCR,    
 MICRNO    
INTO    
 BANKRECOCOMP    
FROM    
 LEDGER1    
WHERE    
 MICRNO = @@MICRNO    
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )    
 AND SLIPNO <>''    
GROUP BY    
 SLIPNO,    
 DRCR,    
 MICRNO    
    
    
UPDATE    
 #BANKRECOSAVE    
SET    
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'    
FROM    
 BANKRECOCOMP    
WHERE    
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)    
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)    
  AND #BANKRECOSAVE.MICRNO = @@MICRNO    
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT    
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO    
  AND REFERENCENO  <> '0'    
    
IF @@ERROR <> 0    
BEGIN    
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'    
 ROLLBACK TRAN    
 RETURN    
END    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
INSERT INTO LEDGER_UPDATES    
SELECT    
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE    
FROM    
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)    
WHERE    
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )    
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)    
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)    
 AND RELDT = ''    
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE    
 AND LEDGER1.VNO = LEDGER.VNO    
 AND LEDGER1.VTYP = LEDGER.VTYP    
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE    
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE    
 AND #BANKRECOSAVE.MICRNO = @@MICRNO    
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO    
 AND #BANKRECOSAVE.REFERENCENO  <> '0'    
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)    
    
IF @@ERROR <> 0    
BEGIN    
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'    
 ROLLBACK TRAN    
 RETURN    
END    
    
    
UPDATE    
 LEDGER1    
SET    
 RELDT = VALUEDATE ,    
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO    
FROM    
 #BANKRECOSAVE, LEDGER  (NOLOCK)    
WHERE    
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )    
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)    
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)    
 AND RELDT = ''    
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE    
 AND #BANKRECOSAVE.MICRNO = @@MICRNO    
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO    
 AND #BANKRECOSAVE.REFERENCENO  <> '0'    
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)    
 AND LEDGER.VNO = LEDGER1.VNO    
 AND LEDGER.VTYP = LEDGER1.VTYP    
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE    
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE    
    
IF @@ERROR <> 0    
BEGIN    
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'    
 ROLLBACK TRAN    
 RETURN    
END    
    
UPDATE    
 L    
SET    
 EDT = VALUEDATE    
FROM    
 LEDGER L, LEDGER_UPDATES LU    
WHERE    
 LU.VNO=L.VNO    
 AND LU.VTYP=L.VTYP    
 AND LU.BOOKTYPE=L.BOOKTYPE    
 AND EDT LIKE 'DEC 31 2049%'    
    
IF @@ERROR <> 0    
BEGIN    
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'    
 ROLLBACK TRAN    
 RETURN    
END    
    
UPDATE    
 L    
SET    
 EDT = VDT    
FROM    
 LEDGER L, LEDGER_UPDATES LU    
WHERE    
 LU.VNO=L.VNO    
 AND LU.VTYP=L.VTYP    
 AND LU.BOOKTYPE=L.BOOKTYPE    
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))    
    
IF @@ERROR <> 0    
BEGIN    
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'    
 ROLLBACK TRAN    
 RETURN    
END    
    
DROP TABLE BANKRECOCOMP    
DROP TABLE LEDGER_UPDATES    

IF @PROCESS_STATUS = 1
BEGIN
	DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)
END
    
INSERT INTO    
 BANKRECO    
SELECT    
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,    
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'    
FROM    
 #BANKRECOSAVE B    
    
    
UPDATE RECOPROCESS SET INPROCESS = 'N'    
    
COMMIT TRAN    
    
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_ICICI_ALLBANKS
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_ICICI_ALLBANKS]        
 @FILENAME VARCHAR(100),                  
 @UNAME VARCHAR(100),                  
 @BANKCODE VARCHAR(10),                  
 @STATUSID VARCHAR(10),                  
 @STATUSNAME VARCHAR(100),            
 @BANK_TYPE VARCHAR(10),            
 @STAT_TYPE VARCHAR(10),            
 @LOGIN VARCHAR(10),            
 @PWD VARCHAR(15),            
 @PROCESS_STATUS BIT = 0              
              
                  
AS                  
                  
/*                
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'                  
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'                  
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'              
SELECT TOP 1 * FROM BANKRECO              
*/                
DECLARE                  
 @@SQL_QUERY AS VARCHAR(1000),                  
 @@CROSSREFERENCENO INT,                  
 @@TABLE_EXIST VARCHAR(20),                  
 @@RECORD_COUNT TINYINT,                  
 @@RECO_STATUS CHAR(1),                  
 @@FILE_EXIST INT,                  
 @@CLTCODE_EXIST INT,                  
 @@MICRNO VARCHAR(20)                  
                  
SET NOCOUNT ON                  
                  
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2                  
                  
IF @@CLTCODE_EXIST = 0                  
 BEGIN                  
  SELECT 'BANK CODE DOSE NOT EXIST.'                  
  RETURN                  
 END                  
                  
SELECT @@MICRNO = ISNULL(MICRNO, 0) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2                  
                  
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                  
DECLARE                  
 @@ERROR_COUNT SMALLINT,              
 @@EXIST_COUNT_BEFORE SMALLINT,              
 @@EXIST_COUNT_AFTER SMALLINT              
SELECT                  
 @@ERROR_COUNT = COUNT(1)                  
FROM                  
 (                  
  SELECT                  
   U_FILENAME                  
  FROM                  
   V2_UPLOADED_FILES                  
  WHERE                  
   U_FILENAME = @FILENAME                  
   AND U_MODULE = 'HDFC_RECO UPLOAD'                  
 ) A                  
IF @@ERROR_COUNT > 0                  
BEGIN                  
 SELECT                  
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'                  
 RETURN                  
END         
                  
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO                  
            
CREATE TABLE #HDFCRECO              
(            
 BOOKDATE VARCHAR(11)            
)            
            
CREATE TABLE #ICICIRECO              
(            
 SR_NO INT,            
 TXN_ID VARCHAR(25),            
 BOOKDATE VARCHAR(11)            
)            
            
IF @BANK_TYPE = 'CITYRECO'            
BEGIN            
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"            
END            
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'             
BEGIN            
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"              
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"            
END            
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'            
BEGIN            
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"            
END            
ELSE IF @BANK_TYPE = 'ICICIRECO'             
BEGIN            
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"            
            
END            
            
EXEC (@@SQL_QUERY)            
            
IF @BANK_TYPE = 'ICICIRECO'             
BEGIN            
 SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD [DESCRIPTION] VARCHAR(100), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"            
            
 EXEC (@@SQL_QUERY)            
END            
            
CREATE TABLE [#BANKRECOSAVE_TEMP]                  
 (                  
  CLTCODE VARCHAR(10),                  
  BOOKDATE DATETIME,                  
  [DESCRIPTION] VARCHAR(50),                  
  AMOUNT VARCHAR(20),                  
  DRCR VARCHAR(1),                  
  VALUEDATE DATETIME,                  
  REFERENCENO VARCHAR(30),                  
  STATUSID VARCHAR(15),                  
  STATUSNAME VARCHAR(25),                  
  LOGINNAME VARCHAR(25),                  
  STATUS VARCHAR(9),                  
  MICRNO INT,                  
  DUMMY1 VARCHAR(15) ,                  
  DUMMY2 VARCHAR(15),                  
  AMOUNTLEDGR1 VARCHAR(20),                  
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL                  
 )                  
ON [PRIMARY]                  
                  
CREATE TABLE [#BANKRECOSAVE]                  
 (                  
  CLTCODE VARCHAR(10),                  
  BOOKDATE DATETIME,                  
  [DESCRIPTION] VARCHAR(50),                  
  AMOUNT MONEY,                  
  DRCR VARCHAR(1),                  
  VALUEDATE DATETIME,                  
  REFERENCENO VARCHAR(30),                  
  STATUSID VARCHAR(15),                  
  STATUSNAME VARCHAR(25),                  
  LOGINNAME VARCHAR(25),                  
  CROSSREFERENCENO [INT],                  
  STATUS VARCHAR(9),                  
  MICRNO INT,                  
  DUMMY1 VARCHAR(15) ,                  
  DUMMY2 VARCHAR(15),                  
  AMOUNTLEDGR1 MONEY                  
 )                  
ON [PRIMARY]                 
            
CREATE TABLE #TESTIMPORT                            
(                            
 OneRow Varchar(2000),                          
 SNO INT IDENTITY(1,1)                          
)               
            
IF @BANK_TYPE = 'ICICIRECO'            
BEGIN            
 SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"            
             
END            
ELSE IF @BANK_TYPE <> 'CANARARECO'            
BEGIN            
 SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"            
END            
            
--PRINT @@SQL_QUERY            
EXEC (@@SQL_QUERY)             
            
            
            
            
IF @BANK_TYPE = 'CITYRECO'            
BEGIN            
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"            
END            
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'             
BEGIN            
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "            
END            
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'            
BEGIN            
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"            
END            
ELSE IF @BANK_TYPE = 'ICICIRECO'            
BEGIN            
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "            
END            
ELSE            
BEGIN            
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "            
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "            
END            
            
            
EXEC (@@SQL_QUERY)            
        
            
IF @BANK_TYPE = 'ICICIRECO'            
BEGIN            
 INSERT INTO #HDFCRECO (BOOKDATE,[DESCRIPTION],REFERENCE_NO,DRCR,AMOUNT,RUNNING_BAL) SELECT BOOKDATE,[DESCRIPTION],REFERENCE_NO,DRCR,REPLACE(AMOUNT, ',', ''),RUNNING_BAL FROM #ICICIRECO            
END            
            
SELECT * INTO HDFCRECO FROM #HDFCRECO            
            
            
IF @BANK_TYPE = 'CITYRECO'            
BEGIN            
 UPDATE HDFCRECO SET [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE', VALUEDATE = BOOKDATE            
END            
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'             
BEGIN            
 UPDATE HDFCRECO SET AMOUNT = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN CREDIT ELSE DEBIT END, DRCR = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN 'C' ELSE 'D' END            
END            
ELSE IF @BANK_TYPE = 'ICICIRECO'             
BEGIN            
 UPDATE HDFCRECO SET VALUEDATE = BOOKDATE, DRCR = CASE WHEN DRCR = 'DR' THEN 'D' ELSE 'C' END            
END            
        
        
            
IF @BANK_TYPE = 'CANARARECO'             
BEGIN            
 SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"            
   EXEC(@@SQL_QUERY)                            
            
 DELETE FROM #TESTIMPORT WHERE OneRow IS NULL            
 DELETE FROM #TESTIMPORT WHERE OneRow LIKE '****%'            
            
 INSERT INTO #BANKRECOSAVE_TEMP                  
 SELECT                  
  @BANKCODE,                  
  BOOKDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),                  
  [DESCRIPTION] = SUBSTRING(OneRow, 18, 23),                  
  AMOUNT = SUBSTRING(OneRow, 41, 14),            
  DRCR = SUBSTRING(OneRow, 17, 1),                  
  VALUEDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),                  
  REFERENCE_NO = SUBSTRING(OneRow, 9, 8),                  
  @STATUSID,                  
  @STATUSNAME,                  
  @UNAME,                  
  'UNMATCHED',                  
  @@MICRNO,                  
  '',                  
  '',                  
  ''                  
 FROM       
  #TESTIMPORT              
END            
ELSE IF @BANK_TYPE = 'ICICIRECO'            
BEGIN            
 INSERT INTO #BANKRECOSAVE_TEMP                  
 SELECT                  
  @BANKCODE,                  
  BOOKDATE = CONVERT(DATETIME,  (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 101),                  
  [DESCRIPTION],                  
  AMOUNT,                  
  DRCR,                  
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE, 2) + '-' + SUBSTRING(VALUEDATE, 4, 2)),                  
  REFERENCE_NO,                  
  @STATUSID,                  
@STATUSNAME,                  
  @UNAME,                  
  'UNMATCHED',                  
  @@MICRNO,                  
  '',                  
  '',                  
  ''                  
 FROM                  
  HDFCRECO              
            
END            
ELSE            
BEGIN            
 INSERT INTO #BANKRECOSAVE_TEMP                  
 SELECT                  
  @BANKCODE,                  
  BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),                  
  [DESCRIPTION],                  
  AMOUNT,                  
  DRCR,                  
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),                  
  REFERENCE_NO,                  
  @STATUSID,                  
  @STATUSNAME,                  
  @UNAME,                  
  'UNMATCHED',                  
  @@MICRNO,                  
  '',                  
  '',                  
  ''                  
 FROM                  
  HDFCRECO              
END            
            
        
DROP TABLE HDFCRECO            
            
            
INSERT INTO #BANKRECOSAVE                  
SELECT                  
 @BANKCODE,                  
 BOOKDATE,                
 [DESCRIPTION],                  
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,                  
 DRCR,                  
 VALUEDATE,                  
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),                     
 @STATUSID,                  
 @STATUSNAME,                  
 @UNAME,                  
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),                  
 'UNMATCHED',                  
 @@MICRNO,                  
 '',                  
 '',                  
 0                  
FROM                  
 #BANKRECOSAVE_TEMP                  
WHERE             
 REFERENCENO NOT LIKE '%[A-Z]%'            
            
INSERT INTO #BANKRECOSAVE                  
SELECT                  
 @BANKCODE,                  
 BOOKDATE,                
 [DESCRIPTION],                  
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,                  
 DRCR,                  
 VALUEDATE,                  
 ISNULL(REFERENCENO, 0),                  
 @STATUSID,                  
 @STATUSNAME,                  
 @UNAME,                  
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),                  
 'UNMATCHED',                  
 @@MICRNO,                  
 '',                  
 '',                  
 0                  
FROM                  
 #BANKRECOSAVE_TEMP                  
WHERE             
 REFERENCENO LIKE '%[A-Z]%'            
            
INSERT INTO #BANKRECOSAVE                  
SELECT                   @BANKCODE,                  
 BOOKDATE,                
 [DESCRIPTION],                  
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,                  
 DRCR,                  
 VALUEDATE,                  
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),                  
 @STATUSID,                  
 @STATUSNAME,                  
 @UNAME,                  
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),                  
 'UNMATCHED',                  
 @@MICRNO,                  
 '',                  
 '',                  
 0                  
FROM                  
 #BANKRECOSAVE_TEMP                  
WHERE             
 REFERENCENO IS NULL            
            
            
IF @BANK_TYPE = 'CANARARECO'            
BEGIN            
 UPDATE #BANKRECOSAVE SET AMOUNT = CONVERT(MONEY, AMOUNT / 100)             
END            
        
/*********************** New code added to check the referenceno from description column *****************/        
        
SELECT VTYPE        
INTO   #VMAST        
FROM   VMAST WITH(NOLOCK)         
WHERE  VTYPE IN ('2','3','5','19',        
                 '20','17')        
                        
UPDATE #BANKRECOSAVE        
SET    REFERENCENO = DBO.REMOVE_ZERO(DDNO,'0')        
FROM   LEDGER1 WITH (NOLOCK)        
WHERE  EXISTS (SELECT VTYPE        
               FROM   #VMAST        
               WHERE  LEDGER1.VTYP = VTYPE)        
       AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
       AND CHARINDEX(DBO.REMOVE_ZERO(DDNO,'0'),[DESCRIPTION]) > 0        
       AND CLTCODE = @BANKCODE        
       AND #BANKRECOSAVE.MICRNO = @@MICRNO        
       AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT)        
                                   FROM   LEDGER1 L1 WITH (NOLOCK),        
                                          LEDGER L2 WITH (NOLOCK)        
                                   WHERE  L2.VNO = L1.VNO        
                                          AND L2.VTYP = L1.VTYP        
                                          AND L2.BOOKTYPE = L1.BOOKTYPE        
                                          AND RELDT = ''        
                                          AND CLTCODE = @BANKCODE        
                                          AND CHARINDEX(DBO.REMOVE_ZERO(L1.DDNO,'0'),#BANKRECOSAVE.[DESCRIPTION]) > 0        
                                          AND #BANKRECOSAVE.DRCR = L1.DRCR    
       AND LEN(DBO.REMOVE_ZERO(L1.DDNO,'0')) >= 5)        
       AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO,0)        
       AND LEDGER1.RELDT = ''      
       AND REFERENCENO = '0'         
       AND LEN(DBO.REMOVE_ZERO(DDNO,'0')) >= 5     
  /*********************** New code added to check the referenceno from description column *****************/        
            
            
/*CREATE TABLE #BANKRECOSAVE_DELETE                  
(                  
 [DESCRIPTION] VARCHAR(250),                  
 AMOUNT MONEY,                  
 DRCR CHAR(1),                  
 REFERENCENO VARCHAR(25),                  
CROSSREFERENCENO INT                  
) */                 
              
DECLARE               
@@AMOUNTDIFF MONEY,              
@@STAMOUNTDIFF MONEY,              
@@BOOKDATE_MIN DATETIME,              
@@BOOKDATE_MAX DATETIME              
              
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE               
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE               
              
              
CREATE TABLE #RECODUPS               
(              
 BOOKDATE VARCHAR(11),               
 REFERENCENO VARCHAR(25),               
 AMOUNT MONEY,               
 DESCRIPTION VARCHAR(200),               
 STATUS VARCHAR(10),               
 CROSSREFERENCENO INT              
)              
              
SET @@EXIST_COUNT_BEFORE = 0              
SET @@EXIST_COUNT_AFTER = 0              
              
DECLARE               
@CLTCODE VARCHAR(10),               
@BOOKDATE DATETIME,               
@AMOUNT MONEY,               
@DRCR CHAR(1),               
@VALUEDATE DATETIME,               
@REFERENCENO VARCHAR(20),              
@DESCRIPTION VARCHAR(200)              
              
DECLARE CUR_CHECCK CURSOR FOR              
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0              
              
OPEN CUR_CHECCK              
              
FETCH NEXT FROM CUR_CHECCK              
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION              
              
WHILE @@FETCH_STATUS = 0              
BEGIN              
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
 IF @PROCESS_STATUS = 0               
 BEGIN              
  SELECT @@ERROR_COUNT = 0              
                
  SELECT                
   @@EXIST_COUNT_BEFORE = COUNT(1)              
  FROM               
   BANKRECO              
  WHERE              
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)              
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')              
              
              
                
 /* IF @@ERROR_COUNT > 0              
   BEGIN              
    SELECT                
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS              
    FROM               
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,               
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B              
    WHERE              
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)              
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO              
                
    RETURN              
   END */              
 END              
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
              
               
                
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)              
 FROM #BANKRECOSAVE              
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0                  
               
 DELETE BR FROM #BANKRECOSAVE BR              
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO              
               
               
 IF @PROCESS_STATUS = 0               
 BEGIN              
  SELECT               
   @@EXIST_COUNT_AFTER = COUNT(1)              
  FROM               
   #BANKRECOSAVE              
  WHERE               
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR               
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0                  
                
                
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER              
   BEGIN              
    INSERT INTO #RECODUPS              
    SELECT                
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO              
    FROM               
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR              
    WHERE              
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)              
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')              
                
   END               
  SET @@EXIST_COUNT_BEFORE = 0              
  SET @@EXIST_COUNT_AFTER = 0              
 END               
 FETCH NEXT FROM CUR_CHECCK              
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION              
END              
              
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0                  
              
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS              
              
IF @@ERROR_COUNT > 0              
BEGIN              
 SELECT * FROM #RECODUPS              
 RETURN              
END              
              
              
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
DELETE BR FROM                
 BANKRECO B, #BANKRECOSAVE BR                
WHERE                 
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))                
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')        
   
   
     
     
              
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL              
            
              
IF @@ERROR_COUNT = 0              
BEGIN               
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'               
 RETURN              
END              
                
SELECT               
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)               
FROM              
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,              
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1              
              
              
IF @PROCESS_STATUS = 1              
BEGIN              
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))              
 FROM               
 (              
  SELECT               
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)              
  FROM               
   BANKRECO              
  WHERE               
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE              
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)              
  UNION ALL              
  SELECT               
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)              
  FROM               
   #BANKRECOSAVE              
  WHERE               
   VALUEDATE IS NOT NULL              
                
                
 )B              
END               
ELSE              
BEGIN               
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))              
 FROM               
 (              
  SELECT               
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)              
  FROM               
   BANKRECO              
  WHERE               
  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE              
  UNION ALL              
  SELECT               
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)              
  FROM               
   #BANKRECOSAVE              
  WHERE               
   VALUEDATE IS NOT NULL              
                
                
 )B              
END              
              
              
IF @@AMOUNTDIFF <> @@STAMOUNTDIFF              
BEGIN              
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'              
 RETURN              
END              
              
 DELETE FROM               
  #BANKRECOSAVE              
 WHERE               
  VALUEDATE IS NULL              
              
              
              
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
                  
SET @@TABLE_EXIST = ''                  
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'                  
                  
IF @@TABLE_EXIST = ''                  
BEGIN                  
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))                  
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')                  
END         
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS               
                  
IF @@RECORD_COUNT = 0                  
BEGIN                  
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')                  
END                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS                  
                  
IF @@RECO_STATUS = 'N'                  
BEGIN                  
 BEGIN TRAN                  
 UPDATE RECOPROCESS SET INPROCESS = 'Y'                  
END                  
ELSE                  
BEGIN                  
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'                  
 RETURN                  
END                  
                  
SET @@TABLE_EXIST = ''                  
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'                  
IF @@TABLE_EXIST <> ''                  
BEGIN                  
 DROP TABLE LEDGER_UPDATES                  
END                  
                  
SET @@TABLE_EXIST = ''                  
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'                  
IF @@TABLE_EXIST <> ''                  
BEGIN                  
 DROP TABLE BANKRECOCOMP             
END                  
                  
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)                  
                  
INSERT                  
INTO                  
 V2_UPLOADED_FILES                  
SELECT                  
 @FILENAME,                  
 @FILENAME,                  
 COUNT(1),                  
 'B',                  
 GETDATE(),                  
 @UNAME,                  
 'HDFC_RECO UPLOAD'           
        
               
        
UPDATE                  
 #BANKRECOSAVE                  
SET                  
 STATUS ='MATCHED'                  
FROM                  
 LEDGER1                  
WHERE                  
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )                  
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)                  
 AND  RTRIM(REFERENCENO) = DBO.REMOVE_ZERO(DDNO, '0')        
 AND CLTCODE = @BANKCODE                  
 AND #BANKRECOSAVE.MICRNO = @@MICRNO                  
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO = DBO.REMOVE_ZERO(DDNO, '0') AND #BANKRECOSAVE.DRCR = L1.DRCR)              
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)            
 AND   REFERENCENO  <> '0'                  
                  
IF @@ERROR <> 0                  
BEGIN                  
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'                  
 ROLLBACK TRAN                  
 RETURN                  
END                  
               
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO                  
 LEDGER_UPDATES                  
SELECT                 
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE                  
FROM                  
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)                  
WHERE                  
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')                  
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE                  
 AND LEDGER1.VNO = LEDGER.VNO                  
 AND LEDGER1.VTYP = LEDGER.VTYP                  
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE                  
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)                  
 AND REFERENCENO = DBO.REMOVE_ZERO(DDNO, '0')        
 AND RELDT = ''                  
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE         
 AND #BANKRECOSAVE.MICRNO = @@MICRNO                  
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO = DBO.REMOVE_ZERO
(  
    
    
      
        
DDNO, '0') AND #BANKRECOSAVE.DRCR = L1.DRCR)                  
 AND   REFERENCENO  <> '0'                  
                  
IF @@ERROR <> 0                  
BEGIN                  
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'                  
 ROLLBACK TRAN                  
 RETURN                  
END                  
                  
                  
UPDATE                  
 LEDGER1                  
SET                  
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO                  
FROM                  
 #BANKRECOSAVE, LEDGER (NOLOCK)                  
WHERE                  
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')                  
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)                  
 AND REFERENCENO = DBO.REMOVE_ZERO(DDNO, '0')        
 AND RELDT = ''                  
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE                  
 AND #BANKRECOSAVE.MICRNO = @@MICRNO                  
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO = DBO.REMOVE_ZERO(DDNO, '0') AND #BANKRECOSAVE.DRCR = L1.DRCR)              
 AND REFERENCENO  <> '0'                  
 AND LEDGER.VNO = LEDGER1.VNO                  
 AND LEDGER.VTYP = LEDGER1.VTYP                  
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE                  
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE                  
                  
IF @@ERROR <> 0                  
BEGIN                  
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'                  
 ROLLBACK TRAN                  
 RETURN                  
END                  
                  
                  
SELECT                  
 SUM(RELAMT) AS AMOUNT,                  
 SLIPNO AS SLIPNO,                  
 UPPER(DRCR) AS DRCR,                  
 MICRNO                  
INTO                  
 BANKRECOCOMP                  
FROM                  
 LEDGER1                  
WHERE                  
 MICRNO = @@MICRNO                  
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )                  
 AND SLIPNO <>''                  
GROUP BY                  
 SLIPNO,                  
 DRCR,                  
 MICRNO                  
                  
                  
UPDATE                  
 #BANKRECOSAVE                  
SET                  
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'                  
FROM                  
 BANKRECOCOMP                  
WHERE                  
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)                  
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)                  
  AND #BANKRECOSAVE.MICRNO = @@MICRNO                  
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT                  
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO            
  AND REFERENCENO  <> '0'                  
                  
IF @@ERROR <> 0                  
BEGIN                  
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'                  
 ROLLBACK TRAN                  
 RETURN                  
END                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO LEDGER_UPDATES                  
SELECT                  
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE                  
FROM                  
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)                  
WHERE                  
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )                  
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)                  
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)                  
 AND RELDT = ''                  
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE                  
 AND LEDGER1.VNO = LEDGER.VNO                  
 AND LEDGER1.VTYP = LEDGER.VTYP                  
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE                  
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE                  
 AND #BANKRECOSAVE.MICRNO = @@MICRNO                  
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)            
 AND #BANKRECOSAVE.REFERENCENO  <> '0'                  
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)                  
                  
IF @@ERROR <> 0                  
BEGIN                  
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'                  
 ROLLBACK TRAN                  
 RETURN                  
END                  
                  
                  
UPDATE                  
 LEDGER1                  
SET                  
 RELDT = VALUEDATE ,                  
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO                  
FROM                
 #BANKRECOSAVE, LEDGER  (NOLOCK)                  
WHERE                  
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )                  
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)                  
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)                  
 AND RELDT = ''                  
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE                  
 AND #BANKRECOSAVE.MICRNO = @@MICRNO                  
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)            
 AND #BANKRECOSAVE.REFERENCENO  <> '0'                  
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)                  
 AND LEDGER.VNO = LEDGER1.VNO                  
 AND LEDGER.VTYP = LEDGER1.VTYP                  
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE                  
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE                  
                  
IF @@ERROR <> 0                  
BEGIN                  
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'                  
 ROLLBACK TRAN                  
 RETURN                  
END                  
                  
UPDATE                  
 L                  
SET                  
 EDT = VALUEDATE                  
FROM                  
 LEDGER L, LEDGER_UPDATES LU                  
WHERE                  
 LU.VNO=L.VNO                  
 AND LU.VTYP=L.VTYP                  
 AND LU.BOOKTYPE=L.BOOKTYPE                  
 AND EDT LIKE 'DEC 31 2049%'                  
                  
IF @@ERROR <> 0                  
BEGIN                  
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'                  
 ROLLBACK TRAN                  
 RETURN                  
END                  
                  
UPDATE                  
 L                  
SET                  
 EDT = VDT                  
FROM                  
 LEDGER L, LEDGER_UPDATES LU                  
WHERE                  
 LU.VNO=L.VNO                  
 AND LU.VTYP=L.VTYP                  
 AND LU.BOOKTYPE=L.BOOKTYPE                  
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))                  
                  
IF @@ERROR <> 0                  
BEGIN                  
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'               ROLLBACK TRAN                  
 RETURN                  
END                  
                  
IF @PROCESS_STATUS = 1              
BEGIN              
 DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)              
END              
                  
INSERT INTO                  
 BANKRECO                  
SELECT                  
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,                  
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'                  
FROM                  
 #BANKRECOSAVE B                
            
INSERT INTO                  
 BANKRECO_LOG                  
SELECT                  
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,                  
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0', 0, 'AUTO', GETDATE(), 'MATCHED'             
FROM                  
 #BANKRECOSAVE B                
WHERE            
 B.STATUS = 'MATCHED'            
            
            
            
INSERT INTO LEDGER1_BANKRECO_LOG            
SELECT L1.*, 'AUTO', GETDATE(), 'MATCHED'             
FROM LEDGER1 L1, LEDGER_UPDATES LU            
WHERE L1.VNO = LU.VNO AND L1.VTYP = LU.VTYP AND L1.BOOKTYPE = LU.BOOKTYPE            
            
DROP TABLE BANKRECOCOMP                  
DROP TABLE LEDGER_UPDATES                
            
UPDATE RECOPROCESS SET INPROCESS = 'N'                  
                  
COMMIT TRAN                  
                  
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_ICICI_ALLBANKS_ITI
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_ICICI_ALLBANKS_ITI]    
 @FILENAME VARCHAR(100),          
 @UNAME VARCHAR(100),          
 @BANKCODE VARCHAR(10),          
 @STATUSID VARCHAR(10),          
 @STATUSNAME VARCHAR(100),    
 @BANK_TYPE VARCHAR(10),    
 @STAT_TYPE VARCHAR(10),    
 @LOGIN VARCHAR(10),    
 @PWD VARCHAR(15),    
 @PROCESS_STATUS BIT = 0      
      
          
AS          
          
/*        
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'          
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'          
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'      
SELECT TOP 1 * FROM BANKRECO      
*/        
DECLARE          
 @@SQL_QUERY AS VARCHAR(1000),          
 @@CROSSREFERENCENO INT,          
 @@TABLE_EXIST VARCHAR(20),          
 @@RECORD_COUNT TINYINT,          
 @@RECO_STATUS CHAR(1),          
 @@FILE_EXIST INT,          
 @@CLTCODE_EXIST INT,          
 @@MICRNO VARCHAR(20)          
          
SET NOCOUNT ON          
          
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2          
          
IF @@CLTCODE_EXIST = 0          
 BEGIN          
  SELECT 'BANK CODE DOSE NOT EXIST.'          
  RETURN          
 END          
          
SELECT @@MICRNO = ISNULL(MICRNO, 0) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2          
          
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/          
DECLARE          
 @@ERROR_COUNT SMALLINT,      
 @@EXIST_COUNT_BEFORE SMALLINT,      
 @@EXIST_COUNT_AFTER SMALLINT      
SELECT          
 @@ERROR_COUNT = COUNT(1)          
FROM          
 (          
  SELECT          
   U_FILENAME          
  FROM          
   V2_UPLOADED_FILES          
  WHERE          
   U_FILENAME = @FILENAME          
   AND U_MODULE = 'HDFC_RECO UPLOAD'          
 ) A          
/*IF @@ERROR_COUNT > 0          
BEGIN          
 SELECT          
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'          
 RETURN          
END       */          
          
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO          
    
CREATE TABLE #HDFCRECO      
(    
 BOOKDATE VARCHAR(11)    
)    
    
CREATE TABLE #ICICIRECO      
(    
 SR_NO INT,    
 TXN_ID VARCHAR(25),    
 BOOKDATE VARCHAR(11)    
)    
    
IF @BANK_TYPE = 'CITYRECO'    
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"    
END    
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'     
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"      
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"    
END    
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'    
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"    
END    
ELSE IF @BANK_TYPE = 'ICICIRECO'     
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"    
    
END    
    
EXEC (@@SQL_QUERY)    
    
IF @BANK_TYPE = 'ICICIRECO'     
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD [DESCRIPTION] VARCHAR(100), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"    
    
 EXEC (@@SQL_QUERY)    
END    
    
CREATE TABLE [#BANKRECOSAVE_TEMP]          
 (          
  CLTCODE VARCHAR(10),          
  BOOKDATE DATETIME,          
  [DESCRIPTION] VARCHAR(50),          
  AMOUNT VARCHAR(20),          
  DRCR VARCHAR(1),          
  VALUEDATE DATETIME,          
  REFERENCENO VARCHAR(30),          
  STATUSID VARCHAR(15),          
  STATUSNAME VARCHAR(25),          
  LOGINNAME VARCHAR(25),          
  STATUS VARCHAR(9),          
  MICRNO INT,          
  DUMMY1 VARCHAR(15) ,          
  DUMMY2 VARCHAR(15),          
  AMOUNTLEDGR1 VARCHAR(20),          
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL          
 )          
ON [PRIMARY]          
          
CREATE TABLE [#BANKRECOSAVE]          
 (          
  CLTCODE VARCHAR(10),          
  BOOKDATE DATETIME,          
  [DESCRIPTION] VARCHAR(50),          
  AMOUNT MONEY,          
  DRCR VARCHAR(1),          
  VALUEDATE DATETIME,          
  REFERENCENO VARCHAR(30),          
  STATUSID VARCHAR(15),          
  STATUSNAME VARCHAR(25),          
  LOGINNAME VARCHAR(25),          
  CROSSREFERENCENO [INT],          
  STATUS VARCHAR(9),          
  MICRNO INT,          
  DUMMY1 VARCHAR(15) ,          
  DUMMY2 VARCHAR(15),          
  AMOUNTLEDGR1 MONEY          
 )          
ON [PRIMARY]         
    
CREATE TABLE #TESTIMPORT                    
(                    
 OneRow Varchar(2000),                  
 SNO INT IDENTITY(1,1)                  
)       
    
IF @BANK_TYPE = 'ICICIRECO'    
BEGIN    
 SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"    
     
END    
ELSE IF @BANK_TYPE <> 'CANARARECO'    
BEGIN    
 SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"    
END    
    
--PRINT @@SQL_QUERY    
EXEC (@@SQL_QUERY)     
    
    
    
    
IF @BANK_TYPE = 'CITYRECO'    
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"    
END    
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'     
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "    
END    
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'    
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"    
END    
ELSE IF @BANK_TYPE = 'ICICIRECO'    
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "    
END    
ELSE    
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "    
END    
    
    
EXEC (@@SQL_QUERY)    
    
IF @BANK_TYPE = 'ICICIRECO'    
BEGIN    
 INSERT INTO #HDFCRECO (BOOKDATE,[DESCRIPTION],REFERENCE_NO,DRCR,AMOUNT,RUNNING_BAL) SELECT BOOKDATE,[DESCRIPTION],REFERENCE_NO,DRCR,REPLACE(AMOUNT, ',', ''),RUNNING_BAL FROM #ICICIRECO    
END    
    
SELECT * INTO HDFCRECO FROM #HDFCRECO    
    
    
IF @BANK_TYPE = 'CITYRECO'    
BEGIN    
 UPDATE HDFCRECO SET [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE', VALUEDATE = BOOKDATE    
END    
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'     
BEGIN    
 UPDATE HDFCRECO SET AMOUNT = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN CREDIT ELSE DEBIT END, DRCR = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN 'C' ELSE 'D' END    
END    
ELSE IF @BANK_TYPE = 'ICICIRECO'     
BEGIN    
 UPDATE HDFCRECO SET VALUEDATE = BOOKDATE, DRCR = CASE WHEN DRCR = 'DR' THEN 'D' ELSE 'C' END    
END    
    
IF @BANK_TYPE = 'CANARARECO'     
BEGIN    
 SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"    
   EXEC(@@SQL_QUERY)                    
    
 DELETE FROM #TESTIMPORT WHERE OneRow IS NULL    
 DELETE FROM #TESTIMPORT WHERE OneRow LIKE '****%'    
    
 INSERT INTO #BANKRECOSAVE_TEMP          
 SELECT          
  @BANKCODE,          
  BOOKDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),          
  [DESCRIPTION] = SUBSTRING(OneRow, 18, 23),          
  AMOUNT = SUBSTRING(OneRow, 41, 14),          
  DRCR = SUBSTRING(OneRow, 17, 1),          
  VALUEDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),          
  REFERENCE_NO = SUBSTRING(OneRow, 9, 8),          
  @STATUSID,          
  @STATUSNAME,          
  @UNAME,          
  'UNMATCHED',          
  @@MICRNO,          
  '',          
  '',          
  ''          
 FROM          
  #TESTIMPORT      
END    
ELSE IF @BANK_TYPE = 'ICICIRECO'    
BEGIN    
 INSERT INTO #BANKRECOSAVE_TEMP          
 SELECT          
  @BANKCODE,          
  BOOKDATE = CONVERT(DATETIME,  (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 101),          
  [DESCRIPTION],          
  AMOUNT,          
  DRCR,          
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE, 2) + '-' + SUBSTRING(VALUEDATE, 4, 2)),          
  REFERENCE_NO,          
  @STATUSID,          
  @STATUSNAME,          
  @UNAME,          
  'UNMATCHED',          
  @@MICRNO,          
  '',          
  '',          
  ''          
 FROM          
  HDFCRECO      
    
END    
ELSE    
BEGIN    
 INSERT INTO #BANKRECOSAVE_TEMP          
 SELECT          
  @BANKCODE,          
  BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),          
  [DESCRIPTION],          
  AMOUNT,          
  DRCR,          
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),          
  REFERENCE_NO,          
  @STATUSID,          
  @STATUSNAME,          
  @UNAME,          
  'UNMATCHED',          
  @@MICRNO,          
  '',          
  '',          
  ''          
 FROM          
  HDFCRECO      
END    
    
    
DROP TABLE HDFCRECO    
    
    
INSERT INTO #BANKRECOSAVE          
SELECT          
 @BANKCODE,          
 BOOKDATE,        
 [DESCRIPTION],          
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,          
 DRCR,          
 VALUEDATE,          
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),             
 @STATUSID,          
 @STATUSNAME,          
 @UNAME,          
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),          
 'UNMATCHED',          
 @@MICRNO,          
 '',          
 '',          
 0          
FROM          
 #BANKRECOSAVE_TEMP          
WHERE     
 REFERENCENO NOT LIKE '%[A-Z]%'    
    
INSERT INTO #BANKRECOSAVE          
SELECT          
 @BANKCODE,          
 BOOKDATE,        
 [DESCRIPTION],          
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,          
 DRCR,          
 VALUEDATE,          
 ISNULL(REFERENCENO, 0),          
 @STATUSID,          
 @STATUSNAME,          
 @UNAME,          
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),          
 'UNMATCHED',          
 @@MICRNO,          
 '',          
 '',          
 0          
FROM          
 #BANKRECOSAVE_TEMP          
WHERE     
 REFERENCENO LIKE '%[A-Z]%'    
    
INSERT INTO #BANKRECOSAVE          
SELECT          
 @BANKCODE,          
 BOOKDATE,        
 [DESCRIPTION],          
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,          
 DRCR,          
 VALUEDATE,          
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),          
 @STATUSID,          
 @STATUSNAME,          
 @UNAME,          
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),          
 'UNMATCHED',          
 @@MICRNO,          
 '',          
 '',          
 0          
FROM          
 #BANKRECOSAVE_TEMP          
WHERE     
 REFERENCENO IS NULL    
    
    
IF @BANK_TYPE = 'CANARARECO'    
BEGIN    
 UPDATE #BANKRECOSAVE SET AMOUNT = CONVERT(MONEY, AMOUNT / 100)     
END    
    
    
    
/*CREATE TABLE #BANKRECOSAVE_DELETE          
(          
 [DESCRIPTION] VARCHAR(250),          
 AMOUNT MONEY,          
 DRCR CHAR(1),          
 REFERENCENO VARCHAR(25),          
CROSSREFERENCENO INT          
) */         
      
DECLARE       
@@AMOUNTDIFF MONEY,      
@@STAMOUNTDIFF MONEY,      
@@BOOKDATE_MIN DATETIME,      
@@BOOKDATE_MAX DATETIME      
      
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE       
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE       
      
      
CREATE TABLE #RECODUPS       
(      
 BOOKDATE VARCHAR(11),       
 REFERENCENO VARCHAR(25),       
 AMOUNT MONEY,       
 DESCRIPTION VARCHAR(200),       
 STATUS VARCHAR(10),       
 CROSSREFERENCENO INT      
)      
      
SET @@EXIST_COUNT_BEFORE = 0      
SET @@EXIST_COUNT_AFTER = 0      
      
DECLARE       
@CLTCODE VARCHAR(10),       
@BOOKDATE DATETIME,       
@AMOUNT MONEY,       
@DRCR CHAR(1),       
@VALUEDATE DATETIME,       
@REFERENCENO VARCHAR(20),      
@DESCRIPTION VARCHAR(200)      
      
DECLARE CUR_CHECCK CURSOR FOR      
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0      
      
OPEN CUR_CHECCK      
      
FETCH NEXT FROM CUR_CHECCK      
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION      
      
WHILE @@FETCH_STATUS = 0      
BEGIN      
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
 IF @PROCESS_STATUS = 0       
 BEGIN      
  SELECT @@ERROR_COUNT = 0      
        
  SELECT        
   @@EXIST_COUNT_BEFORE = COUNT(1)      
  FROM       
   BANKRECO      
  WHERE      
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)      
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')      
      
      
        
 /* IF @@ERROR_COUNT > 0      
   BEGIN      
    SELECT        
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS      
    FROM       
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,       
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B      
    WHERE      
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)      
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO      
        
    RETURN      
   END */      
 END      
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
      
       
           
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)      
 FROM #BANKRECOSAVE      
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0          
       
 DELETE BR FROM #BANKRECOSAVE BR      
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO      
       
       
 IF @PROCESS_STATUS = 0       
 BEGIN      
  SELECT       
   @@EXIST_COUNT_AFTER = COUNT(1)      
  FROM       
   #BANKRECOSAVE      
  WHERE       
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR       
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0          
        
        
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER      
   BEGIN      
    INSERT INTO #RECODUPS      
    SELECT        
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO      
    FROM       
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR      
    WHERE      
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)      
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')      
        
   END       
  SET @@EXIST_COUNT_BEFORE = 0      
  SET @@EXIST_COUNT_AFTER = 0      
 END       
 FETCH NEXT FROM CUR_CHECCK      
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION      
END      
      
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0          
      
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS      
      
IF @@ERROR_COUNT > 0      
BEGIN      
 SELECT * FROM #RECODUPS      
 RETURN      
END      
      
      
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
DELETE BR FROM        
 BANKRECO B, #BANKRECOSAVE BR        
WHERE         
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))        
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')      
      
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL      
    
      
IF @@ERROR_COUNT = 0      
BEGIN       
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'       
 RETURN      
END      
        
SELECT       
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)       
FROM      
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,      
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1      
      
      
IF @PROCESS_STATUS = 1      
BEGIN      
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))      
 FROM       
 (      
  SELECT       
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)      
  FROM       
   BANKRECO      
  WHERE       
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE      
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)      
  UNION ALL      
  SELECT       
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)      
  FROM       
   #BANKRECOSAVE      
  WHERE       
   VALUEDATE IS NOT NULL      
        
        
 )B      
END       
ELSE      
BEGIN       
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))      
 FROM       
 (      
  SELECT       
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)      
  FROM       
   BANKRECO      
  WHERE       
  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE      
  UNION ALL      
  SELECT       
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)      
  FROM       
   #BANKRECOSAVE      
  WHERE       
   VALUEDATE IS NOT NULL      
        
        
 )B      
END      
      
      
IF @@AMOUNTDIFF <> @@STAMOUNTDIFF      
BEGIN      
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'      
 RETURN      
END      
      
 DELETE FROM       
  #BANKRECOSAVE      
 WHERE       
  VALUEDATE IS NULL      
      
      
      
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
          
SET @@TABLE_EXIST = ''          
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'          
          
IF @@TABLE_EXIST = ''          
BEGIN          
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))          
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')          
END          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS          
          
IF @@RECORD_COUNT = 0          
BEGIN          
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')          
END          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS          
          
IF @@RECO_STATUS = 'N'          
BEGIN          
 BEGIN TRAN          
 UPDATE RECOPROCESS SET INPROCESS = 'Y'          
END          
ELSE          
BEGIN          
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'          
 RETURN          
END          
          
SET @@TABLE_EXIST = ''          
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'          
IF @@TABLE_EXIST <> ''          
BEGIN          
 DROP TABLE LEDGER_UPDATES          
END          
          
SET @@TABLE_EXIST = ''          
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'          
IF @@TABLE_EXIST <> ''          
BEGIN          
 DROP TABLE BANKRECOCOMP          
END          
          
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)          
          
INSERT          
INTO          
 V2_UPLOADED_FILES          
SELECT          
 @FILENAME,          
 @FILENAME,          
 COUNT(1),          
 'B',          
 GETDATE(),          
 @UNAME,          
 'HDFC_RECO UPLOAD'          
          
          
UPDATE          
 #BANKRECOSAVE          
SET          
 STATUS ='MATCHED'          
FROM          
 LEDGER1          
WHERE          
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )          
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)          
 AND  RTRIM(REFERENCENO) = DBO.REMOVE_ZERO(DDNO, '0')
 AND CLTCODE = @BANKCODE          
 AND #BANKRECOSAVE.MICRNO = @@MICRNO          
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO = DBO.REMOVE_ZERO(DDNO, '0') AND #BANKRECOSAVE.DRCR = L1.DRCR)      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)    
 AND   REFERENCENO  <> '0'          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'          
 ROLLBACK TRAN          
 RETURN          
END          
          
          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO          
 LEDGER_UPDATES          
SELECT         
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE          
FROM          
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)          
WHERE          
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')          
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE          
 AND LEDGER1.VNO = LEDGER.VNO          
 AND LEDGER1.VTYP = LEDGER.VTYP          
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE          
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)          
 AND REFERENCENO = DBO.REMOVE_ZERO(DDNO, '0')
 AND RELDT = ''          
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE          
 AND #BANKRECOSAVE.MICRNO = @@MICRNO          
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)    
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO = DBO.REMOVE_ZERO(DDNO, '0') AND #BANKRECOSAVE.DRCR = L1.DRCR)          
 AND   REFERENCENO  <> '0'          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'          
 ROLLBACK TRAN          
 RETURN          
END          
          
          
UPDATE          
 LEDGER1          
SET          
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO          
FROM          
 #BANKRECOSAVE, LEDGER (NOLOCK)          
WHERE          
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')          
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)          
 AND REFERENCENO = DBO.REMOVE_ZERO(DDNO, '0')
 AND RELDT = ''          
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE          
 AND #BANKRECOSAVE.MICRNO = @@MICRNO          
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)    
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO = DBO.REMOVE_ZERO(DDNO, '0') AND #BANKRECOSAVE.DRCR = L1.DRCR)      
 AND REFERENCENO  <> '0'          
 AND LEDGER.VNO = LEDGER1.VNO          
 AND LEDGER.VTYP = LEDGER1.VTYP          
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE          
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'          
 ROLLBACK TRAN          
 RETURN          
END          
          
          
SELECT          
 SUM(RELAMT) AS AMOUNT,          
 SLIPNO AS SLIPNO,          
 UPPER(DRCR) AS DRCR,          
 MICRNO          
INTO          
 BANKRECOCOMP          
FROM          
 LEDGER1          
WHERE          
 MICRNO = @@MICRNO          
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )          
 AND SLIPNO <>''          
GROUP BY          
 SLIPNO,          
 DRCR,          
 MICRNO          
          
          
UPDATE          
 #BANKRECOSAVE          
SET          
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'          
FROM          
 BANKRECOCOMP          
WHERE          
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)          
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)          
  AND #BANKRECOSAVE.MICRNO = @@MICRNO          
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT          
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO          
  AND REFERENCENO  <> '0'          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'          
 ROLLBACK TRAN          
 RETURN          
END          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO LEDGER_UPDATES          
SELECT          
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE          
FROM          
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)          
WHERE          
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )          
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)          
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)          
 AND RELDT = ''          
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE          
 AND LEDGER1.VNO = LEDGER.VNO          
 AND LEDGER1.VTYP = LEDGER.VTYP          
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE          
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE          
 AND #BANKRECOSAVE.MICRNO = @@MICRNO          
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)    
 AND #BANKRECOSAVE.REFERENCENO  <> '0'          
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'          
 ROLLBACK TRAN          
 RETURN          
END          
          
          
UPDATE          
 LEDGER1          
SET          
 RELDT = VALUEDATE ,          
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO          
FROM          
 #BANKRECOSAVE, LEDGER  (NOLOCK)          
WHERE          
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )          
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)          
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)          
 AND RELDT = ''          
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE          
 AND #BANKRECOSAVE.MICRNO = @@MICRNO          
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)    
 AND #BANKRECOSAVE.REFERENCENO  <> '0'          
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)          
 AND LEDGER.VNO = LEDGER1.VNO          
 AND LEDGER.VTYP = LEDGER1.VTYP          
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE          
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'          
 ROLLBACK TRAN          
 RETURN          
END          
          
UPDATE          
 L          
SET          
 EDT = VALUEDATE          
FROM          
 LEDGER L, LEDGER_UPDATES LU          
WHERE          
 LU.VNO=L.VNO          
 AND LU.VTYP=L.VTYP          
 AND LU.BOOKTYPE=L.BOOKTYPE          
 AND EDT LIKE 'DEC 31 2049%'          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'          
 ROLLBACK TRAN          
 RETURN          
END          
          
UPDATE          
 L          
SET          
 EDT = VDT          
FROM          
 LEDGER L, LEDGER_UPDATES LU          
WHERE          
 LU.VNO=L.VNO          
 AND LU.VTYP=L.VTYP          
 AND LU.BOOKTYPE=L.BOOKTYPE          
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'          
 ROLLBACK TRAN          
 RETURN          
END          
          
IF @PROCESS_STATUS = 1      
BEGIN      
 DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)      
END      
          
INSERT INTO          
 BANKRECO          
SELECT          
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,          
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'          
FROM          
 #BANKRECOSAVE B        
    
INSERT INTO          
 BANKRECO_LOG          
SELECT          
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,          
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0', 0, 'AUTO', GETDATE(), 'MATCHED'     
FROM          
 #BANKRECOSAVE B        
WHERE    
 B.STATUS = 'MATCHED'    
    
    
    
INSERT INTO LEDGER1_BANKRECO_LOG    
SELECT L1.*, 'AUTO', GETDATE(), 'MATCHED'     
FROM LEDGER1 L1, LEDGER_UPDATES LU    
WHERE L1.VNO = LU.VNO AND L1.VTYP = LU.VTYP AND L1.BOOKTYPE = LU.BOOKTYPE    
    
DROP TABLE BANKRECOCOMP          
DROP TABLE LEDGER_UPDATES        
    
UPDATE RECOPROCESS SET INPROCESS = 'N'          
          
COMMIT TRAN          
          
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_SBI_ALLBANKS
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_SBI_ALLBANKS]
 @FILENAME VARCHAR(100),      
 @UNAME VARCHAR(100),      
 @BANKCODE VARCHAR(10),      
 @STATUSID VARCHAR(10),      
 @STATUSNAME VARCHAR(100),
 @BANK_TYPE VARCHAR(10),
 @STAT_TYPE VARCHAR(10),
 @LOGIN VARCHAR(10),
 @PWD VARCHAR(15),
 @PROCESS_STATUS BIT = 0  
  
      
AS      
      
/*    
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'      
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'      
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'  
SELECT TOP 1 * FROM BANKRECO  
*/    
DECLARE      
 @@SQL_QUERY AS VARCHAR(1000),      
 @@CROSSREFERENCENO INT,      
 @@TABLE_EXIST VARCHAR(20),      
 @@RECORD_COUNT TINYINT,      
 @@RECO_STATUS CHAR(1),      
 @@FILE_EXIST INT,      
 @@CLTCODE_EXIST INT,      
 @@MICRNO VARCHAR(20)      
      
SET NOCOUNT ON      
      
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
IF @@CLTCODE_EXIST = 0      
 BEGIN      
  SELECT 'BANK CODE DOSE NOT EXIST.'      
  RETURN      
 END      
      
SELECT @@MICRNO = ISNULL(MICRNO, 0) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
DECLARE      
 @@ERROR_COUNT SMALLINT,  
 @@EXIST_COUNT_BEFORE SMALLINT,  
 @@EXIST_COUNT_AFTER SMALLINT  
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT      
   U_FILENAME      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FILENAME      
   AND U_MODULE = 'HDFC_RECO UPLOAD'      
 ) A      
/*IF @@ERROR_COUNT > 0      
BEGIN      
 SELECT      
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'      
 RETURN      
END       */      
      
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO      

CREATE TABLE #HDFCRECO  
(
	BOOKDATE VARCHAR(11)
)

CREATE TABLE #ICICIRECO  
(
	SR_NO INT,
	TXN_ID VARCHAR(25),
	BOOKDATE VARCHAR(11)
)



IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"  
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"

END

ELSE IF @BANK_TYPE = 'SBIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11)"

END

EXEC (@@SQL_QUERY)

IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"

	EXEC (@@SQL_QUERY)
END

CREATE TABLE [#BANKRECOSAVE_TEMP]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(100),      
  AMOUNT VARCHAR(20),      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 VARCHAR(20),      
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL      
 )      
ON [PRIMARY]      
      
CREATE TABLE [#BANKRECOSAVE]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(100),      
  AMOUNT MONEY,      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  CROSSREFERENCENO [INT],      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 MONEY      
 )      
ON [PRIMARY]     

CREATE TABLE #TESTIMPORT                
(                
	OneRow Varchar(2000),              
	SNO INT IDENTITY(1,1)              
)   

IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"
	
END
ELSE IF @BANK_TYPE <> 'CANARARECO'
BEGIN
	SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"
END

--PRINT @@SQL_QUERY
EXEC (@@SQL_QUERY) 


IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "
END
ELSE IF @BANK_TYPE = 'SBIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"  
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "
END
ELSE
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "
END


EXEC (@@SQL_QUERY)

SELECT * INTO HDFCRECO FROM #HDFCRECO

IF @BANK_TYPE = 'CITYRECO'
BEGIN
	UPDATE HDFCRECO SET [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE', VALUEDATE = BOOKDATE
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' OR @BANK_TYPE = 'SBIRECO'
BEGIN
	UPDATE HDFCRECO SET AMOUNT = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN CREDIT ELSE DEBIT END, DRCR = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN 'C' ELSE 'D' END
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	UPDATE HDFCRECO SET VALUEDATE = BOOKDATE, DRCR = CASE WHEN DRCR = 'DR' THEN 'D' ELSE 'C' END
END

IF @BANK_TYPE = 'CANARARECO' 
BEGIN
	SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"
  	EXEC(@@SQL_QUERY)                

	DELETE FROM #TESTIMPORT WHERE OneRow IS NULL
	DELETE FROM #TESTIMPORT WHERE OneRow LIKE '****%'

	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 @BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),      
	 [DESCRIPTION] = SUBSTRING(OneRow, 18, 23),      
	 AMOUNT = SUBSTRING(OneRow, 41, 14),      
	 DRCR = SUBSTRING(OneRow, 17, 1),      
	 VALUEDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),      
	 REFERENCE_NO = SUBSTRING(OneRow, 9, 8),      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 @@MICRNO,      
	 '',      
	 '',      
	 ''      
	FROM      
	 #TESTIMPORT  
END
ELSE IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 @BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME,  (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 101),      
	 [DESCRIPTION],      
	 AMOUNT,      
	 DRCR,      
	 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE, 2) + '-' + SUBSTRING(VALUEDATE, 4, 2)),      
	 REFERENCE_NO,      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 @@MICRNO,      
	 '',      
	 '',      
	 ''      
	FROM      
	 HDFCRECO  

END
ELSE
BEGIN
	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 @BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),      
	 [DESCRIPTION],      
	 AMOUNT,      
	 DRCR,      
	 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),      
	 REFERENCE_NO,      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 @@MICRNO,      
	 '',      
	 '',      
	 ''      
	FROM      
	 HDFCRECO  
END

DROP TABLE HDFCRECO


INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO NOT LIKE '%[A-Z]%'

INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO,      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO LIKE '%[A-Z]%'

INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],     
AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO IS NULL



IF @BANK_TYPE = 'CANARARECO'
BEGIN
	UPDATE #BANKRECOSAVE SET AMOUNT = CONVERT(MONEY, AMOUNT / 100)	
END




/*CREATE TABLE #BANKRECOSAVE_DELETE      
(      
 [DESCRIPTION] VARCHAR(250),      
 AMOUNT MONEY,      
 DRCR CHAR(1),      
 REFERENCENO VARCHAR(25),      
CROSSREFERENCENO INT      
) */     
  
DECLARE   
@@AMOUNTDIFF MONEY,  
@@STAMOUNTDIFF MONEY,  
@@BOOKDATE_MIN DATETIME,  
@@BOOKDATE_MAX DATETIME  
  
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE   
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE   
  
  
CREATE TABLE #RECODUPS   
(  
 BOOKDATE VARCHAR(11),   
 REFERENCENO VARCHAR(25),   
 AMOUNT MONEY,   
 DESCRIPTION VARCHAR(200),   
 STATUS VARCHAR(10),   
 CROSSREFERENCENO INT  
)  
  
SET @@EXIST_COUNT_BEFORE = 0  
SET @@EXIST_COUNT_AFTER = 0  
  
DECLARE   
@CLTCODE VARCHAR(10),   
@BOOKDATE DATETIME,   
@AMOUNT MONEY,   
@DRCR CHAR(1),   
@VALUEDATE DATETIME,   
@REFERENCENO VARCHAR(20),  
@DESCRIPTION VARCHAR(200)  
  
DECLARE CUR_CHECCK CURSOR FOR  
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0  
  
OPEN CUR_CHECCK  
  
FETCH NEXT FROM CUR_CHECCK  
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
 IF @PROCESS_STATUS = 0   
 BEGIN  
  SELECT @@ERROR_COUNT = 0  
    
  SELECT    
   @@EXIST_COUNT_BEFORE = COUNT(1)  
  FROM   
   BANKRECO  
  WHERE  
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)  
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')  
  
  
    
 /* IF @@ERROR_COUNT > 0  
   BEGIN  
    SELECT    
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS  
    FROM   
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,   
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B  
    WHERE  
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)  
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO  
    
    RETURN  
   END */  
 END  
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
  
   
       
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)  
 FROM #BANKRECOSAVE  
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0      
   
 DELETE BR FROM #BANKRECOSAVE BR  
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO  
   
   
 IF @PROCESS_STATUS = 0   
 BEGIN  
  SELECT   
   @@EXIST_COUNT_AFTER = COUNT(1)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR   
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0      
    
    
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER  
   BEGIN  
    INSERT INTO #RECODUPS  
    SELECT    
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO  
    FROM   
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR  
    WHERE  
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)  
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')  
    
   END   
  SET @@EXIST_COUNT_BEFORE = 0  
  SET @@EXIST_COUNT_AFTER = 0  
 END   
 FETCH NEXT FROM CUR_CHECCK  
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION  
END  
  
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0      
  
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS  
  
IF @@ERROR_COUNT > 0  
BEGIN  
 SELECT * FROM #RECODUPS  
 RETURN  
END  
  
  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
DELETE BR FROM    
 BANKRECO B, #BANKRECOSAVE BR    
WHERE     
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))    
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')  
  
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL  

  
IF @@ERROR_COUNT = 0  
BEGIN   
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'   
 RETURN  
END  
    
SELECT   
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)   
FROM  
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,  
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1  
  
  
IF @PROCESS_STATUS = 1  
BEGIN  
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))  
 FROM   
 (  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   BANKRECO  
  WHERE   
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE  
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)  
  UNION ALL  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   VALUEDATE IS NOT NULL  
    
    
 )B  
END   
ELSE  
BEGIN   
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))  
 FROM   
 (  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   BANKRECO  
  WHERE   
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE  
  UNION ALL  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   VALUEDATE IS NOT NULL  
    
    
 )B  
END  
  
  
IF @@AMOUNTDIFF <> @@STAMOUNTDIFF  
BEGIN  
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'  
 RETURN  
END  
  
 DELETE FROM   
  #BANKRECOSAVE  
 WHERE   
  VALUEDATE IS NULL  
  
  
  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'      
      
IF @@TABLE_EXIST = ''      
BEGIN      
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS      
      
IF @@RECORD_COUNT = 0      
BEGIN      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS      
      
IF @@RECO_STATUS = 'N'      
BEGIN      
 BEGIN TRAN      
 UPDATE RECOPROCESS SET INPROCESS = 'Y'      
END      
ELSE      
BEGIN      
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'      
 RETURN      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE LEDGER_UPDATES      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE BANKRECOCOMP      
END      
      
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)      
      
INSERT      
INTO      
 V2_UPLOADED_FILES      
SELECT      
 @FILENAME,      
 @FILENAME,      
 COUNT(1),      
 'B',      
 GETDATE(),      
 @UNAME,      
 'HDFC_RECO UPLOAD'      
      
      
UPDATE      
 #BANKRECOSAVE      
SET      
 STATUS ='MATCHED'      
FROM      
 LEDGER1      
WHERE      
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)      
 AND CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109) >= CONVERT(VARCHAR(11), VDT, 109))     
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND   REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
INSERT INTO      
 LEDGER_UPDATES      
SELECT     
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE      
FROM      
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')      
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE      
 AND LEDGER1.VNO = LEDGER.VNO      
 AND LEDGER1.VTYP = LEDGER.VTYP      
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND DDNO =  REFERENCENO      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
 AND CONVERT(VARCHAR(11), #BANKRECOSAVE.AMOUNT, 109) >= CONVERT(VARCHAR(11), LEDGER.VDT, 109)
 AND   REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
UPDATE      
 LEDGER1      
SET      
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
FROM      
 #BANKRECOSAVE, LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND DDNO =  REFERENCENO      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      




 AND REFERENCENO  <> '0'      
 AND LEDGER.VNO = LEDGER1.VNO      
 AND LEDGER.VTYP = LEDGER1.VTYP    
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE      
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE      
 AND CONVERT(VARCHAR(11), LEDGER.VDT, 109) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 109)
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
SELECT      
 SUM(RELAMT) AS AMOUNT,      
 SLIPNO AS SLIPNO,      
 UPPER(DRCR) AS DRCR,      
 MICRNO      
INTO      
 BANKRECOCOMP      
FROM      
 LEDGER1      
WHERE      
 MICRNO = @@MICRNO      
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )      
 AND SLIPNO <>''      
GROUP BY      
 SLIPNO,      
 DRCR,      
 MICRNO      
      
      
UPDATE      
 #BANKRECOSAVE      
SET      
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'      
FROM      
 BANKRECOCOMP      
WHERE      
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)      
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)      
  AND #BANKRECOSAVE.MICRNO = @@MICRNO      
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT      
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO      
  AND REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
INSERT INTO LEDGER_UPDATES      
SELECT      
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE      
FROM      
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE      
 AND LEDGER1.VNO = LEDGER.VNO      
 AND LEDGER1.VTYP = LEDGER.VTYP      
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.REFERENCENO  <> '0'      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
UPDATE      
 LEDGER1      
SET      
 RELDT = VALUEDATE ,      
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
FROM      
 #BANKRECOSAVE, LEDGER  (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.REFERENCENO  <> '0'      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
 AND LEDGER.VNO = LEDGER1.VNO      
 AND LEDGER.VTYP = LEDGER1.VTYP      
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE      
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
UPDATE      
 L      
SET      
 EDT = VALUEDATE      
FROM      
 LEDGER L, LEDGER_UPDATES LU      
WHERE      
 LU.VNO=L.VNO      
 AND LU.VTYP=L.VTYP      
 AND LU.BOOKTYPE=L.BOOKTYPE      
 AND EDT LIKE 'DEC 31 2049%'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'      
 ROLLBACK TRAN      
 RETURN      
END      
      
UPDATE      
 L      
SET      
 EDT = VDT      
FROM      
 LEDGER L, LEDGER_UPDATES LU      
WHERE      
 LU.VNO=L.VNO      
 AND LU.VTYP=L.VTYP      
 AND LU.BOOKTYPE=L.BOOKTYPE      
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
IF @PROCESS_STATUS = 1  
BEGIN  
 DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)  
END  
      
INSERT INTO      
 BANKRECO  
(Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,Status,Micrno,Dummy1,Dummy2)    
SELECT      
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,      
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'      
FROM      
 #BANKRECOSAVE B    

INSERT INTO      
 BANKRECO_LOG      
SELECT      
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,      
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0', 0, 'AUTO', GETDATE(), 'MATCHED' 
FROM      
 #BANKRECOSAVE B    
WHERE
 B.STATUS = 'MATCHED'



INSERT INTO LEDGER1_BANKRECO_LOG
SELECT L1.*, 'AUTO', GETDATE(), 'MATCHED' 
FROM LEDGER1 L1, LEDGER_UPDATES LU
WHERE L1.VNO = LU.VNO AND L1.VTYP = LU.VTYP AND L1.BOOKTYPE = LU.BOOKTYPE

DROP TABLE BANKRECOCOMP      
DROP TABLE LEDGER_UPDATES    

UPDATE RECOPROCESS SET INPROCESS = 'N'      
      
COMMIT TRAN      
      
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bak_rpt_Acc_GLREPORT_250908
-- --------------------------------------------------
--Exec rpt_Acc_GlReport '01/04/2006', '31/03/2007', 'Jan  1 2007', 'Feb  1 2007', '0', '9', 'broker', 'gog', 'HO','vdt', 'Account', 'VDT', 'GL',''  
  
  
CREATE  Proc [dbo].[bak_rpt_Acc_GLREPORT_250908]  
 @sdate varchar(11),            /* As mmm dd yyyy */  
 @edate varchar(11),            /* As mmm dd yyyy */  
 @fdate varchar(11),            /* As mmm dd yyyy */  
 @tdate varchar(11),            /* As mmm dd yyyy */  
 @fcode varchar(10),  
 @tcode varchar(10),  
 @statusId varchar(30),  
 @statusname varchar(30),  
 @branch varchar(10),  
 @selectionby varchar(3),  
 @GroupBy varchar(10),  
 @Sortby varchar(50),  
 @reportname varchar(30),  
 @reportopt varchar(10)  
  
AS  
  
declare  
 @@opendate as varchar(11)  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18' and vdt <= @fdate  
  
  
Select cltcode,vamt as opbal into #opbal from ledger  where 1 =2  
  
  
CREATE TABLE [dbo].[#temptable_gl] (      
  [booktype] [char] (2)  NULL ,      
  [voudt1] [varchar] (20) NULL ,      
  [effdt1] [varchar] (20) NULL ,      
  [shortdesc] [char] (6) NULL ,      
  [dramt] [money] NULL ,      
  [cramt] [money] NULL ,      
  [vno] [varchar] (12) NULL ,      
  [Narration] [varchar] (234) NULL ,  
  [ddno] [varchar] (15) NULL ,      
  [cltcode] [varchar] (10) NOT NULL ,  
  [Longname] [varchar] (100) NULL ,  
  [vdt] [datetime] NULL ,        
  [vtyp] [smallint] NULL ,      
  [accat] [varchar] (30) NULL ,      
  [opbal] [money] NULL ,      
  [crosac] [varchar] (10) NULL ,      
  [Acname] [varchar] (150) NULL ,   
  [Branchcode] [varchar] (20) NULL ,  
  [LNO][smallint] NULL,  
    
  
 ) ON [PRIMARY]    
  
  
  
  
  
  
  
  
--Select  
-- l.booktype,--  
-- voudt1=l.vdt,--  
-- effdt1=l.edt,--  
-- isnull(shortdesc,'') shortdesc,--  
-- dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),--  
-- cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),--  
-- l.vno,--  
-- Replace( l.narration,'"','') narration,--  
-- ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),--  
-- l.cltcode,--  
-- a.longname,--  
-- vdt,--  
-- l.vtyp,--  
-- accat,--  
-- Vamt as opbal,--  
-- crosac=l.cltcode,--  
-- isnull(a.acname,'') acname,--  
-- isnull(a.branchcode,'') branchcode,  
-- lno  
--into  
-- #temptable_gl  
--From  
-- Ledger l,  
-- Acmast a,  
-- Vmast v  
--where  
-- 1 = 2  
  
  
if @selectionby = 'vdt'  
 BEGIN  
  if rtrim(@branch) = '' or rtrim(@branch) = '%'  
   BEGIN  
    Insert into #opbal  
    Select  
     cltcode,  
     sum(case drcr when 'D' then vamt else -vamt end) as opbal  
    from  
     ledger  
    where  
     cltcode between @fcode and @tcode  
     and vdt between @@opendate and @fdate  
    Group by cltcode  
    Order by cltcode  
  
    Insert into #temptable_gl  
    Select  
     l.booktype,  
     voudt1=l.vdt,  
     effdt1=l.edt,  
     isnull(shortdesc,'') shortdesc,  
     dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  
     cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),  
     l.vno,  
     Replace( l.narration,'"','') narration,  
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),  
     l.cltcode,  
     a.longname,  
     vdt,  
     l.vtyp,  
     accat,  
     opbal=0,  
     crosac='',  
     a.acname,  
     a.branchcode,  
     l.lno  
    from  
     Ledger l,  
     Acmast a,  
     Vmast v  
    Where  
     l.vdt between @fdate and @tdate + ' 23:59:59'  
     And vtyp = vtype  
     and l.cltcode = a.cltcode  
     and l.cltcode between @fcode and @tcode  
     and (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')  
    Order by  
     l.cltcode,  
     voudt1,  
     l.vtyp desc,  
     l.vno  
   END  
  ELSE  
   BEGIN  
    insert into #opbal  
    Select  
     l2.cltcode,  
     sum(case l2.drcr when 'D' then camt else -camt end) as opbal  
    from  
     ledger2 l2,  
     ledger l  
    where  
     l2.cltcode between @fcode and @tcode  
     and l.vtyp=l2.vtype  
     and l.booktype=l2.booktype  
     and l.vno=l2.vno  
     and l.lno=l2.lno  
     and vdt between @@opendate and @fdate  
    Group by l2.cltcode  
    Order by l2.cltcode  
  
    insert into #temptable_gl  
    Select  
     l.booktype,  
     voudt1=l.vdt,  
     effdt1=l.edt,  
     isnull(shortdesc,'') shortdesc,  
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),  
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),  
     l.vno,  
     Replace( l.narration,'"','') narration,  
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),  
     l2.cltcode,  
     a.longname,  
     vdt,  
     l.vtyp,  
     accat,  
     opbal=0,  
     crosac='',  
     a.acname,  
     a.branchcode,  
     l.lno  
    from  
     ledger l,  
     vmast v,  
     ledger2 l2,  
     acmast a,  
     costmast c  
    Where  
     l.vdt between @fdate and @tdate + ' 23:59:59'  
     and l.vtyp = l2.vtype  
     and  l.vno = l2.vno  
     and l.lno = l2.lno  
     and l.booktype = l2.booktype  
     and l2.cltcode=a.cltcode  
     and l.vtyp = v.vtype  
     and l2.cltcode between @fcode and  @tcode  
     and a.accat <> '4'  
     and costname = rtrim(@branch)  
     and l2.costcode = c.costcode  
     and  l2.vtype <> 18  
    order by  
     l2.cltcode,  
     voudt1,  
     l.vtyp desc,  
     l.vno  
   END  
 END  
ELSE  
 BEGIN  
  if rtrim(@branch) = '' or rtrim(@branch) = '%'  
   BEGIN  
    insert into #opbal  
    Select  
     cltcode,  
     sum(opbal) opbal  
    from  
     (  
      Select  
       Cltcode,  
       sum(case drcr when 'D' then vamt else -vamt end) as opbal  
      from  
       ledger  
      where  
       Cltcode between @fcode and @tcode  
       and vdt between @@opendate and @fdate  
      Group by  
       Cltcode  
     union ALL  
      Select  
       cltcode,  
       sum(case drcr when 'C' then vamt else -vamt end) as opbal  
      from  
       ledger  
      Where  
       cltcode between  @fcode and  @tcode  
       and vdt < @@opendate  
       and edt >= @@opendate  
       Group by cltcode  
     ) t  
    Group by cltcode  
    Order by cltcode  
  
    insert into #temptable_gl  
    Select  
     l.booktype,  
     voudt1=l.vdt,  
     effdt1=l.edt,  
     isnull(shortdesc,'') shortdesc,  
     dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  
     cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),  
     l.vno,  
     Replace( l.narration,'"','') narration,  
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),  
     l.cltcode,  
     a.longname,  
     vdt,  
     l.vtyp,  
     accat,  
     opbal=0,  
     crosac='',  
     a.acname,  
     a.branchcode,  
     l.lno  
    from  
     Ledger l,  
     acmast a,  
     vmast v  
    Where  
     vtyp = vtype  
     and a.cltcode = l.cltcode  
     and l.cltcode between @fcode and @tcode  
     and  l.edt between @fdate and @tdate + ' 23:59:59'  
     and l.vtyp <> 18  
     and (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')  
    order by  
     l.cltcode,  
     voudt1,  
     l.vtyp desc,  
     l.vno  
   END  
  ELSE  
   BEGIN  
    insert into #opbal  
    Select  
     cltcode,  
     sum(opbal) opbal  
    from  
     (  
      Select  
       l2.cltcode,  
       sum(case l2.drcr when 'D' then camt else -camt end) as opbal  
      from  
       ledger2 l2,  
       ledger l  
      where  
       vdt between @@opendate and @fdate  
       and l.vno=l2.vno  
       and l.vtyp=l2.vtype  
       and l.booktype=l2.booktype  
       and l.lno=l2.lno  
       and l2.cltcode between @fcode and @tcode  
      Group by  
       l2.cltcode  
      union ALL  
       Select  
        l2.cltcode,  
        sum(case l2.drcr when 'C' then camt else -camt end) as opbal  
       from  
        ledger2 l2,  
        ledger l  
       where  
        l.vno=l2.vno  
        and l.vtyp=l2.vtype  
        and l.booktype=l2.booktype  
        and l.lno=l2.lno  
        and vdt < @@opendate  
        and edt >= @@opendate  
        and l2.cltcode between @fcode and @tcode  
       Group by  
        l2.cltcode  
     ) t  
    Group by  
     cltcode  
    Order by  
     cltcode  
    insert into #temptable_gl  
    Select  
     l.booktype,  
     voudt1=l.vdt,  
     effdt1=l.edt,  
     isnull(shortdesc,'') shortdesc,  
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),  
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),  
     l.vno,  
     Replace(l.narration,'"','') narration,  
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),  
     l2.cltcode,  
     a.longname,  
     vdt,  
     l.vtyp,  
     accat,  
     opbal=0,  
     crosac='',  
     a.acname,  
     a.branchcode,  
     l.lno  
    from  
     ledger l,  
     vmast v,  
     ledger2 l2,  
     acmast a,  
     costmast c  
    Where  
     l.vno = l2.vno  
     and l.vtyp = l2.vtype  
     and l.booktype = l2.booktype  
     and l.lno = l2.lno  
     and a.cltcode = l2.cltcode  
     and l2.cltcode between @fcode and @tcode  
     And l.vtyp = v.vtype  
     and a.accat <> '4'  
     and l2.cltcode=a.cltcode  
     and costname = rtrim(@branch)  
     and l2.vtype <> 18  
     and l2.costcode = c.costcode  
     and  l.edt between @fdate and @tdate + ' 23:59:59'  
    order by  
     l2.cltcode,  
     voudt1,  
     l.vtyp desc,  
     l.vno  
   END  
 END  
  
Update  
 #temptable_gl  
set  
 opbal = l.opbal  
from  
 #opbal l  
where  
 #temptable_gl.cltcode = l.cltcode  
  
print 'test 1'  
Update  
 #temptable_gl  
set  
 crosac = l.cltcode  
from  
 ledger l  
where  
 l.vtyp not in('15','21')  
 and #temptable_gl.vtyp = l.vtyp  
 and #temptable_gl.booktype = l.booktype  
 and #temptable_gl.vno = l.vno  
 and #temptable_gl.cltcode <> l.cltcode  
print 'test 2'  
update  
 #temptable_gl  
set  
 branchcode = costname  
from  
 ledger2 l2,  
 costmast c  
where  
 #temptable_gl.vno = l2.vno  
 and #temptable_gl.vtyp = l2.vtype  
 and #temptable_gl.booktype = l2.booktype  
 and #temptable_gl.lno = l2.lno  
 and #temptable_gl.cltcode = l2.cltcode  
 and l2.costcode = c.costcode  
  
Select  
 booktype,  
 voudt = convert(varchar(11), voudt1, 103),  
 effdt = convert(varchar(11), effdt1, 103),  
 shortdesc,  
 dramt,  
 cramt,  
 vno,  
 narration,  
 ddno,  
 cltcode,  
 longname,  
 vdt,  
 vtyp,  
 accat,  
 opbal,  
 crosac,  
 acname,  
 branchcode,  
 lno  
from  
 #temptable_gl  
Order By  
 CltCode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bak_rpt_Acc_GlReport_vin
-- --------------------------------------------------

--EXEC ACC_REPORTS 'APR  1 2004', 'MAR 31 2005', 'APR  1 2004', 'MAR 31 2005', 'HOCA01', 'HOCA01', 'BRANCH', '146', '146','VDT', 'ACCOUNT', 'VOUCHERTYPE, VOUCHERDATE', 'GL', '', '', '', ''  
  
  
--EXEC RPT_ACC_GLREPORT'APR 1 2004', 'MAR 31 2005', 'MAR  1 2005', 'MAR 29 2005', 'HOCA01', 'HOCA01', 'BROKER', 'BROKER', '%','VDT', 'ACCOUNT', 'VDT', 'GL',''       
     
CREATE PROC [dbo].[bak_rpt_Acc_GLREPORT_vin]       
@SDATE VARCHAR(11),            /* AS MMM DD YYYY */      
@EDATE VARCHAR(11),            /* AS MMM DD YYYY */      
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */      
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */      
@FCODE VARCHAR(10),      
@TCODE VARCHAR(10),      
@STATUSID VARCHAR(30),      
@STATUSNAME VARCHAR(30),      
@BRANCH VARCHAR(10),      
@SELECTIONBY VARCHAR(3),      
@GROUPBY VARCHAR(10),      
@SORTBY VARCHAR(50),      
@REPORTNAME VARCHAR(30),      
@REPORTOPT VARCHAR(10)      
      
AS      
      
DECLARE       
@@OPENDATE AS VARCHAR(11)      
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
      
--SELECT @@OPENDATE = CONVERT(VARCHAR(11),MAX(VDT),109) FROM LEDGER WHERE VTYP='18'        
SELECT @@opendate = convert(varchar(11),SDTCUR,109) FROM PARAMETER WHERE @fdate BETWEEN SDTCUR AND LDTCUR 
  
      
SELECT CLTCODE,VAMT AS OPBAL INTO #OPBAL FROM LEDGER  WHERE 1 =2      
      
 SELECT L.BOOKTYPE, VOUDT=CONVERT(VARCHAR,L.VDT,103), EFFDT=CONVERT(VARCHAR,L.EDT,103), ISNULL(SHORTDESC,'') SHORTDESC,      
  DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),        
  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,       
  REPLACE( L.NARRATION,'"','') NARRATION,      
  DDNO=ISNULL((SELECT DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND      
  BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L.CLTCODE , A.LONGNAME,VDT, L.VTYP,      
  ACCAT,VAMT AS OPBAL,CROSAC=L.CLTCODE,      
  ISNULL(A.ACNAME,'') ACNAME,ISNULL(A.BRANCHCODE,'') BRANCHCODE  
 INTO #TEMPTABLE_GL      
FROM LEDGER L , ACMAST A ,VMAST V  
WHERE 1 = 2  
      
    
IF @SELECTIONBY = 'VDT'      
BEGIN      
IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'       
 BEGIN          
  INSERT INTO #OPBAL  
   SELECT CLTCODE,SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL FROM LEDGER       
   WHERE CLTCODE BETWEEN @FCODE AND @TCODE AND VDT BETWEEN @@OPENDATE AND @FDATE     
   GROUP BY CLTCODE       
   ORDER BY CLTCODE       
  
      
  INSERT INTO #TEMPTABLE_GL      
   --SELECT L.BOOKTYPE, VOUDT=CONVERT(VARCHAR,L.VDT,103), EFFDT=CONVERT(VARCHAR,L.EDT,103), ISNULL(SHORTDESC,'') SHORTDESC,      
   SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC,      
   DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),        
   CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO, REPLACE( L.NARRATION,'"','') NARRATION,      
   DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND      
   BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L.CLTCODE , A.LONGNAME,VDT, L.VTYP,      
   ACCAT,OPBAL=0,CROSAC='',   A.ACNAME,A.BRANCHCODE      
   FROM LEDGER L,  ACMAST A ,VMAST V    
    
   WHERE  L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'  AND VTYP = VTYPE AND  
   L.CLTCODE = A.CLTCODE  AND L.CLTCODE BETWEEN @FCODE AND @TCODE AND       
   (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')      
  
   ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO          
 END      
ELSE      
 BEGIN      
  INSERT INTO #OPBAL  
   SELECT L2.CLTCODE,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL FROM LEDGER2 L2, LEDGER L      
   WHERE L2.CLTCODE BETWEEN @FCODE AND @TCODE AND L.VTYP=L2.VTYPE AND L.BOOKTYPE=L2.BOOKTYPE AND L.VNO=L2.VNO AND L.LNO=L2.LNO      
   AND VDT BETWEEN @@OPENDATE AND @FDATE      
   GROUP BY L2.CLTCODE      
       ORDER BY L2.CLTCODE  
      
 INSERT INTO #TEMPTABLE_GL      
   SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC,       
   DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),        
   CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),       
   L.VNO, REPLACE( L.NARRATION,'"','') NARRATION, DDNO=ISNULL((SELECT DDNO FROM LEDGER1 WHERE VTYP = L.VTYP       
   AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE       
   AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP,      
   ACCAT,  OPBAL=0,CROSAC='',A.ACNAME,A.BRANCHCODE       
   FROM LEDGER L ,VMAST V, LEDGER2 L2, ACMAST A,  COSTMAST C         
  
           WHERE  L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND L.VTYP = L2.VTYPE AND  L.VNO = L2.VNO AND  
   L.LNO = L2.LNO AND  L.BOOKTYPE = L2.BOOKTYPE AND L2.CLTCODE=A.CLTCODE  AND L.VTYP = V.VTYPE AND   
   L2.CLTCODE BETWEEN @FCODE AND  @TCODE  AND A.ACCAT <> '4'       
   AND COSTNAME = RTRIM(@BRANCH)       
   AND L2.COSTCODE = C.COSTCODE  AND  L2.VTYPE <> 18  
   ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO      
 END      
END      
ELSE      
BEGIN      
IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'       
 BEGIN          
  INSERT INTO #OPBAL   
  SELECT CLTCODE, SUM(OPBAL) OPBAL  FROM      
   (  
    SELECT CLTCODE,SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL FROM LEDGER       
    WHERE CLTCODE BETWEEN @FCODE AND @TCODE AND VDT BETWEEN @@OPENDATE AND @FDATE      
    GROUP BY CLTCODE      
   
    UNION      
   
   SELECT CLTCODE,SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL FROM LEDGER       
   WHERE CLTCODE BETWEEN  @FCODE AND  @TCODE AND VDT < @@OPENDATE AND EDT >= @@OPENDATE      
   GROUP BY CLTCODE) T    
   GROUP BY CLTCODE      
     ORDER BY CLTCODE                
      
 INSERT INTO #TEMPTABLE_GL      
   SELECT L.BOOKTYPE, VOUDT=CONVERT(VARCHAR,L.VDT,103), EFFDT=CONVERT(VARCHAR,L.EDT,103), ISNULL(SHORTDESC,'') SHORTDESC,      
   DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),        
   CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,       
   REPLACE( L.NARRATION,'"','') NARRATION,      
   DDNO=ISNULL((SELECT DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND      
   BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L.CLTCODE , A.LONGNAME,VDT, L.VTYP,      
   ACCAT,OPBAL=0,CROSAC='',  A.ACNAME,A.BRANCHCODE      
   FROM LEDGER L , ACMAST A ,VMAST V    
   WHERE VTYP = VTYPE  AND A.CLTCODE = L.CLTCODE AND L.CLTCODE BETWEEN @FCODE AND @TCODE   
    AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND    L.VTYP <> 18 AND   
   (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')      
   ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO      
 END      
ELSE      
 BEGIN          
  INSERT INTO #OPBAL   
  SELECT CLTCODE, SUM(OPBAL) OPBAL  FROM      
   (  
  SELECT L2.CLTCODE,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL FROM LEDGER2 L2, LEDGER L      
   WHERE VDT  BETWEEN @@OPENDATE AND @FDATE  AND   L.VNO=L2.VNO AND L.VTYP=L2.VTYPE AND L.BOOKTYPE=L2.BOOKTYPE  
   AND L.LNO=L2.LNO   AND  L2.CLTCODE BETWEEN @FCODE   AND @TCODE  
   GROUP BY L2.CLTCODE      
  
   UNION      
  
   SELECT L2.CLTCODE,SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) AS OPBAL FROM LEDGER2 L2, LEDGER L      
   WHERE  L.VNO=L2.VNO AND L.VTYP=L2.VTYPE AND L.BOOKTYPE=L2.BOOKTYPE AND L.LNO=L2.LNO      
   AND  VDT < @@OPENDATE AND EDT >= @@OPENDATE AND   L2.CLTCODE BETWEEN @FCODE AND @TCODE   
   GROUP BY L2.CLTCODE) T      
 GROUP BY CLTCODE  
     ORDER BY CLTCODE  
      
 INSERT INTO #TEMPTABLE_GL      
  SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC,       
  DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),        
  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),       
  L.VNO, REPLACE( L.NARRATION,'"','') NARRATION, DDNO=ISNULL((SELECT DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE       
  AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP,        
  ACCAT,   OPBAL=0,CROSAC='',A.ACNAME,A.BRANCHCODE       
  FROM LEDGER L ,VMAST V, LEDGER2 L2 ,ACMAST A, COSTMAST C    
  WHERE  L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND  
  L.BOOKTYPE = L2.BOOKTYPE  AND L.LNO = L2.LNO AND A.CLTCODE = L2.CLTCODE   
  AND L2.CLTCODE BETWEEN @FCODE AND  @TCODE AND L.VTYP = V.VTYPE AND A.ACCAT <> '4' AND L2.CLTCODE=A.CLTCODE       
  AND COSTNAME = RTRIM(@BRANCH)  AND L2.VTYPE <> 18  
  AND L2.COSTCODE = C.COSTCODE         
  AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'    
  ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO      
 END      
END      
  
UPDATE #TEMPTABLE_GL SET OPBAL = L.OPBAL  FROM #OPBAL L   WHERE #TEMPTABLE_GL.CLTCODE = L.CLTCODE      
      
UPDATE #TEMPTABLE_GL SET CROSAC = L.CLTCODE  FROM LEDGER L       
WHERE L.VTYP NOT IN('15','21') AND #TEMPTABLE_GL.VTYP = L.VTYP AND #TEMPTABLE_GL.BOOKTYPE = L.BOOKTYPE AND #TEMPTABLE_GL.VNO = L.VNO      
AND #TEMPTABLE_GL.CLTCODE <> L.CLTCODE         

SELECT 
	BOOKTYPE,VOUDT,EFFDT ,SHORTDESC,DRAMT,CRAMT,VNO,NARRATION,DDNO,CLTCODE,LONGNAME,VDT,VTYP,ACCAT,OPBAL,CROSAC,ACNAME,BRANCHCODE
FROM
	#TEMPTABLE_GL
ORDER BY 
	CLTCODE
    
SELECT 
	BOOKTYPE,VOUDT=CONVERT(VARCHAR(11), VOUDT, 103),EFFDT = CONVERT(VARCHAR(11), EFFDT, 103),SHORTDESC,DRAMT,CRAMT,VNO,NARRATION,DDNO,CLTCODE,LONGNAME,VDT,VTYP,ACCAT,OPBAL,CROSAC,ACNAME,BRANCHCODE
FROM
	#TEMPTABLE_GL
ORDER BY 
	CLTCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BR_YEAREND
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[BR_YEAREND]  
 @SDTCUR VARCHAR(11),        
 @LDTCUR VARCHAR(11),        
 @VTYP   SMALLINT,        
 @VNO VARCHAR(12),        
 @BOOKTYPE CHAR(2),        
 @VDT    DATETIME,  
 @PNLCODE VARCHAR(10)        
        
AS        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
        
DECLARE        
 @@MAINCTRLAC AS VARCHAR(10),        
 @@MAINACNAME AS VARCHAR(100),        
 @@MAINCOSTCODE AS INT,        
 @@LNO AS INT,        
 @@COSTCODE AS SMALLINT,        
 @@AMT AS MONEY,        
 @@RCURSOR AS CURSOR  
    
      
        
SELECT         
 @@LNO =         
 (         
 SELECT         
  LNO         
 FROM LEDGER         
 WHERE VTYP = @VTYP         
  AND BOOKTYPE = @BOOKTYPE         
  AND VNO = @VNO         
  AND CLTCODE = @PNLCODE         
 )        
        
SELECT         
 @@MAINCTRLAC =         
 (         
 SELECT         
  MAINCONTROLAC         
 FROM BRANCHACCOUNTS         
 WHERE DEFAULTAC = 1        
 )        
        
SELECT @@MAINCOSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME IN(SELECT BRANCHNAME FROM BRANCHACCOUNTS WHERE DEFAULTAC = 1)        
        
SELECT         
 @@MAINACNAME =         
 (         
 SELECT         
  ACNAME         
 FROM ACMAST         
 WHERE CLTCODE = @@MAINCTRLAC         
 )      
  
TRUNCATE TABLE LEDGER_BRANCHBREAKUP  
  
INSERT INTO LEDGER_BRANCHBREAKUP  
SELECT VNO, VTYPE, BOOKTYPE, LNO, CLTCODE, CAMT, COSTCODE, DRCR   
FROM LEDGER2 L2 WITH (NOLOCK) WHERE CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE)   
AND EXISTS(SELECT VNO FROM LEDGER L WITH (NOLOCK) WHERE VDT > = @SDTCUR + ' 00:00:00'             
 AND VDT <= @LDTCUR + ' 23:59:59' AND L2.VTYPE = L.VTYP             
AND L2.BOOKTYPE = L.BOOKTYPE             
 AND L2.VNO = L.VNO             
 AND L2.LNO = L.LNO   )    
        
TRUNCATE TABLE BRANCHWISECLBAL   
  
INSERT INTO BRANCHWISECLBAL  
SELECT     
 L2.CLTCODE,             
 A.ACNAME ,             
 COSTCODE,             
 BALANCE=SUM(             
 CASE             
  WHEN UPPER(L2.DRCR) = 'D'             
  THEN CAMT             
  ELSE -CAMT             
 END            
 )             
FROM LEDGER_BRANCHBREAKUP L2,             
 ACMAST A             
    
WHERE   
L2.CLTCODE = A.CLTCODE  
 AND             
 (            
  A.ACTYP LIKE 'ASS%'             
  OR A.ACTYP LIKE 'LIAB%'            
 )             
            
GROUP BY COSTCODE,             
 L2.CLTCODE,             
 A.ACNAME          
        
/*  
INSERT         
INTO BRANCHWISECLBAL         
SELECT         
 L2.CLTCODE,         
 A.ACNAME ,         
 COSTCODE,         
 BALANCE=SUM(         
 CASE         
  WHEN UPPER(L2.DRCR) = 'D'         
  THEN CAMT         
  ELSE -CAMT         
 END        
 )         
FROM LEDGER2 L2         
LEFT OUTER JOIN         
 ACMAST A         
 ON L2.CLTCODE = A.CLTCODE,         
 LEDGER L         
WHERE L2.VTYPE = L.VTYP         
 AND L2.BOOKTYPE = L.BOOKTYPE         
 AND L2.VNO = L.VNO         
 AND L2.LNO = L.LNO         
 AND L.VDT > = @SDTCUR + ' 00:00:00'         
 AND L.VDT <= @LDTCUR + ' 23:59:59'         
 AND         
 (        
  A.ACTYP LIKE 'ASS%'         
  OR A.ACTYP LIKE 'LIAB%'        
 )         
 AND L2.CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE)         
GROUP BY COSTCODE,         
 L2.CLTCODE,         
 A.ACNAME  
*/  
INSERT         
  INTO BRANCHWISECLBAL         
 SELECT        
   @@MAINCTRLAC,         
   @@MAINACNAME,         
   COSTCODE,        
   -(SUM(BALANCE))  
  FROM        
   BRANCHWISECLBAL        
  GROUP BY        
   COSTCODE   
  
      
  
/*        
SET @@RCURSOR = CURSOR FOR        
 SELECT        
  COSTCODE,        
  SUM(BALANCE)        
 FROM        
  BRANCHWISECLBAL        
 GROUP BY        
  COSTCODE        
        
OPEN @@RCURSOR        
 FETCH NEXT FROM        
  @@RCURSOR         
 INTO        
  @@COSTCODE,        
  @@AMT        
        
WHILE @@FETCH_STATUS = 0        
 BEGIN        
  INSERT         
  INTO BRANCHWISECLBAL VALUES        
   (         
    @@MAINCTRLAC,         
    @@MAINACNAME,         
    @@COSTCODE,         
    -(@@AMT)         
   )        
        
  FETCH NEXT FROM        
   @@RCURSOR         
  INTO        
   @@COSTCODE,        
   @@AMT        
 END        
        
CLOSE @@RCURSOR        
DEALLOCATE @@RCURSOR       
*/   
        
INSERT         
INTO LEDGER2         
SELECT         
 L.VTYP,         
 L.VNO,         
 L.LNO,         
 (        
 CASE         
  WHEN (CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END) >= 0         
  THEN 'D'         
  ELSE 'C'         
 END        
 ),         
 ABS(CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END),         
 COSTCODE,         
 L.BOOKTYPE,         
 B.CLTCODE         
FROM LEDGER L,         
 BRANCHWISECLBAL B         
WHERE L.VTYP = @VTYP         
 AND L.BOOKTYPE = @BOOKTYPE         
 AND L.VNO = @VNO         
 AND L.CLTCODE = B.CLTCODE        
 AND L.CLTCODE NOT IN         
 (         
 SELECT         
  BRCONTROLAC         
 FROM BRANCHACCOUNTS         
 )        
        
INSERT         
INTO LEDGER2         
SELECT         
 @VTYP,         
 @VNO,         
 @@LNO,         
 (        
 CASE         
  WHEN BALANCE >= 0         
  THEN 'D'         
  ELSE 'C'         
 END        
 ),         
 ABS(BALANCE),         
 COSTCODE,         
 @BOOKTYPE,         
 CLTCODE         
FROM BRANCHWISECLBAL B         
WHERE CLTCODE IN         
 (         
 SELECT         
  BRCONTROLAC         
 FROM BRANCHACCOUNTS         
 )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrClosingBalance
-- --------------------------------------------------
 /**************************************************************************************************************************************************************************************************        
 THIS SP  IS USED TO FIND THE CLOSING BALANCE OF A PARTICULAR A/C CODE         
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~        
 Copy of BrOpeningbalance with change in condition.        
         
 Added two new parameters viz: @flag and @costcode.         
 These are used to display the bank transactions either for all the branches or for a particular branch         
 Depending on the @flag value         
 If @flag = 0  then show bank transaction for all the branches        
 If @flag = 1 then show bank transaction for a selected branch (i.e for the passed costcode )        
  
 Version modified by Deepak Maharishi ON Apr 3 2007  
  1. Removed Cursors and used simple assignments for all values  
  2. Made changes to get the Balance in one query instead of seperate queries for Opening Balance  
  2. Corrected the Balance Computation to get Opening Balance as on Reconciliation Date - 1  
  
  
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 22 2007 23:59:59', 0,0,0  
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 23 2007 23:59:59', 0,0,0  
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 28 2007 23:59:59', 0,0,0  
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 31 2007 23:59:59', 0,0,0  
  
  
exec acc_PrintReconcile '103','STATEMENT', 'Mar 23 2007 23:59:59', 'Mar 23 2007 23:59:59'  
***************************************************************************************************************************************************************************************************/        
      
    
CREATE  Procedure BrClosingBalance   
(  
 @cltcode  varchar(10),        
 @sdtcur  varchar(11),        
 @fromdate varchar(11),        
 @vdtedtflag tinyint,        
 @flag   smallint,        
 @costcode  smallint        
)  
       
AS        
        
Declare        
 @@openbaldt   varchar(11),        
 @@openentry   money,        
 @@openingbal   money,        
 @@startdate  datetime,        
 @@enddate  datetime   
    
 select @@startdate = sdtcur, @@enddate = ldtcur from parameter where @fromdate between sdtcur  and ldtcur    
    
 If @vdtedtflag = 0        
 begin        
 /*===============================================================================================================*/  
  /*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */        
 /*===============================================================================================================*/  
  if @flag = 0         
  begin        
   select @@openingbal = 0        
  
   select   
    @@openingbal = isnull(sum(case drcr when 'd' then isnull(vamt,0) else isnull(-vamt,0) end),0)   
   from   
    ledger   
   where   
    vdt >= @@startdate   
    and vdt <= @fromdate + ' 23:59:59'  
    and cltcode = @cltcode        
  
   Select @@Openingbal         
  end        
  /*===============================================================================================================*/  
   /*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/        
  /*===============================================================================================================*/  
  else if @flag = 1          
  begin         
   select @@openingbal = 0        
      
   select   
    @@openingbal = isnull(sum(case l.drcr when 'd' then isnull(camt,0) else isnull(-camt,0) end),0)   
   from   
    ledger l,  
    ledger2 l2        
   where   
    l.vtyp = l2.vtype   
    and l.vno = l2.vno   
    and l.lno = l2.lno   
    and vdt > = @@openbaldt     
    and vdt >= @@startdate   
    and vdt <= @fromdate + ' 23:59:59'  
    and l.cltcode = @cltcode   
    and costcode = @costcode        
      
   select @@openingbal        
  end        
  
 end        
 else if @vdtedtflag = 1        
 begin        
 /*===============================================================================================================*/  
  /*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */        
 /*===============================================================================================================*/  
  if @flag = 0         
  begin        
   select @@openingbal = 0        
  
   select   
    @@openingbal = isnull(sum(case drcr when 'd' then isnull(vamt,0) else isnull(-vamt,0) end),0)   
   from   
    ledger   
   where   
    vdt between @@startdate and @fromdate + ' 23:59:59'  
    and edt <= @fromdate + ' 23:59:59'  
    and cltcode = @cltcode   
      
   select @@openingbal        
  end         
  /*===============================================================================================================*/  
   /*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/        
  /*===============================================================================================================*/  
  else if @flag = 1          
  begin         
   select @@openingbal = 0        
      
   select   
    @@openingbal = isnull(sum(case l.drcr when 'd' then isnull(camt,0) else isnull(-camt,0) end),0)   
   from   
    ledger l,  
    ledger2 l2        
   where    
    l.vtyp = l2.vtype   
    and l.vno = l2.vno   
    and l.lno = l2.lno   
    and vdt between @@startdate and @fromdate + ' 23:59:59'   
    and edt <= @fromdate + ' 23:59:59'  
    and l.cltcode = @cltcode   
    and costcode = @costcode        
  
   select @@openingbal        
  end         
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Bryearend
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Bryearend    Script Date: 05/10/2004 5:29:30 PM ******/
/****** Object:  Stored Procedure dbo.Bryearend    Script Date: 03/27/2003 11:33:03 AM ******/
/****** Object:  Stored Procedure dbo.Bryearend    Script Date: 02/18/2003 10:26:56 AM ******/
CREATE Procedure [dbo].[Bryearend]
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime

AS

set transaction isolation level read uncommitted


declare
@@mainctrlac as varchar(10),
@@mainacname as varchar(100),
@@lno        as int,
@@costcode   as tinyint,
@@amt        as money,
@@rcursor    as cursor


select @@lno = ( select lno from ledger where vtyp = @vtyp and booktype = @booktype and vno = @vno and cltcode = '999999' )
select @@mainctrlac = ( select MainControlAc from branchaccounts where defaultac = 1)
select @@mainacname = ( select acname from acmast where cltcode = @@mainctrlac )

truncate table branchwiseclbal

insert into branchwiseclbal
select l2.cltcode, a.acname , costcode, balance=sum( case when upper(l2.drcr) = 'D' then camt else -camt end)
from ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, ledger l
where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
and l.vdt > = @sdtcur + ' 00:00:00' and l.vdt <= @ldtcur + ' 23:59:59'
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l2.cltcode not in (@@mainctrlac, '999999')
group by costcode, l2.cltcode, a.acname

set @@rcursor = cursor for
select costcode, sum(balance)
from branchwiseclbal
group by costcode

open @@rcursor
fetch next from @@rcursor 
into @@costcode, @@amt

while @@fetch_status = 0
begin
  insert into branchwiseclbal values( @@mainctrlac, @@mainacname, @@costcode, -(@@amt) )

  fetch next from @@rcursor 
  into @@costcode, @@amt
end

close @@rcursor
deallocate @@rcursor

insert into ledger2 
select l.vtyp, l.vno, l.lno, (case when balance >= 0 then 'D' else 'C' end), abs(balance), costcode, l.booktype, b.cltcode
from ledger l, branchwiseclbal b
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno and l.cltcode = b.cltcode 

insert into ledger2 
select @vtyp, @vno, @@lno, (case when balance >= 0 then 'D' else 'C' end), abs(balance), costcode, @booktype, cltcode
from branchwiseclbal b
where cltcode in ( select brcontrolac from branchaccounts )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO
-- --------------------------------------------------
CREATE  PROC [dbo].[BULKCOPYRECO]  
 @FILENAME VARCHAR(200),  
 @TABLE VARCHAR(50),
 @UNAME VARCHAR(20),
 @PWD VARCHAR(20)

  
AS  
 DECLARE @@SQL AS VARCHAR(4000)  
 DECLARE @@FNAME AS VARCHAR(200)  
  
SELECT @@FNAME = 'C:\TESTIMPORT.TXT'  
CREATE TABLE #TESTIMPORT  
(  
 OneRow Varchar(2000),  
 SNO INT IDENTITY(1,1)  
)  
  
SET NOCOUNT ON  
  
SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"  
  
EXEC(@@SQL)  
  
DELETE FROM #TESTIMPORT WHERE SNO = 1  
  
DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL  
  
DELETE FROM #TESTIMPORT WHERE RTRIM(LEFT(ONEROW, 1)) = CHAR(9)  
  
SELECT ONEROW = REPLACE(REPLACE(REPLACE(REPLACE(ONEROW, ')', ''), '(', ''), ',', ''), '"', '' ) INTO #TESTIMPORT1 From #TESTIMPORT  
  
DROP TABLE #TESTIMPORT  
  
SELECT * INTO TESTIMPORT FROM #TESTIMPORT1  
  
DROP TABLE #TESTIMPORT1  

SELECT @@SQL = " EXEC MASTER.DBO.XP_CMDSHELL 'DEL " + @@FNAME + "', no_output" 
EXEC (@@SQL)
  
SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -U " + CHAR(34) + @UNAME + CHAR(34) + " -P " + CHAR(34) + @PWD + CHAR(34) + "',no_output"  

EXEC(@@SQL)  
  
DROP TABLE TESTIMPORT  
  
SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"  
  
EXEC (@@SQL)  
  
SELECT @@SQL = "DELETE FROM " + @TABLE + " WHERE CREDIT IS NULL AND DEBIT IS NULL AND DESCRIPTION NOT IN('Opening Balance', 'Closing Balance')"  
  
SELECT @@SQL = @@SQL + "UPDATE " + @TABLE + " SET CREDIT = 0 WHERE CREDIT IS NULL "  
  
SELECT @@SQL = @@SQL + "UPDATE " + @TABLE + " SET DEBIT = 0 WHERE DEBIT IS NULL "  
  
SELECT @@SQL = @@SQL + "UPDATE " + @TABLE + " SET LEDGER_BALANCE = 0 WHERE LEDGER_BALANCE IS NULL "  
  
EXEC (@@SQL)  
  
SELECT @@SQL = "UPDATE " + @TABLE + " SET REFERENCE_NO = LEFT(REFERENCE_NO, 15) "  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO_ALLBANK
-- --------------------------------------------------

CREATE PROC [dbo].[BULKCOPYRECO_ALLBANK](
           @FILENAME  VARCHAR(200),
           @TABLE     VARCHAR(50),
           @BANK_TYPE VARCHAR(10),
           @STAT_TYPE VARCHAR(10),
           @LOGIN     VARCHAR(10),
           @PWD       VARCHAR(15))

AS
DECLARE  @@SQL  AS VARCHAR(4000)
  
  DECLARE  @@FNAME  AS VARCHAR(200)
                       
  SELECT @@FNAME = 'C:\TESTIMPORT.TXT'
  
  CREATE TABLE #TESTIMPORT (
    ONEROW VARCHAR(2000),
    SNO    INT   IDENTITY ( 1,1 ))
  
  SET NOCOUNT ON
  
  SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"              
  PRINT @@SQL
  EXEC(@@SQL)     

  IF @BANK_TYPE = 'ICICIRECO'
    BEGIN
      DELETE FROM #TESTIMPORT
      WHERE       SNO <= (SELECT SNO
                          FROM   #TESTIMPORT
                          WHERE  LEFT(ONEROW,8) = 'TXN_DATE')
    END
    
  DELETE FROM #TESTIMPORT
  WHERE       SNO = 1
                    
  DELETE FROM #TESTIMPORT
  WHERE       ONEROW IS NULL
              
  DELETE FROM #TESTIMPORT
  WHERE       RTRIM(LEFT(ONEROW,1)) = CHAR(9)
                                      
  SELECT ONEROW = REPLACE(REPLACE(REPLACE(ONEROW,')',''),'(',''),'"',
                          '')
  INTO   #TESTIMPORT1
  FROM   #TESTIMPORT
         
  DROP TABLE #TESTIMPORT
  
  SELECT *
  INTO   TESTIMPORT
  FROM   #TESTIMPORT1
         
  DROP TABLE #TESTIMPORT1

  SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -U " + CHAR(34) + @LOGIN + CHAR(34) + " -P " + CHAR(34) + @PWD + CHAR(34) + "', no_output"
  PRINT @@SQL
  EXEC (@@SQL)

  DROP TABLE TESTIMPORT
  
  IF @BANK_TYPE = 'CITYRECO'
    BEGIN
      SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ';', KEEPNULLS)"
    END
    ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB'
    BEGIN
      SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"
    END
    ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV') OR @BANK_TYPE = 'UTIRECO' 
    BEGIN
      SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"
    END
    ELSE IF @BANK_TYPE = 'ICICIRECO' 
    BEGIN
      SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"
  END

  PRINT @@SQL
  EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO_ALLBANK_bak_oct2011
-- --------------------------------------------------
CREATE PROC [dbo].[BULKCOPYRECO_ALLBANK_bak_oct2011]
 @FILENAME VARCHAR(200),                
 @TABLE VARCHAR(50),
 @BANK_TYPE VARCHAR(10),
 @STAT_TYPE VARCHAR(10),
 @LOGIN VARCHAR(10),
 @PWD VARCHAR(15)
  
AS                
 DECLARE @@SQL AS VARCHAR(4000)                
 DECLARE @@FNAME AS VARCHAR(200)                
  
 SELECT @@FNAME = 'C:\TESTIMPORT.TXT'                
 CREATE TABLE #TESTIMPORT                
 (                
 OneRow Varchar(2000),              
 SNO INT IDENTITY(1,1)              
 )                
  
SET NOCOUNT ON                
  
SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"              
PRINT @@SQL
EXEC(@@SQL)     

IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	DELETE FROM #TESTIMPORT WHERE SNO <= (SELECT SNO FROM #TESTIMPORT WHERE LEFT(ONEROW, 3) = 'No.')
END

DELETE FROM #TESTIMPORT WHERE SNO = 1              
  
DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL                
  
DELETE FROM #TESTIMPORT WHERE RTRIM(LEFT(ONEROW, 1)) = CHAR(9)                
  
SELECT ONEROW = REPLACE(REPLACE(REPLACE(ONEROW, ')', ''), '(', ''), '"', '' ) INTO #TESTIMPORT1 From #TESTIMPORT                

DROP TABLE #TESTIMPORT                
  
SELECT * INTO TESTIMPORT FROM #TESTIMPORT1  

DROP TABLE #TESTIMPORT1                


SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -U " + CHAR(34) + @LOGIN + CHAR(34) + " -P " + CHAR(34) + @PWD + CHAR(34) + "', no_output"
PRINT @@SQL
EXEC (@@SQL)

DROP TABLE TESTIMPORT

IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ';', KEEPNULLS)"
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND (@STAT_TYPE = 'TAB' OR @STAT_TYPE = 'BNK')
BEGIN
	SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"
END
ELSE IF @BANK_TYPE = 'SCRECO' 
BEGIN
	SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 4, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"
END
ELSE IF @BANK_TYPE = 'SBIRECO' 
BEGIN
	SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"
END
PRINT @@SQL
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO_ANAGRAM
-- --------------------------------------------------
CREATE PROC [dbo].[BULKCOPYRECO_ANAGRAM]      
 @FILENAME VARCHAR(200),      
 @TABLE VARCHAR(50)      
AS      
      
 DECLARE @@SQL AS VARCHAR(4000)      
 DECLARE @@FNAME AS VARCHAR(200)      
      
 SELECT @@FNAME = 'C:\TESTIMPORT.TXT'      
      
 CREATE TABLE #TESTIMPORT      
 (      
 OneRow Varchar(2000),    
 SNO INT IDENTITY(1,1)    
 )      
      
SET NOCOUNT ON      
    
    
SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"    
      
--SELECT @@SQL = "BULK INSERT #TESTIMPORT FROM '" + @FILENAME + "' WITH (FIRSTROW = 3, KEEPNULLS)"      
      
EXEC(@@SQL)      
      
DELETE FROM #TESTIMPORT WHERE SNO = 1    
    
DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL      
      
DELETE FROM #TESTIMPORT WHERE RTRIM(LEFT(ONEROW, 1)) = CHAR(9)      
      
SELECT ONEROW = REPLACE(REPLACE(REPLACE(REPLACE(ONEROW, ')', ''), '(', ''), ',', ''), '"', '' ) INTO #TESTIMPORT1 From #TESTIMPORT      
      
DROP TABLE #TESTIMPORT      
      
SELECT * INTO TESTIMPORT FROM #TESTIMPORT1      
      
DROP TABLE #TESTIMPORT1      
      
SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q', NO_OUTPUT"      
      
--PRINT @@SQL      
      
EXEC(@@SQL)      
      
      
DROP TABLE TESTIMPORT      
/*      
CREATE TABLE TESTIMPORT      
 (      
  BOOKDATE VARCHAR(10),      
  [DESCRIPTION] VARCHAR(100),      
  LEDBALANCE MONEY,      
  CREDIT MONEY,      
  DEBIT MONEY,      
  RELDT VARCHAR(10),      
  REFNO VARCHAR(25),      
  BRANCH VARCHAR(50),      
  SNO INT IDENTITY(1,1)      
 )      
*/      
SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"      
      
EXEC (@@SQL)      
      
--SELECT @@SQL = "DELETE FROM " + @TABLE + " WHERE CREDIT IS NULL AND DEBIT IS NULL "      
      
SELECT @@SQL = "UPDATE " + @TABLE + " SET CREDIT = 0 WHERE CREDIT IS NULL "      
      
SELECT @@SQL = @@SQL + "UPDATE " + @TABLE + " SET DEBIT = 0 WHERE DEBIT IS NULL "      
      
SELECT @@SQL = @@SQL + "UPDATE " + @TABLE + " SET LEDGER_BALANCE = 0 WHERE LEDGER_BALANCE IS NULL "      
      
EXEC (@@SQL)      
      
/*SELECT @@SQL = "SELECT * FROM " + @TABLE + " ORDER BY REFERENCE_NO "  
      
EXEC (@@SQL)    
    */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO_COMBINED
-- --------------------------------------------------
CREATE PROC [dbo].[BULKCOPYRECO_COMBINED]    
 @FILENAME VARCHAR(200),                    
 @TABLE VARCHAR(50),    
 @BANK_TYPE VARCHAR(10),    
 @STAT_TYPE VARCHAR(10),    
 @LOGIN VARCHAR(10),    
 @PWD VARCHAR(15)    
      
AS                    
 DECLARE @@SQL AS VARCHAR(4000)                    
 DECLARE @@FNAME AS VARCHAR(200)                    
      
 SELECT @@FNAME = 'C:\TESTIMPORT.TXT'                    
 CREATE TABLE #TESTIMPORT                    
 (                    
 OneRow Varchar(2000),                  
 SNO INT IDENTITY(1,1)                  
 )                    
      
SET NOCOUNT ON                    
      
SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"                  
PRINT @@SQL    
EXEC(@@SQL)         
--return    
IF @BANK_TYPE = 'ICICIRECO'     
BEGIN    
 DELETE FROM #TESTIMPORT WHERE SNO <= (SELECT SNO FROM #TESTIMPORT WHERE LEFT(ONEROW, 3) = 'No.')    
END    
    
DELETE FROM #TESTIMPORT WHERE SNO = 1                  
      
DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL                    
      
DELETE FROM #TESTIMPORT WHERE RTRIM(LEFT(ONEROW, 1)) = CHAR(9)                    
      
SELECT ONEROW = REPLACE(REPLACE(REPLACE(ONEROW, ')', ''), '(', ''), '"', '' ) INTO #TESTIMPORT1 From #TESTIMPORT                    
    
DROP TABLE #TESTIMPORT                    
      
SELECT * INTO TESTIMPORT FROM #TESTIMPORT1      
    
DROP TABLE #TESTIMPORT1                    
    
SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -U " + CHAR(34) + @LOGIN + CHAR(34) + " -P " + CHAR(34) + @PWD + CHAR(34) + "', no_output"    
PRINT @@SQL    
EXEC (@@SQL)    
    
DROP TABLE TESTIMPORT    
    
SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"    
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO_NEW
-- --------------------------------------------------
CREATE  PROC [dbo].[BULKCOPYRECO_NEW]              
 @FILENAME VARCHAR(200),              
 @TABLE VARCHAR(50)              

AS              
 DECLARE @@SQL AS VARCHAR(4000)              
 DECLARE @@FNAME AS VARCHAR(200)              

 SELECT @@FNAME = 'C:\TESTIMPORT.TXT'              
 CREATE TABLE #TESTIMPORT              
 (              
 OneRow Varchar(2000),            
 SNO INT IDENTITY(1,1)            
 )              

SET NOCOUNT ON              

SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"            


EXEC(@@SQL)              

DELETE FROM #TESTIMPORT WHERE SNO = 1            

DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL              

DELETE FROM #TESTIMPORT WHERE RTRIM(LEFT(ONEROW, 1)) = CHAR(9)              

SELECT ONEROW = REPLACE(REPLACE(REPLACE(ONEROW, ')', ''), '(', ''), '"', '' ) INTO #TESTIMPORT1 From #TESTIMPORT              

DROP TABLE #TESTIMPORT              

SELECT * INTO TESTIMPORT FROM #TESTIMPORT1              

DROP TABLE #TESTIMPORT1              

SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -U " + CHAR(34) + "sa" + CHAR(34) + " -P " + CHAR(34) + "ms" + CHAR(34) + "', no_output"             

EXEC(@@SQL)              

DROP TABLE TESTIMPORT              

SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"              

EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATEBS
-- --------------------------------------------------
CREATE PROC [dbo].[CALCULATEBS]
@FROMDATE VARCHAR(11),    
@TODATE VARCHAR(11),    
@BRANCHCD VARCHAR(20),    
@SHOWZERO VARCHAR(1) = 'N'    
  
AS    
  
BEGIN    
  
SET NOCOUNT ON    
BEGIN TRANSACTION    
  
DELETE FROM PLGROUP_MSTR     
  
/*FOR GROUP DETAILS*/    
INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)     
SELECT GROUP_CODE=LTRIM(RTRIM(GRPCODE)),GROUP_NAME=LTRIM(RTRIM(GRPNAME)),    
MAIN_GROUP=CASE WHEN LTRIM(RTRIM(GRPCODE)) = GRPMAIN THEN '' ELSE LTRIM(RTRIM(GRPMAIN)) END,AMOUNT=0,TYPE='G'    
FROM GRPMAST WHERE (GRPMAIN LIKE 'L%' OR GRPMAIN LIKE 'A%')    
/*FOR GROUP DETAILS*/    
  
/*FOR ACCOUNT DETAILS*/    
IF LTRIM(RTRIM(@BRANCHCD)) = ''    
BEGIN    
 -- FOR HO    
 INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)     
 SELECT GROUP_CODE=LTRIM(RTRIM(L.CLTCODE)),GROUP_NAME=LTRIM(RTRIM(L.ACNAME)),MAIN_GROUP=LTRIM(RTRIM(GRPCODE)),    
 AMOUNT= SUM(CASE WHEN DRCR = 'C' THEN VAMT * -1 ELSE VAMT END),TYPE='A'    
 FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE    
 WHERE EXISTS(SELECT GROUP_CODE FROM PLGROUP_MSTR M WHERE M.GROUP_CODE = A.GRPCODE)     
 AND L.VDT >= CONVERT(DATETIME,@FROMDATE + ' 00:00:00')  AND L.VDT <= CONVERT(DATETIME,@TODATE + ' 23:59:59')    
 GROUP BY L.CLTCODE,L.ACNAME,GRPCODE    
END    
  
ELSE    
BEGIN    
 -- FOR BRANCHES    
 INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)     
 SELECT GROUP_CODE=LTRIM(RTRIM(L.CLTCODE)),GROUP_NAME=LTRIM(RTRIM(A.ACNAME)),MAIN_GROUP=LTRIM(RTRIM(A.GRPCODE)),    
 AMOUNT= SUM(CASE WHEN L.DRCR = 'C' THEN CAMT * -1 ELSE CAMT END),TYPE='A'    
 FROM LEDGER2 L     
 LEFT OUTER JOIN LEDGER L1 ON L1.VTYP = L.VTYPE AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO AND L1.LNO = L.LNO AND L1.CLTCODE = L.CLTCODE    
 LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE    
 LEFT OUTER JOIN COSTMAST M ON L.COSTCODE = M.COSTCODE    
 WHERE EXISTS(SELECT GROUP_CODE FROM PLGROUP_MSTR M WHERE M.GROUP_CODE = A.GRPCODE)     
 AND L1.VDT >= CONVERT(DATETIME,@FROMDATE + ' 00:00:00')  AND L1.VDT <= CONVERT(DATETIME,@TODATE + ' 23:59:59')    
 AND M.COSTNAME = @BRANCHCD    
 GROUP BY L.CLTCODE,A.ACNAME,A.GRPCODE    
END    
  
SELECT *,RECLEVEL = DBO.GETGROUPLEVELS(GROUP_CODE)     
INTO #TMPPL     
FROM PLGROUP_MSTR    
ORDER BY RECLEVEL,GROUP_CODE    
  
COMMIT TRANSACTION    
DECLARE @@GROUPCODE VARCHAR(20),    
@@RECLEVEL INT    
  
DECLARE RSCURSOR  CURSOR FOR    
SELECT DISTINCT GROUP_CODE,RECLEVEL    
FROM #TMPPL     
WHERE TYPE = 'G'    
ORDER BY RECLEVEL DESC    
OPEN RSCURSOR      
FETCH NEXT FROM RSCURSOR INTO @@GROUPCODE,@@RECLEVEL     
WHILE @@FETCH_STATUS = 0    
BEGIN    
 UPDATE #TMPPL SET AMOUNT = ISNULL((SELECT SUM(AMOUNT) FROM #TMPPL T1 WHERE  T1.MAIN_GROUP = @@GROUPCODE),0)    
 FROM #TMPPL T WHERE TYPE = 'G' AND GROUP_CODE = @@GROUPCODE    
 FETCH NEXT FROM RSCURSOR INTO @@GROUPCODE,@@RECLEVEL     
END    
  
CLOSE RSCURSOR    
DEALLOCATE RSCURSOR    
  
IF @SHOWZERO = 'Y'    
BEGIN    
 SELECT GROUP_CODE=GROUP_CODE,GROUP_NAME= CASE WHEN TYPE = 'A' THEN 'A/C :' + GROUP_NAME ELSE GROUP_NAME END,    
 MAIN_GROUP,AMOUNT,TYPE,RECLEVEL     
 FROM #TMPPL ORDER BY RECLEVEL ASC     
END    
  
ELSE    
BEGIN    
 SELECT GROUP_CODE=GROUP_CODE,GROUP_NAME= CASE WHEN TYPE = 'A' THEN 'A/C :' + GROUP_NAME ELSE GROUP_NAME END,    
 MAIN_GROUP,AMOUNT,TYPE,RECLEVEL     
 FROM #TMPPL WHERE AMOUNT <> 0 ORDER BY RECLEVEL ASC     
END    
  
DROP TABLE #TMPPL     
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CalculatePL
-- --------------------------------------------------
CREATE PROC [dbo].[CalculatePL]   
@FROMDATE VARCHAR(11),  
@TODATE VARCHAR(11),  
@BRANCHCD VARCHAR(20),  
@SHOWZERO VARCHAR(1) = 'N'  

AS  

BEGIN  

SET NOCOUNT ON  
BEGIN TRANSACTION  

DELETE FROM PLGROUP_MSTR   

/*FOR GROUP DETAILS*/  
INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)   
SELECT GROUP_CODE=LTRIM(RTRIM(GRPCODE)),GROUP_NAME=LTRIM(RTRIM(GRPNAME)),  
MAIN_GROUP=CASE WHEN LTRIM(RTRIM(GRPCODE)) = GRPMAIN THEN '' ELSE LTRIM(RTRIM(GRPMAIN)) END,AMOUNT=0,TYPE='G'  
FROM GRPMAST WHERE (GRPMAIN LIKE 'X%' OR GRPMAIN LIKE 'N%')  
/*FOR GROUP DETAILS*/  

/*FOR ACCOUNT DETAILS*/  
IF LTRIM(RTRIM(@BRANCHCD)) = ''  
BEGIN  
	-- FOR HO  
	INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)   
	SELECT GROUP_CODE=LTRIM(RTRIM(L.CLTCODE)),GROUP_NAME=LTRIM(RTRIM(L.ACNAME)),MAIN_GROUP=LTRIM(RTRIM(GRPCODE)),  
	AMOUNT= SUM(CASE WHEN DRCR = 'C' THEN VAMT * -1 ELSE VAMT END),TYPE='A'  
	FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE  
	WHERE EXISTS(SELECT GROUP_CODE FROM PLGROUP_MSTR M WHERE M.GROUP_CODE = A.GRPCODE)   
	AND L.VDT >= CONVERT(DATETIME,@FROMDATE + ' 00:00:00')  AND L.VDT <= CONVERT(DATETIME,@TODATE + ' 23:59:59')  
	GROUP BY L.CLTCODE,L.ACNAME,GRPCODE  
END  

ELSE  
BEGIN  
	-- FOR BRANCHES  
	INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)   
	SELECT GROUP_CODE=LTRIM(RTRIM(L.CLTCODE)),GROUP_NAME=LTRIM(RTRIM(A.ACNAME)),MAIN_GROUP=LTRIM(RTRIM(A.GRPCODE)),  
	AMOUNT= SUM(CASE WHEN L.DRCR = 'C' THEN CAMT * -1 ELSE CAMT END),TYPE='A'  
	FROM LEDGER2 L   
	LEFT OUTER JOIN LEDGER L1 ON L1.VTYP = L.VTYPE AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO AND L1.LNO = L.LNO AND L1.CLTCODE = L.CLTCODE  
	LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE  
	LEFT OUTER JOIN COSTMAST M ON L.COSTCODE = M.COSTCODE  
	WHERE EXISTS(SELECT GROUP_CODE FROM PLGROUP_MSTR M WHERE M.GROUP_CODE = A.GRPCODE)   
	AND L1.VDT >= CONVERT(DATETIME,@FROMDATE + ' 00:00:00')  AND L1.VDT <= CONVERT(DATETIME,@TODATE + ' 23:59:59')  
	AND M.COSTNAME = @BRANCHCD  
	GROUP BY L.CLTCODE,A.ACNAME,A.GRPCODE  
END  

SELECT *,RECLEVEL = DBO.GETGROUPLEVELS(GROUP_CODE)   
INTO #TMPPL   
FROM PLGROUP_MSTR  
ORDER BY RECLEVEL,GROUP_CODE  

COMMIT TRANSACTION  
DECLARE @@GROUPCODE VARCHAR(20),  
@@RECLEVEL INT  

DECLARE RSCURSOR  CURSOR FOR  
SELECT DISTINCT GROUP_CODE,RECLEVEL  
FROM #TMPPL   
WHERE TYPE = 'G'  
ORDER BY RECLEVEL DESC  
OPEN RSCURSOR    
FETCH NEXT FROM RSCURSOR INTO @@GROUPCODE,@@RECLEVEL   
WHILE @@FETCH_STATUS = 0  
BEGIN  
	UPDATE #TMPPL SET AMOUNT = ISNULL((SELECT SUM(AMOUNT) FROM #TMPPL T1 WHERE  T1.MAIN_GROUP = @@GROUPCODE),0)  
	FROM #TMPPL T WHERE TYPE = 'G' AND GROUP_CODE = @@GROUPCODE  
	FETCH NEXT FROM RSCURSOR INTO @@GROUPCODE,@@RECLEVEL   
END  

CLOSE RSCURSOR  
DEALLOCATE RSCURSOR  

IF @SHOWZERO = 'Y'  
BEGIN  
	SELECT GROUP_CODE=GROUP_CODE,GROUP_NAME= CASE WHEN TYPE = 'A' THEN 'A/C :' + GROUP_NAME ELSE GROUP_NAME END,  
	MAIN_GROUP,AMOUNT,TYPE,RECLEVEL   
	FROM #TMPPL ORDER BY RECLEVEL ASC   
END  

ELSE  
BEGIN  
	SELECT GROUP_CODE=GROUP_CODE,GROUP_NAME= CASE WHEN TYPE = 'A' THEN 'A/C :' + GROUP_NAME ELSE GROUP_NAME END,  
	MAIN_GROUP,AMOUNT,TYPE,RECLEVEL   
	FROM #TMPPL WHERE AMOUNT <> 0 ORDER BY RECLEVEL ASC   
END  

DROP TABLE #TMPPL   

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CheckMarginopbal
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.CheckMarginopbal    Script Date: 05/10/2004 5:29:30 PM ******/
/****** Object:  Stored Procedure dbo.CheckMarginopbal    Script Date: 03/28/2003 4:33:12 PM ******/
CREATE Procedure [dbo].[CheckMarginopbal]
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime

as
set transaction isolation level read uncommitted


select l.lno, l.cltcode, amt=(case when upper(drcr) = 'D' then vamt else -vamt end), t.bal
from ledger l left outer join acmast a on l.cltcode = a.cltcode,
(select mcltcode, bal=sum( case when upper(drcr) = 'D' then amount else -amount end)
from marginledger where vdt >= @sdtcur + ' 00:00:00'  and vdt <= @ldtcur + ' 23:59:59'
group by mcltcode) t
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno
and a.accat = 14 and t.mcltcode = l.cltcode and 
(case when upper(drcr) = 'D' then vamt else -vamt end) <> bal

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Chequedetailssp_New
-- --------------------------------------------------
CREATE Proc [dbo].[Chequedetailssp_New] 
@Cltcode Varchar(10),             
@Option Varchar(2),             
@Vdt Varchar(11),             
@Statusname Varchar(25)            
As            
       
if @Option = ''      
BEGIN      
 Select Distinct Acname, Cltcode, Bnkname, Brnname, Vamt, Ddno, L.Vtyp, L.Vno, L.Lno, L.Drcr, L.Vdt , L.Booktype, City = ''            
 From Ledger L, Ledger1 L1 , Tblpradnyausers U, Tbladmin A            
 Where  L1.Vtyp = L.Vtyp And L1.Vno = L.Vno            
 And L.Vtyp In (Select Vtyp From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19) And Cltcode = @Cltcode)             
 And L.Vno In (Select Vno From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19)  And Cltcode = @Cltcode)             
 And Clear_mode in ('X','O','N','S','H') And L.Vdt Like @Vdt + '%' And L.Cltcode <> @Cltcode       
 And U.Fldstname = @Statusname         
END      
      
ELSE      
BEGIN      
 Select Distinct Acname, Cltcode, Bnkname, Brnname, Vamt, Ddno, L.Vtyp, L.Vno, L.Lno, L.Drcr, L.Vdt , L.Booktype, City = ''            
 From Ledger L, Ledger1 L1 , Tblpradnyausers U, Tbladmin A            
 Where  L1.Vtyp = L.Vtyp And L1.Vno = L.Vno            
 And L.Vtyp In (Select Vtyp From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19) And Cltcode = @Cltcode)             
 And L.Vno In (Select Vno From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19)  And Cltcode = @Cltcode)             
 And Clear_mode in (@Option) And L.Vdt Like @Vdt + '%' And L.Cltcode <> @Cltcode       
 And U.Fldstname = @Statusname            
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHQ_COVERING_LETTER
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.CHEQUE_COVERING_LETTER    SCRIPT DATE: 10/20/2005 12:19:54 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.CHEQUE_COVERING_LETTER    SCRIPT DATE: 08/29/2005 5:57:26 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC [dbo].[CHQ_COVERING_LETTER]

	@VTYP VARCHAR(2),
	@BOOKTYPE VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12) ,
	@BANKNAME VARCHAR(50),
	@VTYPE1 VARCHAR(2),
	@BRANCHCODE VARCHAR(12)
	
	
AS

	DECLARE
		@@SELECTQURY AS VARCHAR(8000),
		@@FROMTABLES AS VARCHAR(2000),
		@@WHEREPART AS VARCHAR(8000),
		@@SORTBY AS VARCHAR(200)


	IF @VNOFROM <> '' AND @VNOTO <> ''
	   BEGIN
		IF @VTYP = '20'
			SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE "
		ELSE	
			SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

		SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
	   END
	ELSE
	   BEGIN
		IF @VTYP = '20'
			SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE "
		ELSE	
			SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

		 SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
	   END

	IF @VTYP = '2' OR @VTYP = '3' OR @VTYP = '5' OR @VTYP = '16' OR @VTYP = '17' OR @VTYP = '20' OR @VTYP = '19' OR @VTYP = '1' OR @VTYP = '4' OR @VTYP = '22' OR  @VTYP = '23'
	   BEGIN
		SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'0' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T, ACMAST A "
		
		IF @VTYP = '20'
			SELECT @@FROMTABLES = @@FROMTABLES + " , (SELECT PARTY_CODE FROM MARGINLEDGER WHERE VTYP = '" + @VTYP + "' AND VNO >= '" + @VNOFROM + "' AND VNO <= '" + @VNOTO + "' ) ML "

		SELECT @@WHEREPART = @@WHEREPART + " AND L1.DDNO<>'0' AND L1.CHQPRINTED > 0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' "
	   END
	ELSE
	   BEGIN
		SELECT @@WHEREPART = @@WHEREPART + " AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
		SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "
	   END

	IF @VTYPE1 = '98'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
		END
	ELSE IF @VTYPE1 = '90'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART
		END

	SELECT @@SELECTQURY = " SELECT DISTINCT VDT = CONVERT(VARCHAR, L.VDT, 103), DDDT = CONVERT(VARCHAR, L1.DDDT, 103), L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT A.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0),L1.BNKNAME, L1.MICRNO, L.BOOKTYPE, "
	SELECT @@SELECTQURY = @@SELECTQURY + " BRANCHCODE = (CASE BRANCHCODE WHEN 'ALL' THEN '' ELSE BRANCHCODE END) "
	
	SELECT @@SORTBY = " ORDER BY L.VNO "
	
	PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)
	EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHQDETAILS_WCF_FP
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.CHQDETAILS_WCF_FP    SCRIPT DATE: 10/20/2005 12:19:54 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.CHQDETAILS_WCF_FP    SCRIPT DATE: 08/29/2005 5:57:25 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC [dbo].[CHQDETAILS_WCF_FP]

	@VTYP VARCHAR(2),
	@BOOKTYPE VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM 	VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12) ,
	@BANKNAME VARCHAR(50),
	@VTYPE1 VARCHAR(2),
	@BRANCHCODE VARCHAR(12)
	
	/*
		EXEC CHQDETAILS_WCF_FP '3', '', 'Apr  1 2006', 'Aug 16 2006', '000000000000', '999999999999', 'BANK01', 'BANK01 (ANIMESH)', '3', '%' 
	*/
AS

	DECLARE
		@@SELECTQURY AS VARCHAR(8000),
		@@FROMTABLES AS VARCHAR(2000),
		@@WHEREPART AS VARCHAR(8000),
		@@SORTBY AS VARCHAR(200)


	IF @VNOFROM <> '' AND @VNOTO <> ''
		BEGIN
			IF @VTYP = '20'
				SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE "
			ELSE	
				SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "
			
			SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
		END
	ELSE
		BEGIN
			IF @VTYP = '20'
				SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE "
			ELSE	
				SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

			SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
		END
	
	IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'
		BEGIN
			SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO /*AND L1.DDNO='0' */AND L1.CHQPRINTED=0 AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T, ACMAST A "
			
			IF @VTYP = '20'
				SELECT @@FROMTABLES = @@FROMTABLES + " , (SELECT PARTY_CODE FROM MARGINLEDGER WHERE VTYP = '" + @VTYP + "' AND VNO >= '" + @VNOFROM + "' AND VNO <= '" + @VNOTO + "' ) ML "
	
			SELECT @@WHEREPART = @@WHEREPART + " /*AND L1.DDNO='0'*/ AND L1.CHQPRINTED=0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
			SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "
		END
	
	IF @VTYPE1 = '98'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
		END
	ELSE IF @VTYPE1 = '90'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART
		END
	
	SELECT @@SELECTQURY = " SELECT DISTINCT VDT = CONVERT(VARCHAR, L.VDT, 103), DDDT = CONVERT(VARCHAR, L1.DDDT, 103), L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END), 0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT A.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, "
	SELECT @@SELECTQURY = @@SELECTQURY + " BRANCHCODE = (CASE BRANCHCODE WHEN 'ALL' THEN '' ELSE BRANCHCODE END) "
	
	SELECT @@SORTBY = " ORDER BY L.VNO "
	
	PRINT (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)
	EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHQDETAILS_WCF_RP
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.CHQDETAILS_WCF_RP    SCRIPT DATE: 10/20/2005 12:19:54 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.CHQDETAILS_WCF_RP    SCRIPT DATE: 08/29/2005 5:57:26 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC [dbo].[CHQDETAILS_WCF_RP]

	@VTYP VARCHAR(2),
	@BOOKTYPE VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12) ,
	@BANKNAME VARCHAR(50),
	@VTYPE1 VARCHAR(2),
	@BRANCHCODE VARCHAR(12)
	
	/*
		Exec CHQDETAILS_WCF_RP '3', '', 'Aug  1 2006', 'Aug 21 2006', '000000000000', '999999999999', 'BANK01', 'BANK01 (ANIMESH)', '3', '%' 
	*/
AS

	DECLARE
		@@SELECTQURY AS VARCHAR(8000),
		@@FROMTABLES AS VARCHAR(2000),
		@@WHEREPART AS VARCHAR(8000),
		@@SORTBY AS VARCHAR(200)


	IF @VNOFROM <> '' AND @VNOTO <> ''
	   BEGIN
		IF @VTYP = '20'
			SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE "
		ELSE	
			SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

		SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
	   END
	ELSE
	   BEGIN
		IF @VTYP = '20'
			SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE "
		ELSE	
			SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

		 SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
	   END

	IF @VTYP = '2' OR @VTYP = '3' OR @VTYP = '5' OR @VTYP = '16' OR @VTYP = '17' OR @VTYP = '20' OR @VTYP = '19' OR @VTYP = '1' OR @VTYP = '4' OR @VTYP = '22' OR  @VTYP = '23'
	   BEGIN
		SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'0' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T, ACMAST A "
		
		IF @VTYP = '20'
			SELECT @@FROMTABLES = @@FROMTABLES + " , (SELECT PARTY_CODE FROM MARGINLEDGER WHERE VTYP = '" + @VTYP + "' AND VNO >= '" + @VNOFROM + "' AND VNO <= '" + @VNOTO + "' ) ML "

		SELECT @@WHEREPART = @@WHEREPART + " AND L1.DDNO<>'0' AND L1.CHQPRINTED > 0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' "
	   END
	ELSE
	   BEGIN
		SELECT @@WHEREPART = @@WHEREPART + " AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
		SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "
	   END

	IF @VTYPE1 = '98'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
		END
	ELSE IF @VTYPE1 = '90'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART
		END

	SELECT @@SELECTQURY = " SELECT DISTINCT VDT = CONVERT(VARCHAR, L.VDT, 103), DDDT = CONVERT(VARCHAR, L1.DDDT, 103), L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT A.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, "
	SELECT @@SELECTQURY = @@SELECTQURY + " BRANCHCODE = (CASE BRANCHCODE WHEN 'ALL' THEN '' ELSE BRANCHCODE END) "
	
	SELECT @@SORTBY = " ORDER BY L.VNO "
	
	PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)
	EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHQDETAILS_WCF_UPD
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.CHQDETAILS_WCF_UPD SCRIPT DATE: 10/20/2005 12:19:54 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.CHQDETAILS_WCF_UPD SCRIPT DATE: 08/29/2005 5:57:26 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC [dbo].[CHQDETAILS_WCF_UPD]

	@VTYP VARCHAR(2),
	@BOOKTYPE VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12) ,
	@BANKNAME VARCHAR(50),
	@VTYPE1 VARCHAR(2),
	@BRANCHCODE VARCHAR(12),
	@NEWPRINTFLAG VARCHAR(2)
	
	/*
		Exec CHQDETAILS_WCF_UPD '3', '01', 'Apr  1 2006', 'Aug 17 2006', '000000000000', '999999999999', 'BANK01', 'BANK01 (ANIMESH)', '3', '%', 'FP' 
	*/
AS

	DECLARE
		@@SELECTQURY AS VARCHAR(8000),
		@@FROMTABLES AS VARCHAR(2000),
		@@WHEREPART AS VARCHAR(8000),
		@@SORTBY AS VARCHAR(200)

	IF @VNOFROM <> '' AND @VNOTO <> ''
		BEGIN
			IF @VTYP = '20'
				SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE "
			ELSE	
				SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

			SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
		END
	ELSE
		BEGIN
			IF @VTYP = '20'
				SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE "
			ELSE	
				SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

			SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
		END

	IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'
		BEGIN
			SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO /*AND L1.DDNO>'0'*/ AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T, ACMAST A "

			IF @VTYP = '20'
				SELECT @@FROMTABLES = @@FROMTABLES + " , (SELECT PARTY_CODE FROM MARGINLEDGER WHERE VTYP = '" + @VTYP + "' AND VNO >= '" + @VNOFROM + "' AND VNO <= '" + @VNOTO + "' ) ML "

			IF @NEWPRINTFLAG = 'FP'
				SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED = 0 "
			IF @NEWPRINTFLAG = 'RP'
				SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED > 0 "
				SELECT @@WHEREPART = @@WHEREPART + " /*AND L1.DDNO>'0'*/ AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
			SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO /*AND L1.DDNO>'0'*/ "
		END

	IF @VTYPE1 = '98'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
		END
	ELSE IF @VTYPE1 = '90'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART
		END

	SELECT @@SELECTQURY = " SELECT DISTINCT VDT = CONVERT(VARCHAR, L.VDT, 103), DDDT = CONVERT(VARCHAR, L1.DDDT, 103), DDDT = CONVERT(VARCHAR, L1.DDDT, 103), L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT A.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0) , L1.MICRNO, L.BOOKTYPE, "
	SELECT @@SELECTQURY = @@SELECTQURY + " BRANCHCODE = (CASE BRANCHCODE WHEN 'ALL' THEN '' ELSE BRANCHCODE END) "
	
	SELECT @@SORTBY = " ORDER BY L.VNO "
	
	PRINT (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )
	EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GETTABLEINFO
-- --------------------------------------------------
CREATE PROC [dbo].[CLS_GETTABLEINFO]
	@TABLENAME VARCHAR(500),
	@FORINIT BIT = 1
AS
/*
	EXEC CLS_GETTABLEINFO 'CustomerDetailsType'
*/
IF @FORINIT = 1
	BEGIN
		SELECT
			TABLE_NAME = UPPER(@TABLENAME),
			FIELD_NAME = UPPER(C.NAME),
			FIELD_ALIAS = UPPER(CONVERT(VARCHAR(500), ISNULL(P.VALUE, ''))),
			FIELD_TYPE = UPPER(T.NAME),
			FIELD_LENGTH = C.PREC,
			FIELD_SCALE = CASE WHEN
											T.NAME = 'NUMERIC'
											OR T.NAME = 'FLOAT'
											OR T.NAME = 'REAL'
											OR T.NAME = 'MONEY'
											OR T.NAME = 'SMALLMONEY'
											OR T.NAME = 'DECIMAL'
									THEN C.SCALE
									ELSE 0
									END,
			ALLOW_NULL = C.ISNULLABLE,
			ISDEFAULT = CONVERT(BIT, 1),
			ISPRIMARY = CONVERT(BIT, 0),
			KEY_SEQ = CONVERT(SMALLINT, 0),
			ISIDENTITY = C.COLSTAT,
			IDENTITY_START = CONVERT(INT, 0),
			IDENTITY_INCRT = CONVERT(INT, 0),
			ISREQUIRED = CONVERT(BIT, 0),
			DEFAULT_VALUE = CONVERT(VARCHAR(500), ''),
			MODIFIEDBY = 'SYSTEM',
			MODIFIEDAT = GETDATE()
		INTO
			#TABLEINFO
		FROM
			SYSCOLUMNS C
				LEFT OUTER JOIN SYSPROPERTIES P ON (C.ID = P.ID AND C.COLID = P.SMALLID)
				INNER JOIN SYSTYPES T ON (C.XTYPE = T.XTYPE)
		WHERE
			C.ID = OBJECT_ID(@TABLENAME)
		ORDER BY
			C.COLORDER

		CREATE TABLE #PKEYS
		(
			TABLE_QUALIFIER SYSNAME,
			TABLE_OWNER SYSNAME,
			TABLE_NAME SYSNAME,
			COLUMN_NAME SYSNAME,
			KEY_SEQ SMALLINT,
			PK_NAME SYSNAME
		)

		INSERT INTO #PKEYS EXEC SP_PKEYS @TABLENAME

		UPDATE
			I
		SET
			ISPRIMARY = 1,
			KEY_SEQ = K.KEY_SEQ
		FROM
			#TABLEINFO I,
			#PKEYS K
		WHERE
			I.FIELD_NAME = K.COLUMN_NAME

		UPDATE
			#TABLEINFO
		SET
			IDENTITY_START = ident_seed(@TABLENAME),
			IDENTITY_INCRT = ident_incr(@TABLENAME)
		WHERE
			ISIDENTITY = 1

		SELECT * FROM #TABLEINFO
		DROP TABLE #TABLEINFO
		DROP TABLE #PKEYS
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_LEDGER_EOD
-- --------------------------------------------------
CREATE PROC [dbo].[CLS_LEDGER_EOD]
	@PROCESS_TYPE TINYINT
AS

/*SELECT * FROM  CLS_LEDGER_REPORTS
EXEC  CLS_LEDGER_EOD 1*/

DECLARE
	@@EOD_STATUS BIT

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SELECT @@EOD_STATUS = EOD_STATUS FROM CLS_LEDGER_EOD_STATUS

IF @@EOD_STATUS = 0
	BEGIN

		BEGIN TRAN

		 UPDATE CLS_LEDGER_EOD_STATUS
		 SET EOD_STATUS = 1

		CREATE TABLE #CLS_ACMAST_EOD
		(
			CLTCODE VARCHAR(10),
			LONGNAME VARCHAR(100)
		)

		INSERT INTO
			#CLS_ACMAST_EOD
		SELECT
			CLTCODE, LONGNAME
		FROM
			ACMAST
		WHERE
			ACCAT IN (4, 104)

		IF @PROCESS_TYPE = 0
			BEGIN

				TRUNCATE TABLE CLS_LEDGER_REPORTS

				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					L.VNO,
					L.Vtyp,
					L.BookType,
					(CASE L.DRCR WHEN 'D' THEN VAMT ELSE 0 END),
					(CASE L.DRCR WHEN 'C' THEN VAMT ELSE 0 END),
					L.CLTCODE,
					LONGNAME,
					VDT,
					VDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 8, 7) ELSE '' END),
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 20, 1)ELSE '' END),
					'',
					1,
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', EDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					LEDGER L LEFT OUTER JOIN LEDGER1 L1
				ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE,
					#CLS_ACMAST_EOD A
				WHERE
					A.CLTCODE = L.CLTCODE AND L.VTYP NOT IN(15, 21)


				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					L.VNO,
					L.Vtyp,
					L.BookType,
					(CASE L.DRCR WHEN 'D' THEN VAMT ELSE 0 END),
					(CASE L.DRCR WHEN 'C' THEN VAMT ELSE 0 END),
					L.CLTCODE,
					LONGNAME,
					VDT,
					VDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 8, 7) ELSE '' END),
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 20, 1)ELSE '' END),
					'',
					1,
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', EDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					LEDGER L LEFT OUTER JOIN LEDGER1 L1
					ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO,
					#CLS_ACMAST_EOD A
				WHERE
					A.CLTCODE = L.CLTCODE AND L.VTYP IN(15, 21)


				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					ML.VNO,
					ML.Vtyp,
					ML.BookType,
					(CASE ML.DRCR WHEN 'D' THEN AMOUNT ELSE 0 END),
					(CASE ML.DRCR WHEN 'C' THEN AMOUNT ELSE 0 END),
					ML.PARTY_CODE,
					LONGNAME,
					ML.VDT,
					VDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					'',
					'',
					MCLTCODE,
					2,
					DATEDIFF(MINUTE , 'JAN  1 1998', ML.VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					MARGINLEDGER ML LEFT OUTER JOIN LEDGER1 L1
					ON ML.VNO = L1.VNO AND ML.VTYP = L1.VTYP AND ML.BOOKTYPE = L1.BOOKTYPE,
					#CLS_ACMAST_EOD A, (SELECT VNO, VTYP, BOOKTYPE, LNO, NARRATION FROM LEDGER WHERE VTYP IN(19, 20, 23, 24)) LL
				WHERE
					A.CLTCODE = ML.PARTY_CODE
					AND ML.VNO = LL.VNO AND ML.VTYP = LL.VTYP AND ML.BOOKTYPE = LL.BOOKTYPE AND ML.LNO = LL.LNO

				TRUNCATE TABLE CLS_LEDGER_TRIG

				UPDATE CLS_LEDGER_EOD_STATUS
				SET EOD_STATUS = 0


			END
		ELSE IF @PROCESS_TYPE = 1
			BEGIN
				DELETE
					L
				FROM
					CLS_LEDGER_REPORTS L, CLS_LEDGER_TRIG LT
				WHERE
					L.VNO = LT.VNO
					AND L.VTYP = LT.VTYP
					AND L.BOOKTYPE = LT.BOOKTYPE

				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					L.VNO,
					L.Vtyp,
					L.BookType,
					(CASE L.DRCR WHEN 'D' THEN VAMT ELSE 0 END),
					(CASE L.DRCR WHEN 'C' THEN VAMT ELSE 0 END),
					L.CLTCODE,
					LONGNAME,
					VDT,
					EDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 8, 7) ELSE '' END),
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 20, 1)ELSE '' END),
					'',
					1,
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', EDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					LEDGER L LEFT OUTER JOIN LEDGER1 L1
					ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE,
					#CLS_ACMAST_EOD A, (SELECT DISTINCT VNO, VTYP, BOOKTYPE FROM CLS_LEDGER_TRIG WHERE ENTRY IN(1, 2)) LT
				WHERE
					A.CLTCODE = L.CLTCODE
					AND L.VNO = LT.VNO
					AND L.VTYP = LT.VTYP
					AND L.BOOKTYPE = LT.BOOKTYPE
					AND L.VTYP NOT IN(15, 21)


				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					L.VNO,
					L.Vtyp,
					L.BookType,
					(CASE L.DRCR WHEN 'D' THEN VAMT ELSE 0 END),
					(CASE L.DRCR WHEN 'C' THEN VAMT ELSE 0 END),
					L.CLTCODE,
					LONGNAME,
					VDT,
					EDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 8, 7) ELSE '' END),
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 20, 1)ELSE '' END),
					'',
					1,
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', EDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					LEDGER L LEFT OUTER JOIN LEDGER1 L1
					ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO,
					#CLS_ACMAST_EOD A, (SELECT DISTINCT VNO, VTYP, BOOKTYPE FROM CLS_LEDGER_TRIG WHERE ENTRY IN(1, 2)) LT
				WHERE
					A.CLTCODE = L.CLTCODE
					AND L.VNO = LT.VNO
					AND L.VTYP = LT.VTYP
					AND L.BOOKTYPE = LT.BOOKTYPE
					AND L.VTYP IN(15, 21)



				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					ML.VNO,
					ML.Vtyp,
					ML.BookType,
					(CASE ML.DRCR WHEN 'D' THEN AMOUNT ELSE 0 END),
					(CASE ML.DRCR WHEN 'C' THEN AMOUNT ELSE 0 END),
					ML.PARTY_CODE,
					LONGNAME,
					ML.VDT,
					VDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					'',
					'',
					MCLTCODE,
					2,
					DATEDIFF(MINUTE , 'JAN  1 1998', ML.VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					MARGINLEDGER ML LEFT OUTER JOIN LEDGER1 L1
					ON ML.VNO = L1.VNO AND ML.VTYP = L1.VTYP AND ML.BOOKTYPE = L1.BOOKTYPE,
					#CLS_ACMAST_EOD A,
					(SELECT VNO, VTYP, BOOKTYPE, LNO, NARRATION FROM LEDGER WHERE VTYP IN(19, 20, 23, 24)) LL,
					(SELECT DISTINCT VNO, VTYP, BOOKTYPE FROM CLS_LEDGER_TRIG WHERE ENTRY IN(1, 2)) LT
				WHERE
					A.CLTCODE = ML.PARTY_CODE
					AND ML.VNO = LL.VNO
					AND ML.VTYP = LL.VTYP
					AND ML.BOOKTYPE = LL.BOOKTYPE
					AND ML.LNO = LL.LNO
					AND LL.VNO = LT.VNO
					AND LL.VTYP = LT.VTYP
					AND LL.BOOKTYPE = LT.BOOKTYPE

				TRUNCATE TABLE CLS_LEDGER_TRIG

				UPDATE CLS_LEDGER_EOD_STATUS
				SET EOD_STATUS = 0
			END
			COMMIT TRAN
	END
ELSE
	BEGIN
		SELECT 'THE EOD PROCESS IS ALREADY IN USE, PLEASE TRY AFTER SOME TIME.'
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_LEDGER_JOB
-- --------------------------------------------------
CREATE PROC [dbo].[CLS_LEDGER_JOB]
AS

DECLARE 
@@DATEDIFFERENCE DATETIME

BEGIN TRAN
CREATE TABLE #CLS_LED_JOB
(
	VNO VARCHAR(12),
	VTYP SMALLINT,
	BOOKTYPE VARCHAR(3)
)


SELECT @@DATEDIFFERENCE = DATEADD(MI, -15, GETDATE())

INSERT INTO #CLS_LED_JOB
SELECT 
	DISTINCT VNO, VTYP, BOOKTYPE 
FROM 
	CLS_LEDGER_TRIG
WHERE 
	UPDATED_DATE <= @@DATEDIFFERENCE
	

CREATE TABLE #CLS_ACMAST_EOD  
(  
 CLTCODE VARCHAR(10),  
 LONGNAME VARCHAR(100)  
)  
  
INSERT INTO   
 #CLS_ACMAST_EOD   
SELECT   
 CLTCODE, LONGNAME   
FROM   
 ACMAST   
WHERE  
 ACCAT IN (4, 104)  

 DELETE   
  L   
 FROM   
  CLS_LEDGER_REPORTS L, (SELECT VNO, VTYP, BOOKTYPE FROM #CLS_LED_JOB WHERE ENTRY IN(1, 2)) LT   
 WHERE  
  L.VNO = LT.VNO   
  AND L.VTYP = LT.VTYP  
  AND L.BOOKTYPE = LT.BOOKTYPE  

 INSERT INTO CLS_LEDGER_REPORTS  
 SELECT   
  L.VNO,  
  L.Vtyp,  
  L.BookType,  
  (CASE L.DRCR WHEN 'D' THEN VAMT ELSE 0 END),  
  (CASE L.DRCR WHEN 'C' THEN VAMT ELSE 0 END),  
  L.CLTCODE,  
  LONGNAME,  
  VDT,  
  EDT,  
  Narration,  
  DDNO,  
  'NSE',  
  'CAPITAL',  
  (CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 8, 7) ELSE '' END),  
  (CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 20, 1)ELSE '' END),  
  '',  
  1,  
  DATEDIFF(MINUTE , 'JAN  1 1998', VDT),  
  DATEDIFF(MINUTE , 'JAN  1 1998', EDT),  
  ChequeInName,  
  ChqPrinted,  
  DD,  
  BNKNAME,  
  ''  
 FROM  
  LEDGER L LEFT OUTER JOIN LEDGER1 L1  
  ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE,  
  #CLS_ACMAST_EOD A, (SELECT VNO, VTYP, BOOKTYPE FROM #CLS_LED_JOB WHERE ENTRY IN(1, 2)) LT  
 WHERE  
  A.CLTCODE = L.CLTCODE   
  AND L.VNO = LT.VNO   
  AND L.VTYP = LT.VTYP   
  AND L.BOOKTYPE = LT.BOOKTYPE  
  
  
    
 INSERT INTO CLS_LEDGER_REPORTS  
 SELECT   
  ML.VNO,  
  ML.Vtyp,  
  ML.BookType,  
  (CASE ML.DRCR WHEN 'D' THEN AMOUNT ELSE 0 END),  
  (CASE ML.DRCR WHEN 'C' THEN AMOUNT ELSE 0 END),  
  ML.PARTY_CODE,  
  LONGNAME,  
  ML.VDT,  
  EDT,  
  Narration,  
  DDNO,  
  'NSE',  
  'CAPITAL',  
  '',  
  '',  
  MCLTCODE,  
  2,  
  DATEDIFF(MINUTE , 'JAN  1 1998', ML.VDT),  
  DATEDIFF(MINUTE , 'JAN  1 1998', EDT),  
  ChequeInName,  
  ChqPrinted,  
  DD,  
  BNKNAME,  
  ''  
 FROM  
  MARGINLEDGER ML LEFT OUTER JOIN LEDGER1 L1  
   ON ML.VNO = L1.VNO AND ML.VTYP = L1.VTYP AND ML.BOOKTYPE = L1.BOOKTYPE,  
  #CLS_ACMAST_EOD A,   
  (SELECT VNO, VTYP, BOOKTYPE, LNO FROM LEDGER WHERE VTYP IN(19, 20, 23, 24)) LL,  
  (SELECT VNO, VTYP, BOOKTYPE FROM #CLS_LED_JOB WHERE ENTRY IN(1, 2)) LT  
 WHERE  
  A.CLTCODE = ML.PARTY_CODE  
  AND ML.VNO = LL.VNO   
  AND ML.VTYP = LL.VTYP   
  AND ML.BOOKTYPE = LL.BOOKTYPE   
  AND ML.LNO = LL.LNO  
  AND LL.VNO = LT.VNO   
  AND LL.VTYP = LT.VTYP  
  AND LL.BOOKTYPE = LT.BOOKTYPE  
  



 DELETE   
  LT   
 FROM   
  #CLS_LED_JOB L, CLS_LEDGER_TRIG LT   
 WHERE  
  L.VNO = LT.VNO   
  AND L.VTYP = LT.VTYP  
  AND L.BOOKTYPE = LT.BOOKTYPE  
  AND UPDATED_DATE <= @@DATEDIFFERENCE

COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATELASTVNO
-- --------------------------------------------------
CREATE PROC [dbo].[CREATELASTVNO]
AS
DECLARE
	@@SDTCUR AS DATETIME,
	@@LDTCUR AS DATETIME,
	@@VNOFLAG AS INT,
	@@BOOKTYPE AS VARCHAR(2),
	@@VCUR AS CURSOR,
	@@VNOCUR AS CURSOR


DELETE FROM LASTVNO WHERE VTYP = 8

SET @@VCUR = CURSOR FOR
	SELECT DISTINCT BOOKTYPE FROM BOOKTYPE WHERE VTYP = 8

OPEN @@VCUR
FETCH NEXT FROM @@VCUR INTO @@BOOKTYPE

WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @@VNOCUR = CURSOR FOR
			SELECT SDTCUR, LDTCUR, VNOFLAG FROM PARAMETER
		OPEN @@VNOCUR
		FETCH NEXT FROM @@VNOCUR INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
		WHILE @@FETCH_STATUS = 0
			BEGIN
				IF @@VNOFLAG = 0
					BEGIN
						INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO)
						SELECT VTYP = 8, BOOKTYPE = @@BOOKTYPE, VDT = CONVERT(VARCHAR(11), @@SDTCUR, 109), MAX(VNO)
						FROM LEDGER WHERE VDT BETWEEN @@SDTCUR AND @@LDTCUR AND VTYP = 8 AND BOOKTYPE = @@BOOKTYPE
					END
				ELSE IF @@VNOFLAG = 1
					BEGIN
						INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO)
						SELECT VTYP = 8, BOOKTYPE = @@BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), MAX(VNO)
						FROM LEDGER WHERE VDT BETWEEN @@SDTCUR AND @@LDTCUR AND VTYP = 8 AND BOOKTYPE = @@BOOKTYPE
						GROUP BY CONVERT(VARCHAR(11), VDT, 109)
					END
				ELSE IF @@VNOFLAG = 2
					BEGIN
						INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO)
						SELECT VTYP = 8, BOOKTYPE = @@BOOKTYPE, 
							VDT = CONVERT(VARCHAR(4), YEAR(VDT)) + '-' + CASE WHEN LEN(CONVERT(VARCHAR, MONTH(VDT))) = 1 THEN '0' + CONVERT(VARCHAR, MONTH(VDT)) ELSE CONVERT(VARCHAR, MONTH(VDT)) END + '-01', 
							MAX(VNO)
						FROM LEDGER WHERE VDT BETWEEN @@SDTCUR AND @@LDTCUR AND VTYP = 8 AND BOOKTYPE = @@BOOKTYPE
						GROUP BY CONVERT(VARCHAR(4), YEAR(VDT)) + '-' + CASE WHEN LEN(CONVERT(VARCHAR, MONTH(VDT))) = 1 THEN '0' + CONVERT(VARCHAR, MONTH(VDT)) ELSE CONVERT(VARCHAR, MONTH(VDT)) END + '-01'
					END
				FETCH NEXT FROM @@VNOCUR INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
			END
		FETCH NEXT FROM @@VCUR INTO @@BOOKTYPE
	END
DELETE FROM LASTVNO WHERE VTYP = 8 AND LASTVNO IS NULL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATEPARTYLEDGER
-- --------------------------------------------------
CREATE  PROC [dbo].[CREATEPARTYLEDGER]
AS
CREATE TABLE NEWPARTYLEDGER
	(
		BRANCH_CODE VARCHAR(11),
		BRANCH VARCHAR(40),
		CLTCODE VARCHAR(11),
		ACNAME VARCHAR(50),
		VDT DATETIME,
		EDT DATETIME,
		BRANCH_CD VARCHAR(10),
		SUB_BROKER VARCHAR(10),
		TRADER VARCHAR(20),
		FAMILY VARCHAR(10),
		AREA VARCHAR(10),
		REGION VARCHAR(50),
		PARTY VARCHAR(10),
		VAMT MONEY DEFAULT(0) NOT NULL,
		MAMT MONEY DEFAULT(0) NOT NULL,
		UNREALISED MONEY DEFAULT(0) NOT NULL,
		SPID SMALLINT
	)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATEPARTYLEDGER_new
-- --------------------------------------------------
CREATE  PROC [dbo].[CREATEPARTYLEDGER_new]
AS
CREATE TABLE NEWPARTYLEDGER1
	(
		BRANCH_CODE VARCHAR(11),
		BRANCH VARCHAR(40),
		CLTCODE VARCHAR(11),
		ACNAME VARCHAR(50),
		VDT DATETIME,
		EDT DATETIME,
		BRANCH_CD VARCHAR(10),
		SUB_BROKER VARCHAR(10),
		TRADER VARCHAR(20),
		FAMILY VARCHAR(10),
		AREA VARCHAR(10),
		REGION VARCHAR(50),
		PARTY VARCHAR(10),
		NSEVAMT MONEY DEFAULT(0) NOT NULL, 
		BSEVAMT MONEY DEFAULT(0) NOT NULL,
		NFOVAMT MONEY DEFAULT(0) NOT NULL,
		NSEMAMT MONEY DEFAULT(0) NOT NULL, 
		BSEMAMT MONEY DEFAULT(0) NOT NULL,
		NFOMAMT MONEY DEFAULT(0) NOT NULL,
		NSEUNREALISED MONEY DEFAULT(0) NOT NULL,
		BSEUNREALISED MONEY DEFAULT(0) NOT NULL,
		NFOUNREALISED MONEY DEFAULT(0) NOT NULL,
		NSEHTOTAL MONEY DEFAULT(0) NOT NULL, 
		BSEHTOTAL MONEY DEFAULT(0) NOT NULL,
		NFOHTOTAL MONEY DEFAULT(0) NOT NULL,
		VAMT MONEY DEFAULT(0) NOT NULL,
		MAMT MONEY DEFAULT(0) NOT NULL,
		UNREALISED MONEY DEFAULT(0) NOT NULL,
		HTOTAL MONEY DEFAULT(0) NOT NULL,
		SPID SMALLINT
		
	)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Data4BillPosted
-- --------------------------------------------------
CREATE PROC [dbo].[Data4BillPosted]

AS

DECLARE @@COUNTER AS NUMERIC
SELECT @@COUNTER = COUNT(*) FROM BILLPOSTED

IF @@COUNTER = 0
	BEGIN
		BEGIN TRAN
			INSERT 
			INTO BILLPOSTED 
				(
					VNO, 
					VTYP, 
					BOOKTYPE, 
					VDT, 
					BILLDATE, 
					SETT_NO, 
					SETT_TYPE, 
					NARRATION, 
					USERNAME, 
					POSTDATE, 
					EDTDR, 
					EDTCR
				) 
			SELECT 
				VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109), 
				CONVERT(VARCHAR(11), VDT, 109), 
				SUBSTRING(NARRATION, 8, 7), 
				SUBSTRING(NARRATION, 20, 1), 
				--CASE WHEN SUBSTRING(NARRATION, 20, 1) = 'A' THEN SUBSTRING(NARRATION, 20, 2) ELSE SUBSTRING(NARRATION, 20, 1) END, 
				NARRATION, 
				'FROM SYSTEM', 
				GETDATE(), 
				CONVERT(VARCHAR(11), MIN(EDT), 109), 
				CONVERT(VARCHAR(11), MAX(EDT), 109) 
			FROM LEDGER 
			WHERE VDT >= 'APR  1 2005' 
				AND VTYP IN (15, 21) 
			GROUP BY VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109), 
				SUBSTRING(NARRATION, 8, 7), 
				CASE 
					WHEN SUBSTRING(NARRATION, 20, 1) = 'A' 
					THEN SUBSTRING(NARRATION, 20, 2) 
					ELSE SUBSTRING(NARRATION, 20, 1) 
				END
				, 
				NARRATION 
			ORDER BY VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109) 
		COMMIT
	END
ELSE
	BEGIN
		PRINT 'Data Already Found in Table BillPosted. Cannot Continue...'
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DATA4PARTYLEDGER_TBL
-- --------------------------------------------------
CREATE PROC [dbo].[DATA4PARTYLEDGER_TBL]
AS
DECLARE @@SQL AS VARCHAR(8000)
BEGIN TRANSACTION
if NOT exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TBL_MASTER_PARTYLEDGER_BAK]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	BEGIN
		CREATE TABLE [dbo].[TBL_MASTER_PARTYLEDGER_BAK] (
			[SrNo] [int] NOT NULL ,
			[StatusId] [varchar] (25) NULL ,
			[ReportName] [varchar] (200) NULL ,
			[SummaryOpt] [varchar] (1) NULL ,
			[CallingSP] [varchar] (100) NULL ,
			[ReturnFields] [varchar] (1000) NULL 
		) ON [PRIMARY]
	END
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TBL_MASTER_PARTYLEDGER]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	BEGIN
		INSERT INTO TBL_MASTER_PARTYLEDGER_BAK SELECT * FROM TBL_MASTER_PARTYLEDGER
		TRUNCATE TABLE TBL_MASTER_PARTYLEDGER
	END
ELSE
	BEGIN
		CREATE TABLE [dbo].[TBL_MASTER_PARTYLEDGER] (
			[SrNo] [int] IDENTITY (1, 1) NOT NULL ,
			[StatusId] [varchar] (25) NULL ,
			[ReportName] [varchar] (200) NULL ,
			[SummaryOpt] [varchar] (1) NULL ,
			[CallingSP] [varchar] (100) NULL ,
			[ReturnFields] [varchar] (1000) NULL 
		) ON [PRIMARY]
	END

SELECT @@SQL = "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BROKER', 'BRANCH', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'BRANCH, BRANCH NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BROKER', 'SUBBROKER', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'SUBBROKER,SUBBROKER_NAME,$$LEDGER AMOUNT,$$MARGIN AMOUNT,$$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BROKER', 'AREA', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'AREA CODE, AREA NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BROKER', 'REGION', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'REGION CODE, REGION NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BROKER', 'TRADER', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'TRADER CODE, TRADER NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BROKER', 'FAMILY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'FAMILY CODE, FAMILY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BROKER', 'PARTY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'PARTY, PARTY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BRANCH', 'SUBBROKER', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'SUBBROKER,SUBBROKER_NAME,$$LEDGER AMOUNT,$$MARGIN AMOUNT,$$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BRANCH', 'AREA', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'AREA CODE, AREA NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BRANCH', 'REGION', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'REGION CODE, REGION NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BRANCH', 'TRADER', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'TRADER CODE, TRADER NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BRANCH', 'FAMILY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'FAMILY CODE, FAMILY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('BRANCH', 'PARTY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'PARTY, PARTY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('AREA', 'BRANCH', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'BRANCH, BRANCH NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('AREA', 'SUBBROKER', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'SUBBROKER,SUBBROKER_NAME,$$LEDGER AMOUNT,$$MARGIN AMOUNT,$$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('AREA', 'REGION', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'REGION CODE, REGION NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('AREA', 'TRADER', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'TRADER CODE, TRADER NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('AREA', 'FAMILY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'FAMILY CODE, FAMILY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('AREA', 'PARTY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'PARTY, PARTY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('REGION', 'BRANCH', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'BRANCH, BRANCH NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('REGION', 'SUBBROKER', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'SUBBROKER,SUBBROKER_NAME,$$LEDGER AMOUNT,$$MARGIN AMOUNT,$$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('REGION', 'AREA', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'AREA CODE, AREA NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('REGION', 'TRADER', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'TRADER CODE, TRADER NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('REGION', 'FAMILY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'FAMILY CODE, FAMILY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('REGION', 'PARTY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'PARTY, PARTY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('SUBBROKER', 'TRADER', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'TRADER CODE, TRADER NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('SUBBROKER', 'FAMILY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'FAMILY CODE, FAMILY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('SUBBROKER', 'PARTY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'PARTY, PARTY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('TRADER', 'SUBBROKER', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'SUBBROKER,SUBBROKER_NAME,$$LEDGER AMOUNT,$$MARGIN AMOUNT,$$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('TRADER', 'FAMILY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'FAMILY CODE, FAMILY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "
SELECT @@SQL = @@SQL + "INSERT INTO TBL_MASTER_PARTYLEDGER (StatusId,ReportName,SummaryOpt,CallingSP,ReturnFields) VALUES ('TRADER', 'PARTY', 'S', 'RPT_PARTYLEDGER_SUMMARY_V3', 'PARTY, PARTY NAME, $$LEDGER AMOUNT, $$MARGIN AMOUNT, $$UNREALISED AMOUNT, $$TOTAL AMOUNT') "

EXEC (@@SQL)


if NOT exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[SELECTION_LEVELS_PARTYLEDGER_BAK]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	BEGIN
		CREATE TABLE [dbo].[Selection_Levels_PartyLedger_Bak] (
			[Level_No] [smallint] NULL ,
			[Level_Name] [varchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL ,
			[Enable_Flg] [bit] NULL,
			[SNO] [int] IDENTITY (1,1) NOT NULL
		) ON [PRIMARY]
	END
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TBL_MASTER_PARTYLEDGER]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	BEGIN
		INSERT INTO Selection_Levels_PartyLedger_Bak (Level_No,Level_Name,Enable_Flg) SELECT Level_No,Level_Name,Enable_Flg FROM Selection_Levels_PartyLedger
		TRUNCATE TABLE Selection_Levels_PartyLedger
	END
ELSE
	BEGIN
		CREATE TABLE [dbo].[Selection_Levels_PartyLedger] (
			[Level_No] [smallint] NULL ,
			[Level_Name] [varchar] (20) NULL ,
			[Enable_Flg] [bit] NULL 
		) ON [PRIMARY]
	END

SELECT @@SQL = "INSERT INTO SELECTION_LEVELS_PARTYLEDGER (Level_No,Level_Name,Enable_Flg) VALUES ( '0', 'BROKER', '0') "
SELECT @@SQL = @@SQL + "INSERT INTO SELECTION_LEVELS_PARTYLEDGER (Level_No,Level_Name,Enable_Flg) VALUES ( '1', 'AREA', '0') "
SELECT @@SQL = @@SQL + "INSERT INTO SELECTION_LEVELS_PARTYLEDGER (Level_No,Level_Name,Enable_Flg) VALUES ( '1', 'REGION', '0') "
SELECT @@SQL = @@SQL + "INSERT INTO SELECTION_LEVELS_PARTYLEDGER (Level_No,Level_Name,Enable_Flg) VALUES ( '2', 'BRANCH', '1') "
SELECT @@SQL = @@SQL + "INSERT INTO SELECTION_LEVELS_PARTYLEDGER (Level_No,Level_Name,Enable_Flg) VALUES ( '3', 'SUBBROKER', '1') "
SELECT @@SQL = @@SQL + "INSERT INTO SELECTION_LEVELS_PARTYLEDGER (Level_No,Level_Name,Enable_Flg) VALUES ( '3', 'TRADER', '1') "
SELECT @@SQL = @@SQL + "INSERT INTO SELECTION_LEVELS_PARTYLEDGER (Level_No,Level_Name,Enable_Flg) VALUES ( '4', 'FAMILY', '1') "
SELECT @@SQL = @@SQL + "INSERT INTO SELECTION_LEVELS_PARTYLEDGER (Level_No,Level_Name,Enable_Flg) VALUES ( '5', 'PARTY', '1') "

EXEC (@@SQL)

COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delete_Ledger
-- --------------------------------------------------
CREATE Procedure [dbo].[Delete_Ledger]
@vno varchar(12)
as
delete from ledger where vtyp = '18' and booktype = '01' and vno= @vno

delete from ledger2 where vtype = '18' and booktype = '01' and vno= @vno

delete from ledger3 where vtyp = '18' and booktype = '01' and vno= @vno

delete from marginledger where vtyp = '18' and booktype = '01' and vno= @vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DRCRNOTEUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[DRCRNOTEUPLOAD_BULK]
	@FNAME VARCHAR(100),
	@UNAME VARCHAR(25),
	@VTYP SMALLINT,
	@BOOKTYPE VARCHAR(2),
	@USERCAT INT
AS
/*
	DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\Backoffice\DrCrNotes\CR TAMMANA2.csv'
	EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'
	EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'
*/
	SET NOCOUNT ON

	DECLARE
		@@ERROR_COUNT AS INT,
		@@SQL AS VARCHAR(2000),
		@@BACKDAYS INT,
		@@BACKDATE DATETIME

/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/
	IF LTRIM(RTRIM(@FNAME)) = ''
		BEGIN
			SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'
			RETURN
		END

	CREATE TABLE #FEXIST
		(F1 INT, F2 INT, F3 INT)
	
	SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "
	EXEC (@@SQL)

	SELECT @@ERROR_COUNT = F1 FROM #FEXIST
	IF @@ERROR_COUNT = 0
		BEGIN
			SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'
			DROP TABLE #FEXIST
			RETURN
		END

	BEGIN TRAN

	SELECT 
		@@ERROR_COUNT = COUNT(1) 
	FROM
		(SELECT 
			U_FILENAME 
		FROM 
			V2_UPLOADED_FILES
		WHERE 
			U_FILENAME = @FNAME 
			AND U_MODULE = 'DRCR NOTE UPLOAD') A

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME
			ROLLBACK TRAN
			RETURN
		END


	CREATE TABLE #RECPAY_TABLE_TMP
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500),
		BRANCHCODE VARCHAR(10)
	)

	CREATE TABLE [#RECPAY_TABLE]
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500),
		BRANCHCODE VARCHAR(10),
		SNO INT IDENTITY (1, 1) NOT NULL ,
		VDT DATETIME NULL ,
		UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),
		EDT DATETIME NULL ,
		VNO VARCHAR (12)  NULL ,
		ACNAME VARCHAR (100)  NULL ,
		FYSTART DATETIME NULL,
		FYEND DATETIME NULL,
		COSTCODE SMALLINT NULL,
		LNO SMALLINT NOT NULL DEFAULT(0)
	) ON [PRIMARY]

	CREATE TABLE [#RECPAY_TABLE_LNO]
	(
		SNO INT ,
		LNO INT IDENTITY (1, 1) NOT NULL
	) ON [PRIMARY]

	SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "
	EXEC(@@SQL)

      INSERT INTO V2_UPLOADED_FILES
      SELECT
		@FNAME,
		@FNAME,
		COUNT(1),
		'B',
		GETDATE(),
		@UNAME,
		'DRCR NOTE UPLOAD'

	INSERT INTO #RECPAY_TABLE
		(SRNO,
		VVDT,
		EEDT,
		CLTCODE,
		DRCR,
		AMOUNT,
		NARRATION,
		BRANCHCODE)
	SELECT
		SRNO,
		VVDT,
		EEDT,
		UPPER(CLTCODE),
		DRCR,
		AMOUNT,
		LEFT(NARRATION, 234),
		BRANCHCODE
	FROM #RECPAY_TABLE_TMP

	UPDATE
		#RECPAY_TABLE
		SET
			VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),
			EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),
			FYSTART = P.SDTCUR,
			FYEND = P.LDTCUR,
			UPDFLAG = 'Y',
			ACNAME = LONGNAME,
			#RECPAY_TABLE.COSTCODE = C.COSTCODE
      FROM ACMAST A, PARAMETER P, COSTMAST C
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
      AND P.CURYEAR = 1
      AND A.ACCAT IN ('3','4','104')
      AND A.BRANCHCODE = C.COSTNAME
      AND A.BRANCHCODE <> 'ALL'


	UPDATE
		#RECPAY_TABLE
		SET
			VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),
			EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),
			FYSTART = P.SDTCUR,
			FYEND = P.LDTCUR,
			UPDFLAG = 'Y',
			ACNAME = LONGNAME,
			#RECPAY_TABLE.COSTCODE = C.COSTCODE
      FROM ACMAST A, PARAMETER P, COSTMAST C
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
      AND P.CURYEAR = 1
      AND A.ACCAT IN ('3','4','104')
      AND #RECPAY_TABLE.BRANCHCODE = C.COSTNAME
      AND A.BRANCHCODE = 'ALL'
      AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'
      AND #RECPAY_TABLE.COSTCODE IS NULL



	UPDATE
		#RECPAY_TABLE
		SET
			VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),
			EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),
			FYSTART = P.SDTCUR,
			FYEND = P.LDTCUR,
			UPDFLAG = 'Y',
			ACNAME = LONGNAME,
			#RECPAY_TABLE.COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
      FROM ACMAST A, PARAMETER P
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
      AND P.CURYEAR = 1
      AND A.ACCAT IN ('3','4','104')
      AND A.BRANCHCODE = 'ALL'
      AND #RECPAY_TABLE.COSTCODE IS NULL
      


/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/

	DECLARE
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1)


/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'DATE MISMATCH'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
			RETURN
		END

/* '--------------------------UPDATE OF COST CODE ------------------------*/

	UPDATE #RECPAY_TABLE
		SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
	WHERE COSTCODE IS NULL

/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)
	GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
			WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
			RETURN
		END

/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM
		(SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM #RECPAY_TABLE
		GROUP BY SRNO
		HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
			WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
			RETURN
		END

/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT
			CLTCODE
		FROM #RECPAY_TABLE
		WHERE UPDFLAG = 'N'
	) A

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL
			SELECT DISTINCT
				CLTCODE
			FROM #RECPAY_TABLE
			WHERE UPDFLAG = 'N'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
			RETURN
		END


--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------
	SELECT  
		@@BACKDAYS = ISNULL(MAX(NODAYS), 0)  
	FROM  
		USERWRITESTABLE  
	WHERE  
		USERCATEGORY = @USERCAT  
		AND VTYP = @VTYP  
		AND BOOKTYPE = @BOOKTYPE  

	SELECT  
		@@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS  

	SELECT  
		@@ERROR_COUNT = ISNULL(COUNT(VDT), 0)  
	FROM  
		#RECPAY_TABLE  
	WHERE  
		VDT < @@BACKDATE  

	IF @@ERROR_COUNT > 0  
	BEGIN  
		SELECT  
			'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'  
		DROP TABLE #RECPAY_TABLE_TMP  
		DROP TABLE #RECPAY_TABLE  
		ROLLBACK TRAN  
		DELETE FROM V2_UPLOADED_FILES  
		WHERE  
			U_FILENAME = @FNAME  
			AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
		RETURN  
	END



	DECLARE
		@@NEWVNO AS VARCHAR(12),
		@@VDT AS VARCHAR(11),
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS INT,
		@@NOREC AS INT


/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/
	DECLARE
		@@MAXVNO AS VARCHAR(12),
		@@VNO AS VARCHAR(12),
		@@RCOUNT AS INT
	SELECT TOP 1
		@@VDT = CONVERT(VARCHAR(11), VDT, 109)
	FROM
		#RECPAY_TABLE

	SELECT TOP 1
		@@VNOMETHOD = VNOFLAG,
		@@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),
		@@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)
	FROM
		PARAMETER
	WHERE
		@@VDT BETWEEN SDTCUR AND LDTCUR

	SELECT
		@@NOREC = COUNT(DISTINCT SRNO)
	FROM
		#RECPAY_TABLE

	IF @@VNOMETHOD = 0
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, RIGHT(@@STD_DATE, 4) + '00000000') + @@NOREC)
					SELECT @@VNO = RIGHT(@@STD_DATE, 4) + '00000001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@STD_DATE, @@MAXVNO)
				END
		END
	ELSE IF @@VNOMETHOD = 1
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0000'
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)
					SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)
				END
		END
	ELSE IF @@VNOMETHOD = 2
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND MONTH(VDT) = MONTH(@@VDT)
				AND YEAR(VDT) = YEAR(@@VDT)
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000000'
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)
					SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND MONTH(VDT) = MONTH(@@VDT)
						AND YEAR(VDT) = YEAR(@@VDT)
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)
				END
		END

	UPDATE
		#RECPAY_TABLE
	SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)


/* '--------------------------AUTO GENERATION OF LNO ------------------------*/

	SET @@LNOCUR = CURSOR FOR
		SELECT DISTINCT SRNO FROM #RECPAY_TABLE
	OPEN @@LNOCUR
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	WHILE @@FETCH_STATUS = 0
		BEGIN
			INSERT INTO #RECPAY_TABLE_LNO
				(SNO)
			SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO
			UPDATE RP
				SET LNO = RL.LNO
			FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL
			WHERE RP.SNO = RL.SNO
			TRUNCATE TABLE #RECPAY_TABLE_LNO
			FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
		END
	CLOSE @@LNOCUR
	DEALLOCATE @@LNOCUR
	DROP TABLE #RECPAY_TABLE_LNO

/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/
/*==============================
      LEDGER RECORD
==============================*/
	INSERT
	INTO LEDGER
	SELECT
		VTYP = @VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT = AMOUNT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMOUNT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE,
		BOOKTYPE = @BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		#RECPAY_TABLE

/*==============================
	LEDGER3 RECORD
==============================*/
	INSERT
	INTO LEDGER3
	SELECT
		NARATNO = LNO,
		NARRATION,
		REFNO = 0,
		VTYP = @VTYP,
		VNO,
		BOOKTYPE = @BOOKTYPE
      FROM
		#RECPAY_TABLE




	DELETE FROM TEMPLEDGER2
		WHERE SESSIONID = '9999999999'
	INSERT INTO TEMPLEDGER2
	SELECT
		'BRANCH',
		C.COSTNAME,
		AMOUNT,
		VTYP = @VTYP,
		VNO,
		LNO,
		DRCR,
		'0',
		BOOKTYPE = @BOOKTYPE,
		SESSIONID = '9999999999',
		CLIENT_CODE = CLTCODE,
		'A',
		'0'
	FROM
		#RECPAY_TABLE RP,
		COSTMAST C
	WHERE
		RP.COSTCODE = C.COSTCODE

	DECLARE @@L2CUR AS CURSOR,
		@@L2VNO AS VARCHAR(12)
	SET @@L2CUR = CURSOR FOR
		SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO
	OPEN @@L2CUR
	FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	WHILE @@FETCH_STATUS = 0
		BEGIN
			EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'
			FETCH NEXT FROM @@L2CUR INTO @@L2VNO
		END
		DELETE FROM TEMPLEDGER2
			WHERE SESSIONID = '9999999999'
		CLOSE @@L2CUR
		DEALLOCATE @@L2CUR
	COMMIT TRAN

	SELECT RESULT = 'Data Uploaded Successfully'
	UNION ALL
	SELECT RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO FROM #RECPAY_TABLE
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EditReconcile
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 04/15/2004 11:47:27 AM ******/  
  
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 05/10/2004 5:29:32 PM ******/  
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 04/11/2002 7:26:31 PM ******/  
  
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 01/04/1980 1:40:37 AM ******/  
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 12/21/2001 12:40:04 PM ******/  
/*** Modified by VNS on 28/12/2001 to add book type ***/  
  
/* Created By VNS & Sandeep From Store Procedure Reconcile */  
  
CREATE PROCEDURE [dbo].[EditReconcile]    
@code varchar(10),  
@frmdate varchar(11),  
@gdate varchar(11),  
@gdrcr  varchar(1),  
@flag varchar(1),  
@tVamt numeric(17,2)  
AS  
 if @flag=1   
 begin  
  select  isnull(sum(vamt) ,0) ,drcr from ledger   
  where cltcode =    @code    and   vdt <= @gdate     
  group by drcr  
  order  by drcr  
 end  
   
 if @flag=2  
 begin  
  if @tvamt =  0    
  begin  
   select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , acname=isnull( acname ,''),  
   vno=l.vno, drcr=l.drcr ,lno=l.lno, vtyp=l.vtyp,chequeno=isnull(ddno,''), /*refno= l.refno ,*/amt= l.vamt,reldt=convert(varchar,ll1.reldt,103),booktype=l.booktype  
   From ledger l  ,LEDGER1 ll1   
   WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <>@code  
   /*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12)  and */  
   and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.booktype= l.booktype and ll1.lno = l.lno and ll1.drcr=l.drcr and  
   l.vno in  
    (select vno from ledger l1 where cltcode =@code   and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.vno = l.vno)  
    and ll1.reldt <>'1900-01-01 00:00:00.000' and vdt >= @frmdate and vdt < =  @gdate    and   l.drcr like  @gdrcr  
   order by  convert(varchar,l.vdt,101) ,l.vtyp,l.vno,l.drcr  
  end  
  
  if  @tvamt <>0  
  begin  
   select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , acname=isnull( acname ,''),  
   vno=l.vno, drcr=l.drcr ,lno=l.lno,vtyp=l.vtyp, chequeno=isnull(ddno,''),/* refno= l.refno ,*/amt= l.vamt,reldt=convert(varchar,ll1.reldt,103)  
   From ledger l  ,LEDGER1 LL1   
   WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <>@code  
   and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.lno = l.lno and ll1.drcr=l.drcr and  
   /*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12)  and */  
   l.vno in  
    (select vno from ledger l1 where cltcode =@code   and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.vno = l.vno)  
    and ll1.reldt <>'1900-01-01 00:00:00.000'  and vdt >= @frmdate and vdt < =  @gdate    and   l.drcr like  @gdrcr  
    and  vamt = @tVamt  
    order by   convert(varchar,l.vdt,101)  ,l.vtyp,l.vno,l.drcr  
  end  
 end  
 if @flag = 3  
 begin  
  select L.drcr, sum(vamt) from ledger L, ledger1 l1 where l.vtyp = l1.vtyp and l.booktype=l1.booktype and l.vno = l1.vno  
  and l1.reldt = '1900-01-01 00:00:00.000' AND CLTCODE =@CODE  
  GROUP BY L.DRCR   
 end  
  
/*SUBSTRING(LL1.REFNO,1, 12)=SUBSTRING(L.REFNO,1, 12) */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Edtyearend
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Edtyearend    Script Date: 05/10/2004 5:29:33 PM ******/
/****** Object:  Stored Procedure dbo.Edtyearend    Script Date: 02/18/2003 10:26:56 AM ******/
CREATE Procedure  [dbo].[Edtyearend]
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime,
@msg1   varchar(234)
AS

set transaction isolation level read uncommitted

declare
@@netdiff as money


truncate table edtclbal

insert into edtclbal
select l.cltcode,l.acname , balance=isnull(sum( case when upper(drcr) = 'D' then vamt else -vamt end),0)
from ledger l left outer join acmast a on l.cltcode = a.cltcode
where l.edt > = @sdtcur + ' 00:00:00' and l.edt <= @ldtcur + ' 23:59:59'
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l.cltcode <> '999999'
group by l.cltcode,l.acname
order by l.cltcode,l.acname

update ledger set balamt = e.balance from edtclbal e
where ledger.vtyp = @vtyp and ledger.booktype = @booktype and ledger.vno = @vno and ledger.cltcode = e.cltcode

select @@netdiff = ( select sum(balance) from edtclbal )

update ledger set balamt = isnull( case when @@netdiff > = 0 then -(@@netdiff) else abs(@@netdiff) end,0)
where vtyp = @vtyp and booktype = @booktype and vno = @vno and cltcode = '999999'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FASfocert2
-- --------------------------------------------------
  
CREATE proc FASfocert2  as  
   
SELECT A.FLDUSERNAME, a.fldcategory,a.fldstname, A.PWD_EXPIRY_DATE,a.EMAIL, A.EMP_NAME, A.SENIOR, A.SR_NAME, B.EMAIL AS senioremail    
INTO #temp3    
FROM (    
 SELECT A.FLDUSERNAME, a.fldcategory, a.fldstname,A.PWD_EXPIRY_DATE,b.EMAIL, B.EMP_NAME, B.SENIOR, B.SR_NAME    
 FROM TBLPRADNYAUSERS A, [196.1.115.132].RISK.DBO.EMP_INFO B,tblUserControlMaster c    
 WHERE A.FLDUSERNAME = B.EMP_NO    
 and a.fldauto=c.flduserid and     
 c.fldstatus=0    
  AND A.FLDUSERNAME LIKE 'E%'    
  --AND PWD_EXPIRY_DATE > '2014-07-01'    
 ) A    
left outer JOIN (    
 SELECT *  
 FROM [196.1.115.132].RISK.DBO.EMP_INFO B  
 where --and a.fldauto=c.flduserid and     
 --c.fldstatus=0    
  b.emp_no LIKE 'E%'    
  --AND PWD_EXPIRY_DATE > '2014-07-01'    
 ) B    
 ON (A.SENIOR = B.emp_no)    
    
    
  --drop table rightsMCDXCDS  
    
select     
c.*,b.fldReportName ,B.fldreportcode,'MCDXCDS' AS SEGMENT    
 INTO rightsMCDXCDS  
 from #temp3 c    
,tblcatmenu a inner join tblreports b on a.fldreportcode = b.fldreportcode    
Where     
fldcategorycode LIKE '%,' + c.fldcategory + ',%'    
order by 10    
   
  
  
--drop table rightsMCDXCDS1  
--SELECT * FROM RIGHTSNSE WhERE SENIOREMAIL LIKE 'hetvi%' order by emp_name     
  
select a.*,b.fldcategoryname into rightsMCDXCDS1 from  RIGHTSMCDXCDS a ,tblcategory b  
 where   
 a.fldcategory=b.fldcategorycode  
  
  
--drop table rightsMCDXCDS2  
  
  
select distinct a.* ,b.fldgrpname,d.fldmenuname into rightsMCDXCDS2  from  rightsMCDXCDS1 a,tblreportgrp b,tblreports c,tblmenuhead d  
where   
a.fldreportcode=c.fldreportcode  
and b.fldreportgrp=c.fldreportgrp and   
c.fldmenugrp=d.fldmenucode  
order by fldmenuname ,fldgrpname,fldreportname  
  
  
SELECT distinct A.*,max(B.AddDt) FROM rightsBse2 A with(nolock)  
INNER  JOIN   tblreports C with(nolock) ON A.FLDREPORTCODE=C.fldreportcode   
left outer join  V2_REPORT_ACCESS_LOG B  ON b.repPath= '`'+ c.fldpath + '`'  
where email  like 'RAJESH.jain%'  
group by a.FLDUSERNAME ,a.fldcategory ,a.fldstname, a.PWD_EXPIRY_DATE,a.EMAIL , a.EMP_NAME,a.SENIOR ,a.SR_NAME,a.senioremail,a.fldReportName,a.fldreportcode,  
 a.SEGMENT, a.fldcategoryname,a.fldgrpname , a.fldmenuname,a.EMP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.filldata
-- --------------------------------------------------
CREATE proc [dbo].[filldata] 
as
declare @@sql varchar(200)
set @@sql = 'select * from abc '
exec (@@sql)
set @@sql = 'select * from ledger'
exec (@@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FINDTBMISMATCH
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FINDTBMISMATCH]
	@FDATE VARCHAR(11) = '',
	@TDATE VARCHAR(11) = ''
AS
SET NOCOUNT ON
DECLARE
	@@DIFF AS MONEY,
	@@COUNTER AS INT

IF @FDATE = ''
	BEGIN
		SELECT @FDATE = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE CURYEAR = 1
	END
IF @TDATE = ''
	BEGIN
		SELECT @TDATE = CONVERT(VARCHAR(11), LDTCUR, 109) + ' 23:59' FROM PARAMETER WHERE CURYEAR = 1
	END

CREATE TABLE #LEDGERMISMATCH
	(
		PARTICULARS VARCHAR(30),
		DIFF MONEY,
		REMARK VARCHAR(100)
	)

INSERT INTO #LEDGERMISMATCH
SELECT 
	PARTICULARS = 'LEDGER TOTALS', 
	DIFF = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
	REMARK = ''
FROM
	LEDGER
WHERE 
	VDT BETWEEN @FDATE AND @TDATE

SELECT 
	@@DIFF = DIFF
FROM
	#LEDGERMISMATCH

IF @@DIFF <> 0
	BEGIN
		SELECT 
			PARTICULARS,
			DIFF,
			REMARK = CASE WHEN DIFF > 0 THEN 'DEBIT SIDE HEAVY' ELSE 'CREDIT SIDE HEAVY' END
		FROM
			#LEDGERMISMATCH
		CREATE TABLE #MISSVNO
			(
				VNO VARCHAR(12),
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2)
			)
		INSERT INTO #MISSVNO
		SELECT 
			VNO, 
			VTYP, 
			BOOKTYPE
		FROM
			LEDGER
		WHERE 
			VDT BETWEEN @FDATE AND @TDATE
		GROUP BY
			VNO, 
			VTYP, 
			BOOKTYPE
		HAVING
			SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) <> 0
		SELECT 
			@@COUNTER = COUNT(1) 
		FROM 
			#MISSVNO
		IF @@COUNTER > 0
			BEGIN
				SELECT 
					PARTICULARES = 'VOUCHERS WITH DEBIT AND CREDIT MISMATCHES'
				UNION ALL
				SELECT 
					PARTICULARS = VNO + ', ' + CONVERT(VARCHAR, VTYP) + ', ' + BOOKTYPE 
				FROM 
					#MISSVNO
			END
	END

	CREATE TABLE #MISSCLTS
		(
			CLTCODE VARCHAR(10)
		)
	INSERT INTO #MISSCLTS
	SELECT 
		CLTCODE
	FROM
		LEDGER L
	WHERE
		NOT EXISTS
		(
			SELECT 
				CLTCODE
			FROM 
				ACMAST A
			WHERE
				L.CLTCODE = A.CLTCODE
		)
		AND L.VDT BETWEEN @FDATE AND @TDATE
	SELECT 
		@@COUNTER = COUNT(1) 
	FROM
		#MISSCLTS
	IF @@COUNTER > 0
		BEGIN
			SELECT 
				PARTICULARS = 'FOLLOWING CLIENTS DO NOT EXIST IN ACMAST BUT IN LEDGER'
			UNION ALL
			SELECT 
				PARTICULARS = CLTCODE
			FROM 
				#MISSCLTS
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fun
-- --------------------------------------------------

CREATE PROC Fun @fun VARCHAR(25)AS           
Select * from sysobjects where name Like '%' + @fun + '%' and xtype='FN' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Generate_Vno
-- --------------------------------------------------
CREATE PROC [dbo].[Generate_Vno]

	@vdt      varchar(11),  /* dd/mm/yyyy */                
	@vtyp     smallint,                
	@booktype varchar(2),                
	@sdtcur   varchar(11),                
	@ldtcur   varchar(11),      
	@acc_serevr1 varchar(15),
	@acc_db1 varchar(15),
	@exchange1 varchar(10),
	@acc_serevr2 varchar(15),
	@acc_db2 varchar(15),
	@exchange2 varchar(10),
	@acc_serevr3 varchar(15),
	@acc_db3 varchar(15),
	@exchange3 varchar(10),
	@noofrecords int = 1      

as

declare
@@sql varchar(1000)

create table #vno_table 
(
	NSEVNO VARCHAR(12),
	BSEVNO VARCHAR(12),
	FOVNO VARCHAR(12)
)

insert into #vno_table values('', '', '')


create table #vno
(
	vno varchar(12)
)



	set @@sql = "insert into #vno exec " + @acc_serevr1 + "." + @acc_db1 + ".dbo.Acc_GenVno_New '" + @vdt + "'," + convert(varchar,@vtyp) + ",'" + @booktype + "','" + @sdtcur + "','" + @ldtcur + "'"
	print @@sql
	exec (@@sql)

	if @exchange1 = "NSE" 
	BEGIN
		update #vno_table set NSEVNO = vno from #vno
	END	
	Else if @exchange1 = "BSE" 
	BEGIN
		update #vno_table set BSEVNO = vno from #vno
	END	
	Else If @exchange1 = "FO" 
	BEGIN
		update #vno_table set FOVNO = vno from #vno
	END	

	truncate table #vno

	set @@sql = "insert into #vno exec " + @acc_serevr2 + "." + @acc_db2 + ".dbo.Acc_GenVno_New '" + @vdt + "'," + convert(varchar,@vtyp) + ",'" + @booktype + "','" + @sdtcur + "','" + @ldtcur + "'"
	print @@sql
	exec (@@sql)

	if @exchange2 = "NSE" 
	BEGIN
		update #vno_table set NSEVNO = vno from #vno
	END	
	Else if @exchange2 = "BSE" 
	BEGIN
		update #vno_table set BSEVNO = vno from #vno
	END	
	Else If @exchange2 = "FO" 
	BEGIN
		update #vno_table set FOVNO = vno from #vno
	END	

	truncate table #vno

	set @@sql = "insert into #vno exec " + @acc_serevr3 + "." + @acc_db3 + ".dbo.Acc_GenVno_New '" + @vdt + "'," + convert(varchar,@vtyp) + ",'" + @booktype + "','" + @sdtcur + "','" + @ldtcur + "'"
	print @@sql
	exec (@@sql)

	if @exchange3 = "NSE" 
	BEGIN
		update #vno_table set NSEVNO = vno from #vno
	END	
	Else if @exchange3 = "BSE" 
	BEGIN
		update #vno_table set BSEVNO = vno from #vno
	END	
	Else If @exchange3 = "FO" 
	BEGIN
		update #vno_table set FOVNO = vno from #vno
	END	


	select * from #vno_table

GO

-- --------------------------------------------------
-- PROCEDURE dbo.get_currentopentry
-- --------------------------------------------------
Create Proc [dbo].[get_currentopentry] 
(@Sdtcur Datetime) AS

Select SdtCur = Left(Convert(Varchar, SdtCur, 109), 11) from parameter
where @Sdtcur between sdtcur and ldtcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetBillDataSum
-- --------------------------------------------------
CREATE Proc [dbo].[GetBillDataSum]  
@Sett_No As Varchar(7),  
@Sett_Type As Varchar(2),  
@ShareDb As Varchar(15),  
@DispOpt As Varchar(7) = 'Summary',  
@Disp123 As Varchar(2) = 'N'  
  
--exec GetBillDataSum '2004042', 'N', 'MSAJAG', 'Details'  
--Exec GetBillDataSum '2004059', 'A ', 'MSAJAG'  
  
As  
  
Declare  
@@SQLQry As Varchar(2000)  
  
Set @@SQLQry = "Select Party_Code, M.Acname, Round(Amount,2) As Amount, Sell_Buy, Bill_No From " + @ShareDb + " "  
Set @@SQLQry = @@SQLQry + ".Dbo.Accbill a, Acmast m  WITH(NOLOCK)"  
Set @@SQLQry = @@SQLQry + " Where Sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"  
Set @@SQLQry = @@SQLQry + " And A.party_code = M.Cltcode and branchcd = 'ZZZ' "  
--Set @@SQLQry = @@SQLQry + " And Round(Amount,2) <> 0 "  
Set @@SQLQry = @@SQLQry + " union all "  
  
If @DispOpt = 'Summary'  
 Begin  
  Set @@SQLQry = @@SQLQry + " Select 'Party Dr', 'Party Amount Receivables', Round(sum(Amount),2) As Amount, Sell_buy, bill_no "  
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.accbill a, "  
  Set @@SQLQry = @@SQLQry + " Acmast m  where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"  
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "  
  Set @@SQLQry = @@SQLQry + " group by bill_no, Sell_Buy "  
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "  
  Set @@SQLQry = @@SQLQry + " union all "  
 End  
Else  
 Begin  
  Set @@SQLQry = @@SQLQry + " Select Party_Code ,M.AcName, Round(sum(Amount),2) As Amount, Sell_buy, bill_no "  
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.accbill a, "  
  Set @@SQLQry = @@SQLQry + " Acmast m  where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"  
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "  
  Set @@SQLQry = @@SQLQry + " group by Party_Code ,M.AcName, bill_no, Sell_Buy "  
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "  
  Set @@SQLQry = @@SQLQry + " union all "  
 End  
If @DispOpt = 'Summary'  
 Begin  
  Set @@SQLQry = @@SQLQry + " Select 'Party CR', 'Party Amount Payables', Round(sum(Amount),2) As Amount,Sell_buy, bill_no "  
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.Accbill a, acmast m "  
  Set @@SQLQry = @@SQLQry + " where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"  
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "  
  Set @@SQLQry = @@SQLQry + " group by bill_no, Sell_Buy "  
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "  
 End  
Else  
 Begin  
  Set @@SQLQry = @@SQLQry + " Select Party_Code, M.AcName, Round(sum(Amount),2) As Amount,Sell_buy, bill_no "  
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.Accbill a, acmast m "  
  Set @@SQLQry = @@SQLQry + " where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"  
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "  
  Set @@SQLQry = @@SQLQry + " group by Party_Code, M.AcName, bill_no, Sell_Buy "  
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "  
 End  
  
Print @@SQLQry  
Exec(@@SQLQry)  
  
SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETDATA_EDIT_All
-- --------------------------------------------------
CREATE PROC [dbo].[GETDATA_EDIT_All]          
@Fdate Varchar(11),            /* As Mmm Dd Yyyy */                  
@Tdate Varchar(11),            /* As Mmm Dd Yyyy */              
@VTYP INT,          
@BANKCODE VARCHAR(10),      
@VNO_FR VARCHAR(12),          
@VNO_TO VARCHAR(12),          
@VDT VARCHAR(11) = '',          
@VAMT MONEY = 0,            
@BOOKTYPE VARCHAR(3),          
@CLTCODE VARCHAR(10) = '',          
@PageSize varchar(3) = '25'          
AS          
          
CREATE TABLE #GETDATA_EDIT          
(          
 VNO VARCHAR(12),           
 CLTCODE VARCHAR(10),           
 ACNAME VARCHAR(100),           
 VAMT MONEY,           
 NARRATION VARCHAR(250),           
 DDNO VARCHAR(20),           
 RELDT VARCHAR(10),          
 BNKNAME VARCHAR(35),      
 VDT VARCHAR(10),  
 LNO INT          
)          
          
DECLARE          
@@SQL VARCHAR(1000)          
          
SET @@SQL = " INSERT INTO #GETDATA_EDIT "          
SET @@SQL = @@SQL + " SELECT TOP " + @PageSize        
SET @@SQL = @@SQL + " L.VNO, CLTCODE, ACNAME, VAMT = CASE L.DRCR WHEN 'D' THEN -VAMT ELSE VAMT END, NARRATION, DDNO, RELDT = CONVERT(VARCHAR(10), RELDT, 103), BNKNAME, CONVERT(VARCHAR(10), VDT, 103), L.LNO "          
SET @@SQL = @@SQL + " FROM "          
SET @@SQL = @@SQL + " LEDGER L, LEDGER1 L1 "          
SET @@SQL = @@SQL + " WHERE "          
SET @@SQL = @@SQL + " L.VNO = L1.VNO "          
SET @@SQL = @@SQL + " AND L.VTYP = L1.VTYP "          
SET @@SQL = @@SQL + " AND L.BOOKTYPE = L1.BOOKTYPE "          
IF @VTYP = 5   
BEGIN  
SET @@SQL = @@SQL + " AND L.LNO = L1.LNO "          
END  
IF @VTYP <> 5   
BEGIN  
 SET @@SQL = @@SQL + " AND L.LNO =1 "          
END  
--SET @@SQL = @@SQL + " AND L.VNO = L2.VNO "          
--SET @@SQL = @@SQL + " AND L.VTYP = L2.VTYP "          
--SET @@SQL = @@SQL + " AND L.BOOKTYPE = L2.BOOKTYPE "          
SET @@SQL = @@SQL + " AND L.CLTCODE = '" + @BANKCODE + "'"       
IF @VDT = ''           
 BEGIN           
 SET @@SQL = @@SQL + " AND VDT BETWEEN '" + @Fdate + "' And '" + @Tdate + " 23:59:59' "      
END      
ELSE      
BEGIN      
 SET @@SQL = @@SQL + " AND VDT LIKE '" + @VDT + "%' "      
END      
SET @@SQL = @@SQL + " AND L.VTYP = " + CONVERT(VARCHAR, @VTYP)          
SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @VNO_FR + "' AND '" + @VNO_TO +"' "          
SET @@SQL = @@SQL + " AND L.BOOKTYPE = '" + @BOOKTYPE + "' "        
        
IF @VAMT <> 0          
 BEGIN          
 SET @@SQL = @@SQL + " AND L.VAMT = " + CONVERT(VARCHAR,@VAMT) + " "          
 END          
          
IF @CLTCODE <> ''          
 BEGIN          
 SET @@SQL = @@SQL + " AND L.CLTCODE = '" + @CLTCODE + "' "          
 END          
          
/*IF @VDT = ''           
 BEGIN           
  SET @@SQL = @@SQL + " AND L.VDT BETWEEN '" + @Fdate + "' And '" + @Tdate + " 23:59:59' "          
 END           
ELSE           
 BEGIN           
  SET @@SQL = @@SQL + " AND L.VDT LIKE '" + @VDT + "%' "          
 END     */      
  SET @@SQL = @@SQL + " ORDER BY L.VNO "          
        
print @@SQL      
EXEC (@@SQL)          
          
/*DELETE FROM #GETDATA_EDIT          
WHERE           
EXISTS           
 (      
  SELECT VNO FROM LEDGER L WHERE L.VNO = #GETDATA_EDIT.VNO AND L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE          
  GROUP BY VNO, VTYP, BOOKTYPE HAVING COUNT(1) > 2         
 )*/          
  
IF @VTYP = 5  
BEGIN  
 UPDATE G SET RELDT = L1.RELDT FROM #GETDATA_EDIT G, LEDGER1 L1  
 WHERE L1.VNO = G.VNO AND L1.VTYP = @VTYP AND L1.RELDT <> ''  
END  
          
SELECT * FROM #GETDATA_EDIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetIBillDataSum
-- --------------------------------------------------
CREATE     Proc [dbo].[GetIBillDataSum]
@Sett_No As Varchar(7),
@Sett_Type As Varchar(2),
@ShareDb As Varchar(15),
@DispOpt As Varchar(7) = 'Summary'

--exec GetBillDataSum '2004042', 'N', 'MSAJAG'
--Exec GetBillDataSum '2004059', 'A ', 'MSAJAG'

As

Declare
@@SQLQry As Varchar(2000)

Set @@SQLQry = "Select Party_Code, M.Acname, Round(Amount,2) As Amount, Sell_Buy, Bill_No From " + @ShareDb + " "
Set @@SQLQry = @@SQLQry + ".Dbo.IAccbill a, Acmast m  WITH(NOLOCK)"
Set @@SQLQry = @@SQLQry + " Where Sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"
Set @@SQLQry = @@SQLQry + " And A.party_code = M.Cltcode and branchcd = 'ZZZ' "
--Set @@SQLQry = @@SQLQry + " And Round(Amount,2) <> 0 "
Set @@SQLQry = @@SQLQry + " union all "

If @DispOpt = 'Summary'
	Begin
		Set @@SQLQry = @@SQLQry + " Select 'Party DR', 'Party Amount Receivables', Round(sum(Amount),2) As Amount, Sell_buy, bill_no "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.IAccbill a, "
		Set @@SQLQry = @@SQLQry + " Acmast m  where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "
		Set @@SQLQry = @@SQLQry + " group by bill_no, Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
		Set @@SQLQry = @@SQLQry + " union all "
	End
Else
	Begin
		Set @@SQLQry = @@SQLQry + " Select Party_Code, M.AcName, Round(sum(Amount),2) As Amount, Sell_buy, bill_no "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.IAccbill a, "
		Set @@SQLQry = @@SQLQry + " Acmast m  where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "
		Set @@SQLQry = @@SQLQry + " group by Party_Code, M.AcName, bill_no, Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
		Set @@SQLQry = @@SQLQry + " union all "
	End
	
If @DispOpt = 'Summary'
	Begin
		Set @@SQLQry = @@SQLQry + " Select 'Party CR', 'Party Amount Payables', Round(sum(Amount),2) As Amount,Sell_buy, bill_no "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.IAccbill a, acmast m "
		Set @@SQLQry = @@SQLQry + " where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "
		Set @@SQLQry = @@SQLQry + " group by bill_no, Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
	End
Else
	Begin
		Set @@SQLQry = @@SQLQry + " Select Party_Code, M.AcName, Round(sum(Amount),2) As Amount,Sell_buy, bill_no "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.IAccbill a, acmast m "
		Set @@SQLQry = @@SQLQry + " where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "
		Set @@SQLQry = @@SQLQry + " group by Party_Code, M.AcName, bill_no, Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
	End

Print @@SQLQry
Exec(@@SQLQry)

SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetManualBankReco
-- --------------------------------------------------
CREATE  Proc [dbo].[GetManualBankReco]
	@BankCode Varchar(10),
	@FDate Varchar(11),
	@TDate Varchar(11),
	@Edit SmallInt,
	@SVtyp Varchar(5),
	@OrderBy Varchar(15),
      @DDno Varchar(15),
	@SelectRl Varchar(20) = ''
As
Declare @@SelectQury As Varchar(2000)
	Select @@SelectQury = "Select L.AcName, L1.DrCr, L.CltCode, L1.DDNO, Convert(Varchar(10), dddt, 103) as Dddt, CONVERT(VARCHAR(10),reldt,103) AS  reldt1, "
	Select @@SelectQury = @@SelectQury + "L.Vamt as RelAmt, Convert(Varchar(10), L.Vdt, 103) As Vdt, "
	Select @@SelectQury = @@SelectQury + "CONVERT(VARCHAR(10),vdt,101) AS   vdt1,l1.vno,l1.vtyp,l1.booktype,l1.lno,reldt ,ShortDesc "
	Select @@SelectQury = @@SelectQury + "From Ledger L, Ledger1 L1, VMast V, (Select Vno, Vtyp, BookType From Ledger Where CltCode = '" + @BankCode + "' "
	If @SVtyp = 'All'
		Begin
			Select @@SelectQury = @@SelectQury + "And Vtyp In (2,3,5,19,20,17) "
		End
	Else
		Begin
			If @SVtyp = '2'
				Begin
					Select @@SelectQury = @@SelectQury + "And Vtyp = 2 "
				End
			Else
				Begin
					If @SVtyp = '3'
						Begin
							Select @@SelectQury = @@SelectQury + "And Vtyp = 3 "
						End
				End
		End
      If @FDate <> ''
        Begin
	    Select @@SelectQury = @@SelectQury + "And Vdt Between '" + @FDate + "' And '" + @TDate + " 23:59:59') L2 "
        End
      Else
        Begin
            Select @@SelectQury = @@SelectQury + ") L2 "
        End
	Select @@SelectQury = @@SelectQury + "Where L.Vno = L2.Vno and L.Vtyp = L2.Vtyp And L.BookType = L2.Booktype And L.CLtcode <> '" + @BankCode + "' "
	Select @@SelectQury = @@SelectQury + "And L.Vno = L1.Vno and L.Vtyp = L1.Vtyp ANd L.BookType = L1.Booktype ANd L.Lno = L1.Lno "
      If @Ddno <> ''
        Begin
	     Select @@SelectQury = @@SelectQury + "And L1.Ddno = '" + @Ddno + "'"
        End
/*
	If @SelectRl = 'chkRelDt'
		Begin
			Select @@SelectQury = @@SelectQury + "And L1.RelDt Between '" + @FDate + "' And '" + @TDate + " 23:59:59' "
		End
	Else
		Begin
			Select @@SelectQury = @@SelectQury + "And L.Vdt Between '" + @FDate + "' And '" + @TDate + " 23:59:59' "
		End
*/
	If @Edit = 1
		Begin
			Select @@SelectQury = @@SelectQury + "And reldt Not Like 'Jan  1 1900%' "
		End
	Else
		Begin
			Select @@SelectQury = @@SelectQury + "And reldt Like 'Jan  1 1900%' "
		End
	Select @@SelectQury = @@SelectQury + "And v.Vtype = l.vtyp and (upper(clear_mode) <> 'C') "
	If @OrderBy = 'relamt'
		Begin
			Select @@SelectQury = @@SelectQury + "Order By relamt ,vdt1 ,l1.vtyp,l1.vno "
		End
	Else
		Begin
			If @OrderBy = 'vdt'
				Begin
					Select @@SelectQury = @@SelectQury + "Order By vdt1, relamt, l1.vtyp, l1.vno "
				End
			Else
				Begin
					If @OrderBy = 'ddno'
						Begin
							Select @@SelectQury = @@SelectQury + "Order By ddno, relamt, l1.vtyp, l1.vno "
						End
					Else
						Begin
							If @OrderBy = 'reldt'
								Begin
									Select @@SelectQury = @@SelectQury + "Order By reldt, relamt, l1.vtyp, l1.vno "
								End
						End
				End
		End
Print @@SelectQury
Exec (@@SelectQury)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETPARADATE
-- --------------------------------------------------
CREATE PROC [dbo].[GETPARADATE]
/*
	EXEC GETPARADATE 'DEC  1 2006', 'DEC 15 2006'
	EXEC GETPARADATE '01/12/2006', '15/12/2006'
Exec GETPARADATE '01/04/2006', '09/05/2006' 
*/
	@@FROMDT AS VARCHAR(11),
	@@TODT AS VARCHAR(11)
AS
DECLARE
	@@DIFF AS INT,
	@@ISBRIT AS TINYINT

SELECT @@ISBRIT = 0
IF LEN(LTRIM(RTRIM(@@FROMDT))) = 10
	BEGIN
		SELECT @@FROMDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @@FROMDT, 103),109)
		SELECT @@ISBRIT = 1
	END
IF LEN(LTRIM(RTRIM(@@TODT))) = 10
	BEGIN
		SELECT @@TODT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @@TODT, 103),109)
	END


SELECT @@DIFF = 0
SELECT @@DIFF = ISNULL(REPORTDAYS, 0) FROM PARAMETER WHERE @@TODT BETWEEN SDTCUR AND LDTCUR
IF @@DIFF = 0
	BEGIN
		IF @@ISBRIT = 0
			BEGIN
				SELECT @@FROMDT
			END
		ELSE
			BEGIN
				SELECT CONVERT(VARCHAR(10), CONVERT(DATETIME, @@FROMDT), 103)
			END
	END
ELSE
	BEGIN
		IF @@ISBRIT = 0
			BEGIN
				SELECT  ( 
				CASE 
					WHEN CONVERT(DATETIME, @@TODT, 109) - @@DIFF > CONVERT(DATETIME, @@FROMDT, 109) 
					THEN CONVERT(VARCHAR(11), CONVERT(DATETIME, @@TODT, 109) - @@DIFF, 109) 
					ELSE CONVERT(VARCHAR(11), @@FROMDT, 109) 
				END 
				)
			END
		ELSE
			BEGIN
				SELECT  ( 
				CASE 
					WHEN CONVERT(DATETIME, @@TODT, 109) - @@DIFF > CONVERT(DATETIME, @@FROMDT, 109) 
					THEN CONVERT(VARCHAR(10), CONVERT(DATETIME, @@TODT, 109) - @@DIFF, 103) 
					ELSE CONVERT(VARCHAR(10), CONVERT(DATETIME, @@FROMDT), 103) 
				END 
				)
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IMPORTOPENINGBAL
-- --------------------------------------------------
--EXEC IMPORTOPENINGBAL 'D:\BackOffice\OPENINGBALANE\OPENING.csv', 'ASHOKS'
CREATE PROC [dbo].[IMPORTOPENINGBAL]
(  
      @FILENAME VARCHAR(500),  
      @UPLOADBY VARCHAR(100)  
)  
AS  
  
DECLARE     
      @@ERROR_COUNT INT  
  
BEGIN TRAN  
  
CREATE TABLE [#OPENING_BALANCE_LNO]    
(    
SNO INT ,    
LNO INT IDENTITY (1, 1) NOT NULL    
) ON [PRIMARY]    
  
UPDATE     
 V2_OPENING_BALANCE     
 SET    
                  BRANCHCODE = A.BRANCHCODE,  
  FYSTART = P.SDTCUR,      
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,     
  COSTCODE = C.COSTCODE    
      FROM ACMAST A, PARAMETER P, COSTMAST C        
      WHERE A.CLTCODE = V2_OPENING_BALANCE.CLTCODE     
      AND P.CURYEAR = 1     
      AND A.BRANCHCODE = C.COSTNAME    
  
UPDATE     
 V2_OPENING_BALANCE     
 SET    
                  BRANCHCODE = 'HO',  
  FYSTART = P.SDTCUR,      
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,     
  COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  
      FROM ACMAST A, PARAMETER P  
      WHERE A.CLTCODE = V2_OPENING_BALANCE.CLTCODE     
      AND P.CURYEAR = 1     
      AND A.BRANCHCODE = 'ALL'  
  
  
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/   
  
      DECLARE     
            @@STD_DATE VARCHAR(11),    
            @@LST_DATE VARCHAR(11),    
            @@VNOMETHOD INT,     
            @@ACNAME CHAR(100),     
            @@BOOKTYPE CHAR(2),     
            @@MICRNO VARCHAR(10),    
            @@DRCR VARCHAR(1),    
            @@VTYP SMALLINT,  
            @@MONTHLYVDT  VARCHAR(11),  
            @@BACKDAYS SMALLINT,  
            @@BACKDATE VARCHAR(11)  
  
  
/* '--------------------------UPDATE OF COST CODE ------------------------*/   
  
UPDATE V2_OPENING_BALANCE   
 SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')   
WHERE COSTCODE IS NULL   
  
/*--------------------------VALIDATION FOR AMOUNT SHOLD NOT BE ZERO OR NEGATIVE------------------------*/    
  
SELECT @@ERROR_COUNT = COUNT(1) FROM  
         (SELECT AMOUNT   
 FROM V2_OPENING_BALANCE    
         WHERE AMOUNT <= 0) A  
  
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT 'VOUCHER AMOUNT CANNOT BE ZERO OR NEGATIVE.', 'NA', 'NA'     
  ROLLBACK TRAN     
  DELETE FROM V2_UPLOADED_FILES     
  WHERE U_FILENAME = @FILENAME AND U_MODULE = 'OPENING UPLOAD'     
  RETURN     
 END     
  
  
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/    
  
SELECT @@ERROR_COUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)    
 FROM V2_OPENING_BALANCE    
  
IF @@ERROR_COUNT <> 0      
 BEGIN      
  SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.', 'NA', 'NA'     
  ROLLBACK TRAN     
  DELETE FROM V2_UPLOADED_FILES     
  WHERE U_FILENAME = @FILENAME AND U_MODULE = 'OPENING UPLOAD'     
  RETURN     
 END     
  
/*-------------------------- VALIDATION FOR DUPLICATE CLIENT_CODES EXISTS IN FILE ---------------------*/  
SELECT @@ERROR_COUNT = COUNT(1) FROM  
(  
      SELECT CLTCODE   
      FROM V2_OPENING_BALANCE    
      GROUP BY CLTCODE  
      HAVING COUNT(CLTCODE) > 1  
) A  
  
IF @@ERROR_COUNT > 0     
 BEGIN     
  SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS ARE DULICATED IN EXISTING FILE', 'NA', 'NA'    UNION ALL    
                  SELECT CLTCODE, 'NA', 'NA'      
                  FROM V2_OPENING_BALANCE    
                  GROUP BY CLTCODE  
                  HAVING COUNT(CLTCODE) > 1  
  ROLLBACK TRAN    
  DELETE FROM V2_UPLOADED_FILES    
   WHERE U_FILENAME = @FILENAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'    
  RETURN    
 END    
  
  
  
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/   
  
SELECT @@ERROR_COUNT = COUNT(1) FROM    
(    
 SELECT DISTINCT    
  CLTCODE    
 FROM V2_OPENING_BALANCE    
 WHERE UPDFLAG = 'N'    
) A    
  
  
        
IF @@ERROR_COUNT > 0     
 BEGIN     
  SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA', 'NA'    UNION ALL    
  SELECT DISTINCT   
   CLTCODE, 'NA', 'NA'       
  FROM V2_OPENING_BALANCE    
  WHERE UPDFLAG = 'N'    
  ROLLBACK TRAN    
  DELETE FROM V2_UPLOADED_FILES    
   WHERE U_FILENAME = @FILENAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'    
  RETURN    
 END    
  
DECLARE     
 @@NEWVNO AS VARCHAR(12),  
 @@VDT AS VARCHAR(11),     
 @@LNOCUR AS CURSOR,     
 @@LNOVNO AS INT     
  
  
/* '--------------------------AUTO GENERATION OF VNO ------------------------*/   
  
SELECT     
 @@STD_DATE = LEFT(SDTCUR, 11),     
 @@LST_DATE = LEFT(LDTCUR, 11),     
 @@VNOMETHOD = VNOFLAG     
FROM PARAMETER     
WHERE CURYEAR = 1     
  
SET @@NEWVNO = (SELECT CONVERT(VARCHAR,YEAR(@@STD_DATE)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@STD_DATE))),2) + RIGHT('00'+LTRIM(CONVERT(VARCHAR,DAY(@@STD_DATE))),2))+'0001'  
  
UPDATE    
 V2_OPENING_BALANCE     
 SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO))     
  
  
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/   
  
  INSERT INTO #OPENING_BALANCE_LNO    
   (SNO)    
  SELECT SNO FROM V2_OPENING_BALANCE   
  UPDATE RP    
   SET LNO = RL.LNO    
  FROM V2_OPENING_BALANCE RP, #OPENING_BALANCE_LNO RL    
  WHERE RP.SNO = RL.SNO    
DROP TABLE #OPENING_BALANCE_LNO    
  
/*---------------- DELETE EXISTING OPENING BALANCE ENTRY ---------------------------*/  
  
      DELETE FROM LEDGER WHERE VNO = @@NEWVNO AND VTYP = '18' AND BOOKTYPE = '01'  
      DELETE FROM LEDGER2 WHERE VNO = @@NEWVNO AND VTYPE = '18' AND BOOKTYPE = '01'  
  
  
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/    
/*==============================    
      LEDGER RECORD    
==============================*/    
INSERT     
INTO LEDGER     
SELECT     
 VTYP = '18',     
 VNO,     
 EDT,     
 LNO,    
 ACNAME,     
 DRCR,    
 VAMT = AMOUNT,     
 VDT,     
 VNO1 = VNO,     
 REFNO = 0,     
 BALAMT = (CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END),     
 NODAYS = 0,     
 CDT = GETDATE(),     
 CLTCODE,     
 BOOKTYPE = '01',     
 ENTEREDBY = @UPLOADBY,     
 PDT = GETDATE(),     
 CHECKEDBY = @UPLOADBY,     
 ACTNODAYS = 0,     
 NARRATION    
FROM     
 V2_OPENING_BALANCE     
  
INSERT INTO LEDGER2  
      SELECT   
            VTYP = '18',  
            VNO,  
            LNO,  
            DRCR,  
            AMOUNT,  
            COSTCODE,  
            BOOKTYPE = '01',  
            CLTCODE  
      FROM  
            V2_OPENING_BALANCE  
  
COMMIT TRAN   
SELECT 'DATA UPLOADED SUCCESSFULLY', 'NA','NA' AS RESULT UNION ALL   
SELECT CLTCODE, CONVERT(VARCHAR, AMOUNT) , VNO AS RESULT FROM V2_OPENING_BALANCE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Index_GetIndexName
-- --------------------------------------------------
CREATE Proc [dbo].[Index_GetIndexName] As  
Declare @TableName Varchar(100),  
@CurTbl Cursor,  
@Sql Varchar(150)  
  
Create Table #Tbl_Index  
(Sno Int IDENTITY (1, 1) NOT NULL,  
 IndexName Varchar(100) NOT NULL,  
 TableName Varchar(100) NOT NULL)  
  
Set @CurTbl = Cursor For  
Select Name From Sysobjects   
Where xType = 'U'  
Order By Name   
Open @CurTbl  
Fetch Next from  @CurTbl into @TableName  
While @@Fetch_Status = 0   
Begin  
 Insert Into #Tbl_Index  

      Select i.name, TableName=@TableName
      from (dbo.sysindexes i inner join
         dbo.sysfilegroups s on
         i.groupid = s.groupid )
      where id = object_id(@TableName) and i.indid > 0 and i.indid < 255 and
      (INDEXPROPERTY(object_id(@TableName), i.name, N'IsStatistics') <> 1) and
      (INDEXPROPERTY(object_id(@TableName), i.name, N'IsAutoStatistics') <> 1) and
      (INDEXPROPERTY(object_id(@TableName), i.name, N'IsHypothetical') <> 1) 

   
 Fetch Next from  @CurTbl into @TableName  
End  
Close @CurTbl  
DeAllocate @CurTbl  
  
Select * From #Tbl_Index  
Order By TableName, IndexName

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsertToLedger2
-- --------------------------------------------------
CREATE PROC [dbo].[InsertToLedger2]   
(
      @sessionid varchar(15),  
      @vno varchar(12),  
      @branchflag tinyint,  
      @costcenterflag tinyint,  
      @costenable char(1),  
      @statusid as varchar(30),  
      @statusname as varchar(30)  
) 

As  

set nocount on

declare  
      @@onlyall tinyint,  
      @@onebranch tinyint,  
      @@multibranch tinyint,  
      @@oneBranchAll tinyint,  
      @@MultiBranchall tinyint,  
      @@Allcount smallint,  
      @@Branchcount smallint,  
      @@OldBranch varchar(10),  
      @@vtype varchar(2),  
      @@party2 varchar(10),  
      @@costbreakup tinyint,  
      @@costcode1 int,  
  
/*=======================================================================================
      Fields retrived from templedger2 
=======================================================================================*/
      @@category varchar(20),  
      @@branch varchar(25),  
      @@amt    money,  
      @@vtyp varchar(2),  
      @@vno  varchar(12),  
      @@lno  int,  
      @@drcr char(1),  
      @@costcode smallint,  
      @@booktype varchar(2),  
      @@sessionid varchar(25),  
      @@party_code varchar(10),  
      @@mainbr as varchar(10),     
      @@rcursor as cursor  
  
if @branchflag = 1 and @costcenterflag  = 1  
begin  
/*=======================================================================================
      0 = True   1 = False    
=======================================================================================*/
      select @@onlyall = 0               /* True */  
      select @@onebranch = 1             /* True */  
      select @@multibranch = 1           /* False */  
      select @@onebranchall = 1          /* False */  
      select @@Multibranchall = 1        /* False */  
        
      select @@allcount = 0  
      select @@Branchcount = 0  
      select @@OldBranch = ''  
  
      SELECT @@mainbr = 
                  (
                        SELECT 
                              BranchName 
                        FROM branchaccounts 
                        WHERE DefaultAc = 1
                  ) 
  
      SELECT @@vtype = 
                  (
                        SELECT DISTINCT 
                              vtype 
                        FROM templedger2 
                        WHERE rtrim(sessionid) = rtrim(@sessionid) 
                              AND vno = @vno
                  ) 
     
      SELECT @@costbreakup = 
                  (
                        SELECT 
                              count(*) 
                        FROM templedger2 
                        WHERE rtrim(sessionid) = rtrim(@sessionid) 
                              AND category = 'BRANCH' 
                              AND vno = @vno 
                              AND costflag = 'C'
                  ) 
  
      /*=======================================================================================
            if @@vtype = 8 and @@costbreakup > 0  
      =======================================================================================*/
      if @@costbreakup > 0  
      begin  
            DELETE t2
            FROM templedger2 t2
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND upper(rtrim(branch)) = 'ALL' 
                  AND vno = @vno 
                  AND costflag = 'A' 
                  AND exists 
                        ( 
                              SELECT 
                                    party_code 
                              FROM templedger2 t1
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'C'
                        ) 

            DELETE t2
            FROM templedger2 t2
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND vno = @vno 
                  AND costflag = 'C' 
                  AND exists 
                        ( 
                              SELECT 
                                    party_code 
                              FROM templedger2 t1
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'A' and upper(rtrim(t1.branch)) <> 'ALL'
                        ) 



            UPDATE 
                  templedger2 
                  SET costflag = 'A' 
      
            if @@vtype = 5 or @@vtype = 6 or @@vtype = 7 or @@vtype = 8 or @@vtype = 24  
            begin  
                  UPDATE 
                    templedger2 
                        SET branch = 'HO' 
                  WHERE upper(rtrim(branch)) = 'ALL' 
                        AND costflag = 'A' 
            end  
      end  
  
      set @@rcursor = cursor for  
            SELECT 
                  category,
                  branch,
                  paidamt,
                  vtype,
                  vno,
                  lno,
                  drcr,
                  costcode,
                  booktype,
                  sessionid,
                  party_code 
            FROM templedger2 
            WHERE category = 'BRANCH' 
                  AND rtrim(sessionid) = rtrim(@sessionid) 
                  AND vno =@vno 
                  AND costflag = 'A' 
      open @@rcursor  
      fetch next from @@rcursor   
      into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code   
  
      while @@fetch_status = 0  
      begin  
            if rtrim(@@branch) = 'ALL'  
            begin  
                  select @@Allcount = @@Allcount + 1  
            end  
            else   
            if rtrim(@@branch) = @@OldBranch  
            begin  
                  select @@OnlyAll = 1  
            end  
            else  
            if @@OldBranch = ''  
            begin  
                  select @@OnlyAll = 1  
                  select @@OldBranch = rtrim(@@branch)  
                  select @@Branchcount = @@Branchcount + 1  
            end  
            else   
            begin  
                  select @@OnlyAll = 1  
                  select @@Branchcount = @@Branchcount + 1  
                  select @@Multibranch = 0  
                  select @@OneBranch = 1             
            end  
            
            fetch next from @@rcursor   
            into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code   
      end  
      close @@rcursor  
      deallocate @@rcursor  
  
/*      select "AllCount = " + convert(varchar,@@Allcount)  
      select "BranchCount = " + convert(varchar,@@BranchCount)  */
  
      if @@onlyall = 1  
      begin  
            if @@Allcount = 0  
            begin  
                  if @@branchcount = 1  
                  begin  
                        select @@onebranch = 0  
                        select @@multibranch = 1  
                        select @@oneBranchAll = 1  
                        select @@MultiBranchall = 1  
                  end  
                  else  
                  begin  
                        select @@Multibranch = 0  
                        select @@onebranch = 1  
                        select @@oneBranchAll = 1  
                        select @@MultiBranchall = 1  
                  end  
            end  
            else  
            begin  
                  if @@branchcount = 1  
                  begin  
                        select @@onebranchAll = 0  
                        select @@onebranch = 1  
                        select @@multibranch = 1  
                        select @@MultiBranchall = 1  
                  end  
                  else  
                  begin  
                        select @@MultibranchAll = 0  
                        select @@onebranch = 1  
                        select @@multibranch = 1  
                        select @@onebranchAll = 1  
                  end  
            end  
      end  
  
      if @@Onlyall = 0   
      begin  
            SELECT 
                  @@vtype = 
                        (
                              SELECT DISTINCT 
                                    vtype 
                              FROM templedger2 
                              WHERE rtrim(sessionid) = rtrim(@sessionid) 
                                    AND vno = @vno
        ) 
                  SELECT 
                  @@party2 = 
                        (
                              SELECT DISTINCT 
                                    party_code 
                              FROM templedger2 
                              WHERE rtrim(sessionid) = rtrim(@sessionid) 
                                    AND upper(rtrim(branch)) = 'ALL' 
                                    AND vno = @vno 
                                    AND costflag = 'A' 
                                    AND lno = 1
                        ) 
            SELECT 
                  @@costbreakup = 
                        (
                              SELECT 
                                    count(*) 
                              FROM templedger2 
                              WHERE rtrim(sessionid) = rtrim(@sessionid) 
                                    AND category = 'BRANCH' 
                                    AND vno = @vno 
                                    AND costflag = 'C'
                        ) 
      
            if @@costbreakup > 0 and (@@vtype = '3' or @@vtype = '4')   
            begin  
                  DELETE 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND upper(branch) = 'ALL' 
                        AND vno = @vno 
                        AND costflag = 'A' 
      
                  DELETE 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND upper(drcr) = 'C' 
                        AND vno = @vno 
                        AND costflag = 'C' 
      
                  INSERT 
                  INTO templedger2 
                  SELECT 
                        category, 
                        branch, 
                        paidamt, 
                        vtype, 
                        vno, 
                        1, 
                        ( 
                              CASE 
                                    WHEN drcr = 'D' 
                                    THEN 'C' 
                                    ELSE 'D' 
                              END
                        ), 
                        costcode, 
                        booktype, 
                        sessionid, 
                        @@party2, 
                        costflag, 
                        1 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND vno = @vno 
            end  
            if @@costbreakup > 0 and (@@vtype = '1' or @@vtype = '2' )  
            begin  
                  DELETE 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND upper(branch) = 'ALL' 
                        AND vno = @vno 
                        AND costflag = 'A' 
      
                  DELETE 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND upper(drcr) = 'D' 
                        AND vno = @vno 
                        AND costflag = 'C' 
      
                  INSERT 
                  INTO templedger2 
                  SELECT 
                        category, 
                        branch, 
                        paidamt, 
                        vtype, 
                        vno, 
                        1, 
                        ( 
                              CASE 
                                    WHEN drcr = 'D' 
                                    THEN 'C' 
                           ELSE 'D' 
                              END
                        ), 
                        costcode, 
                        booktype, 
                        sessionid, 
                        @@party2, 
                        costflag, 
                        1 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND vno = @vno 
            end  
      end  
  
  
      if @@Onlyall = 0   
      begin   
            if @statusid = 'BRANCH'   
            begin  
                  INSERT 
                  INTO ledger2 
                  SELECT 
                        vtype, 
                        vno, 
                        lno, 
                        drcr, 
                        paidamt, 
                        c.costcode, 
                        BookType,
                        upper(party_code) 
                  FROM templedger2 t, 
                        costmast c 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND rtrim(costname) = rtrim(@statusname) 
                        AND category = 'BRANCH' 
                        AND vno =@vno 
                        AND costflag = 'A' 
            end  
            else  
            begin  
                  INSERT 
                  INTO ledger2 
                  SELECT 
                        vtype, 
                        vno, 
                        lno, 
                        drcr, 
                        paidamt, 
                        c.costcode, 
                        BookType,
                        upper(party_code) 
                  FROM templedger2 t, 
                        Branchaccounts b, 
                        costmast c 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND DefaultAc = 1 
                        AND rtrim(BranchName) = rtrim(costname) 
                        AND category = 'BRANCH' 
                        AND vno =@vno 
                        AND costflag = 'A' 
            end  
      end  
      else  
      if @@OneBranch = 0  
      begin  
            INSERT 
            INTO ledger2 
            SELECT 
                  vtype, 
                  vno, 
                  lno, 
                  drcr, 
                  paidamt, 
                  c.costcode, 
                  BookType, 
                  upper(party_code ) 
            FROM templedger2 t, 
                  costmast c 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND rtrim(branch) = rtrim(costname) 
                  AND category = 'BRANCH' 
                  AND vno =@vno 
                  AND costflag = 'A' 
      end  
      else  
      if @@MultiBranch = 0  
      Begin  
            INSERT 
            INTO ledger2 
            SELECT 
                  vtype, 
                  vno, 
                  lno, 
                  drcr, 
                  paidamt, 
                  c.costcode, 
                  BookType, 
                  upper(party_code) 
            FROM templedger2 t, 
                  costmast c 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND rtrim(branch) = rtrim(costname) 
                  AND category = 'BRANCH' 
                  AND vno =@vno 
                  AND costflag = 'A' 
      
            INSERT 
            INTO ledger2 
            SELECT 
                  vtype, 
                  vno, 
                  lno, 
                  drcr, 
                  paidamt, 
                  costcode= 
                        ( 
                              SELECT 
                                    costcode 
                              FROM costmast c, 
 branchaccounts b 
                              WHERE DefaultAc = 1 
                                    AND rtrim(branchname) = rtrim(costname)
                        ), 
                  BookType, 
                  upper(BrControlAc) 
            FROM templedger2 t, 
                  branchaccounts b 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND rtrim(branch) = rtrim(branchname) 
                  AND category = 'BRANCH' 
                  AND vno =@vno 
                  AND costflag = 'A' 
                  AND rtrim(branch) <> rtrim(@@mainbr) 
      
            INSERT 
            INTO ledger2 
            SELECT 
                  vtype, 
                  vno, 
                  lno, 
                  ( 
                        CASE 
                              WHEN drcr= 'd' 
                              OR drcr = 'D' 
                              THEN 'C' 
                              ELSE 'D' 
                        END
                  ), 
                  paidamt, 
                  c.costcode, 
                  BookType, 
                  upper(MainControlAc) 
            FROM templedger2 t, 
                  costmast c, 
                  branchaccounts b 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND rtrim(branch) = rtrim(costname) 
                  AND rtrim(BranchName) = rtrim(branch) 
                  AND category = 'BRANCH' 
                  AND vno =@vno 
                  AND costflag = 'A' 
                  AND rtrim(branch) <> rtrim(@@mainbr) 
      end  
      else  
      if @@OneBranchAll = 0   
      begin  
      set @@rcursor = cursor for  
            SELECT 
                  branch 
            FROM templedger2 
            WHERE category = 'BRANCH' 
                  AND rtrim(sessionid) = rtrim(@sessionid) 
                  AND vno = @vno 
                  AND branch <> 'ALL' 
                  AND costflag = 'A' 
            ORDER BY branch 
            open @@rcursor  
            fetch next from @@rcursor into @@branch   
            while @@fetch_status = 0  
            begin  
            SELECT @@costcode1 = 
                        ( 
                              SELECT 
                                    costcode 
                              FROM costmast 
                              WHERE rtrim(@@branch) = rtrim(costname)
                        ) 
                  fetch next from @@rcursor into @@branch   
                  end  
                  close @@rcursor  
                  deallocate @@rcursor  
            
                  INSERT 
                  INTO ledger2 
                  SELECT 
                        vtype, 
                        vno, 
                        lno, 
                        drcr, 
                        paidamt, 
                        c.costcode, 
                        BookType, 
                        upper(party_code) 
                  FROM templedger2 t, 
                        costmast c 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND rtrim(branch) = rtrim(costname) 
                        AND category = 'BRANCH' 
                        AND vno =@vno 
                        AND costflag = 'A' 
            
                  INSERT 
                  INTO ledger2 
                  SELECT 
                        vtype, 
                        vno, 
                        lno, 
                        drcr, 
                        paidamt, 
                        @@costcode1, 
                        BookType, 
                        upper(party_code) 
                  FROM templedger2 t 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND rtrim(branch) = 'ALL' 
                        AND category = 'BRANCH' 
                        AND vno =@vno 
                        AND costflag = 'A' 
            end  
      end  
  
      if @costcenterflag  = 1  
      begin  
            INSERT 
            INTO ledger2 
            SELECT 
                  vtype, 
                  @vno, 
                  lno, 
                  drcr, 
                  paidamt, 
                  costcode, 
                  BookType,
                  upper(party_code ) 
            FROM templedger2 t 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND vno = @vno 
                  AND costflag = 'C' 
      end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsertToLedger2_02092009
-- --------------------------------------------------
CREATE PROC [dbo].[InsertToLedger2_02092009]     
(  
      @sessionid varchar(15),    
      @vno varchar(12),    
      @branchflag tinyint,    
      @costcenterflag tinyint,    
      @costenable char(1),    
      @statusid as varchar(30),    
      @statusname as varchar(30)    
)   
  
As    
  
set nocount on  
  
declare    
      @@onlyall tinyint,    
      @@onebranch tinyint,    
      @@multibranch tinyint,    
      @@oneBranchAll tinyint,    
      @@MultiBranchall tinyint,    
      @@Allcount smallint,    
      @@Branchcount smallint,    
      @@OldBranch varchar(10),    
      @@vtype varchar(2),    
      @@party2 varchar(10),    
      @@costbreakup tinyint,    
      @@costcode1 int,    
    
/*=======================================================================================  
      Fields retrived from templedger2   
=======================================================================================*/  
      @@category varchar(20),    
      @@branch varchar(25),    
      @@amt    money,    
      @@vtyp varchar(2),    
      @@vno  varchar(12),    
      @@lno  int,    
      @@drcr char(1),    
      @@costcode smallint,    
      @@booktype varchar(2),    
      @@sessionid varchar(25),    
      @@party_code varchar(10),    
      @@mainbr as varchar(10),       
      @@rcursor as cursor    
    
if @branchflag = 1 and @costcenterflag  = 1    
begin    
/*=======================================================================================  
      0 = True   1 = False      
=======================================================================================*/  
      select @@onlyall = 0               /* True */    
      select @@onebranch = 1             /* True */    
      select @@multibranch = 1           /* False */    
      select @@onebranchall = 1          /* False */    
      select @@Multibranchall = 1        /* False */    
          
      select @@allcount = 0    
      select @@Branchcount = 0    
      select @@OldBranch = ''    
    
      SELECT @@mainbr =   
                  (  
                        SELECT   
                              BranchName   
                        FROM branchaccounts   
                        WHERE DefaultAc = 1  
                  )   
    
      SELECT @@vtype =   
                  (  
                        SELECT DISTINCT   
                              vtype   
                        FROM templedger2   
                        WHERE rtrim(sessionid) = rtrim(@sessionid)   
                              AND vno = @vno  
                  )   
       
      SELECT @@costbreakup =   
                  (  
                        SELECT   
                              count(*)   
                        FROM templedger2   
                        WHERE rtrim(sessionid) = rtrim(@sessionid)   
                              AND category = 'BRANCH'   
                              AND vno = @vno   
                              AND costflag = 'C'  
                  )   
    
      /*=======================================================================================  
            if @@vtype = 8 and @@costbreakup > 0    
      =======================================================================================*/  
      if @@costbreakup > 0    
      begin    
            DELETE t2  
            FROM templedger2 t2  
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND upper(rtrim(branch)) = 'ALL'   
                  AND vno = @vno   
                  AND costflag = 'A'   
                  AND exists   
                        (   
                              SELECT   
                                    party_code   
                              FROM templedger2 t1  
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'C'  
                        )   
  
            DELETE t2  
            FROM templedger2 t2  
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND vno = @vno   
                  AND costflag = 'C'   
       AND exists   
                        (   
                              SELECT   
                                    party_code   
                              FROM templedger2 t1  
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'A' and upper(rtrim(t1.branch)) <> 'ALL'  
                        )   
  
  
  
            UPDATE   
                  templedger2   
                  SET costflag = 'A'   
        
            if @@vtype = 5 or @@vtype = 6 or @@vtype = 7 or @@vtype = 8 or @@vtype = 24    
            begin    
                  UPDATE   
                    templedger2   
                        SET branch = 'HO'   
                  WHERE upper(rtrim(branch)) = 'ALL'   
                        AND costflag = 'A'   
            end    
      end    
    
      set @@rcursor = cursor for    
            SELECT   
                  category,  
                  branch,  
                  paidamt,  
                  vtype,  
                  vno,  
                  lno,  
                  drcr,  
                  costcode,  
                  booktype,  
                  sessionid,  
                  party_code   
            FROM templedger2   
            WHERE category = 'BRANCH'   
                  AND rtrim(sessionid) = rtrim(@sessionid)   
                  AND vno =@vno   
                  AND costflag = 'A'   
      open @@rcursor    
      fetch next from @@rcursor     
      into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code     
    
      while @@fetch_status = 0    
      begin    
            if rtrim(@@branch) = 'ALL'    
            begin    
                  select @@Allcount = @@Allcount + 1    
            end    
            else     
            if rtrim(@@branch) = @@OldBranch    
            begin    
                  select @@OnlyAll = 1    
            end    
            else    
            if @@OldBranch = ''    
            begin    
                  select @@OnlyAll = 1    
                  select @@OldBranch = rtrim(@@branch)    
                  select @@Branchcount = @@Branchcount + 1    
            end    
            else     
            begin    
                  select @@OnlyAll = 1    
                  select @@Branchcount = @@Branchcount + 1    
                  select @@Multibranch = 0    
                  select @@OneBranch = 1               
            end    
              
            fetch next from @@rcursor     
            into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code     
      end    
      close @@rcursor    
      deallocate @@rcursor    
    
/*      select "AllCount = " + convert(varchar,@@Allcount)    
      select "BranchCount = " + convert(varchar,@@BranchCount)  */  
    
      if @@onlyall = 1    
      begin    
            if @@Allcount = 0    
            begin    
                  if @@branchcount = 1    
                  begin    
                        select @@onebranch = 0    
                        select @@multibranch = 1    
                        select @@oneBranchAll = 1    
                        select @@MultiBranchall = 1    
                  end    
                  else    
                  begin    
                        select @@Multibranch = 0    
                        select @@onebranch = 1    
                        select @@oneBranchAll = 1    
                        select @@MultiBranchall = 1    
                  end    
            end    
            else    
            begin    
                  if @@branchcount = 1    
                  begin    
                        select @@onebranchAll = 0    
                        select @@onebranch = 1    
                        select @@multibranch = 1    
                        select @@MultiBranchall = 1    
                  end    
                  else    
                  begin    
                        select @@MultibranchAll = 0    
          select @@onebranch = 1    
                        select @@multibranch = 1    
                        select @@onebranchAll = 1    
                  end    
            end    
      end    
    
      if @@Onlyall = 0     
      begin    
            SELECT   
                  @@vtype =   
                        (  
                              SELECT DISTINCT   
                                    vtype   
                              FROM templedger2   
                              WHERE rtrim(sessionid) = rtrim(@sessionid)   
                                    AND vno = @vno  
        )   
                  SELECT   
                  @@party2 =   
                        (  
                              SELECT DISTINCT   
                                    party_code   
                              FROM templedger2   
                              WHERE rtrim(sessionid) = rtrim(@sessionid)   
                                    AND upper(rtrim(branch)) = 'ALL'   
                                    AND vno = @vno   
                                    AND costflag = 'A'   
                                    AND lno = 1  
                        )   
            SELECT   
                  @@costbreakup =   
                        (  
                              SELECT   
                                    count(*)   
                              FROM templedger2   
                              WHERE rtrim(sessionid) = rtrim(@sessionid)   
                                    AND category = 'BRANCH'   
                                    AND vno = @vno   
                                    AND costflag = 'C'  
                        )   
        
            if @@costbreakup > 0 and (@@vtype = '3' or @@vtype = '4')     
            begin    
                  DELETE   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
                        AND upper(branch) = 'ALL'   
                        AND vno = @vno   
                        AND costflag = 'A'   
        
                  DELETE   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
                        AND upper(drcr) = 'C'   
                        AND vno = @vno   
                        AND costflag = 'C'   
        
                  INSERT   
                  INTO templedger2   
                  SELECT   
                        category,   
                        branch,   
                        paidamt,   
                        vtype,   
                        vno,   
                        1,   
                        (   
                              CASE   
                                    WHEN drcr = 'D'   
                                    THEN 'C'   
                                    ELSE 'D'   
                              END  
                        ),   
                        costcode,   
                        booktype,   
                        sessionid,   
                        @@party2,   
                        costflag,   
                        1   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
                        AND vno = @vno   
            end    
            if @@costbreakup > 0 and (@@vtype = '1' or @@vtype = '2' )    
            begin    
                  DELETE   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
                        AND upper(branch) = 'ALL'   
                        AND vno = @vno   
                        AND costflag = 'A'   
        
                  DELETE   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
        AND upper(drcr) = 'D'   
                        AND vno = @vno   
                        AND costflag = 'C'   
        
                  INSERT   
                  INTO templedger2   
                  SELECT   
                        category,   
                        branch,   
                        paidamt,   
                        vtype,   
                        vno,   
                        1,   
                        (   
                              CASE   
                                    WHEN drcr = 'D'   
                                    THEN 'C'   
                           ELSE 'D'   
                              END  
                        ),   
                        costcode,   
                        booktype,   
                        sessionid,   
                        @@party2,   
                        costflag,   
                        1   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
                        AND vno = @vno   
            end    
      end    
    
    
      if @@Onlyall = 0     
      begin     
            if @statusid = 'BRANCH'     
            begin    
                  INSERT   
                  INTO ledger2   
                  SELECT   
                        vtype,   
                        vno,   
                        lno,   
                        drcr,   
                        paidamt,   
                        c.costcode,   
                        BookType,  
                        upper(party_code)   
                  FROM templedger2 t,   
                        costmast c   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND rtrim(costname) = rtrim(@statusname)   
                        AND category = 'BRANCH'   
                        AND vno =@vno   
                        AND costflag = 'A'   
            end    
            else    
            begin    
                  INSERT   
                  INTO ledger2   
                  SELECT   
                        vtype,   
                        vno,   
                        lno,   
                        drcr,   
                        paidamt,   
                        c.costcode,   
                        BookType,  
                        upper(party_code)   
                  FROM templedger2 t,   
                        Branchaccounts b,   
                        costmast c   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND DefaultAc = 1   
                        AND rtrim(BranchName) = rtrim(costname)   
                        AND category = 'BRANCH'   
                        AND vno =@vno   
                        AND costflag = 'A'   
            end    
      end    
      else    
      if @@OneBranch = 0    
      begin    
            INSERT   
            INTO ledger2   
            SELECT   
                  vtype,   
                  vno,   
                  lno,   
                  drcr,   
                  paidamt,   
                  c.costcode,   
                  BookType,   
                  upper(party_code )   
            FROM templedger2 t,   
                  costmast c   
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND rtrim(branch) = rtrim(costname)   
                  AND category = 'BRANCH'   
                  AND vno =@vno   
                  AND costflag = 'A'   
      end    
      else    
      if @@MultiBranch = 0    
      Begin    
            INSERT   
            INTO ledger2   
            SELECT   
                  vtype,   
                  vno,   
                  lno,   
                  drcr,   
                  paidamt,   
                  c.costcode,   
                  BookType,   
                  upper(party_code)   
            FROM templedger2 t,   
                  costmast c   
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND rtrim(branch) = rtrim(costname)   
                  AND category = 'BRANCH'   
                  AND vno =@vno   
                  AND costflag = 'A'   
        
            INSERT   
            INTO ledger2   
            SELECT   
                  vtype,   
                  vno,   
                  lno,   
                  drcr,   
                  paidamt,   
                  costcode=   
                        (   
                              SELECT   
                                    costcode   
                              FROM costmast c,   
 branchaccounts b   
                              WHERE DefaultAc = 1   
                                    AND rtrim(branchname) = rtrim(costname)  
                        ),   
                  BookType,   
                  upper(BrControlAc)   
            FROM templedger2 t,   
                  branchaccounts b   
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND rtrim(branch) = rtrim(branchname)   
                  AND category = 'BRANCH'   
                  AND vno =@vno   
                  AND costflag = 'A'   
                  AND rtrim(branch) <> rtrim(@@mainbr)   
        
            INSERT   
            INTO ledger2   
            SELECT   
                  vtype,   
                  vno,   
                  lno,   
                  (   
                        CASE   
                              WHEN drcr= 'd'   
                              OR drcr = 'D'   
                              THEN 'C'   
                              ELSE 'D'   
                        END  
                  ),   
                  paidamt,   
                  c.costcode,   
                  BookType,   
                  upper(MainControlAc)   
            FROM templedger2 t,   
                  costmast c,   
                  branchaccounts b   
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND rtrim(branch) = rtrim(costname)   
                  AND rtrim(BranchName) = rtrim(branch)   
                  AND category = 'BRANCH'   
                  AND vno =@vno   
                  AND costflag = 'A'   
                  AND rtrim(branch) <> rtrim(@@mainbr)   
      end    
      else    
      if @@OneBranchAll = 0     
      begin    
      set @@rcursor = cursor for    
            SELECT   
                  branch   
            FROM templedger2   
            WHERE category = 'BRANCH'   
                  AND rtrim(sessionid) = rtrim(@sessionid)   
                  AND vno = @vno   
                  AND branch <> 'ALL'   
                  AND costflag = 'A'   
            ORDER BY branch   
            open @@rcursor    
            fetch next from @@rcursor into @@branch     
            while @@fetch_status = 0    
            begin    
            SELECT @@costcode1 =   
                        (   
                              SELECT   
                                    costcode   
                              FROM costmast   
                              WHERE rtrim(@@branch) = rtrim(costname)  
                        )   
                  fetch next from @@rcursor into @@branch     
                  end    
                  close @@rcursor    
                  deallocate @@rcursor    
              
                  INSERT   
                  INTO ledger2   
                  SELECT   
                        vtype,   
                        vno,   
                        lno,   
                        drcr,   
                        paidamt,   
                        c.costcode,   
                        BookType,   
                        upper(party_code)   
                  FROM templedger2 t,   
                        costmast c   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND rtrim(branch) = rtrim(costname)   
                        AND category = 'BRANCH'   
                        AND vno =@vno   
                        AND costflag = 'A'   
              
                  INSERT   
                  INTO ledger2   
                  SELECT   
                        vtype,   
                        vno,   
                        lno,   
                        drcr,   
                        paidamt,   
                        @@costcode1,   
                        BookType,   
                        upper(party_code)   
                  FROM templedger2 t   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND rtrim(branch) = 'ALL'   
                        AND category = 'BRANCH'   
                        AND vno =@vno   
                        AND costflag = 'A'   
            end    
      end    
    
      if @costcenterflag  = 1    
      begin    
            INSERT   
            INTO ledger2   
            SELECT   
                  vtype,   
                  @vno,   
                  lno,   
                  drcr,   
                  paidamt,   
                  costcode,   
                  BookType,  
                  upper(party_code )   
            FROM templedger2 t   
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND vno = @vno   
                  AND costflag = 'C'   
      end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IPO_POSTBIDDINGAMOUNT
-- --------------------------------------------------
CREATE PROC [dbo].[IPO_POSTBIDDINGAMOUNT](
           @Cltcode       VARCHAR(10),
           @Vamt          MONEY,
           @Enteredby     VARCHAR(20),
           @Acname        VARCHAR(100),
           @Narration     VARCHAR(234),
           @Sessionid     VARCHAR(100),
           @Branchname    CHAR(10),
           @Costflag      VARCHAR(1),
           @Costrowid     INT,
           @IpoCtrlCode   VARCHAR(10),
           @IpoCtrlAcname VARCHAR(100))

AS

  SET NOCOUNT ON
  
  DECLARE  @VDT       VARCHAR(11),
           @SDTCUR    VARCHAR(11),
           @LDTCUR    VARCHAR(11),
           @VNO       VARCHAR(12),
           @ENTEREDAT DATETIME
                      
  SELECT @ENTEREDAT = GETDATE()
                      
  SELECT @VDT = LEFT(GETDATE(),11),
         @SDTCUR = LEFT(SDTCUR,11),
         @LDTCUR = LEFT(LDTCUR,11)
  FROM   PARAMETER
  WHERE  GETDATE() BETWEEN SDTCUR AND LDTCUR
                                      
  CREATE TABLE #VNO (
    VNO VARCHAR(12))
  
  INSERT INTO #VNO
  EXEC ACC_GENVNO_NEW
    @VDT ,
    '55' ,
    '01' ,
    @SDTCUR ,
    @LDTCUR
    
  SELECT TOP 1 @VNO = VNO
  FROM   #VNO
         
  BEGIN TRAN
  
  EXEC NEWACMULTIINSERT
    @Vtyp = 55 ,
    @Booktype = '01' ,
    @VNO = @VNO,
    @Lno = 1 ,
    @Vdt = @VDT ,
    @Edt = @VDT ,
    @Cltcode = @Cltcode ,
    @Drcr = 'D' ,
    @Vamt = @Vamt ,
    @Enteredby = @Enteredby ,
    @Cdt = @ENTEREDAT ,
    @Checkedby = @Enteredby ,
    @Pdt = @ENTEREDAT ,
    @Acname = @Acname ,
    @Narration = @Narration ,
    @Chequeinname = '' ,
    @Chqprinted = 0 ,
    @Accat = '4' ,
    @Bnkname = '' ,
    @Brnname = '' ,
    @Dd = '' ,
    @Ddno = '' ,
    @Dddt = '' ,
    @Reldt = '' ,
    @Relamt = @Vamt ,
    @Micrno = '' ,
    @Sessionid = @Sessionid ,
    @Branchname = @Branchname ,
    @Costflag = @Costflag ,
    @Costrowid = @Costrowid ,
    @Clearingmode = '' ,
    @Emode = 'A'
             
  EXEC NEWACMULTIINSERT
    @Vtyp = 55 ,
    @Booktype = '01' ,
    @VNO = @VNO ,
    @Lno = 2 ,
    @VDT = @VDT ,
    @EDT = @VDT ,
    @Cltcode = @IpoCtrlCode ,
    @Drcr = 'C' ,
    @Vamt = @Vamt ,
    @Enteredby = @Enteredby ,
    @Cdt = @ENTEREDAT ,
    @Checkedby = @Enteredby ,
    @Pdt = @ENTEREDAT ,
    @Acname = @IpoCtrlAcname ,
    @Narration = @Narration ,
    @Chequeinname = '' ,
    @Chqprinted = 0 ,
    @Accat = '3' ,
    @Bnkname = '' ,
    @Brnname = '' ,
    @Dd = '' ,
    @Ddno = '' ,
    @Dddt = '' ,
    @Reldt = '' ,
    @Relamt = @Vamt ,
    @Micrno = '' ,
    @Sessionid = @Sessionid ,
    @Branchname = 'ALL' ,
    @Costflag = @Costflag ,
    @Costrowid = @Costrowid ,
    @Clearingmode = '' ,
    @Emode = 'A'
             
  EXEC INSERTTOLEDGER2
    @Sessionid = @Sessionid ,
    @VNO = @VNO ,
    @branchflag = '1' ,
    @costcenterflag = '1' ,
    @costenable = 'A' ,
    @statusid = 'broker' ,
    @statusname = 'broker'
                  
  DELETE FROM TEMPLEDGER2
  WHERE       SESSIONID = @Sessionid
              AND VTYPE = '55'
              AND BOOKTYPE = '01'
                             
  DELETE FROM TEMPBILLDETAILS
  WHERE       SESSIONID =@Sessionid
              AND VTYPE = '55'
              AND BOOKTYPE = '01'
                             
  COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.JVDRCRDPUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[JVDRCRDPUPLOAD_BULK]  
 @FNAME VARCHAR(100) = '',  
 @UNAME VARCHAR(25),  
 @VTYP SMALLINT,  
 @BOOKTYPE VARCHAR(2),  
 @FDESC VARCHAR(25),  
 @GLCODE VARCHAR(10) = ''  
AS  
/*  
 DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'C:\BulkUploads\JvDrCrDpFiles\indorebse27062007.txt'  
 Exec JVDRCRDPUPLOAD_BULK 'C:\BulkUploads\JvDrCrDpFiles\indorebse27062007.txt', 'DEMO', 6, '01', 'DP FILE', '125025'   
*/  
 SET NOCOUNT ON  
  
 DECLARE  
  @@ERROR_COUNT AS INT,  
  @@SQL AS VARCHAR(2000)  
  
/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/  
 IF LEFT(@FDESC, 11) <> 'THIRD PARTY'  
 BEGIN  
  IF LTRIM(RTRIM(@FNAME)) = ''  
   BEGIN  
    SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'  
    RETURN  
   END  
  
  CREATE TABLE #FEXIST  
   (F1 INT, F2 INT, F3 INT)  
    
  SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "  
  EXEC (@@SQL)  
  
  SELECT @@ERROR_COUNT = F1 FROM #FEXIST  
  IF @@ERROR_COUNT = 0  
   BEGIN  
    SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'  
    DROP TABLE #FEXIST  
    RETURN  
   END  
 END  
   
 CREATE TABLE [#RECPAY_TABLE]  
 (  
  SRNO INT,  
  VVDT VARCHAR(10),  
  EEDT VARCHAR(10),  
  CLTCODE VARCHAR(10),  
  DRCR VARCHAR(1),  
  AMOUNT MONEY,  
  NARRATION VARCHAR(500),  
  SNO INT IDENTITY (1, 1) NOT NULL ,  
  VDT DATETIME NULL ,  
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),  
  EDT DATETIME NULL ,  
  VNO VARCHAR (12)  NULL ,  
  ACNAME VARCHAR (100)  NULL ,  
  FYSTART DATETIME NULL,  
  FYEND DATETIME NULL,  
  COSTCODE SMALLINT NULL,  
  LNO SMALLINT NOT NULL DEFAULT(0)  
 ) ON [PRIMARY]  
  
 CREATE TABLE [#RECPAY_TABLE_LNO]  
 (  
  SNO INT ,  
  LNO INT IDENTITY (1, 1) NOT NULL  
 ) ON [PRIMARY]  
  
 IF @FDESC = 'DP FILE'  
 BEGIN  
  DECLARE @@FILENAME AS VARCHAR(100)  
  SELECT @@FILENAME = 'C:\TESTIMPORT.TXT'  
  
  CREATE TABLE #TESTIMPORT                  
  (                  
   OneRow Varchar(2000),                
   SNO INT IDENTITY(1,1)                
  )   
  
  SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FNAME + "' "                
  EXEC(@@SQL)                  
    
  DELETE FROM #TESTIMPORT WHERE SNO = 1  
  DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL     
    
  DECLARE   
  @@FILEDATA VARCHAR(500),    
  @@INDEX INT  
   
  SELECT TOP 1  
   @@FILEDATA = ONEROW   
  FROM   
   #TESTIMPORT  
    
  SELECT @@INDEX = CHARINDEX('~', @@FILEDATA)  
    
  IF @@INDEX = 0   
  BEGIN   
   SELECT 'THE FILE WHICH YOU ARE TRYING UPLOAD IS OF WRONG FORMAT'  
   DROP TABLE #TESTIMPORT  
   RETURN  
  END  
  
  SELECT * INTO TESTIMPORT FROM #TESTIMPORT  
  DROP TABLE #TESTIMPORT  
  
  SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FILENAME + CHAR(34) + " -c -q -U " + CHAR(34) + "sa" + CHAR(34) + " -P " + CHAR(34) + "ms" + CHAR(34) + "', no_output "         
        
    EXEC(@@SQL)                  
    
  DROP TABLE TESTIMPORT  
  
  CREATE TABLE #DP_TABLE_TMP  
  (  
   BATCHNO INT,  
   CLIENTTCODE VARCHAR(16),  
   DPID VARCHAR(10),     
   CLTCODE VARCHAR(10),     
   DRCR VARCHAR(1),  
   AMOUNT MONEY,  
   VVDT VARCHAR(10),  
   NARRATION VARCHAR(234),  
   SRNO INT IDENTITY (1, 1) NOT NULL  
  )  
  
  SELECT @@SQL = "BULK INSERT #DP_TABLE_TMP FROM '" + @@FILENAME + "' WITH (FIELDTERMINATOR = '~', ROWTERMINATOR = '\n', FIRSTROW = 1) "  
  EXEC(@@SQL)  
  
  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,  
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   VVDT,  
   VVDT,  
   UPPER(CLTCODE),  
   DRCR,  
   AMOUNT,  
   NARRATION  
  FROM #DP_TABLE_TMP  
  
  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,  
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   VVDT,  
   VVDT,  
   @GLCODE,  
   CASE DRCR WHEN 'D' THEN 'C' ELSE 'D' END,  
   AMOUNT,  
   NARRATION  
  FROM #DP_TABLE_TMP  
  
  UPDATE  
   #RECPAY_TABLE  
   SET  
    VDT = CONVERT(DATETIME, LEFT(VVDT,4) + '-' + SUBSTRING(VVDT,5,2) + '-' + RIGHT(VVDT,2)),  
    EDT = CONVERT(DATETIME, LEFT(EEDT,4) + '-' + SUBSTRING(EEDT,5,2) + '-' + RIGHT(EEDT,2)),  
    FYSTART = P.SDTCUR,  
    FYEND = P.LDTCUR,  
    UPDFLAG = 'Y',  
    ACNAME = LONGNAME,  
    COSTCODE = C.COSTCODE  
    FROM ACMAST A, PARAMETER P, COSTMAST C  
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE  
    AND P.CURYEAR = 1  
    AND A.ACCAT IN ('3','4','104')  
    AND A.BRANCHCODE = C.COSTNAME  
    AND A.BRANCHCODE <> 'ALL'  
    
    UPDATE  
   #RECPAY_TABLE  
   SET  
    VDT = CONVERT(DATETIME, LEFT(VVDT,4) + '-' + SUBSTRING(VVDT,5,2) + '-' + RIGHT(VVDT,2)),  
    EDT = CONVERT(DATETIME, LEFT(EEDT,4) + '-' + SUBSTRING(EEDT,5,2) + '-' + RIGHT(EEDT,2)),  
    FYSTART = P.SDTCUR,  
    FYEND = P.LDTCUR,  
    UPDFLAG = 'Y',  
    ACNAME = LONGNAME,  
    COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  
    FROM ACMAST A, PARAMETER P  
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE  
    AND P.CURYEAR = 1  
    AND A.ACCAT IN ('3','4','104')  
    AND A.BRANCHCODE = 'ALL'  
 END  
  
 IF LEFT(@FDESC, 11) = 'THIRD PARTY'  
 BEGIN    
  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,  
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   VVDT,  
   VVDT,  
   UPPER(CLTCODE),  
   DRCR,  
   AMOUNT,  
   NARRATION  
  FROM ##TPR_TMP  
  
  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,  
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   VVDT,  
   VVDT,  
   @GLCODE,  
   CASE DRCR WHEN 'D' THEN 'C' ELSE 'D' END,  
   AMOUNT,  
   NARRATION  
  FROM ##TPR_TMP  
  
  UPDATE  
   #RECPAY_TABLE  
  SET  
   VDT = CONVERT(DATETIME, LEFT(VVDT,4) + '-' + SUBSTRING(VVDT,5,2) + '-' + RIGHT(VVDT,2)),  
   EDT = CONVERT(DATETIME, LEFT(EEDT,4) + '-' + SUBSTRING(EEDT,5,2) + '-' + RIGHT(EEDT,2)),  
   FYSTART = P.SDTCUR,  
   FYEND = P.LDTCUR,  
   UPDFLAG = 'Y',  
   ACNAME = LONGNAME,  
   COSTCODE = C.COSTCODE  
  FROM ACMAST A, PARAMETER P, COSTMAST C  
   WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE  
   AND P.CURYEAR = 1  
   AND A.ACCAT IN ('3','4','104')  
   AND A.BRANCHCODE = C.COSTNAME  
   AND A.BRANCHCODE <> 'ALL'  
    
  UPDATE  
   #RECPAY_TABLE  
  SET  
   VDT = CONVERT(DATETIME, LEFT(VVDT,4) + '-' + SUBSTRING(VVDT,5,2) + '-' + RIGHT(VVDT,2)),  
   EDT = CONVERT(DATETIME, LEFT(EEDT,4) + '-' + SUBSTRING(EEDT,5,2) + '-' + RIGHT(EEDT,2)),  
   FYSTART = P.SDTCUR,  
   FYEND = P.LDTCUR,  
   UPDFLAG = 'Y',  
   ACNAME = LONGNAME,  
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  
  FROM ACMAST A, PARAMETER P  
  WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE  
   AND P.CURYEAR = 1  
   AND A.ACCAT IN ('3','4','104')  
   AND A.BRANCHCODE = 'ALL'  
 END  
  
 ELSE  
 BEGIN  
  CREATE TABLE #JVTESTIMPORT                  
  (  
   OneRow Varchar(2000),                
   SNO INT IDENTITY(1,1)                
  )  
  
  SELECT @@SQL = "INSERT INTO #JVTESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FNAME + "' "                
  EXEC(@@SQL)                  
    
  DELETE FROM #JVTESTIMPORT WHERE SNO = 1  
  DELETE FROM #JVTESTIMPORT WHERE ONEROW IS NULL     
    
  DECLARE   
  @@JVFILEDATA VARCHAR(500),    
  @@JVINDEX INT  
   
  SELECT TOP 1  
   @@JVFILEDATA = ONEROW   
  FROM   
   #JVTESTIMPORT  
    
  SELECT @@JVINDEX = CHARINDEX(',', @@JVFILEDATA)  
    
  IF @@JVINDEX = 0   
  BEGIN   
   SELECT 'THE FILE WHICH YOU ARE TRYING UPLOAD IS OF WRONG FORMAT'  
   DROP TABLE #JVTESTIMPORT  
   RETURN  
  END  
  
  DROP TABLE #JVTESTIMPORT  
  
  CREATE TABLE #RECPAY_TABLE_TMP  
  (  
   SRNO INT,  
   VVDT VARCHAR(10),  
   EEDT VARCHAR(10),  
   CLTCODE VARCHAR(10),  
   DRCR VARCHAR(1),  
   AMOUNT MONEY,  
   NARRATION VARCHAR(500)  
  )  
  
  SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "  
  EXEC(@@SQL)  
  
  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,  
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   VVDT,  
   EEDT,  
   UPPER(CLTCODE),  
   DRCR,  
   AMOUNT,  
   LEFT(NARRATION, 234)  
  FROM #RECPAY_TABLE_TMP  
  
  UPDATE  
   #RECPAY_TABLE  
   SET  
    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),  
    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),  
    FYSTART = P.SDTCUR,  
    FYEND = P.LDTCUR,  
    UPDFLAG = 'Y',  
    ACNAME = LONGNAME,  
    COSTCODE = C.COSTCODE  
    FROM ACMAST A, PARAMETER P, COSTMAST C  
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE  
    AND P.CURYEAR = 1  
    AND A.ACCAT IN ('3','4','104')  
    AND A.BRANCHCODE = C.COSTNAME  
    AND A.BRANCHCODE <> 'ALL'  
  
    UPDATE  
   #RECPAY_TABLE  
   SET  
    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),  
    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),  
    FYSTART = P.SDTCUR,  
    FYEND = P.LDTCUR,  
    UPDFLAG = 'Y',  
    ACNAME = LONGNAME,  
    COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  
    FROM ACMAST A, PARAMETER P  
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE  
    AND P.CURYEAR = 1  
    AND A.ACCAT IN ('3','4','104')  
    AND A.BRANCHCODE = 'ALL'  
 END   
    
 BEGIN TRAN  
  
 IF LEFT(@FDESC, 11) <> 'THIRD PARTY'  
 BEGIN  
  SELECT   
   @@ERROR_COUNT = COUNT(1)   
  FROM  
   (SELECT   
    U_FILENAME   
   FROM   
    V2_UPLOADED_FILES  
   WHERE   
    U_FILENAME = @FNAME   
    AND U_MODULE = 'DRCR NOTE UPLOAD') A  
  
  IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME  
   ROLLBACK TRAN  
   RETURN  
  END  
 END  
  
 INSERT INTO V2_UPLOADED_FILES  
 SELECT  
  @FNAME,  
  @FNAME,  
  COUNT(1),  
  'B',  
  GETDATE(),  
  @UNAME,  
  'DRCR NOTE UPLOAD'  
  
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/  
  
 DECLARE  
  @@STD_DATE VARCHAR(11),  
  @@LST_DATE VARCHAR(11),  
  @@VNOMETHOD INT,  
  @@ACNAME CHAR(100),  
  @@MICRNO VARCHAR(10),  
  @@DRCR VARCHAR(1)  
  
  
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/  
  
 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND  
  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'DATE MISMATCH'  
   IF @FDESC = 'DP FILE'  
    DROP TABLE #DP_TABLE_TMP  
   ELSE IF LEFT(@FDESC, 11) = 'THIRD PARTY'  
    DROP TABLE ##TPR_TMP  
   ELSE  
    DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
   ROLLBACK TRAN  
   DELETE FROM V2_UPLOADED_FILES  
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'  
   RETURN  
  END  
  
/* '--------------------------UPDATE OF COST CODE ------------------------*/  
  
 UPDATE #RECPAY_TABLE  
  SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  
 WHERE COSTCODE IS NULL  
  
/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/  
  
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)  
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'  
   IF @FDESC = 'DP FILE'  
    DROP TABLE #DP_TABLE_TMP  
   ELSE IF LEFT(@FDESC, 11) = 'THIRD PARTY'  
    DROP TABLE ##TPR_TMP  
   ELSE  
    DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
   ROLLBACK TRAN  
   DELETE FROM V2_UPLOADED_FILES  
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'  
   RETURN  
  END  
  
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/  
  
 SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM #RECPAY_TABLE  
  GROUP BY SRNO  
  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'  
   IF @FDESC = 'DP FILE'  
    DROP TABLE #DP_TABLE_TMP  
   ELSE IF LEFT(@FDESC, 11) = 'THIRD PARTY'  
    DROP TABLE ##TPR_TMP  
   ELSE  
    DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
   ROLLBACK TRAN  
   DELETE FROM V2_UPLOADED_FILES  
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'  
   RETURN  
  END  
  
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/  
  
 SELECT @@ERROR_COUNT = COUNT(1) FROM  
 (  
  SELECT DISTINCT  
   CLTCODE  
  FROM #RECPAY_TABLE  
  WHERE UPDFLAG = 'N'  
 ) A  
  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL  
   SELECT DISTINCT  
    CLTCODE  
   FROM #RECPAY_TABLE  
   WHERE UPDFLAG = 'N'  
   IF @FDESC = 'DP FILE'  
    DROP TABLE #DP_TABLE_TMP  
   ELSE IF LEFT(@FDESC, 11) = 'THIRD PARTY'  
    DROP TABLE ##TPR_TMP  
   ELSE  
    DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
   ROLLBACK TRAN  
   DELETE FROM V2_UPLOADED_FILES  
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'  
   RETURN  
  END  
  
 DECLARE  
  @@NEWVNO AS VARCHAR(12),  
  @@VDT AS VARCHAR(11),  
  @@LNOCUR AS CURSOR,  
  @@LNOVNO AS INT,  
  @@NOREC AS INT  
  
  
/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/  
 DECLARE  
  @@MAXVNO AS VARCHAR(12),  
  @@VNO AS VARCHAR(12),  
  @@RCOUNT AS INT  
 SELECT TOP 1  
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)  
 FROM  
  #RECPAY_TABLE  
  
 SELECT TOP 1  
  @@VNOMETHOD = VNOFLAG,  
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),  
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)  
 FROM  
  PARAMETER  
 WHERE  
  @@VDT BETWEEN SDTCUR AND LDTCUR  
  
 /*DP FILE SINGLE VNO GENERATION LOGIC*/  
 IF @FDESC = 'DP FILE'  
 BEGIN  
  SELECT   
   VVDT,  
   EEDT,  
   CLTCODE,  
   DRCR,  
   AMOUNT = SUM(AMOUNT),  
   NARRATION = MAX(NARRATION),  
   VDT,  
   UPDFLAG,  
   EDT,  
   ACNAME,  
   FYSTART,  
   FYEND,  
   COSTCODE,  
   LNO   
  INTO   
   #GLDETAIL  
  FROM   
   #RECPAY_TABLE  
  WHERE   
   DRCR = 'C'  
  GROUP BY   
   VVDT,  
   EEDT,  
   CLTCODE,  
   DRCR,  
   VDT,  
   UPDFLAG,  
   EDT,  
   ACNAME,  
   FYSTART,  
   FYEND,  
   COSTCODE,  
   LNO  
   
  DELETE FROM   
   #RECPAY_TABLE  
  WHERE   
   DRCR = 'C'  
   
  INSERT INTO #RECPAY_TABLE  
  (  
   SRNO,  
   VVDT,  
   EEDT,  
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION,  
   VDT,  
   UPDFLAG,  
   EDT,  
   ACNAME,  
   FYSTART,  
   FYEND,  
   COSTCODE,  
   LNO  
  )  
  SELECT  
   1,  
   VVDT,  
   EEDT,  
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION,  
   VDT,  
   UPDFLAG,  
   EDT,  
   ACNAME,  
   FYSTART,  
   FYEND,  
   COSTCODE,  
   LNO  
  FROM   
  #GLDETAIL  
   
  UPDATE  
   #RECPAY_TABLE  
  SET  
   SRNO = 1  
 END  
 /*DP FILE SINGLE VNO GENERATION LOGIC*/  
  
 SELECT  
  @@NOREC = COUNT(DISTINCT SRNO)  
 FROM  
  #RECPAY_TABLE  
 
/* 
 IF @@VNOMETHOD = 0  
  BEGIN  
   SELECT  
    @@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))  
   FROM  
    LASTVNO WITH (TABLOCKX,HOLDLOCK)  
   WHERE  
    VTYP = @VTYP  
    AND BOOKTYPE = @BOOKTYPE  
    AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'  
   IF @@MAXVNO = '0'  
    BEGIN  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, RIGHT(@@STD_DATE, 4) + '00000000') + @@NOREC)  
     SELECT @@VNO = RIGHT(@@STD_DATE, 4) + '00000001', @@RCOUNT = 0  
    END  
   ELSE  
    BEGIN  
     SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)  
    END  
   IF @@RCOUNT = 1  
    BEGIN  
     UPDATE  
      LASTVNO  
     SET  
      LASTVNO = @@MAXVNO  
     WHERE  
      VTYP = @VTYP  
      AND BOOKTYPE = @BOOKTYPE  
      AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'  
    END  
   ELSE  
    BEGIN  
     INSERT INTO  
      LASTVNO  
      (VTYP, BOOKTYPE, VDT, LASTVNO)  
     VALUES  
      (@VTYP, @BOOKTYPE, @@STD_DATE, @@MAXVNO)  
    END  
  END  
 ELSE IF @@VNOMETHOD = 1  
  BEGIN  
   SELECT  
    @@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))  
   FROM  
    LASTVNO WITH (TABLOCKX,HOLDLOCK)  
   WHERE  
    VTYP = @VTYP  
    AND BOOKTYPE = @BOOKTYPE  
    AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'  
   IF @@MAXVNO = '0'  
    BEGIN  
     SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0000'  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)  
     SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0001', @@RCOUNT = 0  
    END  
   ELSE  
    BEGIN  
     SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)  
    END  
   IF @@RCOUNT = 1  
    BEGIN  
     UPDATE  
      LASTVNO  
     SET  
      LASTVNO = @@MAXVNO  
     WHERE  
      VTYP = @VTYP  
      AND BOOKTYPE = @BOOKTYPE  
      AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'  
    END  
   ELSE  
    BEGIN  
     INSERT INTO  
      LASTVNO  
      (VTYP, BOOKTYPE, VDT, LASTVNO)  
     VALUES  
      (@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)  
    END  
  END  
 ELSE IF @@VNOMETHOD = 2  
  BEGIN  
   SELECT  
    @@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))  
   FROM  
    LASTVNO WITH (TABLOCKX,HOLDLOCK)  
   WHERE  
    VTYP = @VTYP  
    AND BOOKTYPE = @BOOKTYPE  
    AND MONTH(VDT) = MONTH(@@VDT)  
    AND YEAR(VDT) = YEAR(@@VDT)  
   IF @@MAXVNO = '0'  
    BEGIN  
     SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000000'  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)  
     SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000001', @@RCOUNT = 0  
    END  
   ELSE  
    BEGIN  
     SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)  
    END  
   IF @@RCOUNT = 1  
    BEGIN  
     UPDATE  
      LASTVNO  
     SET  
      LASTVNO = @@MAXVNO  
     WHERE  
      VTYP = @VTYP  
      AND BOOKTYPE = @BOOKTYPE  
      AND MONTH(VDT) = MONTH(@@VDT)  
      AND YEAR(VDT) = YEAR(@@VDT)  
    END  
   ELSE  
    BEGIN  
     INSERT INTO  
      LASTVNO  
      (VTYP, BOOKTYPE, VDT, LASTVNO)  
     VALUES  
      (@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)  
    END  
  END  
 */ 
SELECT  
	LASTVNO  
INTO #VNO  
FROM  
	V2_LASTVNO  
WHERE  
	1 = 2 

INSERT  
INTO #VNO
EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC

SELECT
	@@VNO = LASTVNO
FROM
	#VNO

 UPDATE  
  #RECPAY_TABLE  
 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)  
  
  
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/  
  
 SET @@LNOCUR = CURSOR FOR  
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE  
 OPEN @@LNOCUR  
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO  
 WHILE @@FETCH_STATUS = 0  
  BEGIN  
   INSERT INTO #RECPAY_TABLE_LNO  
    (SNO)  
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO  
   UPDATE RP  
    SET LNO = RL.LNO  
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL  
   WHERE RP.SNO = RL.SNO  
   TRUNCATE TABLE #RECPAY_TABLE_LNO  
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO  
  END  
 CLOSE @@LNOCUR  
 DEALLOCATE @@LNOCUR  
 DROP TABLE #RECPAY_TABLE_LNO  
  
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/  
/*==============================  
      LEDGER RECORD  
==============================*/  
 INSERT  
 INTO LEDGER  
 SELECT  
  VTYP = @VTYP,  
  VNO,  
  EDT,  
  LNO,  
  ACNAME,  
  DRCR,  
  VAMT = AMOUNT,  
  VDT,  
  VNO1 = VNO,  
  REFNO = 0,  
  BALAMT = AMOUNT,  
  NODAYS = 0,  
  CDT = GETDATE(),  
  CLTCODE,  
  BOOKTYPE = @BOOKTYPE,  
  ENTEREDBY = @UNAME,  
  PDT = GETDATE(),  
  CHECKEDBY = @UNAME,  
  ACTNODAYS = 0,  
  NARRATION  
 FROM  
  #RECPAY_TABLE  
  
/*==============================  
 LEDGER3 RECORD  
==============================*/  
 INSERT  
 INTO LEDGER3  
 SELECT  
  NARATNO = LNO,  
  NARRATION,  
  REFNO = 0,  
  VTYP = @VTYP,  
  VNO,  
  BOOKTYPE = @BOOKTYPE  
      FROM  
  #RECPAY_TABLE  
  
  
  
  
 DELETE FROM TEMPLEDGER2  
  WHERE SESSIONID = '9999999999'  
 INSERT INTO TEMPLEDGER2  
 SELECT  
  'BRANCH',  
  C.COSTNAME,  
  AMOUNT,  
  VTYP = @VTYP,  
  VNO,  
  LNO,  
  DRCR,  
  '0',  
  BOOKTYPE = @BOOKTYPE,  
  SESSIONID = '9999999999',  
  CLIENT_CODE = CLTCODE,  
  'A',  
  '0'  
 FROM  
  #RECPAY_TABLE RP,  
  COSTMAST C  
 WHERE  
  RP.COSTCODE = C.COSTCODE  
  
 DECLARE @@L2CUR AS CURSOR,  
  @@L2VNO AS VARCHAR(12)  
 SET @@L2CUR = CURSOR FOR  
  SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO  
 OPEN @@L2CUR  
 FETCH NEXT FROM @@L2CUR INTO @@L2VNO  
 WHILE @@FETCH_STATUS = 0  
  BEGIN  
   EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'  
   FETCH NEXT FROM @@L2CUR INTO @@L2VNO  
  END  
  DELETE FROM TEMPLEDGER2  
   WHERE SESSIONID = '9999999999'  
  CLOSE @@L2CUR  
  DEALLOCATE @@L2CUR  
  
 IF @FDESC = 'THIRD PARTY'  
 BEGIN  
  UPDATE   
   T   
  SET   
   VNO_JV = R.VNO   
  FROM   
   THIRDPARTY_COLLECTION T, #RECPAY_TABLE R  
  WHERE  
   T.CLTCODE = R.CLTCODE  
   AND T.AMOUNT = R.AMOUNT  
   AND TPR_FLAG = 'J'  
   AND VNO_JV IS NULL  
 END  
  
 ELSE IF @FDESC = 'THIRD PARTY REVERSAL'  
 BEGIN  
  UPDATE   
   T   
  SET   
   VNO_RJV = R.VNO   
  FROM   
   THIRDPARTY_COLLECTION T, #RECPAY_TABLE R  
  WHERE  
   T.CLTCODE = R.CLTCODE  
   AND T.AMOUNT = R.AMOUNT  
   AND TPR_FLAG = 'R'  
   AND VNO_RJV IS NULL  
 END  
  
 COMMIT TRAN  
  
 SELECT RESULT = '0~<HR><B>.:: Data Posted Successfully ::.</B><HR>'   
 UNION ALL  
 SELECT RESULT = VNO + ', ' + DRCR + ', ' + CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) FROM #RECPAY_TABLE ORDER BY 1  
 IF @FDESC = 'DP FILE'  
  DROP TABLE #DP_TABLE_TMP  
 ELSE IF LEFT(@FDESC, 11) = 'THIRD PARTY'  
  DROP TABLE ##TPR_TMP  
 ELSE  
  DROP TABLE #RECPAY_TABLE_TMP  
 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LED_BALANCES
-- --------------------------------------------------
--EXEC LED_BALANCES 'JUN 25 2007', '99988', '99988'
CREATE PROC [dbo].[LED_BALANCES]
@REPORT_DATE VARCHAR(11),
@FR_PARTY VARCHAR(10) = '0000000000',
@TO_PARTY VARCHAR(10) = 'ZZZZZZZZZZ'
AS

DECLARE 
@@START_DATE VARCHAR(11)

SELECT @@START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE @REPORT_DATE BETWEEN SDTCUR AND LDTCUR

SELECT 
	L.CLTCODE, LONGNAME, BRANCHCODE, BALANCE = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)
FROM 
	LEDGER L, ACMAST A
WHERE 
	L.CLTCODE = A.CLTCODE
	AND L.CLTCODE BETWEEN @FR_PARTY AND @TO_PARTY
	AND VDT BETWEEN @@START_DATE AND @REPORT_DATE + ' 23:59:59'
	AND ACCAT = 4
GROUP BY 
	L.CLTCODE, LONGNAME, BRANCHCODE
ORDER BY 
	L.CLTCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ledgermismatch
-- --------------------------------------------------

/* Query to find out vouchers where debit and credit is not matching */  
  
CREATE proc ledgermismatch  
as  
/*   
select vtyp, vno, debit = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D'),  
credit = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C'),  
balance = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D')  
          - ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C')  
from ledger l1  
group by vtyp, vno  
having ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D') <> ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C')  
*/  
select vtyp, booktype, vno, diff=sum(case when drcr = 'd' then vamt else -vamt end)  
from ledger  
group by vtyp, booktype, vno  
having sum(case when drcr = 'd' then vamt else -vamt end) <> 0  
order by vtyp, booktype, vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MARGINJVUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[MARGINJVUPLOAD_BULK]
	@FNAME VARCHAR(100),
	@UNAME VARCHAR(25),
	@VTYP SMALLINT,
	@BOOKTYPE VARCHAR(2),
	@MULTI BIT,
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(20)

AS
/*
	DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\Backoffice\marginjvs\Sample.Csv' And 
	EXEC MARGINJVUPLOAD_BULK 'D:\Backoffice\marginjvs\Sample.Csv', 'TEST', 24, '01', 0, 'NSE', 'CAPITAL'
	Exec MARGINJVUPLOAD_BULK 'D:\BackOffice\MarginJVs\', 'JAYDEEP', 24, '01', 1, 'NSE', 'CAPITAL'
	SELECT * FROM #RECPAY_TABLE
	SELECT @@TRANCOUNT
	SELECT * FROM #RECPAY_TABLE
	ROLLBACK
	SP CREATED BY		-	YATIN
	SP CREATED ON		-	JUL, 24 2006
*/
	SET NOCOUNT ON
	SELECT @UNAME = 'B_' + LTRIM(RTRIM(@UNAME))
	DECLARE
		@@ERROR_COUNT AS INT,
		@@SQL AS VARCHAR(2000),
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1),
		@@MARGINCODE VARCHAR(10),
		@@NEWVNO AS VARCHAR(12),
		@@VDT AS VARCHAR(11),
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS INT,
		@@NOREC AS INT,
		@@MAXVNO AS VARCHAR(12),
		@@VNO AS VARCHAR(12),
		@@RCOUNT AS INT,
		@@L2CUR AS CURSOR,
		@@BRANCHFLAG AS SMALLINT,
		@@L2VNO AS VARCHAR(12)

/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/
	IF LTRIM(RTRIM(@FNAME)) = ''
		BEGIN
			SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'
			RETURN
		END

	CREATE TABLE #FEXIST
		(F1 INT, F2 INT, F3 INT)
	
	SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "
	EXEC (@@SQL)

	SELECT @@ERROR_COUNT = F1 FROM #FEXIST
	IF @@ERROR_COUNT = 0
		BEGIN
			SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'
			DROP TABLE #FEXIST
			RETURN
		END

	BEGIN TRAN
/*
		SELECT 
			@@ERROR_COUNT = COUNT(1) 
		FROM
			(SELECT 
				U_FILENAME 
			FROM 
				V2_UPLOADED_FILES
			WHERE 
				U_FILENAME = @FNAME 
				AND U_MODULE = 'MARGIN JV UPLOAD') A

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME
			ROLLBACK TRAN
			RETURN
		END

*/
	CREATE TABLE #RECPAY_TABLE_TMP
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		MARGINCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500)
	)

	CREATE TABLE [#RECPAY_TABLE]
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		MARGINCODE VARCHAR(10),
		MARGINNAME VARCHAR(100),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500),
		SNO INT IDENTITY (1, 1) NOT NULL ,
		VDT DATETIME NULL ,
		UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),
		EDT DATETIME NULL ,
		VNO VARCHAR (12)  NULL ,
		ACNAME VARCHAR (100)  NULL ,
		FYSTART DATETIME NULL,
		FYEND DATETIME NULL,
		CLTCOST SMALLINT NULL,
		MARGINCOST SMALLINT NULL,
		LNO SMALLINT NOT NULL DEFAULT(0)
	) ON [PRIMARY]
	IF @MULTI = 0
		BEGIN
			CREATE TABLE [#RECPAY_TABLE_LNO]
			(
				SNO INT ,
				LNO INT IDENTITY (1, 1) NOT NULL
			) ON [PRIMARY]
		END
	ELSE
		BEGIN
			CREATE TABLE [#RECPAY_TABLE_LNO_M]
			(
				DRCR VARCHAR(1),
				LNO INT IDENTITY (1, 1) NOT NULL
			) ON [PRIMARY]
			CREATE TABLE [#RECPAY_TABLE_LNO_M1]
			(
				SRNO INT,
				MARGINCODE VARCHAR(10),
				DRCR VARCHAR(1)
			) ON [PRIMARY]
		END

	SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "
	EXEC(@@SQL)

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			SELECT 'DUE TO SOME ERROR IN BULK UPLOAD, FILE COULD NOT BE UPLOADED.'
			RETURN
		END

/*	      INSERT INTO V2_UPLOADED_FILES
	      SELECT
			@FNAME,
			@FNAME,
			COUNT(1),
			'B',
			GETDATE(),
			@UNAME,
			'MARGIN JV UPLOAD'
*/
	INSERT INTO #RECPAY_TABLE
		(SRNO,
		VVDT,
		EEDT,
		CLTCODE,
		MARGINCODE,
		DRCR,
		AMOUNT,
		NARRATION)
	SELECT
		SRNO,
		VVDT,
		EEDT,
		UPPER(CLTCODE),
		UPPER(MARGINCODE),
		DRCR,
		AMOUNT,
		LEFT(NARRATION, 234)
	FROM #RECPAY_TABLE_TMP

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			SELECT 'DUE TO SYSTEM ERROR, FILE COULD NOT BE UPLOADED.'
			RETURN
		END


	UPDATE
		#RECPAY_TABLE
	SET
		VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),
		EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2))

	SELECT TOP 1
		@@VDT = CONVERT(VARCHAR(11), VDT, 109)
	FROM
		#RECPAY_TABLE

	SELECT TOP 1
		@@VNOMETHOD = VNOFLAG,
		@@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),
		@@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),
		@@BRANCHFLAG = BRANCHFLAG
	FROM
		PARAMETER
	WHERE
		@@VDT BETWEEN SDTCUR AND LDTCUR

	IF @@BRANCHFLAG = 1
		BEGIN
			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = A.LONGNAME,
					CLTCOST = C.COSTCODE
		      FROM ACMAST A, PARAMETER P, COSTMAST C
			WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
			AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
			AND A.ACCAT IN (4, 104)
			AND A.BRANCHCODE = C.COSTNAME
			AND A.BRANCHCODE <> 'ALL'

			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = A.LONGNAME,
					CLTCOST = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			FROM ACMAST A, PARAMETER P
			WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
			AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
			AND A.ACCAT IN (4, 104)
			AND A.BRANCHCODE = 'ALL'

			UPDATE
				#RECPAY_TABLE
				SET
					MARGINNAME = A.LONGNAME,
					MARGINCOST = C.COSTCODE
			FROM ACMAST A, COSTMAST C
			WHERE A.CLTCODE = #RECPAY_TABLE.MARGINCODE
			AND A.BRANCHCODE = C.COSTNAME
			AND A.ACCAT = 14
			AND A.BRANCHCODE <> 'ALL'

			UPDATE
				#RECPAY_TABLE
				SET
					MARGINNAME = A.LONGNAME,
					MARGINCOST = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			FROM ACMAST A
			WHERE A.CLTCODE = #RECPAY_TABLE.MARGINCODE
			AND A.ACCAT = 14
			AND A.BRANCHCODE = 'ALL'

		END
	ELSE
		BEGIN
			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = A.LONGNAME
			FROM ACMAST A, PARAMETER P
			WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
			AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
			AND A.ACCAT IN (4, 104)

			UPDATE
				#RECPAY_TABLE
				SET
					MARGINNAME = A.LONGNAME
			FROM ACMAST A
			WHERE A.CLTCODE = #RECPAY_TABLE.MARGINCODE
			AND A.ACCAT = 14
		END


/* '--------------------------VALIDATION FOR MISSING CLIENT CODES------------------------*/

	SELECT
		CLTCODE
	INTO
		#MISS_CLTS
	FROM
		#RECPAY_TABLE R
	WHERE
		NOT EXISTS
				(SELECT
					CLTCODE
				FROM
					ACMAST A
				WHERE
					R.CLTCODE = A.CLTCODE
					AND ACCAT IN (4, 104)
				)

	SELECT @@ERROR_COUNT = COUNT(1) FROM #MISS_CLTS

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'FOLLOWING CLIENTS DO NOT EXISTS IN MASTER, PLEASE CHECK.'
			SELECT
				CLTCODE
			FROM
				#MISS_CLTS

			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			DROP TABLE #MISS_CLTS
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END


/* '--------------------------VALIDATION FOR MISSING MARGIN CODES------------------------*/

	SELECT
		MARGINCODE
	INTO
		#MISS_MARGINS
	FROM
		#RECPAY_TABLE R
	WHERE
		MARGINCODE IS NOT NULL
		AND NOT EXISTS
				(SELECT
					CLTCODE
				FROM
					ACMAST A
				WHERE
					R.MARGINCODE = A.CLTCODE
					AND ACCAT = 14
				)

	SELECT @@ERROR_COUNT = COUNT(1) FROM #MISS_MARGINS

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'FOLLOWING MARGIN CODE(S) DO NOT EXISTS IN MASTER, PLEASE CHECK.'
			SELECT
				MARGINCODE
			FROM
				#MISS_MARGINS
			
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			DROP TABLE #MISS_MARGINS
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END

/* '--------------------------VALIDATION FOR AVAILABLE MARGIN BALANCE------------------------*/
	IF @MULTI = 0
		BEGIN
			SELECT
				CLTCODE,
				MARGINCODE,
				AMOUNT = SUM(AMOUNT)
			INTO
				#MARGIN_AMOUNT
			FROM
				#RECPAY_TABLE
			WHERE
				DRCR = 'D'
				AND MARGINCODE IS NOT NULL
				AND MARGINCODE <> ''
			GROUP BY
				CLTCODE,
				MARGINCODE
		
			SELECT
				CLTCODE = M.PARTY_CODE,
				MARGINCODE = M.MCLTCODE,
				AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)
			INTO
				#TRANSACTIONS
			FROM
				MARGINLEDGER M
			WHERE
				VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'
				AND EXISTS
				(
				SELECT
					CLTCODE, MARGINCODE
				FROM
					#MARGIN_AMOUNT A
				WHERE
					A.CLTCODE = M.PARTY_CODE
					AND A.MARGINCODE = M.MCLTCODE
				)
			GROUP BY
				PARTY_CODE,
				MCLTCODE
		
			SELECT
				@@ERROR_COUNT = COUNT(1)
			FROM
				#TRANSACTIONS
			WHERE
				AMOUNT > 0
		
			IF @@ERROR_COUNT > 0
				BEGIN
					SELECT RESULT = 'FOLLOWING CLIENTS ARE ALREADY HAVING DEBIT MARGIN BALANCE. PLEASE CHECK THE TRANSACTIONS...'
					UNION ALL
					SELECT
						RESULT = 'CLIENT CODE: ' + CLTCODE + ', CURRENT MARGIN BALANCE: ' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ', MARGINCODE: ' + MARGINCODE
					FROM
						#TRANSACTIONS
					DROP TABLE #RECPAY_TABLE_TMP
					DROP TABLE #RECPAY_TABLE
					DROP TABLE #TRANSACTIONS
					DROP TABLE #MARGIN_AMOUNT
					ROLLBACK TRAN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
					RETURN
				END
		
			SELECT
				CLTCODE = A.CLTCODE,
				MARGINCODE = A.MARGINCODE,
				JVAMOUNT = A.AMOUNT,
				BALANCE = ISNULL(ABS(T.AMOUNT), 0)
			INTO
				#TRANSACTIONS_1
			FROM
				#MARGIN_AMOUNT A
				LEFT OUTER JOIN #TRANSACTIONS T
				ON A.CLTCODE = T.CLTCODE AND A.MARGINCODE = T.MARGINCODE AND T.AMOUNT < 0
		
			SELECT
				@@ERROR_COUNT = COUNT(1)
			FROM
				#TRANSACTIONS_1
			WHERE
				BALANCE < JVAMOUNT
		
			IF @@ERROR_COUNT > 0
				BEGIN
					SELECT RESULT = 'FOLLOWING CLIENTS ARE NOT HAVING ENOUGH CREDIT BALANCE AGAINST WHICH YOU ARE GIVING DEBIT.'
					UNION ALL
					SELECT
						RESULT = 'CLTCODE: ' + CLTCODE + ', AVAILABLE BALANCE: ' + LTRIM(RTRIM(CONVERT(VARCHAR, BALANCE))) + ', ENTRY AMOUNT: ' + LTRIM(RTRIM(CONVERT(VARCHAR, JVAMOUNT)))
					FROM
						#TRANSACTIONS_1
					WHERE
						BALANCE < JVAMOUNT
		
					DROP TABLE #RECPAY_TABLE_TMP
					DROP TABLE #RECPAY_TABLE
					DROP TABLE #TRANSACTIONS
					DROP TABLE #TRANSACTIONS_1
					DROP TABLE #MARGIN_AMOUNT
					ROLLBACK TRAN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
					RETURN
				END
		END
/*	SELECT
		CLTCODE = M.PARTY_CODE,
		AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)
	FROM
		MARGINLEDGER M
	WHERE
		VDT BETWEEN 'APR  1 2006' AND 'MAR 31 2007 23:59'
--		AND PARTY_CODE IN ('HOC0000001', 'TRI0000001')
	GROUP BY PARTY_CODE*/

/* '--------------------------VALIDATION FOR MULTIPLE MARGIN CODES------------------------*/
	IF @MULTI = 0
		BEGIN
			CREATE TABLE #MULTI_MARGIN
			(
				SRNO INT,
				MARGINCODE VARCHAR(10)
			)
			INSERT INTO
				#MULTI_MARGIN
			SELECT
				R.SRNO,
				R.MARGINCODE
			FROM
				#RECPAY_TABLE R,
				(
					SELECT
						SRNO,
						COUNTER = COUNT(1)
					FROM
						#RECPAY_TABLE
					WHERE
						MARGINCODE IS NOT NULL
						AND MARGINCODE <> ''
					GROUP BY
						SRNO
					HAVING
						COUNT(1) > 1
				) A
			WHERE
				R.SRNO = A.SRNO

			SELECT
				@@ERROR_COUNT = COUNT(1)
			FROM
				#MULTI_MARGIN

			IF @@ERROR_COUNT > 0
				BEGIN
					SELECT RESULT = 'MULTIPLE MARGIN CODES ON BOTH THE SIDES ARE NOT ALLOWED. PLEASE CHECK THE FOLLOWING ROWS...'
					UNION ALL
					SELECT
						RESULT = LTRIM(RTRIM(CONVERT(VARCHAR, SRNO))) + ', ' + MARGINCODE
					FROM
						#MULTI_MARGIN
					DROP TABLE #RECPAY_TABLE_TMP
					DROP TABLE #RECPAY_TABLE
					DROP TABLE #MULTI_MARGIN
					ROLLBACK TRAN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
					RETURN
				END
		END

/*--------------------------VALIDATION FOR NO MARGIN CODES IN ENTIRE VOUCHER------------------------*/
		CREATE TABLE #ZERO_MARGIN
		(
			SRNO INT
		)
		INSERT INTO
			#ZERO_MARGIN
		SELECT
			R.SRNO
		FROM
			#RECPAY_TABLE R
		WHERE
			(	R.MARGINCODE IS NULL
				OR R.MARGINCODE = ''
			)
			AND NOT EXISTS
				(
					SELECT DISTINCT
						SRNO
					FROM
						#RECPAY_TABLE R1
					WHERE
						MARGINCODE IS NOT NULL
						AND MARGINCODE <> ''
						AND R.SRNO = R1.SRNO
				)
		GROUP BY
			R.SRNO

		SELECT
			@@ERROR_COUNT = COUNT(1)
		FROM
			#ZERO_MARGIN

		IF @@ERROR_COUNT > 0
			BEGIN
				SELECT RESULT = 'PLEASE CHECK THE FOLLOWING ROWS AS NO MARGIN CODES FOUND IN IT.'
				UNION ALL
				SELECT
					RESULT = 'SRNO :-' + LTRIM(RTRIM(CONVERT(VARCHAR, M.SRNO))) + ', CLIENT CODE :-' + M.CLTCODE + ', MARGIN CODE : NULL'
				FROM
					#RECPAY_TABLE M,
					#ZERO_MARGIN T
				WHERE
					M.SRNO = T.SRNO

				DROP TABLE #RECPAY_TABLE_TMP
				DROP TABLE #RECPAY_TABLE
				ROLLBACK TRAN
				DELETE FROM V2_UPLOADED_FILES
					WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
				RETURN
			END

/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE NOT FALLING IN THE RESPECTIVE FINANCIAL YEAR.'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END

/* '--------------------------UPDATE OF COST CODE ------------------------*/
	IF @@BRANCHFLAG = 1
		BEGIN
			UPDATE #RECPAY_TABLE
				SET CLTCOST = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			WHERE CLTCODE IS NULL
			UPDATE #RECPAY_TABLE
				SET MARGINCOST = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			WHERE MARGINCOST IS NULL
		END

/*--------------------------VALIDATION FOR DIFFERENT VDTS------------------------*/

	SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE
	IF @@ERROR_COUNT > 1
		BEGIN
			SELECT 'MULTIPLE VOUCHER DATES ARE NOT ALLOWED TO UPLOAD'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END

/*--------------------------VALIDATION FOR VDTS LESS THAN EDTS------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM  #RECPAY_TABLE WHERE VDT > EDT
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'VOUCHER DATES IN SOME OF THE VOUCHERS FOUND GREATER THAN EFFECTIVE DATE.'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END

/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)
	GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
			RETURN
		END

/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/
	SELECT @@ERROR_COUNT = 0
	SELECT @@ERROR_COUNT = COUNT(1) FROM
		(SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM #RECPAY_TABLE
		GROUP BY SRNO
		HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END

/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT
			CLTCODE
		FROM #RECPAY_TABLE
		WHERE UPDFLAG = 'N'
	) A

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT RESULTS = 'FILE CANNOT BE UPLOADED AS SOME MISMATCH FOUND IN FOLLOWING ROWS' UNION ALL
			SELECT DISTINCT
				RESULTS = LTRIM(RTRIM(CONVERT(VARCHAR, SRNO))) + ',' + CLTCODE + ',' + MARGINCODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT)))
			FROM #RECPAY_TABLE
			WHERE UPDFLAG = 'N'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END


/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/

	SELECT
		@@NOREC = COUNT(DISTINCT SRNO)
	FROM
		#RECPAY_TABLE

	IF @@VNOMETHOD = 0
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, RIGHT(@@STD_DATE, 4) + '00000000') + @@NOREC)
					SELECT @@VNO = RIGHT(@@STD_DATE, 4) + '00000001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@STD_DATE, @@MAXVNO)
				END
		END
	ELSE IF @@VNOMETHOD = 1
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0000'
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)
					SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)
				END
		END
	ELSE IF @@VNOMETHOD = 2
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND MONTH(VDT) = MONTH(@@VDT)
				AND YEAR(VDT) = YEAR(@@VDT)
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000000'
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)
					SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND MONTH(VDT) = MONTH(@@VDT)
						AND YEAR(VDT) = YEAR(@@VDT)
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)
				END
		END

	UPDATE
		#RECPAY_TABLE
	SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)

/* '--------------------------AUTO GENERATION OF LNO ------------------------*/
	IF @MULTI = 0
		BEGIN
			SET @@LNOCUR = CURSOR FOR
				SELECT DISTINCT SRNO FROM #RECPAY_TABLE
			OPEN @@LNOCUR
				FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
			WHILE @@FETCH_STATUS = 0
				BEGIN
					INSERT INTO #RECPAY_TABLE_LNO
						(SNO)
					SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO ORDER BY MARGINCODE DESC
					UPDATE RP
						SET LNO = RL.LNO
					FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL
					WHERE RP.SNO = RL.SNO
					TRUNCATE TABLE #RECPAY_TABLE_LNO
					FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
				END
			CLOSE @@LNOCUR
			DEALLOCATE @@LNOCUR
			DROP TABLE #RECPAY_TABLE_LNO
		END
	ELSE
		BEGIN
			INSERT INTO #RECPAY_TABLE_LNO_M1
			SELECT
				SRNO,
				MARGINCODE,
				DRCR
			FROM
				#RECPAY_TABLE
			GROUP BY
				SRNO,
				MARGINCODE,
				DRCR
			ORDER BY
				SRNO,
				DRCR,
				MARGINCODE
			SET @@LNOCUR = CURSOR FOR
				SELECT SRNO, MARGINCODE, DRCR FROM #RECPAY_TABLE_LNO_M1 ORDER BY SRNO, DRCR, MARGINCODE
			OPEN @@LNOCUR
				FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@MARGINCODE, @@DRCR
			WHILE @@FETCH_STATUS = 0
				BEGIN
					INSERT INTO #RECPAY_TABLE_LNO_M (DRCR) SELECT DRCR FROM #RECPAY_TABLE_LNO_M1 WHERE SRNO = @@LNOVNO ORDER BY DRCR
					UPDATE RP
						SET LNO = M.LNO
					FROM
						#RECPAY_TABLE RP,
						#RECPAY_TABLE_LNO_M M
					WHERE
						RP.SRNO = @@LNOVNO
						AND RP.MARGINCODE = @@MARGINCODE
						AND RP.DRCR = M.DRCR
					TRUNCATE TABLE #RECPAY_TABLE_LNO_M
					FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@MARGINCODE, @@DRCR
				END
			CLOSE @@LNOCUR
			DEALLOCATE @@LNOCUR
			DROP TABLE #RECPAY_TABLE_LNO_M
		END
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/
/*===========================================
	CREATING FULL LEDGER RECORD AND INSERTING IN ONE SHOT
===========================================*/
	SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0
	INSERT INTO
		#LEDGER
	SELECT
		VTYP = @VTYP,
		VNO,
		EDT,
		LNO,
		MARGINNAME,
		DRCR,
		VAMT = SUM(AMOUNT),
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = SUM(AMOUNT),
		NODAYS = 0,
		CDT = GETDATE(),
		MARGINCODE,
		BOOKTYPE = @BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		#RECPAY_TABLE
	WHERE
		MARGINCODE <> ''
		AND MARGINCODE IS NOT NULL
	GROUP BY
		VNO,
		EDT,
		LNO,
		MARGINNAME,
		DRCR,
		VDT,
		MARGINCODE,
		NARRATION


	INSERT INTO
		#LEDGER
	SELECT
		VTYP = @VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT = AMOUNT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMOUNT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE,
		BOOKTYPE = @BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		#RECPAY_TABLE
	WHERE
		MARGINCODE = ''
		OR MARGINCODE IS NULL

	INSERT INTO
		LEDGER
	SELECT
		*
	FROM
		#LEDGER

	IF @@ERROR <> 0
		BEGIN
			DROP TABLE #LEDGER
			DROP TABLE #RECPAY_TABLE
			DROP TABLE #RECPAY_TABLE_TMP
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			SELECT 'DUE TO SOME ERROR IN LEDGER POSTING, FILE COULD NOT BE UPLOADED.'
			RETURN
		END
	DROP TABLE #LEDGER
/*==========================
	INSERTING MARGINLEDGER RECORD
===========================*/
	SELECT * INTO #MARGINLEDGER FROM MARGINLEDGER WHERE 1 = 0
	INSERT INTO
		#MARGINLEDGER
	SELECT
		VTYP = @VTYP,
		VNO,
		LNO,
		DRCR,
		VDT,
		AMOUNT,
		CLTCODE,
		EXCHANGE = @EXCHANGE,
		SEGMENT = @SEGMENT,
		SETT_NO = 0,
		SETT_TYPE = '',
		BOOKTYPE = @BOOKTYPE,
		MARGINCODE
	FROM
		#RECPAY_TABLE
	WHERE
		MARGINCODE IS NOT NULL
		AND MARGINCODE <> ''

	INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER

	IF @@ERROR <> 0
		BEGIN
			DROP TABLE #RECPAY_TABLE
			DROP TABLE #RECPAY_TABLE_TMP
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			SELECT 'DUE TO SOME ERROR IN MARGINLEDGER POSTING, FILE COULD NOT BE UPLOADED.'
			RETURN
		END
	DROP TABLE #MARGINLEDGER

/*==============================
	LEDGER3 RECORD
==============================*/
	SELECT Naratno,Narr,Refno,Vtyp,Vno,Booktype INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0
	INSERT
	INTO #LEDGER3
	SELECT
		NARATNO = LNO,
		NARRATION,
		REFNO = 0,
		VTYP = @VTYP,
		VNO,
		BOOKTYPE = @BOOKTYPE
      FROM
		#RECPAY_TABLE
	WHERE
		MARGINCODE <> ''
		AND MARGINCODE IS NOT NULL
	GROUP BY
		LNO,
		NARRATION,
		VNO


	INSERT
	INTO #LEDGER3
	SELECT
		NARATNO = LNO,
		NARRATION,
		REFNO = 0,
		VTYP = @VTYP,
		VNO,
		BOOKTYPE = @BOOKTYPE
      FROM
		#RECPAY_TABLE
	WHERE
		MARGINCODE = ''
		OR MARGINCODE IS NULL
	INSERT INTO LEDGER3 SELECT * FROM #LEDGER3
	DROP TABLE #LEDGER3

/*==============================
	LEDGER2 POSTING
==============================*/
	IF @@BRANCHFLAG = 1
		BEGIN
			DELETE FROM TEMPLEDGER2
				WHERE SESSIONID = '9999999999'
			INSERT INTO TEMPLEDGER2
			SELECT
				'BRANCH',
				C.COSTNAME,
				AMOUNT,
				VTYP = @VTYP,
				VNO,
				LNO,
				DRCR,
				'0',
				BOOKTYPE = @BOOKTYPE,
				SESSIONID = '9999999999',
				CLIENT_CODE = CLTCODE,
				'A',
				'0'
			FROM
				#RECPAY_TABLE RP,
				COSTMAST C
			WHERE
				RP.CLTCOST = C.COSTCODE
				AND (MARGINCODE = '' OR MARGINCODE IS NULL)
		
			INSERT INTO TEMPLEDGER2
			SELECT
				'BRANCH',
				C.COSTNAME,
				AMOUNT = SUM(AMOUNT),
				VTYP = @VTYP,
				VNO,
				LNO,
				DRCR,
				'0',
				BOOKTYPE = @BOOKTYPE,
				SESSIONID = '9999999999',
				CLIENT_CODE = MARGINCODE,
				'A',
				'0'
			FROM
				#RECPAY_TABLE RP,
				COSTMAST C
			WHERE
				RP.MARGINCOST = C.COSTCODE
				AND (MARGINCODE <> '' AND MARGINCODE IS NOT NULL)
			GROUP BY
				C.COSTNAME,
				VNO,
				LNO,
				DRCR,
				MARGINCODE


			SET @@L2CUR = CURSOR FOR
				SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO
			OPEN @@L2CUR
			FETCH NEXT FROM @@L2CUR INTO @@L2VNO
			WHILE @@FETCH_STATUS = 0
				BEGIN
					EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'
					IF @@ERROR <> 0
						BEGIN
							ROLLBACK TRAN
							IF @VTYP = 8
								BEGIN
									DELETE FROM V2_UPLOADED_FILES
										WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
								END
							ELSE
								BEGIN
									DELETE FROM V2_UPLOADED_FILES
										WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
								END
							SELECT 'DUE TO SOME ERROR IN LEDGER2 POSTING, FILE COULD NOT BE UPLOADED.'
							RETURN
						END
					FETCH NEXT FROM @@L2CUR INTO @@L2VNO
				END
				DELETE FROM TEMPLEDGER2
					WHERE SESSIONID = '9999999999'
				CLOSE @@L2CUR
				DEALLOCATE @@L2CUR
		END
	COMMIT TRAN
	SELECT RESULT = 'DATE UPLOADED SUCCESSFULLY'
	UNION ALL
	SELECT RESULT = 'CLTCODE:' + CLTCODE + ', MARGINCODE:' + ISNULL(MARGINCODE, '') + ', AMOUNT:' + CONVERT(VARCHAR, AMOUNT) + ', VNO:' + VNO FROM #RECPAY_TABLE
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Marginyearend
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Marginyearend    Script Date: 05/10/2004 5:29:33 PM ******/
/****** Object:  Stored Procedure dbo.Marginyearend    Script Date: 03/28/2003 4:34:58 PM ******/
CREATE Procedure [dbo].[Marginyearend]
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime

as
set transaction isolation level read uncommitted

declare
@@cltcode  as varchar(10),
@@lno      as int,
@@rcursor  as cursor

insert into marginledger
select @vtyp, @vno, 0, (case when t.bal >= 0 then 'D' else 'C' end), @vdt, abs(t.bal), t.party_code,
t.exchange, rtrim(t.segment), 0, '', @booktype, t.mcltcode
from
(select mcltcode, exchange, segment, party_code, bal=sum( case when upper(drcr) = 'D' then amount else -amount end)
from marginledger where vdt >= @sdtcur + ' 00:00:00' and vdt <= @ldtcur + ' 23:59:59'
group by mcltcode, exchange, segment, party_code) t


set @@rcursor = cursor for
select cltcode, lno from ledger where vtyp = @vtyp and booktype = @booktype and vno = @vno
order by cltcode

open @@rcursor
fetch next from @@rcursor 
into @@cltcode, @@lno

while @@fetch_status = 0
begin
   update marginledger set lno = @@lno where vtyp = @vtyp and booktype = @booktype and vno = @vno and mcltcode = @@cltcode

   fetch next from @@rcursor 
   into @@cltcode, @@lno
end

close @@rcursor
deallocate @@rcursor

/* For effective datewise Margin O/p Balances */

update marginledger set sett_no = t.bal
from
(
select mcltcode, exchange, segment, party_code, bal=sum( case when upper(m.drcr) = 'D' then amount else -amount end)
from marginledger m, ledger l
where m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and m.lno = l.lno
and l.edt >= @sdtcur + ' 00:00:00' and l.edt <= @ldtcur +' 23:59:59'
group by mcltcode, exchange, segment, party_code) t
where marginledger.mcltcode = t.mcltcode and marginledger.exchange = t.exchange and marginledger.segment=t.segment
and marginledger.party_code = t.party_code and marginledger.vtyp = 18

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newacc_Trialbalance
-- --------------------------------------------------
CREATE Procedure  [dbo].[Newacc_Trialbalance]

/* Report : Trial Balance        
Prints Trial Balance */

@Vdt Varchar(11),               /* As On Date Entered By User */
@Flag Varchar(15),              /* Sort Order For Report - Codewise Or Namewise */
@Viewoption Varchar(10),        /* Options For Accounts Selection - All, Gl, Party */
@Balance Varchar(10),           /* Normal Or Withopbal */
@Stdate Varchar(11),            /* Start Date Entered By User */
@Curryrstdate Varchar(11), 	/* Start Date Of Financial Year */
@Openentryflag Int, 
@Openingentrydate Varchar(11),  /* O/p Entry Date ( Vtyp = 18 ) Fround From Ledger For Vdt <= Last Date Entered By User */
@Statusid Varchar(20),          /* As Broker/branch/client Etc. */
@Statusname Varchar(20),        /* In Case Of Branch Login Branchcode */
@Sortbydate Varchar(3),         /* Whether Report Is Based On Vdt Or Edt */
@Fromamt    Money,              /* From Amount Entered By User */
@Toamt      Money,              /* To Amount Entered By User */
@Fromac     Varchar(35),        /* From Account/name Entered By User */
@Toac       Varchar(35)         /* To Account/name Entered By User */
As

Declare
@@Selectqury  As Varchar(8000), 
@@Fromtables  As Varchar(2000), 
@@Wherepart   As Varchar(1000), 
@@Wherepart1  As Varchar(500), 
@@Wherepart2  As Varchar(500), 
@@Wherepart3  As Varchar(500), 
@@Addwhere    As Varchar(200), 
@@Groupby     As Varchar(200), 
@@Sortby      As Varchar(200), 
@@Costcode    As Varchar(3), 
@@Whereac     As Varchar(500)

If @Statusid = 'Broker'
Begin
	Select @@Groupby    = " Group By L.Cltcode , A.Acname, Branchcode"
End
Else
Begin
	Select @@Groupby    = " Group By L2.Cltcode , A.Acname, Branchcode"
End

If @Statusid = 'Broker'
Begin
   If @Flag = 'Codewise'
      Begin
	   Select @@Sortby = " Order By  L.Cltcode , A.Acname, Branchcode"
      End
   Else
      Begin
	   Select @@Sortby = " Order By  A.Acname, L.Cltcode, Branchcode"
   End
End
Else
Begin
   If @Flag = 'Codewise'
      Begin
	   Select @@Sortby = " Order By  L2.Cltcode , A.Acname, Branchcode"
      End
   Else
      Begin
	   Select @@Sortby = " Order By  A.Acname, L2.Cltcode, Branchcode"
   End

End



If @Viewoption = 'Partywise'  /* Only Party Accounts To Be Displayed */
Begin
   Select @@Addwhere  = " And A.Accat = 4 " 
End
Else If @Viewoption = 'Gl'  /* Only Party Accounts To Be Displayed */
     Begin
        Select @@Addwhere  = " And A.Accat <> 4 " 
     End
     Else
     Begin
        Select @@Addwhere  = " " 
     End

If @Statusid = 'Broker'
Begin
   If @Sortbydate = 'Vdt'
   Begin
      Select @@Wherepart1 = " Where Vdt <= '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where Vdt >= '" + @Curryrstdate + " 00:00:00' And Vdt <= '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where Vdt >= '" + @Openingentrydate + " 00:00:00' And Vdt <= '" + @Vdt + " 23:59:59'" 
   End
   Else
   Begin
      Select @@Wherepart1 = " Where Edt <= '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where Edt >= '" + @Curryrstdate + " 00:00:00' And Edt <= '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where Edt >= '" + @Openingentrydate + " 00:00:00' And Edt <= '" + @Vdt + " 23:59:59'" 
   End
End
Else If @Statusid = 'Branch'
Begin
   Select @@Costcode = (Select Costcode From Costmast C, Category C2 Where C2.Category = 'Branch' And C.Catcode = C2.Catcode And Costname = @Statusname )
   If @Sortbydate = 'Vdt'
   Begin
      Select @@Wherepart1 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt <= '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt >= '" + @Curryrstdate + " 00:00:00' And Vdt <= '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt >= '" + @Openingentrydate + " 00:00:00' And Vdt <= '" + @Vdt + " 23:59:59'" 
   End
   Else
   Begin
      Select @@Wherepart1 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt <= '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt >= '" + @Curryrstdate + " 00:00:00' And Edt <= '" + @Vdt + " 23:59:59'" 
    Select @@Wherepart3 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt >= '" + @Openingentrydate + " 00:00:00' And Edt <= '" + @Vdt + " 23:59:59'" 
   End
End

If Len(Rtrim(@Fromac)) <> 0 
Begin
   If Len(Rtrim(@Toac)) <> 0  
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode >= '" + @Fromac + "' And L.Cltcode <= '" + @Toac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And A.Acname >= '" + @Fromac + "' And A.Acname <= '" + @Toac + "' "
       End
    Else
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode >= '" + @Fromac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And A.Acname >= '" + @Fromac + "' "
       End
End
Else
Begin
   If Len(Rtrim(@Toac)) <> 0  
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode <= '" + @Toac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And A.Acname <= '" + @Toac + "' "
       End
End


/*  -- For Broker --  */
/* ------------------ */

If @Statusid = 'Broker'
Begin
/*---- If User Wants To See Normal Trial Balance ---*/
If @Balance='Normal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Isnull(Sum(Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), 0)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart1 + @@Addwhere
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Isnull(Sum(Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), 0)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart2 + @@Addwhere
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Insull(Sum(Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), 0)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
/*--- If User Wants To See Trial Balance With Opening Balances ---*/
Else If @Balance='Withopbal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Isnull(Sum(Case When Upper(Drcr) = 'D' Then Vamt Else 0 End), 0), Crtot = Sum(Case When Upper(Drcr) = 'C' Then Vamt Else 0 End), Opbal = 0 "
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
       Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else -vamt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
           Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vtyp = 18 Then ( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End) Else 0 End)"
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
            Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
           Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End) Else 0 End) "
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
End    /* End Og Statusid = 'Broker'  */


/*  -- For Branch Selection --  */
/* ---------------------------- */

If @Statusid = 'Branch'
Begin
/*---- If User Wants To See Normal Trial Balance ---*/
If @Balance='Normal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      Select @@Selectqury = " Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart1 + @@Addwhere
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      Select @@Selectqury = " Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart2 + @@Addwhere
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = " Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
Else If @Balance='Withopbal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End), Crtot = Sum(Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End), Opbal = 0 "
            Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
            Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
           Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vtyp = 18 Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End) Else 0 End)"
            Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
            Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
           Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End) Else 0 End) "
      Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
End /* End Of Branch Login Or Branch Selection From Broker Login */

Print @@Selectqury + @@Fromtables + @@Wherepart + @@Groupby + @@Sortby  

Exec (@@Selectqury + @@Fromtables + @@Wherepart + @@Groupby + @@Sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newacc_trialbalancepartytotal
-- --------------------------------------------------
CREATE Procedure  [dbo].[Newacc_trialbalancepartytotal]
/* Report : Trial Balance        
Prints Trial Balance */
@Vdt Varchar(11),               /* As On Date Entered By User */
@Flag Varchar(15),              /* Sort Order For Report - Codewise Or Namewise */
@Viewoption Varchar(10),        /* Options For Accounts Selection - All, Gl, Party */
@Balance Varchar(10),           /* Normal Or Withopbal */
@Stdate Varchar(11),            /* Start Date Entered By User */
@Curryrstdate Varchar(11), /* Start Date Of Financial Year */
@Openentryflag Int, 
@Openingentrydate Varchar(11),  /* O/p Entry Date ( Vtyp = 18 ) Fround From Ledger For Vdt < = Last Date Entered By User */
@Statusid Varchar(20),          /* As Broker/branch/client Etc. */
@Statusname Varchar(20),        /* In Case Of Branch Login Branchcode */
@Sortbydate Varchar(3),         /* Whether Report Is Based On Vdt Or Edt */
@Fromamt    Money,              /* From Amount Entered By User */
@Toamt      Money,              /* To Amount Entered By User */
@Fromac     Varchar(35),        /* From Account/name Entered By User */
@Toac       Varchar(35)         /* To Account/name Entered By User */
As
Declare
@@Selectqury  As Varchar(8000), 
@@Fromtables  As Varchar(2000), 
@@Wherepart   As Varchar(1000), 
@@Wherepart1  As Varchar(500), 
@@Wherepart2  As Varchar(500), 
@@Wherepart3  As Varchar(500), 
@@Addwhere    As Varchar(200), 
@@Groupby     As Varchar(200), 
@@Sortby      As Varchar(200), 
@@Costcode    As Varchar(3), 
@@Whereac     As Varchar(500)
Select @@Groupby = " "
Select @@Sortby  = " "
Select @@Addwhere  = " And A.Accat = 4 " 
If @Statusid = 'Broker'
Begin
   If @Sortbydate = 'Vdt'
   Begin
      Select @@Wherepart1 = " Where Vdt < = '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where Vdt > = '" + @Curryrstdate + " 00:00:00' And Vdt < = '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where Vdt > = '" + @Openingentrydate + " 00:00:00' And Vdt < = '" + @Vdt + " 23:59:59'" 
   End
   Else
   Begin
      Select @@Wherepart1 = " Where Edt < = '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where Edt > = '" + @Curryrstdate + " 00:00:00' And Edt < = '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where Edt > = '" + @Openingentrydate + " 00:00:00' And Edt < = '" + @Vdt + " 23:59:59'" 
   End
End
Else If @Statusid = 'Branch'
Begin
   Select @@Costcode = (Select Costcode From Costmast C, Category C2 Where C2.Category = 'Branch' And C.Catcode = C2.Catcode And Costname = @Statusname )
   If @Sortbydate = 'Vdt'
   Begin
      Select @@Wherepart1 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt < = '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt > = '" + @Curryrstdate + " 00:00:00' And Vdt < = '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt > = '" + @Openingentrydate + " 00:00:00' And Vdt < = '" + @Vdt + " 23:59:59'" 
   End
   Else
   Begin
      Select @@Wherepart1 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt < = '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt > = '" + @Curryrstdate + " 00:00:00' And Edt < = '" + @Vdt + " 23:59:59'" 
    Select @@Wherepart3 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt > = '" + @Openingentrydate + " 00:00:00' And Edt < = '" + @Vdt + " 23:59:59'" 
   End
End
If Len(Rtrim(@Fromac)) <> 0 
Begin
   If Len(Rtrim(@Toac)) <> 0  
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode > = '" + @Fromac + "' And L.Cltcode < = '" + @Toac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And L.Acname > = '" + @Fromac + "' And L.Acname < = '" + @Toac + "' "
       End
    Else
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode > = '" + @Fromac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And L.Acname > = '" + @Fromac + "' "
       End
End
Else
Begin
   If Len(Rtrim(@Toac)) <> 0  
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode < = '" + @Toac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And L.Acname < = '" + @Toac + "' "
       End
End
/*  -- For Broker --  */
/* ------------------ */
If @Statusid = 'Broker'
Begin
/*---- If User Wants To See Normal Trial Balance ---*/
If @Balance = 'Normal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      Select @@Selectqury = "select Amount = Sum(Case When Drcr = 'D' Then Vamt Else -vamt End)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart1 + @@Addwhere
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      Select @@Selectqury = "select Amount = Sum(Case When Drcr = 'D' Then Vamt Else -vamt End)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart2 + @@Addwhere
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "select Amount = Sum(Case When Drcr = 'D' Then Vamt Else -vamt End)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
/*--- If User Wants To See Trial Balance With Opening Balances ---*/
Else If @Balance = 'Withopbal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "select Drtot = Sum(Case When Drcr = 'D' Then Vamt Else 0 End), Crtot = Sum(Case When Drcr = 'C' Then Vamt Else 0 End), Opbal = 0 "
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
            Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "select Drtot = Sum(Case When Vtyp <> 18 And Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And
 
 Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else -vamt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
           Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "select Drtot = Sum(Case When Vtyp <> 18 And Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And
 Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vtyp = 18 Then ( Case When Drcr = 'D' Then Vamt Else -vamt End) Else 0 End)"
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
            Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "select Drtot = Sum(Case When Vtyp <> 18 And Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And 
Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else -vamt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
           Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "select Drtot = Sum(Case When Vtyp <> 18 And Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And Vdt >
 = '" + @Stdate + "' Then ( Case When Drcr = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else -vamt End) Else 0 End) "
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
End    /* End Og Statusid = 'Broker'  */
/*  -- For Branch Selection --  */
/* ---------------------------- */
If @Statusid = 'Branch'
Begin
/*---- If User Wants To See Normal Trial Balance ---*/
If @Balance = 'Normal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      Select @@Selectqury = " Select Amount = Sum(Case When L2.Drcr = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart1 + @@Addwhere
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      Select @@Selectqury = " Select Amount = Sum(Case When L2.Drcr = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart2 + @@Addwhere
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = " Select Amount = Sum(Case When L2.Drcr = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
Else If @Balance = 'Withopbal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "select Drtot = Sum(Case When L2.Drcr = 'D' Then Camt Else 0 End), Crtot = Sum(Case When L2.Drcr = 'C' Then Camt Else 0 End), Opbal = 0 "
            Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
            Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "select Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <
> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else -camt End) Else 0 End) "
           Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
           Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "select Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp 
 <> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vtyp = 18 Then ( Case When L2.Drcr = 'D' Then Camt Else -camt End) Else 0 End)"
            Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
            Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "select Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <
> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else -camt End) Else 0 End) "
           Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
           Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "select Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <> 18 
And L.Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else -camt End) Else 0 End) "
      Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
End /* End Of Branch Login Or Branch Selection From Broker Login */
Print @@Selectqury + @@Fromtables + @@Wherepart + @@Groupby + @@Sortby  
Exec (@@Selectqury + @@Fromtables + @@Wherepart + @@Groupby + @@Sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newacmultiinsert
-- --------------------------------------------------
CREATE Procedure [dbo].[Newacmultiinsert]      
@Vtyp Smallint,           
@Booktype Char(2),           
@Vno Varchar(12),           
@Lno Int,           
@Vdt Varchar(11),           
@Edt Varchar(11),           
@Cltcode Varchar(10),           
@Drcr Char(1),            
@Vamt Money,           
@Enteredby Varchar(25),           
@Cdt Datetime, /*varchar(30), */          
@Checkedby Varchar(25),           
@Pdt Datetime, /*varchar(30), */          
@Acname Varchar(50),           
@Narration Varchar(234),           
@Chequeinname Varchar(50),           
@Chqprinted Tinyint,           
@Accat Int,           
@Bnkname Varchar(50),           
@Brnname Varchar(30),           
@Dd Char(1),           
@Ddno Varchar(15),           
@Dddt Datetime,           
@Reldt Datetime,           
@Relamt Money,           
@Micrno Int,           
@Sessionid Int,           
@Branchname Char(10),           
@Costflag Varchar(1),           
@Costrowid Int,           
@Clearingmode Char(1),           
@Emode Char(1)          
/*slipno, , Chequeinname, Chqprinted*/          
As          
Declare          
@@Vno1 As Varchar(12),           
@@Refno Char(12),           
@@Nodays Int,           
@@Actnodays Int,           
@@Balamt Money,           
@@Slipno Smallint,           
@@Slipdate Datetime,           
@@Clearingmode Char(2),           
@@Receiptno Int,           
@@Branch As Char(15),           
@@Exchange As Varchar(3),           
@@Segment As Varchar(10),           
@@Sett_no As Varchar(7),           
@@Sett_type As Varchar(3),           
@@Party_code As Varchar(10),           
@@Vdt1 As Datetime,           
@@Edt1 As Datetime,           
@@Dddt1 As Datetime,           
@@Reldt1 As Datetime,           
@@Recordcount As Int          
Select @@Vdt1 = Convert(Datetime, @Vdt+' '+convert(Varchar, Getdate(), 114))          
Select @@Edt1 = Convert(Datetime, @Edt+' '+convert(Varchar, Getdate(), 114))          
Select @@Dddt1 = Convert(Datetime, Substring(Convert(Varchar, @Dddt, 109), 1, 11)+' '+convert(Varchar, Getdate(), 114))          
/* Select @@Reldt1 = Convert(Datetime, Substring(Convert(Varchar, @Reldt, 109), 1, 11)+' 00:00:00' */          
Select @@Reldt1 = @Reldt          
Select @@Vno1 = @Vno          
Select @@Refno = ''          
Select @@Nodays = 0          
Select @@Actnodays  = 0          
Select @@Balamt = 0          
Select @@Slipno = 0          
Select @@Slipdate = ''          
/*select @@Clearingmode = ' ' */          
Select @@Receiptno = 0          
Select @@Branch =  'Branch'          
/* Inserting Record In Ledger */          
Insert Into Ledger(Vtyp, Vno, Drcr, Vamt, Vdt, Refno, Cltcode, Enteredby, Lno, Balamt,           
Vno1, Booktype, Edt, Cdt, Pdt, Nodays, Actnodays, Checkedby, Acname, Narration)           
Values (@Vtyp, @Vno, @Drcr, @Vamt, @@Vdt1, @@Refno, Upper(@Cltcode), @Enteredby, @Lno, @@Balamt,           
@@Vno1, @Booktype, @@Edt1, @Cdt, @Pdt, @@Nodays, @@Actnodays, @Checkedby, @Acname, @Narration)          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
/* Inserting Record In Ledger3 */          
Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values          
(@Lno, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)          
/* Inserting Common Narration In Ledger3 */          
If @Lno = 2           
Begin          
       Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values          
       (0, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)          
End           
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
/* Inserting Record In Ledger1 In Case Of Bank Related Vouchers*/          
If @Vtyp = 2 Or @Vtyp = 3 Or @Vtyp = 5 Or @Vtyp = 16 Or @Vtyp = 17  Or @Vtyp = 19 Or @Vtyp = 20           
Begin          
   If (@Vtyp = 2 Or @Vtyp = 19 Or @Vtyp = 16)          
      Begin          
 If   ( @Drcr = 'C' Or @Drcr = 'C' ) And @Lno = 2          
      Begin             
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)          
     Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)          
     End           
      End           
    Else If (@Vtyp = 3 Or @Vtyp = 20 Or @Vtyp = 17)          
        Begin          
   If  ( @Drcr = 'D' Or @Drcr = 'D' ) And @Lno = 2          
           
   Begin          
        Insert Into Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)          
            Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)          
      Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)          
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)          
                  End           
     End          
    Else If @Vtyp = 5          
        Begin          
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)          
         Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @@Reldt1, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)          
   If @Accat = 2 And @Drcr = 'C'          
   Begin          
           Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)          
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)          
   End          
        End          
End          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
/* Inserting Records In Matchdetails And Updating Billmatch */          
If @Lno = 2           
Begin          
      Delete  From Tempbilldetails Where Payamount = 0 And Rtrim(Sessionid) = Rtrim(@Sessionid)          
       Update Billmatch Set Billmatch.Balamt = Billmatch.Balamt - Payamount From Tempbilldetails T          
        Where  Rtrim(T.Sessionid) = Rtrim(@Sessionid)           
        And T.Party_code = Billmatch.Party_code And T.Billvtype = Billmatch.Vtype And T.Billbooktype = Billmatch.Booktype           
        And T.Billvno = Billmatch.Vno And T.Billlno = Billmatch.Lno          
        Insert Into Matchdetails          
        Select Description, Upper(Party_code), Billvtype, Billvno, Billlno, Billbooktype, Drcr, Payamount, Vtype, @Vno, @Lno, Booktype          
        From Tempbilldetails Where  Rtrim(Sessionid) = Rtrim(@Sessionid)           
End          
/* Insertting Records In Margin Ledger */          
If @Accat = 14 And (@Vtyp = 19 Or @Vtyp = 20 Or @Vtyp = 22 Or @Vtyp = 23 Or @Vtyp = 24)          
Begin          
   Insert Into Marginledger(Vtyp, Vno, Lno, Drcr, Vdt, Amount, Party_code, Exchange, Segment, Sett_no, Sett_type, Booktype, Mcltcode)          
   Values (@Vtyp, @Vno, @Lno, @Drcr, @@Vdt1, @Vamt, Upper(@@Party_code), @@Exchange, @@Segment, 0, @@Sett_type, @Booktype, Upper(@Cltcode))          
End          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
If (@Vtyp = '8' or @Vtyp = '19' or @Vtyp = '20' or @Vtyp = '24' or @Vtyp = '3') And Upper(@Emode) = 'M'            
Begin          
Declare @Recordcounter Smallint           Declare @Partycode Varchar(50)             
 Declare Cur_ledger_insert Cursor For             
        Select Count(Party_code), Party_code From Templedger2 Where             
        Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And           
 Booktype = @Booktype And Sessionid = @Sessionid And Party_code = @Cltcode and costflag = 'A'  Group By Party_code          
            
        Open Cur_ledger_insert            
            
        Fetch Next From Cur_ledger_insert           
        Into @Recordcounter, @Partycode          
While @@Fetch_status = 0            
Begin           
--if  @Partycode <> @Cltcode          
If @Recordcounter = 1          
 Begin          
        Delete From Templedger2 Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid           
 --       Insert Into Templedger2 Values (@@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )            
End          
/* Else          
 Begin          
  Update Templedger2 Set Paidamt = @Vamt Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid           
 End*/          
Fetch Next From Cur_ledger_insert             
             
End            
            
Close Cur_ledger_insert            
Deallocate Cur_ledger_insert            
End           
/* Inserting Record In Templedger2 For Branch Wise Breakup When Brnachflag = 1 And Match_ctoc = 1 In Parameter For Selected Year*/          
If Upper(@Emode) = 'A' Or Upper(@Emode) = 'M'          
/*select @@Recordcount = Count(Party_code) From Templedger2 Where           
Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid And Party_code = Upper(@Cltcode) And Paidamt = @Vamt          
If @@Recordcount = 0          
Begin*/          
Begin          
 Insert Into Templedger2 Values ( @@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )          
End          
--end          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newasp_Margintrialbalance
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[newasp_Margintrialbalance]  
  
@vdt varchar(11),               /* As on date entered by user */  
@flag varchar(15),              /* sort order for report - Codewise or Namewise */  
@viewoption varchar(10),        /* options for accounts selection - ALL, GL, PARTY */  
@balance varchar(10),           /* Normal or Withopbal */  
@stdate varchar(11),            /* Start date entered by user */  
@curryrstdate varchar(11), /* start date of financial year */  
@openentryflag int,  
@openingentrydate varchar(11),  /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */  
@statusid varchar(20),          /* As Broker/Branch/Client etc. */  
@statusname varchar(20),        /* In case of Branch login branchcode */  
@sortbydate varchar(3)          /* Whether report is based on VDT or EDT */  
  
AS  
  
declare  
@@selectqury  as varchar(2000),  
@@fromtables  as varchar(2000),  
@@wherepart   as varchar(1000),  
@@wherepart1  as varchar(500),  
@@wherepart2  as varchar(500),  
@@wherepart3  as varchar(500),  
@@addwhere    as varchar(200),  
@@Groupby     as varchar(200),  
@@sortby      as varchar(200),  
@@costcode    as varchar(3)  
  
if upper(@statusid) = 'BROKER'  
begin  
 select @@Groupby    = " group by l.party_code , a.acname, branchcode"  
end  
else  
begin  
 select @@Groupby    = " group by ml.party_code , a.acname, branchcode"
end  
  
if upper(@statusid) = 'BROKER'  
begin  
 if @flag = 'codewise'  
 begin  
    select @@sortby = " order by  l.party_code, a.acname, branchcode"  
 end  
 else   
 begin   
    select @@sortby = " order by  a.acname, l.party_code, branchcode"  
 end  
end  
else  
begin  
 if @flag = 'codewise'  
 begin  
    select @@sortby = " order by  ml.party_code, a.acname"  
 end  
 else   
 begin   
    select @@sortby = " order by  a.acname, ml.party_code"  
 end  
end  
  
if @viewoption = 'Partywise'  /* Only Party accounts to be displayed */  
begin  
   select @@addwhere  = " and a.accat = 4 "   
end  
else if @viewoption = 'GL'  /* Only Party accounts to be displayed */  
begin  
	select @@addwhere  = " and a.accat <> 4 "   
end  
else  
begin  
	select @@addwhere  = " "   
end  
  
if @statusid = 'Broker'  
begin  
      	select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' "   
      	select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'"   
      	select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'"   
end  
else if @statusid = 'branch'  
begin  
   	select @@costcode = (select costcode from costmast c, category c2 where c2.category = 'BRANCH' and c.catcode = c2.catcode and costname = @statusname )  
      	select @@wherepart1 = " where costcode = '" + @@costcode + "' and vdt <= '" + @vdt + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"   
      	select @@wherepart2 = " where costcode = '" + @@costcode + "' and vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"   
      	select @@wherepart3 = " where costcode = '" + @@costcode + "' and vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"   
end  
  
/*  -- FOR BROKER --  */  
/* ------------------ */  
  
if @statusid = 'Broker'  
begin  
/*---- If user wants to see NORMAL trial balance ---*/  
if @balance='normal'  
begin  
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */  
   begin  
      select @@selectqury = "select l.party_code , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then amount else -amount end)"  
      select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
      select @@wherepart  = @@wherepart1 + @@addwhere  
   end  
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */  
   begin  
        select @@selectqury = "select l.party_code , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then amount else -amount end)"  
        select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
        select @@wherepart  = @@wherepart2 + @@addwhere  
   end  
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */  
   begin  
        select @@selectqury = "select l.party_code , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then amount else -amount end)"  
        select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
        select @@wherepart  = @@wherepart3 + @@addwhere  
   end  
end  
/*--- If user wants to see Trial balance With Opening Balances ---*/  
else if @balance='withopbal'  
begin  
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */  
   begin  
      if @curryrstdate = @stdate   
         begin  
            select @@selectqury = "select l.party_code , acname=isnull(a.acname,''), branchcode, drtot = sum(case when upper(drcr) = 'D' then amount else 0 end), crtot = sum(case when upper(drcr) = 'C' then amount else 0 end),opbal = 0 "  
            select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
            select @@wherepart  = @@wherepart1 + @@addwhere  
         end  
      else  
         begin  
           select @@selectqury = "select l.party_code , acname=isnull(a.acname,''), branchcode,drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "'   then ( case when upper(drcr) = 'D' then amount else 0 end) else 0 end),crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "'    then ( case when upper(drcr) = 'C' then amount else 0 end) else 0 end),opbal = sum(case when vdt < '" + @stdate + "'  then ( case when upper(drcr) = 'D' then amount else -amount end) else 0 end) "  
           select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
           select @@wherepart  = @@wherepart1 + @@addwhere  
         end  
   end  
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */  
   begin  
      if @curryrstdate = @stdate   
         begin  
                select @@selectqury = "select l.party_code , acname=isnull(a.acname,''), branchcode,drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "'  then ( case when upper(drcr) = 'D' then amount else 0 end) else 0 end),crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "'  then ( case when upper(drcr) = 'C' then amount else 0 end) else 0 end),opbal = sum(case when vtyp = 18 then ( case when upper(drcr) = 'D' then amount else -amount end) else 0 end)"  
                select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
                select @@wherepart  = @@wherepart2 + @@addwhere  
         end  
      else  
         begin  
           select @@selectqury = "select l.party_code , acname=isnull(a.acname,''), branchcode,drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "'    then ( case when upper(drcr) = 'D' then amount else 0 end) else 0 end),crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "'   then ( case when upper(drcr) = 'C' then amount else 0 end) else 0 end),opbal = sum(case when vdt < '" + @stdate + "'  then ( case when upper(drcr) = 'D' then amount else -amount end) else 0 end) "  
           select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
           select @@wherepart  = @@wherepart2 + @@addwhere  
         end  
   end  
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */  
   begin  
      	select @@selectqury = "select l.party_code , acname=isnull(a.acname,''), branchcode,drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "'     then ( case when upper(drcr) = 'D' then amount else 0 end) else 0 end),crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "'   then ( case when upper(drcr) = 'C' then amount else 0 end) else 0 end),opbal = sum(case when vdt < '" + @stdate + "'   then ( case when upper(drcr) = 'D' then amount else -amount end) else 0 end) "  
      	select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
      	select @@wherepart  = @@wherepart3 + @@addwhere  
   end  
end  
end    /* End og Statusid = 'Broker'  */  
  
  
/*  -- FOR BRANCH SELECTION --  */  
/* ---------------------------- */  
  
if @statusid = 'Branch'  
begin  
/*---- If user wants to see NORMAL trial balance ---*/  
if @balance='normal'  
begin  
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */  
   begin  
      	select @@selectqury = " select ml.party_code , acname=isnull(a.acname,''), branchcode,Amount = sum(case when upper(ml.drcr) = 'D' then ml.amount else -ml.amount end)"  
      	select @@fromtables = " from ledger2 l LEFT OUTER JOIN (select party_code,amount,vtyp,vno,booktype,lno,drcr,mcltcode,VDT from marginledger) ml ON l.vno=ml.vno and l.vtype=ml.vtyp and l.booktype=ml.booktype and l.lno=ml.lno , ACMAST A"   
      	select @@wherepart  = @@wherepart1 + @@addwhere  
   end  
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */  
   begin  
      	select @@selectqury = " select ml.party_code , acname=isnull(a.acname,''), branchcode,Amount = sum(case when upper(ml.drcr) = 'D' then ml.amount else -ml.amount end)"  
      	select @@fromtables = " from ledger2 l LEFT OUTER JOIN (select party_code,amount,vtyp,vno,booktype,lno,drcr,mcltcode,VDT from marginledger) ml ON l.vno=ml.vno and l.vtype=ml.vtyp and l.booktype=ml.booktype and l.lno=ml.lno , ACMAST A"   
      	select @@wherepart  = @@wherepart2 + @@addwhere  
   end  
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */  
   begin  
      	select @@selectqury = " select ml.party_code , acname=isnull(a.acname,''), branchcode,Amount = sum(case when upper(ml.drcr) = 'D' then ml.amount else -ml.amount end)"  
      	select @@fromtables = " from ledger2 l LEFT OUTER JOIN (select party_code,amount,vtyp,vno,booktype,lno,drcr,mcltcode,VDT from marginledger) ml ON l.vno=ml.vno and l.vtype=ml.vtyp and l.booktype=ml.booktype and l.lno=ml.lno , ACMAST A"   
      	select @@wherepart  = @@wherepart3 + @@addwhere  
   end  
end  
end /* End of Branch login or Branch selection from Broker login */  
  
print @@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby   
  
exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newasp_Margintrialbalancepartytotal
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 04/15/2004 11:47:30 AM ******/  
  
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 05/10/2004 5:29:40 PM ******/  
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 04/07/2003 7:10:42 PM ******/  
  
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 04/07/2003 6:37:53 PM ******/  
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 02/18/2003 10:24:12 AM ******/  
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 12/04/2002 2:04:37 PM ******/  
CREATE  PROCEDURE  [dbo].[newasp_Margintrialbalancepartytotal]   
  
/* report : consolidated trial balance          
file : trialbal.asp  
displays consolidated trial balance */  
  
  
@vdt varchar(11),               /* As on date entered by user */  
@flag varchar(15),              /* sort order for report - Codewise or Namewise */  
@viewoption varchar(10),        /* options for accounts selection - ALL, GL, PARTY */  
@balance varchar(10),           /* Normal or Withopbal */  
@stdate varchar(11),            /* Start date entered by user */  
@curryrstdate varchar(11), /* start date of financial year */  
@openentryflag int,  
@openingentrydate varchar(11),  /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */  
@statusid varchar(20),          /* As Broker/Branch/Client etc. */  
@statusname varchar(20),        /* In case of Branch login branchcode */  
@sortbydate varchar(3)          /* Whether report is based on VDT or EDT */  
  
AS  
  
declare  
@@selectqury  as varchar(8000),  
@@fromtables  as varchar(2000),  
@@wherepart   as varchar(1000),  
@@wherepart1  as varchar(500),  
@@wherepart2  as varchar(500),  
@@wherepart3  as varchar(500),  
@@addwhere    as varchar(200),  
@@Groupby     as varchar(200),  
@@sortby      as varchar(200),  
@@costcode    as varchar(3)  
/*  
select @@Groupby = " group by l.drcr "  
select @@sortby  = " order by  l.drcr "  
*/  
  
select @@Groupby = " "  
select @@sortby  = " "  
  
select @@addwhere  = " and a.accat = 4 "   
  
if @statusid = 'Broker'  
begin  
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' "   
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'"   
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'"   
end  
else if UPPER(@statusid) = 'BRANCH'  
begin        
      select @@costcode = (select costcode from costmast c, category c2 where c2.category = 'BRANCH' and c.catcode = c2.catcode and costname = @statusname )
      select @@wherepart1 = " where costcode = '" + @@costcode + "' and vdt <= '" + @vdt + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"   
      select @@wherepart2 = " where costcode = '" + @@costcode + "' and vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"   
      select @@wherepart3 = " where costcode = '" + @@costcode + "' and vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"         
end  
  
/*  -- FOR BROKER --  */  
/* ------------------ */  
  
if @statusid = 'Broker'  
begin  
/*---- If user wants to see NORMAL trial balance ---*/  
if @balance='normal'  
begin  
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */  
   begin  
      select @@selectqury = "select Amount = isnull(sum(case when upper(drcr) = 'D' then amount else -amount end),0)"  
      select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
      select @@wherepart  = @@wherepart1 + @@addwhere  
   end  
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */  
   begin  
            select @@selectqury = "select Amount = isnull(sum(case when upper(drcr) = 'D' then amount else -amount end),0)"  
            select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
            select @@wherepart  = @@wherepart2 + @@addwhere  
   end  
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */  
   begin  
            select @@selectqury = "select Amount = isnull(sum(case when upper(drcr) = 'D' then amount else -amount end),0)"  
            select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
            select @@wherepart  = @@wherepart3 + @@addwhere  
   end  
end  
/*--- If user wants to see Trial balance With Opening Balances ---*/  
else if @balance='withopbal'  
begin  
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */  
   begin  
      if @curryrstdate = @stdate   
         begin  
            select @@selectqury = "select drtot = isnull(sum(case when upper(drcr) = 'D' then amount else 0 end),0),crtot = isnull(sum(case when upper(drcr) = 'C' then amount else 0 end),0),opbal = 0 "
            select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
            select @@wherepart  = @@wherepart1 + @@addwhere  
         end  
      else  
         begin  
           select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then amount else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and  vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then amount else 0 end) else 0 end),0), opbal = isnull(sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then amount else -amount end) else 0 end),0) "  
           select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
           select @@wherepart  = @@wherepart1 + @@addwhere  
         end  
   end  
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */  
   begin  
      if @curryrstdate = @stdate   
         begin  
                  select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then amount else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then amount else 0 end) else 0 end),0), opbal = isnull(sum(case when vtyp = 18 then ( case when upper(drcr) = 'D' then amount else -amount end) else 0 end),0)"  
                  select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
                  select @@wherepart  = @@wherepart2 + @@addwhere  
         end  
      else  
         begin  
           select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then amount else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then amount else 0 end) else 0 end),0), opbal = isnull(sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then amount else -amount end) else 0 end),0) "  
           select @@fromtables = " from MarginLedger l left outer join acmast a on l.party_code=  a.cltcode "   
           select @@wherepart  = @@wherepart2 + @@addwhere  
         end  
   end  
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */  
   begin  
            select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then amount else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then amount else 0 end) else 0 end),0), opbal = isnull(sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then amount else -amount end) else 0 end),0) "  
            select @@fromtables = " from Marginledger l left outer join acmast a on l.party_code=  a.cltcode "   
            select @@wherepart  = @@wherepart3 + @@addwhere  
   end  
end  
end    /* End og Statusid = 'Broker'  */  
  
  
/*  -- FOR BRANCH SELECTION --  */  
/* ---------------------------- */  
  
if upper(@statusid) = 'BRANCH'  
begin  
/*---- If user wants to see NORMAL trial balance ---*/  
if @balance='normal'  
begin     
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */  
   begin
      select @@selectqury = " select Amount = isnull(sum(case when upper(ml.drcr) = 'D' then ml.amount else -ml.amount end),0)"  
      select @@fromtables = " from ledger2 l LEFT OUTER JOIN (select party_code,amount,vtyp,vno,booktype,lno,drcr,mcltcode,VDT from marginledger) ml ON l.vno=ml.vno and l.vtype=ml.vtyp and l.booktype=ml.booktype and l.lno=ml.lno , ACMAST A "   
      select @@wherepart  = @@wherepart1 + @@addwhere  
   end  
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */  
   begin  
      select @@selectqury = " select Amount = isnull(sum(case when upper(ml.drcr) = 'D' then ml.amount else -ml.amount end),0)"  
      select @@fromtables = " from ledger2 l LEFT OUTER JOIN (select party_code,amount,vtyp,vno,booktype,lno,drcr,mcltcode,VDT from marginledger) ml ON l.vno=ml.vno and l.vtype=ml.vtyp and l.booktype=ml.booktype and l.lno=ml.lno , ACMAST A "   
      select @@wherepart  = @@wherepart2 + @@addwhere  
   end  
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */  
   begin  
      select @@selectqury = " select Amount = isnull(sum(case when upper(ml.drcr) = 'D' then ml.amount else -ml.amount end),0)"  
      select @@fromtables = " from ledger2 l LEFT OUTER JOIN (select party_code,amount,vtyp,vno,booktype,lno,drcr,mcltcode,VDT from marginledger) ml ON l.vno=ml.vno and l.vtype=ml.vtyp and l.booktype=ml.booktype and l.lno=ml.lno , ACMAST A "   
      select @@wherepart  = @@wherepart3 + @@addwhere  
   end

end  
end /* End of Branch login or Branch selection from Broker login */  


print @@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby    
  
exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newasp_trialbalance
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[newasp_trialbalance]  
    
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */    
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */    
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */    
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */    
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */    
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */    
@OPENENTRYFLAG INT,    
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */    
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */    
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */    
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */    
    
AS    
    
DECLARE     
@@COSTCODE INT    
    
SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM(@STATUSNAME)    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
    
IF UPPER(@STATUSID) = 'BROKER'    
BEGIN    
      IF UPPER(@VIEWOPTION) = 'GL'     
      BEGIN    
            IF UPPER(@SORTBYDATE) = 'VDT'    
    
            BEGIN    
                  SELECT     
                        L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
                  FROM     
                        LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                  WHERE     
                        VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59' AND A.ACCAT <> 4      
                  GROUP BY     
                        L.CLTCODE , L.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L.CLTCODE, L.ACNAME, BRANCHCODE    
            END    
    
            ELSE IF UPPER(@SORTBYDATE) = 'EDT'    
    
            BEGIN    
                  SELECT     
                        CLTCODE, ACNAME, BRANCHCODE, AMOUNT=SUM(AMOUNT)     
                  FROM     
                        (SELECT     
                              L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)
                        FROM     
                              LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                        WHERE     
                              EDT LIKE @CURRYRSTDATE + '%' AND A.ACCAT <> 4  AND L.VTYP = 18      
                        GROUP BY     
                              L.CLTCODE , L.ACNAME, BRANCHCODE     
                        UNION ALL     
                        SELECT     
                              L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END)     
                        FROM     
                              LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                        WHERE     
                              EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE AND A.ACCAT <> 4
                        GROUP BY     
                              L.CLTCODE , L.ACNAME, BRANCHCODE
                        UNION ALL     
                        SELECT     
                              L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
                        FROM     
                              LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                        WHERE     
                              EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59' AND A.ACCAT <> 4  AND L.VTYP <> 18     
                        GROUP BY     
                              L.CLTCODE , L.ACNAME, BRANCHCODE) L       
                  GROUP BY     
                        L.CLTCODE , L.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L.CLTCODE, L.ACNAME, BRANCHCODE    
            END    
    
      END    
      ELSE IF UPPER(@VIEWOPTION) = 'PARTYWISE'     
      BEGIN    
            IF UPPER(@SORTBYDATE) = 'VDT'    
    
            BEGIN    
                  SELECT     
                        L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
                  FROM     
                        LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                  WHERE     
                        VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59' AND A.ACCAT = 4      
                  GROUP BY     
			L.CLTCODE , L.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L.CLTCODE, L.ACNAME, BRANCHCODE    
            END    
    
 ELSE IF UPPER(@SORTBYDATE) = 'EDT'    
    
            BEGIN    
                  SELECT     
                        CLTCODE, ACNAME, BRANCHCODE, AMOUNT=SUM(AMOUNT)     
                  FROM     
                        (SELECT     
                               L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
                        FROM     
                              LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                        WHERE     
                              EDT LIKE @CURRYRSTDATE + '%' AND A.ACCAT = 4  AND L.VTYP = 18  
			GROUP BY 
				L.CLTCODE , L.ACNAME, BRANCHCODE     
                        UNION ALL     
			SELECT     
                               L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END)
                        FROM     
                              LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                        WHERE     
                              EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE AND A.ACCAT = 4  
			GROUP BY 
				L.CLTCODE , L.ACNAME, BRANCHCODE     
                        UNION ALL     
                        SELECT     
                              L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
                        FROM     
                              LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                        WHERE     
                              EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59' AND A.ACCAT = 4  AND L.VTYP <> 18     
                        GROUP BY     
                              L.CLTCODE , L.ACNAME, BRANCHCODE) L       
                  GROUP BY     
                        L.CLTCODE , L.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L.CLTCODE, L.ACNAME, BRANCHCODE    
            END    
      END    
    
      ELSE IF UPPER(@VIEWOPTION) = 'ALL'     
      BEGIN    
            IF UPPER(@SORTBYDATE) = 'VDT'    
    
            BEGIN    
                  SELECT     
                        L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
                  FROM     
                        LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                  WHERE     
                        VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59'      
                  GROUP BY     
                        L.CLTCODE , L.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L.CLTCODE, L.ACNAME, BRANCHCODE    
            END    
    
            ELSE IF UPPER(@SORTBYDATE) = 'EDT'    
    
            BEGIN    
                  SELECT     
                        CLTCODE, ACNAME, BRANCHCODE, AMOUNT=SUM(AMOUNT)     
                  FROM     
                        (SELECT     
                              L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)
                        FROM     
                              LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                        WHERE     
                              EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59'  AND L.VTYP = 18      
                        GROUP BY     
                              L.CLTCODE , L.ACNAME, BRANCHCODE     
                        UNION ALL     
                        SELECT     
                              L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END)     
                        FROM     
                              LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                        WHERE     
                              EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE
                        GROUP BY     
                              L.CLTCODE , L.ACNAME, BRANCHCODE
                        UNION ALL     
                        SELECT     
                              L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
                        FROM     
                              LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE      
                        WHERE     
                              EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59'  AND L.VTYP <> 18     
                        GROUP BY     
                              L.CLTCODE , L.ACNAME, BRANCHCODE) L       
                  GROUP BY     
                        L.CLTCODE , L.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L.CLTCODE, L.ACNAME, BRANCHCODE    
            END    
      END    
END    
    
IF UPPER(@STATUSID) = 'BRANCH'    
BEGIN    
      IF UPPER(@VIEWOPTION) = 'GL'     
      BEGIN    
            IF UPPER(@SORTBYDATE) = 'VDT'    
    
            BEGIN    
                  SELECT     
                        L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)     
                  FROM     
                 LEDGER L, LEDGER2 L2     
                        LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE       
                  WHERE     
                        L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = @@COSTCODE     
                        AND VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59' AND A.ACCAT <> 4      
                  GROUP BY     
                        L2.CLTCODE , A.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L2.CLTCODE, A.ACNAME, BRANCHCODE    
            END    
    
            ELSE IF UPPER(@SORTBYDATE) = 'EDT'    
    
            BEGIN    
                  SELECT     
                        CLTCODE, ACNAME, BRANCHCODE, AMOUNT=SUM(AMOUNT)     
                  FROM     
                        (SELECT     
                              L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''),                 
                              BRANCHCODE,AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE -CAMT END)           
                        FROM     
                              LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE             
                        WHERE     
                              L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO                 
                              AND COSTCODE = @@COSTCODE AND EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE AND A.ACCAT <> 4            
                        GROUP BY     
                              L2.CLTCODE , A.ACNAME, BRANCHCODE     
                        UNION ALL      
                        SELECT     
                              L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)     
                        FROM     
                              LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE       
                        WHERE     
                               L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = @@COSTCODE     
                              AND EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59' AND A.ACCAT <> 4      
                        GROUP BY     
                              L2.CLTCODE , A.ACNAME, BRANCHCODE) L     
                  GROUP BY     
                        L.CLTCODE , L.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L.CLTCODE, L.ACNAME, BRANCHCODE    
            END    
    
      END    
      ELSE IF UPPER(@VIEWOPTION) = 'PARTYWISE'     
      BEGIN    
            IF UPPER(@SORTBYDATE) = 'VDT'    
    
            BEGIN    
                  SELECT     
                        L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)     
                  FROM     
                        LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE       
                  WHERE     
                        L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = @@COSTCODE     
                        AND VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59' AND A.ACCAT = 4      
                  GROUP BY     
                        L2.CLTCODE , A.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L2.CLTCODE, A.ACNAME, BRANCHCODE    
            END    
    
            ELSE IF UPPER(@SORTBYDATE) = 'EDT'    
    
            BEGIN    
                   SELECT     
                        CLTCODE, ACNAME, BRANCHCODE, AMOUNT=SUM(AMOUNT) FROM    
                        (SELECT     
                              L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,                 
                              AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE -CAMT END)           
                        FROM     
                              LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE             
                        WHERE     
                              L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO                 
                              AND COSTCODE = @@COSTCODE AND EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE AND A.ACCAT = 4            
                        GROUP BY     
                              L2.CLTCODE , A.ACNAME, BRANCHCODE     
                        UNION ALL      
                        SELECT     
                              L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)     
                        FROM     
                              LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE       
                        WHERE     
                              L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO     
                              AND COSTCODE = @@COSTCODE AND EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59' AND A.ACCAT = 4      
                        GROUP BY     
                              L2.CLTCODE , A.ACNAME, BRANCHCODE) L     
                  GROUP BY     
                        L.CLTCODE , L.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L.CLTCODE, L.ACNAME, BRANCHCODE    
            END    
      END    
    
      ELSE IF UPPER(@VIEWOPTION) = 'ALL'     
      BEGIN    
            IF UPPER(@SORTBYDATE) = 'VDT'    
    
            BEGIN    
                  SELECT     
                        L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)     
                  FROM     
                        LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE       
                  WHERE     
                        L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = @@COSTCODE     
                        AND VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59'      
                  GROUP BY     
                        L2.CLTCODE , A.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L2.CLTCODE, A.ACNAME, BRANCHCODE    
            END    
    
            ELSE IF UPPER(@SORTBYDATE) = 'EDT'    
    
            BEGIN    
                  SELECT     
                        CLTCODE, ACNAME, BRANCHCODE, AMOUNT=SUM(AMOUNT)     
                  FROM     
                        (SELECT     
                              L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,                 
                              AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE -CAMT END)           
                        FROM     
                              LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE             
                        WHERE     
                              L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO                 
                              AND COSTCODE = @@COSTCODE AND EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE     
                        GROUP BY     
                              L2.CLTCODE , A.ACNAME, BRANCHCODE     
                        UNION ALL      
                        SELECT     
                              L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)     
                        FROM     
                              LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE       
                        WHERE     
                              L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = @@COSTCODE     
                              AND EDT >= @CURRYRSTDATE AND EDT <= @VDT  + ' 23:59'     
                        GROUP BY     
                              L2.CLTCODE , A.ACNAME, BRANCHCODE) L     
                  GROUP BY     
                        L.CLTCODE , L.ACNAME, BRANCHCODE     
                  ORDER BY      
                        L.CLTCODE, L.ACNAME, BRANCHCODE    
            END    
      END    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newasp_trialbalancepartytotal
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 12/16/2003 12:59:36 PM ******/

/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 04/07/2003 7:10:42 PM ******/

/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 04/07/2003 6:37:53 PM ******/
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 02/18/2003 10:24:12 AM ******/
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 12/04/2002 2:04:37 PM ******/
CREATE  PROCEDURE  [dbo].[newasp_trialbalancepartytotal] 

/* report : consolidated trial balance        
file : trialbal.asp
displays consolidated trial balance */


@vdt varchar(11),               /* As on date entered by user */
@flag varchar(15),              /* sort order for report - Codewise or Namewise */
@viewoption varchar(10),        /* options for accounts selection - ALL, GL, PARTY */
@balance varchar(10),           /* Normal or Withopbal */
@stdate varchar(11),            /* Start date entered by user */
@curryrstdate varchar(11),	/* start date of financial year */
@openentryflag int,
@openingentrydate varchar(11),  /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */
@statusid varchar(20),          /* As Broker/Branch/Client etc. */
@statusname varchar(20),        /* In case of Branch login branchcode */
@sortbydate varchar(3)          /* Whether report is based on VDT or EDT */

AS

declare
@@selectqury  as varchar(8000),
@@fromtables  as varchar(2000),
@@wherepart   as varchar(1000),
@@wherepart1  as varchar(500),
@@wherepart2  as varchar(500),
@@wherepart3  as varchar(500),
@@addwhere    as varchar(200),
@@Groupby     as varchar(200),
@@sortby      as varchar(200),
@@costcode    as varchar(3)
/*
select @@Groupby = " group by l.drcr "
select @@sortby  = " order by  l.drcr "
*/

select @@Groupby = " "
select @@sortby  = " "

select @@addwhere  = " and a.accat = 4 " 

if @statusid = 'Broker'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
   end
end
else if @statusid = 'branch'
begin
   select @@costcode = (select costcode from costmast c, category c2 where c2.category = 'BRANCH' and c.catcode = c2.catcode and costname = @statusname )
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
    select @@wherepart3 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
   end
end

/*  -- FOR BROKER --  */
/* ------------------ */

if @statusid = 'Broker'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select Amount = isnull(sum(case when upper(drcr) = 'D' then vamt else -vamt end),0)"
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select Amount = isnull(sum(case when upper(drcr) = 'D' then vamt else -vamt end),0)"
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart2 + @@addwhere
	 end
      else
         begin
            select @@selectqury = " select Amount=sum(amount) from "
            select @@selectqury = @@selectqury + " (select Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"            
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + " and l.vtyp <> 18 "
            select @@selectqury = @@selectqury + " Union all "
            select @@selectqury = @@selectqury + "select Amount = sum(balamt)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + " AND L.VTYP = 18 ) t"
            select @@fromtables = " "
            select @@wherepart  = " "
	 end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select Amount = isnull(sum(case when upper(drcr) = 'D' then vamt else -vamt end),0)"
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere
	 end
      else
         begin
            select @@selectqury = " select Amount=sum(amount) from "
            select @@selectqury = @@selectqury + " (select Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"            
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart3 + @@addwhere + " and l.vtyp <> 18 "
            select @@selectqury = @@selectqury + " Union all "
            select @@selectqury = @@selectqury + "select Amount = sum(balamt)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + ") t"
            select @@fromtables = " "
            select @@wherepart  = " "
	 end
   end
end
/*--- If user wants to see Trial balance With Opening Balances ---*/
else if @balance='withopbal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select drtot = isnull(sum(case when upper(drcr) = 'D' then vamt else 0 end),0), crtot = isnull(sum(case when upper(drcr) = 'C' then vamt else 0 end),0),opbal = 0 "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart1 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and  vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end),0), opbal = isnull(sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end),0) "
           select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
           select @@wherepart  = @@wherepart1 + @@addwhere
         end
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @curryrstdate = @stdate 
         begin
            if @sortbydate = 'vdt'
               begin
                  select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end),0), opbal = isnull(sum(case when vtyp = 18 then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end),0)"
                  select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
                  select @@wherepart  = @@wherepart2 + @@addwhere
               end
	    else
	       begin
                  select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end),0), opbal = isnull(sum(case when vtyp = 18 then balamt else 0 end),0)"
                  select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
                  select @@wherepart  = @@wherepart2 + @@addwhere
	       end
         end
      else
         begin
           select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end),0), opbal = isnull(sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end),0) "
           select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end),0), opbal = isnull(sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end),0) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere
	 end
      else
	 begin
            select @@selectqury = " select Amount=sum(amount) from "
            select @@selectqury = @@selectqury + " (select Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"            
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart3 + @@addwhere + " and l.vtyp <> 18 "
            select @@selectqury = @@selectqury + " Union all "
            select @@selectqury = @@selectqury + "select Amount = sum(balamt)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + ") t"
            select @@fromtables = " "
    select @@wherepart  = " "
	 end
   end
end
end    /* End og Statusid = 'Broker'  */


/*  -- FOR BRANCH SELECTION --  */
/* ---------------------------- */

if @statusid = 'Branch'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = " select Amount = isnull(sum(case when upper(l2.drcr) = 'D' then camt else -camt end),0)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      select @@selectqury = " select Amount = isnull(sum(case when upper(l2.drcr) = 'D' then camt else -camt end),0)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart2 + @@addwhere
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = " select Amount = isnull(sum(case when upper(l2.drcr) = 'D' then camt else -camt end),0)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
else if @balance='withopbal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select drtot = isnull(sum(case when upper(l2.drcr) = 'D' then camt else 0 end),0), crtot = isnull(sum(case when upper(l2.drcr) = 'C' then camt else 0 end),0),opbal = 0 "
            select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
            select @@wherepart  = @@wherepart1 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select drtot = isunll(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end),0), crtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end),0), opbal = isnull(sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end),0) "
           select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
           select @@wherepart  = @@wherepart1 + @@addwhere
         end
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select drtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end),0), crtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end),0), opbal = isnull(sum(case when l.vtyp = 18 then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end),0)"
            select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
            select @@wherepart  = @@wherepart2 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select drtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end),0), crtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end),0), opbal = isnull(sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end),0) "
           select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = "select drtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end),0), crtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end),0), opbal = isnull(sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end),0) "
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
end /* End of Branch login or Branch selection from Broker login */

print @@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby  

exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newpartybalances1
-- --------------------------------------------------
--exec Newpartybalances1 '0A141', '0A141', 'Apr 1 2005','Apr 1 2005', 'Feb 28 2006','PARTY', '346969512', '%'  
CREATE Procedure [dbo].[Newpartybalances1]    
@Fromparty Varchar(10),     
@Toparty Varchar(10),     
@Opendate Varchar(11),     
@Fromdt Varchar(11),     
@Todate Varchar(11),     
@Reporttype Varchar(30),     
@Sessionid Varchar(30),     
@Branchcode Varchar(10)    
As    
Declare     
@@Balcur As Cursor,     
@@Baldate As Datetime,     
@@Enddatenew As Datetime,     
@@Enddate As Datetime    
Set Nocount On    
Delete From Temppartybalances1 Where Rtrim(Sessionid) = Rtrim(@Sessionid)    
Select @@Baldate = @Fromdt + ' 23:59'    
/*select @@Baldatenew = @Fromdt + ' 00:00:00'*/    
Select @@Enddate = @Todate + ' 23:59'    
Select @@Enddatenew = Dateadd(Day, 1, @@Baldate)     
If Upper(Rtrim(@Reporttype)) = 'party'  
Begin    
Print 'I Am In Party'    
   While @@Baldate < = @@Enddate    
   Begin    
-- Select @@Baldate    
 Insert Into Temppartybalances1    
 Select L.Cltcode, @@Baldate, Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), @Sessionid    
 From Ledger L, Acmast A Where Edt > = 'Apr  1 2003' + ' 00:00' And Edt < = @@Baldate     
 And L.Cltcode = A.Cltcode And A.Accat = 4 And A.Cltcode > = @Fromparty And A.Cltcode < = @Toparty    
 And A.Branchcode Like Rtrim(@Branchcode) + '%'    
 Group By L.Cltcode    
 Order By L.Cltcode    
        Select @@Baldate = Dateadd(Day, 1, @@Baldate)    
   End    
/*    
While @@Baldatenew < = @@Enddate    
   Begin    
 Select @@Baldatenew    
 Insert Into Temppartybalances1    
 Select L.Cltcode, @@Baldatenew, Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), @Sessionid    
 From Ledger L, Acmast A Where Edt > = @Opendate + ' 00:00:00' And Edt < = @@Baldate     
 And L.Cltcode = A.Cltcode And A.Accat = 4 And A.Cltcode > = @Fromparty And A.Cltcode < = @Toparty    
 And A.Branchcode Like Rtrim(@Branchcode) + '%'    
 Group By L.Cltcode    
 Order By L.Cltcode    
        Select @@Baldate = Dateadd(Day, 1, @@Baldate)    
        Select @@Baldatenew = Dateadd(Day, 1, @@Baldatenew)    
   End    
*/    
End    
Else If Upper(Rtrim(@Reporttype)) = 'family'    
Begin    
Print 'I Am In Family'    
   While @@Baldate < = @@Enddate    
   Begin    
 Select @@Baldate    
 Insert Into Temppartybalances1    
 Select C.Family, @@Baldate, Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), @Sessionid    
 From Ledger L, Clientmaster C Where Edt > = @Opendate + ' 00:00:00' And Edt < = @@Baldate     
 And L.Cltcode = C.Party_code And C.Family > = @Fromparty And C.Family < = @Toparty    
 And C.Branch_cd Like Rtrim(@Branchcode) + '%'    
 Group By C.Family    
 Order By C.Family    
        Select @@Baldate = Dateadd(Day, 1, @@Baldate)    
   End    
End    
Else If Upper(Rtrim(@Reporttype)) = 'familyparty'    
Begin    
Print 'I Am In Familyparty'    
   While @@Baldate < = @@Enddate    
   Begin    
 Select @@Baldate    
 Insert Into Temppartybalances1    
 Select L.Cltcode, @@Baldate, Sum( Case When Upper(Drcr)  = 'D' Then Vamt Else -vamt End), @Sessionid    
 From Ledger L, Clientmaster C  Where Edt > = @Opendate + ' 00:00' And Edt < = @@Baldate     
 And L.Cltcode = C.Party_code And C.Family > = 'S06786' And C.Family < = @Toparty    
 And C.Branch_cd Like Rtrim(@Branchcode) + '%'    
 Group By L.Cltcode    
 Order By L.Cltcode    
        Select @@Baldate = Dateadd(Day, 1, @@Baldate)    
   End    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newpartybalances11
-- --------------------------------------------------
Create Procedure [dbo].[Newpartybalances11]  
@Fromparty Varchar(10),  
@Toparty Varchar(10),   
@Opendate Varchar(11),  
@Fromdt Varchar(11),  
@Todate Varchar(11),  
@Reporttype Varchar(30),  
@Branchcode Varchar(10),  
@Accountserver Varchar(15),  
@Accountdb Varchar(20),  
@Exchange Varchar(10),  
@Segment Varchar(15),  
@Intratedr Numeric,  
@Intratecr Numeric,  
@Tablename Varchar(25),  
@Company Varchar(50),  
@Shareserver Varchar(15),  
@Sharedb Varchar(15),  
@Datetype Varchar(5)  
  
As  
  
Declare   
@@Balcur As Cursor,  
@@Baldate As Varchar(32),  
@@Enddatenew As Datetime,  
@@Enddate As Datetime,  
@Qtytorun Varchar(6000),  
@Selectqry Varchar(2000),  
@Whereclause Varchar(4000)  
  
Select @Qtytorun = '', @Selectqry = '', @Whereclause = ''  
  
--set Nocount On  
  
Select * Into #tempbalances From Temppartybalances2 Where 1 = 2  
  
Select @@Baldate = @Fromdt + ' 23:59'  
  
/*select @@Baldatenew = @Fromdt + ' 00:00:00'*/  
Select @@Enddate = @Todate + ' 23:59'  
Select @@Enddatenew = Dateadd(Day, 1, @@Baldate)   
  
If Upper(Rtrim(@Reporttype)) = 'Party'  
Begin  
--print 'I Am In Party'  
  
   While @@Baldate < = @@Enddate  
 Begin  
 --select @@Baldate  
  
  
   
/* Select @Selectqry = 'Insert Into Temppartybalances1'  
 Select @Selectqry = @Selectqry  + ' Select L.Cltcode, ' + '''' + @@Baldate + '''' + ' , Sum( Case When Upper(Drcr) = ''D'' Then Vamt Else -vamt End), ' +  @Sessionid  
 Select @Selectqry = @Selectqry  + '  From ' +  @Accountserver +'.'+ @Accountdb+'.Dbo.Ledger L, '+@Accountserver+'.'+@Accountdb+'.Dbo.Acmast A Where Edt > = ''Apr  1 2003 00:00''  And Edt < = ' + '''' + @@Baldate  + ''''  
 Select @Selectqry = @Selectqry  + '  And L.Cltcode = A.Cltcode And A.Accat = 4 And A.Cltcode > = ''' + @Fromparty  + '''And A.Cltcode < = '''+ @Toparty+''''  
 Select @Selectqry = @Selectqry  + '  And A.Branchcode Like ' + '''' + @Branchcode  + '%'+ '''' + ' And Not ( Vtyp = ''8'' And L.Booktype = ''02'' ) '  
 Select @Selectqry = @Selectqry  + '  Group By L.Cltcode'  
 Select @Selectqry = @Selectqry  + '  Order By L.Cltcode'*/  
  
  
-- Select @Selectqry = 'Insert Into Temppartybalances2'  
 /*select @Selectqry = 'Insert Into ' + @Tablename  
 Select @Selectqry = @Selectqry  + ' Select L.Cltcode, ' + '''' + @@Baldate + '''' + ' , Sum( Case When Upper(Drcr) = ''D'' Then Vamt Else -vamt End), ' + '''' + @Exchange + '''' + ', ''' + @Segment + ''''  
 Select @Selectqry = @Selectqry  + ', Sum(Case When Upper(Drcr) = ''D'' Then ((Vamt * 30/100)/365) Else 0 End), Sum(Case When Upper(Drcr) = ''C'' Then ((Vamt * 30/100)/365) Else 0 End), ' + '''' + @Accountserver + '''' + ', ''' + @Accountdb + '''' + ', ''
' + @Com
  
  
  
  
  
  
  
  
  
  
  
  
  
  
Pany + ''''  
 Select @Selectqry = @Selectqry  + ', C1.Short_name, ' + '''' + @Shareserver + '''' + ', ''' + @Sharedb + ''''  
 Select @Selectqry = @Selectqry  + ', (Select Isnull(Sum(Case When Upper(M.Drcr) = ''D'' Then Amount Else -amount End), 0) '  
 Select @Selectqry = @Selectqry  + 'From Marginledger M Where Vdt > = ''Apr  1 2003'' And Vdt < = ''' + @@Baldate + ''' And Party_code = L.Cltcode) '  
 Select @Selectqry = @Selectqry  + ' From ' +  @Accountserver + '.' +  @Accountdb+'.Dbo.Ledger L, ' + @Accountserver + '.' + @Accountdb+'.Dbo.Acmast A, '  
 Select @Selectqry = @Selectqry  + @Shareserver + '.' +  @Sharedb+'.Dbo.Client1 C1, ' + @Shareserver + '.' + @Sharedb+'.Dbo.Client2 C2 '  
 Select @Selectqry = @Selectqry  +  'Where Edt > = ''Apr  1 2003 00:00''  And Edt < = ' + '''' + @@Baldate  + ''''  
 Select @Selectqry = @Selectqry  + ' And L.Cltcode = A.Cltcode And A.Accat = 4 And A.Cltcode > = ''' + @Fromparty  + '''And A.Cltcode < = '''+ @Toparty+''''  
 Select @Selectqry = @Selectqry  + ' And A.Branchcode Like ' + '''' + @Branchcode  + '%'+ '''' + ' And Not ( Vtyp = ''8'' And L.Booktype = ''02'' ) '  
 Select @Selectqry = @Selectqry  + ' And L.Cltcode  = C2.Party_code And C1.Cl_code = C2.Cl_code'  
 Select @Selectqry = @Selectqry  + '  Group By L.Cltcode, C1.Short_name'  
 Select @Selectqry = @Selectqry  + '  Order By L.Cltcode'*/  
  
If @Datetype = 'Edt'  
Begin  
 Insert Into #tempbalances  
 Select L.Cltcode, @@Baldate, Sum( Case When Upper(Drcr) = 'D' Then -vamt Else Vamt End), @Exchange, @Segment  
 , Sum(Case When Upper(Drcr) = 'D' Then ((Vamt * 30/100)/365) Else 0 End), Sum(Case When Upper(Drcr) = 'C' Then ((Vamt * 30/100)/365) Else 0 End), @Accountserver, @Accountdb , @Company  
 , C1.Short_name, @Shareserver, @Sharedb  
 , (Select Isnull(Sum(Case When Upper(M.Drcr) = 'D' Then -amount Else Amount End), 0)  
 From Marginledger M Where Vdt > = @Opendate And Vdt < = @@Baldate And Party_code = L.Cltcode)  
 From Ledger L, Acmast A,   
 Client1 C1, Client2 C2  
 Where Edt > = @Opendate  And Edt < = @@Baldate And L.Cltcode = A.Cltcode And A.Accat = 4 And A.Cltcode > = @Fromparty And A.Cltcode < = @Toparty  
 And A.Branchcode Like @Branchcode + '%' And Not ( Vtyp = '8' And L.Booktype = '02' )   
 And L.Cltcode  = C2.Party_code And C1.Cl_code = C2.Cl_code  
 Group By L.Cltcode, C1.Short_name  
 Order By L.Cltcode  
  
End  
Else  
Begin  
 Insert Into #tempbalances  
 Select L.Cltcode, @@Baldate, Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), @Exchange, @Segment  
 , Sum(Case When Upper(Drcr) = 'D' Then ((Vamt * 30/100)/365) Else 0 End), Sum(Case When Upper(Drcr) = 'C' Then ((Vamt * 30/100)/365) Else 0 End), @Accountserver, @Accountdb , @Company  
 , C1.Short_name, @Shareserver, @Sharedb  
 , (Select Isnull(Sum(Case When Upper(M.Drcr) = 'D' Then Amount Else -amount End), 0)  
 From Marginledger M Where Vdt > = @Opendate And Vdt < = @@Baldate And Party_code = L.Cltcode)  
 From Ledger L, Acmast A,   
 Client1 C1, Client2 C2  
 Where Vdt > = @Opendate  And Vdt < = @@Baldate  
 And L.Cltcode = A.Cltcode And A.Accat = 4 And A.Cltcode > = @Fromparty And A.Cltcode < = @Toparty  
 And A.Branchcode Like @Branchcode + '%' And Not ( Vtyp = '8' And L.Booktype = '02' )   
 And L.Cltcode  = C2.Party_code And C1.Cl_code = C2.Cl_code  
 Group By L.Cltcode, C1.Short_name  
 Order By L.Cltcode  
End  
  
  
 Print @Selectqry  
  
 --exec (@Selectqry)  
  
        Set @@Baldate = Dateadd(Day, 1, @@Baldate)  
  
 End  
  
End  
  
Else If Upper(Rtrim(@Reporttype)) = 'Family'  
Begin  
--print 'I Am In Family'  
While @@Baldate < = @@Enddate  
   Begin  
 --select @@Baldate  
  
/* Select @Selectqry = 'Insert Into Temppartybalances1'  
 Select @Selectqry = @Selectqry  + 'Select C.Family, ' + '''' + @@Baldate + '''' + ', Sum( Case When Upper(Drcr) = ''D'' Then Vamt Else -vamt End), ' + @Sessionid  
 Select @Selectqry = @Selectqry  + 'From Ledger L, Clientmaster C Where Edt > = ' + '''' + @Opendate + '00:00:00'''' And Edt < = ' +  '''' + @@Baldate + ''''  
 Select @Selectqry = @Selectqry  + 'And L.Cltcode = C.Party_code And C.Family > = ''' + @Fromparty + ''' And C.Family < = ''' + @Toparty + ''''  
 Select @Selectqry = @Selectqry  + 'And C.Branch_cd Like ' + '''' + @Branchcode + '%' + '''' + ' And Not ( Vtyp = ''8'' And L.Booktype = ''02'' ) '  
 Select @Selectqry = @Selectqry  + 'Group By C.Family'  
 Select @Selectqry = @Selectqry  + 'Order By C.Family'  
 Print @Selectqry*/  
  
 --exec (@Selectqry)  
  
If @Datetype = 'Edt'  
Begin  
 Insert Into #tempbalances  
 Select C.Family, @@Baldate, Sum( Case When Upper(Drcr) = 'D' Then -vamt Else Vamt End),   
 @Exchange, @Segment  
 , Sum(Case When Upper(Drcr) = 'D' Then ((Vamt * 30/100)/365) Else 0 End), Sum(Case When Upper(Drcr) = 'C' Then ((Vamt * 30/100)/365) Else 0 End), @Accountserver, @Accountdb , @Company  
 , C.Short_name, @Shareserver, @Sharedb  
 , (Select Isnull(Sum(Case When Upper(M.Drcr) = 'D' Then -amount Else Amount End), 0)  
 From Marginledger M Where Vdt > = @Opendate And Vdt < = @@Baldate And Party_code = C.Party_code)  
 From Ledger L, Clientmaster C Where Edt > = @Opendate And Edt < = @@Baldate  
 And L.Cltcode = C.Party_code And C.Family > = @Fromparty And C.Family < = @Toparty   
 And C.Branch_cd Like @Branchcode + '%' And Not ( Vtyp = '8' And L.Booktype = '02' )   
 Group By C.Family, C.Short_name, C.Party_code  
 Order By C.Family  
End  
Else  
Begin  
 Insert Into #tempbalances  
 Select C.Family, @@Baldate, Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End),   
 @Exchange, @Segment  
 , Sum(Case When Upper(Drcr) = 'D' Then ((Vamt * 30/100)/365) Else 0 End), Sum(Case When Upper(Drcr) = 'C' Then ((Vamt * 30/100)/365) Else 0 End), @Accountserver, @Accountdb , @Company  
 , C.Short_name, @Shareserver, @Sharedb  
 , (Select Isnull(Sum(Case When Upper(M.Drcr) = 'D' Then Amount Else -amount End), 0)  
 From Marginledger M Where Vdt > = @Opendate And Vdt < = @@Baldate And Party_code = C.Party_code)  
 From Ledger L, Clientmaster C Where Vdt > = @Opendate + ' 00:00' And Vdt < = @@Baldate  
 And L.Cltcode = C.Party_code And C.Family > = @Fromparty And C.Family < = @Toparty   
 And C.Branch_cd Like @Branchcode + '%' And Not ( Vtyp = '8' And L.Booktype = '02' )   
 Group By C.Family, C.Short_name, C.Party_code  
 Order By C.Family  
End  
  
        Select @@Baldate = Dateadd(Day, 1, @@Baldate)  
  
   End  
End  
Else If Upper(Rtrim(@Reporttype)) = 'Familyparty'  
Begin  
--print 'I Am In Familyparty'  
   While @@Baldate < = @@Enddate  
   Begin  
-- Select @@Baldate  
  
  
/* Select @Selectqry = 'Insert Into Temppartybalances1'  
 Select @Selectqry = @Selectqry  + 'Select L.Cltcode, @@Baldate, Sum( Case When Upper(Drcr)  = ''D'' Then Vamt Else -vamt End), ' + @Sessionid  
 Select @Selectqry = @Selectqry  + 'From Ledger L, Clientmaster C  Where Edt > = ''' + @Opendate + ' 00:00' + ''' And Edt < = ''' + @@Baldate + ''''  
 Select @Selectqry = @Selectqry  + 'And L.Cltcode = C.Party_code And C.Family > = ''' + @Fromparty + ''' And C.Family < = ''' + @Toparty + ''''  
 Select @Selectqry = @Selectqry  + 'And C.Branch_cd Like ' + '''' + @Branchcode + '%' + '''' + ' And Not ( Vtyp = ''8'' And L.Booktype = ''02'' ) '  
 Select @Selectqry = @Selectqry  + 'Group By L.Cltcode'  
 Select @Selectqry = @Selectqry  + 'Order By L.Cltcode'  
 Print @Selectqry*/  
  
 --exec (@Selectqry)  
  
If @Datetype = 'Edt'  
Begin  
 Insert Into #tempbalances  
 Select L.Cltcode, @@Baldate, Sum( Case When Upper(Drcr)  = 'D' Then -vamt Else Vamt End), @Exchange, @Segment  
 , Sum(Case When Upper(Drcr) = 'D' Then ((Vamt * 30/100)/365) Else 0 End), Sum(Case When Upper(Drcr) = 'C' Then ((Vamt * 30/100)/365) Else 0 End), @Accountserver, @Accountdb , @Company  
 , C.Short_name, @Shareserver, @Sharedb  
 , (Select Isnull(Sum(Case When Upper(M.Drcr) = 'D' Then -amount Else Amount End), 0)  
 From Marginledger M Where Vdt > = @Opendate And Vdt < = @@Baldate And Party_code = C.Party_code)  
 From Ledger L, Clientmaster C Where Edt > = @Opendate + ' 00:00' And Edt < = @@Baldate   
 And L.Cltcode = C.Party_code And C.Family > = @Fromparty And C.Family < = @Toparty  
 And C.Branch_cd Like Rtrim(@Branchcode) + '%'  
 Group By L.Cltcode, C.Short_name, C.Party_code  
 Order By L.Cltcode  
End  
Else  
Begin  
 Insert Into #tempbalances  
 Select L.Cltcode, @@Baldate, Sum( Case When Upper(Drcr)  = 'D' Then Vamt Else -vamt End), @Exchange, @Segment  
 , Sum(Case When Upper(Drcr) = 'D' Then ((Vamt * 30/100)/365) Else 0 End), Sum(Case When Upper(Drcr) = 'C' Then ((Vamt * 30/100)/365) Else 0 End), @Accountserver, @Accountdb , @Company  
 , C.Short_name, @Shareserver, @Sharedb  
 , (Select Isnull(Sum(Case When Upper(M.Drcr) = 'D' Then Amount Else -amount End), 0)  
 From Marginledger M Where Vdt > = @Opendate And Vdt < = @@Baldate And Party_code = C.Party_code)  
 From Ledger L, Clientmaster C  Where Vdt > = @Opendate + ' 00:00' And Vdt < = @@Baldate   
 And L.Cltcode = C.Party_code And C.Family > = @Fromparty And C.Family < = @Toparty  
 And C.Branch_cd Like Rtrim(@Branchcode) + '%'  
 Group By L.Cltcode, C.Short_name, C.Party_code  
 Order By L.Cltcode  
End  
  
        Select @@Baldate = Dateadd(Day, 1, @@Baldate)  
  
   End  
End  
  
  
  
Select * From #tempbalances

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL
-- --------------------------------------------------
CREATE   PROCEDURE [dbo].[NEWPOSTBILL]  
(
      @VTYP SMALLINT,  
      @BOOKTYPE VARCHAR(2),  
      @VNO VARCHAR(12),  
      @VDT VARCHAR(11),  
      @EDTDR VARCHAR(11),  
      @EDTCR VARCHAR(11),  
      @CDT VARCHAR(11),  
      @PDT VARCHAR(11),  
      @ENTEREDBY VARCHAR(25),  
      @CHECKEDBY VARCHAR(25),  
      @SETT_NO VARCHAR(7),  
      @SETT_TYPE VARCHAR(3),  
      @UNAME VARCHAR(25),   
      @EXCHANGE VARCHAR(10), 
      @OVNO VARCHAR(12) = ''
)

AS  
  
/*=================================================================================================
--EXEC NEWPOSTBILL 15, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'  
--EXEC NEWPOSTBILL 21, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'  
=================================================================================================*/

SET NOCOUNT ON  

DECLARE  
	@@OBJID AS INT,  
	@@EDTDR AS VARCHAR(11),  
	@@EDTCR AS VARCHAR(11),  
	@@LEDCNT AS INT
  
BEGIN TRANSACTION

	SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)

/*=================================================================================================
      CHECK FOR DELETE IF RE-POSTING IS BEING DONE
=================================================================================================*/
      IF @OVNO <> ''
      BEGIN
           SELECT @@LEDCNT = COUNT(1) FROM BILLPOSTED WITH(NOLOCK) WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE
           IF @@LEDCNT > 0 
           BEGIN 
                DELETE FROM LEDGER WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
                DELETE FROM LEDGER1 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
                DELETE FROM LEDGER2 WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
                DELETE FROM LEDGER3 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
                DELETE FROM BILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
                DELETE FROM BILLPOSTED WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
                IF @@OBJID <> 0  
                BEGIN  
                     DELETE FROM BFBILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
                END  
           END
      END

      TRUNCATE TABLE POSTBILLLEDGER  
      TRUNCATE TABLE POSTBILLLEDGER2


/*=========================================================================================================
      POPULATE DATA FROM ACCBILL (NORMAL CLIENTS) / IACCBILL (INST CLIENTS), ACMAST TO BE USED FOR POSTING
=========================================================================================================*/
      IF @VTYP = 15  
      BEGIN  
            INSERT 
            INTO POSTBILLLEDGER 
                  ( 
                        VTYP, 
                        VNO, 
                        EDT, 
                        ACNAME, 
                        DRCR, 
                        VAMT, 
                        VDT, 
                        VNO1, 
                        REFNO, 
                        BALAMT, 
                        NODAYS, 
                        CDT, 
                        CLTCODE, 
                        BOOKTYPE, 
                        ENTEREDBY, 
                        PDT, 
                        CHECKEDBY, 
                        ACTNODAYS, 
                        NARRATION, 
                        SETT_NO, 
                        SETT_TYPE, 
                        BILL_NO, 
                        ACCAT, 
                        BRANCHCODE
                  ) 
            SELECT 
                  @VTYP, 
                  @VNO, 
                  (
                        CASE 
                              WHEN SELL_BUY = 1 
                              THEN @EDTDR 
                              ELSE @EDTCR 
    END
                        ), 
                  ACNAME, 
                        (
                        CASE 
                              WHEN SELL_BUY = 1 
                              THEN 'D' 
                              ELSE 'C' 
                        END
                        ), 
                  AMOUNT, 
                  @VDT, 
                  @VNO, 
                  '', 
                  0, 
                  0, 
                  CONVERT(VARCHAR(11), GETDATE(), 109), 
                  PARTY_CODE, 
                  @BOOKTYPE, 
                  @ENTEREDBY, 
                  CONVERT(VARCHAR(11), GETDATE(), 109), 
                  @CHECKEDBY, 
                  0, 
                  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(NARRATION)), 
                  @SETT_NO, 
                  @SETT_TYPE, 
                  BILL_NO, 
                  A.ACCAT, 
                  A.BRANCHCODE  
            FROM ACCBILL B WITH(NOLOCK), 
                  ACMAST A WITH(NOLOCK) 
            WHERE B.PARTY_CODE = A.CLTCODE 
                  AND B.SETT_NO = @SETT_NO 
                  AND B.SETT_TYPE = @SETT_TYPE 
                  AND B.AMOUNT <> 0
                  AND 
                        (
                              A.ACCAT = 4 
                              OR B.BRANCHCD = 'ZZZ'
                        ) 
       

            INSERT 
                  INTO POSTBILLLEDGER2 
            SELECT 
                  (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END), 
                  AMOUNT, 
                  BRANCHCD, 
                  PARTY_CODE
            FROM 
                  ACCBILL
            WHERE
                  SETT_NO = @SETT_NO 
                  AND SETT_TYPE = @SETT_TYPE 
                  AND BRANCHCD <> 'ZZZ'
                  AND AMOUNT <> 0

      END  
      ELSE  
      IF @VTYP = 21  
      BEGIN  
            INSERT 
            INTO POSTBILLLEDGER 
                  ( 
                        VTYP, 
                        VNO, 
                        EDT, 
                        ACNAME, 
                        DRCR, 
                        VAMT, 
                        VDT, 
                        VNO1, 
                        REFNO, 
                        BALAMT, 
                        NODAYS, 
                        CDT, 
                        CLTCODE, 
                        BOOKTYPE, 
                        ENTEREDBY, 
                        PDT, 
                        CHECKEDBY, 
                        ACTNODAYS, 
                        NARRATION, 
                        SETT_NO, 
                        SETT_TYPE, 
                        BILL_NO, 
                        ACCAT, 
                        BRANCHCODE
                  ) 
            SELECT 
                  @VTYP, 
                  @VNO, 
                  (
                        CASE 
                              WHEN SELL_BUY = 1 
                              THEN @EDTDR 
                              ELSE @EDTCR 
                        END
                  ), 
                  ACNAME, 
                        (
                        CASE 
                              WHEN SELL_BUY = 1 
                              THEN 'D' 
                              ELSE 'C' 
                        END
                        ), 
                  AMOUNT, 
                  @VDT, 
                  @VNO, 
                  '', 
                  0, 
                  0, 
                  CONVERT(VARCHAR(11), GETDATE(), 109), 
                  PARTY_CODE, 
                  @BOOKTYPE, 
                  @ENTEREDBY, 
                  CONVERT(VARCHAR(11), GETDATE(), 109), 
                  @CHECKEDBY, 
                  0, 
                  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(NARRATION)), 
                  @SETT_NO, 
                  @SETT_TYPE, 
                  BILL_NO, 
                  A.ACCAT, 
                  A.BRANCHCODE  
            FROM IACCBILL B WITH(NOLOCK), 
                  ACMAST A WITH(NOLOCK) 
            WHERE B.PARTY_CODE = A.CLTCODE 
                  AND B.SETT_NO = @SETT_NO 
                  AND B.SETT_TYPE = @SETT_TYPE 
                  AND B.AMOUNT <> 0
                  AND 
                        (
                              A.ACCAT = 4 
                       OR B.BRANCHCD = 'ZZZ'
                        ) 

            INSERT 
                  INTO POSTBILLLEDGER2 
            SELECT 
                  (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END), 
                  AMOUNT, 
                  BRANCHCD, 
                  PARTY_CODE
            FROM 
                  IACCBILL
            WHERE
                  SETT_NO = @SETT_NO 
                  AND SETT_TYPE = @SETT_TYPE 
                  AND AMOUNT <> 0
                  AND BRANCHCD <> 'ZZZ'

      END  
  

/*=================================================================================================
      POST DATA INTO LEDGER
=================================================================================================*/
      INSERT 
      INTO LEDGER 
            (
                  VTYP, 
                  VNO, 
                  EDT, 
                  LNO, 
                  ACNAME, 
                  DRCR, 
                  VAMT, 
                  VDT, 
                  VNO1, 
                  REFNO, 
                  BALAMT, 
                  NODAYS, 
                  CDT, 
                  CLTCODE, 
                  BOOKTYPE, 
                  ENTEREDBY, 
                  PDT, 
                  CHECKEDBY, 
                  ACTNODAYS, 
                  NARRATION
            ) 
      SELECT 
            VTYP, 
            VNO, 
            EDT, 
            LNO, 
            ACNAME, 
            DRCR, 
            VAMT, 
            VDT, 
            VNO1, 
            REFNO, 
            BALAMT, 
            NODAYS, 
            CDT, 
            CLTCODE, 
            BOOKTYPE, 
            ENTEREDBY, 
            PDT, 
            CHECKEDBY, 
            ACTNODAYS, 
            NARRATION 
      FROM POSTBILLLEDGER WITH(NOLOCK) 

   
/*=================================================================================================
      POST DATA INTO LEDGER1
=================================================================================================*/
      INSERT 
      INTO LEDGER1 
            (
                  BNKNAME, 
                  BRNNAME, 
                  DD, 
                  DDNO, 
                  DDDT, 
                  RELDT, 
                  RELAMT, 
                  REFNO, 
                  RECEIPTNO, 
                  VTYP, 
                  VNO, 
                  LNO, 
                  DRCR, 
                  BOOKTYPE, 
                  MICRNO, 
                  SLIPNO, 
                  SLIPDATE, 
                  CHEQUEINNAME, 
                  CHQPRINTED, 
                  CLEAR_MODE
            ) 
      SELECT 
            RTRIM(LTRIM(SETT_NO)) + @EXCHANGE + RTRIM(LTRIM(SETT_TYPE)) + CONVERT(VARCHAR(10), BILL_NO), 
            '', 
            'B', 
            '0', 
            '', 
            '', 
            VAMT, 
            '0', 
            '', 
            VTYP, 
            VNO, 
            LNO, 
            DRCR, 
            BOOKTYPE, 
            '0', 
            '', 
            '', 
            '', 
            1, 
            'C' 
      FROM POSTBILLLEDGER WITH(NOLOCK)

  
/*=================================================================================================
      POST DATA INTO LEDGER2
=================================================================================================*/
      INSERT 
      INTO LEDGER2 
            (
                  VTYPE, 
                  VNO, 
                  LNO, 
                  DRCR, 
                  CAMT, 
                  COSTCODE, 
                  BOOKTYPE, 
                  CLTCODE
            ) 
      SELECT 
            B.VTYP, 
            B.VNO, 
            B.LNO, 
            B2.DRCR, 
            B2.AMOUNT, 
            C.COSTCODE, 
            B.BOOKTYPE, 
            B.CLTCODE 
      FROM POSTBILLLEDGER B WITH(NOLOCK), 
            COSTMAST C WITH(NOLOCK),
            POSTBILLLEDGER2 B2 
      WHERE 
            B.CLTCODE = B2.CLTCODE
            AND B2.BRANCHCODE = C.COSTNAME 
  

/*=================================================================================================
      POST DATA INTO LEDGER3
=================================================================================================*/
      INSERT 
      INTO LEDGER3 
            (
                  NARATNO,
                  NARR,
         REFNO,
                  VTYP,
                  VNO,
                  BOOKTYPE
            ) 
      SELECT 
            LNO, 
            NARRATION, 
            '', 
            VTYP, 
            VNO, 
            BOOKTYPE 
      FROM POSTBILLLEDGER 
  

/*=================================================================================================
      POST DATA INTO BILLMATCH
=================================================================================================*/
      INSERT 
      INTO BILLMATCH 
            (
                  EXCHANGE, 
                  SEGMENT, 
                  SETT_TYPE, 
                  SETT_NO, 
                  BILLNO, 
                  DATE, 
                  PARTY_CODE, 
                  AMOUNT, 
                  DRCR, 
                  BALAMT, 
                  VTYPE, 
                  VNO, 
                  LNO, 
                  BRANCH, 
                  BOOKTYPE
            ) 
      SELECT 
            LEFT(@EXCHANGE, 3), 
            'CAPITAL', 
            SETT_TYPE, 
            SETT_NO, 
            BILL_NO, 
            VDT, 
            CLTCODE, 
            VAMT, 
            DRCR, 
            0, 
            VTYP, 
            VNO, 
            LNO, 
            BRANCHCODE, 
            BOOKTYPE 
      FROM POSTBILLLEDGER WITH(NOLOCK)  
      WHERE ACCAT = '4' 
  
/*=================================================================================================
      POST DATA INTO BFBILLMATCH
=================================================================================================*/
      IF @@OBJID <> 0  
      BEGIN  
            INSERT 
            INTO BFBILLMATCH 
                  (
                        EXCHANGE, 
                        SEGMENT, 
                        SETT_TYPE, 
                        SETT_NO, 
                        BILLNO, 
                        DATE, 
                        PARTY_CODE, 
                        AMOUNT, 
                        DRCR, 
                        BALAMT, 
                        VTYPE, 
                        VNO, 
                        LNO, 
                        BRANCH, 
                        BOOKTYPE, 
                        BANKPOSTDATE, 
                        BANKPOSTAMOUNT, 
                        BANKSTATUS, 
                        BANKREASON
                  ) 
            SELECT 
                  LEFT(@EXCHANGE, 3), 
                  'CAPITAL', 
                  SETT_TYPE, 
                  SETT_NO, 
                  BILL_NO, 
                  VDT, 
                  CLTCODE, 
                  VAMT, 
                  DRCR, 
                  0, 
                  VTYP, 
                  VNO, 
                  LNO, 
                  BRANCHCODE, 
                  BOOKTYPE, 
                  '', 
                  0, 
                  '', 
                  '' 
            FROM POSTBILLLEDGER WITH(NOLOCK) 
            WHERE ACCAT = '4' 
      END  
   
/*=================================================================================================
      POST DATA INTO POSTBILLLEDGER
=================================================================================================*/
      SELECT 
            @@EDTDR = MIN(EDT), 
            @@EDTCR = MAX(EDT) 
      FROM POSTBILLLEDGER 

      INSERT 
      INTO BILLPOSTED 
            (
                  VNO, 
                  VTYP, 
                  BOOKTYPE, 
                  VDT, 
                  BILLDATE, 
                  SETT_NO, 
                  SETT_TYPE, 
                  NARRATION, 
                  USERNAME, 
                  POSTDATE, 
                  EDTDR, 
                  EDTCR
            ) 
      SELECT 
            TOP 1 VNO, 
            VTYP, 
            BOOKTYPE, 
            CONVERT(VARCHAR(11), VDT, 109), 
         CONVERT(VARCHAR(11), VDT, 109), 
            SETT_NO, 
            SETT_TYPE, 
            NARRATION, 
            @UNAME, 
            CONVERT(VARCHAR(11), GETDATE(), 109), 
            @@EDTDR, 
            @@EDTCR 
      FROM POSTBILLLEDGER WITH(NOLOCK) 

COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL_REM
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[NEWPOSTBILL_REM]  
(    
      @VTYP SMALLINT,      
      @BOOKTYPE VARCHAR(2),      
      @VNO VARCHAR(12),      
      @VDT VARCHAR(11),      
      @EDTDR VARCHAR(11),      
      @EDTCR VARCHAR(11),      
      @CDT VARCHAR(11),      
      @PDT VARCHAR(11),      
      @ENTEREDBY VARCHAR(25),      
      @CHECKEDBY VARCHAR(25),      
      @SETT_NO VARCHAR(7),      
      @SETT_TYPE VARCHAR(3),      
      @UNAME VARCHAR(25),       
      @EXCHANGE VARCHAR(10),     
      @OVNO VARCHAR(12) = ''    
)    
    
AS      
      
/*=================================================================================================    
--EXEC NEWPOSTBILL 15, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'      
--EXEC NEWPOSTBILL 21, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'      
=================================================================================================*/    
    
SET NOCOUNT ON      
    
DECLARE      
 @@OBJID AS INT,      
 @@EDTDR AS VARCHAR(11),      
 @@EDTCR AS VARCHAR(11),      
 @@LEDCNT AS INT    
      
BEGIN TRANSACTION    
    
 SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)    
    
/*=================================================================================================    
      CHECK FOR DELETE IF RE-POSTING IS BEING DONE    
=================================================================================================*/    
      IF @OVNO <> ''    
      BEGIN    
           SELECT @@LEDCNT = COUNT(1) FROM BILLPOSTED WITH(NOLOCK) WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
           IF @@LEDCNT > 0     
           BEGIN     
                DELETE FROM LEDGER WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
                DELETE FROM LEDGER1 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
                DELETE FROM LEDGER2 WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE      
                DELETE FROM LEDGER3 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
                DELETE FROM BILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE      
                DELETE FROM BILLPOSTED WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
                IF @@OBJID <> 0      
                BEGIN      
                     DELETE FROM BFBILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE      
                END      
           END    
      END    
    
      TRUNCATE TABLE POSTBILLLEDGER      
      TRUNCATE TABLE POSTBILLLEDGER2    
    
    
/*=========================================================================================================    
      POPULATE DATA FROM ACCBILL (NORMAL CLIENTS) / IACCBILL (INST CLIENTS), ACMAST TO BE USED FOR POSTING    
=========================================================================================================*/    
  
            INSERT     
            INTO POSTBILLLEDGER     
                  (     
                        VTYP,     
                        VNO,     
                        EDT,     
                        ACNAME,     
                        DRCR,     
                        VAMT,     
                        VDT,     
                        VNO1,     
                        REFNO,     
                        BALAMT,     
                        NODAYS,     
                        CDT,     
                        CLTCODE,     
                        BOOKTYPE,     
                        ENTEREDBY,     
                        PDT,     
                        CHECKEDBY,     
                        ACTNODAYS,     
                        NARRATION,     
                        SETT_NO,     
                        SETT_TYPE,     
                        BILL_NO,     
                        ACCAT,     
                        BRANCHCODE    
                  )     
            SELECT     
                  @VTYP,     
                  @VNO,     
                  (    
   CASE     
                              WHEN SELL_BUY = 1     
                              THEN @EDTDR     
                              ELSE @EDTCR     
    END    
                        ),     
                  ACNAME,     
                        (    
                        CASE     
                              WHEN SELL_BUY = 1     
                              THEN 'D'     
                              ELSE 'C'     
                        END    
                        ),     
                  AMOUNT,     
                  @VDT,     
                  @VNO,     
                  '',     
                  0,     
                  0,     
                  GETDATE(),     
                  PARTY_CODE,     
                  @BOOKTYPE,     
                  @ENTEREDBY,     
                  GETDATE(),     
                  @CHECKEDBY,     
                  0,     
                  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(NARRATION)),     
                  @SETT_NO,     
                  @SETT_TYPE,     
                  BILL_NO,     
                  A.ACCAT,     
                  A.BRANCHCODE      
            FROM REM_ACCBILL B WITH(NOLOCK),     
                  ACMAST A WITH(NOLOCK)     
            WHERE B.PARTY_CODE = A.CLTCODE     
                  AND B.SETT_NO = @SETT_NO     
                  AND B.SETT_TYPE = @SETT_TYPE     
                  AND B.AMOUNT <> 0    
                  AND     
                        (    
                              A.ACCAT = 4     
                              OR B.BRANCHCD = 'ZZZ'    
                        )     
  AND EXCHANGE = 'NSE'  
  AND SEGMENT = 'CAPITAL'  
           
    
            INSERT     
                  INTO POSTBILLLEDGER2     
            SELECT     
                  (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END),     
                  AMOUNT,     
                  BRANCHCD,     
                  PARTY_CODE    
            FROM     
                  REM_ACCBILL    
            WHERE    
                  SETT_NO = @SETT_NO     
                  AND SETT_TYPE = @SETT_TYPE     
                  AND BRANCHCD <> 'ZZZ'    
                  AND AMOUNT <> 0    
    
  
      
      
    
/*=================================================================================================    
      POST DATA INTO LEDGER    
=================================================================================================*/    
      INSERT     
      INTO LEDGER     
            (    
                  VTYP,     
                  VNO,     
                  EDT,     
                  LNO,     
                  ACNAME,     
                  DRCR,     
                  VAMT,     
                  VDT,     
                  VNO1,     
                  REFNO,     
                  BALAMT,     
                  NODAYS,     
                  CDT,     
                  CLTCODE,     
                  BOOKTYPE,     
                  ENTEREDBY,     
                  PDT,     
                  CHECKEDBY,     
                  ACTNODAYS,     
                  NARRATION    
            )     
      SELECT     
            VTYP,     
            VNO,     
            EDT,     
            LNO,     
            ACNAME,     
            DRCR,     
            VAMT,     
            VDT,     
            VNO1,     
            REFNO,     
            BALAMT,     
            NODAYS,     
            CDT,     
            CLTCODE,     
            BOOKTYPE,     
            ENTEREDBY,     
            PDT,     
            CHECKEDBY,     
            ACTNODAYS,     
            NARRATION     
      FROM POSTBILLLEDGER WITH(NOLOCK)     
    
       
/*=================================================================================================    
      POST DATA INTO LEDGER1    
=================================================================================================*/    
      INSERT     
      INTO LEDGER1     
            (    
                  BNKNAME,     
                  BRNNAME,     
                  DD,     
                  DDNO,     
                  DDDT,     
                  RELDT,     
                  RELAMT,     
                  REFNO,     
                  RECEIPTNO,     
                  VTYP,     
                  VNO,     
                  LNO,     
                  DRCR,     
                  BOOKTYPE,     
                  MICRNO,     
                  SLIPNO,     
                  SLIPDATE,     
                  CHEQUEINNAME,     
                  CHQPRINTED,     
                  CLEAR_MODE    
            )     
      SELECT     
            RTRIM(LTRIM(SETT_NO)) + @EXCHANGE + RTRIM(LTRIM(SETT_TYPE)) + CONVERT(VARCHAR(10), BILL_NO),     
            '',     
            'B',     
            '0',     
            '',     
            '',     
            VAMT,     
            '0',     
            '',     
            VTYP,     
            VNO,     
            LNO,     
            DRCR,     
            BOOKTYPE,     
            '0',     
            '',     
            '',     
            '',     
            1,     
            'C'     
      FROM POSTBILLLEDGER WITH(NOLOCK)    
    
      
/*=================================================================================================    
      POST DATA INTO LEDGER2    
=================================================================================================*/    
      INSERT     
      INTO LEDGER2     
            (    
                  VTYPE,     
                  VNO,     
                  LNO,     
                  DRCR,     
                  CAMT,     
                  COSTCODE,     
                  BOOKTYPE,     
                  CLTCODE    
            )     
      SELECT     
            B.VTYP,     
            B.VNO,     
            B.LNO,     
            B2.DRCR,     
            B2.AMOUNT,     
            C.COSTCODE,     
            B.BOOKTYPE,     
            B.CLTCODE     
      FROM POSTBILLLEDGER B WITH(NOLOCK),     
            COSTMAST C WITH(NOLOCK),    
            POSTBILLLEDGER2 B2     
      WHERE     
            B.CLTCODE = B2.CLTCODE    
            AND B2.BRANCHCODE = C.COSTNAME     
      
    
/*=================================================================================================    
      POST DATA INTO LEDGER3    
=================================================================================================*/    
      INSERT     
      INTO LEDGER3     
            (    
                  NARATNO,    
                  NARR,    
         REFNO,    
                  VTYP,    
                  VNO,    
                  BOOKTYPE    
            )     
      SELECT     
            LNO,     
            NARRATION,     
            '',     
            VTYP,     
            VNO,     
            BOOKTYPE     
      FROM POSTBILLLEDGER     
      
    
/*=================================================================================================    
      POST DATA INTO BILLMATCH    
=================================================================================================*/    
      INSERT     
      INTO BILLMATCH     
            (    
                  EXCHANGE,     
                  SEGMENT,     
                  SETT_TYPE,     
                  SETT_NO,     
                  BILLNO,     
                  DATE,     
                  PARTY_CODE,     
                  AMOUNT,     
                  DRCR,     
                  BALAMT,     
                  VTYPE,     
                  VNO,     
                  LNO,     
                  BRANCH,     
                  BOOKTYPE    
            )     
      SELECT     
            LEFT(@EXCHANGE, 3),     
            'CAPITAL',     
            SETT_TYPE,     
            SETT_NO,     
            BILL_NO,     
            VDT,     
            CLTCODE,     
            VAMT,     
  DRCR,    
            0,     
            VTYP,     
            VNO,     
            LNO,     
            BRANCHCODE,     
            BOOKTYPE     
      FROM POSTBILLLEDGER WITH(NOLOCK)      
      WHERE ACCAT = '4'     
      
/*=================================================================================================    
      POST DATA INTO BFBILLMATCH    
=================================================================================================*/    
      IF @@OBJID <> 0      
      BEGIN      
            INSERT     
            INTO BFBILLMATCH     
                  (    
                        EXCHANGE,     
                        SEGMENT,     
                        SETT_TYPE,     
                        SETT_NO,     
                        BILLNO,     
                        DATE,     
                        PARTY_CODE,     
                        AMOUNT,     
                        DRCR,     
                        BALAMT,     
                        VTYPE,     
                        VNO,     
                        LNO,     
                        BRANCH,     
                        BOOKTYPE,     
                        BANKPOSTDATE,     
                        BANKPOSTAMOUNT,     
                        BANKSTATUS,     
                        BANKREASON    
                  )     
            SELECT     
                  LEFT(@EXCHANGE, 3),     
                  'CAPITAL',     
                  SETT_TYPE,     
                  SETT_NO,     
                  BILL_NO,     
                  VDT,     
                  CLTCODE,     
                  VAMT,     
   DRCR,     
                  0,     
                  VTYP,     
                  VNO,     
                  LNO,     
                  BRANCHCODE,     
                  BOOKTYPE,     
                  '',     
                  0,     
                  '',     
                  ''     
            FROM POSTBILLLEDGER WITH(NOLOCK)     
            WHERE ACCAT = '4'     
      END      
       
/*=================================================================================================    
      POST DATA INTO POSTBILLLEDGER    
=================================================================================================*/    
      SELECT     
            @@EDTDR = MIN(EDT),     
            @@EDTCR = MAX(EDT)     
      FROM POSTBILLLEDGER     
    
      INSERT     
      INTO BILLPOSTED     
            (    
                  VNO,     
                  VTYP,     
                  BOOKTYPE,     
                  VDT,     
                  BILLDATE,     
                  SETT_NO,     
                  SETT_TYPE,     
                  NARRATION,     
                  USERNAME,     
                  POSTDATE,     
                  EDTDR,     
                  EDTCR    
            )     
      SELECT     
            TOP 1 VNO,     
            VTYP,     
            BOOKTYPE,     
            CONVERT(VARCHAR(11), VDT, 109),     
         CONVERT(VARCHAR(11), VDT, 109),     
            SETT_NO,     
            SETT_TYPE,     
            NARRATION,     
            @UNAME,     
            GETDATE(),     
            @@EDTDR,     
            @@EDTCR     
      FROM POSTBILLLEDGER WITH(NOLOCK)     
    
COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFFLINE_DRCRNOTEUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[OFFLINE_DRCRNOTEUPLOAD_BULK]    
 @FNAME VARCHAR(100),    
 @UNAME VARCHAR(25),    
 @VTYP SMALLINT,    
 @BOOKTYPE VARCHAR(2),  
 @STRUPLOADBY VARCHAR(25),   
 @STATUSID VARCHAR(25),   
 @STATUSNAME  VARCHAR(25)  
AS    
/*    
 DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\Backoffice\DrCrNotes\CR TAMMANA2.csv'    
 EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'    
 EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'    
*/    
 SET NOCOUNT ON    
    
 DECLARE    
  @@ERROR_COUNT AS INT,    
  @@SQL AS VARCHAR(2000)    
/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/    
 IF LTRIM(RTRIM(@FNAME)) = ''    
  BEGIN    
   SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'    
   RETURN    
  END    
    
 CREATE TABLE #FEXIST    
  (F1 INT, F2 INT, F3 INT)    
     
 SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "    
 EXEC (@@SQL)    
    
 SELECT @@ERROR_COUNT = F1 FROM #FEXIST    
 IF @@ERROR_COUNT = 0    
  BEGIN    
   SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'    
   DROP TABLE #FEXIST    
   RETURN    
  END    
    
 BEGIN TRAN    
    
 SELECT     
  @@ERROR_COUNT = COUNT(1)     
 FROM    
  (SELECT     
   U_FILENAME     
  FROM     
   V2_UPLOADED_FILES    
  WHERE     
   U_FILENAME = @FNAME     
   AND U_MODULE = 'DRCR NOTE UPLOAD') A    
    
 IF @@ERROR_COUNT > 0    
  BEGIN    
   SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME    
   ROLLBACK TRAN    
   RETURN    
  END    
    
    
 CREATE TABLE #RECPAY_TABLE_TMP    
 (    
  SRNO INT,    
  VVDT VARCHAR(10),    
  EEDT VARCHAR(10),    
  CLTCODE VARCHAR(10),    
  DRCR VARCHAR(1),    
  AMOUNT MONEY,    
  NARRATION VARCHAR(500)    
 )    
    
 CREATE TABLE [#RECPAY_TABLE]    
 (    
  SRNO INT,    
  VVDT VARCHAR(10),    
  EEDT VARCHAR(10),    
  CLTCODE VARCHAR(10),    
  DRCR VARCHAR(1),    
  AMOUNT MONEY,    
  NARRATION VARCHAR(255),    
  SNO INT IDENTITY (1, 1) NOT NULL ,    
  VDT DATETIME NULL ,    
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),    
  EDT DATETIME NULL ,    
  VNO VARCHAR (12)  NULL ,    
  ACNAME VARCHAR (100)  NULL ,    
  FYSTART DATETIME NULL,    
  FYEND DATETIME NULL,    
  COSTCODE SMALLINT NULL,    
  LNO SMALLINT NOT NULL DEFAULT(0),  
  BRANCHCODE VARCHAR(10)    
 ) ON [PRIMARY]    
    
 CREATE TABLE [#RECPAY_TABLE_LNO]    
 (    
  SNO INT ,    
  LNO INT IDENTITY (1, 1) NOT NULL    
 ) ON [PRIMARY]    
    
 SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "    
 EXEC(@@SQL)    
    
SELECT * FROM #RECPAY_TABLE_TMP  
  
INSERT INTO V2_UPLOADED_FILES    
SELECT    
  @FNAME,    
  @FNAME,    
  COUNT(1),    
  'B',    
  GETDATE(),    
  @UNAME,    
  'DRCR NOTE UPLOAD'    
    
 INSERT INTO #RECPAY_TABLE    
  (SRNO,    
  VVDT,    
  EEDT,    
  CLTCODE,    
  DRCR,    
  AMOUNT,    
  NARRATION)    
 SELECT    
  SRNO,    
  VVDT,    
  EEDT,    
  UPPER(CLTCODE),    
  DRCR,    
  AMOUNT,    
  LEFT(NARRATION, 234)    
 FROM #RECPAY_TABLE_TMP    
    
 UPDATE    
  #RECPAY_TABLE    
  SET    
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),    
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),    
   FYSTART = P.SDTCUR,    
   FYEND = P.LDTCUR,    
   UPDFLAG = 'Y',    
   ACNAME = LONGNAME,    
   BRANCHCODE = A.BRANCHCODE  
      FROM ACMAST A, PARAMETER P  
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE    
      AND P.CURYEAR = 1    
      AND A.ACCAT IN ('3','4','104')    
    
/*  
 UPDATE    
  #RECPAY_TABLE    
  SET    
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),    
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),    
   FYSTART = P.SDTCUR,    
   FYEND = P.LDTCUR,    
   UPDFLAG = 'Y',    
   ACNAME = LONGNAME,    
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')    
      FROM ACMAST A, PARAMETER P    
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE    
      AND P.CURYEAR = 1    
      AND A.ACCAT IN ('3','4','104')    
      AND A.BRANCHCODE = 'ALL'    
*/    
    
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/    
    
 DECLARE    
  @@STD_DATE VARCHAR(11),    
  @@LST_DATE VARCHAR(11),    
  @@VNOMETHOD INT,    
  @@ACNAME CHAR(100),    
  @@MICRNO VARCHAR(10),    
  @@DRCR VARCHAR(1),  
  @@BRANCHCODE VARCHAR(10),  
  @@MySessionID VARCHAR(12)  
    
Select @@MySessionID = convert(varchar,getdate(),12)+right(replace(convert(varchar,getdate(),114),':',''),6)   
    
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/    
    
 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND    
    
 IF @@ERROR_COUNT > 0    
  BEGIN    
   SELECT 'DATE MISMATCH'    
   DROP TABLE #RECPAY_TABLE_TMP    
   DROP TABLE #RECPAY_TABLE    
   ROLLBACK TRAN    
   DELETE FROM V2_UPLOADED_FILES    
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'    
   RETURN    
  END    
    
/* '--------------------------UPDATE OF COST CODE ------------------------*/    
    
 UPDATE #RECPAY_TABLE    
  SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')    
 WHERE COSTCODE IS NULL    
    
/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/    
    
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)    
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1    
 IF @@ERROR_COUNT > 0    
  BEGIN    
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'    
   DROP TABLE #RECPAY_TABLE_TMP    
   DROP TABLE #RECPAY_TABLE    
   ROLLBACK TRAN    
   DELETE FROM V2_UPLOADED_FILES    
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'    
   RETURN    
  END    
    
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/    
    
 SELECT @@ERROR_COUNT = COUNT(1) FROM    
  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM #RECPAY_TABLE    
  GROUP BY SRNO    
  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A    
 IF @@ERROR_COUNT > 0    
  BEGIN    
   SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'    
   DROP TABLE #RECPAY_TABLE_TMP    
   DROP TABLE #RECPAY_TABLE    
   ROLLBACK TRAN    
   DELETE FROM V2_UPLOADED_FILES    
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'    
   RETURN    
  END    
    
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/    
    
 SELECT @@ERROR_COUNT = COUNT(1) FROM    
 (    
  SELECT DISTINCT    
   CLTCODE    
  FROM #RECPAY_TABLE    
  WHERE UPDFLAG = 'N'    
 ) A    
    
 IF @@ERROR_COUNT > 0    
  BEGIN    
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL    
   SELECT DISTINCT    
    CLTCODE    
   FROM #RECPAY_TABLE    
   WHERE UPDFLAG = 'N'    
   DROP TABLE #RECPAY_TABLE_TMP    
   DROP TABLE #RECPAY_TABLE    
   ROLLBACK TRAN    
   DELETE FROM V2_UPLOADED_FILES    
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'    
   RETURN    
  END    
    
 DECLARE    
  @@NEWVNO AS VARCHAR(12),    
  @@VDT AS VARCHAR(11),    
  @@LNOCUR AS CURSOR,    
  @@LNOVNO AS INT,    
  @@NOREC AS INT    
    
    
  
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/    
/*    
 SET @@LNOCUR = CURSOR FOR    
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE    
 OPEN @@LNOCUR    
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO    
 WHILE @@FETCH_STATUS = 0    
  BEGIN    
   INSERT INTO #RECPAY_TABLE_LNO    
    (SNO)    
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO    
   UPDATE RP    
    SET LNO = RL.LNO    
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL    
   WHERE RP.SNO = RL.SNO    
   TRUNCATE TABLE #RECPAY_TABLE_LNO    
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO    
  END    
 CLOSE @@LNOCUR    
 DEALLOCATE @@LNOCUR    
 DROP TABLE #RECPAY_TABLE_LNO    
  */
    
Insert into V2_Offline_Ledger_Entries   
(   
VoucherType, BookType, SNo, VDate, EDate,   
CltCode, CreditAmt, DebitAmt, Narration,   
OppCode, BranchCode, Exchange, Segment, TPFlag,   
AddDt, AddBy, StatusID, StatusName, RowState,   
ApprovalFlag, VoucherNo, ClientName,   
OppCodeName   
)   
Select @VTYP, @BOOKTYPE, LNO, convert(datetime,VVDt,105), convert(datetime,EEDT,105), CLTCODE,   
CreditAmt = (Case when drcr = 'C' then Amount else 0 end),   
DebitAmt = (Case when drcr = 'D' then Amount else 0 end),   
Narration,'', BranchCode, 'NSE','CAPITAL',   
TPFlag = 0, getdate(), @STRUPLOADBY, @STATUSID, @STATUSNAME,  
RowState = 0, ApprovalFlag = 0, @@MySessionID, AcName, ''   
from #RecPay_Table   
  

  
COMMIT  
    
 SELECT RESULT = 'Data Uploaded Successfully'    
 UNION ALL    
 SELECT RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO FROM #RECPAY_TABLE    
 DROP TABLE #RECPAY_TABLE_TMP    
 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OfflineLedger_Acc_GenVno
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.V2_Acc_GenVNo    Script Date: 09/30/2005 12:23:51 ******/              
              
/*            
-------------------------------------            
New Procedure to Generate VNO            
-------------------------------------            
            
Author            : Uppili Krishnan            
Date               : Sep 30 2005            
Reviewed By   :            
Review Date   :            
Tested By       :               
Tested Date    :            
            
-------------------------------------            
            
                    
      Flags:            
            VnoFlag = 0 Yearly            
            VnoFlag = 1 Daily            
            VnoFlag = 2 Monthly            
            
Logic:            
 Generates 1 record per day for the combination of VnoFlag, VoucherDate, Financial Year Combination            
 if for the above combination record is not present in V2_LastVno table then a new record is inserted            
 else existing record is updated            
            
            
                                     
*/              
              
CREATE PROC [dbo].[OfflineLedger_Acc_GenVno]    
@vdt      varchar(11),  /* dd/mm/yyyy */                    
@vtyp     smallint,                    
@booktype varchar(2),                    
@sdtcur   varchar(11),                    
@ldtcur   varchar(11),          
@noofrecords int = 1          
/* @vnoflag  int */                    
as                    
                    
                    
                    
Declare @@voudt  as datetime                    
Declare @@maxvno as numeric(12,0)                    
Declare @@vnoflag as tinyint                    
Declare @@vno as varchar(12)                    
Declare @@rcnt as int                    
Declare @@FldAuto bigint                    
Declare @@YearlyVdt varchar(11)                  
Declare @@DailyVDt Varchar(11)                    
Declare @@MonthlyVdt varchar(11)                    
Declare @@UpdtVdt varchar(11)                    
Declare @@FinYear smallint                  
          
Declare @@ReturnVno as varchar(12)          
                    
--SET NOCOUNT ON                    
set Xact_abort on                    
                    
begin transaction                    
            
Select             
      @sdtcur = LEFT(SDTCUR,11),             
      @ldtcur = LEFT(LDTCUR,11),             
      @@vnoflag = isnull(vnoflag,0),                   
      @@FinYear = isnull(FldAuto,0)                    
from             
      Parameter             
where              
      convert(datetime,@vdt) BETWEEN sdtcur and ldtcur             

if isnull(@sdtcur,'') = ''
begin                    
 rollback transaction                    
 select vno = ''                    
 return                    
end                     

            
/*            
Select                   
from                   
      Parameter                   
where                    
      sdtcur like @sdtcur + '%'                   
      and ldtcur like @ldtcur + '%'                  
*/                  
                  
/*                   
Reinitialising the Dates to be posted in the table.                    
      For Daily, the Voucher Date is taken                  
      For Monthly, the 1st Day of the Month  is Taken                  
      For Yearly, the first Day of the year is taken                  
*/                  
                  
select                   
      @@voudt = (select convert(datetime,@vdt)),                   
      @@MonthlyVdt = left(@Vdt,4)+' 1 '+right(@Vdt,4),                   
      @@DailyVdt = @Vdt,                   
      @@YearlyVdt = LEFT(@SDTCUR,4) + ' 1 '+ right(@SDTCUR,4)                  
              
-- Doing Yearly Voucher Gen                    
if @@vnoflag = 0                    
   begin                    
      select                   
            @@FldAuto = isnull(FldAuto,0) ,                   
            @@maxvno = convert(NUMERIC,isnull(lastvno,0))                   
      from                   
            V2_LastVno WITH (INDEX(VNOIDX),TABLOCKX,HOLDLOCK)                   
      where                   
            vtyp = @vtyp                   
            and booktype = @booktype                   
            and vdt = @@YearlyVdt + ' 00:00:00'                   
            and VnoFlag = @@VnoFlag                   
            and FinYear = @@FinYear                  
                  
                  
      if @@ROWCOUNT=0                  
         begin                    
            -- If No Record Present, then Insert                  
           select                   
                  @@FldAuto=0,                   
          @@UpdtVdt = @@YearlyVdt,                   
                  @@ReturnVno = Right(@@YearlyVdt,4) + '00000001',                    
  @@Vno = Right(@@YearlyVdt,4) + Replicate('0', 8-len(@noofrecords)) + cast(@noofrecords as varchar)                      
 end                    
         else                    
         begin                    
           select                   
            -- If record is Present, then Update                  
                  @@UpdtVdt = @@YearlyVdt,                   
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1))  ,                  
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                    
         end                    
   end                    
                  
-- Doing Daily Voucher Gen                    
else if @@vnoflag = 1                    
        begin                    
                  
          select                   
                  @@FldAuto = isnull(FldAuto,0) ,                    
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))                   
            from               
                  V2_LastVno WITH (Index(VnoIdx), TABLOCKX,HOLDLOCK)                   
            where                   
                  vtyp = @vtyp                   
                  and booktype = @booktype                   
                  and vdt = @@DailyVDt + ' 00:00:00'                    
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear                  
                  
                  
          if  @@ROWCOUNT=0                  
             begin                    
            -- If No Record Present, then Insert                  
                select                   
                  @@FldAuto=0,                   
                  @@UpdtVdt = @@DailyVdt,                   
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+'0001'          ,          
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+ Replicate('0', 4-len(@noofrecords)) + cast(@noofrecords as varchar)          
          
             end                    
          else                    
             begin                    
            -- If record is Present, then Update                  
               select                   
                  @@UpdtVdt = @@DailyVdt,                   
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),                    
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                    
          
             end                    
        end                    
                  
-- Doing Monthly Voucher Gen                    
else if @@vnoflag = 2                    
        begin                    
          select                   
                  @@FldAuto = isnull(FldAuto,0) ,                   
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))                   
            from                   
                  V2_LastVno WITH (index(VNoIdx), TABLOCKX,HOLDLOCK)                   
            where                   
                  vtyp = @vtyp                   
                  and booktype = @booktype                   
                  and vdt = @@MonthlyVDt + ' 00:00:00'                    
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear         
                  
                  
          if  @@ROWCOUNT=0                  
             begin                    
            -- If No Record Present, then Insert                  
                select                   
                  @@FldAuto=0,                   
                  @@UpdtVdt = @@MonthlyVdt,                   
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+'000001',                    
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+ Replicate('0', 6-len(@noofrecords)) + cast(@noofrecords as varchar)          
          
             end                    
         else                    
       begin                    
            -- If record is Present, then Update                  
               select                   
                  @@UpdtVdt = @@MonthlyVdt,                   
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),                    
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                    
          
             end                    
        end            
                  
                    
if @@error <> 0                     
begin                    
 rollback transaction                    
 select vno = ''                    
 return                    
end                     
else                    
begin                    
       if isnull(@@vno,'') <> ''                     
       begin                    
                  if isnull(@@FldAuto,0) = 0                    
                  begin                    
                    -- If No Record Present, then Insert                  
                        insert into V2_LastVno                   
                        (Vtyp, BookType, Vdt, LastVno, VnoFlag, FinYear)                  
                        values                   
                        (@vtyp,@booktype,@@UpdtVdt,@@vno, @@VnoFlag, @@FinYear)                    
                  end                    
                  else                    
                  begin                    
                        -- If record is Present, then Update                  
                        Update                   
                              V2_LastVno                   
                        set                   
                              Lastvno = @@Vno                   
                        where                   
                              FldAuto = @@FldAuto                    
                  end                   
           
                        commit transaction                    
          
                        select vno = @@Returnvno                    
                        return                    
       end                     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OfflineLedger_Newacmultiinsert
-- --------------------------------------------------
CREATE Procedure [dbo].[OfflineLedger_Newacmultiinsert]          
@Vtyp Smallint,               
@Booktype Char(2),               
@Vno Varchar(12),               
@Lno Int,               
@Vdt Varchar(11),               
@Edt Varchar(11),               
@Cltcode Varchar(10),               
@Drcr Char(1),                
@Vamt Money,               
@Enteredby Varchar(25),               
@Cdt varchar(30),              
@Checkedby Varchar(25),               
@Pdt varchar(30),             
@Acname Varchar(50),               
@Narration Varchar(234),               
@Chequeinname Varchar(50),               
@Chqprinted Tinyint,               
@Accat Int,               
@Bnkname Varchar(50),               
@Brnname Varchar(30),               
@Dd Char(1),               
@Ddno Varchar(15),               
@Dddt varchar(11),                
@Reldt varchar(11),            
@Relamt Money,               
@Micrno Int,               
@Sessionid Int,               
@Branchname Char(10),               
@Costflag Varchar(1),               
@Costrowid Int,               
@Clearingmode Char(1),               
@Emode Char(1),
@RefLedgerNo varchar(12)
/*slipno, , Chequeinname, Chqprinted*/              
As              
Declare              
@@Vno1 As Varchar(12),               
@@Refno Char(12),               
@@Nodays Int,               
@@Actnodays Int,               
@@Balamt Money,               
@@Slipno Smallint,               
@@Slipdate Datetime,               
@@Clearingmode Char(2),               
@@Receiptno Int,               
@@Branch As Char(15),               
@@Exchange As Varchar(3),               
@@Segment As Varchar(10),               
@@Sett_no As Varchar(7),               
@@Sett_type As Varchar(3),               
@@Party_code As Varchar(10),               
@@Vdt1 As Datetime,               
@@Edt1 As Datetime,               
@@Dddt1 As Datetime,               
@@Reldt1 As Datetime,               
@@Recordcount As Int              
Select @@Vdt1 = Convert(Datetime, @Vdt)              
Select @@Edt1 = Convert(Datetime, @Edt)              
--Select @@Dddt1 = Convert(Datetime, Substring(Convert(Varchar, @Dddt, 109), 1, 11)+' '+convert(Varchar, Getdate(), 114))       
Select @@Dddt1 = Convert(Datetime,@Dddt)                     
/* Select @@Reldt1 = Convert(Datetime, Substring(Convert(Varchar, @Reldt, 109), 1, 11)+' 00:00:00' */              
Select @@Reldt1 = convert(datetime,@Reldt,109)              
Select @@Vno1 = @Vno              
Select @@Refno = ''              
Select @@Nodays = 0              
Select @@Actnodays  = 0              
Select @@Balamt = 0              
Select @@Slipno = 0              
Select @@Slipdate = ''              
/*select @@Clearingmode = ' ' */              
Select @@Receiptno = 0              
Select @@Branch =  'Branch'              
/* Inserting Record In Ledger */              
Insert Into Ledger(Vtyp, Vno, Drcr, Vamt, Vdt, Refno, Cltcode, Enteredby, Lno, Balamt,               
Vno1, Booktype, Edt, Cdt, Pdt, Nodays, Actnodays, Checkedby, Acname, Narration)               
Values (@Vtyp, @Vno, @Drcr, @Vamt, @@Vdt1, /*@@Refno*/ @RefLedgerNo, Upper(@Cltcode), @Enteredby, @Lno, @@Balamt,               
@@Vno1, @Booktype, @@Edt1, @Cdt, @Pdt, @@Nodays, @@Actnodays, @Checkedby, @Acname, @Narration)              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Record In Ledger3 */              
Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values              
(@Lno, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)              
/* Inserting Common Narration In Ledger3 */              
If @Lno = 2               
Begin              
       Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values              
       (0, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)              
End               
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Record In Ledger1 In Case Of Bank Related Vouchers*/              
If @Vtyp = 2 Or @Vtyp = 3 Or @Vtyp = 5 Or @Vtyp = 16 Or @Vtyp = 17  Or @Vtyp = 19 Or @Vtyp = 20               
Begin              
   If (@Vtyp = 2 Or @Vtyp = 19 Or @Vtyp = 16)              
      Begin              
 If   ( @Drcr = 'C' Or @Drcr = 'C' ) And @Lno = 2              
      Begin                 
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
     Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
     End               
      End               
    Else If (@Vtyp = 3 Or @Vtyp = 20 Or @Vtyp = 17)              
        Begin              
   If  ( @Drcr = 'D' Or @Drcr = 'D' ) And @Lno = 2              
               
   Begin              
        Insert Into Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
            Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
      Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)              
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)              
                  End               
     End              
    Else If @Vtyp = 5              
        Begin              
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
         Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @@Reldt1, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
   If @Accat = 2 And @Drcr = 'C'              
   Begin              
           Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)              
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)              
   End              
        End              
End              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Records In Matchdetails And Updating Billmatch */              
If @Lno = 2               
Begin              
      Delete  From Tempbilldetails Where Payamount = 0 And Rtrim(Sessionid) = Rtrim(@Sessionid)              
       Update Billmatch Set Billmatch.Balamt = Billmatch.Balamt - Payamount From Tempbilldetails T              
        Where  Rtrim(T.Sessionid) = Rtrim(@Sessionid)               
        And T.Party_code = Billmatch.Party_code And T.Billvtype = Billmatch.Vtype And T.Billbooktype = Billmatch.Booktype               
        And T.Billvno = Billmatch.Vno And T.Billlno = Billmatch.Lno              
        Insert Into Matchdetails              
        Select Description, Upper(Party_code), Billvtype, Billvno, Billlno, Billbooktype, Drcr, Payamount, Vtype, @Vno, @Lno, Booktype              
        From Tempbilldetails Where  Rtrim(Sessionid) = Rtrim(@Sessionid)               
End              
/* Insertting Records In Margin Ledger */              
If @Accat = 14 And (@Vtyp = 19 Or @Vtyp = 20 Or @Vtyp = 22 Or @Vtyp = 23 Or @Vtyp = 24)              
Begin              
   Insert Into Marginledger(Vtyp, Vno, Lno, Drcr, Vdt, Amount, Party_code, Exchange, Segment, Sett_no, Sett_type, Booktype, Mcltcode)              
   Values (@Vtyp, @Vno, @Lno, @Drcr, @@Vdt1, @Vamt, Upper(@@Party_code), @@Exchange, @@Segment, 0, @@Sett_type, @Booktype, Upper(@Cltcode))              
End              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
If (@Vtyp = '8' or @Vtyp = '19' or @Vtyp = '20' or @Vtyp = '24') And Upper(@Emode) = 'M'                
Begin              
Declare @Recordcounter Smallint           Declare @Partycode Varchar(50)                 
 Declare Cur_ledger_insert Cursor For                 
        Select Count(Party_code), Party_code From Templedger2 Where                 
        Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And               
 Booktype = @Booktype And Sessionid = @Sessionid And Party_code = @Cltcode and costflag = 'A'  Group By Party_code              
                
        Open Cur_ledger_insert                
                
        Fetch Next From Cur_ledger_insert               
        Into @Recordcounter, @Partycode              
While @@Fetch_status = 0                
Begin               
--if  @Partycode <> @Cltcode              
If @Recordcounter = 1              
 Begin              
        Delete From Templedger2 Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid               
 --       Insert Into Templedger2 Values (@@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )                
End              
/* Else              
 Begin              
  Update Templedger2 Set Paidamt = @Vamt Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid               
 End*/              
Fetch Next From Cur_ledger_insert                 
                 
End                
                
Close Cur_ledger_insert                
Deallocate Cur_ledger_insert                
End               
/* Inserting Record In Templedger2 For Branch Wise Breakup When Brnachflag = 1 And Match_ctoc = 1 In Parameter For Selected Year*/              
If Upper(@Emode) = 'A' Or Upper(@Emode) = 'M'              
/*select @@Recordcount = Count(Party_code) From Templedger2 Where               
Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid And Party_code = Upper(@Cltcode) And Paidamt = @Vamt              
If @@Recordcount = 0              
Begin*/              
Begin              
 Insert Into Templedger2 Values ( @@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )              
End              
--end              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PaymentCalAmt
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[PaymentCalAmt]   
@advicedate   datetime ,  
@tvdt datetime ,
@effdate datetime,
@LimitAmt    money
As
select  l.cltcode, acname=a.longname, EffCrAmt  =  abs(sum(CVamt) - Sum(DVamt)),
        	creditAmt= isNULL( (SELECT ISNULL(SUM(VAMT),0)    
                                                       FROM LEDGER L1
                           		WHERE  L.CLTCODE=L1.CLTCODE  AND DRCR='C'   
                            		AND  EDT Like @EFFDATE + '%'
                            		and  VDT <= LEFT(CONVERT(VARCHAR,@ADVICEDATE,109),11) + ' ' + '23:59:59'),0), 
             	shortage = 0  into temppayadv
	from PartyBalAmt l ,acmast a
	where l.cltcode=a.cltcode and a.accat= '4' 
	group by l.cltcode, a.longname
	having abs(sum(DVamt) - Sum(CVamt)) >= @LimitAmt and (sum(DVamt) - Sum(CVamt)) < 0 
	order by l.cltcode 

	insert into payadv   select cltcode ,acname, @tvdt   ,effcramt - creditamt ,'',acname,'',0,effcramt,shortage,
	'3','','01'
	from temppayadv where abs(effcramt - creditamt) > 0
	GROUP BY cltcode ,acname, effcramt,shortage ,effcramt , creditamt
	HAVING  effcramt - creditamt   > =  @limitamt
 	drop  table temppayadv

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PopulateLastVno
-- --------------------------------------------------
CREATE PROC [dbo].[PopulateLastVno]

AS

DECLARE
	@@PARA AS SMALLINT,
	@@STD_DATE AS VARCHAR(11),
	@@LST_DATE AS VARCHAR(11)

BEGIN TRAN

SELECT @@PARA = VNOFLAG, @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109), @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109) FROM PARAMETER WHERE CURYEAR = 1
IF @@PARA = 0		--FOR YEARLY SERIES
	BEGIN
		INSERT INTO LASTVNO
			SELECT VTYP, BOOKTYPE, @@STD_DATE, MAX(VNO)
			FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
			GROUP BY VTYP, BOOKTYPE
		INSERT INTO LASTVNO
			SELECT VTYP, BOOKTYPE, @@STD_DATE, MAX(VNO)
			FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
			GROUP BY VTYP, BOOKTYPE
	END
ELSE
	IF @@PARA = 2
		BEGIN
			INSERT INTO LASTVNO
				SELECT VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT))), MAX(VNO)
				FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
				GROUP BY VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT)))--MONTH(VDT), YEAR(VDT)
			INSERT INTO LASTVNO
				SELECT VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT))), MAX(VNO)
				FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
				GROUP BY VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT)))--MONTH(VDT), YEAR(VDT)
		END
	ELSE
		IF @@PARA = 1
			BEGIN
				INSERT INTO LASTVNO
					SELECT VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), MAX(VNO)
					FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
					AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
					GROUP BY VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)
				INSERT INTO LASTVNO
					SELECT VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), MAX(VNO)
					FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
					AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
					GROUP BY VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)
			END
COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POSTLEDGER2_MISSING
-- --------------------------------------------------
--BEGIN TRAN
--EXEC CD_POSTLEDGER2 'JUL 20 2005', 'JUL 20 2005'
--ROLLBACK
CREATE PROC [dbo].[POSTLEDGER2_MISSING]

AS
	DECLARE
		@@VNO AS VARCHAR(12),
		@@VTYP AS SMALLINT,
		@@BOOKTYPE AS VARCHAR(2),
		@@LEDGER2CNT AS NUMERIC(5),
		@@LEDGER2AMT AS MONEY,
		@@CUR AS CURSOR

	SET @@CUR = CURSOR FOR

	SELECT DISTINCT 
		VNO, 
		VTYP, 
		BOOKTYPE 
	FROM 
		LEDGER L 
	WHERE 
		NOT EXISTS (SELECT DISTINCT VNO, VTYPE, BOOKTYPE FROM LEDGER2 L2 WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE)
		AND VTYP NOT IN (15, 21, 18)

	OPEN @@CUR
	FETCH NEXT FROM @@CUR INTO @@VNO, @@VTYP, @@BOOKTYPE
	WHILE @@FETCH_STATUS = 0
		BEGIN
--			BEGIN TRAN
			DELETE FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999'
			IF @@VTYP = 8 OR @@VTYP = 6 OR @@VTYP = 7
				BEGIN
					INSERT INTO TEMPLEDGER2        
					SELECT 
						'BRANCH', 
						CASE WHEN A.BRANCHCODE <> 'ALL' THEN A.BRANCHCODE ELSE 'HO' END,        
						L.VAMT, 
						L.VTYP, 
						L.VNO, 
						L.LNO, 
						L.DRCR, 
						'0', 
						L.BOOKTYPE, 
						'9999999999',        
						L.CLTCODE, 
						'A', 
						0        
					FROM    
						LEDGER L, ACMAST A    
					WHERE    
						L.CLTCODE = A.CLTCODE    
						AND L.VNO = @@VNO 
						AND L.VTYP = @@VTYP 
						AND L.BOOKTYPE = @@BOOKTYPE    
				END
			ELSE
				BEGIN
					INSERT INTO TEMPLEDGER2    
					SELECT 
						'BRANCH', 
						CASE WHEN A.BRANCHCODE <> 'ALL' THEN A.BRANCHCODE ELSE '' END,    
						L.VAMT, 
						L.VTYP, 
						L.VNO, 
						L.LNO, 
						L.DRCR, 
						'0', 
						L.BOOKTYPE, 
						'9999999999',    
						L.CLTCODE, 
						'A', 
						0    
					FROM    
						LEDGER L, 
						ACMAST A    
					WHERE    
						L.CLTCODE = A.CLTCODE    
						AND L.VNO = @@VNO 
						AND L.VTYP = @@VTYP 
						AND L.BOOKTYPE = @@BOOKTYPE    

					UPDATE 
						TEMPLEDGER2 
					SET 
						BRANCH = (SELECT TOP 1 BRANCH FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999' AND BRANCH <> '')    
					WHERE 
						BRANCH = ''    
					UPDATE 
						TEMPLEDGER2 
					SET 
						BRANCH = 'HO' 
					WHERE 
						BRANCH = ''    
				END
			EXEC INSERTTOLEDGER2 '9999999999', @@VNO, '1', '1', 'A', 'BROKER', 'BROKER'
			SELECT 
				@@LEDGER2CNT = COUNT(1) 
			FROM 
				LEDGER2 
			WHERE 
				VNO = @@VNO 
				AND VTYPE = @@VTYP 
				AND BOOKTYPE = @@BOOKTYPE
			IF @@LEDGER2CNT = 0
				BEGIN
					--ROLLBACK
					INSERT INTO LEDGER2MIS (VNO, VTYPE, BOOKTYPE, REASON) VALUES (@@VNO, @@VTYP, @@BOOKTYPE, 'DID NOT POSTED')
				END
			ELSE
				BEGIN
					SELECT
						@@LEDGER2CNT = COUNT(1)
					FROM
						(
						SELECT 
							CNT = COUNT(1)
						FROM
							LEDGER2
						WHERE
							VNO = @@VNO
							AND VTYPE = @@VTYP
							AND BOOKTYPE = @@BOOKTYPE
						GROUP BY
							COSTCODE
						HAVING
							SUM(CASE WHEN DRCR = 'D' THEN CAMT ELSE -CAMT END) <> 0
						) A
					IF @@LEDGER2CNT <> 0
						BEGIN
							--ROLLBACK
							INSERT INTO LEDGER2MIS (VNO, VTYPE, BOOKTYPE, REASON) VALUES (@@VNO, @@VTYP, @@BOOKTYPE, 'ERROR FOUND IN BRANCHWISE POSTING')
						END
					ELSE
						BEGIN
							PRINT 'POSTED'
							--COMMIT TRAN
						END
				END
			FETCH NEXT FROM @@CUR INTO @@VNO, @@VTYP, @@BOOKTYPE
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POSTLEDGER2VCH_FROMPROC
-- --------------------------------------------------
CREATE  PROC [dbo].[POSTLEDGER2VCH_FROMPROC]
 @VNO VARCHAR(12),          
 @VTYP SMALLINT,          
 @BOOKTYPE VARCHAR(2)          
      
AS          
 IF ISNULL(OBJECT_ID('ALLTOHOL2'), 0) = 0      
  BEGIN      
   SELECT *, GETDATE() UPDDATE INTO ALLTOHOL2 FROM LEDGER2 WHERE 1 = 0      
  END          
-- BEGIN TRAN          
 INSERT INTO ALLTOHOL2      
  SELECT *, GETDATE() FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE      
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE      
 DELETE FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999'      
 IF @VTYP = 8        
  BEGIN        
   INSERT INTO TEMPLEDGER2          
    SELECT 'BRANCH', CASE WHEN A.BRANCHCODE <> 'ALL' THEN A.BRANCHCODE ELSE 'HO' END,          
     L.VAMT, L.VTYP, L.VNO, L.LNO, L.DRCR, '0', L.BOOKTYPE, '9999999999',          
     L.CLTCODE, 'A', 0          
    FROM      
     LEDGER L, ACMAST A      
    WHERE      
     L.CLTCODE = A.CLTCODE      
     AND L.VNO = @VNO AND L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE      
  END      
 ELSE      
  BEGIN        
   INSERT INTO TEMPLEDGER2      
    SELECT 'BRANCH', CASE WHEN A.BRANCHCODE <> 'ALL' THEN A.BRANCHCODE ELSE '' END,      
     L.VAMT, L.VTYP, L.VNO, L.LNO, L.DRCR, '0', L.BOOKTYPE, '9999999999',      
     L.CLTCODE, 'A', 0      
    FROM      
     LEDGER L, ACMAST A      
    WHERE      
     L.CLTCODE = A.CLTCODE      
     AND L.VNO = @VNO AND L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE      
   UPDATE TEMPLEDGER2 SET BRANCH = (SELECT TOP 1 BRANCH FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999' AND BRANCH <> '')      
   WHERE BRANCH = ''      
   UPDATE TEMPLEDGER2 SET BRANCH = 'HO' WHERE BRANCH = ''      
 END        
EXEC INSERTTOLEDGER2 '9999999999', @VNO, 1, 1, '', 'BROKER', 'BROKER'      
DELETE FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999'      
--COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_GET_STATUS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_SQLTABLEREINDEX
-- --------------------------------------------------
CREATE  Proc [dbo].[PR_SQLTABLEREINDEX] AS
/*--------------------------------------------------------------------------------------------------------------------
Program Name 	: PR_SQLTABLEREINDEX
Desc 		: SQL Scripts to 
				1. Re Index all the Transaction Oriented Tables
				2. Checking Index Key Duplication 
Tables Using 	: 1. SQLTableIndex  - Keeping the following Details
			a. TableName
			b. IndexName
			c. IndexColumn
		  2.  SQLTableReIndex_Log - Keeping Re Index Log 
					    and Index Duplication Record
Logic 		: 
			Checking the Availability of the Required Index 
				If Found  --  Re Index & Log to SQLTableReIndex_Log with a remark as 'REINDEX'
				Else   - Create & Log to SQLTableReIndex_Log with a remark as 'NEWINDEX'
				
			Checking the Index Key Duplication
				If Found  -- Log to SQLTableReIndex_Log with a remark as 'DUPLICATE'
Program Benefit : 
			1. Standard Table Index to Maintain
			2. Re Creation Of Index for performance

Note		:  Handling only Non Clustered Index
----------------------------------------------------------------------------------------------------------------------*/



Declare 
	@TableCur Cursor,
	@TableName Varchar(20),
	@IndexName Varchar(10),
	@IndexColumn Varchar(100),
	@IndexColumnChk Varchar(100)
Declare 
	@TIndexName Varchar(20),
	@TIndexColum Varchar(100),
	@strSQL Varchar(200),
	@IndexCurSor Cursor,
	@IndexFlag int,
	@IndexPrv Varchar(20),
	@IndexColumnPrv Varchar(100)

SET NOCOUNT ON

Set @TableCur = Cursor For
Select
	TableName,
	IndexName,
	IndexColumn,
	IndexColumnChk = Ltrim(RTrim(Upper(Replace(IndexColumn,',',''))))
From
	SQLTableIndex
Open @TableCur
Fetch Next From @TableCur Into 	@TableName,@IndexName,@IndexColumn,@IndexColumnChk
While @@Fetch_Status = 0       
Begin      
	Set @IndexFlag  = 0
	Set @IndexColumnPrv = ''
	Set @IndexPrv = ''
	Set @IndexCurSor = Cursor for Select * From 
	(
		Select 
			i.name as IndexName,
			upper(isnull(index_col(@TableName, i.indid,1 ),'')+isnull(index_col(@TableName, i.indid,2 ),'')
			+isnull(index_col(@TableName, i.indid,3 ),'')+isnull(index_col(@TableName, i.indid,4 ),'')
			+isnull(index_col(@TableName, i.indid,5 ),'')+isnull(index_col(@TableName, i.indid,6),'')
			+isnull(index_col(@TableName, i.indid,7 ),'')+isnull(index_col(@TableName, i.indid,8),'') ) as IndexColumns
		from 
			(dbo.sysindexes i inner join dbo.sysfilegroups s on i.groupid = s.groupid )
		where 
			id = object_id(@TableName) and i.indid > 0 and i.indid < 255 and
			(INDEXPROPERTY(object_id(@TableName), i.name, N'IsStatistics') <> 1) and
			(INDEXPROPERTY(object_id(@TableName), i.name, N'IsAutoStatistics') <> 1) and
			(INDEXPROPERTY(object_id(@TableName), i.name, N'IsHypothetical') <> 1)
		 
	)TblIdx  Order By IndexColumns
	Open @IndexCurSor
	Fetch Next From @IndexCurSor into @TIndexName,@TIndexColum
	While @@Fetch_Status = 0       
	Begin     
		if @IndexColumnPrv = @TIndexColum
			Begin
				Insert Into SQLTableReIndex_Log Values 
				(@TableName,@IndexPrv,@TIndexColum,'DUPLICATE',@@SPId,GetDate())	
			End 
		If (@TIndexColum = @IndexColumnChk OR @IndexName = @TIndexName) AND @IndexFlag =0
			Begin
				Set @IndexFlag  = 1
				Set @strSQL = 'CREATE INDEX ['+ @TIndexName +'] ON [dbo].['+@TableName+']('
				Set @strSQL = @strSQL + @IndexColumn + ')'
				Set @strSQL = @strSQL + ' WITH  DROP_EXISTING ON [PRIMARY]'
				Exec (@strSQL)
				Insert Into SQLTableReIndex_Log Values 
				(@TableName,@TIndexName,@IndexColumn,'REINDEX',@@SPId,GetDate())
			End
		Set @IndexPrv = @TIndexName
		Set @IndexColumnPrv = @TIndexColum
		Fetch Next From @IndexCurSor into @TIndexName,@TIndexColum
	End      
	Close @IndexCurSor      
	DeAllocate @IndexCurSor
	if @IndexFlag =0
		Begin
			Set @strSQL = 'CREATE INDEX ['+ @IndexName +'] ON [dbo].['+@TableName+']('
			Set @strSQL = @strSQL + @IndexColumn + ')'
			Exec (@strSQL)
			Insert Into SQLTableReIndex_Log Values 
			(@TableName,@IndexName,@IndexColumn,'NEWINDEX',@@SPId,GetDate())
		End
	Fetch Next From @TableCur Into 	@TableName,@IndexName,@IndexColumn,@IndexColumnChk
End
Close @TableCur      
DeAllocate @TableCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_acc_getcompanyname
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.proc_acc_GetCompanyName    Script Date: 5/18/04 1:04:54 PM ******/  
  
CREATE  PROCEDURE [dbo].[Proc_acc_getcompanyname]  
 @AccoundDBName VarChar (50)  
AS  
  
  SELECT   BROKERID,
           COMPANYNAME,
           EXCHANGE,
           SEGMENT,
           MEMBERTYPE,
           MEMBERCODE,
           SHAREDB,
           SHARESERVER,
           SHAREIP,
           ACCOUNTDB,
           ACCOUNTSERVER,
           ACCOUNTIP,
           DEFAULTDB,
           DEFAULTDBSERVER,
           DEFAULTDBIP,
           DEFAULTCLIENT,
           PANGIR_NO,
           PRIMARYSERVER,
           FILLER2,
           DBUSERNAME,
           DBPASSWORD
  FROM     ACC_MULTICOMPANY
  WHERE    ACCOUNTDB = @AccoundDBName
           AND PRIMARYSERVER = 1
  ORDER BY COMPANYNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[RECPAYUPLOAD_BULK]        
 @FNAME VARCHAR(100),        
 @UNAME VARCHAR(25),        
 @USERCAT SMALLINT        
        
AS        
/*        
begin tran        
SP_HELPTRIGGER LEDGER        
LEDGER_TRG_BILL        
LEDGER_TRG        
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388        
SELECT TOP 1 * FROM LEDGER3        
SELECT TOP 1 * FROM LEDGER_TRG        
ROLLBACK        
*/        
SET NOCOUNT ON        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/        
DECLARE        
 @@STD_DATE VARCHAR(11),        
 @@LST_DATE VARCHAR(11),        
 @@BRANCHFLAG AS TINYINT,        
 @@VNOFLAG AS TINYINT,        
 @@VNOMETHOD INT,        
 @@ACNAME CHAR(100),        
 @@BOOKTYPE CHAR(2),        
 @@MICRNO VARCHAR(10),        
 @@DRCR VARCHAR(1),        
 @@VTYP SMALLINT,        
 @@BANK_CODE VARCHAR(100),        
 @@BACKDAYS INT,        
 @@BACKDATE VARCHAR(11),        
 @@BRNCOUNT   TINYINT,        
 @@MonthlyVdt VARCHAR(11),        
 @@SERIAL_NO INT,        
 @@COSTCODECOUNT TINYINT,        
 @@COSTCODEUPDATES CURSOR,        
 @@NEWVNO AS VARCHAR(12),        
 @@MAXCOUNT AS INT,        
 @@VDT AS VARCHAR(11),        
 @@BANKBRANCH AS VARCHAR(10),        
 @@BANKCOST AS NUMERIC,        
 @@LNOCUR AS CURSOR,        
 @@VNOCUR AS CURSOR,        
 @@LNOVNO AS VARCHAR(12),        
 @@MAXVNO AS INT,        
 @@L2CUR AS CURSOR,        
 @@L2VNO AS VARCHAR(12),        
 @@ERROR_COUNT AS INT,        
 @@FILEEXISTS AS INT,        
 @@SQL AS VARCHAR(2000)        
        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT        
   U_FILENAME        
  FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'        
  RETURN        
 END        
CREATE TABLE #FEXIST        
(        
 F1 SMALLINT,        
 F2 SMALLINT,        
 F3 SMALLINT        
)        
SELECT @@SQL = "INSERT INTO "        
SELECT @@SQL = @@SQL + " #FEXIST "        
SELECT @@SQL = @@SQL + " (F1, F2, F3) "        
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "        
        
EXEC(@@SQL)        
        
SELECT        
 @@FILEEXISTS = F1        
FROM        
 #FEXIST        
        
IF @@FILEEXISTS = 0        
 BEGIN        
  DROP TABLE #FEXIST        
  SELECT        
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'        
  RETURN        
 END        
DROP TABLE #FEXIST        
        
BEGIN TRAN        
CREATE TABLE #RECPAY_TABLE_TMP        
(        
 SERIAL_NO INT,        
 EDATE VARCHAR(20),        
 VOUCHER_DATE VARCHAR(20),        
 CLIENT_CODE VARCHAR(50),        
 AMOUNT MONEY,        
 DRCR VARCHAR(1),        
 NARRATION VARCHAR(234),        
 BANK_CODE VARCHAR(10),        
 BANK_NAME VARCHAR(100),        
 REF_NO VARCHAR(15),        
 BRANCHCODE VARCHAR(20),        
 BRANCH_NAME VARCHAR(50),        
 CHQ_MODE VARCHAR(1),        
 CHQ_DATE VARCHAR(20),        
 CHQ_NAME VARCHAR(100),        
 CL_MODE VARCHAR(1)        
)        
CREATE TABLE [#RECPAY_TABLE]        
 (        
  SERIAL_NO INT,        
  EDATE VARCHAR(20),        
  VOUCHER_DATE VARCHAR(20),        
  CLIENT_CODE VARCHAR(50),        
  AMOUNT MONEY,        
  DRCR VARCHAR(1),        
  NARRATION VARCHAR(234),        
  BANK_CODE VARCHAR(10),        
  BANK_NAME VARCHAR(100),        
  REF_NO VARCHAR(15),        
  BRANCHCODE VARCHAR(20),        
  BRANCH_NAME VARCHAR(50),        
  CHQ_MODE VARCHAR(1),        
  CHQ_DATE VARCHAR(20),        
  CHQ_NAME VARCHAR(100),        
  CL_MODE VARCHAR(1),        
  SNO INT IDENTITY (1, 1) NOT NULL ,        
  VDT DATETIME NULL ,        
  FYSTART DATETIME NULL ,        
  FYEND DATETIME NULL ,        
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),        
  EDT DATETIME NULL ,        
  DDDT DATETIME NULL ,        
  VNO VARCHAR (12) NULL ,        
  VTYP SMALLINT NULL ,        
  ACNAME VARCHAR (100) NULL ,        
  COSTCODE SMALLINT NULL,        
  BANKCOST SMALLINT NULL,        
  LNO SMALLINT NOT NULL DEFAULT(0),        
  BANKNAME VARCHAR(100) NULL,        
  MICRNO INT NULL,        
  BOOKTYPE VARCHAR(2) NULL,        
 ) ON [PRIMARY]        
    
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "        
EXEC (@@SQL)        
        
IF @@ERROR <> 0        
 BEGIN        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRANSACTION        
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'        
  RETURN        
 END        
INSERT INTO        
 V2_UPLOADED_FILES        
SELECT        
 @FNAME,        
 @FNAME,        
 CNT = COUNT(1),        
 'B',        
 GETDATE(),        
 @UNAME,        
 'RECEIPT/PAYMENT UPLOAD'        
        
INSERT INTO        
 #RECPAY_TABLE        
 (        
  SERIAL_NO,        
  EDATE,        
  VOUCHER_DATE,        
  CLIENT_CODE,        
  AMOUNT,        
  DRCR,        
  NARRATION,        
  BANK_CODE,        
  BANK_NAME,        
  REF_NO,        
  BRANCHCODE,        
  BRANCH_NAME,        
  CHQ_MODE,        
  CHQ_DATE,        
  CHQ_NAME,        
  CL_MODE        
 )        
SELECT        
 SERIAL_NO,        
 EDATE,        
 VOUCHER_DATE,        
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),        
 AMOUNT,        
 UPPER(LTRIM(RTRIM(DRCR))),        
 NARRATION,        
 UPPER(LTRIM(RTRIM(BANK_CODE))),        
 UPPER(LTRIM(RTRIM(BANK_NAME))),        
 REF_NO,        
 UPPER(LTRIM(RTRIM(BRANCHCODE))),        
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),        
 UPPER(LTRIM(RTRIM(CHQ_MODE))),        
 CHQ_DATE,        
 CHQ_NAME,        
 CL_MODE        
FROM        
 #RECPAY_TABLE_TMP        
        
UPDATE        
 #RECPAY_TABLE        
SET        
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),        
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),        
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))        
        
        
SELECT        
 @@ERROR_COUNT = COUNT(DISTINCT VDT)        
FROM        
 #RECPAY_TABLE        
        
IF @@ERROR_COUNT > 1        
 BEGIN        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRANSACTION        
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'        
  RETURN        
 END        
        
SELECT TOP 1        
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)        
FROM        
 #RECPAY_TABLE        
        
SELECT        
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),        
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),        
 @@BRANCHFLAG = BRANCHFLAG,        
 @@VNOFLAG = VNOFLAG        
FROM        
 PARAMETER        
WHERE        
 @@VDT BETWEEN SDTCUR AND LDTCUR        
        
IF @@BRANCHFLAG = 1        
 BEGIN        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   BRANCHCODE = A.BRANCHCODE,        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   COSTCODE = C.COSTCODE,        
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0)        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('3','4')        
   AND B.ACCAT = '2'        
   AND A.BRANCHCODE = COSTNAME        
          
  UPDATE        
   #RECPAY_TABLE        
  SET        
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),        
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),        
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,        
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0)        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('3','4')        
   AND B.ACCAT = '2'        
   AND A.BRANCHCODE = 'ALL'        
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'        
        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   BRANCHCODE = 'HO',        
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),        
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),        
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,       
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0)        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('3','4')        
   AND B.ACCAT = '2'        
   AND A.BRANCHCODE = 'ALL'        
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'        
 END        
ELSE        
 BEGIN        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   FYSTART = @@STD_DATE,        
   FYEND = @@LST_DATE + ' 23:59:59',        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0)        
  FROM        
   ACMAST A, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND A.ACCAT IN ('3','4')        
   AND B.ACCAT = '2'        
 END        
        
--SELECT * FROM #RECPAY_TABLE
--RETURN 
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */        
        
 SELECT        
  @@ERROR_COUNT = COUNT(DISTINCT VDT)        
 FROM        
  #RECPAY_TABLE        
 IF @@ERROR_COUNT > 1        
  BEGIN        
   SELECT        
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'        
   DROP TABLE #RECPAY_TABLE_TMP        
   DROP TABLE #RECPAY_TABLE        
   ROLLBACK TRAN        
   DELETE        
   FROM        
    V2_UPLOADED_FILES        
   WHERE        
    U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
   RETURN        
  END        
 SELECT @@ERROR_COUNT = 0        
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/        
/*        
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)        
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1        
 IF @@ERROR_COUNT > 0        
  BEGIN        
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'        
   DROP TABLE #RecPay_Table_Tmp        
   DROP TABLE #RecPay_Table        
   ROLLBACK TRAN        
   DELETE FROM V2_Uploaded_Files        
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
   RETURN        
  END*/        
        
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */        
 SELECT        
  @@ERROR_COUNT = COUNT(1)        
 FROM        
  (        
   SELECT        
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),        
    SERIAL_NO        
   FROM        
    #RECPAY_TABLE        
   GROUP BY        
    SERIAL_NO        
   HAVING        
    COUNT(DISTINCT BANK_CODE) > 1   
  ) A        
 IF @@ERROR_COUNT > 0        
  BEGIN        
   SELECT        
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'        
   UNION ALL        
   SELECT        
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))        
   FROM        
    #RECPAY_TABLE        
   GROUP BY        
    SERIAL_NO        
   HAVING        
    COUNT(DISTINCT BANK_CODE) > 1        
        
   DROP TABLE #RECPAY_TABLE_TMP        
   DROP TABLE #RECPAY_TABLE        
   ROLLBACK TRAN        
   DELETE        
   FROM        
    V2_UPLOADED_FILES        
   WHERE        
    U_FILENAME = @FNAME        
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
   RETURN        
  END        
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
 SELECT DISTINCT        
  DRCR        
 FROM        
  #RECPAY_TABLE        
 ) A        
IF @@ERROR_COUNT > 1        
 BEGIN        
  SELECT        
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE        
  FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
ELSE        
 BEGIN        
  SELECT TOP 1        
   @@DRCR = DRCR,        
   @@VTYP =        
    (        
    CASE        
     WHEN DRCR = 'D'        
     THEN 3        
     ELSE 2        
    END        
    )        
  FROM        
   #RECPAY_TABLE        
  UPDATE        
   #RECPAY_TABLE        
  SET VTYP =        
 (        
    CASE        
     WHEN DRCR = 'D'        
     THEN 3        
     ELSE 2        
    END        
   )        
 END        
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/        
 SELECT @@ERROR_COUNT = COUNT(1)        
 FROM #RECPAY_TABLE        
 WHERE VDT > EDT        
            IF @@ERROR_COUNT > 0        
             BEGIN        
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'        
     DROP TABLE #RECPAY_TABLE_TMP        
     DROP TABLE #RECPAY_TABLE        
     ROLLBACK TRAN        
     DELETE FROM        
      V2_UPLOADED_FILES        
     WHERE        
      U_FILENAME = @FNAME        
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
     RETURN        
             END        
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/        
 SELECT @@ERROR_COUNT = COUNT(1)        
 FROM #RECPAY_TABLE        
 WHERE AMOUNT <= 0        
 IF @@ERROR_COUNT > 0        
  BEGIN        
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'        
     DROP TABLE #RECPAY_TABLE_TMP        
     DROP TABLE #RECPAY_TABLE        
     ROLLBACK TRAN        
     DELETE FROM        
      V2_UPLOADED_FILES        
     WHERE        
      U_FILENAME = @FNAME        
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
     RETURN        
  END        
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT DISTINCT        
   DDNO  = RP.REF_NO        
  FROM        
   #RECPAY_TABLE RP,        
   LEDGER1 L1        
    WITH(NOLOCK)        
  WHERE        
   L1.DDNO = RP.REF_NO        
   AND L1.BNKNAME = RP.BANK_NAME      
   AND L1.DD = RP.CHQ_MODE        
   AND L1.DRCR = @@DRCR        
   AND L1.VTYP = @@VTYP        
   AND RP.REF_NO <> 0        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'        
  UNION ALL        
  SELECT DISTINCT        
   RP.REF_NO, 'NA','NA'        
  FROM        
   #RECPAY_TABLE RP,        
   LEDGER1 L1        
    WITH(NOLOCK)        
  WHERE        
   L1.DDNO = RP.REF_NO        
   AND L1.BNKNAME = RP.BANK_NAME      
   AND L1.DD = RP.CHQ_MODE        
   AND L1.DRCR = @@DRCR        
   AND L1.VTYP = @@VTYP        
   AND RP.CHQ_MODE <> 'N'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT DISTINCT        
   CLIENT_CODE        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   UPDFLAG = 'N'        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'        
  UNION ALL        
  SELECT DISTINCT        
   CLIENT_CODE, 'NA','NA'        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   UPDFLAG = 'N'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */        
  SET @@VNOCUR = CURSOR FOR        
   SELECT DISTINCT        
    BANK_CODE,        
    BOOKTYPE        
   FROM        
    #RECPAY_TABLE WITH(NOLOCK)        
  OPEN @@VNOCUR        
  FETCH NEXT        
   FROM        
    @@VNOCUR        
   INTO        
    @@BANK_CODE,        
    @@BOOKTYPE        
  WHILE @@FETCH_STATUS = 0        
   BEGIN        
  /*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/        
    SELECT        
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)        
    FROM        
     USERWRITESTABLE        
    WHERE        
     USERCATEGORY = @USERCAT        
     AND VTYP = @@VTYP        
     AND BOOKTYPE = @@BOOKTYPE        
    SELECT        
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS        
    SELECT        
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)        
    FROM        
     #RECPAY_TABLE        
    WHERE        
     VDT < @@BACKDATE        
      
    IF @@ERROR_COUNT > 0        
     BEGIN        
      SELECT        
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'        
      DROP TABLE #RECPAY_TABLE_TMP        
      DROP TABLE #RECPAY_TABLE        
      ROLLBACK TRAN        
      DELETE FROM V2_UPLOADED_FILES        
      WHERE        
       U_FILENAME = @FNAME        
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
      RETURN        
     END      
        
    IF @@BRANCHFLAG = 1        
     BEGIN        
      SELECT        
       @@BANKBRANCH = BRANCHCODE,        
       @@BANKCOST = ISNULL(C.COSTCODE, -1)        
      FROM        
       ACMAST A        
        LEFT OUTER JOIN        
        COSTMAST C        
        ON        
         (        
          A.BRANCHCODE = C.COSTNAME        
         )        
      WHERE        
       A.CLTCODE = @@BANK_CODE        
      IF @@BANKBRANCH <> 'ALL'        
       BEGIN        
        UPDATE        
         RP        
          SET COSTCODE = @@BANKCOST        
        FROM        
         #RECPAY_TABLE RP,        
         ACMAST A        
        WHERE        
         A.CLTCODE = RP.CLIENT_CODE        
         AND A.BRANCHCODE = 'ALL'        
        UPDATE        
         #RECPAY_TABLE        
          SET BANKCOST = @@BANKCOST        
        WHERE        
         BANK_CODE = @@BANK_CODE        
       END        
      ELSE        
       BEGIN        
        UPDATE        
         #RECPAY_TABLE        
          SET COSTCODE =        
           (        
            SELECT TOP 1        
             COSTCODE        
            FROM        
             COSTMAST        
            WHERE        
             COSTNAME = 'HO'        
           )        
        WHERE        
         COSTCODE = ''        
         AND BANK_CODE = @@BANK_CODE        
                            SET @@COSTCODEUPDATES = CURSOR FOR        
                                       SELECT        
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)        
                                       FROM        
                                             #RECPAY_TABLE WITH(NOLOCK)        
                                       WHERE        
          BANK_CODE = @@BANK_CODE        
                                       GROUP BY        
                                             SERIAL_NO        
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1        
                            OPEN @@COSTCODEUPDATES        
                            FETCH NEXT        
                             FROM        
                              @@COSTCODEUPDATES        
                             INTO        
                              @@SERIAL_NO,        
                              @@COSTCODECOUNT        
                            WHILE @@FETCH_STATUS = 0        
                             BEGIN        
          UPDATE        
           #RECPAY_TABLE        
            SET BANKCOST =        
             (        
              SELECT TOP 1        
               COSTCODE        
              FROM        
               COSTMAST        
              WHERE        
               COSTNAME = 'HO'        
             )        
          WHERE        
           (BANKCOST = ''   OR BANKCOST IS NULL)        
           AND BANK_CODE = @@BANK_CODE        
                                           AND SERIAL_NO = @@SERIAL_NO        
                              FETCH NEXT        
                               FROM        
                                @@COSTCODEUPDATES        
                               INTO        
                                @@SERIAL_NO,        
                                @@COSTCODECOUNT        
                             END        
                            CLOSE @@COSTCODEUPDATES        
                            DEALLOCATE @@COSTCODEUPDATES        
                  UPDATE        
                   #RECPAY_TABLE        
                    SET BANKCOST = COSTCODE        
                  WHERE        
                   BANK_CODE = @@BANK_CODE        
                                        AND (BANKCOST = ''   OR BANKCOST IS NULL)        
       END        
     END        
    CREATE TABLE        
     #BANK_VNO        
     (        
      SRNO INT,        
      NEWSRNO INT IDENTITY (1, 1)        
     )        
    INSERT INTO        
     #BANK_VNO        
    SELECT        
     DISTINCT SERIAL_NO        
    FROM        
     #RECPAY_TABLE        
    WHERE        
     BANK_CODE = @@BANK_CODE        
     AND BOOKTYPE = @@BOOKTYPE        
        
    SELECT        
     @@MAXCOUNT = COUNT(DISTINCT SNO)        
    FROM        
     #RECPAY_TABLE        
        
    SELECT TOP 1        
     @@VDT = VDT        
    FROM        
     #RECPAY_TABLE        
    SELECT        
     LASTVNO        
    INTO #VNO        
    FROM        
     V2_LASTVNO        
    WHERE        
     1 = 2        
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO        
    INSERT        
    INTO #VNO        
     EXEC ACC_GENVNO_NEW        
      @@VDT,        
      @@VTYP,        
      @@BOOKTYPE,        
      @@STD_DATE,        
      @@LST_DATE,        
      @@MAXVNO        
    SELECT        
     @@NEWVNO = LASTVNO        
    FROM        
     #VNO        
    UPDATE        
     RP        
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))        
    FROM        
     #RECPAY_TABLE RP,        
     #BANK_VNO BV        
    WHERE        
     RP.SERIAL_NO = BV.SRNO        
   DROP TABLE #VNO        
   DROP TABLE #BANK_VNO        
  FETCH NEXT        
   FROM @@VNOCUR        
   INTO        
    @@BANK_CODE,        
    @@BOOKTYPE        
 END        
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */        
UPDATE        
 #RECPAY_TABLE        
  SET LNO = 2        
WHERE        
 VNO IN        
  (        
   SELECT        
    VNO        
   FROM        
    #RECPAY_TABLE        
     WITH(NOLOCK)        
   GROUP BY        
    VNO        
   HAVING        
    COUNT(*) = 1        
  )        
SET @@LNOCUR = CURSOR FOR        
 SELECT        
  VNO        
 FROM        
  #RECPAY_TABLE        
   WITH(NOLOCK)        
 GROUP BY        
  VNO        
 HAVING        
  COUNT(*) > 1        
OPEN @@LNOCUR        
FETCH NEXT        
 FROM        
  @@LNOCUR        
 INTO        
  @@LNOVNO        
WHILE @@FETCH_STATUS = 0        
 BEGIN        
  CREATE TABLE        
   [#LNOGEN]        
    (        
     VNO VARCHAR(12),        
     SNO INT,        
     LNO INT IDENTITY(1,1)        
    )        
  INSERT INTO        
   #LNOGEN        
    SELECT        
     VNO,        
     SNO        
    FROM        
     #RECPAY_TABLE        
      WITH(NOLOCK)        
    WHERE        
     VNO = @@LNOVNO        
    ORDER BY        
     SNO        
  UPDATE        
   #RECPAY_TABLE        
    SET LNO = L.LNO + 1        
  FROM        
   #LNOGEN L        
  WHERE        
   #RECPAY_TABLE.VNO = L.VNO        
   AND #RECPAY_TABLE.SNO = L.SNO        
   AND #RECPAY_TABLE.LNO = 0        
  DROP TABLE #LNOGEN        
  FETCH NEXT        
   FROM        
    @@LNOCUR        
   INTO        
    @@LNOVNO        
 END        
CLOSE @@LNOCUR        
DEALLOCATE @@LNOCUR        
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */        
INSERT INTO        
 LEDGER1        
  (        
   BNKNAME,        
   BRNNAME,        
   DD,        
   DDNO,        
   DDDT,        
   RELDT,        
   RELAMT,        
   REFNO,        
   RECEIPTNO,        
   VTYP,        
   VNO,        
   LNO,        
   DRCR,        
   BOOKTYPE,        
   MICRNO,        
   SLIPNO,        
   SLIPDATE,        
   CHEQUEINNAME,        
   CHQPRINTED,        
   CLEAR_MODE        
  )        
SELECT        
 BNKNAME = MAX(BANK_NAME),        
 BRNNAME = MAX(BRANCH_NAME),        
 DD = MAX(CHQ_MODE),        
 DDNO = MAX(REF_NO),        
 DDDT = MAX(DDDT),        
 RELDT = '',        
 RELAMT = SUM(AMOUNT),        
 REFNO = 0,        
 RECEIPTNO = 0,        
 VTYP,        
 VNO,        
 LNO = 2,        
 DRCR,        
 BOOKTYPE = BOOKTYPE,        
 MICRNO = MAX(MICRNO),        
 SLIPNO = 0,        
 SLIPDATE = '',        
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),        
 CHQPRINTED = 0,        
 CLEAR_MODE = MAX(CL_MODE)        
FROM        
 #RECPAY_TABLE        
GROUP BY        
 VTYP,        
 VNO,        
 DRCR,        
 BOOKTYPE        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
/*================================        
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK        
=================================*/        
CREATE TABLE #LEDGER        
(        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 EDT DATETIME,        
 LNO SMALLINT,        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 VAMT MONEY,        
 VDT DATETIME,        
 VNO1 VARCHAR(12),        
 REFNO CHAR(12),        
 BALAMT MONEY,        
 NODAYS INT,        
 CDT DATETIME,        
 CLTCODE VARCHAR(10),        
 BOOKTYPE VARCHAR(2),        
 ENTEREDBY VARCHAR(25),        
 PDT DATETIME,        
 CHECKEDBY VARCHAR(25),        
 ACTNODAYS INT,        
 NARRATION VARCHAR(234)        
)        
--SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0        
CREATE TABLE #LEDGER3        
(        
 NARATNO INT,        
 NARR VARCHAR(234),        
 REFNO CHAR(12),        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 BOOKTYPE VARCHAR(2)        
)        
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0        
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER        
 (        
  VTYP,        
  VNO,        
  EDT,        
  LNO,        
  ACNAME,        
  DRCR,        
  VAMT,        
  VDT,        
  VNO1,        
  REFNO,        
  BALAMT,        
  NODAYS,        
  CDT,        
  CLTCODE,        
  BOOKTYPE,        
  ENTEREDBY,        
  PDT,        
  CHECKEDBY,        
  ACTNODAYS,        
  NARRATION        
 )        
SELECT        
 VTYP,        
 VNO,        
 EDT = EDT,        
 LNO,        
 ACNAME,        
 DRCR,        
 VAMT = AMOUNT,        
 VDT,        
 VNO1 = VNO,        
 REFNO = 0,        
 BALAMT = AMOUNT,        
 NODAYS = 0,        
 CDT = GETDATE(),        
 CLTCODE = CLIENT_CODE,        
 BOOKTYPE = BOOKTYPE,        
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),        
 PDT = GETDATE(),        
 CHECKEDBY = @UNAME,        
 ACTNODAYS = 0,        
 NARRATION        
FROM        
 #RECPAY_TABLE        
/*==============================        
BANK SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER        
SELECT        
 VTYP,        
 VNO,        
 EDT = EDT,        
 LNO = 1,        
 BANKNAME,        
 DRCR =        
  (        
   CASE        
    WHEN DRCR = 'D'        
    THEN 'C'        
    ELSE 'D'        
   END        
  ),        
 VAMT = SUM(AMOUNT),        
 VDT,        
 VNO1 = VNO,        
 REFNO = 0,        
 BALAMT = SUM(AMOUNT),        
 NODAYS = 0,        
 CDT = GETDATE(),        
 CLTCODE = BANK_CODE,        
 BOOKTYPE = BOOKTYPE,        
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),        
 PDT = GETDATE(),        
 CHECKEDBY = @UNAME,        
 ACTNODAYS = 0,        
 NARRATION = MAX(NARRATION)        
FROM        
 #RECPAY_TABLE     
GROUP BY        
 VTYP,        
 VNO,        
 EDT,        
 DRCR,        
 VDT,        
 BANK_CODE,        
 BOOKTYPE,        
 BANKNAME        
/*==============================        
INSERTING ALL LEDGER RECORDS AT ONE TIME        
==============================*/        
INSERT INTO LEDGER        
SELECT        
 *        
FROM        
 #LEDGER        
ORDER BY        
 BOOKTYPE,        
 VTYP,        
 VNO,        
 LNO        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  DROP TABLE #LEDGER        
  DROP TABLE #LEDGER3        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
DROP TABLE #LEDGER        
/*==============================        
BANK SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER3        
SELECT        
 NARATNO = 1,        
 NARRATION = MAX(NARRATION),        
 REFNO = 0,        
 VTYP,        
 VNO,        
 BOOKTYPE        
FROM        
 #RECPAY_TABLE        
GROUP BY        
 VTYP,        
 VNO,        
 BOOKTYPE        
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER3        
SELECT        
 NARATNO = LNO,        
 NARR = NARRATION,        
 REFNO = 0,        
 VTYP,        
 VNO,        
 BOOKTYPE        
FROM        
 #RECPAY_TABLE        
        
        
/*==============================        
INSERTING ALL LEDGER3 RECORDS AT ONE TIME        
==============================*/        
INSERT INTO LEDGER3        
SELECT        
 *        
FROM        
 #LEDGER3        
ORDER BY        
 BOOKTYPE,        
 VTYP,        
 VNO,        
 NARATNO        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  DROP TABLE #LEDGER3        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
DROP TABLE #LEDGER3        
        
        
IF @@BRANCHFLAG = 1        
 BEGIN        
  SET @@L2CUR = CURSOR FOR        
   SELECT DISTINCT        
    VNO        
   FROM        
    #RECPAY_TABLE        
   ORDER BY        
    VNO        
  OPEN @@L2CUR        
   FETCH NEXT        
   FROM        
  @@L2CUR        
   INTO        
    @@L2VNO        
  WHILE @@FETCH_STATUS = 0        
   BEGIN        
    DELETE FROM        
     TEMPLEDGER2        
    WHERE        
     SESSIONID = '9999999999'        
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
    INSERT INTO        
     TEMPLEDGER2        
    SELECT        
     'BRANCH',        
     C.COSTNAME,        
     AMOUNT,        
     VTYP,        
     VNO,        
     LNO,        
     DRCR,        
     '0',        
     BOOKTYPE,        
     '9999999999',        
     CLIENT_CODE,        
     'A',        
     '0'        
    FROM        
     #RECPAY_TABLE RP,        
     COSTMAST C        
    WHERE        
     RP.COSTCODE = C.COSTCODE        
     AND VNO = @@L2VNO        
/*==============================        
BANK SIDE RECORD        
==============================*/        
    INSERT INTO        
     TEMPLEDGER2        
    SELECT        
     'BRANCH',        
     C.COSTNAME,        
     SUM(AMOUNT),        
     VTYP,        
     VNO,        
     LNO = 1,        
     DRCR =        
      (        
       CASE        
       WHEN DRCR = 'D'        
       THEN 'C'        
       ELSE 'D'        
       END        
      ),        
     '0',        
     BOOKTYPE,        
     '9999999999',        
     BANK_CODE,        
     'A',        
     '0'        
    FROM        
     #RECPAY_TABLE RP,        
     COSTMAST C        
    WHERE        
     RP.BANKCOST = C.COSTCODE        
     AND VNO = @@L2VNO        
    GROUP BY        
     C.COSTNAME,        
     VTYP,        
     VNO,        
      (        
       CASE        
       WHEN DRCR = 'D'        
       THEN 'C'        
       ELSE 'D'        
       END        
      ),        
     BANK_CODE,        
     BOOKTYPE        
    EXEC INSERTTOLEDGER2        
     '9999999999',        
     @@L2VNO,        
     '1',        
     '1',        
     '1',        
     'BROKER',        
     'BROKER'        
    FETCH NEXT        
     FROM        
      @@L2CUR        
     INTO        
      @@L2VNO        
   END        
  DELETE FROM        
   TEMPLEDGER2        
  WHERE        
   SESSIONID = '9999999999'        
  COMMIT TRAN        
 END        
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL        
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE        
DROP TABLE #RECPAY_TABLE_TMP        
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD_BULK_03032011
-- --------------------------------------------------
CREATE PROC [dbo].[RECPAYUPLOAD_BULK_03032011]        
 @FNAME VARCHAR(100),        
 @UNAME VARCHAR(25),        
 @USERCAT SMALLINT        
        
AS        
/*        
begin tran        
SP_HELPTRIGGER LEDGER        
LEDGER_TRG_BILL        
LEDGER_TRG        
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388        
SELECT TOP 1 * FROM LEDGER3        
SELECT TOP 1 * FROM LEDGER_TRG        
ROLLBACK        
*/        
SET NOCOUNT ON        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/        
DECLARE        
 @@STD_DATE VARCHAR(11),        
 @@LST_DATE VARCHAR(11),        
 @@BRANCHFLAG AS TINYINT,        
 @@VNOFLAG AS TINYINT,        
 @@VNOMETHOD INT,        
 @@ACNAME CHAR(100),        
 @@BOOKTYPE CHAR(2),        
 @@MICRNO VARCHAR(10),        
 @@DRCR VARCHAR(1),        
 @@VTYP SMALLINT,        
 @@BANK_CODE VARCHAR(100),        
 @@BACKDAYS INT,        
 @@BACKDATE VARCHAR(11),        
 @@BRNCOUNT   TINYINT,        
 @@MonthlyVdt VARCHAR(11),        
 @@SERIAL_NO INT,        
 @@COSTCODECOUNT TINYINT,        
 @@COSTCODEUPDATES CURSOR,        
 @@NEWVNO AS VARCHAR(12),        
 @@MAXCOUNT AS INT,        
 @@VDT AS VARCHAR(11),        
 @@BANKBRANCH AS VARCHAR(10),        
 @@BANKCOST AS NUMERIC,        
 @@LNOCUR AS CURSOR,        
 @@VNOCUR AS CURSOR,        
 @@LNOVNO AS VARCHAR(12),        
 @@MAXVNO AS INT,        
 @@L2CUR AS CURSOR,        
 @@L2VNO AS VARCHAR(12),        
 @@ERROR_COUNT AS INT,        
 @@FILEEXISTS AS INT,        
 @@SQL AS VARCHAR(2000)        
        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT        
   U_FILENAME        
  FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'        
  RETURN        
 END        
CREATE TABLE #FEXIST        
(        
 F1 SMALLINT,        
 F2 SMALLINT,        
 F3 SMALLINT        
)        
SELECT @@SQL = "INSERT INTO "        
SELECT @@SQL = @@SQL + " #FEXIST "        
SELECT @@SQL = @@SQL + " (F1, F2, F3) "        
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "        
        
EXEC(@@SQL)        
        
SELECT        
 @@FILEEXISTS = F1        
FROM        
 #FEXIST        
        
IF @@FILEEXISTS = 0        
 BEGIN        
  DROP TABLE #FEXIST        
  SELECT        
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'        
  RETURN        
 END        
DROP TABLE #FEXIST        
        
BEGIN TRAN        
CREATE TABLE #RECPAY_TABLE_TMP        
(        
 SERIAL_NO INT,        
 EDATE VARCHAR(20),        
 VOUCHER_DATE VARCHAR(20),        
 CLIENT_CODE VARCHAR(50),        
 AMOUNT MONEY,        
 DRCR VARCHAR(1),        
 NARRATION VARCHAR(234),        
 BANK_CODE VARCHAR(10),        
 BANK_NAME VARCHAR(100),        
 REF_NO VARCHAR(15),        
 BRANCHCODE VARCHAR(20),        
 BRANCH_NAME VARCHAR(50),        
 CHQ_MODE VARCHAR(1),        
 CHQ_DATE VARCHAR(20),        
 CHQ_NAME VARCHAR(100),        
 CL_MODE VARCHAR(1)        
)        
CREATE TABLE [#RECPAY_TABLE]        
 (        
  SERIAL_NO INT,        
  EDATE VARCHAR(20),        
  VOUCHER_DATE VARCHAR(20),        
  CLIENT_CODE VARCHAR(50),        
  AMOUNT MONEY,        
  DRCR VARCHAR(1),        
  NARRATION VARCHAR(234),        
  BANK_CODE VARCHAR(10),        
  BANK_NAME VARCHAR(100),        
  REF_NO VARCHAR(15),        
  BRANCHCODE VARCHAR(20),        
  BRANCH_NAME VARCHAR(50),        
  CHQ_MODE VARCHAR(1),        
  CHQ_DATE VARCHAR(20),        
  CHQ_NAME VARCHAR(100),        
  CL_MODE VARCHAR(1),        
  SNO INT IDENTITY (1, 1) NOT NULL ,        
  VDT DATETIME NULL ,        
  FYSTART DATETIME NULL ,        
  FYEND DATETIME NULL ,        
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),        
  EDT DATETIME NULL ,        
  DDDT DATETIME NULL ,        
  VNO VARCHAR (12) NULL ,        
  VTYP SMALLINT NULL ,        
  ACNAME VARCHAR (100) NULL ,        
  COSTCODE SMALLINT NULL,        
  BANKCOST SMALLINT NULL,        
  LNO SMALLINT NOT NULL DEFAULT(0),        
  BANKNAME VARCHAR(100) NULL,        
  MICRNO INT NULL,        
  BOOKTYPE VARCHAR(2) NULL,        
 ) ON [PRIMARY]        
    
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "        
EXEC (@@SQL)        
        
IF @@ERROR <> 0        
 BEGIN        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRANSACTION        
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'        
  RETURN        
 END        
INSERT INTO        
 V2_UPLOADED_FILES        
SELECT        
 @FNAME,        
 @FNAME,        
 CNT = COUNT(1),        
 'B',        
 GETDATE(),        
 @UNAME,        
 'RECEIPT/PAYMENT UPLOAD'        
        
INSERT INTO        
 #RECPAY_TABLE        
 (        
  SERIAL_NO,        
  EDATE,        
  VOUCHER_DATE,        
  CLIENT_CODE,        
  AMOUNT,        
  DRCR,        
  NARRATION,        
  BANK_CODE,        
  BANK_NAME,        
  REF_NO,        
  BRANCHCODE,        
  BRANCH_NAME,        
  CHQ_MODE,        
  CHQ_DATE,        
  CHQ_NAME,        
  CL_MODE        
 )        
SELECT        
 SERIAL_NO,        
 EDATE,        
 VOUCHER_DATE,        
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),        
 AMOUNT,        
 UPPER(LTRIM(RTRIM(DRCR))),        
 NARRATION,        
 UPPER(LTRIM(RTRIM(BANK_CODE))),        
 UPPER(LTRIM(RTRIM(BANK_NAME))),        
 REF_NO,        
 UPPER(LTRIM(RTRIM(BRANCHCODE))),        
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),        
 UPPER(LTRIM(RTRIM(CHQ_MODE))),        
 CHQ_DATE,        
 CHQ_NAME,        
 CL_MODE        
FROM        
 #RECPAY_TABLE_TMP        
        
UPDATE        
 #RECPAY_TABLE        
SET        
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),        
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),        
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))        
        
        
SELECT        
 @@ERROR_COUNT = COUNT(DISTINCT VDT)        
FROM        
 #RECPAY_TABLE        
        
IF @@ERROR_COUNT > 1        
 BEGIN        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRANSACTION        
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'        
  RETURN        
 END        
        
SELECT TOP 1        
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)        
FROM        
 #RECPAY_TABLE        
        
SELECT        
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),        
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),        
 @@BRANCHFLAG = BRANCHFLAG,        
 @@VNOFLAG = VNOFLAG        
FROM        
 PARAMETER        
WHERE        
 @@VDT BETWEEN SDTCUR AND LDTCUR        
        
IF @@BRANCHFLAG = 1        
 BEGIN        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   BRANCHCODE = A.BRANCHCODE,        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   COSTCODE = C.COSTCODE,        
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0)        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('3','4')        
   AND B.ACCAT = '2'        
   AND A.BRANCHCODE = COSTNAME        
          
  UPDATE        
   #RECPAY_TABLE        
  SET        
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),        
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),        
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,        
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0)        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('3','4')        
   AND B.ACCAT = '2'        
   AND A.BRANCHCODE = 'ALL'        
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'        
        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   BRANCHCODE = 'HO',        
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),        
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),        
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,       
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0)        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('3','4')        
   AND B.ACCAT = '2'        
   AND A.BRANCHCODE = 'ALL'        
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'        
 END        
ELSE        
 BEGIN        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   FYSTART = @@STD_DATE,        
   FYEND = @@LST_DATE + ' 23:59:59',        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0)        
  FROM        
   ACMAST A, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND A.ACCAT IN ('3','4')        
   AND B.ACCAT = '2'        
 END        
        
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */        
        
 SELECT        
  @@ERROR_COUNT = COUNT(DISTINCT VDT)        
 FROM        
  #RECPAY_TABLE        
 IF @@ERROR_COUNT > 1        
  BEGIN        
   SELECT        
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'        
   DROP TABLE #RECPAY_TABLE_TMP        
   DROP TABLE #RECPAY_TABLE        
   ROLLBACK TRAN        
   DELETE        
   FROM        
    V2_UPLOADED_FILES        
   WHERE        
    U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
   RETURN        
  END        
 SELECT @@ERROR_COUNT = 0        
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/        
/*        
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)        
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1        
 IF @@ERROR_COUNT > 0        
  BEGIN        
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'        
   DROP TABLE #RecPay_Table_Tmp        
   DROP TABLE #RecPay_Table        
   ROLLBACK TRAN        
   DELETE FROM V2_Uploaded_Files        
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
   RETURN        
  END*/        
        
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */        
 SELECT        
  @@ERROR_COUNT = COUNT(1)        
 FROM        
  (        
   SELECT        
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),        
    SERIAL_NO        
   FROM        
    #RECPAY_TABLE        
   GROUP BY        
    SERIAL_NO        
   HAVING        
    COUNT(DISTINCT BANK_CODE) > 1   
  ) A        
 IF @@ERROR_COUNT > 0        
  BEGIN        
   SELECT        
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'        
   UNION ALL        
   SELECT        
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))        
   FROM        
    #RECPAY_TABLE        
   GROUP BY        
    SERIAL_NO        
   HAVING        
    COUNT(DISTINCT BANK_CODE) > 1        
        
   DROP TABLE #RECPAY_TABLE_TMP        
   DROP TABLE #RECPAY_TABLE        
   ROLLBACK TRAN        
   DELETE        
   FROM        
    V2_UPLOADED_FILES        
   WHERE        
    U_FILENAME = @FNAME        
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
   RETURN        
  END        
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
 SELECT DISTINCT        
  DRCR        
 FROM        
  #RECPAY_TABLE        
 ) A        
IF @@ERROR_COUNT > 1        
 BEGIN        
  SELECT        
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE        
  FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
ELSE        
 BEGIN        
  SELECT TOP 1        
   @@DRCR = DRCR,        
   @@VTYP =        
    (        
    CASE        
     WHEN DRCR = 'D'        
     THEN 3        
     ELSE 2        
    END        
    )        
  FROM        
   #RECPAY_TABLE        
  UPDATE        
   #RECPAY_TABLE        
  SET VTYP =        
 (        
    CASE        
     WHEN DRCR = 'D'        
     THEN 3        
     ELSE 2        
    END        
   )        
 END        
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/        
 SELECT @@ERROR_COUNT = COUNT(1)        
 FROM #RECPAY_TABLE        
 WHERE VDT > EDT        
            IF @@ERROR_COUNT > 0        
             BEGIN        
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'        
     DROP TABLE #RECPAY_TABLE_TMP        
     DROP TABLE #RECPAY_TABLE        
     ROLLBACK TRAN        
     DELETE FROM        
      V2_UPLOADED_FILES        
     WHERE        
      U_FILENAME = @FNAME        
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
     RETURN        
             END        
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/        
 SELECT @@ERROR_COUNT = COUNT(1)        
 FROM #RECPAY_TABLE        
 WHERE AMOUNT <= 0        
 IF @@ERROR_COUNT > 0        
  BEGIN        
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'        
     DROP TABLE #RECPAY_TABLE_TMP        
     DROP TABLE #RECPAY_TABLE        
     ROLLBACK TRAN        
     DELETE FROM        
      V2_UPLOADED_FILES        
     WHERE        
      U_FILENAME = @FNAME        
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
     RETURN        
  END        
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT DISTINCT        
   DDNO  = RP.REF_NO        
  FROM        
   #RECPAY_TABLE RP,        
   LEDGER1 L1        
    WITH(NOLOCK)        
  WHERE        
   L1.DDNO = RP.REF_NO        
   AND L1.BNKNAME = RP.BANK_NAME      
   AND L1.DD = RP.CHQ_MODE        
   AND L1.DRCR = @@DRCR        
   AND L1.VTYP = @@VTYP        
   AND RP.REF_NO <> 0        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'        
  UNION ALL        
  SELECT DISTINCT        
   RP.REF_NO, 'NA','NA'        
  FROM        
   #RECPAY_TABLE RP,        
   LEDGER1 L1        
    WITH(NOLOCK)        
  WHERE        
   L1.DDNO = RP.REF_NO        
   AND L1.BNKNAME = RP.BANK_NAME      
   AND L1.DD = RP.CHQ_MODE        
   AND L1.DRCR = @@DRCR        
   AND L1.VTYP = @@VTYP        
   AND RP.CHQ_MODE <> 'N'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT DISTINCT        
   CLIENT_CODE        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   UPDFLAG = 'N'        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'        
  UNION ALL        
  SELECT DISTINCT        
   CLIENT_CODE, 'NA','NA'        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   UPDFLAG = 'N'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */        
  SET @@VNOCUR = CURSOR FOR        
   SELECT DISTINCT        
    BANK_CODE,        
    BOOKTYPE        
   FROM        
    #RECPAY_TABLE WITH(NOLOCK)        
  OPEN @@VNOCUR        
  FETCH NEXT        
   FROM        
    @@VNOCUR        
   INTO        
    @@BANK_CODE,        
    @@BOOKTYPE        
  WHILE @@FETCH_STATUS = 0        
   BEGIN        
  /*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/        
    SELECT        
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)        
    FROM        
     USERWRITESTABLE        
    WHERE        
     USERCATEGORY = @USERCAT        
     AND VTYP = @@VTYP        
     AND BOOKTYPE = @@BOOKTYPE        
    SELECT        
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS        
    SELECT        
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)        
    FROM        
     #RECPAY_TABLE        
    WHERE        
     VDT < @@BACKDATE        
      
    IF @@ERROR_COUNT > 0        
     BEGIN        
      SELECT        
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'        
      DROP TABLE #RECPAY_TABLE_TMP        
      DROP TABLE #RECPAY_TABLE        
      ROLLBACK TRAN        
      DELETE FROM V2_UPLOADED_FILES        
      WHERE        
       U_FILENAME = @FNAME        
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
      RETURN        
     END      
        
    IF @@BRANCHFLAG = 1        
     BEGIN        
      SELECT        
       @@BANKBRANCH = BRANCHCODE,        
       @@BANKCOST = ISNULL(C.COSTCODE, -1)        
      FROM        
       ACMAST A        
        LEFT OUTER JOIN        
        COSTMAST C        
        ON        
         (        
          A.BRANCHCODE = C.COSTNAME        
         )        
      WHERE        
       A.CLTCODE = @@BANK_CODE        
      IF @@BANKBRANCH <> 'ALL'        
       BEGIN        
        UPDATE        
         RP        
          SET COSTCODE = @@BANKCOST        
        FROM        
         #RECPAY_TABLE RP,        
         ACMAST A        
        WHERE        
         A.CLTCODE = RP.CLIENT_CODE        
         AND A.BRANCHCODE = 'ALL'        
        UPDATE        
         #RECPAY_TABLE        
          SET BANKCOST = @@BANKCOST        
        WHERE        
         BANK_CODE = @@BANK_CODE        
       END        
      ELSE        
       BEGIN        
        UPDATE        
         #RECPAY_TABLE        
          SET COSTCODE =        
           (        
            SELECT TOP 1        
             COSTCODE        
            FROM        
             COSTMAST        
            WHERE        
             COSTNAME = 'HO'        
           )        
        WHERE        
         COSTCODE = ''        
         AND BANK_CODE = @@BANK_CODE        
                            SET @@COSTCODEUPDATES = CURSOR FOR        
                                       SELECT        
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)        
                                       FROM        
                                             #RECPAY_TABLE WITH(NOLOCK)        
                                       WHERE        
          BANK_CODE = @@BANK_CODE        
                                       GROUP BY        
                                             SERIAL_NO        
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1        
                            OPEN @@COSTCODEUPDATES        
                            FETCH NEXT        
                             FROM        
                              @@COSTCODEUPDATES        
                             INTO        
                              @@SERIAL_NO,        
                              @@COSTCODECOUNT        
                            WHILE @@FETCH_STATUS = 0        
                             BEGIN        
          UPDATE        
           #RECPAY_TABLE        
            SET BANKCOST =        
             (        
              SELECT TOP 1        
               COSTCODE        
              FROM        
               COSTMAST        
              WHERE        
               COSTNAME = 'HO'        
             )        
          WHERE        
           (BANKCOST = ''   OR BANKCOST IS NULL)        
           AND BANK_CODE = @@BANK_CODE        
                                           AND SERIAL_NO = @@SERIAL_NO        
                              FETCH NEXT        
                               FROM        
                                @@COSTCODEUPDATES        
                               INTO        
                                @@SERIAL_NO,        
                                @@COSTCODECOUNT        
                             END        
                            CLOSE @@COSTCODEUPDATES        
                            DEALLOCATE @@COSTCODEUPDATES        
                  UPDATE        
                   #RECPAY_TABLE        
                    SET BANKCOST = COSTCODE        
                  WHERE        
                   BANK_CODE = @@BANK_CODE        
                                        AND (BANKCOST = ''   OR BANKCOST IS NULL)        
       END        
     END        
    CREATE TABLE        
     #BANK_VNO        
     (        
      SRNO INT,        
      NEWSRNO INT IDENTITY (1, 1)        
     )        
    INSERT INTO        
     #BANK_VNO        
    SELECT        
     DISTINCT SERIAL_NO        
    FROM        
     #RECPAY_TABLE        
    WHERE        
     BANK_CODE = @@BANK_CODE        
     AND BOOKTYPE = @@BOOKTYPE        
        
    SELECT        
     @@MAXCOUNT = COUNT(DISTINCT SNO)        
    FROM        
     #RECPAY_TABLE        
        
    SELECT TOP 1        
     @@VDT = VDT        
    FROM        
     #RECPAY_TABLE        
    SELECT        
     LASTVNO        
    INTO #VNO        
    FROM        
     V2_LASTVNO        
    WHERE        
     1 = 2        
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO        
    INSERT        
    INTO #VNO        
     EXEC ACC_GENVNO_NEW        
      @@VDT,        
      @@VTYP,        
      @@BOOKTYPE,        
      @@STD_DATE,        
      @@LST_DATE,        
      @@MAXVNO        
    SELECT        
     @@NEWVNO = LASTVNO        
    FROM        
     #VNO        
    UPDATE        
     RP        
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))        
    FROM        
     #RECPAY_TABLE RP,        
     #BANK_VNO BV        
    WHERE        
     RP.SERIAL_NO = BV.SRNO        
   DROP TABLE #VNO        
   DROP TABLE #BANK_VNO        
  FETCH NEXT        
   FROM @@VNOCUR        
   INTO        
    @@BANK_CODE,        
    @@BOOKTYPE        
 END        
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */        
UPDATE        
 #RECPAY_TABLE        
  SET LNO = 2        
WHERE        
 VNO IN        
  (        
   SELECT        
    VNO        
   FROM        
    #RECPAY_TABLE        
     WITH(NOLOCK)        
   GROUP BY        
    VNO        
   HAVING        
    COUNT(*) = 1        
  )        
SET @@LNOCUR = CURSOR FOR        
 SELECT        
  VNO        
 FROM        
  #RECPAY_TABLE        
   WITH(NOLOCK)        
 GROUP BY        
  VNO        
 HAVING        
  COUNT(*) > 1        
OPEN @@LNOCUR        
FETCH NEXT        
 FROM        
  @@LNOCUR        
 INTO        
  @@LNOVNO        
WHILE @@FETCH_STATUS = 0        
 BEGIN        
  CREATE TABLE        
   [#LNOGEN]        
    (        
     VNO VARCHAR(12),        
     SNO INT,        
     LNO INT IDENTITY(1,1)        
    )        
  INSERT INTO        
   #LNOGEN        
    SELECT        
     VNO,        
     SNO        
    FROM        
     #RECPAY_TABLE        
      WITH(NOLOCK)        
    WHERE        
     VNO = @@LNOVNO        
    ORDER BY        
     SNO        
  UPDATE        
   #RECPAY_TABLE        
    SET LNO = L.LNO + 1        
  FROM        
   #LNOGEN L        
  WHERE        
   #RECPAY_TABLE.VNO = L.VNO        
   AND #RECPAY_TABLE.SNO = L.SNO        
   AND #RECPAY_TABLE.LNO = 0        
  DROP TABLE #LNOGEN        
  FETCH NEXT        
   FROM        
    @@LNOCUR        
   INTO        
    @@LNOVNO        
 END        
CLOSE @@LNOCUR        
DEALLOCATE @@LNOCUR        
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */        
INSERT INTO        
 LEDGER1        
  (        
   BNKNAME,        
   BRNNAME,        
   DD,        
   DDNO,        
   DDDT,        
   RELDT,        
   RELAMT,        
   REFNO,        
   RECEIPTNO,        
   VTYP,        
   VNO,        
   LNO,        
   DRCR,        
   BOOKTYPE,        
   MICRNO,        
   SLIPNO,        
   SLIPDATE,        
   CHEQUEINNAME,        
   CHQPRINTED,        
   CLEAR_MODE        
  )        
SELECT        
 BNKNAME = MAX(BANK_NAME),        
 BRNNAME = MAX(BRANCH_NAME),        
 DD = MAX(CHQ_MODE),        
 DDNO = MAX(REF_NO),        
 DDDT = MAX(DDDT),        
 RELDT = '',        
 RELAMT = SUM(AMOUNT),        
 REFNO = 0,        
 RECEIPTNO = 0,        
 VTYP,        
 VNO,        
 LNO = 2,        
 DRCR,        
 BOOKTYPE = BOOKTYPE,        
 MICRNO = MAX(MICRNO),        
 SLIPNO = 0,        
 SLIPDATE = '',        
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),        
 CHQPRINTED = 0,        
 CLEAR_MODE = MAX(CL_MODE)        
FROM        
 #RECPAY_TABLE        
GROUP BY        
 VTYP,        
 VNO,        
 DRCR,        
 BOOKTYPE        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
/*================================        
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK        
=================================*/        
CREATE TABLE #LEDGER        
(        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 EDT DATETIME,        
 LNO SMALLINT,        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 VAMT MONEY,        
 VDT DATETIME,        
 VNO1 VARCHAR(12),        
 REFNO CHAR(12),        
 BALAMT MONEY,        
 NODAYS INT,        
 CDT DATETIME,        
 CLTCODE VARCHAR(10),        
 BOOKTYPE VARCHAR(2),        
 ENTEREDBY VARCHAR(25),        
 PDT DATETIME,        
 CHECKEDBY VARCHAR(25),        
 ACTNODAYS INT,        
 NARRATION VARCHAR(234)        
)        
--SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0        
CREATE TABLE #LEDGER3        
(        
 NARATNO INT,        
 NARR VARCHAR(234),        
 REFNO CHAR(12),        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 BOOKTYPE VARCHAR(2)        
)        
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0        
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER        
 (        
  VTYP,        
  VNO,        
  EDT,        
  LNO,        
  ACNAME,        
  DRCR,        
  VAMT,        
  VDT,        
  VNO1,        
  REFNO,        
  BALAMT,        
  NODAYS,        
  CDT,        
  CLTCODE,        
  BOOKTYPE,        
  ENTEREDBY,        
  PDT,        
  CHECKEDBY,        
  ACTNODAYS,        
  NARRATION        
 )        
SELECT        
 VTYP,        
 VNO,        
 EDT = EDT,        
 LNO,        
 ACNAME,        
 DRCR,        
 VAMT = AMOUNT,        
 VDT,        
 VNO1 = VNO,        
 REFNO = 0,        
 BALAMT = AMOUNT,        
 NODAYS = 0,        
 CDT = GETDATE(),        
 CLTCODE = CLIENT_CODE,        
 BOOKTYPE = BOOKTYPE,        
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),        
 PDT = GETDATE(),        
 CHECKEDBY = @UNAME,        
 ACTNODAYS = 0,        
 NARRATION        
FROM        
 #RECPAY_TABLE        
/*==============================        
BANK SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER        
SELECT        
 VTYP,        
 VNO,        
 EDT = EDT,        
 LNO = 1,        
 BANKNAME,        
 DRCR =        
  (        
   CASE        
    WHEN DRCR = 'D'        
    THEN 'C'        
    ELSE 'D'        
   END        
  ),        
 VAMT = SUM(AMOUNT),        
 VDT,        
 VNO1 = VNO,        
 REFNO = 0,        
 BALAMT = SUM(AMOUNT),        
 NODAYS = 0,        
 CDT = GETDATE(),        
 CLTCODE = BANK_CODE,        
 BOOKTYPE = BOOKTYPE,        
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),        
 PDT = GETDATE(),        
 CHECKEDBY = @UNAME,        
 ACTNODAYS = 0,        
 NARRATION = MAX(NARRATION)        
FROM        
 #RECPAY_TABLE     
GROUP BY        
 VTYP,        
 VNO,        
 EDT,        
 DRCR,        
 VDT,        
 BANK_CODE,        
 BOOKTYPE,        
 BANKNAME        
/*==============================        
INSERTING ALL LEDGER RECORDS AT ONE TIME        
==============================*/        
INSERT INTO LEDGER        
SELECT        
 *        
FROM        
 #LEDGER        
ORDER BY        
 BOOKTYPE,        
 VTYP,        
 VNO,        
 LNO        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  DROP TABLE #LEDGER        
  DROP TABLE #LEDGER3        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
DROP TABLE #LEDGER        
/*==============================        
BANK SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER3        
SELECT        
 NARATNO = 1,        
 NARRATION = MAX(NARRATION),        
 REFNO = 0,        
 VTYP,        
 VNO,        
 BOOKTYPE        
FROM        
 #RECPAY_TABLE        
GROUP BY        
 VTYP,        
 VNO,        
 BOOKTYPE        
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER3        
SELECT        
 NARATNO = LNO,        
 NARR = NARRATION,        
 REFNO = 0,        
 VTYP,        
 VNO,        
 BOOKTYPE        
FROM        
 #RECPAY_TABLE        
        
        
/*==============================        
INSERTING ALL LEDGER3 RECORDS AT ONE TIME        
==============================*/        
INSERT INTO LEDGER3        
SELECT        
 *        
FROM        
 #LEDGER3        
ORDER BY        
 BOOKTYPE,        
 VTYP,        
 VNO,        
 NARATNO        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  DROP TABLE #LEDGER3        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
DROP TABLE #LEDGER3        
        
        
IF @@BRANCHFLAG = 1        
 BEGIN        
  SET @@L2CUR = CURSOR FOR        
   SELECT DISTINCT        
    VNO        
   FROM        
    #RECPAY_TABLE        
   ORDER BY        
    VNO        
  OPEN @@L2CUR        
   FETCH NEXT        
   FROM        
  @@L2CUR        
   INTO        
    @@L2VNO        
  WHILE @@FETCH_STATUS = 0        
   BEGIN        
    DELETE FROM        
     TEMPLEDGER2        
    WHERE        
     SESSIONID = '9999999999'        
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
    INSERT INTO        
     TEMPLEDGER2        
    SELECT        
     'BRANCH',        
     C.COSTNAME,        
     AMOUNT,        
     VTYP,        
     VNO,        
     LNO,        
     DRCR,        
     '0',        
     BOOKTYPE,        
     '9999999999',        
     CLIENT_CODE,        
     'A',        
     '0'        
    FROM        
     #RECPAY_TABLE RP,        
     COSTMAST C        
    WHERE        
     RP.COSTCODE = C.COSTCODE        
     AND VNO = @@L2VNO        
/*==============================        
BANK SIDE RECORD        
==============================*/        
    INSERT INTO        
     TEMPLEDGER2        
    SELECT        
     'BRANCH',        
     C.COSTNAME,        
     SUM(AMOUNT),        
     VTYP,        
     VNO,        
     LNO = 1,        
     DRCR =        
      (        
       CASE        
       WHEN DRCR = 'D'        
       THEN 'C'        
       ELSE 'D'        
       END        
      ),        
     '0',        
     BOOKTYPE,        
     '9999999999',        
     BANK_CODE,        
     'A',        
     '0'        
    FROM        
     #RECPAY_TABLE RP,        
     COSTMAST C        
    WHERE        
     RP.BANKCOST = C.COSTCODE        
     AND VNO = @@L2VNO        
    GROUP BY        
     C.COSTNAME,        
     VTYP,        
     VNO,        
      (        
       CASE        
       WHEN DRCR = 'D'        
       THEN 'C'        
       ELSE 'D'        
       END        
      ),        
     BANK_CODE,        
     BOOKTYPE        
    EXEC INSERTTOLEDGER2        
     '9999999999',        
     @@L2VNO,        
     '1',        
     '1',        
     '1',        
     'BROKER',        
     'BROKER'        
    FETCH NEXT        
     FROM        
      @@L2CUR        
     INTO        
      @@L2VNO        
   END        
  DELETE FROM        
   TEMPLEDGER2        
  WHERE        
   SESSIONID = '9999999999'        
  COMMIT TRAN        
 END        
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL        
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE        
DROP TABLE #RECPAY_TABLE_TMP        
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD_BULK_SAJAG
-- --------------------------------------------------
CREATE PROC [dbo].[RECPAYUPLOAD_BULK_SAJAG]      
 @FNAME VARCHAR(100),      
 @UNAME VARCHAR(25),      
 @USERCAT SMALLINT      
      
AS      
/*      
begin tran      
SP_HELPTRIGGER LEDGER      
LEDGER_TRG_BILL      
LEDGER_TRG      
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388      
SELECT TOP 1 * FROM LEDGER3      
SELECT TOP 1 * FROM LEDGER_TRG      
ROLLBACK      
*/      
SET NOCOUNT ON      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
DECLARE      
 @@STD_DATE VARCHAR(11),      
 @@LST_DATE VARCHAR(11),      
 @@BRANCHFLAG AS TINYINT,      
 @@VNOFLAG AS TINYINT,      
 @@VNOMETHOD INT,      
 @@ACNAME CHAR(100),      
 @@BOOKTYPE CHAR(2),      
 @@MICRNO VARCHAR(10),      
 @@DRCR VARCHAR(1),      
 @@VTYP SMALLINT,      
 @@BANK_CODE VARCHAR(100),      
 @@BACKDAYS INT,      
 @@BACKDATE VARCHAR(11),      
 @@BRNCOUNT   TINYINT,      
 @@MonthlyVdt VARCHAR(11),      
 @@SERIAL_NO INT,      
 @@COSTCODECOUNT TINYINT,      
 @@COSTCODEUPDATES CURSOR,      
 @@NEWVNO AS VARCHAR(12),      
 @@MAXCOUNT AS INT,      
 @@VDT AS VARCHAR(11),      
 @@BANKBRANCH AS VARCHAR(10),      
 @@BANKCOST AS NUMERIC,      
 @@LNOCUR AS CURSOR,      
 @@VNOCUR AS CURSOR,      
 @@LNOVNO AS VARCHAR(12),      
 @@MAXVNO AS INT,      
 @@L2CUR AS CURSOR,      
 @@L2VNO AS VARCHAR(12),      
 @@ERROR_COUNT AS INT,      
 @@FILEEXISTS AS INT,      
 @@SQL AS VARCHAR(2000)      
      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT      
   U_FILENAME      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
 ) A      
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT      
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'      
  RETURN      
 END      
CREATE TABLE #FEXIST      
(      
 F1 SMALLINT,      
 F2 SMALLINT,      
 F3 SMALLINT      
)      
SELECT @@SQL = "INSERT INTO "      
SELECT @@SQL = @@SQL + " #FEXIST "      
SELECT @@SQL = @@SQL + " (F1, F2, F3) "      
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "      
      
EXEC(@@SQL)      
      
SELECT      
 @@FILEEXISTS = F1      
FROM      
 #FEXIST      
      
IF @@FILEEXISTS = 0      
 BEGIN      
  DROP TABLE #FEXIST      
  SELECT      
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'      
  RETURN      
 END      
DROP TABLE #FEXIST      
      
BEGIN TRAN      
CREATE TABLE #RECPAY_TABLE_TMP      
(      
 SERIAL_NO INT,      
 EDATE VARCHAR(20),      
 VOUCHER_DATE VARCHAR(20),      
 CLIENT_CODE VARCHAR(50),      
 AMOUNT MONEY,      
 DRCR VARCHAR(1),      
 NARRATION VARCHAR(234),      
 BANK_CODE VARCHAR(10),      
 BANK_NAME VARCHAR(100),      
 REF_NO VARCHAR(15),      
 BRANCHCODE VARCHAR(20),      
 BRANCH_NAME VARCHAR(50),      
 CHQ_MODE VARCHAR(1),      
 CHQ_DATE VARCHAR(20),      
 CHQ_NAME VARCHAR(100),      
 CL_MODE VARCHAR(1)      
)      
CREATE TABLE [#RECPAY_TABLE]      
 (      
  SERIAL_NO INT,      
  EDATE VARCHAR(20),      
  VOUCHER_DATE VARCHAR(20),      
  CLIENT_CODE VARCHAR(50),      
  AMOUNT MONEY,      
  DRCR VARCHAR(1),      
  NARRATION VARCHAR(234),      
  BANK_CODE VARCHAR(10),      
  BANK_NAME VARCHAR(100),      
  REF_NO VARCHAR(15),      
  BRANCHCODE VARCHAR(20),      
  BRANCH_NAME VARCHAR(50),      
  CHQ_MODE VARCHAR(1),      
  CHQ_DATE VARCHAR(20),      
  CHQ_NAME VARCHAR(100),      
  CL_MODE VARCHAR(1),      
  SNO INT IDENTITY (1, 1) NOT NULL ,      
  VDT DATETIME NULL ,      
  FYSTART DATETIME NULL ,      
  FYEND DATETIME NULL ,      
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),      
  EDT DATETIME NULL ,      
  DDDT DATETIME NULL ,      
  VNO VARCHAR (12) NULL ,  
VTYP SMALLINT NULL ,      
  ACNAME VARCHAR (100) NULL ,      
  COSTCODE SMALLINT NULL,      
  BANKCOST SMALLINT NULL,      
  LNO SMALLINT NOT NULL DEFAULT(0),      
  BANKNAME VARCHAR(100) NULL,      
  MICRNO INT NULL,      
  BOOKTYPE VARCHAR(2) NULL,      
 ) ON [PRIMARY]      
      
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "      
EXEC (@@SQL)      
      
IF @@ERROR <> 0      
 BEGIN      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRANSACTION      
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'      
  RETURN      
 END      
INSERT INTO      
 V2_UPLOADED_FILES      
SELECT      
 @FNAME,      
 @FNAME,      
 CNT = COUNT(1),      
 'B',      
 GETDATE(),      
 @UNAME,      
 'RECEIPT/PAYMENT UPLOAD'      
      
INSERT INTO      
 #RECPAY_TABLE      
 (      
  SERIAL_NO,      
  EDATE,      
  VOUCHER_DATE,      
  CLIENT_CODE,      
  AMOUNT,      
  DRCR,      
  NARRATION,      
  BANK_CODE,      
  BANK_NAME,      
  REF_NO,      
  BRANCHCODE,      
  BRANCH_NAME,      
  CHQ_MODE,      
  CHQ_DATE,      
  CHQ_NAME,      
  CL_MODE      
 )      
SELECT      
 SERIAL_NO,      
 EDATE,      
 VOUCHER_DATE,      
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),      
 AMOUNT,      
 UPPER(LTRIM(RTRIM(DRCR))),      
 NARRATION,      
 UPPER(LTRIM(RTRIM(BANK_CODE))),      
 UPPER(LTRIM(RTRIM(BANK_NAME))),      
 REF_NO,      
 UPPER(LTRIM(RTRIM(BRANCHCODE))),      
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),      
 UPPER(LTRIM(RTRIM(CHQ_MODE))),      
 CHQ_DATE,      
 CHQ_NAME,      
 CL_MODE      
FROM      
 #RECPAY_TABLE_TMP      
      
UPDATE      
 #RECPAY_TABLE      
SET      
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),      
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),      
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))      


SELECT TOP 1      
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)      
FROM      
 #RECPAY_TABLE      


SELECT      
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),      
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),      
 @@BRANCHFLAG = BRANCHFLAG,      
 @@VNOFLAG = VNOFLAG      
FROM      
 PARAMETER      
WHERE      
 @@VDT BETWEEN SDTCUR AND LDTCUR   
      
IF @@VNOFLAG <> 0 
BEGIN     
	SELECT      
	 @@ERROR_COUNT = COUNT(DISTINCT VDT)      
	FROM      
	 #RECPAY_TABLE      
	      
	IF @@ERROR_COUNT > 1      
	 BEGIN      
	  DROP TABLE #RECPAY_TABLE_TMP      
	  DROP TABLE #RECPAY_TABLE      
	  ROLLBACK TRANSACTION      
	  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'      
	  RETURN      
	 END    
END  
      
      
IF @@BRANCHFLAG = 1      
 BEGIN      
  UPDATE      
   #RECPAY_TABLE      
  SET      
   BRANCHCODE = A.BRANCHCODE,      
   FYSTART = P.SDTCUR,      
   FYEND = P.LDTCUR,      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   COSTCODE = C.COSTCODE,      
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND P.CURYEAR = 1      
   AND A.ACCAT IN ('3','4','18')      
   AND B.ACCAT = '2'      
   AND A.BRANCHCODE = COSTNAME      
        
  UPDATE      
   #RECPAY_TABLE      
  SET      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),      
   FYSTART = P.SDTCUR,      
   FYEND = P.LDTCUR,      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,      
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND P.CURYEAR = 1      
   AND A.ACCAT IN ('3','4','18')      
   AND B.ACCAT = '2'      
   AND A.BRANCHCODE = 'ALL'      
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'      
      
  UPDATE      
   #RECPAY_TABLE      
  SET      
   BRANCHCODE = 'HO',      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),      
   FYSTART = P.SDTCUR,      
   FYEND = P.LDTCUR,      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,      
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND P.CURYEAR = 1      
   AND A.ACCAT IN ('3','4','18')      
   AND B.ACCAT = '2'      
   AND A.BRANCHCODE = 'ALL'      
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'      
 END      
ELSE      
 BEGIN      
  UPDATE      
   #RECPAY_TABLE      
  SET      
   FYSTART = @@STD_DATE,      
   FYEND = @@LST_DATE + ' 23:59:59',      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND A.ACCAT IN ('3','4','18')      
   AND B.ACCAT = '2'      
 END      



     
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */      
      
SELECT
	SERIAL_NO, VOUCHER_DATE
INTO #DUP_VDTS
FROM
	#RECPAY_TABLE
GROUP BY SERIAL_NO, VOUCHER_DATE

SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM #DUP_VDTS
GROUP BY SERIAL_NO
HAVING COUNT(1) > 1

 IF @@ERROR_COUNT > 1      
  BEGIN      
   SELECT      
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES IN SAME SERIAL NO', 'NA', 'NA'      
   DROP TABLE #RECPAY_TABLE_TMP      
   DROP TABLE #RECPAY_TABLE      
   ROLLBACK TRAN      
   DELETE      
   FROM      
    V2_UPLOADED_FILES      
   WHERE      
    U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
   RETURN      
  END      


SELECT 
	@@ERROR_COUNT = COUNT(SERIAL_NO) 
FROM 
	#RECPAY_TABLE
WHERE VDT NOT BETWEEN FYSTART AND FYEND

 IF @@ERROR_COUNT > 0
  BEGIN      
   SELECT      
    'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.', 'NA', 'NA'      
   DROP TABLE #RECPAY_TABLE_TMP      
   DROP TABLE #RECPAY_TABLE      
   ROLLBACK TRAN      
   DELETE      
   FROM      
    V2_UPLOADED_FILES      
   WHERE      
    U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
   RETURN      
  END      

SET @@ERROR_COUNT = 0
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/      
/*      
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)      
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1      
 IF @@ERROR_COUNT > 0      
  BEGIN      
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'      
   DROP TABLE #RecPay_Table_Tmp      
   DROP TABLE #RecPay_Table      
   ROLLBACK TRAN      
   DELETE FROM V2_Uploaded_Files      
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
   RETURN      
  END*/      
      
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */      
 SELECT      
  @@ERROR_COUNT = COUNT(1)      
 FROM      
  (      
   SELECT      
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),      
    SERIAL_NO      
   FROM      
    #RECPAY_TABLE      
   GROUP BY      
    SERIAL_NO      
   HAVING      
    COUNT(DISTINCT BANK_CODE) > 1      
  ) A      
 IF @@ERROR_COUNT > 0      
  BEGIN      
   SELECT      
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'      
   UNION ALL      
   SELECT      
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))      
   FROM      
    #RECPAY_TABLE      
   GROUP BY      
    SERIAL_NO      
   HAVING      
    COUNT(DISTINCT BANK_CODE) > 1      
      
   DROP TABLE #RECPAY_TABLE_TMP      
   DROP TABLE #RECPAY_TABLE      
   ROLLBACK TRAN      
   DELETE      
   FROM      
    V2_UPLOADED_FILES      
   WHERE      
    U_FILENAME = @FNAME      
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
   RETURN      
  END      
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
 SELECT DISTINCT      
  DRCR      
 FROM      
  #RECPAY_TABLE      
 ) A      
IF @@ERROR_COUNT > 1      
 BEGIN      
  SELECT      
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
ELSE      
 BEGIN      
  SELECT TOP 1      
   @@DRCR = DRCR,      
   @@VTYP =      
    (      
    CASE      
     WHEN DRCR = 'D'      
     THEN 3      
     ELSE 2      
    END      
    )      
  FROM      
   #RECPAY_TABLE      
  UPDATE      
   #RECPAY_TABLE      
  SET VTYP =      
   (      
   CASE      
     WHEN DRCR = 'D'      
     THEN 3      
     ELSE 2      
    END      
   )      
 END      
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/      
 SELECT @@ERROR_COUNT = COUNT(1)      
 FROM #RECPAY_TABLE      
 WHERE VDT > EDT      
            IF @@ERROR_COUNT > 0      
             BEGIN      
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'      
     DROP TABLE #RECPAY_TABLE_TMP      
     DROP TABLE #RECPAY_TABLE      
     ROLLBACK TRAN      
     DELETE FROM      
      V2_UPLOADED_FILES      
     WHERE      
      U_FILENAME = @FNAME      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
     RETURN      
             END      
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/      
 SELECT @@ERROR_COUNT = COUNT(1)      
 FROM #RECPAY_TABLE      
 WHERE AMOUNT <= 0      
 IF @@ERROR_COUNT > 0      
  BEGIN      
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'      
     DROP TABLE #RECPAY_TABLE_TMP      
     DROP TABLE #RECPAY_TABLE      
     ROLLBACK TRAN      
     DELETE FROM      
      V2_UPLOADED_FILES      
     WHERE      
      U_FILENAME = @FNAME      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
     RETURN      
  END   
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */      
/*Select REF_NO,CHQ_MODE,BANK_NAME into #tempchqno from 
#RECPAY_TABLE RP,      
   LEDGER1 L1      
    WITH(NOLOCK)      
  WHERE      
   L1.DDNO = RP.REF_NO      
  AND L1.DD = RP.CHQ_MODE  
   AND L1.BNKNAME = RP.BANK_NAME    
   AND L1.DRCR = @@DRCR      
   AND L1.VTYP = @@VTYP      
   AND RP.REF_NO <> 0   

SELECT      
@@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT DISTINCT      
   DDNO  = RP.REF_NO      
  FROM      
   #tempchqno RP where not exists(select vno from  LEDGER1 L1      
    WITH(NOLOCK)      
  WHERE      
   L1.DDNO = RP.REF_NO      
   AND L1.DD = RP.CHQ_MODE  
  AND L1.BNKNAME = RP.BANK_NAME and l1.vtyp = 17)
 ) A      
*/

-----------------------------old code
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT DISTINCT      
   DDNO  = RP.REF_NO      
  FROM      
   #RECPAY_TABLE RP,      
   LEDGER1 L1      
    WITH(NOLOCK)      
  WHERE      
   L1.DDNO = RP.REF_NO      
   AND L1.DD = RP.CHQ_MODE      
   AND L1.DRCR = @@DRCR      
   AND L1.VTYP = @@VTYP      
   AND RP.REF_NO <> 0      
 ) A   
----------------   
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'      
  UNION ALL      
  SELECT DISTINCT      
   RP.REF_NO, 'NA','NA'      
  FROM      
   #RECPAY_TABLE RP,      
   LEDGER1 L1      
    WITH(NOLOCK)      
  WHERE      
   L1.DDNO = RP.REF_NO      
   AND L1.DD = RP.CHQ_MODE      
   AND L1.DRCR = @@DRCR      
   AND L1.VTYP = @@VTYP      
   AND RP.CHQ_MODE <> 'N'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT DISTINCT      
   CLIENT_CODE      
  FROM      
   #RECPAY_TABLE      
  WHERE      
   UPDFLAG = 'N'      
 ) A      
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'      
  UNION ALL      
  SELECT DISTINCT      
   CLIENT_CODE, 'NA','NA'      
  FROM      
   #RECPAY_TABLE      
  WHERE      
   UPDFLAG = 'N'      
  DROP TABLE #RECPAY_TABLE_TMP      
DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */      
  SET @@VNOCUR = CURSOR FOR      
   SELECT DISTINCT      
    BANK_CODE,      
    BOOKTYPE      
   FROM      
    #RECPAY_TABLE WITH(NOLOCK)      
  OPEN @@VNOCUR      
  FETCH NEXT      
   FROM      
    @@VNOCUR      
   INTO      
    @@BANK_CODE,      
    @@BOOKTYPE      
  WHILE @@FETCH_STATUS = 0      
   BEGIN      
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------
    SELECT      
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)      
    FROM      
     USERWRITESTABLE      
    WHERE      
     USERCATEGORY = @USERCAT      
     AND VTYP = @@VTYP      
     AND BOOKTYPE = @@BOOKTYPE      
    SELECT      
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS      
    SELECT      
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)      
    FROM      
     #RECPAY_TABLE      
    WHERE      
     VDT < @@BACKDATE      
    IF @@ERROR_COUNT > 0      
     BEGIN      
      SELECT      
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'      
      DROP TABLE #RECPAY_TABLE_TMP      
      DROP TABLE #RECPAY_TABLE      
      ROLLBACK TRAN      
      DELETE FROM V2_UPLOADED_FILES      
      WHERE      
       U_FILENAME = @FNAME      
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
      RETURN      
     END

    IF @@BRANCHFLAG = 1      
     BEGIN      
      SELECT      
       @@BANKBRANCH = BRANCHCODE,      
       @@BANKCOST = ISNULL(C.COSTCODE, -1)      
      FROM      
       ACMAST A      
        LEFT OUTER JOIN      
        COSTMAST C      
        ON      
         (      
          A.BRANCHCODE = C.COSTNAME      
         )      
      WHERE      
    A.CLTCODE = @@BANK_CODE      
      IF @@BANKBRANCH <> 'ALL'      
       BEGIN      
        UPDATE      
         RP      
          SET COSTCODE = @@BANKCOST      
        FROM      
         #RECPAY_TABLE RP,      
         ACMAST A      
        WHERE      
         A.CLTCODE = RP.CLIENT_CODE      
         AND A.BRANCHCODE = 'ALL'      
        UPDATE      
         #RECPAY_TABLE      
          SET BANKCOST = @@BANKCOST      
        WHERE      
         BANK_CODE = @@BANK_CODE      
       END      
      ELSE      
       BEGIN      
        UPDATE      
         #RECPAY_TABLE      
          SET COSTCODE =      
           (      
            SELECT TOP 1      
             COSTCODE      
            FROM      
             COSTMAST      
            WHERE      
             COSTNAME = 'HO'      
           )      
        WHERE      
         COSTCODE = ''      
         AND BANK_CODE = @@BANK_CODE      
                            SET @@COSTCODEUPDATES = CURSOR FOR      
                                       SELECT      
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)      
                                       FROM      
                                             #RECPAY_TABLE WITH(NOLOCK)      
                                       WHERE      
          BANK_CODE = @@BANK_CODE      
                                       GROUP BY      
                                             SERIAL_NO      
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1      
                            OPEN @@COSTCODEUPDATES      
                            FETCH NEXT      
                             FROM      
                              @@COSTCODEUPDATES      
                             INTO      
                              @@SERIAL_NO,      
                              @@COSTCODECOUNT      
                            WHILE @@FETCH_STATUS = 0      
                             BEGIN      
          UPDATE      
           #RECPAY_TABLE      
            SET BANKCOST =      
             (      
              SELECT TOP 1      
               COSTCODE      
              FROM      
               COSTMAST      
              WHERE      
               COSTNAME = 'HO'      
             )      
          WHERE      
           (BANKCOST = ''   OR BANKCOST IS NULL)      
           AND BANK_CODE = @@BANK_CODE      
                                           AND SERIAL_NO = @@SERIAL_NO      
                              FETCH NEXT      
                               FROM      
                                @@COSTCODEUPDATES      
                               INTO      
                                @@SERIAL_NO,      
                                @@COSTCODECOUNT      
                             END      
                            CLOSE @@COSTCODEUPDATES      
                            DEALLOCATE @@COSTCODEUPDATES      
                  UPDATE      
                   #RECPAY_TABLE      
                    SET BANKCOST = COSTCODE      
            WHERE      
                   BANK_CODE = @@BANK_CODE      
                                        AND (BANKCOST = ''   OR BANKCOST IS NULL)      
       END      
     END      
    CREATE TABLE      
     #BANK_VNO      
     (      
      SRNO INT,      
      NEWSRNO INT IDENTITY (1, 1)      
     )      
    INSERT INTO      
     #BANK_VNO      
    SELECT      
     DISTINCT SERIAL_NO      
    FROM      
     #RECPAY_TABLE      
    WHERE      
     BANK_CODE = @@BANK_CODE      
     AND BOOKTYPE = @@BOOKTYPE      
      
   SELECT      
     @@MAXCOUNT = COUNT(DISTINCT SNO)      
    FROM      
     #RECPAY_TABLE      
      
    SELECT TOP 1      
     @@VDT = VDT      
    FROM      
     #RECPAY_TABLE      
    SELECT      
     LASTVNO      
    INTO #VNO      
    FROM      
     LASTVNO      
    WHERE      
     1 = 2      
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO      
    INSERT      
    INTO #VNO      
     EXEC ACC_GENVNO_NEW      
      @@VDT,      
      @@VTYP,      
      @@BOOKTYPE,      
      @@STD_DATE,      
      @@LST_DATE,      
      @@MAXVNO      
    SELECT      
     @@NEWVNO = LASTVNO      
    FROM      
     #VNO      
    UPDATE      
     RP      
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))      
    FROM      
     #RECPAY_TABLE RP,      
     #BANK_VNO BV      
    WHERE      
     RP.SERIAL_NO = BV.SRNO      
   DROP TABLE #VNO      
   DROP TABLE #BANK_VNO      
  FETCH NEXT      
   FROM @@VNOCUR      
   INTO      
    @@BANK_CODE,      
    @@BOOKTYPE      
 END      
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */      
UPDATE      
 #RECPAY_TABLE      
  SET LNO = 2      
WHERE      
 VNO IN      
  (      
   SELECT      
    VNO      
   FROM      
    #RECPAY_TABLE      
     WITH(NOLOCK)      
   GROUP BY      
    VNO      
   HAVING      
    COUNT(*) = 1      
  )      
SET @@LNOCUR = CURSOR FOR      
 SELECT      
  VNO      
 FROM      
  #RECPAY_TABLE      
   WITH(NOLOCK)      
 GROUP BY      
  VNO      
 HAVING      
  COUNT(*) > 1      
OPEN @@LNOCUR      
FETCH NEXT      
 FROM      
  @@LNOCUR      
 INTO      
  @@LNOVNO      
WHILE @@FETCH_STATUS = 0      
 BEGIN      
  CREATE TABLE      
   [#LNOGEN]      
    (      
     VNO VARCHAR(12),      
     SNO INT,      
     LNO INT IDENTITY(1,1)      
    )      
  INSERT INTO      
   #LNOGEN      
    SELECT      
     VNO,      
     SNO      
    FROM      
     #RECPAY_TABLE      
      WITH(NOLOCK)      
    WHERE      
     VNO = @@LNOVNO      
    ORDER BY      
     SNO      
  UPDATE      
   #RECPAY_TABLE      
    SET LNO = L.LNO + 1      
  FROM      
   #LNOGEN L      
  WHERE      
   #RECPAY_TABLE.VNO = L.VNO      
   AND #RECPAY_TABLE.SNO = L.SNO      
   AND #RECPAY_TABLE.LNO = 0      
  DROP TABLE #LNOGEN      
  FETCH NEXT      
   FROM      
    @@LNOCUR      
   INTO      
    @@LNOVNO      
 END      
CLOSE @@LNOCUR      
DEALLOCATE @@LNOCUR      
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */      
INSERT INTO      
 LEDGER1      
  (      
   BNKNAME,      
   BRNNAME,      
   DD,      
   DDNO,      
   DDDT,      
   RELDT,      
   RELAMT,      
   REFNO,      
   RECEIPTNO,      
   VTYP,      
   VNO,      
   LNO,      
   DRCR,      
   BOOKTYPE,      
   MICRNO,      
   SLIPNO,      
   SLIPDATE,      
   CHEQUEINNAME,      
   CHQPRINTED,      
   CLEAR_MODE      
  )      
SELECT      
 BNKNAME = MAX(BANK_NAME),      
 BRNNAME = MAX(BRANCH_NAME),      
 DD = MAX(CHQ_MODE),      
 DDNO = MAX(REF_NO),      
 DDDT = MAX(DDDT),      
 RELDT = '',      
 RELAMT = SUM(AMOUNT),      
 REFNO = 0,      
 RECEIPTNO = 0,      
 VTYP,      
 VNO,      
 LNO = 2,      
 DRCR,    
 BOOKTYPE = BOOKTYPE,      
 MICRNO = MICRNO,      
 SLIPNO = 0,      
 SLIPDATE = '',      
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),      
 CHQPRINTED = 0,      
 CLEAR_MODE = MAX(CL_MODE)      
FROM      
 #RECPAY_TABLE      
GROUP BY      
 VTYP,      
 VNO,      
 DRCR,      
 BOOKTYPE,    
 MICRNO    
      
IF @@ERROR <> 0      
 BEGIN      
  SELECT      
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE FROM V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
      
/*================================      
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK      
=================================*/      
CREATE TABLE #LEDGER      
(      
 VTYP SMALLINT,      
 VNO VARCHAR(12),      
 EDT DATETIME,      
 LNO SMALLINT,      
 ACNAME VARCHAR(100),      
 DRCR VARCHAR(1),      
 VAMT MONEY,      
 VDT DATETIME,      
 VNO1 VARCHAR(12),      
 REFNO CHAR(12),      
 BALAMT MONEY,      
 NODAYS INT,      
 CDT DATETIME,      
 CLTCODE VARCHAR(10),      
 BOOKTYPE VARCHAR(2),      
 ENTEREDBY VARCHAR(25),      
 PDT DATETIME,      
 CHECKEDBY VARCHAR(25),      
 ACTNODAYS INT,      
 NARRATION VARCHAR(234)      
)    --SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0      
CREATE TABLE #LEDGER3      
(      
 NARATNO INT,      
 NARR VARCHAR(234),      
 REFNO CHAR(12),      
 VTYP SMALLINT,      
 VNO VARCHAR(12),      
 BOOKTYPE VARCHAR(2)      
)      
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0      
/*==============================      
CLIENT SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER      
 (      
  VTYP,      
  VNO,      
  EDT,      
  LNO,      
  ACNAME,      
  DRCR,      
  VAMT,      
  VDT,      
  VNO1,      
  REFNO,      
  BALAMT,      
  NODAYS,      
  CDT,      
  CLTCODE,      
  BOOKTYPE,      
  ENTEREDBY,      
  PDT,      
  CHECKEDBY,      
  ACTNODAYS,      
  NARRATION      
 )      
SELECT      
 VTYP,      
 VNO,      
 EDT = edt,--(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),      
 LNO,      
 ACNAME,      
 DRCR,      
 VAMT = AMOUNT,      
 VDT,      
 VNO1 = VNO,      
 REFNO = 0,      
 BALAMT = AMOUNT,      
 NODAYS = 0,      
 CDT = GETDATE(),      
 CLTCODE = CLIENT_CODE,      
 BOOKTYPE = BOOKTYPE,      
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),      
 PDT = GETDATE(),      
 CHECKEDBY = @UNAME,      
 ACTNODAYS = 0,      
 NARRATION      
FROM      
 #RECPAY_TABLE      
/*==============================      
BANK SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER      
SELECT      
 VTYP,      
 VNO,      
 EDT = edt, --(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),      
 LNO = 1,      
 BANKNAME,      
 DRCR =      
  (      
   CASE      
    WHEN DRCR = 'D'      
    THEN 'C'      
    ELSE 'D'      
   END      
  ),      
 VAMT = SUM(AMOUNT),      
 VDT,      
 VNO1 = VNO,      
 REFNO = 0,      
 BALAMT = SUM(AMOUNT),      
 NODAYS = 0,      
 CDT = GETDATE(),      
 CLTCODE = BANK_CODE,      
 BOOKTYPE = BOOKTYPE,      
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),      
 PDT = GETDATE(),      
 CHECKEDBY = @UNAME,      
 ACTNODAYS = 0,      
 NARRATION = MAX(NARRATION)      
FROM      
 #RECPAY_TABLE      
GROUP BY      
 VTYP,      
 VNO,      
 EDT,      
 DRCR,      
 VDT,      
 BANK_CODE,      
 BOOKTYPE,      
 BANKNAME      
/*==============================      
INSERTING ALL LEDGER RECORDS AT ONE TIME      
==============================*/      

INSERT INTO LEDGER  SELECT      
 Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration      
FROM      
 #LEDGER      
ORDER BY      
 BOOKTYPE,      
 VTYP,      
 VNO,      
 LNO      
      
IF @@ERROR <> 0      
 BEGIN      
  SELECT      
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  DROP TABLE #LEDGER      
  DROP TABLE #LEDGER3      
  ROLLBACK TRAN      
  DELETE FROM V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
DROP TABLE #LEDGER      
/*==============================      
BANK SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER3      
SELECT      
 NARATNO = 1,      
 NARRATION = MAX(NARRATION),      
 REFNO = 0, 
 VTYP,      
 VNO,      
 BOOKTYPE      
FROM      
 #RECPAY_TABLE      
GROUP BY      
 VTYP,      
 VNO,      
 BOOKTYPE      
/*==============================      
CLIENT SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER3      
SELECT      
 NARATNO = LNO,      
 NARR = NARRATION,      
 REFNO = 0,      
 VTYP,      
 VNO,      
 BOOKTYPE      
FROM      
 #RECPAY_TABLE      
      
      
/*==============================      
INSERTING ALL LEDGER3 RECORDS AT ONE TIME      
==============================*/      
INSERT INTO LEDGER3      
SELECT      
 *      
FROM      
 #LEDGER3      
ORDER BY      
 BOOKTYPE,      
 VTYP,      
 VNO,      
 NARATNO      
      
IF @@ERROR <> 0      
 BEGIN      
  SELECT      
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  DROP TABLE #LEDGER3      
  ROLLBACK TRAN      
  DELETE FROM V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
DROP TABLE #LEDGER3      
      
      
IF @@BRANCHFLAG = 1      
 BEGIN      
  SET @@L2CUR = CURSOR FOR      
   SELECT DISTINCT      
    VNO      
   FROM      
    #RECPAY_TABLE      
   ORDER BY      
    VNO      
  OPEN @@L2CUR      
   FETCH NEXT      
   FROM      
    @@L2CUR      
   INTO      
    @@L2VNO      
  WHILE @@FETCH_STATUS = 0      
   BEGIN      
    DELETE FROM      
     TEMPLEDGER2      
    WHERE      
     SESSIONID = '9999999999'      
/*==============================      
CLIENT SIDE RECORD      
==============================*/      
    INSERT INTO      
     TEMPLEDGER2      
    SELECT      
     'BRANCH',      
     C.COSTNAME,      
     AMOUNT,      
     VTYP,      
     VNO,      
     LNO,      
     DRCR,      
     '0',      
     BOOKTYPE,      
     '9999999999',      
     CLIENT_CODE,      
     'A',      
     '0'      
    FROM      
     #RECPAY_TABLE RP,      
     COSTMAST C      
    WHERE      
     RP.COSTCODE = C.COSTCODE      
     AND VNO = @@L2VNO      
/*==============================      
BANK SIDE RECORD      
==============================*/      
    INSERT INTO      
     TEMPLEDGER2      
    SELECT      
     'BRANCH',      
     C.COSTNAME,      
     SUM(AMOUNT),      
     VTYP,      
     VNO,      
     LNO = 1,      
     DRCR =      
      (      
       CASE      
       WHEN DRCR = 'D'      
       THEN 'C'      
       ELSE 'D'      
       END      
      ),      
     '0',      
     BOOKTYPE,      
     '9999999999',      
     BANK_CODE,      
     'A',      
     '0'      
    FROM      
     #RECPAY_TABLE RP,      
     COSTMAST C      
    WHERE      
     RP.BANKCOST = C.COSTCODE      
     AND VNO = @@L2VNO      
    GROUP BY      
     C.COSTNAME,      
     VTYP,  
     VNO,      
      (      
       CASE      
       WHEN DRCR = 'D'      
       THEN 'C'      
       ELSE 'D'      
       END      
      ),      
     BANK_CODE,      
     BOOKTYPE      
    EXEC INSERTTOLEDGER2      
     '9999999999',      
     @@L2VNO,      
     '1',      
     '1',      
     '1',      
     'BROKER',      
     'BROKER'      
    FETCH NEXT      
     FROM      
      @@L2CUR      
     INTO      
      @@L2VNO      
   END      
  DELETE FROM      
   TEMPLEDGER2      
  WHERE      
   SESSIONID = '9999999999'      
  COMMIT TRAN      
 END      
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL      
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE      
DROP TABLE #RECPAY_TABLE_TMP      
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD_BULK_WACCNO
-- --------------------------------------------------
CREATE PROC [dbo].[RECPAYUPLOAD_BULK_WACCNO]          
 @FNAME VARCHAR(100),          
 @UNAME VARCHAR(25),          
 @USERCAT SMALLINT          
          
AS          
        
SET NOCOUNT ON          
        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/          
DECLARE          
 @@STD_DATE VARCHAR(11),          
 @@LST_DATE VARCHAR(11),          
 @@BRANCHFLAG AS TINYINT,          
 @@VNOFLAG AS TINYINT,          
 @@VNOMETHOD INT,          
 @@ACNAME CHAR(100),          
 @@BOOKTYPE CHAR(2),          
 @@MICRNO VARCHAR(10),          
 @@DRCR VARCHAR(1),          
 @@VTYP SMALLINT,          
 @@BANK_CODE VARCHAR(100),          
 @@BACKDAYS INT,          
 @@BACKDATE VARCHAR(11),          
 @@BRNCOUNT   TINYINT,          
 @@MonthlyVdt VARCHAR(11),          
 @@SERIAL_NO INT,          
 @@COSTCODECOUNT TINYINT,          
 @@COSTCODEUPDATES CURSOR,          
 @@NEWVNO AS VARCHAR(12),          
 @@MAXCOUNT AS INT,          
 @@VDT AS VARCHAR(11),          
 @@BANKBRANCH AS VARCHAR(10),          
 @@BANKCOST AS NUMERIC,          
 @@LNOCUR AS CURSOR,          
 @@VNOCUR AS CURSOR,          
 @@LNOVNO AS VARCHAR(12),          
 @@MAXVNO AS INT,          
 @@L2CUR AS CURSOR,          
 @@L2VNO AS VARCHAR(12),          
 @@ERROR_COUNT AS INT,          
 @@FILEEXISTS AS INT,          
 @@SQL AS VARCHAR(2000),        
 @@RECOFLAG AS CHAR(1)        
          
SELECT          
 @@ERROR_COUNT = COUNT(1)          
FROM          
(          
 SELECT          
  U_FILENAME          
 FROM          
  V2_UPLOADED_FILES          
 WHERE          
  U_FILENAME = @FNAME          
  AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
) A          
        
IF @@ERROR_COUNT > 0          
BEGIN          
 SELECT          
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'          
 RETURN          
END          
        
CREATE TABLE #FEXIST          
(          
 F1 SMALLINT,          
 F2 SMALLINT,          
 F3 SMALLINT          
)          
        
SELECT @@SQL = "INSERT INTO "          
SELECT @@SQL = @@SQL + " #FEXIST "          
SELECT @@SQL = @@SQL + " (F1, F2, F3) "          
SELECT @@SQL = @@SQL + " EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "          
          
EXEC(@@SQL)          
          
SELECT          
 @@FILEEXISTS = F1          
FROM          
 #FEXIST          
        
IF @@FILEEXISTS = 0          
BEGIN          
 DROP TABLE #FEXIST          
 SELECT          
  'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'          
 RETURN          
END          
        
DROP TABLE #FEXIST          
        
SELECT @@RECOFLAG = RECOFLAG FROM OWNER        
        
BEGIN TRAN          
        
CREATE TABLE #RECPAY_TABLE_TMP          
(          
 SERIAL_NO INT,          
 EDATE VARCHAR(20),          
 VOUCHER_DATE VARCHAR(20),          
 CLIENT_CODE VARCHAR(50),          
 AMOUNT MONEY,          
 DRCR VARCHAR(1),          
 NARRATION VARCHAR(234),          
 BANK_CODE VARCHAR(10),          
 BANK_NAME VARCHAR(100),          
 REF_NO VARCHAR(15),          
 BRANCHCODE VARCHAR(20),          
 BRANCH_NAME VARCHAR(50),          
 CHQ_MODE VARCHAR(1),          
 CHQ_DATE VARCHAR(20),          
 CHQ_NAME VARCHAR(100),          
 CL_MODE VARCHAR(1),          
 ACC_NO VARCHAR(20)          
)        
          
CREATE TABLE [#RECPAY_TABLE]          
(          
 SERIAL_NO INT,          
 EDATE VARCHAR(20),          
 VOUCHER_DATE VARCHAR(20),          
 CLIENT_CODE VARCHAR(50),          
 AMOUNT MONEY,          
 DRCR VARCHAR(1),          
 NARRATION VARCHAR(234),          
 BANK_CODE VARCHAR(10),          
 BANK_NAME VARCHAR(100),          
 REF_NO VARCHAR(15),          
 BRANCHCODE VARCHAR(20),          
 BRANCH_NAME VARCHAR(50),          
 CHQ_MODE VARCHAR(1),          
 CHQ_DATE VARCHAR(20),          
 CHQ_NAME VARCHAR(100),          
 CL_MODE VARCHAR(1),          
 ACC_NO VARCHAR(20),          
 SNO INT IDENTITY (1, 1) NOT NULL ,          
 VDT DATETIME NULL ,          
 FYSTART DATETIME NULL ,          
 FYEND DATETIME NULL ,      
 UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),          
 EDT DATETIME NULL ,          
 DDDT DATETIME NULL ,          
 VNO VARCHAR (12) NULL ,          
 VTYP SMALLINT NULL ,          
 ACNAME VARCHAR (100) NULL ,          
 COSTCODE SMALLINT NULL,          
 BANKCOST SMALLINT NULL,          
 LNO SMALLINT NOT NULL DEFAULT(0),          
 BANKNAME VARCHAR(100) NULL,          
 MICRNO INT NULL,          
 BOOKTYPE VARCHAR(2) NULL,          
) ON [PRIMARY]          
        
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "          
EXEC (@@SQL)          
        
IF @@ERROR <> 0          
BEGIN          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRANSACTION          
 SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'          
 RETURN          
END          
        
INSERT INTO          
 V2_UPLOADED_FILES          
SELECT          
 @FNAME,          
 @FNAME,          
 CNT = COUNT(1),          
 'B',          
 GETDATE(),          
 @UNAME,          
 'RECEIPT/PAYMENT UPLOAD'          
          

INSERT INTO          
#RECPAY_TABLE          
(          
 SERIAL_NO,          
 EDATE,          
 VOUCHER_DATE,          
 CLIENT_CODE,          
 AMOUNT,          
 DRCR,          
 NARRATION,          
 BANK_CODE,          
 BANK_NAME,          
 REF_NO,          
 BRANCHCODE,          
 BRANCH_NAME,          
 CHQ_MODE,          
 CHQ_DATE,          
 CHQ_NAME,          
 CL_MODE,          
 ACC_NO          
)          
SELECT          
 SERIAL_NO,          
 EDATE,          
 VOUCHER_DATE,          
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),          
 AMOUNT,          
 UPPER(LTRIM(RTRIM(DRCR))),          
 NARRATION,          
 UPPER(LTRIM(RTRIM(BANK_CODE))),          
 UPPER(LTRIM(RTRIM(BANK_NAME))),          
 REF_NO,          
 UPPER(LTRIM(RTRIM(BRANCHCODE))),          
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),          
 UPPER(LTRIM(RTRIM(CHQ_MODE))),          
 CHQ_DATE,          
 CHQ_NAME,          
 CL_MODE,          
 ACC_NO          
FROM          
 #RECPAY_TABLE_TMP          
        
SELECT TOP 1 @@VDT = VOUCHER_DATE FROM #RECPAY_TABLE_TMP          
       
UPDATE          
 #RECPAY_TABLE          
SET          
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),          
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),          
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))          
      
SELECT TOP 1          
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)          
FROM          
 #RECPAY_TABLE      
         
SELECT          
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),          
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),          
 @@BRANCHFLAG = BRANCHFLAG,          
 @@VNOFLAG = VNOFLAG          
FROM          
 PARAMETER          
WHERE          
 @@VDT BETWEEN SDTCUR AND LDTCUR          
         
IF @@VNOFLAG <> 0          
BEGIN          
 SELECT          
  @@ERROR_COUNT = COUNT(DISTINCT VDT)          
 FROM          
  #RECPAY_TABLE          
        
 IF @@ERROR_COUNT > 1          
 BEGIN          
  DROP TABLE #RECPAY_TABLE_TMP          
  DROP TABLE #RECPAY_TABLE          
  ROLLBACK TRANSACTION          
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'          
  RETURN          
 END          
END          
          
IF @@BRANCHFLAG = 1          
BEGIN          
 UPDATE          
  #RECPAY_TABLE          
 SET          
  BRANCHCODE = A.BRANCHCODE,          
  FYSTART = P.SDTCUR,          
  FYEND = P.LDTCUR,          
  UPDFLAG = 'Y',          
  ACNAME = A.LONGNAME,          
  COSTCODE = C.COSTCODE,          
  BANKNAME = B.LONGNAME,          
  BOOKTYPE = B.BOOKTYPE,          
  MICRNO = ISNULL(B.MICRNO, 0)          
 FROM          
  ACMAST A,         
  PARAMETER P,         
  COSTMAST C,         
  ACMAST B          
 WHERE          
  A.CLTCODE = CLIENT_CODE          
  AND B.CLTCODE = BANK_CODE          
  AND P.CURYEAR = 1          
  AND A.ACCAT IN ('3','4')          
  AND B.ACCAT = '2'          
  AND A.BRANCHCODE = COSTNAME          
         
 UPDATE          
  #RECPAY_TABLE          
 SET          
  VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),          
  DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),          
  EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),          
  FYSTART = P.SDTCUR,          
  FYEND = P.LDTCUR,          
  UPDFLAG = 'Y',     
  ACNAME = A.LONGNAME,          
  COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,          
  BANKNAME = B.LONGNAME,          
  BOOKTYPE = B.BOOKTYPE,          
  MICRNO = ISNULL(B.MICRNO, 0)          
 FROM          
  ACMAST A,         
  PARAMETER P,         
  COSTMAST C,         
  ACMAST B          
 WHERE          
  A.CLTCODE = CLIENT_CODE          
  AND B.CLTCODE = BANK_CODE          
  AND P.CURYEAR = 1          
  AND A.ACCAT IN ('3','4')          
  AND B.ACCAT = '2'          
  AND A.BRANCHCODE = 'ALL'          
  AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'          
         
 UPDATE          
  #RECPAY_TABLE          
 SET          
  BRANCHCODE = 'HO',          
  VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),          
  DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),          
  EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),          
  FYSTART = P.SDTCUR,          
  FYEND = P.LDTCUR,          
  UPDFLAG = 'Y',          
  ACNAME = A.LONGNAME,          
  COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,          
  BANKNAME = B.LONGNAME,          
  BOOKTYPE = B.BOOKTYPE,          
  MICRNO = ISNULL(B.MICRNO, 0)          
 FROM          
  ACMAST A,         
  PARAMETER P,         
  COSTMAST C,         
  ACMAST B          
 WHERE          
  A.CLTCODE = CLIENT_CODE          
  AND B.CLTCODE = BANK_CODE          
  AND P.CURYEAR = 1          
  AND A.ACCAT IN ('3','4')          
  AND B.ACCAT = '2'          
  AND A.BRANCHCODE = 'ALL'          
  AND #RECPAY_TABLE.BRANCHCODE = 'ALL'          
END          
ELSE          
BEGIN          
 UPDATE          
  #RECPAY_TABLE          
 SET          
  FYSTART = @@STD_DATE,          
  FYEND = @@LST_DATE + ' 23:59:59',          
  UPDFLAG = 'Y',          
  ACNAME = A.LONGNAME,          
  BANKNAME = B.LONGNAME,          
  BOOKTYPE = B.BOOKTYPE,          
  MICRNO = ISNULL(B.MICRNO, 0)          
 FROM          
  ACMAST A,         
  ACMAST B          
 WHERE          
  A.CLTCODE = CLIENT_CODE          
  AND B.CLTCODE = BANK_CODE          
  AND A.ACCAT IN ('3','4')          
  AND B.ACCAT = '2'          
END          
          
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */          
/*          
SELECT          
 @@ERROR_COUNT = COUNT(DISTINCT VDT)          
FROM          
 #RECPAY_TABLE          
        
IF @@ERROR_COUNT > 1          
BEGIN          
 SELECT          
  'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRAN          
 DELETE          
 FROM          
  V2_UPLOADED_FILES          
 WHERE          
  U_FILENAME = @FNAME          
  AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END          
SELECT @@ERROR_COUNT = 0          
*/        
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/          
/*          
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)          
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1          
IF @@ERROR_COUNT > 0          
BEGIN          
 SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'          
 DROP TABLE #RecPay_Table_Tmp          
 DROP TABLE #RecPay_Table          
 ROLLBACK TRAN          
 DELETE FROM V2_Uploaded_Files          
 WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END*/          
          
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */          
SELECT          
 @@ERROR_COUNT = COUNT(1)          
FROM          
(          
 SELECT          
 BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),          
 SERIAL_NO          
 FROM          
 #RECPAY_TABLE          
 GROUP BY          
 SERIAL_NO          
 HAVING          
 COUNT(DISTINCT BANK_CODE) > 1          
) A          
        
IF @@ERROR_COUNT > 0          
BEGIN          
 SELECT          
  RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'          
 UNION ALL          
 SELECT          
  RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))          
 FROM          
  #RECPAY_TABLE          
 GROUP BY          
  SERIAL_NO          
 HAVING          
  COUNT(DISTINCT BANK_CODE) > 1          
          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRAN          
 DELETE          
 FROM          
 V2_UPLOADED_FILES          
 WHERE          
 U_FILENAME = @FNAME          
 AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END          
        
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */          
SELECT          
 @@ERROR_COUNT = COUNT(1)          
FROM          
 (          
 SELECT DISTINCT          
  DRCR          
 FROM          
  #RECPAY_TABLE          
 ) A          
        
IF @@ERROR_COUNT > 1          
BEGIN          
 SELECT          
  'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRAN          
 DELETE          
 FROM          
  V2_UPLOADED_FILES          
 WHERE          
  U_FILENAME = @FNAME          
  AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END          
ELSE          
BEGIN          
 SELECT TOP 1          
  @@DRCR = DRCR,          
  @@VTYP =          
  (          
  CASE          
   WHEN DRCR = 'D'          
    THEN 3          
    ELSE 2          
  END          
  )          
 FROM          
  #RECPAY_TABLE          
         
 UPDATE          
  #RECPAY_TABLE          
 SET VTYP =          
 (          
 CASE          
  WHEN DRCR = 'D'          
   THEN 3          
   ELSE 2          
 END          
 )          
END          
        
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/          
SELECT @@ERROR_COUNT = COUNT(1)          
FROM #RECPAY_TABLE          
WHERE VDT > EDT          
IF @@ERROR_COUNT > 0          
BEGIN          
 SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRAN          
 DELETE FROM          
  V2_UPLOADED_FILES          
 WHERE          
  U_FILENAME = @FNAME          
  AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END          
        
/*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/          
SELECT @@ERROR_COUNT = COUNT(1)          
FROM #RECPAY_TABLE          
WHERE AMOUNT <= 0          
IF @@ERROR_COUNT > 0          
BEGIN          
 SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRAN          
 DELETE FROM          
  V2_UPLOADED_FILES          
 WHERE          
  U_FILENAME = @FNAME          
  AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END          
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */          
 SELECT @@ERROR_COUNT = COUNT(1)            
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,            
                          CLTCODE = RP.CLIENT_CODE            
   FROM   #RECPAY_TABLE RP,            
                 LEDGER L WITH(NOLOCK),            
                 LEDGER1 L1 WITH(NOLOCK)            
          WHERE  L1.DDNO = RP.REF_NO            
                 AND L1.DD = RP.CHQ_MODE            
                 AND L1.DRCR = @@DRCR            
                 AND L1.VTYP = @@VTYP            
                 AND RP.REF_NO <> 0            
                 AND L.VTYP = @@VTYP            
                 AND L.VNO = L1.VNO            
                 AND L.BOOKTYPE = L1.BOOKTYPE            
                 AND L.DRCR = @@DRCR            
                 AND L.CLTCODE = RP.CLIENT_CODE) A            
              
/*  
-- MODIFIED BY UPPILI ON JAN 23 2008  
  
SELECT          
 @@ERROR_COUNT = COUNT(1)          
FROM          
(          
 SELECT DISTINCT          
  DDNO  = RP.REF_NO          
 FROM          
  #RECPAY_TABLE RP,          
  LEDGER1 L1          
 WITH(NOLOCK)          
 WHERE          
  L1.DDNO = RP.REF_NO     
  AND L1.BNKNAME = RP.BANK_NAME         
  AND L1.DD = RP.CHQ_MODE          
  AND L1.DRCR = @@DRCR          
  AND L1.VTYP = @@VTYP          
  AND RP.REF_NO <> 0          
) A      
*/  
      
IF @@ERROR_COUNT > 0          
BEGIN          
 SELECT          
  'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'          
 UNION ALL  
  
SELECT DISTINCT RP.REF_NO, 'NA','NA'            
   FROM   #RECPAY_TABLE RP,            
                 LEDGER L WITH(NOLOCK),            
                 LEDGER1 L1 WITH(NOLOCK)            
          WHERE  L1.DDNO = RP.REF_NO            
                 AND L1.DD = RP.CHQ_MODE            
                 AND L1.DRCR = @@DRCR            
                 AND L1.VTYP = @@VTYP            
                 AND RP.REF_NO <> 0            
                 AND L.VTYP = @@VTYP            
                 AND L.VNO = L1.VNO            
                 AND L.BOOKTYPE = L1.BOOKTYPE            
                 AND L.DRCR = @@DRCR            
                 AND L.CLTCODE = RP.CLIENT_CODE          
/*  
 SELECT DISTINCT          
  RP.REF_NO, 'NA','NA'          
 FROM          
  #RECPAY_TABLE RP,          
  LEDGER1 L1          
  WITH(NOLOCK)          
 WHERE          
  L1.DDNO = RP.REF_NO          
  AND L1.DD = RP.CHQ_MODE          
  AND L1.DRCR = @@DRCR          
  AND L1.VTYP = @@VTYP          
  AND RP.CHQ_MODE <> 'N'     
*/  
  
       
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRAN          
 DELETE FROM          
  V2_UPLOADED_FILES          
 WHERE          
  U_FILENAME = @FNAME          
  AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END          
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/          
SELECT          
 @@ERROR_COUNT = COUNT(1)          
FROM          
(          
 SELECT DISTINCT          
  CLIENT_CODE          
 FROM          
  #RECPAY_TABLE          
 WHERE          
  UPDFLAG = 'N'          
) A          
IF @@ERROR_COUNT > 0          
BEGIN          
 SELECT          
  'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'          
 UNION ALL          
 SELECT DISTINCT          
  CLIENT_CODE, 'NA','NA'          
 FROM          
  #RECPAY_TABLE          
 WHERE          
  UPDFLAG = 'N'          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRAN          
 DELETE FROM          
  V2_UPLOADED_FILES          
 WHERE          
  U_FILENAME = @FNAME          
  AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END          
/*    --------------------------AUTO GENERATION OF VNO ------------------------ */          
SET @@VNOCUR = CURSOR FOR          
SELECT DISTINCT          
 BANK_CODE,          
 BOOKTYPE          
FROM          
 #RECPAY_TABLE WITH(NOLOCK)          
OPEN @@VNOCUR          
FETCH NEXT          
FROM          
 @@VNOCUR          
INTO       @@BANK_CODE,          
 @@BOOKTYPE          
WHILE @@FETCH_STATUS = 0          
BEGIN          
 /*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/          
 /*    SELECT          
 @@BACKDAYS = ISNULL(MAX(NODAYS), 0)          
 FROM          
 USERWRITESTABLE          
 WHERE          
 USERCATEGORY = @USERCAT          
 AND VTYP = @@VTYP          
 AND BOOKTYPE = @@BOOKTYPE          
 SELECT          
 @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS          
 SELECT          
 @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)          
 FROM          
 #RECPAY_TABLE          
 WHERE          
 VDT < @@BACKDATE          
 IF @@ERROR_COUNT > 0          
 BEGIN          
 SELECT          
 'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRAN          
 DELETE FROM V2_UPLOADED_FILES          
 WHERE          
 U_FILENAME = @FNAME          
 AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
 END*/          
 IF @@BRANCHFLAG = 1          
 BEGIN          
  SELECT          
  @@BANKBRANCH = BRANCHCODE,          
  @@BANKCOST = ISNULL(C.COSTCODE, -1)          
  FROM          
  ACMAST A          
  LEFT OUTER JOIN          
  COSTMAST C          
  ON          
  (          
  A.BRANCHCODE = C.COSTNAME          
  )          
  WHERE          
  A.CLTCODE = @@BANK_CODE          
  IF @@BANKBRANCH <> 'ALL'          
  BEGIN          
   UPDATE          
    RP          
   SET COSTCODE = @@BANKCOST          
   FROM          
    #RECPAY_TABLE RP,          
    ACMAST A          
   WHERE          
    A.CLTCODE = RP.CLIENT_CODE          
    AND A.BRANCHCODE = 'ALL'          
   UPDATE          
    #RECPAY_TABLE          
   SET BANKCOST = @@BANKCOST          
   WHERE          
    BANK_CODE = @@BANK_CODE          
  END          
  ELSE          
  BEGIN          
   UPDATE          
   #RECPAY_TABLE          
   SET COSTCODE =          
   (          
    SELECT TOP 1          
     COSTCODE          
    FROM          
     COSTMAST          
    WHERE          
     COSTNAME = 'HO'          
   )          
   WHERE          
    COSTCODE = ''          
    AND BANK_CODE = @@BANK_CODE          
   SET @@COSTCODEUPDATES = CURSOR FOR          
   SELECT          
    SERIAL_NO, COUNT(DISTINCT COSTCODE)          
   FROM          
    #RECPAY_TABLE WITH(NOLOCK)          
   WHERE          
    BANK_CODE = @@BANK_CODE          
   GROUP BY          
    SERIAL_NO          
   HAVING COUNT(DISTINCT COSTCODE)  > 1          
   OPEN @@COSTCODEUPDATES          
   FETCH NEXT          
   FROM          
    @@COSTCODEUPDATES          
   INTO          
    @@SERIAL_NO,          
    @@COSTCODECOUNT          
   WHILE @@FETCH_STATUS = 0          
   BEGIN          
    UPDATE          
     #RECPAY_TABLE          
    SET BANKCOST =          
    (      
    SELECT TOP 1          
     COSTCODE          
    FROM          
     COSTMAST          
    WHERE          
     COSTNAME = 'HO'          
    )          
    WHERE          
     (BANKCOST = ''   OR BANKCOST IS NULL)          
     AND BANK_CODE = @@BANK_CODE          
     AND SERIAL_NO = @@SERIAL_NO          
    FETCH NEXT          
    FROM          
     @@COSTCODEUPDATES          
    INTO          
     @@SERIAL_NO,          
     @@COSTCODECOUNT          
   END          
   CLOSE @@COSTCODEUPDATES          
   DEALLOCATE @@COSTCODEUPDATES          
   UPDATE          
   #RECPAY_TABLE          
   SET BANKCOST = COSTCODE          
   WHERE          
   BANK_CODE = @@BANK_CODE          
   AND (BANKCOST = ''   OR BANKCOST IS NULL)          
  END          
 END          
 CREATE TABLE          
  #BANK_VNO          
 (          
  SRNO INT,          
  NEWSRNO INT IDENTITY (1, 1)          
 )          
 INSERT INTO          
  #BANK_VNO          
 SELECT          
 DISTINCT SERIAL_NO          
 FROM          
  #RECPAY_TABLE          
 WHERE          
  BANK_CODE = @@BANK_CODE          
  AND BOOKTYPE = @@BOOKTYPE          
         
 SELECT          
  @@MAXCOUNT = COUNT(DISTINCT SNO)          
 FROM          
  #RECPAY_TABLE          
         
 SELECT TOP 1          
  @@VDT = VDT          
 FROM          
  #RECPAY_TABLE          
 SELECT          
  LASTVNO          
 INTO #VNO          
 FROM          
  LASTVNO          
 WHERE          
  1 = 2          
 SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO          
 INSERT          
 INTO #VNO          
 EXEC ACC_GENVNO_NEW          
  @@VDT,          
  @@VTYP,          
  @@BOOKTYPE,          
  @@STD_DATE,          
  @@LST_DATE,          
  @@MAXVNO          
 SELECT          
  @@NEWVNO = LASTVNO          
 FROM          
  #VNO          
 UPDATE          
  RP          
 SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))          
 FROM          
  #RECPAY_TABLE RP,          
  #BANK_VNO BV          
 WHERE          
  RP.SERIAL_NO = BV.SRNO          
 DROP TABLE #VNO          
 DROP TABLE #BANK_VNO          
 FETCH NEXT          
 FROM @@VNOCUR          
 INTO          
 @@BANK_CODE,          
 @@BOOKTYPE          
END          
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */          
UPDATE          
 #RECPAY_TABLE          
SET LNO = 2          
WHERE          
 VNO IN          
 (          
  SELECT          
   VNO          
  FROM          
   #RECPAY_TABLE          
  WITH(NOLOCK)          
  GROUP BY          
   VNO          
  HAVING          
  COUNT(*) = 1          
 )          
SET @@LNOCUR = CURSOR FOR          
SELECT          
 VNO          
FROM          
 #RECPAY_TABLE          
WITH(NOLOCK)          
GROUP BY          
 VNO          
HAVING          
 COUNT(*) > 1          
OPEN @@LNOCUR          
FETCH NEXT          
FROM          
 @@LNOCUR          
INTO          
 @@LNOVNO          
WHILE @@FETCH_STATUS = 0          
BEGIN          
 CREATE TABLE          
 [#LNOGEN]          
 (          
  VNO VARCHAR(12),          
  SNO INT,          
  LNO INT IDENTITY(1,1)          
 )          
 INSERT INTO          
  #LNOGEN          
 SELECT          
  VNO,          
  SNO          
 FROM          
  #RECPAY_TABLE          
 WITH(NOLOCK)          
 WHERE          
  VNO = @@LNOVNO          
 ORDER BY          
  SNO          
 UPDATE          
  #RECPAY_TABLE          
 SET LNO = L.LNO + 1          
 FROM          
  #LNOGEN L          
 WHERE          
  #RECPAY_TABLE.VNO = L.VNO          
  AND #RECPAY_TABLE.SNO = L.SNO          
  AND #RECPAY_TABLE.LNO = 0          
 DROP TABLE #LNOGEN          
 FETCH NEXT          
 FROM          
  @@LNOCUR          
 INTO          
  @@LNOVNO          
END          
CLOSE @@LNOCUR          
DEALLOCATE @@LNOCUR          
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */          
INSERT INTO          
LEDGER1          
(          
 BNKNAME,          
 BRNNAME,          
 DD,          
 DDNO,          
 DDDT,          
 RELDT,          
 RELAMT,         
 REFNO,          
 RECEIPTNO,          
 VTYP,          
 VNO,          
 LNO,          
 DRCR,         
 BOOKTYPE,          
 MICRNO,          
 SLIPNO,          
 SLIPDATE,          
 CHEQUEINNAME,          
 CHQPRINTED,          
 CLEAR_MODE          
)          
SELECT          
 BNKNAME = MAX(BANK_NAME),          
 BRNNAME = MAX(BRANCH_NAME),          
 DD = MAX(CHQ_MODE),          
 DDNO = MAX(REF_NO),          
 DDDT = MAX(DDDT),          
 RELDT = '',          
 RELAMT = SUM(AMOUNT),          
 REFNO = 0,          
 RECEIPTNO = 0,          
 VTYP,          
 VNO,          
 LNO = 2,          
 DRCR,          
 BOOKTYPE = BOOKTYPE,          
 MICRNO = MICRNO,          
 SLIPNO = 0,          
 SLIPDATE = '',          
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),          
 CHQPRINTED = 0,          
 CLEAR_MODE = MAX(CL_MODE)          
FROM          
 #RECPAY_TABLE          
GROUP BY          
 VTYP,          
 VNO,          
 DRCR,          
 BOOKTYPE,          
 MICRNO          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT          
  'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRAN          
 DELETE FROM V2_UPLOADED_FILES          
 WHERE          
  U_FILENAME = @FNAME          
  AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END          
          
/*================================          
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK          
=================================*/          
CREATE TABLE #LEDGER          
(          
 VTYP SMALLINT,          
 VNO VARCHAR(12),          
 EDT DATETIME,          
 LNO SMALLINT,          
 ACNAME VARCHAR(100),          
 DRCR VARCHAR(1),          
 VAMT MONEY,          
 VDT DATETIME,          
 VNO1 VARCHAR(12),          
 REFNO CHAR(12),          
 BALAMT MONEY,          
 NODAYS INT,          
 CDT DATETIME,          
 CLTCODE VARCHAR(10),          
 BOOKTYPE VARCHAR(2),          
 ENTEREDBY VARCHAR(25),          
 PDT DATETIME,          
 CHECKEDBY VARCHAR(25),          
 ACTNODAYS INT,          
 NARRATION VARCHAR(234)          
)          
--SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0          
CREATE TABLE #LEDGER3          
(          
 NARATNO INT,          
 NARR VARCHAR(234),          
 REFNO CHAR(12),          
 VTYP SMALLINT,          
 VNO VARCHAR(12),          
 BOOKTYPE VARCHAR(2)          
)          
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0          
/*==============================          
CLIENT SIDE RECORD          
==============================*/          
INSERT INTO          
#LEDGER          
(          
 VTYP,          
 VNO,          
 EDT,          
 LNO,          
 ACNAME,          
 DRCR,          
 VAMT,          
 VDT,          
 VNO1,          
 REFNO,          
 BALAMT,          
 NODAYS,          
 CDT,          
 CLTCODE,          
 BOOKTYPE,          
 ENTEREDBY,          
 PDT,          
 CHECKEDBY,          
 ACTNODAYS,          
 NARRATION          
)          
SELECT          
 VTYP,          
 VNO,          
 EDT = (CASE WHEN VTYP = 2 AND @@RECOFLAG = 'Y' THEN 'DEC 31 2049' ELSE EDT END),          
 LNO,          
 ACNAME,          
 DRCR,          
 VAMT = AMOUNT,          
 VDT,          
 VNO1 = VNO,          
 REFNO = 0,          
 BALAMT = AMOUNT,          
 NODAYS = 0,          
 CDT = GETDATE(),          
 CLTCODE = CLIENT_CODE,          
 BOOKTYPE = BOOKTYPE,          
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),          
 PDT = GETDATE(),          
 CHECKEDBY = @UNAME,          
 ACTNODAYS = 0,          
 NARRATION          
FROM          
 #RECPAY_TABLE          
/*==============================          
BANK SIDE RECORD          
==============================*/          
INSERT INTO          
 #LEDGER          
SELECT          
 VTYP,          
 VNO,          
 EDT = (CASE WHEN VTYP = 2 AND @@RECOFLAG = 'Y' THEN 'DEC 31 2049' ELSE EDT END),          
 LNO = 1,          
 BANKNAME,          
 DRCR =          
 (          
 CASE          
 WHEN DRCR = 'D'          
 THEN 'C'          
 ELSE 'D'          
 END          
 ),          
 VAMT = SUM(AMOUNT),          
 VDT,          
 VNO1 = VNO,          
 REFNO = 0,          
 BALAMT = SUM(AMOUNT),          
 NODAYS = 0,          
 CDT = GETDATE(),          
 CLTCODE = BANK_CODE,          
 BOOKTYPE = BOOKTYPE,          
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),          
 PDT = GETDATE(),          
 CHECKEDBY = @UNAME,          
 ACTNODAYS = 0,          
 NARRATION = MAX(NARRATION)          
FROM          
 #RECPAY_TABLE          
GROUP BY          
 VTYP,          
 VNO,          
 EDT,          
 DRCR,          
 VDT,          
 BANK_CODE,          
 BOOKTYPE,          
 BANKNAME          
/*==============================          
INSERTING ALL LEDGER RECORDS AT ONE TIME          
==============================*/          
INSERT INTO LEDGER          
 (Vtyp, Vno, Edt, Lno, Acname, Drcr, Vamt, Vdt, Vno1, Refno, Balamt, Nodays, Cdt, Cltcode, Booktype, Enteredby, Pdt, Checkedby, Actnodays, Narration)          
SELECT          
 Vtyp, Vno, Edt, Lno, Acname, Drcr, Vamt, Vdt, Vno1, Refno, Balamt, Nodays, Cdt, Cltcode, Booktype, Enteredby, Pdt, Checkedby, Actnodays, Narration          
FROM          
 #LEDGER          
ORDER BY          
 BOOKTYPE,          
 VTYP,          
 VNO,          
 LNO          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT          
  'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 DROP TABLE #LEDGER          
 DROP TABLE #LEDGER3          
 ROLLBACK TRAN          
 DELETE FROM V2_UPLOADED_FILES          
 WHERE          
  U_FILENAME = @FNAME          
  AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END          
DROP TABLE #LEDGER          
/*==============================          
BANK SIDE RECORD          
==============================*/          
INSERT INTO          
 #LEDGER3          
SELECT          
 NARATNO = 1,          
 NARRATION = MAX(NARRATION),          
 REFNO = 0,          
 VTYP,          
 VNO,          
 BOOKTYPE          
FROM          
 #RECPAY_TABLE          
GROUP BY          
 VTYP,          
 VNO,          
 BOOKTYPE          
/*==============================          
CLIENT SIDE RECORD          
==============================*/          
INSERT INTO          
 #LEDGER3          
SELECT          
 NARATNO = LNO,          
 NARR = NARRATION,          
 REFNO = 0,          
 VTYP,          
 VNO,          
 BOOKTYPE          
FROM          
 #RECPAY_TABLE          
        
        
/*==============================          
INSERTING ALL LEDGER3 RECORDS AT ONE TIME          
==============================*/          
INSERT INTO LEDGER3          
 (NARATNO, NARR, REFNO, VTYP, VNO, BOOKTYPE)          
SELECT          
 NARATNO, NARR, REFNO, VTYP, VNO, BOOKTYPE          
FROM          
 #LEDGER3          
ORDER BY          
 BOOKTYPE,          
 VTYP,          
 VNO,          
 NARATNO          
          
IF @@ERROR <> 0          
BEGIN          
 SELECT          
  'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 DROP TABLE #LEDGER3          
 ROLLBACK TRAN          
 DELETE FROM V2_UPLOADED_FILES          
 WHERE          
  U_FILENAME = @FNAME          
  AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'          
 RETURN          
END          
DROP TABLE #LEDGER3          
          
          
IF @@BRANCHFLAG = 1          
BEGIN          
 SET @@L2CUR = CURSOR FOR          
 SELECT DISTINCT          
  VNO          
 FROM          
  #RECPAY_TABLE          
 ORDER BY          
  VNO          
 OPEN @@L2CUR          
 FETCH NEXT          
 FROM          
  @@L2CUR          
 INTO          
  @@L2VNO          
 WHILE @@FETCH_STATUS = 0          
 BEGIN          
 DELETE FROM          
  TEMPLEDGER2          
 WHERE          
  SESSIONID = '9999999999'          
 /*==============================          
 CLIENT SIDE RECORD          
 ==============================*/          
 INSERT INTO          
  TEMPLEDGER2          
 SELECT          
  'BRANCH',          
  C.COSTNAME,          
  AMOUNT,          
  VTYP,          
  VNO,          
  LNO,          
  DRCR,          
  '0',          
  BOOKTYPE,          
  '9999999999',          
  CLIENT_CODE,          
  'A',          
  '0'          
 FROM          
  #RECPAY_TABLE RP,          
  COSTMAST C          
 WHERE          
  RP.COSTCODE = C.COSTCODE          
  AND VNO = @@L2VNO          
 /*==============================          
 BANK SIDE RECORD          
 ==============================*/          
 INSERT INTO          
  TEMPLEDGER2          
 SELECT          
  'BRANCH',          
  C.COSTNAME,          
  SUM(AMOUNT),          
  VTYP,          
  VNO,          
  LNO = 1,          
  DRCR =          
  (          
  CASE          
  WHEN DRCR = 'D'          
  THEN 'C'          
  ELSE 'D'          
  END          
  ),          
  '0',          
  BOOKTYPE,          
  '9999999999',          
  BANK_CODE,          
  'A',        
  '0'          
 FROM          
  #RECPAY_TABLE RP,          
  COSTMAST C          
 WHERE          
  RP.BANKCOST = C.COSTCODE          
  AND VNO = @@L2VNO          
 GROUP BY          
  C.COSTNAME,          
  VTYP,          
  VNO,          
  (          
  CASE          
  WHEN DRCR = 'D'          
  THEN 'C'          
  ELSE 'D'          
  END          
  ),          
  BANK_CODE,          
  BOOKTYPE          
         
 EXEC INSERTTOLEDGER2          
  '9999999999',          
  @@L2VNO,          
  '1',          
  '1',          
  '1',          
  'BROKER',          
  'BROKER'          
 FETCH NEXT          
 FROM          
  @@L2CUR          
 INTO          
  @@L2VNO          
 END          
 DELETE FROM          
  TEMPLEDGER2          
 WHERE          
  SESSIONID = '9999999999'          
END          
        
IF @@VTYP = 2          
BEGIN          
 INSERT INTO THIRDPARTY_COLLECTION          
  (VNO, VTYP, BOOKTYPE, CLTCODE, AMOUNT, VDT, DDNO, ACCOUNT_NO, TPR_FLAG)          
 SELECT          
  VNO,          
  VTYP,          
  BOOKTYPE,          
  CLIENT_CODE,          
  AMOUNT,          
  VDT,       MAX(REF_NO),          
  ACC_NO,          
  TPR_FLAG = 'S'          
 FROM          
  #RECPAY_TABLE          
 GROUP BY          
  VNO,          
  VTYP,          
  BOOKTYPE,          
  CLIENT_CODE,          
  AMOUNT,          
  VDT,          
  ACC_NO          
         
 UPDATE T          
 SET TPR_FLAG = 'C'          
 FROM THIRDPARTY_COLLECTION T, MULTIBANKID M, #RecPay_Table R          
 WHERE          
  T.CLTCODE = M.CLTCODE          
  AND M.ACCNO = T.ACCOUNT_NO          
  AND T.VNO = R.VNO AND T.VTYP = R.VTYP AND T.BOOKTYPE = R.BOOKTYPE          
END        
          
COMMIT TRAN          
          
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL          
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE          
DROP TABLE #RECPAY_TABLE_TMP          
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Remisssor_Billposting
-- --------------------------------------------------
CREATE PROC [dbo].[Remisssor_Billposting]

	@VTYPE SMALLINT,
	@BOOKTYPE VARCHAR(2),
	@VDT VARCHAR(11),
	@EDTDR VARCHAR(11),
	@EDTCR VARCHAR(11),
	@CDT VARCHAR(11),    
	@PDT VARCHAR(11),    
	@ENTEREDBY VARCHAR(25),    
	@CHECKEDBY VARCHAR(25),    
	@SETT_NO VARCHAR(7),    
	@SETT_TYPE VARCHAR(3),    
	@UNAME VARCHAR(25),
	@ACC_SERVER1 VARCHAR(15),
	@ACC_DB1 VARCHAR(15),
	@VNO1 VARCHAR(12),
	@EXCHANGE1 VARCHAR(10),
	@OVNO1 VARCHAR(12) = '',  
	@ACC_SERVER2 VARCHAR(15),
	@ACC_DB2 VARCHAR(15),
	@VNO2 VARCHAR(12),
	@EXCHANGE2 VARCHAR(10),
	@OVNO2 VARCHAR(12) = '',  
	@ACC_SERVER3 VARCHAR(15),
	@ACC_DB3 VARCHAR(15),
	@VNO3 VARCHAR(12),
	@EXCHANGE3 VARCHAR(10),
	@OVNO3 VARCHAR(12) = ''  
AS

DECLARE 
	@@SQL VARCHAR(1000)

BEGIN TRANSACTION


	SET @@SQL = "EXEC " + @ACC_SERVER1 + "." + @ACC_DB1 + ".DBO.NEWPOSTBILL_REM " + CONVERT(VARCHAR, @VTYPE) + ",'" + @BOOKTYPE + "','" + @VNO1 + "','" + @VDT + "','" + @EDTDR + "','" + @EDTCR + "','" + @CDT + "','" + @PDT + "','" + @ENTEREDBY + "','" + @CHECKEDBY + "','" + @SETT_NO + "','" + @SETT_TYPE + "','" + @UNAME + "','" + @EXCHANGE1 + "','" + @OVNO1 + "'"


	EXEC (@@SQL)

	IF @@ERROR <> 0
	BEGIN
		ROLLBACK TRAN
	END

	SET @@SQL = "EXEC " + @ACC_SERVER2 + "." + @ACC_DB2 + ".DBO.NEWPOSTBILL_REM " + CONVERT(VARCHAR, @VTYPE) + ",'" + @BOOKTYPE + "','" + @VNO2 + "','" + @VDT + "','" + @EDTDR + "','" + @EDTCR + "','" + @CDT + "','" + @PDT + "','" + @ENTEREDBY + "','" + @CHECKEDBY + "','" + @SETT_NO + "','" + @SETT_TYPE + "','" + @UNAME + "','" + @EXCHANGE2 + "','" + @OVNO2 + "'"

	EXEC (@@SQL)

	IF @@ERROR <> 0
	BEGIN
		ROLLBACK TRAN
	END

	SET @@SQL = "EXEC " + @ACC_SERVER3 + "." + @ACC_DB3 + ".DBO.NEWPOSTBILL_REM " + CONVERT(VARCHAR, @VTYPE) + ",'" + @BOOKTYPE + "','" + @VNO3 + "','" + @VDT + "','" + @EDTDR + "','" + @EDTCR + "','" + @CDT + "','" + @PDT + "','" + @ENTEREDBY + "','" + @CHECKEDBY + "','" + @SETT_NO + "','" + @SETT_TYPE + "','" + @UNAME + "','" + @EXCHANGE3 + "','" + @OVNO3 + "'"

	EXEC (@@SQL)

	IF @@ERROR <> 0
	BEGIN
		ROLLBACK TRAN
	END




COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RENUM_VOUCHERS_CRNOTE_FINAL
-- --------------------------------------------------
CREATE PROC [dbo].[RENUM_VOUCHERS_CRNOTE_FINAL]
AS        
        
DECLARE         
 @@MAINREC AS CURSOR,        
 @@VNO AS VARCHAR(12),         
 @@VTYP AS INT,          
 @@BOOKTYPE AS VARCHAR(2),         
 @@VDT AS VARCHAR(11),        
 @@VAMT MONEY,         
 @@SDTCUR AS DATETIME,         
 @@LDTCUR AS DATETIME,        
 @@MAXVNO AS VARCHAR(12)        
        
        
        
CREATE TABLE VNO_CRNOTEUPDATES_New        
(        
 VNO VARCHAR(12),        
 NEWVNO VARCHAR(12),        
 VTYPE INT,        
 BOOKTYPE VARCHAR(2),        
 VDT DATETIME,        
 VAMT MONEY,      
 UPDATEDATE DATETIME        
)        
                   
SET @@MAINREC = CURSOR FOR          
 SELECT DISTINCT VNO, VTYP,  BOOKTYPE,CONVERT(VARCHAR(11), VDT, 109),Vamt,CONVERT(VARCHAR(11), SDTCUR, 109), CONVERT(VARCHAR(11), LDTCUR, 109)        
 FROM LEDGER_DUP_CRNOTES L, PARAMETER P        
 WHERE VDT BETWEEN SDTCUR AND LDTCUR AND LEFT(VNO, 4) <> VNO_SERIES        
      
    
        
          
OPEN @@MAINREC          
 FETCH NEXT FROM @@MAINREC INTO @@VNO, @@VTYP,  @@BOOKTYPE, @@VDT,@@VAMT,@@SDTCUR, @@LDTCUR         
WHILE @@FETCH_STATUS = 0          
BEGIN        
 SELECT         
  @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, MAX(LASTVNO)) + 1)         
--           CONVERT(VARCHAR(12), CONVERT(NUMERIC, MAX(LASTVNO)) + 1)         
 FROM         
  baklastvnodummy         
 WHERE         
  VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND VDT BETWEEN @@SDTCUR AND @@LDTCUR + ' 23:59'       
--    VTYP = 6 AND BOOKTYPE = '01' AND VDT BETWEEN 'Apr  1 2006' AND 'Mar 31 2007' + ' 23:59'         
      
      
      
      
 INSERT INTO VNO_CRNOTEUPDATES_New      
 SELECT         
  VNO,@@MAXVNO,VTYP, BOOKTYPE,VDT,VAMT,GETDATE()        
--  VNO,'200600006551',VTYP, BOOKTYPE, VDT,VAMT,GETDATE()        
 FROM        
  baknetledger        
 WHERE        
-- VTYP = 6 AND BOOKTYPE = '01' AND VDT like 'Apr 13 2006%'  and vamt=160.00      
  VNO = @@VNO         
  AND VTYP = @@VTYP        
  AND BOOKTYPE = @@BOOKTYPE        
  AND VDT LIKE @@VDT + '%'        
  AND VAMT=@@VAMT       
    
 UPDATE         
  BakNetLEDGER3  
 SET         
  VNO = @@MAXVNO         
    
--Select * from Bak_LEDGER3_Dummy        
 WHERE        
--  VNO = '200500000696'         
    VNO = @@VNO    
  AND VTYP = @@VTYP        
  AND BOOKTYPE = @@BOOKTYPE    
  AND NARR IN(        
  SELECT         
   NARRATION         
  FROM         
   baknetledger        
  WHERE         
  VNO = @@VNO    
  AND VTYP = @@VTYP        
  AND BOOKTYPE = @@BOOKTYPE    
  AND VDT LIKE @@VDT + '%'    
  AND VAMT = @@VAMT    
)            
      
    
 UPDATE         
  baknetledger        
 SET         
  VNO = @@MAXVNO         
 WHERE        
  VNO = @@VNO         
  AND VTYP = @@VTYP        
  AND BOOKTYPE = @@BOOKTYPE        
  AND VDT LIKE @@VDT + '%'        
  AND VAMT = @@VAMT      
        
    
        
  UPDATE baklastvnodummy SET LASTVNO = @@MAXVNO WHERE  VTYP = @@VTYP        
  AND BOOKTYPE = @@BOOKTYPE        
  AND VDT LIKE CONVERT(VARCHAR(11), @@VDT, 109) + '%'        
      
/*select * from baklastvnodummy where VTYP = 6        
  AND BOOKTYPE = '01'      
  AND VDT LIKE CONVERT(VARCHAR(11), 'Mar 31 2005', 109) + '%'  */      
        
 FETCH NEXT FROM @@MAINREC INTO @@VNO, @@VTYP,  @@BOOKTYPE, @@VDT,@@VAMT,@@SDTCUR, @@LDTCUR         
END        
        
CLOSE @@MAINREC        
DEALLOCATE @@MAINREC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ReNumberVoucher
-- --------------------------------------------------
CREATE Proc [dbo].[ReNumberVoucher]
As  
	/*
	------------------------------------------------------------------------
		1. Program for Re numbering duplicate vouchers
		2. This will re numeber only receipts and pyments
		3. Cut of date given as Apr 1 2005
		4. Assuming the program is executing for Fin year 2005 - 2006
	------------------------------------------------------------------------
	*/
	Declare  
	@@Vno 		As Varchar(12),  
	@@Vtyp 		As Int,  
	@@BookType 	As Varchar(2),  
	@@NewVno 	As Varchar(12),  
	@@Vamt 		As Money,  
	@@Nar 		As Varchar(2000),
	@@Vdt 		As Varchar(11),
	@@Cur 		As Cursor  

	/*
	--------------------------------------------------------------------------
	   Fetching duplicate vouhcers (receipts and payments) only to temp table 
	--------------------------------------------------------------------------
	*/

--	Select @@NewVno = max(lastvno) from v2_lastvno where vtyp = 2 and booktype = '01' and VDT BETWEEN 'APR  1 2007' AND 'MAR 31 2008' 

	create table #vno
	(
		vno varchar(12)
	)

	SELECT 
		VNO, VTYP, BOOKTYPE 
	Into 
		#Ledger  
	FROM 
		LEDGER
	WHERE 
		VDT BETWEEN 'APR  1 2007' AND 'MAR 31 2008' AND LNO = 2 and vtyp = 2 and booktype = '01'
	GROUP BY 
		VNO, VTYP, BOOKTYPE
	HAVING 
		COUNT(1) > 1







	/*
	--------------------------------------------------------------------------------
			Taking  duplicated voucher numer to loop for assaigning new number
	--------------------------------------------------------------------------------
	*/

	Set @@Cur = Cursor For  
		Select 
			Vno,
			Vtyp,
			BookType
		From 
			#Ledger
	
		Open @@Cur  
		Fetch Next From @@Cur Into @@Vno, @@VTyp, @@BookType  
		While @@Fetch_Status = 0  
			Begin  
				Print @@Vno
--				Begin Tran  
					/*
					------------------------------------------------------------------------------
							Taking First voucher of the duplicate voucher
					------------------------------------------------------------------------------
					*/
					Select Top 1 
						@@Vamt = Vamt, 
						@@Nar = Narration, 
						@@Vdt = Convert(Varchar(11), Vdt, 109) 
					From 
						Ledger
					Where 
						Vno = @@Vno 
						And Vtyp = @@Vtyp 
						And BookType = @@BookType
					Order By 
						vdt desc
					/*
					-------------------------------------------------------------------------------
							Getting the next available vno from Last Vno table
					-------------------------------------------------------------------------------
					*/
					insert into #vno Exec Acc_Genvno @@Vdt, 2, '01', 'APR  1 2007', 'MAR 31 2008'
					Select @@NewVno = vno from #vno
					Print @@NewVno
					/*
					--------------------------------------------------------------------------------
							Updating the first duplicate voucher with the new voucher nunmber
							Logic will fail only if amount , narration are same for both the dupl vouchers
					--------------------------------------------------------------------------------
					*/
--					Update LastVno Set LastVno = @@NewVno Where Vtyp = @@Vtyp And BookType = @@BookType And Vdt Like @@Vdt + '%'  
					Update Ledger Set Vno = @@NewVno Where Vno = @@Vno And Vtyp = @@Vtyp And BookType = @@BookType And VAmt = @@Vamt  
					Update Ledger1 Set Vno = @@NewVno Where Vno = @@Vno And Vtyp = @@Vtyp And BookType = @@BookType And RelAmt = @@Vamt  
					Update Ledger2 Set Vno = @@NewVno Where Vno = @@Vno And Vtype = @@Vtyp And BookType = @@BookType And CAmt = @@Vamt  
					Update Ledger3 Set Vno = @@NewVno Where Vno = @@Vno And Vtyp = @@Vtyp And BookType = @@BookType And Narr = @@Nar  

					/*
					-----------------------------------------------------------------------------------------
							Updaing completed - Looping for next voucher
					-----------------------------------------------------------------------------------------			
					*/
--				Commit Tran
				truncate table #vno
		Fetch Next From @@Cur Into @@Vno, @@VTyp, @@BookType  
	End

	/*
		--------------------------------------------  End Of Program -------------------------------------------------------
	*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RENUMVCH_YRLYTODAILY
-- --------------------------------------------------
CREATE PROC [dbo].[RENUMVCH_YRLYTODAILY]

AS

DECLARE
	@@VNO AS VARCHAR(12),
	@@VTYP AS SMALLINT,    
	@@BOOKTYPE AS VARCHAR(2),
	@@VDT AS VARCHAR(11),
	@@NEWVNO AS VARCHAR(12),
	@@DATA AS CURSOR

SET NOCOUNT ON
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT DISTINCT VTYP, BOOKTYPE, VNO, VDT = CONVERT(VARCHAR(11), VDT)
INTO #LEDGER
FROM LEDGER (NOLOCK)
WHERE VDT >= 'APR  1 2007'
GROUP BY VTYP, BOOKTYPE, VNO, CONVERT(VARCHAR(11), VDT)
ORDER BY VTYP, BOOKTYPE, VNO

SELECT LASTVNO INTO #VNO FROM LASTVNO WHERE 1 = 2

IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME = 'BAK_LEDGER_2007' AND XTYPE = 'U')
BEGIN
	SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION INTO BAK_LEDGER_2007 FROM LEDGER WHERE 1 = 2
	SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE INTO BAK_LEDGER1_2007 FROM LEDGER1 WHERE 1 = 2
	SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE INTO BAK_LEDGER2_2007 FROM LEDGER2 WHERE 1 = 2
	SELECT NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE INTO BAK_LEDGER3_2007 FROM LEDGER3 WHERE 1 = 2
	SELECT EXCHANGE,SEGMENT,SETT_TYPE,SETT_NO,BILLNO,[DATE],PARTY_CODE,AMOUNT,DRCR,BALAMT,VTYPE,VNO,LNO,BRANCH,BOOKTYPE INTO BAK_BILLMATCH_2007 FROM BILLMATCH WHERE 1 = 2
	SELECT VTYP,BOOKTYPE,VDT,LASTVNO INTO BAK_LASTVNO_2007 FROM V2_LASTVNO WHERE 1 = 2
END

INSERT INTO BAK_LASTVNO_2007 SELECT VTYP,BOOKTYPE,VDT,LASTVNO FROM V2_LASTVNO WHERE VDT >= 'APR  1 2007'
DELETE FROM V2_LASTVNO WHERE VDT >= 'APR  1 2007'

SET @@DATA = CURSOR FOR
SELECT VTYP, BOOKTYPE, VNO, VDT FROM #LEDGER

OPEN @@DATA    
FETCH NEXT FROM @@DATA INTO @@VTYP, @@BOOKTYPE, @@VNO, @@VDT

WHILE @@FETCH_STATUS = 0
BEGIN
	INSERT INTO BAK_LEDGER_2007 SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
	INSERT INTO BAK_LEDGER1_2007 SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE FROM LEDGER1 WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
	INSERT INTO BAK_LEDGER2_2007 SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE FROM LEDGER2 WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
	INSERT INTO BAK_LEDGER3_2007 SELECT NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE FROM LEDGER3 WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
	INSERT INTO BAK_BILLMATCH_2007 SELECT EXCHANGE,SEGMENT,SETT_TYPE,SETT_NO,BILLNO,[DATE],PARTY_CODE,AMOUNT,DRCR,BALAMT,VTYPE,VNO,LNO,BRANCH,BOOKTYPE FROM BILLMATCH WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE 

	INSERT INTO #VNO  
	EXEC ACC_GENVNO_NEW @@VDT, @@VTYP, @@BOOKTYPE, 'APR  1 2007', 'MAR 31 2008'	

	SELECT @@NEWVNO = LASTVNO FROM #VNO

	UPDATE LEDGER SET VNO = @@NEWVNO WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE
	UPDATE LEDGER1 SET VNO = @@NEWVNO WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE
	UPDATE LEDGER2 SET VNO = @@NEWVNO WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE
	UPDATE LEDGER3 SET VNO = @@NEWVNO WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE
	UPDATE BILLMATCH SET VNO = @@NEWVNO WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE

	TRUNCATE TABLE #VNO

	PRINT 'OLDVNO = ' + @@VNO + ', NEWVNO = ' + @@NEWVNO + ', VTYP = ' + CONVERT(VARCHAR, @@VTYP) + ', BOOKTYPE = ' + @@BOOKTYPE + ', VDT = ' + @@VDT

	FETCH NEXT FROM @@DATA INTO @@VTYP, @@BOOKTYPE, @@VNO, @@VDT
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Report_Access_CodeList1
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------
--  Proc To List Clients Acc To Login For The Db - Account
---------------------------------------------------------------------------------------------------------
CREATE   Procedure [dbo].[Report_Access_CodeList1]
 @Statusid Varchar(15), 
 @Statusname Varchar(25), 
 @Whattolookfor Varchar(25), -- Partial/complete/null String - Forms The Basis For The Search
 @Whichway Varchar(1),  -- > Or <, Depending On How The Above String Is To Be Compared To The Below One.
 @Comparetowhat Varchar(25), -- Partial/complete/null String To Indicate The Upper/lower Limit Of The Search.
 @Accat Varchar(3),  -- Account Category
 @Lookforname Varchar(25) -- Partial/complete/null String - Forms The Basis For The Search
As
Declare
@Strsql Varchar(2500), 
@@Inaccat Varchar(3)
Select @@Inaccat = Rtrim(Convert(Varchar, Convert(Int, @Accat)+100, 3))
--set Default Values
Set @Whattolookfor = @Whattolookfor + "%"
/* Set @Booktype = @Booktype + "%" */
--broker Login
If  lower(@Statusid) = "broker"
Begin
 Set @Strsql = "select "
 --Set @Strsql = @Strsql + "distinct Cltcode, Acname, Branchcode "
 Set @Strsql = @Strsql + "distinct Cltcode=Cltcode+' - '+Acname, Branchcode "
 Set @Strsql = @Strsql + "from Acmast "
 Set @Strsql = @Strsql + "where "
        If Len(Rtrim(@Whattolookfor)) <> 0 And Len(Rtrim(@Lookforname)) <> 0 
           Begin
    Set @Strsql = @Strsql + " ( Cltcode Like '" + @Whattolookfor + "' And Acname Like '" + @Lookforname + "%') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%' " 
    End
        Else
           If Len(Rtrim(@Lookforname)) <> 0 
               Begin
                  Set @Strsql = @Strsql + " ( Cltcode Like '" + @Whattolookfor + "' Or Acname Like '" + @Lookforname + "%') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%' " 
               End
           Else
               Begin
                  Set @Strsql = @Strsql + " ( Cltcode Like '" + @Whattolookfor + "' Or Acname Like '" + @Whattolookfor + "') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%' " 
               End
        If Rtrim(@Accat) = '3'
           Begin
  Select @Strsql = @Strsql + " Or Accat In ( '14', '18', '114', '118'))" 
           End
        Else
           Begin
  Select @Strsql = @Strsql + " )" 
           End
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections 
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By Cltcode, Branchcode "
End
--branch Login
If lower(@Statusid) = "branch"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = Cltcode+' - '+Acname, "
-- Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " (Branchcode Like '" + @Statusname + "' Or Branchcode = 'All') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%' " 
        If Rtrim(@Accat) = '3'
           Begin
  Select @Strsql = @Strsql + " Or Accat In ( '14', '18', '114', '118'))" 
           End
        Else
           Begin
  Select @Strsql = @Strsql + " )" 
           End
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--sub-broker Login
If lower(@Statusid) = "subbroker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2, "
 Set @Strsql = @Strsql + " Subbrokers S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Sub_broker = S.Sub_broker And "
 Set @Strsql = @Strsql + " C1.Sub_broker Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
End
--trader Login
If lower(@Statusid) = "trader"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Trader "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2, "
 Set @Strsql = @Strsql + " Branches S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 /*set @Strsql = @Strsql + " C1.Trader = S.Branch_cd And "*/
             Set @Strsql = @Strsql + " C1.Branch_cd = S.Branch_cd And "
 Set @Strsql = @Strsql + " C1.Trader Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Trader "
End
--family Login
If lower(@Statusid) = "family"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Family "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Family Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Family "
End
If lower(@Statusid) = "client"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Statusname + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If lower(@Statusid) = "region"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If lower(@Statusid) = "area"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Area Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
 Set @Strsql = @Strsql + " Option  (Fast 10)"
Print @Strsql
Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.REPROCESS_RECO
-- --------------------------------------------------
--EXEC REPROCESS_RECO '326010', '01/10/2006'

CREATE PROC [dbo].[REPROCESS_RECO]  
 @BANKCODE VARCHAR(10),  
 @PROCESS_DATE VARCHAR(10)  
  
AS  
  
DECLARE   
 @@MICRNO VARCHAR(20),  
 @@TABLE_EXIST VARCHAR(20),        
 @@RECORD_COUNT SMALLINT,        
 @@RECO_STATUS CHAR(1),        
 @@CLTCODE_EXIST INT,  
 @@PROC_DATE VARCHAR(11)  
  
  
CREATE TABLE #BANKRECOSAVE  
(  
 Cltcode VARCHAR(10),  
 Bookdate DATETIME,  
 [Description] VARCHAR(200),  
 Amount MONEY,  
 Drcr CHAR(1),  
 Valuedate DATETIME,  
 Referenceno VARCHAR(30),  
 Crossreferenceno BIGINT,  
 STATUS VARCHAR(15),  
 BR_SNo BIGINT,  
 MICRNO VARCHAR(10),  
 AMOUNTLEDGR1 MONEY  
)  
  
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'        
        
IF @@TABLE_EXIST = ''        
BEGIN        
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS        
        
IF @@RECORD_COUNT = 0        
BEGIN        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS        
        
IF @@RECO_STATUS = 'N'        
BEGIN        
 BEGIN TRAN        
 UPDATE RECOPROCESS SET INPROCESS = 'Y'        
END        
ELSE        
BEGIN        
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'        
 RETURN        
END        
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'        
IF @@TABLE_EXIST <> ''        
BEGIN        
 DROP TABLE LEDGER_UPDATES        
END        
        
SET @@TABLE_EXIST = ''        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'        
IF @@TABLE_EXIST <> ''        
BEGIN        
 DROP TABLE BANKRECOCOMP        
END        
        
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)        
  
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2        
        
IF @@CLTCODE_EXIST = 0        
 BEGIN        
  SELECT 'BANK CODE DOES NOT EXIST.'    
  ROLLBACK TRAN    
  RETURN        
 END        
  
SELECT @@MICRNO = MICRNO FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2        
  
  
SELECT @@PROC_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @PROCESS_DATE, 103), 109)  


SELECT 
	@@RECORD_COUNT = COUNT(1) 
FROM 
	BANKRECO 
WHERE  
	CLTCODE = @BANKCODE  
	AND BOOKDATE LIKE @@PROC_DATE + '%'

IF @@RECORD_COUNT = 0
BEGIN
	SELECT 'THE STATEMENT FOR SELECTED DATE ' + @@PROC_DATE + ' FOR ' + @BANKCODE + ' IS NOT UPLOADED.'
	ROLLBACK TRAN
	RETURN
END

SELECT 
	@@RECORD_COUNT = COUNT(1) 
FROM 
	BANKRECO 
WHERE  
	CLTCODE = @BANKCODE  
	AND BOOKDATE LIKE @@PROC_DATE + '%'
	AND STATUS = 'UNMATCHED'

IF @@RECORD_COUNT = 0
BEGIN
	PRINT 'ALL THE RECORDS FOR SELECTED DATE ' + @@PROC_DATE + ' FOR ' + @BANKCODE + ' IS ALREADY MATCHED.'
	ROLLBACK TRAN
	RETURN
END
  
INSERT INTO #BANKRECOSAVE  
SELECT  
 Cltcode,  
 Bookdate,  
 [Description],  
 Amount,  
 Drcr,  
 Valuedate,  
 Referenceno,  
 Crossreferenceno,  
 STATUS,  
 BR_SNo,  
 MICRNO,  
 0  
FROM  
 BANKRECO  
WHERE  
 CLTCODE = @BANKCODE  
 AND BOOKDATE LIKE @@PROC_DATE + '%'  
 AND STATUS = 'UNMATCHED'  
  
  
UPDATE        
 #BANKRECOSAVE        
SET        
 STATUS ='MATCHED'        
FROM        
 LEDGER1        
WHERE        
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)        
 AND CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      

  
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND   REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
INSERT INTO        
 LEDGER_UPDATES        
SELECT       
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE        
FROM        
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' or LEDGER1.VTYP = '17' )        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE        
 AND LEDGER1.VNO = LEDGER.VNO        
 AND LEDGER1.VTYP = LEDGER.VTYP        
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND DDNO =  REFERENCENO        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)        
 AND   REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
UPDATE        
 LEDGER1        
SET        
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO        
FROM        
 #BANKRECOSAVE, LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' or LEDGER1.VTYP = '17')        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND DDNO =  REFERENCENO        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      

  
 AND REFERENCENO  <> '0'        
 AND LEDGER.VNO = LEDGER1.VNO        
 AND LEDGER.VTYP = LEDGER1.VTYP        
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
SELECT        
 SUM(RELAMT) AS AMOUNT,        
 SLIPNO AS SLIPNO,        
 UPPER(DRCR) AS DRCR,        
 MICRNO        
INTO        
 BANKRECOCOMP        
FROM        
 LEDGER1        
WHERE        
 MICRNO = @@MICRNO        
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )        
 AND SLIPNO <>''        
GROUP BY        
 SLIPNO,        
 DRCR,        
 MICRNO        
        
        
UPDATE        
 #BANKRECOSAVE        
SET        
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'        
FROM        
 BANKRECOCOMP        
WHERE        
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)        
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)        
  AND #BANKRECOSAVE.MICRNO = @@MICRNO        
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT      
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO        
  AND REFERENCENO  <> '0'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
INSERT INTO LEDGER_UPDATES        
SELECT        
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE        
FROM        
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE        
 AND LEDGER1.VNO = LEDGER.VNO        
 AND LEDGER1.VTYP = LEDGER.VTYP        
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND #BANKRECOSAVE.REFERENCENO  <> '0'        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
        
UPDATE        
 LEDGER1        
SET        
 RELDT = VALUEDATE ,        
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO        
FROM        
 #BANKRECOSAVE, LEDGER  (NOLOCK)        
WHERE        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)        
 AND RELDT = ''        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO        
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO        
 AND #BANKRECOSAVE.REFERENCENO  <> '0'        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)        
 AND LEDGER.VNO = LEDGER1.VNO        
 AND LEDGER.VTYP = LEDGER1.VTYP        
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
UPDATE        
 L        
SET        
 EDT = VALUEDATE        
FROM        
 LEDGER L, LEDGER_UPDATES LU        
WHERE        
 LU.VNO=L.VNO        
 AND LU.VTYP=L.VTYP        
 AND LU.BOOKTYPE=L.BOOKTYPE        
 AND EDT LIKE 'DEC 31 2049%'        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'        
 ROLLBACK TRAN        
 RETURN        
END        
        
UPDATE        
 L        
SET        
 EDT = VDT        
FROM        
 LEDGER L, LEDGER_UPDATES LU        
WHERE        
 LU.VNO=L.VNO        
 AND LU.VTYP=L.VTYP        
 AND LU.BOOKTYPE=L.BOOKTYPE        
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))        
        
IF @@ERROR <> 0        
BEGIN        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'        
 ROLLBACK TRAN        
 RETURN        
END        
        
DROP TABLE BANKRECOCOMP        
DROP TABLE LEDGER_UPDATES        
  
UPDATE BR   
SET STATUS = 'MATCHED'  
FROM BANKRECO BR, #BANKRECOSAVE BR1  
WHERE BR.BR_SNo = BR1.BR_SNo AND BR1.STATUS = 'MATCHED'  
  
    
UPDATE RECOPROCESS SET INPROCESS = 'N'        
        
COMMIT TRAN      
        
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_BANKBOOK_NEW
-- --------------------------------------------------
/*    
SELECT * FROM LEDGER WHERE VNO = '200600000021' AND VTYP = 3    
SELECT * FROM LEDGER2 WHERE VNO = '200600000021' AND VTYPE = 3    
Exec rpt_Acc_BankBook_New 'Jan 1 2007', 'Feb 1 2007', '01/04/2006', 'BANK01', 'broker', 'gog', '%', 'vdt'     
*/    
    
 --SELECT DISTINCT L.CLTCODE, A.BRANCHCODE FROM LEDGER L, ACMAST A WHERE L.CLTCODE = A.CLTCODE AND L.VDT >= 'APR  1 2005' AND A.ACCAT = 2      
      
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'MAR 11 2006', '01/04/2005', 'BANK01', 'BROKER', 'GOG', '%'      
      
 /****** OBJECT:  STORED PROCEDURE DBO.RPT_ACC_BANKBOOK_NEW    SCRIPT DATE: 07/08/2005 3:55:36 PM ******/              
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'JUL  5 2005', '01/04/2005', '33117', 'BROKER', 'BROKER', '%'                 
--EXEC RPT_ACC_BANKBOOK_NEW '01/04/2005', '31/03/2006', 'JUN  1 2005', 'JUN 29 2005', '33117', '33117', 'BROKER', 'BROKER', '%','VOUCHERDATE', 'ACCOUNT', 'VDT', 'BANK BOOK',''                      
--EXEC RPT_ACC_BANKBOOK_NEW 'JUN  1 2005', 'JUN  1 2005', '01/04/2005', '711129', 'BROKER', 'BROKER', '%'                        
--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'      
CREATE  PROC [dbo].[RPT_ACC_BANKBOOK_NEW]      
--EXEC RPT_ACC_BANKBOOK_NEW 'MAY  2 2005', 'MAY  2 2005', 'APR  1 2005', '711129', 'BROKER', 'BROKER', '%'                        
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @FCODE VARCHAR(10),                          
      @STATUSID VARCHAR(30),                          
      @STATUSNAME VARCHAR(30),                          
      @BRANCH VARCHAR(10),      
      @SELECTIONBY VARCHAR(3) = 'VDT'                           
                          
AS                          
                          
DECLARE                          
 @@OPENDATE AS VARCHAR(11),                          
 @@REPDATE AS VARCHAR(8),                          
 @@STARTDATE AS VARCHAR(11),       
 @@COSTCODE AS SMALLINT      
      
      
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
                        
CREATE TABLE [DBO].[#TBL_GLREPORT] (                        
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                        
 [BOOKTYPE] [CHAR] (2) NULL ,                        
 [VOUDT] [VARCHAR] (10) NULL ,                        
 [EFFDT] [VARCHAR] (10) NULL ,                        
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                        
 [DRAMT] [MONEY] NULL ,                        
 [CRAMT] [MONEY] NULL ,                        
 [VNO] [VARCHAR] (12) NULL ,                        
 [NARRATION] [VARCHAR] (500) NULL ,                        
 [DDNO] [VARCHAR] (15) NULL ,                        
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                        
 [LONGNAME] [VARCHAR] (100) NULL ,                        
 [VDT] [DATETIME] NULL ,                        
 [VTYP] [SMALLINT] NOT NULL ,                        
 [ACCAT] [CHAR] (2) NULL ,                        
 [OPBAL] [MONEY] NOT NULL ,                        
 [CROSAC] [VARCHAR] (10) NOT NULL ,                        
 [ACNAME] [VARCHAR] (100) NULL ,                        
 [BRANCHCODE] [VARCHAR] (35) NULL ,                        
 [LNO] [INT] NULL,    
 [PROCID] [BIGINT] NULL ,                        
 [REPDATE] [VARCHAR] (8) NULL ,                        
 [MAINCODE] [VARCHAR] (10) NULL ,                        
 [VCHDT] [DATETIME] NULL                        
)                        
                        
                          
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                        
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID      
      
SELECT @@COSTCODE = -1      
      
IF @STATUSID <> 'BROKER'      
 BEGIN      
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME       
 END      
ELSE IF @STATUSID = 'BROKER'      
 BEGIN      
  IF @BRANCH <> '' OR @BRANCH <> '%'      
   BEGIN      
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH       
   END      
 END      
    
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                          
      
IF @SELECTIONBY = 'VDT'       
BEGIN      
 IF @STATUSID = 'BROKER'      
  BEGIN                          
   IF @BRANCH = '' OR @BRANCH = '%'      
    BEGIN      
     --PRINT 'CAME HERE - I'      
     INSERT INTO TBL_OPPBALANCE       
     SELECT       
      CLTCODE,       
      SUM(OPBAL) AS OPBAL,      
      SPID ,       
      CURDATE       
     FROM                          
      (SELECT       
       CLTCODE,      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,      
       @@SPID AS SPID,       
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                               
      FROM       
       LEDGER                              
      WHERE       
       CLTCODE = @FCODE       
       AND VTYP = 18       
       AND VDT LIKE @@STARTDATE + '%'      
      GROUP BY       
       CLTCODE      
      UNION ALL                          
      SELECT       
       CLTCODE,      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,      
       @@SPID AS SPID,       
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
      FROM       
       LEDGER                                
      WHERE       
       CLTCODE = @FCODE       
       AND VDT >= @@STARTDATE       
       AND VDT <  @FDATE                          
       AND VTYP <> 18                          
      GROUP BY       
       CLTCODE) A      
     GROUP BY       
      CLTCODE,       
      SPID,       
      CURDATE      
       
                           
     INSERT INTO #TBL_GLREPORT                        
     SELECT       
      L.BOOKTYPE,                           
      VOUDT=CONVERT(VARCHAR,L.VDT,103),       
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                    
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                  
      L.VNO,       
      REPLACE( L.NARRATION,'"','') NARRATION,                                                     
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
      L.CLTCODE ,      
      A.LONGNAME,      
      VDT,       
      L.VTYP,                                                                    
      ACCAT,       
      OPBAL=0,      
      CROSAC='',      
      A.ACNAME,      
      A.BRANCHCODE,    
      L.LNO,      
      @@SPID,       
      CONVERT(VARCHAR,GETDATE(),112), '',       
      L.VDT                        
     FROM       
      LEDGER L         
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
      VMAST V, ACMAST A                        
     WHERE       
      L.VNO = L1.VNO                        
      AND L.VTYP = L1.VTYP                        
      AND L.BOOKTYPE = L1.BOOKTYPE                        
      AND L.VNO = LL.VNO                        
      AND L.VTYP = LL.VTYP                        
      AND L.BOOKTYPE = LL.BOOKTYPE                        
      AND L.CLTCODE = A.CLTCODE                        
      AND L.VTYP = V.VTYPE                        
      AND L.CLTCODE <> @FCODE                        
      AND L.VTYP <> 18                        
    END      
   ELSE      
    BEGIN      
     --PRINT 'CAME HERE - II'      
     INSERT INTO TBL_OPPBALANCE                                
     SELECT       
      CLTCODE,       
      SUM(OPBAL) AS OPBAL,      
      SPID ,       
      CURDATE       
     FROM                          
      (SELECT       
       L2.CLTCODE,      
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
       @@SPID AS SPID,       
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE      
      FROM       
       LEDGER L, LEDGER2 L2      
      WHERE       
       L.VNO = L2.VNO      
       AND L.VTYP = L2.VTYPE      
       AND L.BOOKTYPE = L2.BOOKTYPE      
       AND L.LNO = L2.LNO      
       AND L.CLTCODE = L2.CLTCODE      
       AND L2.CLTCODE = @FCODE       
       AND L2.COSTCODE = @@COSTCODE      
       AND L.VTYP = 18       
       AND L.VDT LIKE @@STARTDATE + '%'      
      GROUP BY       
       L2.CLTCODE       
         
      UNION ALL      
         
      SELECT       
       L2.CLTCODE,      
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
       @@SPID AS SPID,       
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
      FROM       
       LEDGER L, LEDGER2 L2      
      WHERE       
       L.VNO = L2.VNO      
       AND L.VTYP = L2.VTYPE      
       AND L.BOOKTYPE = L2.BOOKTYPE      
       AND L.LNO = L2.LNO      
       AND L.CLTCODE = L2.CLTCODE      
       AND L2.CLTCODE = @FCODE       
       AND L2.COSTCODE = @@COSTCODE      
       AND L.VDT >= @@STARTDATE       
       AND L.VDT <  @FDATE       
       AND L2.VTYPE <> 18                          
      GROUP BY       
       L2.CLTCODE) A      
     GROUP BY       
      CLTCODE,       
      SPID,       
      CURDATE      
       
     INSERT INTO #TBL_GLREPORT                        
     SELECT       
      L.BOOKTYPE,                           
      VOUDT=CONVERT(VARCHAR,L.VDT,103),       
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                    
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                  
      L.VNO,       
      REPLACE( L.NARRATION,'"','') NARRATION,                                                     
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
      L2.CLTCODE ,      
      A.LONGNAME,      
      VDT,       
      L.VTYP,                                                                    
      ACCAT,       
      OPBAL=0,      
      CROSAC='',      
      A.ACNAME,      
      A.BRANCHCODE,    
      L.LNO,      
      @@SPID,       
      CONVERT(VARCHAR,GETDATE(),112), '',       
      L.VDT                        
     FROM       
      LEDGER L         
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
      VMAST V, ACMAST A, LEDGER2 L2                        
     WHERE       
      L.VNO = L1.VNO                        
      AND L.VTYP = L1.VTYP                        
      AND L.BOOKTYPE = L1.BOOKTYPE                        
      AND L.VNO = L2.VNO      
      AND L.VTYP = L2.VTYPE       
      AND L.BOOKTYPE = L2.BOOKTYPE      
      AND L.LNO = L2.LNO      
 --     AND L.DRCR = L2.DRCR      
      AND L.VNO = LL.VNO                        
      AND L.VTYP = LL.VTYP                        
      AND L.BOOKTYPE = LL.BOOKTYPE                        
      AND L2.CLTCODE = A.CLTCODE                        
      AND L.VTYP = V.VTYPE                        
      AND L.CLTCODE <> @FCODE                        
    AND L2.COSTCODE = @@COSTCODE      
      AND L.VTYP <> 18        
       
    END      
  END      
 ELSE      
  BEGIN      
   INSERT INTO TBL_OPPBALANCE                                
   SELECT       
    CLTCODE,       
    SUM(OPBAL) AS OPBAL,      
    SPID ,       
    CURDATE       
   FROM                          
    (SELECT       
     L2.CLTCODE,      
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
     @@SPID AS SPID,       
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE      
    FROM       
     LEDGER L, LEDGER2 L2      
    WHERE       
     L.VNO = L2.VNO      
    AND L.VTYP = L2.VTYPE      
     AND L.BOOKTYPE = L2.BOOKTYPE      
     AND L.LNO = L2.LNO      
     AND L.CLTCODE = L2.CLTCODE      
     AND L2.CLTCODE = @FCODE       
     AND L2.COSTCODE = @@COSTCODE      
     AND L.VTYP = 18       
     AND L.VDT LIKE @@STARTDATE + '%'      
    GROUP BY       
     L2.CLTCODE       
       
    UNION ALL      
       
    SELECT       
     L2.CLTCODE,      
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
     @@SPID AS SPID,       
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
    FROM       
     LEDGER L, LEDGER2 L2      
    WHERE       
     L.VNO = L2.VNO      
     AND L.VTYP = L2.VTYPE      
     AND L.BOOKTYPE = L2.BOOKTYPE      
     AND L.LNO = L2.LNO      
     AND L.CLTCODE = L2.CLTCODE      
     AND L2.CLTCODE = @FCODE       
     AND L2.COSTCODE = @@COSTCODE      
     AND L.VDT >= @@STARTDATE       
     AND L.VDT <  @FDATE       
     AND L2.VTYPE <> 18                          
    GROUP BY       
     L2.CLTCODE) A      
   GROUP BY       
    CLTCODE,       
    SPID,       
    CURDATE      
       
     INSERT INTO #TBL_GLREPORT                        
     SELECT       
      L.BOOKTYPE,                           
      VOUDT=CONVERT(VARCHAR,L.VDT,103),       
      EFFDT=CONVERT(VARCHAR,L.EDT,103),         
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                    
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                  
      L.VNO,       
      REPLACE( L.NARRATION,'"','') NARRATION,                                                     
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
      L.CLTCODE ,      
      A.LONGNAME,      
      VDT,       
      L.VTYP,                                                                    
      ACCAT,       
      OPBAL=0,      
      CROSAC='',      
      A.ACNAME,      
      A.BRANCHCODE,    
      L.LNO,      
      @@SPID,       
      CONVERT(VARCHAR,GETDATE(),112), '',       
      L.VDT                        
     FROM       
      LEDGER L         
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
      VMAST V, ACMAST A, LEDGER2 L2                        
     WHERE       
      L.VNO = L1.VNO                        
      AND L.VTYP = L1.VTYP                        
      AND L.BOOKTYPE = L1.BOOKTYPE                        
      AND L.VNO = L2.VNO      
      AND L.VTYP = L2.VTYPE       
      AND L.BOOKTYPE = L2.BOOKTYPE      
      AND L.LNO = L2.LNO      
 --     AND L.DRCR = L2.DRCR      
      AND L.VNO = LL.VNO                        
      AND L.VTYP = LL.VTYP                        
      AND L.BOOKTYPE = LL.BOOKTYPE                        
      AND L.CLTCODE = A.CLTCODE                        
      AND L.VTYP = V.VTYPE                        
      AND L.CLTCODE <> @FCODE                        
      AND L2.COSTCODE = @@COSTCODE      
      AND L.VTYP <> 18        
  END      
END      
ELSE      
BEGIN      
 IF @STATUSID = 'BROKER'      
  BEGIN                          
   IF @BRANCH = '' OR @BRANCH = '%'      
    BEGIN      
     --PRINT 'CAME HERE - I'      
     INSERT INTO TBL_OPPBALANCE                                
     SELECT       
      CLTCODE,       
      SUM(OPBAL) AS OPBAL,      
      SPID ,       
      CURDATE       
     FROM                          
      (SELECT       
       CLTCODE,      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,      
       @@SPID AS SPID,       
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                               
      FROM       
       LEDGER                              
      WHERE       
       CLTCODE = @FCODE       
       AND VTYP = 18       
       AND EDT LIKE @@STARTDATE + '%'      
      GROUP BY       
       CLTCODE      
      UNION ALL                          
      SELECT       
       CLTCODE,      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,      
       @@SPID AS SPID,       
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
      FROM       
       LEDGER                                
      WHERE       
       CLTCODE = @FCODE       
       AND EDT >= @@STARTDATE       
       AND EDT <  @FDATE                          
       AND VTYP <> 18                          
      GROUP BY       
       CLTCODE      
      UNION ALL                          
      SELECT       
       CLTCODE,      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,      
       @@SPID AS SPID,       
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
      FROM       
       LEDGER                                
      WHERE       
       CLTCODE = @FCODE       
       AND VDT < @@STARTDATE       
       AND EDT >= @@STARTDATE       
       AND VTYP <> 18                          
      GROUP BY       
       CLTCODE) A      
     GROUP BY       
      CLTCODE,       
      SPID,       
      CURDATE       
       
                           
     INSERT INTO #TBL_GLREPORT                        
     SELECT       
      L.BOOKTYPE,                           
      VOUDT=CONVERT(VARCHAR,L.VDT,103),       
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                    
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                  
      L.VNO,       
      REPLACE( L.NARRATION,'"','') NARRATION,                                                     
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
      L.CLTCODE ,      
      A.LONGNAME,      
      VDT,       
      L.VTYP,                                                                    
      ACCAT,       
      OPBAL=0,      
      CROSAC='',      
      A.ACNAME,      
      A.BRANCHCODE,     
      L.LNO,     
      @@SPID,       
      CONVERT(VARCHAR,GETDATE(),112), '',       
      L.VDT                        
     FROM       
      LEDGER L         
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
      VMAST V, ACMAST A                        
     WHERE       
      L.VNO = LL.VNO                        
      AND L.VTYP = LL.VTYP                        
      AND L.BOOKTYPE = LL.BOOKTYPE                        
      AND L.CLTCODE = A.CLTCODE                        
      AND L.VTYP = V.VTYPE                        
      AND L.CLTCODE <> @FCODE                      
      AND L.VTYP <> 18                        
    END      
   ELSE      
    BEGIN      
     --PRINT 'CAME HERE - II'      
     INSERT INTO TBL_OPPBALANCE                                
     SELECT       
      CLTCODE,       
      SUM(OPBAL) AS OPBAL,      
      SPID ,       
      CURDATE       
     FROM                          
      (SELECT       
       L2.CLTCODE,      
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
       @@SPID AS SPID,       
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE      
      FROM       
       LEDGER L, LEDGER2 L2      
      WHERE       
       L.VNO = L2.VNO      
       AND L.VTYP = L2.VTYPE      
       AND L.BOOKTYPE = L2.BOOKTYPE      
       AND L.LNO = L2.LNO      
       AND L.CLTCODE = L2.CLTCODE      
       AND L2.CLTCODE = @FCODE       
       AND L2.COSTCODE = @@COSTCODE      
       AND L.VTYP = 18       
       AND L.EDT LIKE @@STARTDATE + '%'      
      GROUP BY       
       L2.CLTCODE       
         
      UNION ALL      
          
      SELECT       
       L2.CLTCODE,      
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
       @@SPID AS SPID,       
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
      FROM       
       LEDGER L, LEDGER2 L2      
      WHERE       
       L.VNO = L2.VNO      
       AND L.VTYP = L2.VTYPE      
       AND L.BOOKTYPE = L2.BOOKTYPE      
       AND L.LNO = L2.LNO      
       AND L.CLTCODE = L2.CLTCODE      
       AND L2.CLTCODE = @FCODE       
       AND L2.COSTCODE = @@COSTCODE      
       AND L.EDT >= @@STARTDATE       
       AND L.EDT <  @FDATE       
       AND L2.VTYPE <> 18                          
      GROUP BY       
       L2.CLTCODE      
      
      UNION ALL      
         
      SELECT       
       L2.CLTCODE,      
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
       @@SPID AS SPID,       
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
      FROM       
       LEDGER L, LEDGER2 L2      
      WHERE       
       L.VNO = L2.VNO      
       AND L.VTYP = L2.VTYPE      
       AND L.BOOKTYPE = L2.BOOKTYPE      
       AND L.LNO = L2.LNO      
       AND L.CLTCODE = L2.CLTCODE      
       AND L2.CLTCODE = @FCODE       
       AND L2.COSTCODE = @@COSTCODE      
       AND L.EDT >= @@STARTDATE       
       AND L.VDT <  @@STARTDATE       
       AND L2.VTYPE <> 18                          
      GROUP BY       
       L2.CLTCODE) A      
     GROUP BY       
      CLTCODE,       
      SPID,       
      CURDATE      
       
     INSERT INTO #TBL_GLREPORT                        
     SELECT       
      L.BOOKTYPE,                           
      VOUDT=CONVERT(VARCHAR,L.VDT,103),       
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                    
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                  
      L.VNO,       
      REPLACE( L.NARRATION,'"','') NARRATION,                                                     
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
      L.CLTCODE ,      
      A.LONGNAME,      
      VDT,       
      L.VTYP,                                                                    
      ACCAT,       
      OPBAL=0,      
      CROSAC='',      
      A.ACNAME,      
      A.BRANCHCODE,     
      L.LNO,     
      @@SPID,       
      CONVERT(VARCHAR,GETDATE(),112), '',       
      L.VDT                        
     FROM       
      LEDGER L         
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
      VMAST V, ACMAST A, LEDGER2 L2                        
     WHERE       
      L.VNO = L2.VNO      
      AND L.VTYP = L2.VTYPE       
      AND L.BOOKTYPE = L2.BOOKTYPE      
      AND L.LNO = L2.LNO      
      AND L.VNO = LL.VNO                        
      AND L.VTYP = LL.VTYP                        
      AND L.BOOKTYPE = LL.BOOKTYPE                        
      AND L.CLTCODE = A.CLTCODE                        
      AND L.VTYP = V.VTYPE                        
      AND L.CLTCODE <> @FCODE                        
      AND L2.COSTCODE = @@COSTCODE      
      AND L.VTYP <> 18        
       
    END      
  END      
 ELSE      
  BEGIN      
   INSERT INTO TBL_OPPBALANCE                                
   SELECT       
    CLTCODE,       
    SUM(OPBAL) AS OPBAL,      
    SPID ,       
    CURDATE       
   FROM                          
    (SELECT       
     L2.CLTCODE,      
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
     @@SPID AS SPID,       
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE      
    FROM       
     LEDGER L, LEDGER2 L2      
    WHERE       
     L.VNO = L2.VNO      
     AND L.VTYP = L2.VTYPE      
     AND L.BOOKTYPE = L2.BOOKTYPE      
     AND L.LNO = L2.LNO      
     AND L.CLTCODE = L2.CLTCODE      
     AND L2.CLTCODE = @FCODE       
     AND L2.COSTCODE = @@COSTCODE      
     AND L.VTYP = 18       
     AND L.EDT LIKE @@STARTDATE + '%'      
    GROUP BY       
     L2.CLTCODE       
       
    UNION ALL      
       
    SELECT       
     L2.CLTCODE,      
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
     @@SPID AS SPID,       
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
    FROM       
     LEDGER L, LEDGER2 L2      
    WHERE       
     L.VNO = L2.VNO      
     AND L.VTYP = L2.VTYPE      
     AND L.BOOKTYPE = L2.BOOKTYPE      
     AND L.LNO = L2.LNO      
     AND L.CLTCODE = L2.CLTCODE      
     AND L2.CLTCODE = @FCODE       
     AND L2.COSTCODE = @@COSTCODE      
     AND L.EDT >= @@STARTDATE       
     AND L.EDT <  @FDATE                          
     AND L2.VTYPE <> 18                          
    GROUP BY       
     L2.CLTCODE      
       
    UNION ALL      
       
    SELECT       
     L2.CLTCODE,      
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
     @@SPID AS SPID,       
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
    FROM       
     LEDGER L, LEDGER2 L2      
    WHERE       
     L.VNO = L2.VNO      
     AND L.VTYP = L2.VTYPE      
     AND L.BOOKTYPE = L2.BOOKTYPE      
     AND L.LNO = L2.LNO      
     AND L.CLTCODE = L2.CLTCODE      
     AND L2.CLTCODE = @FCODE       
     AND L2.COSTCODE = @@COSTCODE      
     AND L.EDT >= @@STARTDATE       
     AND L.VDT <  @@STARTDATE               
     AND L2.VTYPE <> 18                          
    GROUP BY       
     L2.CLTCODE) A      
   GROUP BY       
    CLTCODE,       
    SPID,       
    CURDATE      
       
     INSERT INTO #TBL_GLREPORT                        
     SELECT       
      L.BOOKTYPE,                           
      VOUDT=CONVERT(VARCHAR,L.VDT,103),       
      EFFDT=CONVERT(VARCHAR,L.EDT,103),         
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                    
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                  
      L.VNO,       
      REPLACE( L.NARRATION,'"','') NARRATION,                                                     
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
      L.CLTCODE ,      
      A.LONGNAME,      
      VDT,       
      L.VTYP,                                                    
      ACCAT,       
      OPBAL=0,      
      CROSAC='',      
      A.ACNAME,      
      A.BRANCHCODE,      
      L.LNO,    
      @@SPID,       
      CONVERT(VARCHAR,GETDATE(),112), '',       
      L.VDT                        
     FROM       
      LEDGER L         
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
      VMAST V, ACMAST A, LEDGER2 L2                        
     WHERE       
      L.VNO = L2.VNO      
      AND L.VTYP = L2.VTYPE       
      AND L.BOOKTYPE = L2.BOOKTYPE      
      AND L.LNO = L2.LNO      
      AND L.VNO = LL.VNO                        
      AND L.VTYP = LL.VTYP                        
      AND L.BOOKTYPE = LL.BOOKTYPE                        
      AND L.CLTCODE = A.CLTCODE                        
      AND L.VTYP = V.VTYPE                        
      AND L.CLTCODE <> @FCODE                        
      AND L2.COSTCODE = @@COSTCODE      
      AND L.VTYP <> 18        
  END      
END      
      
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                        
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                        
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                        
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                        
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                        
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                        
                    
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','','',PROCID,REPDATE, '', ''                        
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                            
                
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0                
    
UPDATE #TBL_GLREPORT SET BRANCHCODE = COSTNAME FROM LEDGER2 L2, COSTMAST C    
WHERE #TBL_GLREPORT.VNO = L2.VNO AND #TBL_GLREPORT.VTYP = L2.VTYPE AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE AND #TBL_GLREPORT.LNO = L2.LNO AND #TBL_GLREPORT.CROSAC = L2.CLTCODE    
AND L2.COSTCODE = C.COSTCODE    
                        
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                        
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                        
SELECT       
      BOOKTYPE,      
      VOUDT VDT ,      
      EFFDT EDT ,      
      SHORTDESC,      
      DRAMT DEBIT,      
      CRAMT CREDIT,      
      VNO,      
      NARRATION,      
      DDNO,      
      CLTCODE,       
      LONGNAME,      
      VTYP,      
      ACCAT,      
      OPBAL,      
      CROSAC,      
      ACNAME,      
      BRANCHCODE,    
   VCHDT                        
FROM       
      #TBL_GLREPORT        
WHERE       
      PROCID = @@SPID                        
ORDER BY       
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_BANKBOOK_NEW_COST
-- --------------------------------------------------
--Exec rpt_Acc_BankBook_New_COST 'Jan  1 2007', 'Feb  2 2007', '01/04/2006', 'BA0095', 'broker', 'broker', '10', 'vdt'
/*SELECT * FROM LEDGER WHERE VNO = '200600007245' AND VTYP = 5
SELECT * FROM LEDGER2 WHERE VNO = '200600007245' AND VTYPE = 5

Exec rpt_Acc_BankBook_New 'Jan 23 2007', 'Jan 23 2007', '01/04/2006', 'BA0095', 'broker', 'broker', '22', 'vdt'*/


 --SELECT DISTINCT L.CLTCODE, A.BRANCHCODE FROM LEDGER L, ACMAST A WHERE L.CLTCODE = A.CLTCODE AND L.VDT >= 'APR  1 2005' AND A.ACCAT = 2  
  
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'MAR 11 2006', '01/04/2005', 'BANK01', 'BROKER', 'GOG', '%'  
  
 /****** OBJECT:  STORED PROCEDURE DBO.RPT_ACC_BANKBOOK_NEW    SCRIPT DATE: 07/08/2005 3:55:36 PM ******/          
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'JUL  5 2005', '01/04/2005', '33117', 'BROKER', 'BROKER', '%'             
--EXEC RPT_ACC_BANKBOOK_NEW '01/04/2005', '31/03/2006', 'JUN  1 2005', 'JUN 29 2005', '33117', '33117', 'BROKER', 'BROKER', '%','VOUCHERDATE', 'ACCOUNT', 'VDT', 'BANK BOOK',''                  
--EXEC RPT_ACC_BANKBOOK_NEW 'JUN  1 2005', 'JUN  1 2005', '01/04/2005', '711129', 'BROKER', 'BROKER', '%'                    
--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'  
CREATE PROC [dbo].[RPT_ACC_BANKBOOK_NEW_COST]  
--EXEC RPT_ACC_BANKBOOK_NEW 'MAY  2 2005', 'MAY  2 2005', 'APR  1 2005', '711129', 'BROKER', 'BROKER', '%'                    
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @FCODE VARCHAR(10),                      
      @STATUSID VARCHAR(30),                      
      @STATUSNAME VARCHAR(30),                      
      @BRANCH VARCHAR(10),  
      @SELECTIONBY VARCHAR(3) = 'VDT'                       
                      
AS                      
                      
DECLARE                      
 @@OPENDATE AS VARCHAR(11),                      
 @@REPDATE AS VARCHAR(8),                      
 @@STARTDATE AS VARCHAR(11),   
 @@COSTCODE AS SMALLINT  
  
  
                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
                    
CREATE TABLE [DBO].[#TBL_GLREPORT] (                    
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                    
 [BOOKTYPE] [CHAR] (2) NULL ,                    
 [VOUDT] [VARCHAR] (10) NULL ,                    
 [EFFDT] [VARCHAR] (10) NULL ,                    
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                    
 [DRAMT] [MONEY] NULL ,                    
 [CRAMT] [MONEY] NULL ,                    
 [VNO] [VARCHAR] (12) NULL ,                    
 [NARRATION] [VARCHAR] (500) NULL ,                    
 [DDNO] [VARCHAR] (15) NULL ,                    
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                    
 [LONGNAME] [VARCHAR] (100) NULL ,                    
 [VDT] [DATETIME] NULL ,                    
 [VTYP] [SMALLINT] NOT NULL ,                    
 [ACCAT] [CHAR] (2) NULL ,                    
 [OPBAL] [MONEY] NOT NULL ,                    
 [CROSAC] [VARCHAR] (10) NOT NULL ,                    
 [ACNAME] [VARCHAR] (100) NULL ,                    
 [BRANCHCODE] [VARCHAR] (10) NULL , 
 [LNO] [INT] NULL,                   
 [PROCID] [BIGINT] NULL ,                    
 [REPDATE] [VARCHAR] (8) NULL ,                    
 [MAINCODE] [VARCHAR] (10) NULL ,                    
 [VCHDT] [DATETIME] NULL                    
)                    
                    
                      
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                    
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID  
  
SELECT @@COSTCODE = -1  
  
IF @STATUSID <> 'BROKER'  
 BEGIN  
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME   
 END  
ELSE IF @STATUSID = 'BROKER'  
 BEGIN  
  IF @BRANCH <> '' OR @BRANCH <> '%'  
   BEGIN  
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH   
   END  
 END  
  
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                      
  
IF @SELECTIONBY = 'VDT'   
BEGIN  
 IF @STATUSID = 'BROKER'  
  BEGIN                      
   IF @BRANCH = '' OR @BRANCH = '%'  
    BEGIN  
     PRINT 'CAME HERE - I'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
     FROM                      
      (SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                           
      FROM   
       LEDGER                          
      WHERE   
       CLTCODE = @FCODE   
       AND VTYP = 18   
       AND VDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       CLTCODE  
      UNION ALL                      
      SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER                            
      WHERE   
       CLTCODE = @FCODE   
       AND VDT >= @@STARTDATE   
       AND VDT <  @FDATE                      
       AND VTYP <> 18                      
      GROUP BY   
       CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
                       
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,
      L.LNO,  
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A                    
     WHERE   
      L.VNO = L1.VNO                    
      AND L.VTYP = L1.VTYP                    
      AND L.BOOKTYPE = L1.BOOKTYPE                    
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L.VTYP <> 18                    
    END  
   ELSE  
    BEGIN  
     PRINT 'CAME HERE - II'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
  FROM                      
      (SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.VTYP = 18   
       AND L.VDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       L2.CLTCODE   
     
      UNION ALL  
     
      SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.VDT >= @@STARTDATE   
       AND L.VDT <  @FDATE   
       AND L2.VTYPE <> 18                      
      GROUP BY   
       L2.CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L2.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,
      L.LNO,  
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
/*      L.VNO = L1.VNO                    
      AND L.VTYP = L1.VTYP                    
      AND L.BOOKTYPE = L1.BOOKTYPE      */              
      L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
 --     AND L.DRCR = L2.DRCR  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L2.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
   
    END  
  END  
 ELSE  
  BEGIN  
   INSERT INTO TBL_OPPBALANCE                            
   SELECT   
    CLTCODE,   
    SUM(OPBAL) AS OPBAL,  
    SPID ,   
    CURDATE   
   FROM                      
    (SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.VTYP = 18   
     AND L.VDT LIKE @@STARTDATE + '%'  
    GROUP BY   
     L2.CLTCODE   
   
    UNION ALL  
   
    SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.VDT >= @@STARTDATE   
     AND L.VDT <  @FDATE   
     AND L2.VTYPE <> 18                      
    GROUP BY   
     L2.CLTCODE) A  
   GROUP BY   
    CLTCODE,   
    SPID,   
    CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,  
      L.LNO,
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
/*      L.VNO = L1.VNO                    
      AND L.VTYP = L1.VTYP                    
      AND L.BOOKTYPE = L1.BOOKTYPE       */             
      L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
 --     AND L.DRCR = L2.DRCR  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L2.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
  END  
END  
ELSE  
BEGIN  
 IF @STATUSID = 'BROKER'  
  BEGIN                      
   IF @BRANCH = '' OR @BRANCH = '%'  
    BEGIN  
     PRINT 'CAME HERE - I'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
     FROM                      
      (SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                           
      FROM   
       LEDGER                          
      WHERE   
       CLTCODE = @FCODE   
       AND VTYP = 18   
       AND EDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       CLTCODE  
      UNION ALL                      
      SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER                            
      WHERE   
       CLTCODE = @FCODE   
       AND EDT >= @@STARTDATE   
       AND EDT <  @FDATE                      
       AND VTYP <> 18                      
      GROUP BY   
       CLTCODE  
      UNION ALL                      
      SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER                            
      WHERE   
       CLTCODE = @FCODE   
       AND VDT < @@STARTDATE   
       AND EDT >= @@STARTDATE   
       AND VTYP <> 18                      
      GROUP BY   
       CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
                       
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,
      L.LNO,  
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A                    
     WHERE   
      L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L.VTYP <> 18                    
    END  
   ELSE  
    BEGIN  
     PRINT 'CAME HERE - II'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
     FROM                      
      (SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.VTYP = 18   
       AND L.EDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       L2.CLTCODE   
     
      UNION ALL  
     
      SELECT   
       L2.CLTCODE,  
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.EDT >= @@STARTDATE   
       AND L.EDT <  @FDATE   
       AND L2.VTYPE <> 18                      
      GROUP BY   
       L2.CLTCODE  
  
      UNION ALL  
     
      SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.EDT >= @@STARTDATE   
       AND L.VDT <  @@STARTDATE   
       AND L2.VTYPE <> 18                      
      GROUP BY   
       L2.CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,  
      L.LNO,
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
      L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
   
    END  
  END  
 ELSE  
  BEGIN  
   INSERT INTO TBL_OPPBALANCE                            
   SELECT   
    CLTCODE,   
    SUM(OPBAL) AS OPBAL,  
    SPID ,   
    CURDATE   
   FROM                      
    (SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
 AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.VTYP = 18   
     AND L.EDT LIKE @@STARTDATE + '%'  
    GROUP BY   
     L2.CLTCODE   
   
    UNION ALL  
   
    SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.EDT >= @@STARTDATE   
     AND L.EDT <  @FDATE                      
     AND L2.VTYPE <> 18                      
    GROUP BY   
     L2.CLTCODE  
   
    UNION ALL  
   
    SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.EDT >= @@STARTDATE   
     AND L.VDT <  @@STARTDATE           
     AND L2.VTYPE <> 18                      
    GROUP BY   
     L2.CLTCODE) A  
   GROUP BY   
    CLTCODE,   
    SPID,   
    CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,  
      L.LNO,
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
      L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L2.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
  END  
END  
  
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                    
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE 
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                    
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                    
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                    
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                    
                
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','','',PROCID,REPDATE, '', ''                    
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                        
            
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0 

UPDATE #TBL_GLREPORT SET BRANCHCODE = COSTNAME FROM LEDGER2 L2, COSTMAST C  
WHERE #TBL_GLREPORT.VNO = L2.VNO AND #TBL_GLREPORT.VTYP = L2.VTYPE AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE AND #TBL_GLREPORT.LNO = L2.LNO AND #TBL_GLREPORT.CROSAC = L2.CLTCODE  
AND L2.COSTCODE = C.COSTCODE             
                    
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                    
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                    
SELECT   
      BOOKTYPE,  
      VOUDT VDT ,  
      EFFDT EDT ,  
      SHORTDESC,  
      DRAMT DEBIT,  
      CRAMT CREDIT,  
      VNO,  
      NARRATION,  
      DDNO,  
      CLTCODE,  
      LONGNAME,  
      VTYP,  
      ACCAT,  
      OPBAL,  
      CROSAC,  
      ACNAME,  
      BRANCHCODE                    
FROM   
      #TBL_GLREPORT    
WHERE   
      PROCID = @@SPID
      AND CLTCODE NOT IN(SELECT BRCONTROLAC FROM BRANCHACCOUNTS)
ORDER BY   
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_BANKBOOK_NEW_ORG
-- --------------------------------------------------
/*
SELECT * FROM LEDGER WHERE VNO = '200600000021' AND VTYP = 3
SELECT * FROM LEDGER2 WHERE VNO = '200600000021' AND VTYPE = 3
Exec rpt_Acc_BankBook_New 'Jan 1 2007', 'Feb 1 2007', '01/04/2006', 'BANK01', 'broker', 'gog', '%', 'vdt' 
*/

 --SELECT DISTINCT L.CLTCODE, A.BRANCHCODE FROM LEDGER L, ACMAST A WHERE L.CLTCODE = A.CLTCODE AND L.VDT >= 'APR  1 2005' AND A.ACCAT = 2  
  
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'MAR 11 2006', '01/04/2005', 'BANK01', 'BROKER', 'GOG', '%'  
  
 /****** OBJECT:  STORED PROCEDURE DBO.RPT_ACC_BANKBOOK_NEW    SCRIPT DATE: 07/08/2005 3:55:36 PM ******/          
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'JUL  5 2005', '01/04/2005', '33117', 'BROKER', 'BROKER', '%'             
--EXEC RPT_ACC_BANKBOOK_NEW '01/04/2005', '31/03/2006', 'JUN  1 2005', 'JUN 29 2005', '33117', '33117', 'BROKER', 'BROKER', '%','VOUCHERDATE', 'ACCOUNT', 'VDT', 'BANK BOOK',''                  
--EXEC RPT_ACC_BANKBOOK_NEW 'JUN  1 2005', 'JUN  1 2005', '01/04/2005', '711129', 'BROKER', 'BROKER', '%'                    
--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'  
CREATE PROC [dbo].[RPT_ACC_BANKBOOK_NEW_ORG]  
--EXEC RPT_ACC_BANKBOOK_NEW 'MAY  2 2005', 'MAY  2 2005', 'APR  1 2005', '711129', 'BROKER', 'BROKER', '%'                    
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @FCODE VARCHAR(10),                      
      @STATUSID VARCHAR(30),                      
      @STATUSNAME VARCHAR(30),                      
      @BRANCH VARCHAR(10),  
      @SELECTIONBY VARCHAR(3) = 'VDT'                       
                      
AS                      
                      
DECLARE                      
 @@OPENDATE AS VARCHAR(11),                      
 @@REPDATE AS VARCHAR(8),                      
 @@STARTDATE AS VARCHAR(11),   
 @@COSTCODE AS SMALLINT  
  
  
                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
                    
CREATE TABLE [DBO].[#TBL_GLREPORT] (                    
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                    
 [BOOKTYPE] [CHAR] (2) NULL ,                    
 [VOUDT] [VARCHAR] (10) NULL ,                    
 [EFFDT] [VARCHAR] (10) NULL ,                    
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                    
 [DRAMT] [MONEY] NULL ,                    
 [CRAMT] [MONEY] NULL ,                    
 [VNO] [VARCHAR] (12) NULL ,                    
 [NARRATION] [VARCHAR] (500) NULL ,                    
 [DDNO] [VARCHAR] (15) NULL ,                    
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                    
 [LONGNAME] [VARCHAR] (100) NULL ,                    
 [VDT] [DATETIME] NULL ,                    
 [VTYP] [SMALLINT] NOT NULL ,                    
 [ACCAT] [CHAR] (2) NULL ,                    
 [OPBAL] [MONEY] NOT NULL ,                    
 [CROSAC] [VARCHAR] (10) NOT NULL ,                    
 [ACNAME] [VARCHAR] (100) NULL ,                    
 [BRANCHCODE] [VARCHAR] (10) NULL ,                    
 [LNO] [INT] NULL,
 [PROCID] [BIGINT] NULL ,                    
 [REPDATE] [VARCHAR] (8) NULL ,                    
 [MAINCODE] [VARCHAR] (10) NULL ,                    
 [VCHDT] [DATETIME] NULL                    
)                    
                    
                      
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                    
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID  
  
SELECT @@COSTCODE = -1  
  
IF @STATUSID <> 'BROKER'  
 BEGIN  
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME   
 END  
ELSE IF @STATUSID = 'BROKER'  
 BEGIN  
  IF @BRANCH <> '' OR @BRANCH <> '%'  
   BEGIN  
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH   
   END  
 END  

SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                      
  
IF @SELECTIONBY = 'VDT'   
BEGIN  
 IF @STATUSID = 'BROKER'  
  BEGIN                      
   IF @BRANCH = '' OR @BRANCH = '%'  
    BEGIN  
     PRINT 'CAME HERE - I'  
     INSERT INTO TBL_OPPBALANCE   
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
     FROM                      
      (SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                           
      FROM   
       LEDGER                          
      WHERE   
       CLTCODE = @FCODE   
       AND VTYP = 18   
       AND VDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       CLTCODE  
      UNION ALL                      
      SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER                            
      WHERE   
       CLTCODE = @FCODE   
       AND VDT >= @@STARTDATE   
       AND VDT <  @FDATE                      
       AND VTYP <> 18                      
      GROUP BY   
       CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
                       
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,
      L.LNO,  
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A                    
     WHERE   
      L.VNO = L1.VNO                    
      AND L.VTYP = L1.VTYP                    
      AND L.BOOKTYPE = L1.BOOKTYPE                    
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L.VTYP <> 18                    
    END  
   ELSE  
    BEGIN  
     PRINT 'CAME HERE - II'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
     FROM                      
      (SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.VTYP = 18   
       AND L.VDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       L2.CLTCODE   
     
      UNION ALL  
     
      SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.VDT >= @@STARTDATE   
       AND L.VDT <  @FDATE   
       AND L2.VTYPE <> 18                      
      GROUP BY   
       L2.CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L2.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,
      L.LNO,  
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
      L.VNO = L1.VNO                    
      AND L.VTYP = L1.VTYP                    
      AND L.BOOKTYPE = L1.BOOKTYPE                    
      AND L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
 --     AND L.DRCR = L2.DRCR  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L2.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
   
    END  
  END  
 ELSE  
  BEGIN  
   INSERT INTO TBL_OPPBALANCE                            
   SELECT   
    CLTCODE,   
    SUM(OPBAL) AS OPBAL,  
    SPID ,   
    CURDATE   
   FROM                      
    (SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.VTYP = 18   
     AND L.VDT LIKE @@STARTDATE + '%'  
    GROUP BY   
     L2.CLTCODE   
   
    UNION ALL  
   
    SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.VDT >= @@STARTDATE   
     AND L.VDT <  @FDATE   
     AND L2.VTYPE <> 18                      
    GROUP BY   
     L2.CLTCODE) A  
   GROUP BY   
    CLTCODE,   
    SPID,   
    CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),     
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,
      L.LNO,  
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
      L.VNO = L1.VNO                    
      AND L.VTYP = L1.VTYP                    
      AND L.BOOKTYPE = L1.BOOKTYPE                    
      AND L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
 --     AND L.DRCR = L2.DRCR  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
  END  
END  
ELSE  
BEGIN  
 IF @STATUSID = 'BROKER'  
  BEGIN                      
   IF @BRANCH = '' OR @BRANCH = '%'  
    BEGIN  
     PRINT 'CAME HERE - I'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
     FROM                      
      (SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                           
      FROM   
       LEDGER                          
      WHERE   
       CLTCODE = @FCODE   
       AND VTYP = 18   
       AND EDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       CLTCODE  
      UNION ALL                      
      SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER                            
      WHERE   
       CLTCODE = @FCODE   
       AND EDT >= @@STARTDATE   
       AND EDT <  @FDATE                      
       AND VTYP <> 18                      
      GROUP BY   
       CLTCODE  
      UNION ALL                      
      SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER                            
      WHERE   
       CLTCODE = @FCODE   
       AND VDT < @@STARTDATE   
       AND EDT >= @@STARTDATE   
       AND VTYP <> 18                      
      GROUP BY   
       CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE   
   
                       
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE, 
      L.LNO, 
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A                    
     WHERE   
      L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L.VTYP <> 18                    
    END  
   ELSE  
    BEGIN  
     PRINT 'CAME HERE - II'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
     FROM                      
      (SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.VTYP = 18   
       AND L.EDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       L2.CLTCODE   
     
      UNION ALL  
     
      SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.EDT >= @@STARTDATE   
       AND L.EDT <  @FDATE   
       AND L2.VTYPE <> 18                      
      GROUP BY   
       L2.CLTCODE  
  
      UNION ALL  
     
      SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.EDT >= @@STARTDATE   
       AND L.VDT <  @@STARTDATE   
       AND L2.VTYPE <> 18                      
      GROUP BY   
       L2.CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE, 
      L.LNO, 
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
      L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
   
    END  
  END  
 ELSE  
  BEGIN  
   INSERT INTO TBL_OPPBALANCE                            
   SELECT   
    CLTCODE,   
    SUM(OPBAL) AS OPBAL,  
    SPID ,   
    CURDATE   
   FROM                      
    (SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.VTYP = 18   
     AND L.EDT LIKE @@STARTDATE + '%'  
    GROUP BY   
     L2.CLTCODE   
   
    UNION ALL  
   
    SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.EDT >= @@STARTDATE   
     AND L.EDT <  @FDATE                      
     AND L2.VTYPE <> 18                      
    GROUP BY   
     L2.CLTCODE  
   
    UNION ALL  
   
    SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.EDT >= @@STARTDATE   
     AND L.VDT <  @@STARTDATE           
     AND L2.VTYPE <> 18                      
    GROUP BY   
     L2.CLTCODE) A  
   GROUP BY   
    CLTCODE,   
    SPID,   
    CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),     
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,  
      L.LNO,
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
      L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
  END  
END  
  
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                    
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                    
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                    
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                    
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                    
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                    
                
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','','',PROCID,REPDATE, '', ''                    
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                        
            
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0            

UPDATE #TBL_GLREPORT SET BRANCHCODE = COSTNAME FROM LEDGER2 L2, COSTMAST C
WHERE #TBL_GLREPORT.VNO = L2.VNO AND #TBL_GLREPORT.VTYP = L2.VTYPE AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE AND #TBL_GLREPORT.LNO = L2.LNO AND #TBL_GLREPORT.CROSAC = L2.CLTCODE
AND L2.COSTCODE = C.COSTCODE
                    
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                    
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                    
SELECT   
      BOOKTYPE,  
      VOUDT VDT ,  
      EFFDT EDT ,  
      SHORTDESC,  
      DRAMT DEBIT,  
      CRAMT CREDIT,  
      VNO,  
      NARRATION,  
      DDNO,  
      CLTCODE,   
      LONGNAME,  
      VTYP,  
      ACCAT,  
      OPBAL,  
      CROSAC,  
      ACNAME,  
      BRANCHCODE                    
FROM   
      #TBL_GLREPORT    
WHERE   
      PROCID = @@SPID                    
ORDER BY   
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_CashBook
-- --------------------------------------------------
CREATE  Proc [dbo].[rpt_Acc_CashBook]        
@sdate varchar(11),            /* As mmm dd yyyy */                                  
@edate varchar(11),            /* As mmm dd yyyy */                                  
@fdate varchar(11),            /* As mmm dd yyyy */                                  
@tdate varchar(11),            /* As mmm dd yyyy */                                  
@fcode varchar(10),                                  
@tcode varchar(10),                                  
@statusId varchar(30),                                  
@statusname varchar(30),                                  
@branch varchar(10),                                  
@selectionby varchar(3),                                  
@GroupBy varchar(10),                                  
@Sortby varchar(50),                                  
@reportname varchar(30),                                  
@reportopt varchar(10)                                  
                                  
AS                                  
                                  
declare                                   
@@opendate as varchar(11),                
@@RepDate as varchar(8)                                  
                
                             
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
/*        
Exec rpt_Acc_GlReport_uk '01/04/2005', '31/03/2006', 'Apr  1 2005', 'Apr  5 2005', '99985', '99985', 'broker', 'broker', '%','vdt', 'Account', 'VDT', 'GL',''               
	
        
*/        
                
              
                
Select @@RepDate= convert(varchar,getdate(),112)                                  
Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18'  and vdt <= @fdate                                               
              
Delete Tbl_GLReport where procid = @@SPID        
Delete Tbl_OppBalance where procid = @@SPID         
                
                         
if @selectionby = 'vdt'                                  
BEGIN                                  
 if rtrim(@branch) = '' or rtrim(@branch) = '%'                                   
  BEGIN                                      
     Insert into Tbl_OppBalance                              
     Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal,@@SPID,@@RepDate                                  
     from ledger    with(index(lededtind))                                    
     where cltcode between @fcode and @tcode and vdt between @@opendate and @fdate                                 
     Group by cltcode                             
                                     
     Insert into Tbl_GLReport                                  
      Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,                                  
      dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                    
      cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),                                   
       l.vno, Replace( l.narration,'"','') narration,                                  
      ddno = (case when isnull(l1.ddno,'')='0' then '' else isnull(l1.ddno,'') end),         
      l.cltcode , a.longname,vdt, l.vtyp,                                  
      accat,opbal=0,crosac='',   a.acname,a.branchcode,@@SPID,@@RepDate                                  
      from Ledger l with(index(lededtind))    
      left outer join (select vtyp, booktype, vno, ddno= max(ddno) from ledger1 group by vtyp, booktype, vno) l1    
      on (l1.vtyp=l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno),     
       Acmast a with(index(acmastind)) ,Vmast v                                                        
      Where l.cltcode between @fcode and @tcode        
      and l.cltcode = a.cltcode          
      and l.vdt between @fdate and @tdate + ' 23:59:59'             
      and l.vtyp <> '18'           
      And l.vtyp = v.vtype         
      and a.accat =  '1'    
                         
  END                                  
ELSE                                  
  BEGIN                                  
        
       insert into Tbl_OppBalance                           
     Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal,@@SPID,@@RepDate         
     from ledger2 l2, ledger l with(index(PartyVdt)), costmast c with(index(cstinx))                                  
     where vdt between @@opendate and @fdate                   
     and l.vno=l2.vno and l.lno=l2.lno                                  
     and l.vtyp=l2.vtype         
     and l.booktype=l2.booktype         
     and costname = rtrim(@branch)                                   
     and l2.costcode = c.costcode                                  
     and l2.cltcode between @fcode and @tcode         
     Group by l2.cltcode                                  
                               
   insert into Tbl_GLReport                                  
     Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,                                   
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                                    
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                                   
     l.vno, Replace( l.narration,'"','') narration,                     
      ddno = (case when isnull(l1.ddno,'')='0' then '' else isnull(l1.ddno,'') end),         
     l2.cltcode , a.longname,vdt, l.vtyp,                                  
     accat,  opbal=0,crosac='',a.acname,a.branchcode ,@@SPID,@@RepDate                
     from ledger l with(index(PartyVdt))     
  left outer join (select vtyp, booktype, vno, ddno= max(ddno) from ledger1 group by vtyp, booktype, vno) l1    
     on (l1.vtyp=l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno),     
  vmast v, ledger2 l2 with(index(TypeNo)), acmast a with(index(acmastind)),  costmast c with(index(cstinx))                                     
      Where  l.vdt between @fdate and @tdate + ' 23:59:59'        
   and  l.vno = l2.vno          
   and l.vtyp = l2.vtype         
   and l.vtyp = v.vtype         
   and l.booktype = l2.booktype         
   and l.lno = l2.lno         
      and l2.cltcode between @fcode and  @tcode          
   and l2.cltcode=a.cltcode          
   and a.accat <> '4'                                   
      and costname = rtrim(@branch)                                   
      and l2.costcode = c.costcode          
   and  l2.vtype <> 18                              
   END                                  
END                                  
ELSE                                  
BEGIN                                  
  if rtrim(@branch) = '' or rtrim(@branch) = '%'                                   
   BEGIN                                      
     insert into Tbl_OppBalance                               
     Select cltcode, sum(opbal) opbal,@@SPID,@@RepDate  from                                  
      (                              
       Select Cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger  with(index(lededtind))                                 
       where Cltcode between @fcode and @tcode and vdt between @@opendate and @fdate                                  
       Group by Cltcode                                  
       union                                  
      Select cltcode,sum(case drcr when 'C' then vamt else -vamt end) as opbal from ledger   with(index(lededtind))                                 
      Where cltcode between  @fcode and  @tcode and vdt < @@opendate and edt >= @@opendate                                  
      Group by cltcode) t                                
      Group by cltcode                
        
        
        
    insert into Tbl_GLReport                                  
      Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,                                  
      dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                    
      cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,                                   
      Replace( l.narration,'"','') narration,                                  
      ddno = (case when isnull(l1.ddno,'')='0' then '' else isnull(l1.ddno,'') end),         
       l.cltcode , a.longname,vdt, l.vtyp,                                  
      accat,opbal=0,crosac='',  a.acname,a.branchcode,@@SPID,@@RepDate                
      from Ledger l with(index(lededtind))    
  left outer join (select vtyp, booktype, vno, ddno= max(ddno) from ledger1 group by vtyp, booktype, vno) l1    
     on (l1.vtyp=l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno),     
    Acmast a with(index(acmastind)) ,Vmast v                                                        
      Where l.cltcode between @fcode and @tcode        
      and l.cltcode = a.cltcode          
      and l.edt between @fdate and @tdate + ' 23:59:59'             
      and l.vtyp <> '18'           
      And l.vtyp = v.vtype         
      and a.accat =  '1'    
        
   END                                  
  ELSE                                  
   BEGIN                                      
     insert into Tbl_OppBalance                               
     Select cltcode, sum(opbal) opbal,@@SPID,@@RepDate  from                                  
      (                              
      Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal         
       from ledger2 l2, ledger l with(index(PartyVdt)), costmast c with(index(cstinx))                                  
       where vdt between @@opendate and @fdate                   
       and l.vno=l2.vno and l.lno=l2.lno                                  
       and l.vtyp=l2.vtype         
       and l.booktype=l2.booktype         
       and costname = rtrim(@branch)                                   
       and l2.costcode = c.costcode                                  
       and l2.cltcode between @fcode and @tcode         
       Group by l2.cltcode                                  
       union                                  
                                  
       Select l2.cltcode,sum(case l2.drcr when 'C' then camt else -camt end) as opbal         
       from ledger2 l2, ledger l with(index(PartyVdt)), costmast c with(index(cstinx))                                  
       where vdt < @@opendate and edt >= @@opendate         
       and l.vno=l2.vno         
       and l.vtyp=l2.vtype         
       and l.booktype=l2.booktype         
       and l.lno=l2.lno                   
       and costname = rtrim(@branch)                                   
       and l2.costcode = c.costcode                                  
       and l2.cltcode between @fcode and @tcode         
       Group by l2.cltcode) t        
       Group by cltcode                                  
        
        
        
    insert into Tbl_GLReport                                  
     Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,                                   
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                                    
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                                   
     l.vno, Replace( l.narration,'"','') narration,                     
      ddno = (case when isnull(l1.ddno,'')='0' then '' else isnull(l1.ddno,'') end),         
     l2.cltcode , a.longname,vdt, l.vtyp,                                    
     accat,   opbal=0,crosac='',a.acname,a.branchcode,@@SPID,@@RepDate                
      from ledger l with(index(PartyVdt))    
  left outer join (select vtyp, booktype, vno, ddno= max(ddno) from ledger1 group by vtyp, booktype, vno) l1    
     on (l1.vtyp=l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno),     
  vmast v, ledger2 l2 with(index(TypeNo)), acmast a with(index(acmastind)),  costmast c with(index(cstinx))                                     
       Where  l.edt between @fdate and @tdate + ' 23:59:59'        
    and  l.vno = l2.vno          
    and l.vtyp = l2.vtype         
    and l.vtyp = v.vtype         
    and l.booktype = l2.booktype         
    and l.lno = l2.lno         
       and l2.cltcode between @fcode and  @tcode          
    and l2.cltcode=a.cltcode          
    and a.accat <> '4'                                   
       and costname = rtrim(@branch)                                   
       and l2.costcode = c.costcode          
    and  l2.vtype <> '18'        
   END                                  
END                                  
          
                              
Update Tbl_GLReport set opbal = Tbl_OppBalance.oppbal,crosac=''  from Tbl_OppBalance             
where Tbl_GLReport.cltcode = Tbl_OppBalance.cltcode  and Tbl_OppBalance.procid = @@SPID and Tbl_OppBalance.ProcId =Tbl_GLReport.Procid            
            
                                  
Update Tbl_GLReport         
set crosac = l.cltcode          
from ledger l  with(index(partyvdt))                        
where         
Tbl_GLReport.vno = l.vno                         
and Tbl_GLReport.vtyp = l.vtyp                         
and Tbl_GLReport.vtyp  in ('3','2')                         
and Tbl_GLReport.booktype = l.booktype                         
and Tbl_GLReport.cltcode <> l.cltcode                                   
and procid = @@SPID                      
                           
          
                
Select booktype,voudt vdt ,effdt edt ,shortdesc,dramt Debit,cramt Credit,vno,narration,ddno,cltcode,longname,vtyp,accat,opbal,crosac,acname,branchcode      
from Tbl_GLReport  where procid = @@SPID        
Order By CltCode , year(vdt),month(vdt),day(vdt), vtyp desc, vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_CashBook_New
-- --------------------------------------------------
/*select * from ledger where cltcode = 'CASH01' and vtyp = 18 and vdt like 'Apr  1 2007%'

SELECT       
      CLTCODE,      
      SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL,      
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                               
     FROM       
      LEDGER                              
     WHERE       
      CLTCODE = 'CASH01'       
      
      AND VDT >= 'Apr  1 2007' and vdt < 'Jul 21 2007'
     GROUP BY       
      CLTCODE      


select * from ledger where vno = '200707200001' and cltcode = 'CASH01'

Exec rpt_Acc_CashBook_New 'Jul 20 2007', 'Jul 30 2007', '01/04/2007', 'CASH01', 'broker', 'broker', '%'*/

CREATE PROC [dbo].[rpt_Acc_CashBook_New]      
--EXEC RPT_ACC_BANKBOOK_NEW 'MAY  2 2005', 'MAY  2 2005', 'APR  1 2005', '711129', 'BROKER', 'BROKER', '%'                        
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @FCODE VARCHAR(10),                          
      @STATUSID VARCHAR(30),                          
      @STATUSNAME VARCHAR(30),                          
      @BRANCH VARCHAR(10)                          
                          
AS                          
                          
DECLARE                          
 @@OPENDATE AS VARCHAR(11),                          
 @@REPDATE AS VARCHAR(8),                          
 @@STARTDATE AS VARCHAR(11),       
 @@COSTCODE AS SMALLINT      
      
      
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
                        
CREATE TABLE [DBO].[#TBL_GLREPORT] (                        
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                        
 [BOOKTYPE] [CHAR] (2) NULL ,                        
 [VOUDT] [VARCHAR] (10) NULL ,                        
 [EFFDT] [VARCHAR] (10) NULL ,                        
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                        
 [DRAMT] [MONEY] NULL ,                        
 [CRAMT] [MONEY] NULL ,                        
 [VNO] [VARCHAR] (12) NULL ,                        
 [NARRATION] [VARCHAR] (500) NULL ,                        
 [DDNO] [VARCHAR] (15) NULL ,                        
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                        
 [LONGNAME] [VARCHAR] (100) NULL ,                        
 [VDT] [DATETIME] NULL ,                        
 [VTYP] [SMALLINT] NOT NULL ,                        
 [ACCAT] [CHAR] (2) NULL ,                        
 [OPBAL] [MONEY] NOT NULL ,                        
 [CROSAC] [VARCHAR] (10) NOT NULL ,                        
 [ACNAME] [VARCHAR] (100) NULL ,                        
 [BRANCHCODE] [VARCHAR] (10) NULL ,                        
 [PROCID] [BIGINT] NULL ,                        
 [REPDATE] [VARCHAR] (8) NULL ,                        
 [MAINCODE] [VARCHAR] (10) NULL ,                        
 [VCHDT] [DATETIME] NULL                        
)                        
                        
                          
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                        
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID      
      
SELECT @@COSTCODE = -1      
      
IF @STATUSID <> 'BROKER'      
 BEGIN      
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME       
 END      
ELSE IF @STATUSID = 'BROKER'      
 BEGIN      
  IF @BRANCH <> '' OR @BRANCH <> '%'      
   BEGIN      
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH       
   END      
 END      
      
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                          
      
IF @STATUSID = 'BROKER'      
 BEGIN                          
  IF @BRANCH = '' OR @BRANCH = '%'      
   BEGIN      
    PRINT 'CAME HERE - I'      
    INSERT INTO TBL_OPPBALANCE                                
    SELECT       
     CLTCODE,       
     SUM(OPBAL) AS OPBAL,      
     SPID ,       
     CURDATE       
    FROM                       
     (SELECT       
      CLTCODE,      
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,      
      @@SPID AS SPID,       
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                               
     FROM       
      LEDGER                              
     WHERE       
      CLTCODE = @FCODE       
      AND VTYP = 18       
      AND VDT LIKE @@STARTDATE + '%'      
     GROUP BY       
      CLTCODE      
     UNION ALL                          
     SELECT       
      CLTCODE,      
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,      
  @@SPID AS SPID,       
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
     FROM       
      LEDGER                                
     WHERE       
      CLTCODE = @FCODE       
      AND VDT >= @@STARTDATE       
      AND VDT <  @FDATE                          
      AND VTYP <> 18                          
     GROUP BY       
      CLTCODE) A      
    GROUP BY       
     CLTCODE,       
     SPID,       
     CURDATE      
      
                          
    INSERT INTO #TBL_GLREPORT                        
    SELECT       
     L.BOOKTYPE,                           
     VOUDT=CONVERT(VARCHAR,L.VDT,103),       
     EFFDT=CONVERT(VARCHAR,L.EDT,103),       
     ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                    
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                  
     L.VNO,       
     REPLACE( L.NARRATION,'"','') NARRATION,                                                     
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
     L.CLTCODE ,      
     A.LONGNAME,      
     VDT,       
     L.VTYP,                                                                    
     ACCAT,       
     OPBAL=0,      
     CROSAC='',      
     A.ACNAME,      
     A.BRANCHCODE,      
     @@SPID,       
     CONVERT(VARCHAR,GETDATE(),112), '',       
     L.VDT                        
    FROM       
     LEDGER L         
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
     VMAST V, ACMAST A                        
    WHERE       
     L.VNO = LL.VNO                        
     AND L.VTYP = LL.VTYP                        
     AND L.BOOKTYPE = LL.BOOKTYPE                        
     AND L.CLTCODE = A.CLTCODE                        
     AND L.VTYP = V.VTYPE                        
     AND L.CLTCODE <> @FCODE                        
     AND L.VTYP <> 18                        
   END      
  ELSE      
   BEGIN      
    PRINT 'CAME HERE - II'      
    INSERT INTO TBL_OPPBALANCE                                
    SELECT       
     CLTCODE,       
     SUM(OPBAL) AS OPBAL,      
     SPID ,       
     CURDATE       
    FROM                          
     (SELECT       
      L2.CLTCODE,      
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
      @@SPID AS SPID,       
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE      
     FROM       
      LEDGER L, LEDGER2 L2      
     WHERE       
      L.VNO = L2.VNO      
      AND L.VTYP = L2.VTYPE      
      AND L.BOOKTYPE = L2.BOOKTYPE      
      AND L.DRCR = L2.DRCR      
      AND L.CLTCODE = L2.CLTCODE      
      AND L2.CLTCODE = @FCODE       
      AND L2.COSTCODE = @@COSTCODE      
      AND L.VTYP = 18       
      AND L.VDT LIKE @@STARTDATE + '%'      
     GROUP BY       
      L2.CLTCODE       
        
     UNION ALL      
  
     SELECT       
      L2.CLTCODE,      
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
      @@SPID AS SPID,       
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
     FROM       
      LEDGER L, LEDGER2 L2      
     WHERE       
      L.VNO = L2.VNO      
      AND L.VTYP = L2.VTYPE      
      AND L.BOOKTYPE = L2.BOOKTYPE      
      AND L.DRCR = L2.DRCR      
      AND L.CLTCODE = L2.CLTCODE      
      AND L2.CLTCODE = @FCODE       
      AND L2.COSTCODE = @@COSTCODE      
      AND L.VDT >= @@STARTDATE       
      AND L.VDT <  @FDATE       
      AND L2.VTYPE <> 18                          
 GROUP BY       
      L2.CLTCODE) A      
    GROUP BY       
     CLTCODE,       
     SPID,       
     CURDATE      
  
    INSERT INTO #TBL_GLREPORT                        
    SELECT       
     L.BOOKTYPE,                           
     VOUDT=CONVERT(VARCHAR,L.VDT,103),       
     EFFDT=CONVERT(VARCHAR,L.EDT,103),       
     ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                    
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                  
     L.VNO,       
     REPLACE( L.NARRATION,'"','') NARRATION,                                                     
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
     L.CLTCODE ,      
     A.LONGNAME,      
     VDT,       
     L.VTYP,                                                                    
     ACCAT,       
     OPBAL=0,      
     CROSAC='',      
     A.ACNAME,      
     A.BRANCHCODE,      
     @@SPID,       
     CONVERT(VARCHAR,GETDATE(),112), '',       
     L.VDT                        
    FROM       
     LEDGER L         
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
     VMAST V, ACMAST A, LEDGER2 L2                        
    WHERE       
      L.VNO = L2.VNO      
     AND L.VTYP = L2.VTYPE       
     AND L.BOOKTYPE = L2.BOOKTYPE      
     AND L.LNO = L2.LNO      
     AND L.DRCR = L2.DRCR      
     AND L.VNO = LL.VNO                        
     AND L.VTYP = LL.VTYP                        
     AND L.BOOKTYPE = LL.BOOKTYPE                        
     AND L.CLTCODE = A.CLTCODE                        
     AND L.VTYP = V.VTYPE                        
     AND L.CLTCODE <> @FCODE                        
     AND L2.COSTCODE = @@COSTCODE      
     AND L.VTYP <> 18      
      
   END      
 END      
ELSE      
 BEGIN      
  INSERT INTO TBL_OPPBALANCE                                
  SELECT       
   CLTCODE,       
   SUM(OPBAL) AS OPBAL,      
   SPID ,       
   CURDATE       
  FROM                          
   (SELECT       
    L2.CLTCODE,      
    SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
    @@SPID AS SPID,       
    CONVERT(VARCHAR,GETDATE(),112) AS CURDATE      
   FROM       
    LEDGER L, LEDGER2 L2      
   WHERE       
    L.VNO = L2.VNO      
    AND L.VTYP = L2.VTYPE      
    AND L.BOOKTYPE = L2.BOOKTYPE      
    AND L.DRCR = L2.DRCR      
    AND L.CLTCODE = L2.CLTCODE      
    AND L2.CLTCODE = @FCODE       
    AND L2.COSTCODE = @@COSTCODE      
    AND L.VTYP = 18       
    AND L.VDT LIKE @@STARTDATE + '%'      
   GROUP BY       
    L2.CLTCODE       
      
   UNION ALL      
      
   SELECT       
    L2.CLTCODE,      
    SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,      
    @@SPID AS SPID,       
    CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                          
   FROM       
    LEDGER L, LEDGER2 L2      
   WHERE       
    L.VNO = L2.VNO      
    AND L.VTYP = L2.VTYPE      
    AND L.BOOKTYPE = L2.BOOKTYPE      
    AND L.DRCR = L2.DRCR      
    AND L.CLTCODE = L2.CLTCODE      
    AND L2.CLTCODE = @FCODE       
    AND L2.COSTCODE = @@COSTCODE      
    AND L.VDT >= @@STARTDATE       
    AND L.VDT <  @FDATE                          
    AND L2.VTYPE <> 18                          
   GROUP BY       
    L2.CLTCODE) A      
  GROUP BY       
   CLTCODE,       
   SPID,       
   CURDATE      
      
    INSERT INTO #TBL_GLREPORT                        
    SELECT       
     L.BOOKTYPE,                           
     VOUDT=CONVERT(VARCHAR,L.VDT,103),       
     EFFDT=CONVERT(VARCHAR,L.EDT,103),        ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                    
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                  
     L.VNO,       
     REPLACE( L.NARRATION,'"','') NARRATION,                                                     
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
     L.CLTCODE ,      
     A.LONGNAME,      
     VDT,       
     L.VTYP,                                                                    
     ACCAT,       
     OPBAL=0,      
     CROSAC='',      
     A.ACNAME,      
     A.BRANCHCODE,      
     @@SPID,       
     CONVERT(VARCHAR,GETDATE(),112), '',       
     L.VDT                        
    FROM       
     LEDGER L         
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
     VMAST V, ACMAST A, LEDGER2 L2                        
    WHERE       
     L.VNO = L1.VNO                        
     AND L.VTYP = L1.VTYP                        
     AND L.BOOKTYPE = L1.BOOKTYPE                        
     AND L.VNO = L2.VNO      
     AND L.VTYP = L2.VTYPE       
     AND L.BOOKTYPE = L2.BOOKTYPE      
     AND L.LNO = L2.LNO      
     AND L.DRCR = L2.DRCR      
     AND L.VNO = LL.VNO                        
     AND L.VTYP = LL.VTYP                        
     AND L.BOOKTYPE = LL.BOOKTYPE                        
     AND L.CLTCODE = A.CLTCODE                        
     AND L.VTYP = V.VTYPE                        
     AND L.CLTCODE <> @FCODE                        
     AND L2.COSTCODE = @@COSTCODE      
     AND L.VTYP <> 18        
 END      
      
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                        
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                        
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                        
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                        
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                        
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                        
                    
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','',PROCID,REPDATE, '', ''                        
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                            
                
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0                
                        
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                        
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                        
SELECT       
      BOOKTYPE,      
      VOUDT VDT ,      
      EFFDT EDT ,      
      SHORTDESC,      
      DRAMT DEBIT,      
      CRAMT CREDIT,      
      VNO,      
      NARRATION,      
      DDNO,      
      CLTCODE,       
      LONGNAME,      
      VTYP,      
      ACCAT,      
      OPBAL,      
    CROSAC,      
      ACNAME,      
      BRANCHCODE                        
FROM       
      #TBL_GLREPORT        
WHERE       
      PROCID = @@SPID                        
ORDER BY       
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GLBook_New
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_Acc_GLBook_New    Script Date: 01/12/2006 16:12:07 ******/
Create Proc [dbo].[rpt_Acc_GLBook_New]        
--Exec rpt_Acc_GlBook_New 'Apr 26 2005', 'Apr 26 2005', '01/04/2005', '771630', '771630', 'broker', 'broker', '%'      
@fdate varchar(11),            /* As mmm dd yyyy */        
@tdate varchar(11),            /* As mmm dd yyyy */        
@sdate varchar(10),            /* As mmm dd yyyy */        
@fcode varchar(10),        
@tcode varchar(10),      
@statusId varchar(30),        
@statusname varchar(30),        
@branch varchar(10)        
        
AS        
        
declare        
@@opendate as varchar(11),        
@@RepDate as varchar(8),        
@@StartDate As Varchar(11)        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
Delete Tbl_GLReport_New where procid = @@SPID                      
Delete Tbl_OppBalance where procid = @@SPID                       
        
Select @@StartDate = Left(Convert(Varchar, Convert(DateTime, '01/04/2005',103), 109), 11)        
        
Insert Into Tbl_OppBalance        
Select cltcode,sum(case drcr when 'C' then vamt else -vamt end) as opbal,@@SPID, convert(varchar,getdate(),112)        
 from ledger 
 where cltcode between @fcode and @tcode and vdt >= @@StartDate and vdt <  @fdate        
 Group by cltcode        
        
        
Insert Into Tbl_GLReport_New      
select l.booktype,         
  voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,                                                 
  dramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),                                                  
  cramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                
  l.vno, Replace( l.narration,'"','') narration,                                   
  ddno = (case when isnull(l1.ddno,'')='0' then '' else isnull(l1.ddno,'') end),                       
  l.cltcode, a.longname,vdt, l.vtyp,                                                  
  accat, opbal=0,crosac='',a.acname,a.branchcode,@@SPID, convert(varchar,getdate(),112), LL.CltCode As MainCode      
 from ledger l 
  left join (select vtyp, booktype, vno, ddno= max(ddno) from ledger1 group by vtyp, booktype, vno) l1        
  on (l1.vtyp=l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno),      
  (select vno, vtyp, booktype, cltcode,drcr from ledger where vdt between @fdate and @tdate + ' 23:59:59' and cltcode between @fcode and @tcode) LL,      
vmast v, acmast a        
where       
l.vno = ll.vno        
and l.vtyp = ll.vtyp        
and l.booktype = ll.booktype       
and l.cltcode = a.cltcode        
and l.drcr=ll.drcr      
and l.vtyp = v.vtype        
and l.vtyp <> 18      
update Tbl_GLReport_New set narration = rtrim(longname) + ' - ' + rtrim(narration) where procid = @@spid        
Update Tbl_GLReport_New set opbal = Tbl_OppBalance.oppbal,crosac=''  from Tbl_OppBalance        
where Tbl_OppBalance.cltcode = Tbl_GlReport_New.MainCode and Tbl_OppBalance.procid = @@SPID and Tbl_OppBalance.ProcId =Tbl_GLReport_New.Procid        
Delete From Tbl_GLReport_New Where cltcode Between @fcode and @tcode and procid = @@spid      
update Tbl_GLReport_New set crosac = cltcode where procid = @@spid      
update Tbl_GLReport_New set cltcode = MainCode where procid = @@spid        
update Tbl_GLReport_New set acname = a.acname from acmast a where Tbl_GLReport_New.cltcode = a.cltcode and Tbl_GLReport_New.procid = @@spid        
update Tbl_GLReport_New set DRAMT = CRAMT, CRAMT = DRAMT      
      
--select * from Tbl_OppBalance where procid = @@spid        
--select * from Tbl_GLReport where procid = @@spid        
Select booktype,voudt ,effdt ,shortdesc,dramt ,cramt ,vno,narration,ddno,cltcode,longname,vtyp,accat,opbal,crosac,acname,branchcode                    
from Tbl_GLReport_New  where procid = @@SPID                      
Order By CltCode , vdt, vtyp desc, vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GlReport
-- --------------------------------------------------
CREATE  Proc rpt_Acc_GlReport                               
@sdate varchar(11),            /* As mmm dd yyyy */                              
@edate varchar(11),            /* As mmm dd yyyy */                              
@fdate varchar(11),            /* As mmm dd yyyy */                              
@tdate varchar(11),            /* As mmm dd yyyy */                              
@fcode varchar(10),                              
@tcode varchar(10),                              
@statusId varchar(30),                              
@statusname varchar(30),                              
@branch varchar(10),                              
@selectionby varchar(3),                              
@GroupBy varchar(10),                              
@Sortby varchar(50),                              
@reportname varchar(30),                              
@reportopt varchar(10)                              
                              
AS                              
                              
declare                               
@@opendate as varchar(11)                              
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                              
--Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18'           
            
select @@OpenDate = left(convert(varchar,sdtcur,109),11) from parameter where @fdate between sdtcur and ldtcur            
          
                      
--SELECT @@OPENDATE = CONVERT(VARCHAR(11),convert(datetime,@SDATE, 103),109)                          
                              
Select cltcode,vamt as opbal into #opbal from ledger  where 1 =2                              
                              
 Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                              
  dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                
  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,                               
  Replace( l.narration,'"','') narration,                              
  ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and                              
  booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                              
  accat,Vamt as opbal,crosac=l.cltcode,                              
  isnull(a.acname,'') acname,isnull(a.branchcode,'') branchcode, lno                          
 into #temptable_gl                              
From Ledger l , Acmast a ,Vmast v  where 1 = 2                          
                              
                            
if @selectionby = 'vdt'                              
BEGIN                              
if rtrim(@branch) = '' or rtrim(@branch) = '%'                               
 BEGIN                    
if @@opendate=@fdate    
 begin      
  Insert into #opbal                          
  Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                               
  where cltcode between @fcode and @tcode and vdt like  @@opendate + '%' and vtyp=18                           
  Group by cltcode                               
  Order by cltcode                               
 end                       
else     
  begin     
 Insert into #opbal                          
    Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                               
    where cltcode between @fcode and @tcode and vdt >= @@opendate and vdt <@fdate    
    Group by cltcode                               
    Order by cltcode                               
   end    
                               
  Insert into #temptable_gl                              
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                              
   dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                
   cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno, Replace( l.narration,'"','') narration,                              
   ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and                              
   booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                              
   accat,opbal=0,crosac='',   a.acname,a.branchcode, l.lno                              
   from Ledger l,  Acmast a ,Vmast v                            
                            
   Where  l.vdt between @fdate and @tdate + ' 23:59:59'  And vtyp = vtype and                          
   l.cltcode = a.cltcode  and l.cltcode between @fcode and @tcode and                               
   (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')                           
                          
   Order by l.cltcode, voudt1, l.vtyp desc, l.vno                                  
 END                 
ELSE                           
 BEGIN                              
  insert into #opbal                          
   Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l                              
   where l2.cltcode between @fcode and @tcode and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.vno=l2.vno and l.lno=l2.lno                              
   and vdt between @@opendate and @fdate                              
   Group by l2.cltcode                              
       Order by l2.cltcode                          
                              
 insert into #temptable_gl                              
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                               
   dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                                
   cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                            
   l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp              and vno = l.vno and booktype = l.booktype                               
   and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,                              
   accat,  opbal=0,crosac='',a.acname,a.branchcode, l.lno                               
   from ledger l ,vmast v, ledger2 l2, acmast a,  costmast c                                 
                          
           Where  l.vdt between @fdate and @tdate + ' 23:59:59' and l.vtyp = l2.vtype and  l.vno = l2.vno and                          
   l.lno = l2.lno and  l.booktype = l2.booktype and l2.cltcode=a.cltcode  and l.vtyp = v.vtype and                           
   l2.cltcode between @fcode and  @tcode  and a.accat <> '4'                               
   and costname = rtrim(@branch)                               
   and l2.costcode = c.costcode  and  l2.vtype <> 18                          
   order by l2.cltcode, voudt1, l.vtyp desc, l.vno                              
 END                              
END                              
ELSE                              
BEGIN                              
if rtrim(@branch) = '' or rtrim(@branch) = '%'                               
 BEGIN                                  
  insert into #opbal                           
  Select cltcode, sum(opbal) opbal  from                              
   (                          
    Select Cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                               
    where Cltcode between @fcode and @tcode and vdt between @@opendate and @fdate                              
    Group by Cltcode                              
                           
    union                              
                           
   Select cltcode,sum(case drcr when 'C' then vamt else -vamt end) as opbal from ledger                               
   Where cltcode between  @fcode and  @tcode and vdt < @@opendate and edt >= @@opendate                              
   Group by cltcode) t                            
   Group by cltcode                              
     Order by cltcode                                        
                              
 insert into #temptable_gl                              
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                              
   dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                
   cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,                               
   Replace( l.narration,'"','') narration,                              
   ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and                              
   booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                              
   accat,opbal=0,crosac='',  a.acname,a.branchcode, l.lno                             
   from Ledger l , acmast a ,vmast v                            
   Where vtyp = vtype  and a.cltcode = l.cltcode and l.cltcode between @fcode and @tcode                           
    and  l.edt between @fdate and @tdate + ' 23:59:59' and    l.vtyp <> 18 and                           
   (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')                              
   order by l.cltcode, voudt1, l.vtyp desc, l.vno                              
 END                              
ELSE                     
 BEGIN                                  
  insert into #opbal                           
  Select cltcode, sum(opbal) opbal  from                              
   (                          
  Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l                              
   where vdt  between @@opendate and @fdate  and   l.vno=l2.vno and l.vtyp=l2.vtype and l.booktype=l2.booktype                          
   and l.lno=l2.lno   and  l2.cltcode between @fcode   and @tcode                          
   Group by l2.cltcode                              
                          
   union                              
                          
   Select l2.cltcode,sum(case l2.drcr when 'C' then camt else -camt end) as opbal from ledger2 l2, ledger l                              
   where  l.vno=l2.vno and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.lno=l2.lno                              
   and  vdt < @@opendate and edt >= @@opendate and   l2.cltcode between @fcode and @tcode                           
   Group by l2.cltcode) t                              
 Group by cltcode                          
     Order by cltcode                          
                              
 insert into #temptable_gl                              
 Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                               
  dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                                
  cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                               
  l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype                               
  and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,                                
  accat,   opbal=0,crosac='',a.acname,a.branchcode, l.lno                               
  from ledger l ,vmast v, ledger2 l2 ,acmast a, costmast c                            
  Where l.vno = l2.vno and l.vtyp = l2.vtype and                          
  l.booktype = l2.booktype  and l.lno = l2.lno and a.cltcode = l2.cltcode                           
  and l2.cltcode between @fcode and  @tcode And l.vtyp = v.vtype and a.accat <> '4' and l2.cltcode=a.cltcode                               
  and costname = rtrim(@branch)  and l2.vtype <> 18                          
  and l2.costcode = c.costcode                                 
  and  l.edt between @fdate and @tdate + ' 23:59:59'                            
order by l2.cltcode, voudt1, l.vtyp desc, l.vno                              
 END                              
END                              
                          
Update #temptable_gl set opbal = l.opbal  from #opbal l   where #temptable_gl.cltcode = l.cltcode                              
                              
Update #temptable_gl set crosac = l.cltcode  from ledger l                               
where l.vtyp not in('15','21') and #temptable_gl.vtyp = l.vtyp and #temptable_gl.booktype = l.booktype and #temptable_gl.vno = l.vno                              
and #temptable_gl.cltcode <> l.cltcode                                 
                        
                      
 update #temptable_gl set branchcode = costname from ledger2 l2, costmast c                        
 where #temptable_gl.vno = l2.vno and #temptable_gl.vtyp = l2.vtype and #temptable_gl.booktype = l2.booktype and #temptable_gl.lno = l2.lno and #temptable_gl.cltcode = l2.cltcode                        
 and l2.costcode = c.costcode                        
                      
                    
                insert into #temptable_gl select '01', '', '', '', 0, 0, '', '', '', cltcode, '', '', 0, '', opbal, '', '', '', 0 from #opbal                    
                            
Select booktype,voudt = convert(varchar(11), voudt1, 103),effdt = convert(varchar(11), effdt1, 103),shortdesc,dramt,cramt,vno,narration,ddno,cltcode,longname,vdt,vtyp,accat,opbal,crosac,acname,branchcode,lno                      
from #temptable_gl                      
where vtyp <> 18              
Order By CltCode,Vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GlReport_bak090630
-- --------------------------------------------------
CREATE  Proc rpt_Acc_GlReport_bak090630                               
@sdate varchar(11),            /* As mmm dd yyyy */                              
@edate varchar(11),            /* As mmm dd yyyy */                              
@fdate varchar(11),            /* As mmm dd yyyy */                              
@tdate varchar(11),            /* As mmm dd yyyy */                              
@fcode varchar(10),                              
@tcode varchar(10),                              
@statusId varchar(30),                              
@statusname varchar(30),                              
@branch varchar(10),                              
@selectionby varchar(3),                              
@GroupBy varchar(10),                              
@Sortby varchar(50),                              
@reportname varchar(30),                              
@reportopt varchar(10)                              
                              
AS                              
                              
declare                               
@@opendate as varchar(11)                              
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                              
--Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18'           
            
select @@OpenDate = left(convert(varchar,sdtcur,109),11) from parameter where @fdate between sdtcur and ldtcur            
          
                      
--SELECT @@OPENDATE = CONVERT(VARCHAR(11),convert(datetime,@SDATE, 103),109)                          
                              
Select cltcode,vamt as opbal into #opbal from ledger  where 1 =2                              
                              
 Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                              
  dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                
  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,                               
  Replace( l.narration,'"','') narration,                              
  ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and                              
  booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                              
  accat,Vamt as opbal,crosac=l.cltcode,                              
  isnull(a.acname,'') acname,isnull(a.branchcode,'') branchcode, lno                          
 into #temptable_gl                              
From Ledger l , Acmast a ,Vmast v  where 1 = 2                          
                              
                            
if @selectionby = 'vdt'                              
BEGIN                              
if rtrim(@branch) = '' or rtrim(@branch) = '%'                               
 BEGIN                    
if @@opendate=@fdate    
 begin      
  Insert into #opbal                          
  Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                               
  where cltcode between @fcode and @tcode and vdt like  @@opendate + '%' and vtyp=18                           
  Group by cltcode                               
  Order by cltcode                               
 end                       
else     
  begin     
 Insert into #opbal                          
    Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                               
    where cltcode between @fcode and @tcode and vdt >= @@opendate and vdt <@fdate    
    Group by cltcode                               
    Order by cltcode                               
   end    
                               
  Insert into #temptable_gl                              
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                              
   dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                
   cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno, Replace( l.narration,'"','') narration,                              
   ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and                              
   booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                              
   accat,opbal=0,crosac='',   a.acname,a.branchcode, l.lno                              
   from Ledger l,  Acmast a ,Vmast v                            
                            
   Where  l.vdt between @fdate and @tdate + ' 23:59:59'  And vtyp = vtype and                          
   l.cltcode = a.cltcode  and l.cltcode between @fcode and @tcode and                               
   (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')                           
                          
   Order by l.cltcode, voudt1, l.vtyp desc, l.vno                                  
 END                 
ELSE                           
 BEGIN                              
  insert into #opbal                          
   Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l                              
   where l2.cltcode between @fcode and @tcode and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.vno=l2.vno and l.lno=l2.lno                              
   and vdt between @@opendate and @fdate                              
   Group by l2.cltcode                              
       Order by l2.cltcode                          
                              
 insert into #temptable_gl                              
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                               
   dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                                
   cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                            
   l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp              and vno = l.vno and booktype = l.booktype                               
   and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,                              
   accat,  opbal=0,crosac='',a.acname,a.branchcode, l.lno                               
   from ledger l ,vmast v, ledger2 l2, acmast a,  costmast c                                 
                          
           Where  l.vdt between @fdate and @tdate + ' 23:59:59' and l.vtyp = l2.vtype and  l.vno = l2.vno and                          
   l.lno = l2.lno and  l.booktype = l2.booktype and l2.cltcode=a.cltcode  and l.vtyp = v.vtype and                           
   l2.cltcode between @fcode and  @tcode  and a.accat <> '4'                               
   and costname = rtrim(@branch)                               
   and l2.costcode = c.costcode  and  l2.vtype <> 18                          
   order by l2.cltcode, voudt1, l.vtyp desc, l.vno                              
 END                              
END                              
ELSE                              
BEGIN                              
if rtrim(@branch) = '' or rtrim(@branch) = '%'                               
 BEGIN                                  
  insert into #opbal                           
  Select cltcode, sum(opbal) opbal  from                              
   (                          
    Select Cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                               
    where Cltcode between @fcode and @tcode and vdt between @@opendate and @fdate                              
    Group by Cltcode                              
                           
    union                              
                           
   Select cltcode,sum(case drcr when 'C' then vamt else -vamt end) as opbal from ledger                               
   Where cltcode between  @fcode and  @tcode and vdt < @@opendate and edt >= @@opendate                              
   Group by cltcode) t                            
   Group by cltcode                              
     Order by cltcode                                        
                              
 insert into #temptable_gl                              
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                              
   dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                
   cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,                               
   Replace( l.narration,'"','') narration,                              
   ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and                              
   booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                              
   accat,opbal=0,crosac='',  a.acname,a.branchcode, l.lno                             
   from Ledger l , acmast a ,vmast v                            
   Where vtyp = vtype  and a.cltcode = l.cltcode and l.cltcode between @fcode and @tcode                           
    and  l.edt between @fdate and @tdate + ' 23:59:59' and    l.vtyp <> 18 and                           
   (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')                              
   order by l.cltcode, voudt1, l.vtyp desc, l.vno                              
 END                              
ELSE                     
 BEGIN                                  
  insert into #opbal                           
  Select cltcode, sum(opbal) opbal  from                              
   (                          
  Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l                              
   where vdt  between @@opendate and @fdate  and   l.vno=l2.vno and l.vtyp=l2.vtype and l.booktype=l2.booktype                          
   and l.lno=l2.lno   and  l2.cltcode between @fcode   and @tcode                          
   Group by l2.cltcode                              
                          
   union                              
                          
   Select l2.cltcode,sum(case l2.drcr when 'C' then camt else -camt end) as opbal from ledger2 l2, ledger l                              
   where  l.vno=l2.vno and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.lno=l2.lno                              
   and  vdt < @@opendate and edt >= @@opendate and   l2.cltcode between @fcode and @tcode                           
   Group by l2.cltcode) t                              
 Group by cltcode                          
     Order by cltcode                          
                              
 insert into #temptable_gl                              
 Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                               
  dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                                
  cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                               
  l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype                               
  and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,                                
  accat,   opbal=0,crosac='',a.acname,a.branchcode, l.lno                               
  from ledger l ,vmast v, ledger2 l2 ,acmast a, costmast c                            
  Where l.vno = l2.vno and l.vtyp = l2.vtype and                          
  l.booktype = l2.booktype  and l.lno = l2.lno and a.cltcode = l2.cltcode                           
  and l2.cltcode between @fcode and  @tcode And l.vtyp = v.vtype and a.accat <> '4' and l2.cltcode=a.cltcode                               
  and costname = rtrim(@branch)  and l2.vtype <> 18                          
  and l2.costcode = c.costcode                                 
  and  l.edt between @fdate and @tdate + ' 23:59:59'                            
order by l2.cltcode, voudt1, l.vtyp desc, l.vno                              
 END                              
END                              
                          
Update #temptable_gl set opbal = l.opbal  from #opbal l   where #temptable_gl.cltcode = l.cltcode                              
                              
Update #temptable_gl set crosac = l.cltcode  from ledger l                               
where l.vtyp not in('15','21') and #temptable_gl.vtyp = l.vtyp and #temptable_gl.booktype = l.booktype and #temptable_gl.vno = l.vno                              
and #temptable_gl.cltcode <> l.cltcode                                 
                        
                      
 update #temptable_gl set branchcode = costname from ledger2 l2, costmast c                        
 where #temptable_gl.vno = l2.vno and #temptable_gl.vtyp = l2.vtype and #temptable_gl.booktype = l2.booktype and #temptable_gl.lno = l2.lno and #temptable_gl.cltcode = l2.cltcode                        
 and l2.costcode = c.costcode                        
                      
                    
                insert into #temptable_gl select '01', '', '', '', 0, 0, '', '', '', cltcode, '', '', 0, '', opbal, '', '', '', 0 from #opbal                    
                            
Select booktype,voudt = convert(varchar(11), voudt1, 103),effdt = convert(varchar(11), effdt1, 103),shortdesc,dramt,cramt,vno,narration,ddno,cltcode,longname,vdt,vtyp,accat,opbal,crosac,acname,branchcode,lno                      
from #temptable_gl                      
where vtyp <> 18              
Order By CltCode,Vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GlReport_May192009
-- --------------------------------------------------
CREATE Proc rpt_Acc_GlReport_May192009
@sdate varchar(11),            /* As mmm dd yyyy */                          
@edate varchar(11),            /* As mmm dd yyyy */                          
@fdate varchar(11),            /* As mmm dd yyyy */                          
@tdate varchar(11),            /* As mmm dd yyyy */                          
@fcode varchar(10),                          
@tcode varchar(10),                          
@statusId varchar(30),                          
@statusname varchar(30),                          
@branch varchar(10),                          
@selectionby varchar(3),                          
@GroupBy varchar(10),                          
@Sortby varchar(50),                          
@reportname varchar(30),                          
@reportopt varchar(10)                          
                          
AS                          
                          
declare                           
@@opendate as varchar(11)                          
                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
                          
Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18'  and vdt like @fdate + '%'      
        
--select @@OpenDate = left(convert(varchar,sdtcur,109),11) from parameter where @fdate between sdtcur and ldtcur        
      
                  
--SELECT @@OPENDATE = CONVERT(VARCHAR(11),convert(datetime,@SDATE, 103),109)                      
                          
Select cltcode,vamt as opbal into #opbal from ledger  where 1 =2                          
                          
 Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                          
  dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                            
  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,                           
  Replace( l.narration,'"','') narration,                          
  ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and                          
  booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                          
  accat,Vamt as opbal,crosac=l.cltcode,                          
  isnull(a.acname,'') acname,isnull(a.branchcode,'') branchcode, lno                      
 into #temptable_gl                          
From Ledger l , Acmast a ,Vmast v  where 1 = 2                      
                          
                        
if @selectionby = 'vdt'                          
BEGIN                          
if rtrim(@branch) = '' or rtrim(@branch) = '%'                           
 BEGIN                              
  Insert into #opbal                      
   Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                           
   where cltcode between @fcode and @tcode and vdt between @@opendate and @fdate  and vtyp=18                       
   Group by cltcode                           
   Order by cltcode                           
                      
                          
  Insert into #temptable_gl                          
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                          
   dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                            
   cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno, Replace( l.narration,'"','') narration,                          
   ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and                          
   booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                          
   accat,opbal=0,crosac='',   a.acname,a.branchcode, l.lno                          
   from Ledger l,  Acmast a ,Vmast v                        
                        
   Where  l.vdt between @fdate and @tdate + ' 23:59:59'  And vtyp = vtype and                      
   l.cltcode = a.cltcode  and l.cltcode between @fcode and @tcode and                           
   (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')                       
                      
   Order by l.cltcode, voudt1, l.vtyp desc, l.vno                              
 END             
ELSE                       
 BEGIN                          
  insert into #opbal                      
   Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l                          
   where l2.cltcode between @fcode and @tcode and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.vno=l2.vno and l.lno=l2.lno                          
   and vdt between @@opendate and @fdate                          
   Group by l2.cltcode                          
       Order by l2.cltcode                      
                          
 insert into #temptable_gl                          
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                           
   dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                            
   cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                        
   l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp              and vno = l.vno and booktype = l.booktype                           
   and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,                          
   accat,  opbal=0,crosac='',a.acname,a.branchcode, l.lno                           
   from ledger l ,vmast v, ledger2 l2, acmast a,  costmast c                             
                      
           Where  l.vdt between @fdate and @tdate + ' 23:59:59' and l.vtyp = l2.vtype and  l.vno = l2.vno and                      
   l.lno = l2.lno and  l.booktype = l2.booktype and l2.cltcode=a.cltcode  and l.vtyp = v.vtype and                       
   l2.cltcode between @fcode and  @tcode  and a.accat <> '4'                           
   and costname = rtrim(@branch)                           
   and l2.costcode = c.costcode  and  l2.vtype <> 18                      
   order by l2.cltcode, voudt1, l.vtyp desc, l.vno                          
 END                          
END                          
ELSE                          
BEGIN                          
if rtrim(@branch) = '' or rtrim(@branch) = '%'                           
 BEGIN                              
  insert into #opbal                       
  Select cltcode, sum(opbal) opbal  from                          
   (                      
    Select Cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                           
    where Cltcode between @fcode and @tcode and vdt between @@opendate and @fdate                          
    Group by Cltcode                          
                       
    union                          
                       
   Select cltcode,sum(case drcr when 'C' then vamt else -vamt end) as opbal from ledger                           
   Where cltcode between  @fcode and  @tcode and vdt < @@opendate and edt >= @@opendate                          
   Group by cltcode) t                        
   Group by cltcode                          
     Order by cltcode                                    
                          
 insert into #temptable_gl                          
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                          
   dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                            
   cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,                           
   Replace( l.narration,'"','') narration,                          
   ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and                          
   booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                          
   accat,opbal=0,crosac='',  a.acname,a.branchcode, l.lno                          
   from Ledger l , acmast a ,vmast v                        
   Where vtyp = vtype  and a.cltcode = l.cltcode and l.cltcode between @fcode and @tcode                       
    and  l.edt between @fdate and @tdate + ' 23:59:59' and    l.vtyp <> 18 and                       
   (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')                          
   order by l.cltcode, voudt1, l.vtyp desc, l.vno                          
 END                          
ELSE                 
 BEGIN                              
  insert into #opbal                       
  Select cltcode, sum(opbal) opbal  from                          
   (                      
  Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l                          
   where vdt  between @@opendate and @fdate  and   l.vno=l2.vno and l.vtyp=l2.vtype and l.booktype=l2.booktype                      
   and l.lno=l2.lno   and  l2.cltcode between @fcode   and @tcode                      
   Group by l2.cltcode                          
                      
   union                          
                      
   Select l2.cltcode,sum(case l2.drcr when 'C' then camt else -camt end) as opbal from ledger2 l2, ledger l                          
   where  l.vno=l2.vno and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.lno=l2.lno                          
   and  vdt < @@opendate and edt >= @@opendate and   l2.cltcode between @fcode and @tcode                       
   Group by l2.cltcode) t                          
 Group by cltcode                      
     Order by cltcode                      
                          
 insert into #temptable_gl                          
 Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                           
  dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                            
  cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                           
  l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype                           
  and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,                            
  accat,   opbal=0,crosac='',a.acname,a.branchcode, l.lno                           
  from ledger l ,vmast v, ledger2 l2 ,acmast a, costmast c                        
  Where l.vno = l2.vno and l.vtyp = l2.vtype and                      
  l.booktype = l2.booktype  and l.lno = l2.lno and a.cltcode = l2.cltcode                       
  and l2.cltcode between @fcode and  @tcode And l.vtyp = v.vtype and a.accat <> '4' and l2.cltcode=a.cltcode                           
  and costname = rtrim(@branch)  and l2.vtype <> 18                      
  and l2.costcode = c.costcode                             
  and  l.edt between @fdate and @tdate + ' 23:59:59'                        
  order by l2.cltcode, voudt1, l.vtyp desc, l.vno                          
 END                          
END                          
                      
Update #temptable_gl set opbal = l.opbal  from #opbal l   where #temptable_gl.cltcode = l.cltcode                          
                          
Update #temptable_gl set crosac = l.cltcode  from ledger l                           
where l.vtyp not in('15','21') and #temptable_gl.vtyp = l.vtyp and #temptable_gl.booktype = l.booktype and #temptable_gl.vno = l.vno                          
and #temptable_gl.cltcode <> l.cltcode                             
                    
                  
 update #temptable_gl set branchcode = costname from ledger2 l2, costmast c                    
 where #temptable_gl.vno = l2.vno and #temptable_gl.vtyp = l2.vtype and #temptable_gl.booktype = l2.booktype and #temptable_gl.lno = l2.lno and #temptable_gl.cltcode = l2.cltcode                    
 and l2.costcode = c.costcode                    
                  
           
                
insert into #temptable_gl select '01', '', '', '', 0, 0, '', '', '', cltcode, '', '', 0, '', opbal, '', '', '', 0 from #opbal                
                        
Select booktype,voudt = convert(varchar(11), voudt1, 103),effdt = convert(varchar(11), effdt1, 103),shortdesc,dramt,cramt,vno,narration,ddno,cltcode,longname,vdt,vtyp,accat,opbal,crosac,acname,branchcode,lno                  
from #temptable_gl                  
where vtyp <> 18          
Order By CltCode,Vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GlReport04102008
-- --------------------------------------------------
  
CREATE  Proc rpt_Acc_GlReport04102008  
 @sdate varchar(11),            /* As mmm dd yyyy */          
 @edate varchar(11),            /* As mmm dd yyyy */          
 @fdate varchar(11),            /* As mmm dd yyyy */          
 @tdate varchar(11),            /* As mmm dd yyyy */          
 @fcode varchar(10),          
 @tcode varchar(10),          
 @statusId varchar(30),          
 @statusname varchar(30),          
 @branch varchar(10),          
 @selectionby varchar(3),          
 @GroupBy varchar(10),          
 @Sortby varchar(50),          
 @reportname varchar(30),          
 @reportopt varchar(10)          
          
AS          
          
declare          
 @@opendate as varchar(11)          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
          
Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18' and vdt <= @fdate                    
          
Select cltcode,vamt as opbal into #opbal from ledger  where 1 =2          
          
Select          
 l.booktype,          
 voudt1=l.vdt,          
 effdt1=l.edt,          
 isnull(shortdesc,'') shortdesc,          
 dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),          
 cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),          
 l.vno,          
 Replace( l.narration,'"','') narration,          
 ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),          
 l.cltcode,          
 a.longname,          
 vdt,          
 l.vtyp,          
 accat,          
 Vamt as opbal,          
 crosac=l.cltcode,          
 isnull(a.acname,'') acname,          
 isnull(a.branchcode,'') branchcode,          
 lno          
into          
 #temptable_gl          
From          
 Ledger l,          
 Acmast a,          
 Vmast v          
where          
 1 = 2          
          
          
if @selectionby = 'vdt'          
 BEGIN          
  if rtrim(@branch) = '' or rtrim(@branch) = '%'          
   BEGIN          
    If @@opendate = @fdate          
    begin          
     Insert into #opbal          
     Select          
      cltcode,          
      sum(case drcr when 'D' then vamt else -vamt end) as opbal          
     from          
      ledger          
     where          
      cltcode between @fcode and @tcode          
      and vdt like @@opendate + '%' and vtyp = 18          
     Group by cltcode          
     Order by cltcode          
    end          
    else          
    begin          
     Insert into #opbal          
     Select          
      cltcode,          
      sum(case drcr when 'D' then vamt else -vamt end) as opbal          
     from          
      ledger          
     where          
      cltcode between @fcode and @tcode          
      and vdt >= @@opendate and vdt < @fdate          
     Group by cltcode          
     Order by cltcode          
    end          
          
    Insert into #temptable_gl          
    Select          
     l.booktype,          
     voudt1=l.vdt,          
     effdt1=l.edt,          
     isnull(shortdesc,'') shortdesc,          
     dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),          
     cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),          
     l.vno,          
     Replace( l.narration,'"','') narration,          
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),          
     l.cltcode,          
     a.longname,          
     vdt,          
     l.vtyp,          
     accat,          
     opbal=0,          
     crosac='',          
     a.acname,          
     a.branchcode,          
     l.lno          
    from          
     Ledger l,          
     Acmast a,          
     Vmast v          
    Where          
     l.vdt between @fdate and @tdate + ' 23:59:59'          
     And vtyp = vtype          
     and l.cltcode = a.cltcode          
     and l.cltcode between @fcode and @tcode          
     and (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')          
    Order by          
     l.cltcode,          
     voudt1,          
     l.vtyp desc,          
     l.vno          
   END          
  ELSE          
   BEGIN          
    insert into #opbal          
    Select      
     l2.cltcode,          
     sum(case l2.drcr when 'D' then camt else -camt end) as opbal          
    from          
     ledger2 l2,          
     ledger l          
    where          
     l2.cltcode between @fcode and @tcode          
     and l.vtyp=l2.vtype          
     and l.booktype=l2.booktype          
 and l.vno=l2.vno          
     and l.lno=l2.lno          
     and vdt between @@opendate and @fdate          
    Group by l2.cltcode          
    Order by l2.cltcode          
          
    insert into #temptable_gl          
    Select          
     l.booktype,          
     voudt1=l.vdt,          
     effdt1=l.edt,          
     isnull(shortdesc,'') shortdesc,          
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),          
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),          
     l.vno,          
     Replace( l.narration,'"','') narration,          
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),          
     l2.cltcode,          
     a.longname,          
     vdt,          
     l.vtyp,          
     accat,          
     opbal=0,          
     crosac='',          
     a.acname,          
     a.branchcode,          
     l.lno          
    from          
     ledger l,          
     vmast v,          
     ledger2 l2,          
     acmast a,          
     costmast c          
    Where          
     l.vdt between @fdate and @tdate + ' 23:59:59'          
     and l.vtyp = l2.vtype          
     and  l.vno = l2.vno          
     and l.lno = l2.lno          
     and l.booktype = l2.booktype          
     and l2.cltcode=a.cltcode          
     and l.vtyp = v.vtype          
     and l2.cltcode between @fcode and  @tcode          
     and a.accat <> '4'          
     and costname = rtrim(@branch)          
     and l2.costcode = c.costcode          
     and  l2.vtype <> 18          
    order by          
     l2.cltcode,          
     voudt1,          
     l.vtyp desc,          
     l.vno          
   END          
 END          
ELSE          
 BEGIN          
  if rtrim(@branch) = '' or rtrim(@branch) = '%'          
   BEGIN          
   If @@opendate = @fdate          
   begin          
    insert into #opbal          
    Select          
     cltcode,          
     sum(opbal) opbal          
    from          
     (          
      Select          
       Cltcode,          
       sum(case drcr when 'D' then vamt else -vamt end) as opbal          
      from          
       ledger          
      where          
       Cltcode between @fcode and @tcode          
       and vdt like @@opendate + '%' and vtyp = 18          
      Group by          
       Cltcode          
     union ALL          
      Select          
       cltcode,          
       sum(case drcr when 'C' then vamt else -vamt end) as opbal          
      from          
       ledger          
      Where          
       cltcode between  @fcode and  @tcode          
       and vdt < @@opendate          
       and edt >= @@opendate          
       Group by cltcode          
     ) t          
    Group by cltcode          
    Order by cltcode          
   end          
   else          
   begin          
    insert into #opbal          
    Select          
     cltcode,          
     sum(opbal) opbal          
    from          
     (          
      Select          
       Cltcode,          
       sum(case drcr when 'D' then vamt else -vamt end) as opbal          
      from          
       ledger          
      where          
       Cltcode between @fcode and @tcode          
       and edt >= @@opendate and edt < @fdate          
      Group by          
       Cltcode          
     union ALL          
      Select    
       cltcode,          
       sum(case drcr when 'C' then vamt else -vamt end) as opbal          
      from          
       ledger          
      Where          
       cltcode between  @fcode and  @tcode          
       and vdt < @@opendate          
       and edt >= @@opendate          
       Group by cltcode          
     ) t          
    Group by cltcode          
    Order by cltcode          
   end          
          
    insert into #temptable_gl          
    Select          
     l.booktype,          
     voudt1=l.vdt,          
     effdt1=l.edt,          
     isnull(shortdesc,'') shortdesc,          
     dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),          
     cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),          
     l.vno,          
     Replace( l.narration,'"','') narration,          
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),          
     l.cltcode,          
     a.longname,          
     vdt,          
     l.vtyp,          
     accat,          
     opbal=0,          
     crosac='',       
     a.acname,          
     a.branchcode,          
     l.lno          
    from          
     Ledger l,          
     acmast a,          
     vmast v          
    Where          
     vtyp = vtype          
     and a.cltcode = l.cltcode          
     and l.cltcode between @fcode and @tcode          
     and  l.edt between @fdate and @tdate + ' 23:59:59'          
     and l.vtyp <> 18          
     and (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')          
    order by          
     l.cltcode,          
     voudt1,          
     l.vtyp desc,          
     l.vno          
   END          
  ELSE          
   BEGIN          
    insert into #opbal          
    Select          
     cltcode,          
     sum(opbal) opbal          
    from          
     (          
      Select          
       l2.cltcode,          
       sum(case l2.drcr when 'D' then camt else -camt end) as opbal          
      from          
       ledger2 l2,          
       ledger l          
      where          
       vdt between @@opendate and @fdate          
       and l.vno=l2.vno          
       and l.vtyp=l2.vtype          
       and l.booktype=l2.booktype          
       and l.lno=l2.lno          
       and l2.cltcode between @fcode and @tcode          
      Group by          
       l2.cltcode          
      union ALL          
       Select          
        l2.cltcode,          
        sum(case l2.drcr when 'C' then camt else -camt end) as opbal          
       from          
        ledger2 l2,          
        ledger l          
       where          
        l.vno=l2.vno          
        and l.vtyp=l2.vtype          
        and l.booktype=l2.booktype          
        and l.lno=l2.lno          
        and vdt < @@opendate          
        and edt >= @@opendate          
        and l2.cltcode between @fcode and @tcode          
       Group by          
        l2.cltcode          
     ) t          
    Group by          
     cltcode          
    Order by          
     cltcode          
    insert into #temptable_gl          
    Select          
     l.booktype,          
     voudt1=l.vdt,          
     effdt1=l.edt,          
     isnull(shortdesc,'') shortdesc,          
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),          
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),          
     l.vno,          
     Replace(l.narration,'"','') narration,          
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),          
     l2.cltcode,          
     a.longname,          
     vdt,          
     l.vtyp,          
     accat,          
     opbal=0,          
     crosac='',          
     a.acname,          
     a.branchcode,          
     l.lno          
    from          
     ledger l,          
     vmast v,          
ledger2 l2,          
     acmast a,          
     costmast c          
    Where          
     l.vno = l2.vno          
     and l.vtyp = l2.vtype          
     and l.booktype = l2.booktype          
     and l.lno = l2.lno          
     and a.cltcode = l2.cltcode          
     and l2.cltcode between @fcode and @tcode          
     And l.vtyp = v.vtype          
     and a.accat <> '4'          
     and l2.cltcode=a.cltcode          
     and costname = rtrim(@branch)          
     and l2.vtype <> 18          
     and l2.costcode = c.costcode          
     and  l.edt between @fdate and @tdate + ' 23:59:59'          
    order by          
     l2.cltcode,          
     voudt1,          
     l.vtyp desc,          
     l.vno          
   END          
 END          
          
Update         
 #temptable_gl          
set          
 opbal = l.opbal          
from          
 #opbal l          
where          
 #temptable_gl.cltcode = l.cltcode          
          
Update          
 #temptable_gl          
set          
 crosac = l.cltcode          
from          
 ledger l          
where          
 l.vtyp not in('15','21')          
 and #temptable_gl.vtyp = l.vtyp          
 and #temptable_gl.booktype = l.booktype          
 and #temptable_gl.vno = l.vno          
 and #temptable_gl.cltcode <> l.cltcode          
      
update          
 #temptable_gl          
set          
 branchcode = costname          
from          
 ledger2 l2,          
 costmast c          
where          
 #temptable_gl.vno = l2.vno          
 and #temptable_gl.vtyp = l2.vtype          
 and #temptable_gl.booktype = l2.booktype          
 and #temptable_gl.lno = l2.lno          
 and #temptable_gl.cltcode = l2.cltcode          
 and l2.costcode = c.costcode          
      
Select          
 booktype,          
 voudt = convert(varchar(11), voudt1, 103),          
 effdt = convert(varchar(11), effdt1, 103),          
 shortdesc,          
 dramt,          
 cramt,          
 vno,          
 narration,          
 ddno,          
 cltcode,          
 longname,          
 vdt,          
 vtyp,          
 accat,          
 opbal,          
 crosac,          
 acname,          
 branchcode,          
 lno          
from          
 #temptable_gl          
where           
 vtyp <> 18          
Order By          
 CltCode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_GLREPORT22122008
-- --------------------------------------------------
CREATE PROC RPT_ACC_GLREPORT22122008          
 @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
 @EDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
 @FCODE VARCHAR(10),                        
 @TCODE VARCHAR(10),                        
 @STATUSID VARCHAR(30),                        
 @STATUSNAME VARCHAR(30),                        
 @BRANCH VARCHAR(10),                        
 @SELECTIONBY VARCHAR(3),                        
 @GROUPBY VARCHAR(10),                        
 @SORTBY VARCHAR(50),                        
 @REPORTNAME VARCHAR(30),                        
 @REPORTOPT VARCHAR(10)                        
                  
AS                        
                  
DECLARE                         
 @@OPENDATE AS VARCHAR(11)                        
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
                  
--SELECT                   
-- @@OPENDATE = CONVERT(VARCHAR(11),MAX(VDT),109) FROM LEDGER WHERE VTYP='18'                          
              
--vin          
--SELECT  @@OPENDATE = CONVERT(VARCHAR(11),convert(datetime,@SDATE, 103),109)              
--Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vdt <= @fdate and vtyp = 18        
SELECT @@opendate = convert(varchar(11),SDTCUR,109) FROM PARAMETER WHERE @fdate BETWEEN SDTCUR AND LDTCUR        
--vin               
             
SELECT                   
 CLTCODE,VAMT AS OPBAL                   
INTO #OPBAL                   
FROM                   
 LEDGER  WHERE 1 =2                        
                  
SELECT                   
 L.BOOKTYPE,                   
 VOUDT=CONVERT(VARCHAR,L.VDT,103),                   
 EFFDT=CONVERT(VARCHAR,L.EDT,103),                   
 ISNULL(SHORTDESC,'') SHORTDESC,                        
 DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                          
 CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                   
 L.VNO,                         
 REPLACE( L.NARRATION,'"','') NARRATION,                        
 DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND                        
 BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L.CLTCODE , A.LONGNAME,VDT, L.VTYP,                        
 ACCAT,VAMT AS OPBAL,CROSAC=L.CLTCODE,                        
 ISNULL(A.ACNAME,'') ACNAME,ISNULL(A.BRANCHCODE,'') BRANCHCODE                    
INTO                   
 #TEMPTABLE_GL                        
FROM                   
 LEDGER L , ACMAST A ,VMAST V                    
WHERE                   
 1 = 2                  
                  
IF @SELECTIONBY = 'VDT'                        
BEGIN                        
IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                         
 BEGIN                            
  IF @@OPENDATE = @FDATE                  
  BEGIN                  
print 'vin'          
   INSERT INTO #OPBAL                    
   SELECT CLTCODE,SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL FROM LEDGER                         
   WHERE CLTCODE BETWEEN @FCODE AND @TCODE AND VDT BETWEEN @@OPENDATE AND @TDATE + ' 23:59'  AND VTYP = '18'                  
   GROUP BY CLTCODE                         
   ORDER BY CLTCODE                         
  END                   
  ELSE                  
  BEGIN                
print 'vin1'          
   INSERT INTO #OPBAL                    
   SELECT CLTCODE,SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL FROM LEDGER                
   WHERE CLTCODE BETWEEN @FCODE AND @TCODE AND VDT BETWEEN @@OPENDATE AND DATEADD(D, -1,CONVERT(DATETIME, @FDATE)) + ' 23:59'  --@FDATE                    
   GROUP BY CLTCODE                         
   ORDER BY CLTCODE                     
  END                  
                  
  INSERT INTO #TEMPTABLE_GL                        
  SELECT                   
   L.BOOKTYPE,                   
   VOUDT=CONVERT(VARCHAR,L.VDT,103),                   
   EFFDT=CONVERT(VARCHAR,L.EDT,103),                   
   ISNULL(SHORTDESC,'') SHORTDESC,                        
   DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                          
   CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                  
    L.VNO,                   
   REPLACE( L.NARRATION,'"','') NARRATION,                        
   DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                   
   A.CLTCODE ,                   
   A.LONGNAME,                   
   VDT,                   
   L.VTYP,                        
   ACCAT,                  
   OPBAL=0,                  
   CROSAC='',                     
   A.ACNAME,                  
   A.BRANCHCODE                        
  FROM                   
   ACMAST A LEFT OUTER JOIN LEDGER L ON L.CLTCODE = A.CLTCODE  ,  VMAST V                      
  WHERE                    
   L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'  AND VTYP = VTYPE AND                    
   L.CLTCODE BETWEEN @FCODE AND @TCODE AND    L.VTYP <> 18 AND                         
   (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%' OR A.ACCAT LIKE '18%' )                        
  ORDER BY                   
   L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO                            
 END                        
ELSE                        
 BEGIN                    
  IF @@OPENDATE = @FDATE                 
  BEGIN                      
  INSERT INTO #OPBAL                    
   SELECT L2.CLTCODE,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL FROM LEDGER2 L2, LEDGER L,  COSTMAST C                  
   WHERE L2.CLTCODE BETWEEN @FCODE AND @TCODE AND L.VTYP=L2.VTYPE AND L.BOOKTYPE=L2.BOOKTYPE AND L.VNO=L2.VNO AND L.LNO=L2.LNO  AND L2.COSTCODE = C.COSTCODE                  
   AND VDT BETWEEN @@OPENDATE AND @TDATE + ' 23:59' AND L2.VTYPE = '18'                  
   AND COSTNAME = RTRIM(@BRANCH)                         
   GROUP BY L2.CLTCODE                        
   ORDER BY L2.CLTCODE                    
  END                  
  ELSE                  
  BEGIN                  
   INSERT INTO #OPBAL                    
   SELECT L2.CLTCODE,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL FROM LEDGER2 L2, LEDGER L,  COSTMAST C                  
   WHERE L2.CLTCODE BETWEEN @FCODE AND @TCODE AND L.VTYP=L2.VTYPE AND L.BOOKTYPE=L2.BOOKTYPE AND L.VNO=L2.VNO AND L.LNO=L2.LNO  AND L2.COSTCODE = C.COSTCODE                  
   AND VDT BETWEEN @@OPENDATE AND DATEADD(D, -1,CONVERT(DATETIME, @FDATE)) + ' 23:59'                         
   AND COSTNAME = RTRIM(@BRANCH)                         
   GROUP BY L2.CLTCODE                        
   ORDER BY L2.CLTCODE                   
  END                  
select * from #opbal    
RETURN     
                
                   
  INSERT INTO #TEMPTABLE_GL                        
  SELECT L.BOOKTYPE,                      
  VOUDT=CONVERT(VARCHAR,L.VDT,103),                   
  EFFDT=CONVERT(VARCHAR,L.EDT,103),                   
  ISNULL(SHORTDESC,'') SHORTDESC,                         
  DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                          
  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                         
  L.VNO, REPLACE( L.NARRATION,'"','') NARRATION, DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP                         
  AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE                         
  AND LNO = L.LNO),''), A.CLTCODE , A.LONGNAME,VDT, L.VTYP,                        
  ACCAT,  OPBAL=0,CROSAC='',A.ACNAME,A.BRANCHCODE                         
  FROM ACMAST A LEFT OUTER JOIN LEDGER2 L2 ON A.CLTCODE = L2.CLTCODE,                   
  LEDGER L ,VMAST V, COSTMAST C                           
  WHERE  L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND L.VTYP = L2.VTYPE AND  L.VNO = L2.VNO AND             
  L.LNO = L2.LNO AND  L.BOOKTYPE = L2.BOOKTYPE AND L.VTYP = V.VTYPE AND                     
  L2.CLTCODE BETWEEN @FCODE AND  @TCODE  AND A.ACCAT <> '4'                         
  AND COSTNAME = RTRIM(@BRANCH)                         
  AND L2.COSTCODE = C.COSTCODE                    
  ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO                        
 END                        
END                        
ELSE                        
BEGIN                        
IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                         
 BEGIN                     
  IF @@OPENDATE = @FDATE                  
  BEGIN                      
   INSERT INTO #OPBAL                     
   SELECT CLTCODE, SUM(OPBAL) OPBAL  FROM                        
   (                    
   SELECT CLTCODE,SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL FROM LEDGER                         
   WHERE CLTCODE BETWEEN @FCODE AND @TCODE AND VDT BETWEEN @@OPENDATE AND @TDATE + ' 23:59' AND VTYP = '18'                  
   GROUP BY CLTCODE                        
                     
   UNION                        
                     
   SELECT CLTCODE,SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL FROM LEDGER                         
   WHERE CLTCODE BETWEEN  @FCODE AND  @TCODE AND VDT < @@OPENDATE AND EDT >= @@OPENDATE             
   GROUP BY CLTCODE) T                      
   GROUP BY CLTCODE                        
   ORDER BY CLTCODE                                  
  END                   
  ELSE                  
  BEGIN                  
   INSERT INTO #OPBAL                     
   SELECT CLTCODE, SUM(OPBAL) OPBAL  FROM                        
   (                    
   SELECT CLTCODE,SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL FROM LEDGER                         
   WHERE CLTCODE BETWEEN @FCODE AND @TCODE AND VDT BETWEEN @@OPENDATE AND @FDATE                        
   GROUP BY CLTCODE                        
                     
   UNION                       
                     
   SELECT CLTCODE,SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL FROM LEDGER                         
   WHERE CLTCODE BETWEEN  @FCODE AND  @TCODE AND VDT < @@OPENDATE AND EDT >= @@OPENDATE                        
   GROUP BY CLTCODE) T                      
   GROUP BY CLTCODE                        
   ORDER BY CLTCODE                                  
  END                  
                    
  INSERT INTO #TEMPTABLE_GL                        
  SELECT L.BOOKTYPE,                   
  VOUDT=CONVERT(VARCHAR,L.VDT,103), EFFDT=CONVERT(VARCHAR,L.EDT,103), ISNULL(SHORTDESC,'') SHORTDESC,                        
  DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                          
  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,                         
  REPLACE( L.NARRATION,'"','') NARRATION,                        
  DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND                        
  BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L.CLTCODE , A.LONGNAME,VDT, L.VTYP,                        
  ACCAT,OPBAL=0,CROSAC='',  A.ACNAME,A.BRANCHCODE                        
  FROM LEDGER L , ACMAST A ,VMAST V                      
  WHERE VTYP = VTYPE  AND A.CLTCODE = L.CLTCODE AND L.CLTCODE BETWEEN @FCODE AND @TCODE                     
  AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND    L.VTYP <> 18 AND                     
  (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%' OR A.ACCAT LIKE '18%' )                        
  ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO                        
 END                        
ELSE                        
 BEGIN      
 IF @SDATE = @FDATE                  
  BEGIN                     
print 'vin20'                   
   INSERT INTO #OPBAL                     
   SELECT CLTCODE, SUM(OPBAL) OPBAL  FROM                        
   (                    
   SELECT L2.CLTCODE,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL FROM LEDGER2 L2, LEDGER L, COSTMAST C                        
   WHERE VDT  BETWEEN @@OPENDATE AND @TDATE + ' 23:59' AND L2.VTYPE = '18' AND   L.VNO=L2.VNO AND L.VTYP=L2.VTYPE AND L.BOOKTYPE=L2.BOOKTYPE  AND L2.COSTCODE = C.COSTCODE                  
   AND L.LNO=L2.LNO   AND  L2.CLTCODE BETWEEN @FCODE   AND @TCODE                    
   AND COSTNAME = RTRIM(@BRANCH)                  
   GROUP BY L2.CLTCODE                        
                     
   UNION                        
                     
   SELECT L2.CLTCODE,SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) AS OPBAL FROM LEDGER2 L2, LEDGER L, COSTMAST C                        
   WHERE  L.VNO=L2.VNO AND L.VTYP=L2.VTYPE AND L.BOOKTYPE=L2.BOOKTYPE AND L.LNO=L2.LNO AND L2.COSTCODE = C.COSTCODE                  
   AND  VDT < @@OPENDATE AND EDT >= @@OPENDATE AND   L2.CLTCODE BETWEEN @FCODE AND @TCODE                     
   AND COSTNAME = RTRIM(@BRANCH)              
   GROUP BY L2.CLTCODE) T                        
   GROUP BY CLTCODE                    
   ORDER BY CLTCODE                    
  END                  
  ELSE                  
  BEGIN    
print 'vin10'                  
   INSERT INTO #OPBAL                     
   SELECT CLTCODE, SUM(OPBAL) OPBAL  FROM                        
   (                    
   SELECT L2.CLTCODE,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL FROM LEDGER2 L2, LEDGER L, COSTMAST C                        
   WHERE VDT  BETWEEN @@OPENDATE AND @FDATE  AND   L.VNO=L2.VNO AND L.VTYP=L2.VTYPE AND L.BOOKTYPE=L2.BOOKTYPE  AND L2.COSTCODE = C.COSTCODE                  
   AND L.LNO=L2.LNO   AND  L2.CLTCODE BETWEEN @FCODE   AND @TCODE                    
   AND COSTNAME = RTRIM(@BRANCH)                  
   GROUP BY L2.CLTCODE                        
                     
   UNION                        
                     
   SELECT L2.CLTCODE,SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) AS OPBAL FROM LEDGER2 L2, LEDGER L, COSTMAST C                        
   WHERE  L.VNO=L2.VNO AND L.VTYP=L2.VTYPE AND L.BOOKTYPE=L2.BOOKTYPE AND L.LNO=L2.LNO AND L2.COSTCODE = C.COSTCODE                  
   AND  VDT < @@OPENDATE AND EDT >= @@OPENDATE AND   L2.CLTCODE BETWEEN @FCODE AND @TCODE                     
   AND COSTNAME = RTRIM(@BRANCH)                  
   GROUP BY L2.CLTCODE) T                        
   GROUP BY CLTCODE                    
   ORDER BY CLTCODE                    
  END                  
--select * from #opbal     
--return                     
  INSERT INTO #TEMPTABLE_GL                        
  SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC,                         
  DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                          
  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                         
  L.VNO, REPLACE( L.NARRATION,'"','') NARRATION, DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE                         
  AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP,                          
  ACCAT,   OPBAL=0,CROSAC='',A.ACNAME,A.BRANCHCODE                         
  FROM LEDGER L ,VMAST V, LEDGER2 L2 ,ACMAST A, COSTMAST C                      
  WHERE  L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND                    
  L.BOOKTYPE = L2.BOOKTYPE  AND L.LNO = L2.LNO AND A.CLTCODE = L2.CLTCODE                     
  AND L2.CLTCODE BETWEEN @FCODE AND  @TCODE AND L.VTYP = V.VTYPE AND A.ACCAT <> '4' AND L2.CLTCODE=A.CLTCODE                         
  AND COSTNAME = RTRIM(@BRANCH)                    
  AND L2.COSTCODE = C.COSTCODE                           
  AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
  ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO                        
 END                        
END                        
                  
UPDATE #TEMPTABLE_GL SET OPBAL = L.OPBAL  FROM #OPBAL L   WHERE #TEMPTABLE_GL.CLTCODE = L.CLTCODE                        
                  
UPDATE #TEMPTABLE_GL SET CROSAC = L.CLTCODE  FROM LEDGER L                         
WHERE L.VTYP NOT IN('15','21','19','20') AND #TEMPTABLE_GL.VTYP = L.VTYP AND #TEMPTABLE_GL.BOOKTYPE = L.BOOKTYPE AND #TEMPTABLE_GL.VNO = L.VNO                        
AND #TEMPTABLE_GL.CLTCODE <> L.CLTCODE                           
              
UPDATE #TEMPTABLE_GL SET CROSAC = L.PARTY_CODE  FROM MARGINLEDGER L                         
WHERE L.VTYP IN('19','20') AND #TEMPTABLE_GL.VTYP = L.VTYP AND #TEMPTABLE_GL.BOOKTYPE = L.BOOKTYPE AND #TEMPTABLE_GL.VNO = L.VNO                        
              
INSERT INTO #TEMPTABLE_GL SELECT '','','','',0,0,'','','',CLTCODE,'','',18,'',OPBAL,CLTCODE,'',''                  
FROM #OPBAL WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TEMPTABLE_GL)                     
                  
                  
SELECT *  FROM #TEMPTABLE_GL    ORDER BY CLTCODE, VDT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_listclient
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------
--  Proc To List Clients Acc To Login For The Db - Account
---------------------------------------------------------------------------------------------------------
--written By    :   Sgk
--date     :   Feb 05 2003
---------------------------------------------------------------------------------------------------------
--    Modification History
---------------------------------------------------------------------------------------------------------
-- .1 By : Sgk   On : Feb 05 2003
---------------------------------------------------------------------------------------------------------
Create Procedure [dbo].[Rpt_acc_listclient]
 @Statusid Varchar(15), 
 @Statusname Varchar(25), 
 @Whattolookfor Varchar(25), -- Partial/complete/null String - Forms The Basis For The Search
 @Whichway Varchar(1),  -- > Or <, Depending On How The Above String Is To Be Compared To The Below One.
 @Comparetowhat Varchar(25), -- Partial/complete/null String To Indicate The Upper/lower Limit Of The Search.
 @Accat Varchar(3)  -- Account Category
As
Declare
@Strsql Varchar(2500), 
@@Inaccat Varchar(3)
Select @@Inaccat = Rtrim(Convert(Varchar, Convert(Int, @Accat)+100, 3))
--set Default Values
Set @Whattolookfor = @Whattolookfor + "%"
/* Set @Booktype = @Booktype + "%" */
--broker Login
If  @Statusid = "broker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')" 
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections 
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--branch Login
If @Statusid = "branch"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " (Branchcode Like '" + @Statusname + "' Or Branchcode = 'All') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')" 
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--sub-broker Login
If @Statusid = "subbroker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2, "
 Set @Strsql = @Strsql + " Subbrokers S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Sub_broker = S.Sub_broker And "
 Set @Strsql = @Strsql + " C1.Sub_broker Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
End
--trader Login
If @Statusid = "trader"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Trader "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2, "
 Set @Strsql = @Strsql + " Branches S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Trader = S.Short_name  And "
 Set @Strsql = @Strsql + " C1.Trader Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Trader "
End
--family Login
If @Statusid = "family"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Family "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Family Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Family "
End
If @Statusid = "client"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Statusname + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "region"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "area"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
 Set @Strsql = @Strsql + " Option  (Fast 10)"
Print @Strsql
Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_listclient_report
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------
--  Proc To List Clients Acc To Login For The Db - Account
---------------------------------------------------------------------------------------------------------
--written By    :   Sgk
--date     :   Feb 05 2003
---------------------------------------------------------------------------------------------------------
--    Modification History
---------------------------------------------------------------------------------------------------------
-- .1 By : Sgk   On : Feb 05 2003
---------------------------------------------------------------------------------------------------------
CREATE Procedure [dbo].[Rpt_acc_listclient_report]
 @Statusid Varchar(15), 
 @Statusname Varchar(25), 
 @Whattolookfor Varchar(25), -- Partial/complete/null String - Forms The Basis For The Search
 @Whichway Varchar(1),  -- > Or <, Depending On How The Above String Is To Be Compared To The Below One.
 @Comparetowhat Varchar(25), -- Partial/complete/null String To Indicate The Upper/lower Limit Of The Search.
 @Accat Varchar(3)   -- Account Category
As
Declare
@Strsql Varchar(2500), 
@@Inaccat Varchar(3)
Select @@Inaccat = Rtrim(Convert(Varchar, Convert(Int, @Accat)+100, 3))
--set Default Values
--set @Whattolookfor = @Whattolookfor + "%"
/* Set @Booktype = @Booktype + "%" */
--broker Login
If  @Statusid = "broker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' And "
 If @Accat = 3  
  Set @Strsql = @Strsql + " (Accat In (3, 14, 18) )"  
 Else
  Set @Strsql = @Strsql + " (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')"  
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--branch Login
If @Statusid = "branch"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " (Branchcode = '" + @Statusname + "' Or Branchcode = 'All') And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' And "
 If @Accat = 3  
  Set @Strsql = @Strsql + " (Accat In (3, 14) )"  
 Else
  Set @Strsql = @Strsql + " (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')"  
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--sub-broker Login
If @Statusid = "subbroker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2, "
 Set @Strsql = @Strsql + " Subbrokers S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Sub_broker = S.Sub_broker And "
 Set @Strsql = @Strsql + " C1.Sub_broker Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
End
--trader Login
If @Statusid = "trader"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Trader "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2, "
 Set @Strsql = @Strsql + " Branches S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Trader = S.Branch_cd And "
 Set @Strsql = @Strsql + " C1.Trader Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Trader "
End
--family Login
If @Statusid = "family"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Family "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Family Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Family "
End
If @Statusid = "client"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Statusname + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "region"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "area"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Client1 C1, "
 Set @Strsql = @Strsql + " Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
 Set @Strsql = @Strsql + " Option  (Fast 10)"
Print @Strsql
Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_Marginledger
-- --------------------------------------------------
/*use account
Exec rpt_acc_partyledger_all 'Jan  1 2007','Feb 12 2007','0z','zzz','ACCODE','vdt','broker','broker','', 'N'
Exec rpt_acc_Marginledger 'Jan  1 2007','Feb 12 2007','0z','zzz','ACCODE','vdt','broker','broker','', 'N'*/
 --Exec rpt_acc_Marginledger 'Aug  1 2006','Aug 26 2006','012019','012019','ACCODE','vdt','broker','broker',''      
      
--Exec rpt_acc_Marginledger 'Aug  1 2006','Aug 26 2006','012019','012019','ACCODE','vdt','broker','broker',''        
 /*                      
 proc name rpt_acc_partyledger                      
 parameters fdate - from date                      
            tdate - date to                      
            fcode - ac code from                      
            tcode - ac code to                      
            strorder - printing order, possible vaues  ACCODE , ACNAME                      
            selectby - report selection by , possible values vdt, edt                      
            statusid - possiblevalues 'BROKER','CLIENT','FAMILY','SUBBORKER','FAMILY','BRANCH'                      
*/                      
           
CREATE procedure [dbo].[rpt_acc_Marginledger]                      
                       
@fdate varchar(11),            /* As mmm dd yyyy */                      
@tdate varchar(11),            /* As mmm dd yyyy */                      
@fcode varchar(10),                      
@tcode varchar(10),                      
@strorder varchar(6),                      
@selectby varchar(3),                      
@statusid varchar(15),                      
@statusname varchar(15),                      
@strbranch varchar(10)                      
as                      
                      
Declare @@opendate   as varchar(11)                      
                
CREATE TABLE [dbo].[#MarginLedgerData] (                        
  [booktype] [char] (2) NULL ,                        
  [voudt] [datetime] NULL ,                        
  [effdt] [datetime] NULL ,                        
  [Acname] [varchar] (100) NULL ,              
  [shortdesc] [char] (6) NULL ,                          
  [drcr] [char] (1) NULL ,                        
  [amount] [money] NULL ,                        
  [vno] [varchar] (12) NULL ,                        
  [ddno] [varchar] (12) NULL ,                        
  [Narration] [varchar] (234) NULL ,                        
  [party_code] [varchar] (10) NOT NULL ,                        
  [vtyp] [smallint] NULL ,                        
  [vdt] [varchar] (30) NULL ,                        
  [edt] [varchar] (30) NULL ,                                    
  [LNo] [decimal](5, 0) NULL,    
  [Pdt] [datetime] NULL    
 ) ON [PRIMARY]                        
                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
              
    
              
              
              
select @@opendate = sdtcur from parameter where @fdate between sdtcur and ldtcur      
                      
/*Getting last opening date */                      
/*if upper(@selectby) = 'VDT'                      
 begin                      
  Select @@opendate = ( Select left(convert(varchar,isnull(max(vdt),0),109),11) from marginledger where vtyp = 18 and vdt <= @fdate )                      
 end                      
else                      
 begin                      
  Select @@opendate = ( Select left(convert(varchar,isnull(max(vdt),0),109),11) from marginledger where vtyp = 18 and vdt <= @fdate )                      
 end                */      
                      
/*Creating blank table for opening balance*/                      
Select CltCode=party_code,oppbal=amount into #OppBalance From marginledger where 1=2                      
                      
/*Getting opening balance*/                      
if @selectby = 'vdt'                      
begin                      
 if @@opendate = @fdate                       
 begin                      
  Insert into  #OppBalance                       
  select CltCode=party_code,oppbal = IsNull(sum( case when upper(drcr) = 'D' then amount else -amount end),0)                      
  from marginledger                       
  where party_code >= @FCode And party_code <=@TCode and  vdt like @fdate + '%' and vtyp = 18                       
  Group By party_code                      
 end                      
 else                      
 begin                      
  Insert into  #OppBalance                       
  select CltCode=party_code,oppbal = IsNull(sum( case when upper(drcr) = 'D' then amount else -amount end),0)                        
  from marginledger                       
  where party_code >=@FCode And party_code <= @TCode  and  vdt >=  @@opendate + ' 00:00:00' and vdt < @fdate                       
  Group By party_code                      
 end                      
end                       
else                      
begin                       
 if @@opendate = @fdate                       
 begin        Insert into  #OppBalance                    
  select cltcode=party_code, opbal = sum(sett_no)                  
  from marginledger                   
  where party_code = @fcode and vdt LIKE @@opendate + '%' and vtyp = 18                  
  group by party_code                  
 end                    
 else                    
 begin                    
  Insert into  #OppBalance                       
  select cltcode, opbal=sum(opbal)                  
  from                  
  (                 
  select cltcode=party_code, opbal = sum(sett_no)                  
  from marginledger                   
  where party_code = @fcode and vdt LIKE @@opendate + '%' and vtyp = 18                  
  group by party_code                  
  union all                  
  select cltcode=party_code, opbal = sum( case when upper(drcr) = 'D' then amount else -amount end)                  
  from marginledger                   
  where party_code = @fcode and vdt >= @@opendate + ' 00:00:00' and vdt < @fdate and vtyp <> 18                  
  group by party_code) t                  
  group by cltcode                  
 end                    
end                      
                
      
                
if @selectby = 'vdt'                
begin                
 insert into #MarginLedgerData                
  select m.booktype, voudt=m.vdt , effdt=l.edt, l.Acname, isnull(shortdesc,'') shortdesc, m.drcr,m.amount,                 
  m.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=m.vno and l1.vtyp=m.vtyp and l1.booktype=m.booktype and l1.lno = m.lno),''),                 
  l.Narration, m.party_code, m.vtyp, convert(varchar,m.vdt,103) vdt, convert(varchar,l.edt,103) edt,m.lno, m.vdt                 
  from marginledger m left outer join ledger l on m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno               
 and m.lno = l.lno left outer join acmast a on m.party_code = a.cltcode , vmast v                 
  where l.vdt >= @fdate + ' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'                
  and m.party_code >= @fcode and m.party_code <= @tcode and m.vtyp <> 18 and accat = '4' and m.vtyp = v.vtype                 
end                
else                
begin                
  insert into #MarginLedgerData                
  select m.booktype, voudt=m.vdt, effdt=l.edt, l.Acname, isnull(shortdesc,'') shortdesc, m.drcr,m.amount,                 
  m.vno,ddno= isnull((select ddno from ledger1 l1 where l1.vno=m.vno and l1.vtyp=m.vtyp and l1.booktype=m.booktype and l1.lno = m.lno),''),               
 l.Narration, m.party_code, m.vtyp, convert(varchar,m.vdt,103) vdt, convert(varchar,l.edt,103) edt,m.lno, m.vdt    
  from marginledger m left outer join ledger l on m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno               
 and m.lno = l.lno left outer join acmast a on m.party_code = a.cltcode , vmast v                 
  where l.edt >= @fdate + ' 00:00:00' and l.edt <= @tdate + ' 23:59:59'                
  and m.party_code >= @fcode and m.party_code <= @tcode and m.vtyp <> 18 and accat = '4' and m.vtyp = v.vtype                 
end                
                
                      
/*Getting client list*/                      
Select c2.Party_code,Bank_Name =isnull(c4.bankid,''),                      
L_Address1,L_Address2,L_Address3,L_city,L_zip,Res_Phone1,c1.Branch_cd,              
Family,c1.Sub_Broker,trader,Cl_type,Cltdpid =isnull(Cltdpid,'')                      
                      
into #LedgerClients                      
                      
from client1 c1 ,client2 c2 left outer join client4  c4 on                      
(c2.party_code=c4.party_code  and  Depository NOT IN ('NSDL','CDSL')  and  DefDp=1)                      
Where c1.cl_code=c2.cl_code                      
And c1.Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)                      
And sub_broker Like (Case When @statusid = 'sub_broker' then @statusname else  '%' end)                      
And Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)                      
And C1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)                      
And C2.Party_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)                      
and c1.Branch_Cd like @strbranch +'%'                      
and c2.Party_code >= @fcode And c2.Party_code <= @tcode           
                 
                      
/*Getting lddger entries*/                      
Select m.booktype, m.voudt, m.effdt, m.shortdesc,                       
dramt=(case when upper(m.drcr) = 'D' then m.amount else 0 end),                        
cramt=(case when upper(m.drcr) = 'C' then m.amount else 0 end),                      
m.vno, m.ddno, m.Narration, c.Party_code CltCode,m.vtyp, m.vdt,                       
m.edt, m.Acname , opbal = amount,                       
c.L_Address1,c.L_Address2,c.L_Address3,c.L_city,c.L_zip,c.Res_Phone1,c.Branch_cd, m.party_code crosac ,                   
ediff=datediff(d,m.effdt,getdate()), c.Family,c.Sub_Broker,c.trader,c.Cl_type,                      
c.Bank_Name,c.Cltdpid, m.LNo, m.Pdt                             
into  #tmpMLedger                             
from  #MarginLedgerData M Right outer join #LedgerClients c on (m.party_code=c.party_code)                      
        
/*Updating opening blanace*/                      
Update #tmpMLedger set OpBal = 0                      
Update #tmpMLedger set OpBal = t.oppbal from #tmpMLedger m,#OppBalance t where m.cltcode = t.cltcode                      
                
                      
/*Updating bank name*/                                     
update  #tmpMLedger set #tmpMLedger.bank_name= b.bank_name  from                      
pobank  b where ltrim(rtrim(cast(b.bankid  as char))) = ltrim(rtrim(#tmpMLedger.bank_name))                      
                  
update  #tmpMLedger set #tmpMLedger.acname= a.acname  from                      
acmast a where ltrim(rtrim(a.cltcode)) = ltrim(rtrim(#tmpMLedger.cltcode))                      
        
      
                  
if @strorder = 'ACCODE'                      
 begin                      
  if @selectby = 'vdt'                      
   begin                       
    select l.* from #tmpMLedger l,acmast a  where  l.cltcode = a.cltcode and accat in ('4','104') order by l.cltcode,voudt                      
   end                      
  else                      
   begin                      
    select l.* from #tmpMLedger l,acmast a   where  l.cltcode = a.cltcode and accat in ('4','104') order by l.cltcode,effdt                      
   end                      
 end                      
else                      
  begin                      
   if @selectby = 'vdt'                      
    begin                       
     select l.* from #tmpMLedger l,acmast a   where l.cltcode = a.cltcode and accat in ('4','104') order by l.Acname,voudt                      
    end                      
   else                      
    begin                      
     select l.* from #tmpMLedger l,acmast a  where l.cltcode = a.cltcode and accat in ('4','104') order by l.Acname,effdt                      
    end                      
  end                      
                      
/*  ------------------------------   End Of the Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_Marginledger_us
-- --------------------------------------------------
/*                
 proc name rpt_acc_partyledger                
 parameters fdate - from date                
            tdate - date to                
            fcode - ac code from                
            tcode - ac code to                
            strorder - printing order, possible vaues  ACCODE , ACNAME                
            selectby - report selection by , possible values vdt, edt                
            statusid - possiblevalues 'BROKER','CLIENT','FAMILY','SUBBORKER','FAMILY','BRANCH'                
*/                
                
CREATE procedure [dbo].[rpt_acc_Marginledger_us]                
                 
@fdate varchar(11),            /* As mmm dd yyyy */                
@tdate varchar(11),            /* As mmm dd yyyy */                
@fcode varchar(10),                
@tcode varchar(10),                
@strorder varchar(6),                
@selectby varchar(3),                
@statusid varchar(15),                
@statusname varchar(15),                
@strbranch varchar(10)                
as                
                
Declare @@opendate   as varchar(11)                
          
CREATE TABLE [dbo].[#MarginLedgerData] (                  
  [booktype] [char] (2) NULL ,                  
  [voudt] [datetime] NULL ,                  
  [effdt] [datetime] NULL ,                  
  [Acname] [varchar] (100) NULL ,        
  [shortdesc] [char] (6) NULL ,                    
  [drcr] [char] (1) NULL ,                  
  [amount] [money] NULL ,                  
  [vno] [varchar] (12) NULL ,                  
  [ddno] [varchar] (12) NULL ,                  
  [Narration] [varchar] (234) NULL ,                  
  [party_code] [varchar] (10) NOT NULL ,                  
  [vtyp] [smallint] NULL ,                  
  [vdt] [varchar] (30) NULL ,                  
  [edt] [varchar] (30) NULL ,                              
  [LNo] [decimal](5, 0) NULL         
 ) ON [PRIMARY]                  
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
        
        
        
        
                
                
/*Getting last opening date */                
if upper(@selectby) = 'VDT'                
 begin                
  Select @@opendate = ( Select left(convert(varchar,isnull(max(vdt),0),109),11) from marginledger where vtyp = 18 and vdt <= @fdate )                
 end                
else                
 begin                
  Select @@opendate = ( Select left(convert(varchar,isnull(max(vdt),0),109),11) from marginledger where vtyp = 18 and vdt <= @fdate )                
 end                
                
/*Creating blank table for opening balance*/                
Select CltCode=party_code,oppbal=amount into #OppBalance From marginledger where 1=2                
                
/*Getting opening balance*/                
if @selectby = 'vdt'                
begin                
 if @@opendate = @fdate                 
 begin                
  Insert into  #OppBalance                 
  select CltCode=party_code,oppbal = IsNull(sum( case when upper(drcr) = 'D' then amount else -amount end),0)                
  from marginledger                 
  where party_code >= @FCode And party_code <=@TCode and  vdt like @fdate + '%' and vtyp = 18                 
  Group By party_code                
 end                
 else                
 begin                
  Insert into  #OppBalance                 
  select CltCode=party_code,oppbal = IsNull(sum( case when upper(drcr) = 'D' then amount else -amount end),0)                  
  from marginledger                 
  where party_code >=@FCode And party_code <= @TCode  and  vdt >=  @@opendate + ' 00:00:00' and vdt < @fdate                 
  Group By party_code                
 end                
end                 
else                
begin                 
 if @@opendate = @fdate                 
 begin        Insert into  #OppBalance              
  select cltcode=party_code, opbal = sum(sett_no)            
  from marginledger             
  where party_code = @fcode and vdt LIKE @@opendate + '%' and vtyp = 18            
  group by party_code            
 end              
 else              
 begin              
  Insert into  #OppBalance                 
  select cltcode, opbal=sum(opbal)            
  from            
  (           
  select cltcode=party_code, opbal = sum(sett_no)            
  from marginledger             
  where party_code = @fcode and vdt LIKE @@opendate + '%' and vtyp = 18            
  group by party_code            
  union all            
  select cltcode=party_code, opbal = sum( case when upper(drcr) = 'D' then amount else -amount end)            
  from marginledger             
  where party_code = @fcode and vdt >= @@opendate + ' 00:00:00' and vdt < @fdate and vtyp <> 18            
  group by party_code) t            
  group by cltcode            
 end              
end                
          
          
if @selectby = 'vdt'          
begin          
 insert into #MarginLedgerData          
  select m.booktype, voudt=m.vdt , effdt=l.edt, l.Acname, isnull(shortdesc,'') shortdesc, m.drcr,m.amount,           
  m.vno,ddno= isnull((select ddno from ledger1 l1 where l1.vno=m.vno and l1.vtyp=m.vtyp and l1.booktype=m.booktype and l1.lno = m.lno),''),           
  l.Narration, m.party_code, m.vtyp, convert(varchar,m.vdt,103) vdt, convert(varchar,l.edt,103) edt,m.lno           
  from marginledger m left outer join ledger l on m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno         
 and m.lno = l.lno left outer join acmast a on m.party_code = a.cltcode , vmast v           
  where l.vdt >= @fdate + ' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'          
  and m.party_code >= @fcode and m.party_code <= @tcode and m.vtyp <> 18 and accat = '4' and m.vtyp = v.vtype           
end          
else          
begin          
  insert into #MarginLedgerData          
  select m.booktype, voudt=m.vdt, effdt=l.edt, l.Acname, isnull(shortdesc,'') shortdesc, m.drcr,m.amount,           
  m.vno,ddno= isnull((select ddno from ledger1 l1 where l1.vno=m.vno and l1.vtyp=m.vtyp and l1.booktype=m.booktype and l1.lno = m.lno),''),         
 l.Narration, m.party_code, m.vtyp, convert(varchar,m.vdt,103) vdt, convert(varchar,l.edt,103) edt,m.lno           
  from marginledger m left outer join ledger l on m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno         
 and m.lno = l.lno left outer join acmast a on m.party_code = a.cltcode , vmast v           
  where l.edt >= @fdate + ' 00:00:00' and l.edt <= @tdate + ' 23:59:59'          
  and m.party_code >= @fcode and m.party_code <= @tcode and m.vtyp <> 18 and accat = '4' and m.vtyp = v.vtype           
end          
          
                
/*Getting client list*/                
Select c2.Party_code,Bank_Name =isnull(c4.bankid,''),                
L_Address1,L_Address2,L_Address3,L_city,L_zip,Res_Phone1,c1.Branch_cd,                
Family,c1.Sub_Broker,trader,Cl_type,Cltdpid =isnull(Cltdpid,'')                
                
into #LedgerClients                
                
from client1 c1 ,client2 c2 left outer join client4  c4 on                
(c2.party_code=c4.party_code  and  Depository NOT IN ('NSDL','CDSL')  and  DefDp=1)                
Where c1.cl_code=c2.cl_code                
And c1.Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)                
And sub_broker Like (Case When @statusid = 'sub_broker' then @statusname else  '%' end)                
And Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)                
And C1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)                
And C2.Party_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)                
and c1.Branch_Cd like @strbranch +'%'                
and c2.Party_code >= @fcode And c2.Party_code <= @tcode                 
                
/*Getting lddger entries*/                
Select m.booktype, m.voudt, m.effdt, m.shortdesc,                 
dramt=(case when upper(m.drcr) = 'D' then m.amount else 0 end),                  
cramt=(case when upper(m.drcr) = 'C' then m.amount else 0 end),                
m.vno, m.ddno, m.Narration, m.Party_code CltCode,m.vtyp, m.vdt,                 
m.edt, m.Acname , opbal = amount,                 
c.L_Address1,c.L_Address2,c.L_Address3,c.L_city,c.L_zip,c.Res_Phone1,c.Branch_cd, m.party_code crosac ,             
ediff=datediff(d,m.effdt,getdate()), c.Family,c.Sub_Broker,c.trader,c.Cl_type,                
c.Bank_Name,c.Cltdpid, m.LNo                       
into  #tmpMLedger                       
from  #MarginLedgerData M Right outer join #LedgerClients c on (m.party_code=c.party_code)                
                
/*Updating opening blanace*/                
Update #tmpMLedger set OpBal = 0                
Update #tmpMLedger set OpBal = t.oppbal from #tmpMLedger m,#OppBalance t where m.cltcode = t.cltcode                
          
                
/*Updating bank name*/                               
update  #tmpMLedger set #tmpMLedger.bank_name= b.bank_name  from                
pobank  b where ltrim(rtrim(cast(b.bankid  as char))) = ltrim(rtrim(#tmpMLedger.bank_name))                
            
update  #tmpMLedger set #tmpMLedger.acname= a.acname  from                
acmast a where ltrim(rtrim(a.cltcode)) = ltrim(rtrim(#tmpMLedger.cltcode))                
            
if @strorder = 'ACCODE'                
 begin                
  if @selectby = 'vdt'                
   begin                 
    select l.* from #tmpMLedger l,acmast a  where  l.cltcode = a.cltcode and accat in ('4','104') order by l.cltcode,voudt                
   end                
  else                
   begin                
    select l.* from #tmpMLedger l,acmast a   where  l.cltcode = a.cltcode and accat in ('4','104') order by l.cltcode,effdt                
   end                
 end                
else                
  begin                
   if @selectby = 'vdt'                
    begin                 
     select l.* from #tmpMLedger l,acmast a   where l.cltcode = a.cltcode and accat in ('4','104') order by l.Acname,voudt                
    end                
   else                
    begin                
     select l.* from #tmpMLedger l,acmast a  where l.cltcode = a.cltcode and accat in ('4','104') order by l.Acname,effdt                
    end                
  end                
                
/*  ------------------------------   End Of the Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_EOD
-- --------------------------------------------------
CREATE   Procedure [dbo].[Rpt_acc_partyledger_EOD]
(
	@Fdate Varchar(11),            /* As Mmm Dd Yyyy */
	@Tdate Varchar(11),            /* As Mmm Dd Yyyy */
	@Fcode Varchar(10),
	@Tcode Varchar(10),
	@Strorder Varchar(6),
	@Selectby Varchar(3),
	@Statusid Varchar(15),
	@Statusname Varchar(15),
	@Strbranch Varchar(10)
)

As

/*========================================================================
Exec Rpt_acc_partyledger_EOD 'Sep  1 2006','Sep 21 2006','0','z','ACCODE','vdt','broker','broker','%'
Exec Rpt_acc_partyledger_EOD 'Sep  1 2006', 'Sep 29 2006', '0A147', '0A147', 'CltCode', 'VDT', 'broker', 'broker', ''
Exec Rpt_acc_partyledger_EOD_Summ 'Sep  1 2006', 'Sep 29 2006', 'Apr  1 2006', 'Mar 31 2007', 'broker', 'broker', 'VDT', '0', 'z'
Exec Rpt_acc_partyledger_EOD 'Sep 1 2006', 'Sep 29 2006', '0A147', '0A147', 'ACCODE', 'VDT', 'broker', 'broker', ''
========================================================================*/

Declare
	@@Opendate As Varchar(11),
	@@SQL AS VARCHAR(2000),
	@@SHAREDB AS VARCHAR(50)

Set Transaction Isolation Level Read Uncommitted


/*getting Last Opening Date */
	If Upper(@Selectby) = 'Vdt'
		Begin
			SELECT
				@@Opendate =
				(
					SELECT
						Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11)
					FROM CLS_LEDGER_REPORTS WITH(NoLock)
					WHERE Vtyp = 18
						AND Vdt < = @Fdate
				)
		End
	Else
		Begin
			SELECT
				@@Opendate =
				(
					SELECT
						Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11)
					FROM CLS_LEDGER_REPORTS WITH(NoLock)
					WHERE Vtyp = 18
						AND Edt < = @Fdate
				)
		End

	/*creating Blank Table For Opening Balance*/
	CREATE TABLE #oppbalance
	(
		CLTCODE VARCHAR(10),
		OPPBAL MONEY
	)

	/*getting Opening Balance*/
	If @Selectby = 'Vdt'
		Begin
			If @@Opendate = @Fdate
				Begin
					INSERT
					INTO #oppbalance
					SELECT PARTY_CODE,
						Oppbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE  <= @Tcode
						AND B.Vdt Like @Fdate + '%'
						AND B.Vtyp = 18
					GROUP BY PARTY_CODE
				End
			Else
				Begin
					INSERT
					INTO #oppbalance
					SELECT PARTY_CODE,
						Oppbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE <= @Tcode
						AND B.Vdt >= @@Opendate + ' 00:00:00'
						AND B.Vdt < @Fdate
					GROUP BY PARTY_CODE
				End
		End
	Else
		Begin
			If @@Opendate = @Fdate
				Begin
					INSERT
					INTO #oppbalance
					SELECT Cltcode,
						Opbal = Sum(Opbal)
					FROM
						(SELECT Cltcode = PARTY_CODE,
							Opbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS
						WITH(NoLock)
						WHERE PARTY_CODE >= @Fcode
							AND PARTY_CODE <= @TCODE
							AND Edt Like @@Opendate + '%'
							AND Vtyp = 18
						GROUP BY PARTY_CODE
					UNION ALL
					SELECT
					Cltcode = PARTY_CODE,
					Oppbal  = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE <= @Tcode
						AND B.Vdt < @@Opendate
						AND B.Edt >= @@Opendate
					GROUP BY PARTY_CODE
					) T
					GROUP BY Cltcode
				End
			Else
				Begin
					INSERT
					INTO #oppbalance
					SELECT
						Cltcode,
						Opbal = Sum(Opbal)
					FROM
					(
						SELECT Cltcode = PARTY_CODE,
							Opbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.Edt Like @@Opendate + '%'
							AND B.Vtyp = 18
						GROUP BY PARTY_CODE
						UNION ALL
						SELECT Cltcode = PARTY_CODE,
							Opbal =  Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.Edt >= @@Opendate + ' 00:00:00'
							AND B.Edt < @Fdate
							AND B.Vtyp <> 18
						GROUP BY PARTY_CODE
						UNION ALL
						SELECT Cltcode = PARTY_CODE,
							Oppbal = Isnull(Sum(CREDIT_AMOUNT - DEBIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.Vdt < @@Opendate
							AND B.Edt >= @@Opendate
							AND B.Vtyp <> 18
						GROUP BY PARTY_CODE
					) T
					GROUP BY Cltcode
				End
		End

	/*generating Blank Structure For Filtered Ledger */

	CREATE TABLE [#ledgerdata]
		(
		VTYP SMALLINT NOT NULL,
		VNO VARCHAR (12) NOT NULL,
		EDT DATETIME NULL,
		LNO DECIMAL(4, 0) NOT NULL,
		ACNAME VARCHAR (100) NOT NULL,
		DRCR CHAR (1) NULL,
		DRAMT MONEY NULL,
		CRAMT MONEY NULL,
		VDT DATETIME NULL,
		VNO1 VARCHAR (12) NULL,
		REFNO CHAR (12) NULL,
		BALAMT MONEY NOT NULL,
		NODAYS INT NULL,
		CDT DATETIME NULL,
		CLTCODE VARCHAR (10) NOT NULL,
		BOOKTYPE CHAR (2) NOT NULL,
		ENTEREDBY VARCHAR (25) NULL,
		PDT DATETIME NULL,
		CHECKEDBY VARCHAR (25) NULL,
		ACTNODAYS INT NULL,
		NARRATION VARCHAR (234) NULL,
		DDNO VARCHAR(35) NULL,
		SHORTDESC VARCHAR(35)
		)

	/*getting Fiiltered Ledger*/
	If @Selectby = 'Vdt'
		Begin
			INSERT
			INTO #ledgerdata
			SELECT VTYP,
				VNO,
				EDT,
				LNO = 0,
				PARTY_NAME,
				DRCR = CASE WHEN DEBIT_AMOUNT <> 0 THEN 'D' ELSE 'C' END,
				DRAMT = DEBIT_AMOUNT,
				CRAMT = CREDIT_AMOUNT,
				VDT,
				VNO1    = VNO,
				REFNO   = '',
				BALAMT  = 0,
				NODAYS  = 0,
				CDT     = GETDATE(),
				CLTCODE = PARTY_CODE,
				BOOKTYPE,
				ENTEREDBY = 'SYSTEM',
				PDT       = GETDATE(),
				CHECKEDBY = 'SYSTEM',
				ACTNODAYS = 0,
				L.NARRATION,
				DDNO = CHEQUE_NO,
				SHORTDESC = ISNULL(V.SHORTDESC, '')
			FROM CLS_LEDGER_REPORTS L WITH(	NoLock),
				Vmast V WITH(	NoLock)
			WHERE L.Vdt >= @Fdate + ' 00:00:00'
				AND L.Vtyp = V.Vtype
				AND L.Vdt <= @Tdate +' 23:59:59'
				AND L.PARTY_CODE >= @Fcode
				AND L.PARTY_CODE <= @Tcode
				AND L.VTYP <> 18
		End
	Else
		Begin
			INSERT
			INTO #ledgerdata
			SELECT VTYP,
				VNO,
				EDT,
				LNO = 0,
				PARTY_NAME,
				DRCR = CASE WHEN DEBIT_AMOUNT <> 0 THEN 'D' ELSE 'C' END,
				DRAMT = DEBIT_AMOUNT,
				CRAMT = CREDIT_AMOUNT,
				VDT,
				VNO1    = VNO,
				REFNO   = '',
				BALAMT  = 0,
				NODAYS  = 0,
				CDT     = GETDATE(),
				CLTCODE = PARTY_CODE,
				BOOKTYPE,
				ENTEREDBY = 'SYSTEM',
				PDT       = GETDATE(),
				CHECKEDBY = 'SYSTEM',
				ACTNODAYS = 0,
				L.NARRATION,
				DDNO = CHEQUE_NO,
				SHORTDESC = ISNULL(V.SHORTDESC, '')
			FROM CLS_LEDGER_REPORTS L WITH(	NoLock),
				Vmast V WITH(	NoLock)
			WHERE Edt > = @Fdate + ' 00:00:00'
				AND L.Vtyp = V.Vtype
				AND L.Edt < = @Tdate +' 23:59:59'
				AND L.PARTY_CODE > = @Fcode
				AND L.PARTY_CODE < = @Tcode
		End

	/*getting Client List*/
	CREATE TABLE #ledgerclients (PARTY_CODE VARCHAR(10))

	SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER
	SELECT @@SQL = "INSERT INTO #ledgerclients SELECT "
	SELECT @@SQL = @@SQL + "		C2.Party_code "
	SELECT @@SQL = @@SQL + "      FROM " + @@SHAREDB + ".Dbo.Client1 C1 WITH(NoLock), "
	SELECT @@SQL = @@SQL + "            " + @@SHAREDB + ".Dbo.Client2 C2 WITH(NoLock) "
	SELECT @@SQL = @@SQL + "      LEFT OUTER JOIN "
	SELECT @@SQL = @@SQL + "            " + @@SHAREDB + ".Dbo.Client4 C4 WITH(NoLock) "
	SELECT @@SQL = @@SQL + "            ON (C2.Party_code = C4.Party_code AND Depository Not In ('Nsdl', 'Cdsl') AND Defdp = 1) "
	SELECT @@SQL = @@SQL + "      WHERE C1.Cl_code = C2.Cl_code "
	SELECT @@SQL = @@SQL + "	AND '" + @Statusname + "' =  "
	SELECT @@SQL = @@SQL + "			CASE '" + @STATUSID + "' WHEN 'BRANCH' THEN C1.BRANCH_CD "
	SELECT @@SQL = @@SQL + "			WHEN 'AREA' THEN C1.AREA "
	SELECT @@SQL = @@SQL + "			WHEN 'REGION' THEN C1.REGION "
	SELECT @@SQL = @@SQL + "			WHEN 'SUBBROKER' THEN C1.SUB_BROKER "
	SELECT @@SQL = @@SQL + "			WHEN 'TRADER' THEN C1.TRADER "
	SELECT @@SQL = @@SQL + "			WHEN 'FAMILY' THEN C1.FAMILY "
	SELECT @@SQL = @@SQL + "			WHEN 'CLIENT' THEN C2.Party_code "
	SELECT @@SQL = @@SQL + "			WHEN 'PARTY' THEN C2.Party_code "
	SELECT @@SQL = @@SQL + "			ELSE 'BROKER' END "
	SELECT @@SQL = @@SQL + "            AND C2.Party_code > = '" + @Fcode + "' "
	SELECT @@SQL = @@SQL + "            AND C2.Party_code < = '" + @Tcode + "' "
	EXEC (@@SQL)

	CREATE TABLE [#tmpledger]
	(
		[Booktype] [char] (2)  NULL ,
		[Voudt] [datetime] NULL ,
		[Effdt] [datetime] NULL ,
		[Shortdesc] [varchar] (35)  NULL ,
		[Dramt] [money] NULL ,
		[Cramt] [money] NULL ,
		[Vno] [varchar] (12)  NULL ,
		[Ddno] [varchar] (15)  NULL ,
		[Narration] [varchar] (234)  NULL ,
		[Cltcode] [varchar] (10)  NULL ,
		[Vtyp] [smallint] NULL ,
		[Vdt] [varchar] (30)  NULL ,
		[Edt] [varchar] (30)  NULL ,
		[Acname] [varchar] (100)  NULL ,
		[Opbal] [money] NULL ,
		[L_address1] [varchar] (40)  NULL ,
		[L_address2] [varchar] (40)  NULL ,
		[L_address3] [varchar] (40)  NULL ,
		[L_city] [varchar] (40)  NULL ,
		[L_zip] [varchar] (10)  NULL ,
		[Res_phone1] [varchar] (15)  NULL ,
		[Branch_cd] [varchar] (10)  NULL ,
		[Crosac] [varchar] (10)  NULL ,
		[Ediff] [int] NULL ,
		[Family] [varchar] (10)  NULL ,
		[Sub_broker] [varchar] (10)  NULL ,
		[Trader] [varchar] (20)  NULL ,
		[Cl_type] [varchar] (3)  NULL ,
		[Bank_name] [varchar] (16)  NULL ,
		[Cltdpid] [varchar] (16)  NULL ,
		[Lno] [smallint] NULL
	)

	/*getting Lddger Entries*/
	INSERT
	INTO #tmpledger
	SELECT L.Booktype,
		Voudt = L.Vdt,
		Effdt = L.Edt,
		L.Shortdesc,
		Dramt,
		Cramt,
		L.Vno,
		Ddno = L.ddNo,
		L.Narration,
		C.Party_code,
		L.Vtyp,
		Convert(Varchar, L.Vdt, 103) Vdt,
		Convert(Varchar, L.Edt, 103) Edt,
		L.Acname ,
		Opbal = (DRAMT + CRAMT),
		L_address1 = '',
		L_address2 = '',
		L_address3 = '',
		L_city = '',
		L_zip = '',
		Res_phone1 = '',
		Branch_cd = '',
		Cltcode Crosac ,
		Ediff = Datediff(D, L.Edt, Getdate()),
		Family = '',
		Sub_broker = '',
		Trader = '',
		Cl_type = '',
		Bank_name = '',
		Cltdpid = '',
		Lno
	FROM #ledgerdata L WITH(NoLock)
	RIGHT OUTER JOIN #ledgerclients C WITH(NoLock) ON (L.Cltcode = C.Party_code )

	/*updating Opening Blanace*/
	UPDATE
		#tmpledger
		SET Opbal = 0

	UPDATE
		#tmpledger
		SET Opbal = T.Oppbal
	FROM #tmpledger L WITH(NoLock),
		#oppbalance T WITH(NoLock)
	WHERE L.Cltcode = T.Cltcode

	SELECT @@SQL = "SELECT "
	SELECT @@SQL = @@SQL + "	L.Booktype, L.Voudt, L.Effdt, L.Shortdesc, Dramt = IsNull(L.Dramt, 0), CrAmt = IsNull(L.Cramt, 0), L.Vno, L.Ddno, L.Narration, "
	SELECT @@SQL = @@SQL + "	L.Cltcode, L.Vtyp, L.Vdt, L.Edt, A.Acname, opBal = IsNull(L.Opbal, 0), L.L_address1, L.L_address2, L.L_address3, "
	SELECT @@SQL = @@SQL + "	L.L_city, L.L_zip, L.Res_phone1, L.Branch_cd, L.Crosac, L.Ediff, L.Family, L.Sub_broker, "
	SELECT @@SQL = @@SQL + "	L.Trader, L.Cl_type, L.Bank_name, L.Cltdpid, L.Lno "
	SELECT @@SQL = @@SQL + "	FROM #tmpledger L WITH(NoLock), "
	SELECT @@SQL = @@SQL + "		Acmast A WITH(NoLock) "
	SELECT @@SQL = @@SQL + "	WHERE L.Cltcode = A.Cltcode "
	SELECT @@SQL = @@SQL + "		AND Accat In ('4', '104') "
	SELECT @@SQL = @@SQL + "		AND (cramt <> 0 or dramt <> 0 or opbal <> 0) "
	IF @STRORDER = 'ACCODE'
		BEGIN
			IF @SELECTBY = 'VDT'
				BEGIN
					SELECT @@SQL = @@SQL + "		ORDER BY L.CLTCODE, L.VOUDT "
				END
			ELSE
				BEGIN
					SELECT @@SQL = @@SQL + "		ORDER BY L.CLTCODE, L.EFFDT "
				END
		END
	ELSE
		BEGIN
			IF @SELECTBY = 'VDT'
				BEGIN
					SELECT @@SQL = @@SQL + "		ORDER BY A.ACNAME, L.VOUDT "
				END
			ELSE
				BEGIN
					SELECT @@SQL = @@SQL + "		ORDER BY A.ACNAME, L.EFFDT "
				END
		END

/*
      If @Strorder = 'Accode'
		Begin
			If @Selectby = 'Vdt'
				Begin
					SELECT
						L.Booktype, L.Voudt, L.Effdt, L.Shortdesc, L.Dramt, L.Cramt, L.Vno, L.Ddno, L.Narration, 
						A.Cltcode, L.Vtyp, L.Vdt, L.Edt, L.Acname, L.Opbal, L.L_address1, L.L_address2, L.L_address3,
						L.L_city, L.L_zip, L.Res_phone1, L.Branch_cd, L.Crosac, L.Ediff, L.Family, L.Sub_broker, 
						L.Trader, L.Cl_type, L.Bank_name, L.Cltdpid, L.Lno
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
						AND (cramt <> 0 or dramt <> 0 or opbal <> 0)
					ORDER BY L.Cltcode,
						Voudt
				End
			Else
				Begin
					SELECT
						L.Booktype, L.Voudt, L.Effdt, L.Shortdesc, L.Dramt, L.Cramt, L.Vno, L.Ddno, L.Narration, 
						A.Cltcode, L.Vtyp, L.Vdt, L.Edt, L.Acname, L.Opbal, L.L_address1, L.L_address2, L.L_address3,
						L.L_city, L.L_zip, L.Res_phone1, L.Branch_cd, L.Crosac, L.Ediff, L.Family, L.Sub_broker, 
						L.Trader, L.Cl_type, L.Bank_name, L.Cltdpid, L.Lno
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Cltcode,
						Effdt
				End
		End
	Else
		Begin
			If @Selectby = 'Vdt'
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Acname,
						Voudt
				End
			Else
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Acname,
						Effdt
				End
		End
*/
EXEC (@@SQL)
/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_EOD_Summ
-- --------------------------------------------------
/*	*****************************************************************************************************
	THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH
	IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.
	THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.
	CREATED BY	:=	YATIN DESAI
	CREATED DATE	:=	DECEMBER 02 2005
	MODIFIED DATE	:=	DECEMBER 16 2005
	DATABASE		:=	ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX
	SYNTAX AS FOLLOWS -----
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'FAMILY'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'REGION', 'AHM', 'VDT', 'APS', 'ZPS'
	Rpt_acc_partyledger_EOD_Summ 'Apr  1 2006','Sep 27 2006','Apr  1 2006','Mar 31 2007','broker','broker','Vdt','0','z'
	*****************************************************************************************************
*/
CREATE  PROC [dbo].[Rpt_acc_partyledger_EOD_Summ]
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@STDDATE VARCHAR(11),
	@LSTDATE VARCHAR(11),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(20),
	@DISPLAYRPT VARCHAR(3),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10)

AS

DECLARE
@@SQL AS VARCHAR(2000),
@@RECCOUNTER AS NUMERIC,
@@SHAREDB AS VARCHAR(25),
@@OBJID AS INT

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID

SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER

	--INSERTING NORMAL LEDGER RECORDS
	SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
	SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
	IF @DISPLAYRPT = 'VDT'
		BEGIN
			SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
		END
	ELSE
		BEGIN
			SELECT @@SQL = @@SQL + "UNREALISED = 0, "
		END
	SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
	SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, LEDGER L "
	SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = L.CLTCODE "
	SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
	IF @DISPLAYRPT = 'VDT'
		BEGIN
			SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
		END
	ELSE
		BEGIN
			SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
		END
	IF @STATUSID = 'AREA'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'REGION'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'BRANCH'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'SUBBROKER'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'TRADER'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'FAMILY'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'CLIENT'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "
		END
	PRINT (@@SQL)
	EXEC (@@SQL)

	--INSERTING MARGIN LEDGER RECORDS
	SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
	SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, "
	SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
	IF @DISPLAYRPT = 'VDT'
		BEGIN
			SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
		END
	ELSE
		BEGIN
			SELECT @@SQL = @@SQL + "UNREALISED = 0, "
		END
	SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
	SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, MARGINLEDGER M, "
	SELECT @@SQL = @@SQL + "LEDGER L "
	SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = M.PARTY_CODE "
	SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
	SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
	IF @DISPLAYRPT = 'VDT'
		BEGIN
			SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
		END
	ELSE
		BEGIN
			SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
		END
	IF @STATUSID = 'AREA'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'REGION'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'BRANCH'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'SUBBROKER'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'TRADER'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'FAMILY'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'CLIENT'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "
		END

	PRINT (@@SQL)
	EXEC (@@SQL)

	IF @DISPLAYRPT = 'EDT'
		BEGIN
			--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
			--INSTEAD OF GIVING REVERSAL EFFECT
			--THIS SAVES UNION JOIN
			SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
			SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
			EXEC (@@SQL)
		END
	SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
	IF @@RECCOUNTER <= 0
		BEGIN
			SELECT CLTCODE, BRANCH AS LONG_NAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			RETURN
		END
	SELECT @@SQL = "SELECT CLTCODE, BRANCH AS LONG_NAME, SUM(VAMT) AS LEDGERAMOUNT, "
	SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
/*				IF @DISPLAYRPT = 'VDT'
		BEGIN*/
			SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
--					END
	SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
	SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
	SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
	SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, BRANCH "
	SELECT @@SQL = @@SQL + "ORDER BY CLTCODE, BRANCH "
	PRINT (@@SQL)
	EXEC (@@SQL)
	DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_Offline
-- --------------------------------------------------
CREATE Procedure [dbo].[Rpt_acc_partyledger_Offline]
(
	@Fdate Varchar(11),            /* As Mmm Dd Yyyy */
	@Tdate Varchar(11),            /* As Mmm Dd Yyyy */
	@Fcode Varchar(10),
	@Tcode Varchar(10),
	@Strorder Varchar(6),
	@Selectby Varchar(3),
	@Statusid Varchar(15),
	@Statusname Varchar(15),
	@Strbranch Varchar(10)
)

As

/*========================================================================
Exec Rpt_acc_partyledger 'Sep  1 2006','Sep 21 2006','0','z','ACCODE','VDT','broker','broker','%'
========================================================================*/

Declare
	@@Opendate   As Varchar(11),
	@@SQL AS VARCHAR(2000),
	@@SHAREDB AS VARCHAR(50),
	@@EXCHANGE AS VARCHAR(5),
	@@SEGMENT AS VARCHAR(10)

Set Transaction Isolation Level Read Uncommitted


SELECT TOP 1 
	@@SHAREDB = SHAREDB,
	@@EXCHANGE = EXCHANGE,
	@@SEGMENT = SEGMENT
FROM 
	OWNER
/*getting Last Opening Date */
	If Upper(@Selectby) = 'Vdt'
		Begin
			SELECT
				@@Opendate =
				(
					SELECT
						Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11)
					FROM CLS_LEDGER_REPORTS WITH(NoLock)
					WHERE Vtyp = 18
						AND Vdt < = @Fdate
						AND EXCHANGE = @@EXCHANGE
						AND SEGMENT = @@SEGMENT
				)
		End
	Else
		Begin
			SELECT
				@@Opendate =
				(
					SELECT
						Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11)
					FROM CLS_LEDGER_REPORTS WITH(NoLock)
					WHERE Vtyp = 18
						AND Edt < = @Fdate
						AND EXCHANGE = @@EXCHANGE
						AND SEGMENT = @@SEGMENT
				)
		End

	/*creating Blank Table For Opening Balance*/
	CREATE TABLE #oppbalance
	(
		CLTCODE VARCHAR(10),
		OPPBAL MONEY
	)

	/*getting Opening Balance*/
	If @Selectby = 'Vdt'
		Begin
			If @@Opendate = @Fdate
				Begin
					INSERT
					INTO #oppbalance
					SELECT PARTY_CODE,
						Oppbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE  <= @Tcode
						AND B.Vdt Like @Fdate + '%'
						AND B.Vtyp = 18
						AND EXCHANGE = @@EXCHANGE
						AND SEGMENT = @@SEGMENT
					GROUP BY PARTY_CODE
				End
			Else
				Begin
					INSERT
					INTO #oppbalance
					SELECT PARTY_CODE,
						Oppbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE <= @Tcode
						AND B.Vdt >= @@Opendate + ' 00:00:00'
						AND B.Vdt < @Fdate
						AND EXCHANGE = @@EXCHANGE
						AND SEGMENT = @@SEGMENT
					GROUP BY PARTY_CODE
				End
		End
	Else
		Begin
			If @@Opendate = @Fdate
				Begin
					INSERT
					INTO #oppbalance
					SELECT Cltcode,
						Opbal = Sum(Opbal)
					FROM
						(SELECT Cltcode = PARTY_CODE,
							Opbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS
						WITH(NoLock)
						WHERE PARTY_CODE >= @Fcode
							AND PARTY_CODE <= @TCODE
							AND Edt Like @@Opendate + '%'
							AND EXCHANGE = @@EXCHANGE
							AND SEGMENT = @@SEGMENT
							AND Vtyp = 18
						GROUP BY PARTY_CODE
					UNION ALL
					SELECT
					Cltcode = PARTY_CODE,
					Oppbal  = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE <= @Tcode
						AND B.EXCHANGE = @@EXCHANGE
						AND B.SEGMENT = @@SEGMENT
						AND B.Vdt < @@Opendate
						AND B.Edt >= @@Opendate
					GROUP BY PARTY_CODE
					) T
					GROUP BY Cltcode
				End
			Else
				Begin
					INSERT
					INTO #oppbalance
					SELECT
						Cltcode,
						Opbal = Sum(Opbal)
					FROM
					(
						SELECT Cltcode = PARTY_CODE,
							Opbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.EXCHANGE = @@EXCHANGE
							AND B.SEGMENT = @@SEGMENT
							AND B.Edt Like @@Opendate + '%'
							AND B.Vtyp = 18
						GROUP BY PARTY_CODE
						UNION ALL
						SELECT Cltcode = PARTY_CODE,
							Opbal =  Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.EXCHANGE = @@EXCHANGE
							AND B.SEGMENT = @@SEGMENT
							AND B.Edt >= @@Opendate + ' 00:00:00'
							AND B.Edt < @Fdate
							AND B.Vtyp <> 18
						GROUP BY PARTY_CODE
						UNION ALL
						SELECT Cltcode = PARTY_CODE,
							Oppbal = Isnull(Sum(CREDIT_AMOUNT - DEBIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.EXCHANGE = @@EXCHANGE
							AND B.SEGMENT = @@SEGMENT
							AND B.Vdt < @@Opendate
							AND B.Edt >= @@Opendate
							AND B.Vtyp <> 18
						GROUP BY PARTY_CODE
					) T
					GROUP BY Cltcode
				End
		End

	/*generating Blank Structure For Filtered Ledger */

	CREATE TABLE [#ledgerdata]
		(
		VTYP SMALLINT NOT NULL,
		VNO VARCHAR (12) NOT NULL,
		EDT DATETIME NULL,
		LNO DECIMAL(4, 0) NOT NULL,
		ACNAME VARCHAR (100) NOT NULL,
		DRCR CHAR (1) NULL,
		DRAMT MONEY NULL,
		CRAMT MONEY NULL,
		VDT DATETIME NULL,
		VNO1 VARCHAR (12) NULL,
		REFNO CHAR (12) NULL,
		BALAMT MONEY NOT NULL,
		NODAYS INT NULL,
		CDT DATETIME NULL,
		CLTCODE VARCHAR (10) NOT NULL,
		BOOKTYPE CHAR (2) NOT NULL,
		ENTEREDBY VARCHAR (25) NULL,
		PDT DATETIME NULL,
		CHECKEDBY VARCHAR (25) NULL,
		ACTNODAYS INT NULL,
		NARRATION VARCHAR (234) NULL,
		DDNO VARCHAR(15) NULL,
		SHORTDESC VARCHAR(35)
		)

	/*getting Fiiltered Ledger*/
	If @Selectby = 'Vdt'
		Begin
			INSERT
			INTO #ledgerdata
			SELECT VTYP,
				VNO,
				EDT,
				LNO = 0,
				PARTY_NAME,
				DRCR = CASE WHEN DEBIT_AMOUNT <> 0 THEN 'D' ELSE 'C' END,
				DRAMT = DEBIT_AMOUNT,
				CRAMT = CREDIT_AMOUNT,
				VDT,
				VNO1    = VNO,
				REFNO   = '',
				BALAMT  = 0,
				NODAYS  = 0,
				CDT     = GETDATE(),
				CLTCODE = PARTY_CODE,
				BOOKTYPE,
				ENTEREDBY = 'SYSTEM',
				PDT       = GETDATE(),
				CHECKEDBY = 'SYSTEM',
				ACTNODAYS = 0,
				L.NARRATION,
				DDNO = CHEQUE_NO,
				SHORTDESC = ISNULL(V.SHORTDESC, '')
			FROM CLS_LEDGER_REPORTS L WITH(	NoLock),
				Vmast V WITH(	NoLock)
			WHERE L.Vdt >= @Fdate + ' 00:00:00'
				AND L.Vtyp = V.Vtype
				AND L.Vdt <= @Tdate +' 23:59:59'
				AND L.PARTY_CODE >= @Fcode
				AND L.PARTY_CODE <= @Tcode
				AND L.VTYP <> 18
				AND L.EXCHANGE = @@EXCHANGE
				AND L.SEGMENT = @@SEGMENT
		End
	Else
		Begin
			INSERT
			INTO #ledgerdata
			SELECT VTYP,
				VNO,
				EDT,
				LNO = 0,
				PARTY_NAME,
				DRCR = CASE WHEN DEBIT_AMOUNT <> 0 THEN 'D' ELSE 'C' END,
				DRAMT = DEBIT_AMOUNT,
				CRAMT = CREDIT_AMOUNT,
				VDT,
				VNO1    = VNO,
				REFNO   = '',
				BALAMT  = 0,
				NODAYS  = 0,
				CDT     = GETDATE(),
				CLTCODE = PARTY_CODE,
				BOOKTYPE,
				ENTEREDBY = 'SYSTEM',
				PDT       = GETDATE(),
				CHECKEDBY = 'SYSTEM',
				ACTNODAYS = 0,
				L.NARRATION,
				DDNO = CHEQUE_NO,
				SHORTDESC = ISNULL(V.SHORTDESC, '')
			FROM CLS_LEDGER_REPORTS L WITH(	NoLock),
				Vmast V WITH(	NoLock)
			WHERE Edt > = @Fdate + ' 00:00:00'
				AND L.Vtyp = V.Vtype
				AND L.Edt < = @Tdate +' 23:59:59'
				AND L.PARTY_CODE > = @Fcode
				AND L.PARTY_CODE < = @Tcode
				AND L.EXCHANGE = @@EXCHANGE
				AND L.SEGMENT = @@SEGMENT
		End

	/*getting Client List*/
	CREATE TABLE #ledgerclients (PARTY_CODE VARCHAR(10), LONG_NAME VARCHAR(100))

	SELECT @@SQL = "INSERT INTO #ledgerclients SELECT "
	SELECT @@SQL = @@SQL + "		C2.Party_code, "
	SELECT @@SQL = @@SQL + "		C1.LONG_NAME "
	SELECT @@SQL = @@SQL + "      FROM " + @@SHAREDB + ".Dbo.Client1 C1 WITH(NoLock), "
	SELECT @@SQL = @@SQL + "            " + @@SHAREDB + ".Dbo.Client2 C2 WITH(NoLock) "
	SELECT @@SQL = @@SQL + "      LEFT OUTER JOIN "
	SELECT @@SQL = @@SQL + "            " + @@SHAREDB + ".Dbo.Client4 C4 WITH(NoLock) "
	SELECT @@SQL = @@SQL + "            ON (C2.Party_code = C4.Party_code AND Depository Not In ('Nsdl', 'Cdsl') AND Defdp = 1) "
	SELECT @@SQL = @@SQL + "      WHERE C1.Cl_code = C2.Cl_code "
	SELECT @@SQL = @@SQL + "	AND '" + @Statusname + "' =  "
	SELECT @@SQL = @@SQL + "			CASE '" + @STATUSID + "' WHEN 'BRANCH' THEN C1.BRANCH_CD "
	SELECT @@SQL = @@SQL + "			WHEN 'AREA' THEN C1.AREA "
	SELECT @@SQL = @@SQL + "			WHEN 'REGION' THEN C1.REGION "
	SELECT @@SQL = @@SQL + "			WHEN 'SUBBROKER' THEN C1.SUB_BROKER "
	SELECT @@SQL = @@SQL + "			WHEN 'TRADER' THEN C1.TRADER "
	SELECT @@SQL = @@SQL + "			WHEN 'FAMILY' THEN C1.FAMILY "
	SELECT @@SQL = @@SQL + "			WHEN 'CLIENT' THEN C2.Party_code "
	SELECT @@SQL = @@SQL + "			WHEN 'PARTY' THEN C2.Party_code "
	SELECT @@SQL = @@SQL + "			ELSE 'BROKER' END "
	SELECT @@SQL = @@SQL + "            AND C2.Party_code > = '" + @Fcode + "' "
	SELECT @@SQL = @@SQL + "            AND C2.Party_code < = '" + @Tcode + "' "
	EXEC (@@SQL)

	CREATE TABLE [#tmpledger]
	(
		[Booktype] [char] (2)  NULL ,
		[Voudt] [datetime] NULL ,
		[Effdt] [datetime] NULL ,
		[Shortdesc] [varchar] (35)  NULL ,
		[Dramt] [money] NULL ,
		[Cramt] [money] NULL ,
		[Vno] [varchar] (12)  NULL ,
		[Ddno] [varchar] (15)  NULL ,
		[Narration] [varchar] (234)  NULL ,
		[Cltcode] [varchar] (10)  NULL ,
		[Vtyp] [smallint] NULL ,
		[Vdt] [varchar] (30)  NULL ,
		[Edt] [varchar] (30)  NULL ,
		[Acname] [varchar] (100)  NULL ,
		[Opbal] [money] NULL ,
		[L_address1] [varchar] (40)  NULL ,
		[L_address2] [varchar] (40)  NULL ,
		[L_address3] [varchar] (40)  NULL ,
		[L_city] [varchar] (40)  NULL ,
		[L_zip] [varchar] (10)  NULL ,
		[Res_phone1] [varchar] (15)  NULL ,
		[Branch_cd] [varchar] (10)  NULL ,
		[Crosac] [varchar] (10)  NULL ,
		[Ediff] [int] NULL ,
		[Family] [varchar] (10)  NULL ,
		[Sub_broker] [varchar] (10)  NULL ,
		[Trader] [varchar] (20)  NULL ,
		[Cl_type] [varchar] (3)  NULL ,
		[Bank_name] [varchar] (16)  NULL ,
		[Cltdpid] [varchar] (16)  NULL ,
		[Lno] [smallint] NULL
	)

	/*getting Lddger Entries*/
	INSERT
	INTO #tmpledger
	SELECT L.Booktype,
		Voudt = L.Vdt,
		Effdt = L.Edt,
		L.Shortdesc,
		Dramt,
		Cramt,
		L.Vno,
		Ddno,
		L.Narration,
		C.Party_code,
		L.Vtyp,
		Convert(Varchar, L.Vdt, 103) Vdt,
		Convert(Varchar, L.Edt, 103) Edt,
		Acname = C.LONG_NAME,
		Opbal = (DRAMT + CRAMT),
		L_address1 = '',
		L_address2 = '',
		L_address3 = '',
		L_city = '',
		L_zip = '',
		Res_phone1 = '',
		Branch_cd = '',
		Crosac = '',
		Ediff = Datediff(D, L.Edt, Getdate()),
		Family = '',
		Sub_broker = '',
		Trader = '',
		Cl_type = '',
		Bank_name = '',
		Cltdpid = '',
		Lno
	FROM #ledgerdata L WITH(NoLock)
	RIGHT OUTER JOIN #ledgerclients C WITH(NoLock) ON (L.Cltcode = C.Party_code )

	/*updating Opening Blanace*/
	UPDATE
		#tmpledger
		SET Opbal = 0

	UPDATE
		#tmpledger
		SET Opbal = T.Oppbal
	FROM #tmpledger L WITH(NoLock),
		#oppbalance T WITH(NoLock)
	WHERE L.Cltcode = T.Cltcode

      If @Strorder = 'Accode'
		Begin
			If @Selectby = 'Vdt'
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
						AND (cramt <> 0 or dramt <> 0 or opbal <> 0)
					ORDER BY L.Cltcode,
						Voudt
				End
			Else
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Cltcode,
						Effdt
				End
		End
	Else
		Begin
			If @Selectby = 'Vdt'
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Acname,
						Voudt
				End
			Else
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Acname,
						Effdt
				End
		End

/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_renamedfor_EOD
-- --------------------------------------------------
CREATE  Procedure [dbo].[Rpt_acc_partyledger_renamedfor_EOD]
(
	@Fdate Varchar(11),            /* As Mmm Dd Yyyy */      
	@Tdate Varchar(11),            /* As Mmm Dd Yyyy */      
	@Fcode Varchar(10),      
	@Tcode Varchar(10),      
	@Strorder Varchar(6),      
	@Selectby Varchar(3),      
	@Statusid Varchar(15),      
	@Statusname Varchar(15),      
	@Strbranch Varchar(10)      
)

As      
      
/*========================================================================
      Exec rpt_acc_partyledger_all 
            'Nov  1 2005',
            'Dec 31 2005',
            'a',
            'zzz',
            'ACCODE',
            'vdt',
            'broker',
            'undefined',
            ''
========================================================================*/

Declare 
	@@Opendate   As Varchar(11)      
      
Set Transaction Isolation Level Read Uncommitted      
      
      
/*getting Last Opening Date */      
      If Upper(@Selectby) = 'Vdt'      
      Begin      
            SELECT 
                  @@Opendate = 
                  ( 
                        SELECT 
                              Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) 
                        FROM Ledger WITH(NoLock) 
                        WHERE Vtyp = 18 
                              AND Vdt < = @Fdate 
                  ) 
      End      
      Else      
      Begin      
            SELECT 
                  @@Opendate = 
                  ( 
                        SELECT 
                              Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11) 
                        FROM Ledger WITH(NoLock) 
                        WHERE Vtyp = 18 
                              AND Edt < = @Fdate 
                  ) 
      End      
            
      
      /*creating Blank Table For Opening Balance*/      
            SELECT 
                  Cltcode, 
                  Oppbal = Vamt 
            INTO #oppbalance 
            FROM Ledger WITH(NoLock) 
            WHERE 1 = 2 
            
      
      /*getting Opening Balance*/      
      If @Selectby = 'Vdt'      
      Begin      
            If @@Opendate = @Fdate       
            Begin      
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
                        Oppbal = Isnull(Sum( 
                        CASE 
                              WHEN Upper(B.Drcr) = 'D' 
                              THEN B.Vamt 
                              ELSE -b.Vamt 
                        END
                        ), 0) 
                  FROM Ledger B WITH(NoLock) 
                  WHERE B.Cltcode > = @Fcode 
                        AND B.Cltcode < = @Tcode 
                        AND B.Vdt Like @Fdate + '%' 
                        AND Vtyp = 18 
                  GROUP BY Cltcode 
            End      
            Else      
            Begin      
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
                        Oppbal = Isnull(Sum( 
                        CASE 
                              WHEN Upper(B.Drcr) = 'D' 
                              THEN B.Vamt 
                              ELSE -b.Vamt 
                        END
                        ), 0) 
                  FROM Ledger B WITH(NoLock) 
                  WHERE B.Cltcode > = @Fcode 
                        AND B.Cltcode < = @Tcode 
                        AND B.Vdt > = @@Opendate + ' 00:00:00' 
                        AND Vdt < @Fdate 
                  GROUP BY Cltcode 
            End      
      End       
      Else      
      Begin       
            If @@Opendate = @Fdate       
            Begin    
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
        Opbal = Sum(Opbal) 
                  FROM 
                        ( 
                              SELECT 
                                    Cltcode, 
                                    Opbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(Drcr) = 'D' 
                                          THEN Vamt 
                                          ELSE -vamt 
                                    END
                                    ), 0) 
                              FROM Ledger WITH(NoLock) 
                              WHERE Cltcode = @Fcode 
                                    AND Edt Like @@Opendate + '%' 
                                    AND Vtyp = 18 
                              GROUP BY Cltcode 
                              UNION ALL 
                              SELECT 
                                    Cltcode, 
                                    Oppbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(B.Drcr) = 'C' 
                                          THEN B.Vamt 
                                          ELSE -b.Vamt 
                                    END
                                    ), 0) 
                              FROM Ledger B WITH(NoLock) 
                              WHERE B.Cltcode > = @Fcode 
                                    AND B.Cltcode < = @Tcode 
                                    AND B.Vdt < @@Opendate
                                    AND Edt >= @@Opendate 
                              GROUP BY Cltcode 
                        ) 
                        T 
                  GROUP BY Cltcode 
            End    
            Else    
            Begin    
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
                        Opbal = Sum(Opbal) 
                  FROM 
                        ( 
                              SELECT 
                                    Cltcode, 
                                    Opbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(Drcr) = 'D' 
                                          THEN Vamt 
                                          ELSE -vamt 
                                    END
                                    ), 0) 
                              FROM Ledger WITH(NoLock) 
                              WHERE Cltcode = @Fcode 
                                    AND Edt Like @@Opendate + '%' 
                                    AND Vtyp = 18 
                              GROUP BY Cltcode 
                              UNION ALL 
                              SELECT 
                                    Cltcode, 
                                    Opbal = Sum( 
                                    CASE 
                                          WHEN Upper(Drcr) = 'D' 
                                          THEN Vamt 
                                          ELSE -vamt 
                                    END
                                    ) 
                              FROM Ledger WITH(NoLock) 
                              WHERE Cltcode = @Fcode 
                                    AND Edt > = @@Opendate + ' 00:00:00' 
                                    AND Edt < @Fdate 
                                    AND Vtyp <> 18 
                              GROUP BY Cltcode 
                              UNION ALL 
                              SELECT 
                                    Cltcode, 
                                    Oppbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(B.Drcr) = 'C' 
                                          THEN B.Vamt 
      ELSE -b.Vamt 
                                    END
                                    ), 0) 
                              FROM Ledger B WITH(NoLock) 
                              WHERE B.Cltcode > = @Fcode 
                                    AND B.Cltcode < = @Tcode 
                                    AND B.Vdt < @@Opendate 
                                    AND Edt >= @@Opendate 
                              GROUP BY Cltcode 
                        ) 
                        T 
                  GROUP BY Cltcode 
            End    
      End      
            
      
      /*generating Blank Structure For Filtered Ledger */      
            SELECT 
                  L.*, 
                  Shortdesc = Space(35) 
            INTO #ledgerdata 
            FROM Ledger L WITH(NoLock) 
            WHERE 1 = 2 
            
      
      
      /*getting Fiiltered Ledger*/      
      If @Selectby = 'Vdt'      
      Begin      
            INSERT 
            INTO #ledgerdata 
            SELECT 
                  L.*, 
                  Isnull(V.Shortdesc, '') Shortdesc 
            FROM Ledger L WITH(NoLock), 
                  Vmast V WITH(NoLock) 
            WHERE Vdt > = @Fdate + ' 00:00:00' 
                  AND L.Vtyp = V.Vtype 
                  AND Vdt < = @Tdate +' 23:59:59' 
                  AND Cltcode > = @Fcode 
                  AND Cltcode < = @Tcode 
      End       
      Else      
      Begin      
            INSERT 
            INTO #ledgerdata 
            SELECT 
                  L.*, 
                  Isnull(V.Shortdesc, '') Shortdesc 
            FROM Ledger L WITH(NoLock), 
                  Vmast V WITH(NoLock) 
            WHERE Edt > = @Fdate + ' 00:00:00' 
                  AND L.Vtyp = V.Vtype 
                  AND Edt < = @Tdate +' 23:59:59' 
                  AND Cltcode > = @Fcode 
                  AND Cltcode < = @Tcode 
      End      
      


/*getting Client List*/      
      SELECT 
            C2.Party_code, 
            Bank_name = Isnull(C4.Bankid, ''), 
            L_address1, 
            L_address2, 
            L_address3, 
            L_city, 
            L_zip, 
            Res_phone1, 
            C1.Branch_cd, 
            Family, 
            C1.Sub_broker, 
            Trader, 
            Cl_type, 
            Cltdpid = Isnull(Cltdpid, '') 
      INTO #ledgerclients 
      FROM Client1 C1 WITH(NoLock), 
            Client2 C2 WITH(NoLock) 
      LEFT OUTER JOIN 
            Client4 C4 WITH(NoLock) 
            ON 
            (
                  C2.Party_code = C4.Party_code 
                  AND Depository Not In ('Nsdl', 'Cdsl') 
                  AND Defdp = 1
            ) 
      WHERE C1.Cl_code = C2.Cl_code 
            AND C1.Branch_cd Like (
            CASE 
                  WHEN @Statusid = 'Branch' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND C1.Area Like (
            CASE 
                  WHEN @Statusid = 'Area' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND Sub_broker Like (
            CASE 
                  WHEN @Statusid = 'Sub_broker' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND Trader Like (
            CASE 
                  WHEN @Statusid = 'Trader' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND C1.Family Like (
            CASE 
                  WHEN @Statusid = 'Family' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND C2.Party_code Like (
            CASE 
                  WHEN @Statusid = 'Client' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND C1.Branch_cd Like @Strbranch +'%' 
            AND C2.Party_code > = @Fcode 
            AND C2.Party_code < = @Tcode 


      CREATE TABLE [#tmpledger] (
      	[Booktype] [char] (2)  NULL ,
      	[Voudt] [datetime] NULL ,
      	[Effdt] [datetime] NULL ,
      	[Shortdesc] [varchar] (35)  NULL ,
      	[Dramt] [money] NULL ,
      	[Cramt] [money] NULL ,
      	[Vno] [varchar] (12)  NULL ,
      	[Ddno] [varchar] (15)  NULL ,
      	[Narration] [varchar] (234)  NULL ,
      	[Cltcode] [varchar] (10)  NOT NULL ,
      	[Vtyp] [smallint] NULL ,
      	[Vdt] [varchar] (30)  NULL ,
      	[Edt] [varchar] (30)  NULL ,
      	[Acname] [varchar] (100)  NULL ,
      	[Opbal] [money] NULL ,
      	[L_address1] [varchar] (40)  NOT NULL ,
      	[L_address2] [varchar] (40)  NULL ,
      	[L_address3] [varchar] (40)  NULL ,
      	[L_city] [varchar] (40)  NULL ,
      	[L_zip] [varchar] (10)  NULL ,
      	[Res_phone1] [varchar] (15)  NULL ,
      	[Branch_cd] [varchar] (10)  NOT NULL ,
      	[Crosac] [varchar] (10)  NULL ,
      	[Ediff] [int] NULL ,
      	[Family] [varchar] (10)  NOT NULL ,
      	[Sub_broker] [varchar] (10)  NOT NULL ,
      	[Trader] [varchar] (20)  NOT NULL ,
      	[Cl_type] [varchar] (3)  NOT NULL ,
      	[Bank_name] [varchar] (16)  NOT NULL ,
      	[Cltdpid] [varchar] (16)  NOT NULL ,
      	[Lno] [decimal](4, 0) NULL 
      ) ON [PRIMARY]

      
/*getting Lddger Entries*/      
      INSERT 
            INTO #tmpledger 
      SELECT 
            L.Booktype, 
            Voudt = L.Vdt, 
            Effdt = L.Edt, 
            L.Shortdesc, 
            Dramt = (
            CASE 
                  WHEN Upper(L.Drcr) = 'D' 
                  THEN L.Vamt 
                  ELSE 0 
            END
            ), 
            Cramt = (
            CASE 
                  WHEN Upper(L.Drcr) = 'C' 
                  THEN L.Vamt 
                  ELSE 0 
            END
            ), 
            L.Vno, 
            Ddno = Space(15), 
            L.Narration, 
            C.Party_code Cltcode, 
            L.Vtyp, 
            Convert(Varchar, L.Vdt, 103) Vdt, 
            Convert(Varchar, L.Edt, 103) Edt, 
            L.Acname , 
            Opbal = Vamt, 
            C.L_address1, 
            C.L_address2, 
            C.L_address3, 
            C.L_city, 
            C.L_zip, 
            C.Res_phone1, 
            C.Branch_cd, 
            L.Cltcode Crosac , 
            Ediff = Datediff(D, L.Edt, Getdate()), 
            C.Family, 
            C.Sub_broker, 
            C.Trader, 
            C.Cl_type, 
            C.Bank_name, 
            C.Cltdpid, 
            L.Lno 
      FROM #ledgerdata L WITH(NoLock) 
      RIGHT OUTER JOIN 
            #ledgerclients C WITH(NoLock) 
            ON 
            (
                  L.Cltcode = C.Party_code
            ) 


      
/*updating Opening Blanace*/      
      UPDATE 
            #tmpledger 
            SET Opbal = 0 

      UPDATE 
            #tmpledger 
            SET Opbal = T.Oppbal 
      FROM #tmpledger L WITH(NoLock), 
            #oppbalance T WITH(NoLock) 
      WHERE L.Cltcode = T.Cltcode 
      


/*updating Cheque Number*/      
      UPDATE 
            #tmpledger 
            SET Ddno = L1.Ddno 
      FROM Ledger1 L1 WITH(NoLock) 
      WHERE L1.Vno = #tmpledger.Vno 
            AND L1.Vtyp = #tmpledger.Vtyp 
            AND L1.Booktype = #tmpledger.Booktype 
            AND L1.Lno = #tmpledger.Lno 
      


/*updating Cross Account Code*/      
      UPDATE 
            #tmpledger 
            SET #tmpledger.Crosac = B.Cltcode 
      FROM Ledger B WITH(NoLock), 
            Acmast V WITH(NoLock) 
      WHERE B.Cltcode = V.Cltcode 
            AND V.Accat = 2 
            AND #tmpledger.Booktype = B.Booktype 
            AND #tmpledger.Vno = B.Vno 
            AND #tmpledger.Vtyp = B.Vtyp 
            AND Ltrim(Rtrim(#tmpledger.Vtyp)) In ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23') 
      


/*updating Bank Name*/                     
      UPDATE 
            #tmpledger 
            SET #tmpledger.Bank_name = B.Bank_name 
      FROM Pobank B WITH(NoLock) 
      WHERE Ltrim(Rtrim(Cast(B.Bankid AS Char))) = Ltrim(Rtrim(#tmpledger.Bank_name)) 

      
      If @Strorder = 'Accode'      
      Begin      
            If @Selectby = 'Vdt'      
            Begin       
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
				AND (cramt <> 0 or dramt <> 0 or opbal <> 0)
                  ORDER BY L.Cltcode, 
                        Voudt 
            End      
            Else      
            Begin      
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
                  ORDER BY L.Cltcode, 
                        Effdt 
            End      
      End      
      Else      
      Begin      
            If @Selectby = 'Vdt'      
            Begin       
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
                  ORDER BY L.Acname, 
                        Voudt 
            End      
            Else      
            Begin      
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
                  ORDER BY L.Acname, 
                        Effdt 
            End      
      End      
      
/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_us
-- --------------------------------------------------
--exec Rpt_acc_partyledger 'May  1 2006','May 24 2006','jkja11','jkja11','ACCODE','vdt','broker','undefined',''        
CREATE Procedure [dbo].[Rpt_acc_partyledger_us]                  
(            
 @Fdate Varchar(11),            /* As Mmm Dd Yyyy */                  
 @Tdate Varchar(11),            /* As Mmm Dd Yyyy */                  
 @Fcode Varchar(10),                  
 @Tcode Varchar(10),                  
 @Strorder Varchar(6),                  
 @Selectby Varchar(3),                  
 @Statusid Varchar(15),                  
 @Statusname Varchar(15),                  
 @Strbranch Varchar(10)                  
)            
            
As                  
                  
/*========================================================================            
      Exec rpt_acc_partyledger_all             
            'Nov  1 2005',            
            'Dec 31 2005',            
            'a',            
            'zzz',            
            'ACCODE',            
            'vdt',            
            'broker',            
            'undefined',            
            ''            
========================================================================*/            
            
Declare             
 @@Opendate   As Varchar(11)                  
                  
Set Transaction Isolation Level Read Uncommitted                  
                  
                  
/*getting Last Opening Date */                  
      If Upper(@Selectby) = 'Vdt'                  
      Begin                  
            SELECT             
                  @@Opendate =             
                  (             
                        SELECT             
                              Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11)             
                        FROM Ledger WITH(NoLock)             
                        WHERE Vtyp = 18             
                              AND Vdt < = @Fdate             
                  )             
      End                  
      Else                  
      Begin                  
            SELECT             
                  @@Opendate =             
                  (             
                        SELECT             
                              Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11)             
                        FROM Ledger WITH(NoLock)             
                        WHERE Vtyp = 18             
                              AND Edt < = @Fdate             
                  )             
      End                  
                        
                  
      /*creating Blank Table For Opening Balance*/                  
            SELECT             
                  Cltcode,             
                  Oppbal = Vamt             
            INTO #oppbalance             
            FROM Ledger WITH(NoLock)             
            WHERE 1 = 2             
                        
                  
      /*getting Opening Balance*/                  
      If @Selectby = 'Vdt'                  
      Begin                  
            If @@Opendate = @Fdate                   
            Begin                  
                  INSERT             
                  INTO #oppbalance             
                  SELECT             
                        Cltcode,             
                        Oppbal = Isnull(Sum(             
                        CASE             
                              WHEN Upper(B.Drcr) = 'D'             
                              THEN B.Vamt             
                              ELSE -b.Vamt             
                        END            
                        ), 0)             
                  FROM Ledger B WITH(NoLock)             
                  WHERE B.Cltcode > = @Fcode             
                        AND B.Cltcode < = @Tcode             
                        AND B.Vdt Like @Fdate + '%'             
                        AND Vtyp = 18             
                  GROUP BY Cltcode             
            End                
            Else                  
            Begin                  
                  INSERT             
                  INTO #oppbalance             
                  SELECT       
                        Cltcode,             
                        Oppbal = Isnull(Sum(             
                        CASE             
                              WHEN Upper(B.Drcr) = 'D'             
                              THEN B.Vamt             
                              ELSE -b.Vamt             
                        END            
                        ), 0)             
                  FROM Ledger B WITH(NoLock)             
                  WHERE B.Cltcode > = @Fcode             
                        AND B.Cltcode < = @Tcode             
                        AND B.Vdt > = @@Opendate + ' 00:00:00'             
                        AND Vdt < @Fdate             
                  GROUP BY Cltcode             
            End                  
      End                   
      Else             
      Begin                   
            If @@Opendate = @Fdate                   
            Begin                
                  INSERT             
                  INTO #oppbalance             
                  SELECT             
                        Cltcode,             
        Opbal = Sum(Opbal)             
                  FROM             
                        (             
                              SELECT             
                                    Cltcode,             
                                    Opbal = Isnull(Sum(             
                                    CASE             
                                          WHEN Upper(Drcr) = 'D'             
                                          THEN Vamt             
                                          ELSE -vamt             
                                    END            
                                    ), 0)             
                              FROM Ledger WITH(NoLock)             
                              WHERE Cltcode = @Fcode             
                                    AND Edt Like @@Opendate + '%'             
                                    AND Vtyp = 18             
                              GROUP BY Cltcode             
                              UNION ALL             
                              SELECT             
                                    Cltcode,             
                                    Oppbal = Isnull(Sum(             
                                    CASE             
                                          WHEN Upper(B.Drcr) = 'C'             
                                          THEN B.Vamt             
                                          ELSE -b.Vamt             
                                    END            
                                    ), 0)             
                              FROM Ledger B WITH(NoLock)             
                              WHERE B.Cltcode > = @Fcode             
                                    AND B.Cltcode < = @Tcode             
                                    AND B.Edt > = @@Opendate + ' 00:00:00'             
                                    AND B.Vdt < @@Opendate             
                              GROUP BY Cltcode             
                        )             
                        T             
                  GROUP BY Cltcode             
            End                
            Else                
            Begin                
                  INSERT             
                  INTO #oppbalance             
                  SELECT             
                        Cltcode,             
                        Opbal = Sum(Opbal)             
                  FROM             
                        (             
                              SELECT             
                                    Cltcode,             
                                    Opbal = Isnull(Sum(         
                                    CASE             
                                          WHEN Upper(Drcr) = 'D'             
                                          THEN Vamt             
                                          ELSE -vamt             
                                    END            
   ), 0)             
                              FROM Ledger WITH(NoLock)             
                              WHERE Cltcode = @Fcode             
                                    AND Edt Like @@Opendate + '%'             
                                    AND Vtyp = 18             
                              GROUP BY Cltcode             
    UNION ALL             
                              SELECT             
                                    Cltcode,             
                                    Opbal = Sum(             
                                    CASE             
                                          WHEN Upper(Drcr) = 'D'             
                                          THEN Vamt             
                     ELSE -vamt             
                                    END            
                                    )             
                              FROM Ledger WITH(NoLock)             
                              WHERE Cltcode = @Fcode             
                                    AND Edt > = @@Opendate + ' 00:00:00'             
                                    AND Edt < @Fdate             
                                    AND Vtyp <> 18             
                              GROUP BY Cltcode             
                       UNION ALL             
                              SELECT             
                                    Cltcode,             
                                    Oppbal = Isnull(Sum(             
                                    CASE             
                                          WHEN Upper(B.Drcr) = 'C'             
                                          THEN B.Vamt             
      ELSE -b.Vamt             
                                    END            
                                    ), 0)             
                              FROM Ledger B WITH(NoLock)             
                              WHERE B.Cltcode > = @Fcode             
                                    AND B.Cltcode < = @Tcode             
                                    AND B.Edt > = @@Opendate + ' 00:00:00'             
                                    AND B.Vdt < @@Opendate             
                              GROUP BY Cltcode             
                        )             
                        T             
                  GROUP BY Cltcode             
            End                
      End                  
                        
                  
      /*generating Blank Structure For Filtered Ledger */                  
            SELECT             
                  L.*,             
                  Shortdesc = Space(35)             
            INTO #ledgerdata             
            FROM Ledger L WITH(NoLock)             
            WHERE 1 = 2             
                        
                  
                  
      /*getting Fiiltered Ledger*/                  
      If @Selectby = 'Vdt'                  
      Begin                  
            INSERT             
            INTO #ledgerdata             
            SELECT             
                  L.*,             
                  Isnull(V.Shortdesc, '') Shortdesc             
            FROM Ledger L WITH(NoLock),             
                  Vmast V WITH(NoLock)             
            WHERE Vdt > = @Fdate + ' 00:00:00'             
                  AND L.Vtyp = V.Vtype             
                  AND Vdt < = @Tdate +' 23:59:59'             
                  AND Cltcode > = @Fcode             
                  AND Cltcode < = @Tcode             
      End                   
      Else                  
      Begin                  
            INSERT             
            INTO #ledgerdata             
            SELECT             
                  L.*,             
                  Isnull(V.Shortdesc, '') Shortdesc             
            FROM Ledger L WITH(NoLock),             
                  Vmast V WITH(NoLock)             
            WHERE Edt > = @Fdate + ' 00:00:00'             
                  AND L.Vtyp = V.Vtype             
                  AND Edt < = @Tdate +' 23:59:59'             
                  AND Cltcode > = @Fcode             
                  AND Cltcode < = @Tcode             
      End                  
                  
            
            
/*getting Client List*/                  
      SELECT             
            C2.Party_code,             
            Bank_name = Isnull(C4.Bankid, ''),             
            L_address1,             
            L_address2,             
            L_address3,             
            L_city,             
            L_zip,             
            Res_phone1,             
            C1.Branch_cd,             
            Family,             
            C1.Sub_broker,             
            Trader,             
            Cl_type,             
            Cltdpid = Isnull(Cltdpid, '')             
      INTO #ledgerclients             
      FROM Client1 C1 WITH(NoLock),             
            Client2 C2 WITH(NoLock)             
      LEFT OUTER JOIN             
            Client4 C4 WITH(NoLock)             
            ON             
            (            
                  C2.Party_code = C4.Party_code             
                  AND Depository Not In ('Nsdl', 'Cdsl')          
                  AND Defdp = 1            
            )             
      WHERE C1.Cl_code = C2.Cl_code             
            AND C1.Branch_cd Like (            
            CASE             
                  WHEN @Statusid = 'Branch'             
                  THEN @Statusname             
                  ELSE '%'             
            END            
            )             
            AND Sub_broker Like (            
            CASE             
                  WHEN @Statusid = 'Sub_broker'             
                  THEN @Statusname             
                  ELSE '%'             
            END            
            )             
            AND Trader Like (            
            CASE             
                  WHEN @Statusid = 'Trader'             
                  THEN @Statusname             
        ELSE '%'             
            END            
            )             
            AND C1.Family Like (            
            CASE             
                  WHEN @Statusid = 'Family'             
                  THEN @Statusname             
                  ELSE '%'             
            END            
            )             
            AND C2.Party_code Like (            
            CASE             
                  WHEN @Statusid = 'Client'             
                  THEN @Statusname             
                  ELSE '%'             
            END            
            )             
            AND C1.Branch_cd Like @Strbranch +'%'             
            AND C2.Party_code > = @Fcode             
            AND C2.Party_code < = @Tcode             
            
            
      CREATE TABLE [#tmpledger] (            
       [Booktype] [char] (2)  NULL ,            
       [Voudt] [datetime] NULL ,            
       [Effdt] [datetime] NULL ,            
       [Shortdesc] [varchar] (35)  NULL ,            
       [Dramt] [money] NULL ,            
       [Cramt] [money] NULL ,            
       [Vno] [varchar] (12)  NULL ,            
       [Ddno] [varchar] (15)  NULL ,            
       [Narration] [varchar] (234)  NULL ,            
       [Cltcode] [varchar] (10)  NOT NULL ,            
       [Vtyp] [smallint] NULL ,            
       [Vdt] [varchar] (30)  NULL ,            
       [Edt] [varchar] (30)  NULL ,            
       [Acname] [varchar] (100)  NULL ,            
       [Opbal] [money] NULL ,            
       [L_address1] [varchar] (40)  NOT NULL ,            
       [L_address2] [varchar] (40)  NULL ,            
       [L_address3] [varchar] (40)  NULL ,            
       [L_city] [varchar] (40)  NULL ,            
       [L_zip] [varchar] (10)  NULL ,            
       [Res_phone1] [varchar] (15)  NULL ,            
       [Branch_cd] [varchar] (10)  NOT NULL ,            
       [Crosac] [varchar] (10)  NULL ,            
       [Ediff] [int] NULL ,            
       [Family] [varchar] (10)  NOT NULL ,            
       [Sub_broker] [varchar] (10)  NOT NULL ,            
       [Trader] [varchar] (20)  NOT NULL ,      
       [Cl_type] [varchar] (3)  NOT NULL ,            
       [Bank_name] [varchar] (50)  NOT NULL ,            
       [Cltdpid] [varchar] (16)  NOT NULL ,            
       [Lno] [decimal](4, 0) NULL             
      ) ON [PRIMARY]            
            
                  
/*getting Lddger Entries*/                  
      INSERT             
            INTO #tmpledger             
      SELECT             
            L.Booktype,             
            Voudt = L.Vdt,             
            Effdt = L.Edt,             
            L.Shortdesc,             
            Dramt = (            
            CASE             
                  WHEN Upper(L.Drcr) = 'D'             
                  THEN L.Vamt             
                  ELSE 0             
            END        
            ),             
            Cramt = (            
            CASE             
                  WHEN Upper(L.Drcr) = 'C'             
                  THEN L.Vamt             
                  ELSE 0             
            END            
            ),             
            L.Vno,             
            Ddno = Space(15),             
            L.Narration,             
            C.Party_code Cltcode,             
            L.Vtyp,             
            Convert(Varchar, L.Vdt, 103) Vdt,             
            Convert(Varchar, L.Edt, 103) Edt,             
            L.Acname ,             
            Opbal = Vamt,             
            C.L_address1,             
            C.L_address2,             
            C.L_address3,             
            C.L_city,             
            C.L_zip,             
            C.Res_phone1,             
        C.Branch_cd,             
            L.Cltcode Crosac ,             
            Ediff = Datediff(D, L.Edt, Getdate()),             
            C.Family,             
            C.Sub_broker,             
            C.Trader,             
            C.Cl_type,             
            C.Bank_name,             
            C.Cltdpid,             
            L.Lno             
      FROM #ledgerdata L WITH(NoLock)             
      RIGHT OUTER JOIN             
            #ledgerclients C WITH(NoLock)             
            ON             
            (            
                  L.Cltcode = C.Party_code            
            )             
            
            
                  
/*updating Opening Blanace*/                  
      UPDATE             
            #tmpledger             
            SET Opbal = 0             
            
      UPDATE             
            #tmpledger             
            SET Opbal = T.Oppbal             
      FROM #tmpledger L WITH(NoLock),             
            #oppbalance T WITH(NoLock)             
      WHERE L.Cltcode = T.Cltcode             
                  
            
            
/*updating Cheque Number*/                  
      UPDATE             
            #tmpledger             
            SET Ddno = L1.Ddno             
      FROM Ledger1 L1 WITH(NoLock)             
      WHERE L1.Vno = #tmpledger.Vno             
            AND L1.Vtyp = #tmpledger.Vtyp             
            AND L1.Booktype = #tmpledger.Booktype             
            AND L1.Lno = #tmpledger.Lno             
                  
            
            
/*updating Cross Account Code*/                  
      UPDATE        
            #tmpledger             
            SET #tmpledger.Crosac = B.Cltcode             
      FROM Ledger B WITH(NoLock),             
            Acmast V WITH(NoLock)             
      WHERE B.Cltcode = V.Cltcode             
            AND V.Accat = 2             
            AND #tmpledger.Booktype = B.Booktype             
            AND #tmpledger.Vno = B.Vno             
            AND #tmpledger.Vtyp = B.Vtyp             
            AND Ltrim(Rtrim(#tmpledger.Vtyp)) In ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')             
                  
            
            
/*updating Bank Name*/                                 
      UPDATE             
            #tmpledger             
            SET #tmpledger.Bank_name = B.Bank_name             
      FROM Pobank B WITH(NoLock)             
      WHERE Ltrim(Rtrim(Cast(B.Bankid AS Char))) = Ltrim(Rtrim(#tmpledger.Bank_name))             
            
                  
      If @Strorder = 'Accode'                  
      Begin                  
            If @Selectby = 'Vdt'                  
            Begin                   
                  SELECT             
                        L.*             
                  FROM #tmpledger L WITH(NoLock),             
                        Acmast A WITH(NoLock)             
                  WHERE L.Cltcode = A.Cltcode             
                        AND Accat In ('4', '104') AND (Dramt <> 0 OR Cramt <> 0 or opbal <> 0)            
                  ORDER BY L.Cltcode,             
                        Voudt             
            End                  
            Else                  
            Begin                  
                  SELECT             
                        L.*             
                  FROM #tmpledger L WITH(NoLock),             
                        Acmast A WITH(NoLock)             
                  WHERE L.Cltcode = A.Cltcode             
                        AND Accat In ('4', '104') AND (Dramt <> 0 OR Cramt <> 0 or opbal <> 0)            
                  ORDER BY L.Cltcode,             
                        Effdt             
            End                  
      End                  
      Else                  
      Begin                  
            If @Selectby = 'Vdt'                  
            Begin                   
                  SELECT             
                        L.*             
                  FROM #tmpledger L WITH(NoLock),             
                        Acmast A WITH(NoLock)             
                  WHERE L.Cltcode = A.Cltcode             
                        AND Accat In ('4', '104') AND (Dramt <> 0 OR Cramt <> 0 or opbal <> 0)            
                  ORDER BY L.Acname,             
                        Voudt             
            End                  
            Else                  
            Begin                  
                  SELECT             
                        L.*         
                  FROM #tmpledger L WITH(NoLock),             
                        Acmast A WITH(NoLock)             
                  WHERE L.Cltcode = A.Cltcode             
                        AND Accat In ('4', '104') AND (Dramt <> 0 OR Cramt <> 0 or opbal <> 0)            
                  ORDER BY L.Acname,             
                        Effdt             
            End                  
      End                  
                  
/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_ACC_TRIALBALANCE]    

	@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */    
	@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */    
	@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */    
	@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */    
	@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */    
	@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */    
	@OPENENTRYFLAG INT,    
	@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */    
	@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */    
	@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */    
	@SORTBYDATE VARCHAR(3),          /* WHETHER REPORT IS BASED ON VDT OR EDT */    
	@BULK VARCHAR(1) = 'N',
	@FNAME VARCHAR(200) = ''

/*
	Exec rpt_Acc_TrialBalance 'Mar 31 2007', 'codewise', 'all', 'withopbal', 'Apr  1 2006', 'Apr  1 2006', 0,'Apr  1 2006', 'BROKER', '%', 'vdt', 'Y', 'D:\TEST.TXT'
*/
    
AS    

DECLARE  
	@@COSTCODE AS VARCHAR(3),
	@@TEMPTABLE AS VARCHAR(100),
	@@SQL AS VARCHAR(2000),
	@@ERRORCNT AS INT

    
SELECT * INTO 	#ACMAST FROM ACMAST WHERE 1 = 2    
  
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2    
  
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2    

IF UPPER(@STATUSID) = 'BROKER'    
	BEGIN
		IF @BALANCE='NORMAL'    
			IF @SORTBYDATE = 'VDT'    
				BEGIN       
					INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,  
					AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)    
					FROM LEDGER L WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'      
					GROUP BY L.CLTCODE    
				END    
			ELSE   
				BEGIN    
					INSERT INTO #TEMPLEDGER    
					SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0     
					FROM      
					(       
					SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)  
					FROM LEDGER L WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18      
					GROUP BY L.CLTCODE      
					
					UNION ALL      
					
					SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)   
					FROM LEDGER  L  WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18      
					GROUP BY L.CLTCODE
					
					UNION ALL      
					
					SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)  
					FROM LEDGER L  WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00'    
					AND EDT < @CURRYRSTDATE      
					GROUP BY L.CLTCODE       
					) T      
					GROUP BY CLTCODE       
				END    
		ELSE  
			IF @SORTBYDATE = 'VDT'    
				BEGIN    
					IF @STDATE = @CURRYRSTDATE
						BEGIN
							INSERT INTO #TEMPLEDGER    
							SELECT L.CLTCODE ,    
							DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
							CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
							OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = '18') THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
							FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'     
							GROUP BY L.CLTCODE    
						END
					ELSE
						BEGIN
							INSERT INTO #TEMPLEDGER    
							SELECT L.CLTCODE ,    
							DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
							CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
							OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
							FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'     
							GROUP BY L.CLTCODE    
						END
				END    
			ELSE    
				BEGIN    
					IF @STDATE = @CURRYRSTDATE
						BEGIN
							INSERT INTO #TEMPLEDGER    
							SELECT L.CLTCODE ,    
							DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
							CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
							OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = '18') THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
							FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'     
							GROUP BY L.CLTCODE    
						END
					ELSE
						BEGIN
							INSERT INTO #TEMPLEDGER    
							SELECT L.CLTCODE ,    
							DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
							CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
							OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
							FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'     
							GROUP BY L.CLTCODE    
						END
				END     
  
		IF  @VIEWOPTION = 'PARTYWISE'     
			BEGIN    
				INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
				FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)  
			END    
		ELSE    
			IF @VIEWOPTION = 'GL'    
				BEGIN    
					INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
					FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)  
				END    
			ELSE    
				BEGIN    
					INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
					FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)  
				END   
		  
		IF @VIEWOPTION = 'GL'    
			BEGIN  
				INSERT INTO #TEMPLEDGERFINAL  
				SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4   
			END  
	END 
/*  -- FOR BRANCH SELECTION --  */  
IF UPPER(@STATUSID) = 'BRANCH'    
	BEGIN
		SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )  
			IF @BALANCE='NORMAL'    
				IF @SORTBYDATE = 'VDT'    
					BEGIN       
						INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,  
						AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)    
						FROM LEDGER L, LEDGER2 L2 WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'      
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L.CLTCODE    
					END    
				ELSE   
					BEGIN    
						INSERT INTO #TEMPLEDGER    
						SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0     
						FROM      
						(       
						SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)  
						FROM LEDGER L, LEDGER2 L2 WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18      
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L.CLTCODE      

						UNION ALL      

						SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)   
						FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18      
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L.CLTCODE       

						UNION ALL      

						SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)  
						FROM LEDGER L, LEDGER2 L2 WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00' AND EDT < @CURRYRSTDATE
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L.CLTCODE       
						) T      
						GROUP BY CLTCODE       
					END    
			ELSE  
				IF @SORTBYDATE = 'VDT'    
					BEGIN    
						INSERT INTO #TEMPLEDGER    
						SELECT L2.CLTCODE ,    
						DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
						CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
						OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
						FROM LEDGER L, LEDGER2 L2 WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L2.CLTCODE    
					END    
				ELSE    
					BEGIN    
						INSERT INTO #TEMPLEDGER    
						SELECT L2.CLTCODE ,    
						DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
						CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
						OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
						FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'     
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L2.CLTCODE    
					END     

		IF  @VIEWOPTION = 'PARTYWISE'     
			BEGIN    
				INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
				FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)  
			END    
		ELSE    
			IF @VIEWOPTION = 'GL'    
				BEGIN    
					INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
					FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)  
				END    
			ELSE    
				BEGIN    
					INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
					FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)  
				END   
  
		IF @VIEWOPTION = 'GL'    
			BEGIN  
				INSERT INTO #TEMPLEDGERFINAL  
				SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4   
			END  
	END 
/* ---------------------------- */  

IF @BULK = 'N'
	BEGIN
		IF @FLAG = 'CODEWISE'    
			BEGIN  
				SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE  
			END  
		ELSE  
			BEGIN  
				SELECT * FROM #TEMPLEDGERFINAL  ORDER BY  ACNAME,CLTCODE, BRANCHCODE  
			END  
	END
ELSE IF @BULK = 'Y'
	BEGIN
		IF @FNAME <> ''
			BEGIN
				INSERT INTO TEMP_TRIALBALANCE_BULK (CLTCODE, DRTOT, CRTOT, AMOUNT, ACNAME, BRANCHCODE, ACCAT, PROCID)
				SELECT CLTCODE,DRTOT,CRTOT, AMOUNT, ACNAME, BRANCHCODE, ACCAT, PROCID = @@SPID FROM #TEMPLEDGERFINAL
/*				CREATE TABLE ERROR_TBL
					(
						ERR_ID INT
					)*/
				IF @FLAG = 'CODEWISE'
					BEGIN
						SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'DEL " + @FNAME + "', no_output"
						EXEC (@@SQL)
						SELECT @@SQL = "INSERT INTO ERROR_TBL EXEC MASTER.DBO.XP_CMDSHELL 'BCP " + CHAR(34) + "SELECT * FROM TEMP_TRIALBALANCE_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " ORDER BY CLTCODE, ACNAME, BRANCHCODE" + CHAR(34) + " queryout " + CHAR(34) + @FNAME + CHAR(34) + " -c -q -t " + CHAR(34) + "," + CHAR(34) + " -U " + CHAR(34) + "SA" + CHAR(34) + " -P " + CHAR(34) + "M0" + CHAR(34) + "', no_output "
					END
				ELSE
					BEGIN
						SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'DEL " + @FNAME + "', no_output"
						EXEC (@@SQL)
						SELECT @@SQL = "INSERT INTO ERROR_TBL EXEC MASTER.DBO.XP_CMDSHELL 'BCP " + CHAR(34) + "SELECT * FROM TEMP_TRIALBALANCE_BULK WHERE PROCID = "  + CONVERT(VARCHAR, @@SPID) + " ORDER BY CLTCODE, ACNAME, BRANCHCODE" + CHAR(34) + " queryout " + CHAR(34) + @FNAME + CHAR(34) + " -c -q -t " + CHAR(34) + "," + CHAR(34) + " -U " + CHAR(34) + "SA" + CHAR(34) + " -P " + CHAR(34) + "M0" + CHAR(34) + "', no_output "
					END
				SELECT @@SQL
				RETURN
				EXEC (@@SQL)
/*				IF @@ERRORCNT <> 0
					BEGIN
						SELECT 'SOME ERROR OCCURED WHILE EXPORTING FILE'
					END*/
			END
		ELSE
			BEGIN
				SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE  
			END
	END
ELSE	
	BEGIN
		SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE  
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE_1
-- --------------------------------------------------
--Exec rpt_Acc_TrialBalance 'Mar 31 2007', 'codewise','partywise','withopbal','Apr  1 2006', 'Apr  1 2006', 0,'Apr  1 2006', 'BROKER', '%', 'vdt'

CREATE PROCEDURE [dbo].[RPT_ACC_TRIALBALANCE_1]
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */      
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */      
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */      
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */      
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */      
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */      
@OPENENTRYFLAG INT,      
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */      
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */      
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */      
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */      
      
AS      
  
DECLARE    
@@COSTCODE AS VARCHAR(3)  
  
      
SELECT * INTO  #ACMAST FROM ACMAST WHERE 1 = 2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2      
    
    
IF UPPER(@STATUSID) = 'BROKER'      
BEGIN  
  IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
         GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER  L  WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
         GROUP BY L.CLTCODE  
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L  WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00'      
         AND EDT < @CURRYRSTDATE        
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
	IF @STDATE = @CURRYRSTDATE
	BEGIN
	        INSERT INTO #TEMPLEDGER      
	        SELECT L.CLTCODE ,      
	        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = 18) THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
	        FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'       
	        GROUP BY L.CLTCODE      
	END
	ELSE
	BEGIN
	        INSERT INTO #TEMPLEDGER      
	        SELECT L.CLTCODE ,      
	        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
	        FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'       
	        GROUP BY L.CLTCODE      
	END
       END      
      ELSE      
       BEGIN      
	IF @STDATE = @CURRYRSTDATE
	BEGIN
	        INSERT INTO #TEMPLEDGER      
	        SELECT L.CLTCODE ,      
	        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = 18) THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
	        FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
	        GROUP BY L.CLTCODE      
	END
	ELSE
	BEGIN
	        INSERT INTO #TEMPLEDGER      
	        SELECT L.CLTCODE ,      
	        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
	        FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
	        GROUP BY L.CLTCODE      
	END
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
   
  
/*  -- FOR BRANCH SELECTION --  */    
IF UPPER(@STATUSID) = 'BRANCH'      
BEGIN  
 SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )    
 IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L, LEDGER2 L2 WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
   AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
   AND COSTCODE = @@COSTCODE  
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
      AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
     GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
         GROUP BY L.CLTCODE         
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00' AND EDT < @CURRYRSTDATE  
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'  
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  
        GROUP BY L2.CLTCODE      
       END      
     ELSE      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  
        GROUP BY L2.CLTCODE      
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
/* ---------------------------- */    
  
  
IF @FLAG = 'CODEWISE'      
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE    
 END    
ELSE    
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL  ORDER BY  ACNAME,CLTCODE, BRANCHCODE    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accallpartyledvoucherdisp
-- --------------------------------------------------
CREATE Procedure [dbo].[Rpt_accallpartyledvoucherdisp]        
@Vtyp Smallint ,        
@Vno Varchar (12),        
@Vdt Varchar(12) ,        
@Booktype Varchar(2),        
@Branch Varchar(10),        
@Cltcode Varchar(10)        
        
As        
If @Branch = 'Full' Or @Branch = '' Or @Branch = '%'        
Begin        
 Select distinct Vamt , L.Vtyp , L.Vno , L.Vdt , L.Drcr , Cltcode, Acname,  L.Lno , Drcrflag = (Case When Upper(L.Drcr) = 'D' Then 'Dr' Else 'Cr' End) ,         
 Nar = Narration, Bank = Isnull(Bnkname, ''), Branch = Isnull(Brnname, '') , Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno,         
 Dddt  =  Convert(Varchar, Dddt, 103)          
 From Ledger L Left Outer Join Ledger1 L1 On L1.Vtyp = L.Vtyp And L1.Booktype = L.Booktype And L1.Vno = L.Vno     
--and L.Lno = L1.Lno        
 Where L.Vtyp = @Vtyp        
 And L.Vno = @Vno          
 And L.Vdt Like  Ltrim(Vdt) + '%'        
 And L.Booktype = @Booktype --and L.Cltcode = @Cltcode        
 Order By L.Drcr Desc , L.Lno         
End        
Else        
Begin        
 Select distinct Vamt = L2.Camt , L.Vtyp , L2.Vno , Vdt , L2.Drcr , L2.Cltcode, A.Acname, L2.Lno ,         
 Drcrflag = (Case When Upper(L2.Drcr) = 'D' Then 'Dr' Else 'Cr' End),         
 Nar = Narration, Bank = Isnull(Bnkname, ''), Branch = Isnull(Brnname, '') , Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno,         
 Dddt  =  Convert(Varchar, Dddt, 103)          
 From Ledger L Left Outer Join Ledger1 L1 On L1.Vtyp = L.Vtyp And L1.Booktype = L.Booktype And L1.Vno = L.Vno,     
--and L.Lno = L1.Lno,        
 Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode        
 Where L.Vtyp = @Vtyp        
 And L.Vno = @Vno          
 And L.Vdt Like  Ltrim(Vdt) + '%'        
 And L.Booktype = @Booktype --and L.Cltcode = @Cltcode        
 And L.Vtyp = L2.Vtype And L.Booktype = L2.Booktype And L.Vno = L2.Vno And L.Lno = L2.Lno        
        And Costcode = (Select Costcode From Costmast Where Costname = Rtrim(@Branch))        
 Order By L2.Drcr Desc , L2.Lno         
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_accallpartyMarginledvoucherdisp
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_accallpartyMarginledvoucherdisp    Script Date: 12/27/2005 12:19:25 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 04/15/2004 11:47:30 AM ******/    
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 06/11/2004 14:22:56 ******/    
    
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 12/16/2003 12:59:37 PM ******/    
    
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 02/28/2003 2:39:05 PM ******/    
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 01/19/2002 12:15:11 ******/    
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 01/04/1980 5:06:24 AM ******/    
/* report : Allpartyledger     
    filename :  voucherdisp.asp    
*/    
/* displays details of a voucher for a party for a date */    
      
CREATE  Procedure [dbo].[rpt_accallpartyMarginledvoucherdisp]    
@vtyp smallint ,    
@vno varchar (12),    
@vdt varchar(12) ,    
@booktype varchar(2),    
@branch varchar(10),    
@cltcode varchar(10)    
    
as    
if @branch = 'full' or @branch= '' or @branch = '%'    
begin    
 select vamt=amount ,l.vtyp , l.vno , l.vdt , l.drcr , cltcode=party_code,a.acname,  l.lno ,drcrflag = (case when upper(l.drcr)='D' then 'Dr' else 'Cr' end) ,     
 nar=narration, bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno,     
 dddt  =  convert(varchar,dddt,103)  
 from marginledger m, acmast a, ledger l left outer join ledger1 l1
 on l1.vtyp = l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno and l.lno = l1.lno
 where   
 l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno and m.lno = l.lno  
 and m.mcltcode=a.cltcode   
 and l.vtyp=@vtyp    
 and l.vno= @vno      
 and l.vdt like  ltrim(m.vdt) + '%'    
 and l.BookType = @booktype and m.party_code = @cltcode    
 order by l.drcr desc , l.lno   
end    
else    
begin    
/*  
 select  vamt=l2.camt ,l.vtyp , l2.vno , vdt , l2.drcr , l2.cltcode, a.acname, l2.lno ,     
 drcrflag = (case when upper(l2.drcr)='D' then 'Dr' else 'Cr' end),     
 nar=narration, bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno,     
 dddt  =  convert(varchar,dddt,103)      
 from ledger l left outer join ledger1 l1 on l1.vtyp = l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno and l.lno = l1.lno,    
 ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode    
 where l.vtyp=@vtyp    
 and l.vno= @vno      
 and l.vdt like  ltrim(vdt) + '%'    
 and l.BookType = @booktype and l.cltcode = @cltcode    
 and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno    
 and costcode = (select costcode from costmast where costname = rtrim(@branch))    
 order by l2.drcr desc , l2.lno     
*/  
  
select  vamt=m.amount ,l.vtyp , l2.vno , m.vdt , l2.drcr , cltcode=m.party_code, a.acname, l2.lno ,     
drcrflag = (case when upper(l2.drcr)='D' then 'Dr' else 'Cr' end),     
nar=narration, bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno,     
dddt  =  convert(varchar,dddt,103)      
from marginledger m,     
ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode,
ledger l left outer join ledger1 l1
on l1.vtyp = l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno and l.lno = l1.lno    
where m.mcltcode=a.cltcode  
and m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and l.lno = m.lno  
and l.vno= @vno      
and l.vdt like  ltrim(m.vdt) + '%'    
and l.BookType = @booktype  
and m.party_code = @cltcode   
and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno    
and costcode = (select costcode from costmast where costname = rtrim(@branch))    
order by l2.drcr desc , l2.lno     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_accchkpathsegbalsign
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 05/10/2004 5:11:16 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 01/11/2003 3:46:55 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 01/04/1980 1:40:39 AM ******/  
  
  
  
/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 11/28/2001 12:23:46 PM ******/  
  
create procedure [dbo].[rpt_accchkpathsegbalsign]  
@sharedb varchar(15)  
as  
select conpath ,segment ,balsign from owner   
where sharedb = @sharedb

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acccompanyname
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_acccompanyname    Script Date: 06/24/2004 8:32:37 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_acccompanyname    Script Date: 05/10/2004 5:29:41 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.rpt_acccompanyname    Script Date: 01/14/2002 20:39:18 ******/  
  
/****** Object:  Stored Procedure dbo.rpt_acccompanyname    Script Date: 01/04/1980 1:40:39 AM ******/  
  
  
  
/****** Object:  Stored Procedure dbo.rpt_acccompanyname    Script Date: 11/28/2001 12:23:46 PM ******/  
  
CREATE proc [dbo].[rpt_acccompanyname]  
@sharedb varchar(15)  
as  
select companyname from multicompany where sharedb = @sharedb

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_AccodeList
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_AccodeList    Script Date: 12/16/2003 12:59:37 PM ******/


/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient    Script Date: 04/13/2003 12:09:05 PM ******/
---------------------------------------------------------------------------------------------------------
--		PROC TO LIST CLIENTS ACC TO LOGIN FOR THE DB - ACCOUNT
---------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [dbo].[rpt_AccodeList]
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@WHATTOLOOKFOR VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
	@WHICHWAY VARCHAR(1),		--	> OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
	@COMPARETOWHAT VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
	@ACCAT varchar(3),		--	Account Category
	@LOOKFORNAME VARCHAR(25)	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
AS

DECLARE
@strSQL VarChar(2500),
@@Inaccat varchar(3)

select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))

--SET DEFAULT VALUES
SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */

--BROKER LOGIN
If  @STATUSID="BROKER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT cltcode, acname, branchcode "
	Set @strSQL = @strSQL + "FROM acmast "
	Set @strSQL = @strSQL + "WHERE "
        if len(rtrim(@WHATTOLOOKFOR)) <> 0 and len(rtrim(@LOOKFORNAME)) <> 0 
           begin
	  	Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' and acname LIKE '" + @LOOKFORNAME + "%') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
	   end
        else
           if len(rtrim(@LOOKFORNAME)) <> 0 
               begin
                  Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' or acname LIKE '" + @LOOKFORNAME + "%') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
               end
           else
               begin
                  Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' or acname LIKE '" + @WHATTOLOOKFOR + "') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
               end
        if rtrim(@accat) = '3'
           begin
		select @strSQL = @strSQL + " or accat in ( '14','18','114','118'))" 
           end
        else
           begin
		select @strSQL = @strSQL + " )" 
           end

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS	
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + " AND "
		Set @strSQL = @strSQL + " cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + " AND "
			Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End

	Set @strSQL = @strSQL + "ORDER BY cltcode, branchcode "
End

--BRANCH LOGIN
IF @STATUSID="BRANCH"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	acname, "
	Set @strSQL = @strSQL + "	branchcode "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' AND "
	Set @strSQL = @strSQL + "	(branchcode LIKE '" + @STATUSNAME + "' OR branchcode = 'ALL') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
        if rtrim(@accat) = '3'
           begin
		select @strSQL = @strSQL + " or accat in ( '14','18','114','118'))" 
           end
        else
           begin
		select @strSQL = @strSQL + " )" 
           end

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	branchcode "
End

--SUB-BROKER LOGIN
IF @STATUSID="SUBBROKER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.sub_broker "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	client1 c1, "
	Set @strSQL = @strSQL + "	client2 c2, "
	Set @strSQL = @strSQL + "	subbrokers s "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.sub_broker = s.sub_broker AND "
	Set @strSQL = @strSQL + "	c1.sub_broker LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.sub_broker "
End

--TRADER LOGIN
If @STATUSID="TRADER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.trader "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	client1 c1, "
	Set @strSQL = @strSQL + "	client2 c2, "
	Set @strSQL = @strSQL + "	branches s "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	/*Set @strSQL = @strSQL + "	c1.trader = s.branch_cd AND "*/
             Set @strSQL = @strSQL + "	c1.Branch_cd = s.branch_cd AND "
	Set @strSQL = @strSQL + "	c1.trader LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.trader "
End

--FAMILY LOGIN
If @STATUSID="FAMILY"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.family "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	client1 c1, "
	Set @strSQL = @strSQL + "	client2 c2 "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.family LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.family "
End

If @STATUSID="CLIENT"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	client1 c1, "
	Set @strSQL = @strSQL + "	client2 c2 "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @STATUSNAME + "' "
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode "
End

	Set @strSQL = @strSQL + "	OPTION  (FAST 10)"

Print @strSQL
Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accvdesc
-- --------------------------------------------------
/*this Procedure Gives Us The Discription For Supplied Vtype*/
Create Procedure 
[dbo].[Rpt_accvdesc] 
@Vtype Smallint
As
Select Vdesc From Vmast Where 
Vtype = @Vtype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ALL_PARTY_SUMMARY_MASTER
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_ALL_PARTY_SUMMARY_MASTER]
/*
EXEC RPT_ALL_PARTY_SUMMARY_MASTER 'APR  1 2006', 'MAR 31 2007', 'APR  1 2006', 'MAR 31 2007', 'BROKER', 'BROKER', 'VDT', '0', 'ZZZ', 'PARTY', 'S', 
'Y', 'ACCOUNT', 'Y', 'ACCOUNTBSE', 'Y', 'ACCOUNTFO', 'Y', 'ACCOUNTNCDX', 'Y', 'ACCOUNTMCDX'

Exec RPT_ALL_PARTY_SUMMARY_MASTER 'Apr 1 2006','May 16 2006','Apr 1 2003','Apr 1 2003','broker','broker','Vdt','0','z','PARTY','S','Y', 'ACCOUNT', 'Y', 'ACCOUNTBSE', 'Y', 'ACCOUNTFO', 'Y', 'ACCOUNTNCDX', 'Y', 'ACCOUNTMCDX' 
*/
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@STDDATE VARCHAR(11),
	@LSTDATE VARCHAR(11),
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(50),
	@DISPRPT VARCHAR(3),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@RPTNAME VARCHAR(20),
	@SUMOPT VARCHAR(1),
	@NSE VARCHAR(1),
	@NSEDATA VARCHAR(30),
	@BSE VARCHAR(1),
	@BSEDATA VARCHAR(30),
	@NSEFO VARCHAR(1),
	@NSEFODATA VARCHAR(30),
	@NCX VARCHAR(1),
	@NCXDATA VARCHAR(30),
	@MCX VARCHAR(1),
	@MCXDATA VARCHAR(30)

AS

DECLARE
	@@SQL AS VARCHAR(2000)

/*
SELECT @@SQL = "CREATE TABLE #ALLPARTYLEDGER "
SELECT @@SQL = @@SQL + "	("
SELECT @@SQL = @@SQL + "		CLTCODE VARCHAR(10),"
SELECT @@SQL = @@SQL + "		ACNAME VARCHAR(100),"
IF @NSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "		NSELEDGER MONEY,"
		SELECT @@SQL = @@SQL + "		NSEMARGIN MONEY,"
		SELECT @@SQL = @@SQL + "		NSEUNREL MONEY,"
		SELECT @@SQL = @@SQL + "		NSETOTAL MONEY,"
	END
IF @BSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "		BSELEDGER MONEY,"
		SELECT @@SQL = @@SQL + "		BSEMARGIN MONEY,"
		SELECT @@SQL = @@SQL + "		BSEUNREL MONEY,"
		SELECT @@SQL = @@SQL + "		BSETOTAL MONEY,"
	END
IF @NSEFO = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "		NSEFOLEDGER MONEY,"
		SELECT @@SQL = @@SQL + "		NSEFOMARGIN MONEY,"
		SELECT @@SQL = @@SQL + "		NSEFOUNREL MONEY,"
		SELECT @@SQL = @@SQL + "		NSEFOTOTAL MONEY,"
	END
IF @MCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "		MCXLEDGER MONEY,"
		SELECT @@SQL = @@SQL + "		MCXMARGIN MONEY,"
		SELECT @@SQL = @@SQL + "		MCXUNREL MONEY,"
		SELECT @@SQL = @@SQL + "		MCXTOTAL MONEY,"
	END
IF @NCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "		NCXLEDGER MONEY,"
		SELECT @@SQL = @@SQL + "		NCXMARGIN MONEY,"
		SELECT @@SQL = @@SQL + "		NCXUNREL MONEY,"
		SELECT @@SQL = @@SQL + "		NCXTOTAL MONEY,"
	END
IF RIGHT(@@SQL, 1) = ','
	BEGIN
		SELECT @@SQL = LEFT(@@SQL, LEN(@@SQL) - 1)
	END
SELECT @@SQL = @@SQL + "	) "
*/

CREATE TABLE #ALLPARTYLEDGER
	(
		CLTCODE VARCHAR(10),
		ACNAME VARCHAR(100),
		NSELEDGER MONEY,
		NSEMARGIN MONEY,
		NSEUNREL MONEY,
		NSETOTAL MONEY,
		BSELEDGER MONEY,
		BSEMARGIN MONEY,
		BSEUNREL MONEY,
		BSETOTAL MONEY,
		NSEFOLEDGER MONEY,
		NSEFOMARGIN MONEY,
		NSEFOUNREL MONEY,
		NSEFOTOTAL MONEY,
		MCXLEDGER MONEY,
		MCXMARGIN MONEY,
		MCXUNREL MONEY,
		MCXTOTAL MONEY,
		NCXLEDGER MONEY,
		NCXMARGIN MONEY,
		NCXUNREL MONEY,
		NCXTOTAL MONEY,
	)

IF @NSE = 'Y'
	BEGIN
		SELECT @@SQL = "INSERT INTO #ALLPARTYLEDGER (CLTCODE, ACNAME, NSELEDGER, NSEMARGIN, NSEUNREL, NSETOTAL) EXEC "
		SELECT @@SQL = @@SQL + @NSEDATA + ".DBO.RPT_MASTER_PARTYLEDGER '" + @FDATE + "', '" + @TDATE + "', '" + @STDDATE + "', "
		SELECT @@SQL = @@SQL + "'" + @LSTDATE + "', '" + @STATUSID + "', '" + @STATUSNAME + "', '" + @DISPRPT + "', '" + @FPARTY + "', "
		SELECT @@SQL = @@SQL + "'" + @TPARTY + "', '" + @RPTNAME + "', '" + @SUMOPT + "'"
		PRINT (@@SQL)
		EXEC (@@SQL)
	END
IF @BSE = 'Y'
	BEGIN
		SELECT @@SQL = "INSERT INTO #ALLPARTYLEDGER (CLTCODE, ACNAME, BSELEDGER, BSEMARGIN, BSEUNREL, BSETOTAL) EXEC "
		SELECT @@SQL = @@SQL + @BSEDATA + ".DBO.RPT_MASTER_PARTYLEDGER '" + @FDATE + "', '" + @TDATE + "', '" + @STDDATE + "', "
		SELECT @@SQL = @@SQL + "'" + @LSTDATE + "', '" + @STATUSID + "', '" + @STATUSNAME + "', '" + @DISPRPT + "', '" + @FPARTY + "', "
		SELECT @@SQL = @@SQL + "'" + @TPARTY + "', '" + @RPTNAME + "', '" + @SUMOPT + "'"
		PRINT (@@SQL)
		EXEC (@@SQL)
	END
IF @NSEFO = 'Y'
	BEGIN
		SELECT @@SQL = "INSERT INTO #ALLPARTYLEDGER (CLTCODE, ACNAME, NSEFOLEDGER, NSEFOMARGIN, NSEFOUNREL, NSEFOTOTAL) EXEC "
		SELECT @@SQL = @@SQL + @NSEFODATA + ".DBO.RPT_MASTER_PARTYLEDGER '" + @FDATE + "', '" + @TDATE + "', '" + @STDDATE + "', "
		SELECT @@SQL = @@SQL + "'" + @LSTDATE + "', '" + @STATUSID + "', '" + @STATUSNAME + "', '" + @DISPRPT + "', '" + @FPARTY + "', "
		SELECT @@SQL = @@SQL + "'" + @TPARTY + "', '" + @RPTNAME + "', '" + @SUMOPT + "'"
		PRINT (@@SQL)
		EXEC (@@SQL)
	END
IF @NCX = 'Y'
	BEGIN
		SELECT @@SQL = "INSERT INTO #ALLPARTYLEDGER (CLTCODE, ACNAME, NCXLEDGER, NCXMARGIN, NCXUNREL, NCXTOTAL) EXEC "
		SELECT @@SQL = @@SQL + @NCXDATA + ".DBO.RPT_MASTER_PARTYLEDGER '" + @FDATE + "', '" + @TDATE + "', '" + @STDDATE + "', "
		SELECT @@SQL = @@SQL + "'" + @LSTDATE + "', '" + @STATUSID + "', '" + @STATUSNAME + "', '" + @DISPRPT + "', '" + @FPARTY + "', "
		SELECT @@SQL = @@SQL + "'" + @TPARTY + "', '" + @RPTNAME + "', '" + @SUMOPT + "'"
		PRINT (@@SQL)
		EXEC (@@SQL)
	END
IF @MCX = 'Y'
	BEGIN
		SELECT @@SQL = "INSERT INTO #ALLPARTYLEDGER (CLTCODE, ACNAME, MCXLEDGER, MCXMARGIN, MCXUNREL, MCXTOTAL) EXEC "
		SELECT @@SQL = @@SQL + @MCXDATA + ".DBO.RPT_MASTER_PARTYLEDGER '" + @FDATE + "', '" + @TDATE + "', '" + @STDDATE + "', "
		SELECT @@SQL = @@SQL + "'" + @LSTDATE + "', '" + @STATUSID + "', '" + @STATUSNAME + "', '" + @DISPRPT + "', '" + @FPARTY + "', "
		SELECT @@SQL = @@SQL + "'" + @TPARTY + "', '" + @RPTNAME + "', '" + @SUMOPT + "'"
		PRINT (@@SQL)
		EXEC (@@SQL)
	END
SELECT @@SQL = "SELECT CLTCODE, ACNAME = MAX(ACNAME), "
IF @NSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "NSELEDGER = SUM(ISNULL(NSELEDGER, 0)), NSEMARGIN = SUM(ISNULL(NSEMARGIN, 0)), NSEUNREL = SUM(ISNULL(NSEUNREL, 0)), NSETOTAL = SUM(ISNULL(NSETOTAL, 0)), "
	END
IF @BSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "BSELEDGER = SUM(ISNULL(BSELEDGER, 0)), BSEMARGIN = SUM(ISNULL(BSEMARGIN, 0)), BSEUNREL = SUM(ISNULL(BSEUNREL, 0)), BSETOTAL = SUM(ISNULL(BSETOTAL, 0)), "
	END
IF @NSEFO = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "NSEFOLEDGER = SUM(ISNULL(NSEFOLEDGER, 0)), NSEFOMARGIN = SUM(ISNULL(NSEFOMARGIN, 0)), NSEFOUNREL = SUM(ISNULL(NSEFOUNREL, 0)), NSEFOTOTAL = SUM(ISNULL(NSEFOTOTAL, 0)), "
	END
IF @NCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "NCXLEDGER = SUM(ISNULL(NCXLEDGER, 0)), NCXMARGIN = SUM(ISNULL(NCXMARGIN, 0)), NCXUNREL = SUM(ISNULL(NCXUNREL, 0)), NCXTOTAL = SUM(ISNULL(NCXTOTAL, 0)), "
	END
IF @MCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "MCXLEDGER = SUM(ISNULL(MCXLEDGER, 0)), MCXMARGIN = SUM(ISNULL(MCXMARGIN, 0)), MCXUNREL = SUM(ISNULL(MCXUNREL, 0)), MCXTOTAL = SUM(ISNULL(MCXTOTAL, 0)), "
	END

SELECT @@SQL = LTRIM(RTRIM(@@SQL))

IF RIGHT(@@SQL, 1) = ','
	BEGIN
		SELECT @@SQL = LEFT(@@SQL, LEN(@@SQL) - 1) + ' '
	END

SELECT @@SQL = @@SQL + "FROM #ALLPARTYLEDGER GROUP BY CLTCODE "
SELECT @@SQL = @@SQL + "COMPUTE "
IF @NSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "SUM(SUM(ISNULL(NSELEDGER, 0))), SUM(SUM(ISNULL(NSEMARGIN, 0))), SUM(SUM(ISNULL(NSEUNREL, 0))), SUM(SUM(ISNULL(NSETOTAL, 0))), "
	END
IF @BSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "SUM(SUM(ISNULL(BSELEDGER, 0))), SUM(SUM(ISNULL(BSEMARGIN, 0))), SUM(SUM(ISNULL(BSEUNREL, 0))), SUM(SUM(ISNULL(BSETOTAL, 0))), "
	END
IF @NSEFO = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "SUM(SUM(ISNULL(NSEFOLEDGER, 0))), SUM(SUM(ISNULL(NSEFOMARGIN, 0))), SUM(SUM(ISNULL(NSEFOUNREL, 0))), SUM(SUM(ISNULL(NSEFOTOTAL, 0))), "
	END
IF @NCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "SUM(SUM(ISNULL(NCXLEDGER, 0))), SUM(SUM(ISNULL(NCXMARGIN, 0))), SUM(SUM(ISNULL(NCXUNREL, 0))), SUM(SUM(ISNULL(NCXTOTAL, 0))), "
	END
IF @MCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "SUM(SUM(ISNULL(MCXLEDGER, 0))), SUM(SUM(ISNULL(MCXMARGIN, 0))), SUM(SUM(ISNULL(MCXUNREL, 0))), SUM(SUM(ISNULL(MCXTOTAL, 0))), "
	END

SELECT @@SQL = LTRIM(RTRIM(@@SQL))

IF RIGHT(@@SQL, 1) = ','
	BEGIN
		SELECT @@SQL = LEFT(@@SQL, LEN(@@SQL) - 1) + ' '
	END


PRINT (@@SQL)
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CONPATH
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_CONPATH    SCRIPT DATE: 01/15/2005 1:33:40 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_CONPATH    SCRIPT DATE: 12/16/2003 2:31:48 PM ******/



/****** OBJECT:  STORED PROCEDURE DBO.RPT_CONPATH    SCRIPT DATE: 05/08/2002 12:35:11 PM ******/




/*REPORT :  ALLPARTY LEDGER 
    FILE : ALLPARTY.ASP
    FILE : LEDGERVIEW.ASP
*/

/* SELECTS CONPATH FROM OWNER FOR A EXCHANGE AND SEGMENT */

CREATE PROCEDURE [dbo].[RPT_CONPATH]

@EXCH VARCHAR(3),
@SEGMENT VARCHAR(20),
@NARRATION VARCHAR(25),
@VTYPE INT,
@SETTTYPE VARCHAR(3) = ''

AS

	SELECT 
		REPORTURL 
	FROM 
		PLDETAIL 
	WHERE 
		EXCHANGE=@EXCH 
		AND SEGMENT LIKE LTRIM(@SEGMENT)+'%'
		AND NARRATION = @NARRATION
		AND ISNULL(SETTTYPE, '') = @SETTTYPE
		AND VTYPE = @VTYPE
		AND FLAG = 'Y'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_conpath_bankbook
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.rpt_conpath_bankbook    Script Date: 01/15/2005 1:33:40 Pm ******/  
  
/****** Object:  Stored Procedure Dbo.rpt_conpath_bankbook    Script Date: 12/16/2003 2:31:48 Pm ******/  
  
  
  
/****** Object:  Stored Procedure Dbo.rpt_conpath_bankbook    Script Date: 05/08/2002 12:35:11 Pm ******/  
  
  
  
  
/*report :  Allparty Ledger   
    File : Allparty.asp  
    File : Ledgerview.asp  
*/  
  
/* Selects Conpath From Owner For A Exchange And Segment */  
  
Create Procedure [dbo].[rpt_conpath_bankbook]  
  
@exch Varchar(3),  
@segment Varchar(20)  
  
As  
  
Select Conpath From owner Where Exchange=@exch And Segment Like Ltrim(@segment)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CURRENTOPENTRY
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_CURRENTOPENTRY]
                @sdtcur DATETIME,
                @ldtcur DATETIME
AS

  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  SELECT ISNULL(LEFT(CONVERT(VARCHAR,SDTCUR,109),11),'')
  FROM   PARAMETER WITH(NOLOCK)
  WHERE  @sdtcur >= SDTCUR
         AND @ldtcur + ' 23:59:59' <= LDTCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_family
-- --------------------------------------------------
/* Familywise Ledger */
/* Finds Families From Client1 */
Create Procedure [dbo].[Rpt_family]
@Statusid Varchar(15), 
@Statusname  Varchar(25)
As
If @Statusid = 'Broker'
Begin
 Select Distinct Family From Client1
 Order By Family
End
If @Statusid = 'Family'
Begin
 Select Distinct Family From Client1
 Where Family = @Statusname
 Order By Family
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_finyearlist
-- --------------------------------------------------
Create Procedure  [dbo].[Rpt_finyearlist]  
As  
Select Distinct  Smonth = Datename(Month, Sdtcur), Syear = Datename(Year, Sdtcur), Emonth = Datename(Month, Ldtcur),   
 Lyear = Datename(Year, Ldtcur) , Sdt = Convert(Varchar, Sdtcur, 103),   
Ldt = Convert(Varchar, Ldtcur, 103), Curyear From Parameter  
Order By Curyear Desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_lastopentry
-- --------------------------------------------------
/*
This Query Is Used If Opening Entry For Current Yr Is Not Found
This Query Gives Us The Latest Opeing Entry Date
*/
Create Procedure [dbo].[Rpt_lastopentry]
@Sdtcur Datetime
As
Select   Isnull(Left((Convert(Varchar, Max(Vdt), 109)), 11), '') From Ledger Where Vtyp = '18' And
Vdt < @Sdtcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MASTER_PARTYLEDGER
-- --------------------------------------------------
--Exec RPT_MASTER_PARTYLEDGER 'Jun  9 2007','Sep 17 2007','Apr  1 2007','Mar 31 2008','broker','broker','Vdt','0000','zzzzz','PARTY','S','Y'


--Exec RPT_MASTER_PARTYLEDGER 'Dec  1 2005','Dec 14 2005','Apr  1 2005','Apr  1 2005','broker','broker','Edt','c','b','BRANCH','S'    
/*       
THIS PROCEDURE IS A MASTER PROCEDURE WHICH INTERNALLY CALL THE DIFFERENT PROCEDURES ON BASIS OF FOLLOWING PARAMETERS      
@STATUSID       
@REPORTNAME      
@SUMMARYOPT       
IT TAKES A PROCEDURE NAME FROM TBL_MASTER_PARTYLEDGER TABLE AND EXECUTE WITH THE PARAMETERS PASSED IN MASTER PROCEDURE.      
CREATED BY := NIKHIL NAVARE      
CREATED DATE := DECEMBER 12 2005      
DATABASE  := ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX      
SYNTAX AS FOLLOWS -----      
EXEC RPT_MASTER_PARTYLEDGER 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'ABC', 'ZZZ', 'BRANCH', 'S'      
*/      
      
CREATE PROC [dbo].[RPT_MASTER_PARTYLEDGER]      
 @FDATE VARCHAR(11),      
 @TDATE VARCHAR(11),      
 @STDDATE VARCHAR(11),      
 @LSTDATE VARCHAR(11),      
 @STATUSID VARCHAR(20),      
 @STATUSNAME VARCHAR(20),      
 @DISPLAYRPT VARCHAR(3),      
 @FPARTY VARCHAR(10),      
 @TPARTY VARCHAR(10),      
 @REPORTNAME varchar(15),      
 @SUMMARYOPT CHAR(1),
 @SHOWZERO VARCHAR(1) = 'N'
      
AS      
      
DECLARE      
@@CALLINGSP VARCHAR(100),      
@@SELECTQUERY VARCHAR(1000)      
      
      
 SELECT       
  @@CALLINGSP = CALLINGSP       
 FROM       
  TBL_MASTER_PARTYLEDGER      
 WHERE      
  REPORTNAME = @REPORTNAME      
  AND STATUSID = @STATUSID      
  AND SUMMARYOPT = @SUMMARYOPT      
    
      
SET @@SELECTQUERY = @@CALLINGSP + ' ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' +  @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY  + ''',''' + @REPORTNAME + ''''  
print (@@SELECTQUERY)


    

EXEC (@@SELECTQUERY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MASTER_PARTYLEDGER_new
-- --------------------------------------------------
--Exec RPT_MASTER_PARTYLEDGER 'Dec  1 2005','Dec 14 2005','Apr  1 2005','Apr  1 2005','broker','broker','Edt','c','b','BRANCH','S'    
/*       
THIS PROCEDURE IS A MASTER PROCEDURE WHICH INTERNALLY CALL THE DIFFERENT PROCEDURES ON BASIS OF FOLLOWING PARAMETERS      
@STATUSID       
@REPORTNAME      
@SUMMARYOPT       
IT TAKES A PROCEDURE NAME FROM TBL_MASTER_PARTYLEDGER TABLE AND EXECUTE WITH THE PARAMETERS PASSED IN MASTER PROCEDURE.      
CREATED BY := NIKHIL NAVARE      
CREATED DATE := DECEMBER 12 2005      
DATABASE  := ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX      
SYNTAX AS FOLLOWS -----      
EXEC RPT_MASTER_PARTYLEDGER 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'ABC', 'ZZZ', 'BRANCH', 'S'      
*/      
      
CREATE  PROC [dbo].[RPT_MASTER_PARTYLEDGER_new]      
 @FDATE VARCHAR(11),      
 @TDATE VARCHAR(11),      
 @STDDATE VARCHAR(11),      
 @LSTDATE VARCHAR(11),      
 @STATUSID VARCHAR(20),      
 @STATUSNAME VARCHAR(20),      
 @DISPLAYRPT VARCHAR(3),      
 @FPARTY VARCHAR(10),      
 @TPARTY VARCHAR(10),      
 @REPORTNAME varchar(15),      
 @SUMMARYOPT CHAR(1),
 @SHOWZERO VARCHAR(1) = 'N',
	@nseflg varchar(1)  ,    
	@bseflg varchar(1)  ,    
	@nfoflg varchar(1)    
      
AS      
      
DECLARE      
@@CALLINGSP VARCHAR(100),      
@@SELECTQUERY VARCHAR(1000)      
      
      
 SELECT       
  @@CALLINGSP = CALLINGSP       
 FROM       
  TBL_MASTER_PARTYLEDGER_NEW      
 WHERE      
  REPORTNAME = @REPORTNAME      
  AND STATUSID = @STATUSID      
  AND SUMMARYOPT = @SUMMARYOPT      
    
      
SET @@SELECTQUERY = @@CALLINGSP + ' ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' +  @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY  + ''',''' + @REPORTNAME + ''''  
    

EXEC (@@SELECTQUERY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_BRANCH_SUMMARY_V3
-- --------------------------------------------------
/*	*****************************************************************************************************
	THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH
	IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.
	THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.
	CREATED BY	:=	YATIN DESAI
	CREATED DATE	:=	DECEMBER 02 2005
	MODIFIED DATE	:=	DECEMBER 16 2005
	DATABASE		:=	ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX
	SYNTAX AS FOLLOWS -----
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'FAMILY'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'REGION', 'AHM', 'VDT', 'APS', 'ZPS'
	*****************************************************************************************************
*/
CREATE PROC [dbo].[RPT_PARTYLEDGER_BRANCH_SUMMARY_V3]
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@STDDATE VARCHAR(11),
	@LSTDATE VARCHAR(11),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(20),
	@DISPLAYRPT VARCHAR(3),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@REPORTNAME VARCHAR(100)

AS

DECLARE
@@SQL AS VARCHAR(2000),
@@RECCOUNTER AS NUMERIC,
@@SHAREDB AS VARCHAR(25),
@@OBJID AS INT
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER'), 0)
IF @@OBJID = 0
	BEGIN
		EXEC CREATEPARTYLEDGER
	END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID

SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER

IF @REPORTNAME = 'BRANCH'
	BEGIN
		IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'
			BEGIN
				--INSERT LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'BROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
					END
				ELSE IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"
					END
				EXEC (@@SQL)
		
				--INSERT MARGINLEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'BROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
					END
				ELSE IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"
					END
				PRINT @@SQL
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH, SUM(VAMT) AS LEDGERAMOUNT, SUM(MAMT) AS MARGINAMOUNT"
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + ", SUM(UNREALISED) AS UNREALISED "
					END
				SELECT @@SQL = @@SQL + ", SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)) "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + ", SUM(SUM(UNREALISED)) "
					END
				SELECT @@SQL = @@SQL + ", SUM(SUM(VAMT + MAMT)) "
				PRINT @@SQL
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'AREA'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.AREA A "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.AREA A, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT AREA, BRANCH AS AREANAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY AREA, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY AREA, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'REGION'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL +   "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.REGION R "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.REGION R, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT REGION, BRANCH AS REGIONNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY REGION, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY REGION, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'SUBBROKER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.SUBBROKERS S "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.SUBBROKERS S, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT SUB_BROKER, BRANCH AS SUBNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY SUB_BROKER, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY SUB_BROKER, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'TRADER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCHES T "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "
				SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, CLTCODE, ACNAME, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, C.CL_CODE, C.LONG_NAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.BRANCHES T, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT TRADER, BRANCH AS TRADERNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY TRADER, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY TRADER, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'FAMILY'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, FAMILYMST F "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "
				SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, FAMILYMST F, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT FAMILY, BRANCH AS FAMILYNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY FAMILY, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY FAMILY, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_ALL
-- --------------------------------------------------
--Exec RPT_PARTYLEDGER_SUMMARY_ALL 'Jun 17 2007','Sep 25 2007','Apr  1 2007','Mar 31 2008','broker','broker','Vdt','0A146','0A146','PARTY','Y','Y','Y'  
  
 /* *****************************************************************************************************    
 THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH    
 IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.    
 THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.    
 CREATED BY := GAUREE MAHAJAN    
 CREATED DATE := AUGUEST 31 2007    
 MODIFIED DATE := SEPTEMBER 24 2007    
 DATABASE  := ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX    
 SYNTAX AS FOLLOWS -----    
 EXEC RPT_PARTYLEDGER_SUMMARY_ALL 'APR  1 2007', 'AUG 31 2007', 'APR  1 2007', 'MAR 31 2008', 'BROKER', 'BROKER', 'VDT', '000', 'ZZZ', 'FAMILY','Y','Y','Y'    
 EXEC RPT_PARTYLEDGER_SUMMARY_ALL 'APR  1 2007', 'AUG 31 2007', 'APR  1 2007', 'MAR 31 2008', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA','Y','Y','Y'    
 EXEC RPT_PARTYLEDGER_SUMMARY_ALL 'APR  1 2007', 'AUG 31 2007', 'APR  1 2007', 'MAR 31 2008','REGION', 'AHM', 'VDT', 'APS', 'ZPS','Y','N','N'    
    
    
 *****************************************************************************************************    
*/    
    
CREATE PROC [dbo].[RPT_PARTYLEDGER_SUMMARY_ALL]    
 @FDATE VARCHAR(11),    
 @TDATE VARCHAR(11),    
 @STDDATE VARCHAR(11),    
 @LSTDATE VARCHAR(11),    
 @STATUSID VARCHAR(20),    
 @STATUSNAME VARCHAR(20),    
 @DISPLAYRPT VARCHAR(3),    
 @FPARTY VARCHAR(10),    
 @TPARTY VARCHAR(10),    
 @REPORTNAME VARCHAR(100),    
 @nseflg varchar(1)  ,        
 @bseflg varchar(1)  ,        
 @nfoflg varchar(1) , 
 @SESSIONID VARCHAR(10)
    
    
AS    
BEGIN    
DECLARE    
@@SQL AS VARCHAR(2000),    
@@RECCOUNTER AS NUMERIC,    
@@SHAREDB AS VARCHAR(25),    
@@OBJID AS INT,    
@@ACCNSESERV AS  VARCHAR(25),   
@@ACCBSESERV AS  VARCHAR(25),   
@@ACCNFOSERV AS  VARCHAR(25),   
@@ACCNSEDB AS  VARCHAR(25),   
@@ACCBSEDB AS  VARCHAR(25),   
@@ACCNFODB AS  VARCHAR(25)
  
  
  
select @@ACCNSEDB = AccountDb,@@ACCNSESERV = AccountServer from multicompany where Exchange = 'NSE' and Segment = 'CAPITAL'  
select @@ACCBSEDB =AccountDb,@@ACCBSESERV = AccountServer from multicompany where Exchange = 'BSE' and Segment = 'CAPITAL'  
select @@ACCNFODB =AccountDb,@@ACCNFOSERV = AccountServer from multicompany where Exchange = 'NSE' and Segment = 'FUTURES'  
  
Select @@ACCNSESERV = '[' + @@ACCNSESERV + ']'  
Select @@ACCBSESERV = '[' + @@ACCBSESERV + ']'  
Select @@ACCNFOSERV = '[' + @@ACCNFOSERV + ']'  
  
  
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER1'), 0)    
IF @@OBJID = 0    
 BEGIN    
  EXEC CREATEPARTYLEDGER_new    
 END    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
    
DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID    

    
--SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER    
    
    
IF @REPORTNAME = 'BRANCH'    
 Begin    
 If @nseflg ='Y'    
  Begin    
 Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'     
 Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
 EXEC( @@SQL)  
  end    
 If @bseflg = 'Y'    
  Begin    
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'     
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
    EXEC( @@SQL)  
  End    
 If @nfoflg ='Y'    
  Begin    
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'     
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
 EXEC( @@SQL)     
  end    
end    
-------------------------------    
IF @REPORTNAME = 'AREA'    
 begin    
 If @nseflg ='Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'       
   Select @@SQL = @@SQL    + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC( @@SQL)       
end    
 If @bseflg = 'Y'    
  Begin    
 Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1(AREA, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'   
 Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
 EXEC(@@SQL)  
  end    
 If @nfoflg ='Y'    
  Begin    
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'  
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
  end    
 end    
----------------------------------    
IF @REPORTNAME = 'REGION'    
 begin    
 If @nseflg ='Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'     
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
  end    
 If @bseflg = 'Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'     
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
 EXEC(@@SQL)  
  end    
 If @nfoflg ='Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'     
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
  end    
end    
--------------------------------    
IF @REPORTNAME = 'SUBBROKER'    
 begin    
 If @nseflg ='Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'      
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
  end    
 If @bseflg = 'Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'     
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
  end    
 If @nfoflg ='Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'     
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
  end    
 end    
    
-----------------------------------    
    
IF @REPORTNAME = 'TRADER'    
 begin    
 If @nseflg ='Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'        
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
  end    
 If @bseflg = 'Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'    
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
  end    
 If @nfoflg ='Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'    
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
 end    
end    
-----------------------------------    
    
    
IF @REPORTNAME = 'FAMILY'    
 begin    
 If @nseflg ='Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'        
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
 end    
 If @bseflg = 'Y'    
  Begin    
  Select @@SQL = ' INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'     
  Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
  end    
 If @nfoflg ='Y'    
  Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'     
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   EXEC(@@SQL)  
  end    
 end    
    
---------------------------------------    
IF @REPORTNAME = 'PARTY'    
 begin    
 If @nseflg ='Y'    
 Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'     
   Select @@SQL = @@SQL  + ' Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   PRINT(@@SQL)   
   EXEC(@@SQL)  
 end    
 If @bseflg = 'Y'    
 Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'      
   Select @@SQL = @@SQL  + ' Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
PRINT(@@SQL)     
EXEC(@@SQL)  
 end    
 If @nfoflg ='Y'    
 Begin    
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'    
   Select @@SQL = @@SQL  + ' Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''  
   PRINT(@@SQL)   
   EXEC(@@SQL)  
 end    
end    
---------------------------------------------  
  
IF @REPORTNAME = 'BRANCH'    
 Begin    
    
 Select BRANCH_CODE, BRANCH,ISNULL(SUM(NSEVAMT), 0) AS NSEL,ISNULL(SUM(BSEVAMT), 0) AS BSEL,ISNULL(SUM(NFOVAMT), 0) AS NFOL,ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,  
 ISNULL(SUM(NSEMAMT), 0) AS NSEM,ISNULL(SUM(BSEMAMT), 0) AS BSEM,ISNULL(SUM(NFOMAMT), 0) AS NFOL,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT,  
 ISNULL(SUM(NSEUNREALISED), 0) AS NSEU , ISNULL(SUM(BSEUNREALISED), 0) AS BSEU , ISNULL(SUM(NFOUNREALISED), 0) AS NFOU ,ISNULL(SUM(UNREALISED), 0) AS UNREALISED ,   
 ISNULL(SUM(NSEHTOTAL), 0) AS NSEH,ISNULL(SUM(BSEHTOTAL), 0) AS BSEH,ISNULL(SUM(NFOHTOTAL), 0) AS NHOH,ISNULL(SUM(HTOTAL), 0) AS HTOTAL   
  
from NEWPARTYLEDGER1     
    
 GROUP BY BRANCH_CODE, BRANCH    
 Order BY BRANCH_CODE, BRANCH    
 COMPUTE SUM(ISNULL(SUM(NSEVAMT), 0)),SUM(ISNULL(SUM(BSEVAMT), 0)),SUM(ISNULL(SUM(NFOVAMT), 0)),SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(NSEMAMT), 0)) , SUM(ISNULL(SUM(BSEMAMT), 0)) , SUM(ISNULL(SUM(NFOMAMT), 0)) , SUM(ISNULL(SUM(MAMT), 0)) , SUM(ISNULL(
  
SUM(NSEUNREALISED), 0)) ,SUM(ISNULL(SUM(BSEUNREALISED), 0)) ,SUM(ISNULL(SUM(NFOUNREALISED), 0)) ,SUM(ISNULL(SUM(UNREALISED), 0)) , SUM(ISNULL(SUM(BSEHTOTAL), 0)),SUM(ISNULL(SUM(NSEHTOTAL), 0)),SUM(ISNULL(SUM(NFOHTOTAL), 0)),SUM(ISNULL(SUM(HTOTAL), 0))    
end    
  
DECLARE  
@@SQL1 AS VARCHAR(200),  
@@SQL2 AS VARCHAR(200),  
@@SQL3 AS VARCHAR(200),  
@@SQL4 AS VARCHAR(200),  
@@SQLCOMPUTE1 AS VARCHAR(200),  
@@SQLCOMPUTE2 AS VARCHAR(200),  
@@SQLCOMPUTE3 AS VARCHAR(200),  
@@SQLCOMPUTE4 AS VARCHAR(200),  
@@SQLFIN AS VARCHAR(2000)  
  
select @@SQL1 =''  
select @@SQL2 =''  
select @@SQL3 =''  
select @@SQL4 =''  
select @@SQLCOMPUTE1 =''  
select @@SQLCOMPUTE2 =''  
select @@SQLCOMPUTE3 =''  
select @@SQLCOMPUTE4 =''  
  
if @nseflg = 'Y'  
 begin  
 select @@SQL1 = 'ISNULL(SUM(NSEVAMT), 0) AS NSEL,'  
 select @@SQL2 = 'ISNULL(SUM(NSEMAMT), 0) AS NSEM,'  
 select @@SQL3 = 'ISNULL(SUM(NSEUNREALISED), 0) AS NSEU,'  
 select @@SQL4 = 'ISNULL(SUM(NSEHTOTAL), 0) AS NSEH,'  
 select @@SQLCOMPUTE1 = 'SUM(ISNULL(SUM(NSEVAMT), 0)),'  
 select @@SQLCOMPUTE2 = 'SUM(ISNULL(SUM(NSEMAMT), 0)),'  
 select @@SQLCOMPUTE3 = 'SUM(ISNULL(SUM(NSEUNREALISED), 0)),'  
 select @@SQLCOMPUTE4 = 'SUM(ISNULL(SUM(NSEHTOTAL), 0)),'  
 end  
  
if @bseflg = 'Y'    
   begin  
  select @@SQL1 = @@SQL1 + 'ISNULL(SUM(BSEVAMT), 0) AS BSEL,'  
  select @@SQL2 = @@SQL2 + 'ISNULL(SUM(BSEMAMT), 0) AS BSEM,'  
  select @@SQL3 = @@SQL3 + 'ISNULL(SUM(BSEUNREALISED), 0) AS BSEU,'  
  select @@SQL4 = @@SQL4 + 'ISNULL(SUM(NSEHTOTAL), 0) AS BSEH,'  
  select @@SQLCOMPUTE1 = @@SQLCOMPUTE1 + 'SUM(ISNULL(SUM(BSEVAMT), 0)),'  
  select @@SQLCOMPUTE2 = @@SQLCOMPUTE2 + 'SUM(ISNULL(SUM(BSEMAMT), 0)),'  
  select @@SQLCOMPUTE3 = @@SQLCOMPUTE3 + 'SUM(ISNULL(SUM(BSEUNREALISED), 0)),'  
  select @@SQLCOMPUTE4 = @@SQLCOMPUTE4 + 'SUM(ISNULL(SUM(NSEHTOTAL), 0)),'  
   end  
   
if @nfoflg = 'Y'    
    begin  
  select @@SQL1 = @@SQL1 + 'ISNULL(SUM(NFOVAMT), 0) AS NFOL,'  
  select @@SQL2 = @@SQL2 + 'ISNULL(SUM(NFOMAMT), 0) AS NFOM,'  
  select @@SQL3 = @@SQL3 + 'ISNULL(SUM(NFOUNREALISED), 0) AS NFOU,'  
  select @@SQL4 = @@SQL4 + 'ISNULL(SUM(NFOHTOTAL), 0) AS NFOH,'  
  select @@SQLCOMPUTE1 = @@SQLCOMPUTE1 + 'SUM(ISNULL(SUM(NFOVAMT), 0)) ,'  
  select @@SQLCOMPUTE2 = @@SQLCOMPUTE2 + 'SUM(ISNULL(SUM(NFOMAMT), 0)) ,'  
  select @@SQLCOMPUTE3 = @@SQLCOMPUTE3 + 'SUM(ISNULL(SUM(NFOUNREALISED), 0)) ,'  
  select @@SQLCOMPUTE4 = @@SQLCOMPUTE4 + 'SUM(ISNULL(SUM(NFOHTOTAL), 0)),'  
 end  
   
  select @@SQL1 = @@SQL1 + 'ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,'  
  select @@SQL2 = @@SQL2 + 'ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT,'  
  select @@SQL3 = @@SQL3 + 'ISNULL(SUM(UNREALISED), 0) AS UNREALISED,'  
  select @@SQL4 = @@SQL4 + 'ISNULL(SUM(HTOTAL), 0) AS HTOTAL'  
  select @@SQLCOMPUTE1 = @@SQLCOMPUTE1 + 'SUM(ISNULL(SUM(VAMT), 0)),'  
  select @@SQLCOMPUTE2 = @@SQLCOMPUTE2 + 'SUM(ISNULL(SUM(MAMT), 0)),'  
  select @@SQLCOMPUTE3 = @@SQLCOMPUTE3 + 'SUM(ISNULL(SUM(UNREALISED), 0)),'  
  select @@SQLCOMPUTE4 = @@SQLCOMPUTE4 + 'SUM(ISNULL(SUM(HTOTAL), 0))'  
  
    
IF @REPORTNAME = 'AREA'    
 begin    
  select @@SQLFIN =  'select  AREA, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4  
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '      
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''
  select @@SQLFIN = @@SQLFIN + 'GROUP BY AREA, BRANCH '    
  select @@SQLFIN = @@SQLFIN + 'Order BY AREA, BRANCH '    
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4  
end    
    
    
    
IF @REPORTNAME = 'REGION'    
 begin    
  select @@SQLFIN =  'select REGION, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4  
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '      
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''
  select @@SQLFIN = @@SQLFIN + 'GROUP BY REGION, BRANCH '    
  select @@SQLFIN = @@SQLFIN + 'Order BY REGION, BRANCH '  
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4  
end    
    
    
IF @REPORTNAME = 'SUBBROKER'    
 begin    
  select @@SQLFIN =  'select SUB_BROKER, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4  
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '      
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''
  select @@SQLFIN = @@SQLFIN + 'GROUP BY SUB_BROKER, BRANCH '    
  select @@SQLFIN = @@SQLFIN + 'Order BY SUB_BROKER, BRANCH '  
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4  
end    
    
    
    
IF @REPORTNAME = 'TRADER'    
 begin    
  select @@SQLFIN =  'select TRADER, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4  
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '      
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''
  select @@SQLFIN = @@SQLFIN + 'GROUP BY TRADER, BRANCH '   
  select @@SQLFIN = @@SQLFIN + 'ORDER BY TRADER, BRANCH '    
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4  
end    
    
    
    
IF @REPORTNAME = 'FAMILY'    
 begin    
  select @@SQLFIN =  'select FAMILY, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4   
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '      
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''
  select @@SQLFIN = @@SQLFIN + 'GROUP BY FAMILY, BRANCH '   
  select @@SQLFIN = @@SQLFIN + 'ORDER BY FAMILY, BRANCH '  
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4  
end    
    
    
    
IF @REPORTNAME = 'PARTY'    
 begin    
--select * from NEWPARTYLEDGER1     
  select @@SQLFIN =  'select CLTCODE, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4   
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '      
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''
  select @@SQLFIN = @@SQLFIN + 'GROUP BY CLTCODE, BRANCH '    
  select @@SQLFIN = @@SQLFIN + 'ORDER BY CLTCODE, BRANCH '    
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4  
end    
PRINT @@SQLFIN  
EXEC (@@SQLFIN)    
    
    
     
    
    
--DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID  

DELETE FROM NEWPARTYLEDGER1 WHERE SESSIONID = @SESSIONID
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_V3
-- --------------------------------------------------
/*	*****************************************************************************************************
	THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH
	IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.
	THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.
	CREATED BY	:=	YATIN DESAI
	CREATED DATE	:=	DECEMBER 02 2005
	MODIFIED DATE	:=	DECEMBER 16 2005
	DATABASE		:=	ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX
	SYNTAX AS FOLLOWS -----
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'FAMILY'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'REGION', 'AHM', 'VDT', 'APS', 'ZPS'
	*****************************************************************************************************
*/

CREATE PROC [dbo].[RPT_PARTYLEDGER_SUMMARY_V3]
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@STDDATE VARCHAR(11),
	@LSTDATE VARCHAR(11),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(20),
	@DISPLAYRPT VARCHAR(3),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@REPORTNAME VARCHAR(100)

AS
DECLARE
@@SQL AS VARCHAR(2000),
@@RECCOUNTER AS NUMERIC,
@@SHAREDB AS VARCHAR(25),
@@OBJID AS INT
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER'), 0)
IF @@OBJID = 0
	BEGIN
		EXEC CREATEPARTYLEDGER
	END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID

SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER

IF @REPORTNAME = 'BRANCH'
	BEGIN
		IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'
			BEGIN
				--INSERT LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'BROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
					END
				ELSE IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"
					END
				EXEC (@@SQL)
		
				--INSERT MARGINLEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'BROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
					END
				ELSE IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"
					END
				PRINT @@SQL
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT BRANCH_CODE, BRANCH, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0
						FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + ", ISNULL(SUM(UNREALISED), 0) AS UNREALISED "
--					END
				SELECT @@SQL = @@SQL + ", ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)) "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + ", SUM(ISNULL(SUM(UNREALISED), 0)) "
--					END
				SELECT @@SQL = @@SQL + ", SUM(ISNULL(SUM(VAMT + MAMT), 0)) "
				PRINT @@SQL
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'AREA'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.AREA A "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.AREA A, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT AREA, BRANCH AS AREANAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT AREA, BRANCH AS AREANAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "
--					END
				SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY AREA, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY AREA, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "
--					END
				SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'REGION'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL +   "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.REGION R "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.REGION R, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN

						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT REGION, BRANCH AS REGIONNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT REGION, BRANCH AS REGIONNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "
--					END
				SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY REGION, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY REGION, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "
--					END
				SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'SUBBROKER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.SUBBROKERS S "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.SUBBROKERS S, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT SUB_BROKER, BRANCH AS SUBNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT SUB_BROKER, BRANCH AS SUBNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "
--					END
				SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY SUB_BROKER, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY SUB_BROKER, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "
--					END
				SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'TRADER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCHES T "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "
				SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, CLTCODE, ACNAME, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, C.CL_CODE, C.LONG_NAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.BRANCHES T, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT TRADER, BRANCH AS TRADERNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT TRADER, BRANCH AS TRADERNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "
--					END
				SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY TRADER, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY TRADER, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "
--					END
				SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'FAMILY'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, FAMILYMST F "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "
				SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, FAMILYMST F, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT FAMILY, BRANCH AS FAMILYNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT FAMILY, BRANCH AS FAMILYNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "
--					END
				SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY FAMILY, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY FAMILY, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "
--					END
				SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END


IF @REPORTNAME = 'PARTY'
	BEGIN
		IF @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY' OR @STATUSID = 'CLIENT'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'CLIENT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME , "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, MARGINLEDGER M, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'CLIENT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT CLTCODE, BRANCH AS LONG_NAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT CLTCODE, BRANCH AS LONG_NAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "
--					END
				SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY CLTCODE, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "
/*				IF @DISPLAYRPT = 'VDT'
					BEGIN*/
						SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "
--					END
				SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_V3_new
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_PARTYLEDGER_SUMMARY_V3_new]        
 @FDATE VARCHAR(11),        
 @TDATE VARCHAR(11),        
 @STDDATE VARCHAR(11),        
 @LSTDATE VARCHAR(11),        
 @STATUSID VARCHAR(20),        
 @STATUSNAME VARCHAR(20),        
 @DISPLAYRPT VARCHAR(3),        
 @FPARTY VARCHAR(10),        
 @TPARTY VARCHAR(10),        
 @REPORTNAME VARCHAR(100),      
 @SESSIONID VARCHAR(10)         
-- @SPID INT ,     
        
AS        
        
DECLARE        
@@SQL AS VARCHAR(2000),        
@@RECCOUNTER AS NUMERIC,        
@@SHAREDB AS VARCHAR(25),        
@@OBJID AS INT        
    
      
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER1'), 0)        
IF @@OBJID = 0        
 BEGIN        
  EXEC CREATEPARTYLEDGER_new        
 END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      
        
SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER        
        
IF @REPORTNAME = 'BRANCH'        
 BEGIN        
  IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'        
   BEGIN        
 PRINT CONVERT(VARCHAR,@@SPID)    
    --INSERT LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID , SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
         
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "        
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'BROKER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
     END        
    ELSE IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"        
     END        
    ELSE IF @STATUSID = 'BRANCH'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"        
     END        
    EXEC (@@SQL)        
          
    --INSERT MARGINLEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END AS MAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END ELSE 0 END AS UNREALISED, "        
     END        
 ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
      
   SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "        
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "        
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'BROKER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
     END        
    ELSE IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"        
     END        
    ELSE IF @STATUSID = 'BRANCH'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"        
     END        
    PRINT @@SQL        
    EXEC (@@SQL)        
-------------------------------------------------------------------------------          
    IF @DISPLAYRPT = 'EDT'        
     BEGIN        
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR        
      --INSTEAD OF GIVING REVERSAL EFFECT        
      --THIS SAVES UNION JOIN        
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "        
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"        
      EXEC (@@SQL)        
-----------------------------------------        
     END        
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
    IF @@RECCOUNTER <= 0        
     BEGIN        
      SELECT BRANCH_CODE, BRANCH,SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0         
      FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      RETURN        
     END        
    SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"        
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "        
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL , SESSIONID "        
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "        
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "        
    SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH , SESSIONID "        
    SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH "        
    --SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)) "        
/*    IF @DISPLAYRPT = 'VDT'        
     BEGIN*/        
--      SELECT @@SQL = @@SQL + ", SUM(ISNULL(SUM(UNREALISED), 0)) "        
--     END        
--    SELECT @@SQL = @@SQL + ", SUM(ISNULL(SUM(VAMT + MAMT), 0)) "        
    PRINT @@SQL        
    EXEC (@@SQL)        
-----------------------------------------        
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
  ELSE        
   BEGIN        
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'        
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
 END        
        
IF @REPORTNAME = 'AREA'        
 BEGIN        
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'        
   BEGIN        
    --INSERTING NORMAL LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID , SESSIONID ) "        
    SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
      
      
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.AREA A "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "        
    SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "        
    SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    --INSERTING MARGIN LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID , SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, "        
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
      
      
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.AREA A, "        
    SELECT @@SQL = @@SQL + "LEDGER L "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "        
    SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "        
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "        
    SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "     
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
          
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    IF @DISPLAYRPT = 'EDT'        
     BEGIN        
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR        
      --INSTEAD OF GIVING REVERSAL EFFECT        
      --THIS SAVES UNION JOIN        
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "        
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"        
      EXEC (@@SQL)        
     END        
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
    IF @@RECCOUNTER <= 0        
     BEGIN        
      SELECT AREA, BRANCH AS AREANAME,SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0         
      FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      RETURN        
     END        
        
    SELECT @@SQL = "SELECT AREA, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"        
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "        
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "        
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "        
        
            
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "        
    SELECT @@SQL = @@SQL + "GROUP BY AREA, BRANCH, SESSIONID "        
    SELECT @@SQL = @@SQL + "ORDER BY AREA, BRANCH "        
    --SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "        
/*    IF @DISPLAYRPT = 'VDT'        
     BEGIN*/        
--      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "        
--     END        
--    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
  ELSE        
   BEGIN        
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'        
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
 END        
        
IF @REPORTNAME = 'REGION'        
 BEGIN        
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'        
   BEGIN        
    --INSERTING NORMAL LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL +   "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
       
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.REGION R "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "        
    SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "        
    SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    --INSERTING MARGIN LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, "        
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
       
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.REGION R, "        
    SELECT @@SQL = @@SQL + "LEDGER L "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "        
    SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "        
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "        
    SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
          
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    IF @DISPLAYRPT = 'EDT'        
     BEGIN        
        
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR        
      --INSTEAD OF GIVING REVERSAL EFFECT        
      --THIS SAVES UNION JOIN        
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "        
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"        
      EXEC (@@SQL)        
     END        
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
    IF @@RECCOUNTER <= 0        
     BEGIN        
      SELECT REGION, BRANCH AS REGIONNAME, SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0         
       FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      RETURN        
     END        
   SELECT @@SQL = "SELECT REGION, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"        
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "        
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "        
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "        
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "        
    SELECT @@SQL = @@SQL + "GROUP BY REGION, BRANCH, SESSIONID "        
    SELECT @@SQL = @@SQL + "ORDER BY REGION, BRANCH "        
    --SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "        
/*    IF @DISPLAYRPT = 'VDT'        
     BEGIN*/        
    --  SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "        
--     END        
    --SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
  ELSE        
   BEGIN        
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'        
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
 END        
        
IF @REPORTNAME = 'SUBBROKER'        
 BEGIN        
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'        
   BEGIN        
    --INSERTING NORMAL LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
      
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.SUBBROKERS S "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "        
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "        
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'BRANCH'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'SUBBROKER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'TRADER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "        
     END        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    --INSERTING MARGIN LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, "        
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN              SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
      
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.SUBBROKERS S, "        
    SELECT @@SQL = @@SQL + "LEDGER L "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "        
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "        
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "        
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
 IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'BRANCH'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'SUBBROKER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "        
     END        
          
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    IF @DISPLAYRPT = 'EDT'        
     BEGIN        
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR        
      --INSTEAD OF GIVING REVERSAL EFFECT        
      --THIS SAVES UNION JOIN        
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "        
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"        
      EXEC (@@SQL)        
     END        
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
    IF @@RECCOUNTER <= 0        
     BEGIN        
      SELECT SUB_BROKER, BRANCH AS SUBNAME, SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0  FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      RETURN        
     END        
   SELECT @@SQL = "SELECT SUB_BROKER, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"        
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "        
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "        
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "        
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "        
    SELECT @@SQL = @@SQL + "GROUP BY SUB_BROKER, BRANCH, SESSIONID "        
    SELECT @@SQL = @@SQL + "ORDER BY SUB_BROKER, BRANCH "        
   -- SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "        
/*    IF @DISPLAYRPT = 'VDT'        
     BEGIN*/        
    --  SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "        
--     END        
   -- SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
  ELSE        
   BEGIN        
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'        
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
 END        
        
IF @REPORTNAME = 'TRADER'        
 BEGIN        
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'        
   BEGIN        
    --INSERTING NORMAL LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "     
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
      
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCHES T "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "        
    SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "        
    SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'BRANCH'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'SUBBROKER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'TRADER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "        
     END        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    --INSERTING MARGIN LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH, CLTCODE, ACNAME, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, C.CL_CODE, C.LONG_NAME, "        
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
      
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.BRANCHES T, "        
    SELECT @@SQL = @@SQL + "LEDGER L "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "        
    SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "        
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "        
    SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'BRANCH'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'SUBBROKER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'TRADER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "        
     END        
      
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    IF @DISPLAYRPT = 'EDT'        
     BEGIN        
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR        
      --INSTEAD OF GIVING REVERSAL EFFECT        
      --THIS SAVES UNION JOIN        
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "        
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"        
      EXEC (@@SQL)        
     END        
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
    IF @@RECCOUNTER <= 0        
     BEGIN        
      SELECT TRADER, BRANCH AS TRADERNAME, SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0, SESSIONID         
      FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      RETURN        
     END        
    SELECT @@SQL = "SELECT TRADER, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"        
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "        
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "        
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "        
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "        
    SELECT @@SQL = @@SQL + "GROUP BY TRADER, BRANCH, SESSIONID "        
    SELECT @@SQL = @@SQL + "ORDER BY TRADER, BRANCH "        
  --  SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "        
/*    IF @DISPLAYRPT = 'VDT'        
     BEGIN*/        
  -- SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "        
--     END        
   -- SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
  ELSE        
   BEGIN        
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'        
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
 END        
        
IF @REPORTNAME = 'FAMILY'        
 BEGIN        
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'        
   BEGIN        
    --INSERTING NORMAL LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
      
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, FAMILYMST F "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "        
    SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "        
    SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'BRANCH'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'SUBBROKER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'TRADER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'FAMILY'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "        
     END        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    --INSERTING MARGIN LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, "        
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
     
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
     
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, FAMILYMST F, "        
    SELECT @@SQL = @@SQL + "LEDGER L "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "        
    SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "        
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "        
    SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'BRANCH'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'SUBBROKER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'TRADER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'FAMILY'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "        
     END        
          
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    IF @DISPLAYRPT = 'EDT'        
     BEGIN        
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR        
      --INSTEAD OF GIVING REVERSAL EFFECT        
      --THIS SAVES UNION JOIN        
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "        
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"        
      EXEC (@@SQL)        
     END        
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
    IF @@RECCOUNTER <= 0        
     BEGIN        
      SELECT FAMILY, BRANCH AS FAMILYNAME, SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0         
      FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      RETURN        
     END        
   SELECT @@SQL = "SELECT FAMILY, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"        
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "        
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "        
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "        
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "        
    SELECT @@SQL = @@SQL + "GROUP BY FAMILY, BRANCH, SESSIONID "        
    SELECT @@SQL = @@SQL + "ORDER BY FAMILY, BRANCH "        
    --SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "        
/*    IF @DISPLAYRPT = 'VDT'        
     BEGIN*/        
    --  SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "        
--     END        
    --SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
 END        
        
        
IF @REPORTNAME = 'PARTY'        
BEGIN        
  IF @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY' OR @STATUSID = 'CLIENT'        
   BEGIN        
    --INSERTING NORMAL LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
   SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
      
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, LEDGER L "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = L.CLTCODE "        
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'BRANCH'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'SUBBROKER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'TRADER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'FAMILY'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'CLIENT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "        
     END        
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    --INSERTING MARGIN LEDGER RECORDS        
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "        
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, "        
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "        
     END        
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID       
      
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, MARGINLEDGER M, "        
    SELECT @@SQL = @@SQL + "LEDGER L "        
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = M.PARTY_CODE "        
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "        
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "        
    IF @DISPLAYRPT = 'VDT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    ELSE        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "        
     END        
    IF @STATUSID = 'AREA'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'REGION'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'BRANCH'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'SUBBROKER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'TRADER'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'FAMILY'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "        
     END        
    ELSE IF @STATUSID = 'CLIENT'        
     BEGIN        
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "        
     END        
          
    PRINT (@@SQL)        
    EXEC (@@SQL)        
          
    IF @DISPLAYRPT = 'EDT'        
     BEGIN        
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR        
      --INSTEAD OF GIVING REVERSAL EFFECT        
      --THIS SAVES UNION JOIN        
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "        
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"        
      EXEC (@@SQL)        
     END        
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
    IF @@RECCOUNTER <= 0        
     BEGIN        
      SELECT CLTCODE, BRANCH AS LONG_NAME,SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0, SESSIONID = @SESSIONID FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      RETURN        
     END        
    SELECT @@SQL = "SELECT CLTCODE, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"        
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "        
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "        
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "        
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "        
    SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, BRANCH, SESSIONID "        
    SELECT @@SQL = @@SQL + "ORDER BY CLTCODE, BRANCH "        
   -- SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "        
/*    IF @DISPLAYRPT = 'VDT'        
     BEGIN*/        
   --   SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "        
--     END        
   -- SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "        
    PRINT (@@SQL)        
   EXEC (@@SQL)        
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
  ELSE        
   BEGIN        
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'        
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
   END        
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_V4
-- --------------------------------------------------
/*	*****************************************************************************************************
	THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH
	IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.
	THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.
	CREATED BY	:=	YATIN DESAI
	CREATED DATE	:=	DECEMBER 02 2005
	MODIFIED DATE	:=	DECEMBER 16 2005
	DATABASE		:=	ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX
	SYNTAX AS FOLLOWS -----
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'BRANCH'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'REGION'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'AREA'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'SUBBROKER'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'TRADER'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'FAMILY'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'REGION', 'AHM', 'VDT', 'APS', 'ZPS'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'PARTY', 'ACO1', 'VDT', 'ADIT1', 'ADIT1', 'PARTY'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'PARTY'
	*****************************************************************************************************
*/
CREATE PROC [dbo].[RPT_PARTYLEDGER_SUMMARY_V4]
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@STDDATE VARCHAR(11),
	@LSTDATE VARCHAR(11),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(20),
	@DISPLAYRPT VARCHAR(3),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@REPORTNAME VARCHAR(100)

AS

DECLARE
@@SQL AS VARCHAR(2000),
@@RECCOUNTER AS NUMERIC,
@@SHAREDB AS VARCHAR(20),
@@OBJID AS INT

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @REPORTNAME = 'BRANCH'
	BEGIN
		IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'
			BEGIN
				SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND BRANCH_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND BRANCH_CODE = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'AREA'
	BEGIN
		IF @STATUSID = 'BROKER' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'
			BEGIN
				SELECT @@SQL = "SELECT AREA, AREA_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY AREA, AREA_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY AREA, AREA_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'REGION'
	BEGIN
		IF @STATUSID = 'BROKER' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'
			BEGIN
				SELECT @@SQL = "SELECT REGION, REGION_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY REGION, REGION_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY REGION, REGION_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'SUBBROKER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				SELECT @@SQL = "SELECT SUBBROKER, SUBBROKER_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND BRANCH_CODE = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND SUBBROKER = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY SUBBROKER, SUBBROKER_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY SUBBROKER, SUBBROKER_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'TRADER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				SELECT @@SQL = "SELECT TRADER, TRADER_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND BRANCH_CODE = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND SUBBROKER = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY TRADER, TRADER_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY TRADER, TRADER_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'FAMILY'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'
			BEGIN
				SELECT @@SQL = "SELECT FAMILY, FAMILY_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND BRANCH_CODE = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND SUBBROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND FAMILY = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY FAMILY, FAMILY_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY FAMILY, FAMILY_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'PARTY'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY' OR @STATUSID = 'PARTY'
			BEGIN
				SELECT @@SQL = "SELECT CLTCODE, LONGNAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND CLTCODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND BRANCH_CODE = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND SUBBROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND FAMILY = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'PARTY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND CLTCODE = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, LONGNAME "
				SELECT @@SQL = @@SQL + "ORDER BY CLTCODE, LONGNAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_Payout_ControlSheet
-- --------------------------------------------------
CREATE Procedure [dbo].[Rpt_Payout_ControlSheet]  
@FDate varchar(11),  
@BranchCode varchar(10),  
@BankCode varchar(10),  
@RptBy varchar(1)  
  
As  
  
Set NoCount On  
CREATE TABLE [#Payout_ControlSheet] (  
 [SNO] [int] IDENTITY (1, 1) NOT NULL ,  
 [Entry_Desc] [varchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL ,  
 [Adhoc_Total] [int] NULL ,  
 [Adhoc_Chq] [int] NULL ,  
 [Adhoc_CSV] [int] NULL ,  
 [Adhoc_Trf] [int] NULL ,  
 [Sett_Total] [int] NULL ,  
 [Sett_Chq] [int] NULL ,  
 [Sett_CSV] [int] NULL ,  
 [Sett_Trf] [int] NULL ,  
 [Others] [int] NULL ,  
 [Total] [int] NULL   
) ON [PRIMARY]  
  
Insert Into #Payout_ControlSheet  
Select Entry_Desc ,Sum(Adhoc_Total) ,Sum(Adhoc_Chq) ,Sum(Adhoc_CSV) ,Sum(Adhoc_Trf) ,Sum(Sett_Total) ,Sum(Sett_Chq) ,Sum(Sett_CSV) ,Sum(Sett_Trf) ,Sum(Others) ,Sum(Total)   
From (Select    
Entry_Desc = 'Requested',   
Adhoc_Total = (Case When GenFlag = 'A' Then Count(*) Else 0 End),  
Adhoc_Chq = 0, Adhoc_CSV = 0, Adhoc_Trf = 0,    
Sett_Total = (Case When GenFlag = 'S' Then Count(*) Else 0 End),   
Sett_Chq = 0, Sett_CSV = 0, Sett_Trf = 0, Others = 0, Total = 0  
From SettPayout   
Where Left(RequestDt,11) = @FDate  
And isnull(BranchCode,'') Like @BranchCode + '%'  
And isnull(BankCode,'') Like @BankCode + '%'  
Group By GenFlag) A  
Group By Entry_Desc  
  
Insert Into #Payout_ControlSheet  
Select Entry_Desc ,Sum(Adhoc_Total) ,Sum(Adhoc_Chq) ,Sum(Adhoc_CSV) ,Sum(Adhoc_Trf) ,Sum(Sett_Total) ,Sum(Sett_Chq) ,Sum(Sett_CSV) ,Sum(Sett_Trf) ,Sum(Others) ,Sum(Total)   
From (Select    
Entry_Desc = 'Pending',   
Adhoc_Total = (Case When GenFlag = 'A' Then Count(*) Else 0 End),  
Adhoc_Chq = 0, Adhoc_CSV = 0, Adhoc_Trf = 0,   
Sett_Total = (Case When GenFlag = 'S' Then Count(*) Else 0 End),   
Sett_Chq = 0, Sett_CSV = 0, Sett_Trf = 0, Others = 0, Total = 0  
From SettPayout   
Where Left(Convert(Varchar,RequestDt,109),11) = @FDate  
And isnull(BranchCode,'') Like @BranchCode + '%'  
And isnull(BankCode,'') Like @BankCode + '%'  
And Status = 'P'  
Group By GenFlag) A  
Group By Entry_Desc  
  
Insert Into #Payout_ControlSheet  
Select Entry_Desc ,Sum(Adhoc_Total) ,Sum(Adhoc_Chq) ,Sum(Adhoc_CSV) ,Sum(Adhoc_Trf) ,Sum(Sett_Total) ,Sum(Sett_Chq) ,Sum(Sett_CSV) ,Sum(Sett_Trf) ,Sum(Others) ,Sum(Total)   
From (Select    
Entry_Desc = 'Rejected',   
Adhoc_Total = (Case When GenFlag = 'A' Then Count(*) Else 0 End),  
Adhoc_Chq = 0, Adhoc_CSV = 0, Adhoc_Trf = 0,    
Sett_Total = (Case When GenFlag = 'S' Then Count(*) Else 0 End),   
Sett_Chq = 0, Sett_CSV = 0, Sett_Trf = 0, Others = 0, Total = 0  
From SettPayout   
Where Left(Convert(Varchar,RequestDt,109),11) = @FDate  
And isnull(BranchCode,'') Like @BranchCode + '%'  
And isnull(BankCode,'') Like @BankCode + '%'  
And Status = 'R'  
Group By GenFlag) A  
Group By Entry_Desc  
  
Insert Into #Payout_ControlSheet  
Select Entry_Desc ,Sum(Adhoc_Total) ,Sum(Adhoc_Chq) ,Sum(Adhoc_CSV) ,Sum(Adhoc_Trf) ,Sum(Sett_Total) ,Sum(Sett_Chq) ,Sum(Sett_CSV) ,Sum(Sett_Trf) ,Sum(Others) ,Sum(Total)   
From (Select    
Entry_Desc = 'Approved',   
Adhoc_Total = (Case When GenFlag = 'A' Then Count(*) Else 0 End),  
Adhoc_Chq = (Case When GenFlag = 'A' And HOPayMode in ('CHQ','DD') Then Count(*) Else 0 End),  
Adhoc_CSV = (Case When GenFlag = 'A' And HOPayMode = 'CSV' Then Count(*) Else 0 End),  
Adhoc_Trf = (Case When GenFlag = 'A' And HOPayMode = 'TL' Then Count(*) Else 0 End),    
Sett_Total = (Case When GenFlag = 'S' Then Count(*) Else 0 End),   
Sett_Chq = (Case When GenFlag = 'S' And HOPayMode in ('CHQ','DD') Then Count(*) Else 0 End),  
Sett_CSV = (Case When GenFlag = 'S' And HOPayMode = 'CSV' Then Count(*) Else 0 End),  
Sett_Trf = (Case When GenFlag = 'S' And HOPayMode = 'TL' Then Count(*) Else 0 End),    
Others = 0,  
Total = 0  
From SettPayout   
Where Left(Convert(Varchar,RequestDt,109),11) = @FDate  
And isnull(BranchCode,'') Like @BranchCode + '%'  
And isnull(BankCode,'') Like @BankCode + '%'  
And Status = 'A'  
Group By GenFlag, HOPayMode) A  
Group By Entry_Desc  
  
Insert Into #Payout_ControlSheet  
Select Entry_Desc , Sum(Adhoc_Total) ,Sum(Adhoc_Chq) ,Sum(Adhoc_CSV) ,Sum(Adhoc_Trf) ,Sum(Sett_Total) ,Sum(Sett_Chq) ,Sum(Sett_CSV) ,Sum(Sett_Trf) ,Sum(Others) ,Sum(Total)   
From (Select    
Entry_Desc = 'Posted',   
Adhoc_Total = (Case When GenFlag = 'A' Then Count(*) Else 0 End),  
Adhoc_Chq = (Case When GenFlag = 'A' And HOPayMode in ('CHQ','DD') Then Count(*) Else 0 End),  
Adhoc_CSV = (Case When GenFlag = 'A' And HOPayMode = 'CSV' Then Count(*) Else 0 End),  
Adhoc_Trf = (Case When GenFlag = 'A' And HOPayMode = 'TL' Then Count(*) Else 0 End),    
Sett_Total = (Case When GenFlag = 'S' Then Count(*) Else 0 End),   
Sett_Chq = (Case When GenFlag = 'S' And HOPayMode in ('CHQ','DD') Then Count(*) Else 0 End),  
Sett_CSV = (Case When GenFlag = 'S' And HOPayMode = 'CSV' Then Count(*) Else 0 End),  
Sett_Trf = (Case When GenFlag = 'S' And HOPayMode = 'TL' Then Count(*) Else 0 End),    
Others = 0,  
Total = 0  
From SettPayout S, Ledger L  
Where Left(Convert(Varchar,RequestDt,109),11) = @FDate  
And isnull(BranchCode,'') Like @BranchCode + '%'  
And isnull(BankCode,'') Like @BankCode + '%'  
And Status = 'A'  
And L.CltCode = S.CltCode  
And L.VTyp = 3  
And L.VNo = S.VNo  
Group By GenFlag, HOPayMode) A  
Group By Entry_Desc  
  
Insert Into #Payout_ControlSheet  
Select   
'Not Posted',  
A.Adhoc_Total - isnull(B.Adhoc_Total,0),  
A.Adhoc_Chq  - isnull(B.Adhoc_Chq,0),  
A.Adhoc_CSV  - isnull(B.Adhoc_CSV,0),  
A.Adhoc_Trf  - isnull(B.Adhoc_Trf,0),    
A.Sett_Total  - isnull(B.Sett_Total,0),   
A.Sett_Chq  - isnull(B.Sett_Chq,0),  
A.Sett_CSV  - isnull(B.Sett_CSV,0),  
A.Sett_Trf  - isnull(B.Sett_Trf,0),    
A.Others,  
A.Total   
From   
(Select * From #Payout_ControlSheet Where Entry_Desc = 'Approved') A   
Left Outer Join   
#Payout_ControlSheet B On B.Entry_Desc = 'Posted'  
  
Insert Into #Payout_ControlSheet  
Select Entry_Desc , Sum(Adhoc_Total) ,Sum(Adhoc_Chq) ,Sum(Adhoc_CSV) ,Sum(Adhoc_Trf) ,Sum(Sett_Total) ,Sum(Sett_Chq) ,Sum(Sett_CSV) ,Sum(Sett_Trf) ,Sum(Others) ,Sum(Total)   
From (Select    
Entry_Desc = 'Printed',   
Adhoc_Total = (Case When GenFlag = 'A' Then Count(*) Else 0 End),  
Adhoc_Chq = (Case When GenFlag = 'A' And HOPayMode in ('CHQ','DD') Then Count(*) Else 0 End),  
Adhoc_CSV = (Case When GenFlag = 'A' And HOPayMode = 'CSV' Then Count(*) Else 0 End),  
Adhoc_Trf = (Case When GenFlag = 'A' And HOPayMode = 'TL' Then Count(*) Else 0 End),    
Sett_Total = (Case When GenFlag = 'S' Then Count(*) Else 0 End),   
Sett_Chq = (Case When GenFlag = 'S' And HOPayMode in ('CHQ','DD') Then Count(*) Else 0 End),  
Sett_CSV = (Case When GenFlag = 'S' And HOPayMode = 'CSV' Then Count(*) Else 0 End),  
Sett_Trf = (Case When GenFlag = 'S' And HOPayMode = 'TL' Then Count(*) Else 0 End),    
Others = 0,  
Total = 0  
From SettPayout S, Ledger1 L  
Where Left(Convert(Varchar,RequestDt,109),11) = @FDate  
And isnull(BranchCode,'') Like @BranchCode + '%'  
And isnull(BankCode,'') Like @BankCode + '%'  
And Status = 'A'  
And L.VTyp = 3  
And L.VNo = S.VNo  
And L.ChqPrinted > 0   
Group By GenFlag, HOPayMode) A  
Group By Entry_Desc  
  
Insert Into #Payout_ControlSheet  
Select   
'Balance',  
A.Adhoc_Total - isnull(B.Adhoc_Total,0),  
A.Adhoc_Chq  - isnull(B.Adhoc_Chq,0),  
A.Adhoc_CSV  - isnull(B.Adhoc_CSV,0),  
A.Adhoc_Trf  - isnull(B.Adhoc_Trf,0),    
A.Sett_Total  - isnull(B.Sett_Total,0),   
A.Sett_Chq  - isnull(B.Sett_Chq,0),  
A.Sett_CSV  - isnull(B.Sett_CSV,0),  
A.Sett_Trf  - isnull(B.Sett_Trf,0),    
A.Others,  
A.Total   
From   
(Select * From #Payout_ControlSheet Where Entry_Desc = 'Posted') A   
Left Outer Join   
#Payout_ControlSheet B On B.Entry_Desc = 'Printed'  
  
Update #Payout_ControlSheet Set Total = Adhoc_Total + Sett_Total  
  
Select SNO,Entry_Desc,Adhoc_Total,Adhoc_Chq,Adhoc_CSV,Adhoc_Trf,Sett_Total,Sett_Chq,Sett_CSV,Sett_Trf,Total   
From #Payout_ControlSheet

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_RETURNFIELDS
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_RETURNFIELDS]      
 @STATUSID VARCHAR(20),      
 @SUMMARYOPT CHAR(1),      
 @REPORTNAME VARCHAR(15)  
  
AS      
      
DECLARE      
@@RETURNFIELDS AS VARCHAR(1000)      
      
 SELECT  
  RETURNFIELDS
 FROM      
   TBL_MASTER_PARTYLEDGER      
 WHERE      
   REPORTNAME = @REPORTNAME      
   AND STATUSID = @STATUSID      
   AND SUMMARYOPT = @SUMMARYOPT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_RETURNFIELDS_ALL
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_RETURNFIELDS_ALL]
/*
	EXEC RPT_RETURNFIELDS_ALL 'BROKER', 'S', 'PARTY', 'Y', 'N', 'Y', 'N', 'Y'
*/
	@STATUSID VARCHAR(10),
	@SUMMARYOPT VARCHAR(1),
	@RPTNAME VARCHAR(20),
	@NSE VARCHAR(1),
	@BSE VARCHAR(1),
	@NSEFO VARCHAR(1),
	@NCX VARCHAR(1),
	@MCX VARCHAR(1)
AS

DECLARE
	@@SQL AS VARCHAR(2000)

SET NOCOUNT ON

SELECT @@SQL = "SELECT RETURNFLDS = FIRSTPART "
IF @NSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "+ NSEPART "
	END
IF @BSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "+ BSEPART "
	END
IF @NSEFO = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "+ NSEFOPART "
	END
IF @NCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "+ NCXPART "
	END
IF @MCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "+ MCXPART "
	END

SELECT @@SQL = LTRIM(RTRIM(@@SQL))

SELECT @@SQL = @@SQL + " FROM TBL_MASTER_PARTYLEDGER_ALL "
SELECT @@SQL = @@SQL + "WHERE REPORTNAME = '" + @RPTNAME + "' "
SELECT @@SQL = @@SQL + "AND STATUSID = '" + @STATUSID + "' "
SELECT @@SQL = @@SQL + "AND SUMMARYOPT = '" + @SUMMARYOPT + "'"

--PRINT (@@SQL)
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_RETURNFIELDS_new
-- --------------------------------------------------
Create PROC [dbo].[RPT_RETURNFIELDS_new]      
 @STATUSID VARCHAR(20),      
 @SUMMARYOPT CHAR(1),      
 @REPORTNAME VARCHAR(15)  
  
AS      
      
DECLARE      
@@RETURNFIELDS AS VARCHAR(1000)      
      
 SELECT  
  RETURNFIELDS
 FROM      
   TBL_MASTER_PARTYLEDGER_new      
 WHERE      
   REPORTNAME = @REPORTNAME      
   AND STATUSID = @STATUSID      
   AND SUMMARYOPT = @SUMMARYOPT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_todaydate
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 06/24/2004 8:32:39 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 05/10/2004 5:29:46 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 01/14/2002 20:39:23 ******/  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 01/04/1980 1:40:42 AM ******/  
  
  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 11/28/2001 12:23:51 PM ******/  
  
  
  
  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 2/17/01 5:19:55 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 3/21/01 12:50:24 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 20-Mar-01 11:39:03 PM ******/  
  
  
  
CREATE PROCEDURE [dbo].[rpt_todaydate]  
AS  
select convert(varchar,getdate(),103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_todaydate1
-- --------------------------------------------------
Create Procedure [dbo].[Rpt_todaydate1]
As
Select Convert(varchar(11),getdate(),109)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_VoucherPrinting
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_VoucherPrinting    Script Date: 06/24/2004 8:32:37 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_VoucherPrinting    Script Date: 05/10/2004 5:29:41 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_VoucherPrinting    Script Date: 04/07/2003 12:28:25 PM ******/  
  
  
CREATE Proc [dbo].[rpt_VoucherPrinting]  
@Vtyp    varchar(2),  
@BookType    varchar(2),  
@FromDate   Varchar(11),  
@ToDate   Varchar(11),  
@VnoFrom   Varchar(12),  
@VnoTo   Varchar(12)  
  
as  
declare  
  
 @@selectqury   as varchar(8000),  
 @@fromtables   as varchar(2000),  
 @@wherepart    as varchar(8000),  
 @@sortby       as varchar(200)  
  
  
   if @VnoFrom <> '' and @VnoTo <> ''   
    begin   
      -- select @@wherepart = " where l.Vtyp = '" + @Vtyp + "'  and l.booktype = '" + @Booktype + "'  
     select @@wherepart = " where l.Vtyp = '" + @Vtyp + "'    
      and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'    
       and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "  
        
    end  
   else  
    begin  
      -- select @@wherepart = " where l.Vtyp = '" + @Vtyp + "'  and l.booktype = '" + @Booktype + "'  
     select @@wherepart = " where l.Vtyp = '" + @Vtyp + "'   
       and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "  
    end         
  
  
   if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'    
   begin  
    select @@wherepart = @@wherepart + "  and   cltcode <> '" + @Booktype + "'"   
  
   end  
   else  
   begin  
    select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"  
   end   
  
  
   select @@selectqury = " select distinct l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,  
   cltcode,  acname ,   
   isnull(l.Vamt,0) Vamt,  l.drcr,  l.vtyp, l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,  
     l.narration, cltcode2 = cltcode, acname2 = acname "  
  
   select @@fromtables = " from Ledger l left outer join ledger1 l1 on  l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "  
  
   select @@sortby = " order by l.vdt, l.vtyp, l.booktype, l.vno, l.drcr desc, l.lno desc "  
      
-- print  (@@selectqury + @@fromtables + @@wherepart + @@sortby )  
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_voucherreport
-- --------------------------------------------------
Create Procedure [dbo].[Rpt_voucherreport]
@Fromdt Varchar(15), 
@Todt Varchar(15), 
@Typ Int, 
@Vno Varchar(15)
As
If @Vno = '%'
Begin
If @Typ In ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
Begin
Select Distinct L.Cltcode, Ltrim(Rtrim(L.Acname)) As Acname , L.Vno, L.Vtyp, 
Left(Convert(Varchar, L.Vdt, 109), 11) As Vdt , L1.Ddno, 
Cramt = Case When L.Drcr = 'C' Then Vamt Else 0 End, 
Dramt = Case When L.Drcr = 'D' Then Vamt Else 0 End, 
Left(Convert(Varchar, L.Edt, 109), 11) As Edt, L.Lno
From Ledger L, Ledger1 L1
Where L.Vdt > = @Fromdt 
And L.Vdt < = @Todt+' 23:59:59' 
And L.Vtyp = @Typ 
And L1.Vtyp = L.Vtyp 
And L.Vno = L1.Vno
Order By L.Vtyp, L.Vno
End
If @Typ Not In ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
Begin
Select Distinct L.Cltcode, Ltrim(Rtrim(L.Acname)) As Acname , L.Vno, L.Vtyp, 
Left(Convert(Varchar, L.Vdt, 109), 11) As Vdt , Ddno = 0, 
Cramt = Case When L.Drcr = 'C' Then Vamt Else 0 End, 
Dramt = Case When L.Drcr = 'D' Then Vamt Else 0 End, 
Left(Convert(Varchar, L.Edt, 109), 11) As Edt, L.Lno
From Ledger L
Where L.Vdt > = @Fromdt 
And L.Vdt < = @Todt+' 23:59:59' 
And L.Vtyp = @Typ 
Order By L.Vtyp, L.Vno
End
End
If @Vno <> '%'
Begin
If @Typ In ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
Begin
Select Distinct L.Cltcode, Ltrim(Rtrim(L.Acname)) As Acname , L.Vno, L.Vtyp, 
Left(Convert(Varchar, L.Vdt, 109), 11) As Vdt , L1.Ddno, 
Cramt = Case When L.Drcr = 'C' Then Vamt Else 0 End, 
Dramt = Case When L.Drcr = 'D' Then Vamt Else 0 End, 
Left(Convert(Varchar, L.Edt, 109), 11) As Edt, L.Lno
From Ledger L, Ledger1 L1
Where L.Vdt > = @Fromdt 
And L.Vdt < = @Todt+' 23:59:59' 
And L.Vtyp = @Typ 
And L.Vno = @Vno 
And L1.Vtyp = L.Vtyp 
And L.Vno = L1.Vno
Order By L.Vtyp, L.Vno
End
If @Typ Not In ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
Begin
Select Distinct L.Cltcode, Ltrim(Rtrim(L.Acname)) As Acname , L.Vno, L.Vtyp, 
Left(Convert(Varchar, L.Vdt, 109), 11) As Vdt , Ddno = 0, 
Cramt = Case When L.Drcr = 'C' Then Vamt Else 0 End, 
Dramt = Case When L.Drcr = 'D' Then Vamt Else 0 End, 
Left(Convert(Varchar, L.Edt, 109), 11) As Edt, L.Lno
From Ledger L
Where L.Vdt > = @Fromdt 
And L.Vdt < = @Todt+' 23:59:59' 
And L.Vtyp = @Typ 
And L.Vno = @Vno 
Order By L.Vtyp, L.Vno
End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTCHQDETAILS_NEW_FP
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC [dbo].[SELECTCHQDETAILS_NEW_FP]

@VTYP 		VARCHAR(2),
@BOOKTYPE 	VARCHAR(2),
@FROMDATE 	VARCHAR(12),
@TODATE 	VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO 		VARCHAR(12),
@BANKCODE 	VARCHAR(12) ,
@BANKNAME      VARCHAR(50),
@VTYPE1 	VARCHAR(2),
@BRANCHCODE VARCHAR(12)

AS

DECLARE
@@SELECTQURY 	AS VARCHAR(8000),
@@FROMTABLES 	AS VARCHAR(2000),
@@WHEREPART  	AS VARCHAR(8000),
@@SORTBY     	AS VARCHAR(200)


IF @VNOFROM <> '' AND @VNOTO <> '' 
BEGIN 
    SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END
ELSE
BEGIN
    SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END							

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
BEGIN
    SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.CHQPRINTED=0 AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
    SELECT @@WHEREPART = @@WHEREPART + " AND  S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND HOPAYMODE='CHQ' AND L1.CHQPRINTED=0 AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND S.BRANCHCODE LIKE '" + @BRANCHCODE + "%' " 
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
    SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "
END 

IF @VTYPE1 = '98'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART
END

SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"

SELECT @@SORTBY = " ORDER BY L.VNO "

PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTCHQDETAILS_NEW_RP
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC [dbo].[SELECTCHQDETAILS_NEW_RP]

@VTYP 		VARCHAR(2),
@BOOKTYPE 	VARCHAR(2),
@FROMDATE 	VARCHAR(12),
@TODATE 	VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO 		VARCHAR(12),
@BANKCODE 	VARCHAR(12) ,
@BANKNAME      VARCHAR(50),
@VTYPE1	VARCHAR(2),
@BRANCHCODE VARCHAR(12)


AS

DECLARE
@@SELECTQURY 	AS VARCHAR(8000),
@@FROMTABLES 	AS VARCHAR(2000),
@@WHEREPART  	AS VARCHAR(8000),
@@SORTBY     	AS VARCHAR(200)


IF @VNOFROM <> '' AND @VNOTO <> '' 
BEGIN 
    SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END
ELSE
BEGIN
    SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END							

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
BEGIN
    SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
    SELECT @@WHEREPART = @@WHEREPART + " AND S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND S.HOPAYMODE='CHQ' AND L1.DDNO<>'0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND S.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L1.CHQPRINTED > 0 " 
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
    SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "
END 

IF @VTYPE1 = '98'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART
END

SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"
SELECT @@SORTBY = " ORDER BY L.VNO "

PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTCHQDETAILS_UPD
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC [dbo].[SELECTCHQDETAILS_UPD]

@VTYP 		VARCHAR(2),
@BOOKTYPE 	VARCHAR(2),
@FROMDATE 	VARCHAR(12),
@TODATE 	VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO 		VARCHAR(12),
@BANKCODE 	VARCHAR(12) ,
@BANKNAME      VARCHAR(50),
@VTYPE1	VARCHAR(2),
@BRANCHCODE VARCHAR(12)


AS

DECLARE
@@SELECTQURY 	AS VARCHAR(8000),
@@FROMTABLES 	AS VARCHAR(2000),
@@WHEREPART  	AS VARCHAR(8000),
@@SORTBY     	AS VARCHAR(200)


IF @VNOFROM <> '' AND @VNOTO <> '' 
BEGIN 
    SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END
ELSE
BEGIN
    SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END							

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
BEGIN
    SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO > '0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
    SELECT @@WHEREPART = @@WHEREPART + " AND S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND S.HOPAYMODE='CHQ'  AND L1.DDNO > '0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND S.BRANCHCODE LIKE '" + @BRANCHCODE + "%' " 
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
    SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO AND L1.DDNO > '0' AND L1.BNKNAME='" + @BANKNAME + "'"
END 

IF @VTYPE1 = '98'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART
END

SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"
SELECT @@SORTBY = " ORDER BY L.VNO "

PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTCSVDETAILS_NEW_FP
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SELECTCSVDETAILS_NEW_FP](
                @VTYP   VARCHAR(2),  
                @BOOKTYPE  VARCHAR(2),  
                @FROMDATE  VARCHAR(12),  
                @TODATE  VARCHAR(12),  
                @VNOFROM  VARCHAR(12),  
                @VNOTO   VARCHAR(12),  
                @BANKCODE  VARCHAR(12) ,  
                @BANKNAME      VARCHAR(50),
                @VTYPE1 	VARCHAR(2)
) 

AS  
    
  DECLARE  @@SELECTQURY  AS VARCHAR(8000),  
           @@FROMTABLES  AS VARCHAR(2000),  
           @@WHEREPART   AS VARCHAR(8000),  
           @@SORTBY      AS VARCHAR(200)  
    
     
  IF @VNOFROM <> '' AND @VNOTO <> ''   
  BEGIN   
     	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "  
  END  
  ELSE  
  BEGIN  
    	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "  
  END         
    
  SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.CHQPRINTED=0 AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, (SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "  
  SELECT @@WHEREPART = @@WHEREPART + " AND  S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND (S.HOPAYMODE = 'CSV' OR S.HOPAYMODE = 'DD' OR S.HOPAYMODE = 'TL') AND L1.CHQPRINTED=0 AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "'"   
    
  IF @VTYPE1 = '98'
  BEGIN
      SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
  END
  ELSE IF @VTYPE1 = '90'
  BEGIN
      SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
  END
  ELSE
  BEGIN
      SELECT @@WHEREPART = @@WHEREPART
  END
    
  SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,0) DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE , HOPAYMODE = (CASE S.HOPAYMODE WHEN 'CSV' THEN 'C' WHEN 'DD' THEN 'D' WHEN 'TL' THEN 'I' END) "  
  SELECT @@SORTBY = " ORDER BY L.VNO "  
        
  PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )   
  EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTCSVDETAILS_NEW_RP
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SELECTCSVDETAILS_NEW_RP](
                @VTYP 		VARCHAR(2),
                @BOOKTYPE 	VARCHAR(2),
                @FROMDATE 	VARCHAR(12),
                @TODATE 	VARCHAR(12),
                @VNOFROM 	VARCHAR(12),
                @VNOTO 		VARCHAR(12),
                @BANKCODE 	VARCHAR(12) ,
                @BANKNAME      VARCHAR(50),
                @VTYPE1 	VARCHAR(2)
)

AS

DECLARE   @@SELECTQURY 	AS VARCHAR(8000),
          @@FROMTABLES 	AS VARCHAR(2000),
          @@WHEREPART  	AS VARCHAR(8000),
          @@SORTBY     	AS VARCHAR(200)

 
  IF @VNOFROM <> '' AND @VNOTO <> '' 
  BEGIN 
  	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
  END
  ELSE
  BEGIN
  	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
  END							
  
  SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
  SELECT @@WHEREPART = @@WHEREPART + " AND S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND (S.HOPAYMODE = 'CSV' OR S.HOPAYMODE = 'DD' OR S.HOPAYMODE = 'TL') AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND CHQPRINTED > 0 " 
  
  IF @VTYPE1 = '98'
  BEGIN
      SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%' "
  END
  ELSE IF @VTYPE1 = '90'
  BEGIN
      SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%' "
  END
  ELSE
  BEGIN
    SELECT @@WHEREPART = @@WHEREPART
  END
  
  SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,0) DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE, HOPAYMODE = (CASE S.HOPAYMODE WHEN 'CSV' THEN 'C' WHEN 'DD' THEN 'D' WHEN 'TL' THEN 'I' END) "
  SELECT @@SORTBY = " ORDER BY L.VNO "
  				
  PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
  EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTDDDETAILS_NEW_FP
-- --------------------------------------------------
CREATE PROC [dbo].[SELECTDDDETAILS_NEW_FP]    
@VTYP   VARCHAR(2),  
@BOOKTYPE  VARCHAR(2),  
@FROMDATE  VARCHAR(12),  
@TODATE  VARCHAR(12),  
@VNOFROM  VARCHAR(12),  
@VNOTO   VARCHAR(12),  
@BANKCODE  VARCHAR(12) ,  
@BANKNAME      VARCHAR(50),
@VTYPE1 	VARCHAR(2),
@BRANCHCODE VARCHAR(12)

AS  
  
DECLARE  
@@SELECTQURY  AS VARCHAR(8000),  
@@FROMTABLES  AS VARCHAR(2000),  
@@WHEREPART   AS VARCHAR(8000),  
@@SORTBY      AS VARCHAR(200)  
  
   
IF @VNOFROM <> '' AND @VNOTO <> ''   
BEGIN   
   	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "  
END  
ELSE  
BEGIN  
  	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "  
END         
  
SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND (L1.DDNO='' OR L1.DDNO='0') AND L1.CHQPRINTED=0 AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, (SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "  
SELECT @@WHEREPART = @@WHEREPART + " AND  S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND HOPAYMODE='DD' AND (L1.DDNO='' OR L1.DDNO='0' ) AND L1.CHQPRINTED=0 AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND S.BRANCHCODE LIKE '" + @BRANCHCODE + "%' "    
  
IF @VTYPE1 = '98'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART
END

  
SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"  
SELECT @@SORTBY = " ORDER BY L.VNO "  
      
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )   
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTDDDETAILS_NEW_MAX
-- --------------------------------------------------
CREATE PROC [dbo].[SELECTDDDETAILS_NEW_MAX]          
@VTYP   VARCHAR(2),        
@BOOKTYPE  VARCHAR(2),        
@FROMDATE  VARCHAR(12),        
@TODATE  VARCHAR(12),        
@VNOFROM  VARCHAR(12),        
@VNOTO   VARCHAR(12),        
@BANKCODE  VARCHAR(12) ,        
@BANKNAME      VARCHAR(50)            
AS           
    
SELECT ISNULL(MAX(DDNO),'') DDNO    
FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP     
AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO    
AND L1.BNKNAME=@BANKNAME AND L.LNO = L1.LNO,     
(SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = @BANKCODE     
AND VTYP = '3' AND BOOKTYPE='01' AND VDT >= @FROMDATE + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59') T  WHERE  L.VTYP = '3'        
AND  L.VDT >= @FROMDATE + ' 00:00:00' AND L.VDT <= @TODATE + ' 23:59:59' AND  S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO     
AND HOPAYMODE='DD'    
AND L1.BNKNAME=@BANKNAME     
AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTDDDETAILS_NEW_RP
-- --------------------------------------------------
CREATE PROC [dbo].[SELECTDDDETAILS_NEW_RP]
@VTYP 		VARCHAR(2),
@BOOKTYPE 	VARCHAR(2),
@FROMDATE 	VARCHAR(12),
@TODATE 	VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO 		VARCHAR(12),
@BANKCODE 	VARCHAR(12) ,
@BANKNAME      VARCHAR(50),
@VTYPE1 	VARCHAR(2),
@BRANCHCODE VARCHAR(12)

AS

DECLARE
@@SELECTQURY 	AS VARCHAR(8000),
@@FROMTABLES 	AS VARCHAR(2000),
@@WHEREPART  	AS VARCHAR(8000),
@@SORTBY     	AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
BEGIN 
    SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END
ELSE
BEGIN
	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END							

SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'' AND L1.DDNO <> '0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
SELECT @@WHEREPART = @@WHEREPART + " AND S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND S.HOPAYMODE='DD' AND L1.DDNO<>'' AND L1.DDNO <> '0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND S.BRANCHCODE LIKE '" + @BRANCHCODE + "%' " 

IF @VTYPE1 = '98'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%' "
END
ELSE IF @VTYPE1 = '90'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%' "
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART
END


SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"
SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTDDDETAILS_UPD
-- --------------------------------------------------
CREATE PROC [dbo].[SELECTDDDETAILS_UPD]
@VTYP 		VARCHAR(2),
@BOOKTYPE 	VARCHAR(2),
@FROMDATE 	VARCHAR(12),
@TODATE 	VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO 		VARCHAR(12),
@BANKCODE 	VARCHAR(12) ,
@BANKNAME      VARCHAR(50),
@VTYPE1 	VARCHAR(2),
@BRANCHCODE VARCHAR(12)

AS

DECLARE
@@SELECTQURY 	AS VARCHAR(8000),
@@FROMTABLES 	AS VARCHAR(2000),
@@WHEREPART  	AS VARCHAR(8000),
@@SORTBY     	AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
BEGIN 
 	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END
ELSE
BEGIN
	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END							

SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'' AND L1.DDNO <>'0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
SELECT @@WHEREPART = @@WHEREPART + " AND S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND S.HOPAYMODE='DD'  AND L1.DDNO <> '' AND L1.DDNO <>'0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND S.BRANCHCODE LIKE '" + @BRANCHCODE + "%' " 

IF @VTYPE1 = '98'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART
END


SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"
SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTION_QUERIES_PROC
-- --------------------------------------------------
--EXEC SELECTION_QUERIES_PROC 'BROKER','%','REGION','%'
CREATE PROC [dbo].[SELECTION_QUERIES_PROC]
@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(10),
@SELECTON VARCHAR(15),
@SEARCH VARCHAR(10),
@FROMAC VARCHAR(10) = '0000000000',
@TOAC VARCHAR(10) = 'ZZZZZZZZZZ'
AS

DECLARE
@@SELECTIONQUERY AS VARCHAR(500),
@@FINALQUERY AS VARCHAR(500)

DECLARE CUR_SELECTION_PARAMETER CURSOR FOR
	SELECT 
		SELECTIONQUERY
	FROM
		SELECTION_QUERIES_TABLE
	WHERE
		STATUSID = @STATUSID
		AND SELECTON = @SELECTON		
        
        OPEN CUR_SELECTION_PARAMETER
        
        FETCH NEXT FROM CUR_SELECTION_PARAMETER
        INTO @@SELECTIONQUERY

WHILE @@FETCH_STATUS = 0        
BEGIN
	SELECT @@FINALQUERY = REPLACE(@@SELECTIONQUERY, 'STATUSNAME', '''' + @STATUSNAME + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'FROMAC', '''' + @FROMAC + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'TOAC', '''' + @TOAC + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'SEARCH', '''' + @SEARCH + '''')

	FETCH NEXT FROM CUR_SELECTION_PARAMETER
	INTO @@SELECTIONQUERY
END

CLOSE CUR_SELECTION_PARAMETER
DEALLOCATE CUR_SELECTION_PARAMETER

PRINT @@FINALQUERY
EXEC (@@FINALQUERY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTTRFDETAILS_NEW_FP
-- --------------------------------------------------
CREATE PROC [dbo].[SELECTTRFDETAILS_NEW_FP]    
@VTYP   VARCHAR(2),  
@BOOKTYPE  VARCHAR(2),  
@FROMDATE  VARCHAR(12),  
@TODATE  VARCHAR(12),  
@VNOFROM  VARCHAR(12),  
@VNOTO   VARCHAR(12),  
@BANKCODE  VARCHAR(12) ,  
@BANKNAME      VARCHAR(50),
@VTYPE1 	VARCHAR(2)
AS  
  
DECLARE  
@@SELECTQURY  AS VARCHAR(8000),  
@@FROMTABLES  AS VARCHAR(2000),  
@@WHEREPART   AS VARCHAR(8000),  
@@SORTBY      AS VARCHAR(200)  
  
   
IF @VNOFROM <> '' AND @VNOTO <> ''   
BEGIN   
   	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "  
END  
ELSE  
BEGIN  
  	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "  
END         
  
SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND (L1.DDNO='' OR L1.DDNO='0') AND L1.CHQPRINTED=0 AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, (SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "  
SELECT @@WHEREPART = @@WHEREPART + " AND  S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND HOPAYMODE='TL' AND (L1.DDNO='' OR L1.DDNO='0') AND L1.CHQPRINTED=0 AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "'"   
  
IF @VTYPE1 = '98'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART
END
  
SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,0) DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), MICRNO, L.BOOKTYPE "  
  
SELECT @@SORTBY = " ORDER BY L.VNO "  
      
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )   
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTTRFDETAILS_NEW_MAX
-- --------------------------------------------------
CREATE PROC [dbo].[SELECTTRFDETAILS_NEW_MAX]        
@VTYP   VARCHAR(2),      
@BOOKTYPE  VARCHAR(2),      
@FROMDATE  VARCHAR(12),      
@TODATE  VARCHAR(12),      
@VNOFROM  VARCHAR(12),      
@VNOTO   VARCHAR(12),      
@BANKCODE  VARCHAR(12) ,      
@BANKNAME      VARCHAR(50)          
AS         
  
SELECT ISNULL(MAX(DDNO),0) DDNO  
FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP   
AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO  
AND L1.BNKNAME=@BANKNAME AND L.LNO = L1.LNO,   
(SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = @BANKCODE   
AND VTYP = '3' AND VDT >= @FROMDATE + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59') T  WHERE  L.VTYP = '3'      
AND  L.VDT >= @FROMDATE + ' 00:00:00' AND L.VDT <= @TODATE + ' 23:59:59' AND  S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO   
AND HOPAYMODE='TL'  
AND L1.BNKNAME=@BANKNAME   
AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTTRFDETAILS_NEW_RP
-- --------------------------------------------------
CREATE PROC [dbo].[SELECTTRFDETAILS_NEW_RP]
@VTYP 		VARCHAR(2),
@BOOKTYPE 	VARCHAR(2),
@FROMDATE 	VARCHAR(12),
@TODATE 	VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO 		VARCHAR(12),
@BANKCODE 	VARCHAR(12) ,
@BANKNAME      VARCHAR(50),
@VTYPE1 	VARCHAR(2)
AS

DECLARE
@@SELECTQURY 	AS VARCHAR(8000),
@@FROMTABLES 	AS VARCHAR(2000),
@@WHEREPART  	AS VARCHAR(8000),
@@SORTBY     	AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
BEGIN 
	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END
ELSE
BEGIN
	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END							

SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'' AND L1.DDNO<>'0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
SELECT @@WHEREPART = @@WHEREPART + " AND S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND S.HOPAYMODE='TL' AND L1.DDNO<>'' AND L1.DDNO<>'0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "'" 

IF @VTYPE1 = '98'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART
END

SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,0) DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"
SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTTRFDETAILS_UPD
-- --------------------------------------------------
CREATE PROC [dbo].[SELECTTRFDETAILS_UPD]
@VTYP 		VARCHAR(2),
@BOOKTYPE 	VARCHAR(2),
@FROMDATE 	VARCHAR(12),
@TODATE 	VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO 		VARCHAR(12),
@BANKCODE 	VARCHAR(12) ,
@BANKNAME      VARCHAR(50),
@VTYPE1 	VARCHAR(2)
AS

DECLARE
@@SELECTQURY 	AS VARCHAR(8000),
@@FROMTABLES 	AS VARCHAR(2000),
@@WHEREPART  	AS VARCHAR(8000),
@@SORTBY     	AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
BEGIN 
 	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END
ELSE
BEGIN
	SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
END							

SELECT @@FROMTABLES = " FROM SETTPAYOUT S, LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'' AND L1.DDNO<>'0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
SELECT @@WHEREPART = @@WHEREPART + " AND S.CLTCODE=L.CLTCODE AND S.VNO=L.VNO AND S.HOPAYMODE='TL'  AND L1.DDNO <> '' AND L1.DDNO<>'0' AND L1.BNKNAME='" + @BANKNAME + "' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "'" 

IF @VTYPE1 = '98'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
    SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
    SELECT @@WHEREPART = @@WHEREPART
END

SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,0) DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), MICRNO, L.BOOKTYPE "
SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 06/24/2004 8:32:35 PM ******/  
  
/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 05/10/2004 5:29:35 PM ******/  
/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/  
CREATE Proc [dbo].[SelectVoucherDetails] 
@Vtyp   varchar(2),  
@BookType  varchar(2),  
@FromDate  varchar(12),  
@Todate  varchar(12),  
@VnoFrom  varchar(12),  
@VnoTo   varchar(12),  
@BankCode  varchar(12)   
  
as  
  
Declare  
@@selectqury  as varchar(8000),  
@@fromtables  as varchar(2000),  
@@wherepart   as varchar(8000),  
@@sortby      as varchar(200)  
  
   
if @VnoFrom <> '' and @VnoTo <> ''   
   begin   
   select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'    
  and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'    
   and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "  
   end  
else  
   begin  
  select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'    
 and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "  
   end         
  
if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'    
   begin  
 select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' 
and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "  
 select @@wherepart = @@wherepart + " and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  cltcode <> '" + @BankCode + "'"   
   end  
else  
   begin  
 select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'" 
 select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "  
   end   
  
select @@wherepart = @@wherepart   
  
select @@selectqury = " select distinct l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno 
  
and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype   
and party_code = cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"  
  
select @@sortby = " order by l.vno "  
      
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby )   
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTVOUCHERDETAILS_NEW
-- --------------------------------------------------
--SELECT * FROM COSTMAST
--Exec SELECTVOUCHERDETAILS_NEW  19 , '01  ' , 'aPR  1 2006' , 'Feb  1 2007' , '0'  , '999' , 'BANK01', 'BRANCH', 'tr001'
--Exec SELECTVOUCHERDETAILS_NEW  19 , '01  ' , 'aPR  1 2006' , 'Feb  1 2007' , '0'  , '999' , 'BANK01', 'BRANCH', 'al001'

CREATE PROC [dbo].[SELECTVOUCHERDETAILS_NEW]
@VTYP INT,
@BOOKTYPE VARCHAR(2),
@FROMDATE VARCHAR(12),
@TODATE VARCHAR(12),
@VNOFROM VARCHAR(12),
@VNOTO VARCHAR(12),
@BANKCODE VARCHAR(10),
@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(10)

AS

DECLARE 
@@COSTCODE INT

IF (@VTYP <> 19 AND @VTYP <> 20)
BEGIN
	IF UPPER(@STATUSID) = 'BROKER'
	BEGIN
		SELECT 
			L.VNO, DD, DDNO, VAMT, DRCR = L.DRCR, CLTCODE = L.CLTCODE, ACNAME = L.ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), MICRNO, L.BOOKTYPE
		FROM 
			LEDGER L, 
			(SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,
			LEDGER1 L1
		WHERE 
			L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> @BANKCODE
			AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE 
	END
	ELSE
	BEGIN
		SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME
		SELECT 
			L.VNO, DD, DDNO, VAMT = CAMT, DRCR = L.DRCR, CLTCODE = L.CLTCODE, ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), A.MICRNO, L.BOOKTYPE
		FROM 
			LEDGER2 L, 
			(SELECT VNO, VTYP, BOOKTYPE, NARRATION FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,
			LEDGER1 L1,
			ACMAST A
		WHERE 
			A.CLTCODE = L.CLTCODE
			AND L.VNO = L2.VNO AND L.VTYPE = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> @BANKCODE
			AND L.VNO = L1.VNO AND L.VTYPE = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND COSTCODE = @@COSTCODE
	END
END  
ELSE
BEGIN
	IF @STATUSID = 'BROKER'
	BEGIN
		SELECT 
			L.VNO, DD, DDNO, VAMT = AMOUNT, DRCR = L.DRCR, CLTCODE = L.PARTY_CODE, ACNAME = A.ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), A.MICRNO, L.BOOKTYPE
		FROM 
			MARGINLEDGER L, 
			(SELECT VNO, VTYP, BOOKTYPE, NARRATION FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,
			LEDGER1 L1,
			ACMAST A
		WHERE 
			L.PARTY_CODE = A.CLTCODE			
			AND L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE 
			AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE 
	END
	ELSE
	BEGIN
		SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME
		SELECT 
			ML.VNO, DD, DDNO, VAMT = AMOUNT, DRCR = ML.DRCR, CLTCODE = ML.PARTY_CODE, ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), A.MICRNO, L.BOOKTYPE
		FROM 
			MARGINLEDGER ML,
			LEDGER2 L, 
			(SELECT VNO, VTYP, BOOKTYPE, NARRATION FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,
			LEDGER1 L1,
			ACMAST A
		WHERE 
			A.CLTCODE = ML.PARTY_CODE
			AND ML.VNO = L2.VNO AND ML.VTYP = L2.VTYP AND ML.BOOKTYPE = L2.BOOKTYPE
			AND L.VNO = L2.VNO AND L.VTYPE = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> @BANKCODE
			AND L.VNO = L1.VNO AND L.VTYPE = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND COSTCODE = @@COSTCODE
	END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails_New_FP
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.SelectVoucherDetails_New_FP    Script Date: 10/20/2005 12:19:54 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_New_FP    Script Date: 08/29/2005 5:57:25 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
CREATE Proc [dbo].[SelectVoucherDetails_New_FP]

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) ,
@BankName      varchar(50),
@Vtype1 	varchar(2),
@BranchCode varchar(12)


as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
		and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'  
		 and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
	and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno /*and l1.ddno='0' */and l1.chqprinted=0 and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	select @@wherepart = @@wherepart + " /*and l1.ddno='0' */and l1.chqprinted=0 and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  l.cltcode <> '" + @BankCode + "' and dd = 'C' " 
--	select @@wherepart = @@wherepart + "  and l1.ddno=0 "
--	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "
   end 

if @vtype1 = '98'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Settno%'  "
end
else if @vtype1 = '90'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Adhoc Payout%'  "
end
else
begin
  select @@wherepart = @@wherepart
end

select @@selectqury = " select distinct l1.dddt,l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno 
and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype 
and party_code = l.cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails_New_RP
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.SelectVoucherDetails_New_RP    Script Date: 10/20/2005 12:19:54 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_New_RP    Script Date: 08/29/2005 5:57:26 PM ******/


/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
CREATE Proc [dbo].[SelectVoucherDetails_New_RP]

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) ,
@BankName      varchar(50),
@vtype1	varchar(2),
@BranchCode varchar(12)


as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
		and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'  
		 and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
	and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l1.ddno<>'0' and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	select @@wherepart = @@wherepart + " and l1.ddno<>'0' and l1.chqprinted > 0 and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  l.cltcode <> '" + @BankCode + "' and dd = 'C' " 
--	select @@wherepart = @@wherepart + "  and l1.ddno=0 "
--	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "
   end 

if @vtype1 = '98'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Settno%'  "
end
else if @vtype1 = '90'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Adhoc Payout%'  "
end
else
begin
  select @@wherepart = @@wherepart
end

select @@selectqury = " select distinct l1.dddt,l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno 
and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype 
and party_code = l.cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails_Upd
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.SelectVoucherDetails_Upd    Script Date: 10/20/2005 12:19:54 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_Upd    Script Date: 08/29/2005 5:57:26 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
CREATE Proc [dbo].[SelectVoucherDetails_Upd]

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) ,
@BankName      varchar(50),
@vtype1	varchar(2),
@BranchCode varchar(12),
@newprintflag varchar(2)


as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
		and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'  
		 and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
	and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l1.ddno>'0' and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	if @newprintflag = 'FP'
		select @@wherepart = @@wherepart + " and l1.chqprinted = 0 "
	if @newprintflag = 'RP'
		select @@wherepart = @@wherepart + " and l1.chqprinted > 0 "
	select @@wherepart = @@wherepart + " and l1.ddno>'0' and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  l.cltcode <> '" + @BankCode + "' and dd = 'C' " 
--	select @@wherepart = @@wherepart + "  and l1.ddno=0 "
--	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno and l1.ddno>'0' "
   end 

if @vtype1 = '98'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Settno%'  "
end
else if @vtype1 = '90'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Adhoc Payout%'  "
end
else
begin
  select @@wherepart = @@wherepart
end

select @@selectqury = " select distinct l1.dddt,l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno 
and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype 
and party_code = l.cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SETCONSTRAINTS
-- --------------------------------------------------
CREATE PROC [dbo].[SETCONSTRAINTS]
AS
/*---------------------------------------RULES AND CONSTRAINTS FOR LEDGER--------------------------------------------*/
DECLARE @@OBJ AS INT
	SELECT @@OBJ = ID FROM SYSOBJECTS WHERE NAME = 'LEDGER'
IF @@OBJ <> 0
	BEGIN
		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VTYP_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_VTYP_SL] CHECK (VTYP IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VTYP_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_ZERO_VTYP_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_ZERO_VTYP_SL] CHECK (VTYP <> 0)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_ZERO_VTYP_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VNO_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_VNO_SL] CHECK (VNO IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VNO_SL ALREADY EXISTS'
			END


		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VNO_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_VNO_SL] CHECK (LTRIM(RTRIM(VNO)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VNO_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_EDT_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_EDT_SL] CHECK (EDT IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_EDT_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_EDT_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_EDT_SL] CHECK (EDT <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_EDT_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_ACNAME_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_ACNAME_SL] CHECK (ACNAME IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_ACNAME_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_ACNAME_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_ACNAME_SL] CHECK (LTRIM(RTRIM(ACNAME)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_ACNAME_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_DRCR_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_DRCR_SL] CHECK (LTRIM(RTRIM(DRCR)) = 'D' OR LTRIM(RTRIM(DRCR)) = 'C')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_DRCR_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VDT_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_VDT_SL] CHECK (VDT IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VDT_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VDT_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_VDT_SL] CHECK (VDT <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VDT_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_CLTCODE_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_CLTCODE_SL] CHECK (CLTCODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_CLTCODE_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_CLTCODE_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_CLTCODE_SL] CHECK (LTRIM(RTRIM(CLTCODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_CLTCODE_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_BOOKTYPE_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_BOOKTYPE_SL] CHECK (BOOKTYPE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_BOOKTYPE_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_BOOKTYPE_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_BOOKTYPE_SL] CHECK (LTRIM(RTRIM(BOOKTYPE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_BOOKTYPE_SL ALREADY EXISTS'
			END
	END
/*---------------------------------------RULES AND CONSTRAINTS FOR MARGIN LEDGER--------------------------------------------*/
	SELECT @@OBJ = 0
	SELECT @@OBJ = ID FROM SYSOBJECTS WHERE NAME = 'MARGINLEDGER'
IF @@OBJ <> 0
	BEGIN
		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VTYP_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_VTYP_ML] CHECK (VTYP IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VTYP_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VTYP_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_VTYP_ML] CHECK (VTYP <> 0)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VTYP_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VNO_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_VNO_ML] CHECK (VNO IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VNO_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VNO_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_VNO_ML] CHECK (LTRIM(RTRIM(VNO)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VNO_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_DRCR_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_DRCR_ML] CHECK (LTRIM(RTRIM(DRCR)) = 'D' OR LTRIM(RTRIM(DRCR)) = 'C')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_DRCR_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VDT_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_VDT_ML] CHECK (VDT IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VDT_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VDT_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_VDT_ML] CHECK (VDT <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VDT_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_PARTYCODE_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_PARTYCODE_ML] CHECK (PARTY_CODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_PARTYCODE_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_PARTYCODE_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_PARTYCODE_ML] CHECK (LTRIM(RTRIM(PARTY_CODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_PARTYCODE_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_BOOKTYPE_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_BOOKTYPE_ML] CHECK (BOOKTYPE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_BOOKTYPE_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_BOOKTYPE_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_BOOKTYPE_ML] CHECK (LTRIM(RTRIM(BOOKTYPE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_BOOKTYPE_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_MCLTCODE_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_MCLTCODE_ML] CHECK (MCLTCODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_MCLTCODE_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_MCLTCODE_SL')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_MCLTCODE_SL] CHECK (LTRIM(RTRIM(MCLTCODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_MCLTCODE_SL ALREADY EXISTS'
			END

	END

/*---------------------------------------RULES AND CONSTRAINTS FOR LEDGER1--------------------------------------------*/

	SELECT @@OBJ = 0
	SELECT @@OBJ = ID FROM SYSOBJECTS WHERE NAME = 'LEDGER1'
IF @@OBJ <> 0
	BEGIN
		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VTYP_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NOT_NULL_VTYP_L1] CHECK (VTYP IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VTYP_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_ZERO_VTYP_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NON_ZERO_VTYP_L1] CHECK (VTYP <> 0)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_ZERO_VTYP_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VNO_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NOT_NULL_VNO_L1] CHECK (VNO IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VNO_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VNO_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NON_BLANK_VNO_L1] CHECK (LTRIM(RTRIM(VNO)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VNO_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_DRCR_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NON_BLANK_DRCR_L1] CHECK (LTRIM(RTRIM(DRCR)) = 'D' OR LTRIM(RTRIM(DRCR)) = 'C')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_DRCR_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_BOOKTYPE_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NOT_NULL_BOOKTYPE_L1] CHECK (BOOKTYPE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_BOOKTYPE_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_BOOKTYPE_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NON_BLANK_BOOKTYPE_L1] CHECK (LTRIM(RTRIM(BOOKTYPE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_BOOKTYPE_L1 ALREADY EXISTS'
			END

	END

/*---------------------------------------RULES AND CONSTRAINTS FOR ACMAST--------------------------------------------*/

	SELECT @@OBJ = 0
	SELECT @@OBJ = ID FROM SYSOBJECTS WHERE NAME = 'ACMAST'
IF @@OBJ <> 0
	BEGIN
		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_ACNAME_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_ACNAME_AM] CHECK (ACNAME IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_ACNAME_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_ACNAME_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_ACNAME_AM] CHECK (LTRIM(RTRIM(ACNAME)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_ACNAME_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_LONGNAME_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_LONGNAME_AM] CHECK (LONGNAME IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_LONGNAME_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_LONGNAME_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_LONGNAME_AM] CHECK (LTRIM(RTRIM(LONGNAME)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_LONGNAME_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_ACTYP_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_ACTYP_AM] CHECK (ACTYP IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_ACTYP_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_ACTYP_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_ACTYP_AM] CHECK (LTRIM(RTRIM(ACTYP)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_ACTYP_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_ACCAT_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_ACCAT_AM] CHECK (ACCAT IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_ACCAT_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_ACCAT_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_ACCAT_AM] CHECK (LTRIM(RTRIM(ACCAT)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_ACCAT_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_CLTCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_CLTCODE_AM] CHECK (CLTCODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_CLTCODE_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_CLTCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_CLTCODE_AM] CHECK (LTRIM(RTRIM(CLTCODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_CLTCODE_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_GRPCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_GRPCODE_AM] CHECK (GRPCODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_GRPCODE_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_GRPCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_GRPCODE_AM] CHECK (LTRIM(RTRIM(GRPCODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_GRPCODE_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_BRANCHCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_BRANCHCODE_AM] CHECK (BRANCHCODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_BRANCHCODE_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_BRANCHCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_BRANCHCODE_AM] CHECK (LTRIM(RTRIM(BRANCHCODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_BRANCHCODE_AM ALREADY EXISTS'
			END

	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP
-- --------------------------------------------------
CREATE PROC SP @spName VARCHAR(25)AS             
Select * from sysobjects where name Like '%' + @spName + '%' and xtype='P' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_Addbranch_Execute
-- --------------------------------------------------
  /****** Object:  Stored Procedure Dbo.Sp_Addbranch_Execute    Script Date: 01/15/2005 4:39:22 Pm ******/  
  
  
/****** Object:  Stored Procedure Dbo.Sp_Addbranch_Execute    Script Date: 12/16/2003 2:21:39 Pm ******/  
  
  
Create Proc [dbo].[Sp_Addbranch_Execute]  
@Strsql Varchar(8000)  
As  
 Print @Strsql  
 Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_Addclient_Execute
-- --------------------------------------------------
 /****** Object:  Stored Procedure Dbo.Sp_Addclient_Execute    Script Date: 01/15/2005 4:39:23 Pm ******/  
  
  
/****** Object:  Stored Procedure Dbo.Sp_Addclient_Execute    Script Date: 12/16/2003 2:21:39 Pm ******/  
  
Create Proc [dbo].[Sp_Addclient_Execute]  
@Strsql Varchar(8000)  
As  
 Print @Strsql  
 Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddEditScrip_Execute
-- --------------------------------------------------
-- Alter this sp under SRE-34143
CREATE PROC [dbo].[sp_AddEditScrip_Execute]    
@strSQL VarChar(8000)    
AS  
SET NOCOUNT ON;
 --Print @strSQL    
 Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_EXTEND_BILL_FINANCIAL_BSE
-- --------------------------------------------------
CREATE PROC [dbo].[SP_EXTEND_BILL_FINANCIAL_BSE]
	@SETT_NO VARCHAR(7), 
	@SETT_TYPE VARCHAR(2), 
	@VDT VARCHAR(11), 
	@EDT VARCHAR(11)

AS

	DECLARE
		@@NNEWVNO AS VARCHAR(12), 
		@@NOLDVNO AS VARCHAR(12), 
		@@INEWVNO AS VARCHAR(12), 
		@@IOLDVNO AS VARCHAR(12), 
		@@VNOFLAG AS SMALLINT, 
		@@COUNTER AS INT, 
		@@OLDVDT AS VARCHAR(12), 
		@@OLDEDT AS VARCHAR(12),
		@@STRCURDATE AS DATETIME,
		@@LDTCURDATE AS DATETIME, 
		@@OBJID AS INT,
		@@OBJID1 AS INT



IF CONVERT(DATETIME, @EDT) <= 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'EFFECTIVE DATE IS LESSER THAN APR 1 2007. CANNOT CONTINUE...'
		RETURN
	END



SELECT @@NOLDVNO = ''
SELECT @@IOLDVNO = ''

SELECT 
	TOP 1 @@NOLDVNO = VNO, 
	@@OLDVDT = CONVERT(VARCHAR(11), VDT, 109), 
	@@OLDEDT = CONVERT(VARCHAR(11), EDT, 109)
FROM 
	LEDGER 
WHERE 
	VTYP = 15 
	AND NARRATION LIKE 'SETTNO=' + LTRIM(RTRIM(@SETT_NO)) + 'BSECM' + LTRIM(RTRIM(@SETT_TYPE)) + '%'
	AND BOOKTYPE = '01'

SELECT 
	TOP 1 @@IOLDVNO = VNO 
FROM 
	LEDGER 
WHERE 
	VTYP = 21 
	AND NARRATION LIKE 'SETTNO=' + LTRIM(RTRIM(@SETT_NO)) + 'BSECM' + LTRIM(RTRIM(@SETT_TYPE)) + '%' 
	AND BOOKTYPE = '01'

IF @@NOLDVNO = '' AND @@IOLDVNO = ''
	BEGIN
		SELECT 'NO BILLS FOUND FOR SELECTED SETTLEMENT'
		RETURN
	END

IF CONVERT(DATETIME, @@OLDVDT) > 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'VOUCHER DATE ALREADY FALLS IN NEXT FINANCIAL YEAR'
		RETURN
	END
IF CONVERT(DATETIME, @@OLDEDT) <= 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'EFFECTIVE DATE ALREADY FALLS IN PREVIOUS FINANCIAL YEAR'
		RETURN
	END

SELECT 
	@@VNOFLAG = VNOFLAG,
	@@STRCURDATE = SDTCUR,
	@@LDTCURDATE = LDTCUR
FROM
	PARAMETER
WHERE
	@VDT BETWEEN SDTCUR AND LDTCUR


IF @@VNOFLAG = 0
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = '200700000001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = '200700000001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END
	END
ELSE IF @@VNOFLAG = 1
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2) + right('00'+ltrim(convert(varchar,day(@VDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2) + right('00'+ltrim(convert(varchar,day(@VDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END

	END
ELSE IF @@VNOFLAG = 2
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = '200704000001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = '200704010001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END
		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END


		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END
	END

SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)
SELECT @@OBJID1 = ISNULL(OBJECT_ID('BILLPOSTED'), 0)


IF @@NOLDVNO <> ''
	BEGIN
		BEGIN TRAN		
		INSERT INTO LEDGER_JRNL SELECT VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION, UPDDATE = GETDATE() FROM LEDGER WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER SET VNO = @@NNEWVNO, VDT = @VDT, EDT = @EDT WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER1 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER2 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER3 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE BILLMATCH SET VNO = @@NNEWVNO, [DATE] = @VDT WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
		IF @@OBJID > 0
			BEGIN
				UPDATE BFBILLMATCH SET VNO = @@NNEWVNO, [DATE] = @VDT WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
			END
		IF @@OBJID1 > 0
			BEGIN
				UPDATE BILLPOSTED SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
			END
		INSERT INTO BILL_SHIFT_LOG (SETT_NO, SETT_TYPE, GEN_VNO, VTYP, BOOKTYPE, UPDDATE) VALUES (@SETT_NO, @SETT_TYPE, @@NNEWVNO, 15, '01', GETDATE())
		COMMIT TRAN

	END
IF @@IOLDVNO <> ''
	BEGIN
		BEGIN TRAN
		INSERT INTO LEDGER_JRNL SELECT VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION, UPDDATE = GETDATE() FROM LEDGER WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER SET VNO = @@INEWVNO, VDT = @VDT, EDT = @EDT WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER1 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER2 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER3 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE BILLMATCH SET VNO = @@INEWVNO, [DATE] = @VDT WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
		IF @@OBJID > 0
			BEGIN
				UPDATE BFBILLMATCH SET VNO = @@INEWVNO, [DATE] = @VDT WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
			END
		IF @@OBJID1 > 0
			BEGIN
				UPDATE BILLPOSTED SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
			END
		INSERT INTO BILL_SHIFT_LOG (SETT_NO, SETT_TYPE, GEN_VNO, VTYP, BOOKTYPE, UPDDATE) VALUES (@SETT_NO, @SETT_TYPE, @@INEWVNO, 21, '01', GETDATE())
		COMMIT TRAN
	END

SELECT 'BILL SUCCESSFULLY POSTED IN NEXT FINANCIAL YEAR WITH VNO : ' + @@NNEWVNO + ' [15] AND ' + @@INEWVNO + ' [21]'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_EXTEND_BILL_FINANCIAL_NSE
-- --------------------------------------------------
CREATE PROC [dbo].[SP_EXTEND_BILL_FINANCIAL_NSE]
	@SETT_NO VARCHAR(7), 
	@SETT_TYPE VARCHAR(2), 
	@VDT VARCHAR(11), 
	@EDT VARCHAR(11)

AS

	DECLARE
		@@NNEWVNO AS VARCHAR(12), 
		@@NOLDVNO AS VARCHAR(12), 
		@@INEWVNO AS VARCHAR(12), 
		@@IOLDVNO AS VARCHAR(12), 
		@@VNOFLAG AS SMALLINT, 
		@@COUNTER AS INT, 
		@@OLDVDT AS VARCHAR(12), 
		@@OLDEDT AS VARCHAR(12),
		@@STRCURDATE AS DATETIME,
		@@LDTCURDATE AS DATETIME, 
		@@OBJID AS INT,
		@@OBJID1 AS INT



IF CONVERT(DATETIME, @EDT) <= 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'EFFECTIVE DATE IS LESSER THAN APR 1 2007. CANNOT CONTINUE...'
		RETURN
	END



SELECT @@NOLDVNO = ''
SELECT @@IOLDVNO = ''

SELECT 
	TOP 1 @@NOLDVNO = VNO, 
	@@OLDVDT = CONVERT(VARCHAR(11), VDT, 109), 
	@@OLDEDT = CONVERT(VARCHAR(11), EDT, 109)
FROM 
	LEDGER 
WHERE 
	VTYP = 15 
	AND NARRATION LIKE 'SETTNO=' + LTRIM(RTRIM(@SETT_NO)) + 'NSECM' + LTRIM(RTRIM(@SETT_TYPE)) + '%'
	AND BOOKTYPE = '01'

SELECT 
	TOP 1 @@IOLDVNO = VNO 
FROM 
	LEDGER 
WHERE 
	VTYP = 21 
	AND NARRATION LIKE 'SETTNO=' + LTRIM(RTRIM(@SETT_NO)) + 'NSECM' + LTRIM(RTRIM(@SETT_TYPE)) + '%' 
	AND BOOKTYPE = '01'

IF @@NOLDVNO = '' AND @@IOLDVNO = ''
	BEGIN
		SELECT 'NO BILLS FOUND FOR SELECTED SETTLEMENT'
		RETURN
	END

IF CONVERT(DATETIME, @@OLDVDT) > 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'VOUCHER DATE ALREADY FALLS IN NEXT FINANCIAL YEAR'
		RETURN
	END
IF CONVERT(DATETIME, @@OLDEDT) <= 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'EFFECTIVE DATE ALREADY FALLS IN PREVIOUS FINANCIAL YEAR'
		RETURN
	END

SELECT 
	@@VNOFLAG = VNOFLAG,
	@@STRCURDATE = SDTCUR,
	@@LDTCURDATE = LDTCUR
FROM
	PARAMETER
WHERE
	@VDT BETWEEN SDTCUR AND LDTCUR


IF @@VNOFLAG = 0
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = '200700000001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = '200700000001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END
	END
ELSE IF @@VNOFLAG = 1
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2) + right('00'+ltrim(convert(varchar,day(@VDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2) + right('00'+ltrim(convert(varchar,day(@VDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END

	END
ELSE IF @@VNOFLAG = 2
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = '200704000001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = '200704010001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END
		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END


		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END
	END

SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)
SELECT @@OBJID1 = ISNULL(OBJECT_ID('BILLPOSTED'), 0)


IF @@NOLDVNO <> ''
	BEGIN
		BEGIN TRAN		
		INSERT INTO LEDGER_JRNL SELECT VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION, UPDDATE = GETDATE() FROM LEDGER WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER SET VNO = @@NNEWVNO, VDT = @VDT, EDT = @EDT WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER1 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER2 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER3 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE BILLMATCH SET VNO = @@NNEWVNO, [DATE] = @VDT WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
		IF @@OBJID > 0
			BEGIN
				UPDATE BFBILLMATCH SET VNO = @@NNEWVNO, [DATE] = @VDT WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
			END
		IF @@OBJID1 > 0
			BEGIN
				UPDATE BILLPOSTED SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
			END
		INSERT INTO BILL_SHIFT_LOG (SETT_NO, SETT_TYPE, GEN_VNO, VTYP, BOOKTYPE, UPDDATE) VALUES (@SETT_NO, @SETT_TYPE, @@NNEWVNO, 15, '01', GETDATE())
		COMMIT TRAN

	END
IF @@IOLDVNO <> ''
	BEGIN
		BEGIN TRAN
		INSERT INTO LEDGER_JRNL SELECT VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION, UPDDATE = GETDATE() FROM LEDGER WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER SET VNO = @@INEWVNO, VDT = @VDT, EDT = @EDT WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER1 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER2 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER3 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE BILLMATCH SET VNO = @@INEWVNO, [DATE] = @VDT WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
		IF @@OBJID > 0
			BEGIN
				UPDATE BFBILLMATCH SET VNO = @@INEWVNO, [DATE] = @VDT WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
			END
		IF @@OBJID1 > 0
			BEGIN
				UPDATE BILLPOSTED SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
			END
		INSERT INTO BILL_SHIFT_LOG (SETT_NO, SETT_TYPE, GEN_VNO, VTYP, BOOKTYPE, UPDDATE) VALUES (@SETT_NO, @SETT_TYPE, @@INEWVNO, 21, '01', GETDATE())
		COMMIT TRAN
	END

SELECT 'BILL SUCCESSFULLY POSTED IN NEXT FINANCIAL YEAR WITH VNO : ' + @@NNEWVNO + ' [15] AND ' + @@INEWVNO + ' [21]'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_LEDGER_SB_PRN1
-- --------------------------------------------------
create PROCEDURE SP_LEDGER_SB_PRN1(@fdate as varchar(11),@Tdate as varchar(11),@sbcode as varchar(11),@with_opnbal as varchar(1))                 
AS                
                
SET NOCOUNT ON                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
/*            
Exec SP_LEDGER_SB_PRN1 'Apr  1 2006','Jan 19 2007','ZC','Y'         
declare @fdate as varchar(11),@Tdate as varchar(11),@sbcode as varchar(11),@with_opnbal as varchar(1)                
set @fdate='Apr  1 2006'                
set @tdate='Dec 31 2006'                
set @sbcode='ZC'                
set @with_opnbal = 'Y'                
*/            
/*            
declare @fdate as varchar(11),@Tdate as varchar(11),@fcode as varchar(11),@Tcode as varchar(11),@MVNO AS VARCHAR(15),@with_opnbal as varchar(1)                
set @fdate='Dec  1 2004'                
set @tdate='Nov 30 2005'                
set @fcode='28000001'                
set @tcode='28999999'                
set @with_opnbal = 'N'                
*/            
    
select *,flag=' ' into #ledgera  from Intranet.risk.dbo.ledger_format                   
                
if @with_opnbal='Y'                 
begin                
 insert into #ledgera                
 select coname='FAS',cltcode,acname=space(200),vdt=@fdate,vtyp='18',shortdesc='OPENEN',    
 vno=replace(convert(varchar(10),convert(datetime,@fdate),102),'.','')+'0000',    
 narration='Opening Balance',                
 Debit=case when     
 sum(case when drcr='D' then vamt else -vamt end) > 0 then sum(case when drcr='D' then vamt else -vamt end) else 0 end,                
 Credit=case when     
 sum(case when drcr='C' then vamt else -vamt end) > 0 then sum(case when drcr='C' then vamt else -vamt end) else 0 end,Flag='Y'      
 from ledger a (nolock)    
 where vdt >= (select sdtcur from parameter where sdtcur<= @fdate and ldtcur >= @fdate+' 23:59:59')    
 and vdt < @fdate+' 00:00:00'                
 and cltcode in (select distinct cltcode from acmast)--(select pcode from Temp_CLI_BSE)       
 group by cltcode    

end    
    
 insert into #ledgera                
 select coname='FAS',cltcode,substring(acname,1,200),vdt,vtyp,shortdesc,vno,substring(a.narration,1,200),               
 Debit=(case when drcr='D' then vamt else 0 end),                
 Credit=(case when drcr='C' then vamt else 0 end),Flag='Y'from ledger a (nolock),               
 (select vtype,shortdesc from dbo.vmast ) b                 
 where a.vtyp=b.vtype and vdt >=@fdate+' 00:00:00' and vdt < @tdate+' 23:59:59'                
 and cltcode in (select distinct cltcode from acmast)---(select pcode from Temp_CLI_BSE)       
      
 update #ledgera set flag='N' where vdt < @fdate         
     
 delete from #ledgera where flag='N'      
 update #ledgera set acname = b.acname from acmast b (nolock) where #ledgera.cltcode=b.cltcode    
            
--update #ledgera set acname = b.long_name from client_Details b                 
--where b.party_Code=#ledgera.cltcode             
            
update #ledgera set cltcode=ltrim(rtrim(cltcode))            
update #ledgera set acname=ltrim(rtrim(acname))            
--update #ledgera set acname=substring(acname,1,40)+replicate(char(255),(40-len(Acname)))            
update #ledgera set acname=substring(acname,1,40)+replicate(' ',(40-len(Acname)))            
        
        
            
select *,tdt=convert(varchar(11),vdt,103) from #ledgera where debit+credit <> 0             
order by cltcode,coname,vno                
                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_voucherreport
-- --------------------------------------------------
CREATE     Procedure [dbo].[Sp_voucherreport]
(  
 @Reptype Varchar(3),   
 @Fromdate Varchar(11),   
 @Todate Varchar(11),   
 @Frombankcode Varchar(10),   
 @Tobankcode Varchar(10),   
 @Fromclientid Varchar(10),   
 @Toclientid Varchar(10),   
 @Statusid Varchar(12),   
 @Statusname Varchar(12),   
 @Datetype varchar(6),  
 @VamtFr varchar(20),  
 @VamtTo varchar(20),  
 @Chqno  varchar(15),  
 @PageSize varchar(3),  
 @VnoFr varchar(12),  
 @VnoTo varchar(12)  
)  
As
Declare @Strsql As Varchar(1000)  



If  @Statusid = 'broker'  
Begin  

 If @Reptype = '16'  
    Begin  
           --Cheque Is Cancelled.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, " +   
    " A.Drcr, A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A" +   
    " Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 16 And Drcr = 'D' "   
    If  @Frombankcode <> ''   
    Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = ' " + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"  
    End  
      
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
    " Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
    " Where A.Vno <> '' And A.Vtyp = 16 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + "' And A.Vdt < = '" + @Todate + " 23:59:59'" --test   
    If @Chqno <> ''    
    Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
    End  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
     If @Fromclientid <> ''  
      Begin  
       Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
      End  
    /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration Order By A.Vno, A.Vdt, A.Drcr Desc " */  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc "   
    End   
  
  Else If @Reptype = '17'   
    Begin  
  --  ****  Cheque Is Returned.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     " A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A " +  
     " Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 17 And Drcr = 'C' "   
     If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End   
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     " Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     " Where A.Vno <> '' And A.Vtyp = 17 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00'" +  
     " And A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End  
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End    
    If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration " +  
      "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  
    Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
  
    End  
  Else If @Reptype = '19'   
    Begin  
  --  **** Margin Bank Received.  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +  
     "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 19 And A.Vdt > = '" + @Fromdate + " 00:00:00'" +  
     " And A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End   
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End    
    If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"       
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
  /*  Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, C.Ddno, C.Dddt, Ledger.Narration" */     End  
  
  Else If @Reptype = '8'   
    Begin  
  --  **** Journal Voucher.  

    Set @Strsql = "select   A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +   
     "a.Vamt, A.Narration From Ledger A Where A.Vno <> '' And A.Vtyp = 8  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
       
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End    
     /*if(@Frombankcode <> "")   
      --@Strsql = @Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If*/  
      
     If @Fromclientid <>  ''  
      Begin  
       Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
    /* Set @Strsql = @Strsql + " Group By  A.Vtyp,  A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
    "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "
  End  

  Else If @Reptype = '300'   
    Begin  
  --  **** DP Charges Voucher.  

    Set @Strsql = "select   A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +   
     "a.Vamt, A.Narration From Acccommon.dbo.Ledger A Where A.Vno <> '' And A.Vtyp = 300  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
       
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End    
     /*if(@Frombankcode <> "")   
      --@Strsql = @Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If*/  
      
     If @Fromclientid <>  ''  
      Begin  
       Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
    /* Set @Strsql = @Strsql + " Group By  A.Vtyp,  A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
    "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "
  End  	
  
  Else If @Reptype = '6'   
    Begin  
  --  **** Debit Note.  
    Set @Strsql = "select   A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vtyp = 6  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''    
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
     If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End  
      
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '7'   
    Begin  
  --  **** Credit Note.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vtyp = 7  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
    If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"  
     End  
      
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '5'   
    Begin  
  --  **** Contra Entry.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vtyp = 5 " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End  
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
   If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
   If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End  
      
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '20'   
    Begin  
  --  **** Margin Bank Repayment.  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +  
     "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And " +  
     "ledger.Booktype = A.Booktype Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And " +  
     "a.Booktype = C.Booktype Inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 20 "  
    If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End  
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
    If @Frombankcode <> ''   
    Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"       
     End  
     If @Fromclientid <> ''  
     Begin   
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
    Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr,   
     C.Ddno,  C.Dddt, Ledger.Narration"  
    End  
  
  Else If @Reptype = '22'    
    Begin  
  --  **** Margin Cash Received.    
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 22 "  
       
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
    End  
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End    
     If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
    End  
    If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
    End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration"*/  
    End  
  
  Else If @Reptype = '23'   
    Begin  
  --  **** Margin Cash Repayment.  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 23 "  
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End    
    If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration"*/  
    End  
  
  Else If @Reptype = '24'      
    Begin  
  --  **** Margin Journal Entries.(Vtyp = 24)  
      
    Set @Strsql = "select  A.Vtyp, A.Party_code  Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Drcr, " +  
     " A.Amount Vamt, C.Narration From Marginledger A Inner Join Ledger C On A.Vno = C.Vno And A.Vtyp = C.Vtyp " +  
     "and A.Booktype = C.Booktype Inner Join Acmast B On  A.Party_code = B.Cltcode " +  
     "where A.Vno <> ''  And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
    /*if(Trim(Strbankcode) <> "")   
      'Strsql = Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If */  
      
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "') "   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Party_code, A.Vno, A.Vdt, B.Acname, A.Drcr, A.Amount, C.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + "order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '3'   
  --  **** Payment Bank.  
    Begin  
       IF @datetype ='Voudt'  
   Begin  
     Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname,   
        A.Drcr, A.Vamt, " +  "convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration , D.CLTCODE as ctl     
       From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, " +  
      "booktype From Ledger Where Vtyp = 3 And Drcr = 'C' "   
       
      If @Frombankcode <> ''   
      Begin  
       Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
      End  
     
      Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Inner Join " +  
      "ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype Where A.Vno <> '' " +  
      "and A.Vtyp = 3 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
    
      If @Fromclientid <> ''  
      Begin  
       Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
      End  
     if @Chqno <> ''    
      Begin  
       Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
      End     
     If @VamtFr <> '' or @VamtTo <> ''   
      Begin  
          Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
        End   
     If @VnoFr <> '' or @VnoTo <> ''   
         Begin  
              Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
            End    
     Set @Strsql = @Strsql + " /* Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,   
        C.Dddt, A.Narration, D.Cltcode */ Order By A.Vno, A.Vdt, A.Drcr Desc "  
        End  
      else if  @datetype ='EntDt'  
       Begin   
       Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Pdt, 109) Pdt, A.Acname,   
       A.Drcr, A.Vamt, " +  "convert(Varchar(11), C.Dddt, 109) cdt, A.Narration , D.CLTCODE as ct     
       From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, " +  
"booktype From Ledger Where Vtyp = 3 And Drcr = 'C' "   
       If @VamtFr <> '' or @VamtTo <> ''   
       Begin  
        Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
       End    
       If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End     
       If @Frombankcode <> ''   
       Begin  
       Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
       End  
     
      Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Inner Join " +  
      "ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype Where A.Vno <> '' " +  
      "and A.Vtyp = 3 And A.Drcr = 'D' And A.Pdt > = '" + @Fromdate + " 00:00:00' And A.Pdt < = '" + @Todate + " 23:59:59' "  
    
      If @Fromclientid <> ''  
      Begin  
       Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
      End  
      Set @Strsql = @Strsql + "/* Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Pdt, A.Acname, A.Drcr, A.Vamt,   
      C.Dddt, A.Narration, D.Cltcode */ Order By A.Vno, A.Pdt, A.Drcr Desc "  
    End  
  End  
  
  Else If @Reptype = '4'   
    Begin  
  --  **** Payment Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 4 And Drcr = 'C' "  
     If @Frombankcode <> ''   
     Begin   
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Where A.Vno <> '' And A.Vtyp = 4 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
       
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + "order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  Else If @Reptype =  '2'   
    Begin  
  --  **** Receipt Bank.  
     IF @datetype ='Voudt'  
     Begin  
     Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration , D.CLTCODE as ctl   From Ledger A Inner Join " +  
     "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' And A.Vtyp = 2 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Vdt < = '" + @Todate + " 23:59:59' "   
     if @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
        Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "' And '" + @VnoTo + "' "  
     End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    Set @Strsql = @Strsql + "/* Group By C.Ddno, A.Vtyp, A.Cltcode ,A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration , D.CLTCODE */ Order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  Else If @datetype='Entdt'  
   Begin    
    Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Pdt, 109) Pdt, A.Acname, A.Drcr, " +  
     "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration ,D.Cltcode as ct From Ledger A Inner Join " +  
     "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' And A.Vtyp = 2 And A.Drcr = 'C' And A.Pdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Pdt < = '" + @Todate + " 23:59:59' "  
     If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    Set @Strsql = @Strsql + "/* Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Pdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration , D.CLTCODE */ Order By A.Vno, A.Pdt, A.Drcr Desc "  
   End  
  End  
  
  Else If @Reptype = '1'   
    Begin  
  --  **** Receipt Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 1 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Where A.Vno <> '' " +  
     "and A.Vtyp = 1 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
      
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
    If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
     
   --else Raiserror ('50001 : No Voucher Type Found', 0, 13)  
   End  
  End

--New  
--Else 
Else if @Statusid ='Subbroker'  
	If @Reptype = '8'   
	Begin  
  --  **** Journal Voucher.  
		Set @Strsql = "select   A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
		 "a.Vamt, A.Narration From Ledger A , Subbrokers S, Client1 C Where A.Vno <> '' And A.Vtyp = 8  " + 
		 "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  +
		 "and A.cltcode= C.Cl_Code and C.sub_broker = '" + @StatusName + "'  "  
       
		If @VamtFr <> '' or @VamtTo <> ''   
		 Begin  
		  Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
		 End   
		If @VnoFr <> '' or @VnoTo <> ''   
		 Begin  
		  Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
		 End    

		Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
	 End
  
   Else If @Reptype =  '300'
	Begin  
  --  **** DP Charges Voucher.  
		Set @Strsql = "select   A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
		 "a.Vamt, A.Narration From Acccommon.dbo.Ledger A , DBCOMMON.dbo.Subbrokers S, DBCOMMON.dbo.Client1 C Where A.Vno <> '' And A.Vtyp = 8  " + 
		 "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  +
		 "and A.cltcode= C.Cl_Code and C.sub_broker = '" + @StatusName + "'  "  
       
		If @VamtFr <> '' or @VamtTo <> ''   
		 Begin  
		  Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
		 End   
		If @VnoFr <> '' or @VnoTo <> ''   
		 Begin  
		  Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
		 End    

		Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
	 End  	

   Else If @Reptype =  '2'   
    Begin  
  --  **** Receipt Bank.  
     IF @datetype ='Voudt'  
     Begin  
     Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration , D.CLTCODE as ctl From Subbrokers S, Client1 C1 ,Ledger A Inner Join " +  
     "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "  
	 
	 If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "' And A.Vtyp = 2 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Vdt < = '" + @Todate + " 23:59:59' "   
     if @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
        Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "' And '" + @VnoTo + "' "  
     End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode ,A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration , D.CLTCODE  Order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  Else If @datetype='Entdt'  
   Begin    
    Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Pdt, 109) Pdt, A.Acname, A.Drcr, " +  
     "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration ,D.Cltcode as ct From Subbrokers S, Client1 C1 ,Ledger A Inner Join " +  
     "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "' And A.Vtyp = 2 And A.Drcr = 'C' And A.Pdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Pdt < = '" + @Todate + " 23:59:59' "  
     If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Pdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration , D.CLTCODE  Order By A.Vno, A.Pdt, A.Drcr Desc "  
   End  
  End  

 Else If @Reptype = '16'   
    Begin  
  --  **** When Cheque Is Cancelled.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, " +  
     "a.Drcr, A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Subbrokers S, Client1 C1 , Ledger A " +  
     "inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 16 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"  
     End  
      
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker = '" + @Statusname + "' And A.Vtyp = 16 And A.Drcr = 'C' " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End    
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
   If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
   If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
    Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration  " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc "   
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '17'   
    Begin  
  --  **** When Cheque Is Returned.(Vtyp = 17)  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     "A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Subbrokers S, Client1 C1 , Ledger A " +  
     "Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 17 And Drcr = 'C' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End    
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
   If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End   
  If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype  " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype  " +  
     "where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "' And A.Vtyp = 17 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
    Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc "   
  Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
    End  
  
  Else If @Reptype = '19'   
    Begin  
  --  **** Margin Bank Received.(Vtyp = 19)  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +  
     "from Subbrokers S, Client1 C1 , Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype  " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "' and A.Vtyp = 19 And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End      
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
     Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End  
    If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
    Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, C.Ddno, C.Dddt, Ledger.Narration"  
      
    End  

 Else If @Reptype = '6'   
    Begin  
  --  **** Debit Note.(Vtyp = 6)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Subbrokers S, Client1 C1 , Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "'  and A.Vtyp = 6  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End     
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Frombankcode <> ''      Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"       
     End  
      
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid +"' ) "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '7'  
    Begin   
  --  **** Credit Note.(Vtyp = 7)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Subbrokers S, Client1 C1 , Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "'  and A.Vtyp = 7   " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Frombankcode <> ''  
     Begin   
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End   
      
     If @Fromclientid <> ''   
    Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '5'   
    Begin  
  --  **** Contra Entry. (Vtyp = 5)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Subbrokers S, Client1 C1 , Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "' and A.Vtyp = 5 " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End  
      
     If @Fromclientid <> ''   
     Begin   
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
     
    End  
  
  Else If @Reptype = '20'   
   Begin  
 --  **** Margin Bank Repayment. (Vtyp = 20)  
   Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
    "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt  " +  
    "from Subbrokers S, Client1 C1 , Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And " +  
    "ledger.Booktype = A.Booktype Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And " +  
    "a.Booktype = C.Booktype Inner Join Acmast B On A.Party_code = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "' and A.Vtyp = 20 "  
    If @Chqno <> ''    
    Begin  
     Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
    End    
   If @VamtFr <> '' or @VamtTo <> ''   
    Begin  
     Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
    End   
   If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End   
    If (@Frombankcode <> "")   
    Begin  
     Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "' )"  
    End  
    If @Fromclientid <> ''  
    Begin  
     Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
    End  
    
  /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, " +  
    "c.Ddno,  C.Dddt, Ledger.Narration" */  
   End  
  
  Else If @Reptype = '22'   
    Begin  
  --  **** Margin Cash Received.(Vtyp = 22)    
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Subbrokers S, Client1 C1 , Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "' and A.Vtyp = 22 "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
    If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration" */  
      
    End    
  
  Else If @Reptype = '23'   
    Begin  
  --  **** Margin Cash Repayment.  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Subbrokers S, Client1 C1 , Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "'  and A.Vtyp = 23 "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration" */  
    End  
  
  Else If @Reptype = '24'      
    Begin  
  --  **** Margin Journal Entries.(Vtyp = 24)  
      
    Set @Strsql = "select  A.Vtyp, A.Party_code  Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Drcr, "+  
     " A.Amount Vamt, C.Narration From Subbrokers S, Client1 C1 , Marginledger A Inner Join Ledger C On A.Vno = C.Vno And A.Vtyp = C.Vtyp " +  
     "and A.Booktype = C.Booktype Inner Join Acmast B On  A.Party_code = B.Cltcode And A.Booktype = B.Booktype " +  
     "where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
     /*if(Trim(Strbankcode) <> "")   
      'Strsql = Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If */  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End   
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Party_code, A.Vno, A.Vdt, B.Acname, A.Drcr, A.Amount, C.Narration  " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '3'   
    Begin  
  --  **** Payment Bank.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration, D.CLTCODE as ctl From Subbrokers S, Client1 C1 ,Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, " +  
     "booktype From Ledger Where Vtyp = 3 And Drcr = 'C' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
       
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode Inner Join Ledger1 C On A.Vno = C.Vno " +  
     "and A.Vtyp = C.Vtyp And A.Booktype = C.Booktype Where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "'" +  
     "and A.Vtyp = 3 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
        Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
      End   
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, " +  
       "c.Dddt, A.Narration,D.Cltcode Order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '4'   
    Begin  
  --  **** Payment Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "from Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Subbrokers S, Client1 C1 ,Ledger Where Vtyp = 4 And Drcr = 'C' "  
     If @Frombankcode <> ''   
  Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End   
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "'" +  
     "and A.Vtyp = 4 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''    
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End   
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
   End  
 
   Else If @Reptype = '1'   
    Begin  
  --  **** Receipt Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From Subbrokers S, Client1 C1 , Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype from Ledger Where Vtyp = 1 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     " Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "'" +  
     " And A.Vtyp = 1 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
  -----else Raiserror ('50001 : No Voucher Type Found For Branch.', 0, 13)  
   End  


        

--New */


else if  @Statusid ='Branch' 
 Begin  
 -- **** Branch Login.  
  If @Reptype = '16'   
    Begin  
  --  **** When Cheque Is Cancelled.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, " +  
     "a.Drcr, A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A " +  
     "inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 16 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"  
     End  
      
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vtyp = 16 And A.Drcr = 'C' " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End    
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
   If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
   If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration  " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '17'   
    Begin  
  --  **** When Cheque Is Returned.(Vtyp = 17)  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     "A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A " +  
     "Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 17 And Drcr = 'C' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End    
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
   If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End   
  If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype  " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype  " +  
     "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vtyp = 17 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
    End  
  
  Else If @Reptype = '19'   
    Begin  
  --  **** Margin Bank Received.(Vtyp = 19)  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +  
     "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype  " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 19 And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End      
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
     Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End  
    If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, C.Ddno, C.Dddt, Ledger.Narration"*/  
      
    End  
  
  Else If @Reptype = '8'   
    Begin  
  --  **** Journal Voucher.(Vtyp = 8)  
    Set @Strsql = "select   A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +   
     "a.Vamt, A.Narration From Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' " +  
     "and B.Branchcode = '" + @Statusname + "' And A.Vtyp = 8  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
      If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End    
     /*if(@Frombankcode <> "")   
      --@Strsql = @Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If*/  
      
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp,  A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + "order By A.Vno, A.Vdt, A.Drcr Desc "  
  
    End  
  
Else If @Reptype = '300'   
    Begin  
  --  **** DP Charges.(Vtyp = 300)  
    Set @Strsql = "select   A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +   
     "a.Vamt, A.Narration From Acccommon.dbo.Ledger A Inner Join Acccommon.dbo.Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' " +  
     "and B.Branchcode = '" + @Statusname + "' And A.Vtyp = 8  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
      If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End    
     /*if(@Frombankcode <> "")   
      --@Strsql = @Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If*/  
      
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp,  A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + "order By A.Vno, A.Vdt, A.Drcr Desc "  
  
    End  
  
  Else If @Reptype = '6'   
    Begin  
  --  **** Debit Note.(Vtyp = 6)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 6  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End     
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Frombankcode <> ''      Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"       
     End  
      
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid +"' ) "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '7'  
    Begin   
  --  **** Credit Note.(Vtyp = 7)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 7   " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Frombankcode <> ''  
     Begin   
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End   
      
     If @Fromclientid <> ''   
    Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '5'   
    Begin  
  --  **** Contra Entry. (Vtyp = 5)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 5 " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End  
      
     If @Fromclientid <> ''   
     Begin   
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
     
    End  
  
  Else If @Reptype = '20'   
   Begin  
 --  **** Margin Bank Repayment. (Vtyp = 20)  
   Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
    "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt  " +  
    "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And " +  
    "ledger.Booktype = A.Booktype Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And " +  
    "a.Booktype = C.Booktype Inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 20 "  
    If @Chqno <> ''    
    Begin  
     Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
    End    
   If @VamtFr <> '' or @VamtTo <> ''   
    Begin  
     Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
    End   
   If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End   
    If (@Frombankcode <> "")   
    Begin  
     Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "' )"  
    End  
    If @Fromclientid <> ''  
    Begin  
     Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
    End  
    
  /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, " +  
    "c.Ddno,  C.Dddt, Ledger.Narration" */  
   End  
  
  Else If @Reptype = '22'   
    Begin  
  --  **** Margin Cash Received.(Vtyp = 22)    
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 22 "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
    If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration" */  
      
    End    
  
  Else If @Reptype = '23'   
    Begin  
  --  **** Margin Cash Repayment.  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 23 "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration" */  
    End  
  
  Else If @Reptype = '24'      
    Begin  
  --  **** Margin Journal Entries.(Vtyp = 24)  
      
    Set @Strsql = "select  A.Vtyp, A.Party_code  Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Drcr, "+  
     " A.Amount Vamt, C.Narration From Marginledger A Inner Join Ledger C On A.Vno = C.Vno And A.Vtyp = C.Vtyp " +  
     "and A.Booktype = C.Booktype Inner Join Acmast B On  A.Party_code = B.Cltcode And A.Booktype = B.Booktype " +  
     "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
     /*if(Trim(Strbankcode) <> "")   
      'Strsql = Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If */  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End   
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Party_code, A.Vno, A.Vdt, B.Acname, A.Drcr, A.Amount, C.Narration  " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '3'   
    Begin  
  --  **** Payment Bank.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration, D.CLTCODE as ctl From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, " +  
     "booktype From Ledger Where Vtyp = 3 And Drcr = 'C' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
       
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode Inner Join Ledger1 C On A.Vno = C.Vno " +  
     "and A.Vtyp = C.Vtyp And A.Booktype = C.Booktype Where A.Vno <> '' And B.Branchcode = '" + @Statusname + "'" +  
     "and A.Vtyp = 3 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
        Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
      End   
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, " +  
       "c.Dddt, A.Narration,D.Cltcode Order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '4'   
    Begin  
  --  **** Payment Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "from Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 4 And Drcr = 'C' "  
     If @Frombankcode <> ''   
  Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End   
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' And B.Branchcode = '" + @Statusname + "'" +  
     "and A.Vtyp = 4 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''    
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End   
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
    End  
  
  Else If @Reptype = '2'   
    Begin  
  --  **** Receipt Bank.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration, D.CLTCODE as ctl From Ledger A Inner Join " +  
     "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "' )"  
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vtyp = 2 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End    
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
    If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
        Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration,D.Cltcode Order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '1'   
    Begin  
  --  **** Receipt Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 1 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     " Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' And B.Branchcode = '" + @Statusname + "'" +  
     " And A.Vtyp = 1 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
  -----else Raiserror ('50001 : No Voucher Type Found For Branch.', 0, 13)  
   End  
End  
  
Print @Strsql  
Execute ( @Strsql )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_VOUCHERREPORT_NEW
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.SP_VOUCHERREPORT_NEW    Script Date: 9/17/2007 10:25:06 AM ******/

/****** RECREATED BY BHARAT ON SEP 11 2007 ******/ 
/****** Execute SP_VOUCHERREPORT_NEW '2','Sep 1 2006', 'Sep 1 2007','','ZZZZZZZZZZZZ', '','ZZZZZZZZZZZZ','broker', 'broker','VOUDT','', '','','','' ****/

CREATE     PROCEDURE [dbo].[SP_VOUCHERREPORT_NEW]  
(  
 @VNOTYPE VARCHAR(2),   
 @FROMDATE VARCHAR(11),   
 @TODATE VARCHAR(11),   
 @FROMBANKCD VARCHAR(10),   
 @TOBANKCD VARCHAR(10),   
 @FROMCLIENTID VARCHAR(10),   
 @TOCLIENTID VARCHAR(10),   
 @STATUSID VARCHAR(12),   
 @STATUSNAME VARCHAR(12),   
 @DATETYPE VARCHAR(6),  
 @FROMVAMT VARCHAR(20),  
 @TOVAMT VARCHAR(20),  
 @CHQNUM  VARCHAR(15),  
 @FROMVNO VARCHAR(12),  
 @TOVNO VARCHAR(12)  
)  
AS
DECLARE @@SQL AS VARCHAR(1000)

PRINT UPPER(@STATUSID)

IF UPPER(@STATUSID) = 'BROKER'
BEGIN


	IF @VNOTYPE = '1' OR @VNOTYPE = '4'
	-- RECEIPT CASH   OR PAYMENT CASH
 	BEGIN

		SET @@SQL =" "
		SET @@SQL = @@SQL + " SELECT L.VTYP, L.CLTCODE, L.VNO, CONVERT(VARCHAR(11),L.VDT,109) VDT,L.ACNAME, L.DRCR, L.VAMT, L.NARRATION "
		SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN "
		SET @@SQL = @@SQL + " (SELECT VNO, CLTCODE ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = " + @VNOTYPE + " AND "
				      
				      IF @VNOTYPE = '1'
				      BEGIN 	 			
					SET @@SQL = @@SQL + " DRCR = 'D' "
				      END	
				      ELSE IF @VNOTYPE = '4'
				      BEGIN	  
					SET @@SQL = @@SQL + " DRCR = 'C' "	
				      END	
					
				      IF @FROMBANKCD <> ''
				      BEGIN
				      	SET @@SQL = @@SQL + " AND (CLTCODE > = '" + @FROMBANKCD + "' AND CLTCODE < = '" + @TOBANKCD + "') " 
				      END

		SET @@SQL = @@SQL + " ) D ON L.VNO = D.VNO AND L.VTYP = D.VTYP AND L.BOOKTYPE = D.BOOKTYPE "
		SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " AND "
		
		IF @VNOTYPE = '1'
		BEGIN
		SET @@SQL = @@SQL + " L.DRCR = 'C' " 
		END
		ELSE IF @VNOTYPE = '4'
		BEGIN
		SET @@SQL = @@SQL + " L.DRCR = 'D' " 
		END	
			
		SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' " 
		
		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN	
		SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "
		END

		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 
		
		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END

		SET @@SQL = @@SQL + " ORDER BY L.VNO, L.VDT, L.DRCR DESC " 
	END
	
	ELSE IF @VNOTYPE = '2' OR @VNOTYPE = '3' OR @VNOTYPE = '5' OR @VNOTYPE = '16' OR @VNOTYPE = '17'  
	     -- RECEIPT BANK   OR PAYMENT BANK   OR CONTRY ENTRY   OR CHEQUE CANCEL   OR CHEQUE RETURN
	BEGIN
		SET @@SQL = " "
		SET @@SQL = @@SQL + " SELECT L1.DDNO, L.VTYP, L.CLTCODE, L.VNO, L.ACNAME, L.DRCR, L.VAMT, L.NARRATION, "
		
		IF UPPER(@DATETYPE) = 'VOUDT'
		BEGIN	
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L.VDT,109) VDT, "
		END
		ELSE 
		BEGIN
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L.PDT,109) PDT, "
		END

		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L1.DDDT,109) CDT, L.CLTCODE AS ctl FROM LEDGER L INNER JOIN "
		SET @@SQL = @@SQL + " (SELECT VNO, CLTCODE ACNAME, VTYP, BOOKTYPE, LNO FROM LEDGER WHERE VTYP = " + @VNOTYPE + " "
				      IF @VNOTYPE = '2' OR @VNOTYPE = '16'  
				      BEGIN 	 			
					SET @@SQL = @@SQL + " AND DRCR = 'D' "
				      END	
				      ELSE IF @VNOTYPE = '3' OR @VNOTYPE = '17'
				      BEGIN	  
					SET @@SQL = @@SQL + " AND DRCR = 'C' "	
				      END	
				      
				      IF @FROMBANKCD <> ''
				      BEGIN
				      	SET @@SQL = @@SQL + " AND (CLTCODE > = '" + @FROMBANKCD + "' AND CLTCODE < = '" + @TOBANKCD + "') " 
				      END

		SET @@SQL = @@SQL + " ) D ON L.VNO = D.VNO AND L.VTYP = D.VTYP AND L.BOOKTYPE = D.BOOKTYPE "
		
		IF @VNOTYPE = '5'
		BEGIN	
		SET @@SQL = @@SQL + " AND L.LNO = D.LNO " 	
		END	
		SET @@SQL = @@SQL + " INNER JOIN LEDGER1 L1 ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE "
			
		IF @VNOTYPE = '5'
		BEGIN
		SET @@SQL  = @@SQL + " AND L1.LNO = L.LNO "
		END
		
		SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " "
		
		IF @VNOTYPE = '2' OR @VNOTYPE = '16'
		BEGIN
		SET @@SQL = @@SQL + " AND L.DRCR = 'C' " 
		END
		ELSE IF @VNOTYPE = '3' OR @VNOTYPE = '17'
		BEGIN
		SET @@SQL = @@SQL + " AND L.DRCR = 'D' " 
		END	
		
		IF UPPER(@DATETYPE) = 'VOUDT' 	
		BEGIN	
		SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' " 
		END
		ELSE
		BEGIN
		SET @@SQL = @@SQL + " AND L.PDT > = '" + @FROMDATE + " 00:00:00' AND L.PDT < = '" + @TODATE + " 23:59:59' " 
		END
		
		IF @CHQNUM <> ''    
     		BEGIN
		SET @@SQL = @@SQL + " AND L1.DDNO = '" + @CHQNUM + "' "   
    		END
		
		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN	
		SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "
		END

		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 
		
		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END
	END

	ELSE IF @VNOTYPE = '6' OR @VNOTYPE = '7' OR @VNOTYPE = '8'
       	--   DEBIT NOTE        OR CREDIT NOTE      OR JOURNAL VOUCHER
	BEGIN
		SET @@SQL = " "
		SET @@SQL = @@SQL + " SELECT L.VTYP, L.CLTCODE, L.VNO, CONVERT(VARCHAR(11), L.VDT, 109) VDT, L.ACNAME, L.DRCR, "
 		SET @@SQL = @@SQL + " L.VAMT, L.NARRATION, CONVERT(VARCHAR(11), L.CDT, 109) CDT  "
 		SET @@SQL = @@SQL + " FROM LEDGER L "
 		SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " "
		SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' "  
		
		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN	
		SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "
		END

		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 

		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END
		
		SET @@SQL = @@SQL + " ORDER BY L.VNO, L.VDT, L.DRCR DESC " 
	END 	 
	
	ELSE IF @VNOTYPE = '19' OR @VNOTYPE = '20'
	--MARGIN BANK RECEIVED  OR MARGIN BANK PAYMENT
	BEGIN 
		SET @@SQL = " "
		SET @@SQL = @@SQL + " SELECT ML.VNO, ML.VTYP, ML.BOOKTYPE, ML.PARTY_CODE CLTCODE, L.NARRATION, "
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),ML.VDT, 109) VDT, A.ACNAME, ML.AMOUNT VAMT, ML.DRCR, L1.DDNO, "
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11), L1.DDDT, 109) CDT " 
		SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN MARGINLEDGER ML ON L.VNO = ML.VNO AND L.VTYP = ML.VTYP AND"
		SET @@SQL = @@SQL + " L.BOOKTYPE = ML.BOOKTYPE INNER JOIN LEDGER1 L1 ON ML.VNO = L1.VNO AND ML.VTYP = L1.VTYP AND "
		SET @@SQL = @@SQL + " ML.BOOKTYPE = L1.BOOKTYPE INNER JOIN ACMAST A ON ML.PARTY_CODE = A.CLTCODE "
		SET @@SQL = @@SQL + " WHERE ML.VTYP = " + @VNOTYPE + " AND ML.VDT > = '" + @FROMDATE + " 00:00:00' AND ML.VDT < = '" + @TODATE + " 23:59:59' " 

		IF @CHQNUM <> ''
		BEGIN 
		SET @@SQL = @@SQL + " AND L1.DDNO = '" + @CHQNUM + "' "
		END 
		
		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN 
		SET @@SQL = @@SQL + " AND ML.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + "  "
		END 	
		  
		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND ML.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 

		IF @FROMBANKCD <> ''
		BEGIN 	
 		SET @@SQL = @@SQL + " AND (ML.PARTY_CODE > = '" + @FROMBANKCD + "' AND ML.PARTY_CODE < = '" + @TOBANKCD + "') "
		END 
		
		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND ML.PARTY_CODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END
  
		SET @@SQL = @@SQL + " ORDER BY ML.VNO, ML.VDT, ML.DRCR DESC "     
	END 
	
	ELSE IF @VNOTYPE = '22' OR @VNOTYPE = '23' OR @VNOTYPE = '24'
	--MARGIN CASH RECEIVED  OR MARGIN CASH PAYMENT
	BEGIN
		SET @@SQL = " "
		SET @@SQL = @@SQL + " SELECT ML.VNO, ML.VTYP, ML.BOOKTYPE, ML.PARTY_CODE CLTCODE, L.NARRATION, "
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11), ML.VDT, 109) VDT, A.ACNAME, ML.AMOUNT VAMT, ML.DRCR "
 		SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN MARGINLEDGER ML ON L.VNO = ML.VNO AND L.VTYP = ML.VTYP AND " 
		SET @@SQL = @@SQL + " L.BOOKTYPE = ML.BOOKTYPE INNER JOIN ACMAST A ON ML.PARTY_CODE = A.CLTCODE "
		SET @@SQL = @@SQL + " WHERE ML.VTYP = " + @VNOTYPE + " "

		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN 
		SET @@SQL = @@SQL + " AND ML.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "
		END 	
		  
		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND ML.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 

		IF @FROMBANKCD <> ''
		BEGIN 	
 		SET @@SQL = @@SQL + " AND (ML.PARTY_CODE > = '" + @FROMBANKCD + "' AND ML.PARTY_CODE < = '" + @TOBANKCD + "') "
		END 
		
		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND ML.PARTY_CODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END
  
		SET @@SQL = @@SQL + " ORDER BY ML.VNO, ML.VDT, ML.DRCR DESC " 
	END 
END
ELSE	
BEGIN
	IF @VNOTYPE = '1' OR @VNOTYPE = '4'
	-- RECEIPT CASH   OR PAYMENT CASH
 	BEGIN
		SET @@SQL =" "
		SET @@SQL = @@SQL + " SELECT L.VTYP, L.CLTCODE, L.VNO, CONVERT(VARCHAR(11),L.VDT,109) VDT,L.ACNAME, L.DRCR, L.VAMT, L.NARRATION "
		SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN "
		SET @@SQL = @@SQL + " (SELECT VNO, CLTCODE ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = " + @VNOTYPE + " AND "
				      
				      IF @VNOTYPE = '1'
				      BEGIN 	 			
					SET @@SQL = @@SQL + " DRCR = 'D' "
				      END	
				      ELSE IF @VNOTYPE = '4'
				      BEGIN	  
					SET @@SQL = @@SQL + " DRCR = 'C' "	
				      END	
					
				      IF @FROMBANKCD <> ''
				      BEGIN
				      	SET @@SQL = @@SQL + " AND (CLTCODE > = '" + @FROMBANKCD + "' AND CLTCODE < = '" + @TOBANKCD + "') " 
				      END

		SET @@SQL = @@SQL + " ) D ON L.VNO = D.VNO AND L.VTYP = D.VTYP AND L.BOOKTYPE = D.BOOKTYPE "
		SET @@SQL = @@SQL + " INNER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE " 
		SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " AND "
		SET @@SQL = @@SQL + " A.BRANCHCODE = '" + @STATUSNAME + "' AND "
		
		IF @VNOTYPE = '1'
		BEGIN
		SET @@SQL = @@SQL + " L.DRCR = 'C' " 
		END
		ELSE IF @VNOTYPE = '4'
		BEGIN
		SET @@SQL = @@SQL + " L.DRCR = 'D' " 
		END	
			
		SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' " 
		
		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN	
		SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "
		END

		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 
		
		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END

		SET @@SQL = @@SQL + " ORDER BY L.VNO, L.VDT, L.DRCR DESC " 
	END

	ELSE IF @VNOTYPE = '2' OR @VNOTYPE = '3' OR @VNOTYPE = '16' OR @VNOTYPE = '17'
	     -- RECEIPT BANK   OR PAYMENT BANK   OR CHEQUE CANCEL   OR CHEQUE RETURN
	BEGIN
		SET @@SQL = " "
		SET @@SQL = @@SQL + " SELECT L1.DDNO, L.VTYP, L.CLTCODE, L.VNO, L.ACNAME, L.DRCR, L.VAMT, L.NARRATION, "
		
		IF UPPER(@DATETYPE) = 'VOUDT'
		BEGIN	
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L.VDT,109) VDT, "
		END
		ELSE 
		BEGIN
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L.PDT,109) PDT, "
		END

		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L1.DDDT,109) CDT, L.CLTCODE AS ctl FROM LEDGER L INNER JOIN "
		SET @@SQL = @@SQL + " (SELECT VNO, CLTCODE ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = " + @VNOTYPE + " "
				      IF @VNOTYPE = '2' OR @VNOTYPE = '16'  
				      BEGIN 	 			
					SET @@SQL = @@SQL + " AND DRCR = 'D' "
				      END	
				      ELSE IF @VNOTYPE = '3' OR @VNOTYPE = '17'
				      BEGIN	  
					SET @@SQL = @@SQL + " AND DRCR = 'C' "	
				      END	
					
				      IF @FROMBANKCD <> ''
				      BEGIN
				      	SET @@SQL = @@SQL + " AND (CLTCODE > = '" + @FROMBANKCD + "' AND CLTCODE < = '" + @TOBANKCD + "') " 
				      END

		SET @@SQL = @@SQL + " ) D ON L.VNO = D.VNO AND L.VTYP = D.VTYP AND L.BOOKTYPE = D.BOOKTYPE "
		SET @@SQL = @@SQL + " INNER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE "
		SET @@SQL = @@SQL + " INNER JOIN LEDGER1 L1 ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE "
		SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " AND "
		SET @@SQL = @@SQL + " A.BRANCHCODE = '" + @STATUSNAME + "' "
		
		IF @VNOTYPE = '2' OR @VNOTYPE = '16'
		BEGIN
		SET @@SQL = @@SQL + " AND L.DRCR = 'C' " 
		END
		ELSE IF @VNOTYPE = '3' OR @VNOTYPE = '17'
		BEGIN
		SET @@SQL = @@SQL + " AND L.DRCR = 'D' " 
		END	
		
		IF UPPER(@DATETYPE) = 'VOUDT' 	
		BEGIN	
		SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' " 
		END
		ELSE
		BEGIN
		SET @@SQL = @@SQL + " AND L.PDT > = '" + @FROMDATE + " 00:00:00' AND L.PDT < = '" + @TODATE + " 23:59:59' " 
		END
		
		IF @CHQNUM <> ''    
     		BEGIN
		SET @@SQL = @@SQL + " AND L1.DDNO = '" + @CHQNUM + "' "   
    		END
		
		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN	
		SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "
		END

		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 
		
		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END
	END

	ELSE IF @VNOTYPE = '5' OR @VNOTYPE = '6' OR @VNOTYPE = '7'
	---     CONTRY ENTRY   OR DEBIT NOTE     OR CREDIT NOTE
	BEGIN
		SET @@SQL = " "
		SET @@SQL = @@SQL + " SELECT L.VTYP, L.CLTCODE, L.VNO, CONVERT(VARCHAR(11),L.VDT,109) VDT, L.ACNAME, L.DRCR, L.VAMT, L.NARRATION, " 
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11), L.CDT, 109) CDT, A.POBANKNAME, A.POBANKCODE "
		SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE "
		SET @@SQL = @@SQL + " WHERE A.BRANCHCODE = '" + @STATUSNAME + "' AND L.VTYP = '" + @VNOTYPE + "' AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' " 
		
		IF @CHQNUM <> ''    
     		BEGIN
		SET @@SQL = @@SQL + " AND L1.DDNO = '" + @CHQNUM + "' "   
    		END
		
		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN	
		SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "
		END

		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 
		
		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END
		
		SET @@SQL = @@SQL + " ORDER BY L.VNO, L.VDT, L.DRCR DESC " 
	END

	ELSE IF @VNOTYPE = '8'
	-- JOURNAL VOUCHER
	BEGIN
		SET @@SQL = " "
		SET @@SQL = @@SQL + " SELECT L.VTYP, L.CLTCODE, L.VNO, CONVERT(VARCHAR(11), L.VDT, 109) VDT, L.ACNAME, L.DRCR, "
 		SET @@SQL = @@SQL + " L.VAMT, L.NARRATION "
 		SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE "
 		SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " AND A.BRANCHCODE = '" + @STATUSNAME + "' "
		SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' "  
		
		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN	
		SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "
		END

		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 

		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END
		
		SET @@SQL = @@SQL + " ORDER BY L.VNO, L.VDT, L.DRCR DESC " 
	END 	 
	
	ELSE IF @VNOTYPE = '19' OR @VNOTYPE = '20'
	--MARGIN BANK RECEIVED  OR MARGIN BANK PAYMENT
	BEGIN 
		SET @@SQL = " "
		SET @@SQL = @@SQL + " SELECT ML.VNO, ML.VTYP, ML.BOOKTYPE, ML.PARTY_CODE CLTCODE, L.NARRATION, "
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),ML.VDT, 109) VDT, A.ACNAME, ML.AMOUNT VAMT, ML.DRCR, L1.DDNO, "
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11), L1.DDDT, 109) CDT " 
		SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN MARGINLEDGER ML ON L.VNO = ML.VNO AND L.VTYP = ML.VTYP AND"
		SET @@SQL = @@SQL + " L.BOOKTYPE = ML.BOOKTYPE INNER JOIN LEDGER1 L1 ON ML.VNO = L1.VNO AND ML.VTYP = L1.VTYP AND "
		SET @@SQL = @@SQL + " ML.BOOKTYPE = L1.BOOKTYPE INNER JOIN ACMAST A ON ML.PARTY_CODE = A.CLTCODE "
		SET @@SQL = @@SQL + " WHERE ML.VTYP = " + @VNOTYPE + " AND A.BRANCHCODE = '" + @STATUSNAME + "' AND ML.VDT > = '" + @FROMDATE + " 00:00:00' AND ML.VDT < = '" + @TODATE + " 23:59:59' " 

		IF @CHQNUM <> ''
		BEGIN 
		SET @@SQL = @@SQL + " AND L1.DDNO = '" + @CHQNUM + "' "
		END 
		
		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN 
		SET @@SQL = @@SQL + " AND ML.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + "  "
		END 	
		  
		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND ML.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 

		IF @FROMBANKCD <> ''
		BEGIN 	
 		SET @@SQL = @@SQL + " AND (ML.PARTY_CODE > = '" + @FROMBANKCD + "' AND ML.PARTY_CODE < = '" + @TOBANKCD + "') "
		END 
		
		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND ML.PARTY_CODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END
  
		SET @@SQL = @@SQL + " ORDER BY ML.VNO, ML.VDT, ML.DRCR DESC "     
	END 
	
	ELSE IF @VNOTYPE = '22' OR @VNOTYPE = '23' OR @VNOTYPE = '24'
	--MARGIN CASH RECEIVED  OR MARGIN CASH PAYMENT
	BEGIN
		SET @@SQL = " "
		SET @@SQL = @@SQL + " SELECT ML.VNO, ML.VTYP, ML.BOOKTYPE, ML.PARTY_CODE CLTCODE, L.NARRATION, "
		SET @@SQL = @@SQL + " CONVERT(VARCHAR(11), ML.VDT, 109) VDT, A.ACNAME, ML.AMOUNT VAMT, ML.DRCR "
 		SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN MARGINLEDGER ML ON L.VNO = ML.VNO AND L.VTYP = ML.VTYP AND " 
		SET @@SQL = @@SQL + " L.BOOKTYPE = ML.BOOKTYPE INNER JOIN ACMAST A ON ML.PARTY_CODE = A.CLTCODE "
		SET @@SQL = @@SQL + " WHERE ML.VTYP = " + @VNOTYPE + " AND A.BRANCHCODE = '" + @STATUSNAME + "' "

		IF @FROMVAMT <> '' OR @TOVAMT <> ''
		BEGIN 
		SET @@SQL = @@SQL + " AND ML.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "
		END 	
		  
		IF @FROMVNO <> '' OR @TOVNO <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND ML.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "
		END 

		IF @FROMBANKCD <> ''
		BEGIN 	
 		SET @@SQL = @@SQL + " AND (ML.PARTY_CODE > = '" + @FROMBANKCD + "' AND ML.PARTY_CODE < = '" + @TOBANKCD + "') "
		END 
		
		IF @FROMCLIENTID <> '' OR @TOCLIENTID <> '' 
		BEGIN
		SET @@SQL = @@SQL + " AND ML.PARTY_CODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "
		END
  
		SET @@SQL = @@SQL + " ORDER BY ML.VNO, ML.VDT, ML.DRCR DESC " 
	END
	
END

PRINT @@SQL
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spa_InsVouchertemp
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 06/24/2004 8:32:35 PM ******/  
  
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 05/10/2004 5:29:35 PM ******/  
  
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 02/18/2003 10:25:07 AM ******/  
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 01/27/2003 9:57:08 PM ******/  
CREATE PROCEDURE [dbo].[Spa_InsVouchertemp]  
 @vno varchar(20),  
 @vtype varchar(2),  
 @booktype varchar(2),  
 @billflag char(1),  
 @costflag char(1),  
 @sid varchar(20)  
 AS  
declare @@tmpcat varchar(50),  
@@tmplno varchar(3),  
@@tmpcost varchar(50),  
@@tmpcostname varchar(50),  
@@tmpexists integer,  
@@tmpcltcode varchar(16),  
@@CNo Cursor  
  
if @billflag=1  
begin  
insert into tempbilldetails   
/*  
 select distinct Exchange,m.Party_code,Sett_no,Sett_type,m.drcr,b.amount,balamt,payamout= m.amount,sessionid=@sid,m.llno,m.lno,  
 b.date,m.description,billbooktype=b.booktype,billvtype=b.vtype,m.lbooktype,m.lvtype,b.vno   
 from matchdetails m left outer join billmatch b on m.vno=b.vno and m.vtype=b.vtype and m.booktype= b.booktype and   
 m.lno=b.lno and b.vtype=15 where m.lvno = @vno and m.lvtype = @vtype and m.lBookType = @booktype    
 and m.description not like 'Advances%' */  
  
  
 select distinct Exchange,m.Party_code,Sett_no,Sett_type,m.drcr,b.amount,balamt,payamout= m.amount,sessionid=@sid,m.llno,m.lno,  
 b.date,m.description,billbooktype=b.booktype,billvtype=b.vtype,m.lbooktype,m.lvtype,b.vno   
 from billmatch b left outer join matchdetails m on b.vno=m.vno and b.vtype=m.vtype and b.booktype= m.booktype and   
 b.lno=m.lno and b.party_code = m.party_code and b.vtype=15  
 where m.lvno = @vno and m.lvtype = @vtype and m.lBookType = @booktype  and m.description not like 'Advances%'  
end  
  
  
If @costflag=1  
begin  
 insert into templedger2 (vtype,vno,lno,drcr,paidamt,costcode,BookType,sessionid,party_code)  
 select distinct vtype,vno,lno,drcr,camt,costcode,BookType,sessionid=@sid,cltcode  
 from ledger2  where vno= @vno and vtype=@vtype and booktype= @booktype  
  
  
 Set @@Cno = Cursor For   
 select distinct lno,costcode,cltcode  
 from ledger2  where vno= @vno  and vtype=@vtype and booktype= @booktype  
 Open @@CNo   
 Fetch Next from @@CNo into @@tmplno,@@tmpcost,@@tmpcltcode  
 While @@Fetch_Status = 0   
 Begin  
  select @@tmpexists = (select count(*) as cnt from branchaccounts where BrControlAc =  @@tmpcltcode)  
  if @@tmpexists = 0  
  begin  
   select @@tmpcat = (select distinct top 1 c.category from category c, costmast m   
   where c.catcode = m.catcode and m.costcode=@@tmpcost)  
   update templedger2   set category= @@tmpcat where costcode = @@tmpcost and sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and  party_code =@@tmpcltcode  
  end   
  else   
  begin  
   select @@tmpcat = 'BRANCH'  
   update templedger2   set category= 'BRANCH' where costcode = @@tmpcost and sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and party_code =@@tmpcltcode  
  end  
 print @@tmpcost   
 select @@tmpcostname = (select distinct top 1 m.COSTNAME from category c, costmast m where c.catcode = m.catcode and m.costcode= @@tmpcost)  
 update templedger2 set branch = @@tmpcostname  where sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and party_code = @@tmpcltcode and costcode=@@tmpcost  
 select @@tmpcat= ''  
 select @@tmpcostname =''  
 select @@tmpcltcode = ''  
 select @@tmpcost=''  
 Fetch Next from @@CNo into @@tmplno,@@tmpcost,@@tmpcltcode  
 end  
 Close @@CNo  
 DeAllocate @@CNo  
  
 delete from templedger2 where party_code in ( select BrControlAc from branchaccounts)  
 update templedger2 set costflag = 'A', rowid = lno  
        where upper(category) = 'BRANCH' and sessionid = @sid and vtype=@vtype and booktype =@booktype and vno= @vno  
 update templedger2 set costflag = 'A', rowid = lno  
        where upper(category) <> 'BRANCH' and sessionid = @sid and vtype=@vtype and booktype =@booktype and vno= @vno  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPTestPrepaid
-- --------------------------------------------------
  
CREATE proc SPTestPrepaid                                 
( @fvdt as datetime,@tvdt as datetime, @code as varchar(10))                                       
                                      
as                                      
          
set nocount on                                               
                                 
select * into #t from ledger nolock where  cltcode=@code and left(convert(varchar,vdt,121),11)>=@fvdt and left(convert(varchar,vdt,121),11)<=@tvdt                                      
                          
                              
select drcr= case                               
when drcr = 'D' then 'C'                               
when drcr = 'C' then 'D' end, vno,left(convert(varchar,vdt,121),11) vdt,vtyp into #l1 from #t                              
select convert(varchar(11),vdt,103) as [Date],VNO,cltcode,acname, segment='AIPL',vamt,  
narration as [Narration],DRCR,vtyp  into #file1 from                              
(                              
select * from #t                            
union                             
select x.* from                              
(                              
select l.*                      
from ledger l (nolock), #t t                       
where l.vtyp = t.vtyp and l.vtyp <> '18' and l.vno = t.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt   
and left(convert(varchar,l.vdt,121),11) <= @tvdt and isnumeric(l.cltcode) = 1   
and (l.cltcode not like '4%' or l.cltcode not like '2%' and l.cltcode  like '5%')                     
              
) x              
inner join                              
(select * from #l1)y                              
on left(convert(varchar,x.vdt,121),11) = y.vdt and x.drcr = y.drcr and x.vno = y.vno                              
) x where cltcode not like '27%'  and cltcode not like '26%' --and cltcode  like '5%'            
            
    
select * into #P from ledger nolock where  cltcode=@code and left(convert(varchar,vdt,121),11)>=@fvdt   
and left(convert(varchar,vdt,121),11)<=@tvdt         
    
    
select l.vtyp,l.vno,l.acname,l.drcr,l.vamt,l.cltcode  into #prepaid1                   
from ledger l (nolock), #p p                       
where l.vtyp = p.vtyp and l.vtyp <> '18' and l.vno = p.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt   
and left(convert(varchar,l.vdt,121),11)<=@tvdt and isnumeric(l.cltcode) = 1   
and (l.cltcode not like '4%' and l.cltcode not like '2%')    
    
    
select t.vdt,t.VTYP,t.vno,t.cltcode,t.acname,t.drcr,t.vamt,t.narration,p.cltcode,p.acname,p.drcr,p.vamt    
from #t t left join #prepaid1 p    
on t.vtyp=p.vtyp and t.vno=p.vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Tbl
-- --------------------------------------------------

CREATE PROC Tbl @TblName VARCHAR(25)AS           
Select * from sysobjects where name Like '%' + @TblName + '%' and xtype='U' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEST_AGEING
-- --------------------------------------------------
--exec Ageingcursor_NEW1_SB '10100000', '10100010', 'Apr  1 2004', 'Nov 19 2004','party','',0, 'A','edt','broker','broker', 6,26,90,160,161,'101', 'VALSAD'

CREATE PROCEDURE [dbo].[TEST_AGEING]
                @fromparty   VARCHAR(10),
                @toparty     VARCHAR(10),
                @opendate    VARCHAR(11),
                @todate      VARCHAR(11),
                @Reporttype  VARCHAR(15),
                @family      VARCHAR(10),
                @amoutgtthan MONEY,
                @ageoption   VARCHAR(1),
                @dttype      VARCHAR(3),
                @statusid    VARCHAR(10),
                @statusname  VARCHAR(25),
                @Days1       INT  = 6,
                @Days2       INT  = 29,
                @Days3       INT  = 90,
                @Days4       INT  = 180,
                @Days5       INT  = 181,
                @FrSb        VARCHAR(10)  = '0',
                @ToSb        VARCHAR(10)  = 'ZZZZ'
                                            
AS

  DECLARE  @@balcur      AS CURSOR,
           @@baldate     AS VARCHAR(11),
           @@openbaldt   AS VARCHAR(11),
           @@balamt      AS MONEY,
           @@ocltcode    AS VARCHAR(10),
           @@vtyp        AS SMALLINT,
           @@vno        VARCHAR(12),
           @@EVdt        AS DATETIME,
           @@vamt        AS MONEY,
           @@closbal     AS MONEY,
           @@cltcode     AS VARCHAR(10),
           @@Branchcode  AS VARCHAR(25),
           @@area        AS VARCHAR(25),
           @@drcr        AS VARCHAR(1),
           @@startdt     AS DATETIME
                            
  PRINT 'Strated '
  
  PRINT CONVERT(DATETIME,GETDATE(),113)
  
  SET NOCOUNT ON
  
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  SELECT @@startdt = (SELECT LEFT(CONVERT(VARCHAR,DATEADD(MM,-12,CONVERT(DATETIME,@todate)),
                                          109),11))
                     
  IF UPPER(@statusid) = 'BROKER'
    BEGIN
      SELECT @@branchcode = '%'
      
      SELECT @@area = '%'
    END
  ELSE
    IF UPPER(@statusid) = 'BRANCH'
      BEGIN
        SELECT @@branchcode = RTRIM(@statusname)
        
        SELECT @@area = '%'
      END
    ELSE
      IF UPPER(@statusid) = 'AREA'
        BEGIN
          SELECT @@branchcode = '%'
          
          SELECT @@area = RTRIM(@statusname)
        END
        
  SELECT CLTCODE,
         VDT         AS BALDATE,
         VAMT        CLOSBAL,
         AGEDAYS = 0
  INTO   #TEMPAGEING
  FROM   LEDGER
  WHERE  1 = 2
  
  SELECT CLTCODE,
         VDT         AS BALDATE,
         VAMT        CLOSBAL,
         AGEDAYS = 0
  INTO   #TEMPAGEING1
  FROM   LEDGER
  WHERE  1 = 2
             
  SELECT *
  INTO   #LEDGER
  FROM   LEDGER
  WHERE  1 = 2
             
  SELECT CLTCODE,
         VTYP,
         VNO,
         EDT     AS EVDT,
         VAMT,
         VAMT    CLOSBAL
  INTO   #LEDGERCURSOR
  FROM   LEDGER
  WHERE  1 = 2
             
  IF @dttype = 'vdt'
    BEGIN
      SELECT @@openbaldt = LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11)
      FROM   LEDGER
      WHERE  VTYP = '18'
             AND VDT < = @opendate
                         
      IF UPPER(@Reporttype) = 'PARTY'
        BEGIN
          INSERT INTO #TEMPAGEING1
          SELECT   L.CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CASE 
                                   WHEN DRCR = 'd' THEN VAMT
                                   ELSE -VAMT
                                 END),
                   AGEDAYS = 0
          FROM     LEDGER L,
                   CLIENT1 C1,
                   CLIENT2 C2
          WHERE    L.CLTCODE = C2.PARTY_CODE
                   AND C1.CL_CODE = C2.CL_CODE
                   AND VDT >= @@openbaldt + ' 00:00:00'
                   AND VDT <= @todate + ' 23:59:59'
                   AND L.CLTCODE >= @fromparty
                   AND L.CLTCODE <= @toparty
                   AND C1.BRANCH_CD LIKE @@branchcode + '%'
                   AND AREA LIKE @@area + '%'
                   AND C1.SUB_BROKER >= @FrSb
                   AND C1.SUB_BROKER <= @ToSb
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
          
          INSERT INTO #TEMPAGEING
          SELECT   CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CLOSBAL),
                   AGEDAYS = 0
          FROM     #TEMPAGEING1
          GROUP BY CLTCODE
          ORDER BY CLTCODE
        END
          
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          INSERT INTO #LEDGER
          SELECT *
          FROM   LEDGER
          WHERE  VDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT DISTINCT CLTCODE
                                 FROM   #TEMPAGEING)
        END
        
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          IF UPPER(RTRIM(@ageoption)) = 'D'
            BEGIN
              INSERT INTO #LEDGERCURSOR
              SELECT   L.CLTCODE,
                       VTYP,
                       VNO,
                       VDT,
                       VAMT,
                       CLOSBAL
              FROM     #LEDGER L,
                       #TEMPAGEING A
              WHERE    CLOSBAL >= 0
                       AND DRCR = (CASE 
                                     WHEN CLOSBAL >= 0 THEN 'd'
                                     ELSE 'c'
                                   END)
                       AND L.CLTCODE = A.CLTCODE
                       AND VDT <= @todate + ' 23:59:59'
                       --
                       AND VTYP <> '18'
              ORDER BY L.CLTCODE,
                       VDT DESC,
                       VTYP,
                       VNO
            END
            
          ELSE
            IF UPPER(RTRIM(@ageoption)) = 'C'
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         VDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         #TEMPAGEING A
                WHERE    CLOSBAL < 0
                         AND DRCR = (CASE 
                                       WHEN CLOSBAL >= 0 THEN 'd'
                                       ELSE 'c'
                                     END)
                         AND L.CLTCODE = A.CLTCODE
                         AND VDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         VDT DESC,
                         VTYP,
                         VNO
              END
              
            ELSE
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         VDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         #TEMPAGEING A
                WHERE    DRCR = (CASE 
                                   WHEN CLOSBAL >= 0 THEN 'd'
                                   ELSE 'c'
                                 END)
                         AND L.CLTCODE = A.CLTCODE
                         AND VDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         VDT DESC,
                         VTYP,
                         VNO
              END
        END

    END
    
  ELSE
    BEGIN
      SELECT @@openbaldt = LEFT(CONVERT(VARCHAR,ISNULL(MAX(EDT),0),109),11)
      FROM   LEDGER
      WHERE  VTYP = '18'
             AND EDT < = @opendate
                         
      IF UPPER(@Reporttype) = 'PARTY'
        BEGIN
          INSERT INTO #TEMPAGEING1
          SELECT   L.CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CASE 
                                   WHEN DRCR = 'd' THEN VAMT
                                   ELSE -VAMT
                                 END),
                   AGEDAYS = 0
          FROM     LEDGER L,
                   ACMAST A,
                   CLIENT1 C1
          WHERE    L.CLTCODE = A.CLTCODE
                   AND L.CLTCODE = C1.CL_CODE
                   AND EDT >= @@openbaldt + ' 00:00:00'
                   AND EDT <= @todate + ' 23:59:59'
                   AND L.CLTCODE >= @fromparty
                   AND L.CLTCODE <= @toparty
                   AND A.BRANCHCODE LIKE @@branchcode + '%'
                   AND A.ACCAT = 4
                   AND C1.SUB_BROKER >= @FrSb
                   AND C1.SUB_BROKER <= @ToSb
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
          
          INSERT INTO #TEMPAGEING
          SELECT   CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CLOSBAL),
                   AGEDAYS = 0
          FROM     #TEMPAGEING1
          GROUP BY CLTCODE
          ORDER BY CLTCODE
                   
        END
           
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          INSERT INTO #LEDGER
          SELECT *
          FROM   LEDGER
          WHERE  EDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT DISTINCT CLTCODE
                                 FROM   #TEMPAGEING)
        END
        
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          IF UPPER(RTRIM(@ageoption)) = 'D'
            BEGIN
              INSERT INTO #LEDGERCURSOR
              SELECT   L.CLTCODE,
                       VTYP,
                       VNO,
                       EDT,
                       VAMT,
                       CLOSBAL
              FROM     #LEDGER L,
                       #TEMPAGEING A
              WHERE    CLOSBAL >= 0
                       AND DRCR = (CASE 
                                     WHEN CLOSBAL >= 0 THEN 'd'
                                     ELSE 'c'
                                   END)
                       AND L.CLTCODE = A.CLTCODE
                       AND EDT <= @todate + ' 23:59:59'
                       --
                       AND VTYP <> '18'
              ORDER BY L.CLTCODE,
                       EDT DESC,
                       VTYP,
                       VNO
            END
            
          ELSE
            IF UPPER(RTRIM(@ageoption)) = 'C'
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         EDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGEREDT L,
                         #TEMPAGEING A
                WHERE    CLOSBAL < 0
                         AND DRCR = (CASE 
                                       WHEN CLOSBAL >= 0 THEN 'd'
                                       ELSE 'c'
                                     END)
                         AND L.CLTCODE = A.CLTCODE
                         AND EDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         EDT DESC,
                         VTYP,
                         VNO
              END
              
            ELSE
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         EDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         #TEMPAGEING A
                WHERE    DRCR = (CASE 
                                   WHEN CLOSBAL >= 0 THEN 'd'
                                   ELSE 'c'
                                 END)
                         AND L.CLTCODE = A.CLTCODE
                         AND EDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         EDT DESC,
                         VTYP,
                         VNO
              END
        END
        
    END
    
  SET @@balcur = CURSOR FOR SELECT   CLTCODE,
                                     VTYP,
                                     VNO,
                                     EVDT,
                                     VAMT,
                                     CLOSBAL
                            FROM     #LEDGERCURSOR
                            ORDER BY CLTCODE,
                                     EVDT DESC,
                                     VTYP,
                                     VNO
  
  SELECT CLTCODE,
         VAMT    BALAMT,
         0       AGEDAYS,
         DRCR
  INTO   #FINTEMPAGEING
  FROM   #LEDGER
  WHERE  1 = 2
             
  OPEN @@balcur
  
  FETCH NEXT FROM @@balcur
  INTO @@cltcode,
       @@vtyp,
       @@vno,
       @@EVdt,
       @@vamt,
       @@closbal
       
  WHILE @@FETCH_STATUS = 0
    BEGIN
      SELECT @@ocltcode = @@cltcode
      
      SELECT @@balamt = ABS(@@closbal)
      
      IF @@closbal >= 0
        BEGIN
          SELECT @@drcr = 'd'
        END
      ELSE
        BEGIN
          SELECT @@drcr = 'c'
        END
        
      WHILE @@FETCH_STATUS = 0
            AND @@ocltcode = @@cltcode
            AND @@balamt > 0
        BEGIN
          IF @@balamt >= @@vamt
            BEGIN
              INSERT INTO #FINTEMPAGEING
              SELECT @@cltcode,
                     @@vamt,
                     DATEDIFF(DAY,@@EVdt,@todate),
                     @@drcr
              
              SELECT @@balamt = @@balamt - @@vamt
            END
            
          ELSE
            BEGIN
              INSERT INTO #FINTEMPAGEING
              SELECT @@cltcode,
                     @@balamt,
                     DATEDIFF(DAY,@@EVdt,@todate),
                     @@drcr
              
              SELECT @@balamt = @@balamt - @@vamt
            END
            
          FETCH NEXT FROM @@balcur
          INTO @@cltcode,
               @@vtyp,
               @@vno,
               @@EVdt,
               @@vamt,
               @@closbal
        END
        
      IF @@balamt > 0
        BEGIN
          INSERT INTO #FINTEMPAGEING
          SELECT @@ocltcode,
                 @@balamt,
                 181,
                 @@drcr
          
          SELECT @@balamt = @@balamt - @@vamt
        END
        
      WHILE @@FETCH_STATUS = 0
            AND @@ocltcode = @@cltcode
        BEGIN
          FETCH NEXT FROM @@balcur
          INTO @@cltcode,
               @@vtyp,
               @@vno,
               @@EVdt,
               @@vamt,
               @@closbal
        END
    END
    
  CLOSE @@balcur
  
  DEALLOCATE @@balcur
  
  PRINT 'cursor closed'
  
  PRINT CONVERT(DATETIME,GETDATE(),113)
  
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days1,
           DRCR
  INTO     #AGEINGLIST
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= 0
           AND AGEDAYS <= @Days1
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days2,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days1 + 1
           AND AGEDAYS <= @Days2
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days3,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days2 + 1
           AND AGEDAYS <= @Days3
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days4,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days3 + 1
           AND AGEDAYS <= @Days4
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days5,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days5
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  PRINT 'done'
  
  PRINT CONVERT(DATETIME,GETDATE(),113)
  
  SELECT   A1.CLTCODE,
           SHORT_NAME = A2.SHORT_NAME,
           BALANCE,
           AGEDAYS,
           DRCR,
           A2.BRANCH_CD,
           A2.SUB_BROKER,
           B.BRANCH,
           S.NAME
  FROM     #AGEINGLIST A1,
           CLIENT1 A2,
           SUBBROKERS S,
           BRANCH B--clientmaster a2--acmast  a2         
  WHERE    BALANCE >= @amoutgtthan
           AND A1.CLTCODE = A2.CL_CODE
           AND A2.BRANCH_CD = B.BRANCH_CODE
           AND A2.SUB_BROKER = S.SUB_BROKER
  ORDER BY A2.BRANCH_CD,
           A2.SUB_BROKER,
           A1.CLTCODE,
           A2.SHORT_NAME
           
  DROP TABLE #TEMPAGEING
  
  DROP TABLE #LEDGER
  
  DROP TABLE #LEDGERCURSOR
  
  DROP TABLE #AGEINGLIST
  
  DROP TABLE #FINTEMPAGEING

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEST1
-- --------------------------------------------------
CREATE PROC [dbo].[TEST1]
AS
/*
	EXEC TEST1
*/
DECLARE
	@SQL VARCHAR(100)
SET XACT_ABORT ON
begin tran
SET @SQL = 'BEGIN TRY SELECT TOP 5 VNO, VTYPE, BOOKTYPE FROM LEDGER END TRY BEGIN CATCH SELECT ''ERROR'' END CATCH'
EXEC (@SQL)
SET @SQL = 'SELECT TOP 5 VNO, VTYP, BOOKTYPE FROM LEDGER'
EXEC (@SQL)
commit tran
PRINT 'COMMITTED'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATEACMAST
-- --------------------------------------------------

CREATE PROC [dbo].[UPDATEACMAST]  
 @EXCHANGE VARCHAR(20),  
 @SEGMENT VARCHAR(20),  
 @COMPANY VARCHAR(100)  
AS  
DECLARE  
 @@SHAREDB AS VARCHAR(50),  
 @@GRPCODE AS VARCHAR(50),  
 @@SQL AS VARCHAR(2000)  
/*  
 EXEC UPDATEACMAST 'NSE', 'CAPITAL', 'MOTILAL OSWAL SECURITIES LTD'  
*/  
SELECT @@SHAREDB = ''  
SELECT TOP 1  
 @@SHAREDB = SHAREDB  
FROM  
 PRADNYA.DBO.MULTICOMPANY  
WHERE  
 EXCHANGE = @EXCHANGE  
 AND SEGMENT = @SEGMENT  
 AND COMPANYNAME = @COMPANY  
 AND PRIMARYSERVER = 1  
  
SELECT @@GRPCODE = ''  
SELECT  
 @@GRPCODE = ISNULL(GRPCODE, '')  
FROM  
 OWNER O,  
 GRPMAST G  
WHERE  
 O.CLIENTGROUP = G.GRPNAME  
IF @@SHAREDB = ''  
 BEGIN  
  SELECT ERR = 1, DESCRIPTION = 'SHARE DATABASE NOT FOUND.CANNOT CONTINUE...'  
  RETURN  
 END  
--BEGIN TRANSACTION  
SELECT @@SQL = "INSERT INTO ACMAST SELECT LONG_NAME, LONG_NAME , 'ASSET', '4', '', PARTY_CODE , '', "  
SELECT @@SQL = @@SQL + "'" + @@GRPCODE + "', '', 0, BRANCH_CD, '0', 'C', 'HDFC BANK', 'MUMBAI', 'GB019' "  
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), " + LTRIM(RTRIM(@@SHAREDB))  
SELECT @@SQL = @@SQL + ".DBO.CLIENT2 C2 (NOLOCK) WHERE C1.CL_CODE=C2.CL_CODE "  
SELECT @@SQL = @@SQL + "AND PARTY_CODE NOT IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT = 4) "  
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONG_NAME, LONGNAME = LONG_NAME, "  
SELECT @@SQL = @@SQL + "BRANCHCODE = BRANCH_CD, GRPCODE = '" + @@GRPCODE + "' "  
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), "  
SELECT @@SQL = @@SQL + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT2 C2 (NOLOCK) "  
SELECT @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = ACMAST.CLTCODE "  
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONGNAME WHERE ACNAME <> LONGNAME "  
SELECT @@SQL = @@SQL + "UPDATE LEDGER SET ACNAME = A.LONGNAME "  
SELECT @@SQL = @@SQL + "FROM ACMAST A (NOLOCK) WHERE LEDGER.CLTCODE = A.CLTCODE "  
SELECT @@SQL = @@SQL + "AND LEDGER.ACNAME <> A.LONGNAME "  
  
--PRINT @@SQL  
EXEC (@@SQL)  
--COMMIT TRANSACTION  
SELECT ERR = 0, DESCRIPTION = 'ACMAST UPDATED SUCCESSFULLY...'  
  
SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATECOST_FULL_FAS
-- --------------------------------------------------
CREATE PROC [dbo].[UPDATECOST_FULL_FAS]    
AS    
DECLARE    
 @@BRANCH_CODE AS VARCHAR(12),    
 @@COSTCODE AS VARCHAR(10),    
 @@BRCNT AS INT,    
 @@BRCURS AS CURSOR    
------------------------------------------UPDATING NSE SEGMENT --------------------------------------------------------  
SET @@BRCURS = CURSOR FOR    
 SELECT DISTINCT   
  BRANCH_CODE   
 FROM FAS.DBO.BRANCH   
 WHERE BRANCH_CODE NOT IN   
  (  
  SELECT DISTINCT   
   COSTNAME   
  FROM FAS.DBO.COSTMAST  
  )  
OPEN @@BRCURS    
 FETCH NEXT   
 FROM @@BRCURS   
 INTO @@BRANCH_CODE  
WHILE @@FETCH_STATUS = 0    
 BEGIN    
  SELECT   
   @@COSTCODE = CONVERT(VARCHAR(10), ISNULL(MAX(COSTCODE)+1, 1))   
  FROM FAS.DBO.COSTMAST   
  INSERT   
  INTO FAS.DBO.COSTMAST VALUES   
   (  
    @@BRANCH_CODE,   
    @@COSTCODE,   
    1,   
    '10000000000'  
   )   
   FETCH NEXT   
  FROM @@BRCURS   
  INTO @@BRANCH_CODE  
 END    
CLOSE @@BRCURS    
SET @@BRCURS = CURSOR FOR    
 SELECT DISTINCT   
  COSTNAME   
 FROM FAS.DBO.COSTMAST   
 WHERE COSTNAME NOT IN   
  (  
  SELECT DISTINCT   
   BRANCHNAME   
  FROM FAS.DBO.BRANCHACCOUNTS  
  )  
OPEN @@BRCURS    
 FETCH NEXT  
 FROM @@BRCURS  
 INTO @@BRANCH_CODE    
WHILE @@FETCH_STATUS = 0    
 BEGIN    
  INSERT   
  INTO FAS.DBO.BRANCHACCOUNTS VALUES   
   (  
    @@BRANCH_CODE,   
    @@BRANCH_CODE,   
    'HOCTRL',   
    0  
   )   
  FETCH NEXT   
  FROM @@BRCURS   
  INTO @@BRANCH_CODE  
 END    
CLOSE @@BRCURS    
 INSERT   
 INTO FAS.DBO.ACMAST   
 SELECT   
  LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C',   
  LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C',   
  'ASSET',   
  '3',   
  '',   
  LTRIM(RTRIM(BRCONTROLAC)),   
  '',   
  'A0000000000',   
  '',   
  '0',   
  LTRIM(RTRIM(BRANCHNAME)),   
  '0',   
  'C',   
  '',   
  '',   
  ''   
 FROM FAS.DBO.BRANCHACCOUNTS   
 WHERE BRCONTROLAC NOT IN   
  (  
  SELECT DISTINCT   
   CLTCODE   
  FROM FAS.DBO.ACMAST  
  )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATECOST_FULL_FAS19092008
-- --------------------------------------------------
CREATE PROC [dbo].[UPDATECOST_FULL_FAS19092008]    
AS    
DECLARE    
 @@BRANCH_CODE AS VARCHAR(10),    
 @@COSTCODE AS VARCHAR(10),    
 @@BRCNT AS INT,    
 @@BRCURS AS CURSOR    
------------------------------------------UPDATING NSE SEGMENT --------------------------------------------------------  
SET @@BRCURS = CURSOR FOR    
 SELECT DISTINCT   
  BRANCH_CODE   
 FROM FAS.DBO.BRANCH   
 WHERE BRANCH_CODE NOT IN   
  (  
  SELECT DISTINCT   
   COSTNAME   
  FROM FAS.DBO.COSTMAST  
  )  
OPEN @@BRCURS    
 FETCH NEXT   
 FROM @@BRCURS   
 INTO @@BRANCH_CODE  
WHILE @@FETCH_STATUS = 0    
 BEGIN    
  SELECT   
   @@COSTCODE = CONVERT(VARCHAR(10), ISNULL(MAX(COSTCODE)+1, 1))   
  FROM FAS.DBO.COSTMAST   
  INSERT   
  INTO FAS.DBO.COSTMAST VALUES   
   (  
    @@BRANCH_CODE,   
    @@COSTCODE,   
    1,   
    '10000000000'  
   )   
   FETCH NEXT   
  FROM @@BRCURS   
  INTO @@BRANCH_CODE  
 END    
CLOSE @@BRCURS    
SET @@BRCURS = CURSOR FOR    
 SELECT DISTINCT   
  COSTNAME   
 FROM FAS.DBO.COSTMAST   
 WHERE COSTNAME NOT IN   
  (  
  SELECT DISTINCT   
   BRANCHNAME   
  FROM FAS.DBO.BRANCHACCOUNTS  
  )  
OPEN @@BRCURS    
 FETCH NEXT  
 FROM @@BRCURS  
 INTO @@BRANCH_CODE    
WHILE @@FETCH_STATUS = 0    
 BEGIN    
  INSERT   
  INTO FAS.DBO.BRANCHACCOUNTS VALUES   
   (  
    @@BRANCH_CODE,   
    @@BRANCH_CODE,   
    'HOCTRL',   
    0  
   )   
  FETCH NEXT   
  FROM @@BRCURS   
  INTO @@BRANCH_CODE  
 END    
CLOSE @@BRCURS    
 INSERT   
 INTO FAS.DBO.ACMAST   
 SELECT   
  LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C',   
  LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C',   
  'ASSET',   
  '3',   
  '',   
  LTRIM(RTRIM(BRCONTROLAC)),   
  '',   
  'A0000000000',   
  '',   
  '0',   
  LTRIM(RTRIM(BRANCHNAME)),   
  '0',   
  'C',   
  '',   
  '',   
  ''   
 FROM FAS.DBO.BRANCHACCOUNTS   
 WHERE BRCONTROLAC NOT IN   
  (  
  SELECT DISTINCT   
   CLTCODE   
  FROM FAS.DBO.ACMAST  
  )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATECOSTBFO_MOSL
-- --------------------------------------------------
CREATE PROC [dbo].[UPDATECOSTBFO_MOSL]
AS  
DECLARE  
	@@BRANCH_CODE AS VARCHAR(10),  
	@@COSTCODE AS VARCHAR(10),  
	@@BRCNT AS INT,  
	@@BRCURS AS CURSOR  

SET @@BRCURS = CURSOR FOR  
	SELECT DISTINCT 
		BRANCH_CODE 
	FROM BSEFO.DBO.BRANCH 
	WHERE BRANCH_CODE NOT IN 
		(
		SELECT DISTINCT 
			COSTNAME 
		FROM ACCOUNTBFO.DBO.COSTMAST
		)
OPEN @@BRCURS  
	FETCH NEXT 
	FROM @@BRCURS 
	INTO @@BRANCH_CODE
WHILE @@FETCH_STATUS = 0  
	BEGIN  
		SELECT 
			@@COSTCODE = CONVERT(VARCHAR(10), ISNULL(MAX(COSTCODE)+1, 1)) 
		FROM ACCOUNTBFO.DBO.COSTMAST 
		INSERT 
		INTO ACCOUNTBFO.DBO.COSTMAST VALUES 
			(
				@@BRANCH_CODE, 
				@@COSTCODE, 
				1, 
				'10000000000'
			) 
			FETCH NEXT 
		FROM @@BRCURS 
		INTO @@BRANCH_CODE
	END  
CLOSE @@BRCURS  
SET @@BRCURS = CURSOR FOR  
	SELECT DISTINCT 
		COSTNAME 
	FROM ACCOUNTBFO.DBO.COSTMAST 
	WHERE COSTNAME NOT IN 
		(
		SELECT DISTINCT 
			BRANCHNAME 
		FROM ACCOUNTBFO.DBO.BRANCHACCOUNTS
		)
OPEN @@BRCURS  
	FETCH NEXT
	FROM @@BRCURS
	INTO @@BRANCH_CODE  
WHILE @@FETCH_STATUS = 0  
	BEGIN  
		INSERT 
		INTO ACCOUNTBFO.DBO.BRANCHACCOUNTS VALUES 
			(
				@@BRANCH_CODE, 
				@@BRANCH_CODE, 
				'HOCTRL', 
				0
			) 
		FETCH NEXT 
		FROM @@BRCURS 
		INTO @@BRANCH_CODE
	END  
CLOSE @@BRCURS  
	INSERT 
	INTO ACCOUNTBFO.DBO.ACMAST 
	SELECT 
		LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C', 
		LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C', 
		'ASSET', 
		'4', 
		'', 
		LTRIM(RTRIM(BRCONTROLAC)), 
		'', 
		'A0000000000', 
		'', 
		'0', 
		LTRIM(RTRIM(BRANCHNAME)), 
		'0', 
		'C', 
		'', 
		'', 
		'' 
	FROM ACCOUNTBFO.DBO.BRANCHACCOUNTS 
	WHERE BRCONTROLAC NOT IN 
		(
		SELECT DISTINCT 
			CLTCODE 
		FROM ACCOUNTBFO.DBO.ACMAST
		)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FETCH_Ledger1
-- --------------------------------------------------
CREATE Proc USP_FETCH_Ledger1(@fdate as varchar(11),@tdate as varchar(11),@segment as varchar(25),@Code as varchar(20))                                    
as        
        
/*declare @segment as varchar(25)                                    
declare @fdate as varchar(25)                                    
declare @tdate as varchar(25)          
declare @Code as varchar(10)          
*/       
declare @str as varchar(5000)                    
declare @condition as varchar(1000)                                                  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))              
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))           
        
/*        
set @fdate = 'May 01 2009'                                    
set @tdate = 'May 31 2009'                                    
set @segment = 'NSE'          
set @Code = 'ALL'         
*/        
If @Code = 'ALL'          
Begin          
 SET @condition =                      
 CASE                       
 WHEN @segment = 'AFAPL' THEN 'left(cltcode,3) in (''310'',''380'',''270'')'                      
 WHEN @segment = 'NBFC' THEN 'left(cltcode,3) in (''310'',''380'',''270'')' ELSE 'left(cltcode,3) = ''270'''  END           
End           
Else          
Begin          
 SET @condition = 'left(cltcode,3) = '''+@Code+''''          
End           
        
create table #Temp          
(          
 SrNo int identity(1,1) not null,          
 VNo varchar(20)          
)        
        
set @str = 'insert into #Temp select distinct vno from ledger x (nolock)  where vdt > = '''+@fdate+'''   
and vdt < = '''+@tdate+'''+'' 23:59:59''                    
and  vtyp = ''8'' and exists                     
(Select vno from ledger b where x.vno = b.vno and '+@condition+'                     
and vtyp = ''8'' and vdt > = '''+@fdate+''' and vdt < = '''+@tdate+'''+'' 23:59:59'' )'          
exec(@str)          
        
delete from  mis.upload.dbo.Ledger_txt      
  
insert into mis.upload.dbo.Ledger_txt                              
select 'SrNo'+'|'+'vtyp'+'|'+'vno'+'|'+'vdt'+'|'+'cltcode'+'|'+'LONGNAME'+'|'+'drcr'+'|'+'vamt'+'|'+'narration'+'|'+'Branch Code'     
        
set @str = 'insert into mis.upload.dbo.Ledger_txt select ltrim(rtrim(Convert(Varchar,b.srno)))+''|''+  
ltrim(rtrim(Convert(Varchar,vtyp)))+''|''+ltrim(rtrim(Convert(Varchar,x.vno)))+''|''+  
ltrim(rtrim(Convert(Varchar(12),vdt,107)))+''|''+ltrim(rtrim(X.cltcode))+''|''+  
ltrim(rtrim(LONGNAME))+''|''+ltrim(rtrim(x.drcr))+''|''+ltrim(rtrim(convert(varchar,vamt)))+''|''+  
ltrim(rtrim(narration))+''|''+ltrim(rtrim(isnull(costname,'''')))  from            
(Select * from ledger x (nolock)  where vdt > = '''+@fdate+''' and vdt < = '''+@tdate+'''+'' 23:59:59''         and  vtyp = ''8'' and exists                     
(Select vno from ledger b (nolock) where x.vno = b.vno and '+@condition+'                     
and vtyp = ''8'' and vdt > = '''+@fdate+''' and vdt < = '''+@tdate+'''+'' 23:59:59'' ))x                    
left outer join                    
(select * from ACMAST (nolock))y                    
on x.cltcode=y.CLTCODE                    
left outer join                    
(select * from ledger2  (nolock))z                    
on x.vno = z.vno and x.lno = z.lno and x.cltcode = z.cltcode and x.vtyp = z.vtype                    
left outer join (select * from costmast (nolock))a on z.costcode = a.costcode          
left outer join (select * from #Temp)b on x.vno = b.vno'        
--print @str  
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_ACC_MONEYPAYOUTADHOC_NEW
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_ACC_MONEYPAYOUTADHOC_NEW]
	@STLTYPNO VARCHAR (16),
	@STRPAYMODE VARCHAR (4),
	@EFFDATE VARCHAR(11),
	@SDATE VARCHAR(11),
	@SETTTYPE1 VARCHAR(2),
	@SETTTYPE2 VARCHAR(2),
	@STATUSNAME VARCHAR(30),
	@BRANCHCODE VARCHAR(10),
	@NOREC VARCHAR(5) = '250',
	@REMARK VARCHAR(2) = '',
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@CLTYPE VARCHAR(4) = 'ALL', -- CLTYPE -> [WEB / NON-WEB / ALL]
	@PAYMODE CHAR(1),
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7)

AS

	/*
	EXEC V2_ACC_MONEYPAYOUTADHOC_NEW
		@STLTYPNO = '2005125',
		@STRPAYMODE = 'BOTH',
		@EFFDATE = 'FEB 17 2006',
		@SDATE = 'APR  1 2005',
		@SETTTYPE1 = 'N',
		@SETTTYPE2 = 'W',
		@STATUSNAME = 'BROKER',
		@BRANCHCODE = 'ALL',
		@NOREC = '1000',
		@REMARK = '',
		@FPARTY = '0',
		@TPARTY = 'zz',
		@CLTYPE = 'ALL',
		@PAYMODE = 'C'
	*/

	DECLARE
		@@SETTNO VARCHAR(7),
		@@PENDINGCNT VARCHAR(11),
		@@MAXDATE VARCHAR(11),
		@@SQL VARCHAR(3000)

	SET @@SETTNO = LEFT(@STLTYPNO, 7)
	SET @@PENDINGCNT = 0
	SET @@MAXDATE = 'JAN  1 1900'

	SET NOCOUNT ON

	IF @FPARTY = ''
	BEGIN
		SET @FPARTY = '0000000000'
	END

	IF @TPARTY = ''
	BEGIN
		SET @TPARTY = 'ZZZZZZZZZZ'
	END

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	/*=============================================================================
   LOOP FOR BROKER LOGIN TO REJECTION OF REQUESTS
         1. ALL OLD DATE PENDING REQUESTS
         2. MULTIPLE REQUESTS. ALL REQUESTS OTHER THAN THE FIRST REQUEST OF THE LOWEST AMOUNT ARE REJECTED.
	=============================================================================*/

	IF UPPER(@STATUSNAME) = 'BROKER'
	BEGIN
		SET @@PENDINGCNT =
		(
			SELECT
			COUNT(*)
			FROM SETTPAYOUT WITH(NOLOCK)
			WHERE STATUS='P'
			AND GENFLAG='A'
		)

		IF @@PENDINGCNT <> 0
		BEGIN
			SET @@MAXDATE =
			(
				SELECT
				LEFT(CONVERT(VARCHAR, MAX(REQUESTDT), 109), 11)
				FROM SETTPAYOUT WITH(NOLOCK)
				WHERE STATUS='P'
				AND GENFLAG='A'
			)
		END

   /*=============================================================================
               1. ALL OLD DATE PENDING REQUESTS
   =============================================================================*/
		UPDATE
			SETTPAYOUT
		SET
			STATUS = 'R'
		WHERE
			STATUS='P'
			AND GENFLAG='A'
			AND REQUESTDT < @@MAXDATE

		SELECT
			CLTCODE,
			AMT = MIN(AMOUNTTOBEPAID),
			SRNO = 0
		INTO
			#PAYOUT_REJECT
		FROM
			SETTPAYOUT WITH(NOLOCK)
		WHERE
			STATUS='P'
			AND GENFLAG='A'
		GROUP BY
			CLTCODE
		HAVING
			COUNT(*) > 1

		UPDATE
			#PAYOUT_REJECT
		SET
			SRNO = S.SRNO
		FROM
			(
				SELECT
					#PAYOUT_REJECT.CLTCODE,
					SRNO = MIN(SETTPAYOUT.SRNO)
				FROM
					SETTPAYOUT WITH(NOLOCK),
					#PAYOUT_REJECT WITH(NOLOCK)
				WHERE
					STATUS='P'
					AND GENFLAG='A'
					AND SETTPAYOUT.CLTCODE = #PAYOUT_REJECT.CLTCODE
					AND AMOUNTTOBEPAID = AMT
				GROUP BY
					#PAYOUT_REJECT.CLTCODE
			)
			S,
			#PAYOUT_REJECT P WITH(NOLOCK)
		WHERE
			S.CLTCODE = P.CLTCODE

		/*=============================================================================
		2. MULTIPLE REQUESTS. ALL REQUESTS OTHER THAN THE FIRST REQUEST OF THE LOWEST AMOUNT ARE REJECTED.
		=============================================================================*/
		UPDATE
			SETTPAYOUT
		SET
			STATUS = 'R'
		WHERE
			STATUS='P'
			AND GENFLAG='A'
			AND CLTCODE IN
			(
				SELECT
				   CLTCODE
				FROM
					#PAYOUT_REJECT WITH(NOLOCK)
			)
			AND SRNO NOT IN
			(
				SELECT
				   SRNO
				FROM
					#PAYOUT_REJECT WITH(NOLOCK)
			)
	END

	/*=============================================================================
	TEMP TABLE CREATION:
	      1. #LEDGERTMP: FINAL TABLE FOR LEDGER BALANCES AND BILL AMOUNT
	      2. #LEDGERBILLTMP: TABLE FOR POPULATING BILL AMOUNTS AS POSTED IN SETTPAYOUT TABLE FOR PENDING REQUESTS.
	=============================================================================*/
	CREATE TABLE [#LedgerBalanceUp]
	(
		[PartyCode] [varchar] (10) NULL ,
		[PartyName] [varchar] (100) NULL ,
		[ChequeName] [varchar] (100) NULL ,
		[branchcode] [varchar] (10) NULL ,
		[accat] [varchar] (10) NULL ,
		[BtoBPayment] [int] NULL ,
		[TOTLedBal] [money] NULL ,
		[NSELedBal] [money] NULL ,
		[BSELedBal] [money] NULL ,
		[FNOLedBal] [money] NULL ,
		[NETLedBal] [money] NULL ,
		[FAMLedBal] [money] NULL ,
		[Sett_No] [varchar] (7) NULL ,
		[NormalBillAmt] [money] NULL ,
		[T2TBillAmt] [money] NULL ,
		[BillAmt] [money] NULL ,
		[futurepayout] [money] NULL ,
		[shortage] [money] NULL ,
		[Amounttobepaid] [money] NULL ,
		[Paymode] [varchar] (1) NULL ,
		[Bankcode] [varchar] (10) NULL ,
		[GenFlag] [varchar] (1) NULL ,
		[CL_TYPE] [varchar] (3) NULL,
		[FAMILYCODE] [varchar] (10) NULL,
		[RunDate] [datetime] NULL ,
	)

	INSERT INTO
		#LedgerBalanceUp
	EXEC V2_GETLEDGERBALANCE_NEW
		@SDATE,
		@FPARTY,
		@TPARTY,
		'', --@STLNO
		'A', --@GENFLAG
		'HO', --@USER
		@EXCHANGE,
		@SEGMENT,
		@EFFDATE,
		'HO' --@COMP_FOR
	
	CREATE TABLE #LEDGERTMP
	(
		CLTCODE VARCHAR(10),
		ACNAME VARCHAR(100),
		CHEQUENAME VARCHAR(100),
		BRANCHCODE VARCHAR(10),
		ACCAT VARCHAR(10),
		BTOBPAYMENT INT,
		LEDGERBALANCE MONEY,
		LEDGERBALANCENSE MONEY,
		LEDGERBALANCEBSE MONEY,
		LEDGERBALANCEFNO MONEY,
		NETLEDBAL MONEY NULL,
		FAMLEDBAL MONEY NULL,
		BILLAMT MONEY,
		FUTUREPAYOUT MONEY,
		SHORTAGE MONEY,
		AMOUNTTOBEPAID MONEY,
		NARRATION VARCHAR (234) NULL,
		REMARK VARCHAR (234) NULL,
		PAYMODE VARCHAR(1),
		BANKCODE VARCHAR(10)
	)


	SELECT @@SQL = "	INSERT INTO #LEDGERTMP "
	SELECT @@SQL = @@SQL + "	SELECT "
	SELECT @@SQL = @@SQL + "		CLTCODE = L.PartyCode, "
	SELECT @@SQL = @@SQL + "		ACNAME = L.PartyName, "
	SELECT @@SQL = @@SQL + "		CHEQUENAME = L.ChequeName, "
	SELECT @@SQL = @@SQL + "		BRANCHCODE = L.branchcode, "
	SELECT @@SQL = @@SQL + "		ACCAT = L.accat, "
	SELECT @@SQL = @@SQL + "		BTOBPAYMENT = L.BtoBPayment, "
	SELECT @@SQL = @@SQL + "		LEDGERBALANCE = L.TOTLedBal, "
	SELECT @@SQL = @@SQL + "		LEDGERBALANCENSE = L.NSELedBal, "
	SELECT @@SQL = @@SQL + "		LEDGERBALANCEBSE = L.BSELedBal, "
	SELECT @@SQL = @@SQL + "		LEDGERBALANCEFNO = L.FNOLedBal, "
	SELECT @@SQL = @@SQL + "		NETLEDBAL = L.NETLEDBAL, "
	SELECT @@SQL = @@SQL + "		FAMLEDBAL = L.FAMLEDBAL, "
	SELECT @@SQL = @@SQL + "		BILLAMT = S.BILLAMT, "
	SELECT @@SQL = @@SQL + "		FUTUREPAYOUT = L.futurepayout, "
	SELECT @@SQL = @@SQL + "		SHORTAGE = L.shortage, "
	SELECT @@SQL = @@SQL + "		AMOUNTTOBEPAID = S.AMOUNTTOBEPAID, "
	SELECT @@SQL = @@SQL + "		S.NARRATION, "
	SELECT @@SQL = @@SQL + "		S.REMARK, "
	SELECT @@SQL = @@SQL + "		PAYMODE = L.Paymode, "
	SELECT @@SQL = @@SQL + "		BANKCODE = L.Bankcode "
	SELECT @@SQL = @@SQL + "	FROM "
	SELECT @@SQL = @@SQL + "		#LedgerBalanceUp L WITH(NOLOCK), "
	SELECT @@SQL = @@SQL + "		SETTPAYOUT S WITH(NOLOCK) "
	SELECT @@SQL = @@SQL + "	WHERE S.CLTCODE = L.PARTYCODE "
	SELECT @@SQL = @@SQL + "		AND STATUS = 'P' "
	SELECT @@SQL = @@SQL + "		AND S.GENFLAG = 'A' "
	SELECT @@SQL = @@SQL + "		AND UPPER(S.BRANCHCODE) LIKE (CASE WHEN UPPER('" + @BRANCHCODE + "') = 'ALL' THEN '%' ELSE UPPER('" + @BRANCHCODE + "') END) "

	IF @CLTYPE = 'WEB'
	BEGIN
		SELECT @@SQL = @@SQL + "	AND L.CL_TYPE = 'WEB' "
	END
	ELSE IF @CLTYPE = 'NWEB'
	BEGIN
		SELECT @@SQL = @@SQL + "	AND L.CL_TYPE <> 'WEB' "
	END

	IF @PAYMODE <> 'A'
	BEGIN
		SELECT @@SQL = @@SQL + "	AND L.PAYMODE = '" + @PAYMODE + "' "
	END

	IF @REMARK = 'ON'
	BEGIN
		SELECT @@SQL = @@SQL + "	AND S.REMARK <> '' "
	END

	EXEC (@@SQL)

	UPDATE
		TMP
	SET 
		CHEQUENAME = M.CHEQUENAME
	FROM 
		#LEDGERTMP TMP,
		MULTIBANKID M
	WHERE 
		M.CLTCODE = TMP.CLTCODE
		AND M.DEFAULTBANK = '1'
	
	SELECT
		PARTYCODE = L.CLTCODE,
		PARTYNAME = L.ACNAME,
		L.BRANCHCODE,
		L.BTOBPAYMENT,
		TOTLEDBAL = SUM(L.LEDGERBALANCENSE) + SUM(L.LEDGERBALANCEBSE) + SUM(L.LEDGERBALANCEFNO),
		NSELEDBAL = SUM(L.LEDGERBALANCENSE),
		BSELEDBAL = SUM(L.LEDGERBALANCEBSE),
		FNOLEDBAL = SUM(L.LEDGERBALANCEFNO),
		L.BILLAMT,
		L.PAYMODE,
		L.BANKCODE,
		L.REMARK,
		L.SHORTAGE,
		L.AMOUNTTOBEPAID,
		L.NARRATION,
		PARTYNAME = L.CHEQUENAME,
		L.ACCAT,
		L.FUTUREPAYOUT,
		NETLEDBAL = SUM(NETLEDBAL),
		FAMLEDBAL = SUM(FAMLEDBAL)
	FROM 
		#LEDGERTMP L WITH(NOLOCK)
	GROUP BY 
		L.CLTCODE,
		L.ACNAME,
		L.CHEQUENAME,
		L.BRANCHCODE,
		L.ACCAT,
		L.BTOBPAYMENT,
		L.BILLAMT,
		L.FUTUREPAYOUT,
		L.SHORTAGE,
		L.AMOUNTTOBEPAID,
		L.NARRATION,
		L.PAYMODE,
		L.REMARK,
		L.BANKCODE
	ORDER BY 
		L.BRANCHCODE,
		L.CLTCODE

/*  -----------------------------------EOF  ----------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_ACCOUNT_LISTING
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_ACCOUNT_LISTING]  
(  
    @FILTER VARCHAR(11), 
	@FROMPARTY VARCHAR(10), 
	@TOPARTY VARCHAR(10), 
	@STATUSID VARCHAR(20), 
	@STATUSNAME VARCHAR(20) 
)  
  
AS  
  
/*==============================================================================================================  
        EXEC V2_ACCOUNT_LISTING  
	    @FILTER = 'BRANCH', 
		@FROMPARTY = '0000000000', 
		@TOPARTY = 'ZZZZZZZZZZ', 
		@STATUSID = 'BROKER', 
		@STATUSNAME = 'BROKER' 
==============================================================================================================*/  
  
        SET NOCOUNT ON

		IF @FILTER = 'BRANCH' 
		BEGIN 
			SELECT DISTINCT 
				PARTY_CODE = BRANCH_CODE, 
				LONG_NAME = BRANCH 
			FROM CLIENT_DETAILS C, 
				BRANCH B 
			WHERE PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND BRANCH_CD = BRANCH_CODE 
					AND @STATUSNAME = (   
							CASE 
									WHEN @STATUSID = 'BRANCH' 
									THEN C.BRANCH_CD 
									WHEN @STATUSID = 'SUBBROKER' 
									THEN C.SUB_BROKER 
									WHEN @STATUSID = 'TRADER' 
									THEN C.TRADER 
									WHEN @STATUSID = 'FAMILY' 
									THEN C.FAMILY 
									WHEN @STATUSID = 'AREA' 
									THEN C.AREA 
									WHEN @STATUSID = 'REGION' 
									THEN C.REGION 
									WHEN @STATUSID = 'CLIENT' 
									THEN C.PARTY_CODE 
									ELSE 'BROKER' END) 
		END

		IF @FILTER = 'FAMILY' 
		BEGIN 
			SELECT DISTINCT 
				PARTY_CODE, 
				LONG_NAME 
			FROM CLIENT_DETAILS C 
			WHERE PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND PARTY_CODE = FAMILY 
					AND @STATUSNAME = (   
							CASE 
									WHEN @STATUSID = 'BRANCH' 
									THEN C.BRANCH_CD 
									WHEN @STATUSID = 'SUBBROKER' 
									THEN C.SUB_BROKER 
									WHEN @STATUSID = 'TRADER' 
									THEN C.TRADER 
									WHEN @STATUSID = 'FAMILY' 
									THEN C.FAMILY 
									WHEN @STATUSID = 'AREA' 
									THEN C.AREA 
									WHEN @STATUSID = 'REGION' 
									THEN C.REGION 
									WHEN @STATUSID = 'CLIENT' 
									THEN C.PARTY_CODE 
									ELSE 'BROKER' END) 
		END

		IF @FILTER = 'CLIENT' 
		BEGIN
			SELECT 
				PARTY_CODE, 
				LONG_NAME 
			FROM CLIENT_DETAILS C
			WHERE PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND @STATUSNAME = (   
							CASE 
									WHEN @STATUSID = 'BRANCH' 
									THEN C.BRANCH_CD 
									WHEN @STATUSID = 'SUBBROKER' 
									THEN C.SUB_BROKER 
									WHEN @STATUSID = 'TRADER' 
									THEN C.TRADER 
									WHEN @STATUSID = 'FAMILY' 
									THEN C.FAMILY 
									WHEN @STATUSID = 'AREA' 
									THEN C.AREA 
									WHEN @STATUSID = 'REGION' 
									THEN C.REGION 
									WHEN @STATUSID = 'CLIENT' 
									THEN C.PARTY_CODE 
									ELSE 'BROKER' END) 
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_AGEING_CAL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_AGEING_CAL] 
(  
        @@BALDATE INT 
)  
  
AS  
  
/*==============================================================================================================  
        EXEC V2_AGEING_CAL  
                @@BALDATE = 20070626 
==============================================================================================================*/  
  

SET NOCOUNT ON

DECLARE 
    @@BUCKET_1 INT, 
    @@BUCKET_2 INT, 
    @@BUCKET_3 INT, 
    @@BUCKET_4 INT, 
    @@CALDATE INT, 
    @@BUCKET INT, 
    @@UPDATEDATE DATETIME  

    SELECT @@UPDATEDATE = GETDATE() 
    
    SET @@BUCKET = 0 
    
/*==============================================================================================================  
    Populate No of Days Bucket Values for Canned Ageing
        Also, identify & store the dates for Balance Computation based on Bucket Values
==============================================================================================================*/  

    SELECT 
        @@BUCKET_1 = BUCKET_1, 
        @@BUCKET_2 = BUCKET_2, 
        @@BUCKET_3 = BUCKET_3, 
        @@BUCKET_4 = BUCKET_4 
    FROM V2_AGEINGBUCKETS
    
    SELECT BUCKET = 0, BUCKET_DAYS = 0, BALDATE = @@BALDATE INTO #BUCKETS 
    
    INSERT INTO #BUCKETS SELECT 1, @@BUCKET_1, CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(CHAR,@@BALDATE)) - @@BUCKET_1,112)) 
    INSERT INTO #BUCKETS SELECT 2, @@BUCKET_2, CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(CHAR,@@BALDATE)) - @@BUCKET_2,112)) 
    INSERT INTO #BUCKETS SELECT 3, @@BUCKET_3, CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(CHAR,@@BALDATE)) - @@BUCKET_3,112)) 
    INSERT INTO #BUCKETS SELECT 4, @@BUCKET_4, CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(CHAR,@@BALDATE)) - @@BUCKET_4,112)) 

/*==============================================================================================================  
    Populate default NSEFO Margin Settings for considering Margin Requirement (after adjusting ]collateral) 
==============================================================================================================*/  
	DECLARE 
		@@SPAN_MARGIN INT,
		@@EXPOSURE_MARGIN INT

	SELECT 
        @@SPAN_MARGIN = SPAN_MARGIN, 
        @@EXPOSURE_MARGIN = EXPOSURE_MARGIN 
	FROM V2_CLIENTPROFILES_FA 
	WHERE CLTCODE = 'ALL'

/*==============================================================================================================  
    Create Based Data for calculating Ageing
        The base data is created using the summarized data as populated in the V2_ACCOUNTBALANCES Table
==============================================================================================================*/  
    TRUNCATE TABLE V2_AGEINGDATA_TMP
    
    SELECT DISTINCT CLTCODE  
    INTO #CLIENT 
    FROM V2_ACCOUNTBALANCES 
    
    CREATE NONCLUSTERED INDEX [MAINIDX] ON [dbo].[#CLIENT] 
    (
    	[CLTCODE] ASC
    )

    /*==============================================================================================================  
        Voucher Date wise Balances for the date 
    ==============================================================================================================*/  
    INSERT INTO V2_AGEINGDATA_TMP 
    SELECT 
        BALDATETYPE = 1, 
    	V.CLTCODE, 
    	V.SEGMENTCODE, 
    	BALANCE = SUM(BALCR - BALDR), 
        BUCKET_1 = 0, 
        BUCKET_2 = 0, 
        BUCKET_3 = 0, 
        BUCKET_4 = 0, 
        'BACKEND', 
        @@UPDATEDATE 
    FROM 
    	V2_ACCOUNTBALANCES V, 
    	#CLIENT C, 
    	PARAMETER P 
    WHERE 
    	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
    	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
    	AND VDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
    	AND V.CLTCODE = C.CLTCODE 
    GROUP BY 
    	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE
    HAVING SUM(BALCR - BALDR) <> 0 
    
    /*==============================================================================================================  
        Effective Date wise Balances for the date 
    ==============================================================================================================*/  
    INSERT INTO V2_AGEINGDATA_TMP 
    SELECT 
        BALDATETYPE = 2, 
    	V.CLTCODE, 
    	V.SEGMENTCODE, 
    	BALANCE = SUM(BALCR - BALDR), 
        BUCKET_1 = 0, 
        BUCKET_2 = 0, 
        BUCKET_3 = 0, 
        BUCKET_4 = 0, 
        'BACKEND', 
        @@UPDATEDATE 
    FROM 
    	V2_ACCOUNTBALANCES V, 
    	#CLIENT C, 
    	PARAMETER P 
    WHERE 
    	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
    	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
    	AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
    	AND V.CLTCODE = C.CLTCODE 
    GROUP BY 
    	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE
    HAVING SUM(BALCR - BALDR) <> 0 

    INSERT INTO V2_AGEINGDATA_TMP 
    SELECT 
        BALDATETYPE = 2, 
    	V.CLTCODE, 
    	V.SEGMENTCODE, 
    	BALANCE = SUM(BALDR - BALCR), 
        BUCKET_1 = 0, 
        BUCKET_2 = 0, 
        BUCKET_3 = 0, 
        BUCKET_4 = 0, 
        'BACKEND', 
        @@UPDATEDATE 
    FROM 
    	V2_ACCOUNTBALANCES V, 
    	#CLIENT C, 
    	PARAMETER P 
    WHERE 
    	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
    	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
    	AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
        AND VDT < CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) 
    	AND V.CLTCODE = C.CLTCODE 
    GROUP BY 
    	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE
    HAVING SUM(BALDR - BALCR) <> 0 

    /*==============================================================================================================  
        NSEFO Margin Requirement for the date 
    ==============================================================================================================*/  
	INSERT INTO V2_AGEINGDATA_TMP  
	SELECT 
        BALDATETYPE = 0, 
    	V.CLTCODE, 
    	SEGMENTCODE = 3, 
    	BALANCE = NONCASH - (
                            (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                            + 
                            (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                ), 
        BUCKET_1 = 0, 
        BUCKET_2 = 0, 
        BUCKET_3 = 0, 
        BUCKET_4 = 0, 
        'BACKEND', 
        @@UPDATEDATE 
	FROM 
		( 
			SELECT 
				CLTCODE = ISNULL(C.CLTCODE,M.CLTCODE), 
				NONCASH = ISNULL(NONCASH,0), 
				TOTALMARGIN = ISNULL(TOTALMARGIN,0), 
				MTOM = ISNULL(MTOM,0) 
			FROM 
				(
					SELECT CLTCODE = PARTY_CODE, NONCASH 
					FROM COLLATERAL 
					WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) = 
                        (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(TRANS_DATE),112)) FROM COLLATERAL WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) <= @@BALDATE AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES') 
					AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES'
				) C FULL OUTER JOIN 
				(
					SELECT CLTCODE = PARTY_CODE, TOTALMARGIN, MTOM 
					FROM NSEFO.DBO.FOMARGINNEW 
					WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) = 
                        (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(MDATE),112)) FROM NSEFO.DBO.FOMARGINNEW WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) <= @@BALDATE) 
				) M 
			ON M.CLTCODE = C.CLTCODE 
		 ) V LEFT OUTER JOIN V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE)
	WHERE NONCASH - (
                        (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                        + 
                        (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                            ) < 0 

    DELETE #CLIENT WHERE CLTCODE NOT IN (SELECT DISTINCT CLTCODE FROM V2_AGEINGDATA_TMP)
    
/*==============================================================================================================  
    Begin Loop for calculating Balances for the dates computed based on Bucket Values 
        Provision for 4 + 1 Buckets has been provided
==============================================================================================================*/  
    WHILE @@BUCKET <= 4 
    BEGIN 
        SELECT @@CALDATE = BALDATE FROM #BUCKETS WHERE BUCKET = @@BUCKET 
    
    /*==============================================================================================================  
        Voucher Date wise Balances as on the date populate against each Bucket
    ==============================================================================================================*/  
        INSERT INTO V2_AGEINGDATA_TMP 
        SELECT 
            BALDATETYPE = 1, 
        	V.CLTCODE, 
        	V.SEGMENTCODE, 
        	BALANCE = 0, 
            BUCKET_1 = (CASE WHEN @@BUCKET = 1 THEN SUM(BALCR - BALDR) ELSE 0 END), 
            BUCKET_2 = (CASE WHEN @@BUCKET = 2 THEN SUM(BALCR - BALDR) ELSE 0 END),  
            BUCKET_3 = (CASE WHEN @@BUCKET = 3 THEN SUM(BALCR - BALDR) ELSE 0 END), 
            BUCKET_4 = (CASE WHEN @@BUCKET = 4 THEN SUM(BALCR - BALDR) ELSE 0 END), 
            'BACKEND', 
            @@UPDATEDATE 
        FROM 
        	V2_ACCOUNTBALANCES V, 
        	#CLIENT C, 
        	PARAMETER P 
        WHERE 
        	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@CALDATE
        	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@CALDATE 
        	AND VDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@CALDATE 
        	AND V.CLTCODE = C.CLTCODE 
        GROUP BY 
        	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE
        HAVING SUM(BALCR - BALDR) <> 0 

    /*==============================================================================================================  
        Effective Date wise Balances as on the date populate against each Bucket
    ==============================================================================================================*/  
        INSERT INTO V2_AGEINGDATA_TMP 
        SELECT 
            BALDATETYPE = 2, 
        	V.CLTCODE, 
        	V.SEGMENTCODE, 
        	BALANCE = 0, 
            BUCKET_1 = (CASE WHEN @@BUCKET = 1 THEN SUM(BALCR - BALDR) ELSE 0 END), 
            BUCKET_2 = (CASE WHEN @@BUCKET = 2 THEN SUM(BALCR - BALDR) ELSE 0 END),  
            BUCKET_3 = (CASE WHEN @@BUCKET = 3 THEN SUM(BALCR - BALDR) ELSE 0 END), 
            BUCKET_4 = (CASE WHEN @@BUCKET = 4 THEN SUM(BALCR - BALDR) ELSE 0 END), 
            'BACKEND', 
            @@UPDATEDATE 
        FROM 
        	V2_ACCOUNTBALANCES V, 
        	#CLIENT C, 
        	PARAMETER P 
        WHERE 
        	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@CALDATE
        	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@CALDATE 
        	AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@CALDATE 
        	AND V.CLTCODE = C.CLTCODE 
        GROUP BY 
        	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE
        HAVING SUM(BALCR - BALDR) <> 0 

        INSERT INTO V2_AGEINGDATA_TMP 
        SELECT 
            BALDATETYPE = 2, 
        	V.CLTCODE, 
        	V.SEGMENTCODE, 
        	BALANCE = 0, 
            BUCKET_1 = (CASE WHEN @@BUCKET = 1 THEN SUM(BALDR - BALCR) ELSE 0 END), 
            BUCKET_2 = (CASE WHEN @@BUCKET = 2 THEN SUM(BALDR - BALCR) ELSE 0 END),  
            BUCKET_3 = (CASE WHEN @@BUCKET = 3 THEN SUM(BALDR - BALCR) ELSE 0 END), 
            BUCKET_4 = (CASE WHEN @@BUCKET = 4 THEN SUM(BALDR - BALCR) ELSE 0 END), 
            'BACKEND', 
            @@UPDATEDATE 
        FROM 
        	V2_ACCOUNTBALANCES V, 
        	#CLIENT C, 
        	PARAMETER P 
        WHERE 
        	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@CALDATE
        	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@CALDATE 
        	AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@CALDATE 
        	AND V.CLTCODE = C.CLTCODE 
        GROUP BY 
        	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE
        HAVING SUM(BALDR - BALCR) <> 0 

    /*==============================================================================================================  
        NSEFO Margin Requirement as on the date populate against each Bucket
    ==============================================================================================================*/  
    	INSERT INTO V2_AGEINGDATA_TMP  
    	SELECT 
            BALDATETYPE = 0, 
        	V.CLTCODE, 
        	SEGMENTCODE = 3, 
        	BALANCE = NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ), 
            BUCKET_1 = 0, 
            BUCKET_2 = 0, 
            BUCKET_3 = 0, 
            BUCKET_4 = 0, 
            'BACKEND', 
            @@UPDATEDATE 
    	FROM 
    		( 
    			SELECT 
    				CLTCODE = ISNULL(C.CLTCODE,M.CLTCODE), 
    				NONCASH = ISNULL(NONCASH,0), 
    				TOTALMARGIN = ISNULL(TOTALMARGIN,0), 
    				MTOM = ISNULL(MTOM,0) 
    			FROM 
    				(
    					SELECT CLTCODE = PARTY_CODE, NONCASH 
    					FROM COLLATERAL 
    					WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) = 
                            (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(TRANS_DATE),112)) FROM COLLATERAL WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) <= @@CALDATE AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES') 
    					AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES'
    				) C FULL OUTER JOIN 
    				(
    					SELECT CLTCODE = PARTY_CODE, TOTALMARGIN, MTOM 
    					FROM NSEFO.DBO.FOMARGINNEW 
    					WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) = 
                            (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(MDATE),112)) FROM NSEFO.DBO.FOMARGINNEW WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) <= @@CALDATE) 
    				) M 
    			ON M.CLTCODE = C.CLTCODE 
    		 ) V LEFT OUTER JOIN V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE)
    	WHERE NONCASH - (
                            (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                            + 
                            (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                ) < 0 

        SET @@BUCKET = @@BUCKET + 1 
    END

    /*==============================================================================================================  
        Margin Requirement dummy data populated for Effective Date wise Calculation
    ==============================================================================================================*/  
    INSERT INTO V2_AGEINGDATA_TMP 
    SELECT 2,CLTCODE,SEGMENTCODE,BALANCE,BUCKET_1,BUCKET_2,BUCKET_3,BUCKET_4,UPDATEBY,UPDATEDATE 
    FROM V2_AGEINGDATA_TMP WHERE BALDATETYPE = 0
    
    UPDATE V2_AGEINGDATA_TMP SET BALDATETYPE = 1 WHERE BALDATETYPE = 0
    
/*==============================================================================================================  
    Begin transaction to compute Final Ageing based on the Data created above 
==============================================================================================================*/  
    BEGIN TRAN
        TRUNCATE TABLE V2_AGEINGDATA 
    
    /*==============================================================================================================  
        Computation Ageing Data based on the Consolidated Balances
    ==============================================================================================================*/  
        INSERT INTO V2_AGEINGDATA 
        SELECT 
            @@BALDATE, 
            BALDATETYPE, 
            CLTCODE, 
            SEGMENTCODE = 0, 
            SUM(BALANCE), 
            SUM(BUCKET_1), 
            SUM(BUCKET_2), 
            SUM(BUCKET_3), 
            SUM(BUCKET_4), 
            UPDATEBY, 
            UPDATEDATE 
        FROM V2_AGEINGDATA_TMP 
        GROUP BY 
            BALDATETYPE, 
            CLTCODE, 
            UPDATEBY, 
            UPDATEDATE     
    
    /*==============================================================================================================  
        Computation Ageing Data based on the Segment Wise Balances
    ==============================================================================================================*/  
        INSERT INTO V2_AGEINGDATA 
        SELECT 
            @@BALDATE, 
            BALDATETYPE, 
            CLTCODE, 
            SEGMENTCODE, 
            SUM(BALANCE), 
            SUM(BUCKET_1), 
            SUM(BUCKET_2), 
            SUM(BUCKET_3), 
            SUM(BUCKET_4), 
            UPDATEBY, 
            UPDATEDATE 
        FROM V2_AGEINGDATA_TMP 
        GROUP BY 
            BALDATETYPE, 
            CLTCODE, 
            SEGMENTCODE, 
            UPDATEBY, 
            UPDATEDATE     
    
    /*==============================================================================================================  
        Computation Final Ageing based on the Ageing Data populated above 
            Value in each Bucket is updated after desired splitting of the net balance of the Client
    ==============================================================================================================*/  
        TRUNCATE TABLE V2_AGEINGFINAL 
        INSERT INTO V2_AGEINGFINAL 
        SELECT BALDATE,BALDATETYPE,CLTCODE,SEGMENTCODE,BALANCE,BUCKET_1,BUCKET_2,BUCKET_3,BUCKET_4,BUCKET_5 = 0,
        UPDATEBY,UPDATEDATE 
        FROM V2_AGEINGDATA
        
        UPDATE V2_AGEINGFINAL 
        SET BUCKET_1 = 
            (CASE 
                WHEN SIGN(BUCKET_1) = SIGN(BALANCE) 
                    AND ABS(BALANCE) > ABS(BUCKET_1) 
                THEN (ABS(BALANCE) - ABS(BUCKET_1)) * SIGN(BALANCE) 
            ELSE 
            CASE 
                WHEN SIGN(BUCKET_1) <> SIGN(BALANCE) 
                THEN BALANCE 
            ELSE 0 END END)
        
        UPDATE V2_AGEINGFINAL 
        SET BUCKET_2 = 
            (CASE 
                WHEN SIGN(BUCKET_2) = SIGN(BALANCE) 
                    AND ABS(BALANCE) - ABS(BUCKET_1) > ABS(BUCKET_2) 
                THEN (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2)) * SIGN(BALANCE) 
            ELSE 
            CASE 
                WHEN SIGN(BUCKET_2) <> SIGN(BALANCE) 
                THEN (ABS(BALANCE) - ABS(BUCKET_1)) * SIGN(BALANCE) 
            ELSE 0 END END)
        
        UPDATE V2_AGEINGFINAL 
        SET BUCKET_3 = 
            (CASE 
                WHEN SIGN(BUCKET_3) = SIGN(BALANCE) 
                    AND ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) > ABS(BUCKET_3) 
                THEN (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) - ABS(BUCKET_3)) * SIGN(BALANCE) 
            ELSE 
            CASE 
                WHEN SIGN(BUCKET_3) <> SIGN(BALANCE) 
                THEN (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2)) * SIGN(BALANCE) 
            ELSE 0 END END)
        
        UPDATE V2_AGEINGFINAL 
        SET BUCKET_4 = 
            (CASE 
                WHEN SIGN(BUCKET_4) = SIGN(BALANCE) 
                    AND ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) - ABS(BUCKET_3) > ABS(BUCKET_4) 
                THEN (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) - ABS(BUCKET_3) - ABS(BUCKET_4)) * SIGN(BALANCE) 
            ELSE 
            CASE 
                WHEN SIGN(BUCKET_4) <> SIGN(BALANCE) 
                THEN (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) - ABS(BUCKET_3)) * SIGN(BALANCE) 
            ELSE 0 END END)
        
        UPDATE V2_AGEINGFINAL 
        SET BUCKET_5 = 
            (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) - ABS(BUCKET_3) - ABS(BUCKET_4)) * SIGN(BALANCE) 
        WHERE 
            ABS(BALANCE) > ABS(BUCKET_1) + ABS(BUCKET_2) + ABS(BUCKET_3) + ABS(BUCKET_4)

    TRUNCATE TABLE V2_AGEINGBUCKETS_TMP 

    INSERT INTO V2_AGEINGBUCKETS_TMP SELECT @@BUCKET_1, @@BUCKET_2, @@BUCKET_3, @@BUCKET_4 

    COMMIT
    
/*==============================================================================================================  
    Clean Temporary Table 
==============================================================================================================*/  
    TRUNCATE TABLE V2_AGEINGDATA_TMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_AGEING_REPORT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_AGEING_REPORT] 
(  
    @FILTER VARCHAR(11), 
    @FROMPARTY VARCHAR(10), 
    @TOPARTY VARCHAR(10), 
    @FILTERON VARCHAR(2), 
    @AGEINGON VARCHAR(3), 
    @SEGMENTCODE INT, 
	@STATUSID VARCHAR(20), 
	@STATUSNAME VARCHAR(20), 
    @BRANCH_CD VARCHAR(10) = '%'  
)  
  
AS  

SELECT PARTY_CODE, LONG_NAME INTO #CLIENT FROM CLIENT_DETAILS C WHERE 1 = 2

INSERT INTO #CLIENT 
EXEC V2_ACCOUNT_LISTING  
	    @FILTER, 
		@FROMPARTY, 
		@TOPARTY, 
		@STATUSID, 
		@STATUSNAME 


    SELECT 
    	CLTCODE = C1.PARTY_CODE, 
    	BALANCE = SUM(BALANCE), 
        BUCKET_1 = SUM(BUCKET_1), 
        BUCKET_2 = SUM(BUCKET_2), 
        BUCKET_3 = SUM(BUCKET_3), 
        BUCKET_4 = SUM(BUCKET_4), 
        BUCKET_5 = SUM(BUCKET_5), 
    	C1.LONG_NAME 
    FROM 
        V2_AGEINGFINAL V, 
    	CLIENT_DETAILS C, 
    	#CLIENT C1  
    WHERE 
        CLTCODE BETWEEN @FROMPARTY AND @TOPARTY 
        AND BALDATETYPE = (CASE WHEN @AGEINGON = 'VDT' THEN 1 ELSE 2 END)
        AND SEGMENTCODE = @SEGMENTCODE  
        AND SIGN(BALANCE) = (CASE WHEN @FILTERON = 'DR' THEN -1 ELSE 1 END)
        AND V.CLTCODE = C.PARTY_CODE     	
        AND C1.PARTY_CODE = ( 
    		CASE 
    			WHEN @FILTER = 'BRANCH' 
    			THEN C.BRANCH_CD 
    			WHEN @FILTER = 'CLIENT' 
    			THEN C.PARTY_CODE 
    			WHEN @FILTER = 'FAMILY' 
    			THEN C.FAMILY 
    		END) 
        AND C.BRANCH_CD LIKE @BRANCH_CD 
    GROUP BY 
        C1.PARTY_CODE, C1.LONG_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_AGEING_REPORT_DETAIL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_AGEING_REPORT_DETAIL] 
(  
    @PARTY VARCHAR(10), 
    @AGEINGON VARCHAR(3), 
	@STATUSID VARCHAR(20), 
	@STATUSNAME VARCHAR(20)
)  
  
AS  

    SELECT PARTY_CODE, LONG_NAME INTO #CLIENT FROM CLIENT_DETAILS C WHERE 1 = 2
    
    INSERT INTO #CLIENT 
    EXEC V2_ACCOUNT_LISTING  
    	    'CLIENT', 
    		@PARTY, 
    		@PARTY, 
    		@STATUSID, 
    		@STATUSNAME 

    SELECT 
    	CLTCODE = C.PARTY_CODE, 
        EXCHANGE, 
        SEGMENT, 
    	BALANCE = SUM(BALANCE), 
        BUCKET_1 = SUM(BUCKET_1), 
        BUCKET_2 = SUM(BUCKET_2), 
        BUCKET_3 = SUM(BUCKET_3), 
        BUCKET_4 = SUM(BUCKET_4), 
        BUCKET_5 = SUM(BUCKET_5), 
    	C.LONG_NAME 
    FROM 
        V2_AGEINGFINAL V, 
    	#CLIENT C, 
        V2_MULTIACCOUNTS A 
    WHERE 
        CLTCODE = @PARTY 
        AND BALDATETYPE = (CASE WHEN @AGEINGON = 'VDT' THEN 1 ELSE 2 END)
        AND V.SEGMENTCODE = A.SEGMENTCODE  
        AND V.CLTCODE = C.PARTY_CODE     	
    GROUP BY 
        C.PARTY_CODE, 
        EXCHANGE, 
        SEGMENT, 
        C.LONG_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BULKPAYOUTPOSTING
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_BULKPAYOUTPOSTING]
(
      @SESSIONID VARCHAR(50),
      @UNAME VARCHAR(50),
      @S_SESSIONID VARCHAR(50),
      @SETT_NO VARCHAR(50),
      @SETT_TYPE VARCHAR(50),
      @GENFLAG VARCHAR(1)
)

AS

-- EXEC V2_BULKPAYOUTPOSTING '1971159042202006', 'BOXM', '1971159042', '2006012', 'N', 'S'

       SET NOCOUNT ON

       DECLARE
       @@NEWVNO AS VARCHAR(12),
       @@MAXCOUNT AS INT,
       @@VDT AS VARCHAR(11),
       @@BANKBRANCH AS VARCHAR(10),
       @@BANKCOST AS NUMERIC,
		 @@VNOCUR AS CURSOR,
       @@LNOCUR AS CURSOR,
       @@LNOVNO AS VARCHAR(12),
       @@ERROR_COUNT INT,
       @@STD_DATE VARCHAR(11),
       @@LST_DATE VARCHAR(11),
       @@VNOMETHOD INT,
       @@ACNAME CHAR(100),
       @@BOOKTYPE CHAR(2),
       @@MICRNO VARCHAR(10),
       @@DRCR VARCHAR(1),
       @@VTYP SMALLINT,
	    @@BNKCODE VARCHAR(100),
	    @@MAXVNO AS INT

       -------------------------- UPDATE BANK CODE DETAILS ------------------------
       UPDATE
           P
           SET BNKNAME = A.ACNAME,
           BRANCHCODE = A.BRANCHCODE,
           MICRNO = A.MICRNO,
           BOOKTYPE = A.BOOKTYPE,
           ACCDTLS = A.ACCDTLS,
           UPDFLAG = 'Y'
       FROM V2_PAYOUT_TEMP P,
           ACMAST A
       WHERE P.BNKCODE = A.CLTCODE
           AND ACCAT = 2
           AND SESSIONID = @SESSIONID

       UPDATE
           P
           SET COSTCODE = C.COSTCODE,
           ACNAME = A.LONGNAME
       FROM ACMAST A,
           COSTMAST C,
           V2_PAYOUT_TEMP P
       WHERE A.CLTCODE = ACCODE
           AND ACCAT IN ('4')
           AND A.BRANCHCODE = C.COSTNAME


       UPDATE
           P
           SET BANKCOST = C.COSTCODE
       FROM ACMAST A,
           COSTMAST C,
           V2_PAYOUT_TEMP P
       WHERE A.CLTCODE = BNKCODE
           AND ACCAT IN ('2')
           AND A.BRANCHCODE = C.COSTNAME


      UPDATE
           V2_PAYOUT_TEMP
           SET BANKCOST = COSTCODE
       WHERE BANKCOST = ''

     -------------------------- VALIDATION BASED ON UPDFLAG ------------------------
     SELECT @@ERROR_COUNT = COUNT(1) FROM
          (
               SELECT DISTINCT ACCODE
               FROM V2_PAYOUT_TEMP WITH(NOLOCK)
               WHERE UPDFLAG = 'N' AND SESSIONID = @SESSIONID
            ) A

     IF @@ERROR_COUNT > 0
     BEGIN
          SELECT 'FOLLOWING CLIENTS DO NOT EXIST'
          UNION ALL
          SELECT DISTINCT ACCODE
          FROM V2_PAYOUT_TEMP WITH(NOLOCK)
          WHERE UPDFLAG = 'N' AND SESSIONID = @SESSIONID
          DELETE FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID
          RETURN
     END

     --------------------------AUTO GENERATION OF VNO ------------------------
     SELECT
          @@STD_DATE = LEFT(SDTCUR, 11),
          @@LST_DATE = LEFT(LDTCUR, 11),
          @@VNOMETHOD = VNOFLAG
     FROM PARAMETER
     WHERE CURYEAR = 1     

	 SET @@VNOCUR = CURSOR FOR
    SELECT DISTINCT
		BNKCODE,
		BOOKTYPE,
		VTYP
	 FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	 WHERE
		SESSIONID = @SESSIONID

	 OPEN @@VNOCUR
	 FETCH NEXT
	 FROM
		 @@VNOCUR
	 INTO
		 @@BNKCODE,
		 @@BOOKTYPE,
		 @@VTYP
	 WHILE @@FETCH_STATUS = 0
	 BEGIN
		CREATE TABLE
			#BANK_VNO
			(
				SRNO INT,
				NEWSRNO INT IDENTITY (1, 1)
			)

			INSERT INTO
				#BANK_VNO
			SELECT
				DISTINCT SRNO
			FROM
				V2_PAYOUT_TEMP WITH(NOLOCK)
			WHERE
				BNKCODE = @@BNKCODE
				AND BOOKTYPE = @@BOOKTYPE

		SELECT TOP 1
			@@VDT = VDT
		FROM
			V2_PAYOUT_TEMP WITH(NOLOCK)

		SELECT  
			LASTVNO  
		INTO #VNO  
		FROM  
			LASTVNO  
		WHERE  
			1 = 2

		SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  

		INSERT INTO #VNO
			EXEC ACC_GENVNO_NEW
			@@VDT,
			@@VTYP,
			@@BOOKTYPE,
			@@STD_DATE,
			@@LST_DATE,  
			@@MAXVNO

		SELECT  
			@@NEWVNO = LASTVNO  
		FROM  
			#VNO

		UPDATE
			P
		SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1)) 
		FROM
			V2_PAYOUT_TEMP P WITH(NOLOCK),
			#BANK_VNO BV
		WHERE
			P.SRNO = BV.SRNO 
			AND SESSIONID = @SESSIONID
    
		DROP TABLE #VNO  
		DROP TABLE #BANK_VNO

		FETCH NEXT  
		FROM @@VNOCUR  
		INTO  
			@@BNKCODE,  
			@@BOOKTYPE,
			@@VTYP  
	END  
	
	DEALLOCATE @@VNOCUR

     --------------------------AUTO GENERATION OF LNO ------------------------
     UPDATE
          V2_PAYOUT_TEMP
     SET LNO = 2
     WHERE VNO IN
          (
               SELECT
               VNO
               FROM V2_PAYOUT_TEMP WITH(NOLOCK)
               WHERE SESSIONID = @SESSIONID
               GROUP BY VNO
               HAVING COUNT(*) = 1
          )

     SET @@LNOCUR = CURSOR FOR
     SELECT
          VNO
     FROM V2_PAYOUT_TEMP WITH(NOLOCK) WHERE SESSIONID = @SESSIONID
     GROUP BY VNO
     HAVING COUNT(*) > 1

     OPEN @@LNOCUR
     FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
     WHILE @@FETCH_STATUS = 0

     BEGIN
          CREATE TABLE [#LNOGEN] (
          VNO VARCHAR(12),
          SNO INT,
          LNO INT IDENTITY(1,1))

          INSERT INTO #LNOGEN
          SELECT
          VNO,
          SRNO
          FROM V2_PAYOUT_TEMP WITH(NOLOCK)
          WHERE VNO = @@LNOVNO AND SESSIONID = @SESSIONID
          ORDER BY SRNO

          UPDATE
          V2_PAYOUT_TEMP
          SET LNO = L.LNO + 1
          FROM #LNOGEN L
          WHERE V2_PAYOUT_TEMP.VNO = L.VNO
          AND V2_PAYOUT_TEMP.SRNO = L.SNO
          AND V2_PAYOUT_TEMP.LNO = 0 AND SESSIONID = @SESSIONID

          DROP TABLE #LNOGEN
          FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
     END
     CLOSE @@LNOCUR
     DEALLOCATE @@LNOCUR

     --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------
     INSERT
     INTO LEDGER1
     SELECT
          BNKNAME,
          BRNNAME = BRCODE,
          DD = LEFT(PAYMODE, 1),
          DDNO,
          DDDT = VDT,
          RELDT = '',
          RELAMT = AMT,
          REFNO = 0,
          RECEIPTNO = 0,
          VTYP,
          VNO,
          LNO = 2,
          DRCR,
          BOOKTYPE,
          MICRNO,
          SLIPNO = 0,
          SLIPDATE = '',
          CHEQUEINNAME = ISNULL(ACNAME,''),
          CHQPRINTED = 0,
          CLEAR_MODE = ''
     FROM
          V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID

     /*==============================
       CLIENT SIDE RECORD
     ==============================*/
     INSERT
     INTO LEDGER
     SELECT
          VTYP,
          VNO,
          EDT,
          LNO,
          ACNAME,
          DRCR,
          VAMT = AMT,
          VDT,
          VNO1 = VNO,
          REFNO = 0,
          BALAMT = AMT,
          NODAYS = 0,
          CDT = GETDATE(),
          CLTCODE = ACCODE,
          BOOKTYPE,
          ENTEREDBY = @UNAME,
          PDT = GETDATE(),
          CHECKEDBY = @UNAME,
          ACTNODAYS = 0,
          NARRATION
     FROM
          V2_PAYOUT_TEMP
     WHERE
          SESSIONID = @SESSIONID

     INSERT INTO LEDGER2
     SELECT
         VTYP,
         VNO,
         LNO,
         DRCR,
         CAMT = AMT,
         COSTCODE,
         BOOKTYPE,
         CLTCODE = ACCODE
     FROM
         V2_PAYOUT_TEMP
     WHERE
          SESSIONID = @SESSIONID
          AND COSTCODE = BANKCOST

      /*==============================
            BANK SIDE RECORD
      ==============================*/
     INSERT
     INTO LEDGER
     SELECT
          VTYP,
          VNO,
          EDT,
          LNO = 1,
          BNKNAME,
          DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
          VAMT = AMT,
          VDT,
          VNO1 = VNO,
          REFNO = 0,
          BALAMT = AMT,
          NODAYS = 0,
          CDT = GETDATE(),
          CLTCODE = BNKCODE,
          BOOKTYPE,
          ENTEREDBY = @UNAME,
          PDT = GETDATE(),
          CHECKEDBY = @UNAME,
          ACTNODAYS = 0,
          NARRATION
     FROM
          V2_PAYOUT_TEMP
     WHERE
          SESSIONID = @SESSIONID


     INSERT INTO LEDGER2
     SELECT
          VTYP,
          VNO,
          LNO = 1,
          DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
          CAMT = AMT,
          COSTCODE,
          BOOKTYPE,
          CLTCODE = BNKCODE
     FROM
          V2_PAYOUT_TEMP
     WHERE
          SESSIONID = @SESSIONID
          AND COSTCODE = BANKCOST

     UPDATE V2_PAYOUT_TEMP SET LEDGER2_UPD = 'Y' WHERE SESSIONID = @SESSIONID AND COSTCODE = BANKCOST


     /*==============================
       BANK SIDE RECORD
     ==============================*/
     INSERT
     INTO LEDGER3
     SELECT
          NARATNO = 1,
          NARRATION,
          REFNO = 0,
          VTYP,
          VNO,
          BOOKTYPE
     FROM
          V2_PAYOUT_TEMP
     WHERE
          SESSIONID = @SESSIONID

     /*==============================
       CLIENT SIDE RECORD
     ==============================*/
     INSERT
     INTO LEDGER3
     SELECT
          NARATNO = LNO,
          NARR = NARRATION,
          REFNO = 0,
          VTYP,
          VNO,
          BOOKTYPE
     FROM
          V2_PAYOUT_TEMP
     WHERE
          SESSIONID = @SESSIONID


     DECLARE @@L2CUR AS CURSOR,
     @@L2VNO AS VARCHAR(12)
     SET @@L2CUR = CURSOR FOR
     SELECT DISTINCT VNO FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND LEDGER2_UPD = 'N' ORDER BY VNO
     OPEN @@L2CUR
     FETCH NEXT FROM @@L2CUR INTO @@L2VNO
     WHILE @@FETCH_STATUS = 0

     BEGIN
     DELETE FROM TEMPLEDGER2
     WHERE SESSIONID =  @S_SESSIONID

     /*==============================
       CLIENT SIDE RECORD
     ==============================*/

     INSERT INTO TEMPLEDGER2
     SELECT
          'BRANCH',
          C.COSTNAME,
          AMT,
          VTYP,
          VNO,
          LNO,
          DRCR,
          '0',
          BOOKTYPE,
          @S_SESSIONID ,
          ACCODE,
          'A',
          '0'
     FROM
          V2_PAYOUT_TEMP RP,
          COSTMAST C
     WHERE
          RP.COSTCODE = C.COSTCODE
          AND VNO = @@L2VNO
          AND SESSIONID = @SESSIONID

     /*==============================
       BANK SIDE RECORD
     ==============================*/

     INSERT INTO TEMPLEDGER2
     SELECT
          'BRANCH',
          BRANCHCODE,
          SUM(AMT),
          VTYP,
          VNO,
          LNO = 1,
          DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
          '0',
          BOOKTYPE,
          @S_SESSIONID,
          BNKCODE,
          'A',
          '0'
     FROM
          V2_PAYOUT_TEMP
     WHERE
          VNO = @@L2VNO
          AND SESSIONID = @SESSIONID
     GROUP BY BRANCHCODE, VTYP, VNO, (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), BNKCODE, BOOKTYPE


     EXEC INSERTTOLEDGER2 @S_SESSIONID, @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'

     FETCH NEXT FROM @@L2CUR INTO @@L2VNO
     END
     DELETE FROM TEMPLEDGER2
     WHERE SESSIONID =  @S_SESSIONID

     UPDATE S
     SET STATUS = 'A',
          APPROVEDDT = GETDATE(),
          HOPAYMODE = P.PAYMODE,
          BANKCODE = P.BNKCODE,
          VNO = P.VNO,
          VDT = P.VDT,
          EDT = P.EDT,
          AMOUNTTOBEPAID = P.AMT
		--REMARK = P.REMARK
     FROM
          SETTPAYOUT S,
          V2_PAYOUT_TEMP P
     WHERE
          CLTCODE = ACCODE
          AND S.BRANCHCODE = BRCODE
          AND ISNULL(SETTNO,'') = ISNULL(@SETT_NO,'')
          AND ISNULL(SETTTYPE,'') = ISNULL(@SETT_TYPE,'')
          AND GENFLAG = @GENFLAG
          AND STATUS = 'P'
          AND P.SESSIONID = @SESSIONID

     DELETE FROM
          V2_LEDGERBALANCE
     WHERE
          PARTYCODE IN (SELECT ACCODE FROM V2_PAYOUT_TEMP WHERE UPDFLAG = 'Y' AND SESSIONID = @SESSIONID)


     SELECT 'VOUCHER NUMBERS GENERATED : <BR>'
     UNION ALL
	 SELECT 'VNO          : ACCODE     : BANKCODE   : AMOUNT~' AS RESULT
	 UNION ALL
     SELECT VNO + ' : ' + ACCODE + SPACE(10 - LEN(ACCODE)) + ' : ' + BNKCODE + SPACE(10 - LEN(BNKCODE)) + ' : ' + CONVERT(VARCHAR, AMT) + '~' AS RESULT
     FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
     UNION ALL
     SELECT '<HR>'
     UNION ALL
     SELECT 'NO. OF VOUCHERS POSTED : ' + CONVERT(VARCHAR, COUNT(1)) + '<BR>'
     FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
     UNION ALL
     SELECT 'TOTAL AMOUNT : ' + CONVERT(VARCHAR, SUM(AMT)) + + '~'
     FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'

     DELETE FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BULKPAYOUTPOSTING_ALL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_BULKPAYOUTPOSTING_ALL]
(
@SESSIONID VARCHAR(50),
@UNAME VARCHAR(50),
@S_SESSIONID VARCHAR(50),
@GENFLAG VARCHAR(1),
@SEGMENT VARCHAR(6)
)

AS

-- EXEC V2_BULKPAYOUTPOSTING_ALL '1971159042202006', 'BOXM', '1971159042', 'A'

SET NOCOUNT ON

DECLARE
@@NEWVNO AS VARCHAR(12),
@@MAXCOUNT AS INT,
@@VDT AS VARCHAR(11),
@@BANKBRANCH AS VARCHAR(10),
@@BANKCOST AS NUMERIC,
@@VNOCUR AS CURSOR,
@@LNOCUR AS CURSOR,
@@LNOVNO AS VARCHAR(12),
@@ERROR_COUNT INT,
@@STD_DATE VARCHAR(11),
@@LST_DATE VARCHAR(11),
@@VNOMETHOD INT,
@@ACNAME CHAR(100),
@@BOOKTYPE CHAR(2),
@@MICRNO VARCHAR(10),
@@DRCR VARCHAR(1),
@@VTYP SMALLINT,
@@BNKCODE VARCHAR(100),
@@MAXVNO INT,
@@SQL VARCHAR(2500),
@@EXCH CHAR(3),
@@SEG CHAR(7)

IF @SEGMENT = 'NSECM'
BEGIN
	SET @@EXCH = 'NSE'
	SET @@SEG = 'CAPITAL'
END

IF @SEGMENT = 'BSECM'
BEGIN
	SET @@EXCH = 'BSE'
	SET @@SEG = 'CAPITAL'
END

IF @SEGMENT = 'NSEFUT'
BEGIN
	SET @@EXCH = 'NSE'
	SET @@SEG = 'FUTURES'
END

IF @SEGMENT = 'BSEFUT'
BEGIN
	SET @@EXCH = 'BSE'
	SET @@SEG = 'FUTURES'
END
-------------------------- UPDATE BANK CODE DETAILS ------------------------
UPDATE
P
SET BNKNAME = A.ACNAME,
BRANCHCODE = A.BRANCHCODE,
MICRNO = A.MICRNO,
BOOKTYPE = A.BOOKTYPE,
ACCDTLS = A.ACCDTLS,
UPDFLAG = 'Y'
FROM V2_PAYOUT_TEMP P,
ACMAST A
WHERE P.BNKCODE = A.CLTCODE
AND ACCAT = 2
AND SESSIONID = @SESSIONID

UPDATE
P
SET COSTCODE = C.COSTCODE,
ACNAME = A.LONGNAME
FROM ACMAST A,
COSTMAST C,
V2_PAYOUT_TEMP P
WHERE A.CLTCODE = ACCODE
AND ACCAT IN ('4')
AND A.BRANCHCODE = C.COSTNAME
AND SESSIONID = @SESSIONID

UPDATE
P
SET BANKCOST = C.COSTCODE
FROM ACMAST A,
COSTMAST C,
V2_PAYOUT_TEMP P
WHERE A.CLTCODE = BNKCODE
AND ACCAT IN ('2')
AND A.BRANCHCODE = C.COSTNAME
AND SESSIONID = @SESSIONID

UPDATE
V2_PAYOUT_TEMP
SET BANKCOST = COSTCODE
WHERE BANKCOST = ''
AND SESSIONID = @SESSIONID

-------------------------- VALIDATION BASED ON UPDFLAG ------------------------
SELECT @@ERROR_COUNT = COUNT(1) FROM
(
SELECT DISTINCT ACCODE
FROM V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE UPDFLAG = 'N' AND SESSIONID = @SESSIONID
) A

IF @@ERROR_COUNT > 0
BEGIN
SELECT 'FOLLOWING CLIENTS DO NOT EXIST<BR>'
UNION ALL
SELECT DISTINCT ACCODE
FROM V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE UPDFLAG = 'N' AND SESSIONID = @SESSIONID
DELETE FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID
RETURN
END

--------------------------AUTO GENERATION OF VNO ------------------------
SELECT
@@STD_DATE = LEFT(SDTCUR, 11),
@@LST_DATE = LEFT(LDTCUR, 11),
@@VNOMETHOD = VNOFLAG
FROM PARAMETER
WHERE CURYEAR = 1     

SET @@VNOCUR = CURSOR FOR
SELECT DISTINCT
BNKCODE,
BOOKTYPE,
VTYP
FROM
V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE
SESSIONID = @SESSIONID

OPEN @@VNOCUR
FETCH NEXT
FROM
@@VNOCUR
INTO
@@BNKCODE,
@@BOOKTYPE,
@@VTYP
WHILE @@FETCH_STATUS = 0
BEGIN
CREATE TABLE
#BANK_VNO
(
SRNO INT,
NEWSRNO INT IDENTITY (1, 1)
)

INSERT INTO
#BANK_VNO
SELECT
DISTINCT SRNO
FROM
V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE
BNKCODE = @@BNKCODE
AND BOOKTYPE = @@BOOKTYPE
AND SESSIONID = @SESSIONID

SELECT
@@MAXCOUNT = COUNT(DISTINCT SRNO)
FROM
V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE
SESSIONID = @SESSIONID

SELECT TOP 1
@@VDT = VDT
FROM
V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE
SESSIONID = @SESSIONID

SELECT  
LASTVNO  
INTO #VNO  
FROM  
V2_LASTVNO  
WHERE  
1 = 2

SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  

INSERT INTO #VNO
EXEC ACC_GENVNO_NEW
@@VDT,
@@VTYP,
@@BOOKTYPE,
@@STD_DATE,
@@LST_DATE,  
@@MAXVNO  

SELECT  
@@NEWVNO = LASTVNO  
FROM  
#VNO

UPDATE
P
SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1)) 
FROM
V2_PAYOUT_TEMP P WITH(NOLOCK),
#BANK_VNO BV
WHERE
P.SRNO = BV.SRNO 
AND SESSIONID = @SESSIONID

DROP TABLE #VNO  
DROP TABLE #BANK_VNO

FETCH NEXT  
FROM @@VNOCUR  
INTO  
@@BNKCODE,  
@@BOOKTYPE,
@@VTYP  
END  

DEALLOCATE @@VNOCUR

--------------------------AUTO GENERATION OF LNO ------------------------
UPDATE
V2_PAYOUT_TEMP
SET LNO = 2
WHERE VNO IN
(
SELECT
VNO
FROM V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE SESSIONID = @SESSIONID
GROUP BY VNO
HAVING COUNT(*) = 1
)

SET @@LNOCUR = CURSOR FOR
SELECT
VNO
FROM V2_PAYOUT_TEMP WITH(NOLOCK) WHERE SESSIONID = @SESSIONID
GROUP BY VNO
HAVING COUNT(*) > 1

OPEN @@LNOCUR
FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
WHILE @@FETCH_STATUS = 0

BEGIN
CREATE TABLE [#LNOGEN] (
VNO VARCHAR(12),
SNO INT,
LNO INT IDENTITY(1,1))

INSERT INTO #LNOGEN
SELECT
VNO,
SRNO
FROM V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE VNO = @@LNOVNO AND SESSIONID = @SESSIONID
ORDER BY SRNO

UPDATE
V2_PAYOUT_TEMP
SET LNO = L.LNO + 1
FROM #LNOGEN L
WHERE V2_PAYOUT_TEMP.VNO = L.VNO
AND V2_PAYOUT_TEMP.SRNO = L.SNO
AND V2_PAYOUT_TEMP.LNO = 0 AND SESSIONID = @SESSIONID

DROP TABLE #LNOGEN
FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
END
CLOSE @@LNOCUR
DEALLOCATE @@LNOCUR

BEGIN TRANSACTION

--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------
INSERT
INTO LEDGER1
SELECT
BNKNAME,
BRNNAME = BRCODE,
DD = LEFT(PAYMODE, 1),
DDNO,
DDDT = VDT,
RELDT = '',
RELAMT = AMT,
REFNO = 0,
RECEIPTNO = 0,
VTYP,
VNO,
LNO = 2,
DRCR,
BOOKTYPE,
MICRNO,
SLIPNO = 0,
SLIPDATE = '',
CHEQUEINNAME = ISNULL(ACNAME,''),
CHQPRINTED = 0,
CLEAR_MODE = ''
FROM
V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID

/*==============================
CLIENT SIDE RECORD
==============================*/
INSERT
INTO LEDGER
SELECT
VTYP,
VNO,
EDT,
LNO,
ACNAME,
DRCR,
VAMT = AMT,
VDT,
VNO1 = VNO,
REFNO = 0,
BALAMT = AMT,
NODAYS = 0,
CDT = GETDATE(),
CLTCODE = ACCODE,
BOOKTYPE,
ENTEREDBY = @UNAME,
PDT = GETDATE(),
CHECKEDBY = @UNAME,
ACTNODAYS = 0,
NARRATION
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID

INSERT INTO LEDGER2
SELECT
VTYP,
VNO,
LNO,
DRCR,
CAMT = AMT,
COSTCODE,
BOOKTYPE,
CLTCODE = ACCODE
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID
AND COSTCODE = BANKCOST

/*==============================
BANK SIDE RECORD
==============================*/
INSERT
INTO LEDGER
SELECT
VTYP,
VNO,
EDT,
LNO = 1,
BNKNAME,
DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
VAMT = AMT,
VDT,
VNO1 = VNO,
REFNO = 0,
BALAMT = AMT,
NODAYS = 0,
CDT = GETDATE(),
CLTCODE = BNKCODE,
BOOKTYPE,
ENTEREDBY = @UNAME,
PDT = GETDATE(),
CHECKEDBY = @UNAME,
ACTNODAYS = 0,
NARRATION
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID


INSERT INTO LEDGER2
SELECT
VTYP,
VNO,
LNO = 1,
DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
CAMT = AMT,
COSTCODE,
BOOKTYPE,
CLTCODE = BNKCODE
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID
AND COSTCODE = BANKCOST

UPDATE V2_PAYOUT_TEMP SET LEDGER2_UPD = 'Y' WHERE SESSIONID = @SESSIONID AND COSTCODE = BANKCOST


/*==============================
BANK SIDE RECORD
==============================*/
INSERT
INTO LEDGER3
SELECT
NARATNO = 1,
NARRATION,
REFNO = 0,
VTYP,
VNO,
BOOKTYPE
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID

/*==============================
CLIENT SIDE RECORD
==============================*/
INSERT
INTO LEDGER3
SELECT
NARATNO = LNO,
NARR = NARRATION,
REFNO = 0,
VTYP,
VNO,
BOOKTYPE
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID


DECLARE @@L2CUR AS CURSOR,
@@L2VNO AS VARCHAR(12)
SET @@L2CUR = CURSOR FOR
SELECT DISTINCT VNO FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND LEDGER2_UPD = 'N' ORDER BY VNO
OPEN @@L2CUR
FETCH NEXT FROM @@L2CUR INTO @@L2VNO
WHILE @@FETCH_STATUS = 0

BEGIN
DELETE FROM TEMPLEDGER2
WHERE SESSIONID =  @S_SESSIONID

/*==============================
CLIENT SIDE RECORD
==============================*/

INSERT INTO TEMPLEDGER2
SELECT
'BRANCH',
C.COSTNAME,
AMT,
VTYP,
VNO,
LNO,
DRCR,
'0',
BOOKTYPE,
@S_SESSIONID ,
ACCODE,
'A',
'0'
FROM
V2_PAYOUT_TEMP RP,
COSTMAST C
WHERE
RP.COSTCODE = C.COSTCODE
AND VNO = @@L2VNO
AND SESSIONID = @SESSIONID

/*==============================
BANK SIDE RECORD
==============================*/

INSERT INTO TEMPLEDGER2
SELECT
'BRANCH',
BRANCHCODE,
SUM(AMT),
VTYP,
VNO,
LNO = 1,
DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
'0',
BOOKTYPE,
@S_SESSIONID,
BNKCODE,
'A',
'0'
FROM
V2_PAYOUT_TEMP
WHERE
VNO = @@L2VNO
AND SESSIONID = @SESSIONID
GROUP BY BRANCHCODE, VTYP, VNO, (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), BNKCODE, BOOKTYPE


EXEC INSERTTOLEDGER2 @S_SESSIONID, @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'

FETCH NEXT FROM @@L2CUR INTO @@L2VNO
END

DELETE FROM TEMPLEDGER2
WHERE SESSIONID =  @S_SESSIONID

SELECT @@SQL = ""
SELECT @@SQL = @@SQL + "UPDATE S "
SELECT @@SQL = @@SQL + "SET STATUS = 'A', "
SELECT @@SQL = @@SQL + "APPROVEDDT = GETDATE(), "
SELECT @@SQL = @@SQL + "HOPAYMODE = P.PAYMODE, "
SELECT @@SQL = @@SQL + "BANKCODE = P.BNKCODE, "
SELECT @@SQL = @@SQL + "VNO = P.VNO, "
SELECT @@SQL = @@SQL + "VDT = P.VDT, "
SELECT @@SQL = @@SQL + "EDT = P.EDT, "
SELECT @@SQL = @@SQL + "AMOUNTTOBEPAID = P.AMT, "
SELECT @@SQL = @@SQL + "REMARK = P.REMARK "
SELECT @@SQL = @@SQL + "FROM "
SELECT @@SQL = @@SQL + "V2_SETTPAYOUT_ALL S, "
SELECT @@SQL = @@SQL + "V2_PAYOUT_TEMP P "
SELECT @@SQL = @@SQL + "WHERE "
SELECT @@SQL = @@SQL + "CLTCODE = ACCODE "
SELECT @@SQL = @@SQL + "AND S.BRANCHCODE = BRCODE "
SELECT @@SQL = @@SQL + "AND GENFLAG = '" + @GENFLAG + "' "
SELECT @@SQL = @@SQL + "AND STATUS IN ('P', 'I') "
SELECT @@SQL = @@SQL + "AND P.SESSIONID = '" + @SESSIONID + "' "
SELECT @@SQL = @@SQL + "AND S.EXCHANGE = '" + @@EXCH + "' "
SELECT @@SQL = @@SQL + "AND S.SEGMENT = '" + @@SEG + "' "

SELECT @@SQL = @@SQL + "INSERT INTO V2_PAYOUTCLIENT "
SELECT @@SQL = @@SQL + "SELECT ACCODE FROM V2_PAYOUT_TEMP WHERE UPDFLAG = 'Y' AND SESSIONID = '" + @SESSIONID + "' "

SELECT @@SQL = @@SQL + "DELETE FROM "
SELECT @@SQL = @@SQL + "V2_LEDGERBALANCE_ALL "
SELECT @@SQL = @@SQL + "WHERE "
SELECT @@SQL = @@SQL + "PARTYCODE IN (SELECT CLTCODE FROM V2_PAYOUTCLIENT) "

SELECT @@SQL = @@SQL + "DELETE FROM "
SELECT @@SQL = @@SQL + "V2_LEDGERBALANCE_NET "
SELECT @@SQL = @@SQL + "WHERE "
SELECT @@SQL = @@SQL + "PARTY_CODE IN (SELECT CLTCODE FROM V2_PAYOUTCLIENT) "

SELECT @@SQL = @@SQL + "DELETE FROM "
SELECT @@SQL = @@SQL + "V2_FOLEDBAL "
SELECT @@SQL = @@SQL + "WHERE "
SELECT @@SQL = @@SQL + "CLTCODE IN (SELECT CLTCODE FROM V2_PAYOUTCLIENT) "

SELECT @@SQL = @@SQL + "DELETE FROM V2_PAYOUTCLIENT "

EXEC (@@SQL)

SELECT @SEGMENT + ' VOUCHER NUMBERS GENERATED : <BR>'
UNION ALL
SELECT 'VNO          : ACCODE     : BANKCODE   : AMOUNT~' AS RESULT
UNION ALL
SELECT VNO + ' : ' + ACCODE + SPACE(10 - LEN(ACCODE)) + ' : ' + BNKCODE + SPACE(10 - LEN(BNKCODE)) + ' : ' + CONVERT(VARCHAR, AMT) + '~' AS RESULT
FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
UNION ALL
SELECT '<HR>'
UNION ALL
SELECT 'NO. OF VOUCHERS POSTED : ' + CONVERT(VARCHAR, COUNT(1)) + '<BR>'
FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
UNION ALL
SELECT 'TOTAL AMOUNT : ' + CONVERT(VARCHAR, SUM(AMT)) + + '~<BR>'
FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'

DELETE FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID

COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CANNEDLEDGERBALANCE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_CANNEDLEDGERBALANCE](
                @SDATE   VARCHAR(11),
                @EFFDATE VARCHAR(11))

AS

  DECLARE  @@RUNDATE DATETIME
                     
  SET @@RUNDATE = GETDATE()
                  
  TRUNCATE TABLE CANNED_LEDGERBALANCE
  
  INSERT INTO CANNED_LEDGERBALANCE
  SELECT   L.CLTCODE,
           LEDBAL = SUM(CASE 
                          WHEN DRCR = 'D' THEN -(VAMT)
                          ELSE (VAMT)
                        END),
           ENTRYTYPE = 1,
           @@RUNDATE
  FROM     LEDGER L WITH (NOLOCK),
           ACMAST A WITH (NOLOCK)
  WHERE    L.CLTCODE = A.CLTCODE
           AND A.ACCAT = 4
           AND L.VDT BETWEEN @SDATE + ' 00:00:00'
                             AND @EFFDATE + ' 23:59:59'
           AND L.EDT <= @EFFDATE + ' 23:59:59'
  GROUP BY L.CLTCODE
  HAVING   SUM(CASE 
                 WHEN DRCR = 'D' THEN -(VAMT)
                 ELSE (VAMT)
               END) <> 0
                       
  INSERT INTO CANNED_LEDGERBALANCE
  SELECT   L.CLTCODE,
           LEDBAL = SUM(CASE 
                          WHEN DRCR = 'D' THEN -(VAMT)
                          ELSE 0
                        END),
           ENTRYTYPE = 2,
           @@RUNDATE
  FROM     LEDGER L WITH (NOLOCK),
           ACMAST A WITH (NOLOCK)
  WHERE    L.CLTCODE = A.CLTCODE
           AND A.ACCAT = 4
           AND L.VDT BETWEEN @SDATE + ' 00:00:00'
                             AND @EFFDATE + ' 23:59:59'
           AND EDT > @EFFDATE + ' 23:59:59'
  GROUP BY L.CLTCODE
  HAVING   SUM(CASE 
                 WHEN DRCR = 'D' THEN -(VAMT)
                 ELSE 0
               END) <> 0 
           
  INSERT INTO CANNED_LEDGERBALANCE
  SELECT   L.CLTCODE,
           LEDBAL = SUM(CASE 
                          WHEN DRCR = 'D' THEN 0
                          ELSE -(VAMT)
                        END),
           ENTRYTYPE = 3,
           @@RUNDATE
  FROM     LEDGER L WITH (NOLOCK),
           ACMAST A WITH (NOLOCK)
  WHERE    L.CLTCODE = A.CLTCODE
           AND A.ACCAT = 4
           AND L.EDT >= @EFFDATE + ' 23:59:59'
           AND L.VDT < @SDATE
  GROUP BY L.CLTCODE
  HAVING   SUM(CASE 
                 WHEN DRCR = 'D' THEN 0
                 ELSE -(VAMT)
               END) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CHECKBLOCKEDREPORTS
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[V2_CHECKBLOCKEDREPORTS]
                @RPTPATH VARCHAR(100)
                
AS

  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  SET NOCOUNT ON
        
  IF (SELECT COUNT(1)
      FROM   TBLREPORTS_BLOCKED WITH (NOLOCK)
      WHERE  BLOCK_FLAG = 1
             AND LTRIM(RTRIM(FLDPATH)) = left(LTRIM(RTRIM(@RPTPATH)),len(FLDPATH))) > 0 
  BEGIN 
    SELECT '<font color = red><b>UPDATION IN PROGRESS!! </b></font>'
  END 
  ELSE 
  BEGIN 
    SELECT '' 
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CLASS_PROC_ENTITYMASTER
-- --------------------------------------------------

CREATE PROC V2_CLASS_PROC_ENTITYMASTER  
  
as  
  
  SELECT ENT_TYPE = A.ENT_TYPE,   
         NO_OF_UNITS = ISNULL(NO_OF_UNITS,0),   
         NO_OF_LOGIN = ISNULL(NO_OF_LOGIN,0),   
         NO_OF_USERS = ISNULL(NO_OF_USERS,0)   
  FROM   (SELECT ENT_TYPE,   
                 NO_OF_UNITS = COUNT(1),   
                 ORDER_BY  
          FROM   V2_CLASS_VW_ENTITYMASTER   
          GROUP BY ENT_TYPE,ORDER_BY) A   
            LEFT OUTER JOIN   
            (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
                    NO_OF_LOGIN = SUM(NO_OF_LOGIN)   
             FROM   (SELECT FLDADMINAUTO,   
                            NO_OF_LOGIN = COUNT(DISTINCT FLDSTNAME)   
                     FROM   TBLPRADNYAUSERS   
                     GROUP BY FLDADMINAUTO) U,   
                     TBLADMIN A   
             WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
             GROUP BY FLDSTATUS) B  
             ON A.ENT_TYPE = B.ENT_TYPE    
              LEFT OUTER JOIN   
                (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
                        NO_OF_USERS = SUM(NO_OF_USERS)   
                 FROM   (SELECT FLDADMINAUTO,   
                                FLDSTNAME,   
                                NO_OF_USERS = COUNT(1)   
                         FROM TBLPRADNYAUSERS   
                         GROUP BY FLDADMINAUTO,   
                          FLDSTNAME) U, TBLADMIN A   
                 WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
                 GROUP BY FLDSTATUS) C   
                 ON A.ENT_TYPE = C.ENT_TYPE   
  ORDER BY ORDER_BY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_Fout_Report
-- --------------------------------------------------
--exec V2_FOUT_Report '19300406','19300406','CLIENT','broker','broker','','S'
CREATE Proc [dbo].[V2_Fout_Report]  
(                
      @FromCode varchar(20),                
      @ToCode varchar(20),                
      @Opt      varchar(10),                
      @StatusId varchar(10),                
      @StatusName varchar(25),                
      @SessionID varchar(30),              
      @ReportOpt varchar(1),
      @Subbroker Varchar(10)	                
)                
                
as                
          
/*          
Create Table V2_Process_Logs          
(          
      FldAuto bigint identity(1,1),          
      ReportName varchar(100),          
      ReportParam varchar(4000),          
      ReportBy      varchar(50),          
      ReportDate      datetime          
)          
*/          
             
             
Insert Into V2_Process_Logs          
Values          
('FOUT_REPORT',           
'exec V2_Fout_Report @FromCode='+@fromCode+', @ToCode='+@tocode+' ,@Opt='+@Opt+' , @StatusID='+@StatusID+' ,@StatusName='+@StatusName+' ,@SessionId='+@SessionID+' ,@ReportOpt='+@ReportOpt,          
left(@statusid+'-'+@StatuSName,50),          
getdate()          
)          
          
/*                
exec V2_FOUT_Report 'INDORE','INDORE','BRANCH','broker','broker','324605080','S'              
exec V2_FOUT_Report 'INDORE','INDORE','BRANCH','broker','broker','324605080','d'              
use accountbse                
exec V2_Fout_Report 'Broker','Broker','INA024','INA044','Client','D'              
exec V2_Fout_Report 'Broker','Broker','INA024','INA044','Client','S'                
exec V2_Fout_Report 'Broker','Broker','I','I','Branch','D'                
*/                
                
                
IF ISNULL(@FromCode,'') = ''                         
BEGIN                        
      SELECT @FromCode ='0000000000'                        
END                        
                    
IF ISNULL(@ToCode,'') = ''                         
BEGIN                        
      SELECT @ToCode ='zzzzzzzzzz'                        
END                        
                
                
if @reportopt='D'                      
begin                
                
              
              
set transaction isolation level read uncommitted                  
      select                     
            GroupName,              
            Party_Code,                    
            Party_name,                    
            NSEBalance,                    
            BSEBalance,                    
            NSEFOBalance,                    
            NSEEstimated1,                    
            NSEEstimated2,                                   
            BSEEstimated1,                    
            BSEEstimated2,                    
            FAActual,                    
            Cash,                    
            NonCash,                    
            IMMargin,                    
            VarMargin,              
            Res_Phone,              
            SesId,        
     TotalParty=NSEBalance+BSEBalance+NSEFOBalance,        
      EstimateTotalParty = NSEBalance+BSEBalance+NSEFOBalance+NSEESTIMATED1+BSEESTIMATED1+NSEESTIMATED2+BSEESTIMATED2,        
            FANetParty = FAACTUAL - (NSEBalance+BSEBalance+NSEFOBalance+NSEESTIMATED1+BSEESTIMATED1+NSEESTIMATED2+BSEESTIMATED2),        
     FinTotalParty = FAACTUAL + IMMargin + VarMargin + NONCASH + CASH,  
     subbroker_code        
From                
 (              
       select                     
             GroupName =                 
                               (Case                
                                     When @Opt = 'Broker' then Branch_Code                
                                     When @Opt = 'SubBroker' then SubBroker_Code                                             
                                     When @Opt = 'Trader' then Trader                
                                     When @Opt = 'Family' then Family_Code                
                                     When @Opt = 'Client' then Party_Code                
                 When @Opt = 'Area' then Area_Code                
                                     When @Opt = 'Region' then Region_Code                
                                     Else Branch_Code                
                                 End                
                               ),                
             Party_Code,                    
             Party_name,               
             NSEBalance,                    
             BSEBalance,                    
             NSEFOBalance,                    
             NSEEstimated1,                    
             NSEEstimated2,                                
             BSEEstimated1,                    
             BSEEstimated2,                    
             FAActual,                    
             Cash,                    
             NonCash,                    
             IMMargin,                    
             VarMargin,              
             Res_Phone,              
             SesId = @SessionID,  
      subbroker_code                     
       from                     
             V2_Fout_LedgerBalances with(index(FoutIdx),nolock)                
       Where                     
             @StatusName =                 
                   (Case                 
                         when @StatusId = 'Broker' then @StatusName                
                         when @StatusId = 'Branch' then Branch_Code                
                         when @StatusId = 'Trader' then Trader                
                         when @StatusId = 'SubBroker' then SubBroker_Code                
                         when @StatusId = 'Area' then Area_Code                
                         when @StatusId = 'Client' then Party_Code                
                         when @StatusId = 'Region' then Region_Code                
                   else                 
                         ''                            
                   end                
                   )                
 ) Dtl              
Where              
 GroupName >= @FromCode              
 And GroupName <= @ToCode + 'ZZZZ'      
Order By                     
            1, 2, 3                
                
end                      
                
                
                
                
if @reportopt<>'D'                      
begin                                
              
                
set transaction isolation level read uncommitted                  
select                     
 GroupName,                     
 Party_Name,                    
 sum(NSEBALANCE) as NSEBALANCE,                        
 sum(BSEBALANCE) as BSEBALANCE,                    
 sum(NSEFOBALANCE) as NSEFOBALANCE,                                
 sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotalParty,                                
 sum(NSEESTIMATED1) as NSEESTIMATED1,                    
 sum(NSEESTIMATED2) as NSEESTIMATED2,                                   
 sum(BSEESTIMATED1) as BSEESTIMATED1,                    
 sum(BSEESTIMATED2) as BSEESTIMATED2,                                
 sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as EstimateTotalParty,                                
 sum(FAActual) as FAACTUAL,                                
 sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as FANETPARTY,                                
 sum(Cash) as CASH,                    
 sum(NonCash) as NonCash,                     
 sum(IMMargin) as IMMargin,                    
 sum(VarMargin) as VarMargin,                                
 sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as FinTotalParty,              
 SesId,          
 subbroker_code,                  
 Res_Phone=''  
  From              
  (               
       select                     
              GroupName =                 
                                (Case                
                                      When @Opt = 'Broker' then Branch_Code                
                                      When @Opt = 'SubBroker' then SubBroker_Code                                             
                                      When @Opt = 'Trader' then Trader                
                                      When @Opt = 'Family' then Family_Code                
                                      When @Opt = 'Client' then Party_Code                
                                      When @Opt = 'Area' then Area_Code                
                                      When @Opt = 'Region' then Region_Code                
                                      Else Branch_Code                
  End                
                                ),                
              Party_Code,                    
              Party_name =                     
                                (Case                
                                      When @Opt = 'Broker' then Branch_Name                
                                      When @Opt = 'SubBroker' then SubBroker_Name                                        
                                      When @Opt = 'Trader' then Trader_Name                
                                      When @Opt = 'Family' then (select party_name from V2_Fout_LedgerBalances v2 where v1.family_code = v2.party_code)   
                                      When @Opt = 'Client' then Party_Name                
                                      When @Opt = 'Area' then Area_Name                
                                      When @Opt = 'Region' then Region_Name                
                                      Else Branch_Name                
                                  End                
                                ),                
                
              NSEBalance,                    
              BSEBalance,                    
              NSEFOBalance,                    
              NSEEstimated1,                    
              NSEEstimated2,                                   
              BSEEstimated1,                    
              BSEEstimated2,                    
              FAActual,                    
              Cash,                    
              NonCash,                    
              IMMargin,                    
              VarMargin,              
       Res_Phone,              
       SesId = @SessionID,  
       subbroker_code                            
        from                     
              V2_Fout_LedgerBalances v1 with(index(FoutIdx),nolock)                 
        Where                     
              @StatusName =                 
                    (Case                 
                          when @StatusId = 'Broker' then @StatusName                
                          when @StatusId = 'Branch' then Branch_Code                
                          when @StatusId = 'Trader' then Trader                
                          when @StatusId = 'SubBroker' then SubBroker_Code                
                          when @StatusId = 'Area' then Area_Code                
                          when @StatusId = 'Client' then Party_Code                
                          when @StatusId = 'Region' then Region_Code                
                    else                 
                          ''                            
                    end                
                    )                
  ) DtlRpt              
 Where              
  GroupName >= @FromCode              
  and GroupName <= @ToCode + 'ZZZZ'             
 Group by GroupName, Party_Name, SesId, subbroker_code              
 Order By GroupName, Party_Name              
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_INTEREST_CAL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_INTEREST_CAL] 
(  
        @@BALDATE INT 
)  
  
AS  
  
/*==============================================================================================================  
        EXEC V2_INTEREST_CAL  
                @@BALDATE = 20070401 
==============================================================================================================*/  
  
        SET NOCOUNT ON

	DECLARE 
		@@CREDIT_INT MONEY, 
		@@DEBIT_INT MONEY,
		@@SPAN_MARGIN INT, 
		@@EXPOSURE_MARGIN INT

	SELECT 
		@@CREDIT_INT = CREDIT_INT, 
		@@DEBIT_INT = DEBIT_INT, 
        @@SPAN_MARGIN = SPAN_MARGIN, 
        @@EXPOSURE_MARGIN = EXPOSURE_MARGIN
	FROM V2_CLIENTPROFILES_FA 
	WHERE CLTCODE = 'ALL'


    SELECT 
        CLTCODE, 
        SEGMENTCODE, 
        LEDTYPE, 
        VDTBAL = SUM(VDTBAL), 
        VDTINTEREST = SUM(VDTINTEREST), 
        EDTBAL = SUM(EDTBAL), 
        EDTINTEREST = SUM(EDTINTEREST), 
		INTDATE = @@BALDATE 
    FROM 
    (
        SELECT 
        	V.CLTCODE, 
        	V.SEGMENTCODE, 
            V.LEDTYPE, 
        	VDTBAL = SUM(BALCR - BALDR), 
    		VDTINTEREST = (CASE WHEN SUM(BALCR - BALDR) > 0 
    				THEN ((SUM(BALCR - BALDR) * ISNULL(CREDIT_INT,@@CREDIT_INT)) / 100) / 365
    				ELSE 
    				(CASE WHEN SUM(BALCR - BALDR) < 0 
    				THEN ((SUM(BALCR - BALDR) * ISNULL(DEBIT_INT,@@DEBIT_INT)) / 100) / 365
    				ELSE 0 END) END), 
    		EDTBAL = 0, 
    		EDTINTEREST = 0
        FROM 
        	V2_ACCOUNTBALANCES V LEFT OUTER JOIN 
            V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE), 
        	PARAMETER P 
        WHERE 
        	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
        	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
        	AND VDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
        GROUP BY 
        	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE, CREDIT_INT, DEBIT_INT
        HAVING SUM(BALCR - BALDR) <> 0 
        
        UNION ALL
    
        SELECT 
        	V.CLTCODE, 
        	V.SEGMENTCODE, 
            V.LEDTYPE, 
    		VDTBAL = 0, 
    		VDTINTEREST = 0, 
        	EDTBAL = SUM(BALCR - BALDR), 
    		EDTINTEREST = (CASE WHEN SUM(BALCR - BALDR) > 0 
    				THEN ((SUM(BALCR - BALDR) * ISNULL(CREDIT_INT,@@CREDIT_INT)) / 100) / 365
    				ELSE 
    				(CASE WHEN SUM(BALCR - BALDR) < 0 
    				THEN ((SUM(BALCR - BALDR) * ISNULL(DEBIT_INT,@@DEBIT_INT)) / 100) / 365
    				ELSE 0 END) END)
        FROM 
        	V2_ACCOUNTBALANCES V LEFT OUTER JOIN 
            V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE), 
        	PARAMETER P 
        WHERE 
        	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
        	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
        	AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
        GROUP BY 
        	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE, CREDIT_INT, DEBIT_INT
        HAVING SUM(BALCR - BALDR) <> 0 
    
        UNION ALL
    
        SELECT 
        	V.CLTCODE, 
        	V.SEGMENTCODE, 
            V.LEDTYPE, 
    		VDTBAL = 0, 
    		VDTINTEREST = 0, 
        	EDTBAL = SUM(BALCR - BALDR), 
    		EDTINTEREST = (CASE WHEN SUM(BALDR - BALCR) > 0 
    				THEN ((SUM(BALDR - BALCR) * ISNULL(DEBIT_INT,@@DEBIT_INT)) / 100) / 365
    				ELSE 
    				(CASE WHEN SUM(BALDR - BALCR) < 0 
    				THEN ((SUM(BALDR - BALCR) * ISNULL(CREDIT_INT,@@CREDIT_INT)) / 100) / 365
    				ELSE 0 END) END)
        FROM 
        	V2_ACCOUNTBALANCES V LEFT OUTER JOIN 
            V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE), 
        	PARAMETER P 
        WHERE 
        	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
        	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
        	AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
            AND VDT < CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112))
        GROUP BY 
        	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE, CREDIT_INT, DEBIT_INT
        HAVING SUM(BALDR - BALCR) <> 0 

        UNION ALL 
    
    	SELECT 
        	V.CLTCODE, 
        	SEGMENTCODE = 3, 
            LEDTYPE = 3, 
        	VDTBAL = NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ), 
    		VDTINTEREST = (CASE WHEN NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) > 0 
    				THEN ((NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) * ISNULL(CREDIT_INT,@@CREDIT_INT)) / 100) / 365
    				ELSE 
    				(CASE WHEN NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) < 0 
    				THEN ((NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) * ISNULL(DEBIT_INT,@@DEBIT_INT)) / 100) / 365
    				ELSE 0 END) END), 
        	EDTBAL = NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ), 
    		EDTINTEREST = (CASE WHEN NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) > 0 
    				THEN ((NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) * ISNULL(CREDIT_INT,@@CREDIT_INT)) / 100) / 365
    				ELSE 
    				(CASE WHEN NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) < 0 
    				THEN ((NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) * ISNULL(DEBIT_INT,@@DEBIT_INT)) / 100) / 365
    				ELSE 0 END) END)
    	FROM 
    		( 
    			SELECT 
    				CLTCODE = ISNULL(C.CLTCODE,M.CLTCODE), 
    				NONCASH = ISNULL(NONCASH,0), 
    				TOTALMARGIN = ISNULL(TOTALMARGIN,0), 
    				MTOM = ISNULL(MTOM,0) 
    			FROM 
    				(
    					SELECT CLTCODE = PARTY_CODE, NONCASH 
    					FROM COLLATERAL 
    					WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) = 
                            (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(TRANS_DATE),112)) FROM COLLATERAL WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) <= @@BALDATE AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES') 
    					AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES'
    				) C FULL OUTER JOIN 
    				(
    					SELECT CLTCODE = PARTY_CODE, TOTALMARGIN, MTOM 
    					FROM NSEFO.DBO.FOMARGINNEW 
    					WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) = 
                            (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(MDATE),112)) FROM NSEFO.DBO.FOMARGINNEW WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) <= @@BALDATE) 
    				) M 
    			ON M.CLTCODE = C.CLTCODE 
    		 ) V LEFT OUTER JOIN V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE)
    	WHERE NONCASH - (
                            (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                            + 
                            (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                ) < 0 
    ) FINAL 
    GROUP BY 
        CLTCODE, 
        SEGMENTCODE, 
        LEDTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_INTEREST_REPORT_DETAIL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_INTEREST_REPORT_DETAIL](
                @FILTER      VARCHAR(11),
                @INTERESTON  VARCHAR(3),
                @SEGMENTCODE INT,
                @FROMDATE    VARCHAR(11),
                @TODATE      VARCHAR(11),
                @FROMPARTY   VARCHAR(10),
                @TOPARTY     VARCHAR(10),
                @STATUSID    VARCHAR(20),
                @STATUSNAME  VARCHAR(20))

AS

  /*==============================================================================================================  
        EXEC V2_INTEREST_REPORT_DETAIL  
	    @FILTER = 'BRANCH', 
	    @INTERESTON = 'VDT', 
	    @FROMDATE = 'JUN  1 2007', 
		@TODATE = 'JUN  7 2007', 
		@FROMPARTY = '0000000000', 
		@TOPARTY = 'ZZZZZZZZZZ', 
		@STATUSID = 'BROKER', 
		@STATUSNAME = 'BROKER' 
==============================================================================================================*/
  SET NOCOUNT ON
  
  DECLARE  @@FDATE INT,
           @@TDATE INT
                   
  SET @@FDATE = CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),112))
                
  SET @@TDATE = CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),112))
                
  SELECT PARTY_CODE,
         LONG_NAME
  INTO   #CLIENT
  FROM   CLIENT_DETAILS C
  WHERE  1 = 2
             
  INSERT INTO #CLIENT
  EXEC V2_ACCOUNT_LISTING
     @FILTER ,
     @FROMPARTY ,
     @TOPARTY ,
     @STATUSID ,
     @STATUSNAME
    
  IF @SEGMENTCODE = 0
    BEGIN
      SELECT   BALDATE = LEFT(CONVERT(DATETIME,CONVERT(VARCHAR,INTDATE)),
                              11),
               NSECM = SUM(CASE 
                             WHEN SEGMENTCODE = 1 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               BSECM = SUM(CASE 
                             WHEN SEGMENTCODE = 2 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               NSEFO = SUM(CASE 
                             WHEN SEGMENTCODE = 3 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               BSEFO = SUM(CASE 
                             WHEN SEGMENTCODE = 4 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               INTEREST = SUM(CASE 
                                WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                 WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                 ELSE (CASE 
                                                                         WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                         ELSE 0
                                                                       END)
                                                               END)
                                ELSE (CASE 
                                        WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                        ELSE (CASE 
                                                WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                ELSE 0
                                              END)
                                      END)
                              END),
               INTDATE
      FROM     V2_INTEREST V
               LEFT OUTER JOIN V2_CLIENTPROFILES_FA F
                 ON (V.CLTCODE = F.CLTCODE),
               (SELECT CREDIT_INT,
                       DEBIT_INT,
                       SPAN_MARGIN,
                       EXPOSURE_MARGIN
                FROM   V2_CLIENTPROFILES_FA
                WHERE  CLTCODE = 'ALL') A,
               CLIENT_DETAILS C,
               #CLIENT C1
      WHERE    C.PARTY_CODE = V.CLTCODE
               AND V.INTDATE BETWEEN @@FDATE
                                     AND @@TDATE
               AND C1.PARTY_CODE = (CASE 
                                      WHEN @FILTER = 'BRANCH' THEN C.BRANCH_CD
                                      WHEN @FILTER = 'CLIENT' THEN C.PARTY_CODE
                                      WHEN @FILTER = 'FAMILY' THEN C.FAMILY
                                    END)
               AND C.PARTY_CODE BETWEEN @FROMPARTY
                                        AND @TOPARTY
      GROUP BY C1.PARTY_CODE,C1.LONG_NAME,INTDATE
      ORDER BY 7
    END
  ELSE
    BEGIN
      SELECT   BALDATE = LEFT(CONVERT(DATETIME,CONVERT(VARCHAR,INTDATE)),
                              11),
               NSECM = SUM(CASE 
                             WHEN SEGMENTCODE = 1 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               BSECM = SUM(CASE 
                             WHEN SEGMENTCODE = 2 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               NSEFO = SUM(CASE 
                             WHEN SEGMENTCODE = 3 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               BSEFO = SUM(CASE 
                             WHEN SEGMENTCODE = 4 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               INTEREST = SUM(CASE 
                                WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                 WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                 ELSE (CASE 
                                                                         WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                         ELSE 0
                                                                       END)
                                                               END)
                                ELSE (CASE 
                                        WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                        ELSE (CASE 
                                                WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                ELSE 0
                                              END)
                                      END)
                              END),
               INTDATE
      FROM     V2_INTEREST V
               LEFT OUTER JOIN V2_CLIENTPROFILES_FA F
                 ON (V.CLTCODE = F.CLTCODE),
               (SELECT CREDIT_INT,
                       DEBIT_INT,
                       SPAN_MARGIN,
                       EXPOSURE_MARGIN
                FROM   V2_CLIENTPROFILES_FA
                WHERE  CLTCODE = 'ALL') A,
               CLIENT_DETAILS C,
               #CLIENT C1
      WHERE    C.PARTY_CODE = V.CLTCODE
               AND V.INTDATE BETWEEN @@FDATE
                                     AND @@TDATE
               AND C1.PARTY_CODE = (CASE 
                                      WHEN @FILTER = 'BRANCH' THEN C.BRANCH_CD
                                      WHEN @FILTER = 'CLIENT' THEN C.PARTY_CODE
                                      WHEN @FILTER = 'FAMILY' THEN C.FAMILY
                                    END)
               AND C.PARTY_CODE BETWEEN @FROMPARTY
                                        AND @TOPARTY
      GROUP BY C1.PARTY_CODE,C1.LONG_NAME,INTDATE
      HAVING   SUM(CASE 
                     WHEN SEGMENTCODE = @SEGMENTCODE THEN (CASE 
                                                             WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                              WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                              ELSE (CASE 
                                                                                                      WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                      ELSE 0
                                                                                                    END)
                                                                                            END)
                                                             ELSE (CASE 
                                                                     WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                     ELSE (CASE 
                                                                             WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                             ELSE 0
                                                                           END)
                                                                   END)
                                                           END)
                     ELSE 0
                   END) <> 0
      ORDER BY 7
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_COSTCENTER_REPORT
-- --------------------------------------------------
CREATE Procedure [dbo].[V2_OFFLINE_COSTCENTER_REPORT]  
as  
  
select  /*a.FldAuto as [S No],  */
 a.VoucherNo as [Ref No],  
 a.LedgerVNo as [V No],  
 a.VoucherType as [V Type],    
 a.BookType as [Book Type],    
 a.SNo  as [L No],    
 a.VDate as [V Dt],    
 a.Edate as [E Dt],    
 a.CltCode  as [Clt Code],    
 a.OppCode  as [GL Code],    
 [Credit Amt] = (Case when b.CreditAmt <> 0 then b.CreditAmt else a.CreditAmt end),  
 [Debit Amt] = (case when b.DebitAmt <> 0 then b.DebitAmt else a.DebitAmt end),  
 isnull(b.BranchCode, a.BranchCode) as [Branch Cd],  
 isnull(b.CatCode, a.BranchCode) as [Cat Cd],  
 isnull(b.CostCode, a.BranchCode) as [Cost Cd]/*,  
 a.addby  as [Add By],    
 a.adddt  as [Add Dt] */
from   
 v2_offline_cc_entries b  
inner  join   
 v2_offline_ledger_entries a  
 on (b.VOLE_RefNo = a.FldAuto)  
Where  
 a.RowState = 0  
Order by A.FldAuto

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_ENTRIES_FROMLEDGER
-- --------------------------------------------------
CREATE Proc [dbo].[V2_OFFLINE_ENTRIES_FROMLEDGER]    
(@EXCHANGE VARCHAR(3), @SEGMENT VARCHAR(10))  
  
as    
  
--INSERT INTO V2_OFFLINE_LEDGER_ENTRIES  
Select z.*  from     
(    
Select l.Vtyp, l.BookTYpe,  
Lno =(case when L.vtyp not in ('6','7','8') then    
 CAST(L.LNO AS INT) - 1   
else  
 l.lno  
   end    
 ),  
vdt =cast(left(l.Vdt,11) as datetime), evdt =cast(left(l.edt,11) as datetime), l.CltCode,CreditAmt= Case when L.drcr = 'C' then l.Vamt else 0 end ,    
DebitAmt = Case when L.drcr = 'D' then l.Vamt else 0 end,     
l.Narration,     
OppCode = (case when L.vtyp not in (6,7,8) then    
  case when L.lno = 1 then l.CltCode     
   else    
    (Select top 1 CltCode from Ledger x where x.vno = l.vno and x.vtyp = l.vtyp and x.booktype = l.booktype and x.lno = 1)    
   end    
    else '' end),    
MARGINCODE = '',  
BankName= l1.BNKNAME,    
BankBranch = L1.BRNNAME, a.BranchCode,     
DDNo = L1.DDNO,     
ChqMode =  L1.DD,  
ChqDt = L1.DDDT,     
ChqName = L1.CHEQUEINNAME,    
ClearMode = L1.CLEAR_MODE,     
TPACNum = (CASE WHEN A.ACNAME = L1.CHEQUEINNAME THEN 1 ELSE 0 END),   
Exchange='NSE',    
Segment='CAPITAL',    
TPFlag = '0',    
AddDt = l.pdt,     
AddBy = l.EnteredBy,    
StatusId= 'STATUSID',    
StatusName = 'STATUSNAME',    
RowState = 1,    
ApprovalFlag = 1,    
ApprovedDt = l.pdt,     
ApprovedBy = l.CheckedBy,     
VoucherNo = l.Vno,     
UploadDt = l.Pdt,     
LedgerVno = l.vno,     
ClientName = a.AcName,     
OppCodeName = a.AcName,     
MarginCodeName = '',    
SettNo = '',    
SettType = '',    
ProductType = '',    
RevAmt = 0,    
RevCode = '',    
MICR = L1.MICRNO
From Ledger l    
join acmast a    
on (a.cltcode = l.cltcode)    
LEFT OUTER JOIN LEDGER1 L1  
ON (L1.VTYP = L.VTYP AND L1.VNO = L.VNO AND L1.BOOKTYPE = L.BOOKTYPE AND L1.LNO = L.LNO)  
LEFT OUTER JOIN LEDGER2 L2
	LEFT OUTER JOIN COSTMAST CM
		LEFT OUTER JOIN CATEGORY C ON (C.CATCODE = CM.CATCODE)
		ON (CM.COSTCODE = L2.COSTCODE)
ON (L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.BOOKTYPE = L.BOOKTYPE AND L2.LNO = L.LNO)  
Where l.Vtyp < '10'    
) z     
where z.cltcode <> z.oppcode    
Order by VTyp    
    
--INSERT INTO V2_OFFLINE_CC_ENTRIES  
SELECT V.FLDAUTO, 
CCCREDIT = CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE 0 END,
CCDEBIT = CASE WHEN L2.DRCR = 'C' THEN CAMT ELSE 0 END,
V.CLTCODE, 
V.OPPCODE,
V.BRANCHCODE,
C.CATEGORY,
CM.COSTNAME,
V.ADDBY,
V.STATUSID,
V.STATUSNAME,
V.ADDDT
FROM V2_OFFLINE_LEDGER_ENTRIES V
LEFT OUTER JOIN LEDGER2 L2
	LEFT OUTER JOIN COSTMAST CM
		LEFT OUTER JOIN CATEGORY C ON (C.CATCODE = CM.CATCODE)
		ON (CM.COSTCODE = L2.COSTCODE)
ON (L2.VTYPE = V.VOUCHERTYPE AND L2.VNO = V.LEDGERVNO AND L2.BOOKTYPE = V.BOOKTYPE AND L2.LNO = V.SNO)  
WHERE ISNULL(C.CATEGORY,'') <> ''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_LEDGER_REPORT
-- --------------------------------------------------
CREATE PROC [dbo].[V2_OFFLINE_LEDGER_REPORT]            
(            
@startDate varchar(11),            
@endDate varchar(11),          
@fromParty varchar(10),          
@toParty varchar(10),      
@Selectionby VARCHAR(3),
@SortBy varchar(6),
@EXCSEGMENT VARCHAR(11)         
)            
AS          
    
/*    
EXEC V2_OFFLINE_LEDGER_REPORT 'SEP  1 2007','SEP 17 2007','0a141','0a141','VDT'    
*/    
    
DECLARE @@QRY AS VARCHAR(8000)    
DECLARE @@CLOSEBALQRY as VARCHAR(8000)
DECLARE @@OPENDATE AS VARCHAR(11)    
DECLARE @@FINSTART AS DATETIME    
DECLARE @@FINSTARTCHAR AS VARCHAR(11)    
    
SELECT @@QRY = "  "
SELECT @@CLOSEBALQRY = " SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "    
    
SELECT @@FINSTART = SDTCUR, @@FINSTARTCHAR = LEFT(SDTCUR,11) FROM PARAMETER (NOLOCK) WHERE CONVERT(DATETIME,@startDate,109) BETWEEN SDTCUR AND LDTCUR      
    
IF UPPER(@SELECTIONBY) = 'VDT'    
BEGIN    
 SELECT @@OPENDATE = (SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDATE),0),109),11) FROM V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) WHERE VOUCHERTYPE = 18    
      AND VDATE <= @@FINSTART)    
    
    
END    
ELSE    
BEGIN    
 SELECT @@OPENDATE = (SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(EDATE),0),109),11) FROM V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) WHERE VOUCHERTYPE = 18    
      AND EDATE <= @@FINSTART)    
END    
    
    
IF Upper(@Selectionby) = 'VDT'      
  BEGIN      
  IF @startDate = @@FINSTART     
        Begin      
   If @@Opendate = @@FINSTARTCHAR       
   Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "   
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "   
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
   End      
   Else      
   Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "      
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And VDATE < '" + @@FINSTARTCHAR + "'"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
   End      
        End      
  Else      
        Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "    
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And VDATE < '" + @@FINSTARTCHAR + "'"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
        End      
END       
ELSE     
  BEGIN      
  If @StartDate = @@FINSTARTCHAR And @@Opendate = @@FINSTARTCHAR      
        Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "    
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And EDate Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
        End      
  Else      
        Begin      
    
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " (CASE WHEN SUM(OPBAL) <= 0 THEN ABS(SUM(OPBAL)) ELSE 0 END) AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " (CASE WHEN SUM(OPBAL) > 0 THEN ABS(SUM(OPBAL)) ELSE 0 END) AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "     
      SELECT @@QRY = @@QRY + " FROM "     
      SELECT @@QRY = @@QRY + " (Select EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE, Opbal = Sum(DEBITAMT - CREDITAMT) "     
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And EDate Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE  "    
      SELECT @@QRY = @@QRY + " UNION ALL  "    
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE, Opbal = Sum(DEBITAMT - CREDITAMT) "     
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And EDATE < '" + @@FINSTARTCHAR + "' AND VOUCHERTYPE <> 18"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE ) T"     
      SELECT @@QRY = @@QRY + " GROUP BY EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE "    
        End      
  End      
    
    
 SELECT @@QRY = @@QRY + " UNION ALL "    
 SELECT @@QRY = @@QRY + " select A.Exchange, A.Segment, "     
 SELECT @@QRY = @@QRY + " UPPER(ISNULL(V.SHORTDESC,'')) AS VNAME, "       
 SELECT @@QRY = @@QRY + " A.VOUCHERTYPE AS VTYP, "    
 SELECT @@QRY = @@QRY + " A.BOOKTYPE AS BOOKTYPE, "      
 SELECT @@QRY = @@QRY + " Convert(varchar,a.Vdate,105) as VDt, "            
 SELECT @@QRY = @@QRY + " Convert(varchar,a.Edate,105) as Edt, "            
 SELECT @@QRY = @@QRY + " a.OppCode as GLCode, "    
 SELECT @@QRY = @@QRY + " a.CltCode,"    
 SELECT @@QRY = @@QRY + " a.BranchCode,"    
 SELECT @@QRY = @@QRY + " a.CreditAmt, "          
 SELECT @@QRY = @@QRY + " a.DebitAmt,"           
 SELECT @@QRY = @@QRY + " a.Narration, "                   
 SELECT @@QRY = @@QRY + " a.VoucherNo as VNO, "        
 SELECT @@QRY = @@QRY + " a.Vdate, "     
 SELECT @@QRY = @@QRY + " a.BankName, "   
 SELECT @@QRY = @@QRY + " a.BranchName "   
 SELECT @@QRY = @@QRY + " from "        
 SELECT @@QRY = @@QRY + " v2_offline_ledger_entries a (NOLOCK) "    
 SELECT @@QRY = @@QRY + " LEFT OUTER JOIN "    
 SELECT @@QRY = @@QRY + " VMAST V ON (V.VTYPE = A.VOUCHERTYPE) "       
 SELECT @@QRY = @@QRY + " Where 1=1 "        
 IF Upper(@Selectionby) = 'VDT'    
 BEGIN      
 SELECT @@QRY = @@QRY + " And a.vDATE >= convert(datetime,'" + @startDate + "',109) "           
 SELECT @@QRY = @@QRY + " and a.vDATE <= convert(datetime,'" + @endDate + " 23:59:59',109) "           
 END    
 ELSE    
 BEGIN    
 SELECT @@QRY = @@QRY + " And a.EDATE >= convert(datetime,'" + @startDate + "',109) "           
 SELECT @@QRY = @@QRY + " and a.EDATE <= convert(datetime,'" + @endDate + " 23:59:59',109) "    
 END    
 SELECT @@QRY = @@QRY + " and a.CltCode >= '" + @FromParty + "' "         
 SELECT @@QRY = @@QRY + " and a.CltCode <= '" + @ToParty + "'"         
 SELECT @@QRY = @@QRY + " AND A.VOUCHERTYPE <> '18'"      
 	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END 


      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " 'CLOSEBAL' AS VNAME, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS VTYP, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BOOKTYPE, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as VDt, "            
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as Edt, "            
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as GLCode, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " CltCode,"    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " BranchCode,"    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " (CASE WHEN SUM(CREDITAMT) - SUM(DEBITAMT) > 0 THEN SUM(CREDITAMT) - SUM(DEBITAMT) ELSE 0 END) AS CREDITAMT, "          
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " (CASE WHEN SUM(CREDITAMT) - SUM(DEBITAMT) <= 0 THEN SUM(DEBITAMT) - SUM(CREDITAMT) ELSE 0 END) AS DEBITAMT, "         
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " 'CLOSING BALANCE' AS Narration, "                   
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS VNO, "        
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '31-DEC-2049' AS Vdate, "     
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BankName, "   
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BranchName "  
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " FROM "
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " ( "
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + @@QRY
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " ) X " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " GROUP BY EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " UNION ALL " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + @@QRY
	if @SORTBY = 'DTASC'
	begin
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Order by  CLTCODE, Exchange, Segment, Vdate asc" 
	end
	else
	begin
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Order by  CLTCODE, Exchange, Segment, Vdate desc" 
	end
EXEC (@@CLOSEBALQRY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_Recreate_VNo
-- --------------------------------------------------
/*select * from ledger where vno like '2006%'     
exec V2_Recreate_VNo*/    
    
    
CREATE Proc [dbo].[V2_Recreate_VNo]    
as    
/*    
            VnoFlag = 0 Yearly      
            VnoFlag = 1 Daily      
            VnoFlag = 2 Monthly      
*/    
    
    
    
    
    
Select f.Vtyp, f.BookType, f.Vdt, Max(VNo), f.VNoFlag, f.FinYear    
From    
(    
      Select     
            x.Vtyp,     
            x.BookType,    
            Vdt = (Case when x.VNoFlag = 0 then Cast(x.Mn1 + ' 1 '+cast(x.Yr as varchar) as Datetime)    
                              when x.VnoFlag = 1 then Cast(left(x.Vdt,11) as Datetime)    
                              when x.VnoFlag = 2 then Cast(x.Mn + ' 1 '+cast(x.Yr as varchar) as Datetime)    
                        End),    
            X.VNO,    
            x.VnoFlag,    
            FinYear = x.FldAuto    
      From    
            (    
                  select     
                  a.Vtyp,     
                  a.BookType,     
                  a.Vdt,     
                  a.VNo,     
                  B.VnoFlag,     
                  b.FldAuto,     
                  Yr = Year(b.sdtCur) ,     
                  Mn1 = left(B.sdtCur,4),    
                  Mn = left(a.Vdt,4),    
                  Dt = day(a.Vdt)    
                  from LEDGER a, Parameter b    
                  where a.Vdt between b.SdtCur and b.LdtCur    
            ) X    
) F    
group by     
f.Vtyp, f.BookType, f.Vdt, f.VNoFlag, f.FinYear

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_SELECTVOUCHERDETAILS_NEW_FP
-- --------------------------------------------------
CREATE PROC [dbo].[V2_SELECTVOUCHERDETAILS_NEW_FP]

@VTYP VARCHAR(2),
@BOOKTYPE VARCHAR(2),
@FROMDATE VARCHAR(12),
@TODATE VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO VARCHAR(12),
@BANKCODE VARCHAR(12) ,
@BANKNAME VARCHAR(50),
@BRANCHCODE VARCHAR(12)

AS

DECLARE
    @@SELECTQURY AS VARCHAR(8000),
    @@FROMTABLES AS VARCHAR(2000),
    @@WHEREPART AS VARCHAR(8000),
    @@SORTBY AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
    BEGIN 
        SELECT @@WHEREPART = " WHERE L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "' AND L.VNO <= '" + @VNOTO + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END

ELSE
    BEGIN
        SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
    BEGIN
        SELECT @@FROMTABLES = " FROM LEDGER L WITH (NOLOCK) LEFT OUTER JOIN  LEDGER1 L1 WITH (NOLOCK) ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.CHQPRINTED=0 AND L.LNO = L1.LNO LEFT OUTER JOIN MULTIBANKID M ON L.CLTCODE = M.CLTCODE AND DEFAULTBANK = 1, " 
        IF @BRANCHCODE <> '%' 
            BEGIN
                SELECT @@FROMTABLES = @@FROMTABLES + " ACMAST A, "
            END
        SELECT @@FROMTABLES = @@FROMTABLES + " ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
        SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED=0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' " 
        IF @BRANCHCODE <> '%' 
            BEGIN        
                SELECT @@WHEREPART = @@WHEREPART + " AND A.CLTCODE = L.CLTCODE AND A.BRANCHCODE = '" + @BRANCHCODE + "' "
            END
    END

SELECT @@WHEREPART = @@WHEREPART

SELECT @@SELECTQURY = " SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "
SELECT @@SELECTQURY = @@SELECTQURY + " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT L.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME=ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, ACCNO = ISNULL(M.ACCNO, '') "

SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_SELECTVOUCHERDETAILS_NEW_RP
-- --------------------------------------------------
CREATE  PROC [dbo].[V2_SELECTVOUCHERDETAILS_NEW_RP]

@VTYP VARCHAR(2),
@BOOKTYPE VARCHAR(2),
@FROMDATE VARCHAR(12),
@TODATE VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO VARCHAR(12),
@BANKCODE VARCHAR(12) ,
@BANKNAME VARCHAR(50),
@BRANCHCODE VARCHAR(12)

AS

DECLARE
    @@SELECTQURY AS VARCHAR(8000),
    @@FROMTABLES AS VARCHAR(2000),
    @@WHEREPART AS VARCHAR(8000),
    @@SORTBY AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
    BEGIN 
        SELECT @@WHEREPART = " WHERE L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "' AND L.VNO <= '" + @VNOTO + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END
ELSE
    BEGIN
        SELECT @@WHEREPART = " WHERE L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END							

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
    BEGIN
        SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'0' AND L.LNO = L1.LNO LEFT OUTER JOIN MULTIBANKID M ON L.CLTCODE = M.CLTCODE AND DEFAULTBANK = 1, " 
        IF @BRANCHCODE <> '%' 
            BEGIN
                SELECT @@FROMTABLES = @@FROMTABLES + " ACMAST A, "
            END
        SELECT @@FROMTABLES = @@FROMTABLES + " ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
        SELECT @@WHEREPART = @@WHEREPART + " AND L1.DDNO<>'0' AND L1.CHQPRINTED > 0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' " 
        IF @BRANCHCODE <> '%' 
            BEGIN        
                SELECT @@WHEREPART = @@WHEREPART + " AND A.CLTCODE = L.CLTCODE AND A.BRANCHCODE = '" + @BRANCHCODE + "' "
            END
    END

SELECT @@WHEREPART = @@WHEREPART

SELECT @@SELECTQURY = " SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "
SELECT @@SELECTQURY = @@SELECTQURY + " SELECT DISTINCT L1.DDDT, L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = numininr(ISNULL(cast(L.VAMT as numeric(18,2)),0)), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT L.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, ACCNO = ISNULL(M.ACCNO, '') "

SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_SELECTVOUCHERDETAILS_UPD
-- --------------------------------------------------
CREATE PROC [dbo].[V2_SELECTVOUCHERDETAILS_UPD]

@VTYP VARCHAR(2),
@BOOKTYPE VARCHAR(2),
@FROMDATE VARCHAR(12),
@TODATE VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO VARCHAR(12),
@BANKCODE VARCHAR(12) ,
@BANKNAME VARCHAR(50),
@BRANCHCODE VARCHAR(12),
@NEWPRINTFLAG VARCHAR(2)

AS

DECLARE
    @@SELECTQURY AS VARCHAR(8000),
    @@FROMTABLES AS VARCHAR(2000),
    @@WHEREPART AS VARCHAR(8000),
    @@SORTBY AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
    BEGIN 
        SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END
ELSE
    BEGIN
        SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END							

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
    BEGIN
        SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO LEFT OUTER JOIN MULTIBANKID M ON L.CLTCODE = M.CLTCODE AND DEFAULTBANK = 1, " 
        IF @BRANCHCODE <> '%' 
            BEGIN
                SELECT @@FROMTABLES = @@FROMTABLES + " ACMAST A, "
            END
        SELECT @@FROMTABLES = @@FROMTABLES + " ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
        IF @NEWPRINTFLAG = 'FP'
            SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED = 0 AND L1.DDNO >= '0' "
        IF @NEWPRINTFLAG = 'RP'
            SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED > 0 AND L1.DDNO > '0' "
        SELECT @@WHEREPART = @@WHEREPART + " AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' " 
        IF @BRANCHCODE <> '%' 
            BEGIN        
                SELECT @@WHEREPART = @@WHEREPART + " AND A.CLTCODE = L.CLTCODE AND A.BRANCHCODE = '" + @BRANCHCODE + "' "
            END
    END

SELECT @@WHEREPART = @@WHEREPART

SELECT @@SELECTQURY = " SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "
SELECT @@SELECTQURY = @@SELECTQURY + " SELECT DISTINCT L1.DDDT, L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT L.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, ACCNO = ISNULL(M.ACCNO, '') "

SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vdtyearend
-- --------------------------------------------------
CREATE Procedure [dbo].[Vdtyearend]  
@sdtcur varchar(11),  
@ldtcur varchar(11),  
@vtyp   smallint,  
@vno varchar(12),  
@BookType char(2),  
@vdt    datetime,  
@msg1   varchar(234)  
AS  
declare  
@@cltcode as varchar(10),  
@@acname  as varchar(100),  
@@vdtbal  as money,  
@@lno     as int,  
@@cdt     as datetime,  
@@netdiff as money,  
@@plcount as int,  
@@plbal   as money,  
@@rcursor as cursor,
@@FixCode Varchar(10) 

Select @@FixCode = '999999'

select @@cdt = ( select getdate() )  
  
set @@rcursor = cursor for  
select l.cltcode,l.acname , balance=isnull(sum( case when upper(drcr) = 'D' then vamt else -vamt end),0)  
from ledger l left outer join acmast a on l.cltcode = a.cltcode  
where l.vdt > = @sdtcur + ' 00:00:00' and l.vdt <= @ldtcur + ' 23:59:59'  
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l.cltcode <> @@FixCode  
group by l.cltcode,l.acname  
order by l.cltcode,l.acname  
  
open @@rcursor  
fetch next from @@rcursor   
into @@cltcode, @@acname, @@vdtbal  
  
select @@lno = 0  
select @@netdiff = 0  
while @@fetch_status = 0  
begin  
   select @@lno = @@lno + 1  
   select @@netdiff = @@netdiff + @@vdtbal  
  
   Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,  
                      EnteredBy,lno,balamt,Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration)   
               values (@vtyp,@vno,(case when @@vdtbal >= 0 then 'D' else 'C' end),isnull(abs(@@vdtbal),0),@vdt,'',upper(@@cltcode),  
                       'System',@@lno,0,@Vno,@booktype,@vdt,@@cdt,@@cdt,0,0,'System',@@acname,@msg1)  
  
  
   Insert into ledger3(naratno,narr,refno,vtyp,vno,BookType)   
                values(@@lno,@msg1,'',@vtyp,@vno,@BookType)  
  
   fetch next from @@rcursor   
   into @@cltcode, @@acname, @@vdtbal  
end  
  
close @@rcursor  
deallocate @@rcursor  
  
select @@lno = @@lno + 1  
select @@acname = ( select acname from acmast where cltcode = @@FixCode)  
Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,  
                   EnteredBy,lno,balamt,Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration)   
            values (@vtyp,@vno,(case when @@netdiff >= 0 then 'C' else 'D' end),abs(@@netdiff),@vdt,'',@@FixCode,  
                    'System',@@lno,0,@Vno,@booktype,@vdt,@@cdt,@@cdt,0,0,'System',@@acname,@msg1)  
  
  
Insert into ledger3  
select lno, narration, refno, vtyp, vno, BookType  
from ledger  
where vtyp = @vtyp and booktype = @booktype and vno = @vno and  cltcode=@@FixCode  
  
Insert into ledger3  
select 0, narration, refno, vtyp, vno, BookType  
from ledger  
where vtyp = @vtyp and booktype = @booktype and vno = @vno and lno = 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VNO_DUPLICATES_RECTIFOCATION
-- --------------------------------------------------
/*begin tran
--EXEC VNO_DUPLICATES_RECTIFOCATION
rollback*/


CREATE PROC [dbo].[VNO_DUPLICATES_RECTIFOCATION]
AS

DECLARE 
	@@MAXVNO VARCHAR(12),
	@@VNO VARCHAR(12),
	@@VTYP SMALLINT,
	@@BOOKTYPE VARCHAR(3),
	@@SDTCUR VARCHAR(11),
	@@LDTCUR VARCHAR(11),
	@@VDT VARCHAR(11),
	@@VNO_SERIES VARCHAR(4),
	@@VAMT MONEY,
	@@NARRATION VARCHAR(250),
	@@COUNTER INT

	CREATE TABLE LEDGER_DUPS_LOG
	(
		VNO VARCHAR(12),
		VTYP SMALLINT,
		BOOKTYPE VARCHAR(3)
	)

	CREATE TABLE #LEDGER_DUPS
	(
		Vtyp SMALLINT,
		Vno VARCHAR(12),
		Edt DATETIME,
		Lno INT,
		Acname VARCHAR(100),
		Drcr CHAR(1),
		Vamt MONEY,
		Vdt DATETIME,
		Vno1 VARCHAR(12),
		Refno VARCHAR(10),
		Balamt MONEY,
		Nodays INT,
		Cdt DATETIME,
		Cltcode VARCHAR(10),
		Booktype VARCHAR(3),
		Enteredby VARCHAR(100),
		Pdt DATETIME,
		Checkedby VARCHAR(100),
		Actnodays INT,
		Narration VARCHAR(250),
		VNO_SERIES VARCHAR(4), 
		SDTCUR VARCHAR(11), 
		LDTCUR VARCHAR(11)
	)

/*	SELECT * INTO #LEDGER_DUPS
	FROM VNO_DUPS WHERE 1 = 2*/

	SELECT * INTO BAK_LEDGER_DUPS_310706 FROM LEDGER WHERE 1 = 2
	SELECT * INTO BAK_LEDGER1_DUPS_310706 FROM LEDGER1 WHERE 1 = 2
	SELECT * INTO BAK_LEDGER2_DUPS_310706 FROM LEDGER2 WHERE 1 = 2
	SELECT * INTO BAK_LEDGER3_DUPS_310706 FROM LEDGER3 WHERE 1 = 2

	
/*	ALTER TABLE #LEDGER_DUPS
	ADD VNO_SERIES VARCHAR(4), SDTCUR VARCHAR(11), LDTCUR VARCHAR(11)*/
	
	UPDATE 
		L 
	SET 
		VNO_SERIES = YEAR(P.SDTCUR), L.SDTCUR = CONVERT(VARCHAR(11), P.SDTCUR, 109), L.LDTCUR = CONVERT(VARCHAR(11), P.LDTCUR, 109)
	FROM 
		#LEDGER_DUPS L, PARAMETER P
	WHERE 
		VDT BETWEEN P.SDTCUR AND P.LDTCUR

	
	DECLARE RENUM_VOUCHER_VNOSERIES CURSOR FOR
	SELECT 
		DISTINCT VNO, VTYP, BOOKTYPE, SDTCUR, LDTCUR, CONVERT(VARCHAR(11), VDT, 109), VNO_SERIES
	FROM 
		#LEDGER_DUPS
	WHERE 
		LEFT(VNO, 4) <> VNO_SERIES
	
	OPEN RENUM_VOUCHER_VNOSERIES
	
	FETCH NEXT FROM RENUM_VOUCHER_VNOSERIES
	INTO @@VNO, @@VTYP, @@BOOKTYPE, @@SDTCUR, @@LDTCUR, @@VDT, @@VNO_SERIES
	
	WHILE @@FETCH_STATUS = 0
	BEGIN

		SELECT 
			@@MAXVNO = ISNULL(CONVERT(VARCHAR(12), CONVERT(NUMERIC, MAX(LASTVNO)) + 1), '')
		FROM 
			LASTVNO 
		WHERE 
			VDT BETWEEN CONVERT(DATETIME, @@SDTCUR) AND CONVERT(DATETIME, @@LDTCUR + ' 23:59')
			AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE

		IF @@MAXVNO IS NOT NULL AND @@MAXVNO <> '' AND LEFT(@@MAXVNO, 4) = @@VNO_SERIES
		BEGIN

			SELECT @@COUNTER = COUNT(1) FROM LEDGER
			WHERE VNO = @@MAXVNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE

			IF @@COUNTER = 0
			BEGIN 
				INSERT INTO BAK_LEDGER_DUPS_310706 
				SELECT * FROM VNO_DUPS
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%'
		
				UPDATE VNO_DUPS SET VNO = @@MAXVNO 
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%'
		
				INSERT INTO BAK_LEDGER1_DUPS_310706 
				SELECT Bnkname,Brnname,Dd,Ddno,Dddt,Reldt,Relamt,Refno,Receiptno,Vtyp,Vno,Lno,Drcr,Booktype,Micrno,Slipno,Slipdate,Chequeinname,Chqprinted,Clear_mode FROM LEDGER1
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE 
				AND RELAMT = (SELECT VAMT FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%' AND LNO = 1)
		
				UPDATE LEDGER1 SET VNO = @@MAXVNO 
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE 
				AND RELAMT = (SELECT VAMT FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%' AND LNO = 1)
		
				
				INSERT INTO BAK_LEDGER2_DUPS_310706 
				SELECT * FROM LEDGER2
				WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
				AND CAMT IN (SELECT VAMT FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%')
		
				UPDATE LEDGER2 SET VNO = @@MAXVNO
				WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
				AND CAMT IN (SELECT VAMT FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%')
		
				INSERT INTO BAK_LEDGER3_DUPS_310706 
				SELECT * FROM LEDGER3
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE 
				AND NARR IN (SELECT NARRATION FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%')
		
				UPDATE LEDGER3 SET VNO = @@MAXVNO 
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE 
				AND NARR IN (SELECT NARRATION FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%')
		
				UPDATE LASTVNO SET LASTVNO = @@MAXVNO
				WHERE VDT BETWEEN @@SDTCUR AND @@LDTCUR + ' 23:59'
				AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE
			END
			ELSE
			BEGIN
				PRINT 'THE VOUCHERS IS NOT UPDATED VNO : ' + @@VNO + ' VTYP : ' + @@VTYP + ' BOOKTYPE : ' + @@BOOKTYPE
				INSERT INTO LEDGER_DUPS_LOG VALUES(@@VNO, @@VTYP, @@BOOKTYPE)
			END
		END
		ELSE
		BEGIN 
			PRINT 'THE VOUCHERS IS NOT UPDATED VNO : ' + @@VNO + ' VTYP : ' + @@VTYP + ' BOOKTYPE : ' + @@BOOKTYPE
			INSERT INTO LEDGER_DUPS_LOG VALUES(@@VNO, @@VTYP, @@BOOKTYPE)
		END
		
		
	FETCH NEXT FROM RENUM_VOUCHER_VNOSERIES
	INTO @@VNO, @@VTYP, @@BOOKTYPE, @@SDTCUR, @@LDTCUR, @@VDT, @@VAMT, @@NARRATION, @@VNO_SERIES
	
	END

	CLOSE RENUM_VOUCHER_VNOSERIES
	DEALLOCATE RENUM_VOUCHER_VNOSERIES

	DECLARE LEDGER_AMT_RENUM CURSOR FOR
	SELECT V.VNO, V.VTYP, V.BOOKTYPE, V.VAMT, V.NARRATION
	FROM 
	(
		SELECT VNO, VTYP, BOOKTYPE, LNO
		FROM VNO_DUPS 
		WHERE LNO = 1 AND VTYP IN(2,3) 
		GROUP BY VNO, VTYP, BOOKTYPE, LNO
		HAVING COUNT(1) > 1
	)A, VNO_DUPS V
	WHERE A.VNO = V.VNO AND A.VTYP = V.VTYP AND A.BOOKTYPE = V.BOOKTYPE 
	GROUP BY V.VNO, V.VTYP, V.BOOKTYPE, V.VAMT, V.NARRATION
	HAVING COUNT(1) = 2 AND SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) = 0

	OPEN LEDGER_AMT_RENUM

	FETCH NEXT FROM LEDGER_AMT_RENUM
	INTO @@VNO, @@VTYP, @@BOOKTYPE, @@VAMT, @@NARRATION

	WHILE @@FETCH_STATUS = 0
	BEGIN

		SELECT @@VDT = CONVERT(VARCHAR(11), VDT, 109) FROM LEDGER 
		WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND VAMT = @@VAMT


		SELECT 
			@@MAXVNO = ISNULL(CONVERT(VARCHAR(12), CONVERT(NUMERIC, MAX(LASTVNO)) + 1), ''), @@SDTCUR = MAX(YEAR(SDTCUR))
		FROM 
			LASTVNO L, PARAMETER P
		WHERE 
			@@VDT BETWEEN CONVERT(DATETIME, CONVERT(VARCHAR(11), SDTCUR, 109)) AND CONVERT(DATETIME, CONVERT(VARCHAR(11), LDTCUR, 11) + ' 23:59')
			AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
	
		IF @@MAXVNO IS NOT NULL AND @@MAXVNO <> '' AND @@SDTCUR = LEFT(@@MAXVNO, 11)
		BEGIN

			SELECT @@COUNTER = COUNT(1) FROM LEDGER
			WHERE VNO = @@MAXVNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE
	
			IF @@COUNTER = 0
			BEGIN 
	
				INSERT INTO BAK_LEDGER_DUPS_310706 
				SELECT * FROM VNO_DUPS
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VAMT = @@VAMT
		
				UPDATE VNO_DUPS SET VNO = @@MAXVNO 
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VAMT = @@VAMT
		
				UPDATE VNO_DUPS SET LNO = 2 
				WHERE VNO = @@MAXVNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VAMT = @@VAMT AND LNO <> 1
		
				INSERT INTO BAK_LEDGER1_DUPS_310706 
				SELECT Bnkname,Brnname,Dd,Ddno,Dddt,Reldt,Relamt,Refno,Receiptno,Vtyp,Vno,Lno,Drcr,Booktype,Micrno,Slipno,Slipdate,Chequeinname,Chqprinted,Clear_mode FROM LEDGER1
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND RELAMT = @@VAMT
		
				UPDATE LEDGER1 SET VNO = @@MAXVNO, LNO = 2
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND RELAMT = @@VAMT
		
				INSERT INTO BAK_LEDGER2_DUPS_310706 
				SELECT * FROM LEDGER2
				WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND CAMT = @@VAMT
		
				UPDATE LEDGER2 SET VNO = @@MAXVNO
				WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND CAMT = @@VAMT
		
				UPDATE LEDGER2 SET LNO = 2
				WHERE VNO = @@MAXVNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND CAMT = @@VAMT AND LNO <> 1
		
				INSERT INTO BAK_LEDGER3_DUPS_310706 
				SELECT * FROM LEDGER3
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND NARR = @@NARRATION
		
				UPDATE LEDGER3 SET VNO = @@MAXVNO 
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND NARR = @@NARRATION
		
				UPDATE L SET LASTVNO = @@MAXVNO
				FROM LASTVNO L, PARAMETER P
				WHERE @@VDT BETWEEN SDTCUR AND CONVERT(VARCHAR(11), LDTCUR, 109) + ' 23:59'
				AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE
			END
			ELSE
			BEGIN
				PRINT 'THE VOUCHERS IS NOT UPDATED VNO : ' + @@VNO + ' VTYP : ' + CONVERT(VARCHAR, @@VTYP) + ' BOOKTYPE : ' + @@BOOKTYPE
				INSERT INTO LEDGER_DUPS_LOG VALUES(@@VNO, @@VTYP, @@BOOKTYPE)
			END
		END
		ELSE
		BEGIN 
			PRINT 'THE VOUCHERS IS NOT UPDATED VNO : ' + @@VNO + ' VTYP : ' + CONVERT(VARCHAR, @@VTYP) + ' BOOKTYPE : ' + @@BOOKTYPE
			INSERT INTO LEDGER_DUPS_LOG VALUES(@@VNO, @@VTYP, @@BOOKTYPE)
		END


	FETCH NEXT FROM LEDGER_AMT_RENUM
	INTO @@VNO, @@VTYP, @@BOOKTYPE, @@VAMT, @@NARRATION
	END 


	CLOSE LEDGER_AMT_RENUM
	DEALLOCATE LEDGER_AMT_RENUM

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VNO_RENUMBER
-- --------------------------------------------------
--SELECT * FROM BAK_LEDGER_LNO_DUPS
--SELECT * FROM LEDGER WHERE VNO = '200708060001' AND VTYP = 2
/*
BEGIN TRAN
EXEC VNO_RENUMBER
ROLLBACK
*/
CREATE PROCEDURE [dbo].[VNO_RENUMBER]
AS

DECLARE
	@@VNO VARCHAR(12),
	@@VTYP SMALLINT,
	@@BOOKTYPE CHAR(2),
	@@CUR_RENUM CURSOR,
	@@COUNTER SMALLINT




CREATE TABLE #VNO_DUPS
(
	VNO VARCHAR(12),
	VTYP SMALLINT,
	BOOKTYPE CHAR(2)
)


SELECT @@COUNTER = COUNT(1) FROM SYSOBJECTS WHERE NAME = 'BAK_LEDGER_LNO_DUPS' AND XTYPE = 'U'

IF @@COUNTER = 0
BEGIN
	CREATE TABLE [BAK_LEDGER_LNO_DUPS] (
		[VTYP] [SMALLINT] NOT NULL ,
		[VNO] [VARCHAR] (12) ,
		[EDT] [DATETIME] NULL ,
		[LNO] [INT],
		[ACNAME] [VARCHAR] (100) ,
		[DRCR] [CHAR] (1)  ,
		[VAMT] [MONEY] NULL ,
		[VDT] [DATETIME] NULL ,
		[VNO1] [VARCHAR] (12)  ,
		[REFNO] [CHAR] (12)  ,
		[BALAMT] [MONEY] NOT NULL ,
		[NODAYS] [INT] NULL ,
		[CDT] [DATETIME] NULL ,
		[CLTCODE] [VARCHAR] (10) ,
		[BOOKTYPE] [CHAR] (2) ,
		[ENTEREDBY] [VARCHAR] (25)  ,
		[PDT] [DATETIME] NULL ,
		[CHECKEDBY] [VARCHAR] (25)  ,
		[ACTNODAYS] [INT] NULL ,
		[NARRATION] [VARCHAR] (234) 
	
	)
END

CREATE TABLE [#LEDGER_LNO_DUPS] (
		[VTYP] [SMALLINT] NOT NULL ,
		[VNO] [VARCHAR] (12) ,
		[EDT] [DATETIME] NULL ,
		[LNO] [INT] IDENTITY (1,1),	
		[ACNAME] [VARCHAR] (100) ,
		[DRCR] [CHAR] (1)  ,
		[VAMT] [MONEY] NULL ,
		[VDT] [DATETIME] NULL ,
		[VNO1] [VARCHAR] (12)  ,
		[REFNO] [CHAR] (12)  ,
		[BALAMT] [MONEY] NOT NULL ,
		[NODAYS] [INT] NULL ,
		[CDT] [DATETIME] NULL ,
		[CLTCODE] [VARCHAR] (10) ,
		[BOOKTYPE] [CHAR] (2) ,
		[ENTEREDBY] [VARCHAR] (25)  ,
		[PDT] [DATETIME] NULL ,
		[CHECKEDBY] [VARCHAR] (25)  ,
		[ACTNODAYS] [INT] NULL ,
		[NARRATION] [VARCHAR] (234) 
	)

INSERT INTO
	#VNO_DUPS
SELECT 
	VNO,
	VTYP,
	BOOKTYPE 
FROM
(
	SELECT 
		 VNO, VTYP, BOOKTYPE, LNO
	FROM 
		LEDGER L 
	WHERE 
		LNO=2 AND VTYP = 2 
		AND NOT EXISTS(
			SELECT 
				VTYP,VNO,BOOKTYPE,LNO
			FROM 
				LEDGER L1 
			WHERE 
				L.VNO = L1.VNO 
				AND L.VTYP = L1.VTYP 
				AND L.BOOKTYPE = L1.BOOKTYPE 
				AND LNO=1 
				AND VTYP = 2 
			GROUP BY 
				VTYP, VNO, BOOKTYPE, LNO
			HAVING 
				COUNT(1)>1)
	GROUP BY 
		VTYP, VNO, BOOKTYPE, LNO
	HAVING 
		COUNT(1)>1
) L


SET @@CUR_RENUM = CURSOR FOR
	SELECT
		VNO, VTYP, BOOKTYPE
	FROM
		#VNO_DUPS
		
OPEN @@CUR_RENUM
FETCH NEXT FROM 
	@@CUR_RENUM		
INTO
	@@VNO, @@VTYP, @@BOOKTYPE

WHILE @@FETCH_STATUS = 0
BEGIN

	PRINT @@VNO

	TRUNCATE TABLE #LEDGER_LNO_DUPS

	INSERT INTO 
		BAK_LEDGER_LNO_DUPS
	SELECT 
		VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT,
		VDT,
		VNO1,
		REFNO,
		BALAMT,
		NODAYS,
		CDT,
		CLTCODE,
		BOOKTYPE,
		ENTEREDBY,
		PDT,
		CHECKEDBY,
		ACTNODAYS,
		NARRATION
	FROM
		LEDGER
	WHERE 
		VNO = @@VNO
		AND VTYP = @@VTYP
		AND BOOKTYPE = @@BOOKTYPE

	INSERT INTO 
		#LEDGER_LNO_DUPS (
			VTYP,
			VNO,
			EDT,
			ACNAME,
			DRCR,
			VAMT,
			VDT,
			VNO1,
			REFNO,
			BALAMT,
			NODAYS,
			CDT,
			CLTCODE,
			BOOKTYPE,
			ENTEREDBY,
			PDT,
			CHECKEDBY,
			ACTNODAYS,
			NARRATION)
	SELECT 
		VTYP,
		VNO,
		EDT,
		ACNAME,
		DRCR,
		VAMT,
		VDT,
		VNO1,
		REFNO,
		BALAMT,
		NODAYS,
		CDT,
		CLTCODE,
		BOOKTYPE,
		ENTEREDBY,
		PDT,
		CHECKEDBY,
		ACTNODAYS,
		NARRATION
	FROM
		LEDGER
	WHERE 
		VNO = @@VNO
		AND VTYP = @@VTYP
		AND BOOKTYPE = @@BOOKTYPE
	ORDER BY
		LNO

	DELETE
	FROM
		LEDGER
	WHERE 
		VNO = @@VNO
		AND VTYP = @@VTYP
		AND BOOKTYPE = @@BOOKTYPE

	INSERT INTO LEDGER
	SELECT * FROM #LEDGER_LNO_DUPS

	FETCH NEXT FROM 
		@@CUR_RENUM		
	INTO
		@@VNO, @@VTYP, @@BOOKTYPE

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VNO_RENUMBER_DUP
-- --------------------------------------------------
/*BEGIN TRAN  
EXEC ACC_GENVNO_NEW 'Aug  7 2007', 2, '01', 'Apr  1 2007', 'Mar 31 2008'  
ROLLBACK*/  
  
--SELECT * FROM BAK_LEDGER_LNO_DUPS  
--SELECT * FROM LEDGER WHERE VNO = '200708060001' AND VTYP = 2  
/*  
BEGIN TRAN  
EXEC VNO_RENUMBER_DUP  
ROLLBACK  
*/  


CREATE PROCEDURE [dbo].[VNO_RENUMBER_DUP]  
AS  
  
DECLARE  
 @@VNO VARCHAR(12),  
 @@VTYP SMALLINT,  
 @@BOOKTYPE CHAR(2),  
 @@VDT VARCHAR(11),  
 @@CUR_RENUM CURSOR,  
 @@SDTCUR VARCHAR(11),  
 @@LDTCUR VARCHAR(11),  
 @@NEW_VNO VARCHAR(12),  
 @@COUNTER SMALLINT  
  
  
  
  
CREATE TABLE #VNO_DUPS  
(  
 VNO VARCHAR(12),  
 VTYP SMALLINT,  
 BOOKTYPE CHAR(2)  
)  
  
  
SELECT @@COUNTER = COUNT(1) FROM SYSOBJECTS WHERE NAME = 'BAK_LEDGER_LNO_DUPS' AND XTYPE = 'U'  
  
IF @@COUNTER = 0  
BEGIN  
 CREATE TABLE [BAK_LEDGER_LNO_DUPS] (  
  [VTYP] [SMALLINT] NOT NULL ,  
  [VNO] [VARCHAR] (12) ,  
  [EDT] [DATETIME] NULL ,  
  [LNO] [INT],  
  [ACNAME] [VARCHAR] (100) ,  
  [DRCR] [CHAR] (1)  ,  
  [VAMT] [MONEY] NULL ,  
  [VDT] [DATETIME] NULL ,  
  [VNO1] [VARCHAR] (12)  ,  
  [REFNO] [CHAR] (12)  ,  
  [BALAMT] [MONEY] NOT NULL ,  
  [NODAYS] [INT] NULL ,  
  [CDT] [DATETIME] NULL ,  
  [CLTCODE] [VARCHAR] (10) ,  
  [BOOKTYPE] [CHAR] (2) ,  
  [ENTEREDBY] [VARCHAR] (25)  ,  
  [PDT] [DATETIME] NULL ,  
  [CHECKEDBY] [VARCHAR] (25)  ,  
  [ACTNODAYS] [INT] NULL ,  
  [NARRATION] [VARCHAR] (234)   
   
 )  
END  
  
INSERT INTO  
 #VNO_DUPS  
SELECT   
 VNO,  
 VTYP,  
 BOOKTYPE   
FROM  
(  
 SELECT   
   VNO, VTYP, BOOKTYPE, LNO  
 FROM   
  LEDGER L   
 WHERE   
  LNO=2 AND VTYP = 2   
  AND EXISTS(  
   SELECT   
    VTYP,VNO,BOOKTYPE,LNO  
   FROM   
    LEDGER L1   
   WHERE   
    L.VNO = L1.VNO   
    AND L.VTYP = L1.VTYP   
    AND L.BOOKTYPE = L1.BOOKTYPE   
    AND LNO=1   
    AND VTYP = 2   
   GROUP BY   
    VTYP, VNO, BOOKTYPE, LNO  
   HAVING   
    COUNT(1)>1)  
 GROUP BY   
  VTYP, VNO, BOOKTYPE, LNO, VAMT  
 HAVING   
  COUNT(1) = 1  
) L  

SELECT DISTINCT * INTO #VNO_COPY FROM #VNO_DUPS
DELETE FROM #VNO_DUPS
INSERT INTO #VNO_DUPS SELECT * FROM #VNO_COPY
  
  
SET @@CUR_RENUM = CURSOR FOR  
 SELECT  
  VNO, VTYP, BOOKTYPE  
 FROM  
  #VNO_DUPS  
    
OPEN @@CUR_RENUM  
FETCH NEXT FROM   
 @@CUR_RENUM    
INTO  
 @@VNO, @@VTYP, @@BOOKTYPE  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
  
 PRINT @@VNO  

 SELECT   
  @@VDT = CONVERT(VARCHAR(11), MAX(VDT), 109)   
 FROM   
  LEDGER   
 WHERE   
  VNO = @@VNO  
  AND VTYP = @@VTYP  
  AND BOOKTYPE = @@BOOKTYPE  
  
 SELECT @@SDTCUR = SDTCUR, @@LDTCUR = LDTCUR  
 FROM PARAMETER  
 WHERE @@VDT BETWEEN SDTCUR AND LDTCUR  
    
  
 INSERT INTO   
  BAK_LEDGER_LNO_DUPS  
 SELECT   
  VTYP,  
  VNO,  
  EDT,  
  LNO,  
  ACNAME,  
  DRCR,  
  VAMT,  
  VDT,  
  VNO1,  
  REFNO,  
  BALAMT,  
  NODAYS,  
  CDT,  
  CLTCODE,  
  BOOKTYPE,  
  ENTEREDBY,  
  PDT,  
  CHECKEDBY,  
  ACTNODAYS,  
  NARRATION  
 FROM  
  LEDGER  
 WHERE   
  VNO = @@VNO  
  AND VTYP = @@VTYP  
  AND BOOKTYPE = @@BOOKTYPE  
  
 CREATE TABLE #VNO  
 (  
  VNO VARCHAR(12)  
 )  
  
/*  
 PRINT @@VDT  
 PRINT @@VTYP  
 PRINT @@BOOKTYPE  
 PRINT @@SDTCUR  
 PRINT @@LDTCUR  
 RETURN  
*/  
  
 INSERT INTO #VNO EXEC ACC_GENVNO_NEW @@VDT, @@VTYP, @@BOOKTYPE, @@SDTCUR, @@LDTCUR  
 SELECT @@NEW_VNO = VNO FROM #VNO  
  
  
 UPDATE   
  LEDGER1   
 SET   
  VNO = @@NEW_VNO   
 WHERE   
  VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE  
  AND RELAMT IN  
  (  
  SELECT   
   VAMT   
  FROM   
   LEDGER  
  WHERE  
   VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND VDT LIKE @@VDT + '%'  
  )  
  
 UPDATE   
  LEDGER2  
 SET   
  VNO = @@NEW_VNO   
 WHERE   
  VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE  
  AND CAMT IN  
  (  
  SELECT   
   VAMT   
  FROM   
   LEDGER  
  WHERE  
   VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND VDT LIKE @@VDT + '%'  
  )  
  
 UPDATE   
  LEDGER3  
 SET   
  VNO = @@NEW_VNO   
 WHERE   
  VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE  
  AND NARR IN  
  (  
  SELECT   
   NARRATION   
  FROM   
   LEDGER  
  WHERE  
   VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND VDT LIKE @@VDT + '%'  
  )  
  
 UPDATE  
  MARGINLEDGER  
 SET   
  VNO = @@NEW_VNO   
 WHERE  
  VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND VDT LIKE @@VDT + '%'  
  
 UPDATE  
  LEDGER  
 SET   
  VNO = @@NEW_VNO   
 WHERE    VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND VDT LIKE @@VDT + '%'  
  
  
  
 FETCH NEXT FROM   
  @@CUR_RENUM    
 INTO  
  @@VNO, @@VTYP, @@BOOKTYPE  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VoucherPrintingSp
-- --------------------------------------------------
--exec VoucherPrintingSp '7','01','01','','','200504070007','200504070007',1,1         
        
--exec VoucherPrintingSp '4','01','01','','','200504020001','200504020001',1,1            
          
/****** Object:  Stored Procedure dbo.VoucherPrintingSp    Script Date: 06/24/2004 8:32:35 PM ******/              
              
/****** Object:  Stored Procedure dbo.VoucherPrintingSp    Script Date: 05/10/2004 5:29:36 PM ******/              
/* comm. narr replaced line narration  by amit requirment in mosl on 18/10/2002*/              
              
CREATE Proc [dbo].[VoucherPrintingSp]               
@Vtyp varchar(2),              
@BookTypeFrom varchar(2),              
@BookTypeTo varchar(2),              
@StartDate Varchar(11),              
@EndDate Varchar(11),              
@VnoFrom Varchar(12),              
@VnoTo Varchar(12),              
@VnoVdtFlag int,              
@Flag int              
as              
              
If @Flag = 0              
Begin              
   if @startdate = ''               
      begin              
/* Conditions of VNO only */              
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24               
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                        ELSE L.acname END ),0),                
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,              
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,              
     narr = isnull(l.narration,'') ,              
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/              
     cnar = isnull(l.narration,'') ,              
   cltcode2 = cltcode, acname2 = acname              
    from ledger l ,LEDGER1 L1              
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo               
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo               
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno    
      end              
   else              
   if @Vnofrom = ''               
      begin              
         /* Conditions on Vdt only */              
  select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                    ELSE L.CLTCODE END ),0),               
    acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                       ELSE L.acname END ),0),                
    isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,              
    bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,              
    narr = isnull(l.narration,'') ,              
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),''), */              
  cnar = isnull(l.narration,'') ,              
  cltcode2 = cltcode, acname2 = acname          
    from ledger l ,LEDGER1 L1              
   where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'              
   and l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype               
    and vdt <=@EndDate + ' 23:59:59'              
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno              
              
      end              
   else              
      begin              
         /* Conditions on Vdt and VNo */              
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24               
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                        ELSE L.acname END ),0),                
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,              
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,              
     narr = isnull(l.narration,'') ,              
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/              
   cnar = isnull(l.narration,'') ,              
   cltcode2 = cltcode, acname2 = acname              
    from ledger l ,LEDGER1 L1              
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo               
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo               
/* Foll condition added by Kalpana on 19/09/2002 */              
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'              
    else 'Jan  1 1900' + ' 00:00:00'              
    end)               
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'              
    else getdate()              
    end)               
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno -- desc              
      end              
end            
              
Else If @Flag = 1              
Begin              
  if @startdate = ''               
     begin              
  /* Conditions of VNO only */              
  select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                       ELSE L.acname END ),0),                
   isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,              
     narr = isnull(l.narration,'') ,              
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/              
   cnar = isnull(l.narration,'') ,              
   cltcode2 = cltcode, acname2 = acname              
     from ledger l               
    where  l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo               
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo            
   --and l.drcr in (case when @Vtyp='6' then 'C' else case when @Vtyp='7' then 'D' else 'C''D' end end)            
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc              
     end              
 else              
 if @Vnofrom = ''               
     begin              
                /* Conditions on Vdt only */              
                
   select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                     THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                      ELSE L.CLTCODE END ),0),               
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                         ELSE L.acname END ),0),                
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,              
     narr = isnull(l.narration,'') ,              
 /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') , */              
   cnar = isnull(l.narration,'') ,              
   cltcode2 = cltcode, acname2 = acname              
    from ledger l               
    where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'               
    and vdt <=@EndDate + ' 23:59:59'              
    order by l.vdt, l.vtyp, l.booktype, l.vno              
     End              
   Else               
          /* Conditions on Vdt and VNo */              
      Begin               
    select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                       ELSE L.acname END ),0),                
   isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,              
     narr = isnull(l.narration,'') ,              
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/              
   cnar = isnull(l.narration,'') ,              
   cltcode2 = cltcode, acname2 = acname              
     from ledger l               
    where  l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo               
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo               
/* Foll condition added by Kalpana on 19/09/2002 */              
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'              
    else 'Jan  1 1900' + ' 00:00:00'              
    end)               
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'              
    else getdate()              
    end)               
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc              
      End                
End              
            
Else If @flag = 2              
Begin              
 if @startdate = ''               
  Begin              
  /* Conditions of VNO only */              
  select   CltCode = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
          ELSE L.CLTCODE END ),0),              
     acname = ISNULL((CASE WHEN a.accat = 14   THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)               
          ELSE L.acname END ),0),              
     l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),              
     narr = isnull(l.narration,'') ,              
     /* cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/              
                        cnar = isnull(l.narration,'') ,              
   cltcode2 = l.cltcode, acname2 = l.acname              
    from ledger l, acmast a              
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo               
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo               
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc              
  End               
    else              
 if @Vnofrom = ''               
     begin              
                /* Conditions on Vdt only */                
    select   CltCode = ISNULL((CASE WHEN a.accat = 14 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                    ELSE L.CLTCODE END ),0),              
     acname = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)               
           ELSE L.acname END ),0),              
    l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),              
    narr = isnull(l.narration,'') ,              
    /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/              
  cnar = isnull(l.narration,'') ,              
  cltcode2 = l.cltcode, acname2 = l.acname              
    from ledger l, acmast a              
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'               
    and vdt <=@EndDate + ' 23:59:59'              
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno              
              
                  
  End               
  Else               
          /* Conditions on Vdt and VNo */              
  Begin              
    select   CltCode = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
          ELSE L.CLTCODE END ),0),              
     acname = ISNULL((CASE WHEN a.accat = 14   THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)               
          ELSE L.acname END ),0),              
     l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),              
     narr = isnull(l.narration,'') ,              
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/              
   cnar = isnull(l.narration,'') ,              
   cltcode2 = l.cltcode, acname2 = l.acname         
    from ledger l, acmast a              
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo               
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo               
/* Foll condition added by Kalpana on 19/09/2002 */              
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'              
    else 'Jan  1 1900' + ' 00:00:00'              
    end)              
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'              
    else getdate()              
    end)               
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno              
  End               
              
End              
else if @flag = 3              
Begin              
   if @startdate = ''               
      begin              
/* Conditions of VNO only */              
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24              
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                        ELSE L.acname END ),0),                
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,              
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,              
     narr = isnull(l.narration,'') ,              
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/              
   cnar = isnull(l.narration,'') ,              
   cltcode2 = cltcode, acname2 = acname              
    from ledger l ,LEDGER1 L1              
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype and l.lno = l1.lno              
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo               
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo               
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc              
      end              
   else              
   if @Vnofrom = ''               
      begin              
         /* Conditions on Vdt only */              
  select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                    ELSE L.CLTCODE END ),0),               
    acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                       ELSE L.acname END ),0),                
    isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,              
    bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,              
    narr = isnull(l.narration,'') ,              
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),''), */              
  cnar = isnull(l.narration,'') ,              
  cltcode2 = cltcode, acname2 = acname              
    from ledger l ,LEDGER1 L1             
   where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'              
   and l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype  and l.lno = l1.lno              
    and vdt <=@EndDate + ' 23:59:59'              
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno              
              
      end              
   else              
      begin              
         /* Conditions on Vdt and VNo */              
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24               
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                        ELSE L.acname END ),0),                
 isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,              
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,              
     narr = isnull(l.narration,'') ,              
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/              
   cnar = isnull(l.narration,'') ,              
   cltcode2 = cltcode, acname2 = acname              
  from ledger l ,LEDGER1 L1              
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype   and l.lno = l1.lno              
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo               
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo               
/* Foll condition added by Kalpana on 19/09/2002 */              
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'              
    else 'Jan  1 1900' + ' 00:00:00'              
    end)               
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'              
    else getdate()              
    end)               
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc              
      end             
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VoucherPrintingSp_test
-- --------------------------------------------------
--exec VoucherPrintingSp_tEST '4','01','01','','','200705000102','200705000102',1,0               
              
--exec VoucherPrintingSp '4','01','01','','','200704000338','200704000338',1,1                  
                
/****** Object:  Stored Procedure dbo.VoucherPrintingSp    Script Date: 06/24/2004 8:32:35 PM ******/                    
                    
/****** Object:  Stored Procedure dbo.VoucherPrintingSp    Script Date: 05/10/2004 5:29:36 PM ******/                    
/* comm. narr replaced line narration  by amit requirment in mosl on 18/10/2002*/                    
  
CREATE Proc [dbo].[VoucherPrintingSp_test]                    
@Vtyp varchar(2),                    
@BookTypeFrom varchar(2),                    
@BookTypeTo varchar(2),                    
@StartDate Varchar(11),                    
@EndDate Varchar(11),                    
@VnoFrom Varchar(12),                    
@VnoTo Varchar(12),                    
@VnoVdtFlag int,                    
@Flag int                    
as             
    
truncate table Voucher_Display    
    
If @Flag = 0                    
Begin                    
   if @startdate = ''                     
      begin                    
/* Conditions of VNO only */     
   insert into Voucher_Display                   
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                     
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
                     ELSE L.CLTCODE END ),0),                     
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                     
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                     
                        ELSE L.acname END ),0),                      
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                    
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                    
     narr = isnull(l.narration,'') ,                    
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                    
     cnar = isnull(l.narration,'') ,                    
   cltcode2 = cltcode, acname2 = acname, costcode = 0                    
    from ledger l ,LEDGER1 L1                    
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                      
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                     
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                     
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno          
      end                    
   else                    
   if @Vnofrom = ''                     
      begin                    
         /* Conditions on Vdt only */        
   insert into Voucher_Display                
  select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                      
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
                    ELSE L.CLTCODE END ),0),                     
    acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                     
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                     
                       ELSE L.acname END ),0),                      
    isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                    
    bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                    
    narr = isnull(l.narration,'') ,                    
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),''), */                    
  cnar = isnull(l.narration,'') ,                    
  cltcode2 = cltcode, acname2 = acname, costcode = 0                
    from ledger l ,LEDGER1 L1                    
   where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                    
   and l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                     
    and vdt <=@EndDate + ' 23:59:59'                    
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno                    
                    
      end                    
   else                    
      begin                    
         /* Conditions on Vdt and VNo */     
   insert into Voucher_Display                   
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                     
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
                     ELSE L.CLTCODE END ),0),                     
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                     
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                     
                        ELSE L.acname END ),0),                      
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                    
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                    
     narr = isnull(l.narration,'') ,                    
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                    
   cnar = isnull(l.narration,'') ,                    
   cltcode2 = cltcode, acname2 = acname, costcode = 0                    
    from ledger l ,LEDGER1 L1                    
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                      
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                     
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                     
/* Foll condition added by Kalpana on 19/09/2002 */                    
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                    
    else 'Jan  1 1900' + ' 00:00:00'                    
    end)                     
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                    
    else getdate()                    
    end)                     
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno -- desc                    
      end                    
end                  
                    
Else If @Flag = 1                    
Begin                    
  if @startdate = ''                     
     begin                    
  /* Conditions of VNO only */       
    
  select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                     
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
                     ELSE L.CLTCODE END ),0),                     
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                     
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                     
                       ELSE L.acname END ),0),                      
   isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                    
     narr = isnull(l.narration,'') ,                    
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                    
   cnar = isnull(l.narration,'') ,                    
   cltcode2 = cltcode, acname2 = acname, costcode = 0                    
     from ledger l                     
    where  l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                     
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                  
   --and l.drcr in (case when @Vtyp='6' then 'C' else case when @Vtyp='7' then 'D' else 'C''D' end end)                  
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                    
     end                    
 else                    
 if @Vnofrom = ''                     
     begin                    
                /* Conditions on Vdt only */                    
    
   select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                     
                     THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
                      ELSE L.CLTCODE END ),0),                     
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                     
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                     
                         ELSE L.acname END ),0),                      
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                    
     narr = isnull(l.narration,'') ,                    
 /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') , */                    
   cnar = isnull(l.narration,'') ,                    
   cltcode2 = cltcode, acname2 = acname, costcode = 0                    
    from ledger l                     
    where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                     
    and vdt <=@EndDate + ' 23:59:59'                    
    order by l.vdt, l.vtyp, l.booktype, l.vno                    
     End                    
   Else                     
          /* Conditions on Vdt and VNo */                    
      Begin      
    
    select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                     
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
                     ELSE L.CLTCODE END ),0),                     
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                     
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                     
                       ELSE L.acname END ),0),                      
   isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                 
     narr = isnull(l.narration,'') ,                    
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                    
   cnar = isnull(l.narration,'') ,                    
   cltcode2 = cltcode, acname2 = acname, costcode = 0                    
     from ledger l                     
    where  l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                     
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                     
/* Foll condition added by Kalpana on 19/09/2002 */                    
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                    
    else 'Jan  1 1900' + ' 00:00:00'           
    end)                     
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                    
    else getdate()                    
    end)                     
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                    
      End                      
End                    
                  
Else If @flag = 2                    
Begin                    
 if @startdate = ''                     
  Begin                    
  /* Conditions of VNO only */       
    
  select   CltCode = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
          ELSE L.CLTCODE END ),0),                    
     acname = ISNULL((CASE WHEN a.accat = 14   THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)                     
          ELSE L.acname END ),0),                    
     l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),                    
     narr = isnull(l.narration,'') ,                    
     /* cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                    
                        cnar = isnull(l.narration,'') ,                    
   cltcode2 = l.cltcode, acname2 = l.acname, costcode = 0                    
    from ledger l, acmast a                    
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                     
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                     
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                    
  End                     
    else                    
 if @Vnofrom = ''                     
     begin                    
                /* Conditions on Vdt only */      
    
    select   CltCode = ISNULL((CASE WHEN a.accat = 14 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
                    ELSE L.CLTCODE END ),0),                    
     acname = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)                     
           ELSE L.acname END ),0),                    
    l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),                    
    narr = isnull(l.narration,'') ,                    
    /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                    
  cnar = isnull(l.narration,'') ,                    
  cltcode2 = l.cltcode, acname2 = l.acname, costcode = 0                    
    from ledger l, acmast a                    
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                     
    and vdt <=@EndDate + ' 23:59:59'                    
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno                    
                    
                        
  End                     
  Else                     
          /* Conditions on Vdt and VNo */     
  Begin       
    
    select   CltCode = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
          ELSE L.CLTCODE END ),0),                    
     acname = ISNULL((CASE WHEN a.accat = 14   THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)                     
          ELSE L.acname END ),0),                    
     l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),                    
     narr = isnull(l.narration,'') ,                    
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                    
   cnar = isnull(l.narration,'') ,                    
   cltcode2 = l.cltcode, acname2 = l.acname, costcode = 0               
    from ledger l, acmast a                    
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                     
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                     
/* Foll condition added by Kalpana on 19/09/2002 */                    
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                    
    else 'Jan  1 1900' + ' 00:00:00'                    
    end)                    
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                    
    else getdate()                    
    end)                     
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno                    
  End                     
                    
End                    
else if @flag = 3                    
Begin                    
   if @startdate = ''                     
      begin                    
/* Conditions of VNO only */        
   insert into Voucher_Display                
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                    
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
                     ELSE L.CLTCODE END ),0),                     
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                     
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                     
                        ELSE L.acname END ),0),                      
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                    
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                    
     narr = isnull(l.narration,'') ,                    
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                    
   cnar = isnull(l.narration,'') ,                    
   cltcode2 = cltcode, acname2 = acname, costcode = 0                    
    from ledger l ,LEDGER1 L1                    
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype and l.lno = l1.lno    
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                     
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                     
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                    
      end                    
   else                    
   if @Vnofrom = ''                     
      begin                    
         /* Conditions on Vdt only */     
   insert into Voucher_Display                   
  select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                      
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
                    ELSE L.CLTCODE END ),0),                     
    acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                     
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                     
                       ELSE L.acname END ),0),                      
    isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                    
    bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                    
    narr = isnull(l.narration,'') ,                    
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),''), */                    
  cnar = isnull(l.narration,'') ,                    
  cltcode2 = cltcode, acname2 = acname, costcode = 0                    
    from ledger l ,LEDGER1 L1                   
   where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                    
   and l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype  and l.lno = l1.lno                    
    and vdt <=@EndDate + ' 23:59:59'                    
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno                    
                    
      end                    
   else                    
      begin                    
         /* Conditions on Vdt and VNo */      
   insert into Voucher_Display                  
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                     
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                     
                     ELSE L.CLTCODE END ),0),                     
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                     
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                     
                        ELSE L.acname END ),0),                      
 isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                    
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                    
     narr = isnull(l.narration,'') ,                    
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                    
   cnar = isnull(l.narration,'') ,                    
   cltcode2 = cltcode, acname2 = acname, costcode = 0                    
  from ledger l ,LEDGER1 L1                    
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype   and l.lno = l1.lno                    
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                     
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                     
/* Foll condition added by Kalpana on 19/09/2002 */                    
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                    
    else 'Jan  1 1900' + ' 00:00:00'                    
    end)                     
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                    
    else getdate()                    
    end)                     
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                    
      end                   
end               
    
update v set costcode = b.branch from ledger2 l2, Voucher_Display v, costmast c, branch b    
where v.vno = l2.vno and v.vtyp = l2.vtype and v.booktype = l2.booktype --and v.lno = l2.lno and v.cltcode = l2.cltcode    
--and v.drcr = l2.drcr   
and l2.costcode= c.costcode and b.branch_code = c.costname AND L2.LNO = 2 and l2.cltcode not in(select brcontrolac from branchaccounts)
                  
select * from Voucher_Display

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vw
-- --------------------------------------------------

CREATE PROC Vw @VwName VARCHAR(25)AS                 
Select * from sysobjects where name Like '%' + @VwName + '%' and xtype='V' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND
-- --------------------------------------------------
    
 /*        
SELECT * FROM LEDGER WHERE VNO  ='200800000001' AND VTYP = 18        
EXEC YEAREND 'APR  1 2007', 'MAR 31 2008', 18, '200804010001', '01', 'APR  1 2008', 'OPENING BALANCE'      
*/        
CREATE PROC YEAREND        
 @SDTCUR VARCHAR(11),        
 @LDTCUR VARCHAR(11),        
 @VTYP SMALLINT,        
 @VNO VARCHAR(12),        
 @BOOKTYPE VARCHAR(2),        
 @VDT VARCHAR(11),        
 @MSG1 VARCHAR(234),      
 @PNL_CODE VARCHAR(10) = '99999'      
AS        
/*        
 EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'TEST OPENING ENTRY'        
 EXEC YEAREND 'Apr  1 2006','Mar 31 2007', 18, '200700000001', '01', 'Apr  1 2007', 'Opening balance'        
 SELECT COUNT(1) FROM LEDGER WHERE VTYP = 18 AND VDT >= 'APR  1 2007'        
         
*/        
      
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE        
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE        
 DELETE FROM LEDGER3 WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE        
 DELETE FROM MARGINLEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE        
        
 CREATE TABLE #VDT        
 (        
  CLTCODE VARCHAR(10),        
  ACNAME VARCHAR(100),        
  DRCR VARCHAR(1),        
  BALANCE MONEY        
 )        
        
 INSERT INTO #VDT        
  (CLTCODE, ACNAME, DRCR, BALANCE)        
 SELECT        
  A.CLTCODE,        
  ACNAME = ISNULL(A.LONGNAME, ''),        
  DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) >= 0 THEN 'D' ELSE 'C' END,        
  VAMT = ABS(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END))        
 FROM        
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE        
 WHERE        
  L.VDT BETWEEN @SDTCUR  AND @LDTCUR + ' 23:59:59'        
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')        
  AND L.CLTCODE <> @PNL_CODE        
 GROUP BY        
  A.CLTCODE,        
  A.LONGNAME        
        
        
 CREATE TABLE #EDT        
 (        
  CLTCODE VARCHAR(10),        
  BALANCE MONEY        
 )        
        
 INSERT INTO #EDT        
  (CLTCODE, BALANCE)        
 SELECT        
  A.CLTCODE,        
  BALANCE = SUM(CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END END)        
 FROM        
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE        
 WHERE        
  L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'        
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')        
  AND L.CLTCODE <> @PNL_CODE        
 GROUP BY        
  A.CLTCODE        
        
        
 CREATE TABLE #LEDGER        
 (        
  VTYP SMALLINT,        
  VNO VARCHAR(12),        
  EDT DATETIME,        
  LNO INT IDENTITY(1,1),        
  ACNAME VARCHAR(100),        
  DRCR CHAR(1),        
  VAMT MONEY,        
  VDT DATETIME,        
  VNO1 VARCHAR(12),        
  REFNO CHAR(12),        
  BALAMT MONEY,        
  NODAYS INT,        
  CDT DATETIME,        
  CLTCODE VARCHAR(10),        
  BOOKTYPE VARCHAR(2),        
  ENTEREDBY VARCHAR(25),        
  PDT DATETIME,        
  CHECKEDBY VARCHAR(25),        
  ACTNODAYS INT,        
  NARRATION VARCHAR(234)        
 )        
        
INSERT INTO #LEDGER        
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)        
SELECT        
 VTYP = @VTYP,        
 VNO = @VNO,        
 EDT = @VDT,        
 ACNAME = V.ACNAME,        
 DRCR = V.DRCR,        
 VAMT = V.BALANCE,        
 VDT = @VDT,        
 VNO1 = @VNO,        
 REFNO = '',        
 BALAMT = ISNULL(E.BALANCE, 0),        
 NODAYS = 0,        
 CDT = GETDATE(),        
 V.CLTCODE,        
 BOOKTYPE = @BOOKTYPE,        
 ENTEREDBY = 'SYSTEM',        
 PDT = GETDATE(),        
 CHECKEDBY = 'SYSTEM',        
 ACTNODAYS = 0,        
 NARRATION = @MSG1        
FROM        
 #VDT V LEFT OUTER JOIN #EDT E ON V.CLTCODE = E.CLTCODE        
        
        
CREATE TABLE #PANDL        
(        
 VDTBAL MONEY,        
 EDTBAL MONEY        
)        
INSERT INTO #PANDL SELECT VDTBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), EDTBAL = (SUM(BALAMT)) FROM #LEDGER        
        
INSERT INTO #LEDGER        
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)        
SELECT        
 VTYP = @VTYP,        
 VNO = @VNO,        
 EDT = @VDT,        
 ACNAME = ISNULL(A.ACNAME, 'PROFIT AND LOSS A/C'),        
 DRCR = CASE WHEN VDTBAL < 0 THEN 'D' ELSE 'C' END,        
 VAMT = ABS(VDTBAL),        
 VDT = @VDT,        
 VNO1 = @VNO,        
 REFNO = '',        
 BALAMT = EDTBAL,        
 NODAYS = 0,        
 CDT = GETDATE(),        
 A.CLTCODE,        
 BOOKTYPE = @BOOKTYPE,        
 ENTEREDBY = 'SYSTEM',        
 PDT = GETDATE(),        
 CHECKEDBY = 'SYSTEM',        
 ACTNODAYS = 0,        
 NARRATION = @MSG1        
FROM        
 #PANDL,        
 ACMAST A        
WHERE        
 A.CLTCODE = @PNL_CODE        
        
        
        
DROP TABLE #VDT        
DROP TABLE #EDT        
DROP TABLE #PANDL        
        
CREATE TABLE #MVDT        
(        
 PARTY_CODE VARCHAR(10),        
 MCLTCODE VARCHAR(10),        
 EXCHANGE VARCHAR(3),        
 SEGMENT VARCHAR(20),        
 DRCR VARCHAR(1),        
 AMOUNT MONEY        
)        
        
INSERT INTO #MVDT        
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, DRCR, AMOUNT)        
SELECT        
 PARTY_CODE,        
 MCLTCODE,        
 EXCHANGE,        
 SEGMENT,        
 DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) >= 0 THEN 'D' ELSE 'C' END,        
 AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)        
FROM        
 MARGINLEDGER        
WHERE        
 VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'        
GROUP BY        
 PARTY_CODE,        
 MCLTCODE,        
 EXCHANGE,        
 SEGMENT        
        
CREATE TABLE #MEDT        
(        
 PARTY_CODE VARCHAR(10),        
 MCLTCODE VARCHAR(10),        
 EXCHANGE VARCHAR(3),        
 SEGMENT VARCHAR(20),        
 AMOUNT MONEY        
)        
        
INSERT INTO #MEDT        
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, AMOUNT)        
SELECT        
 M.PARTY_CODE,        
 M.MCLTCODE,        
 M.EXCHANGE,        
 M.SEGMENT,        
 AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)        
FROM        
 MARGINLEDGER M,        
 LEDGER L        
WHERE        
 M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO        
 AND L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'        
GROUP BY        
 M.PARTY_CODE,        
 M.MCLTCODE,        
 M.EXCHANGE,        
 M.SEGMENT        
        
CREATE TABLE #MARGINLEDGER        
(        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 LNO INT,        
 DRCR VARCHAR(1),        
 VDT DATETIME,        
 AMOUNT MONEY,        
 PARTY_CODE VARCHAR(10),        
 EXCHANGE VARCHAR(3),        
 SEGMENT VARCHAR(20),        
 SETT_NO MONEY,        
 SETT_TYPE VARCHAR(3),        
 BOOKTYPE VARCHAR(2),        
 MCLTCODE VARCHAR(10)        
)        
        
INSERT INTO #MARGINLEDGER        
 (VTYP, VNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)        
SELECT        
 VTYP = @VTYP,        
 VNO = @VNO,        
 DRCR = V.DRCR,        
 VDT = @VDT,        
 AMOUNT = ABS(V.AMOUNT),        
 PARTY_CODE = V.PARTY_CODE,        
 EXCHANGE = V.EXCHANGE,        
 SEGMENT = V.SEGMENT,        
 SETT_NO = ISNULL(E.AMOUNT, 0),        
 SETT_TYPE = '',        
 BOOKTYPE = @BOOKTYPE,        
 MCLTCODE = V.MCLTCODE        
FROM        
 #MVDT V LEFT OUTER JOIN #MEDT E ON        
  V.PARTY_CODE = E.PARTY_CODE        
  AND V.MCLTCODE = E.MCLTCODE        
  AND V.EXCHANGE = E.EXCHANGE        
  AND V.SEGMENT = E.SEGMENT        
        
UPDATE        
 H        
SET        
 LNO = L.LNO        
FROM        
 #MARGINLEDGER H,        
 #LEDGER L        
WHERE        
 H.MCLTCODE = L.CLTCODE        
        
SELECT MCLTCODE, BALANCE = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) INTO #SUMMARGIN FROM #MARGINLEDGER GROUP BY MCLTCODE        
SELECT L.CLTCODE, BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) INTO #SUMLEDGER FROM #LEDGER L, #SUMMARGIN M        
WHERE L.CLTCODE = M.MCLTCODE  GROUP BY L.CLTCODE        
DECLARE @ISDIFF INT        
SET @ISDIFF = 0        
SELECT        
 @ISDIFF = ISNULL(COUNT(1), 0) FROM #SUMMARGIN M, #SUMLEDGER L        
WHERE        
 M.MCLTCODE = L.CLTCODE        
 AND M.BALANCE <> L.BALANCE        
        
/*IF @ISDIFF <> 0        
 BEGIN        
  DROP TABLE #LEDGER        
  DROP TABLE #MARGINLEDGER        
  SELECT ERRNO = 1, ERRMSG = 'MARGIN BALANCE DOES NOT MATCH.'        
 END        
ELSE        
 BEGIN  */      
  INSERT INTO LEDGER SELECT * FROM #LEDGER        
  INSERT INTO LEDGER3 SELECT LNO, NARRATION, REFNO = '', VTYP, VNO, BOOKTYPE FROM #LEDGER        
  INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER        
  EXEC BR_YEAREND  @SDTCUR, @LDTCUR, @VTYP, @VNO, @BOOKTYPE, @VDT, @PNL_CODE        
  DROP TABLE #LEDGER        
  DROP TABLE #MARGINLEDGER        
  SELECT ERRNO = 0, ERRMSG = 'OPENING BALANCES CALCULATED SUCCESSFULLY'        
-- END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND_15062012
-- --------------------------------------------------
/*  
SELECT * FROM LEDGER WHERE VNO  ='200700000001' AND VTYP = 18  
EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'OPENING BALANCE'  
  
EXEC DELETE_LEDGER '200700000001'  
EXEC VDTYEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'OPENING BALANCE'  
EXEC EDTYEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'OPENING BALANCE'  
EXEC MARGINYEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'OPENING BALANCE'  
*/  
CREATE PROC [dbo].[YEAREND_15062012]  
 @SDTCUR VARCHAR(11),  
 @LDTCUR VARCHAR(11),  
 @VTYP SMALLINT,  
 @VNO VARCHAR(12),  
 @BOOKTYPE VARCHAR(2),  
 @VDT VARCHAR(11),  
 @MSG1 VARCHAR(234)  
AS  
/*  
 EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'TEST OPENING ENTRY'  
 EXEC YEAREND 'Apr  1 2006','Mar 31 2007', 18, '200700000001', '01', 'Apr  1 2007', 'Opening balance'  
 SELECT COUNT(1) FROM LEDGER WHERE VTYP = 18 AND VDT >= 'APR  1 2007'  
   
*/  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
 DELETE FROM LEDGER3 WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
 DELETE FROM MARGINLEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
  
 CREATE TABLE #VDT  
 (  
  CLTCODE VARCHAR(10),  
  ACNAME VARCHAR(100),  
  DRCR VARCHAR(1),  
  BALANCE MONEY  
 )  
  
 INSERT INTO #VDT  
  (CLTCODE, ACNAME, DRCR, BALANCE)  
 SELECT  
  A.CLTCODE,  
  ACNAME = ISNULL(A.LONGNAME, ''),  
  DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) >= 0 THEN 'D' ELSE 'C' END,  
  VAMT = ABS(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END))  
 FROM  
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE  
 WHERE  
  L.VDT BETWEEN @SDTCUR  AND @LDTCUR + ' 23:59:59'  
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')  
  AND L.CLTCODE <> '999999'  
 GROUP BY  
  A.CLTCODE,  
  A.LONGNAME  
  
  
 CREATE TABLE #EDT  
 (  
  CLTCODE VARCHAR(10),  
  BALANCE MONEY  
 )  
  
 INSERT INTO #EDT  
  (CLTCODE, BALANCE)  
 SELECT  
  A.CLTCODE,  
  BALANCE = SUM(CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END END)  
 FROM  
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE  
 WHERE  
  L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')  
  AND L.CLTCODE <> '999999'  
 GROUP BY  
  A.CLTCODE  
  
  
 CREATE TABLE #LEDGER  
 (  
  VTYP SMALLINT,  
  VNO VARCHAR(12),  
  EDT DATETIME,  
  LNO INT IDENTITY(1,1),  
  ACNAME VARCHAR(100),  
  DRCR CHAR(1),  
  VAMT MONEY,  
  VDT DATETIME,  
  VNO1 VARCHAR(12),  
  REFNO CHAR(12),  
  BALAMT MONEY,  
  NODAYS INT,  
  CDT DATETIME,  
  CLTCODE VARCHAR(10),  
  BOOKTYPE VARCHAR(2),  
  ENTEREDBY VARCHAR(25),  
  PDT DATETIME,  
  CHECKEDBY VARCHAR(25),  
  ACTNODAYS INT,  
  NARRATION VARCHAR(234)  
 )  
  
INSERT INTO #LEDGER  
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)  
SELECT  
 VTYP = @VTYP,  
 VNO = @VNO,  
 EDT = @VDT,  
 ACNAME = V.ACNAME,  
 DRCR = V.DRCR,  
 VAMT = V.BALANCE,  
 VDT = @VDT,  
 VNO1 = @VNO,  
 REFNO = '',  
 BALAMT = ISNULL(E.BALANCE, 0),  
 NODAYS = 0,  
 CDT = GETDATE(),  
 V.CLTCODE,  
 BOOKTYPE = @BOOKTYPE,  
 ENTEREDBY = 'SYSTEM',  
 PDT = GETDATE(),  
 CHECKEDBY = 'SYSTEM',  
 ACTNODAYS = 0,  
 NARRATION = @MSG1  
FROM  
 #VDT V LEFT OUTER JOIN #EDT E ON V.CLTCODE = E.CLTCODE  
  
  
CREATE TABLE #PANDL  
(  
 VDTBAL MONEY,  
 EDTBAL MONEY  
)  
INSERT INTO #PANDL SELECT VDTBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), EDTBAL = (SUM(BALAMT)) FROM #LEDGER  
  
INSERT INTO #LEDGER  
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)  
SELECT  
 VTYP = @VTYP,  
 VNO = @VNO,  
 EDT = @VDT,  
 ACNAME = ISNULL(A.ACNAME, 'PROFIT AND LOSS A/C'),  
 DRCR = CASE WHEN VDTBAL < 0 THEN 'D' ELSE 'C' END,  
 VAMT = ABS(VDTBAL),  
 VDT = @VDT,  
 VNO1 = @VNO,  
 REFNO = '',  
 BALAMT = EDTBAL,  
 NODAYS = 0,  
 CDT = GETDATE(),  
 A.CLTCODE,  
 BOOKTYPE = @BOOKTYPE,  
 ENTEREDBY = 'SYSTEM',  
 PDT = GETDATE(),  
 CHECKEDBY = 'SYSTEM',  
 ACTNODAYS = 0,  
 NARRATION = @MSG1  
FROM  
 #PANDL,  
 ACMAST A  
WHERE  
 A.CLTCODE = '999999'  
  
  
  
DROP TABLE #VDT  
DROP TABLE #EDT  
DROP TABLE #PANDL  
  
CREATE TABLE #MVDT  
(  
 PARTY_CODE VARCHAR(10),  
 MCLTCODE VARCHAR(10),  
 EXCHANGE VARCHAR(3),  
 SEGMENT VARCHAR(20),  
 DRCR VARCHAR(1),  
 AMOUNT MONEY  
)  
  
INSERT INTO #MVDT  
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, DRCR, AMOUNT)  
SELECT  
 PARTY_CODE,  
 MCLTCODE,  
 EXCHANGE,  
 SEGMENT,  
 DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) >= 0 THEN 'D' ELSE 'C' END,  
 AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
FROM  
 MARGINLEDGER  
WHERE  
 VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
GROUP BY  
 PARTY_CODE,  
 MCLTCODE,  
 EXCHANGE,  
 SEGMENT  
  
CREATE TABLE #MEDT  
(  
 PARTY_CODE VARCHAR(10),  
 MCLTCODE VARCHAR(10),  
 EXCHANGE VARCHAR(3),  
 SEGMENT VARCHAR(20),  
 AMOUNT MONEY  
)  
  
INSERT INTO #MEDT  
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, AMOUNT)  
SELECT  
 M.PARTY_CODE,  
 M.MCLTCODE,  
 M.EXCHANGE,  
 M.SEGMENT,  
 AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)  
FROM  
 MARGINLEDGER M,  
 LEDGER L  
WHERE  
 M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO  
 AND L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
GROUP BY  
 M.PARTY_CODE,  
 M.MCLTCODE,  
 M.EXCHANGE,  
 M.SEGMENT  
  
CREATE TABLE #MARGINLEDGER  
(  
 VTYP SMALLINT,  
 VNO VARCHAR(12),  
 LNO INT,  
 DRCR VARCHAR(1),  
 VDT DATETIME,  
 AMOUNT MONEY,  
 PARTY_CODE VARCHAR(10),  
 EXCHANGE VARCHAR(3),  
 SEGMENT VARCHAR(20),  
 SETT_NO MONEY,  
 SETT_TYPE VARCHAR(3),  
 BOOKTYPE VARCHAR(2),  
 MCLTCODE VARCHAR(10)  
)  
  
INSERT INTO #MARGINLEDGER  
 (VTYP, VNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)  
SELECT  
 VTYP = @VTYP,  
 VNO = @VNO,  
 DRCR = V.DRCR,  
 VDT = @VDT,  
 AMOUNT = ABS(V.AMOUNT),  
 PARTY_CODE = V.PARTY_CODE,  
 EXCHANGE = V.EXCHANGE,  
 SEGMENT = V.SEGMENT,  
 SETT_NO = ISNULL(E.AMOUNT, 0),  
 SETT_TYPE = '',  
 BOOKTYPE = @BOOKTYPE,  
 MCLTCODE = V.MCLTCODE  
FROM  
 #MVDT V LEFT OUTER JOIN #MEDT E ON  
  V.PARTY_CODE = E.PARTY_CODE  
  AND V.MCLTCODE = E.MCLTCODE  
  AND V.EXCHANGE = E.EXCHANGE  
  AND V.SEGMENT = E.SEGMENT  
  
UPDATE  
 H  
SET  
 LNO = L.LNO  
FROM  
 #MARGINLEDGER H,  
 #LEDGER L  
WHERE  
 H.MCLTCODE = L.CLTCODE  
  
SELECT MCLTCODE, BALANCE = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) INTO #SUMMARGIN FROM #MARGINLEDGER GROUP BY MCLTCODE  
SELECT L.CLTCODE, BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) INTO #SUMLEDGER FROM #LEDGER L, #SUMMARGIN M  
WHERE L.CLTCODE = M.MCLTCODE  GROUP BY L.CLTCODE  
DECLARE @ISDIFF INT  
SET @ISDIFF = 0  
SELECT  
 @ISDIFF = ISNULL(COUNT(1), 0) FROM #SUMMARGIN M, #SUMLEDGER L  
WHERE  
 M.MCLTCODE = L.CLTCODE  
 AND M.BALANCE <> L.BALANCE  
  
IF @ISDIFF <> 0  
 BEGIN  
  DROP TABLE #LEDGER  
  DROP TABLE #MARGINLEDGER  
  SELECT ERRNO = 1, ERRMSG = 'MARGIN BALANCE DOES NOT MATCH.'  
 END  
ELSE  
 BEGIN  
  INSERT INTO LEDGER SELECT * FROM #LEDGER  
  INSERT INTO LEDGER3 SELECT LNO, NARRATION, REFNO = '', VTYP, VNO, BOOKTYPE FROM #LEDGER  
  INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER  
  EXEC BRYEAREND  @SDTCUR, @LDTCUR, @VTYP, @VNO, @BOOKTYPE, @VDT  
  DROP TABLE #LEDGER  
  DROP TABLE #MARGINLEDGER  
  SELECT ERRNO = 0, ERRMSG = 'OPENING BALANCES CALCULATED SUCCESSFULLY'  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND_VARIFICATION
-- --------------------------------------------------
 CREATE  PROC YEAREND_VARIFICATION  
 @MSG1 VARCHAR(234)='OPENING BALANCE',    
 @PNL_CODE VARCHAR(10) = '999999'     
AS    
  
DECLARE   
@@VNO  VARCHAR(12),  
@@SDTCURNEW VARCHAR(11),      
@@LDTCURNEW VARCHAR(11),  
@@SDTCUROLD VARCHAR(11),      
@@LDTCUROLD VARCHAR(11),  
@@MAXSDT  VARCHAR(11),  
@@BRFLAG INT   
  
--SELECT DISTINCT @@VNO=VNO FROM LEDGER WHERE  VDT like @VDT +'%' AND VTYP=18  
PRINT  @@VNO  
    
SELECT @@SDTCURNEW=SDTCUR,@@LDTCURNEW=LDTCUR FROM PARAMETER WHERE CURYEAR=1   
  
SELECT @@MAXSDT=MAX(SDTCUR) FROM PARAMETER WHERE CURYEAR<>1  
  
SELECT @@VNO=VNO FROM LEDGER WHERE VDT LIKE @@SDTCURNEW +'%' AND VTYP=18  
  
SELECT @@SDTCUROLD=SDTCUR ,@@LDTCUROLD=LDTCUR FROM PARAMETER WHERE SDTCUR LIKE @@MAXSDT +'%'   
  
SELECT @@BRFLAG=BRANCHFLAG FROM PARAMETER WHERE BRANCHFLAG=1  
  
  
PRINT @@SDTCURNEW  
PRINT @@MAXSDT  
PRINT @@VNO  
PRINT @@SDTCUROLD  
  
  
 SELECT 'LEDGER BALANCES MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE    
  GROUP BY L.CLTCODE    
  UNION ALL    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE    
  GROUP BY L.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
  
IF @@BRFLAG = 1  
PRINT 'VIN'   
BEGIN     
 SELECT 'BRANCHWISE BALANCES MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L    
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO     
  AND VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L2.CLTCODE <> @PNL_CODE    
  GROUP BY L2.CLTCODE    
  UNION ALL    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L     
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO     
  AND L2.VNO = @@VNO AND VTYPE = '18' AND L2.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L2.CLTCODE <> @PNL_CODE    
  GROUP BY L2.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
END  
    
 SELECT 'PROFIT AND LOSS MISMATCH', 0    
 UNION ALL    
 SELECT 'AMOUNT_MISMATCH', SUM(AMOUNT) FROM    
 (    
  SELECT AMOUNT = SUM(AMOUNT) FROM    
  (SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
   FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
   WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
   AND (A.ACTYP LIKE 'INCO%' OR A.ACTYP LIKE 'EXP%')      
   UNION ALL    
  SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
   FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
   WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
   AND L.CLTCODE = @PNL_CODE    
  ) L1    
  UNION ALL    
  SELECT AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND L.CLTCODE = @PNL_CODE    
 ) L    
  
 SELECT 'LEDGER AND LEDGER2 MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE    
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  GROUP BY L.CLTCODE    
  UNION ALL    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE    
  WHERE L2.VNO = @@VNO AND VTYPE = '18' AND L2.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  GROUP BY L2.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
    
 SELECT 'COSTCODEWISE AMOUNT MISMATCH', 0    
 UNION ALL    
 SELECT CONVERT(VARCHAR, COSTCODE), SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)    
 FROM LEDGER2    
 WHERE VNO = @@VNO AND VTYPE = '18' AND BOOKTYPE = '01'    
 GROUP BY CONVERT(VARCHAR, COSTCODE)    
 HAVING SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) <> 0    
  
SELECT 'MARGINLEDGER AMOUNT MISMATCH', 0 ,'',0   
UNION ALL  
SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
FROM MARGINLEDGER M, LEDGER L   
WHERE M.MCLTCODE=L.CLTCODE  
AND AMOUNT<>VAMT  
AND M.VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'   
GROUP BY MCLTCODE,CLTCODE  
  
   
SELECT 'MISMATCH BETWEEN MARGINLEDGER AND LEDGER AMOUNT', 0   
UNION ALL  
 SELECT CLTCODE, SUM(AMOUNT) FROM  (  
 SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 ,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
 FROM MARGINLEDGER M, LEDGER L   
 WHERE M.MCLTCODE=L.CLTCODE  
 AND M.VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'   
 GROUP BY MCLTCODE,CLTCODE  
UNION ALL   
 SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 ,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
 FROM MARGINLEDGER M, LEDGER L   
 WHERE M.MCLTCODE=L.CLTCODE  
 AND M.VTYP='18' AND M.VNO LIKE @@VNO + '%'  
 GROUP BY MCLTCODE,CLTCODE  
 )M  
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0

GO

-- --------------------------------------------------
-- TABLE dbo.acccategory
-- --------------------------------------------------
CREATE TABLE [dbo].[acccategory]
(
    [Categoryid] VARCHAR(10) NULL,
    [Categoryname] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.accountscategory
-- --------------------------------------------------
CREATE TABLE [dbo].[accountscategory]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(100) NULL,
    [Category] VARCHAR(100) NULL,
    [Intrestdr] VARCHAR(100) NULL,
    [Intrestcr] VARCHAR(100) NULL,
    [Dummy1] VARCHAR(100) NULL,
    [Dummy2] VARCHAR(100) NULL,
    [Dummy3] VARCHAR(100) NULL,
    [Dummy4] VARCHAR(100) NULL,
    [Dummy5] VARCHAR(100) NULL,
    [Dummy6] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast]
(
    [acname] VARCHAR(100) NULL,
    [longname] VARCHAR(100) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] VARCHAR(10) NULL,
    [branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_CHK
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_CHK]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(10) NULL,
    [Branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_LEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_LEDGER]
(
    [ACNAME] VARCHAR(100) NOT NULL,
    [LONGNAME] VARCHAR(100) NOT NULL,
    [ACTYP] CHAR(10) NOT NULL,
    [ACCAT] CHAR(10) NOT NULL,
    [FAMILYCD] CHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [ACCDTLS] CHAR(35) NULL,
    [GRPCODE] CHAR(13) NOT NULL,
    [BOOKTYPE] CHAR(4) NULL,
    [MICRNO] VARCHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NOT NULL,
    [BTOBPAYMENT] INT NULL,
    [PAYMODE] CHAR(1) NULL,
    [POBANKNAME] VARCHAR(50) NULL,
    [POBRANCH] VARCHAR(25) NULL,
    [POBANKCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_TLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_TLOG]
(
    [ACNAME] VARCHAR(100) NULL,
    [LONGNAME] VARCHAR(100) NULL,
    [ACTYP] CHAR(10) NULL,
    [ACCAT] CHAR(10) NULL,
    [FAMILYCD] CHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [ACCDTLS] CHAR(35) NULL,
    [GRPCODE] CHAR(13) NULL,
    [BOOKTYPE] CHAR(4) NULL,
    [MICRNO] VARCHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [BTOBPAYMENT] INT NULL,
    [PAYMODE] CHAR(1) NULL,
    [POBANKNAME] VARCHAR(50) NULL,
    [POBRANCH] VARCHAR(25) NULL,
    [POBANKCODE] VARCHAR(10) NULL,
    [UPDDATE] DATETIME NOT NULL,
    [DBACTION] VARCHAR(1) NULL,
    [COMP_NAME] VARCHAR(100) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_TRG]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(10) NULL,
    [Branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast1
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast1]
(
    [acname] VARCHAR(100) NULL,
    [longname] VARCHAR(100) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] VARCHAR(10) NULL,
    [branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angel_temp_mis
-- --------------------------------------------------
CREATE TABLE [dbo].[angel_temp_mis]
(
    [cltcode] VARCHAR(10) NULL,
    [acname] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [ADHRE] MONEY NOT NULL,
    [Bandra] MONEY NOT NULL,
    [KOLGP] MONEY NOT NULL,
    [KHAR_BRANCH] MONEY NOT NULL,
    [MUMRO2] MONEY NOT NULL,
    [NAGUR] MONEY NOT NULL,
    [NHRPL] MONEY NOT NULL,
    [RAJS] MONEY NOT NULL,
    [XO] MONEY NOT NULL,
    [WRNGL] MONEY NOT NULL,
    [KTPLY] MONEY NOT NULL,
    [HYD] MONEY NOT NULL,
    [ERODE] MONEY NOT NULL,
    [CMBTR] MONEY NOT NULL,
    [MDURI] MONEY NOT NULL,
    [SALEM] MONEY NOT NULL,
    [TRPUR] MONEY NOT NULL,
    [KOLK] MONEY NOT NULL,
    [KOLK1] MONEY NOT NULL,
    [KOLNS] MONEY NOT NULL,
    [KOLPA] MONEY NOT NULL,
    [KOLSL] MONEY NOT NULL,
    [JYNG] MONEY NOT NULL,
    [HBLI] MONEY NOT NULL,
    [BNG] MONEY NOT NULL,
    [MYSOR] MONEY NOT NULL,
    [COHIN] MONEY NOT NULL,
    [BHL] MONEY NOT NULL,
    [INDO] MONEY NOT NULL,
    [INDO1] MONEY NOT NULL,
    [INDO2] MONEY NOT NULL,
    [YI] MONEY NOT NULL,
    [XPU] MONEY NOT NULL,
    [XPU1] MONEY NOT NULL,
    [XPU2] MONEY NOT NULL,
    [JLG] MONEY NOT NULL,
    [ARBAD] MONEY NOT NULL,
    [AUNDH] MONEY NOT NULL,
    [KLHPR] MONEY NOT NULL,
    [NAKC] MONEY NOT NULL,
    [NASIK] MONEY NOT NULL,
    [NAGPR] MONEY NOT NULL,
    [MUMRO1] MONEY NOT NULL,
    [NERUL] MONEY NOT NULL,
    [NVASHI] MONEY NOT NULL,
    [PLOANS] MONEY NOT NULL,
    [PMOS] MONEY NOT NULL,
    [POWAI] MONEY NOT NULL,
    [LKDL] MONEY NOT NULL,
    [MALAD] MONEY NOT NULL,
    [MASJID] MONEY NOT NULL,
    [TVLG] MONEY NOT NULL,
    [TB] MONEY NOT NULL,
    [THN] MONEY NOT NULL,
    [VASHI] MONEY NOT NULL,
    [SION] MONEY NOT NULL,
    [RBTRG] MONEY NOT NULL,
    [RK] MONEY NOT NULL,
    [PTN] MONEY NOT NULL,
    [BAN] MONEY NOT NULL,
    [ANE] MONEY NOT NULL,
    [AGOLD] MONEY NOT NULL,
    [ACBPL] MONEY NOT NULL,
    [ACM] MONEY NOT NULL,
    [AKR] MONEY NOT NULL,
    [BVI] MONEY NOT NULL,
    [BVIN] MONEY NOT NULL,
    [CMBUR] MONEY NOT NULL,
    [CALNT] MONEY NOT NULL,
    [CGT] MONEY NOT NULL,
    [KAND] MONEY NOT NULL,
    [INSUR] MONEY NOT NULL,
    [IPO] MONEY NOT NULL,
    [HO] MONEY NOT NULL,
    [DISTR] MONEY NOT NULL,
    [DMAT] MONEY NOT NULL,
    [XPU3] MONEY NOT NULL,
    [XR] MONEY NOT NULL,
    [XT] MONEY NOT NULL,
    [XU] MONEY NOT NULL,
    [XV] MONEY NOT NULL,
    [XW] MONEY NOT NULL,
    [X0001] MONEY NOT NULL,
    [XP] MONEY NOT NULL,
    [WDLA] MONEY NOT NULL,
    [XB] MONEY NOT NULL,
    [XC] MONEY NOT NULL,
    [XD] MONEY NOT NULL,
    [XE] MONEY NOT NULL,
    [XF] MONEY NOT NULL,
    [XG] MONEY NOT NULL,
    [XH] MONEY NOT NULL,
    [XI] MONEY NOT NULL,
    [XJ] MONEY NOT NULL,
    [XM] MONEY NOT NULL,
    [XN] MONEY NOT NULL,
    [YS] MONEY NOT NULL,
    [YV] MONEY NOT NULL,
    [YZ] MONEY NOT NULL,
    [YB] MONEY NOT NULL,
    [YH] MONEY NOT NULL,
    [YD] MONEY NOT NULL,
    [VSANT] MONEY NOT NULL,
    [FRBAD] MONEY NOT NULL,
    [DELCP] MONEY NOT NULL,
    [DELHI] MONEY NOT NULL,
    [DELL] MONEY NOT NULL,
    [DELP] MONEY NOT NULL,
    [DELRSO] MONEY NOT NULL,
    [GJIBD] MONEY NOT NULL,
    [GRGN] MONEY NOT NULL,
    [JLNDR] MONEY NOT NULL,
    [DARKA] MONEY NOT NULL,
    [ROHNI] MONEY NOT NULL,
    [NOIDA] MONEY NOT NULL,
    [SPNR] MONEY NOT NULL,
    [SRITA] MONEY NOT NULL,
    [MYVR] MONEY NOT NULL,
    [MLVYA] MONEY NOT NULL,
    [PTM] MONEY NOT NULL,
    [NEHRU] MONEY NOT NULL,
    [NDD] MONEY NOT NULL,
    [PALP] MONEY NOT NULL,
    [PATAN] MONEY NOT NULL,
    [MESA] MONEY NOT NULL,
    [SSH] MONEY NOT NULL,
    [VD] MONEY NOT NULL,
    [DEESA] MONEY NOT NULL,
    [CNDN] MONEY NOT NULL,
    [AHD] MONEY NOT NULL,
    [ANAND] MONEY NOT NULL,
    [GDHI] MONEY NOT NULL,
    [HIMT] MONEY NOT NULL,
    [EBZ] MONEY NOT NULL,
    [XA] MONEY NOT NULL,
    [YA] MONEY NOT NULL,
    [YA1] MONEY NOT NULL,
    [YA2] MONEY NOT NULL,
    [YA3] MONEY NOT NULL,
    [YAEBG] MONEY NOT NULL,
    [YAINS] MONEY NOT NULL,
    [YAK6] MONEY NOT NULL,
    [YAM5] MONEY NOT NULL,
    [YAMF] MONEY NOT NULL,
    [YAR4] MONEY NOT NULL,
    [YAS7] MONEY NOT NULL,
    [AMRTS] MONEY NOT NULL,
    [CHNDI] MONEY NOT NULL,
    [LUDHN] MONEY NOT NULL,
    [JODH] MONEY NOT NULL,
    [MNSVR] MONEY NOT NULL,
    [UDAY] MONEY NOT NULL,
    [BHIL] MONEY NOT NULL,
    [BKNER] MONEY NOT NULL,
    [AJMER] MONEY NOT NULL,
    [ALWAR] MONEY NOT NULL,
    [KOTA] MONEY NOT NULL,
    [JAIP] MONEY NOT NULL,
    [RJPR] MONEY NOT NULL,
    [JAM1] MONEY NOT NULL,
    [JAMB] MONEY NOT NULL,
    [JAMC] MONEY NOT NULL,
    [JAMK] MONEY NOT NULL,
    [JND] MONEY NOT NULL,
    [KESHD] MONEY NOT NULL,
    [GDHAM] MONEY NOT NULL,
    [GRR] MONEY NOT NULL,
    [ARL] MONEY NOT NULL,
    [BVN] MONEY NOT NULL,
    [BVNS] MONEY NOT NULL,
    [SVB] MONEY NOT NULL,
    [SDRN] MONEY NOT NULL,
    [RAJW] MONEY NOT NULL,
    [RAPCG] MONEY NOT NULL,
    [RRO] MONEY NOT NULL,
    [RAJ] MONEY NOT NULL,
    [RAJ1] MONEY NOT NULL,
    [RAJ2] MONEY NOT NULL,
    [RAJ3] MONEY NOT NULL,
    [RAJ4] MONEY NOT NULL,
    [RAJC] MONEY NOT NULL,
    [RAJEB] MONEY NOT NULL,
    [RAJN] MONEY NOT NULL,
    [RAJOB] MONEY NOT NULL,
    [RAJRR] MONEY NOT NULL,
    [PBR] MONEY NOT NULL,
    [PBRG] MONEY NOT NULL,
    [MNGLR] MONEY NOT NULL,
    [SEBD] MONEY NOT NULL,
    [SG] MONEY NOT NULL,
    [VWD] MONEY NOT NULL,
    [XS] MONEY NOT NULL,
    [XS1] MONEY NOT NULL,
    [XS2] MONEY NOT NULL,
    [XS3] MONEY NOT NULL,
    [XS4] MONEY NOT NULL,
    [XSPCG1] MONEY NOT NULL,
    [YG] MONEY NOT NULL,
    [SVEB] MONEY NOT NULL,
    [VLSD] MONEY NOT NULL,
    [VP] MONEY NOT NULL,
    [BD] MONEY NOT NULL,
    [ANK] MONEY NOT NULL,
    [CHEN] MONEY NOT NULL,
    [AGRA] MONEY NOT NULL,
    [VRNS] MONEY NOT NULL,
    [MRT] MONEY NOT NULL,
    [LUCK] MONEY NOT NULL,
    [KNPR] MONEY NOT NULL,
    [VKPT] MONEY NOT NULL,
    [RJHMY] MONEY NOT NULL,
    [GJWK] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Area
-- --------------------------------------------------
CREATE TABLE [dbo].[Area]
(
    [Areacode] VARCHAR(20) NULL,
    [Description] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BalConfirm_Print_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[BalConfirm_Print_Setting]
(
    [Code] VARCHAR(50) NOT NULL,
    [Description] VARCHAR(1000) NOT NULL,
    [PrintFlag] VARCHAR(1) NOT NULL,
    [OrderNo] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Banklocat
-- --------------------------------------------------
CREATE TABLE [dbo].[Banklocat]
(
    [Cheque] VARCHAR(10) NULL,
    [Type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bankreco
-- --------------------------------------------------
CREATE TABLE [dbo].[Bankreco]
(
    [Cltcode] VARCHAR(10) NULL,
    [Bookdate] DATETIME NULL,
    [Description] VARCHAR(100) NULL,
    [Amount] MONEY NULL,
    [Drcr] VARCHAR(1) NULL,
    [Valuedate] DATETIME NULL,
    [Referenceno] VARCHAR(30) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL,
    [Crossreferenceno] INT NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bankreco_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Bankreco_Log]
(
    [Cltcode] VARCHAR(10) NULL,
    [Bookdate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [Drcr] VARCHAR(1) NULL,
    [Valuedate] DATETIME NULL,
    [Referenceno] VARCHAR(30) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL,
    [Crossreferenceno] INT NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKRECO_MISMATCH_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKRECO_MISMATCH_LOG]
(
    [Cltcode] VARCHAR(10) NULL,
    [BookDate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [DrCr] VARCHAR(1) NULL,
    [ValueDate] DATETIME NULL,
    [ReferenceNo] VARCHAR(30) NULL,
    [StatusId] VARCHAR(15) NULL,
    [StatusName] VARCHAR(25) NULL,
    [LoginName] VARCHAR(25) NULL,
    [CrossReferenceNo] INT NULL,
    [Status] VARCHAR(9) NULL,
    [MicrNo] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [Upload_Date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKRECO_TRIG_TABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKRECO_TRIG_TABLE]
(
    [Cltcode] VARCHAR(10) NULL,
    [Bookdate] DATETIME NULL,
    [Description] VARCHAR(100) NULL,
    [Amount] MONEY NULL,
    [Drcr] VARCHAR(1) NULL,
    [Valuedate] DATETIME NULL,
    [Referenceno] VARCHAR(30) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL,
    [Crossreferenceno] INT NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SRNO] BIGINT NULL,
    [UPD_DATE] DATETIME NULL,
    [COMP_NAME] VARCHAR(100) NULL,
    [FLG] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLLOG]
(
    [GENNO] VARCHAR(50) NULL,
    [STARTTIME] DATETIME NULL,
    [ENDTIME] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [USERNAME] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Billmatch
-- --------------------------------------------------
CREATE TABLE [dbo].[Billmatch]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_no] VARCHAR(12) NULL,
    [Billno] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [Drcr] CHAR(1) NULL,
    [Balamt] MONEY NULL,
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Branch] VARCHAR(10) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BillPosted
-- --------------------------------------------------
CREATE TABLE [dbo].[BillPosted]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [BookType] CHAR(2) NULL,
    [vdt] DATETIME NULL,
    [BillDate] DATETIME NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [narration] VARCHAR(500) NULL,
    [UserName] VARCHAR(25) NULL,
    [PostDate] DATETIME NULL,
    [EdtDr] DATETIME NULL,
    [EdtCr] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLPROCESS]
(
    [IN_PROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Booktype
-- --------------------------------------------------
CREATE TABLE [dbo].[Booktype]
(
    [Vtyp] INT NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Description] VARCHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branch
-- --------------------------------------------------
CREATE TABLE [dbo].[branch]
(
    [Branch_Code] VARCHAR(10) NOT NULL,
    [Branch] VARCHAR(80) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [Address1] VARCHAR(100) NULL,
    [Address2] VARCHAR(100) NULL,
    [City] VARCHAR(40) NULL,
    [State] VARCHAR(30) NULL,
    [Nation] VARCHAR(30) NULL,
    [Zip] VARCHAR(30) NULL,
    [Phone1] VARCHAR(30) NULL,
    [Phone2] VARCHAR(30) NULL,
    [Fax] VARCHAR(30) NULL,
    [Email] VARCHAR(100) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] VARCHAR(60) NULL,
    [Contact_Person] VARCHAR(100) NULL,
    [Prefix] VARCHAR(3) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Branchaccounts
-- --------------------------------------------------
CREATE TABLE [dbo].[Branchaccounts]
(
    [Branchname] VARCHAR(12) NOT NULL,
    [Brcontrolac] VARCHAR(10) NOT NULL,
    [Maincontrolac] VARCHAR(10) NOT NULL,
    [Defaultac] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branchaccounts1
-- --------------------------------------------------
CREATE TABLE [dbo].[branchaccounts1]
(
    [Branchname] VARCHAR(10) NOT NULL,
    [Brcontrolac] VARCHAR(10) NOT NULL,
    [Maincontrolac] VARCHAR(10) NOT NULL,
    [Defaultac] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Branches
-- --------------------------------------------------
CREATE TABLE [dbo].[Branches]
(
    [Branch_Cd] VARCHAR(50) NOT NULL,
    [Short_Name] VARCHAR(20) NOT NULL,
    [Long_Name] VARCHAR(50) NULL,
    [Address1] CHAR(100) NULL,
    [Address2] VARCHAR(100) NULL,
    [City] VARCHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(30) NULL,
    [Contact_Person] CHAR(50) NULL,
    [Com_Perc] MONEY NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Deftrader] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branchwiseclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[branchwiseclbal]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(100) NULL,
    [Costcode] TINYINT NULL,
    [Balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CANNED_LEDGERBALANCE
-- --------------------------------------------------
CREATE TABLE [dbo].[CANNED_LEDGERBALANCE]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [LEDBAL] MONEY NULL,
    [ENTRYTYPE] INT NOT NULL,
    [RUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Category
-- --------------------------------------------------
CREATE TABLE [dbo].[Category]
(
    [Category] CHAR(35) NOT NULL,
    [Catcode] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.catmast
-- --------------------------------------------------
CREATE TABLE [dbo].[catmast]
(
    [Accat] CHAR(10) NOT NULL,
    [Catname] CHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cheque_details
-- --------------------------------------------------
CREATE TABLE [dbo].[cheque_details]
(
    [Ch_Date] DATETIME NULL,
    [Party_code] VARCHAR(12) NULL,
    [DDNO] VARCHAR(15) NULL,
    [Bank] VARCHAR(35) NULL,
    [AccNo] VARCHAR(16) NULL,
    [Amt] MONEY NULL,
    [Created_By] VARCHAR(20) NULL,
    [Created_On] DATETIME NULL,
    [High_NonHigh] CHAR(1) NULL,
    [Bank_Code] VARCHAR(20) NULL,
    [Location] VARCHAR(30) NULL,
    [Entry_Date] DATETIME NULL,
    [SrNo] INT NULL,
    [Status_id] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.chequeformats
-- --------------------------------------------------
CREATE TABLE [dbo].[chequeformats]
(
    [Bankstyle] VARCHAR(50) NOT NULL,
    [Formatcode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableIndex]
(
    [TableName] VARCHAR(50) NULL,
    [IndexName] VARCHAR(200) NULL,
    [IndexType] VARCHAR(18) NULL,
    [IndexColumns] NVARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableListing]
(
    [TableName] VARCHAR(50) NULL,
    [Description] VARCHAR(200) NULL,
    [StatusFlag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Brok_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Brok_Details]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(7) NOT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Trd_Brok] INT NULL,
    [Del_Brok] INT NULL,
    [Ser_Tax] TINYINT NULL,
    [Ser_Tax_Method] TINYINT NULL,
    [Credit_Limit] INT NOT NULL,
    [InActive_From] DATETIME NULL,
    [Print_Options] TINYINT NULL,
    [No_Of_Copies] INT NULL,
    [Participant_Code] VARCHAR(15) NULL,
    [Custodian_Code] VARCHAR(50) NULL,
    [Inst_Contract] CHAR(1) NULL,
    [Round_Style] INT NULL,
    [STP_Provider] VARCHAR(5) NULL,
    [STP_Rp_Style] TINYINT NULL,
    [Market_Type] INT NULL,
    [Multiplier] INT NULL,
    [Charged] INT NULL,
    [Maintenance] INT NULL,
    [Reqd_By_Exch] INT NULL,
    [Reqd_By_Broker] INT NULL,
    [Client_Rating] VARCHAR(10) NULL,
    [Debit_Balance] CHAR(1) NULL,
    [Inter_Sett] CHAR(1) NULL,
    [TRD_STT] MONEY NULL,
    [Trd_Tran_Chrgs] MONEY NULL,
    [Trd_Sebi_Fees] MONEY NULL,
    [Trd_Stamp_Duty] MONEY NULL,
    [Trd_Other_Chrgs] MONEY NULL,
    [Trd_Eff_Dt] DATETIME NULL,
    [Del_Stt] MONEY NULL,
    [Del_Tran_Chrgs] MONEY NULL,
    [Del_SEBI_Fees] MONEY NULL,
    [Del_Stamp_Duty] MONEY NULL,
    [Del_Other_Chrgs] MONEY NULL,
    [Del_Eff_Dt] DATETIME NULL,
    [Rounding_Method] VARCHAR(10) NULL,
    [Round_To_Digit] TINYINT NULL,
    [Round_To_Paise] INT NULL,
    [Fut_Brok] INT NULL,
    [Fut_Opt_Brok] INT NULL,
    [Fut_Fut_Fin_Brok] INT NULL,
    [Fut_Opt_Exc] INT NULL,
    [Fut_Brok_Applicable] INT NULL,
    [Fut_Stt] SMALLINT NULL,
    [Fut_Tran_Chrgs] SMALLINT NULL,
    [Fut_Sebi_Fees] SMALLINT NULL,
    [Fut_Stamp_Duty] SMALLINT NULL,
    [Fut_Other_Chrgs] SMALLINT NULL,
    [Status] CHAR(1) NULL,
    [Modifiedon] DATETIME NULL,
    [Modifiedby] VARCHAR(25) NULL,
    [Imp_Status] TINYINT NULL,
    [Pay_B3B_Payment] CHAR(1) NULL,
    [Pay_Bank_name] VARCHAR(50) NULL,
    [Pay_Branch_name] VARCHAR(50) NULL,
    [Pay_AC_No] VARCHAR(10) NULL,
    [Pay_payment_Mode] CHAR(1) NULL,
    [Brok_Eff_Date] DATETIME NULL,
    [Inst_Trd_Brok] INT NULL,
    [Inst_Del_Brok] INT NULL,
    [SYSTEMDATE] DATETIME NULL,
    [Active_Date] DATETIME NULL,
    [CheckActiveClient] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Details]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(20) NULL,
    [long_name] VARCHAR(100) NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [l_address1] VARCHAR(40) NOT NULL,
    [l_city] VARCHAR(40) NULL,
    [l_address2] VARCHAR(40) NULL,
    [l_state] VARCHAR(50) NULL,
    [l_address3] VARCHAR(40) NULL,
    [l_nation] VARCHAR(15) NULL,
    [l_zip] VARCHAR(10) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [ward_no] VARCHAR(50) NULL,
    [sebi_regn_no] VARCHAR(25) NULL,
    [res_phone1] VARCHAR(15) NULL,
    [res_phone2] VARCHAR(15) NULL,
    [off_phone1] VARCHAR(15) NULL,
    [off_phone2] VARCHAR(15) NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [fax] VARCHAR(15) NULL,
    [email] VARCHAR(50) NULL,
    [cl_type] VARCHAR(3) NOT NULL,
    [cl_status] VARCHAR(3) NOT NULL,
    [family] VARCHAR(10) NOT NULL,
    [region] VARCHAR(20) NULL,
    [area] VARCHAR(20) NULL,
    [p_address1] VARCHAR(50) NULL,
    [p_city] VARCHAR(20) NULL,
    [p_address2] VARCHAR(50) NULL,
    [p_state] VARCHAR(15) NULL,
    [p_address3] VARCHAR(50) NULL,
    [p_nation] VARCHAR(15) NULL,
    [p_zip] VARCHAR(10) NULL,
    [p_phone] VARCHAR(15) NULL,
    [addemailid] VARCHAR(230) NULL,
    [sex] CHAR(1) NULL,
    [dob] DATETIME NULL,
    [introducer] VARCHAR(30) NULL,
    [approver] VARCHAR(30) NULL,
    [interactmode] TINYINT NULL,
    [passport_no] VARCHAR(30) NULL,
    [passport_issued_at] VARCHAR(30) NULL,
    [passport_issued_on] DATETIME NULL,
    [passport_expires_on] DATETIME NULL,
    [licence_no] VARCHAR(30) NULL,
    [licence_issued_at] VARCHAR(30) NULL,
    [licence_issued_on] DATETIME NULL,
    [licence_expires_on] DATETIME NULL,
    [rat_card_no] VARCHAR(30) NULL,
    [rat_card_issued_at] VARCHAR(30) NULL,
    [rat_card_issued_on] DATETIME NULL,
    [votersid_no] VARCHAR(30) NULL,
    [votersid_issued_at] VARCHAR(30) NULL,
    [votersid_issued_on] DATETIME NULL,
    [it_return_yr] VARCHAR(30) NULL,
    [it_return_filed_on] DATETIME NULL,
    [regr_no] VARCHAR(50) NULL,
    [regr_at] VARCHAR(50) NULL,
    [regr_on] DATETIME NULL,
    [regr_authority] VARCHAR(50) NULL,
    [client_agreement_on] DATETIME NULL,
    [sett_mode] VARCHAR(50) NULL,
    [dealing_with_other_tm] VARCHAR(50) NULL,
    [other_ac_no] VARCHAR(50) NULL,
    [introducer_id] VARCHAR(50) NULL,
    [introducer_relation] VARCHAR(50) NULL,
    [repatriat_bank] NUMERIC(18, 0) NULL,
    [repatriat_bank_ac_no] VARCHAR(30) NULL,
    [chk_kyc_form] TINYINT NULL,
    [chk_corporate_deed] TINYINT NULL,
    [chk_bank_certificate] TINYINT NULL,
    [chk_annual_report] TINYINT NULL,
    [chk_networth_cert] TINYINT NULL,
    [chk_corp_dtls_recd] TINYINT NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [AC_Type] VARCHAR(10) NULL,
    [AC_Num] VARCHAR(20) NULL,
    [Depository1] VARCHAR(7) NULL,
    [DpId1] VARCHAR(16) NULL,
    [CltDpId1] VARCHAR(16) NULL,
    [Poa1] CHAR(1) NULL,
    [Depository2] VARCHAR(7) NULL,
    [DpId2] VARCHAR(16) NULL,
    [CltDpId2] VARCHAR(16) NULL,
    [Poa2] CHAR(1) NULL,
    [Depository3] VARCHAR(7) NULL,
    [DpId3] VARCHAR(16) NULL,
    [CltDpId3] VARCHAR(16) NULL,
    [Poa3] CHAR(1) NULL,
    [rel_mgr] VARCHAR(10) NULL,
    [c_group] VARCHAR(10) NULL,
    [sbu] VARCHAR(10) NULL,
    [Status] CHAR(1) NULL,
    [Imp_Status] TINYINT NULL,
    [ModifidedBy] VARCHAR(25) NULL,
    [ModifidedOn] DATETIME NULL,
    [Bank_id] NUMERIC(18, 0) NULL,
    [Mapin_id] VARCHAR(12) NULL,
    [UCC_Code] VARCHAR(12) NULL,
    [Micr_No] VARCHAR(10) NULL,
    [Director_name] VARCHAR(100) NULL,
    [paylocation] VARCHAR(20) NULL,
    [FmCode] VARCHAR(10) NULL,
    [PARENTCODE] VARCHAR(10) NULL,
    [ProductCode] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client1
-- --------------------------------------------------
CREATE TABLE [dbo].[client1]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(21) NOT NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] DECIMAL(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(6) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] DECIMAL(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] TINYINT NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [trader] VARCHAR(20) NULL,
    [WARD_NO] VARCHAR(50) NULL,
    [Region] VARCHAR(20) NULL,
    [Area] VARCHAR(20) NULL,
    [ClRating] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client2
-- --------------------------------------------------
CREATE TABLE [dbo].[client2]
(
    [Cl_Code] CHAR(10) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] DECIMAL(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] INT NULL,
    [Sub_TableNo] INT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] INT NULL,
    [P_To_P] INT NULL,
    [exposure_lim] DECIMAL(12, 2) NOT NULL,
    [demat_tableno] INT NULL,
    [BankId] VARCHAR(16) NULL,
    [CltDpNo] VARCHAR(16) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] SMALLINT NULL,
    [AlbmCF_tableno] INT NULL,
    [MF_tableno] INT NULL,
    [SB_tableno] INT NULL,
    [brok1_tableno] INT NULL,
    [brok2_tableno] INT NULL,
    [brok3_tableno] INT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [MinContAmt] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] INT NULL,
    [InsCont] CHAR(1) NULL,
    [SerTaxMethod] INT NULL,
    [Dummy6] VARCHAR(5) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(10) NULL,
    [Dummy9] VARCHAR(10) NULL,
    [Dummy10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client3
-- --------------------------------------------------
CREATE TABLE [dbo].[Client3]
(
    [Cl_Code] VARCHAR(10) NULL,
    [Party_Code] CHAR(10) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Markettype] VARCHAR(15) NOT NULL,
    [Margin] MONEY NOT NULL,
    [Nooftimes] DECIMAL(2, 0) NOT NULL,
    [Margin_Recd] DECIMAL(18, 0) NULL,
    [Mtom] DECIMAL(18, 0) NULL,
    [Pmarginrate] DECIMAL(5, 2) NULL,
    [Mtomdate] DATETIME NULL,
    [Initialmargin] DECIMAL(18, 4) NULL,
    [Mainenancetmargin] DECIMAL(18, 4) NULL,
    [Marginexchange] DECIMAL(18, 4) NULL,
    [Marginbroker] DECIMAL(18, 4) NULL,
    [Dummy1] VARCHAR(4) NULL,
    [Dummy2] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client4
-- --------------------------------------------------
CREATE TABLE [dbo].[client4]
(
    [Cl_code] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Instru] TINYINT NOT NULL,
    [BankID] VARCHAR(20) NULL,
    [Cltdpid] VARCHAR(20) NULL,
    [Depository] VARCHAR(7) NULL,
    [DefDp] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client5
-- --------------------------------------------------
CREATE TABLE [dbo].[Client5]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Birthdate] SMALLDATETIME NULL,
    [Sex] CHAR(1) NULL,
    [Activefrom] SMALLDATETIME NULL,
    [Interactmode] TINYINT NULL,
    [Repatriatac] TINYINT NULL,
    [Repatriatbank] INT NULL,
    [Repatriatacno] VARCHAR(30) NULL,
    [Introducer] VARCHAR(30) NULL,
    [Approver] VARCHAR(30) NULL,
    [Kycform] TINYINT NULL,
    [Bankcert] TINYINT NULL,
    [Passport] TINYINT NULL,
    [Passportdtl] VARCHAR(30) NULL,
    [Votersid] TINYINT NULL,
    [Votersiddtl] VARCHAR(30) NULL,
    [Itreturn] TINYINT NULL,
    [Itreturndtl] VARCHAR(30) NULL,
    [Drivelicen] TINYINT NULL,
    [Drivelicendtl] VARCHAR(30) NULL,
    [Rationcard] TINYINT NULL,
    [Rationcarddtl] VARCHAR(30) NULL,
    [Corpdtlrecd] TINYINT NULL,
    [Corpdeed] TINYINT NULL,
    [Anualreport] TINYINT NULL,
    [Networthcert] TINYINT NULL,
    [Inactivefrom] DATETIME NULL,
    [P_Address1] VARCHAR(50) NULL,
    [P_Address2] VARCHAR(50) NULL,
    [P_Address3] VARCHAR(50) NULL,
    [P_City] VARCHAR(20) NULL,
    [P_State] VARCHAR(50) NULL,
    [P_Nation] VARCHAR(15) NULL,
    [P_Phone] VARCHAR(15) NULL,
    [P_Zip] VARCHAR(10) NULL,
    [Addemailid] VARCHAR(230) NULL,
    [Passportdateofissue] DATETIME NULL,
    [Passportplaceofissue] VARCHAR(30) NULL,
    [Voteriddateofissue] DATETIME NULL,
    [Voteridplaceofissue] VARCHAR(30) NULL,
    [Itreturndateoffiling] DATETIME NULL,
    [Licencenodateofissue] DATETIME NULL,
    [Licencenoplaceofissue] VARCHAR(30) NULL,
    [Rationcarddateofissue] DATETIME NULL,
    [Rationcardplaceofissue] VARCHAR(30) NULL,
    [Client_Agre_Dt] DATETIME NULL,
    [Regr_No] VARCHAR(50) NULL,
    [Regr_Place] VARCHAR(50) NULL,
    [Regr_Date] DATETIME NULL,
    [Regr_Auth] VARCHAR(50) NULL,
    [Introd_Client_Id] VARCHAR(50) NULL,
    [Introd_Relation] VARCHAR(50) NULL,
    [Any_Other_Acc] VARCHAR(50) NULL,
    [Sett_Mode] VARCHAR(50) NULL,
    [Dealing_With_Othrer_Tm] VARCHAR(50) NULL,
    [Systumdate] DATETIME NULL,
    [Passportexpdate] DATETIME NULL,
    [Driveexpdate] DATETIME NULL,
    [Director_name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Clientmaster
-- --------------------------------------------------
CREATE TABLE [dbo].[Clientmaster]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(21) NOT NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(40) NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [Branch_Cd] VARCHAR(10) NULL,
    [Credit_Limit] DECIMAL(13, 2) NULL,
    [Cl_Type] VARCHAR(3) NULL,
    [Cl_Status] VARCHAR(3) NULL,
    [Gl_Code] VARCHAR(6) NULL,
    [Fd_Code] VARCHAR(4) NULL,
    [Family] VARCHAR(10) NULL,
    [Penalty] DECIMAL(6, 0) NULL,
    [Confirm_Fax] TINYINT NULL,
    [Phoneold] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [Pan_Gir_No] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Clientsmargin
-- --------------------------------------------------
CREATE TABLE [dbo].[Clientsmargin]
(
    [Acname] VARCHAR(50) NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Exchange] VARCHAR(50) NULL,
    [Segment] VARCHAR(50) NULL,
    [Mcltcode] VARCHAR(10) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clienttype
-- --------------------------------------------------
CREATE TABLE [dbo].[clienttype]
(
    [Cl_Type] CHAR(3) NOT NULL,
    [Description] CHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_LEDGER_EOD_STATUS
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_LEDGER_EOD_STATUS]
(
    [EOD_STATUS] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_LEDGER_REPORTS
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_LEDGER_REPORTS]
(
    [VNO] VARCHAR(12) NULL,
    [Vtyp] SMALLINT NULL,
    [BookType] VARCHAR(3) NULL,
    [Debit_Amount] MONEY NULL,
    [Credit_Amount] MONEY NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [Narration] VARCHAR(500) NULL,
    [Cheque_No] VARCHAR(15) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(10) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [MarginCode] VARCHAR(10) NULL,
    [Entry_TYPE] TINYINT NULL,
    [Vdate] INT NULL,
    [Edate] INT NULL,
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chq_Printed] TINYINT NULL,
    [DD] CHAR(1) NULL,
    [Bank_Name] VARCHAR(100) NULL,
    [CROSS_ACC] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_LEDGER_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_LEDGER_TRIG]
(
    [VNO] VARCHAR(12) NULL,
    [Vtyp] TINYINT NULL,
    [BookType] VARCHAR(3) NULL,
    [Updated_Date] DATETIME NULL,
    [Entry] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CMSRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CMSRECO_LOG]
(
    [FILEHEADER_DATE] DATETIME NULL,
    [BANK_CODE] VARCHAR(10) NULL,
    [ENTRY_AMOUNT] MONEY NULL,
    [BR_SNO] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Costmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Costmast]
(
    [Costname] CHAR(35) NOT NULL,
    [Costcode] SMALLINT NOT NULL,
    [Catcode] SMALLINT NOT NULL,
    [Grpcode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.costmast_ALL
-- --------------------------------------------------
CREATE TABLE [dbo].[costmast_ALL]
(
    [Costname] CHAR(35) NOT NULL,
    [Costcode] SMALLINT NOT NULL,
    [Catcode] SMALLINT NOT NULL,
    [Grpcode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.costmast1
-- --------------------------------------------------
CREATE TABLE [dbo].[costmast1]
(
    [Costname] CHAR(35) NOT NULL,
    [Costcode] SMALLINT NOT NULL,
    [Catcode] SMALLINT NOT NULL,
    [Grpcode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Counter_Control
-- --------------------------------------------------
CREATE TABLE [dbo].[Counter_Control]
(
    [Index_Cd] VARCHAR(10) NOT NULL,
    [Key1] VARCHAR(10) NULL,
    [Key2] VARCHAR(10) NULL,
    [Key3] VARCHAR(10) NULL,
    [Key4] VARCHAR(10) NULL,
    [Key5] VARCHAR(10) NULL,
    [Last_Value] NUMERIC(18, 0) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.creditors
-- --------------------------------------------------
CREATE TABLE [dbo].[creditors]
(
    [Cltcode] NVARCHAR(10) NOT NULL,
    [L_address1] NVARCHAR(40) NULL,
    [L_address2] NVARCHAR(40) NULL,
    [L_address3] NVARCHAR(40) NULL,
    [L_city] NVARCHAR(20) NULL,
    [L_state] NVARCHAR(15) NULL,
    [L_nation] NVARCHAR(15) NULL,
    [L_zip] NVARCHAR(10) NULL,
    [Fax] NVARCHAR(15) NULL,
    [Off_phone1] NVARCHAR(15) NULL,
    [Off_phone2] NVARCHAR(15) NULL,
    [Email] NVARCHAR(50) NULL,
    [Mobile_pager] NVARCHAR(40) NULL,
    [Regsupplier] TINYINT NULL,
    [Cstno] NVARCHAR(40) NULL,
    [Sstno] NVARCHAR(40) NULL,
    [Omsflag] TINYINT NULL,
    [Crlimit] MONEY NULL,
    [Crdays] TINYINT NULL,
    [Pan_no] VARCHAR(50) NULL,
    [Servicetax_no] VARCHAR(50) NULL,
    [Tds_no] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DATASTRING
-- --------------------------------------------------
CREATE TABLE [dbo].[DATASTRING]
(
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [MODULE] VARCHAR(30) NULL,
    [SERVER] VARCHAR(30) NULL,
    [LOGIN_ID] VARCHAR(30) NULL,
    [AUTHENTICATION] VARCHAR(50) NULL,
    [COLLECTION] VARCHAR(30) NULL,
    [DRIVER_INFO] VARCHAR(100) NULL,
    [SNO] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DIAG_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[DIAG_LOG]
(
    [ACTIONDATE] DATETIME NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [USERNAME] VARCHAR(25) NULL,
    [OPTIONS] VARCHAR(100) NULL,
    [PERIOD] VARCHAR(30) NULL,
    [RESULT] VARCHAR(2000) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [PROCID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DIAG_RESULT
-- --------------------------------------------------
CREATE TABLE [dbo].[DIAG_RESULT]
(
    [RESULT] VARCHAR(2000) NULL,
    [PROCID] INT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Doc_Ctgry
-- --------------------------------------------------
CREATE TABLE [dbo].[Doc_Ctgry]
(
    [Doc_Cd] VARCHAR(8) NOT NULL,
    [Ctgry_Code] VARCHAR(8) NULL,
    [Group_Code] VARCHAR(8) NOT NULL,
    [Mandatory_Flg] VARCHAR(1) NOT NULL,
    [Stat] VARCHAR(1) NOT NULL,
    [Entry_Id] VARCHAR(20) NOT NULL,
    [Entry_Dt] DATETIME NOT NULL,
    [Effective_Datefrom] DATETIME NOT NULL,
    [Effective_Dateto] DATETIME NOT NULL,
    [Modify_Id] VARCHAR(20) NULL,
    [Modify_Dt] DATETIME NULL,
    [Delete_Id] VARCHAR(20) NULL,
    [Delete_Dt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Document
-- --------------------------------------------------
CREATE TABLE [dbo].[Document]
(
    [Doc_Cd] VARCHAR(8) NOT NULL,
    [Long_Nm] VARCHAR(50) NOT NULL,
    [Stat] VARCHAR(1) NOT NULL,
    [Entry_Id] VARCHAR(20) NOT NULL,
    [Entry_Dt] DATETIME NOT NULL,
    [Modify_Id] VARCHAR(20) NULL,
    [Modify_Dt] DATETIME NULL,
    [Delete_Id] VARCHAR(20) NULL,
    [Delete_Dt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.edtclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[edtclbal]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(100) NULL,
    [Balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ERROR_TBL
-- --------------------------------------------------
CREATE TABLE [dbo].[ERROR_TBL]
(
    [ERR_ID] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Errvouchers
-- --------------------------------------------------
CREATE TABLE [dbo].[Errvouchers]
(
    [Cdt] DATETIME NULL,
    [Errstr] VARCHAR(300) NULL,
    [Statusid] VARCHAR(30) NULL,
    [Statusname] VARCHAR(30) NULL,
    [Username] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILE_OUTPUT
-- --------------------------------------------------
CREATE TABLE [dbo].[FILE_OUTPUT]
(
    [PROCID] INT NULL,
    [CSVFILE] VARCHAR(200) NULL,
    [CONTENTS] VARCHAR(2000) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FNOLEDBAL
-- --------------------------------------------------
CREATE TABLE [dbo].[FNOLEDBAL]
(
    [CLTCODE] VARCHAR(10) NULL,
    [FNO_TOTALBAL] MONEY NULL,
    [FNO_LEDBAL] MONEY NULL,
    [FNO_COLLATERAL] MONEY NULL,
    [FNO_MARGIN] MONEY NULL,
    [MARGIN_DATE] DATETIME NULL,
    [SPANMARGIN] MONEY NULL,
    [EXPOSUREMARGIN] MONEY NULL,
    [CASH] MONEY NULL,
    [NONCASH] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.grpmast
-- --------------------------------------------------
CREATE TABLE [dbo].[grpmast]
(
    [Grpname] VARCHAR(60) NULL,
    [Grpmain] VARCHAR(13) NULL,
    [Grpcode] VARCHAR(13) NULL,
    [Vtyp] FLOAT NULL,
    [Dispdetail] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Lastchequeno
-- --------------------------------------------------
CREATE TABLE [dbo].[Lastchequeno]
(
    [Bankcode] VARCHAR(10) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Ddno] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NOT NULL,
    [Edt] DATETIME NULL,
    [Lno] INT NOT NULL,
    [Acname] VARCHAR(100) NOT NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_log]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [optcode] CHAR(1) NULL,
    [Editdate] DATETIME NULL,
    [EditName] VARCHAR(15) NULL,
    [Status] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_Report
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_Report]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] INT NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL,
    [SNo] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_SANDIP_DELETE
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_SANDIP_DELETE]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NOT NULL,
    [Edt] DATETIME NULL,
    [Lno] INT NOT NULL,
    [Acname] VARCHAR(100) NOT NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_Temp_New
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_Temp_New]
(
    [Vno] INT NOT NULL,
    [CltCode] VARCHAR(10) NOT NULL,
    [Vdt] DATETIME NULL,
    [Edt] DATETIME NULL,
    [VTyp] SMALLINT NOT NULL,
    [Vamt] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(15) NOT NULL,
    [acname] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TEMP_NEW_PARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TEMP_NEW_PARTYLEDGER]
(
    [CLTCODE] VARCHAR(10) NULL,
    [LONGNAME] VARCHAR(100) NULL,
    [VDT] VARCHAR(11) NULL,
    [EDT] VARCHAR(11) NULL,
    [VAMT] MONEY NULL,
    [MAMT] MONEY NULL,
    [DRCR] CHAR(2) NULL,
    [AREA] VARCHAR(10) NULL,
    [AREA_NAME] VARCHAR(100) NULL,
    [REGION] VARCHAR(10) NULL,
    [REGION_NAME] VARCHAR(100) NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [BRANCH_NAME] VARCHAR(100) NULL,
    [SUBBROKER] VARCHAR(10) NULL,
    [SUBBROKER_NAME] VARCHAR(100) NULL,
    [TRADER] VARCHAR(10) NULL,
    [TRADER_NAME] VARCHAR(100) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [FAMILY_NAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TRG]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] INT NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TRG_BILL
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TRG_BILL]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] INT NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TRIG]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_txt
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_txt]
(
    [Txt] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger1
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger1]
(
    [Bnkname] VARCHAR(35) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_BANKRECO_LOG]
(
    [Bnkname] VARCHAR(35) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger1_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger1_log]
(
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_MANUALRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_MANUALRECO_LOG]
(
    [Bnkname] VARCHAR(35) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_TRG]
(
    [Bnkname] VARCHAR(35) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_TRIG]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger2
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger2]
(
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Camt] MONEY NULL,
    [Costcode] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Cltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger2_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger2_log]
(
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL,
    [BookType] CHAR(2) NULL,
    [cltcode] VARCHAR(10) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER2_SANDIP_DELETE
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER2_SANDIP_DELETE]
(
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Camt] MONEY NULL,
    [Costcode] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Cltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER2MIS
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER2MIS]
(
    [VNO] VARCHAR(12) NULL,
    [VTYPE] INT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [REASON] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger3
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger3]
(
    [Naratno] INT NOT NULL,
    [Narr] VARCHAR(234) NULL,
    [Refno] CHAR(12) NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger3_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger3_log]
(
    [naratno] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [refno] CHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [BookType] CHAR(2) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER3_SANDIP_DELETE
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER3_SANDIP_DELETE]
(
    [Naratno] INT NOT NULL,
    [Narr] VARCHAR(234) NULL,
    [Refno] CHAR(12) NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledgerbalances
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledgerbalances]
(
    [Familycode] VARCHAR(50) NULL,
    [Cltcode] VARCHAR(50) NULL,
    [Acname] VARCHAR(100) NULL,
    [Nsebalance] MONEY NULL,
    [Bsebalance] MONEY NULL,
    [Nsefobalance] MONEY NULL,
    [Nseestimated1] MONEY NULL,
    [Nseestimated2] MONEY NULL,
    [Bseestimated1] MONEY NULL,
    [Bseestimated2] MONEY NULL,
    [Faactual] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledgersachin
-- --------------------------------------------------
CREATE TABLE [dbo].[ledgersachin]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NOT NULL,
    [Edt] DATETIME NULL,
    [Lno] INT NOT NULL,
    [Acname] VARCHAR(100) NOT NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Marginledger
-- --------------------------------------------------
CREATE TABLE [dbo].[Marginledger]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] INT NOT NULL,
    [Drcr] CHAR(1) NOT NULL,
    [Vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Mcltcode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.marginledger_log
-- --------------------------------------------------
CREATE TABLE [dbo].[marginledger_log]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NOT NULL,
    [drcr] CHAR(1) NOT NULL,
    [vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [BookType] CHAR(2) NULL,
    [MCltcode] VARCHAR(10) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Matchdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[Matchdetails]
(
    [Description] VARCHAR(20) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [Drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Lvtype] SMALLINT NULL,
    [Lvno] VARCHAR(12) NULL,
    [Llno] DECIMAL(4, 0) NULL,
    [Lbooktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.matchdetails_log
-- --------------------------------------------------
CREATE TABLE [dbo].[matchdetails_log]
(
    [Description] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [Booktype] CHAR(2) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [lvtype] SMALLINT NULL,
    [lvno] VARCHAR(12) NULL,
    [llno] DECIMAL(4, 0) NULL,
    [lBookType] CHAR(2) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MPI_PayIn
-- --------------------------------------------------
CREATE TABLE [dbo].[MPI_PayIn]
(
    [BranchCode] VARCHAR(10) NOT NULL,
    [PartyCode] VARCHAR(10) NOT NULL,
    [BankCode] VARCHAR(10) NOT NULL,
    [BankAC] VARCHAR(16) NOT NULL,
    [BankName] VARCHAR(50) NOT NULL,
    [ACOwner] CHAR(1) NOT NULL,
    [ACType] CHAR(2) NOT NULL,
    [LongName] VARCHAR(100) NOT NULL,
    [HOCltCode] VARCHAR(10) NOT NULL,
    [HOGlCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multibankid
-- --------------------------------------------------
CREATE TABLE [dbo].[multibankid]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(16) NOT NULL,
    [Accno] VARCHAR(20) NOT NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multibankid_trig
-- --------------------------------------------------
CREATE TABLE [dbo].[multibankid_trig]
(
    [Srno] INT NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Bankid] VARCHAR(16) NULL,
    [Accno] VARCHAR(16) NULL,
    [Acctype] VARCHAR(7) NULL,
    [Chequename] VARCHAR(100) NULL,
    [Defaultbank] CHAR(1) NULL,
    [upd_date] DATETIME NULL,
    [comp_name] VARCHAR(50) NULL,
    [status] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multicompany
-- --------------------------------------------------
CREATE TABLE [dbo].[multicompany]
(
    [BrokerId] VARCHAR(6) NOT NULL,
    [CompanyName] VARCHAR(100) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [MemberType] VARCHAR(3) NOT NULL,
    [MemberCode] VARCHAR(15) NOT NULL,
    [ShareDb] VARCHAR(20) NOT NULL,
    [ShareServer] VARCHAR(100) NOT NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NOT NULL,
    [AccountServer] VARCHAR(100) NOT NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NOT NULL,
    [DefaultDbServer] VARCHAR(100) NOT NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [primaryServer] VARCHAR(100) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NEWPARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[NEWPARTYLEDGER]
(
    [BRANCH_CODE] VARCHAR(11) NULL,
    [BRANCH] VARCHAR(100) NULL,
    [CLTCODE] VARCHAR(11) NULL,
    [ACNAME] VARCHAR(50) NULL,
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [AREA] VARCHAR(10) NULL,
    [REGION] VARCHAR(50) NULL,
    [PARTY] VARCHAR(10) NULL,
    [VAMT] MONEY NULL DEFAULT ((0)),
    [MAMT] MONEY NULL DEFAULT ((0)),
    [UNREALISED] MONEY NULL DEFAULT ((0)),
    [SPID] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NEWPARTYLEDGER1
-- --------------------------------------------------
CREATE TABLE [dbo].[NEWPARTYLEDGER1]
(
    [BRANCH_CODE] VARCHAR(11) NULL,
    [BRANCH] VARCHAR(100) NULL,
    [CLTCODE] VARCHAR(11) NULL,
    [ACNAME] VARCHAR(50) NULL,
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [AREA] VARCHAR(10) NULL,
    [REGION] VARCHAR(50) NULL,
    [PARTY] VARCHAR(10) NULL,
    [NSEVAMT] MONEY NOT NULL DEFAULT ((0)),
    [BSEVAMT] MONEY NOT NULL DEFAULT ((0)),
    [NFOVAMT] MONEY NOT NULL DEFAULT ((0)),
    [NSEMAMT] MONEY NOT NULL DEFAULT ((0)),
    [BSEMAMT] MONEY NOT NULL DEFAULT ((0)),
    [NFOMAMT] MONEY NOT NULL DEFAULT ((0)),
    [NSEUNREALISED] MONEY NOT NULL DEFAULT ((0)),
    [BSEUNREALISED] MONEY NOT NULL DEFAULT ((0)),
    [NFOUNREALISED] MONEY NOT NULL DEFAULT ((0)),
    [NSEHTOTAL] MONEY NOT NULL DEFAULT ((0)),
    [BSEHTOTAL] MONEY NOT NULL DEFAULT ((0)),
    [NFOHTOTAL] MONEY NOT NULL DEFAULT ((0)),
    [VAMT] MONEY NOT NULL DEFAULT ((0)),
    [MAMT] MONEY NOT NULL DEFAULT ((0)),
    [UNREALISED] MONEY NOT NULL DEFAULT ((0)),
    [HTOTAL] MONEY NOT NULL DEFAULT ((0)),
    [SPID] INT NULL,
    [SESSIONID] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Offline_RecPay_Table
-- --------------------------------------------------
CREATE TABLE [dbo].[Offline_RecPay_Table]
(
    [EDATE] VARCHAR(20) NULL,
    [VOUCHER_DATE] VARCHAR(20) NULL,
    [CLIENT_CODE] VARCHAR(50) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [SERIAL_NO] INT NULL,
    [SNO] INT NOT NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [VDT] DATETIME NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL DEFAULT 'N',
    [EDT] DATETIME NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [COSTCODE] SMALLINT NULL,
    [CASHBRANCH] VARCHAR(100) NULL,
    [CASHCOST] SMALLINT NULL,
    [LNO] SMALLINT NOT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.opencltcode
-- --------------------------------------------------
CREATE TABLE [dbo].[opencltcode]
(
    [Acname] VARCHAR(100) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Branch] VARCHAR(35) NULL,
    [Status] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Owner
-- --------------------------------------------------
CREATE TABLE [dbo].[Owner]
(
    [CompanyName] VARCHAR(50) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [ShareDB] VARCHAR(10) NOT NULL,
    [AccountDB] VARCHAR(20) NOT NULL,
    [clientgroup] VARCHAR(35) NULL,
    [balsign] TINYINT NULL,
    [conpath] VARCHAR(50) NULL,
    [segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(15) NULL,
    [RecoFlag] CHAR(1) NOT NULL DEFAULT 'Y'
);

GO

-- --------------------------------------------------
-- TABLE dbo.Parameter
-- --------------------------------------------------
CREATE TABLE [dbo].[Parameter]
(
    [Sdtcur] DATETIME NULL,
    [Ldtcur] DATETIME NULL,
    [Ldtprv] DATETIME NULL,
    [Sdtnxt] DATETIME NULL,
    [Curyear] TINYINT NULL,
    [Vnoflag] SMALLINT NULL,
    [Match_btob] SMALLINT NULL,
    [Match_ctoc] SMALLINT NULL,
    [Maker_checker] SMALLINT NULL,
    [Voucherprintflag] SMALLINT NULL,
    [Branchflag] SMALLINT NULL,
    [FldAuto] INT IDENTITY(1,1) NOT NULL,
    [REPORTDAYS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Payadv
-- --------------------------------------------------
CREATE TABLE [dbo].[Payadv]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] CHAR(100) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Amt] MONEY NULL,
    [Chequeno] VARCHAR(15) NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Narration] VARCHAR(234) NULL,
    [Printedflag] TINYINT NULL,
    [Actamt] MONEY NULL,
    [Shortage] MONEY NULL,
    [Vtyp] SMALLINT NOT NULL DEFAULT ((3)),
    [Vno] VARCHAR(12) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Paymentmarking
-- --------------------------------------------------
CREATE TABLE [dbo].[Paymentmarking]
(
    [Paymentdate] DATETIME NULL,
    [Branchcode] VARCHAR(10) NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Defbtobpayment] CHAR(1) NULL,
    [Defpaymode] CHAR(1) NULL,
    [Bankcode] VARCHAR(10) NULL,
    [Amounttobepaid] MONEY NULL,
    [Actualamoutpaid] MONEY NULL,
    [Instrumentno] INT NULL,
    [Paymarkflag] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Vno] VARCHAR(12) NULL,
    [Remark] VARCHAR(50) NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Vtyp] VARCHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Approvedby] VARCHAR(15) NULL,
    [Hoapproval] INT NULL,
    [Approvedon] DATETIME NULL,
    [Chequeno] VARCHAR(12) NULL,
    [Chequeprinted] INT NULL,
    [SNO] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayOut_GlobalParams
-- --------------------------------------------------
CREATE TABLE [dbo].[PayOut_GlobalParams]
(
    [ReqTime] INT NOT NULL,
    [AppTime] INT NOT NULL,
    [MinPayout] MONEY NOT NULL,
    [MaxPayout] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PLDetail
-- --------------------------------------------------
CREATE TABLE [dbo].[PLDetail]
(
    [SrNo] INT NULL,
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Vtype] INT NULL,
    [Setttype] VARCHAR(3) NULL,
    [Narration] VARCHAR(25) NULL,
    [ReportURL] VARCHAR(250) NULL,
    [Flag] CHAR(1) NULL DEFAULT 'Y'
);

GO

-- --------------------------------------------------
-- TABLE dbo.PLDetail_1
-- --------------------------------------------------
CREATE TABLE [dbo].[PLDetail_1]
(
    [SrNo] INT NULL,
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Vtype] INT NULL,
    [Setttype] VARCHAR(3) NULL,
    [Narration] VARCHAR(50) NULL,
    [ReportURL] VARCHAR(250) NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PLEXCHANGE
-- --------------------------------------------------
CREATE TABLE [dbo].[PLEXCHANGE]
(
    [SELECTION] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PLgroup_mstr
-- --------------------------------------------------
CREATE TABLE [dbo].[PLgroup_mstr]
(
    [Group_Code] VARCHAR(13) NULL,
    [Group_Name] VARCHAR(100) NULL,
    [Main_group] VARCHAR(13) NULL,
    [Amount] NUMERIC(18, 4) NULL,
    [type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Pobank
-- --------------------------------------------------
CREATE TABLE [dbo].[Pobank]
(
    [Bankid] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Bank_Name] VARCHAR(50) NOT NULL,
    [Branch_Name] VARCHAR(40) NOT NULL,
    [Address1] VARCHAR(50) NULL,
    [Address2] VARCHAR(50) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Nation] VARCHAR(25) NULL,
    [Zip] VARCHAR(15) NULL,
    [Phone1] VARCHAR(15) NULL,
    [Phone2] VARCHAR(15) NULL,
    [Fax] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PostBillLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[PostBillLedger]
(
    [VTYP] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [EDT] DATETIME NULL,
    [LNO] INT IDENTITY(1,1) NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] VARCHAR(1) NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(234) NULL,
    [SNO] BIGINT NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [BILL_NO] INT NULL,
    [ACCAT] CHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.POSTBILLLEDGER2
-- --------------------------------------------------
CREATE TABLE [dbo].[POSTBILLLEDGER2]
(
    [DRCR] CHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECOPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECOPROCESS]
(
    [INPROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RecPay_Table
-- --------------------------------------------------
CREATE TABLE [dbo].[RecPay_Table]
(
    [SRNO] INT NULL,
    [VVDT] VARCHAR(10) NULL,
    [EEDT] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [VDT] DATETIME NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL DEFAULT 'N',
    [EDT] DATETIME NULL,
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [COSTCODE] SMALLINT NULL,
    [ORGBRANCH] VARCHAR(10) NULL,
    [LNO] SMALLINT NOT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.RecPay_Table_Tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[RecPay_Table_Tmp]
(
    [SRNO] INT NULL,
    [VVDT] VARCHAR(10) NULL,
    [EEDT] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Region
-- --------------------------------------------------
CREATE TABLE [dbo].[Region]
(
    [Regioncode] VARCHAR(20) NULL,
    [Description] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rightsMCDXCDS
-- --------------------------------------------------
CREATE TABLE [dbo].[rightsMCDXCDS]
(
    [FLDUSERNAME] VARCHAR(25) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldstname] VARCHAR(50) NULL,
    [PWD_EXPIRY_DATE] DATETIME NULL,
    [EMAIL] VARCHAR(100) NULL,
    [EMP_NAME] VARCHAR(150) NULL,
    [SENIOR] VARCHAR(6) NULL,
    [SR_NAME] VARCHAR(150) NULL,
    [senioremail] VARCHAR(100) NULL,
    [fldReportName] VARCHAR(35) NULL,
    [fldreportcode] INT NOT NULL,
    [SEGMENT] VARCHAR(7) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rightsMCDXCDS1
-- --------------------------------------------------
CREATE TABLE [dbo].[rightsMCDXCDS1]
(
    [FLDUSERNAME] VARCHAR(25) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldstname] VARCHAR(50) NULL,
    [PWD_EXPIRY_DATE] DATETIME NULL,
    [EMAIL] VARCHAR(100) NULL,
    [EMP_NAME] VARCHAR(150) NULL,
    [SENIOR] VARCHAR(6) NULL,
    [SR_NAME] VARCHAR(150) NULL,
    [senioremail] VARCHAR(100) NULL,
    [fldReportName] VARCHAR(35) NULL,
    [fldreportcode] INT NOT NULL,
    [SEGMENT] VARCHAR(7) NOT NULL,
    [fldcategoryname] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rightsMCDXCDS2
-- --------------------------------------------------
CREATE TABLE [dbo].[rightsMCDXCDS2]
(
    [FLDUSERNAME] VARCHAR(25) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldstname] VARCHAR(50) NULL,
    [PWD_EXPIRY_DATE] DATETIME NULL,
    [EMAIL] VARCHAR(100) NULL,
    [EMP_NAME] VARCHAR(150) NULL,
    [SENIOR] VARCHAR(6) NULL,
    [SR_NAME] VARCHAR(150) NULL,
    [senioremail] VARCHAR(100) NULL,
    [fldReportName] VARCHAR(35) NULL,
    [fldreportcode] INT NOT NULL,
    [SEGMENT] VARCHAR(7) NOT NULL,
    [fldcategoryname] VARCHAR(50) NOT NULL,
    [fldgrpname] VARCHAR(35) NULL,
    [fldmenuname] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rms_expense_head
-- --------------------------------------------------
CREATE TABLE [dbo].[Rms_expense_head]
(
    [Exp_code] VARCHAR(8) NOT NULL,
    [Exp_main_head] VARCHAR(100) NOT NULL,
    [Exp_clt_code] VARCHAR(10) NOT NULL,
    [Exp_ac_category_name] VARCHAR(100) NULL,
    [Exp_ac_type] CHAR(10) NOT NULL,
    [Exp_ac_ctgry] CHAR(10) NOT NULL,
    [Exp_branch_code] VARCHAR(10) NOT NULL,
    [Stat] VARCHAR(1) NOT NULL,
    [Entry_id] VARCHAR(20) NOT NULL,
    [Entry_dt] DATETIME NOT NULL,
    [Effective_datefrom] DATETIME NOT NULL,
    [Effective_dateto] DATETIME NOT NULL,
    [Modify_id] VARCHAR(20) NULL,
    [Modify_dt] DATETIME NULL,
    [Delete_id] VARCHAR(20) NULL,
    [Delete_dt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Selection_Levels_PartyLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[Selection_Levels_PartyLedger]
(
    [Level_No] SMALLINT NULL,
    [Level_Name] VARCHAR(20) NULL,
    [Enable_Flg] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SELECTION_QUERIES_TABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[SELECTION_QUERIES_TABLE]
(
    [SRNO] SMALLINT NOT NULL,
    [STATUSID] VARCHAR(15) NOT NULL,
    [SELECTON] VARCHAR(15) NOT NULL,
    [SELECTIONQUERY] VARCHAR(500) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SettPayout
-- --------------------------------------------------
CREATE TABLE [dbo].[SettPayout]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [BranchCode] VARCHAR(10) NULL,
    [CltCode] VARCHAR(10) NULL,
    [BankCode] VARCHAR(10) NULL,
    [BillAmt] MONEY NULL,
    [LedgerBalNSE] MONEY NULL,
    [LedgerBalBSE] MONEY NULL,
    [LedgerBalFNO] MONEY NULL,
    [DueAmt] MONEY NULL,
    [RequestedAmt] MONEY NULL,
    [Amounttobepaid] MONEY NULL,
    [Narration] VARCHAR(234) NULL,
    [SettType] VARCHAR(3) NULL,
    [SettNo] VARCHAR(7) NULL,
    [RequestDt] DATETIME NULL,
    [UserId] VARCHAR(50) NULL,
    [Status] CHAR(1) NULL,
    [SessionId] VARCHAR(50) NULL,
    [Remark] VARCHAR(234) NULL,
    [ApprovedDt] DATETIME NULL,
    [HOPaymode] VARCHAR(25) NULL,
    [Vno] VARCHAR(12) NULL,
    [ChequeNo] VARCHAR(15) NULL,
    [edt] DATETIME NULL,
    [vdt] DATETIME NULL,
    [GenFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SQLTableIndex
-- --------------------------------------------------
CREATE TABLE [dbo].[SQLTableIndex]
(
    [TableName] VARCHAR(50) NULL,
    [IndexName] VARCHAR(50) NULL,
    [IndexColumn] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SQLTableReIndex_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[SQLTableReIndex_Log]
(
    [TableName] VARCHAR(50) NULL,
    [IndexName] VARCHAR(50) NULL,
    [IndexColumn] VARCHAR(500) NULL,
    [Status] VARCHAR(20) NULL,
    [UserId] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.stalecheque_Vlog
-- --------------------------------------------------
CREATE TABLE [dbo].[stalecheque_Vlog]
(
    [Sno] INT IDENTITY(1,1) NOT NULL,
    [BPVNO] VARCHAR(12) NULL,
    [BPBOOKTYPE] VARCHAR(3) NULL,
    [BPVTYPE] INT NULL,
    [BPVDT] VARCHAR(11) NULL,
    [BRVNO] VARCHAR(12) NULL,
    [BRBOOKTYPE] VARCHAR(3) NULL,
    [BRVTYPE] INT NULL,
    [BrVDT] VARCHAR(11) NULL,
    [CLTCODE] VARCHAR(12) NULL,
    [LAVNO] VARCHAR(12) NULL,
    [LAVTYPE] INT NULL,
    [LAVBOOKTYPE] VARCHAR(3) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [VAMT] MONEY NULL,
    [NARRATION] VARCHAR(250) NULL,
    [DDNO] VARCHAR(20) NULL,
    [DDDT] VARCHAR(11) NULL,
    [BANKCODE] VARCHAR(12) NULL,
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [MICRNO] INT NULL,
    [REMARK] VARCHAR(10) NULL,
    [STATUS] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Subbrokers
-- --------------------------------------------------
CREATE TABLE [dbo].[Subbrokers]
(
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Name] VARCHAR(50) NULL,
    [Address1] VARCHAR(50) NULL,
    [Address2] VARCHAR(50) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Reg_No] CHAR(30) NULL,
    [Registered] BIT NOT NULL,
    [Main_Sub] CHAR(1) NULL,
    [Email] CHAR(50) NULL,
    [Com_Perc] MONEY NULL DEFAULT ((0)),
    [Branch_Code] VARCHAR(10) NULL,
    [Contact_Person] VARCHAR(100) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_GLReport
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_GLReport]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [booktype] CHAR(2) NULL,
    [voudt] VARCHAR(10) NULL,
    [effdt] VARCHAR(10) NULL,
    [shortdesc] CHAR(6) NOT NULL,
    [dramt] MONEY NULL,
    [cramt] MONEY NULL,
    [vno] VARCHAR(12) NULL,
    [narration] VARCHAR(234) NULL,
    [ddno] VARCHAR(15) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [longname] VARCHAR(100) NULL,
    [vdt] DATETIME NULL,
    [vtyp] SMALLINT NOT NULL,
    [accat] CHAR(2) NULL,
    [opbal] MONEY NOT NULL,
    [crosac] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_GLReport_New
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_GLReport_New]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [booktype] CHAR(2) NULL,
    [voudt] VARCHAR(10) NULL,
    [effdt] VARCHAR(10) NULL,
    [shortdesc] CHAR(6) NOT NULL,
    [dramt] MONEY NULL,
    [cramt] MONEY NULL,
    [vno] VARCHAR(12) NULL,
    [narration] VARCHAR(234) NULL,
    [ddno] VARCHAR(15) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [longname] VARCHAR(100) NULL,
    [vdt] DATETIME NULL,
    [vtyp] SMALLINT NOT NULL,
    [accat] CHAR(2) NULL,
    [opbal] MONEY NOT NULL,
    [crosac] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL,
    [MainCode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MASTER_PARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MASTER_PARTYLEDGER]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [StatusId] VARCHAR(25) NULL,
    [ReportName] VARCHAR(200) NULL,
    [SummaryOpt] VARCHAR(1) NULL,
    [CallingSP] VARCHAR(100) NULL,
    [ReturnFields] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MASTER_PARTYLEDGER_ALL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MASTER_PARTYLEDGER_ALL]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [STATUSID] VARCHAR(10) NULL,
    [REPORTNAME] VARCHAR(20) NULL,
    [SUMMARYOPT] VARCHAR(1) NULL,
    [CALLINGSP] VARCHAR(200) NULL,
    [FIRSTPART] VARCHAR(200) NULL,
    [NSEPART] VARCHAR(500) NULL,
    [BSEPART] VARCHAR(500) NULL,
    [NSEFOPART] VARCHAR(500) NULL,
    [NCXPART] VARCHAR(500) NULL,
    [MCXPART] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MASTER_PARTYLEDGER_new
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MASTER_PARTYLEDGER_new]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [StatusId] VARCHAR(25) NULL,
    [ReportName] VARCHAR(200) NULL,
    [SummaryOpt] VARCHAR(1) NULL,
    [CallingSP] VARCHAR(100) NULL,
    [ReturnFields] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_OppBalance
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_OppBalance]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [cltCode] VARCHAR(10) NULL,
    [OppBal] MONEY NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbladmin
-- --------------------------------------------------
CREATE TABLE [dbo].[tbladmin]
(
    [Fldauto_Admin] INT IDENTITY(1,1) NOT NULL,
    [Fldname] VARCHAR(30) NOT NULL,
    [Fldpassword] VARCHAR(30) NOT NULL,
    [Fldcompany] VARCHAR(50) NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Fldstatus] VARCHAR(25) NOT NULL,
    [Flddesc] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbladminconfig
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbladminconfig]
(
    [Fldauto] INT IDENTITY(1,1) NOT NULL,
    [Fldadmin] VARCHAR(50) NOT NULL,
    [Fldflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcategory
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcategory]
(
    [Fldcategorycode] INT IDENTITY(1,1) NOT NULL,
    [Fldcategoryname] VARCHAR(50) NOT NULL,
    [Fldadminauto] INT NULL,
    [Flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tblcatmenu
-- --------------------------------------------------
CREATE TABLE [dbo].[Tblcatmenu]
(
    [Fldauto] INT IDENTITY(1,1) NOT NULL,
    [Fldreportcode] INT NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldcategorycode] VARCHAR(900) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblGlobalParams
-- --------------------------------------------------
CREATE TABLE [dbo].[tblGlobalParams]
(
    [FLDPWDMINLENGTH] SMALLINT NULL,
    [FLDPWDMAXLENGTH] SMALLINT NULL,
    [FLDSPCLCHAR] CHAR(1) NULL,
    [FLDENCRYPTION] CHAR(1) NULL,
    [FLDBLOCKPWD] VARCHAR(255) NULL,
    [FLDDELBLOCK] CHAR(1) NULL,
    [fldlastins] BIGINT NULL,
    [fldlastdel] BIGINT NULL,
    [fldlastupdt] BIGINT NULL,
    [fldupdtdate] DATETIME NULL,
    [fldclientMakerCheker] INT NULL,
    [fldAutoCodeGenerate] INT NULL,
    [fldflag] VARCHAR(3) NULL,
    [fldreportflag] VARCHAR(3) NULL,
    [fldCheckClientProcess] VARCHAR(1) NULL,
    [fldBranchAdd] TINYINT NULL,
    [BranchFlag] CHAR(1) NULL,
    [FldPANValidation] VARCHAR(1) NULL DEFAULT 'Y',
    [FLDPARTYCODEBy] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tblmenuhead
-- --------------------------------------------------
CREATE TABLE [dbo].[Tblmenuhead]
(
    [Fldmenucode] VARCHAR(20) NULL,
    [Fldmenuname] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblPradnyausers
-- --------------------------------------------------
CREATE TABLE [dbo].[tblPradnyausers]
(
    [Fldauto] INT IDENTITY(1,1) NOT NULL,
    [Fldusername] VARCHAR(25) NULL,
    [Fldpassword] VARCHAR(15) NULL,
    [Fldfirstname] VARCHAR(25) NULL,
    [Fldmiddlename] VARCHAR(25) NULL,
    [Fldlastname] VARCHAR(25) NULL,
    [Fldsex] VARCHAR(8) NULL,
    [Fldaddress1] VARCHAR(40) NULL,
    [Fldaddress2] VARCHAR(40) NULL,
    [Fldphone1] VARCHAR(10) NULL,
    [Fldphone2] VARCHAR(10) NULL,
    [Fldcategory] VARCHAR(10) NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Pwd_Expiry_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tblreportgrp
-- --------------------------------------------------
CREATE TABLE [dbo].[Tblreportgrp]
(
    [Fldreportgrp] INT IDENTITY(1,1) NOT NULL,
    [Fldgrpname] VARCHAR(35) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tblreports
-- --------------------------------------------------
CREATE TABLE [dbo].[Tblreports]
(
    [Fldreportcode] INT IDENTITY(1,1) NOT NULL,
    [Fldreportname] VARCHAR(35) NULL,
    [Fldpath] VARCHAR(500) NULL,
    [Fldtarget] VARCHAR(25) NULL,
    [Flddesc] VARCHAR(80) NULL,
    [Fldreportgrp] VARCHAR(10) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Fldstatus] VARCHAR(20) NULL,
    [Fldorder] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblReports_Blocked
-- --------------------------------------------------
CREATE TABLE [dbo].[TblReports_Blocked]
(
    [fldusername] VARCHAR(25) NOT NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [Block_Flag] INT NOT NULL,
    [Fldreportcode] INT NOT NULL,
    [fldpath] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlGlobals
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlGlobals]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDCATEGORYID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster_Jrnl
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster_Jrnl]
(
    [FLDAUTO] BIGINT NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL,
    [FLDUPDTBY] VARCHAR(64) NULL,
    [FLDUPDTDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_AGEING_BULK
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_AGEING_BULK]
(
    [CLTCODE] VARCHAR(10) NULL,
    [SHORT_NAME] VARCHAR(100) NULL,
    [BALANCE] MONEY NULL,
    [AGEDAYS] INT NULL,
    [DRCR] VARCHAR(1) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [SUB_BRNAME] VARCHAR(50) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [BRANCHNAME] VARCHAR(100) NULL,
    [PROCID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TRIALBALANCE_BULK
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TRIALBALANCE_BULK]
(
    [CLTCODE] VARCHAR(10) NULL,
    [DRTOT] MONEY NULL,
    [CRTOT] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [ACNAME] VARCHAR(100) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [ACCAT] INT NULL,
    [PROCID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tempbilldetails
-- --------------------------------------------------
CREATE TABLE [dbo].[Tempbilldetails]
(
    [Exchange] CHAR(10) NULL,
    [Party_code] VARCHAR(25) NULL,
    [Sett_no] VARCHAR(25) NULL,
    [Sett_type] CHAR(10) NULL,
    [Drcr] CHAR(1) NULL,
    [Billamount] MONEY NULL,
    [Balamt] MONEY NULL,
    [Payamount] MONEY NULL,
    [Sessionid] VARCHAR(50) NULL,
    [Rowid] DECIMAL(4, 0) NULL,
    [Billlno] DECIMAL(4, 0) NULL,
    [Date] DATETIME NULL,
    [Description] VARCHAR(20) NULL,
    [Billbooktype] CHAR(2) NULL,
    [Billvtype] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Vtype] VARCHAR(50) NULL,
    [Billvno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Templedger2
-- --------------------------------------------------
CREATE TABLE [dbo].[Templedger2]
(
    [Category] VARCHAR(20) NULL,
    [Branch] VARCHAR(25) NULL,
    [Paidamt] MONEY NULL,
    [Vtype] VARCHAR(2) NULL,
    [Vno] VARCHAR(25) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Costcode] INT NULL,
    [Booktype] CHAR(2) NULL,
    [Sessionid] VARCHAR(15) NULL,
    [Party_code] VARCHAR(25) NULL,
    [Costflag] CHAR(1) NULL,
    [Rowid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temppartybalances1
-- --------------------------------------------------
CREATE TABLE [dbo].[Temppartybalances1]
(
    [Cltcode] VARCHAR(10) NULL,
    [Balancedate] DATETIME NULL,
    [Balance] MONEY NULL,
    [Sessionid] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temppartybalances2
-- --------------------------------------------------
CREATE TABLE [dbo].[temppartybalances2]
(
    [Cltcode] VARCHAR(10) NULL,
    [Balancedate] DATETIME NULL,
    [Balance] MONEY NULL,
    [Exchange] VARCHAR(10) NULL,
    [Segment] VARCHAR(15) NULL,
    [Intrest] MONEY NULL,
    [Credit] MONEY NULL,
    [Accountserver] VARCHAR(25) NULL,
    [Accountdb] VARCHAR(25) NULL,
    [Company] VARCHAR(50) NULL,
    [Short_name] VARCHAR(50) NULL,
    [Shareserver] VARCHAR(15) NULL,
    [Sharedb] VARCHAR(15) NULL,
    [Margin_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test
-- --------------------------------------------------
CREATE TABLE [dbo].[test]
(
    [Costname] CHAR(35) NOT NULL,
    [Costcode] SMALLINT NOT NULL,
    [Catcode] SMALLINT NOT NULL,
    [Grpcode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.THIRDPARTY_COLLECTION
-- --------------------------------------------------
CREATE TABLE [dbo].[THIRDPARTY_COLLECTION]
(
    [TPR_SNO] INT IDENTITY(1,1) NOT NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] VARCHAR(3) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [AMOUNT] MONEY NULL,
    [VDT] DATETIME NULL,
    [DDNO] VARCHAR(20) NULL,
    [ACCOUNT_NO] VARCHAR(25) NULL,
    [TPR_FLAG] CHAR(1) NULL,
    [UPD_FLAG] CHAR(1) NULL DEFAULT 'N',
    [ENTERED_BY] VARCHAR(25) NULL,
    [ENTERED_DATE] DATETIME NULL,
    [MODIFY_BY] VARCHAR(25) NULL,
    [MODIFY_DATE] DATETIME NULL,
    [VNO_JV] VARCHAR(12) NULL,
    [VNO_RJV] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERRIGHTS
-- --------------------------------------------------
CREATE TABLE [dbo].[USERRIGHTS]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL,
    [NoDaysD] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Userwritestable
-- --------------------------------------------------
CREATE TABLE [dbo].[Userwritestable]
(
    [Usercategory] VARCHAR(50) NULL,
    [Userstatusid] VARCHAR(25) NULL,
    [Vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [Nodays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_ACCOUNTBALANCES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_ACCOUNTBALANCES]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [SEGMENTCODE] INT NOT NULL,
    [LEDTYPE] SMALLINT NOT NULL,
    [VDT] INT NOT NULL,
    [EDT] INT NOT NULL,
    [BALDR] MONEY NOT NULL,
    [BALCR] MONEY NOT NULL,
    [OPBALDR] MONEY NOT NULL,
    [OPBALCR] MONEY NOT NULL,
    [BILLSDR] MONEY NOT NULL,
    [BILLSCR] MONEY NOT NULL,
    [INSBILLSDR] MONEY NOT NULL,
    [INSBILLSCR] MONEY NOT NULL,
    [PAYBANK] MONEY NOT NULL,
    [RECBANK] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_AGEINGBUCKETS
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_AGEINGBUCKETS]
(
    [BUCKET_1] INT NOT NULL,
    [BUCKET_2] INT NOT NULL,
    [BUCKET_3] INT NOT NULL,
    [BUCKET_4] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_AGEINGBUCKETS_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_AGEINGBUCKETS_TMP]
(
    [BUCKET_1] INT NOT NULL,
    [BUCKET_2] INT NOT NULL,
    [BUCKET_3] INT NOT NULL,
    [BUCKET_4] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_AGEINGDATA
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_AGEINGDATA]
(
    [BALDATE] INT NOT NULL,
    [BALDATETYPE] INT NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [SEGMENTCODE] INT NOT NULL,
    [BALANCE] MONEY NOT NULL,
    [BUCKET_1] MONEY NOT NULL,
    [BUCKET_2] MONEY NOT NULL,
    [BUCKET_3] MONEY NOT NULL,
    [BUCKET_4] MONEY NOT NULL,
    [UPDATEBY] VARCHAR(20) NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_AGEINGDATA_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_AGEINGDATA_TMP]
(
    [BALDATETYPE] INT NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [SEGMENTCODE] INT NOT NULL,
    [BALANCE] MONEY NOT NULL,
    [BUCKET_1] MONEY NOT NULL,
    [BUCKET_2] MONEY NOT NULL,
    [BUCKET_3] MONEY NOT NULL,
    [BUCKET_4] MONEY NOT NULL,
    [UPDATEBY] VARCHAR(20) NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_AGEINGFINAL
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_AGEINGFINAL]
(
    [BALDATE] INT NOT NULL,
    [BALDATETYPE] INT NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [SEGMENTCODE] INT NOT NULL,
    [BALANCE] MONEY NOT NULL,
    [BUCKET_1] MONEY NOT NULL,
    [BUCKET_2] MONEY NOT NULL,
    [BUCKET_3] MONEY NOT NULL,
    [BUCKET_4] MONEY NOT NULL,
    [BUCKET_5] MONEY NOT NULL,
    [UPDATEBY] VARCHAR(20) NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLIENTPROFILES_FA
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLIENTPROFILES_FA]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [CREDIT_INT] MONEY NOT NULL,
    [DEBIT_INT] MONEY NOT NULL,
    [FROMDATE] SMALLDATETIME NOT NULL,
    [TODATE] SMALLDATETIME NOT NULL,
    [SPAN_MARGIN] INT NOT NULL,
    [EXPOSURE_MARGIN] INT NOT NULL,
    [CREATEDATE] DATETIME NOT NULL,
    [CREATEBY] VARCHAR(20) NOT NULL,
    [UPDATEDATE] DATETIME NULL,
    [UPDATEBY] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_FOLEDBAL
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_FOLEDBAL]
(
    [CLTCODE] VARCHAR(10) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [TOTALBAL] MONEY NULL,
    [LEDBAL] MONEY NULL,
    [CASH] MONEY NULL,
    [NONCASH] MONEY NULL,
    [COLLATERAL] MONEY NULL,
    [IMR] MONEY NULL,
    [EMR] MONEY NULL,
    [MARGIN] MONEY NULL,
    [MARGINDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_FOUT_LEDGERBALANCES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_FOUT_LEDGERBALANCES]
(
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Family_Code] VARCHAR(10) NULL,
    [Family_Name] VARCHAR(10) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Branch_Name] VARCHAR(40) NULL,
    [Trader] VARCHAR(20) NULL,
    [Trader_Name] VARCHAR(50) NULL,
    [SubBroker_Code] VARCHAR(10) NULL,
    [SubBroker_Name] VARCHAR(50) NULL,
    [Area_Code] VARCHAR(20) NULL,
    [Area_Name] VARCHAR(100) NULL,
    [Region_Code] VARCHAR(50) NULL,
    [Region_Name] VARCHAR(50) NULL,
    [Res_Phone] VARCHAR(15) NULL,
    [NSEBALANCE] MONEY NULL,
    [BSEBALANCE] MONEY NULL,
    [NSEFOBALANCE] MONEY NULL,
    [NSEESTIMATED1] MONEY NULL,
    [NSEESTIMATED2] MONEY NULL,
    [BSEESTIMATED1] MONEY NULL,
    [BSEESTIMATED2] MONEY NULL,
    [FAActual] MONEY NULL,
    [NonCash] MONEY NULL,
    [Cash] MONEY NULL,
    [IMMargin] MONEY NULL,
    [VarMargin] MONEY NULL,
    [RepDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_foutLedgerBalances
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_foutLedgerBalances]
(
    [FamilyCode] VARCHAR(50) NULL,
    [CLTCODE] VARCHAR(50) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [NSEBALANCE] MONEY NULL,
    [BSEBALANCE] MONEY NULL,
    [NSEFOBALANCE] MONEY NULL,
    [NSEESTIMATED1] MONEY NULL,
    [NSEESTIMATED2] MONEY NULL,
    [BSEESTIMATED1] MONEY NULL,
    [BSEESTIMATED2] MONEY NULL,
    [FAActual] MONEY NULL,
    [NonCash] MONEY NULL,
    [Cash] MONEY NULL,
    [IMMargin] MONEY NULL,
    [VarMargin] MONEY NULL,
    [sessionid] VARCHAR(25) NULL,
    [BSEFOBALANCE] MONEY NULL,
    [ReportDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_grandsub
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_grandsub]
(
    [sno] INT NOT NULL,
    [F_Value] NVARCHAR(5) NOT NULL,
    [F_Name] NVARCHAR(25) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_inputdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_inputdetails]
(
    [sno] INT NOT NULL,
    [Ctrltype] NVARCHAR(10) NOT NULL,
    [Def] NVARCHAR(250) NOT NULL,
    [Maxlength] INT NULL,
    [ReadOnly] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_INTEREST
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_INTEREST]
(
    [CLTCODE] VARCHAR(10) NULL,
    [SEGMENTCODE] INT NULL,
    [LEDTYPE] INT NULL,
    [VDTBAL] MONEY NULL,
    [VDTINTEREST] MONEY NULL,
    [EDTBAL] MONEY NULL,
    [EDTINTEREST] MONEY NULL,
    [INTDATE] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_INTEREST_NEW
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_INTEREST_NEW]
(
    [CLTCODE] VARCHAR(10) NULL,
    [SEGMENTCODE] INT NULL,
    [LEDTYPE] INT NULL,
    [VDTBAL] MONEY NULL,
    [VDTINTEREST] MONEY NULL,
    [EDTBAL] MONEY NULL,
    [EDTINTEREST] MONEY NULL,
    [INTDATE] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LastVno
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LastVno]
(
    [FldAuto] BIGINT IDENTITY(1,1) NOT NULL,
    [Vtyp] SMALLINT NULL,
    [Booktype] VARCHAR(2) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Lastvno] VARCHAR(12) NULL,
    [VnoFlag] TINYINT NULL,
    [FinYear] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LEDGERBALANCE
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LEDGERBALANCE]
(
    [PARTYCODE] VARCHAR(10) NULL,
    [PARTYNAME] VARCHAR(100) NULL,
    [CHEQUENAME] VARCHAR(100) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [BTOBPAYMENT] INT NULL,
    [TOTLEDBAL] MONEY NULL,
    [NSELEDBAL] MONEY NULL,
    [BSELEDBAL] MONEY NULL,
    [FNOLEDBAL] MONEY NULL,
    [NETLEDBAL] MONEY NULL,
    [FAMLEDBAL] MONEY NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [NORMALBILLAMT] MONEY NULL,
    [T2TBILLAMT] MONEY NULL,
    [BILLAMT] MONEY NULL,
    [FUTUREPAYOUT] MONEY NULL,
    [SHORTAGE] MONEY NULL,
    [AMOUNTTOBEPAID] MONEY NULL,
    [PAYMODE] VARCHAR(1) NULL,
    [BANKCODE] VARCHAR(10) NULL,
    [GENFLAG] VARCHAR(1) NULL,
    [CLIENTTYPE] VARCHAR(3) NULL,
    [FAMILYCODE] VARCHAR(10) NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LEDGERBALANCE_ALL
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LEDGERBALANCE_ALL]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTYCODE] VARCHAR(10) NULL,
    [PARTYNAME] VARCHAR(100) NULL,
    [CHEQUENAME] VARCHAR(100) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [BTOBPAYMENT] INT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [LEDBAL] MONEY NULL,
    [FAMLEDBAL] MONEY NULL,
    [AMTTOPAY] MONEY NULL,
    [PAYMODE] VARCHAR(1) NULL,
    [BANKCODE] VARCHAR(10) NULL,
    [GENFLAG] VARCHAR(1) NULL,
    [CLIENTTYPE] VARCHAR(3) NULL,
    [FAMILYCODE] VARCHAR(10) NULL,
    [RUNDATE] DATETIME NULL,
    [UNCLEARED_AMT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LEDGERBALANCE_NET
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LEDGERBALANCE_NET]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [NET_LEDBAL] MONEY NULL,
    [FAM_LEDBAL] MONEY NULL,
    [TOT_LEDBAL] MONEY NULL,
    [TOT_AMTTOPAY] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Login_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Login_Log]
(
    [Sno] BIGINT IDENTITY(1,1) NOT NULL,
    [UserId] INT NULL,
    [UserName] VARCHAR(64) NULL,
    [Category] VARCHAR(64) NULL,
    [StatusName] VARCHAR(32) NULL,
    [StatusId] VARCHAR(32) NULL,
    [IPADD] VARCHAR(20) NULL,
    [Action] VARCHAR(6) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LovMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LovMaster]
(
    [SNo] INT NOT NULL,
    [ControlType] NVARCHAR(50) NOT NULL,
    [ConttrolValue] NTEXT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_MULTIACCOUNTS
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_MULTIACCOUNTS]
(
    [SEGMENTCODE] INT NOT NULL,
    [EXCHANGE] VARCHAR(3) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [ACCOUNTDB] VARCHAR(20) NOT NULL,
    [ENABLED] SMALLINT NOT NULL,
    [NOOFDAYS] INT NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Offline_CC_Entries
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Offline_CC_Entries]
(
    [FldAuto] BIGINT IDENTITY(1,1) NOT NULL,
    [VOLE_RefNo] BIGINT NOT NULL,
    [CreditAmt] MONEY NULL,
    [DebitAmt] MONEY NULL,
    [CltCode] VARCHAR(10) NULL,
    [OppCode] VARCHAR(10) NULL,
    [BranchCode] VARCHAR(10) NULL,
    [CatCode] VARCHAR(35) NULL,
    [CostCode] VARCHAR(35) NULL,
    [AddBy] VARCHAR(25) NULL,
    [StatusID] VARCHAR(25) NULL,
    [StatusName] VARCHAR(25) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Offline_Ledger_Entries
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Offline_Ledger_Entries]
(
    [FldAuto] INT IDENTITY(1,1) NOT NULL,
    [VoucherType] SMALLINT NULL,
    [BookType] VARCHAR(2) NULL,
    [SNo] INT NULL,
    [Vdate] DATETIME NULL,
    [EDate] DATETIME NULL,
    [CltCode] VARCHAR(10) NULL,
    [CreditAmt] MONEY NULL,
    [DebitAmt] MONEY NULL,
    [Narration] VARCHAR(255) NULL,
    [OppCode] VARCHAR(10) NULL,
    [MarginCode] VARCHAR(10) NULL,
    [BankName] VARCHAR(35) NULL,
    [BranchName] VARCHAR(20) NULL,
    [BranchCode] VARCHAR(10) NULL,
    [DDNo] VARCHAR(15) NULL,
    [ChequeMode] VARCHAR(1) NULL,
    [ChequeDate] DATETIME NULL,
    [ChequeName] VARCHAR(50) NULL,
    [Clear_Mode] VARCHAR(1) NULL,
    [TPAccountNumber] VARCHAR(16) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [TPFlag] TINYINT NULL,
    [AddDt] DATETIME NULL,
    [AddBy] VARCHAR(25) NULL,
    [StatusID] VARCHAR(25) NULL,
    [StatusName] VARCHAR(25) NULL,
    [RowState] TINYINT NULL,
    [ApprovalFlag] TINYINT NULL,
    [ApprovalDate] DATETIME NULL,
    [ApprovedBy] VARCHAR(25) NULL,
    [VoucherNo] VARCHAR(12) NULL,
    [UploadDt] DATETIME NULL,
    [LedgerVNO] VARCHAR(12) NULL,
    [ClientName] VARCHAR(100) NULL,
    [OppCodeName] VARCHAR(100) NULL,
    [MarginCodeName] VARCHAR(100) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [ProductType] VARCHAR(3) NULL,
    [RevAmt] MONEY NULL,
    [RevCode] VARCHAR(10) NULL,
    [MICR] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OPENING_BALANCE
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OPENING_BALANCE]
(
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(500) NULL DEFAULT 'Opening balance',
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL DEFAULT 'N',
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [COSTCODE] SMALLINT NULL,
    [LNO] INT NOT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_payout_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_payout_temp]
(
    [vdt] DATETIME NULL,
    [edt] DATETIME NULL,
    [acCode] VARCHAR(50) NULL,
    [Acname] VARCHAR(100) NULL,
    [amt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [bnkcode] VARCHAR(10) NULL,
    [bnkname] VARCHAR(50) NULL,
    [ddno] VARCHAR(15) NULL,
    [brcode] VARCHAR(25) NULL,
    [narration] VARCHAR(500) NULL,
    [Paymode] CHAR(3) NULL,
    [srno] INT NULL,
    [branchcode] VARCHAR(25) NULL,
    [micrno] INT NULL,
    [BookType] CHAR(4) NULL,
    [accdtls] CHAR(35) NULL,
    [lno] SMALLINT NOT NULL,
    [costcode] SMALLINT NULL,
    [bankcost] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [updflag] VARCHAR(1) NOT NULL,
    [SessionId] VARCHAR(50) NULL,
    [Ledger2_Upd] CHAR(1) NOT NULL,
    [Remark] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PAYOUTCLIENT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PAYOUTCLIENT]
(
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PLEXCHANGE
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PLEXCHANGE]
(
    [EXCHANGE] VARCHAR(7) NULL,
    [ACCOUNTDATA] VARCHAR(15) NULL,
    [SHARESERVER] VARCHAR(25) NULL,
    [ISEXTERNAL] BIT NULL,
    [ENABLED] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Process_Logs
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Process_Logs]
(
    [FldAuto] BIGINT IDENTITY(1,1) NOT NULL,
    [ReportName] VARCHAR(100) NULL,
    [ReportParam] VARCHAR(4000) NULL,
    [ReportBy] VARCHAR(50) NULL,
    [ReportDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PROCESS_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PROCESS_MASTER]
(
    [Processid] INT IDENTITY(1,1) NOT NULL,
    [ProcessName] VARCHAR(100) NULL,
    [ProcessFlag] VARCHAR(1) NULL,
    [ProcessParams] VARCHAR(200) NULL,
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_QueriesSelection
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_QueriesSelection]
(
    [Qno] DECIMAL(18, 0) NOT NULL,
    [QTitle] NTEXT NOT NULL,
    [Qpage] NVARCHAR(250) NULL,
    [Subtotal] NVARCHAR(10) NULL,
    [Grandtotal] NVARCHAR(10) NULL,
    [SubTotalField] NVARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_QueryParam
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_QueryParam]
(
    [Rid] DECIMAL(10, 0) NOT NULL,
    [DisplayName] NVARCHAR(50) NOT NULL,
    [ParamName] NVARCHAR(50) NOT NULL,
    [ControlName] NVARCHAR(50) NOT NULL,
    [ControlType] NVARCHAR(50) NOT NULL,
    [Maxlength] NVARCHAR(10) NULL,
    [FieldType] NVARCHAR(50) NULL,
    [Readonly] NVARCHAR(10) NULL,
    [ExtraParam] NTEXT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_queryreport
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_queryreport]
(
    [Qno] INT NOT NULL,
    [Query] NTEXT NOT NULL,
    [QueryFilter] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Report_Access_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Report_Access_Log]
(
    [Sno] BIGINT IDENTITY(1,1) NOT NULL,
    [RepPath] VARCHAR(4000) NULL,
    [UserId] INT NULL,
    [UserName] VARCHAR(64) NULL,
    [StatusName] VARCHAR(32) NULL,
    [StatusID] VARCHAR(32) NULL,
    [IPAdd] VARCHAR(20) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_RUNNINGBALANCES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_RUNNINGBALANCES]
(
    [CLTCODE] VARCHAR(10) NULL,
    [SEGMENTCODE] INT NOT NULL,
    [LEDTYPE] SMALLINT NOT NULL,
    [VDTBAL] MONEY NULL,
    [EDTBAL] MONEY NULL,
    [BALDATE] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_RUNNINGBALANCES_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_RUNNINGBALANCES_TMP]
(
    [CLTCODE] VARCHAR(10) NULL,
    [SEGMENTCODE] INT NOT NULL,
    [LEDTYPE] SMALLINT NOT NULL,
    [VDTBAL] MONEY NULL,
    [EDTBAL] MONEY NULL,
    [BALDATE] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_SETTPAYOUT_ALL
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_SETTPAYOUT_ALL]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] CHAR(3) NULL,
    [SEGMENT] VARCHAR(12) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BANKCODE] VARCHAR(10) NULL,
    [LEDBAL] MONEY NULL,
    [REQUESTEDAMT] MONEY NULL,
    [AMOUNTTOBEPAID] MONEY NULL,
    [REQUESTDT] DATETIME NULL,
    [USERID] VARCHAR(50) NULL,
    [STATUS] CHAR(1) NULL,
    [SESSIONID] VARCHAR(50) NULL,
    [REMARK] VARCHAR(234) NULL,
    [APPROVEDDT] DATETIME NULL,
    [HOPAYMODE] VARCHAR(25) NULL,
    [VNO] VARCHAR(12) NULL,
    [CHEQUENO] VARCHAR(15) NULL,
    [EDT] DATETIME NULL,
    [VDT] DATETIME NULL,
    [GENFLAG] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v2_sortby
-- --------------------------------------------------
CREATE TABLE [dbo].[v2_sortby]
(
    [sortval] INT NOT NULL,
    [sortname] NVARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_UPLOADED_FILES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_UPLOADED_FILES]
(
    [U_SNO] INT IDENTITY(1,1) NOT NULL,
    [U_FILENAME] VARCHAR(500) NULL,
    [U_PATHNAME] VARCHAR(500) NULL,
    [U_RECORDS] INT NULL,
    [U_STATUS] VARCHAR(2) NULL,
    [U_DATE] DATETIME NULL,
    [U_UNAME] VARCHAR(25) NULL,
    [U_MODULE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMAIN
-- --------------------------------------------------
CREATE TABLE [dbo].[VMAIN]
(
    [VTYPE] VARCHAR(2) NULL,
    [VPATH] VARCHAR(100) NULL,
    [SINGLEVOUCHER] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Vmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Vmast]
(
    [Vtype] SMALLINT NOT NULL,
    [Vdesc] VARCHAR(35) NOT NULL,
    [Shortdesc] CHAR(6) NULL,
    [Dispflag] CHAR(1) NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vno_dups
-- --------------------------------------------------
CREATE TABLE [dbo].[vno_dups]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NOT NULL,
    [Edt] DATETIME NULL,
    [Lno] DECIMAL(4, 0) NOT NULL,
    [Acname] VARCHAR(100) NOT NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.BANKRECO_TRIG_INS
-- --------------------------------------------------
CREATE TRIGGER [dbo].[BANKRECO_TRIG_INS]
ON [dbo].[Bankreco]
AFTER INSERT
AS
INSERT INTO BANKRECO_TRIG_TABLE SELECT *, GETDATE(), HOST_NAME(), 'I'
FROM INSERTED

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER_BILL_D
-- --------------------------------------------------
CREATE TRIGGER [dbo].[LEDGER_BILL_D] ON [dbo].[Ledger] 
FOR DELETE 
AS
INSERT INTO LEDGER_TRG_BILL
	(	VTYP, 
		VNO, 
		EDT, 
		LNO, 
		ACNAME, 
		DRCR, 
		VAMT, 
		VDT, 
		VNO1, 
		REFNO, 
		BALAMT, 
		NODAYS, 
		CDT, 
		CLTCODE, 
		BOOKTYPE, 
		ENTEREDBY, 
		PDT, 
		CHECKEDBY, 
		ACTNODAYS, 
		NARRATION, 
		COMP_NAME, 
		UPDDATE, 
		DBACTION, 
		APPLICATION
	)
SELECT
	VTYP, 
	VNO, 
	EDT, 
	LNO, 
	ACNAME, 
	DRCR, 
	VAMT, 
	VDT, 
	VNO1, 
	REFNO, 
	BALAMT, 
	NODAYS, 
	CDT, 
	CLTCODE, 
	BOOKTYPE, 
	ENTEREDBY, 
	PDT, 
	CHECKEDBY, 
	ACTNODAYS, 
	NARRATION, 
	COMP_NAME = HOST_NAME(), 
	UPDDATE = GETDATE(), 
	DBACTION = 'DELETED', 
	APPLICATION = APP_NAME()
FROM
	DELETED
WHERE
	VTYP IN (15, 21)

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER_BILL_M
-- --------------------------------------------------
CREATE TRIGGER [dbo].[LEDGER_BILL_M] ON [dbo].[Ledger] 
FOR UPDATE 
AS
INSERT INTO LEDGER_TRG_BILL
	(	VTYP, 
		VNO, 
		EDT, 
		LNO, 
		ACNAME, 
		DRCR, 
		VAMT, 
		VDT, 
		VNO1, 
		REFNO, 
		BALAMT, 
		NODAYS, 
		CDT, 
		CLTCODE, 
		BOOKTYPE, 
		ENTEREDBY, 
		PDT, 
		CHECKEDBY, 
		ACTNODAYS, 
		NARRATION, 
		COMP_NAME, 
		UPDDATE, 
		DBACTION, 
		APPLICATION
	)
SELECT
	VTYP, 
	VNO, 
	EDT, 
	LNO, 
	ACNAME, 
	DRCR, 
	VAMT, 
	VDT, 
	VNO1, 
	REFNO, 
	BALAMT, 
	NODAYS, 
	CDT, 
	CLTCODE, 
	BOOKTYPE, 
	ENTEREDBY, 
	PDT, 
	CHECKEDBY, 
	ACTNODAYS, 
	NARRATION, 
	COMP_NAME = HOST_NAME(), 
	UPDDATE = GETDATE(), 
	DBACTION = 'MODIFIED', 
	APPLICATION = APP_NAME()
FROM
	DELETED
WHERE
	VTYP IN (15, 21)

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER_DEL
-- --------------------------------------------------
CREATE TRIGGER [dbo].[LEDGER_DEL] ON [dbo].[Ledger] 
FOR DELETE 
AS
INSERT INTO LEDGER_TRG 
	(	VTYP, 
		VNO, 
		EDT, 
		LNO, 
		ACNAME, 
		DRCR, 
		VAMT, 
		VDT, 
		VNO1, 
		REFNO, 
		BALAMT, 
		NODAYS, 
		CDT, 
		CLTCODE, 
		BOOKTYPE, 
		ENTEREDBY, 
		PDT, 
		CHECKEDBY, 
		ACTNODAYS, 
		NARRATION, 
		COMP_NAME, 
		UPDDATE, 
		DBACTION, 
		APPLICATION
	)
SELECT
	VTYP, 
	VNO, 
	EDT, 
	LNO, 
	ACNAME, 
	DRCR, 
	VAMT, 
	VDT, 
	VNO1, 
	REFNO, 
	BALAMT, 
	NODAYS, 
	CDT, 
	CLTCODE, 
	BOOKTYPE, 
	ENTEREDBY, 
	PDT, 
	CHECKEDBY, 
	ACTNODAYS, 
	NARRATION, 
	COMP_NAME = HOST_NAME(), 
	UPDDATE = GETDATE(), 
	DBACTION = 'DELETED', 
	APPLICATION = APP_NAME()
FROM
	DELETED
WHERE
	VTYP NOT IN (15, 21)

GO

-- --------------------------------------------------
-- TRIGGER dbo.Ledger_MOD
-- --------------------------------------------------
    
CREATE TRIGGER [dbo].[Ledger_MOD] ON [dbo].[Ledger]     
FOR UPDATE    
AS    
INSERT INTO Ledger_TRIG    
SELECT *, HOST_NAME(), GETDATE(), 'MODIFIED' FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER_UP
-- --------------------------------------------------
CREATE TRIGGER [dbo].[LEDGER_UP] ON [dbo].[Ledger] 
FOR UPDATE
AS
INSERT INTO LEDGER_TRG 
	(	VTYP, 
		VNO, 
		EDT, 
		LNO, 
		ACNAME, 
		DRCR, 
		VAMT, 
		VDT, 
		VNO1, 
		REFNO, 
		BALAMT, 
		NODAYS, 
		CDT, 
		CLTCODE, 
		BOOKTYPE, 
		ENTEREDBY, 
		PDT, 
		CHECKEDBY, 
		ACTNODAYS, 
		NARRATION, 
		COMP_NAME, 
		UPDDATE, 
		DBACTION, 
		APPLICATION
	)
SELECT
	VTYP, 
	VNO, 
	EDT, 
	LNO, 
	ACNAME, 
	DRCR, 
	VAMT, 
	VDT, 
	VNO1, 
	REFNO, 
	BALAMT, 
	NODAYS, 
	CDT, 
	CLTCODE, 
	BOOKTYPE, 
	ENTEREDBY, 
	PDT, 
	CHECKEDBY, 
	ACTNODAYS, 
	NARRATION, 
	COMP_NAME = HOST_NAME(), 
	UPDDATE = GETDATE(), 
	DBACTION = 'MODIFIED', 
	APPLICATION = APP_NAME()
FROM
	DELETED
WHERE
	VTYP NOT IN (15, 21)

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER1_DEL
-- --------------------------------------------------
CREATE TRIGGER [dbo].[LEDGER1_DEL] ON [dbo].[Ledger1] 
FOR DELETE 
AS
INSERT INTO LEDGER1_TRG
	(
		BNKNAME, 
		BRNNAME, 
		DD, 
		DDNO, 
		DDDT, 
		RELDT, 
		RELAMT, 
		REFNO, 
		RECEIPTNO, 
		VTYP, 
		VNO, 
		LNO, 
		DRCR, 
		BOOKTYPE, 
		MICRNO, 
		SLIPNO, 
		SLIPDATE, 
		CHEQUEINNAME, 
		CHQPRINTED, 
		CLEAR_MODE, 
		COMP_NAME, 
		UPDDATE, 
		DBACTION, 
		APPLICATION
	)
SELECT 
	BNKNAME, 
	BRNNAME, 
	DD, 
	DDNO, 
	DDDT, 
	RELDT, 
	RELAMT, 
	REFNO, 
	RECEIPTNO, 
	VTYP, 
	VNO, 
	LNO, 
	DRCR, 
	BOOKTYPE, 
	MICRNO, 
	SLIPNO, 
	SLIPDATE, 
	CHEQUEINNAME, 
	CHQPRINTED, 
	CLEAR_MODE, 
	COMP_NAME = HOST_NAME(), 
	UPDDATE = GETDATE(), 
	DBACTION = 'DELETED', 
	APPLICATION = APP_NAME()
FROM
	DELETED
WHERE
	VTYP NOT IN (15, 21)

GO

-- --------------------------------------------------
-- TRIGGER dbo.Ledger1_MOD
-- --------------------------------------------------

CREATE TRIGGER [dbo].[Ledger1_MOD] ON [dbo].[Ledger1]     
FOR UPDATE     
AS    
INSERT INTO Ledger1_TRIG    
SELECT bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode, HOST_NAME(), GETDATE(), 'MODIFIED' FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER1_UP
-- --------------------------------------------------
CREATE TRIGGER [dbo].[LEDGER1_UP] ON [dbo].[Ledger1] 
FOR UPDATE
AS
INSERT INTO LEDGER1_TRG
	(
		BNKNAME, 
		BRNNAME, 
		DD, 
		DDNO, 
		DDDT, 
		RELDT, 
		RELAMT, 
		REFNO, 
		RECEIPTNO, 
		VTYP, 
		VNO, 
		LNO, 
		DRCR, 
		BOOKTYPE, 
		MICRNO, 
		SLIPNO, 
		SLIPDATE, 
		CHEQUEINNAME, 
		CHQPRINTED, 
		CLEAR_MODE, 
		COMP_NAME, 
		UPDDATE, 
		DBACTION, 
		APPLICATION
	)
SELECT 
	BNKNAME, 
	BRNNAME, 
	DD, 
	DDNO, 
	DDDT, 
	RELDT, 
	RELAMT, 
	REFNO, 
	RECEIPTNO, 
	VTYP, 
	VNO, 
	LNO, 
	DRCR, 
	BOOKTYPE, 
	MICRNO, 
	SLIPNO, 
	SLIPDATE, 
	CHEQUEINNAME, 
	CHQPRINTED, 
	CLEAR_MODE, 
	COMP_NAME = HOST_NAME(), 
	UPDDATE = GETDATE(), 
	DBACTION = 'MODIFIED', 
	APPLICATION = APP_NAME()
FROM
	DELETED
WHERE
	VTYP NOT IN (15, 21)

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_MULTICOMPANY
-- --------------------------------------------------

CREATE VIEW ACC_MULTICOMPANY 

AS

  SELECT BROKERID,
         COMPANYNAME,
         EXCHANGE,
         SEGMENT,
         MEMBERTYPE,
         MEMBERCODE,
         SHAREDB,
         SHARESERVER = DBO.ReplaceServerName(SHARESERVER),
         SHAREIP,
         ACCOUNTDB,
         ACCOUNTSERVER = DBO.ReplaceServerName(ACCOUNTSERVER),
         ACCOUNTIP,
         DEFAULTDB,
         DEFAULTDBSERVER = DBO.ReplaceServerName(DEFAULTDBSERVER),
         DEFAULTDBIP,
         DEFAULTCLIENT,
         PANGIR_NO,
         PRIMARYSERVER = DBO.ReplaceServerName(PRIMARYSERVER),
         FILLER2,
         DBUSERNAME,
         DBPASSWORD 
  FROM   MULTICOMPANY

GO

-- --------------------------------------------------
-- VIEW dbo.Clientsmarginview
-- --------------------------------------------------
Create View [dbo].[Clientsmarginview]
As
Select Mcltcode, 
Amt = Isnull((select Sum(case When Drcr = 'c' Then Amount * -1 Else Amount End)
From Clientsmargin Where Mcltcode = C.Mcltcode), 0)
From Clientsmargin C
Group By Mcltcode

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENTSTATUS
-- --------------------------------------------------
create view CLIENTSTATUS as
	select * from msajag..CLIENTSTATUS

GO

-- --------------------------------------------------
-- VIEW dbo.Ledgerdrcr
-- --------------------------------------------------
Create View [dbo].[Ledgerdrcr]
As
Select Sum(vamt) As Totalamount, Drcr
From Ledger
Group By Drcr

GO

-- --------------------------------------------------
-- VIEW dbo.rpt_chequelist
-- --------------------------------------------------

/****** Object:  View dbo.rpt_chequelist    Script Date: 10/6/2001 11:56:32 AM ******/

CREATE view rpt_chequelist as

select l.acname,l.cltcode,l.drcr,l1.ddno,l.vamt,vdt= left(convert(varchar,l.vdt,109),11),edt=left(convert(varchar,l.edt,109),11),
reldt= Case When  (Reldt = '1900-01-01 00:00:00.000'   or   reldt > GetDate() ) Then 'Unrealized' else left(convert(varchar,RelDt,109),11) end,
l1.bnkname,l1.brnname,
nar = (case when (select narr from ledger3 where vtyp = l.vtyp and vno=l.vno and naratno = l.lno) is not null
            then (select narr from ledger3 where vtyp = l.vtyp and vno=l.vno and naratno = l.lno)
	    else (select narr from ledger3 where vtyp = l.vtyp and vno=l.vno)
            end),l.vno,l.vtyp	
 from ledger l,ledger1 l1 where l.vtyp=l1.vtyp and l.vno=l1.vno and l.lno = l1.lno

GO

-- --------------------------------------------------
-- VIEW dbo.SBU_MASTER
-- --------------------------------------------------
create view SBU_MASTER as
	select * from anand1.msajag.dbo.SBU_MASTER

GO

-- --------------------------------------------------
-- VIEW dbo.V2_CLASS_VW_ENTITYMASTER
-- --------------------------------------------------
CREATE VIEW [DBO].[V2_CLASS_VW_ENTITYMASTER]     
    
AS    
    
  SELECT ENT_CODE = 'BROKER',    
         ENT_NAME = 'BROKER',     
         ENT_TYPE = 'BROKER',     
         ORDER_BY = 1      
  FROM   OWNER  (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = BRANCH_CODE,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'BRANCH' ,     
         ORDER_BY = 2      
  FROM   BRANCH   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = SHORT_NAME,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'TRADER',     
         ORDER_BY = 4        
  FROM   BRANCHES   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = SUB_BROKER,    
         ENT_NAME = [NAME],     
         ENT_TYPE = 'SUBBROKER',     
         ORDER_BY = 3        
  FROM   SUBBROKERS  (NOLOCK)   
  UNION ALL     
  SELECT DISTINCT ENT_CODE = AREACODE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'AREA',     
         ORDER_BY = 7        
  FROM   AREA   (NOLOCK)  
  UNION ALL     
  SELECT DISTINCT ENT_CODE = REGIONCODE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'REGION',     
         ORDER_BY = 8        
  FROM   REGION   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = CL_CODE,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'CLIENT',     
         ORDER_BY = 5        
  FROM   CLIENT1  (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = FAMILY,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'FAMILY',     
         ORDER_BY = 6        
  FROM   CLIENT1  (NOLOCK)  
  WHERE  CL_CODE = FAMILY    
  UNION ALL     
    
  SELECT ENT_CODE = CL_TYPE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'CLTYPE',     
         ORDER_BY = 9        
  FROM   CLIENTTYPE   (NOLOCK)   
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'GROUP',     
         ORDER_BY = 10        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'GROUP'    
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'RELMGR',     
         ORDER_BY = 11        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'RELMGR'    
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'SBU',     
         ORDER_BY = 12        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'SBU'    
  UNION ALL     
  SELECT ENT_CODE = CL_STATUS,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'CLSTATUS',     
         ORDER_BY = 13        
  FROM  CLIENTSTATUS   (NOLOCK)

GO

