-- DDL Export
-- Server: 10.253.33.87
-- Database: Pledge
-- Exported: 2026-02-05T02:38:23.088017

USE Pledge;
GO

-- --------------------------------------------------
-- INDEX dbo.Pledge_clientwiseledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Party_code] ON [dbo].[Pledge_clientwiseledger] ([Party_code], [ProcessDate]) INCLUDE ([BSECM_LEDGER], [NSECM_LEDGER], [NSEFO_LEDGER], [MCD_LEDGER], [NSX_LEDGER], [BSECM_CASH_COLLETERAL], [NSECM_CASH_COLLETERAL], [NSEFO_CASH_COLLETERAL], [MCD_CASH_COLLETERAL], [NSX_CASH_COLLETERAL], [BSECM_NONCASH_COLLETERAL], [NSECM_NONCASH_COLLETERAL], [NSEFO_NONCASH_COLLETERAL], [MCD_NONCASH_COLLETERAL], [NBFC_NONCASH_COLLETERAL], [NCDEX_NONCASH_COLLETERAL], [NSX_NONCASH_COLLETERAL], [BSECM_UNRECOSILED_CREDIT], [NSECM_UNRECOSILED_CREDIT], [NSEFO_UNRECOSILED_CREDIT], [MCD_UNRECOSILED_CREDIT], [NCDEX_UNRECOSILED_CREDIT], [NSX_UNRECOSILED_CREDIT], [BSECM_VARMARGIN], [NSECM_VARMARGIN], [NSEFO_SPAN_ADD_MARGIN], [MCD_SPAN_ADD_MARGIN], [NSX_SPAN_ADD_MARGIN])

GO

-- --------------------------------------------------
-- INDEX dbo.Pledge_clientwiseledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ix_Process_Date] ON [dbo].[Pledge_clientwiseledger] ([ProcessDate])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PARTY_PLEDGE_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_PARTY_CODE] ON [dbo].[TBL_PARTY_PLEDGE_DATA] ([PARTY_CODE], [ISIN], [ACCNO]) INCLUDE ([LEDGER_BAL], [CLIENT_PRIORITY], [SCRIPNAME], [QTY], [PLEDGE_QTY], [HOLD_VALUE], [AVG_CLOSING], [PREVDAY_PLEDEGE_QTY], [RELEASE_QTY], [ProcessDate])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PARTY_PLEDGE_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_party_pledge_data_ProcessDate] ON [dbo].[TBL_PARTY_PLEDGE_DATA] ([ProcessDate], [RMS_DATE]) INCLUDE ([PARTY_CODE], [ISIN], [SCRIP_CD], [ACCNO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PARTY_PLEDGE_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_ProcessDate] ON [dbo].[TBL_PARTY_PLEDGE_DATA] ([ProcessDate]) INCLUDE ([PARTY_CODE], [ISIN], [SCRIP_CD], [ACCNO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PARTY_PLEDGE_DATA_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_PARTY_CODE] ON [dbo].[TBL_PARTY_PLEDGE_DATA_LOG] ([PARTY_CODE], [ISIN], [ACCNO]) INCLUDE ([LEDGER_BAL], [CLIENT_PRIORITY], [SCRIPNAME], [QTY], [PLEDGE_QTY], [HOLD_VALUE], [AVG_CLOSING], [PREVDAY_PLEDEGE_QTY], [RELEASE_QTY], [ProcessDate])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PARTY_PLEDGE_DATA_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_party_pledge_data_ProcessDate] ON [dbo].[TBL_PARTY_PLEDGE_DATA_LOG] ([ProcessDate], [RMS_DATE]) INCLUDE ([PARTY_CODE], [ISIN], [SCRIP_CD], [ACCNO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PARTY_PLEDGE_DATA_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_ProcessDate] ON [dbo].[TBL_PARTY_PLEDGE_DATA_LOG] ([ProcessDate]) INCLUDE ([PARTY_CODE], [ISIN], [SCRIP_CD], [ACCNO])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_Party_Pledged_BankWise_Data
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_Processdate] ON [dbo].[Tbl_Party_Pledged_BankWise_Data] ([Processdate]) INCLUDE ([Party_Code], [ISIN], [Scrip_cd], [ScripName], [ACCNO], [Pledge_QTY], [Avg_Closing], [Bank_code], [Pledge_Value], [OD_Utilization])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_DR_getpledgereport
-- --------------------------------------------------
--DBA_DR_getpledgereport 'apr 10 2014'
CREATE proc DBA_DR_getpledgereport
@FrmDt As Datetime
as
Begin
	--Created for automating the pledge data request by DBA team on 11th April 2014
	set nocount on
	Set @FrmDt=Convert(Varchar, @frmdt, 106)    
	Declare @ToDt datetime =Convert(Varchar, @FrmDt, 106) + ' 23:59:59'   

	SELECT CONVERT(date,PROCESSDATE) as Date,MAX(PROCESSDATE) as EntryDate        
	  INTO #RPT_DATES        
	   FROM TBL_PARTY_PLEDGE_DATA_LOG with(nolock)        
	   WHERE PROCESSDATE>=@FRMDT AND PROCESSDATE<=@TODT        
	   group by CONVERT(date,PROCESSDATE)        
   
   
   
	--INSERT INTO TBL_PLEDGE_DATA_BIPIC_TMP  
	Select [Date]=Convert(Varchar, Processdate, 106),Party_code,Min((Ledger_bal))     As [Net debit],Min((Ledger_bal * 2)) As [Adjustable debit],    
		Isin,Scripname,[Accountno]=Accno,[Total holding qty]=Sum(Qty),[Total holding hold value]=Sum(Hold_value),
		[Total pledgeble qty]=Sum(Case Client_priority    
									When 1 Then Qty    
									Else 0    
									End),    
		[Total pledgeble hold value]=Sum(Case Client_priority    
												   When 1 Then Hold_value    
												   Else 0    
												  End),    
		[Closing price]=Avg_closing,[Prevday pledege qty]=Sum(Prevday_pledege_qty),[Release qty]=Sum(Release_qty),[Actual pledge]=Sum(Pledge_qty) 
		into #TBL_PLEDGE_DATA_BIPIC_TMP   
		From   Tbl_party_pledge_data_log A (NOLOCK)
			INNER JOIN #RPT_DATES B        
			ON A.Processdate = B.EntryDate      
		Where  Processdate >= @FRMDT    
			And Processdate <= @TODT    
			And Accno Like '%'    
			And Isin Like '%'    
			And Party_code Like '%'    
		Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname    
	Union All    
	Select [Date]=Convert(Varchar, Processdate, 106),Party_code,Min((Ledger_bal))     As [Net debit],Min((Ledger_bal * 2)) As [Adjustable debit],    
				 Isin,Scripname,[Accountno]=Accno,[Total holding qty]=Sum(Qty),[Total holding hold value]=Sum(Hold_value),    
				 [Total pledgeble qty]=Sum(Case Client_priority    
											When 1 Then Qty    
											Else 0    
										   End),    
				 [Total pledgeble hold value]=Sum(Case Client_priority    
												   When 1 Then Hold_value    
												   Else 0    
												  End),    
				 [Closing price]=Avg_closing,[Prevday pledege qty]=Sum(Prevday_pledege_qty),[Release qty]=Sum(Release_qty),[Actual pledge]=Sum(Pledge_qty) 
		From   Tbl_party_pledge_data (NOLOCK)    
		Where  Processdate >= @FRMDT    
			And Processdate <= @TODT    
			And Accno Like '%'    
			And Isin Like '%'    
			And Party_code Like '%'    
		Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname    
		Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,[Total pledgeble qty] Desc,Isin    

   
	select party_code, [Net debit] ,abs([Adjustable debit]) DEBIT, sum([Total pledgeble qty] * [Closing price])PledgeableVal,
		sum([actual pledge]*[closing price])ActualVal into #temp1 from #TBL_PLEDGE_DATA_BIPIC_TMP
		where date = @FrmDt
		group by party_code,  [Net debit],[Adjustable debit]
 
	select 
		sum(DEBIT) debit ,
		sum(PledgeableVal) pledgeableval,
		sum(ActualVal) actualval,
		(
			select sum(case when ActualVal <= PledgeableVal then (ActualVal)
			else (PledgeableVal)end)  from #temp1 where [Net debit] < 0
		)proportionate,
		sum(case when [Net debit] <=0 then (case when ActualVal > PledgeableVal then (ActualVal -PledgeableVal )
			else (0) end)else (ActualVal) end) excess 
		into #temp2
		from #temp1

	select cast(party_code as varchar(20)) as party_code, cast([net debit] as varchar(100)) as [Net debit] , 
		cast(DEBIT as varchar(100)) as debit,cast(PledgeableVal as varchar(100)) as pledgeableval,cast(ActualVal as varchar(100))ActualVal 
		from #temp1
	union all
	select 'DebitBal','Pledgeable','ActualPledge','Proportionate','Excess'
	union all
	select cast(debit as varchar(100)),cast(pledgeableval as varchar(100)),
		cast(actualval as varchar(100)),cast(proportionate as varchar(100)),
		cast(excess as varchar(100))
		from #temp2
	
 
	 drop table #TBL_PLEDGE_DATA_BIPIC_TMP
	 drop table #temp1
	 drop table #RPT_DATES
	 drop table #temp2
 ENd

GO

-- --------------------------------------------------
-- PROCEDURE dbo.JOB_Pldge_Borrowing
-- --------------------------------------------------
/* SP DESIGN BY ROHIT PATIL FOR PELDGE BORROWING LOGIC ON 13 JAN 2017 */
 CREATE PROC [dbo].[JOB_Pldge_Borrowing]
 AS
 BEGIN
	
	/*SP WILL CREATE BANK DETAILS WITH LATEST DETAILS*/
	 EXEC TOTALPLEDGE_BORROWING
 
	 SELECT CLTCODE,BAL = SUM(CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END )
	 INTO #BANK 
	 FROM AngelBSECM.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK)
	 WHERE VDT BETWEEN (select convert(varchar(15), sdtcur,106) from [196.1.115.132].risk.dbo.parameter with(nolock) where curyear=1) AND   CONVERT(VARCHAR(15),GETDATE()-1,106) + ' 23:59'  
	 AND CLTCODE IN (SELECT CLTCODE FROM TBL_BANKMASTER_CLTCODE )
	 GROUP BY CLTCODE 
	 ORDER BY CLTCODE 
	  
	 SELECT B.BANKCODE,A.BAL 
	 INTO #BANK2 
	 FROM  
	 #BANK A 
	 INNER JOIN
	 TBL_BANKMASTER_CLTCODE B ON A.CLTCODE=B.CLTCODE
	 
	 SELECT BANKCODE,SUM(BAL )AS BAL 
	 INTO #BANK_FINAL 
	 FROM #BANK2
	 GROUP BY  BANKCODE
 
  
	 UPDATE A
	 SET A.AMOUNT = B.BAL,
		A.PERCENTAGE =((B.BAL/ A.TOTAL_PLEDGE)*100),
		A.ENTERED_ON =GETDATE() 
	 FROM 
	 TBL_PLEDGEUNPLEDGEBORROWING  AS A  
	   INNER JOIN #BANK_FINAL AS B 
		   ON A.BANK_CODE = B.BANKCODE 
	WHERE B.BAL > 0	
	
	DROP TABLE #BANK
    DROP TABLE #BANK2
    DROP TABLE #BANK_FINAL
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Las_generate_pledgefile
-- --------------------------------------------------
CREATE Procedure [dbo].[Las_generate_pledgefile]    
(    
 @SERVERIP Varchar(15)    
)    
As    
   Set NOCOUNT On    
    
Begin    
   --DECLARE @SERVERIP VARCHAR(15)                
    
   --Set @SERVERIP='172.29.19.10'
   --exec [Las_generate_pledgefile] '172.29.19.10'             
    
   Print 'GENERATING PLEDGE FILES.............'    
    
   Select *,    
          Row_number() Over(Order By A.Bank_code, A.Pledgor_bo_id) As Rownum    
   Into   #LIST_TO_GENERATE_DATA    
   From   (Select A.Bank_code,    
                  Bankname,    
                  A.Pledgor_bo_id,    
                  B.Bo_id                    As Pledgee_bo_id,    
                  Isnull(C.Agreement_no, '') As Agreement_no,    
                  Count(*)                   As Record_cnt    
           From   DBO.Las_pledge_request A With(NOLOCK)    
                  Left Outer Join general.dbo.Tbl_las_bank_master B With(NOLOCK)    
                   On A.Bank_code = B.Bank_code    
                  Left Outer Join general.dbo.Tbl_las_bank_agreement_master C With(NOLOCK)    
                   On B.Bank_code = C.Bank_code    
                      And A.Pledgor_bo_id = C.Accno    
           Where  Convert(Varchar(11), Update_datetime) = Convert(Varchar(11), Getdate())    
                  And Approved = 2    
                  And A.Request_type = 'DEBITORS'    
           Group  By A.Bank_code,Bankname,A.Pledgor_bo_id,B.Bo_id,C.Agreement_no) A    
   Order  By A.Bank_code    
    
   Select A.Bank_code,    
          A.Pledgor_bo_id,    
          B.Bo_id                    As Pledgee_bo_id,    
          Isnull(C.Agreement_no, '') As Agreement_no,    
          B.Bankname,    
          A.Isin,    
          Sum(A.Qty)                 As Qty,    
          Sum(A.Value)               As Value,    
          D.Scripname,
          D.bsecode		as    ScripCode
   Into   #PLEDGE_REQUEST_DATA    
   From   DBO.Las_pledge_request A With(NOLOCK)    
          Left Outer Join general.dbo.Tbl_las_bank_master B With(NOLOCK)    
           On A.Bank_code = B.Bank_code    
          Left Outer Join general.dbo.Tbl_las_bank_agreement_master C With(NOLOCK)    
           On B.Bank_code = C.Bank_code    
              And A.Pledgor_bo_id = C.Accno    
          Left Outer Join general.dbo.Scrip_master D With(NOLOCK)    
           On A.Isin = D.Isin    
   Where  Convert(Varchar(11), Update_datetime) Like Convert(Varchar(11), Getdate())    
          And Approved = 2    
          And A.Request_type = 'DEBITORS'    
   Group  By A.Bank_code,A.Pledgor_bo_id,B.Bo_id,C.Agreement_no,B.Bankname,A.Isin,D.Scripname,D.bsecode	    
    
   Create Nonclustered Index [IX_PRD_BNKP]    
    On #PLEDGE_REQUEST_DATA ( Bank_code, Pledgor_bo_id, Pledgee_bo_id, Agreement_no )    
    With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
   Insert Into Las_pledge_unpledge_genfilepath_log    
   Select *    
   From   Las_pledge_unpledge_genfilepath    
   Where  [Action] = 'PLEDGE'    
    
   Delete From Las_pledge_unpledge_genfilepath    
   Where  [Action] = 'PLEDGE'    
    
   Declare @FILE_CNT           As Int,    
           @FILE_CTR           As Int,    
           @CTR                As Int,    
           @PLEDGOR_BO_ID      As Varchar(20),    
           @PLEDGEE_BO_ID      As Varchar(20),    
           @AGREEMENT_NO       As Varchar(20),    
           @BANK_CODE          As Int,    
           @BANK_NAME          As Varchar(20),    
           @RECORD_CNT         As Int,    
           @FILE_NAME          As Varchar(50),    
           @PHYSICAL_PATH      As Varchar(200),    
           @VIRTUAL_PATH       As Varchar(200),    
           @DOS_CONVERTOR_PATH As Varchar(1000),    
           @SQL                Varchar(8000)    
    
   Select @FILE_CNT = Count(*)    
   From   #LIST_TO_GENERATE_DATA    
    
   Set @FILE_CTR = 1    
    
   While @FILE_CTR <= @FILE_CNT    
   Begin    
      Select @PLEDGOR_BO_ID = Pledgor_bo_id,    
             @PLEDGEE_BO_ID = Pledgee_bo_id,    
             @AGREEMENT_NO = Agreement_no,    
             @BANK_CODE = Bank_code,    
             @BANK_NAME = Bankname,    
             @RECORD_CNT = Record_cnt    
      From   #LIST_TO_GENERATE_DATA    
      Where  Rownum = @FILE_CTR    
    
      Select @CTR = Counter + 1    
      From   Tbl_las_requirement_output_ctr    
    
      --UPDATE TBL_LAS_REQUIREMENT_OUTPUT_CTR SET COUNTER = @CTR                
      --FILE NAME                
      --SET @FILE_NAME = '07' + Substring(@PLEDGOR_BO_ID, 3, 6) + '.' + DBO.Fillstring(CONVERT(VARCHAR, @CTR), '0', 5, 0)--+'.TXT'                
      If Isnull(@AGREEMENT_NO, '') = ''    
       Set @FILE_NAME =Replace(@BANK_NAME, ' ', '_') + '_' + @PLEDGOR_BO_ID + '.xls'    
      Else    
       Set @FILE_NAME =Replace(@BANK_NAME, ' ', '_') + '_' + @AGREEMENT_NO + '_' + @PLEDGOR_BO_ID + '.xls'    
    
      Set @PHYSICAL_PATH = '\\' + @SERVERIP + '\D$\UPLOAD1\LAS\' + Convert(Varchar(11), Getdate(), 112) + '\PLEDGE\' + Replace(@BANK_NAME, ' ', '_') + '(' + Convert(Varchar, @BANK_CODE) + ')\' + @PLEDGOR_BO_ID    
    
      Set @VIRTUAL_PATH = '/UPLOAD1/LAS/' + Convert(Varchar(11), Getdate(), 112) + '/PLEDGE/' + Replace(@BANK_NAME, ' ', '_') + '(' + Convert(Varchar, @BANK_CODE) + ')\' + @PLEDGOR_BO_ID    
    
      Set @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL ' + '''' + 'MD ' + @PHYSICAL_PATH + ''''    
    
      Exec(@SQL)    
    
      /*                
      PRINT @FILE_NAME                
      PRINT @PHYSICAL_PATH                
      PRINT @VIRTUAL_PATH               
      TBL_LAS_DP_OUTPUT_FILE               
      */    
      Truncate Table Tbl_las_pledge_unpladge_data    
    
      Insert Into Tbl_las_pledge_unpladge_data    
      /*SELECT Substring(@PLEDGOR_BO_ID,3,6)+DBO.Fillstring(CONVERT(VARCHAR,@RECORD_CNT),'0',6,0) AS OUTPUTFILE                
      UNION ALL                
      SELECT                
        'P'+/*PLEDGE TYPE 1 CHARACTERS*/                
        'S'+/*PLEDGE SUB TYPE 1 CHARACTERS*/                
        'F'+/*FREE / LOCKIN FLAG 1 CHARACTERS*/                
        '0000000000000000'+/*LOCKIN ID NUMBER(16)*/                
        '00000000'+/*PLEDGE SEQUENCE NO NUMBER(8)*/                
        DBO.FILLSTRING(ISNULL(A.PLEDGOR_BO_ID,''),'0',16,0)+/*PLEDGOR BO ID 16 CHARACTERS*/                
        DBO.FILLSTRING(ISNULL(A.PLEDGEE_BO_ID,''),'0',16,0)+/*PLEDGEE BO ID 16 CHARACTERS*/                
        ISIN+/*ISIN 16 CHARACTERS*/                
        DBO.FILLSTRING(DBO.FILLSTRING(CONVERT(VARCHAR,QTY),'0',13,0),'0',16,1)+/*PLEDGE QUANTITY NUMBER(16,3)(NO DECIMAL POINT)*/                
        DBO.FILLSTRING(REPLACE(CONVERT(VARCHAR,VALUE),'.',''),'0',15,0)+/*PLEDGE VALUE NUMBER(15,2)(NO DECIMAL POINT)*/                
        REPLACE(CONVERT(VARCHAR,DATEADD(YY,2,GETDATE()),105),'-','') + /*EXPIRYDATE 8 CHARACTERS*/                
        DBO.FILLSTRING('',' ',16,0)+/*PLEDGEE DP INTERNAL REF NO CHAR(16)*/                
        DBO.FILLSTRING('',' ',16,0)+/*PLEDGOR DP INTERNAL REF NO CHAR(16)*/                
        DBO.FILLSTRING(ISNULL(AGREEMENT_NO,''),' ',20,1)+/*AGREEMENT NO CHAR(20)*/                
        DBO.FILLSTRING('0','0',4,1)+/*UNPLEDGE / AUTO UNPLEDGE / CONFISCATE PART COUNTER NUMBER(4)*/                
        DBO.FILLSTRING('0','0',16,1)+/*UNPLEDGE / AUTO UNPLEDGE / CONFISCATE PART QUANTITY NUMBER(16,3)*/                
        DBO.FILLSTRING('',' ',100,1) AS OUTPUTFILE/*PLEDGE REMARKS CHAR(100)*/                
      FROM DBO.#PLEDGE_REQUEST_DATA A WITH(NOLOCK)                
      WHERE PLEDGOR_BO_ID = @PLEDGOR_BO_ID AND BANK_CODE=@BANK_CODE*/    
      --SELECT ',ANGEL BROKING LTD'                
      --UNION ALL                
      --SELECT ',CLIENT ID :  ANGEL BROKING LTD.' + @PLEDGOR_BO_ID                
      --UNION ALL                
      --SELECT ',' + @BANK_NAME + ' : ' + @PLEDGEE_BO_ID                
      --UNION ALL                
      --SELECT ',AGREEMENT NO.:' + @AGREEMENT_NO                
      --UNION ALL                
      --SELECT ',PLEDGE ' + CONVERT(VARCHAR, Getdate(), 104)                
      --UNION ALL                
    --SELECT ''                
      --UNION ALL                
      Select 'SR.NO.',    
             'ISIN',    
             'SCRIP CODE',    
             'SCRIP NAME',    
             'QUANTITY',    
             'PLEDGE ORD NO.',    
             ''    
      Union All    
      Select Convert(Varchar, Row_number()Over(Order By Isin)),    
			 Isin,    
             ScripCode,    
             Scripname,    
             Convert(Varchar, Qty),    
             '',    
             ''    
      From   DBO.#pledge_request_data A With(NOLOCK)    
      Where  Pledgor_bo_id = @PLEDGOR_BO_ID    
             And Bank_code = @BANK_CODE    
             And Pledgee_bo_id = @PLEDGEE_BO_ID    
             And Agreement_no = @AGREEMENT_NO    
    
      Set @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL ' + '''' + 'BCP  " SELECT ROW_NM,ISIN,ScripCode,SCRIPNAME,QTY,PLEDGE_NO FROM [CSOKYC-6].Pledge.DBO.TBL_LAS_PLEDGE_UNPLADGE_DATA  " QUERYOUT ' + @PHYSICAL_PATH + '\' + @FILE_NAME + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'  
 
   
    
      Set @SQL= @SQL + ''''    
    
      --PRINT @SQL                
      Exec(@SQL)    
    
      --Set @DOS_CONVERTOR_PATH = '\\196.1.115.183\D$\UPLOAD1\LAS\'            
    
      --Set @SQL='EXEC MASTER..XP_CMDSHELL ''' + @DOS_CONVERTOR_PATH + 'DOS2UNIX.EXE ' + @PHYSICAL_PATH + '\' + @FILE_NAME + ''''            
    
      --PRINT @SQL                
      --EXEC (@SQL)                
    
      Insert Into Las_pledge_unpledge_genfilepath    
      Values      (@BANK_CODE,    
                   @PHYSICAL_PATH + '\' + @FILE_NAME,    
                   @VIRTUAL_PATH + '/' + @FILE_NAME,    
                   'PLEDGE Request :: (' + @BANK_NAME + ')(' + @PLEDGOR_BO_ID + ')',    
                   'PLEDGE',    
                   Getdate())    
    
      Set @FILE_CTR = @FILE_CTR + 1    
   End    
    
--Print 'GENERATING PLEDGE FILES COMPLETED'            
End    
    
   Set NOCOUNT Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Las_generate_unpledgefile
-- --------------------------------------------------
CREATE Procedure [dbo].[Las_generate_unpledgefile]  
(    
 @SERVERIP Varchar(15)    
)    
As    
   Set NOCOUNT On    
    
Begin    
   --Declare @SERVERIP Varchar(15)    
    
   --Set @SERVERIP='172.29.19.10'    
    
   Print 'GENERATING UNPLEDGE FILES.............'    
    
   /*If Exists(Select *    
   From TEMPDB.DBO.Sysobjects    
   Where Name Like '#LIST_TO_GENERATE_UNPLEDGE%')    
   Begin    
   Drop Table #LIST_TO_GENERATE_UNPLEDGE    
   End    
       
   If Exists(Select *    
   From TEMPDB.DBO.Sysobjects    
   Where Name Like '#UNPLEDGE_REQUEST_DATA%')    
   Begin    
   Drop Table #UNPLEDGE_REQUEST_DATA    
   End*/    
    
   Select *,    
          Row_number() Over(Order By A.Bank_code, A.Pledgor_bo_id) As Rownum    
   Into   #LIST_TO_GENERATE_UNPLEDGE    
   From   (Select Distinct A.Bank_code,    
                           B.Bankname,    
                           A.Pledgor_bo_id,    
                           B.Bo_id As Pledgee_bo_id,    
                           A.Agreement_no,--,REQUEST_TYPE    
                           C.Bank_accno    
           From   DBO.Las_unpledge_request A With(NOLOCK)    
                  Left Outer Join general.dbo.Tbl_las_bank_master B With(NOLOCK)    
                   On A.Bank_code = B.Bank_code    
                  Left Outer Join general.dbo.Tbl_las_bank_agreement_master C With(NOLOCK)    
                   On A.Bank_code = C.Bank_code    
                      And A.Pledgor_bo_id = C.Accno    
           Where  Convert(Varchar(11), A.Update_datetime) Like Convert(Varchar(11), Getdate())    
                  And Request_type = 'CREDITORS') A    
   Order  By A.Bank_code    
    
   Select A.Bank_code,    
          A.Pledgor_bo_id,    
          A.Pledgee_bo_id,    
          A.Agreement_no,    
          B.Bankname,    
          A.Isin,    
          Pledge_no,    
          A.Unpledge_qty As Qty,    
          C.Scripname,    
          C.Bsecode      As Scripcode ,
          A.Unpledge_Value/A.Unpledge_qty As ClsPrice  
   Into   #UNPLEDGE_REQUEST_DATA    
   From   DBO.Las_unpledge_request A With(NOLOCK)    
          Left Outer Join general.dbo.Tbl_las_bank_master B With(NOLOCK)    
           On A.Bank_code = B.Bank_code    
          Left Outer Join general.dbo.Scrip_master C With(NOLOCK)    
           On A.Isin = C.Isin    
   Where  Convert(Varchar(11), a.Update_datetime) Like Convert(Varchar(11), Getdate())    
          And Request_type = 'CREDITORS'    
    
   Create Nonclustered Index [IX_PRD_BNKP]    
    On #UNPLEDGE_REQUEST_DATA ( Bank_code, Pledgor_bo_id, Pledgee_bo_id, Agreement_no )    
    With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
   --Insert Into Las_pledge_unpledge_genfilepath_log    
   --Select *    
   --From   Las_pledge_unpledge_genfilepath    
   --Where  [Action] = 'UNPLEDGE'    
    
   Delete From Las_pledge_unpledge_genfilepath    
   Where  [Action] = 'UNPLEDGE'    
    
   Declare @FILE_CNT           As Int,    
           @FILE_CTR           As Int,    
           @CTR                As Int,    
           @PLEDGOR_BO_ID      As Varchar(20),    
           @PLEDGEE_BO_ID      As Varchar(20),    
           @AGREEMENT_NO       As Varchar(20),    
           @BANK_ACCNO         As Varchar(20),    
           @BANK_CODE          As Int,    
           @BANK_NAME          As Varchar(20),    
           @RECORD_CNT         As Int,    
           @FILE_NAME          As Varchar(200),    
           @PHYSICAL_PATH      As Varchar(200),    
           @VIRTUAL_PATH       As Varchar(200),    
           @DOS_CONVERTOR_PATH As Varchar(1000),    
           @SQL                Varchar(8000)    
    
   Select @FILE_CNT = Count(*)    
   From   #LIST_TO_GENERATE_UNPLEDGE    
    
   Set @FILE_CTR = 1    
    
   While @FILE_CTR <= @FILE_CNT    
   Begin    
      Select @PLEDGOR_BO_ID = Pledgor_bo_id,    
             @PLEDGEE_BO_ID = Pledgee_bo_id,    
             @AGREEMENT_NO = Agreement_no,    
             @BANK_CODE = Bank_code,    
             @BANK_NAME = Bankname,    
             @BANK_ACCNO = Bank_accno    
      From   #LIST_TO_GENERATE_UNPLEDGE    
      Where  Rownum = @FILE_CTR    
    
      --SELECT @CTR = COUNTER + 1 FROM TBL_LAS_REQUIREMENT_OUTPUT_CTR    
      --UPDATE TBL_LAS_REQUIREMENT_OUTPUT_CTR SET COUNTER = @CTR    
    --FILE NAME    
      --SET @FILE_NAME = @BANK_NAME+'('+@PLEDGOR_BO_ID+')'+'('+@AGREEMENT_NO+')'+'.CSV'    
      Set @FILE_NAME = @AGREEMENT_NO + '.XLS'    
    
      Set @PHYSICAL_PATH = '\\' + @SERVERIP + '\D$\UPLOAD1\LAS\' + Convert(Varchar(11), Getdate(), 112) + '\UNPLEDGE\' + Replace(@BANK_NAME, ' ', '_') + '(' + Convert(Varchar, @BANK_CODE) + ')\' + @PLEDGOR_BO_ID    
    
      Set @VIRTUAL_PATH = '/UPLOAD1/LAS/' + Convert(Varchar(11), Getdate(), 112) + '/UNPLEDGE/' + Replace(@BANK_NAME, ' ', '_') + '(' + Convert(Varchar, @BANK_CODE) + ')\' + @PLEDGOR_BO_ID    
    
      Set @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL ' + '''' + 'MD ' + @PHYSICAL_PATH + ''''    
    
      Exec(@SQL)    
    
      /*    
      PRINT @FILE_NAME    
      PRINT @PHYSICAL_PATH    
      PRINT @VIRTUAL_PATH    
      */    
      Truncate Table Tbl_las_pledge_unpladge_data    
    
      If @BANK_CODE = 2--HDFC    
      Begin    
         Insert Into Tbl_las_pledge_unpladge_data    
         Select 'FAS No.',    
                '',    
                '''' + Convert(Varchar, @AGREEMENT_NO),    
                '',    
                '',    
                'Pledgor DP ID',    
                '''' + Convert(Varchar, @PLEDGEE_BO_ID)    
         Union All    
         Select 'Account Number',    
                '',    
                '''' + Convert(Varchar, @BANK_ACCNO),    
                '',    
                '',    
                'Pledgor DP Name',    
                'ANGEL BROKING LTD.'    
         Union All    
         Select 'Account Name',    
                '',    
                'ANGEL BROKING LTD',    
                '',    
                '',    
                'Pledgor Client ID',    
                '''' + Convert(Varchar, @PLEDGOR_BO_ID)    
         Union All    
         Select 'TRF Serial No.',    
                '',    
                '',    
                '',    
                '',    
                'Pledgor Client Name',    
                'ANGEL BROKING LTD.'    
         Union All    
         Select 'Request for Withdrawal of Securities',    
                '',    
                '',    
                '',    
                '',    
                'DATE',    
                Convert(Varchar, Getdate(), 104)    
         Union All    
         Select '',    
                '',    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select 'SR.NO.',    
                'ISIN',    
                'ISIN Description',    
                '',    
                'QUANTITY',    
                'PLEDGE ORD NO.',    
                'Remarks (Not to be filled by Customer)'    
         Union All    
         Select Convert(Varchar, Row_number()Over(Order By Pledge_no)),    
                Isin,    
                Scripname,    
                '',    
                Convert(Varchar, Qty),    
                Pledge_no,    
                ''    
         From   DBO.#unpledge_request_data A With(NOLOCK)    
         Where  Pledgor_bo_id = @PLEDGOR_BO_ID    
                And Bank_code = @BANK_CODE    
                And Pledgee_bo_id = @PLEDGEE_BO_ID    
                And Agreement_no = @AGREEMENT_NO    
    
         Set @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL ' + '''' + 'BCP " SELECT ROW_NM,ISIN,SCRIPCODE,QTY,PLEDGE_NO,REMARK FROM [CSOKYC-6].Pledge.DBO.TBL_LAS_PLEDGE_UNPLADGE_DATA " QUERYOUT ' + @PHYSICAL_PATH + '\' + @FILE_NAME + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'    
    
         Set @SQL= @SQL + ''''    
      End    
      Else If @BANK_CODE = 5--BOI    
      Begin    
         Insert Into Tbl_las_pledge_unpladge_data    
         Select 'Pledgor Detail',    
                '',    
                '',    
                '',    
                '',    
				'Pledge Details',    
                ''    
         Union All    
         Select 'Client Name',    
                'ANGEL BROKING LTD',    
                '',    
                '',    
                'Client Name',    
                Convert(Varchar, @BANK_NAME),    
                ''    
         Union All    
         Select 'Client ID',    
                '''' + Convert(Varchar, @PLEDGOR_BO_ID),    
                '',    
                '',    
				'Client ID',    
                '''' + Convert(Varchar, @PLEDGEE_BO_ID),    
                ''    
         Union All    
         Select 'Agreement No',    
                '''' + Convert(Varchar, @AGREEMENT_NO),    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select 'Closure Date',    
                '',    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select '',    
                '',    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select 'DATE ' + Convert(Varchar, Getdate(), 104),    
                '',    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select '',    
                '',    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select 'UNPLEDGE',    
                '',    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select '',    
                '',    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select 'SR.NO.',    
                'ISIN NO',    
                'SCRIP CODE',    
                'SCRIP NAME',    
                'QUANTITY',    
                'PLEDGE ORD NO.',    
                'Valuation'    
         Union All    
         Select Convert(Varchar, Row_number()Over(Order By Pledge_no)),    
                Isin,    
                Scripcode,    
                Scripname,    
                Convert(Varchar, Qty),    
                Pledge_no,    
                Convert(Varchar,ClsPrice)    
         From   DBO.#unpledge_request_data A With(NOLOCK)    
         Where  Pledgor_bo_id = @PLEDGOR_BO_ID    
                And Bank_code = @BANK_CODE    
                And Pledgee_bo_id = @PLEDGEE_BO_ID    
                And Agreement_no = @AGREEMENT_NO    
    
         Set @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL ' + '''' + 'BCP " SELECT ROW_NM,ISIN,SCRIPCODE,SCRIPNAME,QTY,PLEDGE_NO,REMARK FROM [CSOKYC-6].Pledge.DBO.TBL_LAS_PLEDGE_UNPLADGE_DATA " QUERYOUT ' + @PHYSICAL_PATH + '\' + @FILE_NAME + ' -c -Sintranet -Uinhouse -Pinh6014 '    
    
         Set @SQL= @SQL + ''''    
      End    
      Else If @BANK_CODE = 1--ICICI    
      Begin    
         Insert Into Tbl_las_pledge_unpladge_data    
         Select 'Client ID',    
                'ANGEL BROKING LIMITED',    
                '',    
                '',    
                '''' + Convert(Varchar, @PLEDGOR_BO_ID),    
                '',    
                ''    
         Union All    
         Select 'BANK NAME',    
                Convert(Varchar, @BANK_NAME),    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select 'Agreement No ' + Convert(Varchar, @AGREEMENT_NO),    
                'AC. No.' + Convert(Varchar, @BANK_ACCNO),    
                '''' + Convert(Varchar, @PLEDGEE_BO_ID),    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select 'UNPLEDGE',    
                Convert(Varchar, Getdate(), 104),    
                '',    
                '',    
                'Reference No.',    
                '',    
                ''    
         Union All    
         Select 'SR.NO.',    
                'ISIN',    
                '',    
                'SCRIP NAME',    
                'QUANTITY',    
                'PLEDGE ORD NO.',    
                ''    
         Union All    
         Select '',    
                '',    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select Convert(Varchar, Row_number()Over(Order By Pledge_no)),    
                Isin,    
                '',    
                Scripname,    
				Convert(Varchar, Qty),    
                Pledge_no,    
                ''    
         From   DBO.#unpledge_request_data A With(NOLOCK)    
         Where  Pledgor_bo_id = @PLEDGOR_BO_ID    
                And Bank_code = @BANK_CODE    
                And Pledgee_bo_id = @PLEDGEE_BO_ID    
                And Agreement_no = @AGREEMENT_NO    
    
         Set @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL ' + '''' + 'BCP " SELECT ROW_NM,ISIN,SCRIPNAME,QTY,PLEDGE_NO,REMARK FROM [CSOKYC-6].Pledge.DBO.TBL_LAS_PLEDGE_UNPLADGE_DATA " QUERYOUT ' + @PHYSICAL_PATH + '\' + @FILE_NAME + ' -c -Sintranet -Uinhouse -Pinh6014 '    
    
         Set @SQL= @SQL + ''''    
      End    
      Else---3 Kotak and Another Bank    
      Begin    
         Insert Into Tbl_las_pledge_unpladge_data    
         Select '',    
                'ANGEL BROKING LTD',    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select '',    
                'CLIENT ID : ANGEL BROKING LTD.' + @PLEDGOR_BO_ID,    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select '',    
                @BANK_NAME + ' - ' + @PLEDGEE_BO_ID,    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select '',    
                'AGREEMENT NO.:' + @AGREEMENT_NO,    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select '',    
                'UNPLEDGE ' + Convert(Varchar, Getdate(), 104),    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select '',    
                '',    
                '',    
                '',    
                '',    
                '',    
                ''    
         Union All    
         Select 'SR.NO.',    
                'ISIN',    
                '',    
                'SCRIP NAME',    
                'QUANTITY',    
                'PLEDGE ORD NO.',    
                ''    
         Union All    
         Select Convert(Varchar, Row_number()Over(Order By Pledge_no)),    
                Isin,    
                Scripcode,    
                Scripname,    
                Convert(Varchar, Qty),    
                Pledge_no,    
                ''    
         From   DBO.#unpledge_request_data A With(NOLOCK)    
         Where  Pledgor_bo_id = @PLEDGOR_BO_ID    
                And Bank_code = @BANK_CODE    
                And Pledgee_bo_id = @PLEDGEE_BO_ID    
                And Agreement_no = @AGREEMENT_NO    
    
         Set @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL ' + '''' + 'BCP " SELECT ROW_NM,ISIN,SCRIPNAME,QTY,PLEDGE_NO FROM [CSOKYC-6].Pledge.DBO.TBL_LAS_PLEDGE_UNPLADGE_DATA " QUERYOUT ' + @PHYSICAL_PATH + '\' + @FILE_NAME + ' -c -Sintranet -Uinhouse -Pinh6014 ' 
    
         Set @SQL= @SQL + ''''    
      End    
    
      --PRINT @SQL    
      Exec(@SQL)    
    
      Insert Into Las_pledge_unpledge_genfilepath    
      Values      (@BANK_CODE,    
                   @PHYSICAL_PATH + '\' + @FILE_NAME,    
                   @VIRTUAL_PATH + '/' + @FILE_NAME,    
                   'UNPLEDGE REQUEST :: (' + @BANK_NAME + ')(' + @PLEDGOR_BO_ID + ')(' + @AGREEMENT_NO + ')',    
                   'UNPLEDGE',    
                   Getdate())    
    
      Set @FILE_CTR = @FILE_CTR + 1    
   End    
    
--Print 'GENERATING UNPLEDGE FILES COMPLETED'    
End    
    
   Set NOCOUNT Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_GET_LAS_PLEDGE_UNPLEDGE_FILES
-- --------------------------------------------------
Create Procedure PROC_GET_LAS_PLEDGE_UNPLEDGE_FILES
(
 @ACCESS_TO As Varchar(20)
)
As
   Set NOCOUNT On

Begin
   If Upper(@ACCESS_TO) = 'BROKER'
   Begin
      --IF NOT EXISTS(      
      --    SELECT A.BANK_CODE,BANKNAME,SUM(VALUE) AS PLEDGE_VALUE      
      --    FROM DBO.LAS_PLEDGE_REQUEST A WITH(NOLOCK)      
      --    LEFT OUTER JOIN DBO.TBL_LAS_BANK_MASTER B WITH(NOLOCK)      
      --    ON A.BANK_CODE = B.BANK_CODE      
      --    WHERE CONVERT(VARCHAR(11),UPDATE_DATETIME) LIKE CONVERT(VARCHAR(11),GETDATE()) AND REQUEST_TYPE = 'CREDITORS'      
      --    GROUP BY A.BANK_CODE,BANKNAME      
      --    HAVING SUM(VALUE) > 0      
      --)      
      --BEGIN      
      Select Bank_code                                          As [Bank code],
             Bankname                                           As [Bank name],
             [Action]                                           As [Action],
             '<a href="' + Virtualpath + '">' + [Desc] + '</a>' As [Url],
             Convert(Varchar, Generatedate, 100)                As [Generate datetime]
      From   DBO.Las_pledge_unpledge_genfilepath A With(nolock)
             Left Outer Join general.DBO.Tbl_las_bank_master B With(nolock)
              On A.Bankcode = B.Bank_code
      Order  By Bank_code,[Action]
   --END      
   --ELSE      
   --BEGIN      
   --SELECT '<span style="color:red">FEW REQUEST ARE UNANSWERED AND ARE PENDING FOR APPROVAL. <BR/>PLEASE ASK <b>RAHUL C. SHAH</b> TO APPROVE/REJECT REQUEST</span>' as [DESC]      
   --END      
   End
   Else
   Begin
      Select Top 0 Bankname                                           As [Bank name],
                   [Action]                                           As [Action],
                   '<a href="' + Virtualpath + '">' + [Desc] + '</a>' As [Url],
                   Convert(Varchar, Generatedate, 100)                As [Generate datetime]
      From   DBO.Las_pledge_unpledge_genfilepath A With(nolock)
             Left Outer Join general.DBO.Tbl_las_bank_master B With(nolock)
              On A.Bankcode = B.Bank_code
   End
End

   Set NOCOUNT Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------

  -- exec rebuild_index2 'AdventureWorksDW'
CREATE procedure [dbo].[rebuild_index]
@database varchar(100)
as
declare @db_id  int
Select @db_id = db_id(@database)    

if @db_id is Null    
return   
    
SET NOCOUNT ON;    
DECLARE @objectid int;    
DECLARE @indexid int;    
DECLARE @partitioncount bigint;    
DECLARE @schemaname nvarchar(130);    
DECLARE @objectname nvarchar(130);    
DECLARE @indexname nvarchar(130);    
DECLARE @partitionnum bigint;    
DECLARE @partitions bigint;    
DECLARE @frag float;    
DECLARE @command nvarchar(4000);
DECLARE @MAXROWID int;
DECLARE @MINROWID int;
DECLARE @CURRROWID int; 
DECLARE @ID int;    
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function    
-- and convert object and index IDs to names.    
Create table #work_to_do(id bigint primary key identity(1,1),objectid int,indexid int,partitionnum bigint,frag float )  

insert into #work_to_do(objectid,indexid,partitionnum,frag)
 select
object_id AS objectid,    
index_id AS indexid,    
partition_number AS partitionnum,    
avg_fragmentation_in_percent AS frag    
 FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')    
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0; 

  
   --select @ID =ID from #work_to_do 
  
  SELECT @MINROWID=MIN(ID),@MAXROWID=MAX(ID) FROM #work_to_do WITH(NOLOCK) ; 

  SET @CURRROWID=@MINROWID;  

WHILE (@CURRROWID<=@MAXROWID)
   BEGIN 
 
    SELECT  @objectid=objectid , @indexid=indexid  , @partitionnum=partitionnum , @frag=frag 
     FROM #work_to_do WHERE ID=@CURRROWID 
     set @CURRROWID=@CURRROWID+1   


SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)    
FROM sys.objects AS o    
JOIN sys.schemas as s ON s.schema_id = o.schema_id    
WHERE o.object_id = @objectid;    
SELECT @indexname = QUOTENAME(name)    
FROM sys.indexes    
WHERE object_id = @objectid AND index_id = @indexid;    
SELECT @partitioncount = count (*)    
FROM sys.partitions    
WHERE object_id = @objectid AND index_id = @indexid;    
    
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.    
IF @frag < 30.0    
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';    
IF @frag >= 30.0    
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';    
IF @partitioncount > 1    
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));    
IF @frag >= 30.0    
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)'   
   
EXEC (@command);    
PRINT N'Executed: ' + @command;    
select N'Executed: ' + @command; 
end

      
-- Drop the temporary table.    
DROP TABLE #work_to_do;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_BORROWING
-- --------------------------------------------------
CREATE PROC SP_BORROWING    
@PLEDGE_DATE VARCHAR(15)='',    
@BANK_CODE INT =0,    
@BANK_NAME VARCHAR(300)='',    
@AMOUNT DECIMAL(18,2)=0,    
@ENTERED_BY VARCHAR(30)='',    
@ENTERED_ON VARCHAR(30)='',    
@FLAG VARCHAR(5)=''    
AS    
/*Exec SP_BORROWING '','','',0,'','','D'*/    
BEGIN    
 IF(@FLAG ='I')    
	BEGIN    
		UPDATE tbl_PledgeUnpledgeBorrowing     
		set AMOUNT = @AMOUNT,
			PERCENTAGE =((@AMOUNT/ TOTAL_PLEDGE)*100),
			ENTERED_ON =getdate()   
		WHERE BANK_CODE = @BANK_CODE       
    END    
 IF(@FLAG ='D')    
	BEGIN    
		SELECT Bank_Code,Bank_Name as BankName from  tbl_PledgeUnpledgeBorrowing with(nolock)      
	END   
 IF(@FLAG ='GV')    
	BEGIN    
		SELECT  ROW_NUMBER()OVER(ORDER BY Bank_Name)SRNO,Bank_Name ,
		CONVERT(VARCHAR(100),AMOUNT) Amount,CONVERT(VARCHAR(100),Percentage)Percentage,CONVERT(VARCHAR(100), Entered_On)Entered_On 
		FROM  tbl_PledgeUnpledgeBorrowing WITH(NOLOCK)      
	END         
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ClientWiseDatewise_PledgeDetails
-- --------------------------------------------------
CREATE proc SP_ClientWiseDatewise_PledgeDetails  
@party_code varchar(30)='',  
@Processdate varchar(15)=''  
as  
BEGIN  
--exec SP_ClientWiseDatewise_PledgeDetails 'JOD17256', 'Mar  3 2017'  
  
select   ROW_NUMBER() OVER(ORDER BY A.processdate ASC) SRNO ,A.processdate,party_code,A.isin,        
A.qty,A.pledge_qty,avg_closing,pledge_value/2 as pledge_value,              
A.Bank_code,B.Bankname,A.ledger_bal,isnull(C.PERCENTAGE,0 )as PERCENTAGE,              
Borrowing=   convert(decimal(18,3), ((pledge_value/2) * isnull(C.PERCENTAGE,0 ))/100)  
 from (  
select   
Rms_Date,Ledger_Bal,Party_Code,ISIN,Scrip_cd,ScripName,ACCNO,sum(QTY)as QTY,sum(Pledge_QTY)as Pledge_QTY,  
Avg_Closing,Bank_code,sum(Pledge_Value)as Pledge_Value,OD_Utilization,Processdate from    
Tbl_party_pledged_bankwise_data where party_code=@party_code and convert(date, Processdate)=@Processdate  
group by Rms_Date,Ledger_Bal,Party_Code,ISIN,Scrip_cd,ScripName,ACCNO,Avg_Closing,Bank_code,  
OD_Utilization,Processdate  
) A   
inner Join dbo.Tbl_las_bank_master_Pledge  B  with(nolock) On A.Bank_code = B.Bank_code               
Left Join dbo.tbl_PledgeUnpledgeBorrowing C  with(nolock) on B.Bank_Code = C.Bank_Code   
/*where party_code='JOD17256' and convert(date, Processdate)='Mar 3 2017'*/  
where party_code=@party_code and convert(date, Processdate)=@Processdate  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_SysJob
-- --------------------------------------------------
/*  
 Author :- Prashant  
 Date :- 05 jun 2013  
*/  
CREATE Procedure Sp_SysJob  
(  
 @SearchStr as varchar(20),  
 @SearchType as char(1)='J'  
)  
as  
Begin  
  
 IF UPPER(@SEARCHTYPE) = 'J'  
 BEGIN  
  SELECT B.NAME,A.*   
  FROM MSDB.DBO.SYSJOBSTEPS A   
   INNER JOIN MSDB.DBO.SYSJOBS B  
    ON A.JOB_ID = B.JOB_ID  
  WHERE B.NAME LIKE '%'+@SearchStr+'%'  
 END  
 ELSE IF UPPER(@SEARCHTYPE) = 'S'  
 BEGIN  
  SELECT *   
  FROM MSDB.DBO.SYSJOBS A   
  WHERE EXISTS(SELECT JOB_ID FROM MSDB.DBO.SYSJOBSTEPS B WHERE A.JOB_ID = B.JOB_ID AND B.COMMAND LIKE '%'+@SearchStr+'%')  
 END  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_SysObj
-- --------------------------------------------------
/*  
Author :- Prashant  
Date :- 28/01/2011  
*/  
CREATE Procedure Sp_SysObj  
(  
 @objName as varchar(20),  
 @objType as varchar(3)=''  
)  
as  
Begin  
 select * from sysobjects where name like '%'+@objName+'%' and type like '%'+@objType+'%'--'%batch%'  
 order by name,type  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TOTALPLEDGE_BORROWING
-- --------------------------------------------------
/* SP for JOB which runs after Pledge process is created by Rohit Patil for Borrowing logic */        
CREATE PROCEDURE TOTALPLEDGE_BORROWING        
AS         
BEGIN   
  
DECLARE @FRMDATE DATE   
IF (DATENAME(DW,GETDATE()))='monday'  
BEGIN   
 SET @FRMDATE=GETDATE()-2  
END  
ELSE  
BEGIN   
 SET @FRMDATE=GETDATE()-1  
END         
        
INSERT INTO tbl_PledgeUnpledgeBorrowing_LOG        
SELECT PLEDGE_DATE,BANK_CODE,BANK_NAME,AMOUNT,TOTAL_PLEDGE,        
  PERCENTAGE,ENTERED_BY,ENTERED_ON,GETDATE()          
  FROM TBL_PLEDGEUNPLEDGEBORROWING        
        
TRUNCATE TABLE tbl_PledgeUnpledgeBorrowing        
        
         
select Bank_code,BankName, sum(pledge_value) As TotalPledge         
into #BankDetails        
from  ClientWiseDatewise_PledgeDetails        
where convert(date, processdate)=@FRMDATE        
group by Bank_code,BankName         
         
         
        
INSERT INTO tbl_PledgeUnpledgeBorrowing        
SELECT CONVERT(DATE,GETDATE()-1),BANK_CODE,BANKNAME,0.00,TOTALPLEDGE,0,'SYSTEM',GETDATE() FROM #BankDetails        
      
      
truncate table Tbl_las_bank_master_Pledge      
    
INSERT INTO Tbl_las_bank_master_Pledge     
select * from General.dbo.[Tbl_las_bank_master] with(nolock)      

DROP TABLE #BankDetails      
        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_BakwisePledgeRpt
-- --------------------------------------------------
CREATE Procedure usp_BakwisePledgeRpt
(      
    @FrmDt Datetime,      
    @access_to varchar(20),      
    @access_code varchar(20)      
)      
as      
Begin      
set nocount on      
Select Party_code,Bank_code,Ledger_bal=Max(Ledger_bal),Pledge_value=Sum(Pledge_value),      
       Od_utilization=Sum(Od_utilization)      
Into   #Rslt      
From   Tbl_party_pledged_bankwise_data (Nolock)      
Where  Processdate >= @FrmDt and Processdate <= @FrmDt +' 23:59:59'       
Group  By Party_code,Bank_code       
      
      
Select     A.*,B.Bankname      
Into       #FinRslt      
From       #Rslt A(Nolock)      
Inner Join General.dbo.Tbl_las_bank_master B With(nolock)      
 On A.Bank_code = B.Bank_code       
where bankname<>'BSEExchange'    
      
Declare @Bank Varchar(7200)      
Declare @Bank_OD Varchar(7200)      
Declare @Bank_PL Varchar(7200)      
      
Select @Bank = Stuff((Select Distinct '],[' + [Bankname]      
                      From   #FinRslt      
                      Order  By '],[' + [Bankname]      
                      For xml path('')), 1, 2, '') + ']'      
      
--Select @Bank      
Select @Bank_OD = Stuff((Select Distinct '],b.[' + [Bankname]+'] AS ['+[Bankname]+' OD'      
                      From   #FinRslt      
                      Order  By '],b.[' + [Bankname]+'] AS ['+[Bankname]+' OD'      
                      For xml path('')), 1, 2, '') + ']'      
      
      
Select @Bank_PL = Stuff((Select Distinct '],a.[' + [Bankname]+'] AS ['+[Bankname]+' PV'      
                      From   #FinRslt      
                      Order  By '],a.[' + [Bankname]+'] AS ['+[Bankname]+' PV'      
                      For xml path('')), 1, 2, '') + ']'      
      
      
--Select @Bank_OD      
--Select @Bank_PL      
      
Declare @query Varchar(8000)      
      
Set @query = 'SELECT * into #CliPldVal FROM              
      (SELECT Party_code,Ledger_Bal,[Pledge_value],[BankName]             
                  FROM #FinRslt                
                  ) src              
PIVOT (SUM([Pledge_value]) FOR [BankName]              
IN (' + @Bank + ')) AS pvt order by Party_code        
      
      
SELECT * into #CliODVal FROM              
      (SELECT Party_code,Ledger_Bal,[Od_utilization],[BankName]             
                  FROM #FinRslt                
                  ) src              
PIVOT (SUM([Od_utilization]) FOR [BankName]              
IN (' + @Bank + ')) AS pvt order by Party_code      
      
Select a.party_code,a.ledger_bal,'+@Bank_PL+','+@Bank_OD+'      
from #CliPldVal a inner join #CliODVal b      
on a.Party_code=b.Party_code      
order by 3 desc    
'      
      
--Print @query      
      
Execute (@query)       
set nocount off      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_BakwisePledgeRpt_01032013
-- --------------------------------------------------
CREATE Procedure usp_BakwisePledgeRpt_01032013
(    
    @FrmDt Datetime,    
    @access_to varchar(20),    
    @access_code varchar(20)    
)    
as    
Begin    
set nocount on    
Select Party_code,Bank_code,Ledger_bal=Max(Ledger_bal),Pledge_value=Sum(Pledge_value),    
       Od_utilization=Sum(Od_utilization)    
Into   #Rslt    
From   Tbl_party_pledged_bankwise_data (Nolock)    
Where  Processdate >= @FrmDt and Processdate <= @FrmDt +' 23:59:59'     
Group  By Party_code,Bank_code     
    
    
Select     A.*,B.Bankname    
Into       #FinRslt    
From       #Rslt A(Nolock)    
Inner Join General.dbo.Tbl_las_bank_master B With(nolock)    
 On A.Bank_code = B.Bank_code     
where bankname<>'BSEExchange'  
    
Declare @Bank Varchar(7200)    
Declare @Bank_OD Varchar(7200)    
Declare @Bank_PL Varchar(7200)    
    
Select @Bank = Stuff((Select Distinct '],[' + [Bankname]    
                      From   #FinRslt    
                      Order  By '],[' + [Bankname]    
                      For xml path('')), 1, 2, '') + ']'    
    
--Select @Bank    
Select @Bank_OD = Stuff((Select Distinct '],b.[' + [Bankname]+'] AS ['+[Bankname]+' OD'    
                      From   #FinRslt    
                      Order  By '],b.[' + [Bankname]+'] AS ['+[Bankname]+' OD'    
                      For xml path('')), 1, 2, '') + ']'    
    
    
Select @Bank_PL = Stuff((Select Distinct '],a.[' + [Bankname]+'] AS ['+[Bankname]+' PV'    
                      From   #FinRslt    
                      Order  By '],a.[' + [Bankname]+'] AS ['+[Bankname]+' PV'    
                      For xml path('')), 1, 2, '') + ']'    
    
    
--Select @Bank_OD    
--Select @Bank_PL    
    
Declare @query Varchar(8000)    
    
Set @query = 'SELECT * into #CliPldVal FROM            
      (SELECT Party_code,Ledger_Bal,[Pledge_value],[BankName]           
                  FROM #FinRslt              
                  ) src            
PIVOT (SUM([Pledge_value]) FOR [BankName]            
IN (' + @Bank + ')) AS pvt order by Party_code      
    
    
SELECT * into #CliODVal FROM            
      (SELECT Party_code,Ledger_Bal,[Od_utilization],[BankName]           
                  FROM #FinRslt              
                  ) src            
PIVOT (SUM([Od_utilization]) FOR [BankName]            
IN (' + @Bank + ')) AS pvt order by Party_code    
    
Select a.party_code,a.ledger_bal,'+@Bank_PL+','+@Bank_OD+'    
from #CliPldVal a inner join #CliODVal b    
on a.Party_code=b.Party_code    
order by 3 desc  
'    
    
--Print @query    
    
Execute (@query)     
set nocount off    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_BakwisePledgeRpt_23072013
-- --------------------------------------------------
CREATE Procedure usp_BakwisePledgeRpt_23072013
(      
    @FrmDt Datetime,      
    @access_to varchar(20),      
    @access_code varchar(20)      
)      
as      
Begin      
set nocount on      
Select Party_code,Bank_code,Ledger_bal=Max(Ledger_bal),Pledge_value=Sum(Pledge_value),      
       Od_utilization=Sum(Od_utilization)      
Into   #Rslt      
--From   Tbl_party_pledged_bankwise_data (Nolock)      
from [196.1.115.245].general_new.dbo.Tbl_Party_Pledged_BankWise_Data_2 A(Nolock)  
--Where  Processdate >= @FrmDt and Processdate <= @FrmDt +' 23:59:59'       
Where  rms_date >= @FrmDt and rms_date <= @FrmDt +' 23:59:59'  
Group  By Party_code,Bank_code       
      
Select     A.*,B.Bankname      
Into       #FinRslt      
From       #Rslt A(Nolock)      
Inner Join General.dbo.Tbl_las_bank_master B With(nolock)      
 On A.Bank_code = B.Bank_code       
where bankname<>'BSEExchange'    
      
Declare @Bank Varchar(7200)      
Declare @Bank_OD Varchar(7200)      
Declare @Bank_PL Varchar(7200)      
      
Select @Bank = Stuff((Select Distinct '],[' + [Bankname]      
                      From   #FinRslt      
                      Order  By '],[' + [Bankname]      
                      For xml path('')), 1, 2, '') + ']'      
      
--Select @Bank      
Select @Bank_OD = Stuff((Select Distinct '],b.[' + [Bankname]+'] AS ['+[Bankname]+' OD'      
                      From   #FinRslt      
                      Order  By '],b.[' + [Bankname]+'] AS ['+[Bankname]+' OD'      
                      For xml path('')), 1, 2, '') + ']'      
      
      
Select @Bank_PL = Stuff((Select Distinct '],a.[' + [Bankname]+'] AS ['+[Bankname]+' PV'      
                      From   #FinRslt      
                      Order  By '],a.[' + [Bankname]+'] AS ['+[Bankname]+' PV'      
                      For xml path('')), 1, 2, '') + ']'      
      
      
--Select @Bank_OD      
--Select @Bank_PL      
      
Declare @query Varchar(8000)      
      
Set @query = 'SELECT * into #CliPldVal FROM              
      (SELECT Party_code,Ledger_Bal,[Pledge_value],[BankName]             
                  FROM #FinRslt                
                  ) src              
PIVOT (SUM([Pledge_value]) FOR [BankName]              
IN (' + @Bank + ')) AS pvt order by Party_code        
      
      
SELECT * into #CliODVal FROM              
      (SELECT Party_code,Ledger_Bal,[Od_utilization],[BankName]             
                  FROM #FinRslt                
                  ) src              
PIVOT (SUM([Od_utilization]) FOR [BankName]              
IN (' + @Bank + ')) AS pvt order by Party_code      
      
Select a.party_code,a.ledger_bal,'+@Bank_PL+','+@Bank_OD+'      
from #CliPldVal a inner join #CliODVal b      
on a.Party_code=b.Party_code      
order by 3 desc    
'      
      
--Print @query      
      
Execute (@query)       
set nocount off      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetClientPledgeBankwise_Rpt
-- --------------------------------------------------
/*
CHANGE ID  :: 1 
MODIFIED BY  :: RITESH                                                                                                                        
MODIFIED DATE :: MAR 07 2014                                                                                                                        
REASON   :: CHANGED LOG TABLE TO PHYSICAL TABLE FOR DATA FETCH PREVIOUS DATA     
*/
--exec usp_GetClientPledgeBankwise_Rpt 'FEB 26 2014','FEB 26 2014','%','%','%','cv','BROKER','CSO'
CREATE PROCEDURE Usp_getclientpledgebankwise_rpt (@FrmDt       DATETIME,
                                                 @ToDt        DATETIME,
                                                 @AccNo       VARCHAR(20),
                                                 @Party_Code  VARCHAR(20),
                                                 @ISIN        VARCHAR(20),
                                                 @Data        VARCHAR(20),
                                                 @Access_Code VARCHAR(20),
                                                 @Access_to   VARCHAR(20))
AS
  BEGIN
      SET nocount ON;
      SET @FrmDt=@FrmDt + ' 00:00:00'
      SET @ToDt=@ToDt + ' 23:59:59'

      IF @Party_Code = '%'
        BEGIN
            SET @Party_Code=NULL
        END

      IF @ISIN = '%'
        BEGIN
            SET @ISIN=NULL
        END

      IF @AccNo = '%'
        BEGIN
            SET @AccNo=NULL
        END

      IF @Data = 'HISTORY'
        BEGIN
            SELECT BankName,
                   Party_Code,
                   ISIN,
                   Scrip_cd,
                   ScripName,
                   ACCNO,
                   Pledge_QTY,
                   Avg_Closing,
                   Pledge_Value,
                   OD_Utilization,
                   Processdate
            FROM   Tbl_Party_Pledged_BankWise_Data A(Nolock)
                   /* CHANGE ID  :: 1 
                   Tbl_Party_Pledged_BankWise_Data_log A(Nolock)
                   */
                   INNER JOIN General.dbo.Vw_las_comb_bank_agreeement_mast M WITH(nolock)
                     ON A.Bank_code = M.Bank_code
                        AND a.accno = m.pledgor_bo_id
            WHERE  A.Processdate >= @FrmDt
                   AND A.Processdate <= @ToDt
                   AND A.Party_Code = Isnull(@Party_Code, Party_Code)
                   AND A.ACCNO = Isnull(@ACCNO, ACCNO)
                   AND A.ISIN = Isnull(@ISIN, ISIN)
            --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)                 
            ORDER  BY M.Priority
        END
      ELSE
        BEGIN
            SELECT BankName,
                   Party_Code,
                   ISIN,
                   Scrip_cd,
                   ScripName,
                   ACCNO,
                   Pledge_QTY,
                   Avg_Closing,
                   Pledge_Value,
                   OD_Utilization,
                   Processdate
            FROM   Tbl_Party_Pledged_BankWise_Data A(Nolock)
                   INNER JOIN General.dbo.Vw_las_comb_bank_agreeement_mast M WITH(nolock)
                     ON A.Bank_code = M.Bank_code
                        AND a.accno = m.pledgor_bo_id
            WHERE  A.Processdate >= @FrmDt
                   AND A.Processdate <= @ToDt
                   AND A.Party_Code = Isnull(@Party_Code, Party_Code)
                   AND A.ACCNO = Isnull(@ACCNO, ACCNO)
                   AND A.ISIN = Isnull(@ISIN, ISIN)
            --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)                 
            ORDER  BY M.Priority
        END

      SET nocount OFF;
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetClientPledgeBankwise_Rpt_01032013
-- --------------------------------------------------
CREATE Procedure usp_GetClientPledgeBankwise_Rpt_01032013
(        
 @FrmDt Datetime,        
 @ToDt Datetime,        
 @AccNo Varchar(20),         
 @Party_Code varchar(20),        
 @ISIN Varchar(20),         
 @Data Varchar(20),        
 @Access_Code Varchar(20),        
 @Access_to Varchar(20)        
)        
as        
begin        
set nocount on;        
 set @FrmDt=@FrmDt+  ' 00:00:00'        
 set @ToDt=@ToDt+  ' 23:59:59'        
 if @Party_Code='%'        
 begin        
  set @Party_Code=null        
 end        
 if @ISIN='%'        
 begin        
  set @ISIN=null        
 end        
 if @AccNo='%'        
 begin        
  set @AccNo=null        
 end        
 Select BankName,Party_Code,ISIN,Scrip_cd,ScripName,ACCNO,Pledge_QTY,        
 Avg_Closing,Pledge_Value,OD_Utilization,Processdate          
 from Tbl_Party_Pledged_BankWise_Data A(Nolock) inner join        
 General.dbo.Vw_las_comb_bank_agreeement_mast M With(nolock)        
 On A.Bank_code=M.Bank_code  and a.accno=m.pledgor_bo_id      
 where A.Processdate>=@FrmDt         
    and A.Processdate<=@ToDt        
    and A.Party_Code=isnull(@Party_Code,Party_Code)        
    and A.ACCNO=isnull(@ACCNO,ACCNO)        
    and A.ISIN=isnull(@ISIN,ISIN)        
   --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)         
 Order by M.Priority          
set nocount off;        
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetClientPledgeBankwise_Rpt_07032014
-- --------------------------------------------------
    
--CREATE Procedure usp_GetClientPledgeBankwise_Rpt      
CREATE Procedure usp_GetClientPledgeBankwise_Rpt_07032014    
(                
 @FrmDt Datetime,                
 @ToDt Datetime,                
 @AccNo Varchar(20),                 
 @Party_Code varchar(20),                
 @ISIN Varchar(20),                 
 @Data Varchar(20),                
 @Access_Code Varchar(20),                
 @Access_to Varchar(20)                
)                
as                
begin                
set nocount on;                
 set @FrmDt=@FrmDt+  ' 00:00:00'                
 set @ToDt=@ToDt+  ' 23:59:59'                
 if @Party_Code='%'                
 begin                
  set @Party_Code=null                
 end                
 if @ISIN='%'                
 begin                
  set @ISIN=null                
 end                
 if @AccNo='%'                
 begin                
  set @AccNo=null                
 end    
     
 if @Data = 'HISTORY'    
 begin    
  Select BankName,Party_Code,ISIN,Scrip_cd,ScripName,ACCNO,Pledge_QTY,                
      Avg_Closing,Pledge_Value,OD_Utilization,Processdate                  
  from Tbl_Party_Pledged_BankWise_Data_log A(Nolock) inner join                
   General.dbo.Vw_las_comb_bank_agreeement_mast M With(nolock)    
   On A.Bank_code=M.Bank_code  and a.accno=m.pledgor_bo_id              
  where A.Processdate>=@FrmDt                 
  and A.Processdate<=@ToDt                
  and A.Party_Code=isnull(@Party_Code,Party_Code)                
  and A.ACCNO=isnull(@ACCNO,ACCNO)                
  and A.ISIN=isnull(@ISIN,ISIN)                
    --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)                 
  Order by M.Priority                  
 end    
 else    
 begin    
  Select BankName,Party_Code,ISIN,Scrip_cd,ScripName,ACCNO,Pledge_QTY,                
  Avg_Closing,Pledge_Value,OD_Utilization,Processdate                  
  from Tbl_Party_Pledged_BankWise_Data A(Nolock) inner join                
   General.dbo.Vw_las_comb_bank_agreeement_mast M With(nolock)    
   On A.Bank_code=M.Bank_code  and a.accno=m.pledgor_bo_id              
  where A.Processdate>=@FrmDt                 
  and A.Processdate<=@ToDt                
  and A.Party_Code=isnull(@Party_Code,Party_Code)                
  and A.ACCNO=isnull(@ACCNO,ACCNO)                
  and A.ISIN=isnull(@ISIN,ISIN)                
    --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)                 
  Order by M.Priority                  
 end    
     
     
set nocount off;                
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetClientPledgeBankwise_Rpt_23072013
-- --------------------------------------------------
CREATE Procedure usp_GetClientPledgeBankwise_Rpt_23072013
(            
 @FrmDt Datetime,            
 @ToDt Datetime,            
 @AccNo Varchar(20),             
 @Party_Code varchar(20),            
 @ISIN Varchar(20),             
 @Data Varchar(20),            
 @Access_Code Varchar(20),            
 @Access_to Varchar(20)            
)            
as            
begin            
set nocount on;            
 set @FrmDt=@FrmDt+  ' 00:00:00'            
 set @ToDt=@ToDt+  ' 23:59:59'            
 if @Party_Code='%'            
 begin            
  set @Party_Code=null            
 end            
 if @ISIN='%'            
 begin            
  set @ISIN=null            
 end            
 if @AccNo='%'            
 begin            
  set @AccNo=null            
 end            
 Select BankName,Party_Code,ISIN,Scrip_cd,ScripName,/*ACCNO,*/Pledge_QTY,            
 Avg_Closing as Closing,Pledge_Value,OD_Utilization/*,Processdate*/  
 --from Tbl_Party_Pledged_BankWise_Data A(Nolock) inner join            
 from [196.1.115.245].general_new.dbo.Tbl_Party_Pledged_BankWise_Data_2 A(Nolock) inner join            
 General.dbo.Vw_las_comb_bank_agreeement_mast M With(nolock)            
 On A.Bank_code=M.Bank_code  and a.accno=m.pledgor_bo_id          
 where  /*    
  A.Processdate>=@FrmDt             
    and A.Processdate<=@ToDt            
  */    
  A.rms_date>=@FrmDt             
    and A.rms_date<=@ToDt            
    and A.Party_Code=isnull(@Party_Code,Party_Code)            
    and A.ACCNO=isnull(@ACCNO,ACCNO)            
    and A.ISIN=isnull(@ISIN,ISIN)            
   --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)             
 Order by M.Priority              
set nocount off;            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetClientPledgeBankwise_Rpt_25022013
-- --------------------------------------------------
CREATE Procedure usp_GetClientPledgeBankwise_Rpt_25022013
(    
 @FrmDt Datetime,    
 @ToDt Datetime,    
 @AccNo Varchar(20),     
 @Party_Code varchar(20),    
 @ISIN Varchar(20),     
 @Data Varchar(20),    
 @Access_Code Varchar(20),    
 @Access_to Varchar(20)    
)    
as    
begin    
set nocount on;    
 set @FrmDt=@FrmDt+  ' 00:00:00'    
 set @ToDt=@ToDt+  ' 23:59:59'    
 if @Party_Code='%'    
 begin    
  set @Party_Code=null    
 end    
 if @ISIN='%'    
 begin    
  set @ISIN=null    
 end    
 if @AccNo='%'    
 begin    
  set @AccNo=null    
 end    
 Select BankName,Party_Code,ISIN,Scrip_cd,ScripName,ACCNO,Pledge_QTY,    
 Avg_Closing,Pledge_Value,OD_Utilization,Processdate      
 from Tbl_Party_Pledged_BankWise_Data A(Nolock) inner join    
 General.dbo.Vw_las_comb_bank_agreeement_mast M With(nolock)    
 On A.Bank_code=M.Bank_code  and a.accno=m.pledgor_bo_id  
 where A.Processdate>=@FrmDt     
    and A.Processdate<=@ToDt    
    and A.Party_Code=isnull(@Party_Code,Party_Code)    
    and A.ACCNO=isnull(@ACCNO,ACCNO)    
    and A.ISIN=isnull(@ISIN,ISIN)    
   --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)     
 Order by M.Priority      
set nocount off;    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetClientPledgeBankwise_Rpt_pledge
-- --------------------------------------------------
  
--CREATE Procedure usp_GetClientPledgeBankwise_Rpt    
create Procedure usp_GetClientPledgeBankwise_Rpt_pledge  
(              
 @FrmDt Datetime,              
 @ToDt Datetime,              
 @AccNo Varchar(20),               
 @Party_Code varchar(20),              
 @ISIN Varchar(20),               
 @Data Varchar(20),              
 @Access_Code Varchar(20),              
 @Access_to Varchar(20)              
)              
as              
begin              
set nocount on;              
 set @FrmDt=@FrmDt+  ' 00:00:00'              
 set @ToDt=@ToDt+  ' 23:59:59'              
 if @Party_Code='%'              
 begin              
  set @Party_Code=null              
 end              
 if @ISIN='%'              
 begin              
  set @ISIN=null              
 end              
 if @AccNo='%'              
 begin              
  set @AccNo=null              
 end  
   
 if @Data = 'HISTORY'  
 begin  
  Select BankName,Party_Code,ISIN,Scrip_cd,ScripName,ACCNO,Pledge_QTY,              
      Avg_Closing,Pledge_Value,OD_Utilization,Processdate                
  from Tbl_Party_Pledged_BankWise_Data_log A(Nolock) inner join              
   General.dbo.Vw_las_comb_bank_agreeement_mast M With(nolock)  
   On A.Bank_code=M.Bank_code  and a.accno=m.pledgor_bo_id            
  where A.Processdate>=@FrmDt               
  and A.Processdate<=@ToDt              
  and A.Party_Code=isnull(@Party_Code,Party_Code)              
  and A.ACCNO=isnull(@ACCNO,ACCNO)              
  and A.ISIN=isnull(@ISIN,ISIN)              
    --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)               
  Order by M.Priority                
 end  
 else  
 begin  
  Select BankName,Party_Code,ISIN,Scrip_cd,ScripName,ACCNO,Pledge_QTY,              
  Avg_Closing,Pledge_Value,OD_Utilization,Processdate                
  from Tbl_Party_Pledged_BankWise_Data A(Nolock) inner join              
   General.dbo.Vw_las_comb_bank_agreeement_mast M With(nolock)  
   On A.Bank_code=M.Bank_code  and a.accno=m.pledgor_bo_id            
  where A.Processdate>=@FrmDt               
  and A.Processdate<=@ToDt              
  and A.Party_Code=isnull(@Party_Code,Party_Code)              
  and A.ACCNO=isnull(@ACCNO,ACCNO)              
  and A.ISIN=isnull(@ISIN,ISIN)              
    --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)               
  Order by M.Priority                
 end  
   
   
set nocount off;              
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GETPLEDGEBANKDETAILS
-- --------------------------------------------------
CREATE PROCEDURE USP_GETPLEDGEBANKDETAILS
AS
   SET NOCOUNT ON

BEGIN
   SELECT BANK_CODE,
          BANKNAME,
          LAS_LINE,
          BO_ID,
          ACTIVE_INACTIVE,
          PRIORITY,
          UTILIZATION
   FROM   GENERAL.DBO.TBL_LAS_BANK_MASTER A WITH(NOLOCK)
   ORDER  BY PRIORITY
END

   SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Las_Pledge_Bankwise_Allocation
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_Las_Pledge_Bankwise_Allocation]    
AS    
BEGIN    
 SET nocount ON;    
    
 IF NOT EXISTS    
        (SELECT Hdate    
         FROM   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)    
         WHERE  CONVERT(DATETIME, CONVERT(VARCHAR, Hdate, 106)) = CONVERT(DATETIME,    
                                                                  CONVERT(VARCHAR, Getdate(),106)))    
 BEGIN    
  --drop table #Party_Pledged_Data            
  DECLARE @PRO_DATE DATETIME    
    
  SELECT @PRO_DATE = Max(CONVERT(VARCHAR, Processdate, 106))    
  FROM   Tbl_party_pledge_data A(NOLOCK)
  
  /*Change for Testing 22 Mar 2017 for Dharmesh Mistry*/
  
   INSERT INTO TBL_PARTY_PLEDGED_BANKWISE_DATA_LOG_TEST 
   SELECT *,Logdate=Getdate()      
   FROM   Tbl_party_pledged_bankwise_data      
   WHERE  Processdate >= CONVERT(VARCHAR, @PRO_DATE, 106)      
          AND Processdate <= CONVERT(VARCHAR, @PRO_DATE, 106) + ' 23:59:59' 
  /*Testing End*/    
    
  SELECT Party_row_num=IDENTITY(Int, 1, 1),*,Bank_code=0,Bank_allocated_qty=Cast(0 AS INT)    
  INTO   #Party_Pledged_Data    
  FROM   Tbl_party_pledge_data A(NOLOCK)    
  WHERE  Pledge_qty > 0    
    
  --and isin='INE220B01022'             
  --and Accno='1203320000000051'            
  CREATE CLUSTERED INDEX [IX_PARTY_PLEDGE_PARTYCODE_ISIN]    
   ON #Party_Pledged_Data ( [Isin] ASC, [Party_code] ASC )    
   WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [PRIMARY]    
    
  --drop table #PLEDGE_REQUEST            
  SELECT Isin,Pledgor_bo_id=Clientid,Pledge_qty=Cast(Sum(Pledgeqty - Unpledgeqty) AS INT),    
         Pledg_value=Cast (Sum(0)    
                     AS MONEY),Pledgee_bo_id=Bankid,Bank_code=Cast (Sum(0)AS INT),Bank_priority=Cast (Sum(0)AS INT),    
         Allocated_qty=Cast (Sum(0)AS INT)    
  INTO   #PLEDGE_REQUEST    
  FROM   mis.demat.dbo.Pledge2releaseentry A(NOLOCK)    
  WHERE  EXISTS    
         (SELECT B.Accno    
          FROM   Tbl_las_account_master B WITH(NOLOCK) /* There is 28 account was activated by Rohit Patil on 30th June 2018 as discussed with Anil Wandre */    
          WHERE  B.Active_inactive = 1    
                 AND A.Clientid = B.Accno)    
  GROUP  BY Isin,Clientid,Bankid    
    
  UPDATE #PLEDGE_REQUEST    
  SET    Bank_code = M.Bank_code,Bank_priority = M.Priority    
  FROM   General.dbo.Vw_las_comb_bank_agreeement_mast M WITH(nolock)    
  WHERE  #pledge_request.Pledgee_bo_id = M.Pledgee_bo_id    
         AND #pledge_request.Pledgor_bo_id = M.Pledgor_bo_id    
         AND M.Active_Inactive = 1    
  
DELETE FROM  #PLEDGE_REQUEST WHERE BANK_CODE=0  
           
    
  --drop table #LAS_PLEDGE_REQUEST                 
  SELECT Row_num=IDENTITY(Int, 1, 1),*    
  INTO   #LAS_PLEDGE_REQUEST    
  FROM   #PLEDGE_REQUEST    
  ORDER  BY Bank_priority DESC    
    
  CREATE CLUSTERED INDEX [IX_LAS_PLEDGE_ROW_NUM]    
   ON #LAS_PLEDGE_REQUEST ( [Isin] ASC, [Row_num] ASC )    
   WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [PRIMARY]    
    
  --drop table #Tbl_Party_Pledged_Data_BankWise            
  --update #Party_Pledged_Data set Bank_code=0,Bank_Allocated_Qty=0               
  --update #LAS_PLEDGE_REQUEST set Allocated_qty=0             
  SELECT TOP 0 Rms_date,Ledger_bal=Cast(0 AS MONEY),Party_code,Isin,Scrip_cd,Scripname,Accno,Qty,    
               Pledge_qty,Avg_closing,    
               Bank_code=Cast (0 AS INT),Processdate,Bank_allocated_qty    
  INTO   #Tbl_Party_Pledged_Data_BankWise    
  FROM   #Party_Pledged_Data    
    
  ----VARIABLE BANK LEVEL             
  DECLARE @ISIN         VARCHAR(20),    
          @PLEDGOR_BOID VARCHAR(20),    
          @PLEDGE_QTY   INT,    
          @PLEDG_VALUE  MONEY,    
          @COUNTER      INT,    
          @BANK_CODE    INT    
    
  ----VARIABLE CLIENT LEVEL                
  DECLARE @ISIN_CLI           VARCHAR(20),    
          @PLEDGOR_BOID_CLI   VARCHAR(20),    
          @PLEDGE_QTY_CLI     INT,    
          @DIFFPLEDGE_QTY_CLI INT,    
          @PLEDG_VALUE_CLI    MONEY,    
          @COUNTER_CLI        INT,    
          @PARTY_CODE         VARCHAR(20),    
          @SCRIP_PRIORITY_CLI INT,    
          @BANK_CODE_CLI      INT,    
          @PARTY_ROW_NUM      INT    
    
  SET nocount ON    
    
  SELECT @COUNTER = Max(Row_num)    
  FROM   #LAS_PLEDGE_REQUEST    
    
  WHILE @COUNTER > 0    
  BEGIN    
   SELECT @ISIN = Isin,@PLEDGOR_BOID = Pledgor_bo_id,@PLEDGE_QTY = Pledge_qty - Allocated_qty,    
          @BANK_CODE = Bank_code    
   FROM   #LAS_PLEDGE_REQUEST    
   WHERE  Row_num = @COUNTER    
    
   WHILE @PLEDGE_QTY > 0    
   BEGIN    
    --print 'ISIN : '+@ISIN               
    --print 'COUNTER  : '+Cast(@COUNTER  as varchar)+' Pledge_qty:'+ Cast(@Pledge_qty as varchar)             
    --print 'ISIN : '+@ISIN +' PLEDGOR_BOID: '+ @PLEDGOR_BOID +' Pledge_qty:'+ Cast(@Pledge_qty as varchar)            
    SELECT Row_num=Row_number() OVER(ORDER BY Party_code),Party_row_num,Rms_date,Party_code,Isin,Scrip_cd    
           ,    
           Scripname,    
           Accno,Qty,Pledge_qty,Avg_closing,Bank_code,Processdate,Bank_allocated_qty,Ledger_bal    
    INTO   #PARTY_PLEDGE    
    FROM   #Party_Pledged_Data    
    WHERE  Isin = @ISIN    
           AND Accno = @PLEDGOR_BOID    
           AND Pledge_qty - Bank_allocated_qty > 0    
    ORDER  BY Ledger_bal DESC    
    
    SELECT @COUNTER_CLI = Isnull(Max(Row_num), 0)    
    FROM   #PARTY_PLEDGE    
    
    WHILE @COUNTER_CLI > 0    
    BEGIN    
     SELECT @PLEDGOR_BOID_CLI = Accno,@PARTY_CODE = Party_code,@PLEDGE_QTY_CLI =    
                                                               Pledge_qty - Bank_allocated_qty,    
            @ISIN_CLI = Isin,@PARTY_ROW_NUM = Party_row_num    
     FROM   #PARTY_PLEDGE    
     WHERE  Row_num = @COUNTER_CLI    
    
     --print 'ISIN : '+@ISIN_Cli +' PARTY_CODE: '+ @PARTY_CODE +' Pledge_qty:'+ Cast(@Pledge_qty_CLI as varchar)            
     IF @PLEDGE_QTY_CLI <= @PLEDGE_QTY    
     BEGIN    
      --print 'ISIN : '+@ISIN_Cli +' PLEDGOR_BOID: '+ @PLEDGOR_BOID_CLI +' Party_code:'+ Cast(@Party_code as varchar)            
      INSERT INTO #Tbl_Party_Pledged_Data_BankWise    
       SELECT Rms_date,Ledger_bal,Party_code,Isin,Scrip_cd,Scripname,Accno,Qty,    
       Pledge_qty=Pledge_qty- Bank_allocated_qty,Avg_closing,@BANK_CODE,    
       Processdate,Bank_allocated_qty=@PLEDGE_QTY_CLI    
    FROM   #PARTY_PLEDGE    
    WHERE  Accno = @PLEDGOR_BOID_CLI    
    AND Party_code = @PARTY_CODE    
    AND Isin = @ISIN_CLI    
    AND Row_num = @COUNTER_CLI    
    
    UPDATE #Party_Pledged_Data    
    SET    Bank_code = @BANK_CODE,Bank_allocated_qty = Bank_allocated_qty + @PLEDGE_QTY_CLI    
    WHERE  Accno = @PLEDGOR_BOID_CLI    
    AND Party_code = @PARTY_CODE    
    AND Isin = @ISIN_CLI    
    AND Party_row_num = @PARTY_ROW_NUM    
    
    UPDATE #LAS_PLEDGE_REQUEST    
    SET    Allocated_qty = Allocated_qty + @PLEDGE_QTY_CLI    
    WHERE  Pledgor_bo_id = @PLEDGOR_BOID_CLI    
    AND Bank_code = @BANK_CODE    
    AND Isin = @ISIN_CLI    
    AND Row_num = @COUNTER    
    
    SET @PLEDGE_QTY=@PLEDGE_QTY - @PLEDGE_QTY_CLI    
    --print 'if  ISIN : '+@ISIN_Cli +' PARTY_CODE: '+ @PARTY_CODE +' Pledge_qty:'+ Cast(@Pledge_qty as varchar)            
    END --If @Pledge_qty_CLI<=@Pledge_qty            
    ELSE    
    BEGIN    
    INSERT INTO #Tbl_Party_Pledged_Data_BankWise    
    SELECT Rms_date,Ledger_bal,Party_code,Isin,Scrip_cd,Scripname,Accno,Qty,Pledge_qty=@PLEDGE_QTY,    
    Avg_closing,    
    @BANK_CODE,Processdate,Bank_allocated_qty=@PLEDGE_QTY    
    FROM   #PARTY_PLEDGE    
    WHERE  Accno = @PLEDGOR_BOID_CLI    
    AND Party_code = @PARTY_CODE    
    AND Isin = @ISIN_CLI    
    AND Row_num = @COUNTER_CLI    
    
    UPDATE #Party_Pledged_Data    
    SET    Bank_code = @BANK_CODE,Bank_allocated_qty = Bank_allocated_qty + @PLEDGE_QTY    
    WHERE  Accno = @PLEDGOR_BOID_CLI    
    AND Party_code = @PARTY_CODE    
    AND Isin = @ISIN_CLI    
    AND Party_row_num = @PARTY_ROW_NUM    
    
    UPDATE #LAS_PLEDGE_REQUEST    
    SET    Allocated_qty = Allocated_qty + @PLEDGE_QTY    
    WHERE  Pledgor_bo_id = @PLEDGOR_BOID_CLI    
    AND Bank_code = @BANK_CODE    
    AND Isin = @ISIN_CLI    
    AND Row_num = @COUNTER    
    
  SET @PLEDGE_QTY=0    
    --print 'Else: ISIN : '+@ISIN_Cli +' PARTY_CODE: '+ @PARTY_CODE +' Pledge_qty:'+ Cast(@Pledge_qty as varchar)            
    END --Else             
    
     IF @PLEDGE_QTY = 0    
     BEGIN    
      BREAK    
     END    
    
     SET @COUNTER_CLI=@COUNTER_CLI - 1    
    END --@COUNTER_CLI            
    
    DROP TABLE #PARTY_PLEDGE    
    
    IF @COUNTER_CLI = 0    
    BEGIN    
     SET @PLEDGE_QTY=0    
    END    
   END    
    
   SET @COUNTER=@COUNTER - 1    
  END    
    
  ALTER TABLE #Tbl_Party_Pledged_Data_BankWise    
   ADD Od_utilization DECIMAL(24, 8)    
    
  ALTER TABLE #Tbl_Party_Pledged_Data_BankWise    
   ADD Pledge_value DECIMAL(24, 8)    
    
  UPDATE #Tbl_Party_Pledged_Data_BankWise    
  SET    Pledge_value = Pledge_qty * Avg_closing    
    
  SELECT Bank_code,Pledge_value=Cast(Sum(Pledge_qty * Avg_closing)AS DECIMAL(24, 8)),
  Odutilization=Cast(0 AS DECIMAL(24,8)),
  Odperc=Cast(0 AS DECIMAL(24, 8))    
  INTO   #ODUtilization    
  FROM   #Tbl_Party_Pledged_Data_BankWise    
  GROUP  BY Bank_code    
    
  UPDATE #ODUtilization    
  SET    Odutilization = A.ODUtilization,Odperc = A.ODUtilization / Pledge_value    
  FROM   General.dbo.Tbl_las_bank_master A (nolock)    
  WHERE  A.Bank_Code = #odutilization.Bank_code    
         AND A.Active_Inactive = 1    
    
  UPDATE #Tbl_Party_Pledged_Data_BankWise    
  SET    Od_utilization = #tbl_party_pledged_data_bankwise.Pledge_value * A.ODPerc    
  FROM   #ODUtilization A (nolock)    
  WHERE  A.Bank_Code = #tbl_party_pledged_data_bankwise.Bank_code    
    
  INSERT INTO Tbl_party_pledged_bankwise_data_log    
   SELECT *,Logdate=Getdate()    
   FROM   Tbl_party_pledged_bankwise_data    
   WHERE  Processdate >= CONVERT(VARCHAR, @PRO_DATE, 106)    
          AND Processdate <= CONVERT(VARCHAR, @PRO_DATE, 106) + ' 23:59:59'    
    
  DELETE FROM Tbl_party_pledged_bankwise_data    
  WHERE  Processdate >= CONVERT(VARCHAR, @PRO_DATE, 106)    
         AND Processdate <= CONVERT(VARCHAR, @PRO_DATE, 106) + ' 23:59:59'    
    
  INSERT INTO Tbl_party_pledged_bankwise_data    
   SELECT Rms_date,Ledger_bal,Party_code,Isin,Scrip_cd,Scripname,Accno,Qty,Pledge_qty,Avg_closing,    
          Bank_code    
          ,    
          Pledge_value,Od_utilization,Processdate    
   FROM   #Tbl_Party_Pledged_Data_BankWise    
 END    
    
 SET nocount OFF;    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_bankwise_allocation_26112014
-- --------------------------------------------------
CREATE PROCEDURE Usp_las_pledge_bankwise_allocation_26112014  
AS  
BEGIN  
 SET nocount ON;  
  
 IF NOT EXISTS  
        (SELECT Hdate  
         FROM   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)  
         WHERE  CONVERT(DATETIME, CONVERT(VARCHAR, Hdate, 106)) = CONVERT(DATETIME,  
                                                                  CONVERT(VARCHAR, Getdate(  
                                                                  ),  
                                                                  106)))  
 BEGIN  
  --drop table #Party_Pledged_Data          
  DECLARE @PRO_DATE DATETIME  
  
  SELECT @PRO_DATE = Max(CONVERT(VARCHAR, Processdate, 106))  
  FROM   Tbl_party_pledge_data A(NOLOCK)  
  
  SELECT Party_row_num=IDENTITY(Int, 1, 1),*,Bank_code=0,Bank_allocated_qty=Cast(0 AS INT)  
  INTO   #Party_Pledged_Data  
  FROM   Tbl_party_pledge_data A(NOLOCK)  
  WHERE  Pledge_qty > 0  
  
  --and isin='INE220B01022'           
  --and Accno='1203320000000051'          
  CREATE CLUSTERED INDEX [IX_PARTY_PLEDGE_PARTYCODE_ISIN]  
   ON #Party_Pledged_Data ( [Isin] ASC, [Party_code] ASC )  
   WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [PRIMARY]  
  
  --drop table #PLEDGE_REQUEST          
  SELECT Isin,Pledgor_bo_id=Clientid,Pledge_qty=Cast(Sum(Pledgeqty - Unpledgeqty) AS INT),  
         Pledg_value=Cast (Sum(0)  
                     AS MONEY),Pledgee_bo_id=Bankid,Bank_code=Cast (Sum(0)AS INT),Bank_priority=  
                                                                                  Cast (Sum(0)AS INT),  
         Allocated_qty=Cast (Sum(0)AS INT)  
  INTO   #PLEDGE_REQUEST  
  FROM   mis.demat.dbo.Pledge2releaseentry A(NOLOCK)  
  WHERE  EXISTS  
         (SELECT B.Accno  
          FROM   Tbl_las_account_master B WITH(NOLOCK)  
          WHERE  B.Active_inactive = 1  
                 AND A.Clientid = B.Accno)  
  GROUP  BY Isin,Clientid,Bankid  
  
  UPDATE #PLEDGE_REQUEST  
  SET    Bank_code = M.Bank_code,Bank_priority = M.Priority  
  FROM   General.dbo.Vw_las_comb_bank_agreeement_mast M WITH(nolock)  
  WHERE  #pledge_request.Pledgee_bo_id = M.Pledgee_bo_id  
         AND #pledge_request.Pledgor_bo_id = M.Pledgor_bo_id  
         AND M.Active_Inactive = 1  
  
  --drop table #LAS_PLEDGE_REQUEST               
  SELECT Row_num=IDENTITY(Int, 1, 1),*  
  INTO   #LAS_PLEDGE_REQUEST  
  FROM   #PLEDGE_REQUEST  
  ORDER  BY Bank_priority DESC  
  
  CREATE CLUSTERED INDEX [IX_LAS_PLEDGE_ROW_NUM]  
   ON #LAS_PLEDGE_REQUEST ( [Isin] ASC, [Row_num] ASC )  
   WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [PRIMARY]  
  
  --drop table #Tbl_Party_Pledged_Data_BankWise          
  --update #Party_Pledged_Data set Bank_code=0,Bank_Allocated_Qty=0             
  --update #LAS_PLEDGE_REQUEST set Allocated_qty=0           
  SELECT TOP 0 Rms_date,Ledger_bal=Cast(0 AS MONEY),Party_code,Isin,Scrip_cd,Scripname,Accno,Qty,  
               Pledge_qty,Avg_closing,  
               Bank_code=Cast (0 AS INT),Processdate,Bank_allocated_qty  
  INTO   #Tbl_Party_Pledged_Data_BankWise  
  FROM   #Party_Pledged_Data  
  
  ----VARIABLE BANK LEVEL           
  DECLARE @ISIN         VARCHAR(20),  
          @PLEDGOR_BOID VARCHAR(20),  
          @PLEDGE_QTY   INT,  
          @PLEDG_VALUE  MONEY,  
          @COUNTER      INT,  
          @BANK_CODE    INT  
  
  ----VARIABLE CLIENT LEVEL              
  DECLARE @ISIN_CLI           VARCHAR(20),  
          @PLEDGOR_BOID_CLI   VARCHAR(20),  
          @PLEDGE_QTY_CLI     INT,  
          @DIFFPLEDGE_QTY_CLI INT,  
          @PLEDG_VALUE_CLI    MONEY,  
          @COUNTER_CLI        INT,  
          @PARTY_CODE         VARCHAR(20),  
          @SCRIP_PRIORITY_CLI INT,  
          @BANK_CODE_CLI      INT,  
          @PARTY_ROW_NUM      INT  
  
  SET nocount ON  
  
  SELECT @COUNTER = Max(Row_num)  
  FROM   #LAS_PLEDGE_REQUEST  
  
  WHILE @COUNTER > 0  
  BEGIN  
   SELECT @ISIN = Isin,@PLEDGOR_BOID = Pledgor_bo_id,@PLEDGE_QTY = Pledge_qty - Allocated_qty,  
          @BANK_CODE = Bank_code  
   FROM   #LAS_PLEDGE_REQUEST  
   WHERE  Row_num = @COUNTER  
  
   WHILE @PLEDGE_QTY > 0  
   BEGIN  
    --print 'ISIN : '+@ISIN             
    --print 'COUNTER  : '+Cast(@COUNTER  as varchar)+' Pledge_qty:'+ Cast(@Pledge_qty as varchar)           
    --print 'ISIN : '+@ISIN +' PLEDGOR_BOID: '+ @PLEDGOR_BOID +' Pledge_qty:'+ Cast(@Pledge_qty as varchar)          
    SELECT Row_num=Row_number() OVER(ORDER BY Party_code),Party_row_num,Rms_date,Party_code,Isin,Scrip_cd  
           ,  
           Scripname,  
           Accno,Qty,Pledge_qty,Avg_closing,Bank_code,Processdate,Bank_allocated_qty,Ledger_bal  
    INTO   #PARTY_PLEDGE  
    FROM   #Party_Pledged_Data  
    WHERE  Isin = @ISIN  
           AND Accno = @PLEDGOR_BOID  
           AND Pledge_qty - Bank_allocated_qty > 0  
    ORDER  BY Ledger_bal DESC  
  
    SELECT @COUNTER_CLI = Isnull(Max(Row_num), 0)  
    FROM   #PARTY_PLEDGE  
  
    WHILE @COUNTER_CLI > 0  
    BEGIN  
     SELECT @PLEDGOR_BOID_CLI = Accno,@PARTY_CODE = Party_code,@PLEDGE_QTY_CLI =  
                                                               Pledge_qty - Bank_allocated_qty,  
            @ISIN_CLI = Isin,@PARTY_ROW_NUM = Party_row_num  
     FROM   #PARTY_PLEDGE  
     WHERE  Row_num = @COUNTER_CLI  
  
     --print 'ISIN : '+@ISIN_Cli +' PARTY_CODE: '+ @PARTY_CODE +' Pledge_qty:'+ Cast(@Pledge_qty_CLI as varchar)          
     IF @PLEDGE_QTY_CLI <= @PLEDGE_QTY  
     BEGIN  
      --print 'ISIN : '+@ISIN_Cli +' PLEDGOR_BOID: '+ @PLEDGOR_BOID_CLI +' Party_code:'+ Cast(@Party_code as varchar)          
      INSERT INTO #Tbl_Party_Pledged_Data_BankWise  
       SELECT Rms_date,Ledger_bal,Party_code,Isin,Scrip_cd,Scripname,Accno,Qty,  
       Pledge_qty=Pledge_qty- Bank_allocated_qty,Avg_closing,@BANK_CODE,  
       Processdate,Bank_allocated_qty=@PLEDGE_QTY_CLI  
    FROM   #PARTY_PLEDGE  
    WHERE  Accno = @PLEDGOR_BOID_CLI  
    AND Party_code = @PARTY_CODE  
    AND Isin = @ISIN_CLI  
    AND Row_num = @COUNTER_CLI  
  
    UPDATE #Party_Pledged_Data  
    SET    Bank_code = @BANK_CODE,Bank_allocated_qty = Bank_allocated_qty + @PLEDGE_QTY_CLI  
    WHERE  Accno = @PLEDGOR_BOID_CLI  
    AND Party_code = @PARTY_CODE  
    AND Isin = @ISIN_CLI  
    AND Party_row_num = @PARTY_ROW_NUM  
  
    UPDATE #LAS_PLEDGE_REQUEST  
    SET    Allocated_qty = Allocated_qty + @PLEDGE_QTY_CLI  
    WHERE  Pledgor_bo_id = @PLEDGOR_BOID_CLI  
    AND Bank_code = @BANK_CODE  
    AND Isin = @ISIN_CLI  
    AND Row_num = @COUNTER  
  
    SET @PLEDGE_QTY=@PLEDGE_QTY - @PLEDGE_QTY_CLI  
    --print 'if  ISIN : '+@ISIN_Cli +' PARTY_CODE: '+ @PARTY_CODE +' Pledge_qty:'+ Cast(@Pledge_qty as varchar)          
    END --If @Pledge_qty_CLI<=@Pledge_qty          
    ELSE  
    BEGIN  
    INSERT INTO #Tbl_Party_Pledged_Data_BankWise  
    SELECT Rms_date,Ledger_bal,Party_code,Isin,Scrip_cd,Scripname,Accno,Qty,Pledge_qty=@PLEDGE_QTY,  
    Avg_closing,  
    @BANK_CODE,Processdate,Bank_allocated_qty=@PLEDGE_QTY  
    FROM   #PARTY_PLEDGE  
    WHERE  Accno = @PLEDGOR_BOID_CLI  
    AND Party_code = @PARTY_CODE  
    AND Isin = @ISIN_CLI  
    AND Row_num = @COUNTER_CLI  
  
    UPDATE #Party_Pledged_Data  
    SET    Bank_code = @BANK_CODE,Bank_allocated_qty = Bank_allocated_qty + @PLEDGE_QTY  
    WHERE  Accno = @PLEDGOR_BOID_CLI  
    AND Party_code = @PARTY_CODE  
    AND Isin = @ISIN_CLI  
    AND Party_row_num = @PARTY_ROW_NUM  
  
    UPDATE #LAS_PLEDGE_REQUEST  
    SET    Allocated_qty = Allocated_qty + @PLEDGE_QTY  
    WHERE  Pledgor_bo_id = @PLEDGOR_BOID_CLI  
    AND Bank_code = @BANK_CODE  
    AND Isin = @ISIN_CLI  
    AND Row_num = @COUNTER  
  
    SET @PLEDGE_QTY=0  
    --print 'Else: ISIN : '+@ISIN_Cli +' PARTY_CODE: '+ @PARTY_CODE +' Pledge_qty:'+ Cast(@Pledge_qty as varchar)          
    END --Else           
  
     IF @PLEDGE_QTY = 0  
     BEGIN  
      BREAK  
     END  
  
     SET @COUNTER_CLI=@COUNTER_CLI - 1  
    END --@COUNTER_CLI          
  
    DROP TABLE #PARTY_PLEDGE  
  
    IF @COUNTER_CLI = 0  
    BEGIN  
     SET @PLEDGE_QTY=0  
    END  
   END  
  
   SET @COUNTER=@COUNTER - 1  
  END  
  
  ALTER TABLE #Tbl_Party_Pledged_Data_BankWise  
   ADD Od_utilization DECIMAL(24, 8)  
  
  ALTER TABLE #Tbl_Party_Pledged_Data_BankWise  
   ADD Pledge_value DECIMAL(24, 8)  
  
  UPDATE #Tbl_Party_Pledged_Data_BankWise  
  SET    Pledge_value = Pledge_qty * Avg_closing  
  
  SELECT Bank_code,Pledge_value=Cast(Sum(Pledge_qty * Avg_closing)AS DECIMAL(24, 8)),Odutilization=  
                                                                                     Cast(0 AS DECIMAL(24  
                                                                                               ,  
                                                                                               8)),Odperc  
         =  
         Cast(0 AS DECIMAL(24, 8))  
  INTO   #ODUtilization  
  FROM   #Tbl_Party_Pledged_Data_BankWise  
  GROUP  BY Bank_code  
  
  UPDATE #ODUtilization  
  SET    Odutilization = A.ODUtilization,Odperc = A.ODUtilization / Pledge_value  
  FROM   General.dbo.Tbl_las_bank_master A (nolock)  
  WHERE  A.Bank_Code = #odutilization.Bank_code  
         AND A.Active_Inactive = 1  
  
  UPDATE #Tbl_Party_Pledged_Data_BankWise  
  SET    Od_utilization = #tbl_party_pledged_data_bankwise.Pledge_value * A.ODPerc  
  FROM   #ODUtilization A (nolock)  
  WHERE  A.Bank_Code = #tbl_party_pledged_data_bankwise.Bank_code  
  
  INSERT INTO Tbl_party_pledged_bankwise_data_log  
   SELECT *,Logdate=Getdate()  
   FROM   Tbl_party_pledged_bankwise_data  
   WHERE  Processdate >= CONVERT(VARCHAR, @PRO_DATE, 106)  
          AND Processdate <= CONVERT(VARCHAR, @PRO_DATE, 106) + ' 23:59:59'  
  
  DELETE FROM Tbl_party_pledged_bankwise_data  
  WHERE  Processdate >= CONVERT(VARCHAR, @PRO_DATE, 106)  
         AND Processdate <= CONVERT(VARCHAR, @PRO_DATE, 106) + ' 23:59:59'  
  
  INSERT INTO Tbl_party_pledged_bankwise_data  
   SELECT Rms_date,Ledger_bal,Party_code,Isin,Scrip_cd,Scripname,Accno,Qty,Pledge_qty,Avg_closing,  
          Bank_code  
          ,  
          Pledge_value,Od_utilization,Processdate  
   FROM   #Tbl_Party_Pledged_Data_BankWise  
 END  
  
 SET nocount OFF;  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_bankwise_allocation_recalculate
-- --------------------------------------------------
CREATE PROCEDURE Usp_las_pledge_bankwise_allocation_recalculate(@PRO_DATE DATETIME)    
--(@PROcess_DATE DATETIME)    
AS    
  BEGIN    
      SET nocount ON;    
    
      IF NOT EXISTS (SELECT Hdate    
                     FROM   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)    
                     WHERE  CONVERT(DATETIME, CONVERT(VARCHAR, Hdate, 106)) = CONVERT(DATETIME, CONVERT(VARCHAR, Getdate(), 106)))    
        BEGIN    
                
            --drop table #Party_Pledged_Data              
            /*    
            DECLARE @PRO_DATE DATETIME    
                
            SELECT @PRO_DATE = Max(CONVERT(VARCHAR, Processdate, 106))      
            FROM   Tbl_party_pledge_data_log A(NOLOCK)    
            where Processdate < @PROcess_DATE    
                
            print @PRO_DATE    
            */    
                
            SELECT Party_row_num=IDENTITY(Int, 1, 1),    
                   *,    
                   Bank_code=0,    
                   Bank_allocated_qty=Cast(0 AS INT)    
            INTO   #Party_Pledged_Data    
            --FROM   Tbl_party_pledge_data A(NOLOCK)      
            FROM   Tbl_party_pledge_data_log A(NOLOCK)    
            WHERE  Pledge_qty > 0    
                   AND A.Processdate >= @PRO_DATE    
                   AND A.Processdate <= @PRO_DATE + ' 23:59:59'    
    
            --and isin='INE220B01022'               
            --and Accno='1203320000000051'              
            CREATE CLUSTERED INDEX [IX_PARTY_PLEDGE_PARTYCODE_ISIN]    
              ON #Party_Pledged_Data ( [Isin] ASC, [Party_code] ASC )    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [PRIMARY]    
    
            --drop table #PLEDGE_REQUEST              
            SELECT Isin,    
                   Pledgor_bo_id=Clientid,    
                   Pledge_qty=Cast(Sum(Pledgeqty - Unpledgeqty) AS INT),    
                   Pledg_value=Cast (Sum(0) AS MONEY),    
                   Pledgee_bo_id=Bankid,    
                   Bank_code=Cast (Sum(0)AS INT),    
                   Bank_priority= Cast (Sum(0)AS INT),    
                   Allocated_qty=Cast (Sum(0)AS INT)    
            INTO   #PLEDGE_REQUEST    
            FROM   mis.demat.dbo.Pledge2releaseentry_hist A(NOLOCK)      
            --FROM   PLEDGE_TO_RELEASE_HIST A(NOLOCK)      
            WHERE  LOG_DATETIME BETWEEN (@PRO_DATE + 1)  AND ( @PRO_DATE + 1) + ' 23:59:59'    
                   AND EXISTS (SELECT B.Accno    
                               FROM   Tbl_las_account_master B WITH(NOLOCK)    
                               WHERE  B.Active_inactive = 1    
                                      AND A.Clientid = B.Accno)    
            GROUP  BY Isin,    
                      Clientid,    
                      Bankid    
    
            UPDATE #PLEDGE_REQUEST    
            SET    Bank_code = M.Bank_code,    
                   Bank_priority = M.Priority    
            FROM   General.dbo.Vw_las_comb_bank_agreeement_mast M WITH(nolock)    
            WHERE  #pledge_request.Pledgee_bo_id = M.Pledgee_bo_id    
                   AND #pledge_request.Pledgor_bo_id = M.Pledgor_bo_id    
                   AND M.Active_Inactive = 1    
                   
                     
DELETE FROM  #PLEDGE_REQUEST WHERE BANK_CODE=0  
    
            --drop table #LAS_PLEDGE_REQUEST                   
            SELECT Row_num=IDENTITY(Int, 1, 1),*    
            INTO   #LAS_PLEDGE_REQUEST    
            FROM   #PLEDGE_REQUEST    
            ORDER  BY Bank_priority DESC    
    
            CREATE CLUSTERED INDEX [IX_LAS_PLEDGE_ROW_NUM]    
              ON #LAS_PLEDGE_REQUEST ( [Isin] ASC, [Row_num] ASC )    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [PRIMARY]    
    
            --drop table #Tbl_Party_Pledged_Data_BankWise              
            --update #Party_Pledged_Data set Bank_code=0,Bank_Allocated_Qty=0                 
            --update #LAS_PLEDGE_REQUEST set Allocated_qty=0               
            SELECT TOP 0 Rms_date,    
            Ledger_bal=Cast(0 AS MONEY),    
                         Party_code,    
                         Isin,    
                         Scrip_cd,    
      Scripname,    
                         Accno,    
                         Qty,    
                         Pledge_qty,    
                         Avg_closing,    
                         Bank_code=Cast (0 AS INT),    
                         Processdate,    
                         Bank_allocated_qty    
            INTO   #Tbl_Party_Pledged_Data_BankWise    
            FROM   #Party_Pledged_Data    
    
            ----VARIABLE BANK LEVEL               
            DECLARE @ISIN         VARCHAR(20),    
                    @PLEDGOR_BOID VARCHAR(20),    
                    @PLEDGE_QTY   INT,    
                    @PLEDG_VALUE  MONEY,    
                    @COUNTER      INT,    
                    @BANK_CODE    INT    
                
            ----VARIABLE CLIENT LEVEL                  
            DECLARE @ISIN_CLI           VARCHAR(20),    
                    @PLEDGOR_BOID_CLI   VARCHAR(20),    
                    @PLEDGE_QTY_CLI     INT,    
                    @DIFFPLEDGE_QTY_CLI INT,    
                    @PLEDG_VALUE_CLI    MONEY,    
                    @COUNTER_CLI        INT,    
                    @PARTY_CODE         VARCHAR(20),    
                    @SCRIP_PRIORITY_CLI INT,    
                    @BANK_CODE_CLI      INT,    
                    @PARTY_ROW_NUM      INT    
    
            SET nocount ON    
    
            SELECT @COUNTER = Max(Row_num)    
            FROM   #LAS_PLEDGE_REQUEST    
    
            WHILE @COUNTER > 0    
              BEGIN    
                  SELECT @ISIN = Isin,    
                         @PLEDGOR_BOID = Pledgor_bo_id,    
                         @PLEDGE_QTY = Pledge_qty - Allocated_qty,    
                         @BANK_CODE = Bank_code    
                  FROM   #LAS_PLEDGE_REQUEST    
                  WHERE  Row_num = @COUNTER    
    
                  WHILE @PLEDGE_QTY > 0    
                    BEGIN    
                        --print 'ISIN : '+@ISIN                 
                        --print 'COUNTER  : '+Cast(@COUNTER  as varchar)+' Pledge_qty:'+ Cast(@Pledge_qty as varchar)               
                        --print 'ISIN : '+@ISIN +' PLEDGOR_BOID: '+ @PLEDGOR_BOID +' Pledge_qty:'+ Cast(@Pledge_qty as varchar)              
                        SELECT Row_num=Row_number() OVER(ORDER BY Party_code),    
                               Party_row_num,    
                               Rms_date,    
                               Party_code,    
                               Isin,    
                               Scrip_cd,    
                               Scripname,    
                               Accno,    
                               Qty,    
                               Pledge_qty,    
                               Avg_closing,    
                               Bank_code,    
                               Processdate,    
                               Bank_allocated_qty,    
                               Ledger_bal    
                        INTO   #PARTY_PLEDGE    
                        FROM   #Party_Pledged_Data    
                        WHERE  Isin = @ISIN    
                               AND Accno = @PLEDGOR_BOID    
                               AND Pledge_qty - Bank_allocated_qty > 0    
                        ORDER  BY Ledger_bal DESC    
    
                        SELECT @COUNTER_CLI = Isnull(Max(Row_num), 0)    
                        FROM   #PARTY_PLEDGE    
    
                        WHILE @COUNTER_CLI > 0    
                          BEGIN    
                              SELECT @PLEDGOR_BOID_CLI = Accno,    
                                     @PARTY_CODE = Party_code,    
                                     @PLEDGE_QTY_CLI = Pledge_qty - Bank_allocated_qty,    
                                     @ISIN_CLI = Isin,    
                                     @PARTY_ROW_NUM = Party_row_num    
                            FROM   #PARTY_PLEDGE    
                              WHERE  Row_num = @COUNTER_CLI    
    
                              --print 'ISIN : '+@ISIN_Cli +' PARTY_CODE: '+ @PARTY_CODE +' Pledge_qty:'+ Cast(@Pledge_qty_CLI as varchar)              
                              IF @PLEDGE_QTY_CLI <= @PLEDGE_QTY    
                                BEGIN    
                                    --print 'ISIN : '+@ISIN_Cli +' PLEDGOR_BOID: '+ @PLEDGOR_BOID_CLI +' Party_code:'+ Cast(@Party_code as varchar)              
                                    INSERT INTO #Tbl_Party_Pledged_Data_BankWise    
                                    SELECT Rms_date,    
                                           Ledger_bal,    
                                           Party_code,    
                                           Isin,    
                                           Scrip_cd,    
                                           Scripname,    
                                           Accno,    
                                           Qty,    
                                           Pledge_qty=Pledge_qty - Bank_allocated_qty,    
                                           Avg_closing,    
                                           @BANK_CODE,    
                                           Processdate,    
                                           Bank_allocated_qty=@PLEDGE_QTY_CLI    
                                    FROM   #PARTY_PLEDGE    
                                    WHERE  Accno = @PLEDGOR_BOID_CLI    
                                           AND Party_code = @PARTY_CODE    
                                           AND Isin = @ISIN_CLI    
                                           AND Row_num = @COUNTER_CLI    
    
                                    UPDATE #Party_Pledged_Data    
                                    SET    Bank_code = @BANK_CODE,    
                                           Bank_allocated_qty = Bank_allocated_qty + @PLEDGE_QTY_CLI    
                                    WHERE  Accno = @PLEDGOR_BOID_CLI    
                                           AND Party_code = @PARTY_CODE    
                                           AND Isin = @ISIN_CLI    
                                           AND Party_row_num = @PARTY_ROW_NUM    
    
                                    UPDATE #LAS_PLEDGE_REQUEST    
                                    SET    Allocated_qty = Allocated_qty + @PLEDGE_QTY_CLI    
                                    WHERE  Pledgor_bo_id = @PLEDGOR_BOID_CLI    
                                           AND Bank_code = @BANK_CODE    
                                           AND Isin = @ISIN_CLI    
                                           AND Row_num = @COUNTER    
    
                                    SET @PLEDGE_QTY=@PLEDGE_QTY - @PLEDGE_QTY_CLI    
                                --print 'if  ISIN : '+@ISIN_Cli +' PARTY_CODE: '+ @PARTY_CODE +' Pledge_qty:'+ Cast(@Pledge_qty as varchar)              
                                END --If @Pledge_qty_CLI<=@Pledge_qty              
                              ELSE    
                                BEGIN    
                                    INSERT INTO #Tbl_Party_Pledged_Data_BankWise    
                                    SELECT Rms_date,    
                                           Ledger_bal,    
                                           Party_code,    
                                           Isin,    
                                           Scrip_cd,    
                                           Scripname,    
                                           Accno,    
                                           Qty,    
                                           Pledge_qty=@PLEDGE_QTY,    
                                           Avg_closing,    
                                           @BANK_CODE,    
                                           Processdate,    
                                           Bank_allocated_qty=@PLEDGE_QTY   
                                    FROM   #PARTY_PLEDGE    
                                    WHERE  Accno = @PLEDGOR_BOID_CLI    
                                           AND Party_code = @PARTY_CODE    
                                           AND Isin = @ISIN_CLI    
                                           AND Row_num = @COUNTER_CLI    
    
                                    UPDATE #Party_Pledged_Data    
                                    SET    Bank_code = @BANK_CODE,    
                                           Bank_allocated_qty = Bank_allocated_qty + @PLEDGE_QTY    
                                    WHERE  Accno = @PLEDGOR_BOID_CLI    
                                           AND Party_code = @PARTY_CODE    
                                           AND Isin = @ISIN_CLI    
                                           AND Party_row_num = @PARTY_ROW_NUM    
    
                                    UPDATE #LAS_PLEDGE_REQUEST    
                                    SET    Allocated_qty = Allocated_qty + @PLEDGE_QTY    
                                    WHERE  Pledgor_bo_id = @PLEDGOR_BOID_CLI    
                                           AND Bank_code = @BANK_CODE    
                                           AND Isin = @ISIN_CLI    
                                           AND Row_num = @COUNTER    
    
                                    SET @PLEDGE_QTY=0    
                                --print 'Else: ISIN : '+@ISIN_Cli +' PARTY_CODE: '+ @PARTY_CODE +' Pledge_qty:'+ Cast(@Pledge_qty as varchar)              
                                END --Else               
                              IF @PLEDGE_QTY = 0    
                                BEGIN    
                                    BREAK    
                                END    
    
                              SET @COUNTER_CLI=@COUNTER_CLI - 1    
                          END --@COUNTER_CLI              
                        DROP TABLE #PARTY_PLEDGE    
    
                        IF @COUNTER_CLI = 0    
                          BEGIN    
                              SET @PLEDGE_QTY=0    
                          END    
                    END    
    
                  SET @COUNTER=@COUNTER - 1    
              END    
    
            ALTER TABLE #Tbl_Party_Pledged_Data_BankWise    
              ADD Od_utilization DECIMAL(24, 8)    
    
            ALTER TABLE #Tbl_Party_Pledged_Data_BankWise    
              ADD Pledge_value DECIMAL(24, 8)    
    
            UPDATE #Tbl_Party_Pledged_Data_BankWise    
            SET    Pledge_value = Pledge_qty * Avg_closing    
    
            SELECT Bank_code,    
                   Pledge_value=Cast(Sum(Pledge_qty * Avg_closing)AS DECIMAL(24, 8)),    
                   Odutilization= Cast(0 AS DECIMAL(24, 8)),    
                   Odperc = Cast(0 AS DECIMAL(24, 8))    
            INTO   #ODUtilization    
            FROM   #Tbl_Party_Pledged_Data_BankWise    
            GROUP  BY Bank_code    
    
            UPDATE #ODUtilization    
            SET    Odutilization = A.ODUtilization,    
                   Odperc = A.ODUtilization / Pledge_value    
            FROM   General.dbo.Tbl_las_bank_master A (nolock)    
            WHERE  A.Bank_Code = #odutilization.Bank_code    
                   AND A.Active_Inactive = 1    
    
            UPDATE #Tbl_Party_Pledged_Data_BankWise    
            SET    Od_utilization = #tbl_party_pledged_data_bankwise.Pledge_value * A.ODPerc    
            FROM   #ODUtilization A (nolock)    
            WHERE  A.Bank_Code = #tbl_party_pledged_data_bankwise.Bank_code    
    
            /*    
             INSERT INTO Tbl_party_pledged_bankwise_data_log    
             SELECT *,Logdate=Getdate()      
             FROM   Tbl_party_pledged_bankwise_data      
             WHERE  Processdate >= CONVERT(VARCHAR, @PRO_DATE, 106)      
                    AND Processdate <= CONVERT(VARCHAR, @PRO_DATE, 106) + ' 23:59:59'      
            */    
            --DELETE FROM Tbl_party_pledged_bankwise_data_RESTORE 
            DELETE FROM Tbl_party_pledged_bankwise_data  
            WHERE  Processdate >= CONVERT(VARCHAR, @PRO_DATE, 106)    
                   AND Processdate <= CONVERT(VARCHAR, @PRO_DATE, 106) + ' 23:59:59'    
    
    /*
            INSERT INTO Tbl_party_pledged_bankwise_data_RESTORE    
            SELECT Rms_date,    
                   Ledger_bal,    
                   Party_code,    
                   Isin,    
                   Scrip_cd,    
                   Scripname,    
                   Accno,    
                   Qty,    
                   Pledge_qty,    
                   Avg_closing,    
                   Bank_code,    
                   Pledge_value,    
					Od_utilization,    
                   Processdate,    
                   Logdate=Getdate()                       
            FROM   #Tbl_Party_Pledged_Data_BankWise    
            */
              INSERT INTO Tbl_party_pledged_bankwise_data    
		 SELECT Rms_date,Ledger_bal,Party_code,Isin,Scrip_cd,Scripname,Accno,Qty,Pledge_qty,Avg_closing,    
          Bank_code    
          ,    
          Pledge_value,Od_utilization,Processdate    
   FROM   #Tbl_Party_Pledged_Data_BankWise 
        END    
    
      SET nocount OFF;    
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_client_holding
-- --------------------------------------------------

/*    
    CHANGE ID  :: 1    
    MODIFIED BY  :: PRASHANT    
    MODIFIED DATE :: AUG 03 2013    
    REASON   :: NOT TO PLEDGE SHARES OF WCL CLIENT    
    REQUEST FROM :: RAHUL SIR    
    PRMS ID   :: NONE  
    
    Changes: There is changes has been Done on 29 Jun 2018 by Rohit Patil after discussion with Anil Wandre.
			 Now on wards SP will consider the Co_code MCX and NCDEX	  
*/    
--[Usp_las_pledge_client_holding] 'System'
CREATE Procedure [dbo].[Usp_las_pledge_client_holding]    
(          
 @USERNAME Varchar(10)          
)          
As          
Begin          
   Set NOCOUNT On          
          
   If Not Exists (Select Hdate          
                  From   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)          
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))          
   Begin          
      Declare @LastProc_Date As Datetime          
          
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)          
      From   Tbl_party_pledge_data (nolock)          
  
      /*  
      --Changing the condition to not consider unreco credit  
      --Change by: Renil  
      --Changed on: Dec 03 2014  
      --Change Request by: Rahul C shah  
      */  
      Select Party_code,          
             Co_code,          
             Convert(Money, 0) As Ledger,
             Convert(Money, 0) As [98Series],             
             Imargin,          
             Cash_colleteral,          
             Noncash_colleteral,          
             Unrecosiled_credit=0.00          
      Into   #NET_AVAILABLE_PARTY          
      From   General.dbo.Rms_dtclfi With(NOLOCK)          
      /* Where  Co_code Not In ('MCX', 'NCDEX') */ /* Condition is commented on 29 June 2018 */        
          
      Declare @ACCOPENINGDATE   As Varchar(11),          
              @EXCLUDEOPBALDATE As Varchar(11)          
          
      Select @ACCOPENINGDATE = '04-01-' + Convert(Varchar, Case          
                                                            When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('JAN', 'FEB', 'MAR') Then Datepart(YY, Getdate()) - 2          
                                                            Else Datepart(YY, Getdate()) - 1          
                                                           End),          
             @EXCLUDEOPBALDATE = (Case          
                                   When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('APR') Then '01-01-' + Convert(Varchar, Datepart(YY, Getdate()))          
                                   Else '01-01-1900'          
                                  End)          
          
      --Set @ACCOPENINGDATE='Apr 01 2010'    
      /*  
      --Changing the condition of effective from getdate()-1 to getdate() to consider todays bill posting  
      --Change by: Renil  
      --Changed on: Dec 03 2014  
      --Change Request by: Rahul C shah  
      */        
       
      /***************[98Series] Added by neha naiwar on 18 Jun 2019 as per mail of Anil Wndre************************************/ 
      Update A          
      Set    [98Series] = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Bsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'  and  Cltcode like '98%'            
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = REPLACE(B.Cltcode, '98', '')          
      Where  Co_code = 'BSECM'  
      
      Update A          
      Set    [98Series] =  [98Series] + Isnull(Bal, 0)           
      From   #NET_AVAILABLE_PARTY A          
            Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'   and  Cltcode like '98%'             
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                    Else Vamt          
                                          End) <> 0) B          
              On A.Party_code =  REPLACE(B.Cltcode, '98', '')       
      Where  Co_code = 'NSECM'   
      /***********************************************************************************************************************/    
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Bsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'BSECM'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
            Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                    Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSECM'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsefo_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSEFO'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Mcd_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MCD'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsx_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSX'      
      
      
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                              /* From   anand1.MTFTrade.dbo.ledger With(NOLOCK)          */  /*****Commented on 17 May 2018 by neha**********/
                              From   General.dbo.MTF_CLedger With(NOLOCK)   
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MTF'      
      
      /*********start*************Added by Neha Naiwar on 01 Feb2019 As per Anil W mail**********************************/    
          Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.MCX_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MCX'       
      
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.NCDEX_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NCDEX'  
      /*************End***********************************************************************************************/    
      
      Select Party_code,          
             Ledger=Sum(Ledger+[98Series]),  
             [98Series]=Sum([98Series]),         
             Imargin=Sum(Imargin),          
             Cash_colleteral=Sum(Cash_colleteral),          
             Noncash_colleteral=Sum(Noncash_colleteral),          
             Unrecosiled_credit=Sum(Unrecosiled_credit),          
             Samargin=Convert(Money, 0.0),          
           Varmargin=Convert(Money, 0.0),          
             Co_code          
      Into   #NET_AVAILABLE          
      From   #NET_AVAILABLE_PARTY (nolock)          
      Group  By Party_code,Co_code          
          
      /*------------------------------------          
      SPAN AND ADDITIONAL MARGIN          
      SEGMENT NSEFO,MCDXCDS,NSECURFO ONLY          
      ---------------------------------------*/          
      Select Party_code,          
             Initialmargin=Sum(Initialmargin),          
             Addmargin=Sum(Addmargin),          
             Co_code          
      Into   #SPAN_ADDI_MARGIN          
      From   Vw_derivativemargin (NOLOCK) A          
      Group  By Party_code,Co_code          
          
  ------ SPAN Margin Take 175% as per Bussines          
      ------Date 15-03-2012 SPAN Margin Take 100% only changes          
      ------**************************************          
      /*Update #NET_AVAILABLE          
      Set Samargin = (Initialmargin + Addmargin) * 1.75          
      From #SPAN_ADDI_MARGIN A          
      Where #net_available.Party_code = A.Party_code          
      And #net_available.Co_code = A.Co_code*/          
          
      Update #NET_AVAILABLE          
      Set    Samargin = (Initialmargin + Addmargin)          
      From   #SPAN_ADDI_MARGIN A          
      Where  #net_available.Party_code = A.Party_code          
             And #net_available.Co_code = A.Co_code          
          
      /*------------------------------------          
      VAR MARGIN          
      SEGMENT EQUITY (BSE & NSE) ONLY          
      ---------------------------------------*/          
      Select Party_code,          
             Varmargin=Sum(Varmargin),          
             Co_code          
      Into   #EQUITY_VAR_MARGIN          
      /*Changes Done By Rohit And Anil 24 Oct 2017 to change the Var margin logic*/
      /*From   Vw_equity_var_margin (NOLOCK) A */
      From   VW_Equity_Var_Margin_Pledge (NOLOCK) A          
      Group  By Party_code,Co_code          
          
      Update #NET_AVAILABLE          
      Set    Varmargin = (A.Varmargin)          
      From   #EQUITY_VAR_MARGIN A          
      Where  #net_available.Party_code = A.Party_code          
             And #net_available.Co_code = A.Co_code          
          
      --STEP 1          
      /*---------------------------------------------------------------          
      FETCHING CLIENTS WITH APPROVED HOLDING AND EXCLUDING CLIENTS          
      FROM TBL_CLI_NOT_FOR_PLEDGE TABLE          
      TABLE TBL_CLI_NOT_FOR_PLEDGE CONTAINS ALL CLIENTS FOR WHICH LOAN          
      HAS ALREADY BEEN TAKEN.          
      ---------------------------------------------------------------*/          
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED          
          
      Select Rms_date,          
             Party_code,          
             Convert(Money, 0)    As Net,          
             Holding_approved,        
             Convert(Smallint, 0) As Client_priority          
      Into   #TBL_CL_LIST_APPR_HOLD          
      From   GENERAL.dbo.Rms_dtclfi_summ With(NOLOCK)          
      Where  Holding_approved <> 0          
          
   /*          
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR          
   NOT TO EXLUDE NON LAS CLIENT          
   */          
      --AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK))          
          
      Update A          
      Set    Net = Isnull(Net_available, 0)          
      From   #TBL_CL_LIST_APPR_HOLD A          
             Left Outer Join (Select Party_code,          
                                     Sum(Ledger - Unrecosiled_credit - (Case          
       When (Samargin) - (Cash_colleteral + Noncash_colleteral) > 0 Then (Samargin) - (Cash_colleteral + Noncash_colleteral)          
                                                                         Else 0          
                                                                        End) - Varmargin) As Net_available          
                              From   #NET_AVAILABLE          
                              Group  By Party_code) B          
              On A.Party_code = B.Party_code          
          

		truncate table MIS_AppHld_data 
		insert into MIS_AppHld_data(Rms_date,Party_code,Net,Holding_approved,Client_priority) 
		select Rms_date,Party_code,Net,Holding_approved,Client_priority from #TBL_CL_LIST_APPR_HOLD
          
      /*CHANGE ID  :: 1*/    
      /*START CHANGE ID  :: 1*/    
      Select Party_Code    
        INTO #WCL_CLIENTS    
      from MIS.DBO.WCL_ActionRpt1(convert(datetime,GETDATE(),103))    
      where BOI+YES+SCB+ADH+AXS+HDF+KOT+IDF <> 0.00    
      
          
      update A    
        set Net = 0    
      FROM #TBL_CL_LIST_APPR_HOLD A INNER JOIN #WCL_CLIENTS B    
            ON A.Party_code = B.Party_Code    
         
     INSERT INTO PLEDGE_WCL_CLIENT_LOG(PARTY_CODE)     
     SELECT PARTY_CODE    
     FROM #WCL_CLIENTS    
         
     /*END CHANGE ID  :: 1*/    
          
      /*END*/          
      --STEP 2          
      /*---------------------------------------------------------------          
      GENERATING ROW NUMBER FOR LOOPING DEBIT CLIENTS          
      ---------------------------------------------------------------*/          
      Select *,          
             Row_number() Over(Order By Net) As Row_num          
      Into   #TBL_CL_LIST_APPR_HOLD_TMP          
      From   #TBL_CL_LIST_APPR_HOLD          
      Where  Net < 0          
      Order  By Net          
          
      --STEP 3          
      /*---------------------------------------------------------------          
      FETCHING HOLDING WHERE ACCNO <> (UNSETTLED OR EMPTY) AND          
   HOLDING VALUE <> 0          
      ---------------------------------------------------------------*/          
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED          
          
      --DROP TABLE #TBL_RMS_HOLDING_APPR_TMP          
      Select Party_code,          
             Isin,          
             Scrip_cd,          
             Sum(Qty)               As Qty,          
             Convert(Int, 0)        As Pledge_qty,          
             Convert(Int, Sum(Qty)) As Free_qty,          
             Convert(Money, 0)      As Hold_value,          
             --CONVERT( DECIMAL ( 2,2 ) , ( ( SUM( QTY*CLSRATE ) / SUM( QTY ) ) ) ) AS AVG_CLOSING,          
             Convert(Money, 0)      As Avg_closing,          
             Accno,          
             Scripname,          
             Convert(Smallint, 0)   As Scrip_priority          
      Into   #TBL_RMS_HOLDING_APPR_TMP          
      From   GENERAL.dbo.Rms_holding With(NOLOCK)          
      Where  Source = 'H'          
             And Accno In('1203320000000066', '1203320000000051','1203320009603460', '1203320000000028')          
      Group  By Party_code,Isin,Accno,Scrip_cd,Scripname          
      
      
          
   /*          
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR          
   NOT TO EXLUDE NON LAS CLIENT          
   */          
      --PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK)) AND                
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */      
      /*Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                                     '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate        
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209')*/       
            
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
              and #tbl_rms_holding_appr_tmp.Accno = A.Accno      
              
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000051'       
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin       
                    
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000066'       
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin       
                    
      --STEP 4          
      /*---------------------------------------------------------------          
      SETTING APPROVED SCRIP PRIORITY BANKS WISE          
      ---------------------------------------------------------------*/          
      Select Priority,          
             Bank_code,          
             Row_number() Over(Order By Priority) As Row_num          
      Into   #BANK_LST          
      From   GENERAL.dbo.Tbl_las_bank_master With(NOLOCK)          
      Where  Active_inactive = 1          
      Order  By Priority          
          
      Declare @BANK_CNT As Int,          
              @BANK_TTL As Int,          
              @PRIORITY As Int,          
              @BANK_CD  As Int          
          
      Select @BANK_TTL = Count(*)          
      From   #BANK_LST          
          
      Select @BANK_CNT = 1          
          
      While(@BANK_CNT <= @BANK_TTL)          
      Begin          
         Select @PRIORITY = Priority,          
                @BANK_CD = Bank_code          
         From   #BANK_LST          
   Where  Row_num = @BANK_CNT          
          
         Update #TBL_RMS_HOLDING_APPR_TMP          
         Set    Scrip_priority = @PRIORITY          
         Where  Scrip_cd In (Select Scode          
                             From   GENERAL.dbo.Vw_las_appr_bank_scrip With (NOLOCK)          
                             Where  Bank_code = @BANK_CD)          
                And Scrip_priority = 0          
          
         Set @BANK_CNT = @BANK_CNT + 1          
      End          
          
      Delete From #TBL_RMS_HOLDING_APPR_TMP          
      Where  Scrip_priority = 0          
          
      --STEP 5          
      /*-----------Add New Step For New request----------------------------------------------------          
      Clinet Pledged Priority 1st Previous Day Pleded Qty          
      ---------------------------------------------------------------*/          
      Select Party_code,          
             Isin,          
             Scrip_cd,          
             Sum(Pledge_qty)    As Qty,          
             Cast(0 As Int)     As Pledge_qty,          
             Sum(Pledge_qty)    As Free_qty,        
             Cast(0.0 As Money) As Hold_value,          
             Cast(0.0 As Money) As Avg_closing,          
             Accno,          
             Scripname,          
             Cast(0 As Int)     As Scrip_priority,          
             1                  As Client_priority          
      Into   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
      From   Tbl_party_pledge_data A (nolock)          
      Where  A.Processdate >= @LastProc_Date          
             And A.Processdate <= @LastProc_Date + ' 23:59:59'          
             And A.Pledge_qty <> 0          
      Group  By Party_code,Isin,Scrip_cd,Accno,Scripname          
          
      Select A.Party_code,          
             A.Isin,          
             A.Scrip_cd,          
             Qty=New_qty,          
             A.Pledge_qty,          
             Free_qty=New_qty,          
             A.Hold_value,          
             A.Avg_closing,          
             A.Accno,          
             A.Scripname,          
             Scrip_priority=A.New_scrip_priority          
      Into   #TBL_RMS_HOLDING_APPR_PRVEDAY          
      From   (Select A.*,          
                     New_qty= (Case          
                                When (A.Qty - B.Qty) >= 0 Then B.Qty          
                                Else A.Qty          
                               End),          
                     New_scrip_priority= A.Scrip_priority          
              From   (Select *          
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
                      Where  Scrip_priority = 0) A          
        Inner Join (Select *          
                                 From   #TBL_RMS_HOLDING_APPR_TMP          
                                 Where  Scrip_priority > 0) B          
                      On A.Isin = B.Isin          
                         And A.Scrip_cd = B.Scrip_cd          
                         And A.Accno = B.Accno          
                         And A.Party_code = B.Party_code          
              Union All          
              Select A.*,          
                     New_qty= B.Qty - A.Qty,          
                     New_scrip_priority= B.Scrip_priority          
              From   (Select *          
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
                      Where  Scrip_priority = 0) A          
                     Inner Join (Select *          
                                 From   #TBL_RMS_HOLDING_APPR_TMP          
                                 Where  Scrip_priority > 0) B          
                      On A.Isin = B.Isin          
                         And A.Scrip_cd = B.Scrip_cd          
                         And A.Accno = B.Accno          
                         And A.Party_code = B.Party_code          
              Where  A.Qty < B.Qty) A          
         
      Delete A          
      From   #TBL_RMS_HOLDING_APPR_TMP As A          
             Inner Join #TBL_RMS_HOLDING_APPR_PRVEDAY B          
              On A.Isin = B.Isin          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Accno = B.Accno          
                 And A.Party_code = B.Party_code          
          
      Insert Into #TBL_RMS_HOLDING_APPR_TMP          
      Select *          
      From   #TBL_RMS_HOLDING_APPR_PRVEDAY         
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */       
      /*      
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = A.Clsrate,          
             Hold_value = Qty * A.Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                                     '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209') */      
             
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
              Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = A.Accno      
              
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
               Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000051'       
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin       
                    
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                 Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000066'       
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin          
          
      --STEP 6          
      /*---------------------------------------------------------------          
      GENERATING HOLDING ROW NUMBER FOR LOOPING          
      ---------------------------------------------------------------*/          
      Select *,          
             Row_number() Over(PARTITION By Party_code Order By Scrip_priority, Hold_value Desc) As Row_num          
      /*,CONVERT(INT,0) AS PLEDGE_DP_QTY,          
      CONVERT(INT,0) AS AFTER_ADJUST_PLEDGE_QTY*/          
      Into   #TBL_RMS_HOLDING_APPR          
      From   #TBL_RMS_HOLDING_APPR_TMP          
      Where  Free_qty <> 0          
      Order  By Party_code,Scrip_priority,Hold_value Desc          
          
      --STEP 7          
      /*------------------------------          
      STORE CLINET WISE DETAILS          
      --------------------------------*/          
      Select A.Party_code,
			 [98Series]=  SUM([98Series]) ,          
             Bsecm_ledger=Sum(Case Co_code          
                               When 'BSECM' Then Ledger          
                               Else 0          
                              End),          
             Nsecm_ledger=Sum(Case Co_code          
                               When 'NSECM' Then Ledger          
                               Else 0          
                              End),          
             Nsefo_ledger=Sum(Case Co_code          
                               When 'NSEFO' Then Ledger          
                               Else 0          
                              End),          
             Mcd_ledger=Sum(Case Co_code          
                             When 'MCD' Then Ledger          
                             Else 0          
                            End),          
             Mcx_ledger=Sum(Case Co_code          
                             When 'MCX' Then Ledger          
                             Else 0          
                            End),          
             Nbfc_ledger=Sum(Case Co_code          
                              When 'NBFC' Then Ledger         
                              Else 0          
                             End),          
             Ncdex_ledger=Sum(Case Co_code          
                               When 'NCDEX' Then Ledger          
                               Else 0          
                              End),          
             Nsx_ledger=Sum(Case Co_code          
                             When 'NSX' Then Ledger          
                             Else 0          
                            End),
   /*************added on 17 May 2018 *****************/                            
			MTF_ledger=Sum(Case Co_code            
                             When 'MTF' Then Ledger            
                             Else 0            
                            End),     
   /**********************************/                                  
             Bsecm_imargin=Sum(Case Co_code          
                                When 'BSECM' Then Imargin          
                                Else 0          
                               End),          
             Nsecm_imargin=Sum(Case Co_code          
                                When 'NSECM' Then Imargin          
                                Else 0          
                               End),          
             Nsefo_imargin=Sum(Case Co_code          
                                When 'NSEFO' Then Imargin          
                                Else 0          
                               End),          
             Mcd_imargin=Sum(Case Co_code          
                              When 'MCD' Then Imargin          
                              Else 0          
                             End),          
             Mcx_imargin=Sum(Case Co_code          
                              When 'MCX' Then Imargin          
                              Else 0          
                             End),          
             Nbfc_imargin=Sum(Case Co_code          
                               When 'NBFC' Then Imargin          
                               Else 0          
                              End),          
             Ncdex_imargin=Sum(Case Co_code          
                                When 'NCDEX' Then Imargin          
                                Else 0          
          End),          
             Nsx_imargin=Sum(Case Co_code          
                              When 'NSX' Then Imargin          
                              Else 0          
                             End),          
             Bsecm_cash_colleteral=Sum(Case Co_code          
                                        When 'BSECM' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsecm_cash_colleteral=Sum(Case Co_code          
                                        When 'NSECM' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsefo_cash_colleteral=Sum(Case Co_code          
                                        When 'NSEFO' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Mcd_cash_colleteral=Sum(Case Co_code          
                                      When 'MCD' Then Cash_colleteral          
                                      Else 0          
                       End),          
             Mcx_cash_colleteral=Sum(Case Co_code          
                                      When 'MCX' Then Cash_colleteral          
                                      Else 0          
                                     End),          
             Nbfc_cash_colleteral=Sum(Case Co_code          
                                       When 'NBFC' Then Cash_colleteral          
                                       Else 0          
                                      End),          
             Ncdex_cash_colleteral=Sum(Case Co_code          
                                        When 'NCDEX' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsx_cash_colleteral=Sum(Case Co_code          
                                      When 'NSX' Then Cash_colleteral          
                                      Else 0          
                                     End),          
        Bsecm_noncash_colleteral=Sum(Case Co_code          
                                           When 'BSECM' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsecm_noncash_colleteral=Sum(Case Co_code          
                                           When 'NSECM' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsefo_noncash_colleteral=Sum(Case Co_code          
                                           When 'NSEFO' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Mcd_noncash_colleteral=Sum(Case Co_code          
                                         When 'MCD' Then Noncash_colleteral          
                                         Else 0          
                                        End),          
             Mcx_noncash_colleteral=Sum(Case Co_code          
                                         When 'MCX' Then Noncash_colleteral          
                                         Else 0          
                                        End),          
             Nbfc_noncash_colleteral=Sum(Case Co_code          
                                          When 'NBFC' Then Noncash_colleteral          
                                          Else 0          
                                         End),          
             Ncdex_noncash_colleteral=Sum(Case Co_code          
                                           When 'NCDEX' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsx_noncash_colleteral=Sum(Case Co_code          
                                         When 'NSX' Then Noncash_colleteral          
                                         Else 0          
                     End),          
             Bsecm_unrecosiled_credit=Sum(Case Co_code          
                When 'BSECM' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsecm_unrecosiled_credit=Sum(Case Co_code    
                                           When 'NSECM' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsefo_unrecosiled_credit=Sum(Case Co_code          
                                           When 'NSEFO' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Mcd_unrecosiled_credit=Sum(Case Co_code          
                                         When 'MCD' Then Unrecosiled_credit          
                                         Else 0          
                                        End),          
             Mcx_unrecosiled_credit=Sum(Case Co_code          
                                         When 'MCX' Then Unrecosiled_credit          
                                         Else 0          
                                        End),          
             Nbfc_unrecosiled_credit=Sum(Case Co_code          
                When 'NBFC' Then Unrecosiled_credit          
                                          Else 0          
                                         End),          
             Ncdex_unrecosiled_credit=Sum(Case Co_code          
                                           When 'NCDEX' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsx_unrecosiled_credit=Sum(Case Co_code          
                                         When 'NSX' Then Unrecosiled_credit          
                                         Else 0          
                End),          
             Bsecm_varmargin=Convert(Money, 0.0),          
             Nsecm_varmargin=Convert(Money, 0.0),          
             Nsefo_varmargin=Convert(Money, 0.0),          
             Mcd_varmargin=Convert(Money, 0.0),          
             Mcx_varmargin=Convert(Money, 0.0),          
             Nbfc_varmargin=Convert(Money, 0.0),          
             Ncdex_varmargin=Convert(Money, 0.0),          
             Nsx_varmargin=Convert(Money, 0.0),          
             Bsecm_span_add_margin=Convert(Money, 0.0),          
             Nsecm_span_add_margin=Convert(Money, 0.0),          
             Nsefo_span_add_margin=Convert(Money, 0.0),          
             Mcd_span_add_margin=Convert(Money, 0.0),          
             Mcx_span_add_margin=Convert(Money, 0.0),          
             Nbfc_span_add_margin=Convert(Money, 0.0),          
             Ncdex_span_add_margin=Convert(Money, 0.0),          
             Nsx_span_add_margin=Convert(Money, 0.0)          
      Into   #PLEDGE_CLIENTWISELEDGER          
      From   #NET_AVAILABLE_PARTY A          
             Inner Join (Select Distinct Party_code          
                         From   #TBL_RMS_HOLDING_APPR) B          
              On A.Party_code = B.Party_code          
      Group  By A.Party_code          
          
      Update #PLEDGE_CLIENTWISELEDGER          
      Set    Bsecm_varmargin = A.Bsecm_varmargin,          
             Nsecm_varmargin = A.Nsecm_varmargin          
      From   (Select Party_code,          
                     Bsecm_varmargin=Sum(Case Co_code          
                                          When 'BSECM' Then Varmargin          
                                          Else 0          
                                         End),          
                     Nsecm_varmargin=Sum(Case Co_code          
                                          When 'NSECM' Then Varmargin          
                                          Else 0          
                                         End)   
			  /*Changes Done By Rohit And Anil 24 Oct 2017 to change the Var margin logic*/                                                
              /*From   Vw_equity_var_margin (NOLOCK)*/          
              From VW_Equity_Var_Margin_Pledge (NOLOCK)
              Group  By Party_code)A          
      Where  #pledge_clientwiseledger.Party_code = A.Party_code          
          
      Update #PLEDGE_CLIENTWISELEDGER          
      Set  Nsefo_span_add_margin = A.Nsefo_span_add_margin,          
             Mcd_span_add_margin = A.Mcd_span_add_margin,          
             Nsx_span_add_margin = A.Nsx_span_add_margin          
      From   (Select Party_code,          
                     Nsefo_span_add_margin=Sum(Case Co_code          
                                                When 'NSEFO' Then Initialmargin + Addmargin          
                                                Else 0          
                                               End),          
                     Mcd_span_add_margin=Sum(Case Co_code          
                                              When 'MCD' Then Initialmargin + Addmargin          
                                              Else 0          
                                             End),          
                     Nsx_span_add_margin=Sum(Case Co_code          
                                              When 'NSX' Then Initialmargin + Addmargin          
                                              Else 0          
                                             End)          
              From   Vw_derivativemargin (NOLOCK)          
              Group  By Party_code)A          
      Where  #pledge_clientwiseledger.Party_code = A.Party_code          
          
      Delete From Pledge_clientwiseledger          
      Where  Processdate >= Convert(Varchar, Getdate(), 106)          
             And Processdate <= Convert(Varchar, Getdate(), 106) + ' 23:59:59'          
          
      Insert Into Pledge_clientwiseledger(Party_code,[98Series],BSECM_LEDGER,NSECM_LEDGER,NSEFO_LEDGER,MCD_LEDGER,MCX_LEDGER,NBFC_LEDGER,NCDEX_LEDGER,NSX_LEDGER,MTF_ledger,BSECM_IMARGIN,NSECM_IMARGIN,NSEFO_IMARGIN,MCD_IMARGIN,MCX_IMARGIN,NBFC_IMARGIN,NCDEX_IMARGIN,NSX_IMARGIN,BSECM_CASH_COLLETERAL,NSECM_CASH_COLLETERAL,NSEFO_CASH_COLLETERAL,MCD_CASH_COLLETERAL,MCX_CASH_COLLETERAL,NBFC_CASH_COLLETERAL,NCDEX_CASH_COLLETERAL,NSX_CASH_COLLETERAL,BSECM_NONCASH_COLLETERAL,NSECM_NONCASH_COLLETERAL,NSEFO_NONCASH_COLLETERAL,MCD_NONCASH_COLLETERAL,MCX_NONCASH_COLLETERAL,NBFC_NONCASH_COLLETERAL,NCDEX_NONCASH_COLLETERAL,NSX_NONCASH_COLLETERAL,BSECM_UNRECOSILED_CREDIT,NSECM_UNRECOSILED_CREDIT,NSEFO_UNRECOSILED_CREDIT,MCD_UNRECOSILED_CREDIT,MCX_UNRECOSILED_CREDIT,NBFC_UNRECOSILED_CREDIT,NCDEX_UNRECOSILED_CREDIT,NSX_UNRECOSILED_CREDIT,BSECM_VARMARGIN,NSECM_VARMARGIN,NSEFO_VARMARGIN,MCD_VARMARGIN,MCX_VARMARGIN,NBFC_VARMARGIN,NCDEX_VARMARGIN,NSX_VARMARGIN,BSECM_SPAN_ADD_MARGIN,NSECM_SPAN_ADD_MARGIN,NSEFO_SPAN_ADD_MARGIN,MCD_SPAN_ADD_MARGIN,MCX_SPAN_ADD_MARGIN,NBFC_SPAN_ADD_MARGIN,NCDEX_SPAN_ADD_MARGIN,NSX_SPAN_ADD_MARGIN,ProcessDate,ProcessBy)          
      Select Party_code,[98Series],BSECM_LEDGER,NSECM_LEDGER,NSEFO_LEDGER,MCD_LEDGER,MCX_LEDGER,NBFC_LEDGER,NCDEX_LEDGER,NSX_LEDGER,MTF_ledger,BSECM_IMARGIN,NSECM_IMARGIN,NSEFO_IMARGIN,MCD_IMARGIN,MCX_IMARGIN,NBFC_IMARGIN,NCDEX_IMARGIN,NSX_IMARGIN,BSECM_CASH_COLLETERAL,NSECM_CASH_COLLETERAL,NSEFO_CASH_COLLETERAL,MCD_CASH_COLLETERAL,MCX_CASH_COLLETERAL,NBFC_CASH_COLLETERAL,NCDEX_CASH_COLLETERAL,NSX_CASH_COLLETERAL,BSECM_NONCASH_COLLETERAL,NSECM_NONCASH_COLLETERAL,NSEFO_NONCASH_COLLETERAL,MCD_NONCASH_COLLETERAL,MCX_NONCASH_COLLETERAL,NBFC_NONCASH_COLLETERAL,NCDEX_NONCASH_COLLETERAL,NSX_NONCASH_COLLETERAL,BSECM_UNRECOSILED_CREDIT,NSECM_UNRECOSILED_CREDIT,NSEFO_UNRECOSILED_CREDIT,MCD_UNRECOSILED_CREDIT,MCX_UNRECOSILED_CREDIT,NBFC_UNRECOSILED_CREDIT,NCDEX_UNRECOSILED_CREDIT,NSX_UNRECOSILED_CREDIT,BSECM_VARMARGIN,NSECM_VARMARGIN,NSEFO_VARMARGIN,MCD_VARMARGIN,MCX_VARMARGIN,NBFC_VARMARGIN,NCDEX_VARMARGIN,NSX_VARMARGIN,BSECM_SPAN_ADD_MARGIN,NSECM_SPAN_ADD_MARGIN,NSEFO_SPAN_ADD_MARGIN,MCD_SPAN_ADD_MARGIN,MCX_SPAN_ADD_MARGIN,NBFC_SPAN_ADD_MARGIN,NCDEX_SPAN_ADD_MARGIN,NSX_SPAN_ADD_MARGIN,          
             Processdate=Getdate(),          
             Processby=@USERNAME          
      From   #PLEDGE_CLIENTWISELEDGER          
          
   /*---------------------------------------------------------------          
   FETCHING PLEDGE SCRIPS          
   ---------------------------------------------------------------*/          
      --DROP TABLE #TBL_PLEDGE_QTY_TMP          
   /*SELECT HLD_AC_CODE AS ACCNO,HLD_ISIN_CODE AS ISIN,          
   HLD_AC_POS,HLD_AC_POS AS AFTER_ADJUST_PLEDGE_QTY,CONVERT(BIT,0) AS BANK_APPROVED          
   INTO #TBL_PLEDGE_QTY_TMP          
   FROM DPBACKOFFICE.ACERCROSS.DBO.HOLDING WITH (NOLOCK)          
   --WHERE HLD_AC_CODE IN ('1203320000000051','1203320000000066')          
   WHERE HLD_AC_CODE IN (SELECT ACCNO FROM TBL_LAS_PLEDGE_ACC_MASTER WHERE ACTIVE_INACTIVE=1)          
   AND HLD_AC_TYPE ='14' */          
      --STEP 8          
      /*---------------------------------------------------------------          
      CREATING INDEX TO OPTIMIZE SELECTION          
      ---------------------------------------------------------------*/          
      Create Clustered Index [IX_ROW_NUM]          
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Row_num] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Nonclustered Index [IX_CL_LIST_PARTY]          
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Party_code] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Clustered Index [IX_HOLDING_APPR_ROW_NUM]          
       On #TBL_RMS_HOLDING_APPR ( [Party_code] Asc, [Row_num] Asc          
      --[SCRIP_PRIORITY] ASC          
      )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      --STEP 9 DROP TABLE #TBL_PARTY_PLEDGE_DATA          
      /*---------------------------------------------------------------          
      CREATING TABLE FOR FINAL DATA          
      ---------------------------------------------------------------*/          
      Create Table #TBL_PARTY_PLEDGE_DATA          
       (          
         Rms_date         Datetime,          
         Party_code       Varchar(20),          
         Ledger_bal       Money,          
         Client_priority  Smallint,    
         Isin             Varchar(20),          
         Scrip_cd         Varchar(50),          
         Scripname        Varchar(100),          
         Accno            Varchar(50),          
         Qty  Int,          
         Pledge_qty       Int,          
         Free_qty         Int,          
         Hold_value       Money,          
         Avg_closing      Money,          
         Pledgeable_qty   Int,          
         Pledgeable_value Money,          
         Prevdaypledgeqty Int,          
         Release_qty      Int,          
         Scrip_priority   Smallint          
       )          
          
      --STEP 10          
      /*---------------------------------------------------------------          
      LOOP SPLIT CLIENT SCRIP TO CATEGORIZE TYPE          
      WHERE TYPES ARE AS FOLLOWS          
      1) EQUIVALENT TO DEBIT ( DR = STOCK VALUE * 2 )          
      2) REMAINING ALL SCRIPT FROM ABOVE PROCESS WILL COME HERE          
      3) ALL CREDIT CLIENT WILL COM IN THIS CATEGORY          
      ---------------------------------------------------------------*/          
      Declare @CNT_TOTAL               As Int,          
              @ROW_COUNTER_CLIENT      As Int,          
              @ROW_COUNTER_ISIN        As Int,          
              @PARTY_CODE              As Varchar(20),          
              @PERV_PARTY_CODE         As Varchar(20),          
              @LEDGER_BAL              As Money,          
              @QTY                     As Int,          
              @PLEDGEABLE_QTY          As Int,          
              @PLEDGE_QTY              As Int,          
              @FREE_QTY                As Int,          
              @HOLD_VALUE              As Money,          
              @ISIN                    As Varchar(20),          
              @SCRIP_CD                As Varchar(50),          
              @SCRIPNAME               As Varchar(100),          
              @ACCNO                   As Varchar(50),          
          @LEDGER_TMP              As Money,          
              @CLOSING_RATE            As Money,          
              @CLIENT_PRIORITY         As Smallint,          
              @SCRIP_PRIORITY          As Smallint,          
              @HOLDING_ADJUSTED_VALUE  As Money,          
              @PLEDGEABLE_VALUE  As Money,          
              @COUNTINUE_LOOP          As Bit,          
              @AFTER_ADJUST_PLEDGE_QTY As Int,          
              @RMS_DATE                As Datetime,          
              @QTY_DIFF                As Int,          
              @SCRIP_CNT_TOTAL         As Int,          
              @SCRIP_CTR               As Int          
          
      Select @CNT_TOTAL = Count(1)          
      From   #TBL_CL_LIST_APPR_HOLD_TMP --WHERE CLIENT_PRIORITY <= 2          
          
      --PRINT @CNT_TOTAL          
      Set @ROW_COUNTER_CLIENT = 1--45943--24245          
          
      While @ROW_COUNTER_CLIENT <= @CNT_TOTAL --45943 --24246          
      Begin          
         Select @RMS_DATE = Rms_date,          
                @PARTY_CODE = Party_code,          
                @LEDGER_BAL = Net          
         From   #TBL_CL_LIST_APPR_HOLD_TMP          
         Where  Row_num = @ROW_COUNTER_CLIENT          
          
         Set @SCRIP_CNT_TOTAL = 0          
          
         Set @SCRIP_CTR = 1          
          
         Set @CLIENT_PRIORITY = 1          
          
         Select @SCRIP_CNT_TOTAL = Count(*)          
         From   #TBL_RMS_HOLDING_APPR          
         Where  Party_code = @PARTY_CODE          
          
         Set @HOLDING_ADJUSTED_VALUE = 0          
          
         Set @COUNTINUE_LOOP = 1          
          
         --PRINT '--------------------------'          
         --PRINT CONVERT(VARCHAR,@ROW_COUNTER_CLIENT)+'.) '+@PARTY_CODE+ ' $LEDGER BAL :- '+CONVERT(VARCHAR,@LEDGER_BAL) + ' $PLEDGE VALUE :- '+CONVERT(VARCHAR,@LEDGER_BAL*2)          
         --PRINT ' SCRIP (NO OF SCRIPS ['+CONVERT(VARCHAR,@SCRIP_CNT_TOTAL)+'])'          
         While(@SCRIP_CTR <= @SCRIP_CNT_TOTAL)          
         Begin          
            Set @PLEDGEABLE_QTY = 0          
          
            Set @PLEDGEABLE_VALUE = 0          
          
            Select @ISIN = A.Isin,          
                   @SCRIP_CD = Scrip_cd,          
                   @SCRIPNAME = Scripname,          
                   @QTY = Qty,          
                   @PLEDGE_QTY = Pledge_qty,          
                   @FREE_QTY = Free_qty,          
                   @HOLD_VALUE = Hold_value,          
             @ACCNO = A.Accno,          
                   @CLOSING_RATE = Avg_closing,          
                   @SCRIP_PRIORITY = Scrip_priority          
            From   #TBL_RMS_HOLDING_APPR A          
            Where  Party_code = @PARTY_CODE          
                   And Row_num = @SCRIP_CTR          
          
            If @HOLDING_ADJUSTED_VALUE < Abs(@LEDGER_BAL) * 2          
            Begin          
               If (@HOLDING_ADJUSTED_VALUE + @HOLD_VALUE) > Abs(@LEDGER_BAL) * 2          
               Begin          
                  --SET @QTY_DIFF = CEILING( ( ( ABS( @LEDGER_BAL ) * 2 - ( @HOLDING_ADJUSTED_VALUE) ) / @CLOSING_RATE ) )          
                  Set @QTY_DIFF = Floor(((Abs(@LEDGER_BAL) * 2 - (@HOLDING_ADJUSTED_VALUE)) / @CLOSING_RATE))          
          
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + (@QTY_DIFF * @CLOSING_RATE)          
          
                  Set @HOLD_VALUE = @QTY_DIFF * @CLOSING_RATE          
          
                  Set @FREE_QTY = @FREE_QTY - @QTY_DIFF          
          
                  Set @QTY = @QTY_DIFF          
          
                  Set @PLEDGEABLE_QTY = @QTY          
          
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
          
                  --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +          
                  --' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- ' +          
                  --CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
                  If @QTY > 0          
                  Begin          
                     Insert Into #TBL_PARTY_PLEDGE_DATA          
                     Values      (@RMS_DATE,          
                                  @PARTY_CODE,          
                                  @LEDGER_BAL,          
                                  @CLIENT_PRIORITY,          
                                  @ISIN,          
                                  @SCRIP_CD,          
                                  @SCRIPNAME,          
                                  @ACCNO,          
                                  @QTY,          
                                  @PLEDGE_QTY,          
                                  @QTY_DIFF,          
                                  @HOLD_VALUE,          
                                  @CLOSING_RATE,          
                                  @PLEDGEABLE_QTY,          
                                  @PLEDGEABLE_VALUE,          
                                  0,          
                                  0,          
                                  @SCRIP_PRIORITY)          
                  End          
          
                  Set @QTY = @FREE_QTY          
          
                  Set @HOLD_VALUE = @FREE_QTY * @CLOSING_RATE          
          
                  Set @PLEDGEABLE_QTY = @QTY          
          
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
          
                  Set @CLIENT_PRIORITY = 2          
               --BREAK          
               End          
               Else          
               Begin          
                  Set @PLEDGEABLE_QTY = @FREE_QTY          
          
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE          
          
  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
               End          
          
               --SET @PLEDGEABLE_VALUE = @PLEDGEABLE_QTY*@CLOSING_RATE          
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY)          
               --+ ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '          
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
               If @QTY > 0          
               Begin          
                  Insert Into #TBL_PARTY_PLEDGE_DATA          
                  Values      (@RMS_DATE,          
                               @PARTY_CODE,          
                               @LEDGER_BAL,          
                               @CLIENT_PRIORITY,          
                               @ISIN,          
                               @SCRIP_CD,          
                               @SCRIPNAME,          
                               @ACCNO,          
                               @QTY,          
                               @PLEDGE_QTY,          
                               @FREE_QTY,          
                               @HOLD_VALUE,          
                               @CLOSING_RATE,          
                               @PLEDGEABLE_QTY,          
                               @PLEDGEABLE_VALUE,          
                               0,          
                               0,          
                               @SCRIP_PRIORITY)          
               End          
            End          
            Else          
            Begin          
               Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE          
          
               Set @CLIENT_PRIORITY = 2          
          
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +          
               -- ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '          
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
               If @QTY > 0          
               Begin          
                  Insert Into #TBL_PARTY_PLEDGE_DATA          
                  Values      (@RMS_DATE,          
                               @PARTY_CODE,          
                               @LEDGER_BAL,          
                               @CLIENT_PRIORITY,          
                               @ISIN,          
                               @SCRIP_CD,          
                               @SCRIPNAME,          
                               @ACCNO,          
                               @QTY,          
                               @PLEDGE_QTY,          
                               @FREE_QTY,          
                               @HOLD_VALUE,          
                               @CLOSING_RATE,          
                               @PLEDGEABLE_QTY,          
                               @PLEDGEABLE_VALUE,          
                               0,          
                               0,          
                               @SCRIP_PRIORITY)          
          
               End          
            End          
          
            If ((@CLIENT_PRIORITY = 2)          
                And (@SCRIP_CTR < @SCRIP_CNT_TOTAL))          
            Begin          
               Insert Into #TBL_PARTY_PLEDGE_DATA          
               Select @RMS_DATE,          
                      @PARTY_CODE,          
                      @LEDGER_BAL,          
                      @CLIENT_PRIORITY,          
                      A.Isin,          
                      Scrip_cd,          
                      Scripname,          
                      A.Accno,          
                      Qty,          
                      Pledge_qty,          
                      Free_qty,          
                      Hold_value,          
                      Avg_closing,          
                      Free_qty                               As Pledgeable_qty,          
                      Convert(Money, Free_qty * Avg_closing) As Pledgeable_value,          
                      0                                      As Prevdaypledgeqty,          
                      0                                      As Release_qty,          
                      Scrip_priority          
               From   #TBL_RMS_HOLDING_APPR A          
               Where  Party_code = @PARTY_CODE          
                      And Row_num > @SCRIP_CTR          
          
               Break          
            End          
          
            Set @SCRIP_CTR = @SCRIP_CTR + 1          
         End          
          
         --PRINT ' ADJUSTED VALUE :- '+CONVERT(VARCHAR,@HOLDING_ADJUSTED_VALUE)          
         Set @ROW_COUNTER_CLIENT = @ROW_COUNTER_CLIENT + 1          
      End          
          
      --drop table #prevDayReleaseQty          
      Select A.Isin,          
             A.Party_code,          
             A.Scrip_cd,          
             A.Scripname,          
             A.Accno,          
             Releaseqty =Isnull(A.Qty, 0) - Isnull(B.Pledge_qty, 0),          
           Prevdaypledge=Isnull(A.Qty, 0),          
             A.Client_priority,          
             Ledger_bal=Convert(Money, 0.0),          
             Avg_closing=Convert(Money, 0.0)          
      Into   #prevDayReleaseQty          
      From   (Select *          
              From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
              Where  Scrip_priority = 0) A          
             Left Join (Select Party_code,          
                               Isin,          
                               Scrip_cd,          
                               Accno,          
                               Pledge_qty=Sum(Pledgeable_qty),          
                               Client_priority          
                        From   #TBL_PARTY_PLEDGE_DATA          
                        Where  Client_priority = 1 --Scrip_priority > 0 and          
                        Group  By Party_code,Isin,Scrip_cd,Accno,Client_priority) B          
              On A.Isin = B.Isin          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Accno = B.Accno          
                 And A.Party_code = B.Party_code          
      Where  Isnull(A.Qty, 0) > Isnull(B.Pledge_qty, 0)          
          
      Update #prevDayReleaseQty          
      Set    #prevdayreleaseqty.Ledger_bal = A.Net          
      From   #TBL_CL_LIST_APPR_HOLD A          
      Where  A.Party_code = #prevdayreleaseqty.Party_code          
            
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */      
      /*Update #prevDayReleaseQty          
      Set    Avg_closing = Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #prevdayreleaseqty.Isin = A.Isin          
             And #prevdayreleaseqty.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                              '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #prevDayReleaseQty          
      Set    Avg_closing = Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #prevdayreleaseqty.Isin = A.Isin          
             And #prevdayreleaseqty.Accno In ('1203320000000066', '16921197', '14216209')*/      
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate      
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #prevDayReleaseQty.Isin = A.Isin          
              and #prevDayReleaseQty.Accno = A.Accno      
              
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #prevDayReleaseQty.Accno = '1203320000000051'       
              and #prevDayReleaseQty.Isin = A.Isin       
                    
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate        
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #prevDayReleaseQty.Accno = '1203320000000066'       
              and #prevDayReleaseQty.Isin = A.Isin                  
          
      Update A          
      Set    A.Prevdaypledgeqty = B.Prevdaypledge,          
             A.Release_qty = B.Releaseqty          
      From   #TBL_PARTY_PLEDGE_DATA A          
             Inner Join (Select *          
                         From   #prevDayReleaseQty A          
                         Where  Exists (Select *          
                                        From   #TBL_PARTY_PLEDGE_DATA B          
                                        Where  A.Isin = B.Isin          
                                               And A.Accno = B.Accno          
                                               And A.Scrip_cd = B.Scrip_cd          
                                               And A.Party_code = B.Party_code          
                                               And A.Client_priority = B.Client_priority)) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Party_code = B.Party_code          
                 And A.Client_priority = B.Client_priority          
          
      Update A          
      Set    A.Prevdaypledgeqty = B.Qty--b.PrevDayPledge          
      From   #TBL_PARTY_PLEDGE_DATA A          
             Inner Join (Select *          
                         From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY A          
                        --Where exists (Select * from #TBL_PARTY_PLEDGE_DATA b          
                        --where a.isin=b.isin and a.accno=b.accno and a.scrip_cd=b.scrip_cd and a.party_code=b.party_code          
                        --and a.client_priority=b.client_priority)          
                        ) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Party_code = B.Party_code          
                 And A.Client_priority = B.Client_priority          
                 And A.Scrip_priority = B.Scrip_priority          
          
      --Declare @Rms_date As Datetime          
      Select @Rms_date = Max(Rms_date)          
      From   #TBL_PARTY_PLEDGE_DATA          
          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select Rms_date=@Rms_date,          
             Party_code,          
             Ledger_bal,          
             Client_priority=3,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty=0,          
             Pledge_qty=0,          
             Free_qty=0,          
             Hold_value=0,          
             Avg_closing,          
             Pledgeable_qty=0,          
             Pledgeable_value=0,          
             Prevdaypledgeqty=Prevdaypledge,          
             Release_qty=Releaseqty,          
             Scrip_priority=1          
      From   #prevDayReleaseQty A          
      Where  Not Exists (Select *          
                         From   #TBL_PARTY_PLEDGE_DATA B          
                         Where  A.Isin = B.Isin          
                                And A.Accno = B.Accno          
                                And A.Scrip_cd = B.Scrip_cd          
                                And A.Party_code = B.Party_code          
                                And A.Client_priority = B.Client_priority)          
          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select Rms_date=@Rms_date,          
             Party_code,          
             Ledger_bal,          
             Client_priority=4,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty,          
             Pledge_qty=0,          
             Free_qty,          
             Hold_value,          
             Avg_closing,          
             Pledgeable_qty= Free_qty,          
             Pledgeable_value=0,          
             Prevday_pledege_qty=Release_qty,          
             Release_qty,          
             Scrip_priority          
      From   Tbl_party_pledge_data (nolock)          
      Where  Party_code = 'Unknown'          
             And Client_priority = 1          
             And Processdate >= @LastProc_Date          
             And Processdate <= @LastProc_Date + ' 23:59:59'          
          
      ---*****Save Creditor Client For Adjustment of Pledge excces Adjustment          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select B.Rms_date,          
             B.Party_code,          
             Ledger_bal=B.Net,          
             Client_priority=4,          
             A.Isin,          
             A.Scrip_cd,          
             A.Scripname,          
             A.Accno,          
             A.Qty,         
             Pledge_qty=0,          
             A.Free_qty,          
             A.Hold_value,          
             A.Avg_closing,          
             Pledgeable_qty=A.Free_qty,          
             Pledgeable_value=Convert(Money, A.Free_qty * A.Avg_closing),          
             Prevdaypledgeqty=0,          
             Release_qty=0,          
             A.Scrip_priority          
      From   (Select *          
              From   #TBL_RMS_HOLDING_APPR) A          
             Inner Join (Select *          
                         From   #TBL_CL_LIST_APPR_HOLD          
                         Where  Net >= 0) B          
              On B.Party_code = A.Party_code          
	  
	    /***************[98Series] Added by neha naiwar on 18 Jun 2019 as per mail of Anil Wndre************************************/ 
	    --       Update A          
			  --Set    Ledger_bal = Ledger_bal + Isnull( B.[98Series] , 0)          
			  --From   #TBL_PARTY_PLEDGE_DATA A          
     --        Right Outer Join (Select party_code, [98Series]                
     --                          From   #PLEDGE_CLIENTWISELEDGER With(NOLOCK)          
     --                          Where [98Series]<>0  --and party_code='P60550'       
     --                          Group  By party_code , [98Series]         
     --                          ) B          
     --         On A.Party_code = B.party_code  
	    /*************************************************************************************************/
	  
	            
      Begin Tran          
          
      Insert Into Tbl_party_pledge_data_log          
      Select *          
      From   Tbl_party_pledge_data (nolock)          
    
      /*Delete from Tbl_party_pledge_data          
      Where Processdate >= Convert(varchar,Getdate(),106)          
      And Processdate <= Convert(varchar,Getdate(),106) + ' 23:59:59'*/          
          
      Truncate Table Tbl_party_pledge_data          
          
      Insert Into Tbl_party_pledge_data          
      Select *,          
             Processdate=Getdate(),          
             @USERNAME          
      From   #TBL_PARTY_PLEDGE_DATA          
          
      Commit          
   End          
          
   Set nocount Off          
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_client_holding_01Feb2019
-- --------------------------------------------------

/*    
    CHANGE ID  :: 1    
    MODIFIED BY  :: PRASHANT    
    MODIFIED DATE :: AUG 03 2013    
    REASON   :: NOT TO PLEDGE SHARES OF WCL CLIENT    
    REQUEST FROM :: RAHUL SIR    
    PRMS ID   :: NONE  
    
    Changes: There is changes has been Done on 29 Jun 2018 by Rohit Patil after discussion with Anil Wandre.
			 Now on wards SP will consider the Co_code MCX and NCDEX	  
*/    
--[Usp_las_pledge_client_holding] 'System'
create Procedure [dbo].[Usp_las_pledge_client_holding_01Feb2019]    
(          
 @USERNAME Varchar(10)          
)          
As          
Begin          
   Set NOCOUNT On          
          
   If Not Exists (Select Hdate          
                  From   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)          
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))          
   Begin          
      Declare @LastProc_Date As Datetime          
          
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)          
      From   Tbl_party_pledge_data (nolock)          
  
      /*  
      --Changing the condition to not consider unreco credit  
      --Change by: Renil  
      --Changed on: Dec 03 2014  
      --Change Request by: Rahul C shah  
      */  
      Select Party_code,          
             Co_code,          
             Convert(Money, 0) As Ledger,          
             Imargin,          
             Cash_colleteral,          
             Noncash_colleteral,          
             Unrecosiled_credit=0.00          
      Into   #NET_AVAILABLE_PARTY          
      From   General.dbo.Rms_dtclfi With(NOLOCK)          
      /* Where  Co_code Not In ('MCX', 'NCDEX') */ /* Condition is commented on 29 June 2018 */        
          
      Declare @ACCOPENINGDATE   As Varchar(11),          
              @EXCLUDEOPBALDATE As Varchar(11)          
          
      Select @ACCOPENINGDATE = '04-01-' + Convert(Varchar, Case          
                                                            When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('JAN', 'FEB', 'MAR') Then Datepart(YY, Getdate()) - 2          
                                                            Else Datepart(YY, Getdate()) - 1          
                                                           End),          
             @EXCLUDEOPBALDATE = (Case          
                                   When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('APR') Then '01-01-' + Convert(Varchar, Datepart(YY, Getdate()))          
                                   Else '01-01-1900'          
                                  End)          
          
      --Set @ACCOPENINGDATE='Apr 01 2010'    
      /*  
      --Changing the condition of effective from getdate()-1 to getdate() to consider todays bill posting  
      --Change by: Renil  
      --Changed on: Dec 03 2014  
      --Change Request by: Rahul C shah  
      */        
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Bsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'BSECM'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
            Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                    Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSECM'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsefo_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSEFO'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Mcd_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MCD'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsx_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSX'      
      
      
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                              /* From   anand1.MTFTrade.dbo.ledger With(NOLOCK)          */  /*****Commented on 17 May 2018 by neha**********/
                              From   General.dbo.MTF_CLedger With(NOLOCK)   
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MTF'      
          
          
      Select Party_code,          
             Ledger=Sum(Ledger),          
             Imargin=Sum(Imargin),          
             Cash_colleteral=Sum(Cash_colleteral),          
             Noncash_colleteral=Sum(Noncash_colleteral),          
             Unrecosiled_credit=Sum(Unrecosiled_credit),          
             Samargin=Convert(Money, 0.0),          
           Varmargin=Convert(Money, 0.0),          
             Co_code          
      Into   #NET_AVAILABLE          
      From   #NET_AVAILABLE_PARTY (nolock)          
      Group  By Party_code,Co_code          
          
      /*------------------------------------          
      SPAN AND ADDITIONAL MARGIN          
      SEGMENT NSEFO,MCDXCDS,NSECURFO ONLY          
      ---------------------------------------*/          
      Select Party_code,          
             Initialmargin=Sum(Initialmargin),          
             Addmargin=Sum(Addmargin),          
             Co_code          
      Into   #SPAN_ADDI_MARGIN          
      From   Vw_derivativemargin (NOLOCK) A          
      Group  By Party_code,Co_code          
          
  ------ SPAN Margin Take 175% as per Bussines          
      ------Date 15-03-2012 SPAN Margin Take 100% only changes          
      ------**************************************          
      /*Update #NET_AVAILABLE          
      Set Samargin = (Initialmargin + Addmargin) * 1.75          
      From #SPAN_ADDI_MARGIN A          
      Where #net_available.Party_code = A.Party_code          
      And #net_available.Co_code = A.Co_code*/          
          
      Update #NET_AVAILABLE          
      Set    Samargin = (Initialmargin + Addmargin)          
      From   #SPAN_ADDI_MARGIN A          
      Where  #net_available.Party_code = A.Party_code          
             And #net_available.Co_code = A.Co_code          
          
      /*------------------------------------          
      VAR MARGIN          
      SEGMENT EQUITY (BSE & NSE) ONLY          
      ---------------------------------------*/          
      Select Party_code,          
             Varmargin=Sum(Varmargin),          
             Co_code          
      Into   #EQUITY_VAR_MARGIN          
      /*Changes Done By Rohit And Anil 24 Oct 2017 to change the Var margin logic*/
      /*From   Vw_equity_var_margin (NOLOCK) A */
      From   VW_Equity_Var_Margin_Pledge (NOLOCK) A          
      Group  By Party_code,Co_code          
          
      Update #NET_AVAILABLE          
      Set    Varmargin = (A.Varmargin)          
      From   #EQUITY_VAR_MARGIN A          
      Where  #net_available.Party_code = A.Party_code          
             And #net_available.Co_code = A.Co_code          
          
      --STEP 1          
      /*---------------------------------------------------------------          
      FETCHING CLIENTS WITH APPROVED HOLDING AND EXCLUDING CLIENTS          
      FROM TBL_CLI_NOT_FOR_PLEDGE TABLE          
      TABLE TBL_CLI_NOT_FOR_PLEDGE CONTAINS ALL CLIENTS FOR WHICH LOAN          
      HAS ALREADY BEEN TAKEN.          
      ---------------------------------------------------------------*/          
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED          
          
      Select Rms_date,          
             Party_code,          
             Convert(Money, 0)    As Net,          
             Holding_approved,        
             Convert(Smallint, 0) As Client_priority          
      Into   #TBL_CL_LIST_APPR_HOLD          
      From   GENERAL.dbo.Rms_dtclfi_summ With(NOLOCK)          
      Where  Holding_approved <> 0          
          
   /*          
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR          
   NOT TO EXLUDE NON LAS CLIENT          
   */          
      --AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK))          
          
      Update A          
      Set    Net = Isnull(Net_available, 0)          
      From   #TBL_CL_LIST_APPR_HOLD A          
             Left Outer Join (Select Party_code,          
                                     Sum(Ledger - Unrecosiled_credit - (Case          
       When (Samargin) - (Cash_colleteral + Noncash_colleteral) > 0 Then (Samargin) - (Cash_colleteral + Noncash_colleteral)          
                                                                         Else 0          
                                                                        End) - Varmargin) As Net_available          
                              From   #NET_AVAILABLE          
                              Group  By Party_code) B          
              On A.Party_code = B.Party_code          
          

		truncate table MIS_AppHld_data 
		insert into MIS_AppHld_data(Rms_date,Party_code,Net,Holding_approved,Client_priority) 
		select Rms_date,Party_code,Net,Holding_approved,Client_priority from #TBL_CL_LIST_APPR_HOLD
          
      /*CHANGE ID  :: 1*/    
      /*START CHANGE ID  :: 1*/    
      Select Party_Code    
        INTO #WCL_CLIENTS    
      from MIS.DBO.WCL_ActionRpt1(convert(datetime,GETDATE(),103))    
      where BOI+YES+SCB+ADH+AXS+HDF+KOT+IDF <> 0.00    
      
          
      update A    
        set Net = 0    
      FROM #TBL_CL_LIST_APPR_HOLD A INNER JOIN #WCL_CLIENTS B    
            ON A.Party_code = B.Party_Code    
         
     INSERT INTO PLEDGE_WCL_CLIENT_LOG(PARTY_CODE)     
     SELECT PARTY_CODE    
     FROM #WCL_CLIENTS    
         
     /*END CHANGE ID  :: 1*/    
          
      /*END*/          
      --STEP 2          
      /*---------------------------------------------------------------          
      GENERATING ROW NUMBER FOR LOOPING DEBIT CLIENTS          
      ---------------------------------------------------------------*/          
      Select *,          
             Row_number() Over(Order By Net) As Row_num          
      Into   #TBL_CL_LIST_APPR_HOLD_TMP          
      From   #TBL_CL_LIST_APPR_HOLD          
      Where  Net < 0          
      Order  By Net          
          
      --STEP 3          
      /*---------------------------------------------------------------          
      FETCHING HOLDING WHERE ACCNO <> (UNSETTLED OR EMPTY) AND          
   HOLDING VALUE <> 0          
      ---------------------------------------------------------------*/          
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED          
          
      --DROP TABLE #TBL_RMS_HOLDING_APPR_TMP          
      Select Party_code,          
             Isin,          
             Scrip_cd,          
             Sum(Qty)               As Qty,          
             Convert(Int, 0)        As Pledge_qty,          
             Convert(Int, Sum(Qty)) As Free_qty,          
             Convert(Money, 0)      As Hold_value,          
             --CONVERT( DECIMAL ( 2,2 ) , ( ( SUM( QTY*CLSRATE ) / SUM( QTY ) ) ) ) AS AVG_CLOSING,          
             Convert(Money, 0)      As Avg_closing,          
             Accno,          
             Scripname,          
             Convert(Smallint, 0)   As Scrip_priority          
      Into   #TBL_RMS_HOLDING_APPR_TMP          
      From   GENERAL.dbo.Rms_holding With(NOLOCK)          
      Where  Source = 'H'          
             And Accno In('1203320000000066', '1203320000000051','1203320009603460', '1203320000000028')          
      Group  By Party_code,Isin,Accno,Scrip_cd,Scripname          
      
      
          
   /*          
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR          
   NOT TO EXLUDE NON LAS CLIENT          
   */          
      --PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK)) AND                
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */      
      /*Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                                     '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate        
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209')*/       
            
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
              and #tbl_rms_holding_appr_tmp.Accno = A.Accno      
              
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000051'       
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin       
                    
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000066'       
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin       
                    
      --STEP 4          
      /*---------------------------------------------------------------          
      SETTING APPROVED SCRIP PRIORITY BANKS WISE          
      ---------------------------------------------------------------*/          
      Select Priority,          
             Bank_code,          
             Row_number() Over(Order By Priority) As Row_num          
      Into   #BANK_LST          
      From   GENERAL.dbo.Tbl_las_bank_master With(NOLOCK)          
      Where  Active_inactive = 1          
      Order  By Priority          
          
      Declare @BANK_CNT As Int,          
              @BANK_TTL As Int,          
              @PRIORITY As Int,          
              @BANK_CD  As Int          
          
      Select @BANK_TTL = Count(*)          
      From   #BANK_LST          
          
      Select @BANK_CNT = 1          
          
      While(@BANK_CNT <= @BANK_TTL)          
      Begin          
         Select @PRIORITY = Priority,          
                @BANK_CD = Bank_code          
         From   #BANK_LST          
   Where  Row_num = @BANK_CNT          
          
         Update #TBL_RMS_HOLDING_APPR_TMP          
         Set    Scrip_priority = @PRIORITY          
         Where  Scrip_cd In (Select Scode          
                             From   GENERAL.dbo.Vw_las_appr_bank_scrip With (NOLOCK)          
                             Where  Bank_code = @BANK_CD)          
                And Scrip_priority = 0          
          
         Set @BANK_CNT = @BANK_CNT + 1          
      End          
          
      Delete From #TBL_RMS_HOLDING_APPR_TMP          
      Where  Scrip_priority = 0          
          
      --STEP 5          
      /*-----------Add New Step For New request----------------------------------------------------          
      Clinet Pledged Priority 1st Previous Day Pleded Qty          
      ---------------------------------------------------------------*/          
      Select Party_code,          
             Isin,          
             Scrip_cd,          
             Sum(Pledge_qty)    As Qty,          
             Cast(0 As Int)     As Pledge_qty,          
             Sum(Pledge_qty)    As Free_qty,        
             Cast(0.0 As Money) As Hold_value,          
             Cast(0.0 As Money) As Avg_closing,          
             Accno,          
             Scripname,          
             Cast(0 As Int)     As Scrip_priority,          
             1                  As Client_priority          
      Into   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
      From   Tbl_party_pledge_data A (nolock)          
      Where  A.Processdate >= @LastProc_Date          
             And A.Processdate <= @LastProc_Date + ' 23:59:59'          
             And A.Pledge_qty <> 0          
      Group  By Party_code,Isin,Scrip_cd,Accno,Scripname          
          
      Select A.Party_code,          
             A.Isin,          
             A.Scrip_cd,          
             Qty=New_qty,          
             A.Pledge_qty,          
             Free_qty=New_qty,          
             A.Hold_value,          
             A.Avg_closing,          
             A.Accno,          
             A.Scripname,          
             Scrip_priority=A.New_scrip_priority          
      Into   #TBL_RMS_HOLDING_APPR_PRVEDAY          
      From   (Select A.*,          
                     New_qty= (Case          
                                When (A.Qty - B.Qty) >= 0 Then B.Qty          
                                Else A.Qty          
                               End),          
                     New_scrip_priority= A.Scrip_priority          
              From   (Select *          
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
                      Where  Scrip_priority = 0) A          
        Inner Join (Select *          
                                 From   #TBL_RMS_HOLDING_APPR_TMP          
                                 Where  Scrip_priority > 0) B          
                      On A.Isin = B.Isin          
                         And A.Scrip_cd = B.Scrip_cd          
                         And A.Accno = B.Accno          
                         And A.Party_code = B.Party_code          
              Union All          
              Select A.*,          
                     New_qty= B.Qty - A.Qty,          
                     New_scrip_priority= B.Scrip_priority          
              From   (Select *          
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
                      Where  Scrip_priority = 0) A          
                     Inner Join (Select *          
                                 From   #TBL_RMS_HOLDING_APPR_TMP          
                                 Where  Scrip_priority > 0) B          
                      On A.Isin = B.Isin          
                         And A.Scrip_cd = B.Scrip_cd          
                         And A.Accno = B.Accno          
                         And A.Party_code = B.Party_code          
              Where  A.Qty < B.Qty) A          
         
      Delete A          
      From   #TBL_RMS_HOLDING_APPR_TMP As A          
             Inner Join #TBL_RMS_HOLDING_APPR_PRVEDAY B          
              On A.Isin = B.Isin          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Accno = B.Accno          
                 And A.Party_code = B.Party_code          
          
      Insert Into #TBL_RMS_HOLDING_APPR_TMP          
      Select *          
      From   #TBL_RMS_HOLDING_APPR_PRVEDAY         
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */       
      /*      
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = A.Clsrate,          
             Hold_value = Qty * A.Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                                     '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209') */      
             
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
              Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = A.Accno      
              
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
               Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000051'       
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin       
                    
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                 Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000066'       
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin          
          
      --STEP 6          
      /*---------------------------------------------------------------          
      GENERATING HOLDING ROW NUMBER FOR LOOPING          
      ---------------------------------------------------------------*/          
      Select *,          
             Row_number() Over(PARTITION By Party_code Order By Scrip_priority, Hold_value Desc) As Row_num          
      /*,CONVERT(INT,0) AS PLEDGE_DP_QTY,          
      CONVERT(INT,0) AS AFTER_ADJUST_PLEDGE_QTY*/          
      Into   #TBL_RMS_HOLDING_APPR          
      From   #TBL_RMS_HOLDING_APPR_TMP          
      Where  Free_qty <> 0          
      Order  By Party_code,Scrip_priority,Hold_value Desc          
          
      --STEP 7          
      /*------------------------------          
      STORE CLINET WISE DETAILS          
      --------------------------------*/          
      Select A.Party_code,          
             Bsecm_ledger=Sum(Case Co_code          
                               When 'BSECM' Then Ledger          
                               Else 0          
                              End),          
             Nsecm_ledger=Sum(Case Co_code          
                               When 'NSECM' Then Ledger          
                               Else 0          
                              End),          
             Nsefo_ledger=Sum(Case Co_code          
                               When 'NSEFO' Then Ledger          
                               Else 0          
                              End),          
             Mcd_ledger=Sum(Case Co_code          
                             When 'MCD' Then Ledger          
                             Else 0          
                            End),          
             Mcx_ledger=Sum(Case Co_code          
                             When 'MCX' Then Ledger          
                             Else 0          
                            End),          
             Nbfc_ledger=Sum(Case Co_code          
                              When 'NBFC' Then Ledger         
                              Else 0          
                             End),          
             Ncdex_ledger=Sum(Case Co_code          
                               When 'NCDEX' Then Ledger          
                               Else 0          
                              End),          
             Nsx_ledger=Sum(Case Co_code          
                             When 'NSX' Then Ledger          
                             Else 0          
                            End),
   /*************added on 17 May 2018 *****************/                            
			MTF_ledger=Sum(Case Co_code            
                             When 'MTF' Then Ledger            
                             Else 0            
                            End),     
   /**********************************/                                  
             Bsecm_imargin=Sum(Case Co_code          
                                When 'BSECM' Then Imargin          
                                Else 0          
                               End),          
             Nsecm_imargin=Sum(Case Co_code          
                                When 'NSECM' Then Imargin          
                                Else 0          
                               End),          
             Nsefo_imargin=Sum(Case Co_code          
                                When 'NSEFO' Then Imargin          
                                Else 0          
                               End),          
             Mcd_imargin=Sum(Case Co_code          
                              When 'MCD' Then Imargin          
                              Else 0          
                             End),          
             Mcx_imargin=Sum(Case Co_code          
                              When 'MCX' Then Imargin          
                              Else 0          
                             End),          
             Nbfc_imargin=Sum(Case Co_code          
                               When 'NBFC' Then Imargin          
                               Else 0          
                              End),          
             Ncdex_imargin=Sum(Case Co_code          
                                When 'NCDEX' Then Imargin          
                                Else 0          
          End),          
             Nsx_imargin=Sum(Case Co_code          
                              When 'NSX' Then Imargin          
                              Else 0          
                             End),          
             Bsecm_cash_colleteral=Sum(Case Co_code          
                                        When 'BSECM' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsecm_cash_colleteral=Sum(Case Co_code          
                                        When 'NSECM' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsefo_cash_colleteral=Sum(Case Co_code          
                                        When 'NSEFO' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Mcd_cash_colleteral=Sum(Case Co_code          
                                      When 'MCD' Then Cash_colleteral          
                                      Else 0          
                       End),          
             Mcx_cash_colleteral=Sum(Case Co_code          
                                      When 'MCX' Then Cash_colleteral          
                                      Else 0          
                                     End),          
             Nbfc_cash_colleteral=Sum(Case Co_code          
                                       When 'NBFC' Then Cash_colleteral          
                                       Else 0          
                                      End),          
             Ncdex_cash_colleteral=Sum(Case Co_code          
                                        When 'NCDEX' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsx_cash_colleteral=Sum(Case Co_code          
                                      When 'NSX' Then Cash_colleteral          
                                      Else 0          
                                     End),          
        Bsecm_noncash_colleteral=Sum(Case Co_code          
                                           When 'BSECM' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsecm_noncash_colleteral=Sum(Case Co_code          
                                           When 'NSECM' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsefo_noncash_colleteral=Sum(Case Co_code          
                                           When 'NSEFO' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Mcd_noncash_colleteral=Sum(Case Co_code          
                                         When 'MCD' Then Noncash_colleteral          
                                         Else 0          
                                        End),          
             Mcx_noncash_colleteral=Sum(Case Co_code          
                                         When 'MCX' Then Noncash_colleteral          
                                         Else 0          
                                        End),          
             Nbfc_noncash_colleteral=Sum(Case Co_code          
                                          When 'NBFC' Then Noncash_colleteral          
                                          Else 0          
                                         End),          
             Ncdex_noncash_colleteral=Sum(Case Co_code          
                                           When 'NCDEX' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsx_noncash_colleteral=Sum(Case Co_code          
                                         When 'NSX' Then Noncash_colleteral          
                                         Else 0          
                     End),          
             Bsecm_unrecosiled_credit=Sum(Case Co_code          
                When 'BSECM' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsecm_unrecosiled_credit=Sum(Case Co_code    
                                           When 'NSECM' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsefo_unrecosiled_credit=Sum(Case Co_code          
                                           When 'NSEFO' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Mcd_unrecosiled_credit=Sum(Case Co_code          
                                         When 'MCD' Then Unrecosiled_credit          
                                         Else 0          
                                        End),          
             Mcx_unrecosiled_credit=Sum(Case Co_code          
                                         When 'MCX' Then Unrecosiled_credit          
                                         Else 0          
                                        End),          
             Nbfc_unrecosiled_credit=Sum(Case Co_code          
                When 'NBFC' Then Unrecosiled_credit          
                                          Else 0          
                                         End),          
             Ncdex_unrecosiled_credit=Sum(Case Co_code          
                                           When 'NCDEX' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsx_unrecosiled_credit=Sum(Case Co_code          
                                         When 'NSX' Then Unrecosiled_credit          
                                         Else 0          
                End),          
             Bsecm_varmargin=Convert(Money, 0.0),          
             Nsecm_varmargin=Convert(Money, 0.0),          
             Nsefo_varmargin=Convert(Money, 0.0),          
             Mcd_varmargin=Convert(Money, 0.0),          
             Mcx_varmargin=Convert(Money, 0.0),          
             Nbfc_varmargin=Convert(Money, 0.0),          
             Ncdex_varmargin=Convert(Money, 0.0),          
             Nsx_varmargin=Convert(Money, 0.0),          
             Bsecm_span_add_margin=Convert(Money, 0.0),          
             Nsecm_span_add_margin=Convert(Money, 0.0),          
             Nsefo_span_add_margin=Convert(Money, 0.0),          
             Mcd_span_add_margin=Convert(Money, 0.0),          
             Mcx_span_add_margin=Convert(Money, 0.0),          
             Nbfc_span_add_margin=Convert(Money, 0.0),          
             Ncdex_span_add_margin=Convert(Money, 0.0),          
             Nsx_span_add_margin=Convert(Money, 0.0)          
      Into   #PLEDGE_CLIENTWISELEDGER          
      From   #NET_AVAILABLE_PARTY A          
             Inner Join (Select Distinct Party_code          
                         From   #TBL_RMS_HOLDING_APPR) B          
              On A.Party_code = B.Party_code          
      Group  By A.Party_code          
          
      Update #PLEDGE_CLIENTWISELEDGER          
      Set    Bsecm_varmargin = A.Bsecm_varmargin,          
             Nsecm_varmargin = A.Nsecm_varmargin          
      From   (Select Party_code,          
                     Bsecm_varmargin=Sum(Case Co_code          
                                          When 'BSECM' Then Varmargin          
                                          Else 0          
                                         End),          
                     Nsecm_varmargin=Sum(Case Co_code          
                                          When 'NSECM' Then Varmargin          
                                          Else 0          
                                         End)   
			  /*Changes Done By Rohit And Anil 24 Oct 2017 to change the Var margin logic*/                                                
              /*From   Vw_equity_var_margin (NOLOCK)*/          
              From VW_Equity_Var_Margin_Pledge (NOLOCK)
              Group  By Party_code)A          
      Where  #pledge_clientwiseledger.Party_code = A.Party_code          
          
      Update #PLEDGE_CLIENTWISELEDGER          
      Set  Nsefo_span_add_margin = A.Nsefo_span_add_margin,          
             Mcd_span_add_margin = A.Mcd_span_add_margin,          
             Nsx_span_add_margin = A.Nsx_span_add_margin          
      From   (Select Party_code,          
                     Nsefo_span_add_margin=Sum(Case Co_code          
                                                When 'NSEFO' Then Initialmargin + Addmargin          
                                                Else 0          
                                               End),          
                     Mcd_span_add_margin=Sum(Case Co_code          
                                              When 'MCD' Then Initialmargin + Addmargin          
                                              Else 0          
                                             End),          
                     Nsx_span_add_margin=Sum(Case Co_code          
                                              When 'NSX' Then Initialmargin + Addmargin          
                                              Else 0          
                                             End)          
              From   Vw_derivativemargin (NOLOCK)          
              Group  By Party_code)A          
      Where  #pledge_clientwiseledger.Party_code = A.Party_code          
          
      Delete From Pledge_clientwiseledger          
      Where  Processdate >= Convert(Varchar, Getdate(), 106)          
             And Processdate <= Convert(Varchar, Getdate(), 106) + ' 23:59:59'          
          
      Insert Into Pledge_clientwiseledger(Party_code,BSECM_LEDGER,NSECM_LEDGER,NSEFO_LEDGER,MCD_LEDGER,MCX_LEDGER,NBFC_LEDGER,NCDEX_LEDGER,NSX_LEDGER,MTF_ledger,BSECM_IMARGIN,NSECM_IMARGIN,NSEFO_IMARGIN,MCD_IMARGIN,MCX_IMARGIN,NBFC_IMARGIN,NCDEX_IMARGIN,NSX_IMARGIN,BSECM_CASH_COLLETERAL,NSECM_CASH_COLLETERAL,NSEFO_CASH_COLLETERAL,MCD_CASH_COLLETERAL,MCX_CASH_COLLETERAL,NBFC_CASH_COLLETERAL,NCDEX_CASH_COLLETERAL,NSX_CASH_COLLETERAL,BSECM_NONCASH_COLLETERAL,NSECM_NONCASH_COLLETERAL,NSEFO_NONCASH_COLLETERAL,MCD_NONCASH_COLLETERAL,MCX_NONCASH_COLLETERAL,NBFC_NONCASH_COLLETERAL,NCDEX_NONCASH_COLLETERAL,NSX_NONCASH_COLLETERAL,BSECM_UNRECOSILED_CREDIT,NSECM_UNRECOSILED_CREDIT,NSEFO_UNRECOSILED_CREDIT,MCD_UNRECOSILED_CREDIT,MCX_UNRECOSILED_CREDIT,NBFC_UNRECOSILED_CREDIT,NCDEX_UNRECOSILED_CREDIT,NSX_UNRECOSILED_CREDIT,BSECM_VARMARGIN,NSECM_VARMARGIN,NSEFO_VARMARGIN,MCD_VARMARGIN,MCX_VARMARGIN,NBFC_VARMARGIN,NCDEX_VARMARGIN,NSX_VARMARGIN,BSECM_SPAN_ADD_MARGIN,NSECM_SPAN_ADD_MARGIN,NSEFO_SPAN_ADD_MARGIN,MCD_SPAN_ADD_MARGIN,MCX_SPAN_ADD_MARGIN,NBFC_SPAN_ADD_MARGIN,NCDEX_SPAN_ADD_MARGIN,NSX_SPAN_ADD_MARGIN,ProcessDate,ProcessBy)          
      Select Party_code,BSECM_LEDGER,NSECM_LEDGER,NSEFO_LEDGER,MCD_LEDGER,MCX_LEDGER,NBFC_LEDGER,NCDEX_LEDGER,NSX_LEDGER,MTF_ledger,BSECM_IMARGIN,NSECM_IMARGIN,NSEFO_IMARGIN,MCD_IMARGIN,MCX_IMARGIN,NBFC_IMARGIN,NCDEX_IMARGIN,NSX_IMARGIN,BSECM_CASH_COLLETERAL,NSECM_CASH_COLLETERAL,NSEFO_CASH_COLLETERAL,MCD_CASH_COLLETERAL,MCX_CASH_COLLETERAL,NBFC_CASH_COLLETERAL,NCDEX_CASH_COLLETERAL,NSX_CASH_COLLETERAL,BSECM_NONCASH_COLLETERAL,NSECM_NONCASH_COLLETERAL,NSEFO_NONCASH_COLLETERAL,MCD_NONCASH_COLLETERAL,MCX_NONCASH_COLLETERAL,NBFC_NONCASH_COLLETERAL,NCDEX_NONCASH_COLLETERAL,NSX_NONCASH_COLLETERAL,BSECM_UNRECOSILED_CREDIT,NSECM_UNRECOSILED_CREDIT,NSEFO_UNRECOSILED_CREDIT,MCD_UNRECOSILED_CREDIT,MCX_UNRECOSILED_CREDIT,NBFC_UNRECOSILED_CREDIT,NCDEX_UNRECOSILED_CREDIT,NSX_UNRECOSILED_CREDIT,BSECM_VARMARGIN,NSECM_VARMARGIN,NSEFO_VARMARGIN,MCD_VARMARGIN,MCX_VARMARGIN,NBFC_VARMARGIN,NCDEX_VARMARGIN,NSX_VARMARGIN,BSECM_SPAN_ADD_MARGIN,NSECM_SPAN_ADD_MARGIN,NSEFO_SPAN_ADD_MARGIN,MCD_SPAN_ADD_MARGIN,MCX_SPAN_ADD_MARGIN,NBFC_SPAN_ADD_MARGIN,NCDEX_SPAN_ADD_MARGIN,NSX_SPAN_ADD_MARGIN,          
             Processdate=Getdate(),          
             Processby=@USERNAME          
      From   #PLEDGE_CLIENTWISELEDGER          
          
   /*---------------------------------------------------------------          
   FETCHING PLEDGE SCRIPS          
   ---------------------------------------------------------------*/          
      --DROP TABLE #TBL_PLEDGE_QTY_TMP          
   /*SELECT HLD_AC_CODE AS ACCNO,HLD_ISIN_CODE AS ISIN,          
   HLD_AC_POS,HLD_AC_POS AS AFTER_ADJUST_PLEDGE_QTY,CONVERT(BIT,0) AS BANK_APPROVED          
   INTO #TBL_PLEDGE_QTY_TMP          
   FROM DPBACKOFFICE.ACERCROSS.DBO.HOLDING WITH (NOLOCK)          
   --WHERE HLD_AC_CODE IN ('1203320000000051','1203320000000066')          
   WHERE HLD_AC_CODE IN (SELECT ACCNO FROM TBL_LAS_PLEDGE_ACC_MASTER WHERE ACTIVE_INACTIVE=1)          
   AND HLD_AC_TYPE ='14' */          
      --STEP 8          
      /*---------------------------------------------------------------          
      CREATING INDEX TO OPTIMIZE SELECTION          
      ---------------------------------------------------------------*/          
      Create Clustered Index [IX_ROW_NUM]          
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Row_num] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Nonclustered Index [IX_CL_LIST_PARTY]          
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Party_code] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Clustered Index [IX_HOLDING_APPR_ROW_NUM]          
       On #TBL_RMS_HOLDING_APPR ( [Party_code] Asc, [Row_num] Asc          
      --[SCRIP_PRIORITY] ASC          
      )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      --STEP 9 DROP TABLE #TBL_PARTY_PLEDGE_DATA          
      /*---------------------------------------------------------------          
      CREATING TABLE FOR FINAL DATA          
      ---------------------------------------------------------------*/          
      Create Table #TBL_PARTY_PLEDGE_DATA          
       (          
         Rms_date         Datetime,          
         Party_code       Varchar(20),          
         Ledger_bal       Money,          
         Client_priority  Smallint,    
         Isin             Varchar(20),          
         Scrip_cd         Varchar(50),          
         Scripname        Varchar(100),          
         Accno            Varchar(50),          
         Qty  Int,          
         Pledge_qty       Int,          
         Free_qty         Int,          
         Hold_value       Money,          
         Avg_closing      Money,          
         Pledgeable_qty   Int,          
         Pledgeable_value Money,          
         Prevdaypledgeqty Int,          
         Release_qty      Int,          
         Scrip_priority   Smallint          
       )          
          
      --STEP 10          
      /*---------------------------------------------------------------          
      LOOP SPLIT CLIENT SCRIP TO CATEGORIZE TYPE          
      WHERE TYPES ARE AS FOLLOWS          
      1) EQUIVALENT TO DEBIT ( DR = STOCK VALUE * 2 )          
      2) REMAINING ALL SCRIPT FROM ABOVE PROCESS WILL COME HERE          
      3) ALL CREDIT CLIENT WILL COM IN THIS CATEGORY          
      ---------------------------------------------------------------*/          
      Declare @CNT_TOTAL               As Int,          
              @ROW_COUNTER_CLIENT      As Int,          
              @ROW_COUNTER_ISIN        As Int,          
              @PARTY_CODE              As Varchar(20),          
              @PERV_PARTY_CODE         As Varchar(20),          
              @LEDGER_BAL              As Money,          
              @QTY                     As Int,          
              @PLEDGEABLE_QTY          As Int,          
              @PLEDGE_QTY              As Int,          
              @FREE_QTY                As Int,          
              @HOLD_VALUE              As Money,          
              @ISIN                    As Varchar(20),          
              @SCRIP_CD                As Varchar(50),          
              @SCRIPNAME               As Varchar(100),          
              @ACCNO                   As Varchar(50),          
          @LEDGER_TMP              As Money,          
              @CLOSING_RATE            As Money,          
              @CLIENT_PRIORITY         As Smallint,          
              @SCRIP_PRIORITY          As Smallint,          
              @HOLDING_ADJUSTED_VALUE  As Money,          
              @PLEDGEABLE_VALUE  As Money,          
              @COUNTINUE_LOOP          As Bit,          
              @AFTER_ADJUST_PLEDGE_QTY As Int,          
              @RMS_DATE                As Datetime,          
              @QTY_DIFF                As Int,          
              @SCRIP_CNT_TOTAL         As Int,          
              @SCRIP_CTR               As Int          
          
      Select @CNT_TOTAL = Count(1)          
      From   #TBL_CL_LIST_APPR_HOLD_TMP --WHERE CLIENT_PRIORITY <= 2          
          
      --PRINT @CNT_TOTAL          
      Set @ROW_COUNTER_CLIENT = 1--45943--24245          
          
      While @ROW_COUNTER_CLIENT <= @CNT_TOTAL --45943 --24246          
      Begin          
         Select @RMS_DATE = Rms_date,          
                @PARTY_CODE = Party_code,          
                @LEDGER_BAL = Net          
         From   #TBL_CL_LIST_APPR_HOLD_TMP          
         Where  Row_num = @ROW_COUNTER_CLIENT          
          
         Set @SCRIP_CNT_TOTAL = 0          
          
         Set @SCRIP_CTR = 1          
          
         Set @CLIENT_PRIORITY = 1          
          
         Select @SCRIP_CNT_TOTAL = Count(*)          
         From   #TBL_RMS_HOLDING_APPR          
         Where  Party_code = @PARTY_CODE          
          
         Set @HOLDING_ADJUSTED_VALUE = 0          
          
         Set @COUNTINUE_LOOP = 1          
          
         --PRINT '--------------------------'          
         --PRINT CONVERT(VARCHAR,@ROW_COUNTER_CLIENT)+'.) '+@PARTY_CODE+ ' $LEDGER BAL :- '+CONVERT(VARCHAR,@LEDGER_BAL) + ' $PLEDGE VALUE :- '+CONVERT(VARCHAR,@LEDGER_BAL*2)          
         --PRINT ' SCRIP (NO OF SCRIPS ['+CONVERT(VARCHAR,@SCRIP_CNT_TOTAL)+'])'          
         While(@SCRIP_CTR <= @SCRIP_CNT_TOTAL)          
         Begin          
            Set @PLEDGEABLE_QTY = 0          
          
            Set @PLEDGEABLE_VALUE = 0          
          
            Select @ISIN = A.Isin,          
                   @SCRIP_CD = Scrip_cd,          
                   @SCRIPNAME = Scripname,          
                   @QTY = Qty,          
                   @PLEDGE_QTY = Pledge_qty,          
                   @FREE_QTY = Free_qty,          
                   @HOLD_VALUE = Hold_value,          
             @ACCNO = A.Accno,          
                   @CLOSING_RATE = Avg_closing,          
                   @SCRIP_PRIORITY = Scrip_priority          
            From   #TBL_RMS_HOLDING_APPR A          
            Where  Party_code = @PARTY_CODE          
                   And Row_num = @SCRIP_CTR          
          
            If @HOLDING_ADJUSTED_VALUE < Abs(@LEDGER_BAL) * 2          
            Begin          
               If (@HOLDING_ADJUSTED_VALUE + @HOLD_VALUE) > Abs(@LEDGER_BAL) * 2          
               Begin          
                  --SET @QTY_DIFF = CEILING( ( ( ABS( @LEDGER_BAL ) * 2 - ( @HOLDING_ADJUSTED_VALUE) ) / @CLOSING_RATE ) )          
                  Set @QTY_DIFF = Floor(((Abs(@LEDGER_BAL) * 2 - (@HOLDING_ADJUSTED_VALUE)) / @CLOSING_RATE))          
          
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + (@QTY_DIFF * @CLOSING_RATE)          
          
                  Set @HOLD_VALUE = @QTY_DIFF * @CLOSING_RATE          
          
                  Set @FREE_QTY = @FREE_QTY - @QTY_DIFF          
          
                  Set @QTY = @QTY_DIFF          
          
                  Set @PLEDGEABLE_QTY = @QTY          
          
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
          
                  --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +          
                  --' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- ' +          
                  --CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
                  If @QTY > 0          
                  Begin          
                     Insert Into #TBL_PARTY_PLEDGE_DATA          
                     Values      (@RMS_DATE,          
                                  @PARTY_CODE,          
                                  @LEDGER_BAL,          
                                  @CLIENT_PRIORITY,          
                                  @ISIN,          
                                  @SCRIP_CD,          
                                  @SCRIPNAME,          
                                  @ACCNO,          
                                  @QTY,          
                                  @PLEDGE_QTY,          
                                  @QTY_DIFF,          
                                  @HOLD_VALUE,          
                                  @CLOSING_RATE,          
                                  @PLEDGEABLE_QTY,          
                                  @PLEDGEABLE_VALUE,          
                                  0,          
                                  0,          
                                  @SCRIP_PRIORITY)          
                  End          
          
                  Set @QTY = @FREE_QTY          
          
                  Set @HOLD_VALUE = @FREE_QTY * @CLOSING_RATE          
          
                  Set @PLEDGEABLE_QTY = @QTY          
          
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
          
                  Set @CLIENT_PRIORITY = 2          
               --BREAK          
               End          
               Else          
               Begin          
                  Set @PLEDGEABLE_QTY = @FREE_QTY          
          
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE          
          
  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
               End          
          
               --SET @PLEDGEABLE_VALUE = @PLEDGEABLE_QTY*@CLOSING_RATE          
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY)          
               --+ ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '          
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
               If @QTY > 0          
               Begin          
                  Insert Into #TBL_PARTY_PLEDGE_DATA          
                  Values      (@RMS_DATE,          
                               @PARTY_CODE,          
                               @LEDGER_BAL,          
                               @CLIENT_PRIORITY,          
                               @ISIN,          
                               @SCRIP_CD,          
                               @SCRIPNAME,          
                               @ACCNO,          
                               @QTY,          
                               @PLEDGE_QTY,          
                               @FREE_QTY,          
                               @HOLD_VALUE,          
                               @CLOSING_RATE,          
                               @PLEDGEABLE_QTY,          
                               @PLEDGEABLE_VALUE,          
                               0,          
                               0,          
                               @SCRIP_PRIORITY)          
               End          
            End          
            Else          
            Begin          
               Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE          
          
               Set @CLIENT_PRIORITY = 2          
          
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +          
               -- ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '          
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
               If @QTY > 0          
               Begin          
                  Insert Into #TBL_PARTY_PLEDGE_DATA          
                  Values      (@RMS_DATE,          
                               @PARTY_CODE,          
                               @LEDGER_BAL,          
                               @CLIENT_PRIORITY,          
                               @ISIN,          
                               @SCRIP_CD,          
                               @SCRIPNAME,          
                               @ACCNO,          
                               @QTY,          
                               @PLEDGE_QTY,          
                               @FREE_QTY,          
                               @HOLD_VALUE,          
                               @CLOSING_RATE,          
                               @PLEDGEABLE_QTY,          
                               @PLEDGEABLE_VALUE,          
                               0,          
                               0,          
                               @SCRIP_PRIORITY)          
          
               End          
            End          
          
            If ((@CLIENT_PRIORITY = 2)          
                And (@SCRIP_CTR < @SCRIP_CNT_TOTAL))          
            Begin          
               Insert Into #TBL_PARTY_PLEDGE_DATA          
               Select @RMS_DATE,          
                      @PARTY_CODE,          
                      @LEDGER_BAL,          
                      @CLIENT_PRIORITY,          
                      A.Isin,          
                      Scrip_cd,          
                      Scripname,          
                      A.Accno,          
                      Qty,          
                      Pledge_qty,          
                      Free_qty,          
                      Hold_value,          
                      Avg_closing,          
                      Free_qty                               As Pledgeable_qty,          
                      Convert(Money, Free_qty * Avg_closing) As Pledgeable_value,          
                      0                                      As Prevdaypledgeqty,          
                      0                                      As Release_qty,          
                      Scrip_priority          
               From   #TBL_RMS_HOLDING_APPR A          
               Where  Party_code = @PARTY_CODE          
                      And Row_num > @SCRIP_CTR          
          
               Break          
            End          
          
            Set @SCRIP_CTR = @SCRIP_CTR + 1          
         End          
          
         --PRINT ' ADJUSTED VALUE :- '+CONVERT(VARCHAR,@HOLDING_ADJUSTED_VALUE)          
         Set @ROW_COUNTER_CLIENT = @ROW_COUNTER_CLIENT + 1          
      End          
          
      --drop table #prevDayReleaseQty          
      Select A.Isin,          
             A.Party_code,          
             A.Scrip_cd,          
             A.Scripname,          
             A.Accno,          
             Releaseqty =Isnull(A.Qty, 0) - Isnull(B.Pledge_qty, 0),          
           Prevdaypledge=Isnull(A.Qty, 0),          
             A.Client_priority,          
             Ledger_bal=Convert(Money, 0.0),          
             Avg_closing=Convert(Money, 0.0)          
      Into   #prevDayReleaseQty          
      From   (Select *          
              From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
              Where  Scrip_priority = 0) A          
             Left Join (Select Party_code,          
                               Isin,          
                               Scrip_cd,          
                               Accno,          
                               Pledge_qty=Sum(Pledgeable_qty),          
                               Client_priority          
                        From   #TBL_PARTY_PLEDGE_DATA          
                        Where  Client_priority = 1 --Scrip_priority > 0 and          
                        Group  By Party_code,Isin,Scrip_cd,Accno,Client_priority) B          
              On A.Isin = B.Isin          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Accno = B.Accno          
                 And A.Party_code = B.Party_code          
      Where  Isnull(A.Qty, 0) > Isnull(B.Pledge_qty, 0)          
          
      Update #prevDayReleaseQty          
      Set    #prevdayreleaseqty.Ledger_bal = A.Net          
      From   #TBL_CL_LIST_APPR_HOLD A          
      Where  A.Party_code = #prevdayreleaseqty.Party_code          
            
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */      
      /*Update #prevDayReleaseQty          
      Set    Avg_closing = Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #prevdayreleaseqty.Isin = A.Isin          
             And #prevdayreleaseqty.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                              '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #prevDayReleaseQty          
      Set    Avg_closing = Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #prevdayreleaseqty.Isin = A.Isin          
             And #prevdayreleaseqty.Accno In ('1203320000000066', '16921197', '14216209')*/      
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate      
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #prevDayReleaseQty.Isin = A.Isin          
              and #prevDayReleaseQty.Accno = A.Accno      
              
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #prevDayReleaseQty.Accno = '1203320000000051'       
              and #prevDayReleaseQty.Isin = A.Isin       
                    
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate        
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #prevDayReleaseQty.Accno = '1203320000000066'       
              and #prevDayReleaseQty.Isin = A.Isin                  
          
      Update A          
      Set    A.Prevdaypledgeqty = B.Prevdaypledge,          
             A.Release_qty = B.Releaseqty          
      From   #TBL_PARTY_PLEDGE_DATA A          
             Inner Join (Select *          
                         From   #prevDayReleaseQty A          
                         Where  Exists (Select *          
                                        From   #TBL_PARTY_PLEDGE_DATA B          
                                        Where  A.Isin = B.Isin          
                                               And A.Accno = B.Accno          
                                               And A.Scrip_cd = B.Scrip_cd          
                                               And A.Party_code = B.Party_code          
                                               And A.Client_priority = B.Client_priority)) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Party_code = B.Party_code          
                 And A.Client_priority = B.Client_priority          
          
      Update A          
      Set    A.Prevdaypledgeqty = B.Qty--b.PrevDayPledge          
      From   #TBL_PARTY_PLEDGE_DATA A          
             Inner Join (Select *          
                         From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY A          
                        --Where exists (Select * from #TBL_PARTY_PLEDGE_DATA b          
                        --where a.isin=b.isin and a.accno=b.accno and a.scrip_cd=b.scrip_cd and a.party_code=b.party_code          
                        --and a.client_priority=b.client_priority)          
                        ) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Party_code = B.Party_code          
                 And A.Client_priority = B.Client_priority          
                 And A.Scrip_priority = B.Scrip_priority          
          
      --Declare @Rms_date As Datetime          
      Select @Rms_date = Max(Rms_date)          
      From   #TBL_PARTY_PLEDGE_DATA          
          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select Rms_date=@Rms_date,          
             Party_code,          
             Ledger_bal,          
             Client_priority=3,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty=0,          
             Pledge_qty=0,          
             Free_qty=0,          
             Hold_value=0,          
             Avg_closing,          
             Pledgeable_qty=0,          
             Pledgeable_value=0,          
             Prevdaypledgeqty=Prevdaypledge,          
             Release_qty=Releaseqty,          
             Scrip_priority=1          
      From   #prevDayReleaseQty A          
      Where  Not Exists (Select *          
                         From   #TBL_PARTY_PLEDGE_DATA B          
                         Where  A.Isin = B.Isin          
                                And A.Accno = B.Accno          
                                And A.Scrip_cd = B.Scrip_cd          
                                And A.Party_code = B.Party_code          
                                And A.Client_priority = B.Client_priority)          
          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select Rms_date=@Rms_date,          
             Party_code,          
             Ledger_bal,          
             Client_priority=4,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty,          
             Pledge_qty=0,          
             Free_qty,          
             Hold_value,          
             Avg_closing,          
             Pledgeable_qty= Free_qty,          
             Pledgeable_value=0,          
             Prevday_pledege_qty=Release_qty,          
             Release_qty,          
             Scrip_priority          
      From   Tbl_party_pledge_data (nolock)          
      Where  Party_code = 'Unknown'          
             And Client_priority = 1          
             And Processdate >= @LastProc_Date          
             And Processdate <= @LastProc_Date + ' 23:59:59'          
          
      ---*****Save Creditor Client For Adjustment of Pledge excces Adjustment          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select B.Rms_date,          
             B.Party_code,          
             Ledger_bal=B.Net,          
             Client_priority=4,          
             A.Isin,          
             A.Scrip_cd,          
             A.Scripname,          
             A.Accno,          
             A.Qty,         
             Pledge_qty=0,          
             A.Free_qty,          
             A.Hold_value,          
             A.Avg_closing,          
             Pledgeable_qty=A.Free_qty,          
             Pledgeable_value=Convert(Money, A.Free_qty * A.Avg_closing),          
             Prevdaypledgeqty=0,          
             Release_qty=0,          
             A.Scrip_priority          
      From   (Select *          
              From   #TBL_RMS_HOLDING_APPR) A          
             Inner Join (Select *          
                         From   #TBL_CL_LIST_APPR_HOLD          
                         Where  Net >= 0) B          
              On B.Party_code = A.Party_code          
          
      Begin Tran          
          
      Insert Into Tbl_party_pledge_data_log          
      Select *          
      From   Tbl_party_pledge_data (nolock)          
    
      /*Delete from Tbl_party_pledge_data          
      Where Processdate >= Convert(varchar,Getdate(),106)          
      And Processdate <= Convert(varchar,Getdate(),106) + ' 23:59:59'*/          
          
      Truncate Table Tbl_party_pledge_data          
          
      Insert Into Tbl_party_pledge_data          
      Select *,          
             Processdate=Getdate(),          
             @USERNAME          
      From   #TBL_PARTY_PLEDGE_DATA          
          
      Commit          
   End          
          
   Set nocount Off          
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_client_holding_03082013
-- --------------------------------------------------
CREATE Procedure Usp_las_pledge_client_holding_03082013
(      
 @USERNAME Varchar(10)      
)      
As      
Begin      
   Set NOCOUNT On      
      
   If Not Exists (Select Hdate      
                  From   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)      
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))      
   Begin      
      Declare @LastProc_Date As Datetime      
      
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)      
      From   Tbl_party_pledge_data (nolock)      
      
      Select Party_code,      
             Co_code,      
             Convert(Money, 0) As Ledger,      
             Imargin,      
             Cash_colleteral,      
             Noncash_colleteral,      
             Unrecosiled_credit      
      Into   #NET_AVAILABLE_PARTY      
      From   General.dbo.Rms_dtclfi With(NOLOCK)      
      Where  Co_code Not In ('MCX', 'NCDEX')      
      
      Declare @ACCOPENINGDATE   As Varchar(11),      
              @EXCLUDEOPBALDATE As Varchar(11)      
      
      Select @ACCOPENINGDATE = '04-01-' + Convert(Varchar, Case      
                                                            When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('JAN', 'FEB', 'MAR') Then Datepart(YY, Getdate()) - 2      
                                                            Else Datepart(YY, Getdate()) - 1      
                                                           End),      
             @EXCLUDEOPBALDATE = (Case      
                                   When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('APR') Then '01-01-' + Convert(Varchar, Datepart(YY, Getdate()))      
                                   Else '01-01-1900'      
                                  End)      
      
      --Set @ACCOPENINGDATE='Apr 01 2010'      
      
      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (Select Cltcode,      
                                      Sum(Case      
                                           When Drcr = 'D' Then -Vamt      
                                           Else Vamt      
                                          End) As Bal      
                               From   General.dbo.Bsecm_cledger With(NOLOCK)      
                               Where  Vdt >= @ACCOPENINGDATE      
                                      And Edt <= Convert(Varchar(11), Getdate() - 1) + ' 23:59:59'      
                               --And Not (Vtyp = 18      
                               -- And Vdt = @EXCLUDEOPBALDATE)      
                               Group  By Cltcode      
                               Having Sum(Case      
                                           When Drcr = 'D' Then -Vamt      
                                           Else Vamt      
                                          End) <> 0) B      
              On A.Party_code = B.Cltcode      
      Where  Co_code = 'BSECM'      
      
      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (Select Cltcode,      
                                      Sum(Case      
                                           When Drcr = 'D' Then -Vamt      
                                           Else Vamt      
                                          End) As Bal      
                               From   General.dbo.Nsecm_cledger With(NOLOCK)      
                               Where  Vdt >= @ACCOPENINGDATE      
                                      And Edt <= Convert(Varchar(11), Getdate() - 1) + ' 23:59:59'      
                               --And Not (Vtyp = 18      
                               -- And Vdt = @EXCLUDEOPBALDATE)      
                               Group  By Cltcode      
                               Having Sum(Case      
                                           When Drcr = 'D' Then -Vamt      
                    Else Vamt      
                                          End) <> 0) B      
              On A.Party_code = B.Cltcode      
      Where  Co_code = 'NSECM'      
      
      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (Select Cltcode,      
                                Sum(Case      
                                           When Drcr = 'D' Then -Vamt      
                                           Else Vamt      
                                          End) As Bal      
                               From   General.dbo.Nsefo_cledger With(NOLOCK)      
                               Where  Vdt >= @ACCOPENINGDATE      
                                      And Edt <= Convert(Varchar(11), Getdate() - 1) + ' 23:59:59'      
                               --And Not (Vtyp = 18      
                               -- And Vdt = @EXCLUDEOPBALDATE)      
                               Group  By Cltcode      
                               Having Sum(Case      
                                           When Drcr = 'D' Then -Vamt      
                                           Else Vamt      
                                          End) <> 0) B      
              On A.Party_code = B.Cltcode      
      Where  Co_code = 'NSEFO'      
      
      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (Select Cltcode,      
                                      Sum(Case      
                                           When Drcr = 'D' Then -Vamt      
                                           Else Vamt      
                                          End) As Bal      
                               From   General.dbo.Mcd_cledger With(NOLOCK)      
                               Where  Vdt >= @ACCOPENINGDATE      
                                      And Edt <= Convert(Varchar(11), Getdate() - 1) + ' 23:59:59'      
                               --And Not (Vtyp = 18      
                               -- And Vdt = @EXCLUDEOPBALDATE)      
                               Group  By Cltcode      
                               Having Sum(Case      
                                           When Drcr = 'D' Then -Vamt      
                                           Else Vamt      
                                          End) <> 0) B      
              On A.Party_code = B.Cltcode      
      Where  Co_code = 'MCD'      
      
      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (Select Cltcode,      
                                      Sum(Case      
                                           When Drcr = 'D' Then -Vamt      
                                           Else Vamt      
                                          End) As Bal      
                               From   General.dbo.Nsx_cledger With(NOLOCK)      
                               Where  Vdt >= @ACCOPENINGDATE      
                                      And Edt <= Convert(Varchar(11), Getdate() - 1) + ' 23:59:59'      
                               --And Not (Vtyp = 18      
                               -- And Vdt = @EXCLUDEOPBALDATE)      
                               Group  By Cltcode      
                               Having Sum(Case      
                                           When Drcr = 'D' Then -Vamt      
                                           Else Vamt      
                                          End) <> 0) B      
              On A.Party_code = B.Cltcode      
      Where  Co_code = 'NSX'      
      
      Select Party_code,      
             Ledger=Sum(Ledger),      
             Imargin=Sum(Imargin),      
             Cash_colleteral=Sum(Cash_colleteral),      
             Noncash_colleteral=Sum(Noncash_colleteral),      
             Unrecosiled_credit=Sum(Unrecosiled_credit),      
             Samargin=Convert(Money, 0.0),      
           Varmargin=Convert(Money, 0.0),      
             Co_code      
      Into   #NET_AVAILABLE      
      From   #NET_AVAILABLE_PARTY (nolock)      
      Group  By Party_code,Co_code      
      
      /*------------------------------------      
      SPAN AND ADDITIONAL MARGIN      
      SEGMENT NSEFO,MCDXCDS,NSECURFO ONLY      
      ---------------------------------------*/      
      Select Party_code,      
             Initialmargin=Sum(Initialmargin),      
             Addmargin=Sum(Addmargin),      
             Co_code      
      Into   #SPAN_ADDI_MARGIN      
      From   Vw_derivativemargin (NOLOCK) A      
      Group  By Party_code,Co_code      
      
  ------ SPAN Margin Take 175% as per Bussines      
      ------Date 15-03-2012 SPAN Margin Take 100% only changes      
      ------**************************************      
      /*Update #NET_AVAILABLE      
      Set Samargin = (Initialmargin + Addmargin) * 1.75      
      From #SPAN_ADDI_MARGIN A      
      Where #net_available.Party_code = A.Party_code      
      And #net_available.Co_code = A.Co_code*/      
      
      Update #NET_AVAILABLE      
      Set    Samargin = (Initialmargin + Addmargin)      
      From   #SPAN_ADDI_MARGIN A      
      Where  #net_available.Party_code = A.Party_code      
             And #net_available.Co_code = A.Co_code      
      
      /*------------------------------------      
      VAR MARGIN      
      SEGMENT EQUITY (BSE & NSE) ONLY      
      ---------------------------------------*/      
      Select Party_code,      
             Varmargin=Sum(Varmargin),      
             Co_code      
      Into   #EQUITY_VAR_MARGIN      
      From   Vw_equity_var_margin (NOLOCK) A      
      Group  By Party_code,Co_code      
      
      Update #NET_AVAILABLE      
      Set    Varmargin = (A.Varmargin)      
      From   #EQUITY_VAR_MARGIN A      
      Where  #net_available.Party_code = A.Party_code      
             And #net_available.Co_code = A.Co_code      
      
      --STEP 1      
      /*---------------------------------------------------------------      
      FETCHING CLIENTS WITH APPROVED HOLDING AND EXCLUDING CLIENTS      
      FROM TBL_CLI_NOT_FOR_PLEDGE TABLE      
      TABLE TBL_CLI_NOT_FOR_PLEDGE CONTAINS ALL CLIENTS FOR WHICH LOAN      
      HAS ALREADY BEEN TAKEN.      
      ---------------------------------------------------------------*/      
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED      
      
      Select Rms_date,      
             Party_code,      
             Convert(Money, 0)    As Net,      
             Holding_approved,      
             Convert(Smallint, 0) As Client_priority      
      Into   #TBL_CL_LIST_APPR_HOLD      
      From   GENERAL.dbo.Rms_dtclfi_summ With(NOLOCK)      
      Where  Holding_approved <> 0      
      
   /*      
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR      
   NOT TO EXLUDE NON LAS CLIENT      
   */      
      --AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK))      
      
      Update A      
      Set    Net = Isnull(Net_available, 0)      
      From   #TBL_CL_LIST_APPR_HOLD A      
             Left Outer Join (Select Party_code,      
                                     Sum(Ledger - Unrecosiled_credit - (Case      
                                                                         When (Samargin) - (Cash_colleteral + Noncash_colleteral) > 0 Then (Samargin) - (Cash_colleteral + Noncash_colleteral)      
                                                                         Else 0      
                                                                        End) - Varmargin) As Net_available      
                              From   #NET_AVAILABLE      
                              Group  By Party_code) B      
              On A.Party_code = B.Party_code      
      
   /*END*/      
      --STEP 2      
      /*---------------------------------------------------------------      
      GENERATING ROW NUMBER FOR LOOPING DEBIT CLIENTS      
      ---------------------------------------------------------------*/      
      Select *,      
             Row_number() Over(Order By Net) As Row_num      
      Into   #TBL_CL_LIST_APPR_HOLD_TMP      
      From   #TBL_CL_LIST_APPR_HOLD      
      Where  Net < 0      
      Order  By Net      
      
      --STEP 3      
      /*---------------------------------------------------------------      
      FETCHING HOLDING WHERE ACCNO <> (UNSETTLED OR EMPTY) AND      
   HOLDING VALUE <> 0      
      ---------------------------------------------------------------*/      
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED      
      
      --DROP TABLE #TBL_RMS_HOLDING_APPR_TMP      
      Select Party_code,      
             Isin,      
             Scrip_cd,      
             Sum(Qty)               As Qty,      
             Convert(Int, 0)        As Pledge_qty,      
             Convert(Int, Sum(Qty)) As Free_qty,      
             Convert(Money, 0)      As Hold_value,      
             --CONVERT( DECIMAL ( 2,2 ) , ( ( SUM( QTY*CLSRATE ) / SUM( QTY ) ) ) ) AS AVG_CLOSING,      
             Convert(Money, 0)      As Avg_closing,      
             Accno,      
             Scripname,      
             Convert(Smallint, 0)   As Scrip_priority      
      Into   #TBL_RMS_HOLDING_APPR_TMP      
      From   GENERAL.dbo.Rms_holding With(NOLOCK)      
      Where  Source = 'H'      
             And Accno In('1203320000000066', '1203320000000051')      
      Group  By Party_code,Isin,Accno,Scrip_cd,Scripname      
      
   /*      
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR      
   NOT TO EXLUDE NON LAS CLIENT      
   */      
      --PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK)) AND      
      /* Comment on 09 May 2012  
      PRMS Request ID 10141041   
      */  
      /*Update #TBL_RMS_HOLDING_APPR_TMP      
      Set    Avg_closing = Clsrate,      
             Hold_value = Qty * Clsrate      
      From   (Select Isin,      
                     Clsrate      
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A      
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin      
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate      
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',      
                                                     '1203320000000051', '1203320004025849', '1203320004574264')      
      
      Update #TBL_RMS_HOLDING_APPR_TMP      
      Set    Avg_closing = Clsrate,      
             Hold_value = Qty * Clsrate      
      From   (Select Isin,      
                     Clsrate      
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A      
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin      
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate      
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209')*/   
        
       Update #TBL_RMS_HOLDING_APPR_TMP      
       Set    Avg_closing = Clsrate,      
             Hold_value = Qty * Clsrate      
       From   (Select Isin,      
                     Clsrate,Accno      
              From   Vw_equity_cls_rate With(NOLOCK)) A      
       Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin      
              and #tbl_rms_holding_appr_tmp.Accno = A.Accno  
          
       Update #TBL_RMS_HOLDING_APPR_TMP      
       Set    Avg_closing = Clsrate,      
             Hold_value = Qty * Clsrate      
       From   (Select Isin,      
                     Clsrate,Accno      
              From   Vw_equity_cls_rate With(NOLOCK)  
              Where  Accno In ('1203320000000066')) A      
       Where  Avg_closing=0      
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000051'   
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin   
                
       Update #TBL_RMS_HOLDING_APPR_TMP      
       Set    Avg_closing = Clsrate,      
             Hold_value = Qty * Clsrate      
       From   (Select Isin,      
                     Clsrate,Accno      
              From   Vw_equity_cls_rate With(NOLOCK)  
              Where  Accno In ('1203320000000051')) A      
       Where  Avg_closing=0      
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000066'   
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin   
                
      --STEP 4      
      /*---------------------------------------------------------------      
      SETTING APPROVED SCRIP PRIORITY BANKS WISE      
      ---------------------------------------------------------------*/      
      Select Priority,      
             Bank_code,      
             Row_number() Over(Order By Priority) As Row_num      
      Into   #BANK_LST      
      From   GENERAL.dbo.Tbl_las_bank_master With(NOLOCK)      
      Where  Active_inactive = 1      
      Order  By Priority      
      
      Declare @BANK_CNT As Int,      
              @BANK_TTL As Int,      
              @PRIORITY As Int,      
              @BANK_CD  As Int      
      
      Select @BANK_TTL = Count(*)      
      From   #BANK_LST      
      
      Select @BANK_CNT = 1      
      
      While(@BANK_CNT <= @BANK_TTL)      
      Begin      
         Select @PRIORITY = Priority,      
                @BANK_CD = Bank_code      
         From   #BANK_LST      
         Where  Row_num = @BANK_CNT      
      
         Update #TBL_RMS_HOLDING_APPR_TMP      
         Set    Scrip_priority = @PRIORITY      
         Where  Scrip_cd In (Select Scode      
                             From   GENERAL.dbo.Vw_las_appr_bank_scrip With (NOLOCK)      
                             Where  Bank_code = @BANK_CD)      
                And Scrip_priority = 0      
      
         Set @BANK_CNT = @BANK_CNT + 1      
      End      
      
      Delete From #TBL_RMS_HOLDING_APPR_TMP      
      Where  Scrip_priority = 0      
      
      --STEP 5      
      /*-----------Add New Step For New request----------------------------------------------------      
      Clinet Pledged Priority 1st Previous Day Pleded Qty      
      ---------------------------------------------------------------*/      
      Select Party_code,      
             Isin,      
             Scrip_cd,      
             Sum(Pledge_qty)    As Qty,      
             Cast(0 As Int)     As Pledge_qty,      
             Sum(Pledge_qty)    As Free_qty,      
             Cast(0.0 As Money) As Hold_value,      
             Cast(0.0 As Money) As Avg_closing,      
             Accno,      
             Scripname,      
             Cast(0 As Int)     As Scrip_priority,      
             1                  As Client_priority      
      Into   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY      
      From   Tbl_party_pledge_data A (nolock)      
      Where  A.Processdate >= @LastProc_Date      
             And A.Processdate <= @LastProc_Date + ' 23:59:59'      
             And A.Pledge_qty <> 0      
      Group  By Party_code,Isin,Scrip_cd,Accno,Scripname      
      
      Select A.Party_code,      
             A.Isin,      
             A.Scrip_cd,      
             Qty=New_qty,      
             A.Pledge_qty,      
             Free_qty=New_qty,      
             A.Hold_value,      
             A.Avg_closing,      
             A.Accno,      
             A.Scripname,      
             Scrip_priority=A.New_scrip_priority      
      Into   #TBL_RMS_HOLDING_APPR_PRVEDAY      
      From   (Select A.*,      
                     New_qty= (Case      
                                When (A.Qty - B.Qty) >= 0 Then B.Qty      
                                Else A.Qty      
                               End),      
                     New_scrip_priority= A.Scrip_priority      
              From   (Select *      
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY      
                      Where  Scrip_priority = 0) A      
        Inner Join (Select *      
                                 From   #TBL_RMS_HOLDING_APPR_TMP      
                                 Where  Scrip_priority > 0) B      
                      On A.Isin = B.Isin      
                         And A.Scrip_cd = B.Scrip_cd      
                         And A.Accno = B.Accno      
                         And A.Party_code = B.Party_code      
              Union All      
              Select A.*,      
                     New_qty= B.Qty - A.Qty,      
                     New_scrip_priority= B.Scrip_priority      
              From   (Select *      
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY      
                      Where  Scrip_priority = 0) A      
                     Inner Join (Select *      
                                 From   #TBL_RMS_HOLDING_APPR_TMP      
                                 Where  Scrip_priority > 0) B      
                      On A.Isin = B.Isin      
                         And A.Scrip_cd = B.Scrip_cd      
                         And A.Accno = B.Accno      
                         And A.Party_code = B.Party_code      
              Where  A.Qty < B.Qty) A      
      
      Delete A      
      From   #TBL_RMS_HOLDING_APPR_TMP As A      
             Inner Join #TBL_RMS_HOLDING_APPR_PRVEDAY B      
              On A.Isin = B.Isin      
                 And A.Scrip_cd = B.Scrip_cd      
                 And A.Accno = B.Accno      
                 And A.Party_code = B.Party_code      
      
      Insert Into #TBL_RMS_HOLDING_APPR_TMP      
      Select *      
      From   #TBL_RMS_HOLDING_APPR_PRVEDAY     
      /* Comment on 09 May 2012  
      PRMS Request ID 10141041   
      */   
      /*  
      Update #TBL_RMS_HOLDING_APPR_TMP      
      Set    Avg_closing = A.Clsrate,      
             Hold_value = Qty * A.Clsrate      
      From   (Select Isin,      
                     Clsrate      
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A      
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin      
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate      
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',      
                                                     '1203320000000051', '1203320004025849', '1203320004574264')      
      
      Update #TBL_RMS_HOLDING_APPR_TMP      
      Set    Avg_closing = Clsrate,      
             Hold_value = Qty * Clsrate      
      From   (Select Isin,      
                     Clsrate      
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A      
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin      
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate      
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209') */  
         
       Update #TBL_RMS_HOLDING_APPR_TMP      
       Set    Avg_closing = Clsrate,      
              Hold_value = Qty * Clsrate      
       From   (Select Isin,      
                     Clsrate,Accno      
              From   Vw_equity_cls_rate With(NOLOCK)) A      
       Where  #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin      
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = A.Accno  
          
       Update #TBL_RMS_HOLDING_APPR_TMP      
       Set    Avg_closing = Clsrate,      
               Hold_value = Qty * Clsrate      
       From   (Select Isin,      
                     Clsrate,Accno      
              From   Vw_equity_cls_rate With(NOLOCK)  
              Where  Accno In ('1203320000000066')) A      
       Where  Avg_closing=0      
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000051'   
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin   
                
       Update #TBL_RMS_HOLDING_APPR_TMP      
       Set    Avg_closing = Clsrate,      
             Hold_value = Qty * Clsrate      
       From   (Select Isin,      
                 Clsrate,Accno      
              From   Vw_equity_cls_rate With(NOLOCK)  
              Where  Accno In ('1203320000000051')) A      
       Where  Avg_closing=0      
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000066'   
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin      
      
      --STEP 6      
      /*---------------------------------------------------------------      
      GENERATING HOLDING ROW NUMBER FOR LOOPING      
      ---------------------------------------------------------------*/      
      Select *,      
             Row_number() Over(PARTITION By Party_code Order By Scrip_priority, Hold_value Desc) As Row_num      
      /*,CONVERT(INT,0) AS PLEDGE_DP_QTY,      
      CONVERT(INT,0) AS AFTER_ADJUST_PLEDGE_QTY*/      
      Into   #TBL_RMS_HOLDING_APPR      
      From   #TBL_RMS_HOLDING_APPR_TMP      
      Where  Free_qty <> 0      
      Order  By Party_code,Scrip_priority,Hold_value Desc      
      
      --STEP 7      
      /*------------------------------      
      STORE CLINET WISE DETAILS      
      --------------------------------*/      
      Select A.Party_code,      
             Bsecm_ledger=Sum(Case Co_code      
                               When 'BSECM' Then Ledger      
                               Else 0      
                              End),      
             Nsecm_ledger=Sum(Case Co_code      
                               When 'NSECM' Then Ledger      
                               Else 0      
                              End),      
             Nsefo_ledger=Sum(Case Co_code      
                               When 'NSEFO' Then Ledger      
                               Else 0      
                              End),      
             Mcd_ledger=Sum(Case Co_code      
                             When 'MCD' Then Ledger      
                             Else 0      
                            End),      
             Mcx_ledger=Sum(Case Co_code      
                             When 'MCX' Then Ledger      
                             Else 0      
                            End),      
             Nbfc_ledger=Sum(Case Co_code      
                              When 'NBFC' Then Ledger      
                              Else 0      
                             End),      
             Ncdex_ledger=Sum(Case Co_code      
                               When 'NCDEX' Then Ledger      
                               Else 0      
                              End),      
             Nsx_ledger=Sum(Case Co_code      
                             When 'NSX' Then Ledger      
                             Else 0      
                            End),      
             Bsecm_imargin=Sum(Case Co_code      
                                When 'BSECM' Then Imargin      
                                Else 0      
                               End),      
             Nsecm_imargin=Sum(Case Co_code      
                                When 'NSECM' Then Imargin      
                                Else 0      
                               End),      
             Nsefo_imargin=Sum(Case Co_code      
                                When 'NSEFO' Then Imargin      
                                Else 0      
                               End),      
             Mcd_imargin=Sum(Case Co_code      
                              When 'MCD' Then Imargin      
                              Else 0      
                             End),      
             Mcx_imargin=Sum(Case Co_code      
                              When 'MCX' Then Imargin      
                              Else 0      
                             End),      
             Nbfc_imargin=Sum(Case Co_code      
                               When 'NBFC' Then Imargin      
                               Else 0      
                              End),      
             Ncdex_imargin=Sum(Case Co_code      
                                When 'NCDEX' Then Imargin      
                                Else 0      
          End),      
             Nsx_imargin=Sum(Case Co_code      
                              When 'NSX' Then Imargin      
                              Else 0      
                             End),      
             Bsecm_cash_colleteral=Sum(Case Co_code      
                                        When 'BSECM' Then Cash_colleteral      
                                        Else 0      
                                       End),      
             Nsecm_cash_colleteral=Sum(Case Co_code      
                                        When 'NSECM' Then Cash_colleteral      
                                        Else 0      
                                       End),      
             Nsefo_cash_colleteral=Sum(Case Co_code      
                                        When 'NSEFO' Then Cash_colleteral      
                                        Else 0      
                                       End),      
             Mcd_cash_colleteral=Sum(Case Co_code      
                                      When 'MCD' Then Cash_colleteral      
                                      Else 0      
                       End),      
             Mcx_cash_colleteral=Sum(Case Co_code      
                                      When 'MCX' Then Cash_colleteral      
                                      Else 0      
                                     End),      
             Nbfc_cash_colleteral=Sum(Case Co_code      
                                       When 'NBFC' Then Cash_colleteral      
                                       Else 0      
                                      End),      
             Ncdex_cash_colleteral=Sum(Case Co_code      
                                        When 'NCDEX' Then Cash_colleteral      
                                        Else 0      
                                       End),      
             Nsx_cash_colleteral=Sum(Case Co_code      
                                      When 'NSX' Then Cash_colleteral      
                                      Else 0      
                                     End),      
             Bsecm_noncash_colleteral=Sum(Case Co_code      
                                           When 'BSECM' Then Noncash_colleteral      
                                           Else 0      
                                          End),      
             Nsecm_noncash_colleteral=Sum(Case Co_code      
                                           When 'NSECM' Then Noncash_colleteral      
                                           Else 0      
                                          End),      
             Nsefo_noncash_colleteral=Sum(Case Co_code      
                                           When 'NSEFO' Then Noncash_colleteral      
                                           Else 0      
                                          End),      
             Mcd_noncash_colleteral=Sum(Case Co_code      
                                         When 'MCD' Then Noncash_colleteral      
                                         Else 0      
                                        End),      
             Mcx_noncash_colleteral=Sum(Case Co_code      
                                         When 'MCX' Then Noncash_colleteral      
                                         Else 0      
                                        End),      
             Nbfc_noncash_colleteral=Sum(Case Co_code      
                                          When 'NBFC' Then Noncash_colleteral      
                                          Else 0      
                                         End),      
             Ncdex_noncash_colleteral=Sum(Case Co_code      
                                           When 'NCDEX' Then Noncash_colleteral      
                                           Else 0      
                                          End),      
             Nsx_noncash_colleteral=Sum(Case Co_code      
                                         When 'NSX' Then Noncash_colleteral      
                                         Else 0      
                     End),      
             Bsecm_unrecosiled_credit=Sum(Case Co_code      
                When 'BSECM' Then Unrecosiled_credit      
                                           Else 0      
                                          End),      
             Nsecm_unrecosiled_credit=Sum(Case Co_code      
                                           When 'NSECM' Then Unrecosiled_credit      
                                           Else 0      
                                          End),      
             Nsefo_unrecosiled_credit=Sum(Case Co_code      
                                           When 'NSEFO' Then Unrecosiled_credit      
                                           Else 0      
                                          End),      
             Mcd_unrecosiled_credit=Sum(Case Co_code      
                                         When 'MCD' Then Unrecosiled_credit      
                                         Else 0      
                                        End),      
             Mcx_unrecosiled_credit=Sum(Case Co_code      
                                         When 'MCX' Then Unrecosiled_credit      
                                         Else 0      
                                        End),      
             Nbfc_unrecosiled_credit=Sum(Case Co_code      
                When 'NBFC' Then Unrecosiled_credit      
                                          Else 0      
                                         End),      
             Ncdex_unrecosiled_credit=Sum(Case Co_code      
                                           When 'NCDEX' Then Unrecosiled_credit      
                                           Else 0      
                                          End),      
             Nsx_unrecosiled_credit=Sum(Case Co_code      
                                         When 'NSX' Then Unrecosiled_credit      
                                         Else 0      
                                        End),      
             Bsecm_varmargin=Convert(Money, 0.0),      
             Nsecm_varmargin=Convert(Money, 0.0),      
             Nsefo_varmargin=Convert(Money, 0.0),      
             Mcd_varmargin=Convert(Money, 0.0),      
             Mcx_varmargin=Convert(Money, 0.0),      
             Nbfc_varmargin=Convert(Money, 0.0),      
             Ncdex_varmargin=Convert(Money, 0.0),      
             Nsx_varmargin=Convert(Money, 0.0),      
             Bsecm_span_add_margin=Convert(Money, 0.0),      
             Nsecm_span_add_margin=Convert(Money, 0.0),      
             Nsefo_span_add_margin=Convert(Money, 0.0),      
             Mcd_span_add_margin=Convert(Money, 0.0),      
             Mcx_span_add_margin=Convert(Money, 0.0),      
             Nbfc_span_add_margin=Convert(Money, 0.0),      
             Ncdex_span_add_margin=Convert(Money, 0.0),      
             Nsx_span_add_margin=Convert(Money, 0.0)      
      Into   #PLEDGE_CLIENTWISELEDGER      
      From   #NET_AVAILABLE_PARTY A      
             Inner Join (Select Distinct Party_code      
                         From   #TBL_RMS_HOLDING_APPR) B      
              On A.Party_code = B.Party_code      
      Group  By A.Party_code      
      
      Update #PLEDGE_CLIENTWISELEDGER      
      Set    Bsecm_varmargin = A.Bsecm_varmargin,      
             Nsecm_varmargin = A.Nsecm_varmargin      
      From   (Select Party_code,      
                     Bsecm_varmargin=Sum(Case Co_code      
                                          When 'BSECM' Then Varmargin      
                                          Else 0      
                                         End),      
                     Nsecm_varmargin=Sum(Case Co_code      
                                          When 'NSECM' Then Varmargin      
                                          Else 0      
                                         End)      
              From   Vw_equity_var_margin (NOLOCK)      
              Group  By Party_code)A      
      Where  #pledge_clientwiseledger.Party_code = A.Party_code      
      
      Update #PLEDGE_CLIENTWISELEDGER      
      Set    Nsefo_span_add_margin = A.Nsefo_span_add_margin,      
             Mcd_span_add_margin = A.Mcd_span_add_margin,      
             Nsx_span_add_margin = A.Nsx_span_add_margin      
      From   (Select Party_code,      
                     Nsefo_span_add_margin=Sum(Case Co_code      
                                                When 'NSEFO' Then Initialmargin + Addmargin      
                                                Else 0      
                                               End),      
                     Mcd_span_add_margin=Sum(Case Co_code      
                                              When 'MCD' Then Initialmargin + Addmargin      
                                              Else 0      
                                             End),      
                     Nsx_span_add_margin=Sum(Case Co_code      
                                              When 'NSX' Then Initialmargin + Addmargin      
                                              Else 0      
                                             End)      
              From   Vw_derivativemargin (NOLOCK)      
              Group  By Party_code)A      
      Where  #pledge_clientwiseledger.Party_code = A.Party_code      
      
      Delete From Pledge_clientwiseledger      
      Where  Processdate >= Convert(Varchar, Getdate(), 106)      
             And Processdate <= Convert(Varchar, Getdate(), 106) + ' 23:59:59'      
      
      Insert Into Pledge_clientwiseledger      
      Select *,      
             Processdate=Getdate(),      
             Processby=@USERNAME      
      From   #PLEDGE_CLIENTWISELEDGER      
      
   /*---------------------------------------------------------------      
   FETCHING PLEDGE SCRIPS      
   ---------------------------------------------------------------*/      
      --DROP TABLE #TBL_PLEDGE_QTY_TMP      
   /*SELECT HLD_AC_CODE AS ACCNO,HLD_ISIN_CODE AS ISIN,      
   HLD_AC_POS,HLD_AC_POS AS AFTER_ADJUST_PLEDGE_QTY,CONVERT(BIT,0) AS BANK_APPROVED      
   INTO #TBL_PLEDGE_QTY_TMP      
   FROM DPBACKOFFICE.ACERCROSS.DBO.HOLDING WITH (NOLOCK)      
   --WHERE HLD_AC_CODE IN ('1203320000000051','1203320000000066')      
   WHERE HLD_AC_CODE IN (SELECT ACCNO FROM TBL_LAS_PLEDGE_ACC_MASTER WHERE ACTIVE_INACTIVE=1)      
   AND HLD_AC_TYPE ='14' */      
      --STEP 8      
      /*---------------------------------------------------------------      
      CREATING INDEX TO OPTIMIZE SELECTION      
      ---------------------------------------------------------------*/      
      Create Clustered Index [IX_ROW_NUM]      
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Row_num] Asc )      
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]      
      
      Create Nonclustered Index [IX_CL_LIST_PARTY]      
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Party_code] Asc )      
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]      
      
      Create Clustered Index [IX_HOLDING_APPR_ROW_NUM]      
       On #TBL_RMS_HOLDING_APPR ( [Party_code] Asc, [Row_num] Asc      
      --[SCRIP_PRIORITY] ASC      
      )      
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]      
      
      --STEP 9 DROP TABLE #TBL_PARTY_PLEDGE_DATA      
      /*---------------------------------------------------------------      
      CREATING TABLE FOR FINAL DATA      
      ---------------------------------------------------------------*/      
      Create Table #TBL_PARTY_PLEDGE_DATA      
       (      
         Rms_date         Datetime,      
         Party_code       Varchar(20),      
         Ledger_bal       Money,      
         Client_priority  Smallint,      
         Isin             Varchar(20),      
         Scrip_cd         Varchar(50),      
         Scripname        Varchar(100),      
         Accno            Varchar(50),      
         Qty  Int,      
         Pledge_qty       Int,      
         Free_qty         Int,      
         Hold_value       Money,      
         Avg_closing      Money,      
         Pledgeable_qty   Int,      
         Pledgeable_value Money,      
         Prevdaypledgeqty Int,      
         Release_qty      Int,      
         Scrip_priority   Smallint      
       )      
      
      --STEP 10      
      /*---------------------------------------------------------------      
      LOOP SPLIT CLIENT SCRIP TO CATEGORIZE TYPE      
      WHERE TYPES ARE AS FOLLOWS      
      1) EQUIVALENT TO DEBIT ( DR = STOCK VALUE * 2 )      
      2) REMAINING ALL SCRIPT FROM ABOVE PROCESS WILL COME HERE      
      3) ALL CREDIT CLIENT WILL COM IN THIS CATEGORY      
      ---------------------------------------------------------------*/      
      Declare @CNT_TOTAL               As Int,      
              @ROW_COUNTER_CLIENT      As Int,      
              @ROW_COUNTER_ISIN        As Int,      
              @PARTY_CODE              As Varchar(20),      
              @PERV_PARTY_CODE         As Varchar(20),      
              @LEDGER_BAL              As Money,      
              @QTY                     As Int,      
              @PLEDGEABLE_QTY          As Int,      
              @PLEDGE_QTY              As Int,      
              @FREE_QTY                As Int,      
              @HOLD_VALUE              As Money,      
              @ISIN                    As Varchar(20),      
              @SCRIP_CD                As Varchar(50),      
              @SCRIPNAME               As Varchar(100),      
              @ACCNO                   As Varchar(50),      
              @LEDGER_TMP              As Money,      
              @CLOSING_RATE            As Money,      
              @CLIENT_PRIORITY         As Smallint,      
              @SCRIP_PRIORITY          As Smallint,      
              @HOLDING_ADJUSTED_VALUE  As Money,      
              @PLEDGEABLE_VALUE  As Money,      
              @COUNTINUE_LOOP          As Bit,      
              @AFTER_ADJUST_PLEDGE_QTY As Int,      
              @RMS_DATE                As Datetime,      
              @QTY_DIFF                As Int,      
              @SCRIP_CNT_TOTAL         As Int,      
              @SCRIP_CTR               As Int      
      
      Select @CNT_TOTAL = Count(1)      
      From   #TBL_CL_LIST_APPR_HOLD_TMP --WHERE CLIENT_PRIORITY <= 2      
      
      --PRINT @CNT_TOTAL      
      Set @ROW_COUNTER_CLIENT = 1--45943--24245      
      
      While @ROW_COUNTER_CLIENT <= @CNT_TOTAL --45943 --24246      
      Begin      
         Select @RMS_DATE = Rms_date,      
                @PARTY_CODE = Party_code,      
                @LEDGER_BAL = Net      
         From   #TBL_CL_LIST_APPR_HOLD_TMP      
         Where  Row_num = @ROW_COUNTER_CLIENT      
      
         Set @SCRIP_CNT_TOTAL = 0      
      
         Set @SCRIP_CTR = 1      
      
         Set @CLIENT_PRIORITY = 1      
      
         Select @SCRIP_CNT_TOTAL = Count(*)      
         From   #TBL_RMS_HOLDING_APPR      
         Where  Party_code = @PARTY_CODE      
      
         Set @HOLDING_ADJUSTED_VALUE = 0      
      
         Set @COUNTINUE_LOOP = 1      
      
         --PRINT '--------------------------'      
         --PRINT CONVERT(VARCHAR,@ROW_COUNTER_CLIENT)+'.) '+@PARTY_CODE+ ' $LEDGER BAL :- '+CONVERT(VARCHAR,@LEDGER_BAL) + ' $PLEDGE VALUE :- '+CONVERT(VARCHAR,@LEDGER_BAL*2)      
         --PRINT ' SCRIP (NO OF SCRIPS ['+CONVERT(VARCHAR,@SCRIP_CNT_TOTAL)+'])'      
         While(@SCRIP_CTR <= @SCRIP_CNT_TOTAL)      
         Begin      
            Set @PLEDGEABLE_QTY = 0      
      
            Set @PLEDGEABLE_VALUE = 0      
      
            Select @ISIN = A.Isin,      
                   @SCRIP_CD = Scrip_cd,      
                   @SCRIPNAME = Scripname,      
                   @QTY = Qty,      
                   @PLEDGE_QTY = Pledge_qty,      
                   @FREE_QTY = Free_qty,      
                   @HOLD_VALUE = Hold_value,      
             @ACCNO = A.Accno,      
                   @CLOSING_RATE = Avg_closing,      
                   @SCRIP_PRIORITY = Scrip_priority      
            From   #TBL_RMS_HOLDING_APPR A      
            Where  Party_code = @PARTY_CODE      
                   And Row_num = @SCRIP_CTR      
      
            If @HOLDING_ADJUSTED_VALUE < Abs(@LEDGER_BAL) * 2      
            Begin      
               If (@HOLDING_ADJUSTED_VALUE + @HOLD_VALUE) > Abs(@LEDGER_BAL) * 2      
               Begin      
                  --SET @QTY_DIFF = CEILING( ( ( ABS( @LEDGER_BAL ) * 2 - ( @HOLDING_ADJUSTED_VALUE) ) / @CLOSING_RATE ) )      
                  Set @QTY_DIFF = Floor(((Abs(@LEDGER_BAL) * 2 - (@HOLDING_ADJUSTED_VALUE)) / @CLOSING_RATE))      
      
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + (@QTY_DIFF * @CLOSING_RATE)      
      
                  Set @HOLD_VALUE = @QTY_DIFF * @CLOSING_RATE      
      
                  Set @FREE_QTY = @FREE_QTY - @QTY_DIFF      
      
                  Set @QTY = @QTY_DIFF      
      
                  Set @PLEDGEABLE_QTY = @QTY      
      
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE      
      
                  --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +      
                  --' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- ' +      
                  --CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)      
                  If @QTY > 0      
                  Begin      
                     Insert Into #TBL_PARTY_PLEDGE_DATA      
                     Values      (@RMS_DATE,      
                                  @PARTY_CODE,      
                                  @LEDGER_BAL,      
                                  @CLIENT_PRIORITY,      
                                  @ISIN,      
                                  @SCRIP_CD,      
                                  @SCRIPNAME,      
                                  @ACCNO,      
                                  @QTY,      
                                  @PLEDGE_QTY,      
                                  @QTY_DIFF,      
                                  @HOLD_VALUE,      
                                  @CLOSING_RATE,      
                                  @PLEDGEABLE_QTY,      
                                  @PLEDGEABLE_VALUE,      
                                  0,      
                                  0,      
                                  @SCRIP_PRIORITY)      
                  End      
      
                  Set @QTY = @FREE_QTY      
      
                  Set @HOLD_VALUE = @FREE_QTY * @CLOSING_RATE      
      
                  Set @PLEDGEABLE_QTY = @QTY      
      
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE      
      
                  Set @CLIENT_PRIORITY = 2      
               --BREAK      
               End      
               Else      
               Begin      
                  Set @PLEDGEABLE_QTY = @FREE_QTY      
      
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE      
      
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE      
               End      
      
               --SET @PLEDGEABLE_VALUE = @PLEDGEABLE_QTY*@CLOSING_RATE      
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY)      
               --+ ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '      
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)      
               If @QTY > 0      
               Begin      
                  Insert Into #TBL_PARTY_PLEDGE_DATA      
                  Values      (@RMS_DATE,      
                               @PARTY_CODE,      
                               @LEDGER_BAL,      
                               @CLIENT_PRIORITY,      
                               @ISIN,      
                               @SCRIP_CD,      
                               @SCRIPNAME,      
                               @ACCNO,      
                               @QTY,      
                               @PLEDGE_QTY,      
                               @FREE_QTY,      
                               @HOLD_VALUE,      
                               @CLOSING_RATE,      
                               @PLEDGEABLE_QTY,      
                               @PLEDGEABLE_VALUE,      
                               0,      
                               0,      
                               @SCRIP_PRIORITY)      
               End      
            End      
            Else      
            Begin      
               Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE      
      
               Set @CLIENT_PRIORITY = 2      
      
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +      
               -- ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '      
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)      
               If @QTY > 0      
               Begin      
                  Insert Into #TBL_PARTY_PLEDGE_DATA      
                  Values      (@RMS_DATE,      
                               @PARTY_CODE,      
                               @LEDGER_BAL,      
                               @CLIENT_PRIORITY,      
                               @ISIN,      
                               @SCRIP_CD,      
                               @SCRIPNAME,      
                               @ACCNO,      
                               @QTY,      
                               @PLEDGE_QTY,      
                               @FREE_QTY,      
                               @HOLD_VALUE,      
                               @CLOSING_RATE,      
                               @PLEDGEABLE_QTY,      
                               @PLEDGEABLE_VALUE,      
                               0,      
                               0,      
                               @SCRIP_PRIORITY)      
      
               End      
            End      
      
            If ((@CLIENT_PRIORITY = 2)      
                And (@SCRIP_CTR < @SCRIP_CNT_TOTAL))      
            Begin      
               Insert Into #TBL_PARTY_PLEDGE_DATA      
               Select @RMS_DATE,      
                      @PARTY_CODE,      
                      @LEDGER_BAL,      
                      @CLIENT_PRIORITY,      
                      A.Isin,      
                      Scrip_cd,      
                      Scripname,      
                      A.Accno,      
                      Qty,      
                      Pledge_qty,      
                      Free_qty,      
                      Hold_value,      
                      Avg_closing,      
                      Free_qty                               As Pledgeable_qty,      
                      Convert(Money, Free_qty * Avg_closing) As Pledgeable_value,      
                      0                                      As Prevdaypledgeqty,      
                      0                                      As Release_qty,      
                      Scrip_priority      
               From   #TBL_RMS_HOLDING_APPR A      
               Where  Party_code = @PARTY_CODE      
                      And Row_num > @SCRIP_CTR      
      
               Break      
            End      
      
            Set @SCRIP_CTR = @SCRIP_CTR + 1      
         End      
      
         --PRINT ' ADJUSTED VALUE :- '+CONVERT(VARCHAR,@HOLDING_ADJUSTED_VALUE)      
         Set @ROW_COUNTER_CLIENT = @ROW_COUNTER_CLIENT + 1      
      End      
      
      --drop table #prevDayReleaseQty      
      Select A.Isin,      
             A.Party_code,      
             A.Scrip_cd,      
             A.Scripname,      
             A.Accno,      
             Releaseqty =Isnull(A.Qty, 0) - Isnull(B.Pledge_qty, 0),      
           Prevdaypledge=Isnull(A.Qty, 0),      
             A.Client_priority,      
             Ledger_bal=Convert(Money, 0.0),      
             Avg_closing=Convert(Money, 0.0)      
      Into   #prevDayReleaseQty      
      From   (Select *      
              From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY      
              Where  Scrip_priority = 0) A      
             Left Join (Select Party_code,      
                               Isin,      
                               Scrip_cd,      
                               Accno,      
                               Pledge_qty=Sum(Pledgeable_qty),      
                               Client_priority      
                        From   #TBL_PARTY_PLEDGE_DATA      
                        Where  Client_priority = 1 --Scrip_priority > 0 and      
                        Group  By Party_code,Isin,Scrip_cd,Accno,Client_priority) B      
              On A.Isin = B.Isin      
                 And A.Scrip_cd = B.Scrip_cd      
                 And A.Accno = B.Accno      
                 And A.Party_code = B.Party_code      
      Where  Isnull(A.Qty, 0) > Isnull(B.Pledge_qty, 0)      
      
      Update #prevDayReleaseQty      
      Set    #prevdayreleaseqty.Ledger_bal = A.Net      
      From   #TBL_CL_LIST_APPR_HOLD A      
      Where  A.Party_code = #prevdayreleaseqty.Party_code      
        
      /* Comment on 09 May 2012  
      PRMS Request ID 10141041   
      */  
      /*Update #prevDayReleaseQty      
      Set    Avg_closing = Clsrate      
      From   (Select Isin,      
                     Clsrate      
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A      
      Where  #prevdayreleaseqty.Isin = A.Isin      
             And #prevdayreleaseqty.Accno In ('13326100', '15464303', '11198145', '11197647',      
                                              '1203320000000051', '1203320004025849', '1203320004574264')      
      
      Update #prevDayReleaseQty      
      Set    Avg_closing = Clsrate      
      From   (Select Isin,      
                     Clsrate      
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A      
      Where  #prevdayreleaseqty.Isin = A.Isin      
             And #prevdayreleaseqty.Accno In ('1203320000000066', '16921197', '14216209')*/  
       Update #prevDayReleaseQty       
       Set    Avg_closing = Clsrate  
       From   (Select Isin,      
                     Clsrate,Accno      
              From   Vw_equity_cls_rate With(NOLOCK)) A      
       Where  #prevDayReleaseQty.Isin = A.Isin      
              and #prevDayReleaseQty.Accno = A.Accno  
          
       Update #prevDayReleaseQty       
       Set    Avg_closing = Clsrate      
       From   (Select Isin,      
                     Clsrate,Accno      
              From   Vw_equity_cls_rate With(NOLOCK)  
              Where  Accno In ('1203320000000066')) A      
       Where  Avg_closing=0      
              and #prevDayReleaseQty.Accno = '1203320000000051'   
              and #prevDayReleaseQty.Isin = A.Isin   
                
       Update #prevDayReleaseQty       
       Set    Avg_closing = Clsrate    
       From   (Select Isin,      
                     Clsrate,Accno      
              From   Vw_equity_cls_rate With(NOLOCK)  
              Where  Accno In ('1203320000000051')) A      
       Where  Avg_closing=0      
              and #prevDayReleaseQty.Accno = '1203320000000066'   
              and #prevDayReleaseQty.Isin = A.Isin              
      
      Update A      
      Set    A.Prevdaypledgeqty = B.Prevdaypledge,      
             A.Release_qty = B.Releaseqty      
      From   #TBL_PARTY_PLEDGE_DATA A      
             Inner Join (Select *      
                         From   #prevDayReleaseQty A      
                         Where  Exists (Select *      
                                        From   #TBL_PARTY_PLEDGE_DATA B      
                                        Where  A.Isin = B.Isin      
                                               And A.Accno = B.Accno      
                                               And A.Scrip_cd = B.Scrip_cd      
                                               And A.Party_code = B.Party_code      
                                               And A.Client_priority = B.Client_priority)) B      
              On A.Isin = B.Isin      
                 And A.Accno = B.Accno      
                 And A.Scrip_cd = B.Scrip_cd      
                 And A.Party_code = B.Party_code      
                 And A.Client_priority = B.Client_priority      
      
      Update A      
      Set    A.Prevdaypledgeqty = B.Qty--b.PrevDayPledge      
      From   #TBL_PARTY_PLEDGE_DATA A      
             Inner Join (Select *      
                         From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY A      
                        --Where exists (Select * from #TBL_PARTY_PLEDGE_DATA b      
                        --where a.isin=b.isin and a.accno=b.accno and a.scrip_cd=b.scrip_cd and a.party_code=b.party_code      
                        --and a.client_priority=b.client_priority)      
                        ) B      
              On A.Isin = B.Isin      
                 And A.Accno = B.Accno      
                 And A.Scrip_cd = B.Scrip_cd      
                 And A.Party_code = B.Party_code      
                 And A.Client_priority = B.Client_priority      
                 And A.Scrip_priority = B.Scrip_priority      
      
      --Declare @Rms_date As Datetime      
      Select @Rms_date = Max(Rms_date)      
      From   #TBL_PARTY_PLEDGE_DATA      
      
      Insert Into #TBL_PARTY_PLEDGE_DATA      
      Select Rms_date=@Rms_date,      
             Party_code,      
             Ledger_bal,      
             Client_priority=3,      
             Isin,      
             Scrip_cd,      
             Scripname,      
             Accno,      
             Qty=0,      
             Pledge_qty=0,      
             Free_qty=0,      
             Hold_value=0,      
             Avg_closing,      
             Pledgeable_qty=0,      
             Pledgeable_value=0,      
             Prevdaypledgeqty=Prevdaypledge,      
             Release_qty=Releaseqty,      
             Scrip_priority=1      
      From   #prevDayReleaseQty A      
      Where  Not Exists (Select *      
                         From   #TBL_PARTY_PLEDGE_DATA B      
                         Where  A.Isin = B.Isin      
                                And A.Accno = B.Accno      
                                And A.Scrip_cd = B.Scrip_cd      
                                And A.Party_code = B.Party_code      
                                And A.Client_priority = B.Client_priority)      
      
      Insert Into #TBL_PARTY_PLEDGE_DATA      
      Select Rms_date=@Rms_date,      
             Party_code,      
             Ledger_bal,      
             Client_priority=4,      
             Isin,      
             Scrip_cd,      
             Scripname,      
             Accno,      
             Qty,      
             Pledge_qty=0,      
             Free_qty,      
             Hold_value,      
             Avg_closing,      
             Pledgeable_qty= Free_qty,      
             Pledgeable_value=0,      
             Prevday_pledege_qty=Release_qty,      
             Release_qty,      
             Scrip_priority      
      From   Tbl_party_pledge_data (nolock)      
      Where  Party_code = 'Unknown'      
             And Client_priority = 1      
             And Processdate >= @LastProc_Date      
             And Processdate <= @LastProc_Date + ' 23:59:59'      
      
      ---*****Save Creditor Client For Adjustment of Pledge excces Adjustment      
      Insert Into #TBL_PARTY_PLEDGE_DATA      
      Select B.Rms_date,      
             B.Party_code,      
             Ledger_bal=B.Net,      
             Client_priority=4,      
             A.Isin,      
             A.Scrip_cd,      
             A.Scripname,      
             A.Accno,      
             A.Qty,     
             Pledge_qty=0,      
             A.Free_qty,      
             A.Hold_value,      
             A.Avg_closing,      
             Pledgeable_qty=A.Free_qty,      
             Pledgeable_value=Convert(Money, A.Free_qty * A.Avg_closing),      
             Prevdaypledgeqty=0,      
             Release_qty=0,      
             A.Scrip_priority      
      From   (Select *      
              From   #TBL_RMS_HOLDING_APPR) A      
             Inner Join (Select *      
                         From   #TBL_CL_LIST_APPR_HOLD      
                         Where  Net >= 0) B      
              On B.Party_code = A.Party_code      
      
      Begin Tran      
      
      Insert Into Tbl_party_pledge_data_log      
      Select *      
      From   Tbl_party_pledge_data (nolock)      
      
      /*Delete from Tbl_party_pledge_data      
      Where Processdate >= Convert(varchar,Getdate(),106)      
      And Processdate <= Convert(varchar,Getdate(),106) + ' 23:59:59'*/      
      
      Truncate Table Tbl_party_pledge_data      
      
      Insert Into Tbl_party_pledge_data      
      Select *,      
             Processdate=Getdate(),      
             @USERNAME      
      From   #TBL_PARTY_PLEDGE_DATA      
      
      Commit      
   End      
      
   Set nocount Off      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_client_holding_03122014
-- --------------------------------------------------
/*  
    CHANGE ID  :: 1  
    MODIFIED BY  :: PRASHANT  
    MODIFIED DATE :: AUG 03 2013  
    REASON   :: NOT TO PLEDGE SHARES OF WCL CLIENT  
    REQUEST FROM :: RAHUL SIR  
    PRMS ID   :: NONE  
*/  
CREATE Procedure Usp_las_pledge_client_holding_03122014  
(        
 @USERNAME Varchar(10)        
)        
As        
Begin        
   Set NOCOUNT On        
        
   If Not Exists (Select Hdate        
                  From   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)        
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))        
   Begin        
      Declare @LastProc_Date As Datetime        
        
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)        
      From   Tbl_party_pledge_data (nolock)        
        
      Select Party_code,        
             Co_code,        
             Convert(Money, 0) As Ledger,        
             Imargin,        
             Cash_colleteral,        
             Noncash_colleteral,        
             Unrecosiled_credit        
      Into   #NET_AVAILABLE_PARTY        
      From   General.dbo.Rms_dtclfi With(NOLOCK)        
      Where  Co_code Not In ('MCX', 'NCDEX')        
        
      Declare @ACCOPENINGDATE   As Varchar(11),        
              @EXCLUDEOPBALDATE As Varchar(11)        
        
      Select @ACCOPENINGDATE = '04-01-' + Convert(Varchar, Case        
                                                            When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('JAN', 'FEB', 'MAR') Then Datepart(YY, Getdate()) - 2        
                                                            Else Datepart(YY, Getdate()) - 1        
                                                           End),        
             @EXCLUDEOPBALDATE = (Case        
                                   When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('APR') Then '01-01-' + Convert(Varchar, Datepart(YY, Getdate()))        
                                   Else '01-01-1900'        
                                  End)        
        
      --Set @ACCOPENINGDATE='Apr 01 2010'        
        
      Update A        
      Set    Ledger = Isnull(Bal, 0)        
      From   #NET_AVAILABLE_PARTY A        
             Right Outer Join (Select Cltcode,        
                                      Sum(Case        
                                           When Drcr = 'D' Then -Vamt        
                                           Else Vamt        
                                          End) As Bal        
                               From   General.dbo.Bsecm_cledger With(NOLOCK)        
                               Where  Vdt >= @ACCOPENINGDATE        
                                      And Edt <= Convert(Varchar(11), Getdate() - 1) + ' 23:59:59'        
                               --And Not (Vtyp = 18        
                               -- And Vdt = @EXCLUDEOPBALDATE)        
                               Group  By Cltcode        
                               Having Sum(Case        
                                           When Drcr = 'D' Then -Vamt        
                                           Else Vamt        
                                          End) <> 0) B        
              On A.Party_code = B.Cltcode        
      Where  Co_code = 'BSECM'        
        
      Update A        
      Set    Ledger = Isnull(Bal, 0)        
      From   #NET_AVAILABLE_PARTY A        
             Right Outer Join (Select Cltcode,        
                                      Sum(Case        
                                           When Drcr = 'D' Then -Vamt        
                                           Else Vamt        
                                          End) As Bal        
                               From   General.dbo.Nsecm_cledger With(NOLOCK)        
                               Where  Vdt >= @ACCOPENINGDATE        
                                      And Edt <= Convert(Varchar(11), Getdate() - 1) + ' 23:59:59'        
                               --And Not (Vtyp = 18        
                               -- And Vdt = @EXCLUDEOPBALDATE)        
                               Group  By Cltcode        
                               Having Sum(Case        
                                           When Drcr = 'D' Then -Vamt        
                    Else Vamt        
                                          End) <> 0) B        
              On A.Party_code = B.Cltcode        
      Where  Co_code = 'NSECM'        
        
      Update A        
      Set    Ledger = Isnull(Bal, 0)        
      From   #NET_AVAILABLE_PARTY A        
             Right Outer Join (Select Cltcode,        
                                Sum(Case        
                                           When Drcr = 'D' Then -Vamt        
                                           Else Vamt        
                                          End) As Bal        
                               From   General.dbo.Nsefo_cledger With(NOLOCK)        
                               Where  Vdt >= @ACCOPENINGDATE        
                                      And Edt <= Convert(Varchar(11), Getdate() - 1) + ' 23:59:59'        
                               --And Not (Vtyp = 18        
                               -- And Vdt = @EXCLUDEOPBALDATE)        
                               Group  By Cltcode        
                               Having Sum(Case        
                                           When Drcr = 'D' Then -Vamt        
                                           Else Vamt        
                                          End) <> 0) B        
              On A.Party_code = B.Cltcode        
      Where  Co_code = 'NSEFO'        
        
      Update A        
      Set    Ledger = Isnull(Bal, 0)        
      From   #NET_AVAILABLE_PARTY A        
             Right Outer Join (Select Cltcode,        
                                      Sum(Case        
                                           When Drcr = 'D' Then -Vamt        
                                           Else Vamt        
                                          End) As Bal        
                               From   General.dbo.Mcd_cledger With(NOLOCK)        
                               Where  Vdt >= @ACCOPENINGDATE        
                                      And Edt <= Convert(Varchar(11), Getdate() - 1) + ' 23:59:59'        
                               --And Not (Vtyp = 18        
                               -- And Vdt = @EXCLUDEOPBALDATE)        
                               Group  By Cltcode        
                               Having Sum(Case        
                                           When Drcr = 'D' Then -Vamt        
                                           Else Vamt        
                                          End) <> 0) B        
              On A.Party_code = B.Cltcode        
      Where  Co_code = 'MCD'        
        
      Update A        
      Set    Ledger = Isnull(Bal, 0)        
      From   #NET_AVAILABLE_PARTY A        
             Right Outer Join (Select Cltcode,        
                                      Sum(Case        
                                           When Drcr = 'D' Then -Vamt        
                                           Else Vamt        
                                          End) As Bal        
                               From   General.dbo.Nsx_cledger With(NOLOCK)        
                               Where  Vdt >= @ACCOPENINGDATE        
                                      And Edt <= Convert(Varchar(11), Getdate() - 1) + ' 23:59:59'        
                               --And Not (Vtyp = 18        
                               -- And Vdt = @EXCLUDEOPBALDATE)        
                               Group  By Cltcode        
                               Having Sum(Case        
                                           When Drcr = 'D' Then -Vamt        
                                           Else Vamt        
             End) <> 0) B        
              On A.Party_code = B.Cltcode        
      Where  Co_code = 'NSX'        
        
      Select Party_code,        
             Ledger=Sum(Ledger),        
             Imargin=Sum(Imargin),        
             Cash_colleteral=Sum(Cash_colleteral),        
             Noncash_colleteral=Sum(Noncash_colleteral),        
             Unrecosiled_credit=Sum(Unrecosiled_credit),        
             Samargin=Convert(Money, 0.0),        
           Varmargin=Convert(Money, 0.0),        
             Co_code        
      Into   #NET_AVAILABLE        
      From   #NET_AVAILABLE_PARTY (nolock)        
      Group  By Party_code,Co_code        
        
      /*------------------------------------        
      SPAN AND ADDITIONAL MARGIN        
      SEGMENT NSEFO,MCDXCDS,NSECURFO ONLY        
      ---------------------------------------*/        
      Select Party_code,        
             Initialmargin=Sum(Initialmargin),        
             Addmargin=Sum(Addmargin),        
             Co_code        
      Into   #SPAN_ADDI_MARGIN        
      From   Vw_derivativemargin (NOLOCK) A        
      Group  By Party_code,Co_code        
        
  ------ SPAN Margin Take 175% as per Bussines        
      ------Date 15-03-2012 SPAN Margin Take 100% only changes        
      ------**************************************        
      /*Update #NET_AVAILABLE        
      Set Samargin = (Initialmargin + Addmargin) * 1.75        
      From #SPAN_ADDI_MARGIN A        
      Where #net_available.Party_code = A.Party_code        
      And #net_available.Co_code = A.Co_code*/        
        
      Update #NET_AVAILABLE        
      Set    Samargin = (Initialmargin + Addmargin)        
      From   #SPAN_ADDI_MARGIN A        
      Where  #net_available.Party_code = A.Party_code        
             And #net_available.Co_code = A.Co_code        
        
      /*------------------------------------        
      VAR MARGIN        
      SEGMENT EQUITY (BSE & NSE) ONLY        
      ---------------------------------------*/        
      Select Party_code,        
             Varmargin=Sum(Varmargin),        
             Co_code        
      Into   #EQUITY_VAR_MARGIN        
      From   Vw_equity_var_margin (NOLOCK) A        
      Group  By Party_code,Co_code        
        
      Update #NET_AVAILABLE        
      Set    Varmargin = (A.Varmargin)        
      From   #EQUITY_VAR_MARGIN A        
      Where  #net_available.Party_code = A.Party_code        
             And #net_available.Co_code = A.Co_code        
        
      --STEP 1        
      /*---------------------------------------------------------------        
      FETCHING CLIENTS WITH APPROVED HOLDING AND EXCLUDING CLIENTS        
      FROM TBL_CLI_NOT_FOR_PLEDGE TABLE        
      TABLE TBL_CLI_NOT_FOR_PLEDGE CONTAINS ALL CLIENTS FOR WHICH LOAN        
      HAS ALREADY BEEN TAKEN.        
      ---------------------------------------------------------------*/        
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED        
        
      Select Rms_date,        
             Party_code,        
             Convert(Money, 0)    As Net,        
             Holding_approved,        
             Convert(Smallint, 0) As Client_priority        
      Into   #TBL_CL_LIST_APPR_HOLD        
      From   GENERAL.dbo.Rms_dtclfi_summ With(NOLOCK)        
      Where  Holding_approved <> 0        
        
   /*        
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR        
   NOT TO EXLUDE NON LAS CLIENT        
   */        
      --AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK))        
        
      Update A        
      Set    Net = Isnull(Net_available, 0)        
      From   #TBL_CL_LIST_APPR_HOLD A        
             Left Outer Join (Select Party_code,        
                                     Sum(Ledger - Unrecosiled_credit - (Case        
       When (Samargin) - (Cash_colleteral + Noncash_colleteral) > 0 Then (Samargin) - (Cash_colleteral + Noncash_colleteral)        
                                                                         Else 0        
                                                                        End) - Varmargin) As Net_available        
                              From   #NET_AVAILABLE        
                              Group  By Party_code) B        
              On A.Party_code = B.Party_code        
        
        
      /*CHANGE ID  :: 1*/  
      /*START CHANGE ID  :: 1*/  
      Select Party_Code  
        INTO #WCL_CLIENTS  
      from MIS.DBO.WCL_ActionRpt1(convert(datetime,GETDATE(),103))  
      where BOI+YES+SCB+ADH+AXS <> 0.00  
        
      update A  
        set Net = 0  
      FROM #TBL_CL_LIST_APPR_HOLD A INNER JOIN #WCL_CLIENTS B  
            ON A.Party_code = B.Party_Code  
       
     INSERT INTO PLEDGE_WCL_CLIENT_LOG(PARTY_CODE)   
     SELECT PARTY_CODE  
     FROM #WCL_CLIENTS  
       
     /*END CHANGE ID  :: 1*/  
        
      /*END*/        
      --STEP 2        
      /*---------------------------------------------------------------        
      GENERATING ROW NUMBER FOR LOOPING DEBIT CLIENTS        
      ---------------------------------------------------------------*/        
      Select *,        
             Row_number() Over(Order By Net) As Row_num        
      Into   #TBL_CL_LIST_APPR_HOLD_TMP        
      From   #TBL_CL_LIST_APPR_HOLD        
      Where  Net < 0        
      Order  By Net        
        
      --STEP 3        
      /*---------------------------------------------------------------        
      FETCHING HOLDING WHERE ACCNO <> (UNSETTLED OR EMPTY) AND        
   HOLDING VALUE <> 0        
      ---------------------------------------------------------------*/        
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED        
        
      --DROP TABLE #TBL_RMS_HOLDING_APPR_TMP        
      Select Party_code,        
             Isin,        
             Scrip_cd,        
             Sum(Qty)               As Qty,        
             Convert(Int, 0)        As Pledge_qty,        
             Convert(Int, Sum(Qty)) As Free_qty,        
             Convert(Money, 0)      As Hold_value,        
             --CONVERT( DECIMAL ( 2,2 ) , ( ( SUM( QTY*CLSRATE ) / SUM( QTY ) ) ) ) AS AVG_CLOSING,        
             Convert(Money, 0)      As Avg_closing,        
             Accno,        
             Scripname,        
             Convert(Smallint, 0)   As Scrip_priority        
      Into   #TBL_RMS_HOLDING_APPR_TMP        
      From   GENERAL.dbo.Rms_holding With(NOLOCK)        
      Where  Source = 'H'        
             And Accno In('1203320000000066', '1203320000000051')        
      Group  By Party_code,Isin,Accno,Scrip_cd,Scripname        
        
   /*        
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR        
   NOT TO EXLUDE NON LAS CLIENT        
   */        
      --PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK)) AND        
      /* Comment on 09 May 2012    
      PRMS Request ID 10141041     
      */    
      /*Update #TBL_RMS_HOLDING_APPR_TMP        
      Set    Avg_closing = Clsrate,        
             Hold_value = Qty * Clsrate        
      From   (Select Isin,        
                     Clsrate        
              From   Vw_equity_cls_rate With(NOLOCK)        
              Where  Accno In ('1203320000000051')) A        
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin        
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate        
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',        
                                                     '1203320000000051', '1203320004025849', '1203320004574264')        
        
      Update #TBL_RMS_HOLDING_APPR_TMP        
      Set    Avg_closing = Clsrate,        
             Hold_value = Qty * Clsrate      
      From   (Select Isin,        
                     Clsrate        
              From   Vw_equity_cls_rate With(NOLOCK)        
              Where  Accno In ('1203320000000066')) A        
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin        
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate        
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209')*/     
          
       Update #TBL_RMS_HOLDING_APPR_TMP        
       Set    Avg_closing = Clsrate,        
             Hold_value = Qty * Clsrate        
       From   (Select Isin,        
                     Clsrate,Accno        
              From   Vw_equity_cls_rate With(NOLOCK)) A        
       Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin        
              and #tbl_rms_holding_appr_tmp.Accno = A.Accno    
            
       Update #TBL_RMS_HOLDING_APPR_TMP        
       Set    Avg_closing = Clsrate,        
             Hold_value = Qty * Clsrate        
       From   (Select Isin,        
                     Clsrate,Accno        
              From   Vw_equity_cls_rate With(NOLOCK)    
              Where  Accno In ('1203320000000066')) A        
       Where  Avg_closing=0        
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000051'     
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin     
                  
       Update #TBL_RMS_HOLDING_APPR_TMP        
       Set    Avg_closing = Clsrate,        
             Hold_value = Qty * Clsrate        
       From   (Select Isin,        
                     Clsrate,Accno        
              From   Vw_equity_cls_rate With(NOLOCK)    
              Where  Accno In ('1203320000000051')) A        
       Where  Avg_closing=0        
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000066'     
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin     
                  
      --STEP 4        
      /*---------------------------------------------------------------        
      SETTING APPROVED SCRIP PRIORITY BANKS WISE        
      ---------------------------------------------------------------*/        
      Select Priority,        
             Bank_code,        
             Row_number() Over(Order By Priority) As Row_num        
      Into   #BANK_LST        
      From   GENERAL.dbo.Tbl_las_bank_master With(NOLOCK)        
      Where  Active_inactive = 1        
      Order  By Priority        
        
      Declare @BANK_CNT As Int,        
              @BANK_TTL As Int,        
              @PRIORITY As Int,        
              @BANK_CD  As Int        
        
      Select @BANK_TTL = Count(*)        
      From   #BANK_LST        
        
      Select @BANK_CNT = 1        
        
      While(@BANK_CNT <= @BANK_TTL)        
      Begin        
         Select @PRIORITY = Priority,        
                @BANK_CD = Bank_code        
         From   #BANK_LST        
         Where  Row_num = @BANK_CNT        
        
         Update #TBL_RMS_HOLDING_APPR_TMP        
         Set    Scrip_priority = @PRIORITY        
         Where  Scrip_cd In (Select Scode        
                             From   GENERAL.dbo.Vw_las_appr_bank_scrip With (NOLOCK)        
                             Where  Bank_code = @BANK_CD)        
                And Scrip_priority = 0        
        
         Set @BANK_CNT = @BANK_CNT + 1        
      End        
        
      Delete From #TBL_RMS_HOLDING_APPR_TMP        
      Where  Scrip_priority = 0        
        
      --STEP 5        
      /*-----------Add New Step For New request----------------------------------------------------        
      Clinet Pledged Priority 1st Previous Day Pleded Qty        
      ---------------------------------------------------------------*/        
      Select Party_code,        
             Isin,        
             Scrip_cd,        
             Sum(Pledge_qty)    As Qty,        
             Cast(0 As Int)     As Pledge_qty,        
             Sum(Pledge_qty)    As Free_qty,      
             Cast(0.0 As Money) As Hold_value,        
             Cast(0.0 As Money) As Avg_closing,        
             Accno,        
             Scripname,        
             Cast(0 As Int)     As Scrip_priority,        
             1                  As Client_priority        
      Into   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY        
      From   Tbl_party_pledge_data A (nolock)        
      Where  A.Processdate >= @LastProc_Date        
             And A.Processdate <= @LastProc_Date + ' 23:59:59'        
             And A.Pledge_qty <> 0        
      Group  By Party_code,Isin,Scrip_cd,Accno,Scripname        
        
      Select A.Party_code,        
             A.Isin,        
             A.Scrip_cd,        
             Qty=New_qty,        
             A.Pledge_qty,        
             Free_qty=New_qty,        
             A.Hold_value,        
             A.Avg_closing,        
             A.Accno,        
             A.Scripname,        
             Scrip_priority=A.New_scrip_priority        
      Into   #TBL_RMS_HOLDING_APPR_PRVEDAY        
      From   (Select A.*,        
                     New_qty= (Case        
                                When (A.Qty - B.Qty) >= 0 Then B.Qty        
                                Else A.Qty        
                               End),        
                     New_scrip_priority= A.Scrip_priority        
              From   (Select *        
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY        
                      Where  Scrip_priority = 0) A        
        Inner Join (Select *        
                                 From   #TBL_RMS_HOLDING_APPR_TMP        
                                 Where  Scrip_priority > 0) B        
                      On A.Isin = B.Isin        
                         And A.Scrip_cd = B.Scrip_cd        
                         And A.Accno = B.Accno        
                         And A.Party_code = B.Party_code        
              Union All        
              Select A.*,        
                     New_qty= B.Qty - A.Qty,        
                     New_scrip_priority= B.Scrip_priority        
              From   (Select *        
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY        
                      Where  Scrip_priority = 0) A        
                     Inner Join (Select *        
                                 From   #TBL_RMS_HOLDING_APPR_TMP        
                                 Where  Scrip_priority > 0) B        
                      On A.Isin = B.Isin        
                         And A.Scrip_cd = B.Scrip_cd        
                         And A.Accno = B.Accno        
                         And A.Party_code = B.Party_code        
              Where  A.Qty < B.Qty) A        
        
      Delete A        
      From   #TBL_RMS_HOLDING_APPR_TMP As A        
             Inner Join #TBL_RMS_HOLDING_APPR_PRVEDAY B        
              On A.Isin = B.Isin        
                 And A.Scrip_cd = B.Scrip_cd        
                 And A.Accno = B.Accno        
                 And A.Party_code = B.Party_code        
        
      Insert Into #TBL_RMS_HOLDING_APPR_TMP        
      Select *        
      From   #TBL_RMS_HOLDING_APPR_PRVEDAY       
      /* Comment on 09 May 2012    
      PRMS Request ID 10141041     
      */     
      /*    
      Update #TBL_RMS_HOLDING_APPR_TMP        
      Set    Avg_closing = A.Clsrate,        
             Hold_value = Qty * A.Clsrate        
      From   (Select Isin,        
                     Clsrate        
              From   Vw_equity_cls_rate With(NOLOCK)        
              Where  Accno In ('1203320000000051')) A        
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin        
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate        
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',        
                                                     '1203320000000051', '1203320004025849', '1203320004574264')        
        
      Update #TBL_RMS_HOLDING_APPR_TMP        
      Set    Avg_closing = Clsrate,        
             Hold_value = Qty * Clsrate        
      From   (Select Isin,        
                     Clsrate        
              From   Vw_equity_cls_rate With(NOLOCK)        
              Where  Accno In ('1203320000000066')) A        
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin        
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate        
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209') */    
           
       Update #TBL_RMS_HOLDING_APPR_TMP        
       Set    Avg_closing = Clsrate,        
              Hold_value = Qty * Clsrate        
       From   (Select Isin,        
                     Clsrate,Accno        
              From   Vw_equity_cls_rate With(NOLOCK)) A        
       Where  #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin        
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = A.Accno    
            
       Update #TBL_RMS_HOLDING_APPR_TMP        
       Set    Avg_closing = Clsrate,        
               Hold_value = Qty * Clsrate        
       From   (Select Isin,        
                     Clsrate,Accno        
              From   Vw_equity_cls_rate With(NOLOCK)    
              Where  Accno In ('1203320000000066')) A        
       Where  Avg_closing=0        
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000051'     
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin     
                  
       Update #TBL_RMS_HOLDING_APPR_TMP        
       Set    Avg_closing = Clsrate,        
             Hold_value = Qty * Clsrate        
       From   (Select Isin,        
                 Clsrate,Accno        
              From   Vw_equity_cls_rate With(NOLOCK)    
              Where  Accno In ('1203320000000051')) A        
       Where  Avg_closing=0        
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000066'     
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin        
        
      --STEP 6        
      /*---------------------------------------------------------------        
      GENERATING HOLDING ROW NUMBER FOR LOOPING        
      ---------------------------------------------------------------*/        
      Select *,        
             Row_number() Over(PARTITION By Party_code Order By Scrip_priority, Hold_value Desc) As Row_num        
      /*,CONVERT(INT,0) AS PLEDGE_DP_QTY,        
      CONVERT(INT,0) AS AFTER_ADJUST_PLEDGE_QTY*/        
      Into   #TBL_RMS_HOLDING_APPR        
      From   #TBL_RMS_HOLDING_APPR_TMP        
      Where  Free_qty <> 0        
      Order  By Party_code,Scrip_priority,Hold_value Desc        
        
      --STEP 7        
      /*------------------------------        
      STORE CLINET WISE DETAILS        
      --------------------------------*/        
      Select A.Party_code,        
             Bsecm_ledger=Sum(Case Co_code        
                               When 'BSECM' Then Ledger        
                               Else 0        
                              End),        
             Nsecm_ledger=Sum(Case Co_code        
                               When 'NSECM' Then Ledger        
                               Else 0        
                              End),        
             Nsefo_ledger=Sum(Case Co_code        
                               When 'NSEFO' Then Ledger        
                               Else 0        
                              End),        
             Mcd_ledger=Sum(Case Co_code        
                             When 'MCD' Then Ledger        
                             Else 0        
                            End),        
             Mcx_ledger=Sum(Case Co_code        
                             When 'MCX' Then Ledger        
                             Else 0        
                            End),        
             Nbfc_ledger=Sum(Case Co_code        
                              When 'NBFC' Then Ledger       
                              Else 0        
                             End),        
             Ncdex_ledger=Sum(Case Co_code        
                               When 'NCDEX' Then Ledger        
                               Else 0        
                              End),        
             Nsx_ledger=Sum(Case Co_code        
                             When 'NSX' Then Ledger        
                             Else 0        
                            End),        
             Bsecm_imargin=Sum(Case Co_code        
                                When 'BSECM' Then Imargin        
                                Else 0        
                               End),        
             Nsecm_imargin=Sum(Case Co_code        
                                When 'NSECM' Then Imargin        
                                Else 0        
                               End),        
             Nsefo_imargin=Sum(Case Co_code        
                                When 'NSEFO' Then Imargin        
                                Else 0        
                               End),        
             Mcd_imargin=Sum(Case Co_code        
                              When 'MCD' Then Imargin        
                              Else 0        
                             End),        
             Mcx_imargin=Sum(Case Co_code        
                              When 'MCX' Then Imargin        
                              Else 0        
                             End),        
             Nbfc_imargin=Sum(Case Co_code        
                               When 'NBFC' Then Imargin        
                               Else 0        
                              End),        
             Ncdex_imargin=Sum(Case Co_code        
                                When 'NCDEX' Then Imargin        
                                Else 0        
          End),        
             Nsx_imargin=Sum(Case Co_code        
                              When 'NSX' Then Imargin        
                              Else 0        
                             End),        
             Bsecm_cash_colleteral=Sum(Case Co_code        
                                        When 'BSECM' Then Cash_colleteral        
                                        Else 0        
                                       End),        
             Nsecm_cash_colleteral=Sum(Case Co_code        
                                        When 'NSECM' Then Cash_colleteral        
                                        Else 0        
                                       End),        
             Nsefo_cash_colleteral=Sum(Case Co_code        
                                        When 'NSEFO' Then Cash_colleteral        
                                        Else 0        
                                       End),        
             Mcd_cash_colleteral=Sum(Case Co_code        
                                      When 'MCD' Then Cash_colleteral        
                                      Else 0        
                       End),        
             Mcx_cash_colleteral=Sum(Case Co_code        
                                      When 'MCX' Then Cash_colleteral        
                                      Else 0        
                                     End),        
             Nbfc_cash_colleteral=Sum(Case Co_code        
                                       When 'NBFC' Then Cash_colleteral        
                                       Else 0        
                                      End),        
             Ncdex_cash_colleteral=Sum(Case Co_code        
                                        When 'NCDEX' Then Cash_colleteral        
                                        Else 0        
                                       End),        
             Nsx_cash_colleteral=Sum(Case Co_code        
                                      When 'NSX' Then Cash_colleteral        
                                      Else 0        
                                     End),        
        Bsecm_noncash_colleteral=Sum(Case Co_code        
                                           When 'BSECM' Then Noncash_colleteral        
                                           Else 0        
                                          End),        
             Nsecm_noncash_colleteral=Sum(Case Co_code        
                                           When 'NSECM' Then Noncash_colleteral        
                                           Else 0        
                                          End),        
             Nsefo_noncash_colleteral=Sum(Case Co_code        
                                           When 'NSEFO' Then Noncash_colleteral        
                                           Else 0        
                                          End),        
             Mcd_noncash_colleteral=Sum(Case Co_code        
                                         When 'MCD' Then Noncash_colleteral        
                                         Else 0        
                                        End),        
             Mcx_noncash_colleteral=Sum(Case Co_code        
                                         When 'MCX' Then Noncash_colleteral        
                                         Else 0        
                                        End),        
             Nbfc_noncash_colleteral=Sum(Case Co_code        
                                          When 'NBFC' Then Noncash_colleteral        
                                          Else 0        
                                         End),        
             Ncdex_noncash_colleteral=Sum(Case Co_code        
                                           When 'NCDEX' Then Noncash_colleteral        
                                           Else 0        
                                          End),        
             Nsx_noncash_colleteral=Sum(Case Co_code        
                                         When 'NSX' Then Noncash_colleteral        
                                         Else 0        
                     End),        
             Bsecm_unrecosiled_credit=Sum(Case Co_code        
                When 'BSECM' Then Unrecosiled_credit        
                                           Else 0        
                                          End),        
             Nsecm_unrecosiled_credit=Sum(Case Co_code        
                                           When 'NSECM' Then Unrecosiled_credit        
                                           Else 0        
                                          End),        
             Nsefo_unrecosiled_credit=Sum(Case Co_code        
                                           When 'NSEFO' Then Unrecosiled_credit        
                                           Else 0        
                                          End),        
             Mcd_unrecosiled_credit=Sum(Case Co_code        
                                         When 'MCD' Then Unrecosiled_credit        
                                         Else 0        
                                        End),        
             Mcx_unrecosiled_credit=Sum(Case Co_code        
                                         When 'MCX' Then Unrecosiled_credit        
                                         Else 0        
                                        End),        
             Nbfc_unrecosiled_credit=Sum(Case Co_code        
                When 'NBFC' Then Unrecosiled_credit        
                                          Else 0        
                                         End),        
             Ncdex_unrecosiled_credit=Sum(Case Co_code        
                                           When 'NCDEX' Then Unrecosiled_credit        
                                           Else 0        
                                          End),        
             Nsx_unrecosiled_credit=Sum(Case Co_code        
                                         When 'NSX' Then Unrecosiled_credit        
                                         Else 0        
                End),        
             Bsecm_varmargin=Convert(Money, 0.0),        
             Nsecm_varmargin=Convert(Money, 0.0),        
             Nsefo_varmargin=Convert(Money, 0.0),        
             Mcd_varmargin=Convert(Money, 0.0),        
             Mcx_varmargin=Convert(Money, 0.0),        
             Nbfc_varmargin=Convert(Money, 0.0),        
             Ncdex_varmargin=Convert(Money, 0.0),        
             Nsx_varmargin=Convert(Money, 0.0),        
             Bsecm_span_add_margin=Convert(Money, 0.0),        
             Nsecm_span_add_margin=Convert(Money, 0.0),        
             Nsefo_span_add_margin=Convert(Money, 0.0),        
             Mcd_span_add_margin=Convert(Money, 0.0),        
             Mcx_span_add_margin=Convert(Money, 0.0),        
             Nbfc_span_add_margin=Convert(Money, 0.0),        
             Ncdex_span_add_margin=Convert(Money, 0.0),        
             Nsx_span_add_margin=Convert(Money, 0.0)        
      Into   #PLEDGE_CLIENTWISELEDGER        
      From   #NET_AVAILABLE_PARTY A        
             Inner Join (Select Distinct Party_code        
                         From   #TBL_RMS_HOLDING_APPR) B        
              On A.Party_code = B.Party_code        
      Group  By A.Party_code        
        
      Update #PLEDGE_CLIENTWISELEDGER        
      Set    Bsecm_varmargin = A.Bsecm_varmargin,        
             Nsecm_varmargin = A.Nsecm_varmargin        
      From   (Select Party_code,        
                     Bsecm_varmargin=Sum(Case Co_code        
                                          When 'BSECM' Then Varmargin        
                                          Else 0        
                                         End),        
                     Nsecm_varmargin=Sum(Case Co_code        
                                          When 'NSECM' Then Varmargin        
                                          Else 0        
                                         End)        
              From   Vw_equity_var_margin (NOLOCK)        
              Group  By Party_code)A        
      Where  #pledge_clientwiseledger.Party_code = A.Party_code        
        
      Update #PLEDGE_CLIENTWISELEDGER        
      Set    Nsefo_span_add_margin = A.Nsefo_span_add_margin,        
             Mcd_span_add_margin = A.Mcd_span_add_margin,        
             Nsx_span_add_margin = A.Nsx_span_add_margin        
      From   (Select Party_code,        
                     Nsefo_span_add_margin=Sum(Case Co_code        
                                                When 'NSEFO' Then Initialmargin + Addmargin        
                                                Else 0        
                                               End),        
                     Mcd_span_add_margin=Sum(Case Co_code        
                                              When 'MCD' Then Initialmargin + Addmargin        
                                              Else 0        
                                             End),        
                     Nsx_span_add_margin=Sum(Case Co_code        
                                              When 'NSX' Then Initialmargin + Addmargin        
                                              Else 0        
                                             End)        
              From   Vw_derivativemargin (NOLOCK)        
              Group  By Party_code)A        
      Where  #pledge_clientwiseledger.Party_code = A.Party_code        
        
      Delete From Pledge_clientwiseledger        
      Where  Processdate >= Convert(Varchar, Getdate(), 106)        
             And Processdate <= Convert(Varchar, Getdate(), 106) + ' 23:59:59'        
        
      Insert Into Pledge_clientwiseledger        
      Select *,        
             Processdate=Getdate(),        
             Processby=@USERNAME        
      From   #PLEDGE_CLIENTWISELEDGER        
        
   /*---------------------------------------------------------------        
   FETCHING PLEDGE SCRIPS        
   ---------------------------------------------------------------*/        
      --DROP TABLE #TBL_PLEDGE_QTY_TMP        
   /*SELECT HLD_AC_CODE AS ACCNO,HLD_ISIN_CODE AS ISIN,        
   HLD_AC_POS,HLD_AC_POS AS AFTER_ADJUST_PLEDGE_QTY,CONVERT(BIT,0) AS BANK_APPROVED        
   INTO #TBL_PLEDGE_QTY_TMP        
   FROM DPBACKOFFICE.ACERCROSS.DBO.HOLDING WITH (NOLOCK)        
   --WHERE HLD_AC_CODE IN ('1203320000000051','1203320000000066')        
   WHERE HLD_AC_CODE IN (SELECT ACCNO FROM TBL_LAS_PLEDGE_ACC_MASTER WHERE ACTIVE_INACTIVE=1)        
   AND HLD_AC_TYPE ='14' */        
      --STEP 8        
      /*---------------------------------------------------------------        
      CREATING INDEX TO OPTIMIZE SELECTION        
      ---------------------------------------------------------------*/        
      Create Clustered Index [IX_ROW_NUM]        
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Row_num] Asc )        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]        
        
      Create Nonclustered Index [IX_CL_LIST_PARTY]        
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Party_code] Asc )        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]        
        
      Create Clustered Index [IX_HOLDING_APPR_ROW_NUM]        
       On #TBL_RMS_HOLDING_APPR ( [Party_code] Asc, [Row_num] Asc        
      --[SCRIP_PRIORITY] ASC        
      )        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]        
        
      --STEP 9 DROP TABLE #TBL_PARTY_PLEDGE_DATA        
      /*---------------------------------------------------------------        
      CREATING TABLE FOR FINAL DATA        
      ---------------------------------------------------------------*/        
      Create Table #TBL_PARTY_PLEDGE_DATA        
       (        
         Rms_date         Datetime,        
         Party_code       Varchar(20),        
         Ledger_bal       Money,        
         Client_priority  Smallint,        
         Isin             Varchar(20),        
         Scrip_cd         Varchar(50),        
         Scripname        Varchar(100),        
         Accno            Varchar(50),        
         Qty  Int,        
         Pledge_qty       Int,        
         Free_qty         Int,        
         Hold_value       Money,        
         Avg_closing      Money,        
         Pledgeable_qty   Int,        
         Pledgeable_value Money,        
         Prevdaypledgeqty Int,        
         Release_qty      Int,        
         Scrip_priority   Smallint        
       )        
        
      --STEP 10        
      /*---------------------------------------------------------------        
      LOOP SPLIT CLIENT SCRIP TO CATEGORIZE TYPE        
      WHERE TYPES ARE AS FOLLOWS        
      1) EQUIVALENT TO DEBIT ( DR = STOCK VALUE * 2 )        
      2) REMAINING ALL SCRIPT FROM ABOVE PROCESS WILL COME HERE        
      3) ALL CREDIT CLIENT WILL COM IN THIS CATEGORY        
      ---------------------------------------------------------------*/        
      Declare @CNT_TOTAL               As Int,        
              @ROW_COUNTER_CLIENT      As Int,        
              @ROW_COUNTER_ISIN        As Int,        
              @PARTY_CODE              As Varchar(20),        
              @PERV_PARTY_CODE         As Varchar(20),        
              @LEDGER_BAL              As Money,        
              @QTY                     As Int,        
              @PLEDGEABLE_QTY          As Int,        
              @PLEDGE_QTY              As Int,        
              @FREE_QTY                As Int,        
              @HOLD_VALUE              As Money,        
              @ISIN                    As Varchar(20),        
              @SCRIP_CD                As Varchar(50),        
              @SCRIPNAME               As Varchar(100),        
              @ACCNO                   As Varchar(50),        
          @LEDGER_TMP              As Money,        
              @CLOSING_RATE            As Money,        
              @CLIENT_PRIORITY         As Smallint,        
              @SCRIP_PRIORITY          As Smallint,        
              @HOLDING_ADJUSTED_VALUE  As Money,        
              @PLEDGEABLE_VALUE  As Money,        
              @COUNTINUE_LOOP          As Bit,        
              @AFTER_ADJUST_PLEDGE_QTY As Int,        
              @RMS_DATE                As Datetime,        
              @QTY_DIFF                As Int,        
              @SCRIP_CNT_TOTAL         As Int,        
              @SCRIP_CTR               As Int        
        
      Select @CNT_TOTAL = Count(1)        
      From   #TBL_CL_LIST_APPR_HOLD_TMP --WHERE CLIENT_PRIORITY <= 2        
        
      --PRINT @CNT_TOTAL        
      Set @ROW_COUNTER_CLIENT = 1--45943--24245        
        
      While @ROW_COUNTER_CLIENT <= @CNT_TOTAL --45943 --24246        
      Begin        
         Select @RMS_DATE = Rms_date,        
                @PARTY_CODE = Party_code,        
                @LEDGER_BAL = Net        
         From   #TBL_CL_LIST_APPR_HOLD_TMP        
         Where  Row_num = @ROW_COUNTER_CLIENT        
        
         Set @SCRIP_CNT_TOTAL = 0        
        
         Set @SCRIP_CTR = 1        
        
         Set @CLIENT_PRIORITY = 1        
        
         Select @SCRIP_CNT_TOTAL = Count(*)        
         From   #TBL_RMS_HOLDING_APPR        
         Where  Party_code = @PARTY_CODE        
        
         Set @HOLDING_ADJUSTED_VALUE = 0        
        
         Set @COUNTINUE_LOOP = 1        
        
         --PRINT '--------------------------'        
         --PRINT CONVERT(VARCHAR,@ROW_COUNTER_CLIENT)+'.) '+@PARTY_CODE+ ' $LEDGER BAL :- '+CONVERT(VARCHAR,@LEDGER_BAL) + ' $PLEDGE VALUE :- '+CONVERT(VARCHAR,@LEDGER_BAL*2)        
         --PRINT ' SCRIP (NO OF SCRIPS ['+CONVERT(VARCHAR,@SCRIP_CNT_TOTAL)+'])'        
         While(@SCRIP_CTR <= @SCRIP_CNT_TOTAL)        
         Begin        
            Set @PLEDGEABLE_QTY = 0        
        
            Set @PLEDGEABLE_VALUE = 0        
        
            Select @ISIN = A.Isin,        
                   @SCRIP_CD = Scrip_cd,        
                   @SCRIPNAME = Scripname,        
                   @QTY = Qty,        
                   @PLEDGE_QTY = Pledge_qty,        
                   @FREE_QTY = Free_qty,        
                   @HOLD_VALUE = Hold_value,        
             @ACCNO = A.Accno,        
                   @CLOSING_RATE = Avg_closing,        
                   @SCRIP_PRIORITY = Scrip_priority        
            From   #TBL_RMS_HOLDING_APPR A        
            Where  Party_code = @PARTY_CODE        
                   And Row_num = @SCRIP_CTR        
        
            If @HOLDING_ADJUSTED_VALUE < Abs(@LEDGER_BAL) * 2        
            Begin        
               If (@HOLDING_ADJUSTED_VALUE + @HOLD_VALUE) > Abs(@LEDGER_BAL) * 2        
               Begin        
                  --SET @QTY_DIFF = CEILING( ( ( ABS( @LEDGER_BAL ) * 2 - ( @HOLDING_ADJUSTED_VALUE) ) / @CLOSING_RATE ) )        
                  Set @QTY_DIFF = Floor(((Abs(@LEDGER_BAL) * 2 - (@HOLDING_ADJUSTED_VALUE)) / @CLOSING_RATE))        
        
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + (@QTY_DIFF * @CLOSING_RATE)        
        
                  Set @HOLD_VALUE = @QTY_DIFF * @CLOSING_RATE        
        
                  Set @FREE_QTY = @FREE_QTY - @QTY_DIFF        
        
                  Set @QTY = @QTY_DIFF        
        
                  Set @PLEDGEABLE_QTY = @QTY        
        
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE        
        
                  --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +        
                  --' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- ' +        
                  --CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)        
                  If @QTY > 0        
                  Begin        
                     Insert Into #TBL_PARTY_PLEDGE_DATA        
                     Values      (@RMS_DATE,        
                                  @PARTY_CODE,        
                                  @LEDGER_BAL,        
                                  @CLIENT_PRIORITY,        
                                  @ISIN,        
                                  @SCRIP_CD,        
                                  @SCRIPNAME,        
                                  @ACCNO,        
                                  @QTY,        
                                  @PLEDGE_QTY,        
                                  @QTY_DIFF,        
                                  @HOLD_VALUE,        
                                  @CLOSING_RATE,        
                                  @PLEDGEABLE_QTY,        
                                  @PLEDGEABLE_VALUE,        
                                  0,        
                                  0,        
                                  @SCRIP_PRIORITY)        
                  End        
        
                  Set @QTY = @FREE_QTY        
        
                  Set @HOLD_VALUE = @FREE_QTY * @CLOSING_RATE        
        
                  Set @PLEDGEABLE_QTY = @QTY        
        
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE        
        
                  Set @CLIENT_PRIORITY = 2        
               --BREAK        
               End        
               Else        
               Begin        
                  Set @PLEDGEABLE_QTY = @FREE_QTY        
        
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE        
        
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE        
               End        
        
               --SET @PLEDGEABLE_VALUE = @PLEDGEABLE_QTY*@CLOSING_RATE        
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY)        
               --+ ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '        
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)        
               If @QTY > 0        
               Begin        
                  Insert Into #TBL_PARTY_PLEDGE_DATA        
                  Values      (@RMS_DATE,        
                               @PARTY_CODE,        
                               @LEDGER_BAL,        
                               @CLIENT_PRIORITY,        
                               @ISIN,        
                               @SCRIP_CD,        
                               @SCRIPNAME,        
                               @ACCNO,        
                               @QTY,        
                               @PLEDGE_QTY,        
                               @FREE_QTY,        
                               @HOLD_VALUE,        
                               @CLOSING_RATE,        
                               @PLEDGEABLE_QTY,        
                               @PLEDGEABLE_VALUE,        
                               0,        
                               0,        
                               @SCRIP_PRIORITY)        
               End        
            End        
            Else        
            Begin        
               Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE        
        
               Set @CLIENT_PRIORITY = 2        
        
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +        
               -- ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '        
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)        
               If @QTY > 0        
               Begin        
                  Insert Into #TBL_PARTY_PLEDGE_DATA        
                  Values      (@RMS_DATE,        
                               @PARTY_CODE,        
                               @LEDGER_BAL,        
                               @CLIENT_PRIORITY,        
                               @ISIN,        
                               @SCRIP_CD,        
                               @SCRIPNAME,        
                               @ACCNO,        
                               @QTY,        
                               @PLEDGE_QTY,        
                               @FREE_QTY,        
                               @HOLD_VALUE,        
                               @CLOSING_RATE,        
                               @PLEDGEABLE_QTY,        
                               @PLEDGEABLE_VALUE,        
                               0,        
                               0,        
                               @SCRIP_PRIORITY)        
        
               End        
            End        
        
            If ((@CLIENT_PRIORITY = 2)        
                And (@SCRIP_CTR < @SCRIP_CNT_TOTAL))        
            Begin        
               Insert Into #TBL_PARTY_PLEDGE_DATA        
               Select @RMS_DATE,        
                      @PARTY_CODE,        
                      @LEDGER_BAL,        
                      @CLIENT_PRIORITY,        
                      A.Isin,        
                      Scrip_cd,        
                      Scripname,        
                      A.Accno,        
                      Qty,        
                      Pledge_qty,        
                      Free_qty,        
                      Hold_value,        
                      Avg_closing,        
                      Free_qty                               As Pledgeable_qty,        
                      Convert(Money, Free_qty * Avg_closing) As Pledgeable_value,        
                      0                                      As Prevdaypledgeqty,        
                      0                                      As Release_qty,        
                      Scrip_priority        
               From   #TBL_RMS_HOLDING_APPR A        
               Where  Party_code = @PARTY_CODE        
                      And Row_num > @SCRIP_CTR        
        
               Break        
            End        
        
            Set @SCRIP_CTR = @SCRIP_CTR + 1        
         End        
        
         --PRINT ' ADJUSTED VALUE :- '+CONVERT(VARCHAR,@HOLDING_ADJUSTED_VALUE)        
         Set @ROW_COUNTER_CLIENT = @ROW_COUNTER_CLIENT + 1        
      End        
        
      --drop table #prevDayReleaseQty        
      Select A.Isin,        
             A.Party_code,        
             A.Scrip_cd,        
             A.Scripname,        
             A.Accno,        
             Releaseqty =Isnull(A.Qty, 0) - Isnull(B.Pledge_qty, 0),        
           Prevdaypledge=Isnull(A.Qty, 0),        
             A.Client_priority,        
             Ledger_bal=Convert(Money, 0.0),        
             Avg_closing=Convert(Money, 0.0)        
      Into   #prevDayReleaseQty        
      From   (Select *        
              From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY        
              Where  Scrip_priority = 0) A        
             Left Join (Select Party_code,        
                               Isin,        
                               Scrip_cd,        
                               Accno,        
                               Pledge_qty=Sum(Pledgeable_qty),        
                               Client_priority        
                        From   #TBL_PARTY_PLEDGE_DATA        
                        Where  Client_priority = 1 --Scrip_priority > 0 and        
                        Group  By Party_code,Isin,Scrip_cd,Accno,Client_priority) B        
              On A.Isin = B.Isin        
                 And A.Scrip_cd = B.Scrip_cd        
                 And A.Accno = B.Accno        
                 And A.Party_code = B.Party_code        
      Where  Isnull(A.Qty, 0) > Isnull(B.Pledge_qty, 0)        
        
      Update #prevDayReleaseQty        
      Set    #prevdayreleaseqty.Ledger_bal = A.Net        
      From   #TBL_CL_LIST_APPR_HOLD A        
      Where  A.Party_code = #prevdayreleaseqty.Party_code        
          
      /* Comment on 09 May 2012    
      PRMS Request ID 10141041     
      */    
      /*Update #prevDayReleaseQty        
      Set    Avg_closing = Clsrate        
      From   (Select Isin,        
                     Clsrate        
              From   Vw_equity_cls_rate With(NOLOCK)        
              Where  Accno In ('1203320000000051')) A        
      Where  #prevdayreleaseqty.Isin = A.Isin        
             And #prevdayreleaseqty.Accno In ('13326100', '15464303', '11198145', '11197647',        
                                              '1203320000000051', '1203320004025849', '1203320004574264')        
        
      Update #prevDayReleaseQty        
      Set    Avg_closing = Clsrate        
      From   (Select Isin,        
                     Clsrate        
              From   Vw_equity_cls_rate With(NOLOCK)        
              Where  Accno In ('1203320000000066')) A        
      Where  #prevdayreleaseqty.Isin = A.Isin        
             And #prevdayreleaseqty.Accno In ('1203320000000066', '16921197', '14216209')*/    
       Update #prevDayReleaseQty         
       Set    Avg_closing = Clsrate    
       From   (Select Isin,        
                     Clsrate,Accno        
              From   Vw_equity_cls_rate With(NOLOCK)) A        
       Where  #prevDayReleaseQty.Isin = A.Isin        
              and #prevDayReleaseQty.Accno = A.Accno    
            
       Update #prevDayReleaseQty         
       Set    Avg_closing = Clsrate        
       From   (Select Isin,        
                     Clsrate,Accno        
              From   Vw_equity_cls_rate With(NOLOCK)    
              Where  Accno In ('1203320000000066')) A        
       Where  Avg_closing=0        
              and #prevDayReleaseQty.Accno = '1203320000000051'     
              and #prevDayReleaseQty.Isin = A.Isin     
                  
       Update #prevDayReleaseQty         
       Set    Avg_closing = Clsrate      
       From   (Select Isin,        
                     Clsrate,Accno        
              From   Vw_equity_cls_rate With(NOLOCK)    
              Where  Accno In ('1203320000000051')) A        
       Where  Avg_closing=0        
              and #prevDayReleaseQty.Accno = '1203320000000066'     
              and #prevDayReleaseQty.Isin = A.Isin                
        
      Update A        
      Set    A.Prevdaypledgeqty = B.Prevdaypledge,        
             A.Release_qty = B.Releaseqty        
      From   #TBL_PARTY_PLEDGE_DATA A        
             Inner Join (Select *        
                         From   #prevDayReleaseQty A        
                         Where  Exists (Select *        
                                        From   #TBL_PARTY_PLEDGE_DATA B        
                                        Where  A.Isin = B.Isin        
                                               And A.Accno = B.Accno        
                                               And A.Scrip_cd = B.Scrip_cd        
                                               And A.Party_code = B.Party_code        
                                               And A.Client_priority = B.Client_priority)) B        
              On A.Isin = B.Isin        
                 And A.Accno = B.Accno        
                 And A.Scrip_cd = B.Scrip_cd        
                 And A.Party_code = B.Party_code        
                 And A.Client_priority = B.Client_priority        
        
      Update A        
      Set    A.Prevdaypledgeqty = B.Qty--b.PrevDayPledge        
      From   #TBL_PARTY_PLEDGE_DATA A        
             Inner Join (Select *        
                         From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY A        
                        --Where exists (Select * from #TBL_PARTY_PLEDGE_DATA b        
                        --where a.isin=b.isin and a.accno=b.accno and a.scrip_cd=b.scrip_cd and a.party_code=b.party_code        
                        --and a.client_priority=b.client_priority)        
                        ) B        
              On A.Isin = B.Isin        
                 And A.Accno = B.Accno        
                 And A.Scrip_cd = B.Scrip_cd        
                 And A.Party_code = B.Party_code        
                 And A.Client_priority = B.Client_priority        
                 And A.Scrip_priority = B.Scrip_priority        
        
      --Declare @Rms_date As Datetime        
      Select @Rms_date = Max(Rms_date)        
      From   #TBL_PARTY_PLEDGE_DATA        
        
      Insert Into #TBL_PARTY_PLEDGE_DATA        
      Select Rms_date=@Rms_date,        
             Party_code,        
             Ledger_bal,        
             Client_priority=3,        
             Isin,        
             Scrip_cd,        
             Scripname,        
             Accno,        
             Qty=0,        
             Pledge_qty=0,        
             Free_qty=0,        
             Hold_value=0,        
             Avg_closing,        
             Pledgeable_qty=0,        
             Pledgeable_value=0,        
             Prevdaypledgeqty=Prevdaypledge,        
             Release_qty=Releaseqty,        
             Scrip_priority=1        
      From   #prevDayReleaseQty A        
      Where  Not Exists (Select *        
                         From   #TBL_PARTY_PLEDGE_DATA B        
                         Where  A.Isin = B.Isin        
                                And A.Accno = B.Accno        
                                And A.Scrip_cd = B.Scrip_cd        
                                And A.Party_code = B.Party_code        
                                And A.Client_priority = B.Client_priority)        
        
      Insert Into #TBL_PARTY_PLEDGE_DATA        
      Select Rms_date=@Rms_date,        
             Party_code,        
             Ledger_bal,        
             Client_priority=4,        
             Isin,        
             Scrip_cd,        
             Scripname,        
             Accno,        
             Qty,        
             Pledge_qty=0,        
             Free_qty,        
             Hold_value,        
             Avg_closing,        
             Pledgeable_qty= Free_qty,        
             Pledgeable_value=0,        
             Prevday_pledege_qty=Release_qty,        
             Release_qty,        
             Scrip_priority        
      From   Tbl_party_pledge_data (nolock)        
      Where  Party_code = 'Unknown'        
             And Client_priority = 1        
             And Processdate >= @LastProc_Date        
             And Processdate <= @LastProc_Date + ' 23:59:59'        
        
      ---*****Save Creditor Client For Adjustment of Pledge excces Adjustment        
      Insert Into #TBL_PARTY_PLEDGE_DATA        
      Select B.Rms_date,        
             B.Party_code,        
             Ledger_bal=B.Net,        
             Client_priority=4,        
             A.Isin,        
             A.Scrip_cd,        
             A.Scripname,        
             A.Accno,        
             A.Qty,       
             Pledge_qty=0,        
             A.Free_qty,        
             A.Hold_value,        
             A.Avg_closing,        
             Pledgeable_qty=A.Free_qty,        
             Pledgeable_value=Convert(Money, A.Free_qty * A.Avg_closing),        
             Prevdaypledgeqty=0,        
             Release_qty=0,        
             A.Scrip_priority        
      From   (Select *        
              From   #TBL_RMS_HOLDING_APPR) A        
             Inner Join (Select *        
                         From   #TBL_CL_LIST_APPR_HOLD        
                         Where  Net >= 0) B        
              On B.Party_code = A.Party_code        
        
      Begin Tran        
        
      Insert Into Tbl_party_pledge_data_log        
      Select *        
      From   Tbl_party_pledge_data (nolock)        
  
      /*Delete from Tbl_party_pledge_data        
      Where Processdate >= Convert(varchar,Getdate(),106)        
      And Processdate <= Convert(varchar,Getdate(),106) + ' 23:59:59'*/        
        
      Truncate Table Tbl_party_pledge_data        
        
      Insert Into Tbl_party_pledge_data        
      Select *,        
             Processdate=Getdate(),        
             @USERNAME        
      From   #TBL_PARTY_PLEDGE_DATA        
        
      Commit        
   End        
        
   Set nocount Off        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_client_holding_17May2018
-- --------------------------------------------------

/*    
    CHANGE ID  :: 1    
    MODIFIED BY  :: PRASHANT    
    MODIFIED DATE :: AUG 03 2013    
    REASON   :: NOT TO PLEDGE SHARES OF WCL CLIENT    
    REQUEST FROM :: RAHUL SIR    
    PRMS ID   :: NONE    
*/    
--[Usp_las_pledge_client_holding] 'System'
create Procedure [dbo].[Usp_las_pledge_client_holding_17May2018]    
(          
 @USERNAME Varchar(10)          
)          
As          
Begin          
   Set NOCOUNT On          
          
   If Not Exists (Select Hdate          
                  From   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)          
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))          
   Begin          
      Declare @LastProc_Date As Datetime          
          
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)          
      From   Tbl_party_pledge_data (nolock)          
  
      /*  
      --Changing the condition to not consider unreco credit  
      --Change by: Renil  
      --Changed on: Dec 03 2014  
      --Change Request by: Rahul C shah  
      */  
      Select Party_code,          
             Co_code,          
             Convert(Money, 0) As Ledger,          
             Imargin,          
             Cash_colleteral,          
             Noncash_colleteral,          
             Unrecosiled_credit=0.00          
      Into   #NET_AVAILABLE_PARTY          
      From   General.dbo.Rms_dtclfi With(NOLOCK)          
      Where  Co_code Not In ('MCX', 'NCDEX')          
          
      Declare @ACCOPENINGDATE   As Varchar(11),          
              @EXCLUDEOPBALDATE As Varchar(11)          
          
      Select @ACCOPENINGDATE = '04-01-' + Convert(Varchar, Case          
                                                            When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('JAN', 'FEB', 'MAR') Then Datepart(YY, Getdate()) - 2          
                                                            Else Datepart(YY, Getdate()) - 1          
                                                           End),          
             @EXCLUDEOPBALDATE = (Case          
                                   When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('APR') Then '01-01-' + Convert(Varchar, Datepart(YY, Getdate()))          
                                   Else '01-01-1900'          
                                  End)          
          
      --Set @ACCOPENINGDATE='Apr 01 2010'    
      /*  
      --Changing the condition of effective from getdate()-1 to getdate() to consider todays bill posting  
      --Change by: Renil  
      --Changed on: Dec 03 2014  
      --Change Request by: Rahul C shah  
      */        
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Bsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'BSECM'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
            Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                    Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSECM'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsefo_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSEFO'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Mcd_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MCD'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsx_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSX'      
      
      
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   anand1.MTFTrade.dbo.ledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MTF'      
          
          
      Select Party_code,          
             Ledger=Sum(Ledger),          
             Imargin=Sum(Imargin),          
             Cash_colleteral=Sum(Cash_colleteral),          
             Noncash_colleteral=Sum(Noncash_colleteral),          
             Unrecosiled_credit=Sum(Unrecosiled_credit),          
             Samargin=Convert(Money, 0.0),          
           Varmargin=Convert(Money, 0.0),          
             Co_code          
      Into   #NET_AVAILABLE          
      From   #NET_AVAILABLE_PARTY (nolock)          
      Group  By Party_code,Co_code          
          
      /*------------------------------------          
      SPAN AND ADDITIONAL MARGIN          
      SEGMENT NSEFO,MCDXCDS,NSECURFO ONLY          
      ---------------------------------------*/          
      Select Party_code,          
             Initialmargin=Sum(Initialmargin),          
             Addmargin=Sum(Addmargin),          
             Co_code          
      Into   #SPAN_ADDI_MARGIN          
      From   Vw_derivativemargin (NOLOCK) A          
      Group  By Party_code,Co_code          
          
  ------ SPAN Margin Take 175% as per Bussines          
      ------Date 15-03-2012 SPAN Margin Take 100% only changes          
      ------**************************************          
      /*Update #NET_AVAILABLE          
      Set Samargin = (Initialmargin + Addmargin) * 1.75          
      From #SPAN_ADDI_MARGIN A          
      Where #net_available.Party_code = A.Party_code          
      And #net_available.Co_code = A.Co_code*/          
          
      Update #NET_AVAILABLE          
      Set    Samargin = (Initialmargin + Addmargin)          
      From   #SPAN_ADDI_MARGIN A          
      Where  #net_available.Party_code = A.Party_code          
             And #net_available.Co_code = A.Co_code          
          
      /*------------------------------------          
      VAR MARGIN          
      SEGMENT EQUITY (BSE & NSE) ONLY          
      ---------------------------------------*/          
      Select Party_code,          
             Varmargin=Sum(Varmargin),          
             Co_code          
      Into   #EQUITY_VAR_MARGIN          
      /*Changes Done By Rohit And Anil 24 Oct 2017 to change the Var margin logic*/
      /*From   Vw_equity_var_margin (NOLOCK) A */
      From   VW_Equity_Var_Margin_Pledge (NOLOCK) A          
      Group  By Party_code,Co_code          
          
      Update #NET_AVAILABLE          
      Set    Varmargin = (A.Varmargin)          
      From   #EQUITY_VAR_MARGIN A          
      Where  #net_available.Party_code = A.Party_code          
             And #net_available.Co_code = A.Co_code          
          
      --STEP 1          
      /*---------------------------------------------------------------          
      FETCHING CLIENTS WITH APPROVED HOLDING AND EXCLUDING CLIENTS          
      FROM TBL_CLI_NOT_FOR_PLEDGE TABLE          
      TABLE TBL_CLI_NOT_FOR_PLEDGE CONTAINS ALL CLIENTS FOR WHICH LOAN          
      HAS ALREADY BEEN TAKEN.          
      ---------------------------------------------------------------*/          
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED          
          
      Select Rms_date,          
             Party_code,          
             Convert(Money, 0)    As Net,          
             Holding_approved,        
             Convert(Smallint, 0) As Client_priority          
      Into   #TBL_CL_LIST_APPR_HOLD          
      From   GENERAL.dbo.Rms_dtclfi_summ With(NOLOCK)          
      Where  Holding_approved <> 0          
          
   /*          
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR          
   NOT TO EXLUDE NON LAS CLIENT          
   */          
      --AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK))          
          
      Update A          
      Set    Net = Isnull(Net_available, 0)          
      From   #TBL_CL_LIST_APPR_HOLD A          
             Left Outer Join (Select Party_code,          
                                     Sum(Ledger - Unrecosiled_credit - (Case          
       When (Samargin) - (Cash_colleteral + Noncash_colleteral) > 0 Then (Samargin) - (Cash_colleteral + Noncash_colleteral)          
                                                                         Else 0          
                                                                        End) - Varmargin) As Net_available          
                              From   #NET_AVAILABLE          
                              Group  By Party_code) B          
              On A.Party_code = B.Party_code          
          

		truncate table MIS_AppHld_data 
		insert into MIS_AppHld_data(Rms_date,Party_code,Net,Holding_approved,Client_priority) 
		select Rms_date,Party_code,Net,Holding_approved,Client_priority from #TBL_CL_LIST_APPR_HOLD
          
      /*CHANGE ID  :: 1*/    
      /*START CHANGE ID  :: 1*/    
      Select Party_Code    
        INTO #WCL_CLIENTS    
      from MIS.DBO.WCL_ActionRpt1(convert(datetime,GETDATE(),103))    
      where BOI+YES+SCB+ADH+AXS+HDF+KOT+IDF <> 0.00    
      
          
      update A    
        set Net = 0    
      FROM #TBL_CL_LIST_APPR_HOLD A INNER JOIN #WCL_CLIENTS B    
            ON A.Party_code = B.Party_Code    
         
     INSERT INTO PLEDGE_WCL_CLIENT_LOG(PARTY_CODE)     
     SELECT PARTY_CODE    
     FROM #WCL_CLIENTS    
         
     /*END CHANGE ID  :: 1*/    
          
      /*END*/          
      --STEP 2          
      /*---------------------------------------------------------------          
      GENERATING ROW NUMBER FOR LOOPING DEBIT CLIENTS          
      ---------------------------------------------------------------*/          
      Select *,          
             Row_number() Over(Order By Net) As Row_num          
      Into   #TBL_CL_LIST_APPR_HOLD_TMP          
      From   #TBL_CL_LIST_APPR_HOLD          
      Where  Net < 0          
      Order  By Net          
          
      --STEP 3          
      /*---------------------------------------------------------------          
      FETCHING HOLDING WHERE ACCNO <> (UNSETTLED OR EMPTY) AND          
   HOLDING VALUE <> 0          
      ---------------------------------------------------------------*/          
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED          
          
      --DROP TABLE #TBL_RMS_HOLDING_APPR_TMP          
      Select Party_code,          
             Isin,          
             Scrip_cd,          
             Sum(Qty)               As Qty,          
             Convert(Int, 0)        As Pledge_qty,          
             Convert(Int, Sum(Qty)) As Free_qty,          
             Convert(Money, 0)      As Hold_value,          
             --CONVERT( DECIMAL ( 2,2 ) , ( ( SUM( QTY*CLSRATE ) / SUM( QTY ) ) ) ) AS AVG_CLOSING,          
             Convert(Money, 0)      As Avg_closing,          
             Accno,          
             Scripname,          
             Convert(Smallint, 0)   As Scrip_priority          
      Into   #TBL_RMS_HOLDING_APPR_TMP          
      From   GENERAL.dbo.Rms_holding With(NOLOCK)          
      Where  Source = 'H'          
             And Accno In('1203320000000066', '1203320000000051','1203320009603460', '1203320000000028')          
      Group  By Party_code,Isin,Accno,Scrip_cd,Scripname          
      
      
          
   /*          
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR          
   NOT TO EXLUDE NON LAS CLIENT          
   */          
      --PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK)) AND                
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */      
      /*Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                                     '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate        
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209')*/       
            
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
              and #tbl_rms_holding_appr_tmp.Accno = A.Accno      
              
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000051'       
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin       
                    
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000066'       
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin       
                    
      --STEP 4          
      /*---------------------------------------------------------------          
      SETTING APPROVED SCRIP PRIORITY BANKS WISE          
      ---------------------------------------------------------------*/          
      Select Priority,          
             Bank_code,          
             Row_number() Over(Order By Priority) As Row_num          
      Into   #BANK_LST          
      From   GENERAL.dbo.Tbl_las_bank_master With(NOLOCK)          
      Where  Active_inactive = 1          
      Order  By Priority          
          
      Declare @BANK_CNT As Int,          
              @BANK_TTL As Int,          
              @PRIORITY As Int,          
              @BANK_CD  As Int          
          
      Select @BANK_TTL = Count(*)          
      From   #BANK_LST          
          
      Select @BANK_CNT = 1          
          
      While(@BANK_CNT <= @BANK_TTL)          
      Begin          
         Select @PRIORITY = Priority,          
                @BANK_CD = Bank_code          
         From   #BANK_LST          
   Where  Row_num = @BANK_CNT          
          
         Update #TBL_RMS_HOLDING_APPR_TMP          
         Set    Scrip_priority = @PRIORITY          
         Where  Scrip_cd In (Select Scode          
                             From   GENERAL.dbo.Vw_las_appr_bank_scrip With (NOLOCK)          
                             Where  Bank_code = @BANK_CD)          
                And Scrip_priority = 0          
          
         Set @BANK_CNT = @BANK_CNT + 1          
      End          
          
      Delete From #TBL_RMS_HOLDING_APPR_TMP          
      Where  Scrip_priority = 0          
          
      --STEP 5          
      /*-----------Add New Step For New request----------------------------------------------------          
      Clinet Pledged Priority 1st Previous Day Pleded Qty          
      ---------------------------------------------------------------*/          
      Select Party_code,          
             Isin,          
             Scrip_cd,          
             Sum(Pledge_qty)    As Qty,          
             Cast(0 As Int)     As Pledge_qty,          
             Sum(Pledge_qty)    As Free_qty,        
             Cast(0.0 As Money) As Hold_value,          
             Cast(0.0 As Money) As Avg_closing,          
             Accno,          
             Scripname,          
             Cast(0 As Int)     As Scrip_priority,          
             1                  As Client_priority          
      Into   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
      From   Tbl_party_pledge_data A (nolock)          
      Where  A.Processdate >= @LastProc_Date          
             And A.Processdate <= @LastProc_Date + ' 23:59:59'          
             And A.Pledge_qty <> 0          
      Group  By Party_code,Isin,Scrip_cd,Accno,Scripname          
          
      Select A.Party_code,          
             A.Isin,          
             A.Scrip_cd,          
             Qty=New_qty,          
             A.Pledge_qty,          
             Free_qty=New_qty,          
             A.Hold_value,          
             A.Avg_closing,          
             A.Accno,          
             A.Scripname,          
             Scrip_priority=A.New_scrip_priority          
      Into   #TBL_RMS_HOLDING_APPR_PRVEDAY          
      From   (Select A.*,          
                     New_qty= (Case          
                                When (A.Qty - B.Qty) >= 0 Then B.Qty          
                                Else A.Qty          
                               End),          
                     New_scrip_priority= A.Scrip_priority          
              From   (Select *          
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
                      Where  Scrip_priority = 0) A          
        Inner Join (Select *          
                                 From   #TBL_RMS_HOLDING_APPR_TMP          
                                 Where  Scrip_priority > 0) B          
                      On A.Isin = B.Isin          
                         And A.Scrip_cd = B.Scrip_cd          
                         And A.Accno = B.Accno          
                         And A.Party_code = B.Party_code          
              Union All          
              Select A.*,          
                     New_qty= B.Qty - A.Qty,          
                     New_scrip_priority= B.Scrip_priority          
              From   (Select *          
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
                      Where  Scrip_priority = 0) A          
                     Inner Join (Select *          
                                 From   #TBL_RMS_HOLDING_APPR_TMP          
                                 Where  Scrip_priority > 0) B          
                      On A.Isin = B.Isin          
                         And A.Scrip_cd = B.Scrip_cd          
                         And A.Accno = B.Accno          
                         And A.Party_code = B.Party_code          
              Where  A.Qty < B.Qty) A          
         
      Delete A          
      From   #TBL_RMS_HOLDING_APPR_TMP As A          
             Inner Join #TBL_RMS_HOLDING_APPR_PRVEDAY B          
              On A.Isin = B.Isin          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Accno = B.Accno          
                 And A.Party_code = B.Party_code          
          
      Insert Into #TBL_RMS_HOLDING_APPR_TMP          
      Select *          
      From   #TBL_RMS_HOLDING_APPR_PRVEDAY         
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */       
      /*      
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = A.Clsrate,          
             Hold_value = Qty * A.Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                                     '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209') */      
             
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
              Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = A.Accno      
              
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
               Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000051'       
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin       
                    
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                 Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000066'       
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin          
          
      --STEP 6          
      /*---------------------------------------------------------------          
      GENERATING HOLDING ROW NUMBER FOR LOOPING          
      ---------------------------------------------------------------*/          
      Select *,          
             Row_number() Over(PARTITION By Party_code Order By Scrip_priority, Hold_value Desc) As Row_num          
      /*,CONVERT(INT,0) AS PLEDGE_DP_QTY,          
      CONVERT(INT,0) AS AFTER_ADJUST_PLEDGE_QTY*/          
      Into   #TBL_RMS_HOLDING_APPR          
      From   #TBL_RMS_HOLDING_APPR_TMP          
      Where  Free_qty <> 0          
      Order  By Party_code,Scrip_priority,Hold_value Desc          
          
      --STEP 7          
      /*------------------------------          
      STORE CLINET WISE DETAILS          
      --------------------------------*/          
      Select A.Party_code,          
             Bsecm_ledger=Sum(Case Co_code          
                               When 'BSECM' Then Ledger          
                               Else 0          
                              End),          
             Nsecm_ledger=Sum(Case Co_code          
                               When 'NSECM' Then Ledger          
                               Else 0          
                              End),          
             Nsefo_ledger=Sum(Case Co_code          
                               When 'NSEFO' Then Ledger          
                               Else 0          
                              End),          
             Mcd_ledger=Sum(Case Co_code          
                             When 'MCD' Then Ledger          
                             Else 0          
                            End),          
             Mcx_ledger=Sum(Case Co_code          
                             When 'MCX' Then Ledger          
                             Else 0          
                            End),          
             Nbfc_ledger=Sum(Case Co_code          
                              When 'NBFC' Then Ledger         
                              Else 0          
                             End),          
             Ncdex_ledger=Sum(Case Co_code          
                               When 'NCDEX' Then Ledger          
                               Else 0          
                              End),          
             Nsx_ledger=Sum(Case Co_code          
                             When 'NSX' Then Ledger          
                             Else 0          
                            End),          
             Bsecm_imargin=Sum(Case Co_code          
                                When 'BSECM' Then Imargin          
                                Else 0          
                               End),          
             Nsecm_imargin=Sum(Case Co_code          
                                When 'NSECM' Then Imargin          
                                Else 0          
                               End),          
             Nsefo_imargin=Sum(Case Co_code          
                                When 'NSEFO' Then Imargin          
                                Else 0          
                               End),          
             Mcd_imargin=Sum(Case Co_code          
                              When 'MCD' Then Imargin          
                              Else 0          
                             End),          
             Mcx_imargin=Sum(Case Co_code          
                              When 'MCX' Then Imargin          
                              Else 0          
                             End),          
             Nbfc_imargin=Sum(Case Co_code          
                               When 'NBFC' Then Imargin          
                               Else 0          
                              End),          
             Ncdex_imargin=Sum(Case Co_code          
                                When 'NCDEX' Then Imargin          
                                Else 0          
          End),          
             Nsx_imargin=Sum(Case Co_code          
                              When 'NSX' Then Imargin          
                              Else 0          
                             End),          
             Bsecm_cash_colleteral=Sum(Case Co_code          
                                        When 'BSECM' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsecm_cash_colleteral=Sum(Case Co_code          
                                        When 'NSECM' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsefo_cash_colleteral=Sum(Case Co_code          
                                        When 'NSEFO' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Mcd_cash_colleteral=Sum(Case Co_code          
                                      When 'MCD' Then Cash_colleteral          
                                      Else 0          
                       End),          
             Mcx_cash_colleteral=Sum(Case Co_code          
                                      When 'MCX' Then Cash_colleteral          
                                      Else 0          
                                     End),          
             Nbfc_cash_colleteral=Sum(Case Co_code          
                                       When 'NBFC' Then Cash_colleteral          
                                       Else 0          
                                      End),          
             Ncdex_cash_colleteral=Sum(Case Co_code          
                                        When 'NCDEX' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsx_cash_colleteral=Sum(Case Co_code          
                                      When 'NSX' Then Cash_colleteral          
                                      Else 0          
                                     End),          
        Bsecm_noncash_colleteral=Sum(Case Co_code          
                                           When 'BSECM' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsecm_noncash_colleteral=Sum(Case Co_code          
                                           When 'NSECM' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsefo_noncash_colleteral=Sum(Case Co_code          
                                           When 'NSEFO' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Mcd_noncash_colleteral=Sum(Case Co_code          
                                         When 'MCD' Then Noncash_colleteral          
                                         Else 0          
                                        End),          
             Mcx_noncash_colleteral=Sum(Case Co_code          
                                         When 'MCX' Then Noncash_colleteral          
                                         Else 0          
                                        End),          
             Nbfc_noncash_colleteral=Sum(Case Co_code          
                                          When 'NBFC' Then Noncash_colleteral          
                                          Else 0          
                                         End),          
             Ncdex_noncash_colleteral=Sum(Case Co_code          
                                           When 'NCDEX' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsx_noncash_colleteral=Sum(Case Co_code          
                                         When 'NSX' Then Noncash_colleteral          
                                         Else 0          
                     End),          
             Bsecm_unrecosiled_credit=Sum(Case Co_code          
                When 'BSECM' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsecm_unrecosiled_credit=Sum(Case Co_code    
                                           When 'NSECM' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsefo_unrecosiled_credit=Sum(Case Co_code          
                                           When 'NSEFO' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Mcd_unrecosiled_credit=Sum(Case Co_code          
                                         When 'MCD' Then Unrecosiled_credit          
                                         Else 0          
                                        End),          
             Mcx_unrecosiled_credit=Sum(Case Co_code          
                                         When 'MCX' Then Unrecosiled_credit          
                                         Else 0          
                                        End),          
             Nbfc_unrecosiled_credit=Sum(Case Co_code          
                When 'NBFC' Then Unrecosiled_credit          
                                          Else 0          
                                         End),          
             Ncdex_unrecosiled_credit=Sum(Case Co_code          
                                           When 'NCDEX' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsx_unrecosiled_credit=Sum(Case Co_code          
                                         When 'NSX' Then Unrecosiled_credit          
                                         Else 0          
                End),          
             Bsecm_varmargin=Convert(Money, 0.0),          
             Nsecm_varmargin=Convert(Money, 0.0),          
             Nsefo_varmargin=Convert(Money, 0.0),          
             Mcd_varmargin=Convert(Money, 0.0),          
             Mcx_varmargin=Convert(Money, 0.0),          
             Nbfc_varmargin=Convert(Money, 0.0),          
             Ncdex_varmargin=Convert(Money, 0.0),          
             Nsx_varmargin=Convert(Money, 0.0),          
             Bsecm_span_add_margin=Convert(Money, 0.0),          
             Nsecm_span_add_margin=Convert(Money, 0.0),          
             Nsefo_span_add_margin=Convert(Money, 0.0),          
             Mcd_span_add_margin=Convert(Money, 0.0),          
             Mcx_span_add_margin=Convert(Money, 0.0),          
             Nbfc_span_add_margin=Convert(Money, 0.0),          
             Ncdex_span_add_margin=Convert(Money, 0.0),          
             Nsx_span_add_margin=Convert(Money, 0.0)          
      Into   #PLEDGE_CLIENTWISELEDGER          
      From   #NET_AVAILABLE_PARTY A          
             Inner Join (Select Distinct Party_code          
                         From   #TBL_RMS_HOLDING_APPR) B          
              On A.Party_code = B.Party_code          
      Group  By A.Party_code          
          
      Update #PLEDGE_CLIENTWISELEDGER          
      Set    Bsecm_varmargin = A.Bsecm_varmargin,          
             Nsecm_varmargin = A.Nsecm_varmargin          
      From   (Select Party_code,          
                     Bsecm_varmargin=Sum(Case Co_code          
                                          When 'BSECM' Then Varmargin          
                                          Else 0          
                                         End),          
                     Nsecm_varmargin=Sum(Case Co_code          
                                          When 'NSECM' Then Varmargin          
                                          Else 0          
                                         End)   
			  /*Changes Done By Rohit And Anil 24 Oct 2017 to change the Var margin logic*/                                                
              /*From   Vw_equity_var_margin (NOLOCK)*/          
              From VW_Equity_Var_Margin_Pledge (NOLOCK)
              Group  By Party_code)A          
      Where  #pledge_clientwiseledger.Party_code = A.Party_code          
          
      Update #PLEDGE_CLIENTWISELEDGER          
      Set  Nsefo_span_add_margin = A.Nsefo_span_add_margin,          
             Mcd_span_add_margin = A.Mcd_span_add_margin,          
             Nsx_span_add_margin = A.Nsx_span_add_margin          
      From   (Select Party_code,          
                     Nsefo_span_add_margin=Sum(Case Co_code          
                                                When 'NSEFO' Then Initialmargin + Addmargin          
                                                Else 0          
                                               End),          
                     Mcd_span_add_margin=Sum(Case Co_code          
                                              When 'MCD' Then Initialmargin + Addmargin          
                                              Else 0          
                                             End),          
                     Nsx_span_add_margin=Sum(Case Co_code          
                                              When 'NSX' Then Initialmargin + Addmargin          
                                              Else 0          
                                             End)          
              From   Vw_derivativemargin (NOLOCK)          
              Group  By Party_code)A          
      Where  #pledge_clientwiseledger.Party_code = A.Party_code          
          
      Delete From Pledge_clientwiseledger          
      Where  Processdate >= Convert(Varchar, Getdate(), 106)          
             And Processdate <= Convert(Varchar, Getdate(), 106) + ' 23:59:59'          
          
      Insert Into Pledge_clientwiseledger          
      Select *,          
             Processdate=Getdate(),          
             Processby=@USERNAME          
      From   #PLEDGE_CLIENTWISELEDGER          
          
   /*---------------------------------------------------------------          
   FETCHING PLEDGE SCRIPS          
   ---------------------------------------------------------------*/          
      --DROP TABLE #TBL_PLEDGE_QTY_TMP          
   /*SELECT HLD_AC_CODE AS ACCNO,HLD_ISIN_CODE AS ISIN,          
   HLD_AC_POS,HLD_AC_POS AS AFTER_ADJUST_PLEDGE_QTY,CONVERT(BIT,0) AS BANK_APPROVED          
   INTO #TBL_PLEDGE_QTY_TMP          
   FROM DPBACKOFFICE.ACERCROSS.DBO.HOLDING WITH (NOLOCK)          
   --WHERE HLD_AC_CODE IN ('1203320000000051','1203320000000066')          
   WHERE HLD_AC_CODE IN (SELECT ACCNO FROM TBL_LAS_PLEDGE_ACC_MASTER WHERE ACTIVE_INACTIVE=1)          
   AND HLD_AC_TYPE ='14' */          
      --STEP 8          
      /*---------------------------------------------------------------          
      CREATING INDEX TO OPTIMIZE SELECTION          
      ---------------------------------------------------------------*/          
      Create Clustered Index [IX_ROW_NUM]          
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Row_num] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Nonclustered Index [IX_CL_LIST_PARTY]          
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Party_code] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Clustered Index [IX_HOLDING_APPR_ROW_NUM]          
       On #TBL_RMS_HOLDING_APPR ( [Party_code] Asc, [Row_num] Asc          
      --[SCRIP_PRIORITY] ASC          
      )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      --STEP 9 DROP TABLE #TBL_PARTY_PLEDGE_DATA          
      /*---------------------------------------------------------------          
      CREATING TABLE FOR FINAL DATA          
      ---------------------------------------------------------------*/          
      Create Table #TBL_PARTY_PLEDGE_DATA          
       (          
         Rms_date         Datetime,          
         Party_code       Varchar(20),          
         Ledger_bal       Money,          
         Client_priority  Smallint,    
         Isin             Varchar(20),          
         Scrip_cd         Varchar(50),          
         Scripname        Varchar(100),          
         Accno            Varchar(50),          
         Qty  Int,          
         Pledge_qty       Int,          
         Free_qty         Int,          
         Hold_value       Money,          
         Avg_closing      Money,          
         Pledgeable_qty   Int,          
         Pledgeable_value Money,          
         Prevdaypledgeqty Int,          
         Release_qty      Int,          
         Scrip_priority   Smallint          
       )          
          
      --STEP 10          
      /*---------------------------------------------------------------          
      LOOP SPLIT CLIENT SCRIP TO CATEGORIZE TYPE          
      WHERE TYPES ARE AS FOLLOWS          
      1) EQUIVALENT TO DEBIT ( DR = STOCK VALUE * 2 )          
      2) REMAINING ALL SCRIPT FROM ABOVE PROCESS WILL COME HERE          
      3) ALL CREDIT CLIENT WILL COM IN THIS CATEGORY          
      ---------------------------------------------------------------*/          
      Declare @CNT_TOTAL               As Int,          
              @ROW_COUNTER_CLIENT      As Int,          
              @ROW_COUNTER_ISIN        As Int,          
              @PARTY_CODE              As Varchar(20),          
              @PERV_PARTY_CODE         As Varchar(20),          
              @LEDGER_BAL              As Money,          
              @QTY                     As Int,          
              @PLEDGEABLE_QTY          As Int,          
              @PLEDGE_QTY              As Int,          
              @FREE_QTY                As Int,          
              @HOLD_VALUE              As Money,          
              @ISIN                    As Varchar(20),          
              @SCRIP_CD                As Varchar(50),          
              @SCRIPNAME               As Varchar(100),          
              @ACCNO                   As Varchar(50),          
          @LEDGER_TMP              As Money,          
              @CLOSING_RATE            As Money,          
              @CLIENT_PRIORITY         As Smallint,          
              @SCRIP_PRIORITY          As Smallint,          
              @HOLDING_ADJUSTED_VALUE  As Money,          
              @PLEDGEABLE_VALUE  As Money,          
              @COUNTINUE_LOOP          As Bit,          
              @AFTER_ADJUST_PLEDGE_QTY As Int,          
              @RMS_DATE                As Datetime,          
              @QTY_DIFF                As Int,          
              @SCRIP_CNT_TOTAL         As Int,          
              @SCRIP_CTR               As Int          
          
      Select @CNT_TOTAL = Count(1)          
      From   #TBL_CL_LIST_APPR_HOLD_TMP --WHERE CLIENT_PRIORITY <= 2          
          
      --PRINT @CNT_TOTAL          
      Set @ROW_COUNTER_CLIENT = 1--45943--24245          
          
      While @ROW_COUNTER_CLIENT <= @CNT_TOTAL --45943 --24246          
      Begin          
         Select @RMS_DATE = Rms_date,          
                @PARTY_CODE = Party_code,          
                @LEDGER_BAL = Net          
         From   #TBL_CL_LIST_APPR_HOLD_TMP          
         Where  Row_num = @ROW_COUNTER_CLIENT          
          
         Set @SCRIP_CNT_TOTAL = 0          
          
         Set @SCRIP_CTR = 1          
          
         Set @CLIENT_PRIORITY = 1          
          
         Select @SCRIP_CNT_TOTAL = Count(*)          
         From   #TBL_RMS_HOLDING_APPR          
         Where  Party_code = @PARTY_CODE          
          
         Set @HOLDING_ADJUSTED_VALUE = 0          
          
         Set @COUNTINUE_LOOP = 1          
          
         --PRINT '--------------------------'          
         --PRINT CONVERT(VARCHAR,@ROW_COUNTER_CLIENT)+'.) '+@PARTY_CODE+ ' $LEDGER BAL :- '+CONVERT(VARCHAR,@LEDGER_BAL) + ' $PLEDGE VALUE :- '+CONVERT(VARCHAR,@LEDGER_BAL*2)          
         --PRINT ' SCRIP (NO OF SCRIPS ['+CONVERT(VARCHAR,@SCRIP_CNT_TOTAL)+'])'          
         While(@SCRIP_CTR <= @SCRIP_CNT_TOTAL)          
         Begin          
            Set @PLEDGEABLE_QTY = 0          
          
            Set @PLEDGEABLE_VALUE = 0          
          
            Select @ISIN = A.Isin,          
                   @SCRIP_CD = Scrip_cd,          
                   @SCRIPNAME = Scripname,          
                   @QTY = Qty,          
                   @PLEDGE_QTY = Pledge_qty,          
                   @FREE_QTY = Free_qty,          
                   @HOLD_VALUE = Hold_value,          
             @ACCNO = A.Accno,          
                   @CLOSING_RATE = Avg_closing,          
                   @SCRIP_PRIORITY = Scrip_priority          
            From   #TBL_RMS_HOLDING_APPR A          
            Where  Party_code = @PARTY_CODE          
                   And Row_num = @SCRIP_CTR          
          
            If @HOLDING_ADJUSTED_VALUE < Abs(@LEDGER_BAL) * 2          
            Begin          
               If (@HOLDING_ADJUSTED_VALUE + @HOLD_VALUE) > Abs(@LEDGER_BAL) * 2          
               Begin          
                  --SET @QTY_DIFF = CEILING( ( ( ABS( @LEDGER_BAL ) * 2 - ( @HOLDING_ADJUSTED_VALUE) ) / @CLOSING_RATE ) )          
                  Set @QTY_DIFF = Floor(((Abs(@LEDGER_BAL) * 2 - (@HOLDING_ADJUSTED_VALUE)) / @CLOSING_RATE))          
          
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + (@QTY_DIFF * @CLOSING_RATE)          
          
                  Set @HOLD_VALUE = @QTY_DIFF * @CLOSING_RATE          
          
                  Set @FREE_QTY = @FREE_QTY - @QTY_DIFF          
          
                  Set @QTY = @QTY_DIFF          
          
                  Set @PLEDGEABLE_QTY = @QTY          
          
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
          
                  --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +          
                  --' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- ' +          
                  --CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
                  If @QTY > 0          
                  Begin          
                     Insert Into #TBL_PARTY_PLEDGE_DATA          
                     Values      (@RMS_DATE,          
                                  @PARTY_CODE,          
                                  @LEDGER_BAL,          
                                  @CLIENT_PRIORITY,          
                                  @ISIN,          
                                  @SCRIP_CD,          
                                  @SCRIPNAME,          
                                  @ACCNO,          
                                  @QTY,          
                                  @PLEDGE_QTY,          
                                  @QTY_DIFF,          
                                  @HOLD_VALUE,          
                                  @CLOSING_RATE,          
                                  @PLEDGEABLE_QTY,          
                                  @PLEDGEABLE_VALUE,          
                                  0,          
                                  0,          
                                  @SCRIP_PRIORITY)          
                  End          
          
                  Set @QTY = @FREE_QTY          
          
                  Set @HOLD_VALUE = @FREE_QTY * @CLOSING_RATE          
          
                  Set @PLEDGEABLE_QTY = @QTY          
          
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
          
                  Set @CLIENT_PRIORITY = 2          
               --BREAK          
               End          
               Else          
               Begin          
                  Set @PLEDGEABLE_QTY = @FREE_QTY          
          
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE          
          
  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
               End          
          
               --SET @PLEDGEABLE_VALUE = @PLEDGEABLE_QTY*@CLOSING_RATE          
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY)          
               --+ ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '          
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
               If @QTY > 0          
               Begin          
                  Insert Into #TBL_PARTY_PLEDGE_DATA          
                  Values      (@RMS_DATE,          
                               @PARTY_CODE,          
                               @LEDGER_BAL,          
                               @CLIENT_PRIORITY,          
                               @ISIN,          
                               @SCRIP_CD,          
                               @SCRIPNAME,          
                               @ACCNO,          
                               @QTY,          
                               @PLEDGE_QTY,          
                               @FREE_QTY,          
                               @HOLD_VALUE,          
                               @CLOSING_RATE,          
                               @PLEDGEABLE_QTY,          
                               @PLEDGEABLE_VALUE,          
                               0,          
                               0,          
                               @SCRIP_PRIORITY)          
               End          
            End          
            Else          
            Begin          
               Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE          
          
               Set @CLIENT_PRIORITY = 2          
          
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +          
               -- ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '          
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
               If @QTY > 0          
               Begin          
                  Insert Into #TBL_PARTY_PLEDGE_DATA          
                  Values      (@RMS_DATE,          
                               @PARTY_CODE,          
                               @LEDGER_BAL,          
                               @CLIENT_PRIORITY,          
                               @ISIN,          
                               @SCRIP_CD,          
                               @SCRIPNAME,          
                               @ACCNO,          
                               @QTY,          
                               @PLEDGE_QTY,          
                               @FREE_QTY,          
                               @HOLD_VALUE,          
                               @CLOSING_RATE,          
                               @PLEDGEABLE_QTY,          
                               @PLEDGEABLE_VALUE,          
                               0,          
                               0,          
                               @SCRIP_PRIORITY)          
          
               End          
            End          
          
            If ((@CLIENT_PRIORITY = 2)          
                And (@SCRIP_CTR < @SCRIP_CNT_TOTAL))          
            Begin          
               Insert Into #TBL_PARTY_PLEDGE_DATA          
               Select @RMS_DATE,          
                      @PARTY_CODE,          
                      @LEDGER_BAL,          
                      @CLIENT_PRIORITY,          
                      A.Isin,          
                      Scrip_cd,          
                      Scripname,          
                      A.Accno,          
                      Qty,          
                      Pledge_qty,          
                      Free_qty,          
                      Hold_value,          
                      Avg_closing,          
                      Free_qty                               As Pledgeable_qty,          
                      Convert(Money, Free_qty * Avg_closing) As Pledgeable_value,          
                      0                                      As Prevdaypledgeqty,          
                      0                                      As Release_qty,          
                      Scrip_priority          
               From   #TBL_RMS_HOLDING_APPR A          
               Where  Party_code = @PARTY_CODE          
                      And Row_num > @SCRIP_CTR          
          
               Break          
            End          
          
            Set @SCRIP_CTR = @SCRIP_CTR + 1          
         End          
          
         --PRINT ' ADJUSTED VALUE :- '+CONVERT(VARCHAR,@HOLDING_ADJUSTED_VALUE)          
         Set @ROW_COUNTER_CLIENT = @ROW_COUNTER_CLIENT + 1          
      End          
          
      --drop table #prevDayReleaseQty          
      Select A.Isin,          
             A.Party_code,          
             A.Scrip_cd,          
             A.Scripname,          
             A.Accno,          
             Releaseqty =Isnull(A.Qty, 0) - Isnull(B.Pledge_qty, 0),          
           Prevdaypledge=Isnull(A.Qty, 0),          
             A.Client_priority,          
             Ledger_bal=Convert(Money, 0.0),          
             Avg_closing=Convert(Money, 0.0)          
      Into   #prevDayReleaseQty          
      From   (Select *          
              From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
              Where  Scrip_priority = 0) A          
             Left Join (Select Party_code,          
                               Isin,          
                               Scrip_cd,          
                               Accno,          
                               Pledge_qty=Sum(Pledgeable_qty),          
                               Client_priority          
                        From   #TBL_PARTY_PLEDGE_DATA          
                        Where  Client_priority = 1 --Scrip_priority > 0 and          
                        Group  By Party_code,Isin,Scrip_cd,Accno,Client_priority) B          
              On A.Isin = B.Isin          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Accno = B.Accno          
                 And A.Party_code = B.Party_code          
      Where  Isnull(A.Qty, 0) > Isnull(B.Pledge_qty, 0)          
          
      Update #prevDayReleaseQty          
      Set    #prevdayreleaseqty.Ledger_bal = A.Net          
      From   #TBL_CL_LIST_APPR_HOLD A          
      Where  A.Party_code = #prevdayreleaseqty.Party_code          
            
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */      
      /*Update #prevDayReleaseQty          
      Set    Avg_closing = Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #prevdayreleaseqty.Isin = A.Isin          
             And #prevdayreleaseqty.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                              '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #prevDayReleaseQty          
      Set    Avg_closing = Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #prevdayreleaseqty.Isin = A.Isin          
             And #prevdayreleaseqty.Accno In ('1203320000000066', '16921197', '14216209')*/      
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate      
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #prevDayReleaseQty.Isin = A.Isin          
              and #prevDayReleaseQty.Accno = A.Accno      
              
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #prevDayReleaseQty.Accno = '1203320000000051'       
              and #prevDayReleaseQty.Isin = A.Isin       
                    
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate        
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #prevDayReleaseQty.Accno = '1203320000000066'       
              and #prevDayReleaseQty.Isin = A.Isin                  
          
      Update A          
      Set    A.Prevdaypledgeqty = B.Prevdaypledge,          
             A.Release_qty = B.Releaseqty          
      From   #TBL_PARTY_PLEDGE_DATA A          
             Inner Join (Select *          
                         From   #prevDayReleaseQty A          
                         Where  Exists (Select *          
                                        From   #TBL_PARTY_PLEDGE_DATA B          
                                        Where  A.Isin = B.Isin          
                                               And A.Accno = B.Accno          
                                               And A.Scrip_cd = B.Scrip_cd          
                                               And A.Party_code = B.Party_code          
                                               And A.Client_priority = B.Client_priority)) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Party_code = B.Party_code          
                 And A.Client_priority = B.Client_priority          
          
      Update A          
      Set    A.Prevdaypledgeqty = B.Qty--b.PrevDayPledge          
      From   #TBL_PARTY_PLEDGE_DATA A          
             Inner Join (Select *          
                         From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY A          
                        --Where exists (Select * from #TBL_PARTY_PLEDGE_DATA b          
                        --where a.isin=b.isin and a.accno=b.accno and a.scrip_cd=b.scrip_cd and a.party_code=b.party_code          
                        --and a.client_priority=b.client_priority)          
                        ) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Party_code = B.Party_code          
                 And A.Client_priority = B.Client_priority          
                 And A.Scrip_priority = B.Scrip_priority          
          
      --Declare @Rms_date As Datetime          
      Select @Rms_date = Max(Rms_date)          
      From   #TBL_PARTY_PLEDGE_DATA          
          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select Rms_date=@Rms_date,          
             Party_code,          
             Ledger_bal,          
             Client_priority=3,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty=0,          
             Pledge_qty=0,          
             Free_qty=0,          
             Hold_value=0,          
             Avg_closing,          
             Pledgeable_qty=0,          
             Pledgeable_value=0,          
             Prevdaypledgeqty=Prevdaypledge,          
             Release_qty=Releaseqty,          
             Scrip_priority=1          
      From   #prevDayReleaseQty A          
      Where  Not Exists (Select *          
                         From   #TBL_PARTY_PLEDGE_DATA B          
                         Where  A.Isin = B.Isin          
                                And A.Accno = B.Accno          
                                And A.Scrip_cd = B.Scrip_cd          
                                And A.Party_code = B.Party_code          
                                And A.Client_priority = B.Client_priority)          
          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select Rms_date=@Rms_date,          
             Party_code,          
             Ledger_bal,          
             Client_priority=4,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty,          
             Pledge_qty=0,          
             Free_qty,          
             Hold_value,          
             Avg_closing,          
             Pledgeable_qty= Free_qty,          
             Pledgeable_value=0,          
             Prevday_pledege_qty=Release_qty,          
             Release_qty,          
             Scrip_priority          
      From   Tbl_party_pledge_data (nolock)          
      Where  Party_code = 'Unknown'          
             And Client_priority = 1          
             And Processdate >= @LastProc_Date          
             And Processdate <= @LastProc_Date + ' 23:59:59'          
          
      ---*****Save Creditor Client For Adjustment of Pledge excces Adjustment          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select B.Rms_date,          
             B.Party_code,          
             Ledger_bal=B.Net,          
             Client_priority=4,          
             A.Isin,          
             A.Scrip_cd,          
             A.Scripname,          
             A.Accno,          
             A.Qty,         
             Pledge_qty=0,          
             A.Free_qty,          
             A.Hold_value,          
             A.Avg_closing,          
             Pledgeable_qty=A.Free_qty,          
             Pledgeable_value=Convert(Money, A.Free_qty * A.Avg_closing),          
             Prevdaypledgeqty=0,          
             Release_qty=0,          
             A.Scrip_priority          
      From   (Select *          
              From   #TBL_RMS_HOLDING_APPR) A          
             Inner Join (Select *          
                         From   #TBL_CL_LIST_APPR_HOLD          
                         Where  Net >= 0) B          
              On B.Party_code = A.Party_code          
          
      Begin Tran          
          
      Insert Into Tbl_party_pledge_data_log          
      Select *          
      From   Tbl_party_pledge_data (nolock)          
    
      /*Delete from Tbl_party_pledge_data          
      Where Processdate >= Convert(varchar,Getdate(),106)          
      And Processdate <= Convert(varchar,Getdate(),106) + ' 23:59:59'*/          
          
      Truncate Table Tbl_party_pledge_data          
          
      Insert Into Tbl_party_pledge_data          
      Select *,          
             Processdate=Getdate(),          
             @USERNAME          
      From   #TBL_PARTY_PLEDGE_DATA          
          
      Commit          
   End          
          
   Set nocount Off          
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_client_holding_18Jun2019
-- --------------------------------------------------

/*    
    CHANGE ID  :: 1    
    MODIFIED BY  :: PRASHANT    
    MODIFIED DATE :: AUG 03 2013    
    REASON   :: NOT TO PLEDGE SHARES OF WCL CLIENT    
    REQUEST FROM :: RAHUL SIR    
    PRMS ID   :: NONE  
    
    Changes: There is changes has been Done on 29 Jun 2018 by Rohit Patil after discussion with Anil Wandre.
			 Now on wards SP will consider the Co_code MCX and NCDEX	  
*/    
--[Usp_las_pledge_client_holding] 'System'
create Procedure [dbo].[Usp_las_pledge_client_holding_18Jun2019]    
(          
 @USERNAME Varchar(10)          
)          
As          
Begin          
   Set NOCOUNT On          
          
   If Not Exists (Select Hdate          
                  From   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)          
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))          
   Begin          
      Declare @LastProc_Date As Datetime          
          
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)          
      From   Tbl_party_pledge_data (nolock)          
  
      /*  
      --Changing the condition to not consider unreco credit  
      --Change by: Renil  
      --Changed on: Dec 03 2014  
      --Change Request by: Rahul C shah  
      */  
      Select Party_code,          
             Co_code,          
             Convert(Money, 0) As Ledger,          
             Imargin,          
             Cash_colleteral,          
             Noncash_colleteral,          
             Unrecosiled_credit=0.00          
      Into   #NET_AVAILABLE_PARTY          
      From   General.dbo.Rms_dtclfi With(NOLOCK)          
      /* Where  Co_code Not In ('MCX', 'NCDEX') */ /* Condition is commented on 29 June 2018 */        
          
      Declare @ACCOPENINGDATE   As Varchar(11),          
              @EXCLUDEOPBALDATE As Varchar(11)          
          
      Select @ACCOPENINGDATE = '04-01-' + Convert(Varchar, Case          
                                                            When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('JAN', 'FEB', 'MAR') Then Datepart(YY, Getdate()) - 2          
                                                            Else Datepart(YY, Getdate()) - 1          
                                                           End),          
             @EXCLUDEOPBALDATE = (Case          
                                   When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('APR') Then '01-01-' + Convert(Varchar, Datepart(YY, Getdate()))          
                                   Else '01-01-1900'          
                                  End)          
          
      --Set @ACCOPENINGDATE='Apr 01 2010'    
      /*  
      --Changing the condition of effective from getdate()-1 to getdate() to consider todays bill posting  
      --Change by: Renil  
      --Changed on: Dec 03 2014  
      --Change Request by: Rahul C shah  
      */        
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Bsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'BSECM'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
            Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                    Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSECM'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsefo_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSEFO'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Mcd_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MCD'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsx_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSX'      
      
      
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                              /* From   anand1.MTFTrade.dbo.ledger With(NOLOCK)          */  /*****Commented on 17 May 2018 by neha**********/
                              From   General.dbo.MTF_CLedger With(NOLOCK)   
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MTF'      
      
      /*********start*************Added by Neha Naiwar on 01 Feb2019 As per Anil W mail**********************************/    
          Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.MCX_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MCX'       
      
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.NCDEX_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NCDEX'  
      /*************End***********************************************************************************************/    
      
      Select Party_code,          
             Ledger=Sum(Ledger),          
             Imargin=Sum(Imargin),          
             Cash_colleteral=Sum(Cash_colleteral),          
             Noncash_colleteral=Sum(Noncash_colleteral),          
             Unrecosiled_credit=Sum(Unrecosiled_credit),          
             Samargin=Convert(Money, 0.0),          
           Varmargin=Convert(Money, 0.0),          
             Co_code          
      Into   #NET_AVAILABLE          
      From   #NET_AVAILABLE_PARTY (nolock)          
      Group  By Party_code,Co_code          
          
      /*------------------------------------          
      SPAN AND ADDITIONAL MARGIN          
      SEGMENT NSEFO,MCDXCDS,NSECURFO ONLY          
      ---------------------------------------*/          
      Select Party_code,          
             Initialmargin=Sum(Initialmargin),          
             Addmargin=Sum(Addmargin),          
             Co_code          
      Into   #SPAN_ADDI_MARGIN          
      From   Vw_derivativemargin (NOLOCK) A          
      Group  By Party_code,Co_code          
          
  ------ SPAN Margin Take 175% as per Bussines          
      ------Date 15-03-2012 SPAN Margin Take 100% only changes          
      ------**************************************          
      /*Update #NET_AVAILABLE          
      Set Samargin = (Initialmargin + Addmargin) * 1.75          
      From #SPAN_ADDI_MARGIN A          
      Where #net_available.Party_code = A.Party_code          
      And #net_available.Co_code = A.Co_code*/          
          
      Update #NET_AVAILABLE          
      Set    Samargin = (Initialmargin + Addmargin)          
      From   #SPAN_ADDI_MARGIN A          
      Where  #net_available.Party_code = A.Party_code          
             And #net_available.Co_code = A.Co_code          
          
      /*------------------------------------          
      VAR MARGIN          
      SEGMENT EQUITY (BSE & NSE) ONLY          
      ---------------------------------------*/          
      Select Party_code,          
             Varmargin=Sum(Varmargin),          
             Co_code          
      Into   #EQUITY_VAR_MARGIN          
      /*Changes Done By Rohit And Anil 24 Oct 2017 to change the Var margin logic*/
      /*From   Vw_equity_var_margin (NOLOCK) A */
      From   VW_Equity_Var_Margin_Pledge (NOLOCK) A          
      Group  By Party_code,Co_code          
          
      Update #NET_AVAILABLE          
      Set    Varmargin = (A.Varmargin)          
      From   #EQUITY_VAR_MARGIN A          
      Where  #net_available.Party_code = A.Party_code          
             And #net_available.Co_code = A.Co_code          
          
      --STEP 1          
      /*---------------------------------------------------------------          
      FETCHING CLIENTS WITH APPROVED HOLDING AND EXCLUDING CLIENTS          
      FROM TBL_CLI_NOT_FOR_PLEDGE TABLE          
      TABLE TBL_CLI_NOT_FOR_PLEDGE CONTAINS ALL CLIENTS FOR WHICH LOAN          
      HAS ALREADY BEEN TAKEN.          
      ---------------------------------------------------------------*/          
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED          
          
      Select Rms_date,          
             Party_code,          
             Convert(Money, 0)    As Net,          
             Holding_approved,        
             Convert(Smallint, 0) As Client_priority          
      Into   #TBL_CL_LIST_APPR_HOLD          
      From   GENERAL.dbo.Rms_dtclfi_summ With(NOLOCK)          
      Where  Holding_approved <> 0          
          
   /*          
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR          
   NOT TO EXLUDE NON LAS CLIENT          
   */          
      --AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK))          
          
      Update A          
      Set    Net = Isnull(Net_available, 0)          
      From   #TBL_CL_LIST_APPR_HOLD A          
             Left Outer Join (Select Party_code,          
                                     Sum(Ledger - Unrecosiled_credit - (Case          
       When (Samargin) - (Cash_colleteral + Noncash_colleteral) > 0 Then (Samargin) - (Cash_colleteral + Noncash_colleteral)          
                                                                         Else 0          
                                                                        End) - Varmargin) As Net_available          
                              From   #NET_AVAILABLE          
                              Group  By Party_code) B          
              On A.Party_code = B.Party_code          
          

		truncate table MIS_AppHld_data 
		insert into MIS_AppHld_data(Rms_date,Party_code,Net,Holding_approved,Client_priority) 
		select Rms_date,Party_code,Net,Holding_approved,Client_priority from #TBL_CL_LIST_APPR_HOLD
          
      /*CHANGE ID  :: 1*/    
      /*START CHANGE ID  :: 1*/    
      Select Party_Code    
        INTO #WCL_CLIENTS    
      from MIS.DBO.WCL_ActionRpt1(convert(datetime,GETDATE(),103))    
      where BOI+YES+SCB+ADH+AXS+HDF+KOT+IDF <> 0.00    
      
          
      update A    
        set Net = 0    
      FROM #TBL_CL_LIST_APPR_HOLD A INNER JOIN #WCL_CLIENTS B    
            ON A.Party_code = B.Party_Code    
         
     INSERT INTO PLEDGE_WCL_CLIENT_LOG(PARTY_CODE)     
     SELECT PARTY_CODE    
     FROM #WCL_CLIENTS    
         
     /*END CHANGE ID  :: 1*/    
          
      /*END*/          
      --STEP 2          
      /*---------------------------------------------------------------          
      GENERATING ROW NUMBER FOR LOOPING DEBIT CLIENTS          
      ---------------------------------------------------------------*/          
      Select *,          
             Row_number() Over(Order By Net) As Row_num          
      Into   #TBL_CL_LIST_APPR_HOLD_TMP          
      From   #TBL_CL_LIST_APPR_HOLD          
      Where  Net < 0          
      Order  By Net          
          
      --STEP 3          
      /*---------------------------------------------------------------          
      FETCHING HOLDING WHERE ACCNO <> (UNSETTLED OR EMPTY) AND          
   HOLDING VALUE <> 0          
      ---------------------------------------------------------------*/          
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED          
          
      --DROP TABLE #TBL_RMS_HOLDING_APPR_TMP          
      Select Party_code,          
             Isin,          
             Scrip_cd,          
             Sum(Qty)               As Qty,          
             Convert(Int, 0)        As Pledge_qty,          
             Convert(Int, Sum(Qty)) As Free_qty,          
             Convert(Money, 0)      As Hold_value,          
             --CONVERT( DECIMAL ( 2,2 ) , ( ( SUM( QTY*CLSRATE ) / SUM( QTY ) ) ) ) AS AVG_CLOSING,          
             Convert(Money, 0)      As Avg_closing,          
             Accno,          
             Scripname,          
             Convert(Smallint, 0)   As Scrip_priority          
      Into   #TBL_RMS_HOLDING_APPR_TMP          
      From   GENERAL.dbo.Rms_holding With(NOLOCK)          
      Where  Source = 'H'          
             And Accno In('1203320000000066', '1203320000000051','1203320009603460', '1203320000000028')          
      Group  By Party_code,Isin,Accno,Scrip_cd,Scripname          
      
      
          
   /*          
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR          
   NOT TO EXLUDE NON LAS CLIENT          
   */          
      --PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK)) AND                
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */      
      /*Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                                     '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate        
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209')*/       
            
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
              and #tbl_rms_holding_appr_tmp.Accno = A.Accno      
              
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000051'       
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin       
                    
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000066'       
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin       
                    
      --STEP 4          
      /*---------------------------------------------------------------          
      SETTING APPROVED SCRIP PRIORITY BANKS WISE          
      ---------------------------------------------------------------*/          
      Select Priority,          
             Bank_code,          
             Row_number() Over(Order By Priority) As Row_num          
      Into   #BANK_LST          
      From   GENERAL.dbo.Tbl_las_bank_master With(NOLOCK)          
      Where  Active_inactive = 1          
      Order  By Priority          
          
      Declare @BANK_CNT As Int,          
              @BANK_TTL As Int,          
              @PRIORITY As Int,          
              @BANK_CD  As Int          
          
      Select @BANK_TTL = Count(*)          
      From   #BANK_LST          
          
      Select @BANK_CNT = 1          
          
      While(@BANK_CNT <= @BANK_TTL)          
      Begin          
         Select @PRIORITY = Priority,          
                @BANK_CD = Bank_code          
         From   #BANK_LST          
   Where  Row_num = @BANK_CNT          
          
         Update #TBL_RMS_HOLDING_APPR_TMP          
         Set    Scrip_priority = @PRIORITY          
         Where  Scrip_cd In (Select Scode          
                             From   GENERAL.dbo.Vw_las_appr_bank_scrip With (NOLOCK)          
                             Where  Bank_code = @BANK_CD)          
                And Scrip_priority = 0          
          
         Set @BANK_CNT = @BANK_CNT + 1          
      End          
          
      Delete From #TBL_RMS_HOLDING_APPR_TMP          
      Where  Scrip_priority = 0          
          
      --STEP 5          
      /*-----------Add New Step For New request----------------------------------------------------          
      Clinet Pledged Priority 1st Previous Day Pleded Qty          
      ---------------------------------------------------------------*/          
      Select Party_code,          
             Isin,          
             Scrip_cd,          
             Sum(Pledge_qty)    As Qty,          
             Cast(0 As Int)     As Pledge_qty,          
             Sum(Pledge_qty)    As Free_qty,        
             Cast(0.0 As Money) As Hold_value,          
             Cast(0.0 As Money) As Avg_closing,          
             Accno,          
             Scripname,          
             Cast(0 As Int)     As Scrip_priority,          
             1                  As Client_priority          
      Into   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
      From   Tbl_party_pledge_data A (nolock)          
      Where  A.Processdate >= @LastProc_Date          
             And A.Processdate <= @LastProc_Date + ' 23:59:59'          
             And A.Pledge_qty <> 0          
      Group  By Party_code,Isin,Scrip_cd,Accno,Scripname          
          
      Select A.Party_code,          
             A.Isin,          
             A.Scrip_cd,          
             Qty=New_qty,          
             A.Pledge_qty,          
             Free_qty=New_qty,          
             A.Hold_value,          
             A.Avg_closing,          
             A.Accno,          
             A.Scripname,          
             Scrip_priority=A.New_scrip_priority          
      Into   #TBL_RMS_HOLDING_APPR_PRVEDAY          
      From   (Select A.*,          
                     New_qty= (Case          
                                When (A.Qty - B.Qty) >= 0 Then B.Qty          
                                Else A.Qty          
                               End),          
                     New_scrip_priority= A.Scrip_priority          
              From   (Select *          
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
                      Where  Scrip_priority = 0) A          
        Inner Join (Select *          
                                 From   #TBL_RMS_HOLDING_APPR_TMP          
                                 Where  Scrip_priority > 0) B          
                      On A.Isin = B.Isin          
                         And A.Scrip_cd = B.Scrip_cd          
                         And A.Accno = B.Accno          
                         And A.Party_code = B.Party_code          
              Union All          
              Select A.*,          
                     New_qty= B.Qty - A.Qty,          
                     New_scrip_priority= B.Scrip_priority          
              From   (Select *          
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
                      Where  Scrip_priority = 0) A          
                     Inner Join (Select *          
                                 From   #TBL_RMS_HOLDING_APPR_TMP          
                                 Where  Scrip_priority > 0) B          
                      On A.Isin = B.Isin          
                         And A.Scrip_cd = B.Scrip_cd          
                         And A.Accno = B.Accno          
                         And A.Party_code = B.Party_code          
              Where  A.Qty < B.Qty) A          
         
      Delete A          
      From   #TBL_RMS_HOLDING_APPR_TMP As A          
             Inner Join #TBL_RMS_HOLDING_APPR_PRVEDAY B          
              On A.Isin = B.Isin          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Accno = B.Accno          
                 And A.Party_code = B.Party_code          
          
      Insert Into #TBL_RMS_HOLDING_APPR_TMP          
      Select *          
      From   #TBL_RMS_HOLDING_APPR_PRVEDAY         
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */       
      /*      
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = A.Clsrate,          
             Hold_value = Qty * A.Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                                     '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209') */      
             
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
              Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = A.Accno      
              
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
               Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000051'       
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin       
                    
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                 Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000066'       
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin          
          
      --STEP 6          
      /*---------------------------------------------------------------          
      GENERATING HOLDING ROW NUMBER FOR LOOPING          
      ---------------------------------------------------------------*/          
      Select *,          
             Row_number() Over(PARTITION By Party_code Order By Scrip_priority, Hold_value Desc) As Row_num          
      /*,CONVERT(INT,0) AS PLEDGE_DP_QTY,          
      CONVERT(INT,0) AS AFTER_ADJUST_PLEDGE_QTY*/          
      Into   #TBL_RMS_HOLDING_APPR          
      From   #TBL_RMS_HOLDING_APPR_TMP          
      Where  Free_qty <> 0          
      Order  By Party_code,Scrip_priority,Hold_value Desc          
          
      --STEP 7          
      /*------------------------------          
      STORE CLINET WISE DETAILS          
      --------------------------------*/          
      Select A.Party_code,          
             Bsecm_ledger=Sum(Case Co_code          
                               When 'BSECM' Then Ledger          
                               Else 0          
                              End),          
             Nsecm_ledger=Sum(Case Co_code          
                               When 'NSECM' Then Ledger          
                               Else 0          
                              End),          
             Nsefo_ledger=Sum(Case Co_code          
                               When 'NSEFO' Then Ledger          
                               Else 0          
                              End),          
             Mcd_ledger=Sum(Case Co_code          
                             When 'MCD' Then Ledger          
                             Else 0          
                            End),          
             Mcx_ledger=Sum(Case Co_code          
                             When 'MCX' Then Ledger          
                             Else 0          
                            End),          
             Nbfc_ledger=Sum(Case Co_code          
                              When 'NBFC' Then Ledger         
                              Else 0          
                             End),          
             Ncdex_ledger=Sum(Case Co_code          
                               When 'NCDEX' Then Ledger          
                               Else 0          
                              End),          
             Nsx_ledger=Sum(Case Co_code          
                             When 'NSX' Then Ledger          
                             Else 0          
                            End),
   /*************added on 17 May 2018 *****************/                            
			MTF_ledger=Sum(Case Co_code            
                             When 'MTF' Then Ledger            
                             Else 0            
                            End),     
   /**********************************/                                  
             Bsecm_imargin=Sum(Case Co_code          
                                When 'BSECM' Then Imargin          
                                Else 0          
                               End),          
             Nsecm_imargin=Sum(Case Co_code          
                                When 'NSECM' Then Imargin          
                                Else 0          
                               End),          
             Nsefo_imargin=Sum(Case Co_code          
                                When 'NSEFO' Then Imargin          
                                Else 0          
                               End),          
             Mcd_imargin=Sum(Case Co_code          
                              When 'MCD' Then Imargin          
                              Else 0          
                             End),          
             Mcx_imargin=Sum(Case Co_code          
                              When 'MCX' Then Imargin          
                              Else 0          
                             End),          
             Nbfc_imargin=Sum(Case Co_code          
                               When 'NBFC' Then Imargin          
                               Else 0          
                              End),          
             Ncdex_imargin=Sum(Case Co_code          
                                When 'NCDEX' Then Imargin          
                                Else 0          
          End),          
             Nsx_imargin=Sum(Case Co_code          
                              When 'NSX' Then Imargin          
                              Else 0          
                             End),          
             Bsecm_cash_colleteral=Sum(Case Co_code          
                                        When 'BSECM' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsecm_cash_colleteral=Sum(Case Co_code          
                                        When 'NSECM' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsefo_cash_colleteral=Sum(Case Co_code          
                                        When 'NSEFO' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Mcd_cash_colleteral=Sum(Case Co_code          
                                      When 'MCD' Then Cash_colleteral          
                                      Else 0          
                       End),          
             Mcx_cash_colleteral=Sum(Case Co_code          
                                      When 'MCX' Then Cash_colleteral          
                                      Else 0          
                                     End),          
             Nbfc_cash_colleteral=Sum(Case Co_code          
                                       When 'NBFC' Then Cash_colleteral          
                                       Else 0          
                                      End),          
             Ncdex_cash_colleteral=Sum(Case Co_code          
                                        When 'NCDEX' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsx_cash_colleteral=Sum(Case Co_code          
                                      When 'NSX' Then Cash_colleteral          
                                      Else 0          
                                     End),          
        Bsecm_noncash_colleteral=Sum(Case Co_code          
                                           When 'BSECM' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsecm_noncash_colleteral=Sum(Case Co_code          
                                           When 'NSECM' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsefo_noncash_colleteral=Sum(Case Co_code          
                                           When 'NSEFO' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Mcd_noncash_colleteral=Sum(Case Co_code          
                                         When 'MCD' Then Noncash_colleteral          
                                         Else 0          
                                        End),          
             Mcx_noncash_colleteral=Sum(Case Co_code          
                                         When 'MCX' Then Noncash_colleteral          
                                         Else 0          
                                        End),          
             Nbfc_noncash_colleteral=Sum(Case Co_code          
                                          When 'NBFC' Then Noncash_colleteral          
                                          Else 0          
                                         End),          
             Ncdex_noncash_colleteral=Sum(Case Co_code          
                                           When 'NCDEX' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsx_noncash_colleteral=Sum(Case Co_code          
                                         When 'NSX' Then Noncash_colleteral          
                                         Else 0          
                     End),          
             Bsecm_unrecosiled_credit=Sum(Case Co_code          
                When 'BSECM' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsecm_unrecosiled_credit=Sum(Case Co_code    
                                           When 'NSECM' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsefo_unrecosiled_credit=Sum(Case Co_code          
                                           When 'NSEFO' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Mcd_unrecosiled_credit=Sum(Case Co_code          
                                         When 'MCD' Then Unrecosiled_credit          
                                         Else 0          
                                        End),          
             Mcx_unrecosiled_credit=Sum(Case Co_code          
                                         When 'MCX' Then Unrecosiled_credit          
                                         Else 0          
                                        End),          
             Nbfc_unrecosiled_credit=Sum(Case Co_code          
                When 'NBFC' Then Unrecosiled_credit          
                                          Else 0          
                                         End),          
             Ncdex_unrecosiled_credit=Sum(Case Co_code          
                                           When 'NCDEX' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsx_unrecosiled_credit=Sum(Case Co_code          
                                         When 'NSX' Then Unrecosiled_credit          
                                         Else 0          
                End),          
             Bsecm_varmargin=Convert(Money, 0.0),          
             Nsecm_varmargin=Convert(Money, 0.0),          
             Nsefo_varmargin=Convert(Money, 0.0),          
             Mcd_varmargin=Convert(Money, 0.0),          
             Mcx_varmargin=Convert(Money, 0.0),          
             Nbfc_varmargin=Convert(Money, 0.0),          
             Ncdex_varmargin=Convert(Money, 0.0),          
             Nsx_varmargin=Convert(Money, 0.0),          
             Bsecm_span_add_margin=Convert(Money, 0.0),          
             Nsecm_span_add_margin=Convert(Money, 0.0),          
             Nsefo_span_add_margin=Convert(Money, 0.0),          
             Mcd_span_add_margin=Convert(Money, 0.0),          
             Mcx_span_add_margin=Convert(Money, 0.0),          
             Nbfc_span_add_margin=Convert(Money, 0.0),          
             Ncdex_span_add_margin=Convert(Money, 0.0),          
             Nsx_span_add_margin=Convert(Money, 0.0)          
      Into   #PLEDGE_CLIENTWISELEDGER          
      From   #NET_AVAILABLE_PARTY A          
             Inner Join (Select Distinct Party_code          
                         From   #TBL_RMS_HOLDING_APPR) B          
              On A.Party_code = B.Party_code          
      Group  By A.Party_code          
          
      Update #PLEDGE_CLIENTWISELEDGER          
      Set    Bsecm_varmargin = A.Bsecm_varmargin,          
             Nsecm_varmargin = A.Nsecm_varmargin          
      From   (Select Party_code,          
                     Bsecm_varmargin=Sum(Case Co_code          
                                          When 'BSECM' Then Varmargin          
                                          Else 0          
                                         End),          
                     Nsecm_varmargin=Sum(Case Co_code          
                                          When 'NSECM' Then Varmargin          
                                          Else 0          
                                         End)   
			  /*Changes Done By Rohit And Anil 24 Oct 2017 to change the Var margin logic*/                                                
              /*From   Vw_equity_var_margin (NOLOCK)*/          
              From VW_Equity_Var_Margin_Pledge (NOLOCK)
              Group  By Party_code)A          
      Where  #pledge_clientwiseledger.Party_code = A.Party_code          
          
      Update #PLEDGE_CLIENTWISELEDGER          
      Set  Nsefo_span_add_margin = A.Nsefo_span_add_margin,          
             Mcd_span_add_margin = A.Mcd_span_add_margin,          
             Nsx_span_add_margin = A.Nsx_span_add_margin          
      From   (Select Party_code,          
                     Nsefo_span_add_margin=Sum(Case Co_code          
                                                When 'NSEFO' Then Initialmargin + Addmargin          
                                                Else 0          
                                               End),          
                     Mcd_span_add_margin=Sum(Case Co_code          
                                              When 'MCD' Then Initialmargin + Addmargin          
                                              Else 0          
                                             End),          
                     Nsx_span_add_margin=Sum(Case Co_code          
                                              When 'NSX' Then Initialmargin + Addmargin          
                                              Else 0          
                                             End)          
              From   Vw_derivativemargin (NOLOCK)          
              Group  By Party_code)A          
      Where  #pledge_clientwiseledger.Party_code = A.Party_code          
          
      Delete From Pledge_clientwiseledger          
      Where  Processdate >= Convert(Varchar, Getdate(), 106)          
             And Processdate <= Convert(Varchar, Getdate(), 106) + ' 23:59:59'          
          
      Insert Into Pledge_clientwiseledger(Party_code,BSECM_LEDGER,NSECM_LEDGER,NSEFO_LEDGER,MCD_LEDGER,MCX_LEDGER,NBFC_LEDGER,NCDEX_LEDGER,NSX_LEDGER,MTF_ledger,BSECM_IMARGIN,NSECM_IMARGIN,NSEFO_IMARGIN,MCD_IMARGIN,MCX_IMARGIN,NBFC_IMARGIN,NCDEX_IMARGIN,NSX_IMARGIN,BSECM_CASH_COLLETERAL,NSECM_CASH_COLLETERAL,NSEFO_CASH_COLLETERAL,MCD_CASH_COLLETERAL,MCX_CASH_COLLETERAL,NBFC_CASH_COLLETERAL,NCDEX_CASH_COLLETERAL,NSX_CASH_COLLETERAL,BSECM_NONCASH_COLLETERAL,NSECM_NONCASH_COLLETERAL,NSEFO_NONCASH_COLLETERAL,MCD_NONCASH_COLLETERAL,MCX_NONCASH_COLLETERAL,NBFC_NONCASH_COLLETERAL,NCDEX_NONCASH_COLLETERAL,NSX_NONCASH_COLLETERAL,BSECM_UNRECOSILED_CREDIT,NSECM_UNRECOSILED_CREDIT,NSEFO_UNRECOSILED_CREDIT,MCD_UNRECOSILED_CREDIT,MCX_UNRECOSILED_CREDIT,NBFC_UNRECOSILED_CREDIT,NCDEX_UNRECOSILED_CREDIT,NSX_UNRECOSILED_CREDIT,BSECM_VARMARGIN,NSECM_VARMARGIN,NSEFO_VARMARGIN,MCD_VARMARGIN,MCX_VARMARGIN,NBFC_VARMARGIN,NCDEX_VARMARGIN,NSX_VARMARGIN,BSECM_SPAN_ADD_MARGIN,NSECM_SPAN_ADD_MARGIN,NSEFO_SPAN_ADD_MARGIN,MCD_SPAN_ADD_MARGIN,MCX_SPAN_ADD_MARGIN,NBFC_SPAN_ADD_MARGIN,NCDEX_SPAN_ADD_MARGIN,NSX_SPAN_ADD_MARGIN,ProcessDate,ProcessBy)          
      Select Party_code,BSECM_LEDGER,NSECM_LEDGER,NSEFO_LEDGER,MCD_LEDGER,MCX_LEDGER,NBFC_LEDGER,NCDEX_LEDGER,NSX_LEDGER,MTF_ledger,BSECM_IMARGIN,NSECM_IMARGIN,NSEFO_IMARGIN,MCD_IMARGIN,MCX_IMARGIN,NBFC_IMARGIN,NCDEX_IMARGIN,NSX_IMARGIN,BSECM_CASH_COLLETERAL,NSECM_CASH_COLLETERAL,NSEFO_CASH_COLLETERAL,MCD_CASH_COLLETERAL,MCX_CASH_COLLETERAL,NBFC_CASH_COLLETERAL,NCDEX_CASH_COLLETERAL,NSX_CASH_COLLETERAL,BSECM_NONCASH_COLLETERAL,NSECM_NONCASH_COLLETERAL,NSEFO_NONCASH_COLLETERAL,MCD_NONCASH_COLLETERAL,MCX_NONCASH_COLLETERAL,NBFC_NONCASH_COLLETERAL,NCDEX_NONCASH_COLLETERAL,NSX_NONCASH_COLLETERAL,BSECM_UNRECOSILED_CREDIT,NSECM_UNRECOSILED_CREDIT,NSEFO_UNRECOSILED_CREDIT,MCD_UNRECOSILED_CREDIT,MCX_UNRECOSILED_CREDIT,NBFC_UNRECOSILED_CREDIT,NCDEX_UNRECOSILED_CREDIT,NSX_UNRECOSILED_CREDIT,BSECM_VARMARGIN,NSECM_VARMARGIN,NSEFO_VARMARGIN,MCD_VARMARGIN,MCX_VARMARGIN,NBFC_VARMARGIN,NCDEX_VARMARGIN,NSX_VARMARGIN,BSECM_SPAN_ADD_MARGIN,NSECM_SPAN_ADD_MARGIN,NSEFO_SPAN_ADD_MARGIN,MCD_SPAN_ADD_MARGIN,MCX_SPAN_ADD_MARGIN,NBFC_SPAN_ADD_MARGIN,NCDEX_SPAN_ADD_MARGIN,NSX_SPAN_ADD_MARGIN,          
             Processdate=Getdate(),          
             Processby=@USERNAME          
      From   #PLEDGE_CLIENTWISELEDGER          
          
   /*---------------------------------------------------------------          
   FETCHING PLEDGE SCRIPS          
   ---------------------------------------------------------------*/          
      --DROP TABLE #TBL_PLEDGE_QTY_TMP          
   /*SELECT HLD_AC_CODE AS ACCNO,HLD_ISIN_CODE AS ISIN,          
   HLD_AC_POS,HLD_AC_POS AS AFTER_ADJUST_PLEDGE_QTY,CONVERT(BIT,0) AS BANK_APPROVED          
   INTO #TBL_PLEDGE_QTY_TMP          
   FROM DPBACKOFFICE.ACERCROSS.DBO.HOLDING WITH (NOLOCK)          
   --WHERE HLD_AC_CODE IN ('1203320000000051','1203320000000066')          
   WHERE HLD_AC_CODE IN (SELECT ACCNO FROM TBL_LAS_PLEDGE_ACC_MASTER WHERE ACTIVE_INACTIVE=1)          
   AND HLD_AC_TYPE ='14' */          
      --STEP 8          
      /*---------------------------------------------------------------          
      CREATING INDEX TO OPTIMIZE SELECTION          
      ---------------------------------------------------------------*/          
      Create Clustered Index [IX_ROW_NUM]          
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Row_num] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Nonclustered Index [IX_CL_LIST_PARTY]          
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Party_code] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Clustered Index [IX_HOLDING_APPR_ROW_NUM]          
       On #TBL_RMS_HOLDING_APPR ( [Party_code] Asc, [Row_num] Asc          
      --[SCRIP_PRIORITY] ASC          
      )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      --STEP 9 DROP TABLE #TBL_PARTY_PLEDGE_DATA          
      /*---------------------------------------------------------------          
      CREATING TABLE FOR FINAL DATA          
      ---------------------------------------------------------------*/          
      Create Table #TBL_PARTY_PLEDGE_DATA          
       (          
         Rms_date         Datetime,          
         Party_code       Varchar(20),          
         Ledger_bal       Money,          
         Client_priority  Smallint,    
         Isin             Varchar(20),          
         Scrip_cd         Varchar(50),          
         Scripname        Varchar(100),          
         Accno            Varchar(50),          
         Qty  Int,          
         Pledge_qty       Int,          
         Free_qty         Int,          
         Hold_value       Money,          
         Avg_closing      Money,          
         Pledgeable_qty   Int,          
         Pledgeable_value Money,          
         Prevdaypledgeqty Int,          
         Release_qty      Int,          
         Scrip_priority   Smallint          
       )          
          
      --STEP 10          
      /*---------------------------------------------------------------          
      LOOP SPLIT CLIENT SCRIP TO CATEGORIZE TYPE          
      WHERE TYPES ARE AS FOLLOWS          
      1) EQUIVALENT TO DEBIT ( DR = STOCK VALUE * 2 )          
      2) REMAINING ALL SCRIPT FROM ABOVE PROCESS WILL COME HERE          
      3) ALL CREDIT CLIENT WILL COM IN THIS CATEGORY          
      ---------------------------------------------------------------*/          
      Declare @CNT_TOTAL               As Int,          
              @ROW_COUNTER_CLIENT      As Int,          
              @ROW_COUNTER_ISIN        As Int,          
              @PARTY_CODE              As Varchar(20),          
              @PERV_PARTY_CODE         As Varchar(20),          
              @LEDGER_BAL              As Money,          
              @QTY                     As Int,          
              @PLEDGEABLE_QTY          As Int,          
              @PLEDGE_QTY              As Int,          
              @FREE_QTY                As Int,          
              @HOLD_VALUE              As Money,          
              @ISIN                    As Varchar(20),          
              @SCRIP_CD                As Varchar(50),          
              @SCRIPNAME               As Varchar(100),          
              @ACCNO                   As Varchar(50),          
          @LEDGER_TMP              As Money,          
              @CLOSING_RATE            As Money,          
              @CLIENT_PRIORITY         As Smallint,          
              @SCRIP_PRIORITY          As Smallint,          
              @HOLDING_ADJUSTED_VALUE  As Money,          
              @PLEDGEABLE_VALUE  As Money,          
              @COUNTINUE_LOOP          As Bit,          
              @AFTER_ADJUST_PLEDGE_QTY As Int,          
              @RMS_DATE                As Datetime,          
              @QTY_DIFF                As Int,          
              @SCRIP_CNT_TOTAL         As Int,          
              @SCRIP_CTR               As Int          
          
      Select @CNT_TOTAL = Count(1)          
      From   #TBL_CL_LIST_APPR_HOLD_TMP --WHERE CLIENT_PRIORITY <= 2          
          
      --PRINT @CNT_TOTAL          
      Set @ROW_COUNTER_CLIENT = 1--45943--24245          
          
      While @ROW_COUNTER_CLIENT <= @CNT_TOTAL --45943 --24246          
      Begin          
         Select @RMS_DATE = Rms_date,          
                @PARTY_CODE = Party_code,          
                @LEDGER_BAL = Net          
         From   #TBL_CL_LIST_APPR_HOLD_TMP          
         Where  Row_num = @ROW_COUNTER_CLIENT          
          
         Set @SCRIP_CNT_TOTAL = 0          
          
         Set @SCRIP_CTR = 1          
          
         Set @CLIENT_PRIORITY = 1          
          
         Select @SCRIP_CNT_TOTAL = Count(*)          
         From   #TBL_RMS_HOLDING_APPR          
         Where  Party_code = @PARTY_CODE          
          
         Set @HOLDING_ADJUSTED_VALUE = 0          
          
         Set @COUNTINUE_LOOP = 1          
          
         --PRINT '--------------------------'          
         --PRINT CONVERT(VARCHAR,@ROW_COUNTER_CLIENT)+'.) '+@PARTY_CODE+ ' $LEDGER BAL :- '+CONVERT(VARCHAR,@LEDGER_BAL) + ' $PLEDGE VALUE :- '+CONVERT(VARCHAR,@LEDGER_BAL*2)          
         --PRINT ' SCRIP (NO OF SCRIPS ['+CONVERT(VARCHAR,@SCRIP_CNT_TOTAL)+'])'          
         While(@SCRIP_CTR <= @SCRIP_CNT_TOTAL)          
         Begin          
            Set @PLEDGEABLE_QTY = 0          
          
            Set @PLEDGEABLE_VALUE = 0          
          
            Select @ISIN = A.Isin,          
                   @SCRIP_CD = Scrip_cd,          
                   @SCRIPNAME = Scripname,          
                   @QTY = Qty,          
                   @PLEDGE_QTY = Pledge_qty,          
                   @FREE_QTY = Free_qty,          
                   @HOLD_VALUE = Hold_value,          
             @ACCNO = A.Accno,          
                   @CLOSING_RATE = Avg_closing,          
                   @SCRIP_PRIORITY = Scrip_priority          
            From   #TBL_RMS_HOLDING_APPR A          
            Where  Party_code = @PARTY_CODE          
                   And Row_num = @SCRIP_CTR          
          
            If @HOLDING_ADJUSTED_VALUE < Abs(@LEDGER_BAL) * 2          
            Begin          
               If (@HOLDING_ADJUSTED_VALUE + @HOLD_VALUE) > Abs(@LEDGER_BAL) * 2          
               Begin          
                  --SET @QTY_DIFF = CEILING( ( ( ABS( @LEDGER_BAL ) * 2 - ( @HOLDING_ADJUSTED_VALUE) ) / @CLOSING_RATE ) )          
                  Set @QTY_DIFF = Floor(((Abs(@LEDGER_BAL) * 2 - (@HOLDING_ADJUSTED_VALUE)) / @CLOSING_RATE))          
          
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + (@QTY_DIFF * @CLOSING_RATE)          
          
                  Set @HOLD_VALUE = @QTY_DIFF * @CLOSING_RATE          
          
                  Set @FREE_QTY = @FREE_QTY - @QTY_DIFF          
          
                  Set @QTY = @QTY_DIFF          
          
                  Set @PLEDGEABLE_QTY = @QTY          
          
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
          
                  --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +          
                  --' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- ' +          
                  --CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
                  If @QTY > 0          
                  Begin          
                     Insert Into #TBL_PARTY_PLEDGE_DATA          
                     Values      (@RMS_DATE,          
                                  @PARTY_CODE,          
                                  @LEDGER_BAL,          
                                  @CLIENT_PRIORITY,          
                                  @ISIN,          
                                  @SCRIP_CD,          
                                  @SCRIPNAME,          
                                  @ACCNO,          
                                  @QTY,          
                                  @PLEDGE_QTY,          
                                  @QTY_DIFF,          
                                  @HOLD_VALUE,          
                                  @CLOSING_RATE,          
                                  @PLEDGEABLE_QTY,          
                                  @PLEDGEABLE_VALUE,          
                                  0,          
                                  0,          
                                  @SCRIP_PRIORITY)          
                  End          
          
                  Set @QTY = @FREE_QTY          
          
                  Set @HOLD_VALUE = @FREE_QTY * @CLOSING_RATE          
          
                  Set @PLEDGEABLE_QTY = @QTY          
          
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
          
                  Set @CLIENT_PRIORITY = 2          
               --BREAK          
               End          
               Else          
               Begin          
                  Set @PLEDGEABLE_QTY = @FREE_QTY          
          
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE          
          
  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
               End          
          
               --SET @PLEDGEABLE_VALUE = @PLEDGEABLE_QTY*@CLOSING_RATE          
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY)          
               --+ ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '          
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
               If @QTY > 0          
               Begin          
                  Insert Into #TBL_PARTY_PLEDGE_DATA          
                  Values      (@RMS_DATE,          
                               @PARTY_CODE,          
                               @LEDGER_BAL,          
                               @CLIENT_PRIORITY,          
                               @ISIN,          
                               @SCRIP_CD,          
                               @SCRIPNAME,          
                               @ACCNO,          
                               @QTY,          
                               @PLEDGE_QTY,          
                               @FREE_QTY,          
                               @HOLD_VALUE,          
                               @CLOSING_RATE,          
                               @PLEDGEABLE_QTY,          
                               @PLEDGEABLE_VALUE,          
                               0,          
                               0,          
                               @SCRIP_PRIORITY)          
               End          
            End          
            Else          
            Begin          
               Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE          
          
               Set @CLIENT_PRIORITY = 2          
          
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +          
               -- ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '          
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
               If @QTY > 0          
               Begin          
                  Insert Into #TBL_PARTY_PLEDGE_DATA          
                  Values      (@RMS_DATE,          
                               @PARTY_CODE,          
                               @LEDGER_BAL,          
                               @CLIENT_PRIORITY,          
                               @ISIN,          
                               @SCRIP_CD,          
                               @SCRIPNAME,          
                               @ACCNO,          
                               @QTY,          
                               @PLEDGE_QTY,          
                               @FREE_QTY,          
                               @HOLD_VALUE,          
                               @CLOSING_RATE,          
                               @PLEDGEABLE_QTY,          
                               @PLEDGEABLE_VALUE,          
                               0,          
                               0,          
                               @SCRIP_PRIORITY)          
          
               End          
            End          
          
            If ((@CLIENT_PRIORITY = 2)          
                And (@SCRIP_CTR < @SCRIP_CNT_TOTAL))          
            Begin          
               Insert Into #TBL_PARTY_PLEDGE_DATA          
               Select @RMS_DATE,          
                      @PARTY_CODE,          
                      @LEDGER_BAL,          
                      @CLIENT_PRIORITY,          
                      A.Isin,          
                      Scrip_cd,          
                      Scripname,          
                      A.Accno,          
                      Qty,          
                      Pledge_qty,          
                      Free_qty,          
                      Hold_value,          
                      Avg_closing,          
                      Free_qty                               As Pledgeable_qty,          
                      Convert(Money, Free_qty * Avg_closing) As Pledgeable_value,          
                      0                                      As Prevdaypledgeqty,          
                      0                                      As Release_qty,          
                      Scrip_priority          
               From   #TBL_RMS_HOLDING_APPR A          
               Where  Party_code = @PARTY_CODE          
                      And Row_num > @SCRIP_CTR          
          
               Break          
            End          
          
            Set @SCRIP_CTR = @SCRIP_CTR + 1          
         End          
          
         --PRINT ' ADJUSTED VALUE :- '+CONVERT(VARCHAR,@HOLDING_ADJUSTED_VALUE)          
         Set @ROW_COUNTER_CLIENT = @ROW_COUNTER_CLIENT + 1          
      End          
          
      --drop table #prevDayReleaseQty          
      Select A.Isin,          
             A.Party_code,          
             A.Scrip_cd,          
             A.Scripname,          
             A.Accno,          
             Releaseqty =Isnull(A.Qty, 0) - Isnull(B.Pledge_qty, 0),          
           Prevdaypledge=Isnull(A.Qty, 0),          
             A.Client_priority,          
             Ledger_bal=Convert(Money, 0.0),          
             Avg_closing=Convert(Money, 0.0)          
      Into   #prevDayReleaseQty          
      From   (Select *          
              From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
              Where  Scrip_priority = 0) A          
             Left Join (Select Party_code,          
                               Isin,          
                               Scrip_cd,          
                               Accno,          
                               Pledge_qty=Sum(Pledgeable_qty),          
                               Client_priority          
                        From   #TBL_PARTY_PLEDGE_DATA          
                        Where  Client_priority = 1 --Scrip_priority > 0 and          
                        Group  By Party_code,Isin,Scrip_cd,Accno,Client_priority) B          
              On A.Isin = B.Isin          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Accno = B.Accno          
                 And A.Party_code = B.Party_code          
      Where  Isnull(A.Qty, 0) > Isnull(B.Pledge_qty, 0)          
          
      Update #prevDayReleaseQty          
      Set    #prevdayreleaseqty.Ledger_bal = A.Net          
      From   #TBL_CL_LIST_APPR_HOLD A          
      Where  A.Party_code = #prevdayreleaseqty.Party_code          
            
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */      
      /*Update #prevDayReleaseQty          
      Set    Avg_closing = Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #prevdayreleaseqty.Isin = A.Isin          
             And #prevdayreleaseqty.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                              '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #prevDayReleaseQty          
      Set    Avg_closing = Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #prevdayreleaseqty.Isin = A.Isin          
             And #prevdayreleaseqty.Accno In ('1203320000000066', '16921197', '14216209')*/      
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate      
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #prevDayReleaseQty.Isin = A.Isin          
              and #prevDayReleaseQty.Accno = A.Accno      
              
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #prevDayReleaseQty.Accno = '1203320000000051'       
              and #prevDayReleaseQty.Isin = A.Isin       
                    
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate        
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #prevDayReleaseQty.Accno = '1203320000000066'       
              and #prevDayReleaseQty.Isin = A.Isin                  
          
      Update A          
      Set    A.Prevdaypledgeqty = B.Prevdaypledge,          
             A.Release_qty = B.Releaseqty          
      From   #TBL_PARTY_PLEDGE_DATA A          
             Inner Join (Select *          
                         From   #prevDayReleaseQty A          
                         Where  Exists (Select *          
                                        From   #TBL_PARTY_PLEDGE_DATA B          
                                        Where  A.Isin = B.Isin          
                                               And A.Accno = B.Accno          
                                               And A.Scrip_cd = B.Scrip_cd          
                                               And A.Party_code = B.Party_code          
                                               And A.Client_priority = B.Client_priority)) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Party_code = B.Party_code          
                 And A.Client_priority = B.Client_priority          
          
      Update A          
      Set    A.Prevdaypledgeqty = B.Qty--b.PrevDayPledge          
      From   #TBL_PARTY_PLEDGE_DATA A          
             Inner Join (Select *          
                         From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY A          
                        --Where exists (Select * from #TBL_PARTY_PLEDGE_DATA b          
                        --where a.isin=b.isin and a.accno=b.accno and a.scrip_cd=b.scrip_cd and a.party_code=b.party_code          
                        --and a.client_priority=b.client_priority)          
                        ) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Party_code = B.Party_code          
                 And A.Client_priority = B.Client_priority          
                 And A.Scrip_priority = B.Scrip_priority          
          
      --Declare @Rms_date As Datetime          
      Select @Rms_date = Max(Rms_date)          
      From   #TBL_PARTY_PLEDGE_DATA          
          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select Rms_date=@Rms_date,          
             Party_code,          
             Ledger_bal,          
             Client_priority=3,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty=0,          
             Pledge_qty=0,          
             Free_qty=0,          
             Hold_value=0,          
             Avg_closing,          
             Pledgeable_qty=0,          
             Pledgeable_value=0,          
             Prevdaypledgeqty=Prevdaypledge,          
             Release_qty=Releaseqty,          
             Scrip_priority=1          
      From   #prevDayReleaseQty A          
      Where  Not Exists (Select *          
                         From   #TBL_PARTY_PLEDGE_DATA B          
                         Where  A.Isin = B.Isin          
                                And A.Accno = B.Accno          
                                And A.Scrip_cd = B.Scrip_cd          
                                And A.Party_code = B.Party_code          
                                And A.Client_priority = B.Client_priority)          
          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select Rms_date=@Rms_date,          
             Party_code,          
             Ledger_bal,          
             Client_priority=4,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty,          
             Pledge_qty=0,          
             Free_qty,          
             Hold_value,          
             Avg_closing,          
             Pledgeable_qty= Free_qty,          
             Pledgeable_value=0,          
             Prevday_pledege_qty=Release_qty,          
             Release_qty,          
             Scrip_priority          
      From   Tbl_party_pledge_data (nolock)          
      Where  Party_code = 'Unknown'          
             And Client_priority = 1          
             And Processdate >= @LastProc_Date          
             And Processdate <= @LastProc_Date + ' 23:59:59'          
          
      ---*****Save Creditor Client For Adjustment of Pledge excces Adjustment          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select B.Rms_date,          
             B.Party_code,          
             Ledger_bal=B.Net,          
             Client_priority=4,          
             A.Isin,          
             A.Scrip_cd,          
             A.Scripname,          
             A.Accno,          
             A.Qty,         
             Pledge_qty=0,          
             A.Free_qty,          
             A.Hold_value,          
             A.Avg_closing,          
             Pledgeable_qty=A.Free_qty,          
             Pledgeable_value=Convert(Money, A.Free_qty * A.Avg_closing),          
             Prevdaypledgeqty=0,          
             Release_qty=0,          
             A.Scrip_priority          
      From   (Select *          
              From   #TBL_RMS_HOLDING_APPR) A          
             Inner Join (Select *          
                         From   #TBL_CL_LIST_APPR_HOLD          
                         Where  Net >= 0) B          
              On B.Party_code = A.Party_code          
          
      Begin Tran          
          
      Insert Into Tbl_party_pledge_data_log          
      Select *          
      From   Tbl_party_pledge_data (nolock)          
    
      /*Delete from Tbl_party_pledge_data          
      Where Processdate >= Convert(varchar,Getdate(),106)          
      And Processdate <= Convert(varchar,Getdate(),106) + ' 23:59:59'*/          
          
      Truncate Table Tbl_party_pledge_data          
          
      Insert Into Tbl_party_pledge_data          
      Select *,          
             Processdate=Getdate(),          
             @USERNAME          
      From   #TBL_PARTY_PLEDGE_DATA          
          
      Commit          
   End          
          
   Set nocount Off          
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_client_holding_30Jan2019
-- --------------------------------------------------

/*    
    CHANGE ID  :: 1    
    MODIFIED BY  :: PRASHANT    
    MODIFIED DATE :: AUG 03 2013    
    REASON   :: NOT TO PLEDGE SHARES OF WCL CLIENT    
    REQUEST FROM :: RAHUL SIR    
    PRMS ID   :: NONE  
    
    Changes: There is changes has been Done on 29 Jun 2018 by Rohit Patil after discussion with Anil Wandre.
			 Now on wards SP will consider the Co_code MCX and NCDEX	  
*/    
--[Usp_las_pledge_client_holding] 'System'
create Procedure [dbo].[Usp_las_pledge_client_holding_30Jan2019]    
(          
 @USERNAME Varchar(10)          
)          
As          
Begin          
   Set NOCOUNT On          
          
   If Not Exists (Select Hdate          
                  From   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)          
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))          
   Begin          
      Declare @LastProc_Date As Datetime          
          
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)          
      From   Tbl_party_pledge_data (nolock)          
  
      /*  
      --Changing the condition to not consider unreco credit  
      --Change by: Renil  
      --Changed on: Dec 03 2014  
      --Change Request by: Rahul C shah  
      */  
      Select Party_code,          
             Co_code,          
             Convert(Money, 0) As Ledger,          
             Imargin,          
             Cash_colleteral,          
             Noncash_colleteral,          
             Unrecosiled_credit/*=0.00          */
      Into   #NET_AVAILABLE_PARTY          
      From   General.dbo.Rms_dtclfi With(NOLOCK)          
      /* Where  Co_code Not In ('MCX', 'NCDEX') */ /* Condition is commented on 29 June 2018 */        
          
      Declare @ACCOPENINGDATE   As Varchar(11),          
              @EXCLUDEOPBALDATE As Varchar(11)          
          
      Select @ACCOPENINGDATE = '04-01-' + Convert(Varchar, Case          
                                                            When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('JAN', 'FEB', 'MAR') Then Datepart(YY, Getdate()) - 2          
                                                            Else Datepart(YY, Getdate()) - 1          
                                                           End),          
             @EXCLUDEOPBALDATE = (Case          
                                   When Upper(Left(Convert(Varchar, Getdate()), 3)) In ('APR') Then '01-01-' + Convert(Varchar, Datepart(YY, Getdate()))          
                                   Else '01-01-1900'          
                                  End)          
          
      --Set @ACCOPENINGDATE='Apr 01 2010'    
      /*  
      --Changing the condition of effective from getdate()-1 to getdate() to consider todays bill posting  
      --Change by: Renil  
      --Changed on: Dec 03 2014  
      --Change Request by: Rahul C shah  
      */        
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Bsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'BSECM'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
            Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsecm_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                    Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSECM'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsefo_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSEFO'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Mcd_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MCD'          
          
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.Nsx_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NSX'      
      
      
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                              /* From   anand1.MTFTrade.dbo.ledger With(NOLOCK)          */  /*****Commented on 17 May 2018 by neha**********/
                              From   General.dbo.MTF_CLedger With(NOLOCK)   
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MTF'      

  Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.MCX_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'MCX'       
      
      Update A          
      Set    Ledger = Isnull(Bal, 0)          
      From   #NET_AVAILABLE_PARTY A          
             Right Outer Join (Select Cltcode,          
                                      Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
                                          End) As Bal          
                               From   General.dbo.NCDEX_cledger With(NOLOCK)          
                               Where  Vdt >= @ACCOPENINGDATE          
                                      And Edt <= Convert(Varchar(11), Getdate() ) + ' 23:59:59'          
                               --And Not (Vtyp = 18          
                               -- And Vdt = @EXCLUDEOPBALDATE)          
                               Group  By Cltcode          
                               Having Sum(Case          
                                           When Drcr = 'D' Then -Vamt          
                                           Else Vamt          
             End) <> 0) B          
              On A.Party_code = B.Cltcode          
      Where  Co_code = 'NCDEX'  
          
          
      Select Party_code,          
             Ledger=Sum(Ledger),          
             Imargin=Sum(Imargin),          
             Cash_colleteral=Sum(Cash_colleteral),          
             Noncash_colleteral=Sum(Noncash_colleteral),          
             Unrecosiled_credit=Sum(Unrecosiled_credit),          
             Samargin=Convert(Money, 0.0),          
           Varmargin=Convert(Money, 0.0),          
             Co_code          
      Into   #NET_AVAILABLE          
      From   #NET_AVAILABLE_PARTY (nolock)          
      Group  By Party_code,Co_code          
          
      /*------------------------------------          
      SPAN AND ADDITIONAL MARGIN          
      SEGMENT NSEFO,MCDXCDS,NSECURFO ONLY          
      ---------------------------------------*/          
      Select Party_code,          
             Initialmargin=Sum(Initialmargin),          
             Addmargin=Sum(Addmargin),          
             Co_code          
      Into   #SPAN_ADDI_MARGIN          
      From   Vw_derivativemargin (NOLOCK) A          
      Group  By Party_code,Co_code          
          
  ------ SPAN Margin Take 175% as per Bussines          
      ------Date 15-03-2012 SPAN Margin Take 100% only changes          
      ------**************************************          
      /*Update #NET_AVAILABLE          
      Set Samargin = (Initialmargin + Addmargin) * 1.75          
      From #SPAN_ADDI_MARGIN A          
      Where #net_available.Party_code = A.Party_code          
      And #net_available.Co_code = A.Co_code*/          
          
      Update #NET_AVAILABLE          
      Set    Samargin = (Initialmargin + Addmargin)          
      From   #SPAN_ADDI_MARGIN A          
      Where  #net_available.Party_code = A.Party_code          
             And #net_available.Co_code = A.Co_code          
          
      /*------------------------------------          
      VAR MARGIN          
      SEGMENT EQUITY (BSE & NSE) ONLY          
      ---------------------------------------*/          
      Select Party_code,          
             Varmargin=Sum(Varmargin),          
             Co_code          
      Into   #EQUITY_VAR_MARGIN          
      /*Changes Done By Rohit And Anil 24 Oct 2017 to change the Var margin logic*/
      /*From   Vw_equity_var_margin (NOLOCK) A */
      From   VW_Equity_Var_Margin_Pledge (NOLOCK) A          
      Group  By Party_code,Co_code          
          
      Update #NET_AVAILABLE          
      Set    Varmargin = (A.Varmargin)          
      From   #EQUITY_VAR_MARGIN A          
      Where  #net_available.Party_code = A.Party_code          
             And #net_available.Co_code = A.Co_code          
          
      --STEP 1          
      /*---------------------------------------------------------------          
      FETCHING CLIENTS WITH APPROVED HOLDING AND EXCLUDING CLIENTS          
      FROM TBL_CLI_NOT_FOR_PLEDGE TABLE          
      TABLE TBL_CLI_NOT_FOR_PLEDGE CONTAINS ALL CLIENTS FOR WHICH LOAN          
      HAS ALREADY BEEN TAKEN.          
      ---------------------------------------------------------------*/          
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED          
          
      Select Rms_date,          
             Party_code,          
             Convert(Money, 0)    As Net,          
             Holding_approved,        
             Convert(Smallint, 0) As Client_priority          
      Into   #TBL_CL_LIST_APPR_HOLD          
      From   GENERAL.dbo.Rms_dtclfi_summ With(NOLOCK)          
      Where  Holding_approved <> 0          
          
   /*          
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR          
   NOT TO EXLUDE NON LAS CLIENT          
   */          
      --AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK))          
          
      Update A          
      Set    Net = Isnull(Net_available, 0)          
      From   #TBL_CL_LIST_APPR_HOLD A          
             Left Outer Join (Select Party_code,          
                                     Sum(Ledger - Unrecosiled_credit - (Case          
       When (Samargin) - (Cash_colleteral + Noncash_colleteral) > 0 Then (Samargin) - (Cash_colleteral + Noncash_colleteral)          
                                                                         Else 0          
                                                                        End) - Varmargin) As Net_available          
                              From   #NET_AVAILABLE          
                              Group  By Party_code) B          
              On A.Party_code = B.Party_code          
          

		--truncate table MIS_AppHld_data 
		--insert into MIS_AppHld_data(Rms_date,Party_code,Net,Holding_approved,Client_priority) 
		--select Rms_date,Party_code,Net,Holding_approved,Client_priority from #TBL_CL_LIST_APPR_HOLD
          
      /*CHANGE ID  :: 1*/    
      /*START CHANGE ID  :: 1*/    
      Select Party_Code    
        INTO #WCL_CLIENTS    
      from MIS.DBO.WCL_ActionRpt1(convert(datetime,GETDATE(),103))    
      where BOI+YES+SCB+ADH+AXS+HDF+KOT+IDF <> 0.00    
      
          
      update A    
        set Net = 0    
      FROM #TBL_CL_LIST_APPR_HOLD A INNER JOIN #WCL_CLIENTS B    
            ON A.Party_code = B.Party_Code    
         
     --INSERT INTO PLEDGE_WCL_CLIENT_LOG(PARTY_CODE)     
     --SELECT PARTY_CODE    
     --FROM #WCL_CLIENTS    
         
     /*END CHANGE ID  :: 1*/    
          
      /*END*/          
      --STEP 2          
      /*---------------------------------------------------------------          
      GENERATING ROW NUMBER FOR LOOPING DEBIT CLIENTS          
      ---------------------------------------------------------------*/          
      Select *,          
             Row_number() Over(Order By Net) As Row_num          
      Into   #TBL_CL_LIST_APPR_HOLD_TMP          
      From   #TBL_CL_LIST_APPR_HOLD          
      Where  Net < 0          
      Order  By Net          
          
      --STEP 3          
      /*---------------------------------------------------------------          
      FETCHING HOLDING WHERE ACCNO <> (UNSETTLED OR EMPTY) AND          
   HOLDING VALUE <> 0          
      ---------------------------------------------------------------*/          
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED          
          
      --DROP TABLE #TBL_RMS_HOLDING_APPR_TMP          
      Select Party_code,          
             Isin,          
             Scrip_cd,          
             Sum(Qty)               As Qty,          
             Convert(Int, 0)        As Pledge_qty,          
             Convert(Int, Sum(Qty)) As Free_qty,          
             Convert(Money, 0)      As Hold_value,          
             --CONVERT( DECIMAL ( 2,2 ) , ( ( SUM( QTY*CLSRATE ) / SUM( QTY ) ) ) ) AS AVG_CLOSING,          
             Convert(Money, 0)      As Avg_closing,          
             Accno,          
             Scripname,          
             Convert(Smallint, 0)   As Scrip_priority          
      Into   #TBL_RMS_HOLDING_APPR_TMP          
      From   GENERAL.dbo.Rms_holding With(NOLOCK)          
      Where  Source = 'H'          
             And Accno In('1203320000000066', '1203320000000051','1203320009603460', '1203320000000028')          
      Group  By Party_code,Isin,Accno,Scrip_cd,Scripname          
      
      
          
   /*          
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR          
   NOT TO EXLUDE NON LAS CLIENT          
   */          
      --PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK)) AND                
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */      
      /*Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                                     '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate        
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             --And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209')*/       
            
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
              and #tbl_rms_holding_appr_tmp.Accno = A.Accno      
              
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000051'       
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin       
                    
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #tbl_rms_holding_appr_tmp.Accno = '1203320000000066'       
              and #tbl_rms_holding_appr_tmp.Isin = A.Isin       
                    
      --STEP 4          
      /*---------------------------------------------------------------          
      SETTING APPROVED SCRIP PRIORITY BANKS WISE          
      ---------------------------------------------------------------*/          
      Select Priority,          
             Bank_code,          
             Row_number() Over(Order By Priority) As Row_num          
      Into   #BANK_LST          
      From   GENERAL.dbo.Tbl_las_bank_master With(NOLOCK)          
      Where  Active_inactive = 1          
      Order  By Priority          
          
      Declare @BANK_CNT As Int,          
              @BANK_TTL As Int,          
              @PRIORITY As Int,          
              @BANK_CD  As Int          
          
      Select @BANK_TTL = Count(*)          
      From   #BANK_LST          
          
      Select @BANK_CNT = 1          
          
      While(@BANK_CNT <= @BANK_TTL)          
      Begin          
         Select @PRIORITY = Priority,          
                @BANK_CD = Bank_code          
         From   #BANK_LST          
   Where  Row_num = @BANK_CNT          
          
         Update #TBL_RMS_HOLDING_APPR_TMP          
         Set    Scrip_priority = @PRIORITY          
         Where  Scrip_cd In (Select Scode          
                             From   GENERAL.dbo.Vw_las_appr_bank_scrip With (NOLOCK)          
                             Where  Bank_code = @BANK_CD)          
                And Scrip_priority = 0          
          
         Set @BANK_CNT = @BANK_CNT + 1          
      End          
          
      Delete From #TBL_RMS_HOLDING_APPR_TMP          
      Where  Scrip_priority = 0          
          
      --STEP 5          
      /*-----------Add New Step For New request----------------------------------------------------          
      Clinet Pledged Priority 1st Previous Day Pleded Qty          
      ---------------------------------------------------------------*/          
      Select Party_code,          
             Isin,          
             Scrip_cd,          
             Sum(Pledge_qty)    As Qty,          
             Cast(0 As Int)     As Pledge_qty,          
             Sum(Pledge_qty)    As Free_qty,        
             Cast(0.0 As Money) As Hold_value,          
             Cast(0.0 As Money) As Avg_closing,          
             Accno,          
             Scripname,          
             Cast(0 As Int)     As Scrip_priority,          
             1                  As Client_priority          
      Into   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
      From   Tbl_party_pledge_data A (nolock)          
      Where  A.Processdate >= @LastProc_Date          
             And A.Processdate <= @LastProc_Date + ' 23:59:59'          
             And A.Pledge_qty <> 0          
      Group  By Party_code,Isin,Scrip_cd,Accno,Scripname          
          
      Select A.Party_code,          
             A.Isin,          
             A.Scrip_cd,          
             Qty=New_qty,          
             A.Pledge_qty,          
             Free_qty=New_qty,          
             A.Hold_value,          
             A.Avg_closing,          
             A.Accno,          
             A.Scripname,          
             Scrip_priority=A.New_scrip_priority          
      Into   #TBL_RMS_HOLDING_APPR_PRVEDAY          
      From   (Select A.*,          
                     New_qty= (Case          
                                When (A.Qty - B.Qty) >= 0 Then B.Qty          
                                Else A.Qty          
                               End),          
                     New_scrip_priority= A.Scrip_priority          
              From   (Select *          
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
                      Where  Scrip_priority = 0) A          
        Inner Join (Select *          
                                 From   #TBL_RMS_HOLDING_APPR_TMP          
                                 Where  Scrip_priority > 0) B          
                      On A.Isin = B.Isin          
                         And A.Scrip_cd = B.Scrip_cd          
                         And A.Accno = B.Accno          
                         And A.Party_code = B.Party_code          
              Union All          
              Select A.*,          
                     New_qty= B.Qty - A.Qty,          
                     New_scrip_priority= B.Scrip_priority          
              From   (Select *          
                      From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
                      Where  Scrip_priority = 0) A          
                     Inner Join (Select *          
                                 From   #TBL_RMS_HOLDING_APPR_TMP          
                                 Where  Scrip_priority > 0) B          
                      On A.Isin = B.Isin          
                         And A.Scrip_cd = B.Scrip_cd          
                         And A.Accno = B.Accno          
                         And A.Party_code = B.Party_code          
              Where  A.Qty < B.Qty) A          
         
      Delete A          
      From   #TBL_RMS_HOLDING_APPR_TMP As A          
             Inner Join #TBL_RMS_HOLDING_APPR_PRVEDAY B          
              On A.Isin = B.Isin          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Accno = B.Accno          
                 And A.Party_code = B.Party_code          
          
      Insert Into #TBL_RMS_HOLDING_APPR_TMP          
      Select *          
      From   #TBL_RMS_HOLDING_APPR_PRVEDAY         
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */       
      /*      
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = A.Clsrate,          
             Hold_value = Qty * A.Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                                     '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #TBL_RMS_HOLDING_APPR_TMP          
      Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #tbl_rms_holding_appr_tmp.Isin = A.Isin          
             And #tbl_rms_holding_appr_tmp.Avg_closing <> A.Clsrate          
             And #tbl_rms_holding_appr_tmp.Accno In ('1203320000000066', '16921197', '14216209') */      
             
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
              Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = A.Accno      
              
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
               Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000051'       
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin       
                    
       Update #TBL_RMS_HOLDING_APPR_TMP          
       Set    Avg_closing = Clsrate,          
             Hold_value = Qty * Clsrate          
       From   (Select Isin,          
                 Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #TBL_RMS_HOLDING_APPR_TMP.Accno = '1203320000000066'       
              and #TBL_RMS_HOLDING_APPR_TMP.Isin = A.Isin          
          
      --STEP 6          
      /*---------------------------------------------------------------          
      GENERATING HOLDING ROW NUMBER FOR LOOPING          
      ---------------------------------------------------------------*/          
      Select *,          
             Row_number() Over(PARTITION By Party_code Order By Scrip_priority, Hold_value Desc) As Row_num          
      /*,CONVERT(INT,0) AS PLEDGE_DP_QTY,          
      CONVERT(INT,0) AS AFTER_ADJUST_PLEDGE_QTY*/          
      Into   #TBL_RMS_HOLDING_APPR          
      From   #TBL_RMS_HOLDING_APPR_TMP          
      Where  Free_qty <> 0          
      Order  By Party_code,Scrip_priority,Hold_value Desc          
          
      --STEP 7          
      /*------------------------------          
      STORE CLINET WISE DETAILS          
      --------------------------------*/          
      Select A.Party_code,          
             Bsecm_ledger=Sum(Case Co_code          
                               When 'BSECM' Then Ledger          
                               Else 0          
                              End),          
             Nsecm_ledger=Sum(Case Co_code          
                               When 'NSECM' Then Ledger          
                               Else 0          
                              End),          
             Nsefo_ledger=Sum(Case Co_code          
                               When 'NSEFO' Then Ledger          
                               Else 0          
                              End),          
             Mcd_ledger=Sum(Case Co_code          
                             When 'MCD' Then Ledger          
                             Else 0          
                            End),          
             Mcx_ledger=Sum(Case Co_code          
                             When 'MCX' Then Ledger          
                             Else 0          
                            End),          
             Nbfc_ledger=Sum(Case Co_code          
                              When 'NBFC' Then Ledger         
                              Else 0          
                             End),          
             Ncdex_ledger=Sum(Case Co_code          
                               When 'NCDEX' Then Ledger          
                               Else 0          
                              End),          
             Nsx_ledger=Sum(Case Co_code          
                             When 'NSX' Then Ledger          
                             Else 0          
                            End),
   /*************added on 17 May 2018 *****************/                            
			MTF_ledger=Sum(Case Co_code            
                             When 'MTF' Then Ledger            
                             Else 0            
                            End),     
   /**********************************/                                  
             Bsecm_imargin=Sum(Case Co_code          
                                When 'BSECM' Then Imargin          
                                Else 0          
                               End),          
             Nsecm_imargin=Sum(Case Co_code          
                                When 'NSECM' Then Imargin          
                                Else 0          
                               End),          
             Nsefo_imargin=Sum(Case Co_code          
                                When 'NSEFO' Then Imargin          
                                Else 0          
                               End),          
             Mcd_imargin=Sum(Case Co_code          
                              When 'MCD' Then Imargin          
                              Else 0          
                             End),          
             Mcx_imargin=Sum(Case Co_code          
                              When 'MCX' Then Imargin          
                              Else 0          
                             End),          
             Nbfc_imargin=Sum(Case Co_code          
                               When 'NBFC' Then Imargin          
                               Else 0          
                              End),          
             Ncdex_imargin=Sum(Case Co_code          
                                When 'NCDEX' Then Imargin          
                                Else 0          
          End),          
             Nsx_imargin=Sum(Case Co_code          
                              When 'NSX' Then Imargin          
                              Else 0          
                             End),          
             Bsecm_cash_colleteral=Sum(Case Co_code          
                                        When 'BSECM' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsecm_cash_colleteral=Sum(Case Co_code          
                                        When 'NSECM' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsefo_cash_colleteral=Sum(Case Co_code          
                                        When 'NSEFO' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Mcd_cash_colleteral=Sum(Case Co_code          
                                      When 'MCD' Then Cash_colleteral          
                                      Else 0          
                       End),          
             Mcx_cash_colleteral=Sum(Case Co_code          
                                      When 'MCX' Then Cash_colleteral          
                                      Else 0          
                                     End),          
             Nbfc_cash_colleteral=Sum(Case Co_code          
                                       When 'NBFC' Then Cash_colleteral          
                                       Else 0          
                                      End),          
             Ncdex_cash_colleteral=Sum(Case Co_code          
                                        When 'NCDEX' Then Cash_colleteral          
                                        Else 0          
                                       End),          
             Nsx_cash_colleteral=Sum(Case Co_code          
                                      When 'NSX' Then Cash_colleteral          
                                      Else 0          
                                     End),          
        Bsecm_noncash_colleteral=Sum(Case Co_code          
                                           When 'BSECM' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsecm_noncash_colleteral=Sum(Case Co_code          
                                           When 'NSECM' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsefo_noncash_colleteral=Sum(Case Co_code          
                                           When 'NSEFO' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Mcd_noncash_colleteral=Sum(Case Co_code          
                                         When 'MCD' Then Noncash_colleteral          
                                         Else 0          
                                        End),          
             Mcx_noncash_colleteral=Sum(Case Co_code          
                                         When 'MCX' Then Noncash_colleteral          
                                         Else 0          
                                        End),          
             Nbfc_noncash_colleteral=Sum(Case Co_code          
                                          When 'NBFC' Then Noncash_colleteral          
                                          Else 0          
                                         End),          
             Ncdex_noncash_colleteral=Sum(Case Co_code          
                                           When 'NCDEX' Then Noncash_colleteral          
                                           Else 0          
                                          End),          
             Nsx_noncash_colleteral=Sum(Case Co_code          
                                         When 'NSX' Then Noncash_colleteral          
                                         Else 0          
                     End),          
             Bsecm_unrecosiled_credit=Sum(Case Co_code          
                When 'BSECM' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsecm_unrecosiled_credit=Sum(Case Co_code    
                                           When 'NSECM' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsefo_unrecosiled_credit=Sum(Case Co_code          
                                           When 'NSEFO' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Mcd_unrecosiled_credit=Sum(Case Co_code          
                                         When 'MCD' Then Unrecosiled_credit          
                                         Else 0          
                                        End),          
             Mcx_unrecosiled_credit=Sum(Case Co_code          
                                         When 'MCX' Then Unrecosiled_credit          
                                         Else 0          
                                        End),          
             Nbfc_unrecosiled_credit=Sum(Case Co_code          
                When 'NBFC' Then Unrecosiled_credit          
                                          Else 0          
                                         End),          
             Ncdex_unrecosiled_credit=Sum(Case Co_code          
                                           When 'NCDEX' Then Unrecosiled_credit          
                                           Else 0          
                                          End),          
             Nsx_unrecosiled_credit=Sum(Case Co_code          
                                         When 'NSX' Then Unrecosiled_credit          
                                         Else 0          
                End),          
             Bsecm_varmargin=Convert(Money, 0.0),          
             Nsecm_varmargin=Convert(Money, 0.0),          
             Nsefo_varmargin=Convert(Money, 0.0),          
             Mcd_varmargin=Convert(Money, 0.0),          
             Mcx_varmargin=Convert(Money, 0.0),          
             Nbfc_varmargin=Convert(Money, 0.0),          
             Ncdex_varmargin=Convert(Money, 0.0),          
             Nsx_varmargin=Convert(Money, 0.0),          
             Bsecm_span_add_margin=Convert(Money, 0.0),          
             Nsecm_span_add_margin=Convert(Money, 0.0),          
             Nsefo_span_add_margin=Convert(Money, 0.0),          
             Mcd_span_add_margin=Convert(Money, 0.0),          
             Mcx_span_add_margin=Convert(Money, 0.0),          
             Nbfc_span_add_margin=Convert(Money, 0.0),          
             Ncdex_span_add_margin=Convert(Money, 0.0),          
             Nsx_span_add_margin=Convert(Money, 0.0)          
      Into   #PLEDGE_CLIENTWISELEDGER          
      From   #NET_AVAILABLE_PARTY A          
             Inner Join (Select Distinct Party_code          
                         From   #TBL_RMS_HOLDING_APPR) B          
              On A.Party_code = B.Party_code          
      Group  By A.Party_code          
          
      Update #PLEDGE_CLIENTWISELEDGER          
      Set    Bsecm_varmargin = A.Bsecm_varmargin,          
             Nsecm_varmargin = A.Nsecm_varmargin          
      From   (Select Party_code,          
                     Bsecm_varmargin=Sum(Case Co_code          
                                          When 'BSECM' Then Varmargin          
                                          Else 0          
                                         End),          
                     Nsecm_varmargin=Sum(Case Co_code          
                                          When 'NSECM' Then Varmargin          
                                          Else 0          
                                         End)   
			  /*Changes Done By Rohit And Anil 24 Oct 2017 to change the Var margin logic*/                                                
              /*From   Vw_equity_var_margin (NOLOCK)*/          
              From VW_Equity_Var_Margin_Pledge (NOLOCK)
              Group  By Party_code)A          
      Where  #pledge_clientwiseledger.Party_code = A.Party_code          
          
      Update #PLEDGE_CLIENTWISELEDGER          
      Set  Nsefo_span_add_margin = A.Nsefo_span_add_margin,          
             Mcd_span_add_margin = A.Mcd_span_add_margin,          
             Nsx_span_add_margin = A.Nsx_span_add_margin          
      From   (Select Party_code,          
                     Nsefo_span_add_margin=Sum(Case Co_code          
                                                When 'NSEFO' Then Initialmargin + Addmargin          
                                                Else 0          
                                               End),          
                     Mcd_span_add_margin=Sum(Case Co_code          
                                              When 'MCD' Then Initialmargin + Addmargin          
                                              Else 0          
                                             End),          
                     Nsx_span_add_margin=Sum(Case Co_code          
                                              When 'NSX' Then Initialmargin + Addmargin          
                                              Else 0          
                                             End)          
              From   Vw_derivativemargin (NOLOCK)          
              Group  By Party_code)A          
      Where  #pledge_clientwiseledger.Party_code = A.Party_code          
          
      Delete From Pledge_clientwiseledger          
      Where  Processdate >= Convert(Varchar, Getdate(), 106)          
             And Processdate <= Convert(Varchar, Getdate(), 106) + ' 23:59:59'          
          
      Insert Into Pledge_clientwiseledger_30Jan2019(Party_code,BSECM_LEDGER,NSECM_LEDGER,NSEFO_LEDGER,MCD_LEDGER,MCX_LEDGER,NBFC_LEDGER,NCDEX_LEDGER,NSX_LEDGER,MTF_ledger,BSECM_IMARGIN,NSECM_IMARGIN,NSEFO_IMARGIN,MCD_IMARGIN,MCX_IMARGIN,NBFC_IMARGIN,NCDEX_IMARGIN,NSX_IMARGIN,BSECM_CASH_COLLETERAL,NSECM_CASH_COLLETERAL,NSEFO_CASH_COLLETERAL,MCD_CASH_COLLETERAL,MCX_CASH_COLLETERAL,NBFC_CASH_COLLETERAL,NCDEX_CASH_COLLETERAL,NSX_CASH_COLLETERAL,BSECM_NONCASH_COLLETERAL,NSECM_NONCASH_COLLETERAL,NSEFO_NONCASH_COLLETERAL,MCD_NONCASH_COLLETERAL,MCX_NONCASH_COLLETERAL,NBFC_NONCASH_COLLETERAL,NCDEX_NONCASH_COLLETERAL,NSX_NONCASH_COLLETERAL,BSECM_UNRECOSILED_CREDIT,NSECM_UNRECOSILED_CREDIT,NSEFO_UNRECOSILED_CREDIT,MCD_UNRECOSILED_CREDIT,MCX_UNRECOSILED_CREDIT,NBFC_UNRECOSILED_CREDIT,NCDEX_UNRECOSILED_CREDIT,NSX_UNRECOSILED_CREDIT,BSECM_VARMARGIN,NSECM_VARMARGIN,NSEFO_VARMARGIN,MCD_VARMARGIN,MCX_VARMARGIN,NBFC_VARMARGIN,NCDEX_VARMARGIN,NSX_VARMARGIN,BSECM_SPAN_ADD_MARGIN,NSECM_SPAN_ADD_MARGIN,NSEFO_SPAN_ADD_MARGIN,MCD_SPAN_ADD_MARGIN,MCX_SPAN_ADD_MARGIN,NBFC_SPAN_ADD_MARGIN,NCDEX_SPAN_ADD_MARGIN,NSX_SPAN_ADD_MARGIN,ProcessDate,ProcessBy)          
      Select Party_code,BSECM_LEDGER,NSECM_LEDGER,NSEFO_LEDGER,MCD_LEDGER,MCX_LEDGER,NBFC_LEDGER,NCDEX_LEDGER,NSX_LEDGER,MTF_ledger,BSECM_IMARGIN,NSECM_IMARGIN,NSEFO_IMARGIN,MCD_IMARGIN,MCX_IMARGIN,NBFC_IMARGIN,NCDEX_IMARGIN,NSX_IMARGIN,BSECM_CASH_COLLETERAL,NSECM_CASH_COLLETERAL,NSEFO_CASH_COLLETERAL,MCD_CASH_COLLETERAL,MCX_CASH_COLLETERAL,NBFC_CASH_COLLETERAL,NCDEX_CASH_COLLETERAL,NSX_CASH_COLLETERAL,BSECM_NONCASH_COLLETERAL,NSECM_NONCASH_COLLETERAL,NSEFO_NONCASH_COLLETERAL,MCD_NONCASH_COLLETERAL,MCX_NONCASH_COLLETERAL,NBFC_NONCASH_COLLETERAL,NCDEX_NONCASH_COLLETERAL,NSX_NONCASH_COLLETERAL,BSECM_UNRECOSILED_CREDIT,NSECM_UNRECOSILED_CREDIT,NSEFO_UNRECOSILED_CREDIT,MCD_UNRECOSILED_CREDIT,MCX_UNRECOSILED_CREDIT,NBFC_UNRECOSILED_CREDIT,NCDEX_UNRECOSILED_CREDIT,NSX_UNRECOSILED_CREDIT,BSECM_VARMARGIN,NSECM_VARMARGIN,NSEFO_VARMARGIN,MCD_VARMARGIN,MCX_VARMARGIN,NBFC_VARMARGIN,NCDEX_VARMARGIN,NSX_VARMARGIN,BSECM_SPAN_ADD_MARGIN,NSECM_SPAN_ADD_MARGIN,NSEFO_SPAN_ADD_MARGIN,MCD_SPAN_ADD_MARGIN,MCX_SPAN_ADD_MARGIN,NBFC_SPAN_ADD_MARGIN,NCDEX_SPAN_ADD_MARGIN,NSX_SPAN_ADD_MARGIN,          
             Processdate=Getdate(),          
             Processby=@USERNAME          
      From   #PLEDGE_CLIENTWISELEDGER          
          
   /*---------------------------------------------------------------          
   FETCHING PLEDGE SCRIPS          
   ---------------------------------------------------------------*/          
      --DROP TABLE #TBL_PLEDGE_QTY_TMP          
   /*SELECT HLD_AC_CODE AS ACCNO,HLD_ISIN_CODE AS ISIN,          
   HLD_AC_POS,HLD_AC_POS AS AFTER_ADJUST_PLEDGE_QTY,CONVERT(BIT,0) AS BANK_APPROVED          
   INTO #TBL_PLEDGE_QTY_TMP          
   FROM DPBACKOFFICE.ACERCROSS.DBO.HOLDING WITH (NOLOCK)          
   --WHERE HLD_AC_CODE IN ('1203320000000051','1203320000000066')          
   WHERE HLD_AC_CODE IN (SELECT ACCNO FROM TBL_LAS_PLEDGE_ACC_MASTER WHERE ACTIVE_INACTIVE=1)          
   AND HLD_AC_TYPE ='14' */          
      --STEP 8          
      /*---------------------------------------------------------------          
      CREATING INDEX TO OPTIMIZE SELECTION          
      ---------------------------------------------------------------*/          
      Create Clustered Index [IX_ROW_NUM]          
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Row_num] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Nonclustered Index [IX_CL_LIST_PARTY]          
       On #TBL_CL_LIST_APPR_HOLD_TMP ( [Party_code] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Clustered Index [IX_HOLDING_APPR_ROW_NUM]          
       On #TBL_RMS_HOLDING_APPR ( [Party_code] Asc, [Row_num] Asc          
      --[SCRIP_PRIORITY] ASC          
      )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      --STEP 9 DROP TABLE #TBL_PARTY_PLEDGE_DATA          
      /*---------------------------------------------------------------          
      CREATING TABLE FOR FINAL DATA          
      ---------------------------------------------------------------*/          
      Create Table #TBL_PARTY_PLEDGE_DATA          
       (          
         Rms_date         Datetime,          
         Party_code       Varchar(20),          
         Ledger_bal       Money,          
         Client_priority  Smallint,    
         Isin             Varchar(20),          
         Scrip_cd         Varchar(50),          
         Scripname        Varchar(100),          
         Accno            Varchar(50),          
         Qty  Int,          
         Pledge_qty       Int,          
         Free_qty         Int,          
         Hold_value       Money,          
         Avg_closing      Money,          
         Pledgeable_qty   Int,          
         Pledgeable_value Money,          
         Prevdaypledgeqty Int,          
         Release_qty      Int,          
         Scrip_priority   Smallint          
       )          
          
      --STEP 10          
      /*---------------------------------------------------------------          
      LOOP SPLIT CLIENT SCRIP TO CATEGORIZE TYPE          
      WHERE TYPES ARE AS FOLLOWS          
      1) EQUIVALENT TO DEBIT ( DR = STOCK VALUE * 2 )          
      2) REMAINING ALL SCRIPT FROM ABOVE PROCESS WILL COME HERE          
      3) ALL CREDIT CLIENT WILL COM IN THIS CATEGORY          
      ---------------------------------------------------------------*/          
      Declare @CNT_TOTAL               As Int,          
              @ROW_COUNTER_CLIENT      As Int,          
              @ROW_COUNTER_ISIN        As Int,          
              @PARTY_CODE              As Varchar(20),          
              @PERV_PARTY_CODE         As Varchar(20),          
              @LEDGER_BAL              As Money,          
              @QTY                     As Int,          
              @PLEDGEABLE_QTY          As Int,          
              @PLEDGE_QTY              As Int,          
              @FREE_QTY                As Int,          
              @HOLD_VALUE              As Money,          
              @ISIN                    As Varchar(20),          
              @SCRIP_CD                As Varchar(50),          
              @SCRIPNAME               As Varchar(100),          
              @ACCNO                   As Varchar(50),          
          @LEDGER_TMP              As Money,          
              @CLOSING_RATE            As Money,          
              @CLIENT_PRIORITY         As Smallint,          
              @SCRIP_PRIORITY          As Smallint,          
              @HOLDING_ADJUSTED_VALUE  As Money,          
              @PLEDGEABLE_VALUE  As Money,          
              @COUNTINUE_LOOP          As Bit,          
              @AFTER_ADJUST_PLEDGE_QTY As Int,          
              @RMS_DATE                As Datetime,          
              @QTY_DIFF                As Int,          
              @SCRIP_CNT_TOTAL         As Int,          
              @SCRIP_CTR               As Int          
          
      Select @CNT_TOTAL = Count(1)          
      From   #TBL_CL_LIST_APPR_HOLD_TMP --WHERE CLIENT_PRIORITY <= 2          
          
      --PRINT @CNT_TOTAL          
      Set @ROW_COUNTER_CLIENT = 1--45943--24245          
          
      While @ROW_COUNTER_CLIENT <= @CNT_TOTAL --45943 --24246          
      Begin          
         Select @RMS_DATE = Rms_date,          
                @PARTY_CODE = Party_code,          
                @LEDGER_BAL = Net          
         From   #TBL_CL_LIST_APPR_HOLD_TMP          
         Where  Row_num = @ROW_COUNTER_CLIENT          
          
         Set @SCRIP_CNT_TOTAL = 0          
          
         Set @SCRIP_CTR = 1          
          
         Set @CLIENT_PRIORITY = 1          
          
         Select @SCRIP_CNT_TOTAL = Count(*)          
         From   #TBL_RMS_HOLDING_APPR          
         Where  Party_code = @PARTY_CODE          
          
         Set @HOLDING_ADJUSTED_VALUE = 0          
          
         Set @COUNTINUE_LOOP = 1          
          
         --PRINT '--------------------------'          
         --PRINT CONVERT(VARCHAR,@ROW_COUNTER_CLIENT)+'.) '+@PARTY_CODE+ ' $LEDGER BAL :- '+CONVERT(VARCHAR,@LEDGER_BAL) + ' $PLEDGE VALUE :- '+CONVERT(VARCHAR,@LEDGER_BAL*2)          
         --PRINT ' SCRIP (NO OF SCRIPS ['+CONVERT(VARCHAR,@SCRIP_CNT_TOTAL)+'])'          
         While(@SCRIP_CTR <= @SCRIP_CNT_TOTAL)          
         Begin          
            Set @PLEDGEABLE_QTY = 0          
          
            Set @PLEDGEABLE_VALUE = 0          
          
            Select @ISIN = A.Isin,          
                   @SCRIP_CD = Scrip_cd,          
                   @SCRIPNAME = Scripname,          
                   @QTY = Qty,          
                   @PLEDGE_QTY = Pledge_qty,          
                   @FREE_QTY = Free_qty,          
                   @HOLD_VALUE = Hold_value,          
             @ACCNO = A.Accno,          
                   @CLOSING_RATE = Avg_closing,          
                   @SCRIP_PRIORITY = Scrip_priority          
            From   #TBL_RMS_HOLDING_APPR A          
            Where  Party_code = @PARTY_CODE          
                   And Row_num = @SCRIP_CTR          
          
            If @HOLDING_ADJUSTED_VALUE < Abs(@LEDGER_BAL) * 2          
            Begin          
               If (@HOLDING_ADJUSTED_VALUE + @HOLD_VALUE) > Abs(@LEDGER_BAL) * 2          
               Begin          
                  --SET @QTY_DIFF = CEILING( ( ( ABS( @LEDGER_BAL ) * 2 - ( @HOLDING_ADJUSTED_VALUE) ) / @CLOSING_RATE ) )          
                  Set @QTY_DIFF = Floor(((Abs(@LEDGER_BAL) * 2 - (@HOLDING_ADJUSTED_VALUE)) / @CLOSING_RATE))          
          
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + (@QTY_DIFF * @CLOSING_RATE)          
          
                  Set @HOLD_VALUE = @QTY_DIFF * @CLOSING_RATE          
          
                  Set @FREE_QTY = @FREE_QTY - @QTY_DIFF          
          
                  Set @QTY = @QTY_DIFF          
          
                  Set @PLEDGEABLE_QTY = @QTY          
          
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
          
                  --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +          
                  --' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- ' +          
                  --CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
                  If @QTY > 0          
                  Begin          
                     Insert Into #TBL_PARTY_PLEDGE_DATA          
                     Values      (@RMS_DATE,          
                                  @PARTY_CODE,          
                                  @LEDGER_BAL,          
                                  @CLIENT_PRIORITY,          
                                  @ISIN,          
                                  @SCRIP_CD,          
                                  @SCRIPNAME,          
                                  @ACCNO,          
                                  @QTY,          
                                  @PLEDGE_QTY,          
                                  @QTY_DIFF,          
                                  @HOLD_VALUE,          
                                  @CLOSING_RATE,          
                                  @PLEDGEABLE_QTY,          
                                  @PLEDGEABLE_VALUE,          
                                  0,          
                                  0,          
                                  @SCRIP_PRIORITY)          
                  End          
          
                  Set @QTY = @FREE_QTY          
          
                  Set @HOLD_VALUE = @FREE_QTY * @CLOSING_RATE          
          
                  Set @PLEDGEABLE_QTY = @QTY          
          
                  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
          
                  Set @CLIENT_PRIORITY = 2          
               --BREAK          
               End          
               Else          
               Begin          
                  Set @PLEDGEABLE_QTY = @FREE_QTY          
          
                  Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE          
          
  Set @PLEDGEABLE_VALUE = @HOLD_VALUE          
               End          
          
               --SET @PLEDGEABLE_VALUE = @PLEDGEABLE_QTY*@CLOSING_RATE          
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY)          
               --+ ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '          
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
               If @QTY > 0          
               Begin          
                  Insert Into #TBL_PARTY_PLEDGE_DATA          
                  Values      (@RMS_DATE,          
                               @PARTY_CODE,          
                               @LEDGER_BAL,          
                               @CLIENT_PRIORITY,          
                               @ISIN,          
                               @SCRIP_CD,          
                               @SCRIPNAME,          
                               @ACCNO,          
                               @QTY,          
                               @PLEDGE_QTY,          
                               @FREE_QTY,          
                               @HOLD_VALUE,          
                               @CLOSING_RATE,          
                               @PLEDGEABLE_QTY,          
                               @PLEDGEABLE_VALUE,          
                               0,          
                               0,          
                               @SCRIP_PRIORITY)          
               End          
            End          
            Else          
            Begin          
               Set @HOLDING_ADJUSTED_VALUE = @HOLDING_ADJUSTED_VALUE + @HOLD_VALUE          
          
               Set @CLIENT_PRIORITY = 2          
          
               --PRINT ' '+CONVERT(VARCHAR,@SCRIP_CTR)+'.)' + @SCRIP_CD + ' QTY :- ' + CONVERT(VARCHAR,@QTY) +          
               -- ' PLEDGEABLE QTY :- ' + CONVERT(VARCHAR,@PLEDGEABLE_QTY) + ' CLOSING VALUE :- '          
               --+ CONVERT(VARCHAR,@CLOSING_RATE) + ' PLEDGEABLE VALUE :- ' + CONVERT(VARCHAR,@PLEDGEABLE_VALUE)          
               If @QTY > 0          
               Begin          
                  Insert Into #TBL_PARTY_PLEDGE_DATA          
                  Values      (@RMS_DATE,          
                               @PARTY_CODE,          
                               @LEDGER_BAL,          
                               @CLIENT_PRIORITY,          
                               @ISIN,          
                               @SCRIP_CD,          
                               @SCRIPNAME,          
                               @ACCNO,          
                               @QTY,          
                               @PLEDGE_QTY,          
                               @FREE_QTY,          
                               @HOLD_VALUE,          
                               @CLOSING_RATE,          
                               @PLEDGEABLE_QTY,          
                               @PLEDGEABLE_VALUE,          
                               0,          
                               0,          
                               @SCRIP_PRIORITY)          
          
               End          
            End          
          
            If ((@CLIENT_PRIORITY = 2)          
                And (@SCRIP_CTR < @SCRIP_CNT_TOTAL))          
            Begin          
               Insert Into #TBL_PARTY_PLEDGE_DATA          
               Select @RMS_DATE,          
                      @PARTY_CODE,          
                      @LEDGER_BAL,          
                      @CLIENT_PRIORITY,          
                      A.Isin,          
                      Scrip_cd,          
                      Scripname,          
                      A.Accno,          
                      Qty,          
                      Pledge_qty,          
                      Free_qty,          
                      Hold_value,          
                      Avg_closing,          
                      Free_qty                               As Pledgeable_qty,          
                      Convert(Money, Free_qty * Avg_closing) As Pledgeable_value,          
                      0                                      As Prevdaypledgeqty,          
                      0                                      As Release_qty,          
                      Scrip_priority          
               From   #TBL_RMS_HOLDING_APPR A          
               Where  Party_code = @PARTY_CODE          
                      And Row_num > @SCRIP_CTR          
          
               Break          
            End          
          
            Set @SCRIP_CTR = @SCRIP_CTR + 1          
         End          
          
         --PRINT ' ADJUSTED VALUE :- '+CONVERT(VARCHAR,@HOLDING_ADJUSTED_VALUE)          
         Set @ROW_COUNTER_CLIENT = @ROW_COUNTER_CLIENT + 1          
      End          
          
      --drop table #prevDayReleaseQty          
      Select A.Isin,          
             A.Party_code,          
             A.Scrip_cd,          
             A.Scripname,          
             A.Accno,          
             Releaseqty =Isnull(A.Qty, 0) - Isnull(B.Pledge_qty, 0),          
           Prevdaypledge=Isnull(A.Qty, 0),          
             A.Client_priority,          
             Ledger_bal=Convert(Money, 0.0),          
             Avg_closing=Convert(Money, 0.0)          
      Into   #prevDayReleaseQty          
      From   (Select *          
              From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY          
              Where  Scrip_priority = 0) A          
             Left Join (Select Party_code,          
                               Isin,          
                               Scrip_cd,          
                               Accno,          
                               Pledge_qty=Sum(Pledgeable_qty),          
                               Client_priority          
                        From   #TBL_PARTY_PLEDGE_DATA          
                        Where  Client_priority = 1 --Scrip_priority > 0 and          
                        Group  By Party_code,Isin,Scrip_cd,Accno,Client_priority) B          
              On A.Isin = B.Isin          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Accno = B.Accno          
                 And A.Party_code = B.Party_code          
      Where  Isnull(A.Qty, 0) > Isnull(B.Pledge_qty, 0)          
          
      Update #prevDayReleaseQty          
      Set    #prevdayreleaseqty.Ledger_bal = A.Net          
      From   #TBL_CL_LIST_APPR_HOLD A          
      Where  A.Party_code = #prevdayreleaseqty.Party_code          
            
      /* Comment on 09 May 2012      
      PRMS Request ID 10141041       
      */      
      /*Update #prevDayReleaseQty          
      Set    Avg_closing = Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000051')) A          
      Where  #prevdayreleaseqty.Isin = A.Isin          
             And #prevdayreleaseqty.Accno In ('13326100', '15464303', '11198145', '11197647',          
                                              '1203320000000051', '1203320004025849', '1203320004574264')          
          
      Update #prevDayReleaseQty          
      Set    Avg_closing = Clsrate          
      From   (Select Isin,          
                     Clsrate          
              From   Vw_equity_cls_rate With(NOLOCK)          
              Where  Accno In ('1203320000000066')) A          
      Where  #prevdayreleaseqty.Isin = A.Isin          
             And #prevdayreleaseqty.Accno In ('1203320000000066', '16921197', '14216209')*/      
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate      
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)) A          
       Where  #prevDayReleaseQty.Isin = A.Isin          
              and #prevDayReleaseQty.Accno = A.Accno      
              
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate          
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000066')) A          
       Where  Avg_closing=0          
              and #prevDayReleaseQty.Accno = '1203320000000051'       
              and #prevDayReleaseQty.Isin = A.Isin       
                    
       Update #prevDayReleaseQty           
       Set    Avg_closing = Clsrate        
       From   (Select Isin,          
                     Clsrate,Accno          
              From   Vw_equity_cls_rate With(NOLOCK)      
              Where  Accno In ('1203320000000051')) A          
       Where  Avg_closing=0          
              and #prevDayReleaseQty.Accno = '1203320000000066'       
              and #prevDayReleaseQty.Isin = A.Isin                  
          
      Update A          
      Set    A.Prevdaypledgeqty = B.Prevdaypledge,          
             A.Release_qty = B.Releaseqty          
      From   #TBL_PARTY_PLEDGE_DATA A          
             Inner Join (Select *          
                         From   #prevDayReleaseQty A          
                         Where  Exists (Select *          
                                        From   #TBL_PARTY_PLEDGE_DATA B          
                                        Where  A.Isin = B.Isin          
                                               And A.Accno = B.Accno          
                                               And A.Scrip_cd = B.Scrip_cd          
                                               And A.Party_code = B.Party_code          
                                               And A.Client_priority = B.Client_priority)) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Party_code = B.Party_code          
                 And A.Client_priority = B.Client_priority          
          
      Update A          
      Set    A.Prevdaypledgeqty = B.Qty--b.PrevDayPledge          
      From   #TBL_PARTY_PLEDGE_DATA A          
             Inner Join (Select *          
                         From   #TBL_RMS_HOLDING_APPR_TMP_PRVEDAY A          
                        --Where exists (Select * from #TBL_PARTY_PLEDGE_DATA b          
                        --where a.isin=b.isin and a.accno=b.accno and a.scrip_cd=b.scrip_cd and a.party_code=b.party_code          
                        --and a.client_priority=b.client_priority)          
                        ) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Party_code = B.Party_code          
                 And A.Client_priority = B.Client_priority          
                 And A.Scrip_priority = B.Scrip_priority          
          
      --Declare @Rms_date As Datetime          
      Select @Rms_date = Max(Rms_date)          
      From   #TBL_PARTY_PLEDGE_DATA          
          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select Rms_date=@Rms_date,          
             Party_code,          
             Ledger_bal,          
             Client_priority=3,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty=0,          
             Pledge_qty=0,          
             Free_qty=0,          
             Hold_value=0,          
             Avg_closing,          
             Pledgeable_qty=0,          
             Pledgeable_value=0,          
             Prevdaypledgeqty=Prevdaypledge,          
             Release_qty=Releaseqty,          
             Scrip_priority=1          
      From   #prevDayReleaseQty A          
      Where  Not Exists (Select *          
                         From   #TBL_PARTY_PLEDGE_DATA B          
                         Where  A.Isin = B.Isin          
                                And A.Accno = B.Accno          
                                And A.Scrip_cd = B.Scrip_cd          
                                And A.Party_code = B.Party_code          
                                And A.Client_priority = B.Client_priority)          
          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select Rms_date=@Rms_date,          
             Party_code,          
             Ledger_bal,          
             Client_priority=4,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty,          
             Pledge_qty=0,          
             Free_qty,          
             Hold_value,          
             Avg_closing,          
             Pledgeable_qty= Free_qty,          
             Pledgeable_value=0,          
             Prevday_pledege_qty=Release_qty,          
             Release_qty,          
             Scrip_priority          
      From   Tbl_party_pledge_data (nolock)          
      Where  Party_code = 'Unknown'          
             And Client_priority = 1          
             And Processdate >= @LastProc_Date          
             And Processdate <= @LastProc_Date + ' 23:59:59'          
          
      ---*****Save Creditor Client For Adjustment of Pledge excces Adjustment          
      Insert Into #TBL_PARTY_PLEDGE_DATA          
      Select B.Rms_date,          
             B.Party_code,          
             Ledger_bal=B.Net,          
             Client_priority=4,          
             A.Isin,          
             A.Scrip_cd,          
             A.Scripname,          
             A.Accno,          
             A.Qty,         
             Pledge_qty=0,          
             A.Free_qty,          
             A.Hold_value,          
             A.Avg_closing,          
             Pledgeable_qty=A.Free_qty,          
             Pledgeable_value=Convert(Money, A.Free_qty * A.Avg_closing),          
             Prevdaypledgeqty=0,          
             Release_qty=0,          
             A.Scrip_priority          
      From   (Select *          
              From   #TBL_RMS_HOLDING_APPR) A          
             Inner Join (Select *          
                         From   #TBL_CL_LIST_APPR_HOLD          
                         Where  Net >= 0) B          
              On B.Party_code = A.Party_code          
          
      Begin Tran          
          
      --Insert Into Tbl_party_pledge_data_log          
      --Select *          
      --From   Tbl_party_pledge_data (nolock)          
    
      /*Delete from Tbl_party_pledge_data          
      Where Processdate >= Convert(varchar,Getdate(),106)          
      And Processdate <= Convert(varchar,Getdate(),106) + ' 23:59:59'*/          
          
      --Truncate Table Tbl_party_pledge_data          
          
      Insert Into Tbl_party_pledge_data_30Jan2019          
      Select *,          
             Processdate=Getdate(),          
             @USERNAME          
      From   #TBL_PARTY_PLEDGE_DATA          
          
      Commit          
   End          
          
   Set nocount Off          
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_reallocation_cli
-- --------------------------------------------------
/*              
    CHANGE ID  :: 1              
    MODIFIED BY  :: PRASHANT              
    MODIFIED DATE :: AUG 03 2013              
    REASON   :: RELEASE PLEDGE SHARES OF WCL CLIENT WHILE REALLOCATING PREVIOUS DAY SHARES              
    REQUEST FROM :: RAHUL SIR              
    PRMS ID   :: NONE              
                  
    CHANGE ID  :: 2              
    MODIFIED BY  :: PRASHANT              
    MODIFIED DATE :: AUG 03 2013              
    REASON   :: CALL WCL PROCESS BEFORE PLEDGE PROCESS              
    REQUEST FROM :: RAHUL SIR              
    PRMS ID   :: NONE              
      
    CHANGE ID  :: 3  
    MODIFIED BY  :: PRASHANT              
    MODIFIED DATE :: SEP 16 2013              
    REASON   :: EXCLUDE IN-ACTIVE BANK'S IN REALLOCATION PROCESS  
    REQUEST FROM :: RAHUL SIR  
    PRMS ID   :: NONE              
*/              
CREATE Procedure [dbo].[Usp_las_pledge_reallocation_cli]              
As              
Begin              
   --Drop Table #LAS_PLEDGE_REQUEST                          
   -----****Satart Allocation Pledgeable Qty              
   Set nocount On              
                 
   If Not Exists (Select Hdate              
                  From   [196.1.115.239].harmony.DBO.Holimst A(nolock)              
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))              
   Begin              

		truncate table PledgeProcessWCLLog
	 insert into dbo.PledgeProcessWCLLog(Starttime) values(GETDATE())
	
      /*CHANGE ID  :: 2*/              
      exec MIS.DBO.Upd_WCL       
      
      update dbo.PledgeProcessWCLLog set Endtime=GETDATE()
                 
      Declare @LastProc_Date As Datetime                        
                        
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)                        
      From   Tbl_party_pledge_data (nolock)                        
                        
      Select Row_num=Identity(Int, 1, 1),                        
             Isin,                        
             Pledgor_bo_id=Clientid,                        
             Pledg_qty=Cast(Sum(Pledgeqty - Unpledgeqty) As Int),                        
             Pledg_value=Cast (Sum(0)As Money)                        
      Into   #LAS_PLEDGE_REQUEST                        
      From   mis.demat.dbo.Pledge2releaseentry A(NOLOCK)  
      Where  Clientid In('1203320000000066', '1203320000000051','1203320009603460','1203320000000028')  
             /*CHANGE ID  :: 3*/  
             AND EXISTS(SELECT *   
                        FROM GENERAL.dbo.Tbl_las_bank_master B With(NOLOCK)  
                        Where  Active_inactive = 1 AND A.BANKID = B.BO_ID)  
      Group  By Isin,Clientid  
                        
      --Drop Table #Tbl_party_pledge_data                          
                        
      Select *                        
      Into   #Tbl_party_pledge_data                        
      From   Tbl_party_pledge_data (nolock)                        
      Where  Processdate >= @LastProc_Date                        
             And Processdate <= @LastProc_Date + ' 23:59:59'                        
             And Client_priority = 1                        
             And Qty > 0                        
             --And Avg_closing > 0 --Comment on 25 Apr 2012                     
             And Accno In('1203320000000066', '1203320000000051','1203320009603460','1203320000000028')                        
                        
      Create Clustered Index [IX_LAS_PLEDGE_ROW_NUM]                        
       On #LAS_PLEDGE_REQUEST ( [Isin] Asc, [Row_num] Asc )                        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                        
                        
      Create Clustered Index [IX_PARTY_PLEDGE_PARTYCODE_ISIN]                        
       On #TBL_PARTY_PLEDGE_DATA ( [Isin] Asc, [Party_code] Asc )                        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                        
                        
      Declare @ISIN         Varchar(20),                        
     @PLEDGOR_BOID Varchar(20),                        
              @PLEDG_QTY    Int,                        
              @PLEDG_VALUE  Money,                        
              @COUNTER      Int                        
                        
      ----VARIABLE CLIENT LEVEL                          
      Declare @ISIN_CLI           Varchar(20),                        
              @PLEDGOR_BOID_CLI   Varchar(20),                        
              @PLEDG_QTY_CLI      Int,                        
              @DIFFPLEDG_QTY_CLI  Int,                 
              @PLEDG_VALUE_CLI    Money,                        
              @COUNTER_CLI        Int,                        
              @PARTY_CODE         Varchar(20),                        
              @SCRIP_PRIORITY_CLI Int                        
                        
      Select @COUNTER = Max(Row_num)                        
      From   #LAS_PLEDGE_REQUEST                        
                        
      While @COUNTER > 0                        
      Begin                        
         Select @ISIN = Isin,                        
                @PLEDGOR_BOID = Pledgor_bo_id,                        
                @PLEDG_QTY = Pledg_qty,                        
                @PLEDG_VALUE = Pledg_value                        
         From   #LAS_PLEDGE_REQUEST                        
         Where  Row_num = @COUNTER                        
                        
         --Print 'TOATL: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                          
                        
         Select Row_num=Identity(Int, 1, 1),                        
                Isin,                        
                Accno,                        
                Scrip_cd,                        
                Party_code,                        
                Qty,                        
                Actual_pledgeqty=0,                        
                Scrip_priority                        
         Into   #PARTY_PLEDGE                        
         From   #Tbl_party_pledge_data                        
         Where  Isin = @ISIN                        
                And Accno = @PLEDGOR_BOID                        
         Order  By Scrip_priority Desc,Ledger_bal--Hold_value--LEDGER_BAL                          
                        
         Select @COUNTER_CLI = Max(Row_num)                        
         From   #PARTY_PLEDGE                        
                        
         While @COUNTER_CLI > 0                        
         Begin                        
            --Print 'TOATL DIFF: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                          
                        
            Select @PLEDGOR_BOID_CLI = Accno,                        
               @PARTY_CODE = Party_code,                        
                   @PLEDG_QTY_CLI = Qty,                        
                   @SCRIP_PRIORITY_Cli = Scrip_priority,                        
                   @ISIN_Cli = Isin                        
            From   #PARTY_PLEDGE                        
            Where  Row_num = @COUNTER_CLI                        
                        
            --Print 'CLIENT TOATL: ' + @PARTY_CODE + ' ' + Cast(@PLEDG_QTY_CLI As Varchar)                          
                        
            If @PLEDG_QTY > 0                        
            Begin                        
              If @PLEDG_QTY_CLI < @PLEDG_QTY                        
               Begin                        
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                        
                        
                  --Print 'REMAINING :' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                          
                        
                  Update #PARTY_PLEDGE                        
                  Set    Actual_pledgeqty = @PLEDG_QTY_CLI                        
                  Where  Party_code = @PARTY_CODE    
                         And Accno = @PLEDGOR_BOID_CLI                        
                         And Row_num = @COUNTER_CLI                        
                         And Isin = @Isin                        
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                        
                        
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                        
               End                        
               Else If @PLEDG_QTY_CLI >= @PLEDG_QTY                        
               Begin                        
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                        
                        
            --Print 'REMAINING B:' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                          
                        
                  Update #PARTY_PLEDGE                        
                  Set    Actual_pledgeqty = @PLEDG_QTY                        
                  Where  Party_code = @PARTY_CODE                        
                         And Accno = @PLEDGOR_BOID_CLI                        
                         And Row_num = @COUNTER_CLI                        
                         And Isin = @ISIN_Cli                        
                         And Scrip_priority = @SCRIP_PRIORITY_Cli          
                        
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                        
               --BREAK                          
               End                        
            End                        
                        
            Set @COUNTER_CLI=@COUNTER_CLI - 1                        
         End                        
          
         Update A                        
         Set    A.Pledge_qty = B.Actual_pledgeqty                        
         From   #Tbl_party_pledge_data A                        
                Inner Join #PARTY_PLEDGE B                        
                 On A.Party_code = B.Party_code                        
                    And A.Isin = B.Isin                        
        And A.Scrip_cd = B.Scrip_cd                        
                    And A.Accno = B.Accno                        
                    And A.Scrip_priority = B.Scrip_priority                        
         Where  Processdate >= @LastProc_Date                        
                And Processdate <= @LastProc_Date + ' 23:59:59'                        
                And A.Client_priority = 1                        
                        
         Drop Table #PARTY_PLEDGE                        
                        
         Set @COUNTER=@COUNTER - 1                        
                        
      End                        
                        
      --Print '********End While Reallocation Pleqdgeable Qty**********'                          
                        
      Update A                        
      Set    A.Pledge_qty = B.Pledge_qty                        
      From   Tbl_party_pledge_data A                        
             Inner Join #Tbl_party_pledge_data B                        
              On A.Party_code = B.Party_code                        
                 And A.Isin = B.Isin                        
                 And A.Accno = B.Accno                        
                 And A.Scrip_cd = B.Scrip_cd                        
                 And A.Qty = B.Qty                        
                 And A.Scrip_priority = B.Scrip_priority                        
                 And A.Client_priority = B.Client_priority                        
      Where  A.Processdate >= @LastProc_Date                        
             And A.Processdate <= @LastProc_Date + ' 23:59:59'                        
             And A.Client_priority = 1                        
                        
      -----****End Allocation Pledgeable Qty                          
                        
      ---------------****Adjust Extra Pledge Qty Against Creditor and Not Pledgeable clienct stock                          
      --drop table #Adjustmentisinqty                          
      Select Isin=Isnull(A.Isin, B.Isin),                        
             Accno=Isnull(A.Accno, B.Accno),                        
             Diffqty=Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0),                        
             Avg_closing=Convert(Money, 0),                        
             Scrip_cd=Space(50),                        
             Scripname=Space(50)                        
      Into   #AdjustmentISINQty                        
      From   (Select Isin,                        
                     Accno,                        
                     Pledge_qty=Sum(Pledge_qty)                        
              From   Tbl_party_pledge_data                        
              Where  Processdate >= @LastProc_Date                        
                     And Processdate <= @LastProc_Date + ' 23:59:59'                        
                     And Accno In ('1203320000000066', '1203320000000051','1203320009603460','1203320000000028')                        
                     And Pledge_qty <> 0                        
              Group  By Isin,Accno)A                        
             Full Outer Join(Select Isin,                        
    Accno=Pledgor_bo_id,                        
                                    Actualpledge_qty=Sum(Pledg_qty)                        
                             From   #LAS_PLEDGE_REQUEST                        
                             Where  Pledgor_bo_id In ('1203320000000066', '1203320000000051','1203320009603460','1203320000000028')                        
                             Group  By Isin,Pledgor_bo_id) B                        
              On A.Isin = B.Isin                
                 And A.Accno = B.Accno                        
      Where  Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0) > 0                        
                        
      Select Row_num=Identity(Int, 1, 1),                        
             Isin,                        
             Pledgor_bo_id=Accno,                        
             Pledg_qty=Cast(Sum(Diffqty) As Int),                        
             Pledg_value=Cast (Sum(0)As Money)                        
Into   #LAS_PLEDGE_REQUEST_EXCESS                        
      From   #Adjustmentisinqty A(NOLOCK)                        
      Where  Accno In('1203320000000066', '1203320000000051','1203320009603460','1203320000000028')                        
      Group  By Isin,Accno                        
                    
      /*CHANGE ID  :: 1*/              
      Select Party_Code              
        INTO #WCL_CLIENTS              
      from MIS.DBO.WCL_ActionRpt1(convert(datetime,GETDATE(),103))              
      where BOI+YES+SCB+ADH+AXS+HDF+KOT+IDF<> 0.00               
      --+ICI 
      
                        
      Select a.*          
      Into   #Tbl_party_pledge_data_CR                        
      From   Tbl_party_pledge_data A(NOLOCK)               
                LEFT OUTER JOIN #WCL_CLIENTS B (NOLOCK)               
                    ON A.PARTY_CODE = B.PARTY_CODE              
      Where  Processdate >= @LastProc_Date                        
             And Processdate <= @LastProc_Date + ' 23:59:59'                        
             And Pledge_qty <> Qty                        
             --And Avg_closing > 0 --Comment on 25 Apr 2012                         
             And Pledge_qty = 0               
             And Accno In('1203320000000066', '1203320000000051','1203320009603460','1203320000000028')              
             /*CHANGE ID  :: 1*/              
             /*              
                This should be party_codes which were excluded in previous day process.              
                Store WCL LAS clients details in a table and use that table here              
             */              
             AND B.PARTY_CODE IS NULL              
             And Isin In (Select Isin                        
                          From   #LAS_PLEDGE_REQUEST_EXCESS)                        
                        
      Create Clustered Index [IX_LAS_PLEDGE_ROW_NUM]                        
       On #LAS_PLEDGE_REQUEST_EXCESS ( [Isin] Asc, [Row_num] Asc )                        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                        
                        
      Create Clustered Index [IX_PARTY_PLEDGE_PARTYCODE_ISIN]                        
       On #Tbl_party_pledge_data_CR ( [Isin] Asc, [Party_code] Asc )                        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                        
                        
      /*Declare @ISIN Varchar(20),                          
      @PLEDGOR_BOID Varchar(20),                          
      @PLEDG_QTY Int,                          
      @PLEDG_VALUE Money,                          
      @COUNTER Int                          
                                
      ----VARIABLE CLIENT LEVEL                
      Declare @ISIN_CLI Varchar(20),                          
      @PLEDGOR_BOID_CLI Varchar(20),                          
      @PLEDG_QTY_CLI Int,                          
      @DIFFPLEDG_QTY_CLI Int,                          
    @PLEDG_VALUE_CLI Money,                          
      @COUNTER_CLI Int,                          
      @PARTY_CODE Varchar(20),                          
      @SCRIP_PRIORITY_CLI Int*/                        
                        
      Set @ISIN=''                        
                        
      Set @PLEDGOR_BOID=''                   
                        
      Set @PLEDG_QTY=0                        
                        
      Set @PLEDG_VALUE =0                        
                        
      Set @COUNTER=0                        
                        
      Set @ISIN_CLI=''                        
                        
      Set @PLEDGOR_BOID_CLI=''                        
                        
      Set @PLEDG_QTY_CLI=0                        
                        
      Set @PLEDG_VALUE_CLI =0                    
                        
      Set @DIFFPLEDG_QTY_CLI=0                        
                        
      Set @PLEDG_VALUE_CLI=0                        
                        
      Set @PARTY_CODE=''                        
                        
      Set @SCRIP_PRIORITY_CLI=0                        
                        
      Set @COUNTER_CLI=0                        
                        
      Select @COUNTER = Max(Row_num)                        
      From   #LAS_PLEDGE_REQUEST_EXCESS                        
                        
      While @COUNTER > 0                        
      Begin                        
         Select @ISIN = Isin,                        
                @PLEDGOR_BOID = Pledgor_bo_id,                        
                @PLEDG_QTY = Pledg_qty,                        
                @PLEDG_VALUE = Pledg_value                        
        From   #LAS_PLEDGE_REQUEST_EXCESS                        
         Where  Row_num = @COUNTER                        
                        
         --Print 'TOATL: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                          
                        
         Select Row_num=Identity(Int, 1, 1),                        
                Isin,                        
                Accno,                        
                Scrip_cd,                        
                Party_code,                        
                Qty,                        
                Actual_pledgeqty=0,                        
                Scrip_priority,                        
                Client_priority                        
         Into   #PARTY_PLEDGE_CR                      
         From   #Tbl_party_pledge_data_CR                        
         Where  Isin = @ISIN                        
                And Accno = @PLEDGOR_BOID                        
         Order  By Client_priority Desc,Ledger_bal--Hold_value--LEDGER_BAL                                                  
         Select @COUNTER_CLI = Max(Row_num)                        
         From   #PARTY_PLEDGE_CR                        
                        
         While @COUNTER_CLI > 0                        
         Begin                        
            --Print 'TOATL DIFF: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                          
                        
            Select @PLEDGOR_BOID_CLI = Accno,                        
                   @PARTY_CODE = Party_code,                        
                   @PLEDG_QTY_CLI = Qty,                        
                   @SCRIP_PRIORITY_Cli = Scrip_priority,                        
                   @Isin_CLI = Isin                        
            From   #PARTY_PLEDGE_CR                        
            Where  Row_num = @COUNTER_CLI                        
                        
            --Print 'CLIENT TOATL: ' + @PARTY_CODE + ' ' + Cast(@PLEDG_QTY_CLI As Varchar)                          
                        
            If @PLEDG_QTY > 0                        
            Begin                        
              If @PLEDG_QTY_CLI < @PLEDG_QTY                        
               Begin                        
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                        
                        
                  --Print 'REMAINING :' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                          
                        
                  Update #PARTY_PLEDGE_CR                        
                  Set    Actual_pledgeqty = @PLEDG_QTY_CLI                        
                  Where  Party_code = @PARTY_CODE                        
                         And Accno = @PLEDGOR_BOID_CLI                        
                         And Row_num = @COUNTER_CLI                        
           And Isin = @Isin_CLI                        
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                        
                        
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                        
               End                        
               Else If @PLEDG_QTY_CLI >= @PLEDG_QTY                        
               Begin                        
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                        
                        
                  --Print 'REMAINING B:' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                          
                        
                  Update #PARTY_PLEDGE_CR                        
                  Set    Actual_pledgeqty = @PLEDG_QTY                        
                  Where  Party_code = @PARTY_CODE                        
                         And Accno = @PLEDGOR_BOID_CLI                        
                         And Row_num = @COUNTER_CLI                        
                         And Isin = @Isin                        
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                        
                        
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                        
                        
               --BREAK                          
               End                        
            End                        
                        
            Set @COUNTER_CLI=@COUNTER_CLI - 1                        
         End                        
                        
         Update A                        
         Set    A.Pledge_qty = B.Actual_pledgeqty                        
         From #Tbl_party_pledge_data_CR A                        
                Inner Join #PARTY_PLEDGE_CR B                        
                 On A.Party_code = B.Party_code                        
                    And A.Isin = B.Isin                        
                    And A.Scrip_cd = B.Scrip_cd                        
                    And A.Accno = B.Accno                        
                    And A.Scrip_priority = B.Scrip_priority                       
                    And A.Client_priority = B.Client_priority                        
         Where  Processdate >= @LastProc_Date                        
                And Processdate <= @LastProc_Date + ' 23:59:59'                        
                And A.Pledge_qty <> A.Qty                        
                        
         Drop Table #PARTY_PLEDGE_CR                        
                        
         Set @COUNTER=@COUNTER - 1              
                        
      End                        
                        
      --Print '********End While Reallocation Excess Pleqdge Qty**********'                          
                        
      Update A                        
      Set    A.Pledge_qty = B.Pledge_qty                        
      --A.Scrip_priority = 0                          
      From   Tbl_party_pledge_data A                        
             Inner Join #Tbl_party_pledge_data_CR B                        
              On A.Party_code = B.Party_code                        
                 And A.Isin = B.Isin                        
                 And A.Accno = B.Accno                        
                 And A.Scrip_cd = B.Scrip_cd                        
 And A.Qty = B.Qty                        
                 And A.Scrip_priority = B.Scrip_priority                        
                 And A.Client_priority = B.Client_priority                        
      Where  A.Processdate >= @LastProc_Date                        
    And A.Processdate <= @LastProc_Date + ' 23:59:59'                        
             And A.Pledge_qty <> A.Qty                        
             And A.Pledge_qty = 0                        
             And B.Pledge_qty <> 0                        
             And A.Isin In (Select Isin                        
                            From   #LAS_PLEDGE_REQUEST_EXCESS)                        
                        
      --drop table #AdjustmentISINQty_Cr                          
      Select Isin=Isnull(A.Isin, B.Isin),                        
             Accno=Isnull(A.Accno, B.Accno),                      
             Diffqty=Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0),                        
             Avg_closing=Convert(Money, 0),                        
             Scrip_cd=Space(50),                        
             Scripname=Space(50)                        
      Into   #AdjustmentISINQty_Cr                        
      From   (Select Isin,                        
                     Accno,                        
                     Pledge_qty=Sum(Pledge_qty)                        
              From   Tbl_party_pledge_data (nolock)                        
              Where  Processdate >= @LastProc_Date                        
                     And Processdate <= @LastProc_Date + ' 23:59:59'                        
                     And Accno In ('1203320000000066', '1203320000000051','1203320009603460','1203320000000028')                        
              Group  By Isin,Accno)A                        
             Full Outer Join(Select Isin,                        
                                    Accno=Pledgor_bo_id,                        
                                    Actualpledge_qty=Sum(Pledg_qty)                        
                             From   #LAS_PLEDGE_REQUEST                        
                             Where  Pledgor_bo_id In ('1203320000000066', '1203320000000051','1203320009603460','1203320000000028')                        
                             Group  By Isin,Pledgor_bo_id) B                        
              On A.Isin = B.Isin                        
                 And A.Accno = B.Accno                        
      Where  Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0) <> 0                        
                        
      Update #AdjustmentISINQty_Cr                        
      Set    Avg_closing = A.Clsrate,                        
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                        
            #adjustmentisinqty_cr.Scripname = A.Scripname                        
      From   (Select *                        
              From   Vw_equity_cls_rate (nolock)) A                        
      Where  #adjustmentisinqty_cr.Isin = A.Isin                        
             And #adjustmentisinqty_cr.Accno = A.Accno                    
                        
      Update #AdjustmentISINQty_Cr                        
      Set    Avg_closing = A.Clsrate,                        
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                        
             #adjustmentisinqty_cr.Scripname = A.Scripname                        
      From   (Select *                        
              From   Vw_equity_cls_rate (nolock)                  
              Where Accno in('1203320000000066')) A                        
      Where  #adjustmentisinqty_cr.Isin = A.Isin                   
             And #adjustmentisinqty_cr.Accno = '1203320000000051'                   
                        
       Update #AdjustmentISINQty_Cr                        
      Set    Avg_closing = A.Clsrate,                        
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                        
             #adjustmentisinqty_cr.Scripname = A.Scripname                        
      From   (Select *                        
              From   Vw_equity_cls_rate (nolock)                  
              Where Accno in('1203320000000051')) A                        
      Where  #adjustmentisinqty_cr.Isin = A.Isin                        
             And #adjustmentisinqty_cr.Accno = '1203320000000066'                   
                        
      Declare @Rms_Date Datetime                        
                        
      Select @Rms_Date = Max(Rms_date)                        
      From   Tbl_party_pledge_data                        
                        
      Insert Into Tbl_party_pledge_data                        
      Select Rms_date=@Rms_Date,                        
             Party_code='Unknown',                        
             Ledger_bal=0,                        
             Client_priority=1,                        
             Isin,                        
             Scrip_cd,                        
             Scripname,                        
             Accno,                        
             Qty=0,            
             Pledge_qty=0,                        
           Free_qty=0,                        
             Hold_value=0,                        
             Avg_closing,                        
             Pledgeable_qty=0,                        
             Pledgeable_value=0,                        
             Prevdaypledgeqty=0,                        
             Release_qty=Diffqty,                        
             Scrip_priority=0,                        
             @LastProc_Date,                        
             'System'                        
      From   #AdjustmentISINQty_Cr                        
                        
   ---Checking Ploting release Qty And Pldge Qty                          
   /*Select a.*,b.*                          
   from                          
   (Select accno,isin,AQty=Sum(PLEDGE_QTY)+Sum(Release_qty) from                          
   ----#Tbl_party_pledge_data                          
   Tbl_party_pledge_data                          
   where Processdate >= Convert(Varchar, Getdate()-1, 106)                          
   And Processdate <= Convert(Varchar, Getdate()-1, 106) + ' 23:59:59'                          
   and accno in ('1203320000000066','1203320000000051')                          
   --and isin='INE209L01016'                          
   --order by party_code                          
   group by accno,isin) a                          
   inner join                          
   (Select Clientid,isin,BQty=Sum(pledgeQty)-Sum(unpledgeQty) from mis.demat.dbo.Pledge2ReleaseEntry a(NOLOCK)                          
   where Clientid in ('1203320000000066','1203320000000051')                          
   --and isin='INE209L01016'                          
   group by Clientid,isin) b                          
   on b.Clientid=a.accno                          
   and b.isin=a.isin                          
   where AQty<>BQty                          
   */                        
   End                        
                        
   Set nocount Off                        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_reallocation_cli_03082013
-- --------------------------------------------------
CREATE Procedure Usp_las_pledge_reallocation_cli_03082013
As          
Begin          
   --Drop Table #LAS_PLEDGE_REQUEST            
   -----****Satart Allocation Pledgeable Qty            
   Set nocount On          
          
   If Not Exists (Select Hdate          
                  From   [196.1.115.239].harmony.DBO.Holimst A(nolock)          
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))          
   Begin          
      Declare @LastProc_Date As Datetime          
          
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)          
      From   Tbl_party_pledge_data (nolock)          
          
      Select Row_num=Identity(Int, 1, 1),          
             Isin,          
             Pledgor_bo_id=Clientid,          
             Pledg_qty=Cast(Sum(Pledgeqty - Unpledgeqty) As Int),          
             Pledg_value=Cast (Sum(0)As Money)          
      Into   #LAS_PLEDGE_REQUEST          
      From   mis.demat.dbo.Pledge2releaseentry A(NOLOCK)          
      Where  Clientid In('1203320000000066', '1203320000000051')          
      Group  By Isin,Clientid          
          
      --Drop Table #Tbl_party_pledge_data            
          
      Select *          
      Into   #Tbl_party_pledge_data          
      From   Tbl_party_pledge_data (nolock)          
      Where  Processdate >= @LastProc_Date          
             And Processdate <= @LastProc_Date + ' 23:59:59'          
             And Client_priority = 1          
             And Qty > 0          
             --And Avg_closing > 0 --Comment on 25 Apr 2012       
             And Accno In('1203320000000066', '1203320000000051')          
          
      Create Clustered Index [IX_LAS_PLEDGE_ROW_NUM]          
       On #LAS_PLEDGE_REQUEST ( [Isin] Asc, [Row_num] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Clustered Index [IX_PARTY_PLEDGE_PARTYCODE_ISIN]          
       On #TBL_PARTY_PLEDGE_DATA ( [Isin] Asc, [Party_code] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Declare @ISIN         Varchar(20),          
              @PLEDGOR_BOID Varchar(20),          
              @PLEDG_QTY    Int,          
              @PLEDG_VALUE  Money,          
              @COUNTER      Int          
          
      ----VARIABLE CLIENT LEVEL            
      Declare @ISIN_CLI           Varchar(20),          
              @PLEDGOR_BOID_CLI   Varchar(20),          
              @PLEDG_QTY_CLI      Int,          
              @DIFFPLEDG_QTY_CLI  Int,          
              @PLEDG_VALUE_CLI    Money,          
              @COUNTER_CLI        Int,          
              @PARTY_CODE         Varchar(20),          
              @SCRIP_PRIORITY_CLI Int          
          
      Select @COUNTER = Max(Row_num)          
      From   #LAS_PLEDGE_REQUEST          
          
      While @COUNTER > 0          
      Begin          
         Select @ISIN = Isin,          
                @PLEDGOR_BOID = Pledgor_bo_id,          
                @PLEDG_QTY = Pledg_qty,          
                @PLEDG_VALUE = Pledg_value          
         From   #LAS_PLEDGE_REQUEST          
         Where  Row_num = @COUNTER          
          
         --Print 'TOATL: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)            
          
         Select Row_num=Identity(Int, 1, 1),          
                Isin,          
                Accno,          
                Scrip_cd,          
                Party_code,          
                Qty,          
                Actual_pledgeqty=0,          
                Scrip_priority          
         Into   #PARTY_PLEDGE          
         From   #Tbl_party_pledge_data          
         Where  Isin = @ISIN          
                And Accno = @PLEDGOR_BOID          
         Order  By Scrip_priority Desc,Ledger_bal--Hold_value--LEDGER_BAL            
          
         Select @COUNTER_CLI = Max(Row_num)          
         From   #PARTY_PLEDGE          
          
         While @COUNTER_CLI > 0          
         Begin          
            --Print 'TOATL DIFF: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)            
          
            Select @PLEDGOR_BOID_CLI = Accno,          
               @PARTY_CODE = Party_code,          
                   @PLEDG_QTY_CLI = Qty,          
                   @SCRIP_PRIORITY_Cli = Scrip_priority,          
                   @ISIN_Cli = Isin          
            From   #PARTY_PLEDGE          
            Where  Row_num = @COUNTER_CLI          
          
            --Print 'CLIENT TOATL: ' + @PARTY_CODE + ' ' + Cast(@PLEDG_QTY_CLI As Varchar)            
          
            If @PLEDG_QTY > 0          
            Begin          
              If @PLEDG_QTY_CLI < @PLEDG_QTY          
               Begin          
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI          
          
                  --Print 'REMAINING :' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)            
          
                  Update #PARTY_PLEDGE          
                  Set    Actual_pledgeqty = @PLEDG_QTY_CLI          
                  Where  Party_code = @PARTY_CODE          
                         And Accno = @PLEDGOR_BOID_CLI          
                         And Row_num = @COUNTER_CLI          
                         And Isin = @Isin          
                         And Scrip_priority = @SCRIP_PRIORITY_Cli          
          
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI          
               End          
               Else If @PLEDG_QTY_CLI >= @PLEDG_QTY          
               Begin          
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI          
          
                  --Print 'REMAINING B:' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)            
          
                  Update #PARTY_PLEDGE          
                  Set    Actual_pledgeqty = @PLEDG_QTY          
                  Where  Party_code = @PARTY_CODE          
                         And Accno = @PLEDGOR_BOID_CLI          
                         And Row_num = @COUNTER_CLI          
                         And Isin = @ISIN_Cli          
                         And Scrip_priority = @SCRIP_PRIORITY_Cli          
          
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI          
               --BREAK            
               End          
            End          
          
            Set @COUNTER_CLI=@COUNTER_CLI - 1          
         End          
          
         Update A          
         Set    A.Pledge_qty = B.Actual_pledgeqty          
         From   #Tbl_party_pledge_data A          
                Inner Join #PARTY_PLEDGE B          
                 On A.Party_code = B.Party_code          
                    And A.Isin = B.Isin          
                    And A.Scrip_cd = B.Scrip_cd          
                    And A.Accno = B.Accno          
                    And A.Scrip_priority = B.Scrip_priority          
         Where  Processdate >= @LastProc_Date          
                And Processdate <= @LastProc_Date + ' 23:59:59'          
                And A.Client_priority = 1          
          
         Drop Table #PARTY_PLEDGE          
          
         Set @COUNTER=@COUNTER - 1          
          
      End          
          
      --Print '********End While Reallocation Pleqdgeable Qty**********'            
          
      Update A          
      Set    A.Pledge_qty = B.Pledge_qty          
      From   Tbl_party_pledge_data A          
             Inner Join #Tbl_party_pledge_data B          
              On A.Party_code = B.Party_code          
                 And A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Qty = B.Qty          
                 And A.Scrip_priority = B.Scrip_priority          
                 And A.Client_priority = B.Client_priority          
      Where  A.Processdate >= @LastProc_Date          
             And A.Processdate <= @LastProc_Date + ' 23:59:59'          
             And A.Client_priority = 1          
          
      -----****End Allocation Pledgeable Qty            
          
      ---------------****Adjust Extra Pledge Qty Against Creditor and Not Pledgeable clienct stock            
      --drop table #Adjustmentisinqty            
      Select Isin=Isnull(A.Isin, B.Isin),          
             Accno=Isnull(A.Accno, B.Accno),          
             Diffqty=Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0),          
             Avg_closing=Convert(Money, 0),          
             Scrip_cd=Space(50),          
             Scripname=Space(50)          
      Into   #AdjustmentISINQty          
      From   (Select Isin,          
                     Accno,          
                     Pledge_qty=Sum(Pledge_qty)          
              From   Tbl_party_pledge_data          
              Where  Processdate >= @LastProc_Date          
                     And Processdate <= @LastProc_Date + ' 23:59:59'          
                     And Accno In ('1203320000000066', '1203320000000051')          
                     And Pledge_qty <> 0          
              Group  By Isin,Accno)A          
             Full Outer Join(Select Isin,          
                                    Accno=Pledgor_bo_id,          
                                    Actualpledge_qty=Sum(Pledg_qty)          
                             From   #LAS_PLEDGE_REQUEST          
                             Where  Pledgor_bo_id In ('1203320000000066', '1203320000000051')          
                             Group  By Isin,Pledgor_bo_id) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
      Where  Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0) > 0          
          
      Select Row_num=Identity(Int, 1, 1),          
             Isin,          
             Pledgor_bo_id=Accno,          
             Pledg_qty=Cast(Sum(Diffqty) As Int),          
             Pledg_value=Cast (Sum(0)As Money)          
      Into   #LAS_PLEDGE_REQUEST_EXCESS          
      From   #Adjustmentisinqty A(NOLOCK)          
      Where  Accno In('1203320000000066', '1203320000000051')          
      Group  By Isin,Accno          
          
      Select *          
      Into   #Tbl_party_pledge_data_CR          
      From   Tbl_party_pledge_data A(NOLOCK)          
      Where  Processdate >= @LastProc_Date          
             And Processdate <= @LastProc_Date + ' 23:59:59'          
             And Pledge_qty <> Qty          
             --And Avg_closing > 0 --Comment on 25 Apr 2012           
             And Pledge_qty = 0          
             And Accno In('1203320000000066', '1203320000000051')          
             And Isin In (Select Isin          
                          From   #LAS_PLEDGE_REQUEST_EXCESS)          
          
      Create Clustered Index [IX_LAS_PLEDGE_ROW_NUM]          
       On #LAS_PLEDGE_REQUEST_EXCESS ( [Isin] Asc, [Row_num] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      Create Clustered Index [IX_PARTY_PLEDGE_PARTYCODE_ISIN]          
       On #Tbl_party_pledge_data_CR ( [Isin] Asc, [Party_code] Asc )          
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]          
          
      /*Declare @ISIN Varchar(20),            
      @PLEDGOR_BOID Varchar(20),            
      @PLEDG_QTY Int,            
      @PLEDG_VALUE Money,            
      @COUNTER Int            
                  
      ----VARIABLE CLIENT LEVEL            
      Declare @ISIN_CLI Varchar(20),            
      @PLEDGOR_BOID_CLI Varchar(20),            
      @PLEDG_QTY_CLI Int,            
      @DIFFPLEDG_QTY_CLI Int,            
    @PLEDG_VALUE_CLI Money,            
      @COUNTER_CLI Int,            
      @PARTY_CODE Varchar(20),            
      @SCRIP_PRIORITY_CLI Int*/          
          
      Set @ISIN=''          
          
      Set @PLEDGOR_BOID=''          
          
      Set @PLEDG_QTY=0          
          
      Set @PLEDG_VALUE =0          
          
      Set @COUNTER=0          
          
      Set @ISIN_CLI=''          
          
      Set @PLEDGOR_BOID_CLI=''          
          
      Set @PLEDG_QTY_CLI=0          
          
      Set @PLEDG_VALUE_CLI =0      
          
      Set @DIFFPLEDG_QTY_CLI=0          
          
      Set @PLEDG_VALUE_CLI=0          
          
      Set @PARTY_CODE=''          
          
      Set @SCRIP_PRIORITY_CLI=0          
          
      Set @COUNTER_CLI=0          
          
      Select @COUNTER = Max(Row_num)          
      From   #LAS_PLEDGE_REQUEST_EXCESS          
          
      While @COUNTER > 0          
      Begin          
         Select @ISIN = Isin,          
                @PLEDGOR_BOID = Pledgor_bo_id,          
                @PLEDG_QTY = Pledg_qty,          
                @PLEDG_VALUE = Pledg_value          
         From   #LAS_PLEDGE_REQUEST_EXCESS          
         Where  Row_num = @COUNTER          
          
         --Print 'TOATL: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)            
          
         Select Row_num=Identity(Int, 1, 1),          
                Isin,          
                Accno,          
                Scrip_cd,          
                Party_code,          
                Qty,          
                Actual_pledgeqty=0,          
                Scrip_priority,          
                Client_priority          
         Into   #PARTY_PLEDGE_CR          
         From   #Tbl_party_pledge_data_CR          
         Where  Isin = @ISIN          
                And Accno = @PLEDGOR_BOID          
         Order  By Client_priority Desc,Ledger_bal--Hold_value--LEDGER_BAL            
          
         Select @COUNTER_CLI = Max(Row_num)          
         From   #PARTY_PLEDGE_CR          
          
         While @COUNTER_CLI > 0          
         Begin          
            --Print 'TOATL DIFF: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)            
          
            Select @PLEDGOR_BOID_CLI = Accno,          
                   @PARTY_CODE = Party_code,          
                   @PLEDG_QTY_CLI = Qty,          
                   @SCRIP_PRIORITY_Cli = Scrip_priority,          
                   @Isin_CLI = Isin          
            From   #PARTY_PLEDGE_CR          
            Where  Row_num = @COUNTER_CLI          
          
            --Print 'CLIENT TOATL: ' + @PARTY_CODE + ' ' + Cast(@PLEDG_QTY_CLI As Varchar)            
          
            If @PLEDG_QTY > 0          
            Begin          
               If @PLEDG_QTY_CLI < @PLEDG_QTY          
               Begin          
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI          
          
                  --Print 'REMAINING :' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)            
          
                  Update #PARTY_PLEDGE_CR          
                  Set    Actual_pledgeqty = @PLEDG_QTY_CLI          
                  Where  Party_code = @PARTY_CODE          
                         And Accno = @PLEDGOR_BOID_CLI          
                         And Row_num = @COUNTER_CLI          
                         And Isin = @Isin_CLI          
                         And Scrip_priority = @SCRIP_PRIORITY_Cli          
          
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI          
               End          
               Else If @PLEDG_QTY_CLI >= @PLEDG_QTY          
               Begin          
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI          
          
                  --Print 'REMAINING B:' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)            
          
                  Update #PARTY_PLEDGE_CR          
                  Set    Actual_pledgeqty = @PLEDG_QTY          
                  Where  Party_code = @PARTY_CODE          
                         And Accno = @PLEDGOR_BOID_CLI          
                         And Row_num = @COUNTER_CLI          
                         And Isin = @Isin          
                         And Scrip_priority = @SCRIP_PRIORITY_Cli          
          
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI          
          
               --BREAK            
               End          
            End          
          
            Set @COUNTER_CLI=@COUNTER_CLI - 1          
         End          
          
         Update A          
         Set    A.Pledge_qty = B.Actual_pledgeqty          
         From   #Tbl_party_pledge_data_CR A          
                Inner Join #PARTY_PLEDGE_CR B          
                 On A.Party_code = B.Party_code          
                    And A.Isin = B.Isin          
                    And A.Scrip_cd = B.Scrip_cd          
                    And A.Accno = B.Accno          
                    And A.Scrip_priority = B.Scrip_priority          
                    And A.Client_priority = B.Client_priority          
         Where  Processdate >= @LastProc_Date          
                And Processdate <= @LastProc_Date + ' 23:59:59'          
                And A.Pledge_qty <> A.Qty          
          
         Drop Table #PARTY_PLEDGE_CR          
          
         Set @COUNTER=@COUNTER - 1          
          
      End          
          
      --Print '********End While Reallocation Excess Pleqdge Qty**********'            
          
      Update A          
      Set    A.Pledge_qty = B.Pledge_qty          
      --A.Scrip_priority = 0            
      From   Tbl_party_pledge_data A          
             Inner Join #Tbl_party_pledge_data_CR B          
              On A.Party_code = B.Party_code          
                 And A.Isin = B.Isin          
                 And A.Accno = B.Accno          
                 And A.Scrip_cd = B.Scrip_cd          
                 And A.Qty = B.Qty          
                 And A.Scrip_priority = B.Scrip_priority          
                 And A.Client_priority = B.Client_priority          
      Where  A.Processdate >= @LastProc_Date          
             And A.Processdate <= @LastProc_Date + ' 23:59:59'          
             And A.Pledge_qty <> A.Qty          
             And A.Pledge_qty = 0          
             And B.Pledge_qty <> 0          
             And A.Isin In (Select Isin          
                            From   #LAS_PLEDGE_REQUEST_EXCESS)          
          
      --drop table #AdjustmentISINQty_Cr            
      Select Isin=Isnull(A.Isin, B.Isin),          
             Accno=Isnull(A.Accno, B.Accno),          
             Diffqty=Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0),          
             Avg_closing=Convert(Money, 0),          
             Scrip_cd=Space(50),          
             Scripname=Space(50)          
      Into   #AdjustmentISINQty_Cr          
      From   (Select Isin,          
                     Accno,          
                     Pledge_qty=Sum(Pledge_qty)          
              From   Tbl_party_pledge_data (nolock)          
              Where  Processdate >= @LastProc_Date          
                     And Processdate <= @LastProc_Date + ' 23:59:59'          
                     And Accno In ('1203320000000066', '1203320000000051')          
              Group  By Isin,Accno)A          
             Full Outer Join(Select Isin,          
                                    Accno=Pledgor_bo_id,          
                                    Actualpledge_qty=Sum(Pledg_qty)          
                             From   #LAS_PLEDGE_REQUEST          
                             Where  Pledgor_bo_id In ('1203320000000066', '1203320000000051')          
                             Group  By Isin,Pledgor_bo_id) B          
              On A.Isin = B.Isin          
                 And A.Accno = B.Accno          
      Where  Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0) <> 0          
          
      Update #AdjustmentISINQty_Cr          
      Set    Avg_closing = A.Clsrate,          
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,          
             #adjustmentisinqty_cr.Scripname = A.Scripname          
      From   (Select *          
              From   Vw_equity_cls_rate (nolock)) A          
      Where  #adjustmentisinqty_cr.Isin = A.Isin          
             And #adjustmentisinqty_cr.Accno = A.Accno      
          
      Update #AdjustmentISINQty_Cr          
      Set    Avg_closing = A.Clsrate,          
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,          
             #adjustmentisinqty_cr.Scripname = A.Scripname          
      From   (Select *          
              From   Vw_equity_cls_rate (nolock)    
              Where Accno in('1203320000000066')) A          
      Where  #adjustmentisinqty_cr.Isin = A.Isin     
             And #adjustmentisinqty_cr.Accno = '1203320000000051'     
          
       Update #AdjustmentISINQty_Cr          
      Set    Avg_closing = A.Clsrate,          
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,          
             #adjustmentisinqty_cr.Scripname = A.Scripname          
      From   (Select *          
              From   Vw_equity_cls_rate (nolock)    
              Where Accno in('1203320000000051')) A          
      Where  #adjustmentisinqty_cr.Isin = A.Isin          
             And #adjustmentisinqty_cr.Accno = '1203320000000066'     
          
      Declare @Rms_Date Datetime          
          
      Select @Rms_Date = Max(Rms_date)          
      From   Tbl_party_pledge_data          
          
      Insert Into Tbl_party_pledge_data          
      Select Rms_date=@Rms_Date,          
             Party_code='Unknown',          
             Ledger_bal=0,          
             Client_priority=1,          
             Isin,          
             Scrip_cd,          
             Scripname,          
             Accno,          
             Qty=0,          
             Pledge_qty=0,          
             Free_qty=0,          
             Hold_value=0,          
             Avg_closing,          
             Pledgeable_qty=0,          
             Pledgeable_value=0,          
             Prevdaypledgeqty=0,          
             Release_qty=Diffqty,          
             Scrip_priority=0,          
             @LastProc_Date,          
             'System'          
      From   #AdjustmentISINQty_Cr          
          
   ---Checking Ploting release Qty And Pldge Qty            
   /*Select a.*,b.*            
   from            
   (Select accno,isin,AQty=Sum(PLEDGE_QTY)+Sum(Release_qty) from            
   ----#Tbl_party_pledge_data            
   Tbl_party_pledge_data            
   where Processdate >= Convert(Varchar, Getdate()-1, 106)            
   And Processdate <= Convert(Varchar, Getdate()-1, 106) + ' 23:59:59'            
   and accno in ('1203320000000066','1203320000000051')            
   --and isin='INE209L01016'            
   --order by party_code            
   group by accno,isin) a            
   inner join            
   (Select Clientid,isin,BQty=Sum(pledgeQty)-Sum(unpledgeQty) from mis.demat.dbo.Pledge2ReleaseEntry a(NOLOCK)            
   where Clientid in ('1203320000000066','1203320000000051')            
   --and isin='INE209L01016'            
   group by Clientid,isin) b            
   on b.Clientid=a.accno            
   and b.isin=a.isin            
   where AQty<>BQty            
   */          
   End          
          
   Set nocount Off          
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_reallocation_cli_07112016
-- --------------------------------------------------
/*              
    CHANGE ID  :: 1              
    MODIFIED BY  :: PRASHANT              
    MODIFIED DATE :: AUG 03 2013              
    REASON   :: RELEASE PLEDGE SHARES OF WCL CLIENT WHILE REALLOCATING PREVIOUS DAY SHARES              
    REQUEST FROM :: RAHUL SIR              
    PRMS ID   :: NONE              
                  
    CHANGE ID  :: 2              
    MODIFIED BY  :: PRASHANT              
    MODIFIED DATE :: AUG 03 2013              
    REASON   :: CALL WCL PROCESS BEFORE PLEDGE PROCESS              
    REQUEST FROM :: RAHUL SIR              
    PRMS ID   :: NONE              
      
    CHANGE ID  :: 3  
    MODIFIED BY  :: PRASHANT              
    MODIFIED DATE :: SEP 16 2013              
    REASON   :: EXCLUDE IN-ACTIVE BANK'S IN REALLOCATION PROCESS  
    REQUEST FROM :: RAHUL SIR  
    PRMS ID   :: NONE              
*/              
Create Procedure [dbo].[Usp_las_pledge_reallocation_cli_07112016]              
As              
Begin              
   --Drop Table #LAS_PLEDGE_REQUEST                          
   -----****Satart Allocation Pledgeable Qty              
   Set nocount On              
                 
   If Not Exists (Select Hdate              
                  From   [196.1.115.239].harmony.DBO.Holimst A(nolock)              
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))              
   Begin              

		truncate table PledgeProcessWCLLog
	 insert into dbo.PledgeProcessWCLLog(Starttime) values(GETDATE())
	
      /*CHANGE ID  :: 2*/              
      exec MIS.DBO.Upd_WCL       
      
      update dbo.PledgeProcessWCLLog set Endtime=GETDATE()
                 
      Declare @LastProc_Date As Datetime                        
                        
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)                        
      From   Tbl_party_pledge_data (nolock)                        
                        
      Select Row_num=Identity(Int, 1, 1),                        
             Isin,                        
             Pledgor_bo_id=Clientid,                        
             Pledg_qty=Cast(Sum(Pledgeqty - Unpledgeqty) As Int),                        
             Pledg_value=Cast (Sum(0)As Money)                        
      Into   #LAS_PLEDGE_REQUEST                        
      From   mis.demat.dbo.Pledge2releaseentry A(NOLOCK)  
      Where  Clientid In('1203320000000066', '1203320000000051')  
             /*CHANGE ID  :: 3*/  
             AND EXISTS(SELECT *   
                        FROM GENERAL.dbo.Tbl_las_bank_master B With(NOLOCK)  
                        Where  Active_inactive = 1 AND A.BANKID = B.BO_ID)  
      Group  By Isin,Clientid  
                        
      --Drop Table #Tbl_party_pledge_data                          
                        
      Select *                        
      Into   #Tbl_party_pledge_data                        
      From   Tbl_party_pledge_data (nolock)                        
      Where  Processdate >= @LastProc_Date                        
             And Processdate <= @LastProc_Date + ' 23:59:59'                        
             And Client_priority = 1                        
             And Qty > 0                        
             --And Avg_closing > 0 --Comment on 25 Apr 2012                     
             And Accno In('1203320000000066', '1203320000000051')                        
                        
      Create Clustered Index [IX_LAS_PLEDGE_ROW_NUM]                        
       On #LAS_PLEDGE_REQUEST ( [Isin] Asc, [Row_num] Asc )                        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                        
                        
      Create Clustered Index [IX_PARTY_PLEDGE_PARTYCODE_ISIN]                        
       On #TBL_PARTY_PLEDGE_DATA ( [Isin] Asc, [Party_code] Asc )                        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                        
                        
      Declare @ISIN         Varchar(20),                        
     @PLEDGOR_BOID Varchar(20),                        
              @PLEDG_QTY    Int,                        
              @PLEDG_VALUE  Money,                        
              @COUNTER      Int                        
                        
      ----VARIABLE CLIENT LEVEL                          
      Declare @ISIN_CLI           Varchar(20),                        
              @PLEDGOR_BOID_CLI   Varchar(20),                        
              @PLEDG_QTY_CLI      Int,                        
              @DIFFPLEDG_QTY_CLI  Int,                 
              @PLEDG_VALUE_CLI    Money,                        
              @COUNTER_CLI        Int,                        
              @PARTY_CODE         Varchar(20),                        
              @SCRIP_PRIORITY_CLI Int                        
                        
      Select @COUNTER = Max(Row_num)                        
      From   #LAS_PLEDGE_REQUEST                        
                        
      While @COUNTER > 0                        
      Begin                        
         Select @ISIN = Isin,                        
                @PLEDGOR_BOID = Pledgor_bo_id,                        
                @PLEDG_QTY = Pledg_qty,                        
                @PLEDG_VALUE = Pledg_value                        
         From   #LAS_PLEDGE_REQUEST                        
         Where  Row_num = @COUNTER                        
                        
         --Print 'TOATL: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                          
                        
         Select Row_num=Identity(Int, 1, 1),                        
                Isin,                        
                Accno,                        
                Scrip_cd,                        
                Party_code,                        
                Qty,                        
                Actual_pledgeqty=0,                        
                Scrip_priority                        
         Into   #PARTY_PLEDGE                        
         From   #Tbl_party_pledge_data                        
         Where  Isin = @ISIN                        
                And Accno = @PLEDGOR_BOID                        
         Order  By Scrip_priority Desc,Ledger_bal--Hold_value--LEDGER_BAL                          
                        
         Select @COUNTER_CLI = Max(Row_num)                        
         From   #PARTY_PLEDGE                        
                        
         While @COUNTER_CLI > 0                        
         Begin                        
            --Print 'TOATL DIFF: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                          
                        
            Select @PLEDGOR_BOID_CLI = Accno,                        
               @PARTY_CODE = Party_code,                        
                   @PLEDG_QTY_CLI = Qty,                        
                   @SCRIP_PRIORITY_Cli = Scrip_priority,                        
                   @ISIN_Cli = Isin                        
            From   #PARTY_PLEDGE                        
            Where  Row_num = @COUNTER_CLI                        
                        
            --Print 'CLIENT TOATL: ' + @PARTY_CODE + ' ' + Cast(@PLEDG_QTY_CLI As Varchar)                          
                        
            If @PLEDG_QTY > 0                        
            Begin                        
              If @PLEDG_QTY_CLI < @PLEDG_QTY                        
               Begin                        
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                        
                        
                  --Print 'REMAINING :' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                          
                        
                  Update #PARTY_PLEDGE                        
                  Set    Actual_pledgeqty = @PLEDG_QTY_CLI                        
                  Where  Party_code = @PARTY_CODE    
                         And Accno = @PLEDGOR_BOID_CLI                        
                         And Row_num = @COUNTER_CLI                        
                         And Isin = @Isin                        
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                        
                        
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                        
               End                        
               Else If @PLEDG_QTY_CLI >= @PLEDG_QTY                        
               Begin                        
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                        
                        
            --Print 'REMAINING B:' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                          
                        
                  Update #PARTY_PLEDGE                        
                  Set    Actual_pledgeqty = @PLEDG_QTY                        
                  Where  Party_code = @PARTY_CODE                        
                         And Accno = @PLEDGOR_BOID_CLI                        
                         And Row_num = @COUNTER_CLI                        
                         And Isin = @ISIN_Cli                        
                         And Scrip_priority = @SCRIP_PRIORITY_Cli          
                        
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                        
               --BREAK                          
               End                        
            End                        
                        
            Set @COUNTER_CLI=@COUNTER_CLI - 1                        
         End                        
          
         Update A                        
         Set    A.Pledge_qty = B.Actual_pledgeqty                        
         From   #Tbl_party_pledge_data A                        
                Inner Join #PARTY_PLEDGE B                        
                 On A.Party_code = B.Party_code                        
                    And A.Isin = B.Isin                        
        And A.Scrip_cd = B.Scrip_cd                        
                    And A.Accno = B.Accno                        
                    And A.Scrip_priority = B.Scrip_priority                        
         Where  Processdate >= @LastProc_Date                        
                And Processdate <= @LastProc_Date + ' 23:59:59'                        
                And A.Client_priority = 1                        
                        
         Drop Table #PARTY_PLEDGE                        
                        
         Set @COUNTER=@COUNTER - 1                        
                        
      End                        
                        
      --Print '********End While Reallocation Pleqdgeable Qty**********'                          
                        
      Update A                        
      Set    A.Pledge_qty = B.Pledge_qty                        
      From   Tbl_party_pledge_data A                        
             Inner Join #Tbl_party_pledge_data B                        
              On A.Party_code = B.Party_code                        
                 And A.Isin = B.Isin                        
                 And A.Accno = B.Accno                        
                 And A.Scrip_cd = B.Scrip_cd                        
                 And A.Qty = B.Qty                        
                 And A.Scrip_priority = B.Scrip_priority                        
                 And A.Client_priority = B.Client_priority                        
      Where  A.Processdate >= @LastProc_Date                        
             And A.Processdate <= @LastProc_Date + ' 23:59:59'                        
             And A.Client_priority = 1                        
                        
      -----****End Allocation Pledgeable Qty                          
                        
      ---------------****Adjust Extra Pledge Qty Against Creditor and Not Pledgeable clienct stock                          
      --drop table #Adjustmentisinqty                          
      Select Isin=Isnull(A.Isin, B.Isin),                        
             Accno=Isnull(A.Accno, B.Accno),                        
             Diffqty=Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0),                        
             Avg_closing=Convert(Money, 0),                        
             Scrip_cd=Space(50),                        
             Scripname=Space(50)                        
      Into   #AdjustmentISINQty                        
      From   (Select Isin,                        
                     Accno,                        
                     Pledge_qty=Sum(Pledge_qty)                        
              From   Tbl_party_pledge_data                        
              Where  Processdate >= @LastProc_Date                        
                     And Processdate <= @LastProc_Date + ' 23:59:59'                        
                     And Accno In ('1203320000000066', '1203320000000051')                        
                     And Pledge_qty <> 0                        
              Group  By Isin,Accno)A                        
             Full Outer Join(Select Isin,                        
    Accno=Pledgor_bo_id,                        
                                    Actualpledge_qty=Sum(Pledg_qty)                        
                             From   #LAS_PLEDGE_REQUEST                        
                             Where  Pledgor_bo_id In ('1203320000000066', '1203320000000051')                        
                             Group  By Isin,Pledgor_bo_id) B                        
              On A.Isin = B.Isin                
                 And A.Accno = B.Accno                        
      Where  Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0) > 0                        
                        
      Select Row_num=Identity(Int, 1, 1),                        
             Isin,                        
             Pledgor_bo_id=Accno,                        
             Pledg_qty=Cast(Sum(Diffqty) As Int),                        
             Pledg_value=Cast (Sum(0)As Money)                        
Into   #LAS_PLEDGE_REQUEST_EXCESS                        
      From   #Adjustmentisinqty A(NOLOCK)                        
      Where  Accno In('1203320000000066', '1203320000000051')                        
      Group  By Isin,Accno                        
                    
      /*CHANGE ID  :: 1*/              
      Select Party_Code              
        INTO #WCL_CLIENTS              
      from MIS.DBO.WCL_ActionRpt1(convert(datetime,GETDATE(),103))              
      where BOI+YES+SCB+ADH+AXS <> 0.00               
                        
      Select a.*          
      Into   #Tbl_party_pledge_data_CR                        
      From   Tbl_party_pledge_data A(NOLOCK)               
                LEFT OUTER JOIN #WCL_CLIENTS B (NOLOCK)               
                    ON A.PARTY_CODE = B.PARTY_CODE              
      Where  Processdate >= @LastProc_Date                        
             And Processdate <= @LastProc_Date + ' 23:59:59'                        
             And Pledge_qty <> Qty                        
             --And Avg_closing > 0 --Comment on 25 Apr 2012                         
             And Pledge_qty = 0               
             And Accno In('1203320000000066', '1203320000000051')              
             /*CHANGE ID  :: 1*/              
             /*              
                This should be party_codes which were excluded in previous day process.              
                Store WCL LAS clients details in a table and use that table here              
             */              
             AND B.PARTY_CODE IS NULL              
             And Isin In (Select Isin                        
                          From   #LAS_PLEDGE_REQUEST_EXCESS)                        
                        
      Create Clustered Index [IX_LAS_PLEDGE_ROW_NUM]                        
       On #LAS_PLEDGE_REQUEST_EXCESS ( [Isin] Asc, [Row_num] Asc )                        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                        
                        
      Create Clustered Index [IX_PARTY_PLEDGE_PARTYCODE_ISIN]                        
       On #Tbl_party_pledge_data_CR ( [Isin] Asc, [Party_code] Asc )                        
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                        
                        
      /*Declare @ISIN Varchar(20),                          
      @PLEDGOR_BOID Varchar(20),                          
      @PLEDG_QTY Int,                          
      @PLEDG_VALUE Money,                          
      @COUNTER Int                          
                                
      ----VARIABLE CLIENT LEVEL                
      Declare @ISIN_CLI Varchar(20),                          
      @PLEDGOR_BOID_CLI Varchar(20),                          
      @PLEDG_QTY_CLI Int,                          
      @DIFFPLEDG_QTY_CLI Int,                          
    @PLEDG_VALUE_CLI Money,                          
      @COUNTER_CLI Int,                          
      @PARTY_CODE Varchar(20),                          
      @SCRIP_PRIORITY_CLI Int*/                        
                        
      Set @ISIN=''                        
                        
      Set @PLEDGOR_BOID=''                   
                        
      Set @PLEDG_QTY=0                        
                        
      Set @PLEDG_VALUE =0                        
                        
      Set @COUNTER=0                        
                        
      Set @ISIN_CLI=''                        
                        
      Set @PLEDGOR_BOID_CLI=''                        
                        
      Set @PLEDG_QTY_CLI=0                        
                        
      Set @PLEDG_VALUE_CLI =0                    
                        
      Set @DIFFPLEDG_QTY_CLI=0                        
                        
      Set @PLEDG_VALUE_CLI=0                        
                        
      Set @PARTY_CODE=''                        
                        
      Set @SCRIP_PRIORITY_CLI=0                        
                        
      Set @COUNTER_CLI=0                        
                        
      Select @COUNTER = Max(Row_num)                        
      From   #LAS_PLEDGE_REQUEST_EXCESS                        
                        
      While @COUNTER > 0                        
      Begin                        
         Select @ISIN = Isin,                        
                @PLEDGOR_BOID = Pledgor_bo_id,                        
                @PLEDG_QTY = Pledg_qty,                        
                @PLEDG_VALUE = Pledg_value                        
        From   #LAS_PLEDGE_REQUEST_EXCESS                        
         Where  Row_num = @COUNTER                        
                        
         --Print 'TOATL: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                          
                        
         Select Row_num=Identity(Int, 1, 1),                        
                Isin,                        
                Accno,                        
                Scrip_cd,                        
                Party_code,                        
                Qty,                        
                Actual_pledgeqty=0,                        
                Scrip_priority,                        
                Client_priority                        
         Into   #PARTY_PLEDGE_CR                      
         From   #Tbl_party_pledge_data_CR                        
         Where  Isin = @ISIN                        
                And Accno = @PLEDGOR_BOID                        
         Order  By Client_priority Desc,Ledger_bal--Hold_value--LEDGER_BAL                                                  
         Select @COUNTER_CLI = Max(Row_num)                        
         From   #PARTY_PLEDGE_CR                        
                        
         While @COUNTER_CLI > 0                        
         Begin                        
            --Print 'TOATL DIFF: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                          
                        
            Select @PLEDGOR_BOID_CLI = Accno,                        
                   @PARTY_CODE = Party_code,                        
                   @PLEDG_QTY_CLI = Qty,                        
                   @SCRIP_PRIORITY_Cli = Scrip_priority,                        
                   @Isin_CLI = Isin                        
            From   #PARTY_PLEDGE_CR                        
            Where  Row_num = @COUNTER_CLI                        
                        
            --Print 'CLIENT TOATL: ' + @PARTY_CODE + ' ' + Cast(@PLEDG_QTY_CLI As Varchar)                          
                        
            If @PLEDG_QTY > 0                        
            Begin                        
              If @PLEDG_QTY_CLI < @PLEDG_QTY                        
               Begin                        
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                        
                        
                  --Print 'REMAINING :' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                          
                        
                  Update #PARTY_PLEDGE_CR                        
                  Set    Actual_pledgeqty = @PLEDG_QTY_CLI                        
                  Where  Party_code = @PARTY_CODE                        
                         And Accno = @PLEDGOR_BOID_CLI                        
                         And Row_num = @COUNTER_CLI                        
           And Isin = @Isin_CLI                        
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                        
                        
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                        
               End                        
               Else If @PLEDG_QTY_CLI >= @PLEDG_QTY                        
               Begin                        
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                        
                        
                  --Print 'REMAINING B:' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                          
                        
                  Update #PARTY_PLEDGE_CR                        
                  Set    Actual_pledgeqty = @PLEDG_QTY                        
                  Where  Party_code = @PARTY_CODE                        
                         And Accno = @PLEDGOR_BOID_CLI                        
                         And Row_num = @COUNTER_CLI                        
                         And Isin = @Isin                        
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                        
                        
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                        
                        
               --BREAK                          
               End                        
            End                        
                        
            Set @COUNTER_CLI=@COUNTER_CLI - 1                        
         End                        
                        
         Update A                        
         Set    A.Pledge_qty = B.Actual_pledgeqty                        
         From #Tbl_party_pledge_data_CR A                        
                Inner Join #PARTY_PLEDGE_CR B                        
                 On A.Party_code = B.Party_code                        
                    And A.Isin = B.Isin                        
                    And A.Scrip_cd = B.Scrip_cd                        
                    And A.Accno = B.Accno                        
                    And A.Scrip_priority = B.Scrip_priority                       
                    And A.Client_priority = B.Client_priority                        
         Where  Processdate >= @LastProc_Date                        
                And Processdate <= @LastProc_Date + ' 23:59:59'                        
                And A.Pledge_qty <> A.Qty                        
                        
         Drop Table #PARTY_PLEDGE_CR                        
                        
         Set @COUNTER=@COUNTER - 1              
                        
      End                        
                        
      --Print '********End While Reallocation Excess Pleqdge Qty**********'                          
                        
      Update A                        
      Set    A.Pledge_qty = B.Pledge_qty                        
      --A.Scrip_priority = 0                          
      From   Tbl_party_pledge_data A                        
             Inner Join #Tbl_party_pledge_data_CR B                        
              On A.Party_code = B.Party_code                        
                 And A.Isin = B.Isin                        
                 And A.Accno = B.Accno                        
                 And A.Scrip_cd = B.Scrip_cd                        
 And A.Qty = B.Qty                        
                 And A.Scrip_priority = B.Scrip_priority                        
                 And A.Client_priority = B.Client_priority                        
      Where  A.Processdate >= @LastProc_Date                        
    And A.Processdate <= @LastProc_Date + ' 23:59:59'                        
             And A.Pledge_qty <> A.Qty                        
             And A.Pledge_qty = 0                        
             And B.Pledge_qty <> 0                        
             And A.Isin In (Select Isin                        
                            From   #LAS_PLEDGE_REQUEST_EXCESS)                        
                        
      --drop table #AdjustmentISINQty_Cr                          
      Select Isin=Isnull(A.Isin, B.Isin),                        
             Accno=Isnull(A.Accno, B.Accno),                      
             Diffqty=Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0),                        
             Avg_closing=Convert(Money, 0),                        
             Scrip_cd=Space(50),                        
             Scripname=Space(50)                        
      Into   #AdjustmentISINQty_Cr                        
      From   (Select Isin,                        
                     Accno,                        
                     Pledge_qty=Sum(Pledge_qty)                        
              From   Tbl_party_pledge_data (nolock)                        
              Where  Processdate >= @LastProc_Date                        
                     And Processdate <= @LastProc_Date + ' 23:59:59'                        
                     And Accno In ('1203320000000066', '1203320000000051')                        
              Group  By Isin,Accno)A                        
             Full Outer Join(Select Isin,                        
                                    Accno=Pledgor_bo_id,                        
                                    Actualpledge_qty=Sum(Pledg_qty)                        
                             From   #LAS_PLEDGE_REQUEST                        
                             Where  Pledgor_bo_id In ('1203320000000066', '1203320000000051')                        
                             Group  By Isin,Pledgor_bo_id) B                        
              On A.Isin = B.Isin                        
                 And A.Accno = B.Accno                        
      Where  Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0) <> 0                        
                        
      Update #AdjustmentISINQty_Cr                        
      Set    Avg_closing = A.Clsrate,                        
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                        
            #adjustmentisinqty_cr.Scripname = A.Scripname                        
      From   (Select *                        
              From   Vw_equity_cls_rate (nolock)) A                        
      Where  #adjustmentisinqty_cr.Isin = A.Isin                        
             And #adjustmentisinqty_cr.Accno = A.Accno                    
                        
      Update #AdjustmentISINQty_Cr                        
      Set    Avg_closing = A.Clsrate,                        
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                        
             #adjustmentisinqty_cr.Scripname = A.Scripname                        
      From   (Select *                        
              From   Vw_equity_cls_rate (nolock)                  
              Where Accno in('1203320000000066')) A                        
      Where  #adjustmentisinqty_cr.Isin = A.Isin                   
             And #adjustmentisinqty_cr.Accno = '1203320000000051'                   
                        
       Update #AdjustmentISINQty_Cr                        
      Set    Avg_closing = A.Clsrate,                        
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                        
             #adjustmentisinqty_cr.Scripname = A.Scripname                        
      From   (Select *                        
              From   Vw_equity_cls_rate (nolock)                  
              Where Accno in('1203320000000051')) A                        
      Where  #adjustmentisinqty_cr.Isin = A.Isin                        
             And #adjustmentisinqty_cr.Accno = '1203320000000066'                   
                        
      Declare @Rms_Date Datetime                        
                        
      Select @Rms_Date = Max(Rms_date)                        
      From   Tbl_party_pledge_data                        
                        
      Insert Into Tbl_party_pledge_data                        
      Select Rms_date=@Rms_Date,                        
             Party_code='Unknown',                        
             Ledger_bal=0,                        
             Client_priority=1,                        
             Isin,                        
             Scrip_cd,                        
             Scripname,                        
             Accno,                        
             Qty=0,            
             Pledge_qty=0,                        
           Free_qty=0,                        
             Hold_value=0,                        
             Avg_closing,                        
             Pledgeable_qty=0,                        
             Pledgeable_value=0,                        
             Prevdaypledgeqty=0,                        
             Release_qty=Diffqty,                        
             Scrip_priority=0,                        
             @LastProc_Date,                        
             'System'                        
      From   #AdjustmentISINQty_Cr                        
                        
   ---Checking Ploting release Qty And Pldge Qty                          
   /*Select a.*,b.*                          
   from                          
   (Select accno,isin,AQty=Sum(PLEDGE_QTY)+Sum(Release_qty) from                          
   ----#Tbl_party_pledge_data                          
   Tbl_party_pledge_data                          
   where Processdate >= Convert(Varchar, Getdate()-1, 106)                          
   And Processdate <= Convert(Varchar, Getdate()-1, 106) + ' 23:59:59'                          
   and accno in ('1203320000000066','1203320000000051')                          
   --and isin='INE209L01016'                          
   --order by party_code                          
   group by accno,isin) a                          
   inner join                          
   (Select Clientid,isin,BQty=Sum(pledgeQty)-Sum(unpledgeQty) from mis.demat.dbo.Pledge2ReleaseEntry a(NOLOCK)                          
   where Clientid in ('1203320000000066','1203320000000051')                          
   --and isin='INE209L01016'                          
   group by Clientid,isin) b                          
   on b.Clientid=a.accno                          
   and b.isin=a.isin                          
   where AQty<>BQty                          
   */                        
   End                        
                        
   Set nocount Off                        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_LAS_PLEDGE_REALLOCATION_CLI_16092013
-- --------------------------------------------------
/*            
    CHANGE ID  :: 1            
    MODIFIED BY  :: PRASHANT            
    MODIFIED DATE :: AUG 03 2013            
    REASON   :: RELEASE PLEDGE SHARES OF WCL CLIENT WHILE REALLOCATING PREVIOUS DAY SHARES            
    REQUEST FROM :: RAHUL SIR            
    PRMS ID   :: NONE            
                
    CHANGE ID  :: 2            
    MODIFIED BY  :: PRASHANT            
    MODIFIED DATE :: AUG 03 2013            
    REASON   :: CALL WCL PROCESS BEFORE PLEDGE PROCESS            
    REQUEST FROM :: RAHUL SIR            
    PRMS ID   :: NONE            
*/            
CREATE Procedure USP_LAS_PLEDGE_REALLOCATION_CLI_16092013
As            
Begin            
   --Drop Table #LAS_PLEDGE_REQUEST                        
   -----****Satart Allocation Pledgeable Qty            
   Set nocount On            
               
   If Not Exists (Select Hdate            
                  From   [196.1.115.239].harmony.DBO.Holimst A(nolock)            
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))            
   Begin            
               
      /*CHANGE ID  :: 2*/            
      exec MIS.DBO.Upd_WCL      
               
      Declare @LastProc_Date As Datetime                      
                      
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)                      
      From   Tbl_party_pledge_data (nolock)                      
                      
      Select Row_num=Identity(Int, 1, 1),                      
             Isin,                      
             Pledgor_bo_id=Clientid,                      
             Pledg_qty=Cast(Sum(Pledgeqty - Unpledgeqty) As Int),                      
             Pledg_value=Cast (Sum(0)As Money)                      
      Into   #LAS_PLEDGE_REQUEST                      
      From   mis.demat.dbo.Pledge2releaseentry A(NOLOCK)                      
      Where  Clientid In('1203320000000066', '1203320000000051')                      
      Group  By Isin,Clientid                      
                      
      --Drop Table #Tbl_party_pledge_data                        
                      
      Select *                      
      Into   #Tbl_party_pledge_data                      
      From   Tbl_party_pledge_data (nolock)                      
      Where  Processdate >= @LastProc_Date                      
             And Processdate <= @LastProc_Date + ' 23:59:59'                      
             And Client_priority = 1                      
             And Qty > 0                      
             --And Avg_closing > 0 --Comment on 25 Apr 2012                   
             And Accno In('1203320000000066', '1203320000000051')                      
                      
      Create Clustered Index [IX_LAS_PLEDGE_ROW_NUM]                      
       On #LAS_PLEDGE_REQUEST ( [Isin] Asc, [Row_num] Asc )                      
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                      
                      
      Create Clustered Index [IX_PARTY_PLEDGE_PARTYCODE_ISIN]                      
       On #TBL_PARTY_PLEDGE_DATA ( [Isin] Asc, [Party_code] Asc )                      
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                      
                      
      Declare @ISIN         Varchar(20),                      
              @PLEDGOR_BOID Varchar(20),                      
              @PLEDG_QTY    Int,                      
              @PLEDG_VALUE  Money,                      
              @COUNTER      Int                      
                      
      ----VARIABLE CLIENT LEVEL                        
      Declare @ISIN_CLI           Varchar(20),                      
              @PLEDGOR_BOID_CLI   Varchar(20),                      
              @PLEDG_QTY_CLI      Int,                      
              @DIFFPLEDG_QTY_CLI  Int,               
              @PLEDG_VALUE_CLI    Money,                      
              @COUNTER_CLI        Int,                      
              @PARTY_CODE         Varchar(20),                      
              @SCRIP_PRIORITY_CLI Int                      
                      
      Select @COUNTER = Max(Row_num)                      
      From   #LAS_PLEDGE_REQUEST                      
                      
      While @COUNTER > 0                      
      Begin                      
         Select @ISIN = Isin,                      
                @PLEDGOR_BOID = Pledgor_bo_id,                      
                @PLEDG_QTY = Pledg_qty,                      
                @PLEDG_VALUE = Pledg_value                      
         From   #LAS_PLEDGE_REQUEST                      
         Where  Row_num = @COUNTER                      
                      
         --Print 'TOATL: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                        
                      
         Select Row_num=Identity(Int, 1, 1),                      
                Isin,                      
                Accno,                      
                Scrip_cd,                      
                Party_code,                      
                Qty,                      
                Actual_pledgeqty=0,                      
                Scrip_priority                      
         Into   #PARTY_PLEDGE                      
         From   #Tbl_party_pledge_data                      
         Where  Isin = @ISIN                      
                And Accno = @PLEDGOR_BOID                      
         Order  By Scrip_priority Desc,Ledger_bal--Hold_value--LEDGER_BAL                        
                      
         Select @COUNTER_CLI = Max(Row_num)                      
         From   #PARTY_PLEDGE                      
                      
         While @COUNTER_CLI > 0                      
         Begin                      
            --Print 'TOATL DIFF: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                        
                      
            Select @PLEDGOR_BOID_CLI = Accno,                      
               @PARTY_CODE = Party_code,                      
                   @PLEDG_QTY_CLI = Qty,                      
                   @SCRIP_PRIORITY_Cli = Scrip_priority,                      
                   @ISIN_Cli = Isin                      
            From   #PARTY_PLEDGE                      
            Where  Row_num = @COUNTER_CLI                      
                      
            --Print 'CLIENT TOATL: ' + @PARTY_CODE + ' ' + Cast(@PLEDG_QTY_CLI As Varchar)                        
                      
            If @PLEDG_QTY > 0                      
            Begin                      
              If @PLEDG_QTY_CLI < @PLEDG_QTY                      
               Begin                      
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                      
                      
                  --Print 'REMAINING :' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                        
                      
                  Update #PARTY_PLEDGE                      
                  Set    Actual_pledgeqty = @PLEDG_QTY_CLI                      
                  Where  Party_code = @PARTY_CODE                      
                         And Accno = @PLEDGOR_BOID_CLI                      
                         And Row_num = @COUNTER_CLI                      
                         And Isin = @Isin                      
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                      
                      
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                      
               End                      
               Else If @PLEDG_QTY_CLI >= @PLEDG_QTY                      
               Begin                      
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                      
                      
            --Print 'REMAINING B:' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                        
                      
                  Update #PARTY_PLEDGE                      
                  Set    Actual_pledgeqty = @PLEDG_QTY                      
                  Where  Party_code = @PARTY_CODE                      
                         And Accno = @PLEDGOR_BOID_CLI                      
                         And Row_num = @COUNTER_CLI                      
                         And Isin = @ISIN_Cli                      
                         And Scrip_priority = @SCRIP_PRIORITY_Cli        
                      
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                      
               --BREAK                        
               End                      
            End                      
                      
            Set @COUNTER_CLI=@COUNTER_CLI - 1                      
         End                      
        
         Update A                      
         Set    A.Pledge_qty = B.Actual_pledgeqty                      
         From   #Tbl_party_pledge_data A                      
                Inner Join #PARTY_PLEDGE B                      
                 On A.Party_code = B.Party_code                      
                    And A.Isin = B.Isin                      
        And A.Scrip_cd = B.Scrip_cd                      
                    And A.Accno = B.Accno                      
                    And A.Scrip_priority = B.Scrip_priority                      
         Where  Processdate >= @LastProc_Date                      
                And Processdate <= @LastProc_Date + ' 23:59:59'                      
                And A.Client_priority = 1                      
                      
         Drop Table #PARTY_PLEDGE                      
                      
         Set @COUNTER=@COUNTER - 1                      
                      
      End                      
                      
      --Print '********End While Reallocation Pleqdgeable Qty**********'                        
                      
      Update A                      
      Set    A.Pledge_qty = B.Pledge_qty                      
      From   Tbl_party_pledge_data A                      
             Inner Join #Tbl_party_pledge_data B                      
              On A.Party_code = B.Party_code                      
                 And A.Isin = B.Isin                      
                 And A.Accno = B.Accno                      
                 And A.Scrip_cd = B.Scrip_cd                      
                 And A.Qty = B.Qty                      
                 And A.Scrip_priority = B.Scrip_priority                      
                 And A.Client_priority = B.Client_priority                      
      Where  A.Processdate >= @LastProc_Date                      
             And A.Processdate <= @LastProc_Date + ' 23:59:59'                      
             And A.Client_priority = 1                      
                      
      -----****End Allocation Pledgeable Qty                        
                      
      ---------------****Adjust Extra Pledge Qty Against Creditor and Not Pledgeable clienct stock                        
      --drop table #Adjustmentisinqty                        
      Select Isin=Isnull(A.Isin, B.Isin),                      
             Accno=Isnull(A.Accno, B.Accno),                      
             Diffqty=Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0),                      
             Avg_closing=Convert(Money, 0),                      
             Scrip_cd=Space(50),                      
             Scripname=Space(50)                      
      Into   #AdjustmentISINQty                      
      From   (Select Isin,                      
                     Accno,                      
                     Pledge_qty=Sum(Pledge_qty)                      
              From   Tbl_party_pledge_data                      
              Where  Processdate >= @LastProc_Date                      
                     And Processdate <= @LastProc_Date + ' 23:59:59'                      
                     And Accno In ('1203320000000066', '1203320000000051')                      
                     And Pledge_qty <> 0                      
              Group  By Isin,Accno)A                      
             Full Outer Join(Select Isin,                      
    Accno=Pledgor_bo_id,                      
                                    Actualpledge_qty=Sum(Pledg_qty)                      
                             From   #LAS_PLEDGE_REQUEST                      
                             Where  Pledgor_bo_id In ('1203320000000066', '1203320000000051')                      
                             Group  By Isin,Pledgor_bo_id) B                      
              On A.Isin = B.Isin              
                 And A.Accno = B.Accno                      
      Where  Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0) > 0                      
                      
      Select Row_num=Identity(Int, 1, 1),                      
             Isin,                      
             Pledgor_bo_id=Accno,                      
             Pledg_qty=Cast(Sum(Diffqty) As Int),                      
             Pledg_value=Cast (Sum(0)As Money)                      
Into   #LAS_PLEDGE_REQUEST_EXCESS                      
      From   #Adjustmentisinqty A(NOLOCK)                      
      Where  Accno In('1203320000000066', '1203320000000051')                      
      Group  By Isin,Accno                      
                  
      /*CHANGE ID  :: 1*/            
      Select Party_Code            
        INTO #WCL_CLIENTS            
      from MIS.DBO.WCL_ActionRpt1(convert(datetime,GETDATE(),103))            
      where BOI+YES+SCB+ADH+AXS <> 0.00             
                      
      Select a.*        
      Into   #Tbl_party_pledge_data_CR                      
      From   Tbl_party_pledge_data A(NOLOCK)             
                LEFT OUTER JOIN #WCL_CLIENTS B (NOLOCK)             
                    ON A.PARTY_CODE = B.PARTY_CODE            
      Where  Processdate >= @LastProc_Date                      
             And Processdate <= @LastProc_Date + ' 23:59:59'                      
             And Pledge_qty <> Qty                      
             --And Avg_closing > 0 --Comment on 25 Apr 2012                       
             And Pledge_qty = 0             
             And Accno In('1203320000000066', '1203320000000051')            
             /*CHANGE ID  :: 1*/            
             /*            
                This should be party_codes which were excluded in previous day process.            
                Store WCL LAS clients details in a table and use that table here            
             */            
             AND B.PARTY_CODE IS NULL            
             And Isin In (Select Isin                      
                          From   #LAS_PLEDGE_REQUEST_EXCESS)                      
                      
      Create Clustered Index [IX_LAS_PLEDGE_ROW_NUM]                      
       On #LAS_PLEDGE_REQUEST_EXCESS ( [Isin] Asc, [Row_num] Asc )                      
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                      
                      
      Create Clustered Index [IX_PARTY_PLEDGE_PARTYCODE_ISIN]                      
       On #Tbl_party_pledge_data_CR ( [Isin] Asc, [Party_code] Asc )                      
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                      
                      
      /*Declare @ISIN Varchar(20),                        
      @PLEDGOR_BOID Varchar(20),                        
      @PLEDG_QTY Int,                        
      @PLEDG_VALUE Money,                        
      @COUNTER Int                        
                              
      ----VARIABLE CLIENT LEVEL              
      Declare @ISIN_CLI Varchar(20),                        
      @PLEDGOR_BOID_CLI Varchar(20),                        
      @PLEDG_QTY_CLI Int,                        
      @DIFFPLEDG_QTY_CLI Int,                        
    @PLEDG_VALUE_CLI Money,                        
      @COUNTER_CLI Int,                        
      @PARTY_CODE Varchar(20),                        
      @SCRIP_PRIORITY_CLI Int*/                      
                      
      Set @ISIN=''                      
                      
      Set @PLEDGOR_BOID=''                 
                      
      Set @PLEDG_QTY=0                      
                      
      Set @PLEDG_VALUE =0                      
                      
      Set @COUNTER=0                      
                      
      Set @ISIN_CLI=''                      
                      
      Set @PLEDGOR_BOID_CLI=''                      
                      
      Set @PLEDG_QTY_CLI=0                      
                      
      Set @PLEDG_VALUE_CLI =0                  
                      
      Set @DIFFPLEDG_QTY_CLI=0                      
                      
      Set @PLEDG_VALUE_CLI=0                      
                      
      Set @PARTY_CODE=''                      
                      
      Set @SCRIP_PRIORITY_CLI=0                      
                      
      Set @COUNTER_CLI=0                      
                      
      Select @COUNTER = Max(Row_num)                      
      From   #LAS_PLEDGE_REQUEST_EXCESS                      
                      
      While @COUNTER > 0                      
      Begin                      
         Select @ISIN = Isin,                      
                @PLEDGOR_BOID = Pledgor_bo_id,                      
                @PLEDG_QTY = Pledg_qty,                      
                @PLEDG_VALUE = Pledg_value                      
        From   #LAS_PLEDGE_REQUEST_EXCESS                      
         Where  Row_num = @COUNTER                      
                      
         --Print 'TOATL: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                        
                      
         Select Row_num=Identity(Int, 1, 1),                      
                Isin,                      
                Accno,                      
                Scrip_cd,                      
                Party_code,                      
                Qty,                      
                Actual_pledgeqty=0,                      
                Scrip_priority,                      
                Client_priority                      
         Into   #PARTY_PLEDGE_CR                    
         From   #Tbl_party_pledge_data_CR                      
         Where  Isin = @ISIN                      
                And Accno = @PLEDGOR_BOID                      
         Order  By Client_priority Desc,Ledger_bal--Hold_value--LEDGER_BAL                        
                      
         Select @COUNTER_CLI = Max(Row_num)                      
         From   #PARTY_PLEDGE_CR                      
                      
         While @COUNTER_CLI > 0                      
         Begin                      
            --Print 'TOATL DIFF: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                        
                      
            Select @PLEDGOR_BOID_CLI = Accno,                      
                   @PARTY_CODE = Party_code,                      
                   @PLEDG_QTY_CLI = Qty,                      
                   @SCRIP_PRIORITY_Cli = Scrip_priority,                      
                   @Isin_CLI = Isin                      
            From   #PARTY_PLEDGE_CR                      
            Where  Row_num = @COUNTER_CLI                      
                      
            --Print 'CLIENT TOATL: ' + @PARTY_CODE + ' ' + Cast(@PLEDG_QTY_CLI As Varchar)                        
                      
            If @PLEDG_QTY > 0                      
            Begin                      
              If @PLEDG_QTY_CLI < @PLEDG_QTY                      
               Begin                      
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                      
                      
                  --Print 'REMAINING :' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                        
                      
                  Update #PARTY_PLEDGE_CR                      
                  Set    Actual_pledgeqty = @PLEDG_QTY_CLI                      
                  Where  Party_code = @PARTY_CODE                      
                         And Accno = @PLEDGOR_BOID_CLI                      
                         And Row_num = @COUNTER_CLI                      
           And Isin = @Isin_CLI                      
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                      
                      
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                      
               End                      
               Else If @PLEDG_QTY_CLI >= @PLEDG_QTY                      
               Begin                      
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                      
                      
                  --Print 'REMAINING B:' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                        
                      
                  Update #PARTY_PLEDGE_CR                      
                  Set    Actual_pledgeqty = @PLEDG_QTY                      
                  Where  Party_code = @PARTY_CODE                      
                         And Accno = @PLEDGOR_BOID_CLI                      
                         And Row_num = @COUNTER_CLI                      
                         And Isin = @Isin                      
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                      
                      
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                      
                      
               --BREAK                        
               End                      
            End                      
                      
            Set @COUNTER_CLI=@COUNTER_CLI - 1                      
         End                      
                      
         Update A                      
         Set    A.Pledge_qty = B.Actual_pledgeqty                      
         From #Tbl_party_pledge_data_CR A                      
                Inner Join #PARTY_PLEDGE_CR B                      
                 On A.Party_code = B.Party_code                      
                    And A.Isin = B.Isin                      
                    And A.Scrip_cd = B.Scrip_cd                      
                    And A.Accno = B.Accno                      
                    And A.Scrip_priority = B.Scrip_priority                      
                    And A.Client_priority = B.Client_priority                      
         Where  Processdate >= @LastProc_Date                      
                And Processdate <= @LastProc_Date + ' 23:59:59'                      
                And A.Pledge_qty <> A.Qty                      
                      
         Drop Table #PARTY_PLEDGE_CR                      
                      
         Set @COUNTER=@COUNTER - 1            
                      
      End                      
                      
      --Print '********End While Reallocation Excess Pleqdge Qty**********'                        
                      
      Update A                      
      Set    A.Pledge_qty = B.Pledge_qty                      
      --A.Scrip_priority = 0                        
      From   Tbl_party_pledge_data A                      
             Inner Join #Tbl_party_pledge_data_CR B                      
              On A.Party_code = B.Party_code                      
                 And A.Isin = B.Isin                      
                 And A.Accno = B.Accno                      
                 And A.Scrip_cd = B.Scrip_cd                      
 And A.Qty = B.Qty                      
                 And A.Scrip_priority = B.Scrip_priority                      
                 And A.Client_priority = B.Client_priority                      
      Where  A.Processdate >= @LastProc_Date                      
    And A.Processdate <= @LastProc_Date + ' 23:59:59'                      
             And A.Pledge_qty <> A.Qty                      
             And A.Pledge_qty = 0                      
             And B.Pledge_qty <> 0                      
             And A.Isin In (Select Isin                      
                            From   #LAS_PLEDGE_REQUEST_EXCESS)                      
                      
      --drop table #AdjustmentISINQty_Cr                        
      Select Isin=Isnull(A.Isin, B.Isin),                      
             Accno=Isnull(A.Accno, B.Accno),                    
             Diffqty=Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0),                      
             Avg_closing=Convert(Money, 0),                      
             Scrip_cd=Space(50),                      
             Scripname=Space(50)                      
      Into   #AdjustmentISINQty_Cr                      
      From   (Select Isin,                      
                     Accno,                      
                     Pledge_qty=Sum(Pledge_qty)                      
              From   Tbl_party_pledge_data (nolock)                      
              Where  Processdate >= @LastProc_Date                      
                     And Processdate <= @LastProc_Date + ' 23:59:59'                      
                     And Accno In ('1203320000000066', '1203320000000051')                      
              Group  By Isin,Accno)A                      
             Full Outer Join(Select Isin,                      
                                    Accno=Pledgor_bo_id,                      
                                    Actualpledge_qty=Sum(Pledg_qty)                      
                             From   #LAS_PLEDGE_REQUEST                      
                             Where  Pledgor_bo_id In ('1203320000000066', '1203320000000051')                      
                             Group  By Isin,Pledgor_bo_id) B                      
              On A.Isin = B.Isin                      
                 And A.Accno = B.Accno                      
      Where  Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0) <> 0                      
                      
      Update #AdjustmentISINQty_Cr                      
      Set    Avg_closing = A.Clsrate,                      
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                      
             #adjustmentisinqty_cr.Scripname = A.Scripname                      
      From   (Select *                      
              From   Vw_equity_cls_rate (nolock)) A                      
      Where  #adjustmentisinqty_cr.Isin = A.Isin                      
             And #adjustmentisinqty_cr.Accno = A.Accno                  
                      
      Update #AdjustmentISINQty_Cr                      
      Set    Avg_closing = A.Clsrate,                      
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                      
             #adjustmentisinqty_cr.Scripname = A.Scripname                      
      From   (Select *                      
              From   Vw_equity_cls_rate (nolock)                
              Where Accno in('1203320000000066')) A                      
      Where  #adjustmentisinqty_cr.Isin = A.Isin                 
             And #adjustmentisinqty_cr.Accno = '1203320000000051'                 
                      
       Update #AdjustmentISINQty_Cr                      
      Set    Avg_closing = A.Clsrate,                      
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                      
             #adjustmentisinqty_cr.Scripname = A.Scripname                      
      From   (Select *                      
              From   Vw_equity_cls_rate (nolock)                
              Where Accno in('1203320000000051')) A                      
      Where  #adjustmentisinqty_cr.Isin = A.Isin                      
             And #adjustmentisinqty_cr.Accno = '1203320000000066'                 
                      
      Declare @Rms_Date Datetime                      
                      
      Select @Rms_Date = Max(Rms_date)                      
      From   Tbl_party_pledge_data                      
                      
      Insert Into Tbl_party_pledge_data                      
      Select Rms_date=@Rms_Date,                      
             Party_code='Unknown',                      
             Ledger_bal=0,                      
             Client_priority=1,                      
             Isin,                      
             Scrip_cd,                      
             Scripname,                      
             Accno,                      
             Qty=0,          
             Pledge_qty=0,                      
           Free_qty=0,                      
             Hold_value=0,                      
             Avg_closing,                      
             Pledgeable_qty=0,                      
             Pledgeable_value=0,                      
             Prevdaypledgeqty=0,                      
             Release_qty=Diffqty,                      
             Scrip_priority=0,                      
             @LastProc_Date,                      
             'System'                      
      From   #AdjustmentISINQty_Cr                      
                      
   ---Checking Ploting release Qty And Pldge Qty                        
   /*Select a.*,b.*                        
   from                        
   (Select accno,isin,AQty=Sum(PLEDGE_QTY)+Sum(Release_qty) from                        
   ----#Tbl_party_pledge_data                        
   Tbl_party_pledge_data                        
   where Processdate >= Convert(Varchar, Getdate()-1, 106)                        
   And Processdate <= Convert(Varchar, Getdate()-1, 106) + ' 23:59:59'                        
   and accno in ('1203320000000066','1203320000000051')                        
   --and isin='INE209L01016'                        
   --order by party_code                        
   group by accno,isin) a                        
   inner join                        
   (Select Clientid,isin,BQty=Sum(pledgeQty)-Sum(unpledgeQty) from mis.demat.dbo.Pledge2ReleaseEntry a(NOLOCK)                        
   where Clientid in ('1203320000000066','1203320000000051')                        
   --and isin='INE209L01016'                        
   group by Clientid,isin) b                        
   on b.Clientid=a.accno                        
   and b.isin=a.isin                        
   where AQty<>BQty                        
   */                      
   End                      
                      
   Set nocount Off                      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_LAS_PLEDGE_REALLOCATION_CLI_30082013
-- --------------------------------------------------
/*      
    CHANGE ID  :: 1      
    MODIFIED BY  :: PRASHANT      
    MODIFIED DATE :: AUG 03 2013      
    REASON   :: RELEASE PLEDGE SHARES OF WCL CLIENT WHILE REALLOCATING PREVIOUS DAY SHARES      
    REQUEST FROM :: RAHUL SIR      
    PRMS ID   :: NONE      
          
    CHANGE ID  :: 2      
    MODIFIED BY  :: PRASHANT      
    MODIFIED DATE :: AUG 03 2013      
    REASON   :: CALL WCL PROCESS BEFORE PLEDGE PROCESS      
    REQUEST FROM :: RAHUL SIR      
    PRMS ID   :: NONE      
*/      
CREATE Procedure USP_LAS_PLEDGE_REALLOCATION_CLI_30082013
As      
Begin      
   --Drop Table #LAS_PLEDGE_REQUEST                  
   -----****Satart Allocation Pledgeable Qty      
   Set nocount On      
         
   If Not Exists (Select Hdate      
                  From   [196.1.115.239].harmony.DBO.Holimst A(nolock)      
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))      
   Begin      
         
      /*CHANGE ID  :: 2*/      
      exec MIS.DBO.Upd_WCL      
         
      Declare @LastProc_Date As Datetime                
                
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)                
      From   Tbl_party_pledge_data (nolock)                
                
      Select Row_num=Identity(Int, 1, 1),                
             Isin,                
             Pledgor_bo_id=Clientid,                
             Pledg_qty=Cast(Sum(Pledgeqty - Unpledgeqty) As Int),                
             Pledg_value=Cast (Sum(0)As Money)                
      Into   #LAS_PLEDGE_REQUEST                
      From   mis.demat.dbo.Pledge2releaseentry A(NOLOCK)                
      Where  Clientid In('1203320000000066', '1203320000000051')                
      Group  By Isin,Clientid                
                
      --Drop Table #Tbl_party_pledge_data                  
                
      Select *                
      Into   #Tbl_party_pledge_data                
      From   Tbl_party_pledge_data (nolock)                
      Where  Processdate >= @LastProc_Date                
             And Processdate <= @LastProc_Date + ' 23:59:59'                
             And Client_priority = 1                
             And Qty > 0                
             --And Avg_closing > 0 --Comment on 25 Apr 2012             
             And Accno In('1203320000000066', '1203320000000051')                
                
      Create Clustered Index [IX_LAS_PLEDGE_ROW_NUM]                
       On #LAS_PLEDGE_REQUEST ( [Isin] Asc, [Row_num] Asc )                
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                
                
      Create Clustered Index [IX_PARTY_PLEDGE_PARTYCODE_ISIN]                
       On #TBL_PARTY_PLEDGE_DATA ( [Isin] Asc, [Party_code] Asc )                
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                
                
      Declare @ISIN         Varchar(20),                
              @PLEDGOR_BOID Varchar(20),                
              @PLEDG_QTY    Int,                
              @PLEDG_VALUE  Money,                
              @COUNTER      Int                
                
      ----VARIABLE CLIENT LEVEL                  
      Declare @ISIN_CLI           Varchar(20),                
              @PLEDGOR_BOID_CLI   Varchar(20),                
              @PLEDG_QTY_CLI      Int,                
              @DIFFPLEDG_QTY_CLI  Int,                
              @PLEDG_VALUE_CLI    Money,                
              @COUNTER_CLI        Int,                
              @PARTY_CODE         Varchar(20),                
              @SCRIP_PRIORITY_CLI Int                
                
      Select @COUNTER = Max(Row_num)                
      From   #LAS_PLEDGE_REQUEST                
                
      While @COUNTER > 0                
      Begin                
         Select @ISIN = Isin,                
                @PLEDGOR_BOID = Pledgor_bo_id,                
                @PLEDG_QTY = Pledg_qty,                
                @PLEDG_VALUE = Pledg_value                
         From   #LAS_PLEDGE_REQUEST                
         Where  Row_num = @COUNTER                
                
         --Print 'TOATL: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                  
                
         Select Row_num=Identity(Int, 1, 1),                
                Isin,                
                Accno,                
                Scrip_cd,                
                Party_code,                
                Qty,                
                Actual_pledgeqty=0,                
                Scrip_priority                
         Into   #PARTY_PLEDGE                
         From   #Tbl_party_pledge_data                
         Where  Isin = @ISIN                
                And Accno = @PLEDGOR_BOID                
         Order  By Scrip_priority Desc,Ledger_bal--Hold_value--LEDGER_BAL                  
                
         Select @COUNTER_CLI = Max(Row_num)                
         From   #PARTY_PLEDGE                
                
         While @COUNTER_CLI > 0                
         Begin                
            --Print 'TOATL DIFF: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                  
                
            Select @PLEDGOR_BOID_CLI = Accno,                
               @PARTY_CODE = Party_code,                
                   @PLEDG_QTY_CLI = Qty,                
                   @SCRIP_PRIORITY_Cli = Scrip_priority,                
                   @ISIN_Cli = Isin                
            From   #PARTY_PLEDGE                
            Where  Row_num = @COUNTER_CLI                
                
            --Print 'CLIENT TOATL: ' + @PARTY_CODE + ' ' + Cast(@PLEDG_QTY_CLI As Varchar)                  
                
            If @PLEDG_QTY > 0                
            Begin                
              If @PLEDG_QTY_CLI < @PLEDG_QTY                
               Begin                
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                
                
                  --Print 'REMAINING :' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                  
                
                  Update #PARTY_PLEDGE                
                  Set    Actual_pledgeqty = @PLEDG_QTY_CLI                
                  Where  Party_code = @PARTY_CODE                
                         And Accno = @PLEDGOR_BOID_CLI                
                         And Row_num = @COUNTER_CLI                
                         And Isin = @Isin                
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                
                
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                
               End                
               Else If @PLEDG_QTY_CLI >= @PLEDG_QTY                
               Begin                
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                
                
                  --Print 'REMAINING B:' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                  
                
                  Update #PARTY_PLEDGE                
                  Set    Actual_pledgeqty = @PLEDG_QTY                
                  Where  Party_code = @PARTY_CODE                
                         And Accno = @PLEDGOR_BOID_CLI                
                         And Row_num = @COUNTER_CLI                
                         And Isin = @ISIN_Cli                
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                
                
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                
               --BREAK                  
               End                
            End                
                
            Set @COUNTER_CLI=@COUNTER_CLI - 1                
         End                
  
         Update A                
         Set    A.Pledge_qty = B.Actual_pledgeqty                
         From   #Tbl_party_pledge_data A                
                Inner Join #PARTY_PLEDGE B                
                 On A.Party_code = B.Party_code                
                    And A.Isin = B.Isin                
        And A.Scrip_cd = B.Scrip_cd                
                    And A.Accno = B.Accno                
                    And A.Scrip_priority = B.Scrip_priority                
         Where  Processdate >= @LastProc_Date                
                And Processdate <= @LastProc_Date + ' 23:59:59'                
                And A.Client_priority = 1                
                
         Drop Table #PARTY_PLEDGE                
                
         Set @COUNTER=@COUNTER - 1                
                
      End                
                
      --Print '********End While Reallocation Pleqdgeable Qty**********'                  
                
      Update A                
      Set    A.Pledge_qty = B.Pledge_qty                
      From   Tbl_party_pledge_data A                
             Inner Join #Tbl_party_pledge_data B                
              On A.Party_code = B.Party_code                
                 And A.Isin = B.Isin                
                 And A.Accno = B.Accno                
                 And A.Scrip_cd = B.Scrip_cd                
                 And A.Qty = B.Qty                
                 And A.Scrip_priority = B.Scrip_priority                
                 And A.Client_priority = B.Client_priority                
      Where  A.Processdate >= @LastProc_Date                
             And A.Processdate <= @LastProc_Date + ' 23:59:59'                
             And A.Client_priority = 1                
                
      -----****End Allocation Pledgeable Qty                  
                
      ---------------****Adjust Extra Pledge Qty Against Creditor and Not Pledgeable clienct stock                  
      --drop table #Adjustmentisinqty                  
      Select Isin=Isnull(A.Isin, B.Isin),                
             Accno=Isnull(A.Accno, B.Accno),                
             Diffqty=Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0),                
             Avg_closing=Convert(Money, 0),                
             Scrip_cd=Space(50),                
             Scripname=Space(50)                
      Into   #AdjustmentISINQty                
      From   (Select Isin,                
                     Accno,                
                     Pledge_qty=Sum(Pledge_qty)                
              From   Tbl_party_pledge_data                
              Where  Processdate >= @LastProc_Date                
                     And Processdate <= @LastProc_Date + ' 23:59:59'                
                     And Accno In ('1203320000000066', '1203320000000051')                
                     And Pledge_qty <> 0                
              Group  By Isin,Accno)A                
             Full Outer Join(Select Isin,                
                                    Accno=Pledgor_bo_id,                
                                    Actualpledge_qty=Sum(Pledg_qty)                
                             From   #LAS_PLEDGE_REQUEST                
                             Where  Pledgor_bo_id In ('1203320000000066', '1203320000000051')                
                             Group  By Isin,Pledgor_bo_id) B                
              On A.Isin = B.Isin                
                 And A.Accno = B.Accno                
      Where  Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0) > 0                
                
      Select Row_num=Identity(Int, 1, 1),                
             Isin,                
             Pledgor_bo_id=Accno,                
             Pledg_qty=Cast(Sum(Diffqty) As Int),                
             Pledg_value=Cast (Sum(0)As Money)                
Into   #LAS_PLEDGE_REQUEST_EXCESS                
      From   #Adjustmentisinqty A(NOLOCK)                
      Where  Accno In('1203320000000066', '1203320000000051')                
      Group  By Isin,Accno                
            
      /*CHANGE ID  :: 1*/      
      Select Party_Code      
        INTO #WCL_CLIENTS      
      from MIS.DBO.WCL_ActionRpt1(convert(datetime,GETDATE(),103))      
      where BOI+YES+SCB+ADH+AXS <> 0.00       
                
      Select a.*  
      Into   #Tbl_party_pledge_data_CR                
      From   Tbl_party_pledge_data A(NOLOCK)       
                LEFT OUTER JOIN #WCL_CLIENTS B (NOLOCK)       
                    ON A.PARTY_CODE = B.PARTY_CODE      
      Where  Processdate >= @LastProc_Date                
             And Processdate <= @LastProc_Date + ' 23:59:59'                
             And Pledge_qty <> Qty                
             --And Avg_closing > 0 --Comment on 25 Apr 2012                 
             And Pledge_qty = 0       
             And Accno In('1203320000000066', '1203320000000051')      
             /*CHANGE ID  :: 1*/      
             /*      
                This should be party_codes which were excluded in previous day process.      
                Store WCL LAS clients details in a table and use that table here      
             */      
             AND B.PARTY_CODE IS NULL      
             And Isin In (Select Isin                
                          From   #LAS_PLEDGE_REQUEST_EXCESS)                
                
      Create Clustered Index [IX_LAS_PLEDGE_ROW_NUM]                
       On #LAS_PLEDGE_REQUEST_EXCESS ( [Isin] Asc, [Row_num] Asc )                
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                
                
      Create Clustered Index [IX_PARTY_PLEDGE_PARTYCODE_ISIN]                
       On #Tbl_party_pledge_data_CR ( [Isin] Asc, [Party_code] Asc )                
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off) On [PRIMARY]                
                
      /*Declare @ISIN Varchar(20),                  
      @PLEDGOR_BOID Varchar(20),                  
      @PLEDG_QTY Int,                  
      @PLEDG_VALUE Money,                  
      @COUNTER Int                  
                        
      ----VARIABLE CLIENT LEVEL                  
      Declare @ISIN_CLI Varchar(20),                  
      @PLEDGOR_BOID_CLI Varchar(20),                  
      @PLEDG_QTY_CLI Int,                  
      @DIFFPLEDG_QTY_CLI Int,                  
    @PLEDG_VALUE_CLI Money,                  
      @COUNTER_CLI Int,                  
      @PARTY_CODE Varchar(20),                  
      @SCRIP_PRIORITY_CLI Int*/                
                
      Set @ISIN=''                
                
      Set @PLEDGOR_BOID=''                
                
      Set @PLEDG_QTY=0                
                
      Set @PLEDG_VALUE =0                
                
      Set @COUNTER=0                
                
      Set @ISIN_CLI=''                
                
      Set @PLEDGOR_BOID_CLI=''                
                
      Set @PLEDG_QTY_CLI=0                
                
      Set @PLEDG_VALUE_CLI =0            
                
      Set @DIFFPLEDG_QTY_CLI=0                
                
      Set @PLEDG_VALUE_CLI=0                
                
      Set @PARTY_CODE=''                
                
      Set @SCRIP_PRIORITY_CLI=0                
                
      Set @COUNTER_CLI=0                
                
      Select @COUNTER = Max(Row_num)                
      From   #LAS_PLEDGE_REQUEST_EXCESS                
                
      While @COUNTER > 0                
      Begin                
         Select @ISIN = Isin,                
                @PLEDGOR_BOID = Pledgor_bo_id,                
                @PLEDG_QTY = Pledg_qty,                
                @PLEDG_VALUE = Pledg_value                
        From   #LAS_PLEDGE_REQUEST_EXCESS                
         Where  Row_num = @COUNTER                
                
         --Print 'TOATL: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                  
                
         Select Row_num=Identity(Int, 1, 1),                
                Isin,                
                Accno,                
                Scrip_cd,                
                Party_code,                
                Qty,                
                Actual_pledgeqty=0,                
                Scrip_priority,                
                Client_priority                
         Into   #PARTY_PLEDGE_CR              
         From   #Tbl_party_pledge_data_CR                
         Where  Isin = @ISIN                
                And Accno = @PLEDGOR_BOID                
         Order  By Client_priority Desc,Ledger_bal--Hold_value--LEDGER_BAL                  
                
         Select @COUNTER_CLI = Max(Row_num)                
         From   #PARTY_PLEDGE_CR                
                
         While @COUNTER_CLI > 0                
         Begin                
            --Print 'TOATL DIFF: ' + @ISIN + ':' + Cast(@PLEDG_QTY As Varchar)                  
                
            Select @PLEDGOR_BOID_CLI = Accno,                
                   @PARTY_CODE = Party_code,                
                   @PLEDG_QTY_CLI = Qty,                
                   @SCRIP_PRIORITY_Cli = Scrip_priority,                
                   @Isin_CLI = Isin                
            From   #PARTY_PLEDGE_CR                
            Where  Row_num = @COUNTER_CLI                
                
            --Print 'CLIENT TOATL: ' + @PARTY_CODE + ' ' + Cast(@PLEDG_QTY_CLI As Varchar)                  
                
            If @PLEDG_QTY > 0                
            Begin                
               If @PLEDG_QTY_CLI < @PLEDG_QTY                
               Begin                
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                
                
                  --Print 'REMAINING :' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                  
                
                  Update #PARTY_PLEDGE_CR                
                  Set    Actual_pledgeqty = @PLEDG_QTY_CLI                
                  Where  Party_code = @PARTY_CODE                
                         And Accno = @PLEDGOR_BOID_CLI                
                         And Row_num = @COUNTER_CLI                
                         And Isin = @Isin_CLI                
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                
                
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                
               End                
               Else If @PLEDG_QTY_CLI >= @PLEDG_QTY                
               Begin                
                  Set @DIFFPLEDG_QTY_CLI=@PLEDG_QTY - @PLEDG_QTY_CLI                
                
                  --Print 'REMAINING B:' + Cast (@DIFFPLEDG_QTY_CLI As Varchar)                  
                
                  Update #PARTY_PLEDGE_CR                
                  Set    Actual_pledgeqty = @PLEDG_QTY                
                  Where  Party_code = @PARTY_CODE                
                         And Accno = @PLEDGOR_BOID_CLI                
                         And Row_num = @COUNTER_CLI                
                         And Isin = @Isin                
                         And Scrip_priority = @SCRIP_PRIORITY_Cli                
                
                  Set @PLEDG_QTY=@DIFFPLEDG_QTY_CLI                
                
               --BREAK                  
               End                
            End                
                
            Set @COUNTER_CLI=@COUNTER_CLI - 1                
         End                
                
         Update A                
         Set    A.Pledge_qty = B.Actual_pledgeqty                
         From #Tbl_party_pledge_data_CR A                
                Inner Join #PARTY_PLEDGE_CR B                
                 On A.Party_code = B.Party_code                
                    And A.Isin = B.Isin                
                    And A.Scrip_cd = B.Scrip_cd                
                    And A.Accno = B.Accno                
                    And A.Scrip_priority = B.Scrip_priority                
                    And A.Client_priority = B.Client_priority                
         Where  Processdate >= @LastProc_Date                
                And Processdate <= @LastProc_Date + ' 23:59:59'                
                And A.Pledge_qty <> A.Qty                
                
         Drop Table #PARTY_PLEDGE_CR                
                
         Set @COUNTER=@COUNTER - 1      
                
      End                
                
      --Print '********End While Reallocation Excess Pleqdge Qty**********'                  
                
      Update A                
      Set    A.Pledge_qty = B.Pledge_qty                
      --A.Scrip_priority = 0                  
      From   Tbl_party_pledge_data A                
             Inner Join #Tbl_party_pledge_data_CR B                
              On A.Party_code = B.Party_code                
                 And A.Isin = B.Isin                
                 And A.Accno = B.Accno                
                 And A.Scrip_cd = B.Scrip_cd                
                 And A.Qty = B.Qty                
                 And A.Scrip_priority = B.Scrip_priority                
                 And A.Client_priority = B.Client_priority                
      Where  A.Processdate >= @LastProc_Date                
    And A.Processdate <= @LastProc_Date + ' 23:59:59'                
             And A.Pledge_qty <> A.Qty                
             And A.Pledge_qty = 0                
             And B.Pledge_qty <> 0                
             And A.Isin In (Select Isin                
                            From   #LAS_PLEDGE_REQUEST_EXCESS)                
                
      --drop table #AdjustmentISINQty_Cr                  
      Select Isin=Isnull(A.Isin, B.Isin),                
             Accno=Isnull(A.Accno, B.Accno),                
             Diffqty=Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0),                
             Avg_closing=Convert(Money, 0),                
             Scrip_cd=Space(50),                
             Scripname=Space(50)                
      Into   #AdjustmentISINQty_Cr                
      From   (Select Isin,                
                     Accno,                
                     Pledge_qty=Sum(Pledge_qty)                
              From   Tbl_party_pledge_data (nolock)                
              Where  Processdate >= @LastProc_Date                
                     And Processdate <= @LastProc_Date + ' 23:59:59'                
                     And Accno In ('1203320000000066', '1203320000000051')                
              Group  By Isin,Accno)A                
             Full Outer Join(Select Isin,                
                                    Accno=Pledgor_bo_id,                
                                    Actualpledge_qty=Sum(Pledg_qty)                
                             From   #LAS_PLEDGE_REQUEST                
                             Where  Pledgor_bo_id In ('1203320000000066', '1203320000000051')                
                             Group  By Isin,Pledgor_bo_id) B                
              On A.Isin = B.Isin                
                 And A.Accno = B.Accno                
      Where  Isnull(B.Actualpledge_qty, 0) - Isnull(A.Pledge_qty, 0) <> 0                
                
      Update #AdjustmentISINQty_Cr                
      Set    Avg_closing = A.Clsrate,                
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                
             #adjustmentisinqty_cr.Scripname = A.Scripname                
      From   (Select *                
              From   Vw_equity_cls_rate (nolock)) A                
      Where  #adjustmentisinqty_cr.Isin = A.Isin                
             And #adjustmentisinqty_cr.Accno = A.Accno            
                
      Update #AdjustmentISINQty_Cr                
      Set    Avg_closing = A.Clsrate,                
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                
             #adjustmentisinqty_cr.Scripname = A.Scripname                
      From   (Select *                
              From   Vw_equity_cls_rate (nolock)          
              Where Accno in('1203320000000066')) A                
      Where  #adjustmentisinqty_cr.Isin = A.Isin           
             And #adjustmentisinqty_cr.Accno = '1203320000000051'           
                
       Update #AdjustmentISINQty_Cr                
      Set    Avg_closing = A.Clsrate,                
             #adjustmentisinqty_cr.Scrip_cd = A.Scrip_cd,                
             #adjustmentisinqty_cr.Scripname = A.Scripname                
      From   (Select *                
              From   Vw_equity_cls_rate (nolock)          
              Where Accno in('1203320000000051')) A                
      Where  #adjustmentisinqty_cr.Isin = A.Isin                
             And #adjustmentisinqty_cr.Accno = '1203320000000066'           
                
      Declare @Rms_Date Datetime                
                
      Select @Rms_Date = Max(Rms_date)                
      From   Tbl_party_pledge_data                
                
      Insert Into Tbl_party_pledge_data                
      Select Rms_date=@Rms_Date,                
             Party_code='Unknown',                
             Ledger_bal=0,                
             Client_priority=1,                
             Isin,                
             Scrip_cd,                
             Scripname,                
             Accno,                
             Qty=0,                
             Pledge_qty=0,                
           Free_qty=0,                
             Hold_value=0,                
             Avg_closing,                
             Pledgeable_qty=0,                
             Pledgeable_value=0,                
             Prevdaypledgeqty=0,                
             Release_qty=Diffqty,                
             Scrip_priority=0,                
             @LastProc_Date,                
             'System'                
      From   #AdjustmentISINQty_Cr                
                
   ---Checking Ploting release Qty And Pldge Qty                  
   /*Select a.*,b.*                  
   from                  
   (Select accno,isin,AQty=Sum(PLEDGE_QTY)+Sum(Release_qty) from                  
   ----#Tbl_party_pledge_data                  
   Tbl_party_pledge_data                  
   where Processdate >= Convert(Varchar, Getdate()-1, 106)                  
   And Processdate <= Convert(Varchar, Getdate()-1, 106) + ' 23:59:59'                  
   and accno in ('1203320000000066','1203320000000051')                  
   --and isin='INE209L01016'                  
   --order by party_code                  
   group by accno,isin) a                  
   inner join                  
   (Select Clientid,isin,BQty=Sum(pledgeQty)-Sum(unpledgeQty) from mis.demat.dbo.Pledge2ReleaseEntry a(NOLOCK)                  
   where Clientid in ('1203320000000066','1203320000000051')                  
   --and isin='INE209L01016'                  
   group by Clientid,isin) b                  
   on b.Clientid=a.accno                  
   and b.isin=a.isin                  
   where AQty<>BQty                  
   */                
   End                
                
   Set nocount Off                
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_LAS_PLEDGE_UNPLEDGE_AlertMail
-- --------------------------------------------------
CREATE Procedure USP_LAS_PLEDGE_UNPLEDGE_AlertMail        
as        
begin   
 If Not Exists  
        (Select Hdate  
         From   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)  
         Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime,  
                                                                  Convert(Varchar, Getdate(  
                                                                  ),  
                                                                  106)))  
 Begin       
declare @sub varchar(75)      
    
Declare @StrTo as nvarchar(max)              
select distinct @StrTo=              
replace(replace(              
( select replace (ltrim(rtrim(email)), ' ', '~') as [data()]              
from intranet.misc.dbo.global_email x With(nolock)             
where ActiveStatus='Active' and recipientstatus='TO' and moduleName='USP_LAS_PLEDGE_UNPLEDGE_AlertMail'              
for xml path ('')              
), ' ', ';'), '~', ' ')              
            
from intranet.misc.dbo.global_email a With(nolock)     
    
Declare @StrCC as nvarchar(max)              
select distinct @StrCC=              
replace(replace(              
( select replace (ltrim(rtrim(email)), ' ', '~') as [data()]              
from intranet.misc.dbo.global_email x With(nolock)             
where ActiveStatus='Active' and recipientstatus='CC' and moduleName='USP_LAS_PLEDGE_UNPLEDGE_AlertMail'              
for xml path ('')              
), ' ', ';'), '~', ' ')     
from intranet.misc.dbo.global_email a With(nolock)     
    
    
Declare @StrBCC as nvarchar(max)              
select distinct @StrBCC=              
replace(replace(              
( select replace (ltrim(rtrim(email)), ' ', '~') as [data()]              
from intranet.misc.dbo.global_email x With(nolock)             
where ActiveStatus='Active' and recipientstatus='BCC' and moduleName='USP_LAS_PLEDGE_UNPLEDGE_AlertMail'              
for xml path ('')              
), ' ', ';'), '~', ' ')      
from intranet.misc.dbo.global_email a With(nolock)     
      
declare @mailitem_id int        
set @sub= 'Pledge Process Information'        
exec intranet.msdb.dbo.sp_send_dbmail        
@profile_name = 'intranet',        
@recipients=@StrTo, --'pledge@angelbroking.com;bharti@angelbroking.com;anil.wandre@angelbroking.com;pradnya.kadam@angelbroking.com;bipin.veliyam@angelbroking.com;',        
@body = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pledge Process Completed.',        
@blind_copy_recipients =@StrBCC, --'amit.gupta@angelbroking.com;shweta.tiwari@angelbroking.com;',    
@copy_recipients = @StrCC,       
@body_format = 'html',        
@subject = @sub,        
@mailitem_id = @mailitem_id output        
end    
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_unpledge_allocation
-- --------------------------------------------------
CREATE Procedure [dbo].[Usp_las_pledge_unpledge_allocation]     
(    
 @USERNAME Varchar(10)    
)    
As    
Begin    
   ----***************PLEDGE AND UNPLEDGE PROCESS START****---    
   Set NOCOUNT On    
	
   --If Not Exists (Select Hdate    
   --               From   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)    
   --               Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))    
   --Begin    
   
	Declare @LastProc_Date As Datetime    
    
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)    
      From   Tbl_party_pledge_data With(nolock)    
    
      /*COMMON VARIABLES*/    
      Declare @AGREEMENT_NO      As Varchar(30),    
              @BANK_CODE         As Int,    
              @BANK_CTR          As Int,    
              @BANK_TOTAL        As Int,    
              @CHECK_LEFT_QTY    As Int,    
              @CLSRATE           As Money,    
              @CNT_UNPLEDGE_BANK As Int,    
              @CNT_UNPLEDGE_ISIN As Int,    
              @CTR_UNPLEDGE_BANK As Int,    
              @CTR_UNPLEDGE_ISIN As Int,    
              @ISIN              As Varchar(20),    
              @PLEDGE_CNT        As Int,    
              @PLEDGE_CTR        As Int,    
              @PLEDGE_NO         As Varchar(30),    
              @PLEDGE_VALUE      As Money,    
              @PLEDGEE_BO_ID     As Varchar(30),    
              @PLEDGOR_BO_ID     As Varchar(30),    
              @PRIORITY          As Int,    
              @QTY               As Int,    
              @REQUIREMENT       As Money,    
              @ROW_NUM           As Int,    
              @UNPLEGE_QTY       As Int,    
              @UNPLEGE_REQ       As Int,    
              @VALUE             As Money    
    
      Print 'LOADING HOLDING......'    
    
      Select *    
      Into   #Tbl_party_pledge_data    
      From   Tbl_party_pledge_data(nolock)    
      Where  Processdate >= @LastProc_Date    
             And Processdate <= @LastProc_Date + ' 23:59:59'    
    
      Select Isnull(A.Isin, B.Isin)                                                     As Isin,    
             Isnull(A.Accno, B.Accno)                                                   As Accno,    
             Isnull(A.Scrip_cd, B.Scrip_cd)                                             As Scrip_cd,    
             Isnull(B.Pledgeqty * B.Avg_closing, A.Prevday_pledege_qty * A.Avg_closing) As Total,    
             Isnull(B.Avg_closing, A.Avg_closing)                                       As Clsrate,    
             Isnull(B.Pledgeqty, 0) - Isnull(A.Prevday_pledege_qty, 0)                  As Qty,    
             Nse_approved = Convert(Varchar(2), '0'),    
             Priority = 1    
      Into   #HLD    
      From   (Select Accno,    
                     Isin,    
                     Scrip_cd,    
                     Prevday_pledege_qty=Sum(Prevday_pledege_qty),    
                     Avg_closing=Min(Avg_closing)    
              From   #Tbl_party_pledge_data (NOLOCK)    
              Group  By Accno,Isin,Scrip_cd    
              Having Sum(Prevday_pledege_qty) <> 0) A    
             Full Outer Join (Select Accno,    
                                     Isin,    
                                     Scrip_cd,    
                                     Pledgeqty=Sum(Qty),    
                                     Avg_closing=Min(Avg_closing)    
                              From   #Tbl_party_pledge_data (NOLOCK)    
                              Where  Client_priority = 1    
                              Group  By Accno,Isin,Scrip_cd)B    
              On A.Accno = B.Accno    
                 And A.Isin = B.Isin    
                 And A.Scrip_cd = B.Scrip_cd    
    
      Print 'MARKING APPROVED SCRIPS'    
    
      Update #HLD    
      Set    Nse_approved = 1    
      Where  Exists(Select A.Scode    
                    From   Vw_las_appr_bank_scrip A    
                    Where  #hld.Scrip_cd = A.Scode)    
    
      Select Accno,    
			 Isin,    
             Scrip_cd,    
             Qty=Sum(Qty),    
             Value=Sum(Total),    
             Clsrate=Min(Clsrate),    
             Pledge_qty=Convert(Int, 0),    
             Priority = Convert(Int, 0),    
             Client_priority = Priority,    
             Scrip_priority=Convert(Int, 0),    
             Row_num = Row_number() Over(PARTITION By Priority Order By Isin, Accno)    
      Into   #PLEDGABLE_STOCK    
      From   #HLD With (NOLOCK)    
      Where  Nse_approved <> 0    
             And Qty > 0    
      Group  By Accno,Scrip_cd,Isin,Priority    
      Order  By Accno,Scrip_cd    
    
      ----Added on 16-March-2012    
      -----Pledge Priority Common/uncommon Scrip    
      Update #PLEDGABLE_STOCK    
      Set    Scrip_priority = A.Scrip_priority    
      From   (Select Scode,    
                     Scrip_priority=Count(Scode)    
              From   Vw_las_appr_bank_scrip With (nolock)    
              Group  By Scode) A    
      Where  #pledgable_stock.Scrip_cd = A.Scode    
    
      --DROP TABLE #PLEDGABLE_STOCK    
      Print 'FETCHING DP37 DATA'    
    
   /*START*/    
   /*    
   SELECT SUM(PLEDGE_QTY) AS PLEDGE_QTY,SUM(TOTAL_UNPLEDGE_QTY) AS TOTAL_UNPLEDGE_QTY,    
   SUM(PLEDGE_QTY)-SUM(TOTAL_UNPLEDGE_QTY) AS ACTUALPLEDGE_QTY,ISIN,PLEDGEE_BO_ID,AGREEMENT_NO,--PLEDGOR_BO_ID,    
   CLOSING_PRICE = CONVERT(MONEY,0),VALUE = CONVERT(MONEY,0)    
   INTO #ALREADY_PLEDGE_STOCK    
   FROM [196.1.115.199].SYNERGY.DBO.SYNERGY_DP37 DP WITH(NOLOCK)    
   WHERE PLEDGE_TYPE = 'PLEDGE' AND PLEDGE_QTY-TOTAL_UNPLEDGE_QTY <> 0    
   AND DATE_TIME LIKE 'NOV 9 2011%'    
   AND TRXN_STATUS = 'A'    
   AND PLEDGOR_BO_ID IN ('1203320000000066','1203320000000051')    
   /*    
   AND EXISTS(    
   SELECT BANK_CODE    
   FROM VW_LAS_COMB_BANK_AGREEEMENT_MAST A    
   WHERE DP.PLEDGOR_BO_ID = A.PLEDGOR_BO_ID    
   AND DP.PLEDGEE_BO_ID = A.PLEDGEE_BO_ID    
   AND DP.AGREEMENT_NO = A.AGREEMENT_NO    
   )    
   */    
   GROUP BY ISIN,PLEDGEE_BO_ID,AGREEMENT_NO--,PLEDGOR_BO_ID    
   */    
   /*TEMPORARY FIX TO GET PLEDGE QTY*/    
   /*REQUIRED*/    
   /*TEMPORARY FIX Take Data from inhouse*/    
      /*Select Isin,    
      Pledgor_bo_id,    
      Pledgee_bo_id,    
      Isnull(Agreement_no, '') As Agreement_no,    
      Pledge_no,    
      Pledge_qty,    
      Convert(Money, 0) As Clsrate,    
      Convert(Int, 0) As Unpledge_qty,    
      Convert(Money, 0) As Unpledge_value,    
      Bank_code=Convert(Int, 0)    
      Into #PLEDGE    
      From [196.1.115.199].SYNERGY.DBO.Synergy_dp37 Dp With(NOLOCK)    
      Where Pledge_type = 'PLEDGE'    
      And Trxn_status In ('A', 'D')    
      And Pledgor_bo_id In ('1203320000000066', '1203320000000051')*/    
    
      Select Isin,    
             Clientid                 As Pledgor_bo_id,    
             Bankid                   As Pledgee_bo_id,    
             Isnull(Agreement_no, '') As Agreement_no,    
             Pledgeorder              As Pledge_no,    
             Convert(Int, Pledgeqty)  As Pledge_qty,    
             Convert(Money, 0)        As Clsrate,    
             Convert(Int, 0)          As Unpledge_qty,    
             Convert(Money, 0)        As Unpledge_value,    
             Bank_code=Convert(Int, 0)    
      Into   #PLEDGE    
      From   mis.demat.dbo.Pledge2releaseentry A With(NOLOCK)    
             Left Outer Join GENERAL.dbo.Vw_las_comb_bank_agreeement_mast B With(NOLOCK)    
              On A.Clientid = B.Pledgor_bo_id    
                 And A.Bankid = B.Pledgee_bo_id    
      Where  A.Clientid In ('1203320000000066', '1203320000000051','1203320009603460','1203320000000028')
			And B.Active_Inactive=1    
    
      --AND AGREEMENT_NO IS NOT NULL    
      --DROP TABLE #PLEDGE    
      Create Nonclustered Index [IX_ROW_NUM]    
       On #PLEDGE ( Isin, Pledge_no, Pledgee_bo_id, Agreement_no, Pledgor_bo_id )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Update #PLEDGE    
      Set    Bank_code = M.Bank_code    
      From   GENERAL.dbo.Vw_las_comb_bank_agreeement_mast M With(nolock)    
      Where  #pledge.Pledgee_bo_id = M.Pledgee_bo_id    
             And #pledge.Pledgor_bo_id = M.Pledgor_bo_id    
			 And M.Active_Inactive=1
      /*Select Pledge_no,    
      Sum(Unpld_conf_qty) As Total_unpledge_qty    
      Into #UNPLEDGE    
      From [196.1.115.199].SYNERGY.DBO.Synergy_dp37 Dp With(NOLOCK)    
      Where Pledge_type = 'UNPLEDGE'    
      And Trxn_status In ('A', 'D')    
      And Exists(Select Pledge_no    
      From #PLEDGE A    
      Where A.Pledge_no = Dp.Pledge_no)    
      Group By Pledge_no */    
    
      Select Pledgeorder                    As Pledge_no,    
             Convert(Int, Sum(Unpledgeqty)) As Total_unpledge_qty    
      Into   #UNPLEDGE    
      From   mis.demat.dbo.Pledge2releaseentry Dp With(NOLOCK)    
      Where  Exists(Select Pledge_no    
                    From   #PLEDGE A    
                    Where  A.Pledge_no = Dp.Pledgeorder)    
      Group  By Pledgeorder    
    
      Select A.Pledge_no,    
             A.Bank_code,    
             Sum(Pledge_qty)                                      As Pledge_qty,    
             Sum(Isnull(Total_unpledge_qty, 0))                   As Total_unpledge_qty,    
             Sum(Pledge_qty) - Sum(Isnull(Total_unpledge_qty, 0)) As Actualpledge_qty,    
             Isin,    
             Pledgee_bo_id,    
             Agreement_no,    
             Pledgor_bo_id,    
             Closing_price = Convert(Money, 0),    
             Value = Convert(Money, 0)    
      Into   #ALREADY_PLEDGE_STOCK    
      From   #PLEDGE A    
             Full Outer Join #UNPLEDGE B    
              On A.Pledge_no = B.Pledge_no    
      Where  Pledge_qty - Isnull(B.Total_unpledge_qty, 0) <> 0    
      Group  By A.Pledge_no,A.Bank_code,Isin,Pledgee_bo_id,Agreement_no,Pledgor_bo_id    
    
      /*END*/    
      Select Isnull(Th.Isin, P.Isin)   As Isin,    
             Isnull(Th.Accno, P.Accno) As Accno,    
             Isnull(Value, 0)          As Available_qty_value,    
             Isnull(Th.Qty, 0)         As Available_qty,    
             Isnull(Clsrate, 0)        As Clsrate,    
             /*Isnull(P.Qty, 0)*/0     As Already_pledge_qty,    
             --Isnull(Th.Qty, 0) - Isnull(P.Qty, 0) As Qty_available_for_pledge,    
             Isnull(Th.Qty, 0)         As Qty_available_for_pledge,    
             Convert(Int, 0)           As Pledge_qty,    
             Priority = Convert(Smallint, 0)    
      Into   #ISINWISE_PLEDGE_SUMMARY    
      From   (Select Isin,    
                     Accno,    
                     Sum(Qty)   As Qty,    
                     Sum(Value) As Value,    
                     Clsrate = Min(Clsrate)    
              From   #PLEDGABLE_STOCK A    
              Where  Client_priority = 1    
              Group  By Isin,Accno) Th    
             Full Outer Join (Select Isin,    
                                     Accno=Pledgor_bo_id,    
                                     Sum(Actualpledge_qty) As Qty    
                              From   #ALREADY_PLEDGE_STOCK    
                              Group  By Isin,Pledgor_bo_id) P    
              On Th.Isin = P.Isin    
                 And Th.Accno = P.Accno    
    
      Print 'UPDATING CLOSING PRICE'    
    
     /*ALREADY PLEDGE DATA*/  
      /* Comment on 09 May 2012  
      PRMS Request ID 10141041   
      */    
      /*--BSECM    
      Update A    
      Set    Closing_price = Rate,    
             Value = Rate * Actualpledge_qty    
      From   #ALREADY_PLEDGE_STOCK A,    
             (Select Isin,    
                     Rate    
              From   GENERAL.dbo.Cp_bsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scode = B.Bsecode) Cp    
      Where  A.Isin = Cp.Isin    
             And Closing_price = 0    
    
      --NSECM    
      Update A    
      Set    Closing_price = Rate,    
             Value = Rate * Actualpledge_qty    
      From   #ALREADY_PLEDGE_STOCK A,    
    (Select Isin,    
                     Cls As Rate    
              From   GENERAL.dbo.Cp_nsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scrip = B.Nsesymbol    
                         And A.Series = B.Nseseries) Cp    
      Where  A.Isin = Cp.Isin    
             And Closing_price = 0 */   
               
      Update A    
      Set    Closing_price = Rate,    
             Value = Rate * Actualpledge_qty    
      From   #ALREADY_PLEDGE_STOCK A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)) Cp    
      Where  Closing_price = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = Cp.AccNo   
         
      Update A    
      Set    Closing_price = Rate,    
             Value = Rate * Actualpledge_qty    
      From   #ALREADY_PLEDGE_STOCK A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000066')) Cp    
      Where  Closing_price = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = '1203320000000051'   
         
      Update A    
      Set    Closing_price = Rate,    
             Value = Rate * Actualpledge_qty    
      From   #ALREADY_PLEDGE_STOCK A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000051')) Cp    
      Where  Closing_price = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = '1203320000000066'    
               
    
        /*PLEDGE DATA*/   
        /* Comment on 09 May 2012  
        PRMS Request ID 10141041   
        */   
      --BSECM    
      /*Update A    
      Set    Clsrate = Rate    
      From   #PLEDGE A,    
             (Select Isin,    
                     Rate    
              From   GENERAL.dbo.Cp_bsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scode = B.Bsecode) Cp    
      Where  A.Isin = Cp.Isin    
             And Clsrate = 0    
    
      --NSECM    
      Update A    
      Set    Clsrate = Rate    
      From   #PLEDGE A,    
             (Select Isin,    
                     Cls As Rate    
              From   GENERAL.dbo.Cp_nsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scrip = B.Nsesymbol    
                         And A.Series = B.Nseseries) Cp    
      Where  A.Isin = Cp.Isin    
             And Clsrate = 0*/  
               
      Update A    
      Set    Clsrate = Rate  
      From   #PLEDGE A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = Cp.AccNo   
         
      Update A    
      Set    Clsrate = Rate  
      From   #PLEDGE A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000066')) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = '1203320000000051'   
         
      Update A    
      Set    Clsrate = Rate  
      From   #PLEDGE A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000051')) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = '1203320000000066'      
    
      /*SUMMARY DATA*/  
      /* Comment on 09 May 2012  
      PRMS Request ID 10141041   
      */    
      /*Update A    
      Set    Clsrate = Rate    
      From   #ISINWISE_PLEDGE_SUMMARY A,    
             (Select Isin,    
                     Rate    
              From   GENERAL.dbo.Cp_bsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scode = B.Bsecode) Cp    
      Where  A.Isin = Cp.Isin    
             And Clsrate = 0    
    
      --NSECM    
      Update A    
      Set    Clsrate = Rate    
      From   #ISINWISE_PLEDGE_SUMMARY A,    
             (Select Isin,    
                     Cls As Rate    
              From   GENERAL.dbo.Cp_nsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scrip = B.Nsesymbol    
                         And A.Series = B.Nseseries) Cp    
      Where  A.Isin = Cp.Isin    
             And Clsrate = 0 */  
               
        
      Update A    
      Set    Clsrate = Rate  
      From   #ISINWISE_PLEDGE_SUMMARY A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.AccNo = Cp.AccNo   
         
      Update A    
      Set    Clsrate = Rate  
      From   #ISINWISE_PLEDGE_SUMMARY A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000066')) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.AccNo = '1203320000000051'   
         
      Update A    
      Set    Clsrate = Rate  
      From   #ISINWISE_PLEDGE_SUMMARY A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000051')) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.AccNo = '1203320000000066'     
    
      Print 'LOADING BANK DETAILS'    
    
      --DROP TABLE #BANK_LIST    
      Select Priority,    
             Bank_code,    
             Bankname,    
             Las_line,    
             Utilization,    
             Already_pledge_value = Convert(Money, 0),    
             Tday_creditors_unpledge_value = Convert(Money, 0),    
             Tday_interbank_unpledge_value = Convert(Money, 0),    
             Tday_debtors_pledge_value = Convert(Money, 0),    
             Tday_interbank_pledge_value = Convert(Money, 0),    
             Tday_creditors_pledge_value = Convert(Money, 0),    
             [Required_excess] = Convert(Money, 0),    
             Bo_id,    
             Row_number() Over(Order By Priority) As Row_num    
      Into   #BANK_LIST    
      From   GENERAL.dbo.Tbl_las_bank_master With(NOLOCK)    
      Where  Active_inactive = 1    
      Order  By Priority    
    
      Create Table #UNPLEDGE_REQUEST    
       (    
         Bank_code      Int Not Null,    
         Isin           Varchar(30) Not Null,    
         Pledgor_bo_id  Varchar(30) Not Null,    
         Pledgee_bo_id  Varchar(30) Not Null,    
         Agreement_no   Varchar(30) Not Null,    
         Pledge_no      Varchar(20) Not Null,    
         Unpledge_qty   Int Not Null,    
         Unpledge_value Money Not Null,    
         Request_type   Varchar(20) Not Null/* CREDITORS / INTERBANK */    
       )    
    
      Create Table #UNPLEDGE_BANK_DATA    
       (    
         Bank_code     Int Not Null,    
         Pledgor_bo_id Varchar(30) Not Null,    
         Pledgee_bo_id Varchar(30) Not Null,    
         Agreement_no  Varchar(30) Not Null,    
         Pledge_no     Varchar(20) Not Null,    
         Pledge_qty    Int Not Null,    
         Row_num       Int Not Null    
       )    
    
      Create Clustered Index [IX_ROW_NUM]    
       On #UNPLEDGE_BANK_DATA ( [Row_num] Asc )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Select Isin,    
             Accno,    
             Clsrate=Min(Clsrate),    
             Qty_available_for_pledge=Sum(Qty)    
      Into   #ISINWISE_UNPLEDGE_SUMMARY    
      From   #HLD    
      Group  By Isin,Accno    
    
      Select Isin,    
             Accno,    
             Clsrate,    
             Qty_available_for_pledge,    
             Row_number() Over(Order By Isin) As Row_num    
      Into   #UNPLEDGE_ISIN    
      From   #ISINWISE_UNPLEDGE_SUMMARY    
      Where  Qty_available_for_pledge < 0    
    
   /*    
   drop table #UNPLEDGE_ISIN    
   TRUNCATE TABLE #UNPLEDGE_REQUEST    
   UPDATE #PLEDGE    
   SET UNPLEDGE_QTY = 0,    
   UNPLEDGE_VALUE = 0    
   */    
   --SET NOCOUNT ON    
    
      /*Declare @CNT_UNPLEDGE_ISIN As Int,    
      @CTR_UNPLEDGE_ISIN As Int,    
      @ISIN As Varchar(20),    
      @UNPLEGE_REQ As Int,    
      @CLSRATE As Money,    
      @VALUE As Money,    
      @BANK_CODE As Int,    
      @CNT_UNPLEDGE_BANK As Int,    
      @CTR_UNPLEDGE_BANK As Int,    
      @UNPLEGE_QTY As Int,    
      @PLEDGOR_BO_ID As Varchar(30),    
      @PLEDGEE_BO_ID As Varchar(30),    
      @AGREEMENT_NO As Varchar(30),    
      @PLEDGE_NO As Varchar(30)*/    
    
      Print ''    
    
      Print ''    
    
      Print 'UNPLEDGING CREDITORS STOCK'    
    
      Print ' STARTED'    
    
      Select @CNT_UNPLEDGE_ISIN = Count(*)    
      From   #UNPLEDGE_ISIN    
    
      Set @CTR_UNPLEDGE_ISIN = 1    
    
      While(@CTR_UNPLEDGE_ISIN <= @CNT_UNPLEDGE_ISIN)    
      Begin    
         Select @ISIN = Isin,    
                @UNPLEGE_REQ = Qty_available_for_pledge * -1,    
                @VALUE = Qty_available_for_pledge * Clsrate,    
                @CLSRATE = Clsrate,    
                @PLEDGOR_BO_ID = Accno    
         From   #UNPLEDGE_ISIN    
         Where  Row_num = @CTR_UNPLEDGE_ISIN    
    
         Truncate Table #UNPLEDGE_BANK_DATA    
    
         Insert Into #UNPLEDGE_BANK_DATA    
         Select A.Bank_code,    
                Pledgor_bo_id,    
                Pledgee_bo_id,    
                Agreement_no=Isnull(Agreement_no, ''),    
                Pledge_no,    
                /*Pledge_qty,*/Actualpledge_qty                                          As Pledge_qty,    
                Row_number() Over(Order By Priority Desc, Pledgor_bo_id Desc, Pledge_no) As Row_num    
         From   /*#PLEDGE*/#ALREADY_PLEDGE_STOCK A    
                           Left Outer Join General.dbo.Tbl_las_bank_master B (NOLOCK)    
                            On A.Pledgee_bo_id = B.BO_ID    
         Where  Isin = @ISIN    
                And A.Pledgor_bo_id = @PLEDGOR_BO_ID    
    
         --And Isnull(Agreement_no, '') <> ''    
    
         Select @CNT_UNPLEDGE_BANK = Count(*)    
         From   #UNPLEDGE_BANK_DATA    
    
         Set @CTR_UNPLEDGE_BANK = 1    
    
         While(@CTR_UNPLEDGE_BANK <= @CNT_UNPLEDGE_BANK)    
         Begin    
            Select @PLEDGOR_BO_ID = Pledgor_bo_id,    
                   @PLEDGEE_BO_ID = Pledgee_bo_id,    
                   @AGREEMENT_NO = Agreement_no,    
                   @PLEDGE_NO = Pledge_no,    
                   @UNPLEGE_QTY = Pledge_qty,    
                   @BANK_CODE = Bank_code    
            From   #UNPLEDGE_BANK_DATA    
            Where  Row_num = @CTR_UNPLEDGE_BANK    
    
            If(@UNPLEGE_QTY < @UNPLEGE_REQ)    
            Begin    
               Insert Into #UNPLEDGE_REQUEST    
               Values      (@BANK_CODE,    
                            @ISIN,    
                            @PLEDGOR_BO_ID,    
                            @PLEDGEE_BO_ID,    
                            @AGREEMENT_NO,    
                            @PLEDGE_NO,    
                            @UNPLEGE_QTY,    
                            @CLSRATE * @UNPLEGE_QTY,    
                            'CREDITORS')    
    
               Update #PLEDGE    
               Set    Unpledge_qty = Unpledge_qty + @UNPLEGE_QTY,    
                      Unpledge_value = (Unpledge_qty + @UNPLEGE_QTY) * @CLSRATE    
               Where  Isin = @ISIN    
                      And Pledge_no = @PLEDGE_NO    
                      And Pledgee_bo_id = @PLEDGEE_BO_ID    
                      And Agreement_no = @AGREEMENT_NO    
                      And Pledgor_bo_id = @PLEDGOR_BO_ID    
            End    
            Else    
            Begin    
               Insert Into #UNPLEDGE_REQUEST    
               Values      (@BANK_CODE,    
                            @ISIN,    
                            @PLEDGOR_BO_ID,    
                            @PLEDGEE_BO_ID,    
                            @AGREEMENT_NO,    
                            @PLEDGE_NO,    
                            @UNPLEGE_REQ,    
                            @CLSRATE * @UNPLEGE_REQ,    
                            'CREDITORS')    
    
               Update #PLEDGE    
               Set    Unpledge_qty = Unpledge_qty + @UNPLEGE_REQ,    
              Unpledge_value = (Unpledge_qty + @UNPLEGE_REQ) * @CLSRATE    
               Where  Isin = @ISIN    
                      And Pledge_no = @PLEDGE_NO    
                      And Pledgee_bo_id = @PLEDGEE_BO_ID    
                      And Agreement_no = @AGREEMENT_NO    
                      And Pledgor_bo_id = @PLEDGOR_BO_ID    
            End    
    
            Set @UNPLEGE_REQ = @UNPLEGE_REQ - @UNPLEGE_QTY    
    
            If @UNPLEGE_REQ <= 0    
            Begin    
               Break    
            End    
    
            Set @CTR_UNPLEDGE_BANK = @CTR_UNPLEDGE_BANK + 1    
         End    
    
         Set @UNPLEGE_QTY = 0    
    
         Set @CTR_UNPLEDGE_ISIN = @CTR_UNPLEDGE_ISIN + 1    
      End    
    
      --SET NOCOUNT OFF    
      Print ' COMPLETED'    
    
      Print 'UPDATING UNPLEDGE VALUE BANKWISE FOR CREDITORS STOCK '    
    
      /*    
      UPDATE ALREADY PLEDGE VALUE FROM DP37 FILE DATA    
      */    
      Update #BANK_LIST    
      Set    Already_pledge_value = Isnull(Pledge_value, 0)    
      From   (Select Pledgee_bo_id,    
                     Sum(Value) As Pledge_value    
              From   #ALREADY_PLEDGE_STOCK    
              Group  By Pledgee_bo_id) A    
      Where  #bank_list.Bo_id = A.Pledgee_bo_id    
    
      /*    
      UPDATE TDAY UNPLEDGE VALUE    
      */    
      Update #BANK_LIST    
      Set    Tday_creditors_unpledge_value = Isnull(Unpledge_value, 0)    
      From   (Select Pledgee_bo_id,    
                     Sum(Unpledge_value) As Unpledge_value    
              From   #PLEDGE    
              Where  Unpledge_qty > 0    
              Group  By Pledgee_bo_id) A    
      Where  #bank_list.Bo_id = A.Pledgee_bo_id    
    
      --UPDATE #BANK_LIST SET UTILIZATION = 1500000000.00 WHERE BANK_CODE = 1    
      Print 'RECALCULATING BANKWISE REQUIREMENT/EXCESS AFTER UNPLEDGING CREDITORS STOCK............'    
    
      /*    
      UPDATEING REQUIREMENT FOR DEBTORS CLIENT STOCK    
      */    
      Update #BANK_LIST    
      Set    [Required_excess] = Utilization - (Already_pledge_value - Tday_creditors_unpledge_value - Tday_interbank_unpledge_value) - Tday_debtors_pledge_value - Tday_interbank_pledge_value - Tday_creditors_pledge_value    
    
      Create Table #PLEDGE_REQUEST    
       (    
         Bank_code     Int Not Null,    
         Pledgor_bo_id Varchar(20) Not Null,    
         Isin          Varchar(20) Not Null,    
         Qty           Int Not Null,    
         Value         Money Not Null,    
         Request_type  Varchar(20) Not Null /* DEBITORS / CREDITORS / INTERBANK */,    
         Approved      Int Not Null /*0-UNANSWERED , 1-REJECTED, 2-APPROVED*/,    
         Approved_by   Varchar(100) Not Null    
       )    
    
      Select Top 0 *,    
                   Rw_nm=Convert(Int, 0)    
      Into   #TMP_PLEDGE_DATA    
      From   #PLEDGABLE_STOCK    
    
      Create Clustered Index [IX_ROW_NUM]    
       On #TMP_PLEDGE_DATA ( Rw_nm Asc )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Create Clustered Index [IX_PRIORITY]    
       On #PLEDGABLE_STOCK ( Priority Asc )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Create Nonclustered Index [IX_ROW_NUM]    
       On #PLEDGABLE_STOCK ( Row_num )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Create Clustered Index [IX_ISIN]    
       On #ISINWISE_PLEDGE_SUMMARY ( Isin )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Truncate Table #TMP_PLEDGE_DATA    
    
      --SET NOCOUNT ON    
    
      /*DECLARE @BANK_CTR AS INT,    
      @BANK_TOTAL AS INT,    
      @PRIORITY AS INT,    
      @BANK_CODE AS INT,    
      @REQUIREMENT AS MONEY,    
      @PLEDGE_CTR AS INT,    
      @PLEDGE_CNT AS INT,    
          
      @PLEDGOR_BO_ID AS VARCHAR(20),    
      @ISIN AS VARCHAR(20),    
      @QTY AS INT,    
      @VALUE AS MONEY,    
      @CLSRATE AS MONEY,    
          
      @CHECK_LEFT_QTY AS INT,    
      @PLEDGE_VALUE AS MONEY,    
      @ROW_NUM AS INT */    
    
      Print ''    
    
      Print ''    
    
      Print 'PLEDGING DEBITORS STOCK'    
    
      Print ' STARTED'    
    
      Select @BANK_TOTAL = Count(*)    
      From   #BANK_LIST    
    
      Select @BANK_CTR = 1    
    
      While (@BANK_CTR <= @BANK_TOTAL)    
      Begin    
         Select @PRIORITY = Priority,    
                @BANK_CODE = Bank_code,    
                @REQUIREMENT = [Required_excess]    
         From   #BANK_LIST    
         Where  Row_num = @BANK_CTR    
    
         If @REQUIREMENT > 0    
         Begin    
            Set @PLEDGE_VALUE = 0    
    
            /*Update #PLEDGABLE_STOCK    
            Set Priority = @PRIORITY    
            Where Isin In (Select Isin    
            From Vw_las_appr_bank_scrip A With (NOLOCK)    
            Inner Join Scrip_master B With(NOLOCK)    
            On A.Scode = B.Bsecode    
            Where Bank_code = @BANK_CODE)    
            ----- Addtional condition for BSE Exchenge only 66 Acc    
            Or (Accno = '1203320000000066'    
            And @Bank_code = 8)*/    
    
            Update #PLEDGABLE_STOCK    
            Set    Priority = @PRIORITY    
            From   (Select B.Isin,    
                           C.Accno    
                    From   Vw_las_appr_bank_scrip A With (NOLOCK)    
                           Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                            On A.Scode = B.Bsecode    
                           Inner Join (Select Bank_code,    
                                              Accno=Pledgor_bo_id    
                                       From   GENERAL.dbo.Vw_las_comb_bank_agreeement_mast With (NOLOCK)    
                                       Where  Bank_code = @BANK_CODE
											And Active_Inactive=1) C    
                            On A.Bank_code = C.Bank_code    
                    Where  C.Bank_code = @BANK_CODE) P    
            Where  #pledgable_stock.Accno = P.Accno    
                   And #pledgable_stock.Isin = P.Isin    
    
            Truncate Table #TMP_PLEDGE_DATA    
    
            Insert Into #TMP_PLEDGE_DATA    
            Select Accno,    
                   Isin,    
                   Scrip_cd,    
                   Qty - Pledge_qty,    
                   Value=(Qty - Pledge_qty) * Clsrate,    
                   Clsrate,    
                   Pledge_qty,    
                   Priority,    
                   Client_priority,    
                   Scrip_priority,    
                   Row_num,    
                   Row_number() Over(Order By Accno Desc, Scrip_priority, Value Desc)    
            From   #PLEDGABLE_STOCK    
            Where  Priority = @PRIORITY    
                   And (Qty - Pledge_qty)/*AVAILABLE QTY*/ > 0    
                   And (Qty - Pledge_qty) * Clsrate/*VALUE*/ > 0    
                   And Client_priority = 1    
    
            --BREAK    
            Select @PLEDGE_CNT = Count(*)    
            From   #TMP_PLEDGE_DATA    
    
            Select @PLEDGE_CTR = 1    
    
            While ((@PLEDGE_CTR <= @PLEDGE_CNT)    
                   And (@PLEDGE_VALUE < @REQUIREMENT))    
            Begin    
               Select @PLEDGOR_BO_ID = Accno,    
                      @ISIN = Isin,    
                      @QTY = Qty,    
                      @VALUE = Value,    
                      @CLSRATE = Clsrate,    
                      @ROW_NUM = Row_num    
               From   #TMP_PLEDGE_DATA    
               Where  Rw_nm = @PLEDGE_CTR    
    
               /*    
               PRINT ' '    
               PRINT 'BANK ID :: ' + CONVERT(VARCHAR,@BANK_CODE)    
               PRINT CONVERT(VARCHAR,@PLEDGE_CTR)+' :: ' + @PLEDGOR_BO_ID + ' - ' + @ISIN    
               PRINT ' QTY : ' + CONVERT(VARCHAR,@QTY) + '; VALUE : ' + CONVERT(VARCHAR,@VALUE) + '; CLSRATE : ' + CONVERT(VARCHAR,@CLSRATE)    
               */    
               Select @CHECK_LEFT_QTY = Qty_available_for_pledge - Pledge_qty    
               From   #ISINWISE_PLEDGE_SUMMARY    
               Where  Isin = @ISIN    
                      And Accno = @PLEDGOR_BO_ID    
    
               If @CHECK_LEFT_QTY < @QTY    
               Begin    
                  Set @QTY = @CHECK_LEFT_QTY    
               End    
    
               If (@PLEDGE_VALUE + @VALUE) > @REQUIREMENT    
               Begin    
                  Set @QTY = Ceiling((@REQUIREMENT - @PLEDGE_VALUE) / @CLSRATE)    
               End    
    
               If @QTY < 0    
               Begin    
                  Set @QTY = 0    
               End    
    
               If @QTY > 0    
               Begin    
                  Set @VALUE = @QTY * @CLSRATE    
    
                  Insert Into #PLEDGE_REQUEST    
                  Values      (@BANK_CODE,    
                               @PLEDGOR_BO_ID,    
                               @ISIN,    
                               @QTY,    
                               @VALUE,    
                               'DEBITORS',    
                               2,    
                               @USERNAME)    
    
                  Update #ISINWISE_PLEDGE_SUMMARY    
                  Set    Pledge_qty = Pledge_qty + @QTY    
                  Where  Isin = @ISIN    
                         And Accno = @PLEDGOR_BO_ID    
    
                  Update #PLEDGABLE_STOCK    
                  Set    Pledge_qty = Pledge_qty + @QTY    
                  Where  Row_num = @ROW_NUM    
    
                  Set @PLEDGE_VALUE = @PLEDGE_VALUE + @VALUE    
               End    
    
               Set @PLEDGE_CTR = @PLEDGE_CTR + 1    
            End    
         End    
    
         Set @BANK_CTR = @BANK_CTR + 1    
      End    
    
      --SET NOCOUNT OFF    
      Print ' COMPLETED'    
    
      Print 'UPDATING PLEDGE VALUE BANKWISE FOR DEBITORS STOCK'    
    
      /*    
      UPDATE TDAY DEBTORS PLEDGE VALUE    
      */    
      Update #BANK_LIST    
      Set    Tday_debtors_pledge_value = Tday_debtors_pledge_value + Isnull(Pledge_value, 0)    
      From   (Select Bank_code,    
                     Sum(Value) As Pledge_value    
              From   #PLEDGE_REQUEST    
              Where  Request_type = 'DEBITORS'    
              Group  By Bank_code) A    
      Where  #bank_list.Bank_code = A.Bank_code    
    
      Print 'RECALCULATING BANKWISE REQUIREMENT/EXCESS AFTER PLEDGING DEBITORS STOCK............'    
    
      /*    
      RE-UPDATEING REQUIREMENT FOR INTERBANK    
      */    
      Update #BANK_LIST    
      Set    [Required_excess] = Utilization - (Already_pledge_value - Tday_creditors_unpledge_value - Tday_interbank_unpledge_value) - Tday_debtors_pledge_value - Tday_interbank_pledge_value - Tday_creditors_pledge_value    
    
      --UPDATE #BANK_LIST SET [REQUIRED_EXCESS] = [REQUIRED_EXCESS] + 100000000 WHERE UTILIZATION > 0    
      Update #BANK_LIST    
      Set    [Required_excess] = 0    
      Where  Utilization = 0    
    
      Create Table #BANK_LIST_FOR_INTERBANK    
       (    
         Bank_id                  Int Not Null,    
         [Available_for_transfer] Money Not Null,    
         Row_num                  Int Not Null,    
         Amount_unpledged         Money Not Null    
       )    
    
      Create Table #INTERBANK_TRANSFER_REQUEST    
       (    
         From_bank_code     Int Not Null,    
         From_pledgee_bo_id Varchar(20) Not Null,    
         From_pledgor_bo_id Varchar(20) Not Null,    
         To_bank_code       Int Not Null,    
         To_pledgee_bo_id   Varchar(20) Not Null,    
         To_pledgor_bo_id   Varchar(20) Not Null,    
         Agreement_no       Varchar(30) Not Null,    
         Isin               Varchar(20) Not Null,    
         Qty                Int Not Null,    
         Clsrate            Money Not Null,    
         Value              Money Not Null    
       )    
    
      Create Table #INTERBANK_TRANSFER_REQUEST_TMP    
       (    
         From_bank_code     Int Not Null,    
         From_pledgee_bo_id Varchar(20) Not Null,    
         From_pledgor_bo_id Varchar(20) Not Null,    
         Agreement_no       Varchar(30) Not Null,    
         Isin               Varchar(20) Not Null,    
         Qty                Int Not Null,    
         Clsrate            Money Not Null,    
         Value              Money Not Null,    
         Row_num            Int Not Null    
       )    
    
      Create Table #UNPLEDGE_INTERBANK_ISIN    
       (    
         From_pledgee_bo_id Varchar(20) Not Null,    
         From_pledgor_bo_id Varchar(20) Not Null,    
         Agreement_no       Varchar(30) Not Null,    
         Isin               Varchar(20) Not Null,    
         Qty                Int Not Null,    
         Clsrate            Money Not Null,    
         Value              Money Not Null,    
         Row_num            Int Not Null    
       )    
    
	
	/*Code added to handle unpledge quantity during interbank excess allocation*/		
	update a set Pledge_qty=Pledge_qty-b.Total_unpledge_qty from
	(select * from #PLEDGE )a
	inner join
	(select * from #UNPLEDGE)b on a.Pledge_no=b.Pledge_no
    
    
      Truncate Table #INTERBANK_TRANSFER_REQUEST    
    
      /*    
      --SET NOCOUNT ON    
      DECLARE @BANK_CTR AS INT,    
      @BANK_TOTAL AS INT,    
          
      @INTERBANK_CTR AS INT,    
      @INTERBANK_TOTAL AS INT,    
      @INTERBANK_BANK_CODE AS INT,    
      @INTERBANK_AVAILABLE AS INT,    
      @INTERBANK_TRANSFER_VALUE AS MONEY,    
      @INTERBANK_BANKTRANSFER_VALUE AS MONEY,    
          
      @ACTUAL_AVALABLE_FUND AS MONEY,    
          
      @FROM_BANK_CODE AS INT,    
      @FROM_PLEDGEE_BO_ID AS VARCHAR(20),    
      @FROM_PLEDGOR_BO_ID AS VARCHAR(20),    
          
      @AGREEMENT_NO AS VARCHAR(30),    
          
      @PRIORITY AS INT,    
      @BANK_CODE AS INT,    
      @REQUIREMENT AS MONEY,    
      @PLEDGE_CTR AS INT,    
      @PLEDGE_CNT AS INT,    
          
      @PLEDGOR_BO_ID AS VARCHAR(20),    
      @ISIN AS VARCHAR(20),    
      @QTY AS INT,    
      @VALUE AS MONEY,    
      @CLSRATE AS MONEY,    
          
      @CHECK_LEFT_QTY AS INT,    
      @PLEDGE_VALUE AS MONEY,    
      @ROW_NUM AS INT    
          
          
      DECLARE @CNT_UNPLEDGE_ISIN AS INT,    
      @CTR_UNPLEDGE_ISIN AS INT,    
      @UNPLEGE_REQ AS INT,    
      @UNPLEGE_AVAIL AS INT,    
          
      @CNT_UNPLEDGE_BANK AS INT,    
      @CTR_UNPLEDGE_BANK AS INT,    
      @UNPLEGE_QTY AS INT,    
      @PLEDGEE_BO_ID AS VARCHAR(30),    
      @PLEDGE_NO AS VARCHAR(30)    
          
      */    
      Print ''    
    
      Print ''    
    
      Print 'INTERBANK REQUIREMENT ANALYSIS & ALLOCATION STARTED'    
    
      Print ' STARTED'    
    
      /* PLEDGING/UNPLEDGING INTERBANK STOCK*/    
      Declare @INTERBANK_CTR                As Int,    
              @INTERBANK_TOTAL              As Int,    
              @INTERBANK_BANK_CODE          As Int,    
              @INTERBANK_AVAILABLE          As Int,    
              @INTERBANK_TRANSFER_VALUE     As Money,    
              @INTERBANK_BANKTRANSFER_VALUE As Money,    
              @ACTUAL_AVALABLE_FUND         As Money,    
              @FROM_BANK_CODE               As Int,    
              @FROM_PLEDGEE_BO_ID           As Varchar(20),    
              @FROM_PLEDGOR_BO_ID           As Varchar(20),    
              @UNPLEGE_AVAIL                As Int    
    
      Select @BANK_TOTAL = Count(*)    
      From   #BANK_LIST    
    
      Select @BANK_CTR = 1    
    
      Print ' THERE ARE ' + Convert(Varchar, @BANK_CTR) + ' BANKS FOR INTER BANK TRANSFER'    
    
      /*LOOP THROUGH BANK HAVING REQUIREMENT FOR INTERBANK TRANSFER*/    
      While (@BANK_CTR <= @BANK_TOTAL)    
      Begin    
         Select @PRIORITY = Priority,    
                @BANK_CODE = Bank_code,    
                @REQUIREMENT = [Required_excess]    
         From   #BANK_LIST    
         Where  Row_num = @BANK_CTR    
    
         If @REQUIREMENT > 0    
         Begin    
            --SET @INTERBANK_TRANSFER_VALUE = 0    
            Truncate Table #BANK_LIST_FOR_INTERBANK    
    
            Insert Into #BANK_LIST_FOR_INTERBANK    
            Select Bank_code,    
                   (([Required_excess] * -1) - (Utilization * 0.25 / 100)) As [Available_for_transfer],    
                   Row_number() Over(Order By Priority)                    As Row_num,    
                   0                                                       As Unpledge_value    
            From   #BANK_LIST    
            Where  [Required_excess] < 0    
                   And [Required_excess] * -1 > (Utilization * 0.25 / 100) /*0.25% OF UTILIZATION + UTILIZATION*/    
    
            /*    
            SELECT 'INTERBANK TRANSFER DATA',*,(([REQUIRED_EXCESS]*-1)-;(UTILIZATION*0.25/100)) AS [AVAILABLE_FOR_TRANSFER],    
            ROW_NUMBER() OVER(ORDER BY PRIORITY) AS ROW_NUM,0 AS UNPLEDGE_VALUE    
            FROM #BANK_LIST    
            WHERE [REQUIRED_EXCESS] < 0 AND [REQUIRED_EXCESS]*-1 > (UTILIZATION*0.25/100) /*0.25% OF UTILIZATION + UTILIZATION*/    
            */    
            Print ''    
    
            Print ' BANK CODE :: ' + Convert(Varchar, @BANK_CODE)    
    
            Select @INTERBANK_TOTAL = Count(*)    
            From   #BANK_LIST_FOR_INTERBANK    
    
            Set @INTERBANK_CTR = 1    
    
            /*LOOP THROUGH BANK HAVING EXCESS FOR INTERBANK TRANSFER*/    
            While (@INTERBANK_CTR <= @INTERBANK_TOTAL)    
            Begin    
               Select @INTERBANK_BANK_CODE = Bank_id,    
                      @INTERBANK_AVAILABLE = [Available_for_transfer]    
               From   #BANK_LIST_FOR_INTERBANK    
               Where  Row_num = @INTERBANK_CTR    
    
               Truncate Table #INTERBANK_TRANSFER_REQUEST_TMP    
    
               Insert Into #INTERBANK_TRANSFER_REQUEST_TMP    
               Select Bank_code,    
                      Pledgee_bo_id,    
                      Pledgor_bo_id,    
                      P.Agreement_no,    
                      Isin,    
                      Sum(Pledge_qty - Unpledge_qty),    
                      Min(Clsrate),    
                      Sum((Pledge_qty - Unpledge_qty) * Clsrate),    
                      Row_number() Over(Order By Pledgor_bo_id Desc, Sum((Pledge_qty-Unpledge_qty)*Clsrate) Desc )    
               From   #PLEDGE P    
               Where  Bank_code = @INTERBANK_BANK_CODE    
                      And Clsrate <> 0    
                      And Exists(Select Isin    
                                 From   Vw_las_appr_bank_scrip A With (NOLOCK)    
                                        Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                                         On A.Scode = B.Bsecode    
                                 Where  Bank_code = @BANK_CODE    
                                        And P.Isin = B.Isin)    
                      And Exists (Select Bank.Agreement_no    
                                  From   GENERAL.dbo.Vw_las_comb_bank_agreeement_mast Bank    
                                  Where  Bank_code = @INTERBANK_BANK_CODE    
                                         And Bank.Agreement_no = P.Agreement_no
                                         And Bank.Active_Inactive=1)    
               --AND (PLEDGE_QTY-UNPLEDGE_QTY) > 0    
               Group  By Bank_code,Pledgor_bo_id,Pledgee_bo_id,P.Agreement_no,Isin    
    
               Select @PLEDGE_CNT = Count(*)    
               From   #INTERBANK_TRANSFER_REQUEST_TMP    
    
               Select @PLEDGE_CTR = 1    
    
            /*LOOP THROUGH COMMON SCRIPS WHICH CAN BE TRANSFERED*/    
               /*    
               FETCHING TRANSFER DATA    
               */    
               If (@REQUIREMENT > 0)    
                  And (@INTERBANK_AVAILABLE > 0)    
               Begin    
                  Print @INTERBANK_BANK_CODE    
    
                  Print @INTERBANK_AVAILABLE    
    
                  Print @REQUIREMENT    
    
                  While (@PLEDGE_CTR <= @PLEDGE_CNT)    
                  Begin    
                     Select @FROM_BANK_CODE = From_bank_code,    
                            @FROM_PLEDGEE_BO_ID = From_pledgee_bo_id,    
                            @FROM_PLEDGOR_BO_ID = From_pledgor_bo_id,    
                            @AGREEMENT_NO = Agreement_no,    
                            @ISIN = Isin,    
                            @QTY = Qty,    
                            @VALUE = Value,    
                            @CLSRATE = Clsrate,    
                            @ROW_NUM = Row_num    
                     From   #INTERBANK_TRANSFER_REQUEST_TMP    
                     Where  Row_num = @PLEDGE_CTR    
    
                     /*    
                     PRINT '------------------------------------------------------------------- '    
                     PRINT 'REQUIRE BANK CODE :: ' + CONVERT(VARCHAR,@BANK_CODE)    
                     PRINT 'REQUIREMENT :: ' + CONVERT(VARCHAR,@REQUIREMENT)    
                         
                     PRINT 'FROM BANK ID :: ' + CONVERT(VARCHAR,@FROM_BANK_CODE)    
                     PRINT 'AVAILABLE :: ' + CONVERT(VARCHAR,@INTERBANK_AVAILABLE)    
                         
                     PRINT CONVERT(VARCHAR,@PLEDGE_CTR)+' :: ' + @FROM_PLEDGEE_BO_ID + ' - ' + @ISIN    
                     PRINT ' QTY : ' + CONVERT(VARCHAR,@QTY) + '; VALUE : ' + CONVERT(VARCHAR,@VALUE) + '; CLSRATE : ' + CONVERT(VARCHAR,@CLSRATE)    
                     */    
                     If @INTERBANK_AVAILABLE < @REQUIREMENT    
                      Set @ACTUAL_AVALABLE_FUND = @INTERBANK_AVAILABLE    
                     Else    
                      Set @ACTUAL_AVALABLE_FUND = @REQUIREMENT    
    
                     If @ACTUAL_AVALABLE_FUND < @VALUE    
                     Begin    
                        Set @QTY = Ceiling(@ACTUAL_AVALABLE_FUND / @CLSRATE)    
                     End    
    
                     If @QTY > 0    
                     Begin    
                        Set @VALUE = @QTY * @CLSRATE    
    
                        Insert Into #INTERBANK_TRANSFER_REQUEST    
                        Values      (@FROM_BANK_CODE,    
                                     @FROM_PLEDGEE_BO_ID,    
                                     @FROM_PLEDGOR_BO_ID,    
                                     @BANK_CODE,    
                                     '',    
                                     @FROM_PLEDGOR_BO_ID,    
                                     @AGREEMENT_NO,    
                                     @ISIN,    
                                     @QTY,    
                                     @CLSRATE,    
                                     @VALUE)    
    
                        Set @REQUIREMENT = @REQUIREMENT - @VALUE    
    
                        Set @INTERBANK_AVAILABLE = @INTERBANK_AVAILABLE - @VALUE    
                     End    
    
                     /*    
                     PRINT ' TRANSFER QTY : ' + CONVERT(VARCHAR,@QTY) + '; TRANSFER VALUE : ' + CONVERT(VARCHAR,@VALUE)    
                     */    
                     If (@REQUIREMENT < 0)    
                         Or (@INTERBANK_AVAILABLE < 0)    
                     Begin    
                        /*    
                        PRINT ' '    
        PRINT ' REQUIREMENT :: '+CONVERT(VARCHAR,@REQUIREMENT)    
                        PRINT ' INTERBANK AVAILABLE :: '+CONVERT(VARCHAR,@INTERBANK_AVAILABLE)    
                        */    
                        Break    
                     End    
    
                     Set @PLEDGE_CTR = @PLEDGE_CTR + 1    
                  End    
    
               /*MAINTAIN STATE AT BANK LEVEL FOR RE-CALCULATING REQUIREMENT/EXCESS*/    
               /*    
               SELECT 'BANK_DATA BEFORE',* FROM #BANK_LIST    
               WHERE BANK_CODE IN (@BANK_CODE,@INTERBANK_BANK_CODE)    
               */    
                  /*    
                  PRINT ' '    
                  PRINT '$$$$$$$$$$$$$$$$$$$$$$$'    
                  PRINT ' UPDATING BANKWISE DATA '    
                      
                  PRINT ' PLEDGE DATA TO BANK CODE :- ' + CONVERT(VARCHAR,@BANK_CODE)    
                  */    
                  Print ' UPDATING PLEDGE/UNPLEDGE VALUE BANKWISE FOR INTERBANK TRANSFER'    
    
                  Print @BANK_CODE    
    
                  Print @FROM_BANK_CODE    
    
                  Update #BANK_LIST    
                  --SET TDAY_INTERBANK_PLEDGE_VALUE = VALUE    
                  Set    Tday_interbank_pledge_value = Tday_interbank_pledge_value + Value    
                  From   (Select To_bank_code,    
                                 Sum(Value) As Value    
                          From   #INTERBANK_TRANSFER_REQUEST    
                          --WHERE TO_BANK_CODE=@BANK_CODE    
                          Where  To_bank_code = @BANK_CODE    
                                 And From_bank_code = @FROM_BANK_CODE    
                          Group  By To_bank_code) A    
                  Where  #bank_list.Bank_code = A.To_bank_code    
    
                  /*    
                  PRINT ' UNPLEDGE DATA FROM BANK CODE :- ' + CONVERT(VARCHAR,@FROM_BANK_CODE)    
                  */    
                  Update #BANK_LIST    
                  --SET TDAY_INTERBANK_UNPLEDGE_VALUE = VALUE    
                  Set    Tday_interbank_unpledge_value = Tday_interbank_unpledge_value + Value    
                  From   (Select From_bank_code,    
                                 Sum(Value) As Value    
                          From   #INTERBANK_TRANSFER_REQUEST    
                          --WHERE TO_BANK_CODE=@BANK_CODE    
                          Where  To_bank_code = @BANK_CODE    
                                 And From_bank_code = @FROM_BANK_CODE    
                          Group  By From_bank_code) A    
                  Where  #bank_list.Bank_code = A.From_bank_code    
    
                  /* PRINT '$$$$$$$$$$$$$$$$$$$$$$$'    
                  */    
                  Print 'RECALCULATING BANKWISE REQUIREMENT/EXCESS AFTER INTER-BANK TRANSFER............'    
    
                  /*    
                  UPDATEING REQUIREMENT/EXCESS FOR INTERBANK    
                  */    
                  Update #BANK_LIST    
                  Set    [Required_excess] = Utilization - (Already_pledge_value - Tday_creditors_unpledge_value - Tday_interbank_unpledge_value) - Tday_debtors_pledge_value - Tday_interbank_pledge_value - Tday_creditors_pledge_value    
                  Where  Bank_code In (@BANK_CODE, @INTERBANK_BANK_CODE)    
    
               /*    
               SELECT 'BANK_DATA AFTER',* FROM #BANK_LIST    
               WHERE BANK_CODE IN (@BANK_CODE,@INTERBANK_BANK_CODE)    
               */    
                  /*    
                  PLEDGEING / UNPLEDGING INTERBANK TRANSFER REQUEST    
                  */    
                  Print ' PUSHING PLEDGE REQUEST FOR INTERBANK'    
    
                  Insert Into #PLEDGE_REQUEST    
                  Select To_bank_code,    
                         To_pledgor_bo_id,    
                         Isin,    
                         Qty,    
                         Value,    
                         'INTERBANK',    
                         2,    
                         @USERNAME    
                 From   #INTERBANK_TRANSFER_REQUEST    
                  Where  To_bank_code = @BANK_CODE    
                         And From_bank_code = @INTERBANK_BANK_CODE    
    
               /** UNPLEDGE STARTED FOR INTERBANK **/    
                  /*    
                  PRINT ' '    
                  PRINT '*************************************************************'    
                  PRINT 'UNPLEDING FOR INTERBANK STARTED FORM BANK_CODE :: ' + CONVERT(VARCHAR,@INTERBANK_BANK_CODE)    
                  */    
                  Print ' PUSHING UNPLEDGE REQUEST FOR INTERBANK'    
    
                  Truncate Table #UNPLEDGE_INTERBANK_ISIN    
    
                  Insert Into #UNPLEDGE_INTERBANK_ISIN    
                  Select From_pledgee_bo_id,    
                         From_pledgor_bo_id,    
                         Agreement_no,    
                         Isin,    
                         Qty,    
                         Clsrate,    
                         Value,    
                         Row_number() Over(Order By Isin)    
                  From   #INTERBANK_TRANSFER_REQUEST    
                  Where  To_bank_code = @BANK_CODE    
                         And From_bank_code = @INTERBANK_BANK_CODE    
    
                  Select @CNT_UNPLEDGE_ISIN = Count(*)    
                  From   #UNPLEDGE_INTERBANK_ISIN    
    
                  --PRINT ' THERE ARE ' + CONVERT(VARCHAR,@CNT_UNPLEDGE_ISIN) + ' RECORDS FOR UNPLEDGING REQUEST'    
                  --PRINT ' '    
                  Set @CTR_UNPLEDGE_ISIN = 1    
    
                  Set @AGREEMENT_NO = ''    
    
                  While(@CTR_UNPLEDGE_ISIN <= @CNT_UNPLEDGE_ISIN)    
                  Begin    
                     Select @FROM_PLEDGEE_BO_ID = From_pledgee_bo_id,    
                            @FROM_PLEDGOR_BO_ID = From_pledgor_bo_id,    
                            @AGREEMENT_NO = Agreement_no,    
                            @ISIN = Isin,    
                            @UNPLEGE_REQ = Qty,    
                            @VALUE = Value,    
                            @CLSRATE = Clsrate    
                     From   #UNPLEDGE_INTERBANK_ISIN    
                     Where  Row_num = @CTR_UNPLEDGE_ISIN    
    
                     /*    
                     PRINT '-------------------------------------------'    
                     PRINT ' ' + CONVERT(VARCHAR,@CTR_UNPLEDGE_ISIN)    
                     PRINT ' ISIN :: ' + CONVERT(VARCHAR,@ISIN)    
                     PRINT ' FROM_PLEDGEE_BO_ID :: ' + CONVERT(VARCHAR,@FROM_PLEDGEE_BO_ID)    
                     PRINT ' FROM_PLEDGOR_BO_ID :: ' + CONVERT(VARCHAR,@FROM_PLEDGOR_BO_ID)    
                     PRINT ' UNPLEGE_REQ :: ' + CONVERT(VARCHAR,@UNPLEGE_REQ)    
                     */    
                     Truncate Table #UNPLEDGE_BANK_DATA    
    
                     Insert Into #UNPLEDGE_BANK_DATA    
                     --SELECT PLEDGOR_BO_ID,PLEDGEE_BO_ID,AGREEMENT_NO,PLEDGE_NO,PLEDGE_QTY,ROW_NUMBER() OVER(ORDER BY PLEDGOR_BO_ID DESC,PLEDGE_NO) AS ROW_NUM    
                     Select @INTERBANK_BANK_CODE,    
                            Pledgor_bo_id,    
                            Pledgee_bo_id,    
                            Agreement_no,    
                            Pledge_no,    
                            (Pledge_qty - Unpledge_qty),    
                            Row_number() Over(Order By Pledgor_bo_id Desc, Pledge_no) As Row_num    
                     From   #PLEDGE A    
                     Where  Isin = @ISIN    
                            And Pledgee_bo_id = @FROM_PLEDGEE_BO_ID    
                            And Pledgor_bo_id = @FROM_PLEDGOR_BO_ID    
                            And Agreement_no = @AGREEMENT_NO    
                            And (Pledge_qty - Unpledge_qty) > 0    
    
                     Select @CNT_UNPLEDGE_BANK = Count(*)    
                     From   #UNPLEDGE_BANK_DATA    
    
                     Set @CTR_UNPLEDGE_BANK = 1    
    
                     Set @UNPLEGE_QTY = 0    
    
                     /*    
                     PRINT ' -------------------------------'    
                     PRINT ' IDENTIFYING UNPLEDGE PLEDGE NO.'    
                     PRINT ' -------------------------------'    
                     */    
                     While(@CTR_UNPLEDGE_BANK <= @CNT_UNPLEDGE_BANK)    
                     Begin    
                        Select @PLEDGOR_BO_ID = Pledgor_bo_id,    
                               @PLEDGEE_BO_ID = Pledgee_bo_id,    
                               @AGREEMENT_NO = Agreement_no,    
                               @PLEDGE_NO = Pledge_no,    
                               --@UNPLEGE_QTY = PLEDGE_QTY    
                               @UNPLEGE_AVAIL = Pledge_qty,    
                               @BANK_CODE = Bank_code    
                        From   #UNPLEDGE_BANK_DATA    
                        Where  Row_num = @CTR_UNPLEDGE_BANK    
    
                        /*    
                        PRINT ' ' + CONVERT(VARCHAR,@CTR_UNPLEDGE_BANK)    
                        PRINT ' AGREEMENT_NO :: ' + CONVERT(VARCHAR,@AGREEMENT_NO)    
                        PRINT ' PLEDGE_NO :: ' + CONVERT(VARCHAR,@PLEDGE_NO)    
                        PRINT ' QTY :: ' + CONVERT(VARCHAR,@UNPLEGE_AVAIL)    
                        */    
                        If((@UNPLEGE_QTY + @UNPLEGE_AVAIL) > @UNPLEGE_REQ)    
                        Begin    
                           Set @UNPLEGE_AVAIL = @UNPLEGE_REQ - @UNPLEGE_QTY    
                        End    
    
                        Insert Into #UNPLEDGE_REQUEST    
                        Values      (@BANK_CODE,    
                                     @ISIN,    
                                     @PLEDGOR_BO_ID,    
                                     @PLEDGEE_BO_ID,    
                                     @AGREEMENT_NO,    
                                     @PLEDGE_NO,    
                                     @UNPLEGE_AVAIL,    
                                     @UNPLEGE_AVAIL * @CLSRATE,    
                                     'INTERBANK')    
    
                        Update #PLEDGE    
                        Set    Unpledge_qty = Unpledge_qty + @UNPLEGE_AVAIL,    
                               Unpledge_value = (Unpledge_qty + @UNPLEGE_AVAIL) * @CLSRATE    
                        Where  Isin = @ISIN    
                               And Pledge_no = @PLEDGE_NO    
                               And Pledgee_bo_id = @PLEDGEE_BO_ID    
                And Agreement_no = @AGREEMENT_NO    
                               And Pledgor_bo_id = @PLEDGOR_BO_ID    
    
                        /*    
                        PRINT ' UNPLEDGE QTY :: ' + CONVERT(VARCHAR,@UNPLEGE_AVAIL)    
                        */    
                        Set @UNPLEGE_QTY = @UNPLEGE_QTY + @UNPLEGE_AVAIL    
    
                        If(@UNPLEGE_QTY >= @UNPLEGE_REQ)    
                        Begin    
                           Break    
                        End    
    
                        Set @CTR_UNPLEDGE_BANK = @CTR_UNPLEDGE_BANK + 1    
                     End    
    
                     Set @UNPLEGE_QTY = 0    
    
                     Set @UNPLEGE_REQ = 0    
    
                     Set @UNPLEGE_AVAIL = 0    
    
                     Set @CTR_UNPLEDGE_ISIN = @CTR_UNPLEDGE_ISIN + 1    
                  End    
               /** UNPLEDGE COMPLETE **/    
               End    
    
               Set @INTERBANK_CTR = @INTERBANK_CTR + 1    
            End    
         End    
    
         Set @BANK_CTR = @BANK_CTR + 1    
      End    
    
      --SET NOCOUNT OFF    
      Print ' COMPLETED'    
    
      Truncate Table #TMP_PLEDGE_DATA    
    
      --SET NOCOUNT ON    
      /*    
      DECLARE @BANK_CTR AS INT,    
      @BANK_TOTAL AS INT,    
      @PRIORITY AS INT,    
      @BANK_CODE AS INT,    
      @REQUIREMENT AS MONEY,    
      @PLEDGE_CTR AS INT,    
      @PLEDGE_CNT AS INT,    
          
      @PLEDGOR_BO_ID AS VARCHAR(20),    
      @ISIN AS VARCHAR(20),    
      @QTY AS INT,    
      @VALUE AS MONEY,    
      @CLSRATE AS MONEY,    
          
      @CHECK_LEFT_QTY AS INT,    
      @PLEDGE_VALUE AS MONEY,    
      @ROW_NUM AS INT    
      */    
      Print ''    
    
      Print ''    
    
      Print 'PLEDGING CREDITORS STOCK'    
    
      Print ' STARTED'    
    
      Select @BANK_TOTAL = Count(*)    
      From   #BANK_LIST    
    
      Select @BANK_CTR = 1    
    
      While (@BANK_CTR <= @BANK_TOTAL)    
      Begin    
         Select @PRIORITY = Priority,    
                @BANK_CODE = Bank_code,    
                @REQUIREMENT = [Required_excess]    
         From   #BANK_LIST    
         Where  Row_num = @BANK_CTR    
    
         If @REQUIREMENT > 0    
         Begin    
            Set @PLEDGE_VALUE = 0    
    
         /*Update #PLEDGABLE_STOCK    
         Set Priority = @PRIORITY    
         Where Isin In (Select Isin    
         From Vw_las_appr_bank_scrip A With (NOLOCK)    
         Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
         On A.Scode = B.Bsecode    
         Where Bank_code = @BANK_CODE) */    
            --AND PRIORITY = 0    
            Update #PLEDGABLE_STOCK    
            Set    Priority = @PRIORITY    
            From   (Select B.Isin,    
                           C.Accno    
                    From   Vw_las_appr_bank_scrip A With (NOLOCK)    
                           Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                            On A.Scode = B.Bsecode    
                           Inner Join (Select Bank_code,    
                                              Accno=Pledgor_bo_id    
                                       From   GENERAL.dbo.Vw_las_comb_bank_agreeement_mast With (NOLOCK)    
                                       Where  Bank_code = @BANK_CODE
											  And Active_Inactive=1) C    
                            On A.Bank_code = C.Bank_code    
                    Where  C.Bank_code = @BANK_CODE) P    
            Where  #pledgable_stock.Accno = P.Accno    
                   And #pledgable_stock.Isin = P.Isin    
    
            Truncate Table #TMP_PLEDGE_DATA    
    
            Insert Into #TMP_PLEDGE_DATA    
            Select Accno,    
                   Isin,    
                   Scrip_cd,    
                   Qty - Pledge_qty,    
                   Value=(Qty - Pledge_qty) * Clsrate,    
                   Clsrate,    
                   Pledge_qty,    
                   Priority,    
                   Client_priority,    
                   Scrip_priority,    
                   Row_num,    
                   Row_number() Over(Order By Accno Desc, Scrip_priority, Value Desc)    
            From   #PLEDGABLE_STOCK    
            Where  Priority = @PRIORITY    
                   And (Qty - Pledge_qty)/*AVAILABLE QTY*/ > 0    
                   And (Qty - Pledge_qty) * Clsrate/*VALUE*/ > 0    
                   And Client_priority = 5    
    
            --BREAK    
            Select @PLEDGE_CNT = Count(*)    
            From   #TMP_PLEDGE_DATA    
    
            Select @PLEDGE_CTR = 1    
    
            While ((@PLEDGE_CTR <= @PLEDGE_CNT)    
                   And (@PLEDGE_VALUE < @REQUIREMENT))    
            Begin    
               Select @PLEDGOR_BO_ID = Accno,    
                      @ISIN = Isin,    
                      @QTY = Qty,    
                      @VALUE = Value,    
                      @CLSRATE = Clsrate,    
                      @ROW_NUM = Row_num    
               From   #TMP_PLEDGE_DATA    
               Where  Rw_nm = @PLEDGE_CTR    
    
            /*    
            PRINT ' '    
            PRINT 'BANK ID :: ' + CONVERT(VARCHAR,@BANK_CODE)    
            PRINT CONVERT(VARCHAR,@PLEDGE_CTR)+' :: ' + @PLEDGOR_BO_ID + ' - ' + @ISIN    
            PRINT ' QTY : ' + CONVERT(VARCHAR,@QTY) + '; VALUE : ' + CONVERT(VARCHAR,@VALUE) + '; CLSRATE : ' + CONVERT(VARCHAR,@CLSRATE) */    
               /*    
               SELECT @CHECK_LEFT_QTY = QTY_AVAILABLE_FOR_PLEDGE-PLEDGE_QTY    
               FROM #ISINWISE_PLEDGE_SUMMARY    
             WHERE ISIN = @ISIN    
                   
               IF @CHECK_LEFT_QTY < @QTY    
               BEGIN    
               SET @QTY = @CHECK_LEFT_QTY    
               END    
               */    
               If (@PLEDGE_VALUE + @VALUE) > @REQUIREMENT    
               Begin    
                  Set @QTY = Ceiling((@REQUIREMENT - @PLEDGE_VALUE) / @CLSRATE)    
               End    
    
               If @QTY < 0    
               Begin    
                  Set @QTY = 0    
               End    
    
               If @QTY > 0    
               Begin    
                  Set @VALUE = @QTY * @CLSRATE    
    
                  Insert Into #PLEDGE_REQUEST    
                  Values      (@BANK_CODE,    
                               @PLEDGOR_BO_ID,    
                               @ISIN,    
                               @QTY,    
                               @VALUE,    
                               'CREDITORS',    
                               0,    
                               '')    
    
                  Update #PLEDGABLE_STOCK    
                  Set    Pledge_qty = Pledge_qty + @QTY    
                  Where  Row_num = @ROW_NUM    
    
                  Set @PLEDGE_VALUE = @PLEDGE_VALUE + @VALUE    
               End    
    
               Set @PLEDGE_CTR = @PLEDGE_CTR + 1    
            End    
         End    
    
         Set @BANK_CTR = @BANK_CTR + 1    
      End    
    
      Print ' COMPLETED'    
    
      --SET NOCOUNT OFF    
      Print ' UPDATING PLEDGE VALUE BANKWISE FOR CREDITORS STOCK'    
    
      /*    
      UPDATE TDAY DEBTORS PLEDGE VALUE    
      */    
      Update #BANK_LIST    
      Set    Tday_creditors_pledge_value = Tday_creditors_pledge_value + Isnull(Pledge_value, 0)    
      From   (Select Bank_code,    
                     Sum(Value) As Pledge_value    
              From   #PLEDGE_REQUEST    
              Where  Request_type = 'CREDITORS'    
              Group  By Bank_code) A    
      Where  #bank_list.Bank_code = A.Bank_code    
    
      Print 'RECALCULATING BANKWISE REQUIREMENT/EXCESS AFTER PLEDGING CREDITORS STOCK............'    
    
      /*    
      RECALCULATING BANKWISE REQUIREMENT/EXCESS AFTER PLEDGING CREDITORS STOCK    
      */    
      Update #BANK_LIST    
      Set    [Required_excess] = Utilization - (Already_pledge_value - Tday_creditors_unpledge_value - Tday_interbank_unpledge_value) - Tday_debtors_pledge_value - Tday_interbank_pledge_value - Tday_creditors_pledge_value    
    
      Print 'FINALIZING AND SAVING PLEDGE/UNPLEDGE REQUEST'    
    
      Delete From Las_pledge_request    
      Where  Convert(Varchar(11), Update_datetime) Like Convert(Varchar(11), Getdate())    
    
      Insert Into Las_pledge_request    
      Select Getdate() As Update_datetime,    
             *--,'' AS APPROVED_BY    
      From   #PLEDGE_REQUEST    
    
      Delete From Las_unpledge_request    
      Where  Convert(Varchar(11), Update_datetime) Like Convert(Varchar(11), Getdate())    
    
      Insert Into Las_unpledge_request    
      Select Getdate() As Update_datetime,    
             *    
      From   #UNPLEDGE_REQUEST    
    
      Delete From Las_interbank_transfer_request    
      Where  Convert(Varchar(11), Update_datetime) Like Convert(Varchar(11), Getdate())    
    
      Insert Into Las_interbank_transfer_request    
      Select Getdate() As Update_datetime,    
             *    
      From   #INTERBANK_TRANSFER_REQUEST    
    
      Insert Into Las_pledge_unpledge_bank_log    
      Select Getdate() As Update_datetime,    
             *,    
             Update_by=Convert(Varchar(20), '')    
      From   #BANK_LIST    
    
      Print 'PROCESS COMPLETED'    
   --End    
    
   Set NOCOUNT Off    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_las_pledge_unpledge_allocation_05022016
-- --------------------------------------------------
Create Procedure [dbo].[Usp_las_pledge_unpledge_allocation_05022016]     
(    
 @USERNAME Varchar(10)    
)    
As    
Begin    
   ----***************PLEDGE AND UNPLEDGE PROCESS START****---    
   Set NOCOUNT On    
    
   If Not Exists (Select Hdate    
                  From   [196.1.115.239].HARMONY.DBO.Holimst A(nolock)    
                  Where  Convert(Datetime, Convert(Varchar, Hdate, 106)) = Convert(Datetime, Convert(Varchar, Getdate(), 106)))    
   Begin    
      Declare @LastProc_Date As Datetime    
    
      Select @LastProc_Date = Convert(Varchar, Max(Processdate), 106)    
      From   Tbl_party_pledge_data With(nolock)    
    
      /*COMMON VARIABLES*/    
      Declare @AGREEMENT_NO      As Varchar(30),    
              @BANK_CODE         As Int,    
              @BANK_CTR          As Int,    
              @BANK_TOTAL        As Int,    
              @CHECK_LEFT_QTY    As Int,    
              @CLSRATE           As Money,    
              @CNT_UNPLEDGE_BANK As Int,    
              @CNT_UNPLEDGE_ISIN As Int,    
              @CTR_UNPLEDGE_BANK As Int,    
              @CTR_UNPLEDGE_ISIN As Int,    
              @ISIN              As Varchar(20),    
              @PLEDGE_CNT        As Int,    
              @PLEDGE_CTR        As Int,    
              @PLEDGE_NO         As Varchar(30),    
              @PLEDGE_VALUE      As Money,    
              @PLEDGEE_BO_ID     As Varchar(30),    
              @PLEDGOR_BO_ID     As Varchar(30),    
              @PRIORITY          As Int,    
              @QTY               As Int,    
              @REQUIREMENT       As Money,    
              @ROW_NUM           As Int,    
              @UNPLEGE_QTY       As Int,    
              @UNPLEGE_REQ       As Int,    
              @VALUE             As Money    
    
      Print 'LOADING HOLDING......'    
    
      Select *    
      Into   #Tbl_party_pledge_data    
      From   Tbl_party_pledge_data(nolock)    
      Where  Processdate >= @LastProc_Date    
             And Processdate <= @LastProc_Date + ' 23:59:59'    
    
      Select Isnull(A.Isin, B.Isin)                                                     As Isin,    
             Isnull(A.Accno, B.Accno)                                                   As Accno,    
             Isnull(A.Scrip_cd, B.Scrip_cd)                                             As Scrip_cd,    
             Isnull(B.Pledgeqty * B.Avg_closing, A.Prevday_pledege_qty * A.Avg_closing) As Total,    
             Isnull(B.Avg_closing, A.Avg_closing)                                       As Clsrate,    
             Isnull(B.Pledgeqty, 0) - Isnull(A.Prevday_pledege_qty, 0)                  As Qty,    
             Nse_approved = Convert(Varchar(2), '0'),    
             Priority = 1    
      Into   #HLD    
      From   (Select Accno,    
                     Isin,    
                     Scrip_cd,    
                     Prevday_pledege_qty=Sum(Prevday_pledege_qty),    
                     Avg_closing=Min(Avg_closing)    
              From   #Tbl_party_pledge_data (NOLOCK)    
              Group  By Accno,Isin,Scrip_cd    
              Having Sum(Prevday_pledege_qty) <> 0) A    
             Full Outer Join (Select Accno,    
                                     Isin,    
                                     Scrip_cd,    
                                     Pledgeqty=Sum(Qty),    
                                     Avg_closing=Min(Avg_closing)    
                              From   #Tbl_party_pledge_data (NOLOCK)    
                              Where  Client_priority = 1    
                              Group  By Accno,Isin,Scrip_cd)B    
              On A.Accno = B.Accno    
                 And A.Isin = B.Isin    
                 And A.Scrip_cd = B.Scrip_cd    
    
      Print 'MARKING APPROVED SCRIPS'    
    
      Update #HLD    
      Set    Nse_approved = 1    
      Where  Exists(Select A.Scode    
                    From   Vw_las_appr_bank_scrip A    
                    Where  #hld.Scrip_cd = A.Scode)    
    
      Select Accno,    
			 Isin,    
             Scrip_cd,    
             Qty=Sum(Qty),    
             Value=Sum(Total),    
             Clsrate=Min(Clsrate),    
             Pledge_qty=Convert(Int, 0),    
             Priority = Convert(Int, 0),    
             Client_priority = Priority,    
             Scrip_priority=Convert(Int, 0),    
             Row_num = Row_number() Over(PARTITION By Priority Order By Isin, Accno)    
      Into   #PLEDGABLE_STOCK    
      From   #HLD With (NOLOCK)    
      Where  Nse_approved <> 0    
             And Qty > 0    
      Group  By Accno,Scrip_cd,Isin,Priority    
      Order  By Accno,Scrip_cd    
    
      ----Added on 16-March-2012    
      -----Pledge Priority Common/uncommon Scrip    
      Update #PLEDGABLE_STOCK    
      Set    Scrip_priority = A.Scrip_priority    
      From   (Select Scode,    
                     Scrip_priority=Count(Scode)    
              From   Vw_las_appr_bank_scrip With (nolock)    
              Group  By Scode) A    
      Where  #pledgable_stock.Scrip_cd = A.Scode    
    
      --DROP TABLE #PLEDGABLE_STOCK    
      Print 'FETCHING DP37 DATA'    
    
   /*START*/    
   /*    
   SELECT SUM(PLEDGE_QTY) AS PLEDGE_QTY,SUM(TOTAL_UNPLEDGE_QTY) AS TOTAL_UNPLEDGE_QTY,    
   SUM(PLEDGE_QTY)-SUM(TOTAL_UNPLEDGE_QTY) AS ACTUALPLEDGE_QTY,ISIN,PLEDGEE_BO_ID,AGREEMENT_NO,--PLEDGOR_BO_ID,    
   CLOSING_PRICE = CONVERT(MONEY,0),VALUE = CONVERT(MONEY,0)    
   INTO #ALREADY_PLEDGE_STOCK    
   FROM [196.1.115.199].SYNERGY.DBO.SYNERGY_DP37 DP WITH(NOLOCK)    
   WHERE PLEDGE_TYPE = 'PLEDGE' AND PLEDGE_QTY-TOTAL_UNPLEDGE_QTY <> 0    
   AND DATE_TIME LIKE 'NOV 9 2011%'    
   AND TRXN_STATUS = 'A'    
   AND PLEDGOR_BO_ID IN ('1203320000000066','1203320000000051')    
   /*    
   AND EXISTS(    
   SELECT BANK_CODE    
   FROM VW_LAS_COMB_BANK_AGREEEMENT_MAST A    
   WHERE DP.PLEDGOR_BO_ID = A.PLEDGOR_BO_ID    
   AND DP.PLEDGEE_BO_ID = A.PLEDGEE_BO_ID    
   AND DP.AGREEMENT_NO = A.AGREEMENT_NO    
   )    
   */    
   GROUP BY ISIN,PLEDGEE_BO_ID,AGREEMENT_NO--,PLEDGOR_BO_ID    
   */    
   /*TEMPORARY FIX TO GET PLEDGE QTY*/    
   /*REQUIRED*/    
   /*TEMPORARY FIX Take Data from inhouse*/    
      /*Select Isin,    
      Pledgor_bo_id,    
      Pledgee_bo_id,    
      Isnull(Agreement_no, '') As Agreement_no,    
      Pledge_no,    
      Pledge_qty,    
      Convert(Money, 0) As Clsrate,    
      Convert(Int, 0) As Unpledge_qty,    
      Convert(Money, 0) As Unpledge_value,    
      Bank_code=Convert(Int, 0)    
      Into #PLEDGE    
      From [196.1.115.199].SYNERGY.DBO.Synergy_dp37 Dp With(NOLOCK)    
      Where Pledge_type = 'PLEDGE'    
      And Trxn_status In ('A', 'D')    
      And Pledgor_bo_id In ('1203320000000066', '1203320000000051')*/    
    
      Select Isin,    
             Clientid                 As Pledgor_bo_id,    
             Bankid                   As Pledgee_bo_id,    
             Isnull(Agreement_no, '') As Agreement_no,    
             Pledgeorder              As Pledge_no,    
             Convert(Int, Pledgeqty)  As Pledge_qty,    
             Convert(Money, 0)        As Clsrate,    
             Convert(Int, 0)          As Unpledge_qty,    
             Convert(Money, 0)        As Unpledge_value,    
             Bank_code=Convert(Int, 0)    
      Into   #PLEDGE    
      From   mis.demat.dbo.Pledge2releaseentry A With(NOLOCK)    
             Left Outer Join GENERAL.dbo.Vw_las_comb_bank_agreeement_mast B With(NOLOCK)    
              On A.Clientid = B.Pledgor_bo_id    
                 And A.Bankid = B.Pledgee_bo_id    
      Where  A.Clientid In ('1203320000000066', '1203320000000051')
			And B.Active_Inactive=1    
    
      --AND AGREEMENT_NO IS NOT NULL    
      --DROP TABLE #PLEDGE    
      Create Nonclustered Index [IX_ROW_NUM]    
       On #PLEDGE ( Isin, Pledge_no, Pledgee_bo_id, Agreement_no, Pledgor_bo_id )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Update #PLEDGE    
      Set    Bank_code = M.Bank_code    
      From   GENERAL.dbo.Vw_las_comb_bank_agreeement_mast M With(nolock)    
      Where  #pledge.Pledgee_bo_id = M.Pledgee_bo_id    
             And #pledge.Pledgor_bo_id = M.Pledgor_bo_id    
			 And M.Active_Inactive=1
      /*Select Pledge_no,    
      Sum(Unpld_conf_qty) As Total_unpledge_qty    
      Into #UNPLEDGE    
      From [196.1.115.199].SYNERGY.DBO.Synergy_dp37 Dp With(NOLOCK)    
      Where Pledge_type = 'UNPLEDGE'    
      And Trxn_status In ('A', 'D')    
      And Exists(Select Pledge_no    
      From #PLEDGE A    
      Where A.Pledge_no = Dp.Pledge_no)    
      Group By Pledge_no */    
    
      Select Pledgeorder                    As Pledge_no,    
             Convert(Int, Sum(Unpledgeqty)) As Total_unpledge_qty    
      Into   #UNPLEDGE    
      From   mis.demat.dbo.Pledge2releaseentry Dp With(NOLOCK)    
      Where  Exists(Select Pledge_no    
                    From   #PLEDGE A    
                    Where  A.Pledge_no = Dp.Pledgeorder)    
      Group  By Pledgeorder    
    
      Select A.Pledge_no,    
             A.Bank_code,    
             Sum(Pledge_qty)                                      As Pledge_qty,    
             Sum(Isnull(Total_unpledge_qty, 0))                   As Total_unpledge_qty,    
             Sum(Pledge_qty) - Sum(Isnull(Total_unpledge_qty, 0)) As Actualpledge_qty,    
             Isin,    
             Pledgee_bo_id,    
             Agreement_no,    
             Pledgor_bo_id,    
             Closing_price = Convert(Money, 0),    
             Value = Convert(Money, 0)    
      Into   #ALREADY_PLEDGE_STOCK    
      From   #PLEDGE A    
             Full Outer Join #UNPLEDGE B    
              On A.Pledge_no = B.Pledge_no    
      Where  Pledge_qty - Isnull(B.Total_unpledge_qty, 0) <> 0    
      Group  By A.Pledge_no,A.Bank_code,Isin,Pledgee_bo_id,Agreement_no,Pledgor_bo_id    
    
      /*END*/    
      Select Isnull(Th.Isin, P.Isin)   As Isin,    
             Isnull(Th.Accno, P.Accno) As Accno,    
             Isnull(Value, 0)          As Available_qty_value,    
             Isnull(Th.Qty, 0)         As Available_qty,    
             Isnull(Clsrate, 0)        As Clsrate,    
             /*Isnull(P.Qty, 0)*/0     As Already_pledge_qty,    
             --Isnull(Th.Qty, 0) - Isnull(P.Qty, 0) As Qty_available_for_pledge,    
             Isnull(Th.Qty, 0)         As Qty_available_for_pledge,    
             Convert(Int, 0)           As Pledge_qty,    
             Priority = Convert(Smallint, 0)    
      Into   #ISINWISE_PLEDGE_SUMMARY    
      From   (Select Isin,    
                     Accno,    
                     Sum(Qty)   As Qty,    
                     Sum(Value) As Value,    
                     Clsrate = Min(Clsrate)    
              From   #PLEDGABLE_STOCK A    
              Where  Client_priority = 1    
              Group  By Isin,Accno) Th    
             Full Outer Join (Select Isin,    
                                     Accno=Pledgor_bo_id,    
                                     Sum(Actualpledge_qty) As Qty    
                              From   #ALREADY_PLEDGE_STOCK    
                              Group  By Isin,Pledgor_bo_id) P    
              On Th.Isin = P.Isin    
                 And Th.Accno = P.Accno    
    
      Print 'UPDATING CLOSING PRICE'    
    
     /*ALREADY PLEDGE DATA*/  
      /* Comment on 09 May 2012  
      PRMS Request ID 10141041   
      */    
      /*--BSECM    
      Update A    
      Set    Closing_price = Rate,    
             Value = Rate * Actualpledge_qty    
      From   #ALREADY_PLEDGE_STOCK A,    
             (Select Isin,    
                     Rate    
              From   GENERAL.dbo.Cp_bsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scode = B.Bsecode) Cp    
      Where  A.Isin = Cp.Isin    
             And Closing_price = 0    
    
      --NSECM    
      Update A    
      Set    Closing_price = Rate,    
             Value = Rate * Actualpledge_qty    
      From   #ALREADY_PLEDGE_STOCK A,    
    (Select Isin,    
                     Cls As Rate    
              From   GENERAL.dbo.Cp_nsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scrip = B.Nsesymbol    
                         And A.Series = B.Nseseries) Cp    
      Where  A.Isin = Cp.Isin    
             And Closing_price = 0 */   
               
      Update A    
      Set    Closing_price = Rate,    
             Value = Rate * Actualpledge_qty    
      From   #ALREADY_PLEDGE_STOCK A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)) Cp    
      Where  Closing_price = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = Cp.AccNo   
         
      Update A    
      Set    Closing_price = Rate,    
             Value = Rate * Actualpledge_qty    
      From   #ALREADY_PLEDGE_STOCK A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000066')) Cp    
      Where  Closing_price = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = '1203320000000051'   
         
      Update A    
      Set    Closing_price = Rate,    
             Value = Rate * Actualpledge_qty    
      From   #ALREADY_PLEDGE_STOCK A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000051')) Cp    
      Where  Closing_price = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = '1203320000000066'    
               
    
        /*PLEDGE DATA*/   
        /* Comment on 09 May 2012  
        PRMS Request ID 10141041   
        */   
      --BSECM    
      /*Update A    
      Set    Clsrate = Rate    
      From   #PLEDGE A,    
             (Select Isin,    
                     Rate    
              From   GENERAL.dbo.Cp_bsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scode = B.Bsecode) Cp    
      Where  A.Isin = Cp.Isin    
             And Clsrate = 0    
    
      --NSECM    
      Update A    
      Set    Clsrate = Rate    
      From   #PLEDGE A,    
             (Select Isin,    
                     Cls As Rate    
              From   GENERAL.dbo.Cp_nsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scrip = B.Nsesymbol    
                         And A.Series = B.Nseseries) Cp    
      Where  A.Isin = Cp.Isin    
             And Clsrate = 0*/  
               
      Update A    
      Set    Clsrate = Rate  
      From   #PLEDGE A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = Cp.AccNo   
         
      Update A    
      Set    Clsrate = Rate  
      From   #PLEDGE A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000066')) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = '1203320000000051'   
         
      Update A    
      Set    Clsrate = Rate  
      From   #PLEDGE A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000051')) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.Pledgor_bo_id = '1203320000000066'      
    
      /*SUMMARY DATA*/  
      /* Comment on 09 May 2012  
      PRMS Request ID 10141041   
      */    
      /*Update A    
      Set    Clsrate = Rate    
      From   #ISINWISE_PLEDGE_SUMMARY A,    
             (Select Isin,    
                     Rate    
              From   GENERAL.dbo.Cp_bsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scode = B.Bsecode) Cp    
      Where  A.Isin = Cp.Isin    
             And Clsrate = 0    
    
      --NSECM    
      Update A    
      Set    Clsrate = Rate    
      From   #ISINWISE_PLEDGE_SUMMARY A,    
             (Select Isin,    
                     Cls As Rate    
              From   GENERAL.dbo.Cp_nsecm A With(NOLOCK)    
                     Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                      On A.Scrip = B.Nsesymbol    
                         And A.Series = B.Nseseries) Cp    
      Where  A.Isin = Cp.Isin    
             And Clsrate = 0 */  
               
        
      Update A    
      Set    Clsrate = Rate  
      From   #ISINWISE_PLEDGE_SUMMARY A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.AccNo = Cp.AccNo   
         
      Update A    
      Set    Clsrate = Rate  
      From   #ISINWISE_PLEDGE_SUMMARY A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000066')) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.AccNo = '1203320000000051'   
         
      Update A    
      Set    Clsrate = Rate  
      From   #ISINWISE_PLEDGE_SUMMARY A,    
             (Select Isin,    
                     Rate=ClsRate,AccNo    
              From   Vw_equity_cls_rate A With(NOLOCK)  
              Where AccNo in ('1203320000000051')) Cp    
      Where  Clsrate = 0    
             And A.Isin = Cp.Isin     
             And A.AccNo = '1203320000000066'     
    
      Print 'LOADING BANK DETAILS'    
    
      --DROP TABLE #BANK_LIST    
      Select Priority,    
             Bank_code,    
             Bankname,    
             Las_line,    
             Utilization,    
             Already_pledge_value = Convert(Money, 0),    
             Tday_creditors_unpledge_value = Convert(Money, 0),    
             Tday_interbank_unpledge_value = Convert(Money, 0),    
             Tday_debtors_pledge_value = Convert(Money, 0),    
             Tday_interbank_pledge_value = Convert(Money, 0),    
             Tday_creditors_pledge_value = Convert(Money, 0),    
             [Required_excess] = Convert(Money, 0),    
             Bo_id,    
             Row_number() Over(Order By Priority) As Row_num    
      Into   #BANK_LIST    
      From   GENERAL.dbo.Tbl_las_bank_master With(NOLOCK)    
      Where  Active_inactive = 1    
      Order  By Priority    
    
      Create Table #UNPLEDGE_REQUEST    
       (    
         Bank_code      Int Not Null,    
         Isin           Varchar(30) Not Null,    
         Pledgor_bo_id  Varchar(30) Not Null,    
         Pledgee_bo_id  Varchar(30) Not Null,    
         Agreement_no   Varchar(30) Not Null,    
         Pledge_no      Varchar(20) Not Null,    
         Unpledge_qty   Int Not Null,    
         Unpledge_value Money Not Null,    
         Request_type   Varchar(20) Not Null/* CREDITORS / INTERBANK */    
       )    
    
      Create Table #UNPLEDGE_BANK_DATA    
       (    
         Bank_code     Int Not Null,    
         Pledgor_bo_id Varchar(30) Not Null,    
         Pledgee_bo_id Varchar(30) Not Null,    
         Agreement_no  Varchar(30) Not Null,    
         Pledge_no     Varchar(20) Not Null,    
         Pledge_qty    Int Not Null,    
         Row_num       Int Not Null    
       )    
    
      Create Clustered Index [IX_ROW_NUM]    
       On #UNPLEDGE_BANK_DATA ( [Row_num] Asc )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Select Isin,    
             Accno,    
             Clsrate=Min(Clsrate),    
             Qty_available_for_pledge=Sum(Qty)    
      Into   #ISINWISE_UNPLEDGE_SUMMARY    
      From   #HLD    
      Group  By Isin,Accno    
    
      Select Isin,    
             Accno,    
             Clsrate,    
             Qty_available_for_pledge,    
             Row_number() Over(Order By Isin) As Row_num    
      Into   #UNPLEDGE_ISIN    
      From   #ISINWISE_UNPLEDGE_SUMMARY    
      Where  Qty_available_for_pledge < 0    
    
   /*    
   drop table #UNPLEDGE_ISIN    
   TRUNCATE TABLE #UNPLEDGE_REQUEST    
   UPDATE #PLEDGE    
   SET UNPLEDGE_QTY = 0,    
   UNPLEDGE_VALUE = 0    
   */    
   --SET NOCOUNT ON    
    
      /*Declare @CNT_UNPLEDGE_ISIN As Int,    
      @CTR_UNPLEDGE_ISIN As Int,    
      @ISIN As Varchar(20),    
      @UNPLEGE_REQ As Int,    
      @CLSRATE As Money,    
      @VALUE As Money,    
      @BANK_CODE As Int,    
      @CNT_UNPLEDGE_BANK As Int,    
      @CTR_UNPLEDGE_BANK As Int,    
      @UNPLEGE_QTY As Int,    
      @PLEDGOR_BO_ID As Varchar(30),    
      @PLEDGEE_BO_ID As Varchar(30),    
      @AGREEMENT_NO As Varchar(30),    
      @PLEDGE_NO As Varchar(30)*/    
    
      Print ''    
    
      Print ''    
    
      Print 'UNPLEDGING CREDITORS STOCK'    
    
      Print ' STARTED'    
    
      Select @CNT_UNPLEDGE_ISIN = Count(*)    
      From   #UNPLEDGE_ISIN    
    
      Set @CTR_UNPLEDGE_ISIN = 1    
    
      While(@CTR_UNPLEDGE_ISIN <= @CNT_UNPLEDGE_ISIN)    
      Begin    
         Select @ISIN = Isin,    
                @UNPLEGE_REQ = Qty_available_for_pledge * -1,    
                @VALUE = Qty_available_for_pledge * Clsrate,    
                @CLSRATE = Clsrate,    
                @PLEDGOR_BO_ID = Accno    
         From   #UNPLEDGE_ISIN    
         Where  Row_num = @CTR_UNPLEDGE_ISIN    
    
         Truncate Table #UNPLEDGE_BANK_DATA    
    
         Insert Into #UNPLEDGE_BANK_DATA    
         Select A.Bank_code,    
                Pledgor_bo_id,    
                Pledgee_bo_id,    
                Agreement_no=Isnull(Agreement_no, ''),    
                Pledge_no,    
                /*Pledge_qty,*/Actualpledge_qty                                          As Pledge_qty,    
                Row_number() Over(Order By Priority Desc, Pledgor_bo_id Desc, Pledge_no) As Row_num    
         From   /*#PLEDGE*/#ALREADY_PLEDGE_STOCK A    
                           Left Outer Join General.dbo.Tbl_las_bank_master B (NOLOCK)    
                            On A.Pledgee_bo_id = B.BO_ID    
         Where  Isin = @ISIN    
                And A.Pledgor_bo_id = @PLEDGOR_BO_ID    
    
         --And Isnull(Agreement_no, '') <> ''    
    
         Select @CNT_UNPLEDGE_BANK = Count(*)    
         From   #UNPLEDGE_BANK_DATA    
    
         Set @CTR_UNPLEDGE_BANK = 1    
    
         While(@CTR_UNPLEDGE_BANK <= @CNT_UNPLEDGE_BANK)    
         Begin    
            Select @PLEDGOR_BO_ID = Pledgor_bo_id,    
                   @PLEDGEE_BO_ID = Pledgee_bo_id,    
                   @AGREEMENT_NO = Agreement_no,    
                   @PLEDGE_NO = Pledge_no,    
                   @UNPLEGE_QTY = Pledge_qty,    
                   @BANK_CODE = Bank_code    
            From   #UNPLEDGE_BANK_DATA    
            Where  Row_num = @CTR_UNPLEDGE_BANK    
    
            If(@UNPLEGE_QTY < @UNPLEGE_REQ)    
            Begin    
               Insert Into #UNPLEDGE_REQUEST    
               Values      (@BANK_CODE,    
                            @ISIN,    
                            @PLEDGOR_BO_ID,    
                            @PLEDGEE_BO_ID,    
                            @AGREEMENT_NO,    
                            @PLEDGE_NO,    
                            @UNPLEGE_QTY,    
                            @CLSRATE * @UNPLEGE_QTY,    
                            'CREDITORS')    
    
               Update #PLEDGE    
               Set    Unpledge_qty = Unpledge_qty + @UNPLEGE_QTY,    
                      Unpledge_value = (Unpledge_qty + @UNPLEGE_QTY) * @CLSRATE    
               Where  Isin = @ISIN    
                      And Pledge_no = @PLEDGE_NO    
                      And Pledgee_bo_id = @PLEDGEE_BO_ID    
                      And Agreement_no = @AGREEMENT_NO    
                      And Pledgor_bo_id = @PLEDGOR_BO_ID    
            End    
            Else    
            Begin    
               Insert Into #UNPLEDGE_REQUEST    
               Values      (@BANK_CODE,    
                            @ISIN,    
                            @PLEDGOR_BO_ID,    
                            @PLEDGEE_BO_ID,    
                            @AGREEMENT_NO,    
                            @PLEDGE_NO,    
                            @UNPLEGE_REQ,    
                            @CLSRATE * @UNPLEGE_REQ,    
                            'CREDITORS')    
    
               Update #PLEDGE    
               Set    Unpledge_qty = Unpledge_qty + @UNPLEGE_REQ,    
              Unpledge_value = (Unpledge_qty + @UNPLEGE_REQ) * @CLSRATE    
               Where  Isin = @ISIN    
                      And Pledge_no = @PLEDGE_NO    
                      And Pledgee_bo_id = @PLEDGEE_BO_ID    
                      And Agreement_no = @AGREEMENT_NO    
                      And Pledgor_bo_id = @PLEDGOR_BO_ID    
            End    
    
            Set @UNPLEGE_REQ = @UNPLEGE_REQ - @UNPLEGE_QTY    
    
            If @UNPLEGE_REQ <= 0    
            Begin    
               Break    
            End    
    
            Set @CTR_UNPLEDGE_BANK = @CTR_UNPLEDGE_BANK + 1    
         End    
    
         Set @UNPLEGE_QTY = 0    
    
         Set @CTR_UNPLEDGE_ISIN = @CTR_UNPLEDGE_ISIN + 1    
      End    
    
      --SET NOCOUNT OFF    
      Print ' COMPLETED'    
    
      Print 'UPDATING UNPLEDGE VALUE BANKWISE FOR CREDITORS STOCK '    
    
      /*    
      UPDATE ALREADY PLEDGE VALUE FROM DP37 FILE DATA    
      */    
      Update #BANK_LIST    
      Set    Already_pledge_value = Isnull(Pledge_value, 0)    
      From   (Select Pledgee_bo_id,    
                     Sum(Value) As Pledge_value    
              From   #ALREADY_PLEDGE_STOCK    
              Group  By Pledgee_bo_id) A    
      Where  #bank_list.Bo_id = A.Pledgee_bo_id    
    
      /*    
      UPDATE TDAY UNPLEDGE VALUE    
      */    
      Update #BANK_LIST    
      Set    Tday_creditors_unpledge_value = Isnull(Unpledge_value, 0)    
      From   (Select Pledgee_bo_id,    
                     Sum(Unpledge_value) As Unpledge_value    
              From   #PLEDGE    
              Where  Unpledge_qty > 0    
              Group  By Pledgee_bo_id) A    
      Where  #bank_list.Bo_id = A.Pledgee_bo_id    
    
      --UPDATE #BANK_LIST SET UTILIZATION = 1500000000.00 WHERE BANK_CODE = 1    
      Print 'RECALCULATING BANKWISE REQUIREMENT/EXCESS AFTER UNPLEDGING CREDITORS STOCK............'    
    
      /*    
      UPDATEING REQUIREMENT FOR DEBTORS CLIENT STOCK    
      */    
      Update #BANK_LIST    
      Set    [Required_excess] = Utilization - (Already_pledge_value - Tday_creditors_unpledge_value - Tday_interbank_unpledge_value) - Tday_debtors_pledge_value - Tday_interbank_pledge_value - Tday_creditors_pledge_value    
    
      Create Table #PLEDGE_REQUEST    
       (    
         Bank_code     Int Not Null,    
         Pledgor_bo_id Varchar(20) Not Null,    
         Isin          Varchar(20) Not Null,    
         Qty           Int Not Null,    
         Value         Money Not Null,    
         Request_type  Varchar(20) Not Null /* DEBITORS / CREDITORS / INTERBANK */,    
         Approved      Int Not Null /*0-UNANSWERED , 1-REJECTED, 2-APPROVED*/,    
         Approved_by   Varchar(100) Not Null    
       )    
    
      Select Top 0 *,    
                   Rw_nm=Convert(Int, 0)    
      Into   #TMP_PLEDGE_DATA    
      From   #PLEDGABLE_STOCK    
    
      Create Clustered Index [IX_ROW_NUM]    
       On #TMP_PLEDGE_DATA ( Rw_nm Asc )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Create Clustered Index [IX_PRIORITY]    
       On #PLEDGABLE_STOCK ( Priority Asc )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Create Nonclustered Index [IX_ROW_NUM]    
       On #PLEDGABLE_STOCK ( Row_num )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Create Clustered Index [IX_ISIN]    
       On #ISINWISE_PLEDGE_SUMMARY ( Isin )    
       With (SORT_IN_TEMPDB = Off, DROP_EXISTING = Off, IGNORE_DUP_KEY = Off, ONLINE = Off, Fillfactor=50) On [PRIMARY]    
    
      Truncate Table #TMP_PLEDGE_DATA    
    
      --SET NOCOUNT ON    
    
      /*DECLARE @BANK_CTR AS INT,    
      @BANK_TOTAL AS INT,    
      @PRIORITY AS INT,    
      @BANK_CODE AS INT,    
      @REQUIREMENT AS MONEY,    
      @PLEDGE_CTR AS INT,    
      @PLEDGE_CNT AS INT,    
          
      @PLEDGOR_BO_ID AS VARCHAR(20),    
      @ISIN AS VARCHAR(20),    
      @QTY AS INT,    
      @VALUE AS MONEY,    
      @CLSRATE AS MONEY,    
          
      @CHECK_LEFT_QTY AS INT,    
      @PLEDGE_VALUE AS MONEY,    
      @ROW_NUM AS INT */    
    
      Print ''    
    
      Print ''    
    
      Print 'PLEDGING DEBITORS STOCK'    
    
      Print ' STARTED'    
    
      Select @BANK_TOTAL = Count(*)    
      From   #BANK_LIST    
    
      Select @BANK_CTR = 1    
    
      While (@BANK_CTR <= @BANK_TOTAL)    
      Begin    
         Select @PRIORITY = Priority,    
                @BANK_CODE = Bank_code,    
                @REQUIREMENT = [Required_excess]    
         From   #BANK_LIST    
         Where  Row_num = @BANK_CTR    
    
         If @REQUIREMENT > 0    
         Begin    
            Set @PLEDGE_VALUE = 0    
    
            /*Update #PLEDGABLE_STOCK    
            Set Priority = @PRIORITY    
            Where Isin In (Select Isin    
            From Vw_las_appr_bank_scrip A With (NOLOCK)    
            Inner Join Scrip_master B With(NOLOCK)    
            On A.Scode = B.Bsecode    
            Where Bank_code = @BANK_CODE)    
            ----- Addtional condition for BSE Exchenge only 66 Acc    
            Or (Accno = '1203320000000066'    
            And @Bank_code = 8)*/    
    
            Update #PLEDGABLE_STOCK    
            Set    Priority = @PRIORITY    
            From   (Select B.Isin,    
                           C.Accno    
                    From   Vw_las_appr_bank_scrip A With (NOLOCK)    
                           Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                            On A.Scode = B.Bsecode    
                           Inner Join (Select Bank_code,    
                                              Accno=Pledgor_bo_id    
                                       From   GENERAL.dbo.Vw_las_comb_bank_agreeement_mast With (NOLOCK)    
                                       Where  Bank_code = @BANK_CODE
											And Active_Inactive=1) C    
                            On A.Bank_code = C.Bank_code    
                    Where  C.Bank_code = @BANK_CODE) P    
            Where  #pledgable_stock.Accno = P.Accno    
                   And #pledgable_stock.Isin = P.Isin    
    
            Truncate Table #TMP_PLEDGE_DATA    
    
            Insert Into #TMP_PLEDGE_DATA    
            Select Accno,    
                   Isin,    
                   Scrip_cd,    
                   Qty - Pledge_qty,    
                   Value=(Qty - Pledge_qty) * Clsrate,    
                   Clsrate,    
                   Pledge_qty,    
                   Priority,    
                   Client_priority,    
                   Scrip_priority,    
                   Row_num,    
                   Row_number() Over(Order By Accno Desc, Scrip_priority, Value Desc)    
            From   #PLEDGABLE_STOCK    
            Where  Priority = @PRIORITY    
                   And (Qty - Pledge_qty)/*AVAILABLE QTY*/ > 0    
                   And (Qty - Pledge_qty) * Clsrate/*VALUE*/ > 0    
                   And Client_priority = 1    
    
            --BREAK    
            Select @PLEDGE_CNT = Count(*)    
            From   #TMP_PLEDGE_DATA    
    
            Select @PLEDGE_CTR = 1    
    
            While ((@PLEDGE_CTR <= @PLEDGE_CNT)    
                   And (@PLEDGE_VALUE < @REQUIREMENT))    
            Begin    
               Select @PLEDGOR_BO_ID = Accno,    
                      @ISIN = Isin,    
                      @QTY = Qty,    
                      @VALUE = Value,    
                      @CLSRATE = Clsrate,    
                      @ROW_NUM = Row_num    
               From   #TMP_PLEDGE_DATA    
               Where  Rw_nm = @PLEDGE_CTR    
    
               /*    
               PRINT ' '    
               PRINT 'BANK ID :: ' + CONVERT(VARCHAR,@BANK_CODE)    
               PRINT CONVERT(VARCHAR,@PLEDGE_CTR)+' :: ' + @PLEDGOR_BO_ID + ' - ' + @ISIN    
               PRINT ' QTY : ' + CONVERT(VARCHAR,@QTY) + '; VALUE : ' + CONVERT(VARCHAR,@VALUE) + '; CLSRATE : ' + CONVERT(VARCHAR,@CLSRATE)    
               */    
               Select @CHECK_LEFT_QTY = Qty_available_for_pledge - Pledge_qty    
               From   #ISINWISE_PLEDGE_SUMMARY    
               Where  Isin = @ISIN    
                      And Accno = @PLEDGOR_BO_ID    
    
               If @CHECK_LEFT_QTY < @QTY    
               Begin    
                  Set @QTY = @CHECK_LEFT_QTY    
               End    
    
               If (@PLEDGE_VALUE + @VALUE) > @REQUIREMENT    
               Begin    
                  Set @QTY = Ceiling((@REQUIREMENT - @PLEDGE_VALUE) / @CLSRATE)    
               End    
    
               If @QTY < 0    
               Begin    
                  Set @QTY = 0    
               End    
    
               If @QTY > 0    
               Begin    
                  Set @VALUE = @QTY * @CLSRATE    
    
                  Insert Into #PLEDGE_REQUEST    
                  Values      (@BANK_CODE,    
                               @PLEDGOR_BO_ID,    
                               @ISIN,    
                               @QTY,    
                               @VALUE,    
                               'DEBITORS',    
                               2,    
                               @USERNAME)    
    
                  Update #ISINWISE_PLEDGE_SUMMARY    
                  Set    Pledge_qty = Pledge_qty + @QTY    
                  Where  Isin = @ISIN    
                         And Accno = @PLEDGOR_BO_ID    
    
                  Update #PLEDGABLE_STOCK    
                  Set    Pledge_qty = Pledge_qty + @QTY    
                  Where  Row_num = @ROW_NUM    
    
                  Set @PLEDGE_VALUE = @PLEDGE_VALUE + @VALUE    
               End    
    
               Set @PLEDGE_CTR = @PLEDGE_CTR + 1    
            End    
         End    
    
         Set @BANK_CTR = @BANK_CTR + 1    
      End    
    
      --SET NOCOUNT OFF    
      Print ' COMPLETED'    
    
      Print 'UPDATING PLEDGE VALUE BANKWISE FOR DEBITORS STOCK'    
    
      /*    
      UPDATE TDAY DEBTORS PLEDGE VALUE    
      */    
      Update #BANK_LIST    
      Set    Tday_debtors_pledge_value = Tday_debtors_pledge_value + Isnull(Pledge_value, 0)    
      From   (Select Bank_code,    
                     Sum(Value) As Pledge_value    
              From   #PLEDGE_REQUEST    
              Where  Request_type = 'DEBITORS'    
              Group  By Bank_code) A    
      Where  #bank_list.Bank_code = A.Bank_code    
    
      Print 'RECALCULATING BANKWISE REQUIREMENT/EXCESS AFTER PLEDGING DEBITORS STOCK............'    
    
      /*    
      RE-UPDATEING REQUIREMENT FOR INTERBANK    
      */    
      Update #BANK_LIST    
      Set    [Required_excess] = Utilization - (Already_pledge_value - Tday_creditors_unpledge_value - Tday_interbank_unpledge_value) - Tday_debtors_pledge_value - Tday_interbank_pledge_value - Tday_creditors_pledge_value    
    
      --UPDATE #BANK_LIST SET [REQUIRED_EXCESS] = [REQUIRED_EXCESS] + 100000000 WHERE UTILIZATION > 0    
      Update #BANK_LIST    
      Set    [Required_excess] = 0    
      Where  Utilization = 0    
    
      Create Table #BANK_LIST_FOR_INTERBANK    
       (    
         Bank_id                  Int Not Null,    
         [Available_for_transfer] Money Not Null,    
         Row_num                  Int Not Null,    
         Amount_unpledged         Money Not Null    
       )    
    
      Create Table #INTERBANK_TRANSFER_REQUEST    
       (    
         From_bank_code     Int Not Null,    
         From_pledgee_bo_id Varchar(20) Not Null,    
         From_pledgor_bo_id Varchar(20) Not Null,    
         To_bank_code       Int Not Null,    
         To_pledgee_bo_id   Varchar(20) Not Null,    
         To_pledgor_bo_id   Varchar(20) Not Null,    
         Agreement_no       Varchar(30) Not Null,    
         Isin               Varchar(20) Not Null,    
         Qty                Int Not Null,    
         Clsrate            Money Not Null,    
         Value              Money Not Null    
       )    
    
      Create Table #INTERBANK_TRANSFER_REQUEST_TMP    
       (    
         From_bank_code     Int Not Null,    
         From_pledgee_bo_id Varchar(20) Not Null,    
         From_pledgor_bo_id Varchar(20) Not Null,    
         Agreement_no       Varchar(30) Not Null,    
         Isin               Varchar(20) Not Null,    
         Qty                Int Not Null,    
         Clsrate            Money Not Null,    
         Value              Money Not Null,    
         Row_num            Int Not Null    
       )    
    
      Create Table #UNPLEDGE_INTERBANK_ISIN    
       (    
         From_pledgee_bo_id Varchar(20) Not Null,    
         From_pledgor_bo_id Varchar(20) Not Null,    
         Agreement_no       Varchar(30) Not Null,    
         Isin               Varchar(20) Not Null,    
         Qty                Int Not Null,    
         Clsrate            Money Not Null,    
         Value              Money Not Null,    
         Row_num            Int Not Null    
       )    
    
      Truncate Table #INTERBANK_TRANSFER_REQUEST    
    
      /*    
      --SET NOCOUNT ON    
      DECLARE @BANK_CTR AS INT,    
      @BANK_TOTAL AS INT,    
          
      @INTERBANK_CTR AS INT,    
      @INTERBANK_TOTAL AS INT,    
      @INTERBANK_BANK_CODE AS INT,    
      @INTERBANK_AVAILABLE AS INT,    
      @INTERBANK_TRANSFER_VALUE AS MONEY,    
      @INTERBANK_BANKTRANSFER_VALUE AS MONEY,    
          
      @ACTUAL_AVALABLE_FUND AS MONEY,    
          
      @FROM_BANK_CODE AS INT,    
      @FROM_PLEDGEE_BO_ID AS VARCHAR(20),    
      @FROM_PLEDGOR_BO_ID AS VARCHAR(20),    
          
      @AGREEMENT_NO AS VARCHAR(30),    
          
      @PRIORITY AS INT,    
      @BANK_CODE AS INT,    
      @REQUIREMENT AS MONEY,    
      @PLEDGE_CTR AS INT,    
      @PLEDGE_CNT AS INT,    
          
      @PLEDGOR_BO_ID AS VARCHAR(20),    
      @ISIN AS VARCHAR(20),    
      @QTY AS INT,    
      @VALUE AS MONEY,    
      @CLSRATE AS MONEY,    
          
      @CHECK_LEFT_QTY AS INT,    
      @PLEDGE_VALUE AS MONEY,    
      @ROW_NUM AS INT    
          
          
      DECLARE @CNT_UNPLEDGE_ISIN AS INT,    
      @CTR_UNPLEDGE_ISIN AS INT,    
      @UNPLEGE_REQ AS INT,    
      @UNPLEGE_AVAIL AS INT,    
          
      @CNT_UNPLEDGE_BANK AS INT,    
      @CTR_UNPLEDGE_BANK AS INT,    
      @UNPLEGE_QTY AS INT,    
      @PLEDGEE_BO_ID AS VARCHAR(30),    
      @PLEDGE_NO AS VARCHAR(30)    
          
      */    
      Print ''    
    
      Print ''    
    
      Print 'INTERBANK REQUIREMENT ANALYSIS & ALLOCATION STARTED'    
    
      Print ' STARTED'    
    
      /* PLEDGING/UNPLEDGING INTERBANK STOCK*/    
      Declare @INTERBANK_CTR                As Int,    
              @INTERBANK_TOTAL              As Int,    
              @INTERBANK_BANK_CODE          As Int,    
              @INTERBANK_AVAILABLE          As Int,    
              @INTERBANK_TRANSFER_VALUE     As Money,    
              @INTERBANK_BANKTRANSFER_VALUE As Money,    
              @ACTUAL_AVALABLE_FUND         As Money,    
              @FROM_BANK_CODE               As Int,    
              @FROM_PLEDGEE_BO_ID           As Varchar(20),    
              @FROM_PLEDGOR_BO_ID           As Varchar(20),    
              @UNPLEGE_AVAIL                As Int    
    
      Select @BANK_TOTAL = Count(*)    
      From   #BANK_LIST    
    
      Select @BANK_CTR = 1    
    
      Print ' THERE ARE ' + Convert(Varchar, @BANK_CTR) + ' BANKS FOR INTER BANK TRANSFER'    
    
      /*LOOP THROUGH BANK HAVING REQUIREMENT FOR INTERBANK TRANSFER*/    
      While (@BANK_CTR <= @BANK_TOTAL)    
      Begin    
         Select @PRIORITY = Priority,    
                @BANK_CODE = Bank_code,    
                @REQUIREMENT = [Required_excess]    
         From   #BANK_LIST    
         Where  Row_num = @BANK_CTR    
    
         If @REQUIREMENT > 0    
         Begin    
            --SET @INTERBANK_TRANSFER_VALUE = 0    
            Truncate Table #BANK_LIST_FOR_INTERBANK    
    
            Insert Into #BANK_LIST_FOR_INTERBANK    
            Select Bank_code,    
                   (([Required_excess] * -1) - (Utilization * 0.25 / 100)) As [Available_for_transfer],    
                   Row_number() Over(Order By Priority)                    As Row_num,    
                   0                                                       As Unpledge_value    
            From   #BANK_LIST    
            Where  [Required_excess] < 0    
                   And [Required_excess] * -1 > (Utilization * 0.25 / 100) /*0.25% OF UTILIZATION + UTILIZATION*/    
    
            /*    
            SELECT 'INTERBANK TRANSFER DATA',*,(([REQUIRED_EXCESS]*-1)-;(UTILIZATION*0.25/100)) AS [AVAILABLE_FOR_TRANSFER],    
            ROW_NUMBER() OVER(ORDER BY PRIORITY) AS ROW_NUM,0 AS UNPLEDGE_VALUE    
            FROM #BANK_LIST    
            WHERE [REQUIRED_EXCESS] < 0 AND [REQUIRED_EXCESS]*-1 > (UTILIZATION*0.25/100) /*0.25% OF UTILIZATION + UTILIZATION*/    
            */    
            Print ''    
    
            Print ' BANK CODE :: ' + Convert(Varchar, @BANK_CODE)    
    
            Select @INTERBANK_TOTAL = Count(*)    
            From   #BANK_LIST_FOR_INTERBANK    
    
            Set @INTERBANK_CTR = 1    
    
            /*LOOP THROUGH BANK HAVING EXCESS FOR INTERBANK TRANSFER*/    
            While (@INTERBANK_CTR <= @INTERBANK_TOTAL)    
            Begin    
               Select @INTERBANK_BANK_CODE = Bank_id,    
                      @INTERBANK_AVAILABLE = [Available_for_transfer]    
               From   #BANK_LIST_FOR_INTERBANK    
               Where  Row_num = @INTERBANK_CTR    
    
               Truncate Table #INTERBANK_TRANSFER_REQUEST_TMP    
    
               Insert Into #INTERBANK_TRANSFER_REQUEST_TMP    
               Select Bank_code,    
                      Pledgee_bo_id,    
                      Pledgor_bo_id,    
                      P.Agreement_no,    
                      Isin,    
                      Sum(Pledge_qty - Unpledge_qty),    
                      Min(Clsrate),    
                      Sum((Pledge_qty - Unpledge_qty) * Clsrate),    
                      Row_number() Over(Order By Pledgor_bo_id Desc, Sum((Pledge_qty-Unpledge_qty)*Clsrate) Desc )    
               From   #PLEDGE P    
               Where  Bank_code = @INTERBANK_BANK_CODE    
                      And Clsrate <> 0    
                      And Exists(Select Isin    
                                 From   Vw_las_appr_bank_scrip A With (NOLOCK)    
                                        Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                                         On A.Scode = B.Bsecode    
                                 Where  Bank_code = @BANK_CODE    
                                        And P.Isin = B.Isin)    
                      And Exists (Select Bank.Agreement_no    
                                  From   GENERAL.dbo.Vw_las_comb_bank_agreeement_mast Bank    
                                  Where  Bank_code = @INTERBANK_BANK_CODE    
                                         And Bank.Agreement_no = P.Agreement_no
                                         And Bank.Active_Inactive=1)    
               --AND (PLEDGE_QTY-UNPLEDGE_QTY) > 0    
               Group  By Bank_code,Pledgor_bo_id,Pledgee_bo_id,P.Agreement_no,Isin    
    
               Select @PLEDGE_CNT = Count(*)    
               From   #INTERBANK_TRANSFER_REQUEST_TMP    
    
               Select @PLEDGE_CTR = 1    
    
            /*LOOP THROUGH COMMON SCRIPS WHICH CAN BE TRANSFERED*/    
               /*    
               FETCHING TRANSFER DATA    
               */    
               If (@REQUIREMENT > 0)    
                  And (@INTERBANK_AVAILABLE > 0)    
               Begin    
                  Print @INTERBANK_BANK_CODE    
    
                  Print @INTERBANK_AVAILABLE    
    
                  Print @REQUIREMENT    
    
                  While (@PLEDGE_CTR <= @PLEDGE_CNT)    
                  Begin    
                     Select @FROM_BANK_CODE = From_bank_code,    
                            @FROM_PLEDGEE_BO_ID = From_pledgee_bo_id,    
                            @FROM_PLEDGOR_BO_ID = From_pledgor_bo_id,    
                            @AGREEMENT_NO = Agreement_no,    
                            @ISIN = Isin,    
                            @QTY = Qty,    
                            @VALUE = Value,    
                            @CLSRATE = Clsrate,    
                            @ROW_NUM = Row_num    
                     From   #INTERBANK_TRANSFER_REQUEST_TMP    
                     Where  Row_num = @PLEDGE_CTR    
    
                     /*    
                     PRINT '------------------------------------------------------------------- '    
                     PRINT 'REQUIRE BANK CODE :: ' + CONVERT(VARCHAR,@BANK_CODE)    
                     PRINT 'REQUIREMENT :: ' + CONVERT(VARCHAR,@REQUIREMENT)    
                         
                     PRINT 'FROM BANK ID :: ' + CONVERT(VARCHAR,@FROM_BANK_CODE)    
                     PRINT 'AVAILABLE :: ' + CONVERT(VARCHAR,@INTERBANK_AVAILABLE)    
                         
                     PRINT CONVERT(VARCHAR,@PLEDGE_CTR)+' :: ' + @FROM_PLEDGEE_BO_ID + ' - ' + @ISIN    
                     PRINT ' QTY : ' + CONVERT(VARCHAR,@QTY) + '; VALUE : ' + CONVERT(VARCHAR,@VALUE) + '; CLSRATE : ' + CONVERT(VARCHAR,@CLSRATE)    
                     */    
                     If @INTERBANK_AVAILABLE < @REQUIREMENT    
                      Set @ACTUAL_AVALABLE_FUND = @INTERBANK_AVAILABLE    
                     Else    
                      Set @ACTUAL_AVALABLE_FUND = @REQUIREMENT    
    
                     If @ACTUAL_AVALABLE_FUND < @VALUE    
                     Begin    
                        Set @QTY = Ceiling(@ACTUAL_AVALABLE_FUND / @CLSRATE)    
                     End    
    
                     If @QTY > 0    
                     Begin    
                        Set @VALUE = @QTY * @CLSRATE    
    
                        Insert Into #INTERBANK_TRANSFER_REQUEST    
                        Values      (@FROM_BANK_CODE,    
                                     @FROM_PLEDGEE_BO_ID,    
                                     @FROM_PLEDGOR_BO_ID,    
                                     @BANK_CODE,    
                                     '',    
                                     @FROM_PLEDGOR_BO_ID,    
                                     @AGREEMENT_NO,    
                                     @ISIN,    
                                     @QTY,    
                                     @CLSRATE,    
                                     @VALUE)    
    
                        Set @REQUIREMENT = @REQUIREMENT - @VALUE    
    
                        Set @INTERBANK_AVAILABLE = @INTERBANK_AVAILABLE - @VALUE    
                     End    
    
                     /*    
                     PRINT ' TRANSFER QTY : ' + CONVERT(VARCHAR,@QTY) + '; TRANSFER VALUE : ' + CONVERT(VARCHAR,@VALUE)    
                     */    
                     If (@REQUIREMENT < 0)    
                         Or (@INTERBANK_AVAILABLE < 0)    
                     Begin    
                        /*    
                        PRINT ' '    
        PRINT ' REQUIREMENT :: '+CONVERT(VARCHAR,@REQUIREMENT)    
                        PRINT ' INTERBANK AVAILABLE :: '+CONVERT(VARCHAR,@INTERBANK_AVAILABLE)    
                        */    
                        Break    
                     End    
    
                     Set @PLEDGE_CTR = @PLEDGE_CTR + 1    
                  End    
    
               /*MAINTAIN STATE AT BANK LEVEL FOR RE-CALCULATING REQUIREMENT/EXCESS*/    
               /*    
               SELECT 'BANK_DATA BEFORE',* FROM #BANK_LIST    
               WHERE BANK_CODE IN (@BANK_CODE,@INTERBANK_BANK_CODE)    
               */    
                  /*    
                  PRINT ' '    
                  PRINT '$$$$$$$$$$$$$$$$$$$$$$$'    
                  PRINT ' UPDATING BANKWISE DATA '    
                      
                  PRINT ' PLEDGE DATA TO BANK CODE :- ' + CONVERT(VARCHAR,@BANK_CODE)    
                  */    
                  Print ' UPDATING PLEDGE/UNPLEDGE VALUE BANKWISE FOR INTERBANK TRANSFER'    
    
                  Print @BANK_CODE    
    
                  Print @FROM_BANK_CODE    
    
                  Update #BANK_LIST    
                  --SET TDAY_INTERBANK_PLEDGE_VALUE = VALUE    
                  Set    Tday_interbank_pledge_value = Tday_interbank_pledge_value + Value    
                  From   (Select To_bank_code,    
                                 Sum(Value) As Value    
                          From   #INTERBANK_TRANSFER_REQUEST    
                          --WHERE TO_BANK_CODE=@BANK_CODE    
                          Where  To_bank_code = @BANK_CODE    
                                 And From_bank_code = @FROM_BANK_CODE    
                          Group  By To_bank_code) A    
                  Where  #bank_list.Bank_code = A.To_bank_code    
    
                  /*    
                  PRINT ' UNPLEDGE DATA FROM BANK CODE :- ' + CONVERT(VARCHAR,@FROM_BANK_CODE)    
                  */    
                  Update #BANK_LIST    
                  --SET TDAY_INTERBANK_UNPLEDGE_VALUE = VALUE    
                  Set    Tday_interbank_unpledge_value = Tday_interbank_unpledge_value + Value    
                  From   (Select From_bank_code,    
                                 Sum(Value) As Value    
                          From   #INTERBANK_TRANSFER_REQUEST    
                          --WHERE TO_BANK_CODE=@BANK_CODE    
                          Where  To_bank_code = @BANK_CODE    
                                 And From_bank_code = @FROM_BANK_CODE    
                          Group  By From_bank_code) A    
                  Where  #bank_list.Bank_code = A.From_bank_code    
    
                  /* PRINT '$$$$$$$$$$$$$$$$$$$$$$$'    
                  */    
                  Print 'RECALCULATING BANKWISE REQUIREMENT/EXCESS AFTER INTER-BANK TRANSFER............'    
    
                  /*    
                  UPDATEING REQUIREMENT/EXCESS FOR INTERBANK    
                  */    
                  Update #BANK_LIST    
                  Set    [Required_excess] = Utilization - (Already_pledge_value - Tday_creditors_unpledge_value - Tday_interbank_unpledge_value) - Tday_debtors_pledge_value - Tday_interbank_pledge_value - Tday_creditors_pledge_value    
                  Where  Bank_code In (@BANK_CODE, @INTERBANK_BANK_CODE)    
    
               /*    
               SELECT 'BANK_DATA AFTER',* FROM #BANK_LIST    
               WHERE BANK_CODE IN (@BANK_CODE,@INTERBANK_BANK_CODE)    
               */    
                  /*    
                  PLEDGEING / UNPLEDGING INTERBANK TRANSFER REQUEST    
                  */    
                  Print ' PUSHING PLEDGE REQUEST FOR INTERBANK'    
    
                  Insert Into #PLEDGE_REQUEST    
                  Select To_bank_code,    
                         To_pledgor_bo_id,    
                         Isin,    
                         Qty,    
                         Value,    
                         'INTERBANK',    
                         2,    
                         @USERNAME    
                 From   #INTERBANK_TRANSFER_REQUEST    
                  Where  To_bank_code = @BANK_CODE    
                         And From_bank_code = @INTERBANK_BANK_CODE    
    
               /** UNPLEDGE STARTED FOR INTERBANK **/    
                  /*    
                  PRINT ' '    
                  PRINT '*************************************************************'    
                  PRINT 'UNPLEDING FOR INTERBANK STARTED FORM BANK_CODE :: ' + CONVERT(VARCHAR,@INTERBANK_BANK_CODE)    
                  */    
                  Print ' PUSHING UNPLEDGE REQUEST FOR INTERBANK'    
    
                  Truncate Table #UNPLEDGE_INTERBANK_ISIN    
    
                  Insert Into #UNPLEDGE_INTERBANK_ISIN    
                  Select From_pledgee_bo_id,    
                         From_pledgor_bo_id,    
                         Agreement_no,    
                         Isin,    
                         Qty,    
                         Clsrate,    
                         Value,    
                         Row_number() Over(Order By Isin)    
                  From   #INTERBANK_TRANSFER_REQUEST    
                  Where  To_bank_code = @BANK_CODE    
                         And From_bank_code = @INTERBANK_BANK_CODE    
    
                  Select @CNT_UNPLEDGE_ISIN = Count(*)    
                  From   #UNPLEDGE_INTERBANK_ISIN    
    
                  --PRINT ' THERE ARE ' + CONVERT(VARCHAR,@CNT_UNPLEDGE_ISIN) + ' RECORDS FOR UNPLEDGING REQUEST'    
                  --PRINT ' '    
                  Set @CTR_UNPLEDGE_ISIN = 1    
    
                  Set @AGREEMENT_NO = ''    
    
                  While(@CTR_UNPLEDGE_ISIN <= @CNT_UNPLEDGE_ISIN)    
                  Begin    
                     Select @FROM_PLEDGEE_BO_ID = From_pledgee_bo_id,    
                            @FROM_PLEDGOR_BO_ID = From_pledgor_bo_id,    
                            @AGREEMENT_NO = Agreement_no,    
                            @ISIN = Isin,    
                            @UNPLEGE_REQ = Qty,    
                            @VALUE = Value,    
                            @CLSRATE = Clsrate    
                     From   #UNPLEDGE_INTERBANK_ISIN    
                     Where  Row_num = @CTR_UNPLEDGE_ISIN    
    
                     /*    
                     PRINT '-------------------------------------------'    
                     PRINT ' ' + CONVERT(VARCHAR,@CTR_UNPLEDGE_ISIN)    
                     PRINT ' ISIN :: ' + CONVERT(VARCHAR,@ISIN)    
                     PRINT ' FROM_PLEDGEE_BO_ID :: ' + CONVERT(VARCHAR,@FROM_PLEDGEE_BO_ID)    
                     PRINT ' FROM_PLEDGOR_BO_ID :: ' + CONVERT(VARCHAR,@FROM_PLEDGOR_BO_ID)    
                     PRINT ' UNPLEGE_REQ :: ' + CONVERT(VARCHAR,@UNPLEGE_REQ)    
                     */    
                     Truncate Table #UNPLEDGE_BANK_DATA    
    
                     Insert Into #UNPLEDGE_BANK_DATA    
                     --SELECT PLEDGOR_BO_ID,PLEDGEE_BO_ID,AGREEMENT_NO,PLEDGE_NO,PLEDGE_QTY,ROW_NUMBER() OVER(ORDER BY PLEDGOR_BO_ID DESC,PLEDGE_NO) AS ROW_NUM    
                     Select @INTERBANK_BANK_CODE,    
                            Pledgor_bo_id,    
                            Pledgee_bo_id,    
                            Agreement_no,    
                            Pledge_no,    
                            (Pledge_qty - Unpledge_qty),    
                            Row_number() Over(Order By Pledgor_bo_id Desc, Pledge_no) As Row_num    
                     From   #PLEDGE A    
                     Where  Isin = @ISIN    
                            And Pledgee_bo_id = @FROM_PLEDGEE_BO_ID    
                            And Pledgor_bo_id = @FROM_PLEDGOR_BO_ID    
                            And Agreement_no = @AGREEMENT_NO    
                            And (Pledge_qty - Unpledge_qty) > 0    
    
                     Select @CNT_UNPLEDGE_BANK = Count(*)    
                     From   #UNPLEDGE_BANK_DATA    
    
                     Set @CTR_UNPLEDGE_BANK = 1    
    
                     Set @UNPLEGE_QTY = 0    
    
                     /*    
                     PRINT ' -------------------------------'    
                     PRINT ' IDENTIFYING UNPLEDGE PLEDGE NO.'    
                     PRINT ' -------------------------------'    
                     */    
                     While(@CTR_UNPLEDGE_BANK <= @CNT_UNPLEDGE_BANK)    
                     Begin    
                        Select @PLEDGOR_BO_ID = Pledgor_bo_id,    
                               @PLEDGEE_BO_ID = Pledgee_bo_id,    
                               @AGREEMENT_NO = Agreement_no,    
                               @PLEDGE_NO = Pledge_no,    
                               --@UNPLEGE_QTY = PLEDGE_QTY    
                               @UNPLEGE_AVAIL = Pledge_qty,    
                               @BANK_CODE = Bank_code    
                        From   #UNPLEDGE_BANK_DATA    
                        Where  Row_num = @CTR_UNPLEDGE_BANK    
    
                        /*    
                        PRINT ' ' + CONVERT(VARCHAR,@CTR_UNPLEDGE_BANK)    
                        PRINT ' AGREEMENT_NO :: ' + CONVERT(VARCHAR,@AGREEMENT_NO)    
                        PRINT ' PLEDGE_NO :: ' + CONVERT(VARCHAR,@PLEDGE_NO)    
                        PRINT ' QTY :: ' + CONVERT(VARCHAR,@UNPLEGE_AVAIL)    
                        */    
                        If((@UNPLEGE_QTY + @UNPLEGE_AVAIL) > @UNPLEGE_REQ)    
                        Begin    
                           Set @UNPLEGE_AVAIL = @UNPLEGE_REQ - @UNPLEGE_QTY    
                        End    
    
                        Insert Into #UNPLEDGE_REQUEST    
                        Values      (@BANK_CODE,    
                                     @ISIN,    
                                     @PLEDGOR_BO_ID,    
                                     @PLEDGEE_BO_ID,    
                                     @AGREEMENT_NO,    
                                     @PLEDGE_NO,    
                                     @UNPLEGE_AVAIL,    
                                     @UNPLEGE_AVAIL * @CLSRATE,    
                                     'INTERBANK')    
    
                        Update #PLEDGE    
                        Set    Unpledge_qty = Unpledge_qty + @UNPLEGE_AVAIL,    
                               Unpledge_value = (Unpledge_qty + @UNPLEGE_AVAIL) * @CLSRATE    
                        Where  Isin = @ISIN    
                               And Pledge_no = @PLEDGE_NO    
                               And Pledgee_bo_id = @PLEDGEE_BO_ID    
                And Agreement_no = @AGREEMENT_NO    
                               And Pledgor_bo_id = @PLEDGOR_BO_ID    
    
                        /*    
                        PRINT ' UNPLEDGE QTY :: ' + CONVERT(VARCHAR,@UNPLEGE_AVAIL)    
                        */    
                        Set @UNPLEGE_QTY = @UNPLEGE_QTY + @UNPLEGE_AVAIL    
    
                        If(@UNPLEGE_QTY >= @UNPLEGE_REQ)    
                        Begin    
                           Break    
                        End    
    
                        Set @CTR_UNPLEDGE_BANK = @CTR_UNPLEDGE_BANK + 1    
                     End    
    
                     Set @UNPLEGE_QTY = 0    
    
                     Set @UNPLEGE_REQ = 0    
    
                     Set @UNPLEGE_AVAIL = 0    
    
                     Set @CTR_UNPLEDGE_ISIN = @CTR_UNPLEDGE_ISIN + 1    
                  End    
               /** UNPLEDGE COMPLETE **/    
               End    
    
               Set @INTERBANK_CTR = @INTERBANK_CTR + 1    
            End    
         End    
    
         Set @BANK_CTR = @BANK_CTR + 1    
      End    
    
      --SET NOCOUNT OFF    
      Print ' COMPLETED'    
    
      Truncate Table #TMP_PLEDGE_DATA    
    
      --SET NOCOUNT ON    
      /*    
      DECLARE @BANK_CTR AS INT,    
      @BANK_TOTAL AS INT,    
      @PRIORITY AS INT,    
      @BANK_CODE AS INT,    
      @REQUIREMENT AS MONEY,    
      @PLEDGE_CTR AS INT,    
      @PLEDGE_CNT AS INT,    
          
      @PLEDGOR_BO_ID AS VARCHAR(20),    
      @ISIN AS VARCHAR(20),    
      @QTY AS INT,    
      @VALUE AS MONEY,    
      @CLSRATE AS MONEY,    
          
      @CHECK_LEFT_QTY AS INT,    
      @PLEDGE_VALUE AS MONEY,    
      @ROW_NUM AS INT    
      */    
      Print ''    
    
      Print ''    
    
      Print 'PLEDGING CREDITORS STOCK'    
    
      Print ' STARTED'    
    
      Select @BANK_TOTAL = Count(*)    
      From   #BANK_LIST    
    
      Select @BANK_CTR = 1    
    
      While (@BANK_CTR <= @BANK_TOTAL)    
      Begin    
         Select @PRIORITY = Priority,    
                @BANK_CODE = Bank_code,    
                @REQUIREMENT = [Required_excess]    
         From   #BANK_LIST    
         Where  Row_num = @BANK_CTR    
    
         If @REQUIREMENT > 0    
         Begin    
            Set @PLEDGE_VALUE = 0    
    
         /*Update #PLEDGABLE_STOCK    
         Set Priority = @PRIORITY    
         Where Isin In (Select Isin    
         From Vw_las_appr_bank_scrip A With (NOLOCK)    
         Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
         On A.Scode = B.Bsecode    
         Where Bank_code = @BANK_CODE) */    
            --AND PRIORITY = 0    
            Update #PLEDGABLE_STOCK    
            Set    Priority = @PRIORITY    
            From   (Select B.Isin,    
                           C.Accno    
                    From   Vw_las_appr_bank_scrip A With (NOLOCK)    
                           Inner Join GENERAL.dbo.Scrip_master B With(NOLOCK)    
                            On A.Scode = B.Bsecode    
                           Inner Join (Select Bank_code,    
                                              Accno=Pledgor_bo_id    
                                       From   GENERAL.dbo.Vw_las_comb_bank_agreeement_mast With (NOLOCK)    
                                       Where  Bank_code = @BANK_CODE
											  And Active_Inactive=1) C    
                            On A.Bank_code = C.Bank_code    
                    Where  C.Bank_code = @BANK_CODE) P    
            Where  #pledgable_stock.Accno = P.Accno    
                   And #pledgable_stock.Isin = P.Isin    
    
            Truncate Table #TMP_PLEDGE_DATA    
    
            Insert Into #TMP_PLEDGE_DATA    
            Select Accno,    
                   Isin,    
                   Scrip_cd,    
                   Qty - Pledge_qty,    
                   Value=(Qty - Pledge_qty) * Clsrate,    
                   Clsrate,    
                   Pledge_qty,    
                   Priority,    
                   Client_priority,    
                   Scrip_priority,    
                   Row_num,    
                   Row_number() Over(Order By Accno Desc, Scrip_priority, Value Desc)    
            From   #PLEDGABLE_STOCK    
            Where  Priority = @PRIORITY    
                   And (Qty - Pledge_qty)/*AVAILABLE QTY*/ > 0    
                   And (Qty - Pledge_qty) * Clsrate/*VALUE*/ > 0    
                   And Client_priority = 5    
    
            --BREAK    
            Select @PLEDGE_CNT = Count(*)    
            From   #TMP_PLEDGE_DATA    
    
            Select @PLEDGE_CTR = 1    
    
            While ((@PLEDGE_CTR <= @PLEDGE_CNT)    
                   And (@PLEDGE_VALUE < @REQUIREMENT))    
            Begin    
               Select @PLEDGOR_BO_ID = Accno,    
                      @ISIN = Isin,    
                      @QTY = Qty,    
                      @VALUE = Value,    
                      @CLSRATE = Clsrate,    
                      @ROW_NUM = Row_num    
               From   #TMP_PLEDGE_DATA    
               Where  Rw_nm = @PLEDGE_CTR    
    
            /*    
            PRINT ' '    
            PRINT 'BANK ID :: ' + CONVERT(VARCHAR,@BANK_CODE)    
            PRINT CONVERT(VARCHAR,@PLEDGE_CTR)+' :: ' + @PLEDGOR_BO_ID + ' - ' + @ISIN    
            PRINT ' QTY : ' + CONVERT(VARCHAR,@QTY) + '; VALUE : ' + CONVERT(VARCHAR,@VALUE) + '; CLSRATE : ' + CONVERT(VARCHAR,@CLSRATE) */    
               /*    
               SELECT @CHECK_LEFT_QTY = QTY_AVAILABLE_FOR_PLEDGE-PLEDGE_QTY    
               FROM #ISINWISE_PLEDGE_SUMMARY    
             WHERE ISIN = @ISIN    
                   
               IF @CHECK_LEFT_QTY < @QTY    
               BEGIN    
               SET @QTY = @CHECK_LEFT_QTY    
               END    
               */    
               If (@PLEDGE_VALUE + @VALUE) > @REQUIREMENT    
               Begin    
                  Set @QTY = Ceiling((@REQUIREMENT - @PLEDGE_VALUE) / @CLSRATE)    
               End    
    
               If @QTY < 0    
               Begin    
                  Set @QTY = 0    
               End    
    
               If @QTY > 0    
               Begin    
                  Set @VALUE = @QTY * @CLSRATE    
    
                  Insert Into #PLEDGE_REQUEST    
                  Values      (@BANK_CODE,    
                               @PLEDGOR_BO_ID,    
                               @ISIN,    
                               @QTY,    
                               @VALUE,    
                               'CREDITORS',    
                               0,    
                               '')    
    
                  Update #PLEDGABLE_STOCK    
                  Set    Pledge_qty = Pledge_qty + @QTY    
                  Where  Row_num = @ROW_NUM    
    
                  Set @PLEDGE_VALUE = @PLEDGE_VALUE + @VALUE    
               End    
    
               Set @PLEDGE_CTR = @PLEDGE_CTR + 1    
            End    
         End    
    
         Set @BANK_CTR = @BANK_CTR + 1    
      End    
    
      Print ' COMPLETED'    
    
      --SET NOCOUNT OFF    
      Print ' UPDATING PLEDGE VALUE BANKWISE FOR CREDITORS STOCK'    
    
      /*    
      UPDATE TDAY DEBTORS PLEDGE VALUE    
      */    
      Update #BANK_LIST    
      Set    Tday_creditors_pledge_value = Tday_creditors_pledge_value + Isnull(Pledge_value, 0)    
      From   (Select Bank_code,    
                     Sum(Value) As Pledge_value    
              From   #PLEDGE_REQUEST    
              Where  Request_type = 'CREDITORS'    
              Group  By Bank_code) A    
      Where  #bank_list.Bank_code = A.Bank_code    
    
      Print 'RECALCULATING BANKWISE REQUIREMENT/EXCESS AFTER PLEDGING CREDITORS STOCK............'    
    
      /*    
      RECALCULATING BANKWISE REQUIREMENT/EXCESS AFTER PLEDGING CREDITORS STOCK    
      */    
      Update #BANK_LIST    
      Set    [Required_excess] = Utilization - (Already_pledge_value - Tday_creditors_unpledge_value - Tday_interbank_unpledge_value) - Tday_debtors_pledge_value - Tday_interbank_pledge_value - Tday_creditors_pledge_value    
    
      Print 'FINALIZING AND SAVING PLEDGE/UNPLEDGE REQUEST'    
    
      Delete From Las_pledge_request    
      Where  Convert(Varchar(11), Update_datetime) Like Convert(Varchar(11), Getdate())    
    
      Insert Into Las_pledge_request    
      Select Getdate() As Update_datetime,    
             *--,'' AS APPROVED_BY    
      From   #PLEDGE_REQUEST    
    
      Delete From Las_unpledge_request    
      Where  Convert(Varchar(11), Update_datetime) Like Convert(Varchar(11), Getdate())    
    
      Insert Into Las_unpledge_request    
      Select Getdate() As Update_datetime,    
             *    
      From   #UNPLEDGE_REQUEST    
    
      Delete From Las_interbank_transfer_request    
      Where  Convert(Varchar(11), Update_datetime) Like Convert(Varchar(11), Getdate())    
    
      Insert Into Las_interbank_transfer_request    
      Select Getdate() As Update_datetime,    
             *    
      From   #INTERBANK_TRANSFER_REQUEST    
    
      Insert Into Las_pledge_unpledge_bank_log    
      Select Getdate() As Update_datetime,    
             *,    
             Update_by=Convert(Varchar(20), '')    
      From   #BANK_LIST    
    
      Print 'PROCESS COMPLETED'    
   End    
    
   Set NOCOUNT Off    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_PledgeSummaryISIN_Acc_Wise
-- --------------------------------------------------
CREATE Procedure Usp_pledgesummaryisin_acc_wise
(
 @access_to   Varchar(20)=Null,
 @access_code Varchar(20)=Null
)
As
Begin
 Set nocount On

 Select [Date]=Convert(Varchar, Processdate, 103),
        Accno,
        Isin,
        Pledgeableqty=Sum(Case Client_priority
                          When 1 Then Qty
                          Else 0
                          End),
        Prevdaypledgeqty=Sum(Prevday_pledege_qty),
        Cls_rate=Min(Avg_closing)
 Into   #Total_Pledgeable_Holding
 From   Tbl_party_pledge_data With (Nolock)
 Where  Convert(Varchar, Processdate, 106) = Convert(Varchar, Getdate(), 106)
 --And Client_priority = 1   
 --and isin='INE101D01012' 
 Group  By Accno,Isin,Convert(Varchar, Processdate, 103)
 Having Sum(Case Client_priority
            When 1 Then Qty
            Else 0
            End) <> 0  Or
        Sum(Prevday_pledege_qty) <> 0

 Select [Date]=Convert(Varchar, Update_datetime, 103),
        Accno=Pledgor_bo_id,
        Isin,
        Actualpledgeqty=Sum(Qty)
 Into   #Actual_Pledgeable_Holding
 From   Las_pledge_request With (Nolock)
 Where  Convert(Varchar, Update_datetime, 106) = Convert(Varchar, Getdate(), 106) And
        Request_type = 'DEBITORS'
 Group  By Isin,Pledgor_bo_id,Convert(Varchar, Update_datetime, 103)

 Select          A.[Date],
                 A.Accno,
                 A.Isin,
                 [Pledgeable qty]=A.Pledgeableqty,
                 [Pledgeable value]=(A.Pledgeableqty * A.Cls_rate),
                 [Prev day pledge qty]=A.Prevdaypledgeqty,
                 [Prev day pledge value]=(A.Prevdaypledgeqty * A.Cls_rate),
                 [Difference qty]=A.Pledgeableqty - A.Prevdaypledgeqty,
                 [Difference value]=((A.Pledgeableqty - A.Prevdaypledgeqty) * A.Cls_rate),
                 [Actual pledge qty]=Isnull(B.Actualpledgeqty, 0),
                 [Actual pledge value]=Isnull(B.Actualpledgeqty, 0) * A.Cls_rate,
                 [Remaing pledge qty]=A.Pledgeableqty - A.Prevdaypledgeqty - Isnull(B.Actualpledgeqty, 0),
                 [Remaing pledge value]=(A.Pledgeableqty - A.Prevdaypledgeqty - Isnull(B.Actualpledgeqty, 0)) * Cls_rate
 From            #Total_Pledgeable_Holding A With (Nolock)
 Left Outer Join #Actual_Pledgeable_Holding B With (Nolock)
  On A.[Date] = B.[Date] And
     A.Accno = B.Accno And
     A.Isin = B.Isin
 Order           By A.Isin

 Select          'Total',
                 '&nbsp;',
                 '&nbsp;',
                 Sum(A.Pledgeableqty),
                 Sum(A.Pledgeableqty * A.Cls_rate),
                 Sum(A.Prevdaypledgeqty),
                 Sum(A.Prevdaypledgeqty * A.Cls_rate),
                 Sum(A.Pledgeableqty - A.Prevdaypledgeqty),
                 Sum((A.Pledgeableqty - A.Prevdaypledgeqty) * A.Cls_rate),
                 Sum(Isnull(B.Actualpledgeqty, 0)),
                 Sum(Isnull(B.Actualpledgeqty, 0) * Cls_rate),
                 Sum(A.Pledgeableqty - A.Prevdaypledgeqty - Isnull(B.Actualpledgeqty, 0)),
                 Sum((A.Pledgeableqty - A.Prevdaypledgeqty - Isnull(B.Actualpledgeqty, 0)) * A.Cls_rate)
 From            #Total_Pledgeable_Holding A With (Nolock)
 Left Outer Join #Actual_Pledgeable_Holding B With (Nolock)
  On A.[Date] = B.[Date] And
     A.Accno = B.Accno And
     A.Isin = B.Isin

 Set nocount Off
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_pledgeunpledgebankwisedtl
-- --------------------------------------------------
CREATE Procedure [dbo].[Usp_pledgeunpledgebankwisedtl]    
As    
Begin    
   Set nocount On;    
    
   --Drop Table #AlreadyPledge    
   Select Isin,    
          Clientid                              As Pledgor_bo_id,    
          Bankid                                As Pledgee_bo_id,    
          Isnull(Agreement_no, '')              As Agreement_no,    
          Pledgeorder                           As Pledge_no,    
          Convert(Int, Pledgeqty - Unpledgeqty) As Pledge_qty,    
          Convert(Money, 0)                     As Clsrate,    
          Convert(Int, B.Bank_code)             As Bank_code    
   Into   #AlreadyPledge    
   From   mis.demat.dbo.Pledge2releaseentry A With(NOLOCK)    
          Left Outer Join General.dbo.Vw_las_comb_bank_agreeement_mast B With(NOLOCK)    
           On A.Clientid = B.Pledgor_bo_id    
              And A.Bankid = B.Pledgee_bo_id    
   Where  A.Clientid In ('1203320000000066', '1203320000000051','1203320009603460', '1203320000000028')    
    
   --BSECM    
   Update A    
   Set    Clsrate = Rate    
   From   #AlreadyPledge A,    
          (Select Isin,    
                  Rate    
           From   General.dbo.Cp_bsecm A With(NOLOCK)    
                  Inner Join General.dbo.Scrip_master B With(NOLOCK)    
                   On A.Scode = B.Bsecode) Cp    
   Where  A.Isin = Cp.Isin    
          And Clsrate = 0    
    
   --NSECM    
   Update A    
   Set    Clsrate = Rate    
   From   #AlreadyPledge A,    
          (Select Isin,    
                  Cls As Rate    
           From   General.dbo.Cp_nsecm A With(NOLOCK)    
                  Inner Join General.dbo.Scrip_master B With(NOLOCK)    
                   On A.Scrip = B.Nsesymbol    
                      And A.Series = B.Nseseries) Cp    
   Where  A.Isin = Cp.Isin    
          And Clsrate = 0    
    
   ---Drop Table #FinalRslt    
   Select Bank_code,    
          Sum(Pledge_qty * Clsrate) As Alreadypledgevalue,    
          Convert(Money, 0)         As Pledgevalue66,    
          Convert(Money, 0)         As Pledgevalue51,               
          Convert(Money, 0)         As Unpledgevalue66,    
          Convert(Money, 0)         As Unpledgevalue51, 		            
          Convert(Money, 0)         As Net,    
          Convert(Money, 0)         As Banklimit,    
          Convert(Money, 0)         As Bankrequirement,    
          Convert(Money, 0)         As Shortage,
          Convert(Money, 0)         As Pledgevalue60,      
          Convert(Money, 0)         As Unpledgevalue60,
          Convert(Money, 0)         As Pledgevalue28,      
          Convert(Money, 0)         As Unpledgevalue28     
   Into   #FinalRslt    
   From   #AlreadyPledge    
   Group  By Bank_code    
   union
   select Bank_code,    
          Convert(Money, 0) As Alreadypledgevalue,    
          Convert(Money, 0)         As Pledgevalue66,    
          Convert(Money, 0)         As Pledgevalue51,              
          Convert(Money, 0)         As Unpledgevalue66,    
          Convert(Money, 0)         As Unpledgevalue51,              
          Convert(Money, 0)         As Net,    
          Convert(Money, 0)         As Banklimit,    
          Convert(Money, 0)         As Bankrequirement,    
          Convert(Money, 0)         As Shortage, 
		  Convert(Money, 0)         As Pledgevalue60,      
          Convert(Money, 0)         As Unpledgevalue60,
          Convert(Money, 0)         As Pledgevalue28,      
          Convert(Money, 0)         As Unpledgevalue28   
          from General.dbo.Tbl_las_bank_master with (nolock) where Active_InActive=1
          and bank_code not in (select bank_code from #AlreadyPledge group by Bank_Code)
   
    
   ----------***Update Bank Value *****    
   ---------------------------------------    
   Update #FinalRslt    
   Set    Banklimit = A.Las_line,    
          Bankrequirement = A.Utilization    
   From   General.dbo.Tbl_las_bank_master A With(NOLOCK)    
   Where  A.Bank_code = #finalrslt.Bank_code    
          And A.Active_inactive = 1    
    
   ----------***Update Pledge Value *****    
   ---------------------------------------    
   ---Drop Table #Pledge    
   Select Bank_code,    
          Pledgor_bo_id,    
          Pledgevalue=Sum(Value)    
   Into   #Pledge    
   From   Las_pledge_request With(NOLOCK)    
   Where  Convert(Varchar(11), Update_datetime, 106) = Convert(Varchar(11), Getdate(), 106)    
          And Request_type = 'DEBITORS'    
   Group  By Bank_code,Pledgor_bo_id    
    
   Update #FinalRslt    
   Set    Pledgevalue66 = (Case A.Pledgor_bo_id    
                            When '1203320000000066' Then Pledgevalue    
                            Else 0    
                           End)    
   From   #Pledge A With(NOLOCK)    
   Where  A.Bank_code = #finalrslt.Bank_code    
          And A.Pledgor_bo_id = '1203320000000066'    
    
   Update #FinalRslt    
   Set    Pledgevalue51 = (Case A.Pledgor_bo_id    
                            When '1203320000000051' Then Pledgevalue    
                            Else 0    
                           End)    
   From   #Pledge A With(NOLOCK)    
   Where  A.Bank_code = #finalrslt.Bank_code    
          And A.Pledgor_bo_id = '1203320000000051'    
          
   Update #FinalRslt    
   Set    Pledgevalue60 = (Case A.Pledgor_bo_id    
                            When '1203320009603460' Then Pledgevalue    
                            Else 0    
                           End)    
   From   #Pledge A With(NOLOCK)    
   Where  A.Bank_code = #finalrslt.Bank_code    
          And A.Pledgor_bo_id = '1203320009603460'
          
   Update #FinalRslt    
   Set    Pledgevalue28 = (Case A.Pledgor_bo_id    
                            When '1203320000000028' Then Pledgevalue    
                            Else 0    
                           End)    
   From   #Pledge A With(NOLOCK)    
   Where  A.Bank_code = #finalrslt.Bank_code    
          And A.Pledgor_bo_id = '1203320000000028'              
          
    
   ----------***Update unpledge Value *****    
   ----------------------------------------    
   ---Drop Table #Unpledge    
   Select Bank_code,    
          Pledgor_bo_id,    
          Unledgevalue=Sum(Unpledge_value)    
   Into   #Unpledge    
   From   Las_unpledge_request With(NOLOCK)    
   Where  Convert(Varchar(11), Update_datetime, 106) = Convert(Varchar(11), Getdate(), 106)    
          And Request_type = 'CREDITORS'    
   Group  By Bank_code,Pledgor_bo_id    
    
   Update #FinalRslt    
   Set    Unpledgevalue66 = (Case A.Pledgor_bo_id    
                              When '1203320000000066' Then A.Unledgevalue    
                              Else 0    
                             End)    
   From   #Unpledge A With(NOLOCK)    
   Where  A.Bank_code = #finalrslt.Bank_code    
          And A.Pledgor_bo_id = '1203320000000066'    
    
   Update #FinalRslt    
   Set    Unpledgevalue51 = (Case A.Pledgor_bo_id    
                              When '1203320000000051' Then A.Unledgevalue    
                              Else 0    
                             End)    
   From   #Unpledge A With(NOLOCK)    
   Where  A.Bank_code = #finalrslt.Bank_code    
          And A.Pledgor_bo_id = '1203320000000051'    
          
   Update #FinalRslt    
   Set    Unpledgevalue60 = (Case A.Pledgor_bo_id    
                              When '1203320009603460' Then A.Unledgevalue    
                              Else 0    
                             End)    
   From   #Unpledge A With(NOLOCK)    
   Where  A.Bank_code = #finalrslt.Bank_code    
          And A.Pledgor_bo_id = '1203320009603460' 
          
   Update #FinalRslt    
   Set    Unpledgevalue28 = (Case A.Pledgor_bo_id    
                              When '1203320000000028' Then A.Unledgevalue    
                              Else 0    
                             End)    
   From   #Unpledge A With(NOLOCK)    
   Where  A.Bank_code = #finalrslt.Bank_code    
          And A.Pledgor_bo_id = '1203320000000028'              
    
   Update #FinalRslt    
   Set    Net = Alreadypledgevalue + (Pledgevalue66 + Pledgevalue51+Pledgevalue60+Pledgevalue28) - (Unpledgevalue66 + Unpledgevalue51+Unpledgevalue60+Unpledgevalue28),    
          Shortage = (Alreadypledgevalue + (Pledgevalue66 + Pledgevalue51+Pledgevalue60+Pledgevalue28) - (Unpledgevalue66 + Unpledgevalue51+Unpledgevalue60+Unpledgevalue28)) - Bankrequirement    
    
   Delete From Las_pledgeunpledge_bankwise    
   Where  Convert(Varchar(11), Update_datetime, 106) = Convert(Varchar(11), Getdate(), 106)    
    
   Insert Into Las_pledgeunpledge_bankwise    
   Select Update_datetime=Getdate(),    
          *    
   From   #FinalRslt    
    
   Set nocount Off;    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGEBANKWISEMIS
-- --------------------------------------------------
CREATE Procedure [dbo].[USP_PLEDGEUNPLEDGEBANKWISEMIS]   
(  
 @PledgeDt    As Datetime,  
 @access_to   Varchar(20),  
 @access_code Varchar(20)  
)  
As  
Begin  
   Set nocount On;  
  
   Select A.Update_datetime,  
          A.Bank_code,  
          B.Bankname As Bank_name,  
          A.Alreadypledgevalue,  
          A.Pledgevalue66,  
          A.Pledgevalue51,  
          A.Pledgevalue60,
          A.Pledgevalue28,  
          A.Unpledgevalue66,  
          A.Unpledgevalue51,  
          A.Unpledgevalue60,
          A.Unpledgevalue28,  
          A.Net,  
          A.Banklimit,  
          A.Bankrequirement,  
          A.Shortage,
          B.Priority  
   Into   #FinRslt  
   From   Las_pledgeunpledge_bankwise A With(NOLOCK)  
          Inner Join General.dbo.Tbl_las_bank_master B With(NOLOCK)  
           On A.Bank_code = B.Bank_code  
   Where  Convert(Varchar(11), A.Update_datetime, 106) = Convert(Varchar(11), @PledgeDt, 106)  
  
   Select Bank_name          As [Bank name],  
          Alreadypledgevalue As [Already pledge value],  
          Pledgevalue66      As [Pledge value 1203320000000066],  
          Pledgevalue51      As [Pledge value 1203320000000051],  
          Pledgevalue60      As [Pledge value 1203320009603460],  
          Pledgevalue28      As [Pledge value 1203320000000028],  
          Unpledgevalue66    As [Unpledge value 1203320000000066],  
          Unpledgevalue51    As [Unpledge value 1203320000000051],            
          Unpledgevalue60   As [Unpledge value 1203320009603460],  
          Unpledgevalue28    As [Unpledge value 1203320000000028],  
          Net,  
          Banklimit          As [Bank limit],  
          Bankrequirement    As [Bank requirement],  
          Shortage  
   From   #FinRslt With(NOLOCK)  
   Order  By Priority  
  
   Select 'Total :',  
          Sum(Alreadypledgevalue),  
          Sum(Pledgevalue66),  
          Sum(Pledgevalue51),  
          Sum(Pledgevalue60),
          Sum(Pledgevalue28),  
          Sum(Unpledgevalue66),  
          Sum(Unpledgevalue51),
          Sum(Unpledgevalue60),  
          Sum(Unpledgevalue28),  
          Sum(Net),  
          Sum(Banklimit),  
          Sum(Bankrequirement),  
          Sum(Shortage)  
   From   #FinRslt  
  
   Set nocount Off;  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_pledgeunpledgebankwiserpt
-- --------------------------------------------------
Create Procedure Usp_pledgeunpledgebankwiserpt
(
 @PLEDGEDT      As Datetime,
 @FLAG          As Int,
 @PLEDGOR_BO_ID As Varchar(25),
 @ISIN          As Varchar(25),
 @BANK_CODE     As Int,
 @BANK_NAME     As Varchar,
 @ACCESS_TO     As Varchar(25),
 @ACCESS_CODE   As Varchar(25)
)
As
   Set NOCOUNT On;

   If @BANK_CODE = 0
   Begin
      Set @BANK_CODE=Null
   End

   If @FLAG = 1
   Begin
      Select Convert(Varchar, A.UPDATE_DATETIME, 106) As [Pledg date],
             B.BANKNAME                               As [Bank name],
             B.PLEDGEE_BO_ID                          As[Bank account],
             A.ISIN,
             A.QTY                                    As [Pledged quantity],
             A.VALUE                                  As [Pledged value],
             A.PLEDGOR_BO_ID
      From   Las_pledge_request A (NOLOCK)
             Inner Join general.dbo.Vw_las_comb_bank_agreeement_mast B (NOLOCK)
              On A.BANK_CODE = B.BANK_CODE
                 And A.PLEDGOR_BO_ID = B.PLEDGOR_BO_ID
      Where  Convert(Varchar, A.UPDATE_DATETIME, 106) = Convert(Varchar, @PLEDGEDT, 106)
             And B.BANK_CODE Like Isnull(@BANK_CODE, B.BANK_CODE)
             And A.PLEDGOR_BO_ID Like @PLEDGOR_BO_ID
             And A.ISIN Like @ISIN
             And A.Request_Type = 'DEBITORS'
      Order  By B.BANKNAME,A.PLEDGOR_BO_ID
   End

   If @FLAG = 2
   Begin
      Select Convert(Varchar, A.UPDATE_DATETIME, 106) As [Unpledg date],
             B.BANKNAME                               As [Bank name],
             B.PLEDGEE_BO_ID                          As[Bank account],
             A.ISIN,
             A.UNPLEDGE_QTY                           As [Unpledg quantity],
             A.UNPLEDGE_VALUE                         As [Unpledg value],
             A.PLEDGE_NO                              As [Pledge order no],
             A.PLEDGOR_BO_ID
      From   Las_unpledge_request A (NOLOCK)
             Inner Join general.dbo.Vw_las_comb_bank_agreeement_mast B (NOLOCK)
              On A.BANK_CODE = B.BANK_CODE
                 And A.PLEDGOR_BO_ID = B.PLEDGOR_BO_ID
      Where  Convert(Varchar, A.UPDATE_DATETIME, 106) = Convert(Varchar, @PLEDGEDT, 106)
             And B.BANK_CODE Like Isnull(@BANK_CODE, B.BANK_CODE)
             And A.PLEDGOR_BO_ID Like @PLEDGOR_BO_ID
             And A.ISIN Like @ISIN
             And A.Request_Type = 'CREDITORS'
      Order  By B.BANKNAME,A.PLEDGE_NO
   End

   Set NOCOUNT Off;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLINETRPT
-- --------------------------------------------------
--Usp_pledgeunpledgeclinetrpt '2018-05-17 00:00:00.000','2018-05-17 12:59:59.000','J777','broker','cso'

CREATE Procedure [dbo].[USP_PLEDGEUNPLEDGECLINETRPT]  
(  
 @FrmDt       As Datetime,  
 @ToDt        As Datetime,  
 @Party_code  As Varchar(20),  
 @access_to   As Varchar(20),  
 @access_code As Varchar(20)  
)  
As  
Begin  
   Set nocount On; 
   
                                          
	if(@Party_code='All')          
	Begin          
	 set @Party_code='%'          
	End    
  
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)  
  
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'  
  
   Select Processdate=Convert(Varchar, Processdate, 106),  
          Party_code,
          [98Series],  
          Bsecm_ledger,  
          Nsecm_ledger,  
          Nsefo_ledger,  
          Mcd_ledger,  
          Nsx_ledger,
          MTF_Ledger,
          MCX_LEDGER,
          NCDEX_LEDGER,  
          Bsecm_cash_colleteral,  
          Nsecm_cash_colleteral,  
          Nsefo_cash_colleteral,  
          Mcd_cash_colleteral,  
          Nsx_cash_colleteral,
          MCX_CASH_COLLETERAL,
          NCDEX_CASH_COLLETERAL,  
          Bsecm_noncash_colleteral,  
          Nsecm_noncash_colleteral,  
          Nsefo_noncash_colleteral,  
          Mcd_noncash_colleteral,  
          Nbfc_noncash_colleteral,
          MCX_NONCASH_COLLETERAL,  
          Ncdex_noncash_colleteral,  
          Nsx_noncash_colleteral,  
          Bsecm_unrecosiled_credit,  
          Nsecm_unrecosiled_credit,  
          Nsefo_unrecosiled_credit,  
          Mcd_unrecosiled_credit,  
          Ncdex_unrecosiled_credit,  
          Nsx_unrecosiled_credit,
          MCX_UNRECOSILED_CREDIT,  
          NCDEX_UNRECOSILED_CREDIT,
          Bsecm_varmargin,  
          Nsecm_varmargin,  
          Nsefo_span_add_margin,  
          Mcd_span_add_margin,  
          Nsx_span_add_margin,
          MCX_SPAN_ADD_MARGIN,
          NCDEX_SPAN_ADD_MARGIN,
          NSEFO_IMARGIN,
          MCX_IMARGIN,NBFC_IMARGIN,NCDEX_IMARGIN

   From   Pledge_clientwiseledger (nolock)  
   Where  Processdate >= @FrmDt
          And Processdate <= @ToDt  
          And Party_code Like @Party_code  
   Order  By Convert(Varchar, Processdate, 106),Party_code  
  
   Set nocount Off;  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLINETRPT_01Feb2019
-- --------------------------------------------------
--Usp_pledgeunpledgeclinetrpt '2018-05-17 00:00:00.000','2018-05-17 12:59:59.000','J777','broker','cso'

create Procedure [dbo].[USP_PLEDGEUNPLEDGECLINETRPT_01Feb2019]  
(  
 @FrmDt       As Datetime,  
 @ToDt        As Datetime,  
 @Party_code  As Varchar(20),  
 @access_to   As Varchar(20),  
 @access_code As Varchar(20)  
)  
As  
Begin  
   Set nocount On; 
   
                                          
	if(@Party_code='All')          
	Begin          
	 set @Party_code='%'          
	End    
  
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)  
  
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'  
  
   Select Processdate=Convert(Varchar, Processdate, 106),  
          Party_code,  
          Bsecm_ledger,  
          Nsecm_ledger,  
          Nsefo_ledger,  
          Mcd_ledger,  
          Nsx_ledger,
          MTF_Ledger,  
          Bsecm_cash_colleteral,  
          Nsecm_cash_colleteral,  
          Nsefo_cash_colleteral,  
          Mcd_cash_colleteral,  
          Nsx_cash_colleteral,  
          Bsecm_noncash_colleteral,  
          Nsecm_noncash_colleteral,  
          Nsefo_noncash_colleteral,  
          Mcd_noncash_colleteral,  
          Nbfc_noncash_colleteral,  
          Ncdex_noncash_colleteral,  
          Nsx_noncash_colleteral,  
          Bsecm_unrecosiled_credit,  
          Nsecm_unrecosiled_credit,  
          Nsefo_unrecosiled_credit,  
          Mcd_unrecosiled_credit,  
          Ncdex_unrecosiled_credit,  
          Nsx_unrecosiled_credit,  
          Bsecm_varmargin,  
          Nsecm_varmargin,  
          Nsefo_span_add_margin,  
          Mcd_span_add_margin,  
          Nsx_span_add_margin  
   From   Pledge_clientwiseledger (nolock)  
   Where  Processdate >= @FrmDt
          And Processdate <= @ToDt  
          And Party_code Like @Party_code  
   Order  By Convert(Varchar, Processdate, 106),Party_code  
  
   Set nocount Off;  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_pledgeunpledgeclinetrpt_12102017
-- --------------------------------------------------
CREATE Procedure Usp_pledgeunpledgeclinetrpt_12102017  
(  
 @FrmDt       As Datetime,  
 @ToDt        As Datetime,  
 @Party_code  As Varchar(20),  
 @access_to   As Varchar(20),  
 @access_code As Varchar(20)  
)  
As  
Begin  
   Set nocount On;  
  
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)  
  
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'  
  
   Select Processdate=Convert(Varchar, Processdate, 106),  
          Party_code,  
          Bsecm_ledger,  
          Nsecm_ledger,  
          Nsefo_ledger,  
          Mcd_ledger,  
          Nsx_ledger,  
          Bsecm_cash_colleteral,  
          Nsecm_cash_colleteral,  
          Nsefo_cash_colleteral,  
          Mcd_cash_colleteral,  
          Nsx_cash_colleteral,  
          Bsecm_noncash_colleteral,  
          Nsecm_noncash_colleteral,  
          Nsefo_noncash_colleteral,  
          Mcd_noncash_colleteral,  
          Nbfc_noncash_colleteral,  
          Ncdex_noncash_colleteral,  
          Nsx_noncash_colleteral,  
          Bsecm_unrecosiled_credit,  
          Nsecm_unrecosiled_credit,  
          Nsefo_unrecosiled_credit,  
          Mcd_unrecosiled_credit,  
          Ncdex_unrecosiled_credit,  
          Nsx_unrecosiled_credit,  
          Bsecm_varmargin,  
          Nsecm_varmargin,  
          Nsefo_span_add_margin,  
          Mcd_span_add_margin,  
          Nsx_span_add_margin  
   From   Pledge_clientwiseledger (nolock)  
   Where  Processdate >= @FrmDt  
          And Processdate <= @ToDt  
          And Party_code Like @Party_code  
   Order  By Convert(Varchar, Processdate, 106),Party_code  
  
   Set nocount Off;  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLIRPT
-- --------------------------------------------------
    
--USP_PLEDGEUNPLEDGECLIRPT '2015-12-31','2015-12-31','%','%','%','HISTORY','broker','cso'    
    
CREATE Procedure [dbo].[USP_PLEDGEUNPLEDGECLIRPT]
(                
 @FrmDt       As Datetime,                
 @ToDt        As Datetime,                
 @AccNo       As Varchar(20),                
 @Party_code  As Varchar(20),                
 @ISIN        As Varchar(20),                
 @Data        As Varchar(20),                
 @access_to   As Varchar(20),                
 @access_code As Varchar(20)                
)                
As                
Begin                
   Set nocount On;                
                
   --Declare @FrmDt as Datetime,@ToDt as Datetime,                  
   --@AccNo as Varchar(20),@Party_code as Varchar(20),                  
   --@ISIN as Varchar(20),@access_to as Varchar(20),                  
   --@access_code as Varchar(20)                  
                
   --set @FrmDt=GETDATE()-1                  
   --set @ToDt=GETDATE()                  
   --set @AccNo='1203320000000066'                  
   --set @ISIN='INE275A01028'                  
   --set @Party_code='%'                  
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)                
                
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'                
                
   If @Data = 'Current'                
   Begin                
      Select [Date]=Convert(Varchar, Processdate, 106),                
             Party_code,                
             Min((Ledger_bal))     As [Net debit],                
             Min((Ledger_bal * 2)) As [Adjustable debit],                
             Isin,                
             Scripname,                
             [Accountno]=Accno,                
             [Total holding qty]=Sum(Qty),                
             [Total holding hold value]=Sum(Hold_value),                
             [Total pledgeble qty]=Sum(Case Client_priority                
                                        When 1 Then Qty                
                                        Else 0                
                                       End),                
             [Total pledgeble hold value]=Sum(Case Client_priority                
                                               When 1 Then Hold_value                
                                               Else 0                
                                              End),                
             [Closing price]=Avg_closing,                
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                
             [Release qty]=Sum(Release_qty),                
             [Actual pledge]=Sum(Pledge_qty)                
      From   Tbl_party_pledge_data (NOLOCK)                
      Where  Accno Like @ACCNO                
             And Isin Like @ISIN                
             And Party_code Like @PARTY_CODE                
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,Isin                
      Order  By Convert(Varchar, Processdate, 106),[Net debit]              
   End                
   Else                
   Begin            
   /*            
  Added by Prashant on Jan  2 2013, Reported By : Anil wandre            
  Reason :- Double Entries in Log table due to Reprocess            
   */            
   SELECT CONVERT(date,PROCESSDATE) as Date,MAX(PROCESSDATE) as EntryDate            
  INTO #RPT_DATES            
   FROM TBL_PARTY_PLEDGE_DATA_LOG with(nolock)            
   WHERE PROCESSDATE>=@FRMDT AND PROCESSDATE<=@TODT            
   group by CONVERT(date,PROCESSDATE)            
   
  update #RPT_DATES set EntryDate='2016-11-08 08:56:10.877' where   EntryDate='2016-11-08 11:46:03.740'
               
   CREATE NONCLUSTERED INDEX IDX_DATE ON #RPT_DATES (ENTRYDATE)            
               
      Select  [Date]=Convert(Varchar, Processdate, 106),                
             Party_code,                
             Min((Ledger_bal))     As [Net debit],                
   Min((Ledger_bal * 2)) As [Adjustable debit],                
             Isin,                
             Scripname,                
             [Accountno]=Accno,                
             [Total holding qty]=Sum(Qty),                
             [Total holding hold value]=Sum(Hold_value),                
             [Total pledgeble qty]=Sum(Case Client_priority                
                                        When 1 Then Qty                
                                        Else 0                
                     End),                
             [Total pledgeble hold value]=Sum(Case Client_priority                
                                               When 1 Then Hold_value                
                                               Else 0                
                                              End),                
             [Closing price]=Avg_closing,                
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                
             [Release qty]=Sum(Release_qty),                
             [Actual pledge]=Sum(Pledge_qty)        
             --[Actual pledge]=Sum(Pledge_qty-bse_exchange_pledge_qty)                
      From   Tbl_party_pledge_data_log A (NOLOCK)          
  INNER JOIN #RPT_DATES B            
   ON A.Processdate = B.EntryDate            
    Where  Processdate >= @FRMDT                
     And Processdate <= @TODT                
     And Accno Like @ACCNO                
     And Isin Like @ISIN                
     And Party_code Like @PARTY_CODE                
   Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                
      Union All                
      Select [Date]=Convert(Varchar, Processdate, 106),                
             Party_code,                
             Min((Ledger_bal))     As [Net debit],                
             Min((Ledger_bal * 2)) As [Adjustable debit],                
             Isin,                
             Scripname,                
             [Accountno]=Accno,                
             [Total holding qty]=Sum(Qty),                
             [Total holding hold value]=Sum(Hold_value),                
             [Total pledgeble qty]=Sum(Case Client_priority                
                                        When 1 Then Qty                
                                        Else 0                
                                       End),                
             [Total pledgeble hold value]=Sum(Case Client_priority                
                                               When 1 Then Hold_value                
                                               Else 0                
                                              End),                
             [Closing price]=Avg_closing,                
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                
             [Release qty]=Sum(Release_qty),                
             [Actual pledge]=Sum(Pledge_qty)                
      From   Tbl_party_pledge_data (NOLOCK)                
      Where  Processdate >= @FRMDT                
             And Processdate <= @TODT                
             And Accno Like @ACCNO                
             And Isin Like @ISIN                
             And Party_code Like @PARTY_CODE                
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,[Total pledgeble qty] Desc,Isin                
      Order  By Convert(Varchar, Processdate, 106),[Net debit]               
   End                
                
   Set nocount Off;                
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLIRPT_02012013
-- --------------------------------------------------
CREATE Procedure USP_PLEDGEUNPLEDGECLIRPT_02012013
(    
 @FrmDt       As Datetime,    
 @ToDt        As Datetime,    
 @AccNo       As Varchar(20),    
 @Party_code  As Varchar(20),    
 @ISIN        As Varchar(20),    
 @Data        As Varchar(20),    
 @access_to   As Varchar(20),    
 @access_code As Varchar(20)    
)    
As    
Begin    
   Set nocount On;    
    
   --Declare @FrmDt as Datetime,@ToDt as Datetime,      
   --@AccNo as Varchar(20),@Party_code as Varchar(20),      
   --@ISIN as Varchar(20),@access_to as Varchar(20),      
   --@access_code as Varchar(20)      
    
   --set @FrmDt=GETDATE()-1      
   --set @ToDt=GETDATE()      
   --set @AccNo='1203320000000066'      
   --set @ISIN='INE275A01028'      
   --set @Party_code='%'      
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)    
    
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'    
    
   If @Data = 'Current'    
   Begin    
      Select [Date]=Convert(Varchar, Processdate, 106),    
             Party_code,    
             Min((Ledger_bal))     As [Net debit],    
             Min((Ledger_bal * 2)) As [Adjustable debit],    
             Isin,    
             Scripname,    
             [Accountno]=Accno,    
             [Total holding qty]=Sum(Qty),    
             [Total holding hold value]=Sum(Hold_value),    
             [Total pledgeble qty]=Sum(Case Client_priority    
                                        When 1 Then Qty    
                                        Else 0    
                                       End),    
             [Total pledgeble hold value]=Sum(Case Client_priority    
                                               When 1 Then Hold_value    
                                               Else 0    
                                              End),    
             [Closing price]=Avg_closing,    
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),    
             [Release qty]=Sum(Release_qty),    
             [Actual pledge]=Sum(Pledge_qty)    
      From   Tbl_party_pledge_data (NOLOCK)    
      Where  Accno Like @ACCNO    
             And Isin Like @ISIN    
             And Party_code Like @PARTY_CODE    
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname    
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,Isin    
      Order  By Convert(Varchar, Processdate, 106),[Net debit]  
   End    
   Else    
   Begin    
      Select [Date]=Convert(Varchar, Processdate, 106),    
             Party_code,    
             Min((Ledger_bal))     As [Net debit],    
             Min((Ledger_bal * 2)) As [Adjustable debit],    
             Isin,    
             Scripname,    
             [Accountno]=Accno,    
             [Total holding qty]=Sum(Qty),    
             [Total holding hold value]=Sum(Hold_value),    
             [Total pledgeble qty]=Sum(Case Client_priority    
                                        When 1 Then Qty    
                                        Else 0    
                                       End),    
             [Total pledgeble hold value]=Sum(Case Client_priority    
                                               When 1 Then Hold_value    
                                               Else 0    
                                              End),    
             [Closing price]=Avg_closing,    
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),    
             [Release qty]=Sum(Release_qty),    
             [Actual pledge]=Sum(Pledge_qty)    
      From   Tbl_party_pledge_data_log (NOLOCK)    
      Where  Processdate >= @FRMDT    
             And Processdate <= @TODT    
             And Accno Like @ACCNO    
             And Isin Like @ISIN    
             And Party_code Like @PARTY_CODE    
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname    
      Union All    
      Select [Date]=Convert(Varchar, Processdate, 106),    
             Party_code,    
             Min((Ledger_bal))     As [Net debit],    
             Min((Ledger_bal * 2)) As [Adjustable debit],    
             Isin,    
             Scripname,    
             [Accountno]=Accno,    
             [Total holding qty]=Sum(Qty),    
             [Total holding hold value]=Sum(Hold_value),    
             [Total pledgeble qty]=Sum(Case Client_priority    
                                        When 1 Then Qty    
                                        Else 0    
                                       End),    
             [Total pledgeble hold value]=Sum(Case Client_priority    
                                               When 1 Then Hold_value    
                                               Else 0    
                                              End),    
             [Closing price]=Avg_closing,    
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),    
             [Release qty]=Sum(Release_qty),    
             [Actual pledge]=Sum(Pledge_qty)    
      From   Tbl_party_pledge_data (NOLOCK)    
      Where  Processdate >= @FRMDT    
             And Processdate <= @TODT    
             And Accno Like @ACCNO    
             And Isin Like @ISIN    
             And Party_code Like @PARTY_CODE    
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname    
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,[Total pledgeble qty] Desc,Isin    
      Order  By Convert(Varchar, Processdate, 106),[Net debit]   
   End    
    
   Set nocount Off;    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLIRPT_18Jun2019
-- --------------------------------------------------
    
--USP_PLEDGEUNPLEDGECLIRPT '2015-12-31','2015-12-31','%','%','%','HISTORY','broker','cso'    
    
create Procedure [dbo].[USP_PLEDGEUNPLEDGECLIRPT_18Jun2019]
(                
 @FrmDt       As Datetime,                
 @ToDt        As Datetime,                
 @AccNo       As Varchar(20),                
 @Party_code  As Varchar(20),                
 @ISIN        As Varchar(20),                
 @Data        As Varchar(20),                
 @access_to   As Varchar(20),                
 @access_code As Varchar(20)                
)                
As                
Begin                
   Set nocount On;                
                
   --Declare @FrmDt as Datetime,@ToDt as Datetime,                  
   --@AccNo as Varchar(20),@Party_code as Varchar(20),                  
   --@ISIN as Varchar(20),@access_to as Varchar(20),                  
   --@access_code as Varchar(20)                  
                
   --set @FrmDt=GETDATE()-1                  
   --set @ToDt=GETDATE()                  
   --set @AccNo='1203320000000066'                  
   --set @ISIN='INE275A01028'                  
   --set @Party_code='%'                  
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)                
                
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'                
                
   If @Data = 'Current'                
   Begin                
      Select [Date]=Convert(Varchar, Processdate, 106),                
             Party_code,                
             Min((Ledger_bal))     As [Net debit],                
             Min((Ledger_bal * 2)) As [Adjustable debit],                
             Isin,                
             Scripname,                
             [Accountno]=Accno,                
             [Total holding qty]=Sum(Qty),                
             [Total holding hold value]=Sum(Hold_value),                
             [Total pledgeble qty]=Sum(Case Client_priority                
                                        When 1 Then Qty                
                                        Else 0                
                                       End),                
             [Total pledgeble hold value]=Sum(Case Client_priority                
                                               When 1 Then Hold_value                
                                               Else 0                
                                              End),                
             [Closing price]=Avg_closing,                
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                
             [Release qty]=Sum(Release_qty),                
             [Actual pledge]=Sum(Pledge_qty)                
      From   Tbl_party_pledge_data (NOLOCK)                
      Where  Accno Like @ACCNO                
             And Isin Like @ISIN                
             And Party_code Like @PARTY_CODE                
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,Isin                
      Order  By Convert(Varchar, Processdate, 106),[Net debit]              
   End                
   Else                
   Begin            
   /*            
  Added by Prashant on Jan  2 2013, Reported By : Anil wandre            
  Reason :- Double Entries in Log table due to Reprocess            
   */            
   SELECT CONVERT(date,PROCESSDATE) as Date,MAX(PROCESSDATE) as EntryDate            
  INTO #RPT_DATES            
   FROM TBL_PARTY_PLEDGE_DATA_LOG with(nolock)            
   WHERE PROCESSDATE>=@FRMDT AND PROCESSDATE<=@TODT            
   group by CONVERT(date,PROCESSDATE)            
   
  update #RPT_DATES set EntryDate='2016-11-08 08:56:10.877' where   EntryDate='2016-11-08 11:46:03.740'
               
   CREATE NONCLUSTERED INDEX IDX_DATE ON #RPT_DATES (ENTRYDATE)            
               
      Select  [Date]=Convert(Varchar, Processdate, 106),                
             Party_code,                
             Min((Ledger_bal))     As [Net debit],                
   Min((Ledger_bal * 2)) As [Adjustable debit],                
             Isin,                
             Scripname,                
             [Accountno]=Accno,                
             [Total holding qty]=Sum(Qty),                
             [Total holding hold value]=Sum(Hold_value),                
             [Total pledgeble qty]=Sum(Case Client_priority                
                                        When 1 Then Qty                
                                        Else 0                
                     End),                
             [Total pledgeble hold value]=Sum(Case Client_priority                
                                               When 1 Then Hold_value                
                                               Else 0                
                                              End),                
             [Closing price]=Avg_closing,                
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                
             [Release qty]=Sum(Release_qty),                
             [Actual pledge]=Sum(Pledge_qty)        
             --[Actual pledge]=Sum(Pledge_qty-bse_exchange_pledge_qty)                
      From   Tbl_party_pledge_data_log A (NOLOCK)          
  INNER JOIN #RPT_DATES B            
   ON A.Processdate = B.EntryDate            
    Where  Processdate >= @FRMDT                
     And Processdate <= @TODT                
     And Accno Like @ACCNO                
     And Isin Like @ISIN                
     And Party_code Like @PARTY_CODE                
   Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                
      Union All                
      Select [Date]=Convert(Varchar, Processdate, 106),                
             Party_code,                
             Min((Ledger_bal))     As [Net debit],                
             Min((Ledger_bal * 2)) As [Adjustable debit],                
             Isin,                
             Scripname,                
             [Accountno]=Accno,                
             [Total holding qty]=Sum(Qty),                
             [Total holding hold value]=Sum(Hold_value),                
             [Total pledgeble qty]=Sum(Case Client_priority                
                                        When 1 Then Qty                
                                        Else 0                
                                       End),                
             [Total pledgeble hold value]=Sum(Case Client_priority                
                                               When 1 Then Hold_value                
                                               Else 0                
                                              End),                
             [Closing price]=Avg_closing,                
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                
             [Release qty]=Sum(Release_qty),                
             [Actual pledge]=Sum(Pledge_qty)                
      From   Tbl_party_pledge_data (NOLOCK)                
      Where  Processdate >= @FRMDT                
             And Processdate <= @TODT                
             And Accno Like @ACCNO                
             And Isin Like @ISIN                
             And Party_code Like @PARTY_CODE                
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,[Total pledgeble qty] Desc,Isin                
      Order  By Convert(Varchar, Processdate, 106),[Net debit]               
   End                
                
   Set nocount Off;                
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLIRPT_23072013
-- --------------------------------------------------
--USP_PLEDGEUNPLEDGECLIRPT 'apr 17 2012','apr 17 2012','1203320000000066','%','%','his','broker','cso'          
CREATE Procedure USP_PLEDGEUNPLEDGECLIRPT_23072013
(                        
 @FrmDt       As Datetime,                        
 @ToDt        As Datetime,                        
 @AccNo       As Varchar(20),                        
 @Party_code  As Varchar(20),                        
 @ISIN        As Varchar(20),                        
 @Data        As Varchar(20),                        
 @access_to   As Varchar(20),                        
 @access_code As Varchar(20)                        
)                        
As                        
Begin                        
   Set nocount On;                        
                        
   --Declare @FrmDt as Datetime,@ToDt as Datetime,                          
   --@AccNo as Varchar(20),@Party_code as Varchar(20),                          
   --@ISIN as Varchar(20),@access_to as Varchar(20),                          
   --@access_code as Varchar(20)                          
                        
   --set @FrmDt=GETDATE()-1                          
   --set @ToDt=GETDATE()                          
   --set @AccNo='1203320000000066'                          
   --set @ISIN='INE275A01028'                          
   --set @Party_code='%'                          
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)                        
                        
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'                        
                        
   If @Data = 'Current'                        
   Begin                        
      Select [Date]=Convert(Varchar, Processdate, 106),                        
             Party_code,                        
             Min((Ledger_bal))     As [Net debit],                        
             Min((Ledger_bal * 2)) As [Adjustable debit],                        
             Isin,                        
             Scripname,                        
             /*[Accountno]=Accno,*/  
             [Total holding qty]=Sum(Qty),                        
             [Total holding hold value]=Sum(Hold_value),                        
             [Total pledgeble qty]=Sum(Case Client_priority                        
                                        When 1 Then Qty                        
                                        Else 0                        
                                       End),                        
             [Total pledgeble hold value]=Sum(Case Client_priority                        
                                               When 1 Then Hold_value                        
                                               Else 0                        
                                              End),                        
             [Closing price]=Avg_closing,                        
             /*[Prevday pledege qty]=Sum(Prevday_pledege_qty),                        
             [Release qty]=Sum(Release_qty),*/  
             [Actual pledge]=Sum(Pledge_qty)                        
      From   Tbl_party_pledge_data (NOLOCK)                        
      Where  Accno Like @ACCNO                        
             And Isin Like @ISIN                        
             And Party_code Like @PARTY_CODE                        
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                        
      having Sum(Qty) <> 0  
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,Isin                        
      Order  By Convert(Varchar, Processdate, 106),[Net debit]                      
   End                        
   Else                        
   Begin                    
   /*                    
  Added by Prashant on Jan  2 2013, Reported By : Anil wandre                    
  Reason :- Double Entries in Log table due to Reprocess                    
   */          
   /*          
   SELECT CONVERT(date,PROCESSDATE) as Date,MAX(PROCESSDATE) as EntryDate                    
  INTO #RPT_DATES                    
   --FROM TBL_PARTY_PLEDGE_DATA_LOG with(nolock)                    
   --From   [196.1.115.245].general_new.dbo.TBL_BSE_EXCHANGE_PLEDGE with(NOLOCK)                    
   From   [196.1.115.245].general_new.dbo.vw_BSE_EXCHANGE_PLEDGE_2 with(NOLOCK)                    
   --WHERE PROCESSDATE>=@FRMDT AND PROCESSDATE<=@TODT                    
   WHERE rms_date>=@FRMDT AND rms_date<=@TODT                    
   group by CONVERT(date,PROCESSDATE)                    
   */          
                       
   --CREATE NONCLUSTERED INDEX IDX_DATE ON #RPT_DATES (ENTRYDATE)                    
                       
      Select [Date]=Convert(Varchar, rms_date, 106),                        
             Party_code,                        
             Min((Ledger_bal))     As [Net debit],                        
             Min((Ledger_bal * 2)) As [Adjustable debit],                        
             Isin,                        
             Scripname,                        
             /*[Accountno]=Accno,*/  
             [Total holding qty]=Sum(Qty),                        
             [Total holding hold value]=Sum(Hold_value),                        
             [Total pledgeble qty]=Sum(Case Client_priority                        
                                        When 1 Then Qty                        
                                        Else 0                        
                     End),                        
             [Total pledgeble hold value]=Sum(Case Client_priority                        
                                               When 1 Then Hold_value                        
                                               Else 0                        
                                              End),                        
             [Closing price]=Avg_closing,                        
             --[Prevday pledege qty]=Sum(Prevday_pledege_qty),                        
             /*[Prevday pledege qty]=Sum(Prevday_pledege_qty-PrevDay_Pledge_BSE_Exchange),         
             [Release qty]=Sum(Release_qty),*/  
             --[Actual pledge]=Sum(Pledge_qty)                
             [Actual pledge]=Sum(Pledge_qty-bse_exchange_pledge_qty)                        
      --From   Tbl_party_pledge_data_log A (NOLOCK)                  
      From   [196.1.115.245].general_new.dbo.TBL_BSE_EXCHANGE_PLEDGE a with(NOLOCK)                    
  /*          
    INNER JOIN #RPT_DATES B                    
     ON A.Processdate = B.EntryDate                    
  */          
   Where  rms_date >= @FRMDT                        
    And rms_date <= @TODT                        
    And Accno Like @ACCNO                        
    And Isin Like @ISIN                        
    And Party_code Like @PARTY_CODE                        
    Group  By Party_code,Convert(Varchar, rms_date, 106),Isin,Accno,Avg_closing,Scripname                        
    having Sum(Qty) <> 0  
      Union All                        
      Select [Date]=Convert(Varchar, Processdate, 106),                        
             Party_code,                        
             Min((Ledger_bal))     As [Net debit],                        
             Min((Ledger_bal * 2)) As [Adjustable debit],                        
             Isin,                        
             Scripname,                        
             /*[Accountno]=Accno,*/  
             [Total holding qty]=Sum(Qty),                        
             [Total holding hold value]=Sum(Hold_value),                        
             [Total pledgeble qty]=Sum(Case Client_priority                        
                                        When 1 Then Qty                        
                                        Else 0                        
                                       End),                        
             [Total pledgeble hold value]=Sum(Case Client_priority                        
                 When 1 Then Hold_value                        
                                               Else 0                        
                                              End),                        
             [Closing price]=Avg_closing,                        
             /*[Prevday pledege qty]=Sum(Prevday_pledege_qty),                        
             [Release qty]=Sum(Release_qty),*/  
             [Actual pledge]=Sum(Pledge_qty)                        
   From   Tbl_party_pledge_data (NOLOCK)                        
      Where  Processdate >= @FRMDT                        
             And Processdate <= @TODT                        
             And Accno Like @ACCNO                        
             And Isin Like @ISIN                        
             And Party_code Like @PARTY_CODE                        
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                        
      having Sum(Qty) <> 0  
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,[Total pledgeble qty] Desc,Isin                       
      Order  By Convert(Varchar, rms_date, 106),[Net debit]                       
   End                        
                        
   Set nocount Off;                        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLIRPT_28022013
-- --------------------------------------------------
  
--USP_PLEDGEUNPLEDGECLIRPT 'apr 17 2012','apr 17 2012','1203320000000066','%','%','his','broker','cso'  
  
CREATE Procedure USP_PLEDGEUNPLEDGECLIRPT_28022013
(              
 @FrmDt       As Datetime,              
 @ToDt        As Datetime,              
 @AccNo       As Varchar(20),              
 @Party_code  As Varchar(20),              
 @ISIN        As Varchar(20),              
 @Data        As Varchar(20),              
 @access_to   As Varchar(20),              
 @access_code As Varchar(20)              
)              
As              
Begin              
   Set nocount On;              
              
   --Declare @FrmDt as Datetime,@ToDt as Datetime,                
   --@AccNo as Varchar(20),@Party_code as Varchar(20),                
   --@ISIN as Varchar(20),@access_to as Varchar(20),                
   --@access_code as Varchar(20)                
              
   --set @FrmDt=GETDATE()-1                
   --set @ToDt=GETDATE()                
   --set @AccNo='1203320000000066'                
   --set @ISIN='INE275A01028'                
   --set @Party_code='%'                
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)              
              
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'              
              
   If @Data = 'Current'              
   Begin              
      Select [Date]=Convert(Varchar, Processdate, 106),              
             Party_code,              
             Min((Ledger_bal))     As [Net debit],              
             Min((Ledger_bal * 2)) As [Adjustable debit],              
             Isin,              
             Scripname,              
             [Accountno]=Accno,              
             [Total holding qty]=Sum(Qty),              
             [Total holding hold value]=Sum(Hold_value),              
             [Total pledgeble qty]=Sum(Case Client_priority              
                                        When 1 Then Qty              
                                        Else 0              
                                       End),              
             [Total pledgeble hold value]=Sum(Case Client_priority              
                                               When 1 Then Hold_value              
                                               Else 0              
                                              End),              
             [Closing price]=Avg_closing,              
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),              
             [Release qty]=Sum(Release_qty),              
             [Actual pledge]=Sum(Pledge_qty)              
      From   Tbl_party_pledge_data (NOLOCK)              
      Where  Accno Like @ACCNO              
             And Isin Like @ISIN              
             And Party_code Like @PARTY_CODE              
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname              
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,Isin              
      Order  By Convert(Varchar, Processdate, 106),[Net debit]            
   End              
   Else              
   Begin          
   /*          
  Added by Prashant on Jan  2 2013, Reported By : Anil wandre          
  Reason :- Double Entries in Log table due to Reprocess          
   */          
   SELECT CONVERT(date,PROCESSDATE) as Date,MAX(PROCESSDATE) as EntryDate          
  INTO #RPT_DATES          
   FROM TBL_PARTY_PLEDGE_DATA_LOG with(nolock)          
   WHERE PROCESSDATE>=@FRMDT AND PROCESSDATE<=@TODT          
   group by CONVERT(date,PROCESSDATE)          
             
   CREATE NONCLUSTERED INDEX IDX_DATE ON #RPT_DATES (ENTRYDATE)          
             
      Select [Date]=Convert(Varchar, Processdate, 106),              
             Party_code,              
             Min((Ledger_bal))     As [Net debit],              
             Min((Ledger_bal * 2)) As [Adjustable debit],              
             Isin,              
             Scripname,              
             [Accountno]=Accno,              
             [Total holding qty]=Sum(Qty),              
             [Total holding hold value]=Sum(Hold_value),              
             [Total pledgeble qty]=Sum(Case Client_priority              
                                        When 1 Then Qty              
                                        Else 0              
                     End),              
             [Total pledgeble hold value]=Sum(Case Client_priority              
                                               When 1 Then Hold_value              
                                               Else 0              
                                              End),              
             [Closing price]=Avg_closing,              
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),              
             [Release qty]=Sum(Release_qty),              
             [Actual pledge]=Sum(Pledge_qty)      
             --[Actual pledge]=Sum(Pledge_qty-bse_exchange_pledge_qty)              
      From   Tbl_party_pledge_data_log A (NOLOCK)        
  INNER JOIN #RPT_DATES B          
   ON A.Processdate = B.EntryDate          
    Where  Processdate >= @FRMDT              
     And Processdate <= @TODT              
     And Accno Like @ACCNO              
     And Isin Like @ISIN              
     And Party_code Like @PARTY_CODE              
   Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname              
      Union All              
      Select [Date]=Convert(Varchar, Processdate, 106),              
             Party_code,              
             Min((Ledger_bal))     As [Net debit],              
             Min((Ledger_bal * 2)) As [Adjustable debit],              
             Isin,              
             Scripname,              
             [Accountno]=Accno,              
             [Total holding qty]=Sum(Qty),              
             [Total holding hold value]=Sum(Hold_value),              
             [Total pledgeble qty]=Sum(Case Client_priority              
                                        When 1 Then Qty              
                                        Else 0              
                                       End),              
             [Total pledgeble hold value]=Sum(Case Client_priority              
                                               When 1 Then Hold_value              
                                               Else 0              
                                              End),              
             [Closing price]=Avg_closing,              
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),              
             [Release qty]=Sum(Release_qty),              
             [Actual pledge]=Sum(Pledge_qty)              
      From   Tbl_party_pledge_data (NOLOCK)              
      Where  Processdate >= @FRMDT              
             And Processdate <= @TODT              
             And Accno Like @ACCNO              
             And Isin Like @ISIN              
             And Party_code Like @PARTY_CODE              
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname              
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,[Total pledgeble qty] Desc,Isin              
      Order  By Convert(Varchar, Processdate, 106),[Net debit]             
   End              
              
   Set nocount Off;              
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLIRPT_ACTUAL
-- --------------------------------------------------
CREATE Procedure USP_PLEDGEUNPLEDGECLIRPT_ACTUAL
(                  
 @FrmDt       As Datetime,                  
 @ToDt        As Datetime,                  
 @AccNo       As Varchar(20),                  
 @Party_code  As Varchar(20),                  
 @ISIN        As Varchar(20),                  
 @Data        As Varchar(20),                  
 @access_to   As Varchar(20),                  
 @access_code As Varchar(20)                  
)                  
As                  
Begin                  
   Set nocount On;                  
                  
   --Declare @FrmDt as Datetime,@ToDt as Datetime,                    
   --@AccNo as Varchar(20),@Party_code as Varchar(20),                    
   --@ISIN as Varchar(20),@access_to as Varchar(20),                    
   --@access_code as Varchar(20)                    
                  
   --set @FrmDt=GETDATE()-1                    
   --set @ToDt=GETDATE()                    
   --set @AccNo='1203320000000066'                    
   --set @ISIN='INE275A01028'                    
   --set @Party_code='%'                    
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)                  
                  
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'                  
                  
   If @Data = 'Current'                  
   Begin                  
      Select [Date]=Convert(Varchar, Processdate, 106),                  
             Party_code,                  
             Min((Ledger_bal))     As [Net debit],                  
             Min((Ledger_bal * 2)) As [Adjustable debit],                  
             Isin,                  
             Scripname,                  
             [Accountno]=Accno,                  
             [Total holding qty]=Sum(Qty),                  
             [Total holding hold value]=Sum(Hold_value),                  
             [Total pledgeble qty]=Sum(Case Client_priority                  
                                        When 1 Then Qty                  
                                        Else 0                  
                                       End),                  
             [Total pledgeble hold value]=Sum(Case Client_priority                  
                                               When 1 Then Hold_value                  
                                               Else 0                  
                                              End),                  
             [Closing price]=Avg_closing,                  
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                  
             [Release qty]=Sum(Release_qty),                  
             [Actual pledge]=Sum(Pledge_qty)                  
      From   Tbl_party_pledge_data (NOLOCK)                  
      Where  Accno Like @ACCNO                  
             And Isin Like @ISIN                  
             And Party_code Like @PARTY_CODE                  
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                  
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,Isin                  
      Order  By Convert(Varchar, Processdate, 106),[Net debit]                
   End                  
   Else                  
   Begin              
   /*              
  Added by Prashant on Jan  2 2013, Reported By : Anil wandre              
  Reason :- Double Entries in Log table due to Reprocess              
   */              
   SELECT CONVERT(date,PROCESSDATE) as Date,MAX(PROCESSDATE) as EntryDate              
  INTO #RPT_DATES              
   FROM TBL_PARTY_PLEDGE_DATA_LOG with(nolock)              
   WHERE PROCESSDATE>=@FRMDT AND PROCESSDATE<=@TODT              
   group by CONVERT(date,PROCESSDATE)              
                 
   CREATE NONCLUSTERED INDEX IDX_DATE ON #RPT_DATES (ENTRYDATE)              
                 
      Select [Date]=Convert(Varchar, Processdate, 106),                  
             Party_code,                  
             Min((Ledger_bal))     As [Net debit],                  
   Min((Ledger_bal * 2)) As [Adjustable debit],                  
             Isin,                  
             Scripname,                  
             [Accountno]=Accno,                  
             [Total holding qty]=Sum(Qty),                  
             [Total holding hold value]=Sum(Hold_value),                  
             [Total pledgeble qty]=Sum(Case Client_priority                  
                                        When 1 Then Qty                  
                                        Else 0                  
                     End),                  
             [Total pledgeble hold value]=Sum(Case Client_priority                  
                                               When 1 Then Hold_value                  
                                               Else 0                  
                                              End),                  
             [Closing price]=Avg_closing,                  
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                  
             [Release qty]=Sum(Release_qty),                  
             [Actual pledge]=Sum(Pledge_qty)          
             --[Actual pledge]=Sum(Pledge_qty-bse_exchange_pledge_qty)                  
      From   Tbl_party_pledge_data_log A (NOLOCK)            
  INNER JOIN #RPT_DATES B              
   ON A.Processdate = B.EntryDate              
    Where  Processdate >= @FRMDT                  
     And Processdate <= @TODT                  
     And Accno Like @ACCNO                  
     And Isin Like @ISIN                  
     And Party_code Like @PARTY_CODE                  
   Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                  
      Union All                  
      Select [Date]=Convert(Varchar, Processdate, 106),                  
             Party_code,                  
             Min((Ledger_bal))     As [Net debit],                  
             Min((Ledger_bal * 2)) As [Adjustable debit],                  
             Isin,                  
             Scripname,                  
             [Accountno]=Accno,                  
             [Total holding qty]=Sum(Qty),                  
             [Total holding hold value]=Sum(Hold_value),                  
             [Total pledgeble qty]=Sum(Case Client_priority                  
                                        When 1 Then Qty                  
                                        Else 0                  
                                       End),                  
             [Total pledgeble hold value]=Sum(Case Client_priority                  
                                               When 1 Then Hold_value                  
                                               Else 0                  
                                              End),                  
             [Closing price]=Avg_closing,                  
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                  
             [Release qty]=Sum(Release_qty),                  
             [Actual pledge]=Sum(Pledge_qty)                  
      From   Tbl_party_pledge_data (NOLOCK)                  
      Where  Processdate >= @FRMDT                  
             And Processdate <= @TODT                  
             And Accno Like @ACCNO                  
             And Isin Like @ISIN                  
             And Party_code Like @PARTY_CODE                  
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                  
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,[Total pledgeble qty] Desc,Isin                  
      Order  By Convert(Varchar, Processdate, 106),[Net debit]                 
   End                  
                  
   Set nocount Off;                  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLIRPT_archivaldb
-- --------------------------------------------------
    
--USP_PLEDGEUNPLEDGECLIRPT '2019-01-04','2019-01-04','%','%','%','HISTORY','broker','cso'    
    
create Procedure [dbo].[USP_PLEDGEUNPLEDGECLIRPT_archivaldb]
(                
 @FrmDt       As Datetime,                
 @ToDt        As Datetime,                
 @AccNo       As Varchar(20),                
 @Party_code  As Varchar(20),                
 @ISIN        As Varchar(20),                
 @Data        As Varchar(20),                
 @access_to   As Varchar(20),                
 @access_code As Varchar(20)                
)                
As                
Begin                
   Set nocount On;                
                
   --Declare @FrmDt as Datetime,@ToDt as Datetime,                  
   --@AccNo as Varchar(20),@Party_code as Varchar(20),                  
   --@ISIN as Varchar(20),@access_to as Varchar(20),                  
   --@access_code as Varchar(20)                  
                
   --set @FrmDt=GETDATE()-1                  
   --set @ToDt=GETDATE()                  
   --set @AccNo='1203320000000066'                  
   --set @ISIN='INE275A01028'                  
   --set @Party_code='%'                  
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)                
                
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'                
                
   If @Data = 'Current'                
   Begin                
      Select [Date]=Convert(Varchar, Processdate, 106),                
             Party_code,                
             Min((Ledger_bal))     As [Net debit],                
             Min((Ledger_bal * 2)) As [Adjustable debit],                
             Isin,                
             Scripname,                
             [Accountno]=Accno,                
             [Total holding qty]=Sum(Qty),                
             [Total holding hold value]=Sum(Hold_value),                
             [Total pledgeble qty]=Sum(Case Client_priority                
                                        When 1 Then Qty                
                                        Else 0                
                                       End),                
             [Total pledgeble hold value]=Sum(Case Client_priority                
                                               When 1 Then Hold_value                
                                               Else 0                
                                              End),                
             [Closing price]=Avg_closing,                
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                
             [Release qty]=Sum(Release_qty),                
             [Actual pledge]=Sum(Pledge_qty)                
      From   Tbl_party_pledge_data (NOLOCK)                
      Where  Accno Like @ACCNO                
             And Isin Like @ISIN                
             And Party_code Like @PARTY_CODE                
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,Isin                
      Order  By Convert(Varchar, Processdate, 106),[Net debit]              
   End                
   Else                
   Begin            
   /*            
  Added by Prashant on Jan  2 2013, Reported By : Anil wandre            
  Reason :- Double Entries in Log table due to Reprocess            
   */            
   SELECT CONVERT(date,PROCESSDATE) as Date,MAX(PROCESSDATE) as EntryDate            
  INTO #RPT_DATES            
   FROM [172.31.16.250].[196.1.115.182].dbo.Pledge_dbo_TBL_PARTY_PLEDGE_DATA_LOG_01_Dec_2016_To_31_Mar_2019 with(nolock)            
   WHERE PROCESSDATE>=@FrmDt AND PROCESSDATE<=@ToDt            
   group by CONVERT(date,PROCESSDATE)    
   
   select min(PROCESSDATE) from TBL_PARTY_PLEDGE_DATA_LOG        
   
  update #RPT_DATES set EntryDate='2016-11-08 08:56:10.877' where   EntryDate='2016-11-08 11:46:03.740'
               
   CREATE NONCLUSTERED INDEX IDX_DATE ON #RPT_DATES (ENTRYDATE)            
               
      Select  [Date]=Convert(Varchar, Processdate, 106),                
             Party_code,                
             Min((Ledger_bal))     As [Net debit],                
   Min((Ledger_bal * 2)) As [Adjustable debit],                
             Isin,                
             Scripname,                
             [Accountno]=Accno,                
             [Total holding qty]=Sum(Qty),                
             [Total holding hold value]=Sum(Hold_value),                
             [Total pledgeble qty]=Sum(Case Client_priority                
                                        When 1 Then Qty                
                                        Else 0                
                     End),                
             [Total pledgeble hold value]=Sum(Case Client_priority                
                                               When 1 Then Hold_value                
                                               Else 0                
                                              End),                
             [Closing price]=Avg_closing,                
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                
             [Release qty]=Sum(Release_qty),                
             [Actual pledge]=Sum(Pledge_qty)        
             --[Actual pledge]=Sum(Pledge_qty-bse_exchange_pledge_qty)                
      From   Tbl_party_pledge_data_log A (NOLOCK)          
  INNER JOIN #RPT_DATES B            
   ON A.Processdate = B.EntryDate            
    Where  Processdate >= @FRMDT                
     And Processdate <= @TODT                
     And Accno Like @ACCNO                
     And Isin Like @ISIN                
     And Party_code Like @PARTY_CODE                
   Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                
      Union All                
      Select [Date]=Convert(Varchar, Processdate, 106),                
             Party_code,                
             Min((Ledger_bal))     As [Net debit],                
             Min((Ledger_bal * 2)) As [Adjustable debit],                
             Isin,                
             Scripname,                
             [Accountno]=Accno,                
             [Total holding qty]=Sum(Qty),                
             [Total holding hold value]=Sum(Hold_value),                
             [Total pledgeble qty]=Sum(Case Client_priority                
                                        When 1 Then Qty                
                                        Else 0                
                                       End),                
             [Total pledgeble hold value]=Sum(Case Client_priority                
                                               When 1 Then Hold_value                
                                               Else 0                
                                              End),                
             [Closing price]=Avg_closing,                
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                
             [Release qty]=Sum(Release_qty),                
             [Actual pledge]=Sum(Pledge_qty)                
      From   Tbl_party_pledge_data (NOLOCK)                
      Where  Processdate >= @FRMDT                
             And Processdate <= @TODT                
             And Accno Like @ACCNO                
             And Isin Like @ISIN                
             And Party_code Like @PARTY_CODE                
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,[Total pledgeble qty] Desc,Isin                
      Order  By Convert(Varchar, Processdate, 106),[Net debit]               
   End                
                
   Set nocount Off;                
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLIRPT_bipin
-- --------------------------------------------------
CREATE Procedure USP_PLEDGEUNPLEDGECLIRPT_bipin    
(    
 @FrmDt       As Datetime,    
 @ToDt        As Datetime,    
 @AccNo       As Varchar(20),    
 @Party_code  As Varchar(20),    
 @ISIN        As Varchar(20),    
 @Data        As Varchar(20),    
 @access_to   As Varchar(20),    
 @access_code As Varchar(20)    
)    
As    
Begin    
   Set nocount On;    
     
   TRUNCATE TABLE TBL_PLEDGE_DATA_BIPIC_TMP  
    
   --Declare @FrmDt as Datetime,@ToDt as Datetime,      
   --@AccNo as Varchar(20),@Party_code as Varchar(20),      
   --@ISIN as Varchar(20),@access_to as Varchar(20),      
   --@access_code as Varchar(20)      
    
   --set @FrmDt=GETDATE()-1      
   --set @ToDt=GETDATE()      
   --set @AccNo='1203320000000066'      
   --set @ISIN='INE275A01028'      
   --set @Party_code='%'      
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)    
    
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'    
    
   If @Data = 'Current'    
   Begin    
   INSERT INTO TBL_PLEDGE_DATA_BIPIC_TMP  
      Select  [Date]=Convert(Varchar, Processdate, 106),    
             Party_code,    
             Min((Ledger_bal))     As [Net debit],    
             Min((Ledger_bal * 2)) As [Adjustable debit],    
             Isin,    
             Scripname,    
             [Accountno]=Accno,    
             [Total holding qty]=Sum(Qty),    
             [Total holding hold value]=Sum(Hold_value),    
             [Total pledgeble qty]=Sum(Case Client_priority    
                                        When 1 Then Qty    
                                        Else 0    
                                       End),    
             [Total pledgeble hold value]=Sum(Case Client_priority    
                                               When 1 Then Hold_value    
                                               Else 0    
                                              End),    
             [Closing price]=Avg_closing,    
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),    
             [Release qty]=Sum(Release_qty),    
             [Actual pledge]=Sum(Pledge_qty)    
      From   Tbl_party_pledge_data (NOLOCK)    
      Where  Accno Like @ACCNO    
             And Isin Like @ISIN    
             And Party_code Like @PARTY_CODE    
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname    
      Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,Isin    
   End    
   Else    
   Begin
   
   SELECT CONVERT(date,PROCESSDATE) as Date,MAX(PROCESSDATE) as EntryDate        
  INTO #RPT_DATES        
   FROM TBL_PARTY_PLEDGE_DATA_LOG with(nolock)        
   WHERE PROCESSDATE>=@FRMDT AND PROCESSDATE<=@TODT        
   group by CONVERT(date,PROCESSDATE)        
   
   
   
      INSERT INTO TBL_PLEDGE_DATA_BIPIC_TMP  
      Select [Date]=Convert(Varchar, Processdate, 106),    
             Party_code,    
             Min((Ledger_bal))     As [Net debit],    
             Min((Ledger_bal * 2)) As [Adjustable debit],    
             Isin,    
             Scripname,    
             [Accountno]=Accno,    
             [Total holding qty]=Sum(Qty),    
             [Total holding hold value]=Sum(Hold_value),    
             [Total pledgeble qty]=Sum(Case Client_priority    
                                        When 1 Then Qty    
                                        Else 0    
                                       End),    
             [Total pledgeble hold value]=Sum(Case Client_priority    
                                               When 1 Then Hold_value    
                                               Else 0    
                                              End),    
             [Closing price]=Avg_closing,    
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),    
             [Release qty]=Sum(Release_qty),    
             [Actual pledge]=Sum(Pledge_qty)    
      From   Tbl_party_pledge_data_log A (NOLOCK)
				INNER JOIN #RPT_DATES B        
					ON A.Processdate = B.EntryDate      
      Where  Processdate >= @FRMDT    
             And Processdate <= @TODT    
             And Accno Like @ACCNO    
             And Isin Like @ISIN    
             And Party_code Like @PARTY_CODE    
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname    
      Union All    
      Select [Date]=Convert(Varchar, Processdate, 106),    
             Party_code,    
             Min((Ledger_bal))     As [Net debit],    
             Min((Ledger_bal * 2)) As [Adjustable debit],    
             Isin,    
             Scripname,    
             [Accountno]=Accno,    
             [Total holding qty]=Sum(Qty),    
             [Total holding hold value]=Sum(Hold_value),    
             [Total pledgeble qty]=Sum(Case Client_priority    
                                        When 1 Then Qty    
                                        Else 0    
                                       End),    
             [Total pledgeble hold value]=Sum(Case Client_priority    
                                               When 1 Then Hold_value    
                                               Else 0    
                                              End),    
             [Closing price]=Avg_closing,    
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),    
             [Release qty]=Sum(Release_qty),    
             [Actual pledge]=Sum(Pledge_qty)    
      From   Tbl_party_pledge_data (NOLOCK)    
      Where  Processdate >= @FRMDT    
             And Processdate <= @TODT    
             And Accno Like @ACCNO    
             And Isin Like @ISIN    
             And Party_code Like @PARTY_CODE    
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname    
      Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,[Total pledgeble qty] Desc,Isin    
   End    
    
   Set nocount Off;    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLIRPT_insp
-- --------------------------------------------------
--USP_PLEDGEUNPLEDGECLIRPT 'apr 17 2012','apr 17 2012','1203320000000066','%','%','his','broker','cso'    
CREATE Procedure USP_PLEDGEUNPLEDGECLIRPT_insp  
(                  
 @FrmDt       As Datetime,                  
 @ToDt        As Datetime,                  
 @AccNo       As Varchar(20),                  
 @Party_code  As Varchar(20),                  
 @ISIN        As Varchar(20),                  
 @Data        As Varchar(20),                  
 @access_to   As Varchar(20),                  
 @access_code As Varchar(20)                  
)                  
As                  
Begin                  
   Set nocount On;                  
                  
   --Declare @FrmDt as Datetime,@ToDt as Datetime,                    
   --@AccNo as Varchar(20),@Party_code as Varchar(20),                    
   --@ISIN as Varchar(20),@access_to as Varchar(20),                    
   --@access_code as Varchar(20)                    
                  
   --set @FrmDt=GETDATE()-1                    
   --set @ToDt=GETDATE()                    
   --set @AccNo='1203320000000066'                    
   --set @ISIN='INE275A01028'                    
   --set @Party_code='%'                    
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)                  
                  
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'                  
                  
   If @Data = 'Current'                  
   Begin                  
      Select [Date]=Convert(Varchar, Processdate, 106),                  
             Party_code,                  
             Min((Ledger_bal))     As [Net debit],                  
             Min((Ledger_bal * 2)) As [Adjustable debit],                  
             Isin,                  
             Scripname,                  
             [Accountno]=Accno,                  
             [Total holding qty]=Sum(Qty),                  
             [Total holding hold value]=Sum(Hold_value),                  
             [Total pledgeble qty]=Sum(Case Client_priority                  
                                        When 1 Then Qty                  
                                        Else 0                  
                                       End),                  
             [Total pledgeble hold value]=Sum(Case Client_priority                  
                                               When 1 Then Hold_value                  
                                               Else 0                  
                                              End),                  
             [Closing price]=Avg_closing,                  
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                  
             [Release qty]=Sum(Release_qty),                  
             [Actual pledge]=Sum(Pledge_qty)                  
      From   Tbl_party_pledge_data (NOLOCK)                  
      Where  Accno Like @ACCNO                  
             And Isin Like @ISIN                  
             And Party_code Like @PARTY_CODE                  
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                  
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,Isin                  
      Order  By Convert(Varchar, Processdate, 106),[Net debit]                
   End                  
   Else                  
   Begin              
   /*              
  Added by Prashant on Jan  2 2013, Reported By : Anil wandre              
  Reason :- Double Entries in Log table due to Reprocess              
   */    
   /*    
   SELECT CONVERT(date,PROCESSDATE) as Date,MAX(PROCESSDATE) as EntryDate              
  INTO #RPT_DATES              
   --FROM TBL_PARTY_PLEDGE_DATA_LOG with(nolock)              
   --From   [196.1.115.245].general_new.dbo.TBL_BSE_EXCHANGE_PLEDGE with(NOLOCK)              
   From   [196.1.115.245].general_new.dbo.vw_BSE_EXCHANGE_PLEDGE_2 with(NOLOCK)              
   --WHERE PROCESSDATE>=@FRMDT AND PROCESSDATE<=@TODT              
   WHERE rms_date>=@FRMDT AND rms_date<=@TODT              
   group by CONVERT(date,PROCESSDATE)              
   */    
                 
   --CREATE NONCLUSTERED INDEX IDX_DATE ON #RPT_DATES (ENTRYDATE)              
                 
      Select [Date]=Convert(Varchar, rms_date, 106),                  
             Party_code,                  
             Min((Ledger_bal))     As [Net debit],                  
             Min((Ledger_bal * 2)) As [Adjustable debit],                  
             Isin,                  
             Scripname,                  
             [Accountno]=Accno,                  
             [Total holding qty]=Sum(Qty),                  
             [Total holding hold value]=Sum(Hold_value),                  
             [Total pledgeble qty]=Sum(Case Client_priority                  
                                        When 1 Then Qty                  
                                        Else 0                  
                     End),                  
             [Total pledgeble hold value]=Sum(Case Client_priority                  
                                               When 1 Then Hold_value                  
                                               Else 0                  
                                              End),                  
             [Closing price]=Avg_closing,                  
             --[Prevday pledege qty]=Sum(Prevday_pledege_qty),                  
             [Prevday pledege qty]=Sum(Prevday_pledege_qty-PrevDay_Pledge_BSE_Exchange),   
             [Release qty]=Sum(Release_qty),                  
             --[Actual pledge]=Sum(Pledge_qty)          
             [Actual pledge]=Sum(Pledge_qty-bse_exchange_pledge_qty)                  
      --From   Tbl_party_pledge_data_log A (NOLOCK)            
      From   [196.1.115.245].general_new.dbo.TBL_BSE_EXCHANGE_PLEDGE a with(NOLOCK)              
  /*    
    INNER JOIN #RPT_DATES B              
     ON A.Processdate = B.EntryDate              
  */    
   Where  rms_date >= @FRMDT                  
    And rms_date <= @TODT                  
    And Accno Like @ACCNO                  
    And Isin Like @ISIN                  
    And Party_code Like @PARTY_CODE                  
    Group  By Party_code,Convert(Varchar, rms_date, 106),Isin,Accno,Avg_closing,Scripname                  
      Union All                  
      Select [Date]=Convert(Varchar, Processdate, 106),                  
             Party_code,                  
             Min((Ledger_bal))     As [Net debit],                  
             Min((Ledger_bal * 2)) As [Adjustable debit],                  
             Isin,                  
             Scripname,                  
             [Accountno]=Accno,                  
             [Total holding qty]=Sum(Qty),                  
             [Total holding hold value]=Sum(Hold_value),                  
             [Total pledgeble qty]=Sum(Case Client_priority                  
                                        When 1 Then Qty                  
                                        Else 0                  
                                       End),                  
             [Total pledgeble hold value]=Sum(Case Client_priority                  
                                               When 1 Then Hold_value                  
                                               Else 0                  
                                              End),                  
             [Closing price]=Avg_closing,                  
             [Prevday pledege qty]=Sum(Prevday_pledege_qty),                  
             [Release qty]=Sum(Release_qty),                  
             [Actual pledge]=Sum(Pledge_qty)                  
      From   Tbl_party_pledge_data (NOLOCK)                  
      Where  Processdate >= @FRMDT                  
             And Processdate <= @TODT                  
             And Accno Like @ACCNO                  
             And Isin Like @ISIN                  
             And Party_code Like @PARTY_CODE                  
      Group  By Party_code,Convert(Varchar, Processdate, 106),Isin,Accno,Avg_closing,Scripname                  
      --Order  By Convert(Varchar, Processdate, 106),Party_code,Accno,[Total pledgeble qty] Desc,Isin                 
      Order  By Convert(Varchar, rms_date, 106),[Net debit]                 
   End                  
                  
   Set nocount Off;                  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PLEDGEUNPLEDGECLIRPT_SEBI
-- --------------------------------------------------
    
--USP_PLEDGEUNPLEDGECLIRPT_SEBI '2015-12-31','2015-12-31','%','%','%','HISTORY','broker','cso' 
--USP_PLEDGEUNPLEDGECLIRPT_SEBI '2015-12-31','2015-12-31','%','%','%','Current','broker','cso'    
    
CREATE Procedure [dbo].[USP_PLEDGEUNPLEDGECLIRPT_SEBI]
(                
 @FrmDt       As Datetime,                
 @ToDt        As Datetime,                
 @AccNo       As Varchar(20)='',
 @RptType     As Varchar(20)='',              
 @Party_code  As Varchar(20)='',                
 @ISIN        As Varchar(20)='',                
 @Data        As Varchar(20)='',                
 @access_to   As Varchar(20)='',                
 @access_code As Varchar(20)='',
 @Flag        As Varchar(10)=''                
)                
As                
Begin                
   Set nocount On;                
                
   --Declare @FrmDt as Datetime,@ToDt as Datetime,                  
   --@AccNo as Varchar(20),@Party_code as Varchar(20),                  
   --@ISIN as Varchar(20),@access_to as Varchar(20),                  
   --@access_code as Varchar(20)                  
                
   --set @FrmDt=GETDATE()-1                  
   --set @ToDt=GETDATE()                  
   --set @AccNo='1203320000000066'                  
   --set @ISIN='INE275A01028'                  
   --set @Party_code='%'                  
   Set @FrmDt=Convert(Varchar, @FrmDt, 106)                
                
   Set @ToDt=Convert(Varchar, @ToDt, 106) + ' 23:59:59'                
                
   If (@RptType ='CW' AND  @Data = 'Current' )               
   Begin                
      
      Select [Date]=Convert(Varchar, A.Processdate, 106),                
             A.Party_code,                
             [Ledger debit at the end of trade day] = Min((A.Ledger_bal)), 
             [ISIN/ Security Name] = A.ISIN ,
             [Previous days closing price]=B.Avg_closing,
             [Total Quantity]=Sum(B.Qty),
             ((B.Avg_closing )* ( Sum(B.Qty))) as 'Total Value (Total Quantity * Previous day closing price)',
             ((B.Avg_closing )* ( Sum(B.Qty)))/2 as'Total Value (Adjusted for applicable haircut)',
             [Pledged Quantity]=Sum(B.pledge_qty),  
             [Pledged Value]=( CASE WHEN (Sum(B.pledge_qty))=(Sum(B.Qty)) 
								THEN (((B.Avg_closing )* ( Sum(B.Qty)))/2) ELSE ((Sum(B.pledge_qty))*(B.Avg_closing))/2 END )
             ,[Borrowing]=convert(decimal(18,3), ((pledge_value/2) * isnull(C.PERCENTAGE,0 ))/100),
             C.Bank_name as [Details of Pledgee (Bank Name)]
              --into #Temp              
      From   Tbl_party_pledge_data A(NOLOCK)
			 Left hash Join	
			 Tbl_party_pledged_bankwise_data B (NOLOCK) on A.Party_code=B.Party_code and A.isin=B.isin and A.accno=B.accno
			 Left Join 
			 dbo.tbl_PledgeUnpledgeBorrowing C  on B.Bank_Code = C.Bank_Code 	  
			 	                
      Where  A.Accno Like @ACCNO                
             And A.Isin Like @ISIN 
             And A.Party_code Like @PARTY_CODE 
             And A.PREVDAY_PLEDEGE_QTY <> 0 
             
             AND B.processdate= (select processdate=max(processdate) from dbo.Tbl_party_pledged_bankwise_data ) 
      Group  By A.Party_code,Convert(Varchar, A.Processdate, 106),A.Isin,A.Accno,B.Avg_closing,A.Scripname,pledge_value,C.PERCENTAGE,C.Bank_name                                     
      Order  By Convert(Varchar, A.Processdate, 106)
      
      
      ----------------
      /*
      Select [Date]=Convert(Varchar, A.Processdate, 106),                
             A.Party_code,                
             [Ledger debit at the end of trade day] = Min((A.Ledger_bal)), 
             [ISIN/ Security Name] = A.ISIN ,
             [Previous days closing price]=A.Avg_closing,
             [Total Quantity]=Sum(A.Qty),
             ((A.Avg_closing )* ( Sum(A.Qty))) as 'Total Value (Total Quantity * Previous day closing price)',
             ((A.Avg_closing )* ( Sum(A.Qty)))/2 as'Total Value (Adjusted for applicable haircut)',
             [Pledged Quantity]=Sum(A.Prevday_pledege_qty),  
             [Pledged Value]=( CASE WHEN (Sum(A.Prevday_pledege_qty))=(Sum(A.Qty)) 
								THEN (((A.Avg_closing )* ( Sum(A.Qty)))/2) ELSE ((Sum(A.Prevday_pledege_qty))*(A.Avg_closing))/2 END ),
             B.Borrowing as [Borrowing],
             B.Bankname as [Details of Pledgee (Bank Name)]
                            
      From   Tbl_party_pledge_data A(NOLOCK)
			 Left Join	
			 ClientWiseDatewise_PledgeDetails B on A.Party_code=B.Party_code and A.isin=B.isin	                
      Where  A.Accno Like @ACCNO                
             And A.Isin Like @ISIN
             And A.Party_code Like @PARTY_CODE
             And A.PREVDAY_PLEDEGE_QTY <> 0 
      Group  By A.Party_code,Convert(Varchar, A.Processdate, 106),A.Isin,A.Accno,A.Avg_closing,A.Scripname,B.Borrowing,B.Bankname                                     
      Order  By Convert(Varchar, A.Processdate, 106) /*,[Net debit]*/ 
      
      */             
   End                
   If (@RptType ='CW' AND  @Data = 'History')               
   Begin            
   /*            
  Added by Prashant on Jan  2 2013, Reported By : Anil wandre            
  Reason :- Double Entries in Log table due to Reprocess            
   */            
   SELECT CONVERT(date,PROCESSDATE) as Date,MAX(PROCESSDATE) as EntryDate            
  INTO #RPT_DATES            
   FROM TBL_PARTY_PLEDGE_DATA_LOG with(nolock)            
   WHERE PROCESSDATE>=@FRMDT AND PROCESSDATE<=@TODT            
   group by CONVERT(date,PROCESSDATE)            
               
   CREATE NONCLUSTERED INDEX IDX_DATE ON #RPT_DATES (ENTRYDATE)            
               
   
   Select [Date]=Convert(Varchar, A.Processdate, 106),                
             A.Party_code,                
             [Ledger debit at the end of trade day] = Min((A.Ledger_bal)), 
             [ISIN/ Security Name] = A.ISIN ,
             [Previous days closing price]=C.Avg_closing,
             [Total Quantity]=Sum(C.Qty),
             ((C.Avg_closing )* ( Sum(C.Qty))) as 'Total Value (Total Quantity * Previous day closing price)',
             ((C.Avg_closing )* ( Sum(C.Qty)))/2 as'Total Value (Adjusted for applicable haircut)',
             [Pledged Quantity]=Sum(C.pledge_qty),  
             [Pledged Value]=( CASE WHEN (Sum(C.pledge_qty))=(Sum(C.Qty)) 
								THEN (((C.Avg_closing )* ( Sum(C.Qty)))/2) ELSE ((Sum(C.pledge_qty))*(C.Avg_closing))/2 END )
             ,[Borrowing]=convert(decimal(18,3), ((pledge_value/2) * isnull(D.PERCENTAGE,0 ))/100),
             D.Bank_name as [Details of Pledgee (Bank Name)]
                             
      From   Tbl_party_pledge_data_log A (NOLOCK)          
			INNER JOIN #RPT_DATES B ON A.Processdate = B.EntryDate   
			LEFT HASH JOIN Tbl_party_pledged_bankwise_data C (NOLOCK) on A.Party_code=C.Party_code and A.isin=C.isin and A.accno=C.accno
			LEFT JOIN dbo.tbl_PledgeUnpledgeBorrowing D  on C.Bank_Code = D.Bank_Code 		            
  
			Where  A.Processdate >= @FRMDT                
			 And A.Processdate <= @TODT                
			 And A.Accno Like @ACCNO                
			 And A.Isin Like @ISIN                
			 And A.Party_code Like @PARTY_CODE                
			Group  By A.Party_code,Convert(Varchar, A.Processdate, 106),A.Isin,A.Accno,C.Avg_closing,A.Scripname,Pledge_Value,D.PERCENTAGE,D.Bank_name                
      Union All 
                     
   Select [Date]=Convert(Varchar, A.Processdate, 106),                
             A.Party_code,                
             [Ledger debit at the end of trade day] = Min((A.Ledger_bal)), 
             [ISIN/ Security Name] = A.ISIN ,
             [Previous days closing price]=C.Avg_closing,
             [Total Quantity]=Sum(C.Qty),
             ((C.Avg_closing )* ( Sum(C.Qty))) as 'Total Value (Total Quantity * Previous day closing price)',
             ((C.Avg_closing )* ( Sum(C.Qty)))/2 as'Total Value (Adjusted for applicable haircut)',
             [Pledged Quantity]=Sum(C.pledge_qty),  
             [Pledged Value]=( CASE WHEN (Sum(C.pledge_qty))=(Sum(C.Qty)) 
								THEN (((C.Avg_closing )* ( Sum(C.Qty)))/2) ELSE ((Sum(C.pledge_qty))*(C.Avg_closing))/2 END )
             ,[Borrowing]=convert(decimal(18,3), ((pledge_value/2) * isnull(D.PERCENTAGE,0 ))/100),
             D.Bank_name as [Details of Pledgee (Bank Name)]
             
      From   Tbl_party_pledge_data A (NOLOCK)          
			  INNER JOIN #RPT_DATES B ON A.Processdate = B.EntryDate            
			  LEFT HASH JOIN Tbl_party_pledged_bankwise_data C (NOLOCK) on A.Party_code=C.Party_code and A.isin=C.isin and A.accno=C.accno
			  LEFT JOIN dbo.tbl_PledgeUnpledgeBorrowing D  on C.Bank_Code = D.Bank_Code 
				Where  A.Processdate >= @FRMDT                
				 And A.Processdate <= @TODT                
				 And A.Accno Like @ACCNO                
				 And A.Isin Like @ISIN                
				 And A.Party_code Like @PARTY_CODE                
			    Group  By A.Party_code,Convert(Varchar, A.Processdate, 106),A.Isin,A.Accno,C.Avg_closing,A.Scripname,Pledge_Value,D.PERCENTAGE,D.Bank_name               
   End 
   
   If (@RptType ='BW' AND  @Data = 'HISTORY' )               
   Begin
		
      SET @FrmDt=@FrmDt + ' 00:00:00'
      SET @ToDt=@ToDt + ' 23:59:59'

      IF @Party_Code = '%'
        BEGIN
            SET @Party_Code=NULL
        END

      IF @ISIN = '%'
        BEGIN
            SET @ISIN=NULL
        END

      IF @AccNo = '%'
        BEGIN
            SET @AccNo=NULL
        END
        
        
        SELECT top 1 M.BankName,
                   A.Party_Code,
                   A.ISIN,
                   A.Scrip_cd,
                   A.ScripName,
                   A.ACCNO,
                   A.Pledge_QTY,
                   A.Avg_Closing,
                   A.Pledge_Value,
                   A.OD_Utilization,
                   A.Processdate,
                   C.Borrowing as [Borrowing],
				   C.Bankname as [Details of Pledgee (Bank Name)]
				   
            FROM   Tbl_Party_Pledged_BankWise_Data A(Nolock)
                   /* CHANGE ID  :: 1 
                   Tbl_Party_Pledged_BankWise_Data_log A(Nolock)
                   */
                   INNER JOIN General.dbo.Vw_las_comb_bank_agreeement_mast M WITH(nolock)
                     ON A.Bank_code = M.Bank_code AND a.accno = m.pledgor_bo_id
                   Left merge Join	ClientWiseDatewise_PledgeDetails C WITH(NOLOCK) on A.Party_code = C.Party_code and A.isin=C.isin                      
            WHERE  A.Processdate >= @FrmDt
                   AND A.Processdate <= @ToDt
                   AND A.Party_Code = Isnull(@Party_Code, A.Party_Code)
                   AND A.ACCNO = Isnull(@ACCNO, A.ACCNO)
                   AND A.ISIN = Isnull(@ISIN, A.ISIN)
            --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)                 
            ORDER  BY M.Priority
   End
   
   If (@RptType ='BW' AND  @Data = 'Current' )               
   Begin               
	  
	  /*
	  declare @FrmDt datetime	
	  declare @ToDt datetime
	  declare @Party_Code varchar(30)='%'
	  declare @ISIN varchar(30)='%'
	  declare @AccNo varchar(30)='%'
		
      SET @FrmDt='14 Jan 2017' + ' 00:00:00'
      SET @ToDt='14 Jan 2017' + ' 23:59:59'
      */
      
      IF @Party_Code = '%'
        BEGIN
            SET @Party_Code=NULL
        END

      IF @ISIN = '%'
        BEGIN
            SET @ISIN=NULL
        END

      IF @AccNo = '%'
        BEGIN
            SET @AccNo=NULL
        END
        
		SELECT	   M.BankName,
                   A.Party_Code,
                   A.ISIN,
                   A.Scrip_cd,
                   A.ScripName,
                   A.ACCNO,
                   A.Pledge_QTY,
                   A.Avg_Closing,
                   A.Pledge_Value,
                   A.OD_Utilization,
                   A.Processdate,
                   C.Borrowing as [Borrowing],
				   C.Bankname as [Details of Pledgee (Bank Name)]
				   
            FROM   Tbl_Party_Pledged_BankWise_Data A(Nolock)
                   INNER JOIN General.dbo.Vw_las_comb_bank_agreeement_mast M WITH(nolock) 
                   ON A.Bank_code = M.Bank_code AND a.accno = m.pledgor_bo_id
                   LEFT MERGE JOIN	ClientWiseDatewise_PledgeDetails C WITH(NOLOCK) on A.Party_code = C.Party_code and A.isin=C.isin 
            WHERE  A.Processdate >= @FrmDt
                   AND A.Processdate <= @ToDt
                   AND A.Party_Code = Isnull(@Party_Code, A.Party_Code)
                   AND A.ACCNO = Isnull(@ACCNO, A.ACCNO)
                   AND A.ISIN = Isnull(@ISIN, A.ISIN)
            --and A.Bank_Code=isnull(@BankCode,A.Bank_Code)                 
            ORDER  BY M.Priority  
        
   End             
   Set nocount Off;                
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UpdateBOPledge_Dtl
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[usp_UpdateBOPledge_Dtl]    
AS    
BEGIN    
SET NOCOUNT ON;    
    IF NOT EXISTS (SELECT HDATE        
                        FROM   [196.1.115.239].HARMONY.DBO.HOLIMST A(NOLOCK)        
                        WHERE  CONVERT(DATETIME, CONVERT(VARCHAR, HDATE, 106))     
                                = CONVERT(DATETIME,CONVERT(VARCHAR, GETDATE(),106)))        
    BEGIN    
        DECLARE @PLEDGE_DATE AS DATETIME  
          
        SELECT @PLEDGE_DATE=MAX(PROCESSDATE) FROM TBL_PARTY_PLEDGE_DATA_LOG WITH(NOLOCK)  
          
        DELETE FROM AngelNseCM.MSAJAG.DBO.TBL_ANG_PARTY_PLEDGE     
        WHERE CONVERT(VARCHAR,PLEDGE_DATE,106)=CONVERT(VARCHAR,@PLEDGE_DATE,106)    
    
        INSERT INTO AngelNseCM.MSAJAG.DBO.TBL_ANG_PARTY_PLEDGE     
        (PARTY_CODE,SEGMENT,ISIN,SCRIP_CD,SCRIP_NAME,PLEDGE_QTY,    
        PLEDGE_VALUE,PLEDGE_DATE,UPDATE_DATETIME)     
        (SELECT PARTY_CODE,SEGMENT,ISIN,SCRIP_CD,SCRIP_NAME=SCRIPNAME,PLEDGE_QTY=PLEDGEQTY,    
        PLEDGE_VALUE=PLEDGEVALUE,PLEDGE_DATE=CONVERT(VARCHAR,@PLEDGE_DATE,106),UPDATE_DATETIME=GETDATE()     
        FROM GENERAL.DBO.VW_PARTY_PLEDGE_DTL WITH(NOLOCK))    
            
    END    
    
   /* Added by Manesh Mukherjee on 10/07/2012... as requested by anil wandre on 10/07/2012 06:16 pm approved by Rahul Shah */
   
   update A
   set pledge2release=b.unpledge_qty from mis.demat.dbo.Pledge2ReleaseEntry A
   RIGHT OUTER JOIN
   (
   select isin,pledge_no,sum(unpledge_qty) as unpledge_qty,pledgor_bo_id,pledgee_bo_id from pledge.dbo.Las_unpledge_request with (nolock)
   where convert(datetime,convert(varchar(11),update_datetime))=convert(datetime,convert(varchar(11),getdate()))
   and REQUEST_TYPE='CREDITORS'
   group by isin,pledge_no,pledgor_bo_id,pledgee_bo_id
   ) B
   ON 
   A.pledgeorder=b.pledge_no and A.isin=b.isin and a.clientid=b.pledgor_bo_id
   and a.bankid=b.pledgee_bo_id 
    
   /* Addition Ended */ 
    
SET NOCOUNT OFF;    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WCL_process
-- --------------------------------------------------
Create Procedure WCL_process(@mdate as varchar(11))
as
   Set NOCOUNT On      
      
      


      Select Party_code,      
             Co_code,      
             Convert(Money, 0) As Ledger,      
             Imargin,      
             Cash_colleteral,      
             Noncash_colleteral,      
             Unrecosiled_credit      
      Into   #NET_AVAILABLE_PARTY      
      From   General.dbo.Rms_dtclfi With(NOLOCK)      
      Where  Co_code Not In ('MCX', 'NCDEX')      


      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (
				Select Cltcode,      
				Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) As Bal      
				From   General.dbo.Bsecm_cledger With(NOLOCK)      
				Where  Vdt >= (select min(vdt) From General.dbo.Bsecm_cledger With(NOLOCK) where vtyp=18)  
				And Edt <= Convert(Varchar(11), @mdate ) + ' 23:59:59'      
				Group  By Cltcode      
				Having Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) <> 0
		) B      
		On A.Party_code = B.Cltcode      
		Where  Co_code = 'BSECM'      
      
      

      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (
				Select Cltcode,      
				Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) As Bal      
				From   General.dbo.Nsecm_cledger With(NOLOCK)      
				Where  Vdt >= (select min(vdt) From General.dbo.Nsecm_cledger With(NOLOCK) where vtyp=18)  
				And Edt <= Convert(Varchar(11), @mdate ) + ' 23:59:59'      
				Group  By Cltcode      
				Having Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) <> 0
		) B      
		On A.Party_code = B.Cltcode      
		Where  Co_code = 'NSECM'      
      


      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (
				Select Cltcode,      
				Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) As Bal      
				From   General.dbo.Nsefo_cledger With(NOLOCK)      
				Where  Vdt >= (select min(vdt) From General.dbo.Nsefo_cledger With(NOLOCK) where vtyp=18)  
				And Edt <= Convert(Varchar(11), @mdate ) + ' 23:59:59'      
				Group  By Cltcode      
				Having Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) <> 0
		) B      
		On A.Party_code = B.Cltcode      
		Where  Co_code = 'NSEFO'      
      



      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (
				Select Cltcode,      
				Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) As Bal      
				From   General.dbo.Nsefo_cledger With(NOLOCK)      
				Where  Vdt >= (select min(vdt) From General.dbo.Nsefo_cledger With(NOLOCK) where vtyp=18)  
				And Edt <= Convert(Varchar(11), @mdate ) + ' 23:59:59'      
				Group  By Cltcode      
				Having Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) <> 0
		) B      
		On A.Party_code = B.Cltcode      
		Where  Co_code = 'NSEFO'      


      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (
				Select Cltcode,      
				Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) As Bal      
				From   General.dbo.Mcd_cledger With(NOLOCK)      
				Where  Vdt >= (select min(vdt) From General.dbo.Mcd_cledger With(NOLOCK) where vtyp=18)  
				And Edt <= Convert(Varchar(11), @mdate ) + ' 23:59:59'      
				Group  By Cltcode      
				Having Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) <> 0
		) B      
		On A.Party_code = B.Cltcode      
		Where  Co_code = 'MCD'      


      Update A      
      Set    Ledger = Isnull(Bal, 0)      
      From   #NET_AVAILABLE_PARTY A      
             Right Outer Join (
				Select Cltcode,      
				Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) As Bal      
				From   General.dbo.Nsx_cledger With(NOLOCK)      
				Where  Vdt >= (select min(vdt) From General.dbo.Nsx_cledger With(NOLOCK) where vtyp=18)  
				And Edt <= Convert(Varchar(11), @mdate ) + ' 23:59:59'      
				Group  By Cltcode      
				Having Sum(Case      
				When Drcr = 'D' Then -Vamt      
				Else Vamt      
				End) <> 0
		) B      
		On A.Party_code = B.Cltcode      
		Where  Co_code = 'NSX'      


      Select Party_code,      
             Ledger=Sum(Ledger),      
             Imargin=Sum(Imargin),      
             Cash_colleteral=Sum(Cash_colleteral),      
             Noncash_colleteral=Sum(Noncash_colleteral),      
             Unrecosiled_credit=Sum(Unrecosiled_credit),      
             Samargin=Convert(Money, 0.0),      
           Varmargin=Convert(Money, 0.0),      
             Co_code      
      Into   #NET_AVAILABLE      
      From   #NET_AVAILABLE_PARTY (nolock)      
      Group  By Party_code,Co_code      

      Select Party_code,      
             Initialmargin=Sum(Initialmargin),      
             Addmargin=Sum(Addmargin),      
             Co_code      
      Into   #SPAN_ADDI_MARGIN      
      From   pledge.dbo.Vw_derivativemargin (NOLOCK) A      
      Group  By Party_code,Co_code      


      Update #NET_AVAILABLE      
      Set    Samargin = (Initialmargin + Addmargin)      
      From   #SPAN_ADDI_MARGIN A      
      Where  #net_available.Party_code = A.Party_code      
             And #net_available.Co_code = A.Co_code      
      
      /*------------------------------------      
      VAR MARGIN      
      SEGMENT EQUITY (BSE & NSE) ONLY      
      ---------------------------------------*/      

      Select Party_code,      
             Varmargin=Sum(Varmargin),      
             Co_code      
      Into   #EQUITY_VAR_MARGIN      
      From   pledge.dbo.Vw_equity_var_margin (NOLOCK) A      
      Group  By Party_code,Co_code      
      
      Update #NET_AVAILABLE      
      Set    Varmargin = (A.Varmargin)      
      From   #EQUITY_VAR_MARGIN A      
      Where  #net_available.Party_code = A.Party_code      
             And #net_available.Co_code = A.Co_code      
      
      --STEP 1      
      /*---------------------------------------------------------------      
      FETCHING CLIENTS WITH APPROVED HOLDING AND EXCLUDING CLIENTS      
      FROM TBL_CLI_NOT_FOR_PLEDGE TABLE      
      TABLE TBL_CLI_NOT_FOR_PLEDGE CONTAINS ALL CLIENTS FOR WHICH LOAN      
      HAS ALREADY BEEN TAKEN.      
      ---------------------------------------------------------------*/      
      Set Transaction ISOLATION LEVEL Read UNCOMMITTED      
      
      Select Rms_date,      
             Party_code,      
             Convert(Money, 0)    As Net,      
             Holding_approved,      
             Convert(Smallint, 0) As Client_priority      
      Into   #TBL_CL_LIST_APPR_HOLD      
      From   GENERAL.dbo.Rms_dtclfi_summ With(NOLOCK)      
      Where  Holding_approved <> 0      
      
   /*      
   COMMENTED BY PRASHANT ON JAN 3 2012 AS CONFIRMED BY YOGEN FROM RAHUL SIR      
   NOT TO EXLUDE NON LAS CLIENT      
   */      
      --AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM GENERAL..TBL_LAS_CLI_NOT_FOR_PLEDGE WITH(NOLOCK))      
      
		Update A      
		Set    Net = Isnull(Net_available, 0)      
		From   #TBL_CL_LIST_APPR_HOLD A      
		Left Outer Join (Select Party_code,      
		Sum(Ledger - Unrecosiled_credit - (Case      
		When (Samargin) - (Cash_colleteral + Noncash_colleteral) > 0 Then (Samargin) - (Cash_colleteral + Noncash_colleteral)      
		Else 0      
		End) - Varmargin) As Net_available      
		From   #NET_AVAILABLE      
		Group  By Party_code) B      
		On A.Party_code = B.Party_code      

   /*END*/      
      --STEP 2      
      /*---------------------------------------------------------------      
      GENERATING ROW NUMBER FOR LOOPING DEBIT CLIENTS      
      ---------------------------------------------------------------*/      
      Select *,      
             Row_number() Over(Order By Net) As Row_num      
      Into   #TBL_CL_LIST_APPR_HOLD_TMP      
      From   #TBL_CL_LIST_APPR_HOLD      
      Where  Net < 0      
      Order  By Net      
      
		insert into WCL_CliWC_details_temp
		select *,PledgeAmt=convert(money,0),
		Bucket_000=convert(money,0),
		Bucket_007=convert(money,0),
		Bucket_015=convert(money,0),
		Bucket_030=convert(money,0),
		Bucket_060=convert(money,0),
		Bucket_090=convert(money,0),
		Bucket_180=convert(money,0),
		Bucket_abv=convert(money,0),
		TOTAL_WCLimit=convert(money,0)
		from #TBL_CL_LIST_APPR_HOLD_TMP      







      
---      **** processed till here ****

GO

-- --------------------------------------------------
-- TABLE dbo.'051$'
-- --------------------------------------------------
CREATE TABLE [dbo].['051$']
(
    [Account] NVARCHAR(255) NULL,
    [ISIN Code] NVARCHAR(255) NULL,
    [ISIN NAME] NVARCHAR(255) NULL,
    [Bank Id] NVARCHAR(255) NULL,
    [Pledge Holding] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.'066$'
-- --------------------------------------------------
CREATE TABLE [dbo].['066$']
(
    [Account] NVARCHAR(255) NULL,
    [ISIN Code] NVARCHAR(255) NULL,
    [ISIN NAME] NVARCHAR(255) NULL,
    [Bank Id] NVARCHAR(255) NULL,
    [Pledge Holding] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bseappscr$
-- --------------------------------------------------
CREATE TABLE [dbo].[bseappscr$]
(
    [COMPANY_NAME] NVARCHAR(255) NULL,
    [ISIN] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.hdfcappscr$
-- --------------------------------------------------
CREATE TABLE [dbo].[hdfcappscr$]
(
    [Name of Company] NVARCHAR(255) NULL,
    [ISIN] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.iciciappscr$
-- --------------------------------------------------
CREATE TABLE [dbo].[iciciappscr$]
(
    [Name of the Scrip] NVARCHAR(255) NULL,
    [ISIN] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kotakappscr$
-- --------------------------------------------------
CREATE TABLE [dbo].[kotakappscr$]
(
    [SCRIP NAME] NVARCHAR(255) NULL,
    [ISIN] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LAS_INTERBANK_TRANSFER_REQUEST
-- --------------------------------------------------
CREATE TABLE [dbo].[LAS_INTERBANK_TRANSFER_REQUEST]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [FROM_BANK_CODE] INT NOT NULL,
    [FROM_PLEDGEE_BO_ID] VARCHAR(20) NOT NULL,
    [FROM_PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [TO_BANK_CODE] INT NOT NULL,
    [TO_PLEDGEE_BO_ID] VARCHAR(20) NOT NULL,
    [TO_PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [AGREEMENT_NO] VARCHAR(30) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [QTY] INT NOT NULL,
    [CLSRATE] MONEY NOT NULL,
    [VALUE] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_interbank_transfer_request_04Apr2018
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_interbank_transfer_request_04Apr2018]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [FROM_BANK_CODE] INT NOT NULL,
    [FROM_PLEDGEE_BO_ID] VARCHAR(20) NOT NULL,
    [FROM_PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [TO_BANK_CODE] INT NOT NULL,
    [TO_PLEDGEE_BO_ID] VARCHAR(20) NOT NULL,
    [TO_PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [AGREEMENT_NO] VARCHAR(30) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [QTY] INT NOT NULL,
    [CLSRATE] MONEY NOT NULL,
    [VALUE] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_interbank_transfer_request_070802017
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_interbank_transfer_request_070802017]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [FROM_BANK_CODE] INT NOT NULL,
    [FROM_PLEDGEE_BO_ID] VARCHAR(20) NOT NULL,
    [FROM_PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [TO_BANK_CODE] INT NOT NULL,
    [TO_PLEDGEE_BO_ID] VARCHAR(20) NOT NULL,
    [TO_PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [AGREEMENT_NO] VARCHAR(30) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [QTY] INT NOT NULL,
    [CLSRATE] MONEY NOT NULL,
    [VALUE] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_interbank_transfer_request_14012016
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_interbank_transfer_request_14012016]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [FROM_BANK_CODE] INT NOT NULL,
    [FROM_PLEDGEE_BO_ID] VARCHAR(20) NOT NULL,
    [FROM_PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [TO_BANK_CODE] INT NOT NULL,
    [TO_PLEDGEE_BO_ID] VARCHAR(20) NOT NULL,
    [TO_PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [AGREEMENT_NO] VARCHAR(30) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [QTY] INT NOT NULL,
    [CLSRATE] MONEY NOT NULL,
    [VALUE] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LAS_PLEDGE_REQUEST
-- --------------------------------------------------
CREATE TABLE [dbo].[LAS_PLEDGE_REQUEST]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [QTY] INT NOT NULL,
    [VALUE] MONEY NOT NULL,
    [REQUEST_TYPE] VARCHAR(20) NOT NULL,
    [APPROVED] INT NOT NULL,
    [APPROVED_BY] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_pledge_request_04Apr2018
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_pledge_request_04Apr2018]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [QTY] INT NOT NULL,
    [VALUE] MONEY NOT NULL,
    [REQUEST_TYPE] VARCHAR(20) NOT NULL,
    [APPROVED] INT NOT NULL,
    [APPROVED_BY] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_pledge_request_07082017
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_pledge_request_07082017]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [QTY] INT NOT NULL,
    [VALUE] MONEY NOT NULL,
    [REQUEST_TYPE] VARCHAR(20) NOT NULL,
    [APPROVED] INT NOT NULL,
    [APPROVED_BY] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_pledge_request_14012016
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_pledge_request_14012016]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [QTY] INT NOT NULL,
    [VALUE] MONEY NOT NULL,
    [REQUEST_TYPE] VARCHAR(20) NOT NULL,
    [APPROVED] INT NOT NULL,
    [APPROVED_BY] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_pledge_request_InteraBank
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_pledge_request_InteraBank]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [PLEDGOR_BO_ID] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [QTY] INT NOT NULL,
    [VALUE] MONEY NOT NULL,
    [REQUEST_TYPE] VARCHAR(20) NOT NULL,
    [APPROVED] INT NOT NULL,
    [APPROVED_BY] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LAS_PLEDGE_UNPLEDGE_BANK_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LAS_PLEDGE_UNPLEDGE_BANK_LOG]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [PRIORITY] INT NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [BANKNAME] VARCHAR(20) NOT NULL,
    [LAS_Line] MONEY NOT NULL,
    [Utilization] MONEY NOT NULL,
    [ALREADY_PLEDGE_VALUE] MONEY NOT NULL,
    [TDAY_CREDITORS_UNPLEDGE_VALUE] MONEY NOT NULL,
    [TDAY_INTERBANK_UNPLEDGE_VALUE] MONEY NOT NULL,
    [TDAY_DEBTORS_PLEDGE_VALUE] MONEY NOT NULL,
    [TDAY_INTERBANK_PLEDGE_VALUE] MONEY NOT NULL,
    [TDAY_CREDITORS_PLEDGE_VALUE] MONEY NOT NULL,
    [REQUIRED_EXCESS] MONEY NOT NULL,
    [BO_ID] VARCHAR(16) NOT NULL,
    [ROW_NUM] BIGINT NOT NULL,
    [UPDATE_BY] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_pledge_unpledge_bank_log_04Apr2018
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_pledge_unpledge_bank_log_04Apr2018]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [PRIORITY] INT NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [BANKNAME] VARCHAR(20) NOT NULL,
    [LAS_Line] MONEY NOT NULL,
    [Utilization] MONEY NOT NULL,
    [ALREADY_PLEDGE_VALUE] MONEY NOT NULL,
    [TDAY_CREDITORS_UNPLEDGE_VALUE] MONEY NOT NULL,
    [TDAY_INTERBANK_UNPLEDGE_VALUE] MONEY NOT NULL,
    [TDAY_DEBTORS_PLEDGE_VALUE] MONEY NOT NULL,
    [TDAY_INTERBANK_PLEDGE_VALUE] MONEY NOT NULL,
    [TDAY_CREDITORS_PLEDGE_VALUE] MONEY NOT NULL,
    [REQUIRED_EXCESS] MONEY NOT NULL,
    [BO_ID] VARCHAR(16) NOT NULL,
    [ROW_NUM] BIGINT NOT NULL,
    [UPDATE_BY] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LAS_PLEDGE_UNPLEDGE_GenFilePath
-- --------------------------------------------------
CREATE TABLE [dbo].[LAS_PLEDGE_UNPLEDGE_GenFilePath]
(
    [BankCode] INT NOT NULL,
    [PhysicalPath] VARCHAR(200) NULL,
    [VirtualPath] VARCHAR(200) NULL,
    [Desc] VARCHAR(200) NULL,
    [Action] VARCHAR(100) NOT NULL,
    [GenerateDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LAS_PLEDGE_UNPLEDGE_GenFilePath_log
-- --------------------------------------------------
CREATE TABLE [dbo].[LAS_PLEDGE_UNPLEDGE_GenFilePath_log]
(
    [BankCode] INT NOT NULL,
    [PhysicalPath] VARCHAR(200) NULL,
    [VirtualPath] VARCHAR(200) NULL,
    [Desc] VARCHAR(200) NULL,
    [Action] VARCHAR(100) NOT NULL,
    [GenerateDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_PledgeUnpledge_Bankwise
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_PledgeUnpledge_Bankwise]
(
    [Update_Datetime] DATETIME NOT NULL,
    [Bank_code] INT NULL,
    [Alreadypledgevalue] MONEY NULL,
    [Pledgevalue66] MONEY NULL,
    [Pledgevalue51] MONEY NULL,
    [Unpledgevalue66] MONEY NULL,
    [Unpledgevalue51] MONEY NULL,
    [Net] MONEY NULL,
    [Banklimit] MONEY NULL,
    [Bankrequirement] MONEY NULL,
    [Shortage] MONEY NULL,
    [Pledgevalue60] MONEY NULL,
    [Unpledgevalue60] MONEY NULL,
    [Pledgevalue28] MONEY NULL,
    [Unpledgevalue28] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_pledgeunpledge_bankwise_04Apr2018
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_pledgeunpledge_bankwise_04Apr2018]
(
    [Update_Datetime] DATETIME NOT NULL,
    [Bank_code] INT NULL,
    [Alreadypledgevalue] MONEY NULL,
    [Pledgevalue66] MONEY NULL,
    [Pledgevalue51] MONEY NULL,
    [Unpledgevalue66] MONEY NULL,
    [Unpledgevalue51] MONEY NULL,
    [Net] MONEY NULL,
    [Banklimit] MONEY NULL,
    [Bankrequirement] MONEY NULL,
    [Shortage] MONEY NULL,
    [Pledgevalue60] MONEY NULL,
    [Unpledgevalue60] MONEY NULL,
    [Pledgevalue28] MONEY NULL,
    [Unpledgevalue28] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_PledgeUnpledge_Bankwise_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_PledgeUnpledge_Bankwise_temp]
(
    [Update_Datetime] DATETIME NOT NULL,
    [Bank_code] INT NULL,
    [Alreadypledgevalue] MONEY NULL,
    [Pledgevalue66] MONEY NULL,
    [Pledgevalue51] MONEY NULL,
    [Unpledgevalue66] MONEY NULL,
    [Unpledgevalue51] MONEY NULL,
    [Net] MONEY NULL,
    [Banklimit] MONEY NULL,
    [Bankrequirement] MONEY NULL,
    [Shortage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LAS_UNPLEDGE_REQUEST
-- --------------------------------------------------
CREATE TABLE [dbo].[LAS_UNPLEDGE_REQUEST]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [ISIN] VARCHAR(30) NOT NULL,
    [PLEDGOR_BO_ID] VARCHAR(30) NOT NULL,
    [PLEDGEE_BO_ID] VARCHAR(30) NOT NULL,
    [AGREEMENT_NO] VARCHAR(30) NOT NULL,
    [PLEDGE_NO] VARCHAR(20) NOT NULL,
    [UNPLEDGE_QTY] INT NOT NULL,
    [UNPLEDGE_VALUE] MONEY NOT NULL,
    [REQUEST_TYPE] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_unpledge_request_07082017
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_unpledge_request_07082017]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [ISIN] VARCHAR(30) NOT NULL,
    [PLEDGOR_BO_ID] VARCHAR(30) NOT NULL,
    [PLEDGEE_BO_ID] VARCHAR(30) NOT NULL,
    [AGREEMENT_NO] VARCHAR(30) NOT NULL,
    [PLEDGE_NO] VARCHAR(20) NOT NULL,
    [UNPLEDGE_QTY] INT NOT NULL,
    [UNPLEDGE_VALUE] MONEY NOT NULL,
    [REQUEST_TYPE] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Las_unpledge_request_14012016
-- --------------------------------------------------
CREATE TABLE [dbo].[Las_unpledge_request_14012016]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [ISIN] VARCHAR(30) NOT NULL,
    [PLEDGOR_BO_ID] VARCHAR(30) NOT NULL,
    [PLEDGEE_BO_ID] VARCHAR(30) NOT NULL,
    [AGREEMENT_NO] VARCHAR(30) NOT NULL,
    [PLEDGE_NO] VARCHAR(20) NOT NULL,
    [UNPLEDGE_QTY] INT NOT NULL,
    [UNPLEDGE_VALUE] MONEY NOT NULL,
    [REQUEST_TYPE] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LAS_UNPLEDGE_REQUEST_INTERABANK
-- --------------------------------------------------
CREATE TABLE [dbo].[LAS_UNPLEDGE_REQUEST_INTERABANK]
(
    [UPDATE_DATETIME] DATETIME NOT NULL,
    [BANK_CODE] INT NOT NULL,
    [ISIN] VARCHAR(30) NOT NULL,
    [PLEDGOR_BO_ID] VARCHAR(30) NOT NULL,
    [PLEDGEE_BO_ID] VARCHAR(30) NOT NULL,
    [AGREEMENT_NO] VARCHAR(30) NOT NULL,
    [PLEDGE_NO] VARCHAR(20) NOT NULL,
    [UNPLEDGE_QTY] INT NOT NULL,
    [UNPLEDGE_VALUE] MONEY NOT NULL,
    [REQUEST_TYPE] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_AppHld_data
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_AppHld_data]
(
    [Rms_date] DATETIME NULL,
    [Party_code] VARCHAR(10) NULL,
    [Net] MONEY NULL,
    [Holding_approved] MONEY NULL,
    [Client_priority] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_AppHld_data_04Apr2018
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_AppHld_data_04Apr2018]
(
    [Rms_date] DATETIME NULL,
    [Party_code] VARCHAR(10) NULL,
    [Net] MONEY NULL,
    [Holding_approved] MONEY NULL,
    [Client_priority] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newchangehldg$
-- --------------------------------------------------
CREATE TABLE [dbo].[newchangehldg$]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] NVARCHAR(255) NULL,
    [ISIN] NVARCHAR(255) NULL,
    [SCRIP_CD] FLOAT NULL,
    [SCRIPNAME] NVARCHAR(255) NULL,
    [ACCNO] NVARCHAR(255) NULL,
    [PLEDGE_QTY] FLOAT NULL,
    [New client] NVARCHAR(255) NULL,
    [F9] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newchangehldg2$
-- --------------------------------------------------
CREATE TABLE [dbo].[newchangehldg2$]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] NVARCHAR(255) NULL,
    [LEDGER_BAL] FLOAT NULL,
    [CLIENT_PRIORITY] FLOAT NULL,
    [ISIN] NVARCHAR(255) NULL,
    [SCRIP_CD] FLOAT NULL,
    [SCRIPNAME] NVARCHAR(255) NULL,
    [ACCNO] NVARCHAR(255) NULL,
    [QTY] FLOAT NULL,
    [PLEDGE_QTY] FLOAT NULL,
    [AVG_CLOSING] FLOAT NULL,
    [Pledge value] FLOAT NULL,
    [New client] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pld
-- --------------------------------------------------
CREATE TABLE [dbo].[pld]
(
    [ACCNO] VARCHAR(50) NULL,
    [PLEDGE_QTY] INT NULL,
    [ISIN] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Pledge_clientwiseledger
-- --------------------------------------------------
CREATE TABLE [dbo].[Pledge_clientwiseledger]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_LEDGER] MONEY NULL,
    [NSECM_LEDGER] MONEY NULL,
    [NSEFO_LEDGER] MONEY NULL,
    [MCD_LEDGER] MONEY NULL,
    [MCX_LEDGER] MONEY NULL,
    [NBFC_LEDGER] MONEY NULL,
    [NCDEX_LEDGER] MONEY NULL,
    [NSX_LEDGER] MONEY NULL,
    [BSECM_IMARGIN] MONEY NULL,
    [NSECM_IMARGIN] MONEY NULL,
    [NSEFO_IMARGIN] MONEY NULL,
    [MCD_IMARGIN] MONEY NULL,
    [MCX_IMARGIN] MONEY NULL,
    [NBFC_IMARGIN] MONEY NULL,
    [NCDEX_IMARGIN] MONEY NULL,
    [NSX_IMARGIN] MONEY NULL,
    [BSECM_CASH_COLLETERAL] MONEY NULL,
    [NSECM_CASH_COLLETERAL] MONEY NULL,
    [NSEFO_CASH_COLLETERAL] MONEY NULL,
    [MCD_CASH_COLLETERAL] MONEY NULL,
    [MCX_CASH_COLLETERAL] MONEY NULL,
    [NBFC_CASH_COLLETERAL] MONEY NULL,
    [NCDEX_CASH_COLLETERAL] MONEY NULL,
    [NSX_CASH_COLLETERAL] MONEY NULL,
    [BSECM_NONCASH_COLLETERAL] MONEY NULL,
    [NSECM_NONCASH_COLLETERAL] MONEY NULL,
    [NSEFO_NONCASH_COLLETERAL] MONEY NULL,
    [MCD_NONCASH_COLLETERAL] MONEY NULL,
    [MCX_NONCASH_COLLETERAL] MONEY NULL,
    [NBFC_NONCASH_COLLETERAL] MONEY NULL,
    [NCDEX_NONCASH_COLLETERAL] MONEY NULL,
    [NSX_NONCASH_COLLETERAL] MONEY NULL,
    [BSECM_UNRECOSILED_CREDIT] MONEY NULL,
    [NSECM_UNRECOSILED_CREDIT] MONEY NULL,
    [NSEFO_UNRECOSILED_CREDIT] MONEY NULL,
    [MCD_UNRECOSILED_CREDIT] MONEY NULL,
    [MCX_UNRECOSILED_CREDIT] MONEY NULL,
    [NBFC_UNRECOSILED_CREDIT] MONEY NULL,
    [NCDEX_UNRECOSILED_CREDIT] MONEY NULL,
    [NSX_UNRECOSILED_CREDIT] MONEY NULL,
    [BSECM_VARMARGIN] MONEY NULL,
    [NSECM_VARMARGIN] MONEY NULL,
    [NSEFO_VARMARGIN] MONEY NULL,
    [MCD_VARMARGIN] MONEY NULL,
    [MCX_VARMARGIN] MONEY NULL,
    [NBFC_VARMARGIN] MONEY NULL,
    [NCDEX_VARMARGIN] MONEY NULL,
    [NSX_VARMARGIN] MONEY NULL,
    [BSECM_SPAN_ADD_MARGIN] MONEY NULL,
    [NSECM_SPAN_ADD_MARGIN] MONEY NULL,
    [NSEFO_SPAN_ADD_MARGIN] MONEY NULL,
    [MCD_SPAN_ADD_MARGIN] MONEY NULL,
    [MCX_SPAN_ADD_MARGIN] MONEY NULL,
    [NBFC_SPAN_ADD_MARGIN] MONEY NULL,
    [NCDEX_SPAN_ADD_MARGIN] MONEY NULL,
    [NSX_SPAN_ADD_MARGIN] MONEY NULL,
    [ProcessDate] DATETIME NOT NULL,
    [ProcessBy] VARCHAR(15) NULL,
    [MTF_ledger] MONEY NULL,
    [98Series] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Pledge_clientwiseledger_04Apr2018
-- --------------------------------------------------
CREATE TABLE [dbo].[Pledge_clientwiseledger_04Apr2018]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_LEDGER] MONEY NULL,
    [NSECM_LEDGER] MONEY NULL,
    [NSEFO_LEDGER] MONEY NULL,
    [MCD_LEDGER] MONEY NULL,
    [MCX_LEDGER] MONEY NULL,
    [NBFC_LEDGER] MONEY NULL,
    [NCDEX_LEDGER] MONEY NULL,
    [NSX_LEDGER] MONEY NULL,
    [BSECM_IMARGIN] MONEY NULL,
    [NSECM_IMARGIN] MONEY NULL,
    [NSEFO_IMARGIN] MONEY NULL,
    [MCD_IMARGIN] MONEY NULL,
    [MCX_IMARGIN] MONEY NULL,
    [NBFC_IMARGIN] MONEY NULL,
    [NCDEX_IMARGIN] MONEY NULL,
    [NSX_IMARGIN] MONEY NULL,
    [BSECM_CASH_COLLETERAL] MONEY NULL,
    [NSECM_CASH_COLLETERAL] MONEY NULL,
    [NSEFO_CASH_COLLETERAL] MONEY NULL,
    [MCD_CASH_COLLETERAL] MONEY NULL,
    [MCX_CASH_COLLETERAL] MONEY NULL,
    [NBFC_CASH_COLLETERAL] MONEY NULL,
    [NCDEX_CASH_COLLETERAL] MONEY NULL,
    [NSX_CASH_COLLETERAL] MONEY NULL,
    [BSECM_NONCASH_COLLETERAL] MONEY NULL,
    [NSECM_NONCASH_COLLETERAL] MONEY NULL,
    [NSEFO_NONCASH_COLLETERAL] MONEY NULL,
    [MCD_NONCASH_COLLETERAL] MONEY NULL,
    [MCX_NONCASH_COLLETERAL] MONEY NULL,
    [NBFC_NONCASH_COLLETERAL] MONEY NULL,
    [NCDEX_NONCASH_COLLETERAL] MONEY NULL,
    [NSX_NONCASH_COLLETERAL] MONEY NULL,
    [BSECM_UNRECOSILED_CREDIT] MONEY NULL,
    [NSECM_UNRECOSILED_CREDIT] MONEY NULL,
    [NSEFO_UNRECOSILED_CREDIT] MONEY NULL,
    [MCD_UNRECOSILED_CREDIT] MONEY NULL,
    [MCX_UNRECOSILED_CREDIT] MONEY NULL,
    [NBFC_UNRECOSILED_CREDIT] MONEY NULL,
    [NCDEX_UNRECOSILED_CREDIT] MONEY NULL,
    [NSX_UNRECOSILED_CREDIT] MONEY NULL,
    [BSECM_VARMARGIN] MONEY NULL,
    [NSECM_VARMARGIN] MONEY NULL,
    [NSEFO_VARMARGIN] MONEY NULL,
    [MCD_VARMARGIN] MONEY NULL,
    [MCX_VARMARGIN] MONEY NULL,
    [NBFC_VARMARGIN] MONEY NULL,
    [NCDEX_VARMARGIN] MONEY NULL,
    [NSX_VARMARGIN] MONEY NULL,
    [BSECM_SPAN_ADD_MARGIN] MONEY NULL,
    [NSECM_SPAN_ADD_MARGIN] MONEY NULL,
    [NSEFO_SPAN_ADD_MARGIN] MONEY NULL,
    [MCD_SPAN_ADD_MARGIN] MONEY NULL,
    [MCX_SPAN_ADD_MARGIN] MONEY NULL,
    [NBFC_SPAN_ADD_MARGIN] MONEY NULL,
    [NCDEX_SPAN_ADD_MARGIN] MONEY NULL,
    [NSX_SPAN_ADD_MARGIN] MONEY NULL,
    [ProcessDate] DATETIME NOT NULL,
    [ProcessBy] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Pledge_clientwiseledger_30Jan2019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[Pledge_clientwiseledger_30Jan2019_Renamed_By_DBA]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_LEDGER] MONEY NULL,
    [NSECM_LEDGER] MONEY NULL,
    [NSEFO_LEDGER] MONEY NULL,
    [MCD_LEDGER] MONEY NULL,
    [MCX_LEDGER] MONEY NULL,
    [NBFC_LEDGER] MONEY NULL,
    [NCDEX_LEDGER] MONEY NULL,
    [NSX_LEDGER] MONEY NULL,
    [BSECM_IMARGIN] MONEY NULL,
    [NSECM_IMARGIN] MONEY NULL,
    [NSEFO_IMARGIN] MONEY NULL,
    [MCD_IMARGIN] MONEY NULL,
    [MCX_IMARGIN] MONEY NULL,
    [NBFC_IMARGIN] MONEY NULL,
    [NCDEX_IMARGIN] MONEY NULL,
    [NSX_IMARGIN] MONEY NULL,
    [BSECM_CASH_COLLETERAL] MONEY NULL,
    [NSECM_CASH_COLLETERAL] MONEY NULL,
    [NSEFO_CASH_COLLETERAL] MONEY NULL,
    [MCD_CASH_COLLETERAL] MONEY NULL,
    [MCX_CASH_COLLETERAL] MONEY NULL,
    [NBFC_CASH_COLLETERAL] MONEY NULL,
    [NCDEX_CASH_COLLETERAL] MONEY NULL,
    [NSX_CASH_COLLETERAL] MONEY NULL,
    [BSECM_NONCASH_COLLETERAL] MONEY NULL,
    [NSECM_NONCASH_COLLETERAL] MONEY NULL,
    [NSEFO_NONCASH_COLLETERAL] MONEY NULL,
    [MCD_NONCASH_COLLETERAL] MONEY NULL,
    [MCX_NONCASH_COLLETERAL] MONEY NULL,
    [NBFC_NONCASH_COLLETERAL] MONEY NULL,
    [NCDEX_NONCASH_COLLETERAL] MONEY NULL,
    [NSX_NONCASH_COLLETERAL] MONEY NULL,
    [BSECM_UNRECOSILED_CREDIT] MONEY NULL,
    [NSECM_UNRECOSILED_CREDIT] MONEY NULL,
    [NSEFO_UNRECOSILED_CREDIT] MONEY NULL,
    [MCD_UNRECOSILED_CREDIT] MONEY NULL,
    [MCX_UNRECOSILED_CREDIT] MONEY NULL,
    [NBFC_UNRECOSILED_CREDIT] MONEY NULL,
    [NCDEX_UNRECOSILED_CREDIT] MONEY NULL,
    [NSX_UNRECOSILED_CREDIT] MONEY NULL,
    [BSECM_VARMARGIN] MONEY NULL,
    [NSECM_VARMARGIN] MONEY NULL,
    [NSEFO_VARMARGIN] MONEY NULL,
    [MCD_VARMARGIN] MONEY NULL,
    [MCX_VARMARGIN] MONEY NULL,
    [NBFC_VARMARGIN] MONEY NULL,
    [NCDEX_VARMARGIN] MONEY NULL,
    [NSX_VARMARGIN] MONEY NULL,
    [BSECM_SPAN_ADD_MARGIN] MONEY NULL,
    [NSECM_SPAN_ADD_MARGIN] MONEY NULL,
    [NSEFO_SPAN_ADD_MARGIN] MONEY NULL,
    [MCD_SPAN_ADD_MARGIN] MONEY NULL,
    [MCX_SPAN_ADD_MARGIN] MONEY NULL,
    [NBFC_SPAN_ADD_MARGIN] MONEY NULL,
    [NCDEX_SPAN_ADD_MARGIN] MONEY NULL,
    [NSX_SPAN_ADD_MARGIN] MONEY NULL,
    [ProcessDate] DATETIME NOT NULL,
    [ProcessBy] VARCHAR(15) NULL,
    [MTF_ledger] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PLEDGE_TO_RELEASE_HIST
-- --------------------------------------------------
CREATE TABLE [dbo].[PLEDGE_TO_RELEASE_HIST]
(
    [HoldingDateTime] DATETIME NULL,
    [ClientId] VARCHAR(50) NULL,
    [BankId] VARCHAR(50) NULL,
    [Isin] VARCHAR(50) NULL,
    [sc_isinname] VARCHAR(50) NULL,
    [PledgeOrder] VARCHAR(50) NULL,
    [PledgeDate] VARCHAR(50) NULL,
    [PledgeQty] MONEY NULL,
    [UnPledgeOrder] VARCHAR(50) NULL,
    [UnPledgeQty] MONEY NULL,
    [Balance] MONEY NULL,
    [Pledge2ReleaseMarked] MONEY NULL,
    [Pledge2Release] MONEY NULL,
    [Remarks] VARCHAR(500) NULL,
    [MkrId] VARCHAR(50) NULL,
    [MkrTime] VARCHAR(50) NULL,
    [MaxCounter] NVARCHAR(1000) NULL,
    [Log_Datetime] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PLEDGE_WCL_CLIENT_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[PLEDGE_WCL_CLIENT_LOG]
(
    [PARTY_CODE] VARCHAR(50) NULL,
    [WCL_DATE] DATETIME NOT NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.PLEDGE_WCL_CLIENT_LOG_04Apr2018
-- --------------------------------------------------
CREATE TABLE [dbo].[PLEDGE_WCL_CLIENT_LOG_04Apr2018]
(
    [PARTY_CODE] VARCHAR(50) NULL,
    [WCL_DATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PledgeAnil_24052017$
-- --------------------------------------------------
CREATE TABLE [dbo].[PledgeAnil_24052017$]
(
    [Client Code] NVARCHAR(255) NULL,
    [Client Name] NVARCHAR(255) NULL,
    [Date Of Exposure] DATETIME NULL,
    [Net Ledger ] FLOAT NULL,
    [Pledge] FLOAT NULL,
    [Unpledge] FLOAT NULL,
    [Total Margins] FLOAT NULL,
    [FO collateral Actual ] FLOAT NULL,
    [DP Holding with POA ] FLOAT NULL,
    [Total Holdings   (Pool + Coll+DP)] FLOAT NULL,
    [Net ] FLOAT NULL,
    [POA ] NVARCHAR(255) NULL,
    [Var Days ] NVARCHAR(255) NULL,
    [Ageing days ] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PledgeClientHold_07112016$
-- --------------------------------------------------
CREATE TABLE [dbo].[PledgeClientHold_07112016$]
(
    [party_code] NVARCHAR(255) NULL,
    [isin] NVARCHAR(255) NULL,
    [accno] NVARCHAR(255) NULL,
    [clsrate] FLOAT NULL,
    [QTY] FLOAT NULL,
    [Delete] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PledgeDate_07112016
-- --------------------------------------------------
CREATE TABLE [dbo].[PledgeDate_07112016]
(
    [Account] NVARCHAR(255) NULL,
    [ISIN Code] NVARCHAR(255) NULL,
    [ISIN NAME] NVARCHAR(255) NULL,
    [Bank Id] NVARCHAR(255) NULL,
    [Pledge Holding] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PledgeDate_071120161
-- --------------------------------------------------
CREATE TABLE [dbo].[PledgeDate_071120161]
(
    [Account] NVARCHAR(255) NULL,
    [ISIN Code] NVARCHAR(255) NULL,
    [ISIN NAME] NVARCHAR(255) NULL,
    [Bank Id] NVARCHAR(255) NULL,
    [Pledge Holding] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PledgeFinal_07112016$
-- --------------------------------------------------
CREATE TABLE [dbo].[PledgeFinal_07112016$]
(
    [party_code] NVARCHAR(255) NULL,
    [Ledger] FLOAT NULL,
    [FOMargin] FLOAT NULL,
    [NSX] FLOAT NULL,
    [BSE] FLOAT NULL,
    [NSE] FLOAT NULL,
    [NET] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PledgeHold_07112016$
-- --------------------------------------------------
CREATE TABLE [dbo].[PledgeHold_07112016$]
(
    [ ISIN] NVARCHAR(255) NULL,
    [ACCNO] NVARCHAR(255) NULL,
    [ DP PLD QTY] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PledgeProcessWCLLog
-- --------------------------------------------------
CREATE TABLE [dbo].[PledgeProcessWCLLog]
(
    [Starttime] DATETIME NULL,
    [Endtime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Prepaid
-- --------------------------------------------------
CREATE TABLE [dbo].[Prepaid]
(
    [Party_code] NVARCHAR(50) NULL,
    [Active] NVARCHAR(50) NULL,
    [Expiry] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RCS_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[RCS_TEMP]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rms_dtclfi_07112016
-- --------------------------------------------------
CREATE TABLE [dbo].[Rms_dtclfi_07112016]
(
    [RMS_Date] DATETIME NULL,
    [Co_code] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Party_name] VARCHAR(100) NULL,
    [Ledger] MONEY NULL,
    [Deposit] MONEY NULL,
    [IMargin] MONEY NULL,
    [Cash_Colleteral] MONEY NULL,
    [NonCash_Colleteral] MONEY NULL,
    [Holding_total] MONEY NULL,
    [Holding_Approved] MONEY NULL,
    [Holding_NonApproved] MONEY NULL,
    [Other_Credit] MONEY NULL,
    [Other_Deposit] MONEY NULL,
    [MTM_Loss_Act] MONEY NULL,
    [MTM_Loss_Proj] MONEY NULL,
    [MTM_Profit_Act] MONEY NULL,
    [NoDel_Loss] MONEY NULL,
    [NoDel_Profit] MONEY NULL,
    [Unrecosiled_Credit] MONEY NULL,
    [MTM_Profit_Proj] MONEY NULL,
    [IMargin_Shortage_value] MONEY NULL,
    [IMargin_Shortage_Percent] MONEY NULL,
    [LastBillDate] DATETIME NULL,
    [LastDrCrDays] INT NULL,
    [Exposure] MONEY NULL,
    [HoldingWithHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rms_dtclfi_summ_07112016
-- --------------------------------------------------
CREATE TABLE [dbo].[Rms_dtclfi_summ_07112016]
(
    [RMS_date] DATETIME NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Party_name] VARCHAR(100) NULL,
    [Ledger] MONEY NULL,
    [Deposit] MONEY NULL,
    [IMargin] MONEY NULL,
    [Cash_Colleteral] MONEY NULL,
    [NonCash_Colleteral] MONEY NULL,
    [Holding_total] MONEY NULL,
    [Holding_Approved] MONEY NULL,
    [Holding_NonApproved] MONEY NULL,
    [Other_Credit] MONEY NULL,
    [Other_Deposit] MONEY NULL,
    [MTM_Loss_Act] MONEY NULL,
    [MTM_Loss_Proj] MONEY NULL,
    [MTM_Profit_Act] MONEY NULL,
    [NoDel_Loss] MONEY NULL,
    [NoDel_Profit] MONEY NULL,
    [Unrecosiled_Credit] MONEY NULL,
    [MTM_Profit_Proj] MONEY NULL,
    [IMargin_Shortage_value] MONEY NULL,
    [IMargin_Shortage_Percent] INT NOT NULL,
    [LastBillDate] DATETIME NULL,
    [LastDrCrDays] INT NULL,
    [Net] MONEY NULL,
    [ProjRisk] MONEY NULL,
    [PureRisk] MONEY NULL,
    [Exposure] MONEY NULL,
    [DrNoOfDays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rms_holding_07112016
-- --------------------------------------------------
CREATE TABLE [dbo].[Rms_holding_07112016]
(
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(10) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(50) NULL,
    [partyname] VARCHAR(100) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [source] VARCHAR(2) NULL,
    [upd_date] DATETIME NULL,
    [AdjQty] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_BankMaster_CltCode
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_BankMaster_CltCode]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [BankCode] INT NULL,
    [CltCode] VARCHAR(100) NULL,
    [BankName] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_las_account_master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_las_account_master]
(
    [Acc_Code] INT NOT NULL,
    [AccNo] VARCHAR(20) NULL,
    [Priority] INT NULL,
    [Active_Inactive] BIT NULL,
    [Update_Datetime] DATETIME NULL,
    [Update_By] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_las_bank_master_Pledge
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_las_bank_master_Pledge]
(
    [Bank_Code] INT NULL,
    [BankName] VARCHAR(20) NOT NULL,
    [LAS_Line] MONEY NOT NULL,
    [Funding_Perc] MONEY NOT NULL,
    [BO_ID] VARCHAR(16) NOT NULL,
    [Active_InActive] BIT NOT NULL,
    [Priority] INT NOT NULL,
    [Utilization] MONEY NOT NULL DEFAULT ((0)),
    [ODUtilization] MONEY NULL DEFAULT ((0)),
    [UPDATE_DATE] DATETIME NOT NULL,
    [UPDATE_BY] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_las_bank_master_Pledge_
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_las_bank_master_Pledge_]
(
    [Bank_Code] INT IDENTITY(1,1) NOT NULL,
    [BankName] VARCHAR(20) NOT NULL,
    [LAS_Line] MONEY NOT NULL,
    [Funding_Perc] MONEY NOT NULL,
    [BO_ID] VARCHAR(16) NOT NULL,
    [Active_InActive] BIT NOT NULL,
    [Priority] INT NOT NULL,
    [Utilization] MONEY NOT NULL,
    [ODUtilization] MONEY NULL,
    [UPDATE_DATE] DATETIME NOT NULL,
    [UPDATE_BY] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_las_pledge_unpladge_data
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_las_pledge_unpladge_data]
(
    [ROW_NM] VARCHAR(100) NULL,
    [ISIN] VARCHAR(100) NULL,
    [SCRIPCODE] VARCHAR(100) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [QTY] VARCHAR(100) NULL,
    [PLEDGE_NO] VARCHAR(100) NULL,
    [REMARK] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_las_requirement_output_ctr
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_las_requirement_output_ctr]
(
    [COUNTER] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PARTY_PLEDGE_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PARTY_PLEDGE_DATA]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_04072017
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_04072017]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_04Apr2018
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_04Apr2018]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_07082017
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_07082017]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_07082017_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_07082017_new]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_30Jan2019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_30Jan2019_Renamed_By_DBA]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_bck14012016
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_bck14012016]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_bkp_12Aug2017
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_bkp_12Aug2017]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_bkp12aug2017
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_bkp12aug2017]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_party_pledge_data_correction
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_party_pledge_data_correction]
(
    [Rms_date] DATETIME NULL,
    [Party_code] VARCHAR(20) NULL,
    [Ledger_bal] MONEY NULL,
    [Client_priority] SMALLINT NULL,
    [Isin] VARCHAR(20) NULL,
    [Scrip_cd] VARCHAR(50) NULL,
    [Scripname] VARCHAR(100) NULL,
    [Accno] VARCHAR(50) NULL,
    [Qty] INT NULL,
    [Pledge_qty] INT NULL,
    [Free_qty] INT NULL,
    [Hold_value] MONEY NULL,
    [Avg_closing] MONEY NULL,
    [Pledgeable_qty] INT NULL,
    [Pledgeable_value] MONEY NULL,
    [Prevdaypledgeqty] INT NULL,
    [Release_qty] INT NULL,
    [Scrip_priority] SMALLINT NULL,
    [Processdate] DATETIME NOT NULL,
    [username] VARCHAR(6) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_party_pledge_data_correction1
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_party_pledge_data_correction1]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_party_pledge_data_correction1_2
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_party_pledge_data_correction1_2]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_party_pledge_data_correction2
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_party_pledge_data_correction2]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PARTY_PLEDGE_DATA_FINAL_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PARTY_PLEDGE_DATA_FINAL_TEST]
(
    [Rms_date] DATETIME NULL,
    [Party_code] VARCHAR(20) NULL,
    [Ledger_bal] MONEY NULL,
    [Client_priority] SMALLINT NULL,
    [Isin] VARCHAR(20) NULL,
    [Scrip_cd] VARCHAR(50) NULL,
    [Scripname] VARCHAR(100) NULL,
    [Accno] VARCHAR(50) NULL,
    [Qty] INT NULL,
    [Pledge_qty] INT NULL,
    [Free_qty] INT NULL,
    [Hold_value] MONEY NULL,
    [Avg_closing] MONEY NULL,
    [Pledgeable_qty] INT NULL,
    [Pledgeable_value] MONEY NULL,
    [Prevdaypledgeqty] INT NULL,
    [Release_qty] INT NULL,
    [Scrip_priority] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PARTY_PLEDGE_DATA_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PARTY_PLEDGE_DATA_LOG]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_log_04072017
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_log_04072017]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PARTY_PLEDGE_DATA_LOG_07112016
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PARTY_PLEDGE_DATA_LOG_07112016]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PARTY_PLEDGE_DATA_LOG_07112016FIXED
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PARTY_PLEDGE_DATA_LOG_07112016FIXED]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PARTY_PLEDGE_DATA_LOG_08112016
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PARTY_PLEDGE_DATA_LOG_08112016]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PARTY_PLEDGE_DATA_LOG_08112016REMOVE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PARTY_PLEDGE_DATA_LOG_08112016REMOVE]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PARTY_PLEDGE_DATA_LOG_08Apr2019_0841
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PARTY_PLEDGE_DATA_LOG_08Apr2019_0841]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_log_bkp12Aug2017
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_log_bkp12Aug2017]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_test
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_test]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledge_data_test1
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledge_data_test1]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Party_Pledged_BankWise_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Party_Pledged_BankWise_Data]
(
    [Rms_Date] DATETIME NULL,
    [Ledger_Bal] MONEY NULL,
    [Party_Code] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Scrip_cd] VARCHAR(50) NULL,
    [ScripName] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [Pledge_QTY] INT NULL,
    [Avg_Closing] MONEY NULL,
    [Bank_code] INT NULL,
    [Pledge_Value] MONEY NULL,
    [OD_Utilization] MONEY NULL,
    [Processdate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledged_bankwise_data_04Apr2018
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledged_bankwise_data_04Apr2018]
(
    [Rms_Date] DATETIME NULL,
    [Ledger_Bal] MONEY NULL,
    [Party_Code] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Scrip_cd] VARCHAR(50) NULL,
    [ScripName] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [Pledge_QTY] INT NULL,
    [Avg_Closing] MONEY NULL,
    [Bank_code] INT NULL,
    [Pledge_Value] MONEY NULL,
    [OD_Utilization] MONEY NULL,
    [Processdate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Party_Pledged_BankWise_Data_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Party_Pledged_BankWise_Data_Log]
(
    [Rms_Date] DATETIME NULL,
    [Ledger_Bal] INT NOT NULL,
    [Party_Code] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Scrip_cd] VARCHAR(50) NULL,
    [ScripName] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [Pledge_QTY] INT NULL,
    [Avg_Closing] MONEY NULL,
    [Bank_code] INT NULL,
    [Pledge_Value] MONEY NULL,
    [OD_Utilization] MONEY NULL,
    [Processdate] DATETIME NOT NULL,
    [LogDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledged_bankwise_data_log_TEst
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledged_bankwise_data_log_TEst]
(
    [Rms_Date] DATETIME NULL,
    [Ledger_Bal] INT NOT NULL,
    [Party_Code] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Scrip_cd] VARCHAR(50) NULL,
    [ScripName] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [Pledge_QTY] INT NULL,
    [Avg_Closing] MONEY NULL,
    [Bank_code] INT NULL,
    [Pledge_Value] MONEY NULL,
    [OD_Utilization] MONEY NULL,
    [Processdate] DATETIME NOT NULL,
    [LogDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_party_pledged_bankwise_data_RESTORE
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_party_pledged_bankwise_data_RESTORE]
(
    [Rms_Date] DATETIME NULL,
    [Ledger_Bal] INT NOT NULL,
    [Party_Code] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Scrip_cd] VARCHAR(50) NULL,
    [ScripName] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [Pledge_QTY] INT NULL,
    [Avg_Closing] MONEY NULL,
    [Bank_code] INT NULL,
    [Pledge_Value] MONEY NULL,
    [OD_Utilization] MONEY NULL,
    [Processdate] DATETIME NOT NULL,
    [LogDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PLEDGE_DATA_BIPIC_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PLEDGE_DATA_BIPIC_TMP]
(
    [DATE] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(50) NULL,
    [Net debit] MONEY NULL,
    [Adjustable debit] MONEY NULL,
    [Isin] VARCHAR(20) NULL,
    [Scripname] VARCHAR(100) NULL,
    [Accountno] VARCHAR(20) NULL,
    [Total holding qty] INT NULL,
    [Total holding hold value] MONEY NULL,
    [Total pledgeble qty] INT NULL,
    [Total pledgeble hold value] MONEY NULL,
    [Closing price] MONEY NULL,
    [Prevday pledege qty] INT NULL,
    [Release qty] INT NULL,
    [Actual pledge] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PLEDGE_DATA_BIPIC_TMP_1
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PLEDGE_DATA_BIPIC_TMP_1]
(
    [DATE] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(50) NULL,
    [Net debit] MONEY NULL,
    [Adjustable debit] MONEY NULL,
    [Isin] VARCHAR(20) NULL,
    [Scripname] VARCHAR(100) NULL,
    [Accountno] VARCHAR(20) NULL,
    [Total holding qty] INT NULL,
    [Total holding hold value] MONEY NULL,
    [Total pledgeble qty] INT NULL,
    [Total pledgeble hold value] MONEY NULL,
    [Closing price] MONEY NULL,
    [Prevday pledege qty] INT NULL,
    [Release qty] INT NULL,
    [Actual pledge] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PLEDGE_DATA_BIPIC_TMP_2
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PLEDGE_DATA_BIPIC_TMP_2]
(
    [DATE] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(50) NULL,
    [Net debit] MONEY NULL,
    [Adjustable debit] MONEY NULL,
    [Isin] VARCHAR(20) NULL,
    [Scripname] VARCHAR(100) NULL,
    [Accountno] VARCHAR(20) NULL,
    [Total holding qty] INT NULL,
    [Total holding hold value] MONEY NULL,
    [Total pledgeble qty] INT NULL,
    [Total pledgeble hold value] MONEY NULL,
    [Closing price] MONEY NULL,
    [Prevday pledege qty] INT NULL,
    [Release qty] INT NULL,
    [Actual pledge] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PLEDGE_DATA_BIPIC_TMP_3
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PLEDGE_DATA_BIPIC_TMP_3]
(
    [DATE] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(50) NULL,
    [Net debit] MONEY NULL,
    [Adjustable debit] MONEY NULL,
    [Isin] VARCHAR(20) NULL,
    [Scripname] VARCHAR(100) NULL,
    [Accountno] VARCHAR(20) NULL,
    [Total holding qty] INT NULL,
    [Total holding hold value] MONEY NULL,
    [Total pledgeble qty] INT NULL,
    [Total pledgeble hold value] MONEY NULL,
    [Closing price] MONEY NULL,
    [Prevday pledege qty] INT NULL,
    [Release qty] INT NULL,
    [Actual pledge] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PLEDGE_DATA_BIPIC_TMP_4
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PLEDGE_DATA_BIPIC_TMP_4]
(
    [DATE] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(50) NULL,
    [Net debit] MONEY NULL,
    [Adjustable debit] MONEY NULL,
    [Isin] VARCHAR(20) NULL,
    [Scripname] VARCHAR(100) NULL,
    [Accountno] VARCHAR(20) NULL,
    [Total holding qty] INT NULL,
    [Total holding hold value] MONEY NULL,
    [Total pledgeble qty] INT NULL,
    [Total pledgeble hold value] MONEY NULL,
    [Closing price] MONEY NULL,
    [Prevday pledege qty] INT NULL,
    [Release qty] INT NULL,
    [Actual pledge] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_Pledge_data_tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_Pledge_data_tmp]
(
    [RMS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LEDGER_BAL] MONEY NULL,
    [CLIENT_PRIORITY] SMALLINT NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [ACCNO] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [PLEDGE_QTY] INT NULL,
    [FREE_QTY] INT NULL,
    [HOLD_VALUE] MONEY NULL,
    [AVG_CLOSING] MONEY NULL,
    [PLEDGEABLE_QTY] INT NULL,
    [PLEDGEABLE_VALUE] MONEY NULL,
    [PREVDAY_PLEDEGE_QTY] INT NULL,
    [RELEASE_QTY] INT NULL,
    [SCRIP_PRIORITY] SMALLINT NULL,
    [ProcessDate] DATETIME NOT NULL,
    [USER_BY] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_PledgeUnpledgeBorrowing
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_PledgeUnpledgeBorrowing]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PLEDGE_DATE] DATE NULL,
    [BANK_CODE] INT NULL,
    [BANK_NAME] VARCHAR(300) NULL,
    [AMOUNT] DECIMAL(18, 2) NULL,
    [TOTAL_PLEDGE] DECIMAL(18, 2) NULL,
    [PERCENTAGE] DECIMAL(18, 2) NULL,
    [ENTERED_BY] VARCHAR(30) NULL,
    [ENTERED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_PledgeUnpledgeBorrowing_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_PledgeUnpledgeBorrowing_LOG]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PLEDGE_DATE] DATE NULL,
    [BANK_CODE] INT NULL,
    [BANK_NAME] VARCHAR(300) NULL,
    [AMOUNT] DECIMAL(18, 2) NULL,
    [TOTAL_PLEDGE] DECIMAL(18, 2) NULL,
    [PERCENTAGE] DECIMAL(18, 2) NULL,
    [ENTERED_BY] VARCHAR(30) NULL,
    [ENTERED_ON] DATETIME NULL,
    [LOG_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.ClientWiseDatewise_PledgeDetails
-- --------------------------------------------------
CREATE View ClientWiseDatewise_PledgeDetails                
/*with schemabinding*/            
AS                
select  ROW_NUMBER() OVER(ORDER BY A.processdate ASC) SRNO ,A.processdate,party_code,A.isin,        
A.qty,A.pledge_qty,avg_closing,pledge_value/2 as pledge_value,              
A.Bank_code,B.Bankname,A.ledger_bal,isnull(C.PERCENTAGE,0 )as PERCENTAGE,              
Borrowing=   convert(decimal(18,3), ((pledge_value/2) * isnull(C.PERCENTAGE,0 ))/100) from                 
 (  
 select  processdate,sum(Pledge_QTY)as Pledge_QTY,party_code,isin,sum(QTY)as QTY,avg_closing,sum(Pledge_Value)as Pledge_Value,Bank_code,ledger_bal   
 from dbo.Tbl_party_pledged_bankwise_data  with(nolock)  
 -- where convert(date, Processdate)='Sep 19 2017' 
 group by processdate,party_code,isin,avg_closing,Bank_code,ledger_bal  
 )A                 
inner Join dbo.Tbl_las_bank_master_Pledge  B  with(nolock) On A.Bank_code = B.Bank_code               
Left Join dbo.tbl_PledgeUnpledgeBorrowing C  with(nolock) on B.Bank_Code = C.Bank_Code

GO

-- --------------------------------------------------
-- VIEW dbo.MIS_AppHld_View
-- --------------------------------------------------
CREATE View MIS_AppHld_View  
as  
/*   
requirement for overview of shares - MIS : by Rahul Shah Dt: 25/08/2015   
Client ledger calculated on effective date basis.  
*/  

select rms_Date,party_code,Net from MIS_AppHLD_data with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.vw_DerivativeMargin
-- --------------------------------------------------
CREATE view vw_DerivativeMargin          
as          
Select margindate,Party_code,initialmargin,AddMargin,Co_code from          
(          
 Select margindate,Party_code,initialmargin,AddMargin,Co_code='NSEFO'           
 from ANGELFO.NSEFO.dbo.tbl_ClientMargin a (nolock)          
 Where Convert(varchar,margindate,106)= (Select Convert(varchar,Max(margindate),106)          
 from ANGELFO.NSEFO.dbo.tbl_ClientMargin a (nolock))          
          
 union all          
          
 Select margindate,Party_code,initialmargin,AddMargin,Co_code='MCD'        
 from ANGELCOMMODITY.MCDXCDS.dbo.tbl_ClientMargin a (nolock)          
 Where Convert(varchar,margindate,106)= (Select Convert(varchar,Max(margindate),106)          
 from ANGELCOMMODITY.MCDXCDS.dbo.tbl_ClientMargin a (nolock))          
 union all          
          
 Select margindate,Party_code,initialmargin,AddMargin,Co_code='NSX'        
 from ANGELFO.NSECURFO.dbo.tbl_ClientMargin a (nolock)          
 Where Convert(varchar,margindate,106)= (Select Convert(varchar,Max(margindate),106)          
 from ANGELFO.NSECURFO.dbo.tbl_ClientMargin a (nolock))          
) a

GO

-- --------------------------------------------------
-- VIEW dbo.vw_DerivativeMargin_07112016
-- --------------------------------------------------
CREATE view vw_DerivativeMargin_07112016            
as            
Select margindate,Party_code,initialmargin,AddMargin,Co_code from            
(            
 Select margindate,Party_code,initialmargin,AddMargin,Co_code='NSEFO'             
 from ANGELFO.NSEFO.dbo.tbl_ClientMargin a (nolock)            
 Where Convert(varchar,margindate,106)= ('04 Nov 2016')            
            
 union all            
            
 Select margindate,Party_code,initialmargin,AddMargin,Co_code='MCD'          
 from ANGELCOMMODITY.MCDXCDS.dbo.tbl_ClientMargin a (nolock)            
 Where Convert(varchar,margindate,106)= ('04 Nov 2016')            
 union all            
            
 Select margindate,Party_code,initialmargin,AddMargin,Co_code='NSX'          
 from ANGELFO.NSECURFO.dbo.tbl_ClientMargin a (nolock)            
 Where Convert(varchar,margindate,106)= ('04 Nov 2016')            
) a

GO

-- --------------------------------------------------
-- VIEW dbo.VW_EQUITY_CLS_RATE
-- --------------------------------------------------
CREATE View VW_EQUITY_CLS_RATE          
As          
 Select Clsrate=A.RATE,          
        B.ISIN,          
        Accno='1203320000000066',          
        Scrip_cd=B.BSECODE,          
        Scripname=Scripname,    
        Segment='BSECM'          
 From   GENERAL.dbo.Cp_bsecm A (NOLOCK)          
        Inner Join GENERAL.dbo.Scrip_master B(NOLOCK)          
         On A.SCODE = B.BSECODE          
 Union All          
 Select Clsrate=A.CLS,          
        B.ISIN,          
        Accno='1203320000000051',          
        Scrip_cd=isnull(bsecode,B.NSESYMBOL),          
        Scripname=Scripname,    
        Segment='NSECM'     
 From   GENERAL.dbo.Cp_nsecm A (NOLOCK)          
        Left Join GENERAL.dbo.Scrip_master B(NOLOCK)          
         On A.SCRIP = B.NSESYMBOL          
            And Case          
                 When A.SERIES In ('EQ', 'BE') Then 'EQ'          
                 Else A.SERIES          
                End = Case          
                       When B.NSESERIES In ('EQ', 'BE') Then 'EQ'          
                       Else B.NSESERIES          
                      End          
 Where  Isin Is Not Null   
   
 /*Added on 4th Aug to handle new account*/  
 union all  
 select clsrate=max(clsrate),  
 isin,accno,scrip_cd=max(scrip_Cd),scripname=max(scripname),segment=max(segment) from VW_EQUITY_CLS_RATE_MTF  group by isin,accno
 
 /*Added on 26th Sep 2017 to handle new account 28*/  
 union all  
 select clsrate=max(clsrate),  
 isin,accno,scrip_cd=max(scrip_Cd),scripname=max(scripname),segment=max(segment) from VW_EQUITY_CLS_RATE_28  group by isin,accno

GO

-- --------------------------------------------------
-- VIEW dbo.VW_EQUITY_CLS_RATE_07112016
-- --------------------------------------------------
CREATE View VW_EQUITY_CLS_RATE_07112016        
As        
 Select Clsrate=A.RATE,        
        B.ISIN,        
        Accno='1203320000000066',        
        Scrip_cd=B.BSECODE,        
        Scripname=Scripname,  
        Segment='BSECM'        
 From   history.dbo.CP_BSECM_hist A (NOLOCK)        
        Inner Join GENERAL.dbo.Scrip_master B(NOLOCK)        
         On A.SCODE = B.BSECODE   where  CLS_Date between  
              '2016-11-07' and '2016-11-07  23:59:59'     
 Union All        
 Select Clsrate=A.CLS,        
        B.ISIN,        
        Accno='1203320000000051',        
        Scrip_cd=isnull(bsecode,B.NSESYMBOL),        
        Scripname=Scripname,  
        Segment='NSECM'   
 From   history.dbo.Cp_nsecm_hist A (NOLOCK)        
        Left Join GENERAL.dbo.Scrip_master B(NOLOCK)        
         On A.SCRIP = B.NSESYMBOL        
            And Case        
                 When A.SERIES In ('EQ', 'BE') Then 'EQ'        
                 Else A.SERIES        
                End = Case        
                       When B.NSESERIES In ('EQ', 'BE') Then 'EQ'        
                       Else B.NSESERIES        
                      End        
 Where  Isin Is Not Null and  CLS_Date between  
              '2016-11-07' and '2016-11-07  23:59:59'

GO

-- --------------------------------------------------
-- VIEW dbo.VW_EQUITY_CLS_RATE_28
-- --------------------------------------------------
Create View VW_EQUITY_CLS_RATE_28  
 as  
  Select Clsrate=A.RATE,          
        B.ISIN,          
        Accno='1203320000000028',          
        Scrip_cd=B.BSECODE,          
        Scripname=Scripname,    
        Segment='BSECM'          
 From   GENERAL.dbo.Cp_bsecm A (NOLOCK)          
        Inner Join GENERAL.dbo.Scrip_master B(NOLOCK)          
         On A.SCODE = B.BSECODE          
 Union All          
 Select Clsrate=A.CLS,          
        B.ISIN,          
        Accno='1203320000000028',          
        Scrip_cd=isnull(bsecode,B.NSESYMBOL),          
        Scripname=Scripname,    
        Segment='NSECM'     
 From   GENERAL.dbo.Cp_nsecm A (NOLOCK)          
        Left Join GENERAL.dbo.Scrip_master B(NOLOCK)          
         On A.SCRIP = B.NSESYMBOL          
            And Case          
                 When A.SERIES In ('EQ', 'BE') Then 'EQ'          
                 Else A.SERIES          
                End = Case          
                       When B.NSESERIES In ('EQ', 'BE') Then 'EQ'          
                       Else B.NSESERIES          
                      End          
 Where  Isin Is Not Null

GO

-- --------------------------------------------------
-- VIEW dbo.VW_EQUITY_CLS_RATE_MTF
-- --------------------------------------------------
Create View VW_EQUITY_CLS_RATE_MTF
 as
  Select Clsrate=A.RATE,        
        B.ISIN,        
        Accno='1203320009603460',        
        Scrip_cd=B.BSECODE,        
        Scripname=Scripname,  
        Segment='BSECM'        
 From   GENERAL.dbo.Cp_bsecm A (NOLOCK)        
        Inner Join GENERAL.dbo.Scrip_master B(NOLOCK)        
         On A.SCODE = B.BSECODE        
 Union All        
 Select Clsrate=A.CLS,        
        B.ISIN,        
        Accno='1203320009603460',        
        Scrip_cd=isnull(bsecode,B.NSESYMBOL),        
        Scripname=Scripname,  
        Segment='NSECM'   
 From   GENERAL.dbo.Cp_nsecm A (NOLOCK)        
        Left Join GENERAL.dbo.Scrip_master B(NOLOCK)        
         On A.SCRIP = B.NSESYMBOL        
            And Case        
                 When A.SERIES In ('EQ', 'BE') Then 'EQ'        
                 Else A.SERIES        
                End = Case        
                       When B.NSESERIES In ('EQ', 'BE') Then 'EQ'        
                       Else B.NSESERIES        
                      End        
 Where  Isin Is Not Null

GO

-- --------------------------------------------------
-- VIEW dbo.VW_Equity_Var_Margin
-- --------------------------------------------------

CREATE view [dbo].[VW_Equity_Var_Margin]        
as        
Select party_code=ltrim(rtrim(party_code)),margin_date,VarMargin,Co_code        
from         
(        
 select party_code,margin_date,VarMargin=sum(varamt+elm),Co_code='BSECM'         
 from AngelBSECM.bsedb_ab.dbo.tbl_mg02 with (nolock)        
 where convert(varchar,margin_date,106)= (select convert(varchar,max(margin_date),106)          
 from AngelBSECM.bsedb_ab.dbo.tbl_mg02 a (nolock))          
 group by party_code,margin_date        
        
 union all        
        
 select party_code=ltrim(rtrim(party_code)),margin_date,VarMargin=sum(varamt),Co_code='NSECM'          
 from AngelNseCM.msajag.dbo.tbl_mg02 with (nolock)        
 where convert(varchar,margin_date,106)= (select convert(varchar,max(margin_date),106)          
 from AngelNseCM.msajag.dbo.tbl_mg02 a (nolock))          
 group by party_code,margin_date        
) a

GO

-- --------------------------------------------------
-- VIEW dbo.VW_Equity_Var_Margin_07112016
-- --------------------------------------------------
CREATE view VW_Equity_Var_Margin_07112016          
as          
Select party_code=ltrim(rtrim(party_code)),margin_date,VarMargin,Co_code          
from           
(          
 select party_code,margin_date,VarMargin=sum(varamt+elm),Co_code='BSECM'           
 from anand.bsedb_ab.dbo.tbl_mg02 with (nolock)          
 where convert(varchar,margin_date,106)= ('04 Nov 2016')            
 group by party_code,margin_date      
 
          
 union all          
          
 select party_code=ltrim(rtrim(party_code)),margin_date,VarMargin=sum(varamt),Co_code='NSECM'            
 from anand1.msajag.dbo.tbl_mg02 with (nolock)          
 where convert(varchar,margin_date,106)= ('04 Nov 2016')            
 group by party_code,margin_date          
) a

GO

-- --------------------------------------------------
-- VIEW dbo.VW_Equity_Var_Margin_Pledge
-- --------------------------------------------------

CREATE view [dbo].[VW_Equity_Var_Margin_Pledge]          
as          
Select party_code=ltrim(rtrim(party_code)),margin_date,VarMargin,Co_code          
from           
(          
 /*select party_code,margin_date,VarMargin=sum(varamt+elm),Co_code='BSECM'           
 from anand.bsedb_ab.dbo.tbl_mg02 with (nolock)          
 where convert(varchar,margin_date,106)= (select convert(varchar,max(margin_date),106)            
 from anand.bsedb_ab.dbo.tbl_mg02 a (nolock))            
 group by party_code,margin_date          
          
 union all          
          
 select party_code=ltrim(rtrim(party_code)),margin_date,VarMargin=sum(varamt),Co_code='NSECM'            
 from anand1.msajag.dbo.tbl_mg02 with (nolock)          
 where convert(varchar,margin_date,106)= (select convert(varchar,max(margin_date),106) from anand1.msajag.dbo.tbl_mg02 a (nolock))            
 group by party_code,margin_date          
 */
 /* Changes done by Rohit Patil And Anil on 24 Oct 2017 as per discussed with Rahul Sir */
 select party_code,margin_date,VarMargin=sum(varamt+elm),Co_code='BSECM'           
 from AngelBSECM.bsedb_ab.dbo.tbl_mg02 with (nolock)          
 where convert(varchar,margin_date,106)= (select convert(varchar,max(margin_date),106)  from AngelBSECM.bsedb_ab.dbo.tbl_mg02 a (nolock)) 
 and sett_no in (select sett_no from anand.bsedb_ab.dbo.sett_mst where sec_payin > getdate() and sett_type in ('c','d' ))       
 group by party_code,margin_date
          
 union all          
  
 select party_code=ltrim(rtrim(party_code)),margin_date,VarMargin=sum(varamt),Co_code='NSECM'            
 from AngelNseCM.msajag.dbo.tbl_mg02 with (nolock)          
 where convert(varchar,margin_date,106)= (select convert(varchar,max(margin_date),106) from AngelNseCM.msajag.dbo.tbl_mg02 a (nolock))    
 and sett_no in (select sett_no from AngelNseCM.msajag.dbo.sett_mst where sec_payin > getdate() and sett_type in ('n','w' ))        
 group by party_code,margin_date  
 
) a

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_LAS_Appr_Bank_Scrip
-- --------------------------------------------------
  
CREATE VIEW [dbo].[Vw_LAS_Appr_Bank_Scrip]        
AS        
      
 SELECT DISTINCT 1       AS BANK_CODE,        
                 'ICICI' AS BANK,        
                 SCODE        
 FROM   INTRANET.RISK.DBO.ICICI_SCP WITH (NOLOCK)        
 UNION ALL        
 SELECT DISTINCT 2      AS BANK_CODE,        
                 'HDFC' AS BANK,        
                 SCODE        
 FROM   INTRANET.RISK.DBO.HDFC_SCP WITH (NOLOCK)        
 UNION ALL        
 SELECT DISTINCT 3       AS BANK_CODE,        
                 'KOTAK' AS BANK,        
                 SCODE        
 FROM   INTRANET.RISK.DBO.KOTAK_SCP WITH (NOLOCK)        
 UNION ALL        
 SELECT DISTINCT 5               AS BANK_CODE,        
                 'BANK OF INDIA' AS BANK,        
                 SCODE        
 FROM   INTRANET.RISK.DBO.BANKOFINDIA_SCP WITH (NOLOCK)        
 UNION ALL        
 SELECT DISTINCT 8             AS BANK_CODE,        
                 'BSEEXCHANGE' AS BANK,        
                 SCODE        
 FROM   INTRANET.RISK.DBO.BSE_SCP WITH (NOLOCK)         
UNION ALL     
SELECT DISTINCT 12       AS BANK_CODE,            
                 'INDUSIND' AS BANK,            
                 SCODE            
 FROM   INTRANET.RISK.DBO.INDUSIND_SCP WITH (NOLOCK)     
UNION ALL      
SELECT DISTINCT 7       AS BANK_CODE,            
                 'ABGL' AS BANK,            
                 SCODE            
 FROM   INTRANET.RISK.DBO.Abgl_bank WITH (NOLOCK)    
 UNION ALL      
SELECT DISTINCT 11       AS BANK_CODE,            
                 'JM' AS BANK,            
                 SCODE            
 FROM   INTRANET.RISK.DBO.JM WITH (NOLOCK) 
 UNION ALL
 SELECT DISTINCT 22       AS BANK_CODE,            
                 'BajajFinance' AS BANK,            
                 SCODE            
 FROM   INTRANET.RISK.DBO.BajajFinance WITH (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.vw_Party_Pledge_Dtl
-- --------------------------------------------------


CREATE View [dbo].[vw_Party_Pledge_Dtl]    
As    
 Select Party_code,  
        Segment=(Case Accno  
                  When '1203320000000066' Then 'BSECM'  
                  When '1203320000000051' Then 'NSECM'  
                  when '1203320009603460' Then 'BSECM'  
                 End),  
        Isin,  
        Scrip_cd,  
        Scripname,  
        Pledgeqty=Sum(Prevday_pledege_qty),  
        --Avg_closing=Avg_closing,  
        Pledgevalue=Sum(Prevday_pledege_qty * Avg_closing)  
 From   Tbl_party_pledge_data (NOLOCK)  
 Group  By Accno,Isin,Scrip_cd,Party_code,Avg_closing,Scripname  
 Having Sum(Prevday_pledege_qty * Avg_closing) > 0

GO

-- --------------------------------------------------
-- VIEW dbo.WCL_DerivativeMargin
-- --------------------------------------------------
CREATE view WCL_DerivativeMargin            
as            
Select margindate,Party_code,initialmargin,AddMargin,Co_code from            
(            

 Select margindate,Party_code,initialmargin+MTMMargin as initialmargin,AddMargin,Co_code='NSEFO'             
 from ANGELFO.NSEFO.dbo.tbl_ClientMargin a (nolock)            
 Where Convert(varchar,margindate,106)= (Select Convert(varchar,Max(margindate),106)            
 from ANGELFO.NSEFO.dbo.tbl_ClientMargin a (nolock))            
            
 union all            
            
 Select margindate,Party_code,initialmargin+MTMMargin as initialmargin,AddMargin,Co_code='MCD'          
 from ANGELCOMMODITY.MCDXCDS.dbo.tbl_ClientMargin a (nolock)            
 Where Convert(varchar,margindate,106)= (Select Convert(varchar,Max(margindate),106)            
 from ANGELCOMMODITY.MCDXCDS.dbo.tbl_ClientMargin a (nolock))            
 union all            
            
 Select margindate,Party_code,initialmargin+MTMMargin as initialmargin,AddMargin,Co_code='NSX'          
 from ANGELFO.NSECURFO.dbo.tbl_ClientMargin a (nolock)            
 Where Convert(varchar,margindate,106)= (Select Convert(varchar,Max(margindate),106)            
 from ANGELFO.NSECURFO.dbo.tbl_ClientMargin a (nolock))            
) a

GO

