-- DDL Export
-- Server: 10.253.33.89
-- Database: Dustbin
-- Exported: 2026-02-05T02:38:42.018513

USE Dustbin;
GO

-- --------------------------------------------------
-- FUNCTION dbo.AddZeroPrefix
-- --------------------------------------------------
CREATE function AddZeroPrefix(@ivalue money,@cnt int)              
RETURNs varchar(25)      
As              
Begin              
declare @value varchar(25)       
set @value = convert(varchar(25),@ivalue)      
      
While @cnt > len(@value)      
Begin       
 set @value='0'+@value      
End      
Return @value       
             
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_StripCharacters
-- --------------------------------------------------
CREATE FUNCTION [dbo].[fn_StripCharacters](@String NVARCHAR(MAX))  
RETURNS NVARCHAR(MAX)  
AS  
BEGIN  
  
Declare @MatchExpression VARCHAR(255) = '^a-z 0-9'  
/*  
Alphabetic only:  
SELECT dbo.fn_StripCharacters('a1!s2 @d3#f4$', '^a-z ')  
  
Numeric only:  
SELECT dbo.fn_StripCharacters('a1!s2@d3#f4$', '^0-9')  
  
Alphanumeric only:  
SELECT dbo.fn_StripCharacters('a1!s 2@d3#f4$', '^a-z 0-9')  
  
Non-alphanumeric:  
SELECT dbo.fn_StripCharacters('a1!s2@d3#f4$', 'a-z0-9')  
*/  
  
    SET @MatchExpression =  '%['+@MatchExpression+']%'  
  
    WHILE PatIndex(@MatchExpression, @String) > 0  
        SET @String = Stuff(@String, PatIndex(@MatchExpression, @String), 1, '')  
  
    RETURN @String  
  
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.SplitString
-- --------------------------------------------------



CREATE FUNCTION dbo.SplitString
(
    @String NVARCHAR(MAX), 
    @Delimiter CHAR(1)
)
RETURNS @Results TABLE 
(
    Id INT IDENTITY(1,1), 
    Value NVARCHAR(MAX)
)
AS
BEGIN
    DECLARE @Index INT;
    DECLARE @Slice NVARCHAR(MAX);

    SET @Index = 1;
    WHILE @Index > 0
    BEGIN
        SET @Index = CHARINDEX(@Delimiter, @String);

        IF @Index > 0
            SET @Slice = LEFT(@String, @Index - 1);
        ELSE
            SET @Slice = @String;

        INSERT INTO @Results(Value) VALUES(@Slice);

        SET @String = RIGHT(@String, LEN(@String) - @Index);

        IF LEN(@String) = 0 BREAK;
    END

    RETURN;
END;

GO

-- --------------------------------------------------
-- INDEX dbo.ebroking_BSETrade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[ebroking_BSETrade] ([Sauda_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.ebroking_MCXSXTrade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[ebroking_MCXSXTrade] ([sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.ebroking_MCXTrade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[ebroking_MCXTrade] ([sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.ebroking_mis_to
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[ebroking_mis_to] ([sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.ebroking_NSDEXTrade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[ebroking_NSDEXTrade] ([sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.ebroking_NSEFOTrade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[ebroking_NSEFOTrade] ([sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.ebroking_NSETrade
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[ebroking_NSETrade] ([sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.ebroking_NSXTRADE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[ebroking_NSXTRADE] ([SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_MCDX_ord_client_info
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[MIS_MCDX_ord_client_info] ([SaudaDate])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_MCXSX_ord_client_info
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[MIS_MCXSX_ord_client_info] ([SaudaDate])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_NCDX_ord_client_info
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[MIS_NCDX_ord_client_info] ([SaudaDate])

GO

-- --------------------------------------------------
-- INDEX dbo.MIS_tbl_Ctcl_Diet_Alloted_new
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcol] ON [dbo].[MIS_tbl_Ctcl_Diet_Alloted_new] ([updated_on])

GO

-- --------------------------------------------------
-- INDEX dbo.OFS_ORDER_HISTORY
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_OFS_ORDER_HISTORY_REQID] ON [dbo].[OFS_ORDER_HISTORY] ([REQUEST_ID], [AuditDate])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Employees
-- --------------------------------------------------
ALTER TABLE [dbo].[Employees] ADD CONSTRAINT [PK__Employee__7AD04FF189C2ECC5] PRIMARY KEY ([EmployeeID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MailListSbTag
-- --------------------------------------------------
ALTER TABLE [dbo].[MailListSbTag] ADD CONSTRAINT [PK__MailList__3213E83FEF39B043] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.menu_item30092024
-- --------------------------------------------------
ALTER TABLE [dbo].[menu_item30092024] ADD CONSTRAINT [PK_menu_item] PRIMARY KEY ([menu_code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.NCMS_AutoPayout_BillToBill_28Feb2024
-- --------------------------------------------------
ALTER TABLE [dbo].[NCMS_AutoPayout_BillToBill_28Feb2024] ADD CONSTRAINT [PK_Bill_Partycode] PRIMARY KEY ([party_code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.OFS_BATCH
-- --------------------------------------------------
ALTER TABLE [dbo].[OFS_BATCH] ADD CONSTRAINT [PK__OFS_BATC__3213E83FB5992156] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.OFS_CNSLOG
-- --------------------------------------------------
ALTER TABLE [dbo].[OFS_CNSLOG] ADD CONSTRAINT [PK__OFS_CNSL__3213E83F0CFEAD58] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.OFS_ORDER_HISTORY
-- --------------------------------------------------
ALTER TABLE [dbo].[OFS_ORDER_HISTORY] ADD CONSTRAINT [PK__OFS_ORDE__4D7B4ADD1BE4F5F9] PRIMARY KEY ([HistoryID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.OFS_REVERSE_UPLOAD
-- --------------------------------------------------
ALTER TABLE [dbo].[OFS_REVERSE_UPLOAD] ADD CONSTRAINT [PK__OFS_REVE__3214EC274889E826] PRIMARY KEY ([ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.OFS_StatusMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[OFS_StatusMaster] ADD CONSTRAINT [PK__OFS_Stat__6A7B44FD8086949A] PRIMARY KEY ([StatusCode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.SbTag_Mail
-- --------------------------------------------------
ALTER TABLE [dbo].[SbTag_Mail] ADD CONSTRAINT [PK__SbTag_Ma__8B5CCB5CCDF7A2A7] PRIMARY KEY ([sbtag], [Emailid])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.SubBrokerMailSendLog
-- --------------------------------------------------
ALTER TABLE [dbo].[SubBrokerMailSendLog] ADD CONSTRAINT [PK__SubBroke__11F3F53FB434AF8F] PRIMARY KEY ([sbtag], [email], [logdate])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBL_OFS_BATCH
-- --------------------------------------------------
ALTER TABLE [dbo].[TBL_OFS_BATCH] ADD CONSTRAINT [PK__TBL_OFS___3213E83F5F4702B5] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_SFDCClientrepsonseAPI
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_SFDCClientrepsonseAPI] ADD CONSTRAINT [PK__tbl_SFDC__3214EC072B0A9E1C] PRIMARY KEY ([Id])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_option_pl
-- --------------------------------------------------
CREATE procedure [dbo].[angel_option_pl](@fdate as varchar(11))          
as          
       --   exec angel_option_pl 'OCT 7 2024'
set transaction isolation level read uncommitted          
set nocount on          
/*          
declare @fdate as varchar(11)          
set @fdate = 'Sep 15 2009'          
*/          
          
declare @disp as varchar(1)          
set @disp ='Y'          
        if @fdate=''          
begin          
    set @fdate=convert(varchar(11),getdate()-1)          
    set @disp ='Y'          
end          
          
declare @nor as int          
select @nor= count(*) from Angel_OptionPL (nolock) where sauda_date>=@fdate+' 00:00:00' and sauda_date <=@fdate+' 23:59:59'--'2024-10-03'  
 print 'this is a test message'; 

if @nor <= 0         
 print 'this is a test message'; 

begin          
    select trade_no,party_Code,inst_type,symbol,expirydate,strike_price,option_type,user_id,sauda_date,sell_buy          
    into #file1          
    from angelcommodity.mcdx.dbo.fosettlement          
    where sauda_Date >=@fdate+' 00:00:00' and sauda_date <=@fdate+' 23:59:59'          
    and isnumeric(trade_no) = 1 and cast(replace(trade_no,'','') as numeric)>0          
    and trade_no not like 'EA%'          
    and convert(varchar(11),sauda_date,108) <> '00:00:00'          
    --and trade_no > 0          
    --order by trade_no          
           print 'this is a test message'; 

    ------- check for buy sell time difference          
          
    select a.party_code,a.inst_type,a.symbol,a.expirydate,a.strike_price,a.option_type,          
    timediff=abs(datediff(mi,max(a.sauda_date),min(b.sauda_date)))          
    into #filtd          
    from (select * from #file1 where sell_buy=1 )a ,          
    (select * from #file1 where sell_buy=2 )b          
    where a.party_Code=b.party_Code          
    and a.inst_type=b.inst_type and a.symbol=b.symbol          
    and a.expirydate=b.expirydate and a.strike_price=b.strike_price and a.option_type= b.option_type          
    group by a.party_code,a.inst_type,a.symbol,a.expirydate,a.strike_price,a.option_type          
          
          
    select x.party_Code,x.inst_type,x.symbol,x.expirydate,x.strike_price,x.option_type,cpcode=y.party_code,y.user_id          
    into #sec_det          
    from angelcommodity.mcdx.dbo.fosettlement x,          
    (          
    select a.*,cpcode=b.party_Code from #file1 a , #file1 b where a.trade_no=b.trade_no and a.party_Code<> b.party_Code          
    and a.inst_type=b.inst_type and a.symbol=b.symbol and a.expirydate=b.expirydate and a.strike_price=b.strike_price and a.option_type= b.option_type          
    ) y          
    where x.sauda_Date >=@fdate+' 00:00:00' and x.sauda_date <=@fdate+' 23:59:59'          
    and x.trade_no not like 'EA%'          
    and isnumeric(x.trade_no) = 1 and cast(replace(x.trade_no,'','') as numeric)>0          
    and convert(varchar(11),x.sauda_date,108) <> '00:00:00'          
    and x.trade_no=y.trade_no          
    and x.inst_type=y.inst_type and x.symbol=y.symbol and x.expirydate=y.expirydate and x.strike_price=y.strike_price          
    and x.option_type= y.option_type          
    and x.party_code <> y.party_Code          
          
       print 'this is a test message 63';   
    select sauda_date=convert(varchar(11),sauda_date),branch_code,sub_Broker,party_code,Party_name,inst_type,symbol,option_type,expirydate=convert(varchar(11),expirydate),Strike_Price,          
    pqty=sum(pqty),prate=(case when sum(pqty) > 0 then sum(prate*pqty)/sum(pqty) else 0 end),pval=sum(prate*pqty),          
    sqty=sum(sqty),srate=(case when sum(sqty) > 0 then sum(srate*sqty)/sum(sqty) else 0 end),sval=sum(srate*sqty),          
    pl=((case          
    when sum(pqty) > sum(sqty) then sum(sqty*srate)-sum(sqty*prate)          
    when sum(pqty) < sum(sqty) then sum(pqty*srate)-sum(pqty*prate)          
    else sum(sqty*srate)-sum(pqty*prate)          
    end)*sum(numerator)/sum(denominator))          
    ,stat=space(25),cls_rate=convert(money,0),terminal_id=space(10),PercMktGross=convert(money,0),          
    timegap=convert(int,0),PriceVariation=convert(money,0),SellPriceVariation =convert(money,0),          
    Min_time=Convert(datetime,'1900-01-01'),          
    Max_time=Convert(datetime,'1900-01-01'),          
    NOD30Days=0          
    into #file_a          
    from angelcommodity.mcdx.dbo.fobillvalan          
    where sauda_Date >=@fdate+' 00:00:00' and sauda_date <=@fdate+' 23:59:59'          
    --and option_type <> ''          
    and tradetype='BT' and AuctionPart <> 'EA'          
    group by sauda_date,branch_code,sub_Broker,party_code,Party_name,inst_type,symbol,option_type,expirydate,Strike_Price          
  --having sum(pqty) > 0 and sum(sqty) > 0          
    --order by party_code,symbol          
          print 'this is a test message 85';
    ---Start Added on 21 Nov 2011          
    Select sauda_Date=Convert(datetime,convert(varchar,sauda_Date,106)),          
    Party_code,Min_ime=min(Sauda_date),Max_Time=max(Sauda_date)          
    into #tt          
    from angelcommodity.mcdx.dbo.fosettlement with (nolock)          
    where sauda_Date >=@fdate+' 00:00:00' and sauda_date <=@fdate+' 23:59:59'          
    group by Convert(datetime,convert(varchar,sauda_Date,106)),Party_code          
          
    update #file_a set Min_time=a.Min_ime,Max_Time=a.Max_Time          
    from #tt a          
    where a.party_code=#file_a.party_code          
    and Convert(datetime,a.sauda_Date)=Convert(datetime,#file_a.sauda_Date)          
          
    Select NOD30Days=Count(distinct Convert(varchar,sauda_Date,106)),Party_code          
    into #tt1          
    from angelcommodity.mcdx.dbo.fosettlement with (nolock)          
    where sauda_Date >=Convert(datetime,@fdate)-30 and sauda_date <=@fdate+' 23:59:59'          
    group by Party_code          
          
    update #file_a set NOD30Days=a.NOD30Days          
    from #tt1 a          
    where a.party_code=#file_a.party_code          
          
    ---end          
          
          
    ---- Convert Quantity into Lots          
    update #file_a set PQTY=PQTY/b.c_Regular_lot,SQTY=SQTY/b.c_Regular_lot          
    from angelcommodity.mcdx.DBO.FOscrip2 b where          
    #file_a.Inst_type=b.Inst_type and #file_a.symbol=b.symbol and #file_a.expirydate+' 23:59:00'=b.Expirydate          
    and #file_a.strike_price=b.strike_price and #file_a.option_type=b.option_type          
          
          
    -------------- check for % to market gross          
          print 'this is a test message 120';
    update #file_a set PercMktGross=mkt_vol from          
    (          
    --select a.*,mkt_vol=((pqty+sqty)*100.00)/(b.aa*2) from #file_a a,     
 SELECT a.*, ((pqty + sqty) * 100.00) / (CONVERT(numeric, b.aa) * 2) AS mkt_vol FROM #file_a a,     
    /*          
    (select * from intranet.risk.dbo.fomd_cumm where mfdate=@fdate) b          
    (select *,ff as aa from [196.1.115.182].general.dbo.cp_mcx where Tradedate=@fdate) b          
    */          
    (          
    select MArketType as T_TYpe,InstType as Inst_type,Symbol,ExpiryDate as Exp_date,Opt_type=Optiontype,strike_price=StrikePrice,          
    /* ff as aa */          
    ee as aa          
    /* Changes Done by Rohit in View Vw_CP_MCX_New */              
    from Vw_CP_MCX_New where tradedate>=@fdate+' 00:00:00' and tradedate <=@fdate+' 23:59:59'--'2024-10-07'      
    ) b          
    where a.inst_type=b.inst_type and a.symbol=b.symbol           
    and ISNULL(a.option_type,'')= ISNULL(b.opt_type,'')          
    and convert(datetime,a.expirydate)=convert(datetime,b.exp_Date)          
    and ISNULL(a.strike_price,'') = ISNULL(b.strike_price,'')          
    ) b where #file_a.party_Code=b.party_code and          
    #file_a.inst_type=b.inst_type and #file_a.symbol=b.symbol          
    --and #file_a.option_type=b.option_type          
    -- and #file_a.strike_price=b.strike_price          
    and #file_a.expirydate=b.expirydate          
          print 'this is a test message 145';
          
    update #file_a set terminal_id=b.user_id from #file1 b          
    where #file_a.party_code=b.party_code          
    and #file_a.inst_type=b.inst_type          
    and #file_a.symbol=b.symbol          
    and #file_a.option_type=b.option_type          
    and #file_a.expirydate=convert(varchar(11),b.expirydate)          
    and #file_a.strike_price=b.strike_price          
          
    /*          
    update #File_a set stat='ST' from #sec_Det b where #File_a.party_Code=b.party_code          
    and #File_a.inst_type=#File_a.inst_type          
    and #File_a.symbol=b.symbol          
    and #File_a.expirydate=convert(varchar(11),b.expirydate)          
    and #File_a.strike_price=b.strike_price          
    and #File_a.option_type=b.option_type          
    */          
          
          
    update #File_a set stat='ST'+'-'+b.cpCode,terminal_id=user_id          
    from #sec_Det b where #File_a.party_Code=b.party_code          
    and #File_a.inst_type=#File_a.inst_type          
    and #File_a.symbol=b.symbol          
    and #File_a.expirydate=convert(varchar(11),b.expirydate)          
    and #File_a.strike_price=b.strike_price          
    and #File_a.option_type=b.option_type          
          
    /*          
    update #file_A set cls_rate = b.cls from (select * from intranet.risk.dbo.mdcumm where mfdate =@fdate) b          
    where #file_A.symbol=b.scrip          
          
    select * into #gg from          
    (          
    select scrip,hi,lo,cls from intranet.risk.dbo.mdcumm where mfdate =@fdate and series='EQ'          
    union          
    select scrip=symbol,hi=hgh,lo=lw,cls=nifty from intranet.risk.dbo.spot_nifty where tdate =@fdate          
    ) a          
          
    update #file_a set PriceVariation=b.prvar from          
    (          
    select a.*,          
    PrVar=(case when a.prate > b.hi then ((a.prate-b.hi)*100)/b.hi when a.prate < b.lo then ((b.lo-a.prate)*100)/b.lo          
    else 0 end) from (select * from #file_a where left(inst_Type,3)='FUT') a left outer join #gg b          
    on a.symbol=b.scrip          
    where a.prate > isnull(b.hi,0) or a.prate < isnull(b.lo,0)          
    ) b          
    where #file_A.party_Code=b.party_Code          
    and #file_A.inst_type=b.inst_type and #file_A.symbol=b.symbol          
    and #file_A..expirydate=b.expirydate          
    and #file_A.strike_price=b.strike_price          
    and #file_A.option_type= b.option_type          
          
          
          
    update #file_a set SellPriceVariation=b.prvar from          
    (          
    select a.*,          
    PrVar=(case when a.srate > b.hi then ((a.srate-b.hi)*100)/b.hi when a.srate < b.lo then ((b.lo-a.srate)*100)/b.lo          
    else 0 end) from (select * from #file_a where left(inst_Type,3)='FUT') a left outer join #gg b          
    on a.symbol=b.scrip          
    where a.srate > isnull(b.hi,0) or a.srate < isnull(b.lo,0)          
    ) b          
    where #file_A.party_Code=b.party_Code          
    and #file_A.inst_type=b.inst_type and #file_A.symbol=b.symbol          
    and #file_A..expirydate=b.expirydate          
    and #file_A.strike_price=b.strike_price          
    and #file_A.option_type= b.option_type          
    */          
          
          
    update #file_A set timegap = b.timediff from #filtd b          
    where #file_A.party_Code=b.party_Code          
    and #file_A.inst_type=b.inst_type and #file_A.symbol=b.symbol          
    and convert(datetime,#file_A.expirydate+' 23:59:00')=b.expirydate          
    and #file_A.strike_price=b.strike_price          
    and #file_A.option_type= b.option_type          
          
    delete from Angel_OptionPL where sauda_date >=@fdate+' 00:00:00' and sauda_date <=@fdate+' 23:59:59'   --- '2024-10-03'     
    insert into Angel_OptionPL select distinct * from #file_A          
end          
          
if @disp ='N'          
Begin          
--print 'this is a test message start';
    select distinct *,Time_Gap=CONVERT(varchar(8), DATEADD(ms, DATEDIFF(ms, Min_time, Max_time), 0), 114)          
    from Angel_OptionPL (nolock) where sauda_date >=@fdate+' 00:00:00' and sauda_date <=@fdate+' 23:59:59'----'2024-10-03' --- 146723  
    order by party_code,inst_type,symbol,expirydate,strike_price,option_type        
	--print 'this is a test message end';
End          
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Brokerage_client_upload_Utility
-- --------------------------------------------------
CREATE PROC [dbo].[Brokerage_client_upload_Utility]                 
(          
@FileName VARCHAR(50) = NULL ,                  
 @Total int out,            
 @username varchar(50)    
  )                             
    
AS                       
BEGIN         
truncate table Brok_Client_forMail      
         
   Declare @filePath1 varchar(500)=''        
   set @filePath1 ='\\INHOUSELIVEAPP1-FS.angelone.in\D\UploadAdvChart\'+@FileName+''                  
        
   DECLARE @sql1 NVARCHAR(4000) = 'BULK INSERT Brok_Client_forMail FROM ''' + @filePath1 + ''' WITH ( FIELDTERMINATOR ='','', ROWTERMINATOR =''\n'',FirstRow=1 )';                  
   EXEC(@sql1)     
   print @sql1         
              
   insert into  Brok_Client_forMail_hist      
   select *,@FileName,GETDATE() from Brok_Client_forMail    
    
   select @Total=COUNT(1) from Brok_Client_forMail      
  -- return @Total      
             
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Brokerage_CustomBrok_mailer_TEST
-- --------------------------------------------------

CREATE proc [dbo].[Brokerage_CustomBrok_mailer_TEST] (@CODE VARCHAR (50))
as
begin
declare @BSEL1 as decimal(18,4)=0.00,@BSEM1 as decimal(18,4)=0.00,@BseP1 as decimal(18,4)=0.00,@BSEL2 as decimal(18,4)=0.00,@BSEM2 as decimal(18,4)=0.00,
@BseP2 as decimal(18,4)=0.00,@BSEDel as decimal(18,4)=0.00,@BSEMDel as decimal(18,4)=0.00,@BsePDel as decimal(18,4)=0.00,@NSEL1 as decimal(18,4)=0.00,@NSEM1 as decimal(18,4)=0.00,
@NSEP1 as decimal(18,4)=0.00,@NSEL2 as decimal(18,4)=0.00,@NSEM2 as decimal(18,4)=0.00,@NSEP2 as decimal(18,4)=0.00,
@NSELDel as decimal(18,4)=0.00,@NSEMDel as decimal(18,4)=0.00,@NSEPDel as decimal(18,4)=0.00,@MCXL1 as decimal(18,4)=0.00,@MCX1M as decimal(18,4)=0.00,@MCX1Fu as decimal(18,4)=0.00,
@MCXL2 as decimal(18,4)=0.00,@MCX2M as decimal(18,4)=0.00,@MCX2Fu as decimal(18,4)=0.00,@NCDX1L as decimal(18,4)=0.00,@NCDX1Min as decimal(18,4)=0.00,@NCDX1Fu as decimal(18,4)=0.00,
@NCDX2L as decimal(18,4)=0.00,@NCDX2Min as decimal(18,4)=0.00,@NCDX2Fu as decimal(18,4)=0.00,@NSEFOFL as decimal(18,4)=0.00,
@NSEFOFMin as decimal(18,4)=0.00,@NSEFOFFu as decimal(18,4)=0.00,@NSEFOSL as decimal(18,4)=0.00,@NSEFOSMin as decimal(18,4)=0.00,@NSEFOSFu as decimal(18,4)=0.00,
@NSX1 as decimal(18,4)=0.00,@NSX2 as decimal(18,4)=0.00,@NSEFOOS1 as decimal(18,4)=0.00,@NSEFOOS2 as decimal(18,4)=0.00,@NSEFOON1 as decimal(18,4)=0.00,@NSEFOON2 as decimal(18,4)=0.00,
@NSEFOOB1 as decimal(18,4)=0.00,@NSEFOOB2 as decimal(18,4)=0.00,@NSEFOOFN1 as decimal(18,4)=0.00,@NSEFOOFN2 as decimal(18,4)=0.00,@NSXO1 as decimal(18,4)=0.00,@NSXO2 as decimal(18,4)=0.00,@MCD1 as decimal(18,4)=0.00,@MCD2 as decimal(18,4)=0.00,
@MCDO1 as decimal(18,4)=0.00,@MCDO2 as decimal(18,4)=0.00,
@BSEFOOAll1 as decimal(18,4)=0.00,@BSEFOOAll2 as decimal(18,4)=0.00,@BSEFOOSX501 as decimal(18,4)=0.00,@BSEFOOSX502 as decimal(18,4)=0.00,
@BSEFOOBKX1 as decimal(18,4)=0.00,@BSEFOOBKX2 as decimal(18,4)=0.00,@BSEFOOBSX1 as decimal(18,4)=0.00,
@BSEFOOBSX2 as decimal(18,4)=0.00,
@BSEFOOAll1_Old as decimal(18,4)=0.00, @BSEFOOSX501_Old as decimal(18,4)=0.00, @BSEFOOBKX1_Old as decimal(18,4)=0.00,
@BSEFOOBSX1_Old as decimal(18,4)=0.00,@BSEFOOAll2_Old as decimal(18,4)=0.00, @BSEFOOSX502_Old as decimal(18,4)=0.00,
@BSEFOOBKX2_Old as decimal(18,4)=0.00, @BSEFOOBSX2_Old as decimal(18,4)=0.00,
@BSEFOFL as decimal(18,4)=0.00,    
@BSEFOFMin as decimal(18,4)=0.00,@BSEFOFFu as decimal(18,4)=0.00,@BSEFOSL as decimal(18,4)=0.00,@BSEFOSMin as decimal(18,4)=0.00,@BSEFOSFu as decimal(18,4)=0.00,  
@BSEFOFL_Old  as decimal(18,4)=0.00,@BSEFOFMin_Old as decimal(18,4)=0.00,@BSEFOFFu_Old as decimal(18,4)=0.00,    
   @BSEFOSL_Old as decimal(18,4)=0.00,@BSEFOSMin_Old as decimal(18,4)=0.00,@BSEFOSFu_Old as decimal(18,4)=0.00,  
   @BSXOPT_N1 as decimal(18,4)=0.00,@BSXOPT_N2 as decimal(18,4)=0.00,@SX500PT_N1 as decimal(18,4)=0.00,
@SX500PT_N2 as decimal(18,4)=0.00,@BSEFOOALL_S1 as decimal(18,4)=0.00,@BSEFOOALL_S2 as decimal(18,4)=0.00,
@BKXOPT_B1 as decimal(18,4)=0.00,@BKXOPT_B2 as decimal(18,4)=0.00,
   @BSXOPT_N1_Old as decimal(18,4)=0.00,@BSXOPT_N2_Old as decimal(18,4)=0.00,@SX500PT_N1_Old as decimal(18,4)=0.00,
@SX500PT_N2_Old as decimal(18,4)=0.00,@BSEFOOALL_S1_Old as decimal(18,4)=0.00,@BSEFOOALL_S2_Old as decimal(18,4)=0.00,
@BKXOPT_B1_Old as decimal(18,4)=0.00,@BKXOPT_B2_Old as decimal(18,4)=0.00,
@NCEL1 as decimal(18,4)=0.00,@NCE1M as decimal(18,4)=0.00,@NCE1Fu as decimal(18,4)=0.00,
@NCEL2 as decimal(18,4)=0.00,@NCE2M as decimal(18,4)=0.00,@NCE2Fu as decimal(18,4)=0.00,

@NCEL1_Old as decimal(18,4)=0.00,@NCE1M_Old as decimal(18,4)=0.00,@NCE1Fu_Old as decimal(18,4)=0.00,  
@NCEL2_Old as decimal(18,4)=0.00,@NCE2M_Old as decimal(18,4)=0.00,@NCE2Fu_Old as decimal(18,4)=0.00


declare @BSEL1_Old as decimal(18,4)=0.00,@BSEM1_Old as decimal(18,4)=0.00,@BseP1_Old as decimal(18,4)=0.00,@BSEL2_Old as decimal(18,4)=0.00,@BSEM2_Old as decimal(18,4)=0.00,  
@BseP2_Old as decimal(18,4)=0.00,@BSEDel_Old as decimal(18,4)=0.00,@BSEMDel_Old as decimal(18,4)=0.00,@BsePDel_Old as decimal(18,4)=0.00,@NSEL1_Old as decimal(18,4)=0.00,@NSEM1_Old as decimal(18,4)=0.00,  
@NSEP1_Old as decimal(18,4)=0.00,@NSEL2_Old as decimal(18,4)=0.00,@NSEM2_Old as decimal(18,4)=0.00,@NSEP2_Old as decimal(18,4)=0.00,  
@NSELDel_Old as decimal(18,4)=0.00,@NSEMDel_Old as decimal(18,4)=0.00,@NSEPDel_Old as decimal(18,4)=0.00,@MCXL1_Old as decimal(18,4)=0.00,@MCX1M_Old as decimal(18,4)=0.00,@MCX1Fu_Old as decimal(18,4)=0.00,  
@MCXL2_Old as decimal(18,4)=0.00,@MCX2M_Old as decimal(18,4)=0.00,@MCX2Fu_Old as decimal(18,4)=0.00,@NCDX1L_Old as decimal(18,4)=0.00,@NCDX1Min_Old as decimal(18,4)=0.00,@NCDX1Fu_Old as decimal(18,4)=0.00,  
@NCDX2L_Old as decimal(18,4)=0.00,@NCDX2Min_Old as decimal(18,4)=0.00,@NCDX2Fu_Old as decimal(18,4)=0.00,@NSEFOFL_Old as decimal(18,4)=0.00,  
@NSEFOFMin_Old as decimal(18,4)=0.00,@NSEFOFFu_Old as decimal(18,4)=0.00,@NSEFOSL_Old as decimal(18,4)=0.00,@NSEFOSMin_Old as decimal(18,4)=0.00,@NSEFOSFu_Old as decimal(18,4)=0.00,  
@NSX1_Old as decimal(18,4)=0.00,@NSX2_Old as decimal(18,4)=0.00,@NSEFOOS1_Old as decimal(18,4)=0.00,@NSEFOOS2_Old as decimal(18,4)=0.00,@NSEFOON1_Old as decimal(18,4)=0.00,@NSEFOON2_Old as decimal(18,4)=0.00,  
@NSEFOOB1_Old as decimal(18,4)=0.00,@NSEFOOB2_Old as decimal(18,4)=0.00,@NSEFOOFN1_Old as decimal(18,4)=0.00,@NSEFOOFN2_Old as decimal(18,4)=0.00,@NSXO1_Old as decimal(18,4)=0.00,@NSXO2_Old as decimal(18,4)=0.00,@MCD1_Old as decimal(18,4)=0.00,@MCD2_Old as decimal(18,4)=0.00,  
@MCDO1_Old as decimal(18,4)=0.00,@MCDO2_Old as decimal(18,4)=0.00 , 
@NSEFOOMCN1  as decimal(18,4)=0.00,@NSEFOOMCN2 as decimal(18,4)=0.00,@NSEFOOMCN1_Old  as decimal(18,4)=0.00,
@NSEFOOMCN2_Old  as decimal(18,4)=0.00,

@MCXOP_Silver1M  as decimal(18,4)=0.00 ,@MCXOP_Silver2M as decimal(18,4)=0.00,    
@MCXOP_Copper1M as decimal(18,4)=0.00,@MCXOP_Copper2M as decimal(18,4)=0.00,   
@MCXOP_Zinc1M as decimal(18,4)=0.00, @MCXOP_Zinc2M as decimal(18,4)=0.00,   
@MCXOP_Gold1M as decimal(18,4)=0.00 ,@MCXOP_Gold2M as decimal(18,4)=0.00,     
@MCXOP_Crudoil1M as decimal(18,4)=0.00 ,@MCXOP_Crudoil2M as decimal(18,4)=0.00, 
@MCXOP_NaturalGas1M as decimal(18,4)=0.00 ,@MCXOP_NaturalGas2M as decimal(18,4)=0.00,  
@MCXOP_ALL1M as decimal(18,4)=0.00 ,@MCXOP_ALL2M as decimal(18,4)=0.00, 
  
@MCXOP_Silver1M_Old  as decimal(18,4)=0.00, @MCXOP_Silver2M_Old decimal(18,4)=0.00 ,    
@MCXOP_Copper1M_Old decimal(18,4)=0.00 ,@MCXOP_Copper2M_Old decimal(18,4)=0.00,   
@MCXOP_Zinc1M_Old decimal(18,4)=0.00 ,@MCXOP_Zinc2M_Old decimal(18,4)=0.00, 
@MCXOP_Gold1M_Old decimal(18,4)=0.00 ,@MCXOP_Gold2M_Old decimal(18,4)=0.00,     
@MCXOP_Crudoil1M_Old decimal(18,4)=0.00 ,@MCXOP_Crudoil2M_Old decimal(18,4)=0.00, 
@MCXOP_NaturalGas1M_Old decimal(18,4)=0.00 ,@MCXOP_NaturalGas2M_Old decimal(18,4)=0.00, 
@MCXOP_ALL1M_Old decimal(18,4)=0.00 ,@MCXOP_ALL2M_Old decimal(18,4)=0.00, 

@NCEOP_Silver1M  as decimal(18,4)=0.00,@NCEOP_Silver2M as decimal(18,4)=0.00,  
@NCEOP_Copper1M as decimal(18,4)=0.00,@NCEOP_Copper2M as decimal(18,4)=0.00,   
@NCEOP_Zinc1M as decimal(18,4)=0.00,@NCEOP_Zinc2M as decimal(18,4)=0.00,   
@NCEOP_Gold1M as decimal(18,4)=0.00 ,@NCEOP_Gold2M as decimal(18,4)=0.00,    
@NCEOP_Crudoil1M as decimal(18,4)=0.00,@NCEOP_Crudoil2M as decimal(18,4)=0.00, 
@NCEOP_NaturalGas1M as decimal(18,4)=0.00,@NCEOP_NaturalGas2M as decimal(18,4)=0.00,    
@NCEOP_ALL1M as decimal(18,4)=0.00,@NCEOP_ALL2M as decimal(18,4)=0.00, 
  
@NCEOP_Silver1M_Old  as decimal(18,4)=0.00,@NCEOP_Silver2M_Old decimal(18,4)=0.00,   
@NCEOP_Copper1M_Old decimal(18,4)=0.00,@NCEOP_Copper2M_Old decimal(18,4)=0.00,    
@NCEOP_Zinc1M_Old decimal(18,4)=0.00,@NCEOP_Zinc2M_Old decimal(18,4)=0.00, 
@NCEOP_Gold1M_Old decimal(18,4)=0.00,@NCEOP_Gold2M_Old decimal(18,4)=0.00,    
@NCEOP_Crudoil1M_Old decimal(18,4)=0.00,@NCEOP_Crudoil2M_Old decimal(18,4)=0.00,   
@NCEOP_NaturalGas1M_Old decimal(18,4)=0.00,@NCEOP_NaturalGas2M_Old decimal(18,4)=0.00 ,  
@NCEOP_ALL1M_Old decimal(18,4)=0.00,@NCEOP_ALL2M_Old decimal(18,4)=0.00,

@NCXOP_Silver1M  as decimal(18,4)=0.00 ,@NCXOP_Silver2M as decimal(18,4)=0.00,    
@NCXOP_Copper1M as decimal(18,4)=0.00,@NCXOP_Copper2M as decimal(18,4)=0.00,   
@NCXOP_Zinc1M as decimal(18,4)=0.00, @NCXOP_Zinc2M as decimal(18,4)=0.00,   
@NCXOP_Gold1M as decimal(18,4)=0.00 ,@NCXOP_Gold2M as decimal(18,4)=0.00,     
@NCXOP_Crudoil1M as decimal(18,4)=0.00 ,@NCXOP_Crudoil2M as decimal(18,4)=0.00, 
@NCXOP_NaturalGas1M as decimal(18,4)=0.00 ,@NCXOP_NaturalGas2M as decimal(18,4)=0.00,  
@NCXOP_ALL1M as decimal(18,4)=0.00 ,@NCXOP_ALL2M as decimal(18,4)=0.00, 
  
@NCXOP_Silver1M_Old  as decimal(18,4)=0.00, @NCXOP_Silver2M_Old decimal(18,4)=0.00 ,    
@NCXOP_Copper1M_Old decimal(18,4)=0.00 ,@NCXOP_Copper2M_Old decimal(18,4)=0.00,   
@NCXOP_Zinc1M_Old decimal(18,4)=0.00 ,@NCXOP_Zinc2M_Old decimal(18,4)=0.00, 
@NCXOP_Gold1M_Old decimal(18,4)=0.00 ,@NCXOP_Gold2M_Old decimal(18,4)=0.00,     
@NCXOP_Crudoil1M_Old decimal(18,4)=0.00 ,@NCXOP_Crudoil2M_Old decimal(18,4)=0.00, 
@NCXOP_NaturalGas1M_Old decimal(18,4)=0.00 ,@NCXOP_NaturalGas2M_Old decimal(18,4)=0.00, 
@NCXOP_ALL1M_Old decimal(18,4)=0.00 ,@NCXOP_ALL2M_Old decimal(18,4)=0.00, 

@clientcount as int=0,@pcount as int=1,@M_pcode as varchar(10)=''
DECLARE @emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)   

declare @ClientEmail as varchar(50)='',@ClientName as varchar(100)='',@SBCode as varchar(100),
@emp_email_CC as varchar(100)

--exec angelnsecm.msajag.dbo.Brokerge_allDate

SELECT @emailto='nilesh@angelbroking.com'         
SELECT @emailcc='hrishikesh.yerunkar@angelbroking.com'
SELECT @emailbcc='brokerage.intimation@angelbroking.com'           
  DECLARE @MessBody NVARCHAR(MAX) 
  set @MessBody=''
--select distinct * into  #Client1 from angelNSECM.msajag.dbo.Brokerage_ForMail with(nolock) where party_code in 
--(select party_Code from dustbin.dbo.Brok_Client_forMail with(nolock))

select distinct * into  #Client1 from angelNSECM.msajag.dbo.Brokerage_ForMail with(nolock) where party_code =@CODE

select ROW_NUMBER() OVER ( ORDER BY party_code) AS Srno,* into #Client from #Client1

select distinct party_code into #party1 from #Client -- where party_code='POTR1008'
select  ROW_NUMBER() OVER ( ORDER BY party_code) AS Srno,* into #party from #party1
select @clientcount=COUNT(1) from #party

while    @pcount<=   @clientcount
begin

select @M_pcode=party_code from #party where SrNo=@pcount
--select @ClientEmail=email,@ClientName=long_name from RISK.DBO.client_details where party_code=@M_pcode
SELECT @ClientEmail=email,@ClientName=long_name FROM ANGELNSECM.MSAJAG.DBO.CLIENT_DETAILS WHERE PARTY_CODE=@M_pcode

--------------BSE CASH--------------- 
 select @BSEM1=isnull(FRIST_LEG_MIN_NEW,0),@BSEP1=isnull(FRIST_LEG_MAX_NEW,0),@BSEM2=isnull(SECOND_LEG_MIN_NEW,0),
@BSEP2=isnull(SECOND_LEG_MAX_NEW,0),@BSEM1_Old=isnull(FRIST_LEG_MIN_OLD,0),@BSEP1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@BSEM2_Old=isnull(SECOND_LEG_MIN_OLD,0),@BSEP2_Old=isnull(SECOND_LEG_MAX_OLD,0)
	from #Client with(nolock) where  segment='BSE CASH' and scheme_type='TRD' and party_code=@M_pcode

select	@BSEMDEL=isnull(FRIST_LEG_MIN_NEW,0),@BSEPDel=isnull(FRIST_LEG_MAX_NEW,0),@BSEMDEL_Old=isnull(FRIST_LEG_MIN_OLD,0),
	@BSEPDel_Old=isnull(FRIST_LEG_MAX_OLD,0)	from #Client with(nolock) where  segment='BSE CASH' 
	and scheme_type='DEL'  and party_code=@M_pcode

if(@BSEM1>0 or @BSEP1>0 or @BSEM2>0 or @BSEP2>0)
begin
create table #BSE
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 

    insert into #BSE                   
	--select '1st Leg' as Type,@BSEM1 as Min,@BSEP1 as Per
	select '1st Leg' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@BSEM1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEM1) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@BSEP1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEP1) END as Per                   

	insert into #BSE                                     
	--select '2nd Leg' as Type,@BSEM2 as Min,@BSEP2 as Per
	select '2nd Leg' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@BSEM2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEM2) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@BSEP2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEP2) END as Per

	insert into #BSE                   
	--select 'Delivery' as Type,@BSEMDEL as Min,@BSEPDel  as Per
	select 'Delivery' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@BSEMDEL)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEMDEL) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@BSEPDel)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEPDel) END  as Per

	create table #BSE_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #BSE_OLD                   
	--select '1st Leg' as Type,@BSEM1_Old as Min,@BSEP1_OLd as Per  
	select '1st Leg' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@BSEM1_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEM1_Old) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@BSEP1_OLd)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEP1_OLd) END as Per         

	insert into #BSE_OLD                                     
	--select '2nd Leg' as Type,@BSEM2_Old as Min,@BSEP2_old as Per
	select '2nd Leg' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@BSEM2_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEM2_Old) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@BSEP2_old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEP2_old) END as Per

	insert into #BSE_OLD                   
	--select 'Delivery' as Type,@BSEMDEL_Old as Min,@BSEPDel_old  as Per   
	select 'Delivery' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@BSEMDEL_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEMDEL_Old) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@BSEPDel_old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEPDel_old) END as Per   

		  declare @Count int,@CountEnd int,@Type as varchar(20)='',@Min as varchar(50),@Per as varchar(50)
	  declare @MESS NVARCHAR(MAX)
	  declare @MESSBSE NVARCHAR(MAX) =''     
	  DECLARE @xml NVARCHAR(MAX)              
	   DECLARE @Data NVARCHAR(MAX) ,  @totctrOT as int=0          
	           
		set @Data=''                
 		set @MESS=''          
		set @Count=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa from #BSE          
		 SELECT @totctrOT=count(1) from #aa           
	   SET @MESS=                            
	   '<table border="1" cellpadding="2" cellspacing="2">
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr>                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min  </th>                            
		   <th  align="center"> Per(%)   </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @Count <= @totctrOT                              
		 BEGIN                        
		  SELECT @Type=Type, @Min=Min,@Per=Per FROM #aa WHERE Srno=@count                                   
		  set @Data=@Data+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @Count=@Count+1                                    
		 END
		 SET @MESS= @MESS + @Data +'</Table>' 
  declare @Count_OLD int,@CountEnd_OLD int,@Type_OLD as varchar(20)='',@Min_OLD as varchar(50),@Per_OLD as varchar(50)
	  declare @MESS_OLD NVARCHAR(MAX)     
	  DECLARE @xml_OLD NVARCHAR(MAX)              
	   DECLARE @Data_OLD NVARCHAR(MAX) ,  @totctrOT_OLD as int=0          
	           
		set @Data_OLD=''                
		                        
		set @MESS_OLD=''          
		set @Count_OLD=1                                    
	              
	              
		select  row_number()over (order by Type_OLD ) As Srno,Type_OLD ,Min_OLD ,Per_OLD  into #aa_Old from #BSE_OLD          
		 SELECT @totctrOT_OLD=count(1) from #aa_Old           
	   SET @MESS_OLD=                            
	   '<table border="1" cellpadding="2" cellspacing="2">
	   <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min </th>                            
		   <th  align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @Count_OLD <= @totctrOT_OLD                              
		 BEGIN                        
		  SELECT @Type_OLD=Type_OLD, @Min_OLD=Min_OLD,@Per_OLD=Per_OLD FROM #aa_OLD WHERE Srno=@count_OLD                                   
		  set @Data_OLD=@Data_OLD+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type_OLD) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min_OLD) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per_OLD) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @Count_OLD=@Count_OLD+1                                    
		 END
		 
		 SET @MESS_OLD=  @MESS_OLD + @Data_OLD +'</Table>'
		 --print @MESS
		 --set @MESSBSE='<Br><B>BSECM</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS_OLD + '</td><td> '+ @MESS +'</td></tr></Table>'            
				 set @MESSBSE='<Br><B>BSECM</B> <Br><Br>'+ '<Table> <tr> <td> '+ @MESS +'</td></tr></Table>'            


IF OBJECT_ID('tempdb..#BSE', 'U') IS NOT NULL
    DROP TABLE #BSE
IF OBJECT_ID('tempdb..#aa', 'U') IS NOT NULL
    DROP TABLE #aa
IF OBJECT_ID('tempdb..#BSE_Old', 'U') IS NOT NULL
drop table #BSE_Old
IF OBJECT_ID('tempdb..#aa_Old', 'U') IS NOT NULL
drop table #aa_Old
end
--------------NSE CASH--------------- 
 select @NSEM1=isnull(FRIST_LEG_MIN_NEW,0),@NSEP1=isnull(FRIST_LEG_MAX_NEW,0),@NSEM2=isnull(SECOND_LEG_MIN_NEW,0),
@NSEP2=isnull(SECOND_LEG_MAX_NEW,0),@NSEM1_Old=isnull(FRIST_LEG_MIN_OLD,0),@NSEP1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@NSEM2_Old=isnull(SECOND_LEG_MIN_OLD,0),@NSEP2_Old=isnull(SECOND_LEG_MAX_OLD,0)
	from #Client with(nolock) where  segment='NSE CASH' and scheme_type='TRD' and party_code=@M_pcode

select	@NSEMDEL=isnull(FRIST_LEG_MIN_NEW,0),@NSEPDel=isnull(FRIST_LEG_MAX_NEW,0),@NSEMDEL_Old=isnull(FRIST_LEG_MIN_OLD,0),
	@NSEPDel_Old=isnull(FRIST_LEG_MAX_OLD,0)	from #Client with(nolock) where  segment='NSE CASH' 
	and scheme_type='DEL'  and party_code=@M_pcode

if(@NSEM1>0 or @NSEP1>0 or @NSEM2>0 or @NSEP2>0)
begin
create table #NSE
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 

    insert into #NSE                   
	--select '1st Leg' as Type,@NSEM1 as Min,@NSEP1 as Per 
	select '1st Leg' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@NSEM1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEM1) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@NSEP1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEP1) END as Per          

	insert into #NSE                                     
	--select '2nd Leg' as Type,@NSEM2 as Min,@NSEP2 as Per
	select '2nd Leg' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@NSEM2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEM2) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@NSEP2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEP2) END as Per

	insert into #NSE                   
	--select 'Delivery' as Type,@NSEMDEL as Min,@NSEPDel  as Per
	select 'Delivery' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@NSEMDEL)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEMDEL) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@NSEPDel)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEPDel) END as Per

	create table #NSE_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #NSE_OLD                   
	--select '1st Leg' as Type,@NSEM1_Old as Min,@NSEP1_OLd as Per 
	select '1st Leg' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@NSEM1_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEM1_Old) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@NSEP1_OLd)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEP1_OLd) END as Per           

	insert into #NSE_OLD                                     
	--select '2nd Leg' as Type,@NSEM2_Old as Min,@NSEP2_old as Per
	select '2nd Leg' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@NSEM2_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEM2_Old) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@NSEP2_old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEP2_old) END as Per

	insert into #NSE_OLD                   
	--select 'Delivery' as Type,@NSEMDEL_Old as Min,@NSEPDel_old  as Per  
	select 'Delivery' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@NSEMDEL_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEMDEL_Old) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@NSEPDel_old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEPDel_old) END as Per  

		  declare @Count_NSE int,@CountEnd_NSE int,@Type_NSE as varchar(20)='',@Min_NSE as varchar(50),@Per_NSE as varchar(50)
	  declare @MESS_NSE NVARCHAR(MAX)
	  declare @MESSNSE NVARCHAR(MAX) =''     
	  DECLARE @xml_NSE NVARCHAR(MAX)              
	   DECLARE @Data_NSE NVARCHAR(MAX) ,  @totctrOT_NSE as int=0          
	           
		set @Data_NSE=''                
 		set @MESS_NSE=''          
		set @Count_NSE=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa_NSE from #NSE          
		 SELECT @totctrOT_NSE=count(1) from #aa_NSE           
	   SET @MESS_NSE=                            
	   '<table border="1" cellpadding="2" cellspacing="2">
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr>                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min  </th>                            
		   <th  align="center"> Per(%)   </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @Count_NSE <= @totctrOT_NSE                              
		 BEGIN                        
		  SELECT @Type_NSE=Type, @Min_NSE=Min,@Per_NSE=Per FROM #aa_NSE WHERE Srno=@count_NSE                                   
		  set @Data_NSE=@Data_NSE+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type_NSE) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min_NSE) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per_NSE) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @Count_NSE=@Count_NSE+1                                    
		 END
		 SET @MESS_NSE= @MESS_NSE + @Data_NSE +'</Table>' 
  declare @Count_OLD_NSE int,@CountEnd_OLD_NSE int,@Type_OLD_NSE as varchar(20)='',@Min_OLD_NSE as varchar(50),@Per_OLD_NSE as varchar(50)
	  declare @MESS_OLD_NSE NVARCHAR(MAX)     
	  DECLARE @xml_OLD_NSE NVARCHAR(MAX)              
	   DECLARE @Data_OLD_NSE NVARCHAR(MAX) ,  @totctrOT_OLD_NSE as int=0          
	           
		set @Data_OLD_NSE=''                
		                        
		set @MESS_OLD_NSE=''          
		set @Count_OLD_NSE=1                                    
	              
	              
		select  row_number()over (order by Type_OLD ) As Srno,Type_OLD ,Min_OLD ,Per_OLD  into #aa_NSE_Old from #NSE_OLD          
		 SELECT @totctrOT_OLD_NSE=count(1) from #aa_NSE_Old           
	   SET @MESS_OLD_NSE=                            
	   '<table border="1" cellpadding="2" cellspacing="2">
	   <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min </th>                            
		   <th  align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @Count_OLD_NSE <= @totctrOT_OLD_NSE                              
		 BEGIN                        
		  SELECT @Type_OLD_NSE=Type_OLD, @Min_OLD_NSE=Min_OLD,@Per_OLD_NSE=Per_OLD FROM #aa_NSE_OLD WHERE Srno=@count_OLD_NSE                                   
		  set @Data_OLD_NSE=@Data_OLD_NSE+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type_OLD_NSE) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min_OLD_NSE) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per_OLD_NSE) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @Count_OLD_NSE=@Count_OLD_NSE+1                                    
		 END
		 
		 SET @MESS_OLD_NSE=  @MESS_OLD_NSE + @Data_OLD_NSE +'</Table>'
		 --print @MESS
		 --set @MESSNSE='<Br><B>NSECM</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS_OLD_NSE + '</td><td> '+ @MESS_NSE+'</td></tr></Table>'            
		 set @MESSNSE='<Br><B>NSECM</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS_NSE+'</td></tr></Table>'            

IF OBJECT_ID('tempdb..#NSE', 'U') IS NOT NULL
    DROP TABLE #NSE
IF OBJECT_ID('tempdb..#aa_NSE', 'U') IS NOT NULL
    DROP TABLE #aa_NSE
IF OBJECT_ID('tempdb..#NSE_Old', 'U') IS NOT NULL
drop table #NSE_Old
IF OBJECT_ID('tempdb..#aa_NSE_Old', 'U') IS NOT NULL
drop table #aa_NSE_Old
end
----------------------NSEFO-------------------------
select @NSEFOFMin=isnull(Frist_Leg_min_New,0),@NSEFOFFu=isnull(Frist_Leg_max_New,0),@NSEFOSMin=isnull(Second_Leg_Min_New,0),
@NSEFOSFu=isnull(Second_Leg_max_New,0)
	from  #Client with(nolock) where  segment='NSE FO' and scheme_type='TRD' and party_code=@M_pcode

select	@NSEFOFMin_Old=isnull(FRIST_LEG_MAX_OLD,0),@NSEFOFFu_Old=isnull(FRIST_LEG_MIN_OLD,0),@NSEFOSMin_Old=isnull(SECOND_LEG_MIN_OLD,0),
	@NSEFOSFu_Old=isnull(SECOND_LEG_MAX_OLD,0)	from #Client with(nolock) where  segment='NSE FO'  and party_code=@M_pcode
	and scheme_type='TRD'
---------------------------
if(@NSEFOFMin>0 or @NSEFOFFu>0 or @NSEFOSMin>0 or @NSEFOSFu>0)
begin
	create table #NSEFO
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 
	insert into #NSEFO                   
	--select '1st Leg' as Type,@NSEFOFMin as Min,@NSEFOFFu as Per  
	select '1st Leg' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@NSEFOFMin)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOFMin) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@NSEFOFFu)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOFFu) END as Per         

	insert into #NSEFO                                     
	--select '2nd Leg' as Type,@NSEFOSMin as Min,@NSEFOSFu as Per
	select '2nd Leg' as Type,
	CASE WHEN CONVERT(VARCHAR(20),@NSEFOSMin)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOSMin) END as Min,
	CASE WHEN CONVERT(VARCHAR(20),@NSEFOSFu)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOSFu) END as Per
	
	create table #NSEFO_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #NSEFO_OLD                   
	--select '1st Leg' as Type,@NSEFOFMin_Old as Min,@NSEFOFFu_Old as Per   
	select '1st Leg' as Type, 
	CASE WHEN CONVERT(VARCHAR(20),@NSEFOFMin_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOFMin_Old) END as Min, 
	CASE WHEN CONVERT(VARCHAR(20),@NSEFOFFu_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOFFu_Old) END as Per
	
	insert into #NSEFO_OLD                                     
	--select '2nd Leg' as Type,@NSEFOSMin_Old as Min,@NSEFOSFu_Old as Per
	select '2nd Leg' as Type, 
	CASE WHEN CONVERT(VARCHAR(20),@NSEFOSMin_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOSMin_Old) END as Min, 
	CASE WHEN CONVERT(VARCHAR(20),@NSEFOSFu_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOSFu_Old) END as Per

           
	  declare @CountNSEFO int,@CountEndNSEFO1 int,@Type2 as varchar(20)='',@Min2 as varchar(50),@Per2 as varchar(50)           
	  DECLARE @MessBody2 NVARCHAR(MAX) ,@MESS2 NVARCHAR(MAX) ,@Mess2_NSEFO  NVARCHAR(MAX)                       
	   DECLARE @Data2 NVARCHAR(MAX) ,  @totctrOTNSEFO as int=0          
	           
		set @Data2=''                
		--set @MessBody=''                          
		set @MESS2='' 
		set @Mess2_NSEFO=''         
		set @CountNSEFO=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa2 from #NSEFO          
		 SELECT @totctrOTNSEFO=count(1) from #aa2           
	   SET @MESS2=                            
	   '<table border="1" cellpadding="2" cellspacing="2">                            
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr> 
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountNSEFO <= @totctrOTNSEFO                              
		 BEGIN                        
		  SELECT @Type2=Type, @Min2=Min,@Per2=Per FROM #aa2 WHERE Srno=@CountNSEFO                                   
		  set @Data2=@Data2+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type2) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min2) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per2) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountNSEFO=@CountNSEFO+1                                    
		 END             
  SET @MESS2= @MESS2 + @Data2 +'</Table>' 
  
  declare @CountNSEFO_Old int,@CountEndNSEFO1_Old int,@Type2_Old as varchar(20)='',@Min2_Old as varchar(50),@Per2_Old as varchar(50)           
	  DECLARE @MessBody2_Old NVARCHAR(MAX) ,@MESS2_Old NVARCHAR(MAX)                        
	   DECLARE @Data2_Old NVARCHAR(MAX) ,  @totctrOTNSEFO_Old as int=0          
	           
		set @Data2_Old=''                
		--set @MessBody=''                          
		set @MESS2_Old=''          
		set @CountNSEFO_Old=1                                    
	              
	              
		select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa2_Old from #NSEFO_Old          
		 SELECT @totctrOTNSEFO_Old=count(1) from #aa2_Old           
	   SET @MESS2_Old=                            
	   '<table border="1" cellpadding="2" cellspacing="2"> 
	    <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountNSEFO_Old <= @totctrOTNSEFO_Old                              
		 BEGIN                        
		  SELECT @Type2_Old=Type_Old, @Min2_Old=Min_Old,@Per2_Old=Per_Old FROM #aa2_Old WHERE Srno=@CountNSEFO_Old                                   
		  set @Data2_Old=@Data2_Old+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type2_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min2_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per2_Old) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountNSEFO_Old=@CountNSEFO_Old+1                                    
		 END             
  SET @MESS2_Old= @MESS2_Old + @Data2_Old +'</Table>'  
   --set @Mess2_NSEFO='<Br><B>NSEFO</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS2_Old + '</td><td> '+ @MESS2 +'</td></tr></Table>'  
    set @Mess2_NSEFO='<Br><B>NSEFO</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS2 +'</td></tr></Table>'  

IF OBJECT_ID('tempdb..#NSEFO', 'U') IS NOT NULL
DROP TABLE #NSEFO
IF OBJECT_ID('tempdb..#aa2', 'U') IS NOT NULL
DROP TABLE #aa2
IF OBJECT_ID('tempdb..#NSEFO_Old', 'U') IS NOT NULL
drop table #NSEFO_Old
IF OBJECT_ID('tempdb..#aa2_Old', 'U') IS NOT NULL
drop table #aa2_Old
end
-----------------------NSEFO Option--------------------------------------
set @NSEFOOS1=0.00
set @NSEFOOS2=0.00
select @NSEFOOS1=isnull(FRIST_LEG_MAX_NEW,0),@NSEFOOS2=isnull(SECOND_LEG_MAX_NEW,0),@NSEFOOS1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@NSEFOOS2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='NSE OPT' and scheme_type='ALL'
 and party_code=@M_pcode

select @NSEFOON1=isnull(FRIST_LEG_MAX_NEW,0),@NSEFOON2=isnull(SECOND_LEG_MAX_NEW,0),@NSEFOON1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@NSEFOON2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='NSE OPT' and scheme_type='NIFTY'
 and party_code=@M_pcode

select @NSEFOOB1=isnull(FRIST_LEG_MAX_NEW,0),@NSEFOOB2=isnull(SECOND_LEG_MAX_NEW,0),@NSEFOOB1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@NSEFOOB2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='NSE OPT' and scheme_type='BANKNIFTY'
 and party_code=@M_pcode

select @NSEFOOFN1=isnull(FRIST_LEG_MAX_NEW,0),@NSEFOOFN2=isnull(SECOND_LEG_MAX_NEW,0),@NSEFOOFN1_Old=isnull(FRIST_LEG_MAX_OLD,0)
,@NSEFOOFN2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='NSE OPT' and scheme_type='FINNIFTY'


select @NSEFOOMCN1=isnull(FRIST_LEG_MAX_NEW,0),@NSEFOOMCN2=isnull(SECOND_LEG_MAX_NEW,0),@NSEFOOMCN1_Old=isnull(FRIST_LEG_MAX_OLD,0)
,@NSEFOOMCN2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='NSE OPT' and scheme_type='MIDCPNIFTY'
 and party_code=@M_pcode

if(@NSEFOOS1>0 or @NSEFOOS2>0 or @NSEFOON1>0 or @NSEFOON2>0 or @NSEFOOB1>0 or @NSEFOOB2>0 or @NSEFOOFN1>0 or @NSEFOOFN2>0 or
 @NSEFOOMCN1>0 or @NSEFOOMCN2>0)
begin
print 'atharva'
print @NSEFOOS1
print 'klj'
create table #NSEFOOpt
(
Type  varchar(50),
Stock  varchar(50),
Nifty  varchar(50),
BankNifty  varchar(50),
FinNifty  varchar(50),
MidCPNifty varchar(50)
) 
--insert into #NSEFOOpt                   
--select '1st Leg' as Type,@NSEFOOS1 as Stock ,@NSEFOON1 as Nifty, @NSEFOOB1 as BankNifty,@NSEFOOFN1 as FinNifty,@NSEFOOMCN1 as MidCPNifty       

--insert into #NSEFOOpt                                     
--select '2nd Leg' as Type,@NSEFOOS2 as Stock ,@NSEFOON2 as Nifty, @NSEFOOB2 as BankNifty,@NSEFOOFN2 as FinNifty,@NSEFOOMCN2 as MidCPNifty  

insert into #NSEFOOpt 
select '1st Leg' as Type,
CASE WHEN CONVERT(VARCHAR(20),@NSEFOOS1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOOS1) END as Stock ,
CASE WHEN CONVERT(VARCHAR(20),@NSEFOON1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOON1) END as Nifty, 
CASE WHEN CONVERT(VARCHAR(20),@NSEFOOB1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOOB1) END as BankNifty,
CASE WHEN CONVERT(VARCHAR(20),@NSEFOOFN1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOOFN1) END as FinNifty, 
CASE WHEN CONVERT(VARCHAR(20),@NSEFOOMCN1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOOMCN1) END as MidCPNifty        

insert into #NSEFOOpt                                     
select '2nd Leg' as Type,
CASE WHEN CONVERT(VARCHAR(20),@NSEFOOS2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOOS2) END as Stock ,
CASE WHEN CONVERT(VARCHAR(20),@NSEFOON2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOON2) END as Nifty, 
CASE WHEN CONVERT(VARCHAR(20),@NSEFOOB2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOOB2) END as BankNifty,
CASE WHEN CONVERT(VARCHAR(20),@NSEFOOFN2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOOFN2) END as FinNifty, 
CASE WHEN CONVERT(VARCHAR(20),@NSEFOOMCN2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSEFOOMCN2) END as MidCPNifty

--create table #NSEFOOpt_Old
--(
--Type_Old  varchar(50),
--Stock_Old  varchar(50),
--Nifty_Old  varchar(50),
--BankNifty_Old  varchar(50),
--FinNifty_Old  varchar(50),
--MidCPNifty_old  varchar(50)
--) 
--insert into #NSEFOOpt_Old                   
--select '1st Leg' as Type_Old,@NSEFOOS1_Old as Stock_Old ,@NSEFOON1_Old as Nifty_Old, @NSEFOOB1_Old as BankNifty_Old,
--@NSEFOOFN1_Old as FinNifty_Old,@NSEFOOMCN1_Old as MidCPNifty_old

--insert into #NSEFOOpt_Old                                     
--select '2nd Leg' as Type_Old,@NSEFOOS2_Old as Stock_Old ,@NSEFOON2_Old as Nifty_Old, @NSEFOOB2_Old as BankNifty_Old,
--@NSEFOOFN2_Old as FinNifty_Old,@NSEFOOMCN2_Old as MidCPNifty_old
            
  declare @Count7 int,@CountEnd7 int,@Type7 as varchar(20)='',@stock as varchar(50),@nifty as varchar(50),@Banknifty as varchar(50)
  ,@Finnifty as varchar(50),@midcpnifty as varchar(50)
  DECLARE @MessBody7 NVARCHAR(MAX) ,@MESS7 NVARCHAR(MAX) ,@Mess7_NSEFOOpt NVARCHAR(MAX)        
  DECLARE @xml7 NVARCHAR(MAX)              
   DECLARE @Data7 NVARCHAR(MAX) ,  @totctrOT7 as int=0          
           
    set @Data7=''                
    set @MessBody7=''                          
    set @MESS7=''          
    set @Count7=1  
    set @Mess7_NSEFOOpt=''                                  
              
              
    select  row_number()over (order by Type) As Srno,Type,Stock,Nifty,BankNifty,FinNifty,MidCPNifty into #aa7 from #NSEFOOpt          
     SELECT @totctrOT7=count(1) from #aa7           
   SET @MESS7=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
      <tr><th  align="center" colspan="6">New Brokerage </th>
	   </tr>                           
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Stock Rs./Lot </th>                                                                                 
       <th align="center"> Nifty Rs./Lot </th>
       <th align="center"> Bank Nifty Rs./Lot </th>
       <th align="center"> Fin Nifty Rs./Lot </th>
	   <th align="center"> MidCP Nifty Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count7 <= @totctrOT7                              
     BEGIN  
	 set @stock=0.00
	 set @nifty=0.00
	 set @Banknifty=0.00
	 set @Finnifty=0.00
	 set @midcpnifty=0.00
	
      SELECT @Type7=Type,@stock=Stock,@nifty=Nifty,@Banknifty=BankNifty,@Finnifty=FinNifty,@midcpnifty=MidCPNifty FROM #aa7 WHERE Srno=@count7                                   
      set @Data7=@Data7+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type7) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@stock) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@nifty) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@Banknifty) +' </td>                                                                      
         <td align="center"> '+ CONVERT(VARCHAR,@Finnifty) +' </td>  
         <td align="center"> '+ CONVERT(VARCHAR,@midcpnifty) +' </td>                                                                      		 
       </tr>' 
	   print 'nn'
	   print @stock
	   print 'yy'
       print @Data7                         
      SET   @Count7=@Count7+1                                    
     END   
     SET @MESS7= @MESS7 + @Data7 +'</Table>'
     print  @MESS7 
     
--declare @Count7_Old int,@CountEnd7_Old int,@Type7_Old as varchar(20)='',@stock_Old as varchar(50),
--@nifty_Old as varchar(50),@Banknifty_Old as varchar(50) ,@finnifty_Old as varchar(50),@midcpnifty_old as varchar(50)         
--  DECLARE @MessBody7_Old NVARCHAR(MAX) ,@MESS7_Old NVARCHAR(MAX)         
--  DECLARE @xml7_Old NVARCHAR(MAX)              
--   DECLARE @Data7_Old NVARCHAR(MAX) ,  @totctrOT7_Old as int=0          
           
--    set @Data7_Old=''                
--    set @MessBody7_Old=''                          
--    set @MESS7_Old=''          
--    set @Count7_Old=1                                    
              
              
--    select  row_number()over (order by Type_Old) As Srno,Type_Old,Stock_Old,Nifty_Old,BankNifty_Old,FinNifty_Old,
--	MidCPNifty_old into #aa7_Old from #NSEFOOpt_Old          
--     SELECT @totctrOT7_Old=count(1) from #aa7_Old           
--   SET @MESS7_Old=                            
--   '<table border="1" cellpadding="2" cellspacing="2">  
--      <tr><th  align="center" colspan="6">Old Brokerage </th>
--	   </tr>                           
--   <tr>                       
--    <th align="center"> Type </th>                            
--       <th align="center"> Stock Rs./Lot </th>                                                                                 
--       <th align="center"> Nifty Rs./Lot </th>
--       <th align="center"> Bank Nifty Rs./Lot </th>
--       <th align="center"> Fin Nifty Rs./Lot </th>
--	          <th align="center"> MidCP Nifty Rs./Lot </th>
--   </tr>'          
----print @MESS          
--   WHILE @Count7_Old <= @totctrOT7_Old                              
--     BEGIN                        
--      SELECT @Type7_Old=Type_Old,@stock_Old=Stock_Old,@nifty_Old=Nifty_Old,@Banknifty_Old=BankNifty_Old,
--	  @finnifty_Old=FinNifty_Old,@midcpnifty_old=MidCPNifty_old FROM #aa7_Old WHERE Srno=@count7_Old                                   
--      set @Data7_Old=@Data7_Old+                           
--     '<tr>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@Type7_Old) +' </td>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@stock_Old) +' </td>   
--       <td align="center"> '+ CONVERT(VARCHAR,@nifty_Old) +' </td>   
--         <td align="center"> '+ CONVERT(VARCHAR,@Banknifty_Old) +' </td>                                                                      
--         <td align="center"> '+ CONVERT(VARCHAR,@finnifty_Old) +' </td>  
--		          <td align="center"> '+ CONVERT(VARCHAR,@midcpnifty_old) +' </td>                                                                      
--       </tr>'           
--       print @Data7_Old                         
--      SET   @Count7_Old=@Count7_Old+1                                    
--     END   
--     SET @MESS7_Old=@MESS7_Old + @Data7_Old +'</Table>' 
     --set @Mess7_NSEFOOpt='<Br><B>NSEFO Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS7_OLD + '</td><td> '+ @MESS7 +'</td></tr></Table>'          
     set @Mess7_NSEFOOpt='<Br><B>NSEFO Option</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS7 +'</td></tr></Table>'          
 
IF OBJECT_ID('tempdb..#NSEFOOpt', 'U') IS NOT NULL
DROP TABLE #NSEFOOpt
IF OBJECT_ID('tempdb..#aa7', 'U') IS NOT NULL
DROP TABLE #aa7
IF OBJECT_ID('tempdb..#NSEFOOpt_Old', 'U') IS NOT NULL
drop table #NSEFOOpt_Old
IF OBJECT_ID('tempdb..#aa7_Old', 'U') IS NOT NULL
drop table #aa7_Old
end
------------------MCX-------------------

	select @MCX1M=isnull(FRIST_LEG_MIN_NEW,0),@MCX1Fu=isnull(FRIST_LEG_MAX_NEW,0),@MCX2M=isnull(SECOND_LEG_MIN_NEW,0),
	@MCX2Fu=isnull(SECOND_LEG_MAX_NEW,0), @MCX1M_Old=ISNULL(Frist_Leg_min_Old,0),@MCX1Fu_Old=ISNULL(Frist_Leg_max_Old,0),
	@MCX2M_Old=ISNULL(Second_Leg_Min_Old,0),@MCX2Fu_Old=ISNULL(Second_Leg_max_Old,0)	from #Client with(nolock) where 
	segment='MCDX' and scheme_type='TRD' 
	and party_code=@M_pcode

if(@MCX1M>0 or @MCX1Fu>0 or @MCX2M>0 or @MCX2Fu>0)
begin
create table #MCX
(
Type  varchar(50),
Min  varchar(50),
Per  varchar(50)
) 
insert into #MCX                   
--select '1st Leg' as Type,@MCX1M as Min,@MCX1Fu as Per   
select '1st Leg' as Type,
CASE WHEN CONVERT(VARCHAR(20),@MCX1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCX1M) END as Min, 
CASE WHEN CONVERT(VARCHAR(20),@MCX1Fu)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCX1Fu) END as Per         

insert into #MCX                                     
--select '2nd Leg' as Type,@MCX2M as Min,@MCX2Fu as Per
select '2nd Leg' as Type, 
CASE WHEN CONVERT(VARCHAR(20),@MCX2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCX2M) END as Min,
CASE WHEN CONVERT(VARCHAR(20),@MCX2Fu)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCX2Fu) END as Per

create table #MCX_Old
(
Type_Old  varchar(50),
Min_Old  varchar(50),
Per_Old  varchar(50)
) 
insert into #MCX_Old                   
--select '1st Leg' as Type_Old,@MCX1M_Old as Min_Old,@MCX1Fu_Old as Per_Old 
select '1st Leg' as Type_Old, 
CASE WHEN CONVERT(VARCHAR(20),@MCX1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCX1M_Old) END as Min_Old, 
CASE WHEN CONVERT(VARCHAR(20),@MCX1Fu_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCX1Fu_Old) END as Per_Old            

insert into #MCX_Old                                     
--select '2nd Leg' as Type_Old,@MCX2M_Old as Min_Old,@MCX2Fu_Old as Per_Old
select '2nd Leg' as Type_Old, 
CASE WHEN CONVERT(VARCHAR(20),@MCX2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCX2M_Old) END as Min_Old, 
CASE WHEN CONVERT(VARCHAR(20),@MCX2Fu_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCX2Fu_Old) END as Per_Old
            
  declare @Count14 int,@CountEnd14 int,@Type14 as varchar(20)='',@Min14 as varchar(50),@Per14 as varchar(50)           
  DECLARE @MessBody14 NVARCHAR(MAX) ,@MESS14 NVARCHAR(MAX),@MESS14_MCX NVARCHAR(MAX)
  DECLARE @xml14 NVARCHAR(MAX)              
   DECLARE @Data14 NVARCHAR(MAX) ,  @totctrOT14 as int=0          
           
    set @Data14=''                
    set @MessBody14=''                          
    set @MESS14=''          
    set @Count14=1
    set @MESS14_MCX=''                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa14 from #MCX          
     SELECT @totctrOT14=count(1) from #aa14           
   SET @MESS14=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
      <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count14 <= @totctrOT14                              
     BEGIN                        
      SELECT @Type14=Type, @Min14=Min,@Per14=Per FROM #aa14 WHERE Srno=@count14                                   
      set @Data14=@Data14+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type14) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min14) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per14) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count14=@Count14+1                                    
     END 
      SET @MESS14=@MESS14 + @Data14 +'</Table>' 
            
  declare @Count14_Old int,@CountEnd14_Old int,@Type14_Old as varchar(20)='',@Min14_Old as varchar(50),@Per14_Old as varchar(50)           
  DECLARE @MessBody14_Old NVARCHAR(MAX) ,@MESS14_Old NVARCHAR(MAX)
  DECLARE @xml14_Old NVARCHAR(MAX)              
   DECLARE @Data14_Old NVARCHAR(MAX) ,  @totctrOT14_Old as int=0          
           
    set @Data14_Old=''                
    set @MessBody14_Old=''                          
    set @MESS14_Old=''          
    set @Count14_Old=1
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa14_Old from #MCX_Old          
     SELECT @totctrOT14_Old=count(1) from #aa14_Old           
   SET @MESS14_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">
      <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count14_Old <= @totctrOT14_Old                              
     BEGIN                        
      SELECT @Type14_Old=Type_Old, @Min14_Old=Min_Old,@Per14_Old=Per_Old FROM #aa14_Old WHERE Srno=@count14_Old                                   
      set @Data14_Old=@Data14_Old+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type14_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min14_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per14_Old) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count14_Old=@Count14_Old+1                                    
     END 
      SET @MESS14_Old=@MESS14_Old + @Data14_Old +'</Table>' 
      --set @MESS14_MCX='<Br><B>MCX</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS14_Old + '</td><td> '+ @MESS14 +'</td></tr></Table>'
      set @MESS14_MCX='<Br><B>MCX</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS14 +'</td></tr></Table>'
   
IF OBJECT_ID('tempdb..#MCX', 'U') IS NOT NULL
DROP TABLE #MCX
IF OBJECT_ID('tempdb..#aa14', 'U') IS NOT NULL
DROP TABLE #aa14
IF OBJECT_ID('tempdb..#MCX_Old', 'U') IS NOT NULL
drop table #MCX_Old
IF OBJECT_ID('tempdb..#aa14_Old', 'U') IS NOT NULL
drop table #aa14_Old
end
---------------------NCE-----------------------------

 	select @NCE1M=isnull(FRIST_LEG_MIN_NEW,0),@NCE1Fu=isnull(FRIST_LEG_MAX_NEW,0),@NCE2M=isnull(SECOND_LEG_MIN_NEW,0),
	@NCE2Fu=isnull(SECOND_LEG_MAX_NEW,0),@NCE1M_Old=ISNULL(Frist_Leg_min_Old,0),@NCE1Fu_Old=ISNULL(Frist_Leg_max_Old,0),
	@NCE2M_Old=ISNULL(Second_Leg_Min_Old,0),@NCE2Fu_Old=ISNULL(Second_Leg_max_Old,0)
	from #Client with(nolock) where 
	segment='NCE' and scheme_type='TRD' 
	and party_code=@M_pcode  

if(@NCE1M>0 or @NCE1Fu>0 or @NCE2M>0 or @NCE2Fu>0)
begin
create table #NCE
(
Type  varchar(50),
Min  varchar(50),
Per  varchar(50)
) 
insert into #NCE                   
--select '1st Leg' as Type,@NCE1M as Min,@NCE1Fu as Per       
select '1st Leg' as Type, 
CASE WHEN CONVERT(VARCHAR(20),@NCE1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCE1M) END as Min,
CASE WHEN CONVERT(VARCHAR(20),@NCE1Fu)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCE1Fu) END as Per            

insert into #NCE                                     
--select '2nd Leg' as Type,@NCE2M as Min,@NCE2Fu as Per
select '2nd Leg' as Type, 
CASE WHEN CONVERT(VARCHAR(20),@NCE2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCE2M) END as Min, 
CASE WHEN CONVERT(VARCHAR(20),@NCE2Fu)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCE2Fu) END as Per

create table #NCE_Old
(
Type_Old  varchar(50),
Min_Old  varchar(50),
Per_Old  varchar(50)
) 
insert into #NCE_Old                   
--select '1st Leg' as Type_Old,@NCE1M_Old as Min_Old,@NCE1Fu_Old as Per_Old  
select '1st Leg' as Type_Old, 
CASE WHEN CONVERT(VARCHAR(20),@NCE1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCE1M_Old) END as Min_Old, 
CASE WHEN CONVERT(VARCHAR(20),@NCE1Fu_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCE1Fu_Old) END as Per_Old           

insert into #NCE_Old                                     
--select '2nd Leg' as Type_Old,@NCE2M_Old as Min_Old,@NCE2Fu_Old as Per_Old
select '2nd Leg' as Type_Old, 
CASE WHEN CONVERT(VARCHAR(20),@NCE2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCE2M_Old) END as Min_Old, 
CASE WHEN CONVERT(VARCHAR(20),@NCE2Fu_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCE2Fu_Old) END as Per_Old
            
  declare @Count145 int,@CountEnd145 int,@Type145 as varchar(20)='',@Min145 as varchar(50),@Per145 as varchar(50)           
  DECLARE @MessBody145 NVARCHAR(MAX) ,@MESS145 NVARCHAR(MAX),@MESS14_NCE NVARCHAR(MAX)
  DECLARE @xml145 NVARCHAR(MAX)              
   DECLARE @Data145 NVARCHAR(MAX) ,  @totctrOT145 as int=0          
           
    set @Data145=''                
    set @MessBody145=''                          
    set @MESS145=''          
    set @Count145=1
    set @MESS14_NCE=''                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa145 from #NCE          
     SELECT @totctrOT145=count(1) from #aa145           
   SET @MESS145=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
      <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count145 <= @totctrOT145                              
     BEGIN                        
      SELECT @Type145=Type, @Min145=Min,@Per145=Per FROM #aa145 WHERE Srno=@count145                                   
      set @Data145=@Data145+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type145) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min145) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per145) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count145=@Count145+1                                    
     END 
      SET @MESS145=@MESS145 + @Data145 +'</Table>' 
            
  declare @Count145_Old int,@CountEnd145_Old int,@Type145_Old as varchar(20)='',@Min145_Old as varchar(50),@Per145_Old as varchar(50)           
  DECLARE @MessBody145_Old NVARCHAR(MAX) ,@MESS145_Old NVARCHAR(MAX)
  DECLARE @xml145_Old NVARCHAR(MAX)              
   DECLARE @Data145_Old NVARCHAR(MAX) ,  @totctrOT145_Old as int=0          
           
    set @Data145_Old=''                
    set @MessBody145_Old=''                          
    set @MESS145_Old=''          
    set @Count145_Old=1
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa145_Old from #NCE_Old          
     SELECT @totctrOT145_Old=count(1) from #aa145_Old           
   SET @MESS145_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">
      <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count145_Old <= @totctrOT145_Old                              
     BEGIN                        
      SELECT @Type145_Old=Type_Old, @Min145_Old=Min_Old,@Per145_Old=Per_Old FROM #aa145_Old WHERE Srno=@count145_Old                                   
      set @Data145_Old=@Data145_Old+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type145_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min145_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per145_Old) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count145_Old=@Count145_Old+1                                    
     END 
      SET @MESS145_Old=@MESS145_Old + @Data145_Old +'</Table>' 
      --set @MESS14_NCE='<Br><B>NCE</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS145_Old + '</td><td> '+ @MESS145 +'</td></tr></Table>'
      set @MESS14_NCE='<Br><B>NCE</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS145 +'</td></tr></Table>'

IF OBJECT_ID('tempdb..#aa145_Old', 'U') IS NOT NULL
DROP TABLE #aa145_Old
IF OBJECT_ID('tempdb..#aa145', 'U') IS NOT NULL
DROP TABLE #aa145
IF OBJECT_ID('tempdb..#NCE', 'U') IS NOT NULL
drop table #NCE
IF OBJECT_ID('tempdb..#NCE_Old', 'U') IS NOT NULL
drop table #NCE_Old
end
-------------------NCDEX------------------------
select @NCDX1Min=isnull(FRIST_LEG_MIN_NEW,0),@NCDX1Fu=isnull(FRIST_LEG_MAX_NEW,0),@NCDX2Min=isnull(SECOND_LEG_MIN_NEW,0),
 @NCDX2Fu=isnull(SECOND_LEG_MAX_NEW,0),@NCDX1Min_Old=ISNULL(Frist_Leg_min_Old,0),@NCDX1Fu_Old=ISNULL(Frist_Leg_max_Old,0),
 @NCDX2Min_Old=ISNULL(Second_Leg_Min_Old,0),@NCDX2Fu_Old=ISNULL(Second_Leg_max_Old,0)
 from #Client with(nolock) where 
	segment='NCDX' and scheme_type='TRD' 
	and party_code=@M_pcode

if(@NCDX1Min>0 or @NCDX1Fu>0 or @NCDX2Min>0 or @NCDX2Fu>0)
begin
create table #NCDX
(
Type  varchar(50),
Min  varchar(50),
Per  varchar(50)
) 
insert into #NCDX                   
--select '1st Leg' as Type,@NCDX1Min as Min,@NCDX1Fu as Per 
select '1st Leg' as Type, 
CASE WHEN CONVERT(VARCHAR(20),@NCDX1Min)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCDX1Min) END as Min, 
CASE WHEN CONVERT(VARCHAR(20),@NCDX1Fu)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCDX1Fu) END as Per           

insert into #NCDX                                     
--select '2nd Leg' as Type,@NCDX2Min as Min,@NCDX2Fu as Per
select '2nd Leg' as Type, 
CASE WHEN CONVERT(VARCHAR(20),@NCDX2Min)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCDX2Min) END as Min, 
CASE WHEN CONVERT(VARCHAR(20),@NCDX2Fu)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCDX2Fu) END as Per

create table #NCDX_Old
(
Type_Old  varchar(50),
Min_Old  varchar(50),
Per_Old  varchar(50)
) 
insert into #NCDX_Old                   
--select '1st Leg' as Type_Old,@NCDX1Min_Old as Min_Old,@NCDX1Fu_Old as Per_Old      
select '1st Leg' as Type_Old, 
CASE WHEN CONVERT(VARCHAR(20),@NCDX1Min_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCDX1Min_Old) END as Min_Old, 
CASE WHEN CONVERT(VARCHAR(20),@NCDX1Fu_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCDX1Fu_Old) END as Per_Old              

insert into #NCDX_Old                                     
--select '2nd Leg' as Type_Old,@NCDX2Min_Old as Min_Old,@NCDX2Fu_Old as Per_Old
select '2nd Leg' as Type_Old, 
CASE WHEN CONVERT(VARCHAR(20),@NCDX2Min_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCDX2Min_Old) END as Min_Old, 
CASE WHEN CONVERT(VARCHAR(20),@NCDX2Fu_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCDX2Fu_Old) END as Per_Old
            
  declare @Count4 int,@CountEnd4 int,@Type4 as varchar(20)='',@Min4 as varchar(50),@Per4 as varchar(50)           
  DECLARE @MessBody4 NVARCHAR(MAX) ,@MESS4 NVARCHAR(MAX),@MESS4_NCDX NVARCHAR(MAX)
  DECLARE @xml4 NVARCHAR(MAX)              
   DECLARE @Data4 NVARCHAR(MAX) ,  @totctrOT4 as int=0          
           
    set @Data4=''                
    set @MessBody4=''                          
    set @MESS4=''          
    set @Count4=1
    set @MESS4_NCDX=''                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa4 from #NCDX          
     SELECT @totctrOT4=count(1) from #aa4           
   SET @MESS4=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
      <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count4 <= @totctrOT4                              
     BEGIN                        
      SELECT @Type4=Type, @Min4=Min,@Per4=Per FROM #aa4 WHERE Srno=@count4                                   
      set @Data4=@Data4+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type4) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min4) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per4) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count4=@Count4+1                                    
     END 
      SET @MESS4=@MESS4 + @Data4 +'</Table>' 
            
  declare @Count4_Old int,@CountEnd4_Old int,@Type4_Old as varchar(20)='',@Min4_Old as varchar(50),@Per4_Old as varchar(50)           
  DECLARE @MessBody4_Old NVARCHAR(MAX) ,@MESS4_Old NVARCHAR(MAX)
  DECLARE @xml4_Old NVARCHAR(MAX)              
   DECLARE @Data4_Old NVARCHAR(MAX) ,  @totctrOT4_Old as int=0          
           
    set @Data4_Old=''                
    set @MessBody4_Old=''                          
    set @MESS4_Old=''          
    set @Count4_Old=1
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa4_Old from #NCDX_Old          
     SELECT @totctrOT4_Old=count(1) from #aa4_Old           
   SET @MESS4_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">
      <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count4_Old <= @totctrOT4_Old                              
     BEGIN                        
      SELECT @Type4_Old=Type_Old, @Min4_Old=Min_Old,@Per4_Old=Per_Old FROM #aa4_Old WHERE Srno=@count4_Old                                   
      set @Data4_Old=@Data4_Old+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type4_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min4_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per4_Old) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count4_Old=@Count4_Old+1                                    
     END 
      SET @MESS4_Old=@MESS4_Old + @Data4_Old +'</Table>' 
      --set @MESS4_NCDX='<Br><B>NCDX</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS4_Old + '</td><td> '+ @MESS4 +'</td></tr></Table>'   
      set @MESS4_NCDX='<Br><B>NCDX</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS4 +'</td></tr></Table>'   

IF OBJECT_ID('tempdb..#NCDX', 'U') IS NOT NULL
DROP TABLE #NCDX
IF OBJECT_ID('tempdb..#aa4', 'U') IS NOT NULL
DROP TABLE #aa4
IF OBJECT_ID('tempdb..#NCDX_Old', 'U') IS NOT NULL
drop table #NCDX_Old
IF OBJECT_ID('tempdb..#aa4_Old', 'U') IS NOT NULL
drop table #aa4_Old
end
---------------------------NSX----------------------------
 select @NSX1=isnull(FRIST_LEG_MAX_NEW,0),@NSX2=isnull(SECOND_LEG_MAX_NEW,0),@NSX1_Old=ISNULL(Frist_Leg_max_Old,0),
  @NSX2_Old=ISNULL(Second_Leg_max_Old,0)  from #Client with(nolock) where 
	segment='NSE CURFO' and scheme_type='TRD' 
	and party_code=@M_pcode

if(@NSX1>0 or @NSX2>0)
begin
create table #NSXCurr
(
Type  varchar(50),
Future  varchar(50)
) 
insert into #NSXCurr                   
--select '1st Leg' as Type,@NSX1 as Future 
select '1st Leg' as Type, CASE WHEN CONVERT(VARCHAR(20),@NSX1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSX1) END as Future         

insert into #NSXCurr                                     
--select '2nd Leg' as Type,@NSX2 as Future             
select '2nd Leg' as Type, CASE WHEN CONVERT(VARCHAR(20),@NSX2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSX2) END as Future

create table #NSXCurr_Old
(
Type_Old  varchar(50),
Future_Old  varchar(50)
) 
insert into #NSXCurr_Old                   
select '1st Leg' as Type_Old, CASE WHEN CONVERT(VARCHAR(20),@NSX1_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSX1_Old) END as Future_Old         

insert into #NSXCurr_Old                                     
select '2nd Leg' as Type_Old, CASE WHEN CONVERT(VARCHAR(20),@NSX2_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSX2_Old) END as Future_Old
             
  declare @Count5 int,@CountEnd5 int,@Type5 as varchar(20)='',@Min5 as varchar(50),@Per5 as varchar(50)           
  DECLARE @MessBody5 NVARCHAR(MAX) ,@MESS5 NVARCHAR(MAX),@MESS5_NSX NVARCHAR(MAX)      
  DECLARE @xml5 NVARCHAR(MAX)              
   DECLARE @Data5 NVARCHAR(MAX) ,  @totctrOT5 as int=0          
           
    set @Data5=''                
    set @MessBody5=''                          
    set @MESS5=''          
    set @Count5=1                                    
	set @MESS5_NSX=''              
              
    select  row_number()over (order by Type) As Srno,Type,Future into #aa5 from #NSXCurr          
     SELECT @totctrOT5=count(1) from #aa5           
   SET @MESS5=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
   <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Future (%) </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count5 <= @totctrOT5                              
     BEGIN                        
      SELECT @Type5=Type, @Min5=Future FROM #aa5 WHERE Srno=@count5                                   
      set @Data5=@Data5+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type5) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min5) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count5=@Count5+1                                    
     END
SET @MESS5=@MESS5 + @Data5 +'</Table>' 

 declare @Count5_Old int,@CountEnd5_Old int,@Type5_Old as varchar(20)='',@Min5_Old as varchar(50),@Per5_Old as varchar(50)           
  DECLARE @MessBody5_Old NVARCHAR(MAX) ,@MESS5_Old NVARCHAR(MAX)      
  DECLARE @xml5_Old NVARCHAR(MAX)              
   DECLARE @Data5_Old NVARCHAR(MAX) ,  @totctrOT5_Old as int=0          
           
    set @Data5_Old=''                
    set @MessBody5_Old=''                          
    set @MESS5_Old=''          
    set @Count5_Old=1                                    
              
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Future_Old into #aa5_Old from #NSXCurr_Old          
     SELECT @totctrOT5_Old=count(1) from #aa5_Old           
   SET @MESS5_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
   <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Future (%) </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count5_Old <= @totctrOT5_Old                              
     BEGIN                        
      SELECT @Type5_Old=Type_Old, @Min5_Old=Future_Old FROM #aa5_Old WHERE Srno=@count5_Old                                   
      set @Data5_Old=@Data5_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type5_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min5_Old) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count5_Old=@Count5_Old+1                                    
     END
SET @MESS5_Old=@MESS5_Old + @Data5_Old +'</Table>' 
 --set @MESS5_NSX='<Br><B>NSX</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS5_Old + '</td><td> '+ @MESS5 +'</td></tr></Table>'      
 set @MESS5_NSX='<Br><B>NSX</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS5 +'</td></tr></Table>'      

IF OBJECT_ID('tempdb..#NSXCurr', 'U') IS NOT NULL
DROP TABLE #NSXCurr
IF OBJECT_ID('tempdb..#aa5', 'U') IS NOT NULL
DROP TABLE #aa5
IF OBJECT_ID('tempdb..#NSXCurr_Old', 'U') IS NOT NULL
drop table #NSXCurr_Old
IF OBJECT_ID('tempdb..#aa5_Old', 'U') IS NOT NULL
drop table #aa5_Old
end
------------------BSEFO------------------
select @BSEFOFMin=isnull(FRIST_LEG_MIN_NEW,0),@BSEFOFFu=isnull(FRIST_LEG_MAX_NEW,0),@BSEFOSMin=isnull(SECOND_LEG_MIN_NEW,0),
 @BSEFOSFu=isnull(SECOND_LEG_MAX_NEW,0),@BSEFOFMin_Old=ISNULL(Frist_Leg_min_Old,0),@BSEFOFFu_Old=ISNULL(Frist_Leg_max_Old,0),
 @BSEFOSMin_Old=ISNULL(Second_Leg_Min_Old,0),@BSEFOSFu_Old=ISNULL(Second_Leg_max_Old,0)
	from #Client with(nolock) where segment='BSEFO' and scheme_type='TRD' 
	and party_code=@M_pcode

if(@BSEFOFMin>0 or @BSEFOFFu>0 or @BSEFOSMin>0 or @BSEFOSFu>0)
begin
 	create table #BSEFO
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 
	insert into #BSEFO                   
	--select '1st Leg' as Type,@BSEFOFMin as Min,@BSEFOFFu as Per    
	select '1st Leg' as Type, 
	CASE WHEN CONVERT(VARCHAR(20),@BSEFOFMin)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOFMin) END as Min, 
	CASE WHEN CONVERT(VARCHAR(20),@BSEFOFFu)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOFFu) END as Per             

	insert into #BSEFO                                     
	--select '2nd Leg' as Type,@BSEFOSMin as Min,@BSEFOSFu as Per
	select '2nd Leg' as Type, 
	CASE WHEN CONVERT(VARCHAR(20),@BSEFOSMin)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOSMin) END as Min, 
	CASE WHEN CONVERT(VARCHAR(20),@BSEFOSFu)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOSFu) END as Per
	
	create table #BSEFO_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #BSEFO_OLD                   
	--select '1st Leg' as Type,@BSEFOFMin_Old as Min,@BSEFOFFu_Old as Per  
	select '1st Leg' as Type, 
	CASE WHEN CONVERT(VARCHAR(20),@BSEFOFMin_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOFMin_Old) END as Min, 
	CASE WHEN CONVERT(VARCHAR(20),@BSEFOFFu_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOFFu_Old) END as Per            

	insert into #BSEFO_OLD                                     
	--select '2nd Leg' as Type,@BSEFOSMin_Old as Min,@BSEFOSFu_Old as Per
	select '2nd Leg' as Type, 
	CASE WHEN CONVERT(VARCHAR(20),@BSEFOSMin_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOSMin_Old) END as Min, 
	CASE WHEN CONVERT(VARCHAR(20),@BSEFOSFu_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOSFu_Old) END as Per

           
	  declare @CountBSEFO int,@CountEndBSEFO1 int,@Type12 as varchar(20)='',@Min12 as varchar(50),@Per12 as varchar(50)           
	  DECLARE @MessBody12 NVARCHAR(MAX) ,@MESS12 NVARCHAR(MAX) ,@Mess2_BSEFO  NVARCHAR(MAX)                       
	   DECLARE @Data12 NVARCHAR(MAX) ,  @totctrOTBSEFO as int=0          
	           
		set @Data12=''                
		--set @MessBody=''                          
		set @MESS12='' 
		set @Mess2_BSEFO=''         
		set @CountBSEFO=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa12 from #BSEFO          
		 SELECT @totctrOTBSEFO=count(1) from #aa12           
	   SET @MESS12=                            
	   '<table border="1" cellpadding="2" cellspacing="2">                            
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr> 
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountBSEFO <= @totctrOTBSEFO                              
		 BEGIN                        
		  SELECT @Type12=Type, @Min12=Min,@Per12=Per FROM #aa12 WHERE Srno=@CountBSEFO                                   
		  set @Data12=@Data12+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type12) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min12) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per12) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountBSEFO=@CountBSEFO+1                                    
		 END             
  SET @MESS12= @MESS12 + @Data12 +'</Table>' 
  
  declare @CountBSEFO_Old int,@CountEndBSEFO1_Old int,@Type12_Old as varchar(20)='',@Min12_Old as varchar(50),@Per12_Old as varchar(50)           
	  DECLARE @MessBody12_Old NVARCHAR(MAX) ,@MESS12_Old NVARCHAR(MAX)                        
	   DECLARE @Data12_Old NVARCHAR(MAX) ,  @totctrOTBSEFO_Old as int=0          
	           
		set @Data12_Old=''                
		--set @MessBody=''                          
		set @MESS12_Old=''          
		set @CountBSEFO_Old=1                                    
	              
	              
		select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa12_Old from #BSEFO_Old          
		 SELECT @totctrOTBSEFO_Old=count(1) from #aa12_Old           
	   SET @MESS12_Old=                            
	   '<table border="1" cellpadding="2" cellspacing="2"> 
	    <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountBSEFO_Old <= @totctrOTBSEFO_Old                              
		 BEGIN                        
		  SELECT @Type12_Old=Type_Old, @Min12_Old=Min_Old,@Per12_Old=Per_Old FROM #aa12_Old WHERE Srno=@CountBSEFO_Old                                   
		  set @Data12_Old=@Data12_Old+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type12_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min12_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per12_Old) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountBSEFO_Old=@CountBSEFO_Old+1                                    
		 END             
  SET @MESS12_Old= @MESS12_Old + @Data12_Old +'</Table>'  
   --set @Mess2_BSEFO='<Br><B>BSEFO</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS12_Old + '</td><td> '+ @MESS12 +'</td></tr></Table>'  
    set @Mess2_BSEFO='<Br><B>BSEFO</B> <Br><Br>'+ '<Table> <tr> <td> '+ @MESS12 +'</td></tr></Table>'  

IF OBJECT_ID('tempdb..#BSEFO', 'U') IS NOT NULL
DROP TABLE #BSEFO
IF OBJECT_ID('tempdb..#aa12', 'U') IS NOT NULL
DROP TABLE #aa12
IF OBJECT_ID('tempdb..#BSEFO_Old', 'U') IS NOT NULL
drop table #BSEFO_Old
IF OBJECT_ID('tempdb..#aa12_Old', 'U') IS NOT NULL
drop table #aa12_Old
end
 
-- -------------NSX Option---------------------
  select @NSXO1=isnull(FRIST_LEG_MAX_NEW,0),@NSXO2=isnull(SECOND_LEG_MAX_NEW,0),@NSXO1_Old=ISNULL(Frist_Leg_max_Old,0),
 @NSXO2_Old=ISNULL(Second_Leg_max_Old,0)  from #Client with(nolock) where 
	segment='NSX OPT' and scheme_type='ALL' 
	and party_code=@M_pcode

if(@NSXO1>0 or @NSXO2>0)
begin
create table #NSXO
(
Type  varchar(50),
PerLot  varchar(50)
) 
insert into #NSXO                   
--select '1st Leg' as Type,@NSXO1 as PerLot   
select '1st Leg' as Type, CASE WHEN CONVERT(VARCHAR(20),@NSXO1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSXO1) END as PerLot              

insert into #NSXO                                     
--select '2nd Leg' as Type,@NSXO2 as PerLot           
select '2nd Leg' as Type, CASE WHEN CONVERT(VARCHAR(20),@NSXO2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSXO2) END as PerLot

create table #NSXO_Old
(
Type_Old  varchar(50),
PerLot_Old  varchar(50)
) 
insert into #NSXO_Old                   
--select '1st Leg' as Type_Old,@NSXO1_Old as PerLot_Old 
select '1st Leg' as Type_Old, CASE WHEN CONVERT(VARCHAR(20),@NSXO1_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSXO1_Old) END as PerLot_Old               

insert into #NSXO_Old                                     
--select '2nd Leg' as Type_Old,@NSXO2_Old as PerLot_Old    
select '2nd Leg' as Type_Old, CASE WHEN CONVERT(VARCHAR(20),@NSXO2_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NSXO2_Old) END as PerLot_Old

  declare @Count8 int,@CountEnd8 int,@Type8 as varchar(20)='',@Min8 as varchar(50),@Per8 as varchar(50)           
  DECLARE @MessBody8 NVARCHAR(MAX) ,@MESS8 NVARCHAR(MAX),@MESS8_NSXOption NVARCHAR(MAX)    
  DECLARE @xml8 NVARCHAR(MAX)              
   DECLARE @Data8 NVARCHAR(MAX) ,  @totctrOT8 as int=0          
           
    set @Data8=''                
    set @MessBody8=''                          
    set @MESS8=''          
    set @Count8=1                                    
    set @MESS8_NSXOption=''          
              
    select  row_number()over (order by Type) As Srno,Type,PerLot into #aa8 from #NSXO          
     SELECT @totctrOT8=count(1) from #aa8           
   SET @MESS8=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
    <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Per Lot Rs. </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count8 <= @totctrOT8                              
     BEGIN                        
      SELECT @Type8=Type, @Min8=PerLot FROM #aa8 WHERE Srno=@count8                                   
      set @Data8=@Data8+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type8) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min8) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count8=@Count8+1                                    
     END
      SET @MESS8=@MESS8 + @Data8 +'</Table>' 
      
       declare @Count8_Old int,@CountEnd8_Old int,@Type8_Old as varchar(20)='',@Min8_Old as varchar(50),@Per8_Old as varchar(50)           
  DECLARE @MessBody8_Old NVARCHAR(MAX) ,@MESS8_Old NVARCHAR(MAX)  
  DECLARE @xml8_Old NVARCHAR(MAX)              
   DECLARE @Data8_Old NVARCHAR(MAX) ,  @totctrOT8_Old as int=0          
           
    set @Data8_Old=''                
    set @MessBody8_Old=''                          
    set @MESS8_Old=''          
    set @Count8_Old=1                                           
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,PerLot_Old into #aa8_Old from #NSXO_Old          
     SELECT @totctrOT8_Old=count(1) from #aa8_Old           
   SET @MESS8_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
    <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Per Lot Rs. </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count8_Old <= @totctrOT8_Old                              
     BEGIN                        
      SELECT @Type8_Old=Type_Old, @Min8_Old=PerLot_Old FROM #aa8_Old WHERE Srno=@count8_Old                                   
      set @Data8_Old=@Data8_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type8_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min8_Old) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count8_Old=@Count8_Old+1                                    
     END
      SET @MESS8_Old= @MESS8_Old + @Data8_Old +'</Table>'
      --set @MESS8_NSXOption='<Br><B>NSX Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS8_Old + '</td><td> '+ @MESS8 +'</td></tr></Table>'                    
      set @MESS8_NSXOption='<Br><B>NSX Option</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS8 +'</td></tr></Table>'                    

IF OBJECT_ID('tempdb..#NSXO', 'U') IS NOT NULL
DROP TABLE #NSXO
IF OBJECT_ID('tempdb..#aa8', 'U') IS NOT NULL
DROP TABLE #aa8
IF OBJECT_ID('tempdb..#NSXO_Old', 'U') IS NOT NULL
drop table #NSXO_Old
IF OBJECT_ID('tempdb..#aa8_old', 'U') IS NOT NULL
drop table #aa8_old
end
-----------------MCX Option-------------------------

  select @MCXOP_Silver1M=isnull(FRIST_LEG_MAX_NEW,0)  ,@MCXOP_Silver2M=isnull(SECOND_LEG_MAX_NEW,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

select @MCXOP_Copper1M =isnull(FRIST_LEG_MAX_NEW,0), @MCXOP_Copper2M=isnull(SECOND_LEG_MAX_NEW,0) 
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

select @MCXOP_Zinc1M =isnull(FRIST_LEG_MAX_NEW,0), @MCXOP_Zinc2M=isnull(SECOND_LEG_MAX_NEW,0)  
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

select @MCXOP_Gold1M=isnull(FRIST_LEG_MAX_NEW,0) , @MCXOP_Gold2M=isnull(SECOND_LEG_MAX_NEW,0) 
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

select @MCXOP_Crudoil1M =isnull(FRIST_LEG_MAX_NEW,0),@MCXOP_Crudoil2M=isnull(SECOND_LEG_MAX_NEW,0) 
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

select @MCXOP_NaturalGas1M=isnull(FRIST_LEG_MAX_NEW,0)  ,@MCXOP_NaturalGas2M=isnull(SECOND_LEG_MAX_NEW,0) 
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

select @MCXOP_ALL1M=isnull(FRIST_LEG_MAX_NEW,0) , @MCXOP_ALL2M =isnull(SECOND_LEG_MAX_NEW,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='ALL' 	and party_code=@M_pcode

select @MCXOP_Silver1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0), @MCXOP_Silver2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

select @MCXOP_Copper1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0) ,@MCXOP_Copper2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)
   from #Client with(nolock) where segment='MCX OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

select @MCXOP_Zinc1M_Old =ISNULL(FRIST_LEG_MAX_OLD,0), @MCXOP_Zinc2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

select @MCXOP_Gold1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0) ,@MCXOP_Gold2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
   from #Client with(nolock) where segment='MCX OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

 select @MCXOP_Crudoil1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0), @MCXOP_Crudoil2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
   from #Client with(nolock) where segment='MCX OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

select @MCXOP_NaturalGas1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0), @MCXOP_NaturalGas2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

select @MCXOP_ALL1M_Old =ISNULL(FRIST_LEG_MAX_OLD,0) , @MCXOP_ALL2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='ALL' 	and party_code=@M_pcode

if(@MCXOP_Silver1M>0 or @MCXOP_Silver2M>0 or @MCXOP_Copper1M>0 or @MCXOP_Copper2M>0 or @MCXOP_Zinc1M>0 or @MCXOP_Zinc2M>0 or
@MCXOP_Gold1M>0 or @MCXOP_Gold2M>0 or @MCXOP_Crudoil1M>0 or @MCXOP_Crudoil2M>0 or @MCXOP_NaturalGas1M>0 or @MCXOP_NaturalGas2M>0
or @MCXOP_ALL1M>0 or @MCXOP_ALL2M>0)
begin

create table #MCXOpt
(
Type  varchar(50),
SilverMin  varchar(50),
CopperMin  varchar(50),
ZincMin  varchar(50),
GoldMin varchar(50),
CrudoilMin varchar(50),
NaturalGasMin varchar(50),
All_Min varchar(50),
) 
insert into #MCXOpt                   
--select '1st Leg' as Type,@MCXOP_Silver1M as SilverMin ,@MCXOP_Copper1M as CopperMin,
--  @MCXOP_Zinc1M as ZincMin ,@MCXOP_Gold1M as GoldMin,
-- @MCXOP_Crudoil1M as  CrudoilMin ,@MCXOP_NaturalGas1M as NaturalGasMin,
-- @MCXOP_ALL1M as All_Min   
 select '1st Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Silver1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Silver1M) END as SilverMin , 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Copper1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Copper1M) END as CopperMin,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Zinc1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Zinc1M) END as ZincMin ,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Gold1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Gold1M) END as GoldMin,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Crudoil1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Crudoil1M) END as CrudoilMin , 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_NaturalGas1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_NaturalGas1M) END as NaturalGasMin,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_ALL1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_ALL1M) END as All_Min

insert into #MCXOpt                                     
--select '2nd Leg' as Type,@MCXOP_Silver2M as SilverMin, @MCXOP_Copper2M as CopperMin,
--  @MCXOP_Zinc2M as ZincMin ,@MCXOP_Gold2M as GoldMin,
-- @MCXOP_Crudoil2M as  CrudoilMin, @MCXOP_NaturalGas2M as NaturalGasMin,
-- @MCXOP_ALL2M as All_Min                              
select '2nd Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Silver2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Silver2M) END as SilverMin,  
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Copper2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Copper2M) END as CopperMin,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Zinc2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Zinc2M) END as ZincMin , 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Gold2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Gold2M) END as GoldMin,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Crudoil2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Crudoil2M) END as  CrudoilMin,  
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_NaturalGas2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_NaturalGas2M) END as NaturalGasMin,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_ALL2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_ALL2M) END as All_Min        


create table #MCXOpt_Old
(
Type_Old  varchar(50),
SilverMin_Old  varchar(50),
CopperMin_Old  varchar(50),
 ZincMin_Old  varchar(50),
 GoldMin_Old varchar(50),
 CrudoilMin_Old varchar(50),
 NaturalGasMin_Old varchar(50),
 All_Min_Old varchar(50),
 ) 
insert into #MCXOpt_Old                   
--select '1st Leg' as Type,@MCXOP_Silver1M_Old as SilverMin_Old ,@MCXOP_Copper1M_Old as CopperMin_Old,
-- @MCXOP_Zinc1M_Old as ZincMin_Old, 
--@MCXOP_Gold1M_Old as GoldMin_Old ,@MCXOP_Crudoil1M_Old as  CrudoilMin_Old,
-- @MCXOP_NaturalGas1M_Old as NaturalGasMin_Old,@MCXOP_ALL1M_Old as All_Min_Old
select '1st Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Silver1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Silver1M_Old) END as SilverMin_Old , 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Copper1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Copper1M_Old) END as CopperMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Zinc1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Zinc1M_Old) END as ZincMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Gold1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Gold1M_Old) END as GoldMin_Old , 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Crudoil1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Crudoil1M_Old) END as  CrudoilMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_NaturalGas1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_NaturalGas1M_Old) END as NaturalGasMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_ALL1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_ALL1M_Old) END as All_Min_Old
 

insert into #MCXOpt_Old                                    
--select '2nd Leg' as Type,@MCXOP_Silver2M_Old as SilverMin_Old, 
--@MCXOP_Copper2M_Old as CopperMin_Old,  @MCXOP_Zinc2M_Old as ZincMin_Old,
-- @MCXOP_Gold2M_Old as GoldMin_Old,
--@MCXOP_Crudoil2M_Old as  CrudoilMin_Old,@MCXOP_NaturalGas2M_Old as NaturalGasMin_Old,@MCXOP_ALL2M_Old as All_Min_Old  
select '2nd Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Silver2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Silver2M_Old) END as SilverMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Copper2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Copper2M_Old) END as CopperMin_Old,  
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Zinc2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Zinc2M_Old) END as ZincMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Gold2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Gold2M_Old) END as GoldMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_Crudoil2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_Crudoil2M_Old) END as  CrudoilMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_NaturalGas2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_NaturalGas2M_Old) END as NaturalGasMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@MCXOP_ALL2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@MCXOP_ALL2M_Old) END as All_Min_Old  
            
  declare @Count888 int,@CountEnd888 int,@Type888 as varchar(20)='',@SilverMin as Varchar(50),  
  @CopperMin as Varchar(50)   ,  @ZincMin as Varchar(50), 
 @GoldMin as Varchar(50) , @CrudoilMin as Varchar(50), 
  @NaturalGasMin as Varchar(50),  @All_Min as Varchar(50)
  DECLARE @MessBody888 NVARCHAR(MAX) ,@MESS888 NVARCHAR(MAX)         
  DECLARE @xml888 NVARCHAR(MAX)              
   DECLARE @Data888 NVARCHAR(MAX) ,  @totctrOT888 as int=0 ,@Mess_MCXOpt NVARCHAR(MAX)  =''    
           
    set @Data888=''                
    set @MessBody888=''                          
    set @MESS888=''          
    set @Count888=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,SilverMin,CopperMin,ZincMin,GoldMin,
CrudoilMin,NaturalGasMin,All_Min   into #aa888 from #MCXOpt          

     SELECT @totctrOT888=count(1) from #aa888           
   SET @MESS888=                            
   '<table border="1" cellpadding="2" cellspacing="2">          
	   <tr><th  align="center" colspan="8">New Brokerage </th>
	   </tr>     
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Silver </th>                                                                                 
       <th align="center"> Copper </th>
	   <th align="center"> Zinc </th>
	   <th align="center"> Gold </th>
	   <th align="center"> Crudoil </th>
	   <th align="center"> NaturalGas </th>
	   <th align="center"> All </th>
   </tr>'          
--print @MESS          
   WHILE @Count888 <= @totctrOT888                              
     BEGIN                        
      SELECT @Type888=Type,@SilverMin=SilverMin ,@CopperMin=CopperMin,@ZincMin=ZincMin,
	 @GoldMin=GoldMin ,@CrudoilMin=CrudoilMin, @NaturalGasMin=NaturalGasMin,
	  @All_Min=All_Min FROM #aa888 WHERE Srno=@count888                                   
      set @Data888=@Data888+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type888) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@CopperMin) +' </td>     
   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin) +' </td>     
 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin) +' </td>     
 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@All_Min) +' </td>     
 
       </tr>'           
       print @Data888                         
      SET   @Count888=@Count888+1                                    
     END   
     SET @MESS888=  @MESS888 + @Data888 +'</Table>'
     print  @MESS888         
 --drop table #aa888
 
 declare @Count999 int,@CountEnd999 int,@Type999 as varchar(20)='',@SilverMin_Old as Varchar(50),
  @CopperMin_Old as Varchar(50)  ,  @ZincMin_Old as Varchar(50), 
    @GoldMin_Old as Varchar(50), @CrudoilMin_Old as Varchar(50),  
  @NaturalGasMin_Old as Varchar(50),  @All_Min_Old as Varchar(50)
  DECLARE @MessBody999 NVARCHAR(MAX) ,@MESS999 NVARCHAR(MAX)         
  DECLARE @xml999 NVARCHAR(MAX)              
   DECLARE @Data999 NVARCHAR(MAX) ,  @totctrOT999 as int=0          
           
    set @Data999=''                
    set @MessBody999=''                          
    set @MESS999=''          
    set @Count999=1                                    
              
              
    select  row_number()over (order by Type_Old) as Srno,Type_Old,SilverMin_Old,CopperMin_Old,ZincMin_Old,GoldMin_Old,
CrudoilMin_Old,NaturalGasMin_Old,All_Min_Old   into #aa999 from #MCXOpt_Old          

     SELECT @totctrOT999=count(1) from #aa999           
   SET @MESS999=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
   	   <tr><th  align="center" colspan="8">Old Brokerage </th>
	   </tr>  
   <tr>                       
    <th align="center"> Type_Old </th>                            
       <th align="center"> Silver_Old </th>                                                                                 
        <th align="center"> Copper_Old </th>
 	   <th align="center"> Zinc_Old </th>
 	   <th align="center"> Gold_Old </th>
 	   <th align="center"> Crudoil_Old </th>
 	   <th align="center"> NaturalGas_Old </th>
 	   <th align="center"> All_Old </th>
    </tr>'          
--print @MESS          
   WHILE @Count999 <= @totctrOT999                              
     BEGIN                        
      SELECT @Type999=Type_Old,@SilverMin_Old=SilverMin_Old, @CopperMin_Old=CopperMin_Old ,@ZincMin_Old=ZincMin_Old,
	  @GoldMin_Old=GoldMin_Old, @CrudoilMin_Old=CrudoilMin_Old, @NaturalGasMin_Old=NaturalGasMin_Old,
	  @All_Min_Old=All_Min_Old  FROM #aa999 WHERE Srno=@count999                                   
      set @Data999=@Data999+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type999) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin_Old) +' </td>   
          <td align="center"> '+ CONVERT(VARCHAR,@CopperMin_Old) +' </td>     
   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin_Old) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin_Old) +' </td>     
 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin_Old) +' </td>     
 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin_Old) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@All_Min_Old) +' </td>     
 
       </tr>'           
       print @Data999                         
      SET   @Count999=@Count999+1                                    
     END   
     SET @MESS999=  @MESS999 + @Data999 +'</Table>'
     --set @Mess_MCXOpt='<Br><B>MCX Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS999 + '</td><td> '+ @MESS888 +'</td></tr></Table>'          
     set @Mess_MCXOpt='<Br><B>MCX Option</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS888 +'</td></tr></Table>'          

end
IF OBJECT_ID('tempdb..#MCXOpt', 'U') IS NOT NULL
    DROP TABLE #MCXOpt
IF OBJECT_ID('tempdb..#aa999', 'U') IS NOT NULL
    DROP TABLE #aa999
IF OBJECT_ID('tempdb..#MCXOpt_Old', 'U') IS NOT NULL
drop table #MCXOpt_Old
IF OBJECT_ID('tempdb..#aa888', 'U') IS NOT NULL
drop table #aa888

--------------NCE Option-------------------------

select @NCEOP_Silver1M=isnull(FRIST_LEG_MAX_NEW,0) , @NCEOP_Silver2M=isnull(SECOND_LEG_MAX_NEW,0)  
from #Client with(nolock) where segment='NCE OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

select @NCEOP_Copper1M =isnull(FRIST_LEG_MAX_NEW,0), @NCEOP_Copper2M=isnull(SECOND_LEG_MAX_NEW,0)  
from #Client with(nolock) where segment='NCE OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

select @NCEOP_Zinc1M =isnull(FRIST_LEG_MAX_NEW,0), @NCEOP_Zinc2M=isnull(SECOND_LEG_MAX_NEW,0) 
from #Client with(nolock) where segment='NCE OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

select @NCEOP_Gold1M=isnull(FRIST_LEG_MAX_NEW,0)  ,@NCEOP_Gold2M=isnull(SECOND_LEG_MAX_NEW,0) 
from #Client with(nolock) where segment='NCE OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

select @NCEOP_Crudoil1M =isnull(FRIST_LEG_MAX_NEW,0),@NCEOP_Crudoil2M=isnull(SECOND_LEG_MAX_NEW,0)
from #Client with(nolock) where segment='NCE OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

select @NCEOP_NaturalGas1M=isnull(FRIST_LEG_MAX_NEW,0) , @NCEOP_NaturalGas2M=isnull(SECOND_LEG_MAX_NEW,0)
from #Client with(nolock) where segment='NCE OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

select @NCEOP_ALL1M=isnull(FRIST_LEG_MAX_NEW,0) , @NCEOP_ALL2M =isnull(SECOND_LEG_MAX_NEW,0)
from #Client with(nolock) where segment='NCE OPT' and scheme_type='ALL' 	and party_code=@M_pcode

select @NCEOP_Silver1M_Old=ISNULL(Frist_Leg_max_Old,0) ,@NCEOP_Silver2M_Old =ISNULL(Second_Leg_Min_Old,0)
from #Client with(nolock) where segment='NCE OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

select @NCEOP_Copper1M_Old=ISNULL(Frist_Leg_max_Old,0),@NCEOP_Copper2M_Old=ISNULL(Second_Leg_Min_Old,0)
from #Client with(nolock) where segment='NCE OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

select @NCEOP_Zinc1M_Old =ISNULL(Frist_Leg_max_Old,0) ,@NCEOP_Zinc2M_Old =ISNULL(Second_Leg_Min_Old,0)
from #Client with(nolock) where segment='NCE OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

select @NCEOP_Gold1M_Old=ISNULL(Frist_Leg_max_Old,0), @NCEOP_Gold2M_Old =ISNULL(Second_Leg_Min_Old,0)
from #Client with(nolock) where segment='NCE OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

select @NCEOP_Crudoil1M_Old=ISNULL(Frist_Leg_max_Old,0),@NCEOP_Crudoil2M_Old =ISNULL(Second_Leg_Min_Old,0)
from #Client with(nolock) where segment='NCE OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

select @NCEOP_NaturalGas1M_Old=ISNULL(Frist_Leg_max_Old,0), @NCEOP_NaturalGas2M_Old=ISNULL(Second_Leg_Min_Old,0)
from #Client with(nolock) where segment='NCE OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

select @NCEOP_ALL1M_Old =ISNULL(Frist_Leg_max_Old,0)  ,@NCEOP_ALL2M_Old=ISNULL(Second_Leg_Min_Old,0)  
from #Client with(nolock) where segment='NCE OPT' and scheme_type='ALL' 	and party_code=@M_pcode

if(@NCEOP_Silver1M>0 or @NCEOP_Silver2M>0 or @NCEOP_Copper1M>0 or @NCEOP_Copper2M>0 or @NCEOP_Zinc1M>0 or @NCEOP_Zinc2M>0 or
@NCEOP_Gold1M>0 or @NCEOP_Gold2M>0 or @NCEOP_Crudoil1M>0 or @NCEOP_Crudoil2M>0 or @NCEOP_NaturalGas1M>0 or @NCEOP_NaturalGas2M>0
or @NCEOP_ALL1M>0 or @NCEOP_ALL2M>0)
begin

create table #NCEOpt
(
Type  varchar(50),
SilverMin  varchar(50),
 CopperMin  varchar(50),
 ZincMin  varchar(50),
 GoldMin varchar(50),
 CrudoilMin varchar(50),
 NaturalGasMin varchar(50),
 All_Min varchar(50)) 
insert into #NCEOpt                   
--select '1st Leg' as Type,@NCEOP_Silver1M as SilverMin ,@NCEOP_Copper1M as CopperMin,
-- @NCEOP_Zinc1M as ZincMin ,@NCEOP_Gold1M as GoldMin,
-- @NCEOP_Crudoil1M as  CrudoilMin ,@NCEOP_NaturalGas1M as NaturalGasMin,
-- @NCEOP_ALL1M as All_Min               
select '1st Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Silver1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Silver1M) END as SilverMin , 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Copper1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Copper1M) END as CopperMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Zinc1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Zinc1M) END as ZincMin , 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Gold1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Gold1M) END as GoldMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Crudoil1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Crudoil1M) END as CrudoilMin , 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_NaturalGas1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_NaturalGas1M) END as NaturalGasMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_ALL1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_ALL1M) END as All_Min   

insert into #NCEOpt                                     
--select '2nd Leg' as Type,@NCEOP_Silver2M as SilverMin, @NCEOP_Copper2M as CopperMin,
-- @NCEOP_Zinc2M as ZincMin ,@NCEOP_Gold2M as GoldMin,
-- @NCEOP_Crudoil2M as  CrudoilMin, @NCEOP_NaturalGas2M as NaturalGasMin,
-- @NCEOP_ALL2M as All_Min                              
select '2nd Leg' as Type,
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Silver2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Silver2M) END as SilverMin,  
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Copper2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Copper2M) END as CopperMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Zinc2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Zinc2M) END as ZincMin, 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Gold2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Gold2M) END as GoldMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Crudoil2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Crudoil2M) END as CrudoilMin,  
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_NaturalGas2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_NaturalGas2M) END as NaturalGasMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_ALL2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_ALL2M) END as All_Min


create table #NCEOpt_Old
(
Type_Old  varchar(50),
SilverMin_Old  varchar(50),
 CopperMin_Old  varchar(50),
 ZincMin_Old  varchar(50),
 GoldMin_Old varchar(50),
 CrudoilMin_Old varchar(50),
 NaturalGasMin_Old varchar(50),
 All_Min_Old varchar(50))
 
insert into #NCEOpt_Old                   
--select '1st Leg' as Type,@NCEOP_Silver1M_Old as SilverMin_Old, @NCEOP_Copper1M_Old as CopperMin_Old,
--  @NCEOP_Zinc1M_Old as ZincMin_Old,
--@NCEOP_Gold1M_Old as GoldMin_Old ,@NCEOP_Crudoil1M_Old as  CrudoilMin_Old,
--@NCEOP_NaturalGas1M_Old as NaturalGasMin_Old,@NCEOP_ALL1M_Old as All_Min_Old  
select '1st Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Silver1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Silver1M_Old) END as SilverMin_Old,  
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Copper1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Copper1M_Old) END as CopperMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Zinc1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Zinc1M_Old) END as ZincMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Gold1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Gold1M_Old) END as GoldMin_Old , 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Crudoil1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Crudoil1M_Old) END as  CrudoilMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_NaturalGas1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_NaturalGas1M_Old) END as NaturalGasMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_ALL1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_ALL1M_Old) END as All_Min_Old 

insert into #NCEOpt_Old                                    
--select '2nd Leg' as Type,@NCEOP_Silver2M_Old as SilverMin_Old, 
--@NCEOP_Copper2M_Old as CopperMin_Old,  @NCEOP_Zinc2M_Old as ZincMin_Old,@NCEOP_Gold2M_Old as GoldMin_Old, 
--@NCEOP_Crudoil2M_Old as  CrudoilMin_Old ,@NCEOP_NaturalGas2M_Old as NaturalGasMin_Old,@NCEOP_ALL2M_Old as All_Min_Old                    
select '2nd Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Silver2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Silver2M_Old) END as SilverMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Copper2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Copper2M_Old) END as CopperMin_Old,   
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Zinc2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Zinc2M_Old) END as ZincMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Gold2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Gold2M_Old) END as GoldMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_Crudoil2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_Crudoil2M_Old) END as  CrudoilMin_Old , 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_NaturalGas2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_NaturalGas2M_Old) END as NaturalGasMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCEOP_ALL2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCEOP_ALL2M_Old) END as All_Min_Old  
            
  declare @Count111 int,@CountEnd111 int,@Type111 as varchar(20)='',@SilverMin_NCE as Varchar(50), 
  @CopperMin_NCE as Varchar(50)   , @ZincMin_NCE as Varchar(50), 
    @GoldMin_NCE as Varchar(50),  @CrudoilMin_NCE as Varchar(50),
  @NaturalGasMin_NCE as Varchar(50),  @All_Min_NCE as Varchar(50) 
  DECLARE @MessBody111 NVARCHAR(MAX) ,@MESS111 NVARCHAR(MAX)         
  DECLARE @xml111 NVARCHAR(MAX)              
   DECLARE @Data111 NVARCHAR(MAX) ,  @totctrOT111 as int=0 ,@Mess_NCEOpt NVARCHAR(MAX)  =''    
           
    set @Data111=''                
    set @MessBody111=''                          
    set @MESS111=''          
    set @Count111=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,SilverMin,CopperMin,ZincMin,GoldMin,
CrudoilMin,NaturalGasMin,All_Min   into #aa111 from #NCEOpt          

     SELECT @totctrOT111=count(1) from #aa111           
   SET @MESS111=                            
   '<table border="1" cellpadding="2" cellspacing="2">                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Silver </th>                                                                                 
        <th align="center"> Copper </th>
 	   <th align="center"> Zinc </th>
 	   <th align="center"> Gold </th>
 	   <th align="center"> Crudoil </th>
 	   <th align="center"> NaturalGas </th>
 	   <th align="center"> All </th>
    </tr>'          
--print @MESS          
   WHILE @Count111 <= @totctrOT111                              
     BEGIN                        
      SELECT @Type111=Type,@SilverMin_NCE=SilverMin ,@CopperMin_NCE=CopperMin, @ZincMin_NCE=ZincMin,
	 @GoldMin_NCE=GoldMin, @CrudoilMin_NCE=CrudoilMin ,@NaturalGasMin=NaturalGasMin,
	  @All_Min_NCE=All_Min   FROM #aa111 WHERE Srno=@count111                                   
      set @Data111=@Data111+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type111) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin_NCE) +' </td>   
          <td align="center"> '+ CONVERT(VARCHAR,@CopperMin_NCE) +' </td>     
   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin_NCE) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin_NCE) +' </td>     
 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin_NCE) +' </td>     
 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@All_Min_NCE) +' </td>     
 
       </tr>'           
       print @Data111                         
      SET   @Count111=@Count111+1                                    
     END   
     SET @MESS111=  @MESS111 + @Data111 +'</Table>'
     print  @MESS111         
 drop table #aa111
 
 declare @Count456 int,@CountEnd456 int,@Type456 as varchar(20)='',@SilverMin_NCE_Old as Varchar(50), 
  @CopperMin_NCE_Old as Varchar(50)  ,   @ZincMin_NCE_Old as Varchar(50), 
  @GoldMin_NCE_Old as Varchar(50),  @CrudoilMin_NCE_Old as Varchar(50), 
  @NaturalGasMin_NCE_Old as Varchar(50),   @All_Min_NCE_Old as Varchar(50) 
  DECLARE @MessBody456 NVARCHAR(MAX) ,@MESS456 NVARCHAR(MAX)         
  DECLARE @xml456 NVARCHAR(MAX)              
   DECLARE @Data456 NVARCHAR(MAX) ,  @totctrOT456 as int=0          
           
    set @Data456=''                
    set @MessBody456=''                          
    set @MESS456=''          
    set @Count456=1                                    
              
              
    select  row_number()over (order by Type_Old) as Srno,Type_Old,SilverMin_Old,CopperMin_Old,ZincMin_Old,GoldMin_Old,
CrudoilMin_Old,NaturalGasMin_Old,All_Min_Old   into #aa456 from #NCEOpt_Old          

     SELECT @totctrOT456=count(1) from #aa456           
   SET @MESS456=                            
   '<table border="1" cellpadding="2" cellspacing="2">                            
   <tr>                       
    <th align="center"> Type_Old </th>                            
       <th align="center"> Silver_Old </th>                                                                                 
        <th align="center"> Copper_Old </th>
 	   <th align="center"> Zinc_Old </th>
 	   <th align="center"> Gold_Old </th>
 	   <th align="center"> Crudoil_Old </th>
 	   <th align="center"> NaturalGas_Old </th>
 	   <th align="center"> All_Old </th>
    </tr>'          
--print @MESS          
   WHILE @Count456 <= @totctrOT456                              
     BEGIN                        
      SELECT @Type456=Type_Old,@SilverMin_NCE_Old=SilverMin_Old,@CopperMin_NCE_Old=CopperMin_Old,
	  @ZincMin_NCE_Old=ZincMin_Old,
	  @GoldMin_NCE_Old=GoldMin_Old,@CrudoilMin_NCE_Old=CrudoilMin_Old,@NaturalGasMin_Old=NaturalGasMin_Old,
	  @All_Min_NCE_Old=All_Min_Old  FROM #aa456 WHERE Srno=@count456                                   
      set @Data456=@Data456+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type456) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin_NCE_Old) +' </td>   
          <td align="center"> '+ CONVERT(VARCHAR,@CopperMin_NCE_Old) +' </td>     
   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin_NCE_Old) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin_NCE_Old) +' </td>     
 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin_NCE_Old) +' </td>     
 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin_Old) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@All_Min_NCE_Old) +' </td>     
       </tr>'           
       print @Data456                         
      SET   @Count456=@Count456+1                                    
     END   
     SET @MESS456=  @MESS456 + @Data456 +'</Table>'
     --set @Mess_NCEOpt='<Br><B>NCE Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS111 + '</td><td> '+ @MESS456 +'</td></tr></Table>'  
     set @Mess_NCEOpt='<Br><B>NCE Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS111 + '</td><td> ' +'</td></tr></Table>'          

END

-----------------------BSEFO Option--------------------------------------
select @BSEFOOAll1=isnull(FRIST_LEG_MAX_NEW,0),@BSEFOOAll2=isnull(SECOND_LEG_MAX_NEW,0),@BSEFOOAll1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@BSEFOOAll2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='BFO OPT' and scheme_type='ALL'

select @BSEFOOSX501=isnull(FRIST_LEG_MAX_NEW,0),@BSEFOOSX502=isnull(SECOND_LEG_MAX_NEW,0),@BSEFOOSX501_Old=isnull(FRIST_LEG_MAX_OLD,0),
@BSEFOOSX502_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='BFO OPT' and scheme_type='SX50OPT'

select @BSEFOOBKX1=isnull(FRIST_LEG_MAX_NEW,0),@BSEFOOBKX2=isnull(SECOND_LEG_MAX_NEW,0),@BSEFOOBKX1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@BSEFOOBKX2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='BFO OPT' and scheme_type='BKXOPT'

select @BSEFOOBSX1=isnull(FRIST_LEG_MAX_NEW,0),@BSEFOOBSX2=isnull(SECOND_LEG_MAX_NEW,0),@BSEFOOBSX1_Old=isnull(FRIST_LEG_MAX_OLD,0)
,@BSEFOOBSX2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='BFO OPT' and scheme_type='BSXOPT'

if(@BSEFOOAll1>0 or @BSEFOOAll2>0 or @BSEFOOSX501>0 or @BSEFOOSX502>0 or @BSEFOOBKX1>0 or @BSEFOOBKX2>0 or @BSEFOOBSX1>0 or @BSEFOOBSX2>0)
begin
create table #BSEFOOpt
(
Type  varchar(50),
Stock  varchar(50),
SX50OPT  varchar(50),
BKXOPT  varchar(50),
BSXOPT  varchar(50)
) 
insert into #BSEFOOpt                   
--select '1st Leg' as Type,@BSEFOOAll1 as Stock ,@BSEFOOSX501 as SX50OPT, @BSEFOOBKX1 as BKXOPT,@BSEFOOBSX1 as BSXOPT   
select '1st Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOAll1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOAll1) END as Stock , 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOSX501)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOSX501) END as SX50OPT, 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOBKX1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOBKX1) END as BKXOPT, 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOBSX1)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOBSX1) END as BSXOPT       

insert into #BSEFOOpt                                     
--select '2nd Leg' as Type,@BSEFOOAll2 as Stock ,@BSEFOOSX502 as SX50OPT, @BSEFOOBKX2 as BKXOPT,@BSEFOOBSX2 as BSXOPT 
select '2nd Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOAll2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOAll2) END as Stock , 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOSX502)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOSX502) END as SX50OPT,
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOBKX2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOBKX2) END as BKXOPT, 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOBSX2)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOBSX2) END as BSXOPT 

create table #BSEFOOpt_Old
(
Type_Old  varchar(50),
ALL_Old  varchar(50),
SX50OPT_Old  varchar(50),
BKXOPT_Old  varchar(50),
BSXOPT_old  varchar(50)
) 
insert into #BSEFOOpt_Old                   
--select '1st Leg' as Type_Old,@BSEFOOAll1_Old as ALL_Old ,@BSEFOOSX501_Old as SX50OPT_Old, @BSEFOOBKX1_Old as BKXOPT_Old,
--@BSEFOOBSX1_Old as BSXOPT_Old           
select '1st Leg' as Type_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOAll1_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOAll1_Old) END as ALL_Old , 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOSX501_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOSX501_Old) END as SX50OPT_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOBKX1_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOBKX1_Old) END as BKXOPT_Old,
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOBSX1_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOBSX1_Old) END as BSXOPT_Old

insert into #BSEFOOpt_Old                                     
--select '2nd Leg' as Type_Old,@BSEFOOAll2_Old as ALL_Old ,@BSEFOOSX502_Old as SX50OPT_Old, @BSEFOOBKX2_Old as BKXOPT_Old,
--@BSEFOOBSX2_Old as BSXOPT_Old                              
select '2nd Leg' as Type_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOAll2_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOAll2_Old) END as ALL_Old , 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOSX502_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOSX502_Old) END as SX50OPT_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOBKX2_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOBKX2_Old) END as BKXOPT_Old,
 CASE WHEN CONVERT(VARCHAR(20),@BSEFOOBSX2_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@BSEFOOBSX2_Old) END as BSXOPT_Old
            
  declare @Count0234 int,@CountEnd0234 int,@Type0234 as varchar(20)='',@All as varchar(50),@SX50 as varchar(50),@BSX as varchar(50)
  ,@BKX as varchar(50)
  DECLARE @MessBody0234 NVARCHAR(MAX) ,@MESS0234 NVARCHAR(MAX) ,@Mess0234_BSEFOOpt NVARCHAR(MAX)        
  DECLARE @xml0234 NVARCHAR(MAX)              
   DECLARE @Data0234 NVARCHAR(MAX) ,  @totctrOT0234 as int=0          
           
    set @Data0234=''                
    set @MessBody0234=''                          
    set @MESS0234=''          
    set @Count0234=1  
    set @Mess0234_BSEFOOpt=''                                  
              
              
    select  row_number()over (order by Type) As Srno,Type,Stock,SX50OPT,BSXOPT,BKXOPT into #aa0234 from #BSEFOOpt          
     SELECT @totctrOT0234=count(1) from #aa0234           
   SET @MESS0234=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
      <tr><th  align="center" colspan="6">New Brokerage </th>
	   </tr>                           
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> ALL Rs./Lot </th>                                                                                 
       <th align="center"> SX50 Rs./Lot </th>
       <th align="center"> BSX Rs./Lot </th>
       <th align="center"> BKX Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count0234 <= @totctrOT0234                              
     BEGIN                        
      SELECT @Type0234=Type,@All=Stock,@SX50=SX50OPT,@BSX=BSXOPT,@BKX=BKXOPT FROM #aa0234 WHERE Srno=@count0234                                   
      set @Data0234=@Data0234+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type0234) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@All) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@SX50) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@BSX) +' </td>                                                                      
         <td align="center"> '+ CONVERT(VARCHAR,@BKX) +' </td>  
       </tr>'           
       print @Data0234                         
      SET   @Count0234=@Count0234+1                                    
     END   
     SET @MESS0234= @MESS0234 + @Data0234 +'</Table>'
     print  @MESS0234 
     
declare @Count0234_Old int,@CountEnd0234_Old int,@Type0234_Old as varchar(20)='',@All_Old as varchar(50),
@SX50_Old as varchar(50),@BSX_Old as varchar(50) ,@BKX_Old as varchar(50)      
  DECLARE @MessBody0234_Old NVARCHAR(MAX) ,@MESS0234_Old NVARCHAR(MAX)         
  DECLARE @xml0234_Old NVARCHAR(MAX)              
   DECLARE @Data0234_Old NVARCHAR(MAX) ,  @totctrOT0234_Old as int=0          
           
    set @Data0234_Old=''                
    set @MessBody0234_Old=''                          
    set @MESS0234_Old=''          
    set @Count0234_Old=1                                    
              
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,ALL_Old,SX50OPT_Old,BSXOPT_old,BKXOPT_Old 
	into #aa0234_Old from #BSEFOOpt_Old          
     SELECT @totctrOT0234_Old=count(1) from #aa0234_Old           
   SET @MESS0234_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
      <tr><th  align="center" colspan="6">Old Brokerage </th>
	   </tr>                           
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> ALL Rs./Lot </th>                                                                                 
       <th align="center"> SX50 Rs./Lot </th>
       <th align="center"> BSX Rs./Lot </th>
       <th align="center"> BKX Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count0234_Old <= @totctrOT0234_Old                              
     BEGIN                        
      SELECT @Type0234_Old=Type_Old,@All_Old=ALL_Old,@SX50_Old=SX50OPT_Old,@BSX_Old=BSXOPT_old,
	  @BKX_Old=BKXOPT_Old FROM #aa0234_Old WHERE Srno=@count0234_Old                                   
      set @Data0234_Old=@Data0234_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type0234_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@All_Old) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@SX50_Old) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@BSX_Old) +' </td>                                                                      
         <td align="center"> '+ CONVERT(VARCHAR,@BKX_Old) +' </td>  
       </tr>'           
       print @Data0234_Old                         
      SET   @Count0234_Old=@Count0234_Old+1                                    
     END   
     SET @MESS0234_Old=@MESS0234_Old + @Data0234_Old +'</Table>' 
     --set @Mess0234_BSEFOOpt='<Br><B>BSEFO Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS0234_OLD + '</td><td> '+ @MESS0234 +'</td></tr></Table>'          
     set @Mess0234_BSEFOOpt='<Br><B>BSEFO Option</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS0234 +'</td></tr></Table>'          

 
IF OBJECT_ID('tempdb..#BSEFOOpt', 'U') IS NOT NULL
    DROP TABLE #BSEFOOpt
IF OBJECT_ID('tempdb..#aa0234', 'U') IS NOT NULL
    DROP TABLE #aa0234
IF OBJECT_ID('tempdb..#BSEFOOpt_Old', 'U') IS NOT NULL
drop table #BSEFOOpt_Old
IF OBJECT_ID('tempdb..#aa0234_Old', 'U') IS NOT NULL
drop table #aa0234_Old
end

---------------NCDEX Option ------------------


select @NCXOP_Silver1M=isnull(FRIST_LEG_MAX_NEW,0) , @NCXOP_Silver2M=isnull(SECOND_LEG_MAX_NEW,0)  
from #Client with(nolock) where segment='NCX OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

select @NCXOP_Copper1M =isnull(FRIST_LEG_MAX_NEW,0), @NCXOP_Copper2M=isnull(SECOND_LEG_MAX_NEW,0)  
from #Client with(nolock) where segment='NCX OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

select @NCXOP_Zinc1M =isnull(FRIST_LEG_MAX_NEW,0), @NCXOP_Zinc2M=isnull(SECOND_LEG_MAX_NEW,0) 
from #Client with(nolock) where segment='NCX OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

select @NCXOP_Gold1M=isnull(FRIST_LEG_MAX_NEW,0)  ,@NCXOP_Gold2M=isnull(SECOND_LEG_MAX_NEW,0) 
from #Client with(nolock) where segment='NCX OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

select @NCXOP_Crudoil1M =isnull(FRIST_LEG_MAX_NEW,0),@NCXOP_Crudoil2M=isnull(SECOND_LEG_MAX_NEW,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

select @NCXOP_NaturalGas1M=isnull(FRIST_LEG_MAX_NEW,0) , @NCXOP_NaturalGas2M=isnull(SECOND_LEG_MAX_NEW,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

select @NCXOP_ALL1M=isnull(FRIST_LEG_MAX_NEW,0) , @NCXOP_ALL2M =isnull(SECOND_LEG_MAX_NEW,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='ALL' 	and party_code=@M_pcode

select @NCXOP_Silver1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0) ,@NCXOP_Silver2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

select @NCXOP_Copper1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0),@NCXOP_Copper2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

select @NCXOP_Zinc1M_Old =ISNULL(FRIST_LEG_MAX_OLD,0) ,@NCXOP_Zinc2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

select @NCXOP_Gold1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0), @NCXOP_Gold2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

select @NCXOP_Crudoil1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0),@NCXOP_Crudoil2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

select @NCXOP_NaturalGas1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0), @NCXOP_NaturalGas2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

select @NCXOP_ALL1M_Old =ISNULL(FRIST_LEG_MAX_OLD,0)  ,@NCXOP_ALL2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)  
from #Client with(nolock) where segment='NCX OPT' and scheme_type='ALL' 	and party_code=@M_pcode

if(@NCXOP_Silver1M>0 or @NCXOP_Silver2M>0 or @NCXOP_Copper1M>0 or @NCXOP_Copper2M>0 or @NCXOP_Zinc1M>0 or @NCXOP_Zinc2M>0 or
@NCXOP_Gold1M>0 or @NCXOP_Gold2M>0 or @NCXOP_Crudoil1M>0 or @NCXOP_Crudoil2M>0 or @NCXOP_NaturalGas1M>0 or @NCXOP_NaturalGas2M>0
or @NCXOP_ALL1M>0 or @NCXOP_ALL2M>0)
begin

create table #NCXOpt
(
Type  varchar(50),
SilverMin  varchar(50),
 CopperMin  varchar(50),
 ZincMin  varchar(50),
 GoldMin varchar(50),
 CrudoilMin varchar(50),
 NaturalGasMin varchar(50),
 All_Min varchar(50)) 
insert into #NCXOpt                   
--select '1st Leg' as Type,@NCXOP_Silver1M as SilverMin ,@NCXOP_Copper1M as CopperMin,
-- @NCXOP_Zinc1M as ZincMin ,@NCXOP_Gold1M as GoldMin,
-- @NCXOP_Crudoil1M as  CrudoilMin ,@NCXOP_NaturalGas1M as NaturalGasMin,
-- @NCXOP_ALL1M as All_Min             
select '1st Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Silver1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Silver1M) END as SilverMin , 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Copper1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Copper1M) END as CopperMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Zinc1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Zinc1M) END as ZincMin , 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Gold1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Gold1M) END as GoldMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Crudoil1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Crudoil1M) END as  CrudoilMin , 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_NaturalGas1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_NaturalGas1M) END as NaturalGasMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_ALL1M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_ALL1M) END as All_Min

insert into #NCXOpt                                     
--select '2nd Leg' as Type,@NCXOP_Silver2M as SilverMin, @NCXOP_Copper2M as CopperMin,
-- @NCXOP_Zinc2M as ZincMin ,@NCXOP_Gold2M as GoldMin,
-- @NCXOP_Crudoil2M as  CrudoilMin, @NCXOP_NaturalGas2M as NaturalGasMin,
-- @NCXOP_ALL2M as All_Min                                
select '2nd Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Silver2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Silver2M) END as SilverMin, 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Copper2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Copper2M) END as CopperMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Zinc2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Zinc2M) END as ZincMin , 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Gold2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Gold2M) END as GoldMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Crudoil2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Crudoil2M) END as  CrudoilMin,  
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_NaturalGas2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_NaturalGas2M) END as NaturalGasMin,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_ALL2M)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_ALL2M) END as All_Min  


create table #NCXOpt_Old
(
Type_Old  varchar(50),
SilverMin_Old  varchar(50),
 CopperMin_Old  varchar(50),
 ZincMin_Old  varchar(50),
 GoldMin_Old varchar(50),
 CrudoilMin_Old varchar(50),
 NaturalGasMin_Old varchar(50),
 All_Min_Old varchar(50)) 
insert into #NCXOpt_Old                   
--select '1st Leg' as Type,@NCXOP_Silver1M_Old as SilverMin_Old, @NCXOP_Copper1M_Old as CopperMin_Old,
--  @NCXOP_Zinc1M_Old as ZincMin_Old,
--@NCXOP_Gold1M_Old as GoldMin_Old ,@NCXOP_Crudoil1M_Old as  CrudoilMin_Old,
--@NCXOP_NaturalGas1M_Old as NaturalGasMin_Old,@NCXOP_ALL1M_Old as All_Min_Old  
select '1st Leg' as Type, 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Silver1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Silver1M_Old) END as SilverMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Copper1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Copper1M_Old) END as CopperMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Zinc1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Zinc1M_Old) END as ZincMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Gold1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Gold1M_Old) END as GoldMin_Old , 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Crudoil1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Crudoil1M_Old) END as  CrudoilMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_NaturalGas1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_NaturalGas1M_Old) END as NaturalGasMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_ALL1M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_ALL1M_Old) END as All_Min_Old  

insert into #NCXOpt_Old                                    
--select '2nd Leg' as Type,@NCXOP_Silver2M_Old as SilverMin_Old, 
--@NCXOP_Copper2M_Old as CopperMin_Old,  @NCXOP_Zinc2M_Old as ZincMin_Old,@NCXOP_Gold2M_Old as GoldMin_Old, 
--@NCXOP_Crudoil2M_Old as  CrudoilMin_Old ,@NCXOP_NaturalGas2M_Old as NaturalGasMin_Old,@NCXOP_ALL2M_Old as All_Min_Old  
select '2nd Leg' as Type,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Silver2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Silver2M_Old) END as SilverMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Copper2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Copper2M_Old) END as CopperMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Zinc2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Zinc2M_Old) END as ZincMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Gold2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Gold2M_Old) END as GoldMin_Old, 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_Crudoil2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_Crudoil2M_Old) END as  CrudoilMin_Old , 
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_NaturalGas2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_NaturalGas2M_Old) END as NaturalGasMin_Old,
 CASE WHEN CONVERT(VARCHAR(20),@NCXOP_ALL2M_Old)='0.0000' THEN 'N.A.' ELSE CONVERT(VARCHAR(20),@NCXOP_ALL2M_Old) END as All_Min_Old 
            
  declare @Count111_4 int,@CountEnd111_4 int,@Type111_4 as varchar(20)='',@SilverMin_NCX as Varchar(50), 
  @CopperMin_NCX as Varchar(50)   , @ZincMin_NCX as Varchar(50), 
    @GoldMin_NCX as Varchar(50),  @CrudoilMin_NCX as Varchar(50),
  @NaturalGasMin_NCX as Varchar(50),  @All_Min_NCX as Varchar(50) 
  DECLARE @MessBody111_4 NVARCHAR(MAX) ,@MESS111_4 NVARCHAR(MAX)         
  DECLARE @xml111_4 NVARCHAR(MAX)              
   DECLARE @Data111_4 NVARCHAR(MAX) ,  @totctrOT111_4 as int=0 ,@Mess_NCXOpt NVARCHAR(MAX)  =''    
           
    set @Data111_4=''                
    set @MessBody111_4=''                          
    set @MESS111_4=''          
    set @Count111_4=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,SilverMin,CopperMin,ZincMin,GoldMin,
CrudoilMin,NaturalGasMin,All_Min   into #aa111_4 from #NCXOpt          

     SELECT @totctrOT111_4=count(1) from #aa111_4           
   SET @MESS111_4=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
   	   <tr><th  align="center" colspan="8">New Brokerage </th>
	   </tr>  
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Silver </th>                                                                                 
        <th align="center"> Copper </th>
 	   <th align="center"> Zinc </th>
 	   <th align="center"> Gold </th>
 	   <th align="center"> Crudoil </th>
 	   <th align="center"> NaturalGas </th>
 	   <th align="center"> All </th>
    </tr>'          
--print @MESS          
   WHILE @Count111_4 <= @totctrOT111_4                              
     BEGIN                        
      SELECT @Type111_4=Type,@SilverMin_NCX=SilverMin ,@CopperMin_NCX=CopperMin, @ZincMin_NCX=ZincMin,
	 @GoldMin_NCX=GoldMin, @CrudoilMin_NCX=CrudoilMin ,@NaturalGasMin_NCX=NaturalGasMin,
	  @All_Min_NCX=All_Min   FROM #aa111_4 WHERE Srno=@count111_4                                   
      set @Data111_4=@Data111_4+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type111_4) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin_NCX) +' </td>   
          <td align="center"> '+ CONVERT(VARCHAR,@CopperMin_NCX) +' </td>     
   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin_NCX) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin_NCX) +' </td>     
 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin_NCX) +' </td>     
 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin_NCX) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@All_Min_NCX) +' </td>     
 
       </tr>'           
       print @Data111_4                         
      SET   @Count111_4=@Count111_4+1                                    
     END   
     SET @MESS111_4=  @MESS111_4 + @Data111_4 +'</Table>'
     print  @MESS111_4         
 --drop table #aa111_4
 
 declare @Count4134 int,@CountEnd4134 int,@Type4134 as varchar(20)='',@SilverMin_NCX_Old as Varchar(50), 
  @CopperMin_NCX_Old as Varchar(50)  ,   @ZincMin_NCX_Old as Varchar(50), 
  @GoldMin_NCX_Old as Varchar(50),  @CrudoilMin_NCX_Old as Varchar(50), 
  @NaturalGasMin_NCX_Old as Varchar(50),   @All_Min_NCX_Old as Varchar(50) 
  DECLARE @MessBody4134 NVARCHAR(MAX) ,@MESS4134 NVARCHAR(MAX)         
  DECLARE @xml4134 NVARCHAR(MAX)              
   DECLARE @Data4134 NVARCHAR(MAX) ,  @totctrOT4134 as int=0          
           
    set @Data4134=''                
    set @MessBody4134=''                          
    set @MESS4134=''          
    set @Count4134=1                                    
              
              
    select  row_number()over (order by Type_Old) as Srno,Type_Old,SilverMin_Old,CopperMin_Old,ZincMin_Old,GoldMin_Old,
CrudoilMin_Old,NaturalGasMin_Old,All_Min_Old   into #aa4134 from #NCXOpt_Old          

     SELECT @totctrOT4134=count(1) from #aa4134           
   SET @MESS4134=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
   	   <tr><th  align="center" colspan="8">Old Brokerage </th>
	   </tr>  
   <tr>                       
    <th align="center"> Type_Old </th>                            
       <th align="center"> Silver_Old </th>                                                                                 
        <th align="center"> Copper_Old </th>
 	   <th align="center"> Zinc_Old </th>
 	   <th align="center"> Gold_Old </th>
 	   <th align="center"> Crudoil_Old </th>
 	   <th align="center"> NaturalGas_Old </th>
 	   <th align="center"> All_Old </th>
    </tr>'          
--print @MESS          
   WHILE @Count4134 <= @totctrOT4134                              
     BEGIN                        
      SELECT @Type4134=Type_Old,@SilverMin_NCX_Old=SilverMin_Old,@CopperMin_NCX_Old=CopperMin_Old,
	  @ZincMin_NCX_Old=ZincMin_Old,
	  @GoldMin_NCX_Old=GoldMin_Old,@CrudoilMin_NCX_Old=CrudoilMin_Old,@NaturalGasMin_NCX_Old=NaturalGasMin_Old,
	  @All_Min_NCX_Old=All_Min_Old  FROM #aa4134 WHERE Srno=@count4134                                   
      set @Data4134=@Data4134+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type4134) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin_NCX_Old) +' </td>   
          <td align="center"> '+ CONVERT(VARCHAR,@CopperMin_NCX_Old) +' </td>     
   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin_NCX_Old) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin_NCX_Old) +' </td>     
 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin_NCX_Old) +' </td>     
 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin_NCX_Old) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@All_Min_NCX_Old) +' </td>     
       </tr>'           
       print @Data4134                         
      SET   @Count4134=@Count4134+1                                    
     END   
     SET @MESS4134=  @MESS4134 + @Data4134 +'</Table>'
     --set @Mess_NCXOpt='<Br><B>NCDEX Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS4134 + '</td><td> '+ @MESS111_4 +'</td></tr></Table>'          
     set @Mess_NCXOpt='<Br><B>NCDEX Option</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS111_4 +'</td></tr></Table>'          


IF OBJECT_ID('tempdb..#NCXOpt', 'U') IS NOT NULL
    DROP TABLE #NCXOpt
IF OBJECT_ID('tempdb..#aa111_4', 'U') IS NOT NULL
    DROP TABLE #aa111_4
IF OBJECT_ID('tempdb..#NCXOpt_Old', 'U') IS NOT NULL
drop table #NCXOpt_Old
IF OBJECT_ID('tempdb..#aa4134', 'U') IS NOT NULL
drop table #aa4134
end

	--SET @MessBody =  '<b><font size="4" color="#FF4500">Dear '+@ClientName+'('+@M_pcode+')</font></b>,<br/><br/>'+' We are acknowledging your request for change in brokerage rates as described below  <br/><br/> '+ isnull(@MESSBSE,'') + '<Br>'     
	SET @MessBody =  '<b><font size="4" color="#000000">Dear '+@ClientName+'('+@M_pcode+')</font></b>,<br/><br/>'+' We are acknowledging your request for change in brokerage rates as described below  <br/><br/> '+ isnull(@MESSBSE,'') + '<Br>'+ isnull(@MESSNSE,'')+'<Br>'+ isnull(@Mess2_NSEFO,'')+'<Br>'+isnull(@Mess7_NSEFOOpt,'') +'<Br>' +isnull(@MESS14_MCX,'') +'<Br>' +isnull(@MESS4_NCDX,'')+'<Br>' +isnull(@MESS5_NSX,'')+'<Br>'  +isnull(@Mess2_BSEFO,'')+'<Br>' +isnull(@MESS8_NSXOption,'')+'<Br>' +isnull(@Mess_MCXOpt,'')+'<Br>'+isnull(@Mess_NCXOpt,'')+'<Br>' +isnull(@Mess0234_BSEFOOpt,'') +'<Br>'+isnull(@MESS14_NCE,'')+'<Br>'+isnull(@Mess_NCEOpt,'')+'<Br>'  
	--print @MessBody
	SET @MessBody=@MessBody+'<BR><BR>NOTE:- N.A. HERE REPRESENTS NO CHANGES IN YOUR BROKERAGE FOR THAT SEGMENTS....<br><Br>'
	--SET @MessBody=@MessBody+'<BR><BR><b><font size="2" color="#ff0000">NOTE:- N.A. MEANS NOT APPLICABLE.....</font></b>'
	SET @MessBody=@MessBody+'<BR><BR>Regards,<br><Br>Angel One.'                                    
	SET @MessBody=@MessBody+'<BR><BR>This is a system generated message. Please do not Reply.'
	SET @MessBody=@MessBody+'<BR><BR> Please contact- 1800 1020 '
	set @sub='Acknowledgement of Brokerage modification for Client Code-'+@M_pcode+'' 
	                                 
                          
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                    
 --@RECIPIENTS =@emailto ,   
 @RECIPIENTS =@ClientEmail ,
 @COPY_RECIPIENTS = @emailcc,                                    
 @blind_copy_recipients =@emailbcc,               
 @PROFILE_NAME = 'AngelBroking',                                    
 @BODY_FORMAT ='HTML',                                    
 @SUBJECT = @sub,                                    
 @FILE_ATTACHMENTS ='',                                    
 @BODY =@MessBody 

 set @pcount=@pcount+1
 --print @MESSBSE
-- print @M_pcode
end
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Brokerage_CustomBrok_mailer_TEST_BKP_06DEC2024
-- --------------------------------------------------


CREATE proc [dbo].[Brokerage_CustomBrok_mailer_TEST_BKP_06DEC2024] (@CODE VARCHAR (50))
as
begin
declare @BSEL1 as decimal(18,4)=0.00,@BSEM1 as decimal(18,4)=0.00,@BseP1 as decimal(18,4)=0.00,@BSEL2 as decimal(18,4)=0.00,@BSEM2 as decimal(18,4)=0.00,
@BseP2 as decimal(18,4)=0.00,@BSEDel as decimal(18,4)=0.00,@BSEMDel as decimal(18,4)=0.00,@BsePDel as decimal(18,4)=0.00,@NSEL1 as decimal(18,4)=0.00,@NSEM1 as decimal(18,4)=0.00,
@NSEP1 as decimal(18,4)=0.00,@NSEL2 as decimal(18,4)=0.00,@NSEM2 as decimal(18,4)=0.00,@NSEP2 as decimal(18,4)=0.00,
@NSELDel as decimal(18,4)=0.00,@NSEMDel as decimal(18,4)=0.00,@NSEPDel as decimal(18,4)=0.00,@MCXL1 as decimal(18,4)=0.00,@MCX1M as decimal(18,4)=0.00,@MCX1Fu as decimal(18,4)=0.00,
@MCXL2 as decimal(18,4)=0.00,@MCX2M as decimal(18,4)=0.00,@MCX2Fu as decimal(18,4)=0.00,@NCDX1L as decimal(18,4)=0.00,@NCDX1Min as decimal(18,4)=0.00,@NCDX1Fu as decimal(18,4)=0.00,
@NCDX2L as decimal(18,4)=0.00,@NCDX2Min as decimal(18,4)=0.00,@NCDX2Fu as decimal(18,4)=0.00,@NSEFOFL as decimal(18,4)=0.00,
@NSEFOFMin as decimal(18,4)=0.00,@NSEFOFFu as decimal(18,4)=0.00,@NSEFOSL as decimal(18,4)=0.00,@NSEFOSMin as decimal(18,4)=0.00,@NSEFOSFu as decimal(18,4)=0.00,
@NSX1 as decimal(18,4)=0.00,@NSX2 as decimal(18,4)=0.00,@NSEFOOS1 as decimal(18,4)=0.00,@NSEFOOS2 as decimal(18,4)=0.00,@NSEFOON1 as decimal(18,4)=0.00,@NSEFOON2 as decimal(18,4)=0.00,
@NSEFOOB1 as decimal(18,4)=0.00,@NSEFOOB2 as decimal(18,4)=0.00,@NSEFOOFN1 as decimal(18,4)=0.00,@NSEFOOFN2 as decimal(18,4)=0.00,@NSXO1 as decimal(18,4)=0.00,@NSXO2 as decimal(18,4)=0.00,@MCD1 as decimal(18,4)=0.00,@MCD2 as decimal(18,4)=0.00,
@MCDO1 as decimal(18,4)=0.00,@MCDO2 as decimal(18,4)=0.00,
@BSEFOOAll1 as decimal(18,4)=0.00,@BSEFOOAll2 as decimal(18,4)=0.00,@BSEFOOSX501 as decimal(18,4)=0.00,@BSEFOOSX502 as decimal(18,4)=0.00,
@BSEFOOBKX1 as decimal(18,4)=0.00,@BSEFOOBKX2 as decimal(18,4)=0.00,@BSEFOOBSX1 as decimal(18,4)=0.00,
@BSEFOOBSX2 as decimal(18,4)=0.00,
@BSEFOOAll1_Old as decimal(18,4)=0.00, @BSEFOOSX501_Old as decimal(18,4)=0.00, @BSEFOOBKX1_Old as decimal(18,4)=0.00,
@BSEFOOBSX1_Old as decimal(18,4)=0.00,@BSEFOOAll2_Old as decimal(18,4)=0.00, @BSEFOOSX502_Old as decimal(18,4)=0.00,
@BSEFOOBKX2_Old as decimal(18,4)=0.00, @BSEFOOBSX2_Old as decimal(18,4)=0.00,
@BSEFOFL as decimal(18,4)=0.00,    
@BSEFOFMin as decimal(18,4)=0.00,@BSEFOFFu as decimal(18,4)=0.00,@BSEFOSL as decimal(18,4)=0.00,@BSEFOSMin as decimal(18,4)=0.00,@BSEFOSFu as decimal(18,4)=0.00,  
@BSEFOFL_Old  as decimal(18,4)=0.00,@BSEFOFMin_Old as decimal(18,4)=0.00,@BSEFOFFu_Old as decimal(18,4)=0.00,    
   @BSEFOSL_Old as decimal(18,4)=0.00,@BSEFOSMin_Old as decimal(18,4)=0.00,@BSEFOSFu_Old as decimal(18,4)=0.00,  
   @BSXOPT_N1 as decimal(18,4)=0.00,@BSXOPT_N2 as decimal(18,4)=0.00,@SX500PT_N1 as decimal(18,4)=0.00,
@SX500PT_N2 as decimal(18,4)=0.00,@BSEFOOALL_S1 as decimal(18,4)=0.00,@BSEFOOALL_S2 as decimal(18,4)=0.00,
@BKXOPT_B1 as decimal(18,4)=0.00,@BKXOPT_B2 as decimal(18,4)=0.00,
   @BSXOPT_N1_Old as decimal(18,4)=0.00,@BSXOPT_N2_Old as decimal(18,4)=0.00,@SX500PT_N1_Old as decimal(18,4)=0.00,
@SX500PT_N2_Old as decimal(18,4)=0.00,@BSEFOOALL_S1_Old as decimal(18,4)=0.00,@BSEFOOALL_S2_Old as decimal(18,4)=0.00,
@BKXOPT_B1_Old as decimal(18,4)=0.00,@BKXOPT_B2_Old as decimal(18,4)=0.00,
@NCEL1 as decimal(18,4)=0.00,@NCE1M as decimal(18,4)=0.00,@NCE1Fu as decimal(18,4)=0.00,
@NCEL2 as decimal(18,4)=0.00,@NCE2M as decimal(18,4)=0.00,@NCE2Fu as decimal(18,4)=0.00,

@NCEL1_Old as decimal(18,4)=0.00,@NCE1M_Old as decimal(18,4)=0.00,@NCE1Fu_Old as decimal(18,4)=0.00,  
@NCEL2_Old as decimal(18,4)=0.00,@NCE2M_Old as decimal(18,4)=0.00,@NCE2Fu_Old as decimal(18,4)=0.00


declare @BSEL1_Old as decimal(18,4)=0.00,@BSEM1_Old as decimal(18,4)=0.00,@BseP1_Old as decimal(18,4)=0.00,@BSEL2_Old as decimal(18,4)=0.00,@BSEM2_Old as decimal(18,4)=0.00,  
@BseP2_Old as decimal(18,4)=0.00,@BSEDel_Old as decimal(18,4)=0.00,@BSEMDel_Old as decimal(18,4)=0.00,@BsePDel_Old as decimal(18,4)=0.00,@NSEL1_Old as decimal(18,4)=0.00,@NSEM1_Old as decimal(18,4)=0.00,  
@NSEP1_Old as decimal(18,4)=0.00,@NSEL2_Old as decimal(18,4)=0.00,@NSEM2_Old as decimal(18,4)=0.00,@NSEP2_Old as decimal(18,4)=0.00,  
@NSELDel_Old as decimal(18,4)=0.00,@NSEMDel_Old as decimal(18,4)=0.00,@NSEPDel_Old as decimal(18,4)=0.00,@MCXL1_Old as decimal(18,4)=0.00,@MCX1M_Old as decimal(18,4)=0.00,@MCX1Fu_Old as decimal(18,4)=0.00,  
@MCXL2_Old as decimal(18,4)=0.00,@MCX2M_Old as decimal(18,4)=0.00,@MCX2Fu_Old as decimal(18,4)=0.00,@NCDX1L_Old as decimal(18,4)=0.00,@NCDX1Min_Old as decimal(18,4)=0.00,@NCDX1Fu_Old as decimal(18,4)=0.00,  
@NCDX2L_Old as decimal(18,4)=0.00,@NCDX2Min_Old as decimal(18,4)=0.00,@NCDX2Fu_Old as decimal(18,4)=0.00,@NSEFOFL_Old as decimal(18,4)=0.00,  
@NSEFOFMin_Old as decimal(18,4)=0.00,@NSEFOFFu_Old as decimal(18,4)=0.00,@NSEFOSL_Old as decimal(18,4)=0.00,@NSEFOSMin_Old as decimal(18,4)=0.00,@NSEFOSFu_Old as decimal(18,4)=0.00,  
@NSX1_Old as decimal(18,4)=0.00,@NSX2_Old as decimal(18,4)=0.00,@NSEFOOS1_Old as decimal(18,4)=0.00,@NSEFOOS2_Old as decimal(18,4)=0.00,@NSEFOON1_Old as decimal(18,4)=0.00,@NSEFOON2_Old as decimal(18,4)=0.00,  
@NSEFOOB1_Old as decimal(18,4)=0.00,@NSEFOOB2_Old as decimal(18,4)=0.00,@NSEFOOFN1_Old as decimal(18,4)=0.00,@NSEFOOFN2_Old as decimal(18,4)=0.00,@NSXO1_Old as decimal(18,4)=0.00,@NSXO2_Old as decimal(18,4)=0.00,@MCD1_Old as decimal(18,4)=0.00,@MCD2_Old as decimal(18,4)=0.00,  
@MCDO1_Old as decimal(18,4)=0.00,@MCDO2_Old as decimal(18,4)=0.00 , 
@NSEFOOMCN1  as decimal(18,4)=0.00,@NSEFOOMCN2 as decimal(18,4)=0.00,@NSEFOOMCN1_Old  as decimal(18,4)=0.00,
@NSEFOOMCN2_Old  as decimal(18,4)=0.00,

@MCXOP_Silver1M  as decimal(18,4)=0.00 ,@MCXOP_Silver2M as decimal(18,4)=0.00,    
@MCXOP_Copper1M as decimal(18,4)=0.00,@MCXOP_Copper2M as decimal(18,4)=0.00,   
@MCXOP_Zinc1M as decimal(18,4)=0.00, @MCXOP_Zinc2M as decimal(18,4)=0.00,   
@MCXOP_Gold1M as decimal(18,4)=0.00 ,@MCXOP_Gold2M as decimal(18,4)=0.00,     
@MCXOP_Crudoil1M as decimal(18,4)=0.00 ,@MCXOP_Crudoil2M as decimal(18,4)=0.00, 
@MCXOP_NaturalGas1M as decimal(18,4)=0.00 ,@MCXOP_NaturalGas2M as decimal(18,4)=0.00,  
@MCXOP_ALL1M as decimal(18,4)=0.00 ,@MCXOP_ALL2M as decimal(18,4)=0.00, 
  
@MCXOP_Silver1M_Old  as decimal(18,4)=0.00, @MCXOP_Silver2M_Old decimal(18,4)=0.00 ,    
@MCXOP_Copper1M_Old decimal(18,4)=0.00 ,@MCXOP_Copper2M_Old decimal(18,4)=0.00,   
@MCXOP_Zinc1M_Old decimal(18,4)=0.00 ,@MCXOP_Zinc2M_Old decimal(18,4)=0.00, 
@MCXOP_Gold1M_Old decimal(18,4)=0.00 ,@MCXOP_Gold2M_Old decimal(18,4)=0.00,     
@MCXOP_Crudoil1M_Old decimal(18,4)=0.00 ,@MCXOP_Crudoil2M_Old decimal(18,4)=0.00, 
@MCXOP_NaturalGas1M_Old decimal(18,4)=0.00 ,@MCXOP_NaturalGas2M_Old decimal(18,4)=0.00, 
@MCXOP_ALL1M_Old decimal(18,4)=0.00 ,@MCXOP_ALL2M_Old decimal(18,4)=0.00, 

@NCEOP_Silver1M  as decimal(18,4)=0.00,@NCEOP_Silver2M as decimal(18,4)=0.00,  
@NCEOP_Copper1M as decimal(18,4)=0.00,@NCEOP_Copper2M as decimal(18,4)=0.00,   
@NCEOP_Zinc1M as decimal(18,4)=0.00,@NCEOP_Zinc2M as decimal(18,4)=0.00,   
@NCEOP_Gold1M as decimal(18,4)=0.00 ,@NCEOP_Gold2M as decimal(18,4)=0.00,    
@NCEOP_Crudoil1M as decimal(18,4)=0.00,@NCEOP_Crudoil2M as decimal(18,4)=0.00, 
@NCEOP_NaturalGas1M as decimal(18,4)=0.00,@NCEOP_NaturalGas2M as decimal(18,4)=0.00,    
@NCEOP_ALL1M as decimal(18,4)=0.00,@NCEOP_ALL2M as decimal(18,4)=0.00, 
  
@NCEOP_Silver1M_Old  as decimal(18,4)=0.00,@NCEOP_Silver2M_Old decimal(18,4)=0.00,   
@NCEOP_Copper1M_Old decimal(18,4)=0.00,@NCEOP_Copper2M_Old decimal(18,4)=0.00,    
@NCEOP_Zinc1M_Old decimal(18,4)=0.00,@NCEOP_Zinc2M_Old decimal(18,4)=0.00, 
@NCEOP_Gold1M_Old decimal(18,4)=0.00,@NCEOP_Gold2M_Old decimal(18,4)=0.00,    
@NCEOP_Crudoil1M_Old decimal(18,4)=0.00,@NCEOP_Crudoil2M_Old decimal(18,4)=0.00,   
@NCEOP_NaturalGas1M_Old decimal(18,4)=0.00,@NCEOP_NaturalGas2M_Old decimal(18,4)=0.00 ,  
@NCEOP_ALL1M_Old decimal(18,4)=0.00,@NCEOP_ALL2M_Old decimal(18,4)=0.00,

@NCXOP_Silver1M  as decimal(18,4)=0.00 ,@NCXOP_Silver2M as decimal(18,4)=0.00,    
@NCXOP_Copper1M as decimal(18,4)=0.00,@NCXOP_Copper2M as decimal(18,4)=0.00,   
@NCXOP_Zinc1M as decimal(18,4)=0.00, @NCXOP_Zinc2M as decimal(18,4)=0.00,   
@NCXOP_Gold1M as decimal(18,4)=0.00 ,@NCXOP_Gold2M as decimal(18,4)=0.00,     
@NCXOP_Crudoil1M as decimal(18,4)=0.00 ,@NCXOP_Crudoil2M as decimal(18,4)=0.00, 
@NCXOP_NaturalGas1M as decimal(18,4)=0.00 ,@NCXOP_NaturalGas2M as decimal(18,4)=0.00,  
@NCXOP_ALL1M as decimal(18,4)=0.00 ,@NCXOP_ALL2M as decimal(18,4)=0.00, 
  
@NCXOP_Silver1M_Old  as decimal(18,4)=0.00, @NCXOP_Silver2M_Old decimal(18,4)=0.00 ,    
@NCXOP_Copper1M_Old decimal(18,4)=0.00 ,@NCXOP_Copper2M_Old decimal(18,4)=0.00,   
@NCXOP_Zinc1M_Old decimal(18,4)=0.00 ,@NCXOP_Zinc2M_Old decimal(18,4)=0.00, 
@NCXOP_Gold1M_Old decimal(18,4)=0.00 ,@NCXOP_Gold2M_Old decimal(18,4)=0.00,     
@NCXOP_Crudoil1M_Old decimal(18,4)=0.00 ,@NCXOP_Crudoil2M_Old decimal(18,4)=0.00, 
@NCXOP_NaturalGas1M_Old decimal(18,4)=0.00 ,@NCXOP_NaturalGas2M_Old decimal(18,4)=0.00, 
@NCXOP_ALL1M_Old decimal(18,4)=0.00 ,@NCXOP_ALL2M_Old decimal(18,4)=0.00, 

@clientcount as int=0,@pcount as int=1,@M_pcode as varchar(10)=''
DECLARE @emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)   

declare @ClientEmail as varchar(50)='',@ClientName as varchar(100)='',@SBCode as varchar(100),
@emp_email_CC as varchar(100)

--exec angelnsecm.msajag.dbo.Brokerge_allDate

SELECT @emailto='hrishikesh.yerunkar@angelbroking.com;nilesh@angelbroking.com;yogen.gandhi@angelbroking.com'         
SELECT @emailcc='hrishikesh.yerunkar@angelbroking.com'
--SELECT @emailbcc='brokerage.intimation@angelbroking.com'           
  DECLARE @MessBody NVARCHAR(MAX) 
  set @MessBody=''
--select distinct * into  #Client1 from angelNSECM.msajag.dbo.Brokerage_ForMail with(nolock) where party_code in 
--(select party_Code from dustbin.dbo.Brok_Client_forMail with(nolock))

select distinct * into  #Client1 from angelNSECM.msajag.dbo.Brokerage_ForMail with(nolock) where party_code =@CODE

select ROW_NUMBER() OVER ( ORDER BY party_code) AS Srno,* into #Client from #Client1

select distinct party_code into #party1 from #Client -- where party_code='POTR1008'
select  ROW_NUMBER() OVER ( ORDER BY party_code) AS Srno,* into #party from #party1
select @clientcount=COUNT(1) from #party

while    @pcount<=   @clientcount
begin

select @M_pcode=party_code from #party where SrNo=@pcount
select @ClientEmail=email,@ClientName=long_name from RISK.DBO.client_details where party_code=@M_pcode

--------------BSE CASH--------------- 
 select @BSEM1=isnull(FRIST_LEG_MIN_NEW,0),@BSEP1=isnull(FRIST_LEG_MAX_NEW,0),@BSEM2=isnull(SECOND_LEG_MIN_NEW,0),
@BSEP2=isnull(SECOND_LEG_MAX_NEW,0),@BSEM1_Old=isnull(FRIST_LEG_MIN_OLD,0),@BSEP1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@BSEM2_Old=isnull(SECOND_LEG_MIN_OLD,0),@BSEP2_Old=isnull(SECOND_LEG_MAX_OLD,0)
	from #Client with(nolock) where  segment='BSE CASH' and scheme_type='TRD' and party_code=@M_pcode

select	@BSEMDEL=isnull(FRIST_LEG_MIN_NEW,0),@BSEPDel=isnull(FRIST_LEG_MAX_NEW,0),@BSEMDEL_Old=isnull(FRIST_LEG_MIN_OLD,0),
	@BSEPDel_Old=isnull(FRIST_LEG_MAX_OLD,0)	from #Client with(nolock) where  segment='BSE CASH' 
	and scheme_type='DEL'  and party_code=@M_pcode

if(@BSEM1>0 or @BSEP1>0 or @BSEM2>0 or @BSEP2>0)
begin
create table #BSE
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 

    insert into #BSE                   
	select '1st Leg' as Type,@BSEM1 as Min,@BSEP1 as Per          

	insert into #BSE                                     
	select '2nd Leg' as Type,@BSEM2 as Min,@BSEP2 as Per

	insert into #BSE                   
	select 'Delivery' as Type,@BSEMDEL as Min,@BSEPDel  as Per

	create table #BSE_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #BSE_OLD                   
	select '1st Leg' as Type,@BSEM1_Old as Min,@BSEP1_OLd as Per          

	insert into #BSE_OLD                                     
	select '2nd Leg' as Type,@BSEM2_Old as Min,@BSEP2_old as Per

	insert into #BSE_OLD                   
	select 'Delivery' as Type,@BSEMDEL_Old as Min,@BSEPDel_old  as Per   

		  declare @Count int,@CountEnd int,@Type as varchar(20)='',@Min as varchar(50),@Per as varchar(50)
	  declare @MESS NVARCHAR(MAX)
	  declare @MESSBSE NVARCHAR(MAX) =''     
	  DECLARE @xml NVARCHAR(MAX)              
	   DECLARE @Data NVARCHAR(MAX) ,  @totctrOT as int=0          
	           
		set @Data=''                
 		set @MESS=''          
		set @Count=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa from #BSE          
		 SELECT @totctrOT=count(1) from #aa           
	   SET @MESS=                            
	   '<table border="1" cellpadding="2" cellspacing="2">
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr>                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min  </th>                            
		   <th  align="center"> Per(%)   </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @Count <= @totctrOT                              
		 BEGIN                        
		  SELECT @Type=Type, @Min=Min,@Per=Per FROM #aa WHERE Srno=@count                                   
		  set @Data=@Data+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @Count=@Count+1                                    
		 END
		 SET @MESS= @MESS + @Data +'</Table>' 
  declare @Count_OLD int,@CountEnd_OLD int,@Type_OLD as varchar(20)='',@Min_OLD as varchar(50),@Per_OLD as varchar(50)
	  declare @MESS_OLD NVARCHAR(MAX)     
	  DECLARE @xml_OLD NVARCHAR(MAX)              
	   DECLARE @Data_OLD NVARCHAR(MAX) ,  @totctrOT_OLD as int=0          
	           
		set @Data_OLD=''                
		                        
		set @MESS_OLD=''          
		set @Count_OLD=1                                    
	              
	              
		select  row_number()over (order by Type_OLD ) As Srno,Type_OLD ,Min_OLD ,Per_OLD  into #aa_Old from #BSE_OLD          
		 SELECT @totctrOT_OLD=count(1) from #aa_Old           
	   SET @MESS_OLD=                            
	   '<table border="1" cellpadding="2" cellspacing="2">
	   <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min </th>                            
		   <th  align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @Count_OLD <= @totctrOT_OLD                              
		 BEGIN                        
		  SELECT @Type_OLD=Type_OLD, @Min_OLD=Min_OLD,@Per_OLD=Per_OLD FROM #aa_OLD WHERE Srno=@count_OLD                                   
		  set @Data_OLD=@Data_OLD+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type_OLD) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min_OLD) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per_OLD) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @Count_OLD=@Count_OLD+1                                    
		 END
		 
		 SET @MESS_OLD=  @MESS_OLD + @Data_OLD +'</Table>'
		 --print @MESS
		 --set @MESSBSE='<Br><B>BSECM</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS_OLD + '</td><td> '+ @MESS +'</td></tr></Table>'            
				 set @MESSBSE='<Br><B>BSECM</B> <Br><Br>'+ '<Table> <tr> <td> '+ @MESS +'</td></tr></Table>'            


IF OBJECT_ID('tempdb..#BSE', 'U') IS NOT NULL
    DROP TABLE #BSE
IF OBJECT_ID('tempdb..#aa', 'U') IS NOT NULL
    DROP TABLE #aa
IF OBJECT_ID('tempdb..#BSE_Old', 'U') IS NOT NULL
drop table #BSE_Old
IF OBJECT_ID('tempdb..#aa_Old', 'U') IS NOT NULL
drop table #aa_Old
end
--------------NSE CASH--------------- 
 select @NSEM1=isnull(FRIST_LEG_MIN_NEW,0),@NSEP1=isnull(FRIST_LEG_MAX_NEW,0),@NSEM2=isnull(SECOND_LEG_MIN_NEW,0),
@NSEP2=isnull(SECOND_LEG_MAX_NEW,0),@NSEM1_Old=isnull(FRIST_LEG_MIN_OLD,0),@NSEP1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@NSEM2_Old=isnull(SECOND_LEG_MIN_OLD,0),@NSEP2_Old=isnull(SECOND_LEG_MAX_OLD,0)
	from #Client with(nolock) where  segment='NSE CASH' and scheme_type='TRD' and party_code=@M_pcode

select	@NSEMDEL=isnull(FRIST_LEG_MIN_NEW,0),@NSEPDel=isnull(FRIST_LEG_MAX_NEW,0),@NSEMDEL_Old=isnull(FRIST_LEG_MIN_OLD,0),
	@NSEPDel_Old=isnull(FRIST_LEG_MAX_OLD,0)	from #Client with(nolock) where  segment='NSE CASH' 
	and scheme_type='DEL'  and party_code=@M_pcode

if(@NSEM1>0 or @NSEP1>0 or @NSEM2>0 or @NSEP2>0)
begin
create table #NSE
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 

    insert into #NSE                   
	select '1st Leg' as Type,@NSEM1 as Min,@NSEP1 as Per          

	insert into #NSE                                     
	select '2nd Leg' as Type,@NSEM2 as Min,@NSEP2 as Per

	insert into #NSE                   
	select 'Delivery' as Type,@NSEMDEL as Min,@NSEPDel  as Per

	create table #NSE_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #NSE_OLD                   
	select '1st Leg' as Type,@NSEM1_Old as Min,@NSEP1_OLd as Per          

	insert into #NSE_OLD                                     
	select '2nd Leg' as Type,@NSEM2_Old as Min,@NSEP2_old as Per

	insert into #NSE_OLD                   
	select 'Delivery' as Type,@NSEMDEL_Old as Min,@NSEPDel_old  as Per   

		  declare @Count_NSE int,@CountEnd_NSE int,@Type_NSE as varchar(20)='',@Min_NSE as varchar(50),@Per_NSE as varchar(50)
	  declare @MESS_NSE NVARCHAR(MAX)
	  declare @MESSNSE NVARCHAR(MAX) =''     
	  DECLARE @xml_NSE NVARCHAR(MAX)              
	   DECLARE @Data_NSE NVARCHAR(MAX) ,  @totctrOT_NSE as int=0          
	           
		set @Data_NSE=''                
 		set @MESS_NSE=''          
		set @Count_NSE=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa_NSE from #NSE          
		 SELECT @totctrOT_NSE=count(1) from #aa_NSE           
	   SET @MESS_NSE=                            
	   '<table border="1" cellpadding="2" cellspacing="2">
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr>                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min  </th>                            
		   <th  align="center"> Per(%)   </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @Count_NSE <= @totctrOT_NSE                              
		 BEGIN                        
		  SELECT @Type_NSE=Type, @Min_NSE=Min,@Per_NSE=Per FROM #aa_NSE WHERE Srno=@count_NSE                                   
		  set @Data_NSE=@Data_NSE+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type_NSE) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min_NSE) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per_NSE) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @Count_NSE=@Count_NSE+1                                    
		 END
		 SET @MESS_NSE= @MESS_NSE + @Data_NSE +'</Table>' 
  declare @Count_OLD_NSE int,@CountEnd_OLD_NSE int,@Type_OLD_NSE as varchar(20)='',@Min_OLD_NSE as varchar(50),@Per_OLD_NSE as varchar(50)
	  declare @MESS_OLD_NSE NVARCHAR(MAX)     
	  DECLARE @xml_OLD_NSE NVARCHAR(MAX)              
	   DECLARE @Data_OLD_NSE NVARCHAR(MAX) ,  @totctrOT_OLD_NSE as int=0          
	           
		set @Data_OLD_NSE=''                
		                        
		set @MESS_OLD_NSE=''          
		set @Count_OLD_NSE=1                                    
	              
	              
		select  row_number()over (order by Type_OLD ) As Srno,Type_OLD ,Min_OLD ,Per_OLD  into #aa_NSE_Old from #NSE_OLD          
		 SELECT @totctrOT_OLD_NSE=count(1) from #aa_NSE_Old           
	   SET @MESS_OLD_NSE=                            
	   '<table border="1" cellpadding="2" cellspacing="2">
	   <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min </th>                            
		   <th  align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @Count_OLD_NSE <= @totctrOT_OLD_NSE                              
		 BEGIN                        
		  SELECT @Type_OLD_NSE=Type_OLD, @Min_OLD_NSE=Min_OLD,@Per_OLD_NSE=Per_OLD FROM #aa_NSE_OLD WHERE Srno=@count_OLD_NSE                                   
		  set @Data_OLD_NSE=@Data_OLD_NSE+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type_OLD_NSE) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min_OLD_NSE) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per_OLD_NSE) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @Count_OLD_NSE=@Count_OLD_NSE+1                                    
		 END
		 
		 SET @MESS_OLD_NSE=  @MESS_OLD_NSE + @Data_OLD_NSE +'</Table>'
		 --print @MESS
		 --set @MESSNSE='<Br><B>NSECM</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS_OLD_NSE + '</td><td> '+ @MESS_NSE+'</td></tr></Table>'            
		 set @MESSNSE='<Br><B>NSECM</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS_NSE+'</td></tr></Table>'            

IF OBJECT_ID('tempdb..#NSE', 'U') IS NOT NULL
    DROP TABLE #NSE
IF OBJECT_ID('tempdb..#aa_NSE', 'U') IS NOT NULL
    DROP TABLE #aa_NSE
IF OBJECT_ID('tempdb..#NSE_Old', 'U') IS NOT NULL
drop table #NSE_Old
IF OBJECT_ID('tempdb..#aa_NSE_Old', 'U') IS NOT NULL
drop table #aa_NSE_Old
end
----------------------NSEFO-------------------------
select @NSEFOFMin=isnull(Frist_Leg_min_New,0),@NSEFOFFu=isnull(Frist_Leg_max_New,0),@NSEFOSMin=isnull(Second_Leg_Min_New,0),
@NSEFOSFu=isnull(Second_Leg_max_New,0)
	from  #Client with(nolock) where  segment='NSE FO' and scheme_type='TRD' and party_code=@M_pcode

select	@NSEFOFMin_Old=isnull(FRIST_LEG_MAX_OLD,0),@NSEFOFFu_Old=isnull(FRIST_LEG_MIN_OLD,0),@NSEFOSMin_Old=isnull(SECOND_LEG_MIN_OLD,0),
	@NSEFOSFu_Old=isnull(SECOND_LEG_MAX_OLD,0)	from #Client with(nolock) where  segment='NSE FO'  and party_code=@M_pcode
	and scheme_type='TRD'
---------------------------
if(@NSEFOFMin>0 or @NSEFOFFu>0 or @NSEFOSMin>0 or @NSEFOSFu>0)
begin
	create table #NSEFO
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 
	insert into #NSEFO                   
	select '1st Leg' as Type,@NSEFOFMin as Min,@NSEFOFFu as Per          

	insert into #NSEFO                                     
	select '2nd Leg' as Type,@NSEFOSMin as Min,@NSEFOSFu as Per
	
	create table #NSEFO_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #NSEFO_OLD                   
	select '1st Leg' as Type,@NSEFOFMin_Old as Min,@NSEFOFFu_Old as Per          
	insert into #NSEFO_OLD                                     
	select '2nd Leg' as Type,@NSEFOSMin_Old as Min,@NSEFOSFu_Old as Per

           
	  declare @CountNSEFO int,@CountEndNSEFO1 int,@Type2 as varchar(20)='',@Min2 as varchar(50),@Per2 as varchar(50)           
	  DECLARE @MessBody2 NVARCHAR(MAX) ,@MESS2 NVARCHAR(MAX) ,@Mess2_NSEFO  NVARCHAR(MAX)                       
	   DECLARE @Data2 NVARCHAR(MAX) ,  @totctrOTNSEFO as int=0          
	           
		set @Data2=''                
		--set @MessBody=''                          
		set @MESS2='' 
		set @Mess2_NSEFO=''         
		set @CountNSEFO=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa2 from #NSEFO          
		 SELECT @totctrOTNSEFO=count(1) from #aa2           
	   SET @MESS2=                            
	   '<table border="1" cellpadding="2" cellspacing="2">                            
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr> 
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountNSEFO <= @totctrOTNSEFO                              
		 BEGIN                        
		  SELECT @Type2=Type, @Min2=Min,@Per2=Per FROM #aa2 WHERE Srno=@CountNSEFO                                   
		  set @Data2=@Data2+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type2) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min2) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per2) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountNSEFO=@CountNSEFO+1                                    
		 END             
  SET @MESS2= @MESS2 + @Data2 +'</Table>' 
  
  declare @CountNSEFO_Old int,@CountEndNSEFO1_Old int,@Type2_Old as varchar(20)='',@Min2_Old as varchar(50),@Per2_Old as varchar(50)           
	  DECLARE @MessBody2_Old NVARCHAR(MAX) ,@MESS2_Old NVARCHAR(MAX)                        
	   DECLARE @Data2_Old NVARCHAR(MAX) ,  @totctrOTNSEFO_Old as int=0          
	           
		set @Data2_Old=''                
		--set @MessBody=''                          
		set @MESS2_Old=''          
		set @CountNSEFO_Old=1                                    
	              
	              
		select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa2_Old from #NSEFO_Old          
		 SELECT @totctrOTNSEFO_Old=count(1) from #aa2_Old           
	   SET @MESS2_Old=                            
	   '<table border="1" cellpadding="2" cellspacing="2"> 
	    <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountNSEFO_Old <= @totctrOTNSEFO_Old                              
		 BEGIN                        
		  SELECT @Type2_Old=Type_Old, @Min2_Old=Min_Old,@Per2_Old=Per_Old FROM #aa2_Old WHERE Srno=@CountNSEFO_Old                                   
		  set @Data2_Old=@Data2_Old+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type2_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min2_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per2_Old) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountNSEFO_Old=@CountNSEFO_Old+1                                    
		 END             
  SET @MESS2_Old= @MESS2_Old + @Data2_Old +'</Table>'  
   --set @Mess2_NSEFO='<Br><B>NSEFO</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS2_Old + '</td><td> '+ @MESS2 +'</td></tr></Table>'  
    set @Mess2_NSEFO='<Br><B>NSEFO</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS2 +'</td></tr></Table>'  

IF OBJECT_ID('tempdb..#NSEFO', 'U') IS NOT NULL
DROP TABLE #NSEFO
IF OBJECT_ID('tempdb..#aa2', 'U') IS NOT NULL
DROP TABLE #aa2
IF OBJECT_ID('tempdb..#NSEFO_Old', 'U') IS NOT NULL
drop table #NSEFO_Old
IF OBJECT_ID('tempdb..#aa2_Old', 'U') IS NOT NULL
drop table #aa2_Old
end
-----------------------NSEFO Option--------------------------------------
set @NSEFOOS1=0.00
set @NSEFOOS2=0.00
select @NSEFOOS1=isnull(FRIST_LEG_MAX_NEW,0),@NSEFOOS2=isnull(SECOND_LEG_MAX_NEW,0),@NSEFOOS1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@NSEFOOS2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='NSE OPT' and scheme_type='ALL'
 and party_code=@M_pcode

select @NSEFOON1=isnull(FRIST_LEG_MAX_NEW,0),@NSEFOON2=isnull(SECOND_LEG_MAX_NEW,0),@NSEFOON1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@NSEFOON2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='NSE OPT' and scheme_type='NIFTY'
 and party_code=@M_pcode

select @NSEFOOB1=isnull(FRIST_LEG_MAX_NEW,0),@NSEFOOB2=isnull(SECOND_LEG_MAX_NEW,0),@NSEFOOB1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@NSEFOOB2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='NSE OPT' and scheme_type='BANKNIFTY'
 and party_code=@M_pcode

select @NSEFOOFN1=isnull(FRIST_LEG_MAX_NEW,0),@NSEFOOFN2=isnull(SECOND_LEG_MAX_NEW,0),@NSEFOOFN1_Old=isnull(FRIST_LEG_MAX_OLD,0)
,@NSEFOOFN2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='NSE OPT' and scheme_type='FINNIFTY'


select @NSEFOOMCN1=isnull(FRIST_LEG_MAX_NEW,0),@NSEFOOMCN2=isnull(SECOND_LEG_MAX_NEW,0),@NSEFOOMCN1_Old=isnull(FRIST_LEG_MAX_OLD,0)
,@NSEFOOMCN2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='NSE OPT' and scheme_type='MIDCPNIFTY'
 and party_code=@M_pcode

if(@NSEFOOS1>0 or @NSEFOOS2>0 or @NSEFOON1>0 or @NSEFOON2>0 or @NSEFOOB1>0 or @NSEFOOB2>0 or @NSEFOOFN1>0 or @NSEFOOFN2>0 or
 @NSEFOOMCN1>0 or @NSEFOOMCN2>0)
begin
print 'atharva'
print @NSEFOOS1
print 'klj'
create table #NSEFOOpt
(
Type  varchar(50),
Stock  varchar(50),
Nifty  varchar(50),
BankNifty  varchar(50),
FinNifty  varchar(50),
MidCPNifty varchar(50)
) 
insert into #NSEFOOpt                   
select '1st Leg' as Type,@NSEFOOS1 as Stock ,@NSEFOON1 as Nifty, @NSEFOOB1 as BankNifty,@NSEFOOFN1 as FinNifty,@NSEFOOMCN1 as MidCPNifty       

insert into #NSEFOOpt                                     
select '2nd Leg' as Type,@NSEFOOS2 as Stock ,@NSEFOON2 as Nifty, @NSEFOOB2 as BankNifty,@NSEFOOFN2 as FinNifty,@NSEFOOMCN2 as MidCPNifty  

--create table #NSEFOOpt_Old
--(
--Type_Old  varchar(50),
--Stock_Old  varchar(50),
--Nifty_Old  varchar(50),
--BankNifty_Old  varchar(50),
--FinNifty_Old  varchar(50),
--MidCPNifty_old  varchar(50)
--) 
--insert into #NSEFOOpt_Old                   
--select '1st Leg' as Type_Old,@NSEFOOS1_Old as Stock_Old ,@NSEFOON1_Old as Nifty_Old, @NSEFOOB1_Old as BankNifty_Old,
--@NSEFOOFN1_Old as FinNifty_Old,@NSEFOOMCN1_Old as MidCPNifty_old

--insert into #NSEFOOpt_Old                                     
--select '2nd Leg' as Type_Old,@NSEFOOS2_Old as Stock_Old ,@NSEFOON2_Old as Nifty_Old, @NSEFOOB2_Old as BankNifty_Old,
--@NSEFOOFN2_Old as FinNifty_Old,@NSEFOOMCN2_Old as MidCPNifty_old
            
  declare @Count7 int,@CountEnd7 int,@Type7 as varchar(20)='',@stock as varchar(50),@nifty as varchar(50),@Banknifty as varchar(50)
  ,@Finnifty as varchar(50),@midcpnifty as varchar(50)
  DECLARE @MessBody7 NVARCHAR(MAX) ,@MESS7 NVARCHAR(MAX) ,@Mess7_NSEFOOpt NVARCHAR(MAX)        
  DECLARE @xml7 NVARCHAR(MAX)              
   DECLARE @Data7 NVARCHAR(MAX) ,  @totctrOT7 as int=0          
           
    set @Data7=''                
    set @MessBody7=''                          
    set @MESS7=''          
    set @Count7=1  
    set @Mess7_NSEFOOpt=''                                  
              
              
    select  row_number()over (order by Type) As Srno,Type,Stock,Nifty,BankNifty,FinNifty,MidCPNifty into #aa7 from #NSEFOOpt          
     SELECT @totctrOT7=count(1) from #aa7           
   SET @MESS7=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
      <tr><th  align="center" colspan="6">New Brokerage </th>
	   </tr>                           
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Stock Rs./Lot </th>                                                                                 
       <th align="center"> Nifty Rs./Lot </th>
       <th align="center"> Bank Nifty Rs./Lot </th>
       <th align="center"> Fin Nifty Rs./Lot </th>
	   <th align="center"> MidCP Nifty Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count7 <= @totctrOT7                              
     BEGIN  
	 set @stock=0.00
	 set @nifty=0.00
	 set @Banknifty=0.00
	 set @Finnifty=0.00
	 set @midcpnifty=0.00
	
      SELECT @Type7=Type,@stock=Stock,@nifty=Nifty,@Banknifty=BankNifty,@Finnifty=FinNifty,@midcpnifty=MidCPNifty FROM #aa7 WHERE Srno=@count7                                   
      set @Data7=@Data7+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type7) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@stock) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@nifty) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@Banknifty) +' </td>                                                                      
         <td align="center"> '+ CONVERT(VARCHAR,@Finnifty) +' </td>  
         <td align="center"> '+ CONVERT(VARCHAR,@midcpnifty) +' </td>                                                                      		 
       </tr>' 
	   print 'nn'
	   print @stock
	   print 'yy'
       print @Data7                         
      SET   @Count7=@Count7+1                                    
     END   
     SET @MESS7= @MESS7 + @Data7 +'</Table>'
     print  @MESS7 
     
--declare @Count7_Old int,@CountEnd7_Old int,@Type7_Old as varchar(20)='',@stock_Old as varchar(50),
--@nifty_Old as varchar(50),@Banknifty_Old as varchar(50) ,@finnifty_Old as varchar(50),@midcpnifty_old as varchar(50)         
--  DECLARE @MessBody7_Old NVARCHAR(MAX) ,@MESS7_Old NVARCHAR(MAX)         
--  DECLARE @xml7_Old NVARCHAR(MAX)              
--   DECLARE @Data7_Old NVARCHAR(MAX) ,  @totctrOT7_Old as int=0          
           
--    set @Data7_Old=''                
--    set @MessBody7_Old=''                          
--    set @MESS7_Old=''          
--    set @Count7_Old=1                                    
              
              
--    select  row_number()over (order by Type_Old) As Srno,Type_Old,Stock_Old,Nifty_Old,BankNifty_Old,FinNifty_Old,
--	MidCPNifty_old into #aa7_Old from #NSEFOOpt_Old          
--     SELECT @totctrOT7_Old=count(1) from #aa7_Old           
--   SET @MESS7_Old=                            
--   '<table border="1" cellpadding="2" cellspacing="2">  
--      <tr><th  align="center" colspan="6">Old Brokerage </th>
--	   </tr>                           
--   <tr>                       
--    <th align="center"> Type </th>                            
--       <th align="center"> Stock Rs./Lot </th>                                                                                 
--       <th align="center"> Nifty Rs./Lot </th>
--       <th align="center"> Bank Nifty Rs./Lot </th>
--       <th align="center"> Fin Nifty Rs./Lot </th>
--	          <th align="center"> MidCP Nifty Rs./Lot </th>
--   </tr>'          
----print @MESS          
--   WHILE @Count7_Old <= @totctrOT7_Old                              
--     BEGIN                        
--      SELECT @Type7_Old=Type_Old,@stock_Old=Stock_Old,@nifty_Old=Nifty_Old,@Banknifty_Old=BankNifty_Old,
--	  @finnifty_Old=FinNifty_Old,@midcpnifty_old=MidCPNifty_old FROM #aa7_Old WHERE Srno=@count7_Old                                   
--      set @Data7_Old=@Data7_Old+                           
--     '<tr>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@Type7_Old) +' </td>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@stock_Old) +' </td>   
--       <td align="center"> '+ CONVERT(VARCHAR,@nifty_Old) +' </td>   
--         <td align="center"> '+ CONVERT(VARCHAR,@Banknifty_Old) +' </td>                                                                      
--         <td align="center"> '+ CONVERT(VARCHAR,@finnifty_Old) +' </td>  
--		          <td align="center"> '+ CONVERT(VARCHAR,@midcpnifty_old) +' </td>                                                                      
--       </tr>'           
--       print @Data7_Old                         
--      SET   @Count7_Old=@Count7_Old+1                                    
--     END   
--     SET @MESS7_Old=@MESS7_Old + @Data7_Old +'</Table>' 
     --set @Mess7_NSEFOOpt='<Br><B>NSEFO Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS7_OLD + '</td><td> '+ @MESS7 +'</td></tr></Table>'          
     set @Mess7_NSEFOOpt='<Br><B>NSEFO Option</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS7 +'</td></tr></Table>'          
 
IF OBJECT_ID('tempdb..#NSEFOOpt', 'U') IS NOT NULL
DROP TABLE #NSEFOOpt
IF OBJECT_ID('tempdb..#aa7', 'U') IS NOT NULL
DROP TABLE #aa7
IF OBJECT_ID('tempdb..#NSEFOOpt_Old', 'U') IS NOT NULL
drop table #NSEFOOpt_Old
IF OBJECT_ID('tempdb..#aa7_Old', 'U') IS NOT NULL
drop table #aa7_Old
end
------------------MCX-------------------

	select @MCX1M=isnull(FRIST_LEG_MIN_NEW,0),@MCX1Fu=isnull(FRIST_LEG_MAX_NEW,0),@MCX2M=isnull(SECOND_LEG_MIN_NEW,0),
	@MCX2Fu=isnull(SECOND_LEG_MAX_NEW,0), @MCX1M_Old=ISNULL(Frist_Leg_min_Old,0),@MCX1Fu_Old=ISNULL(Frist_Leg_max_Old,0),
	@MCX2M_Old=ISNULL(Second_Leg_Min_Old,0),@MCX2Fu_Old=ISNULL(Second_Leg_max_Old,0)	from #Client with(nolock) where 
	segment='MCDX' and scheme_type='TRD' 
	and party_code=@M_pcode

if(@MCX1M>0 or @MCX1Fu>0 or @MCX2M>0 or @MCX2Fu>0)
begin
create table #MCX
(
Type  varchar(50),
Min  varchar(50),
Per  varchar(50)
) 
insert into #MCX                   
select '1st Leg' as Type,@MCX1M as Min,@MCX1Fu as Per          

insert into #MCX                                     
select '2nd Leg' as Type,@MCX2M as Min,@MCX2Fu as Per

create table #MCX_Old
(
Type_Old  varchar(50),
Min_Old  varchar(50),
Per_Old  varchar(50)
) 
insert into #MCX_Old                   
select '1st Leg' as Type_Old,@MCX1M_Old as Min_Old,@MCX1Fu_Old as Per_Old          

insert into #MCX_Old                                     
select '2nd Leg' as Type_Old,@MCX2M_Old as Min_Old,@MCX2Fu_Old as Per_Old
            
  declare @Count14 int,@CountEnd14 int,@Type14 as varchar(20)='',@Min14 as varchar(50),@Per14 as varchar(50)           
  DECLARE @MessBody14 NVARCHAR(MAX) ,@MESS14 NVARCHAR(MAX),@MESS14_MCX NVARCHAR(MAX)
  DECLARE @xml14 NVARCHAR(MAX)              
   DECLARE @Data14 NVARCHAR(MAX) ,  @totctrOT14 as int=0          
           
    set @Data14=''                
    set @MessBody14=''                          
    set @MESS14=''          
    set @Count14=1
    set @MESS14_MCX=''                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa14 from #MCX          
     SELECT @totctrOT14=count(1) from #aa14           
   SET @MESS14=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
      <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count14 <= @totctrOT14                              
     BEGIN                        
      SELECT @Type14=Type, @Min14=Min,@Per14=Per FROM #aa14 WHERE Srno=@count14                                   
      set @Data14=@Data14+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type14) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min14) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per14) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count14=@Count14+1                                    
     END 
      SET @MESS14=@MESS14 + @Data14 +'</Table>' 
            
  declare @Count14_Old int,@CountEnd14_Old int,@Type14_Old as varchar(20)='',@Min14_Old as varchar(50),@Per14_Old as varchar(50)           
  DECLARE @MessBody14_Old NVARCHAR(MAX) ,@MESS14_Old NVARCHAR(MAX)
  DECLARE @xml14_Old NVARCHAR(MAX)              
   DECLARE @Data14_Old NVARCHAR(MAX) ,  @totctrOT14_Old as int=0          
           
    set @Data14_Old=''                
    set @MessBody14_Old=''                          
    set @MESS14_Old=''          
    set @Count14_Old=1
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa14_Old from #MCX_Old          
     SELECT @totctrOT14_Old=count(1) from #aa14_Old           
   SET @MESS14_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">
      <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count14_Old <= @totctrOT14_Old                              
     BEGIN                        
      SELECT @Type14_Old=Type_Old, @Min14_Old=Min_Old,@Per14_Old=Per_Old FROM #aa14_Old WHERE Srno=@count14_Old                                   
      set @Data14_Old=@Data14_Old+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type14_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min14_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per14_Old) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count14_Old=@Count14_Old+1                                    
     END 
      SET @MESS14_Old=@MESS14_Old + @Data14_Old +'</Table>' 
      --set @MESS14_MCX='<Br><B>MCX</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS14_Old + '</td><td> '+ @MESS14 +'</td></tr></Table>'
      set @MESS14_MCX='<Br><B>MCX</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS14 +'</td></tr></Table>'
   
IF OBJECT_ID('tempdb..#MCX', 'U') IS NOT NULL
DROP TABLE #MCX
IF OBJECT_ID('tempdb..#aa14', 'U') IS NOT NULL
DROP TABLE #aa14
IF OBJECT_ID('tempdb..#MCX_Old', 'U') IS NOT NULL
drop table #MCX_Old
IF OBJECT_ID('tempdb..#aa14_Old', 'U') IS NOT NULL
drop table #aa14_Old
end
---------------------NCE-----------------------------

 	select @NCE1M=isnull(FRIST_LEG_MIN_NEW,0),@NCE1Fu=isnull(FRIST_LEG_MAX_NEW,0),@NCE2M=isnull(SECOND_LEG_MIN_NEW,0),
	@NCE2Fu=isnull(SECOND_LEG_MAX_NEW,0),@NCE1M_Old=ISNULL(Frist_Leg_min_Old,0),@NCE1Fu_Old=ISNULL(Frist_Leg_max_Old,0),
	@NCE2M_Old=ISNULL(Second_Leg_Min_Old,0),@NCE2Fu_Old=ISNULL(Second_Leg_max_Old,0)
	from #Client with(nolock) where 
	segment='NCE' and scheme_type='TRD' 
	and party_code=@M_pcode  

if(@NCE1M>0 or @NCE1Fu>0 or @NCE2M>0 or @NCE2Fu>0)
begin
create table #NCE
(
Type  varchar(50),
Min  varchar(50),
Per  varchar(50)
) 
insert into #NCE                   
select '1st Leg' as Type,@NCE1M as Min,@NCE1Fu as Per          

insert into #NCE                                     
select '2nd Leg' as Type,@NCE2M as Min,@NCE2Fu as Per

create table #NCE_Old
(
Type_Old  varchar(50),
Min_Old  varchar(50),
Per_Old  varchar(50)
) 
insert into #NCE_Old                   
select '1st Leg' as Type_Old,@NCE1M_Old as Min_Old,@NCE1Fu_Old as Per_Old          

insert into #NCE_Old                                     
select '2nd Leg' as Type_Old,@NCE2M_Old as Min_Old,@NCE2Fu_Old as Per_Old
            
  declare @Count145 int,@CountEnd145 int,@Type145 as varchar(20)='',@Min145 as varchar(50),@Per145 as varchar(50)           
  DECLARE @MessBody145 NVARCHAR(MAX) ,@MESS145 NVARCHAR(MAX),@MESS14_NCE NVARCHAR(MAX)
  DECLARE @xml145 NVARCHAR(MAX)              
   DECLARE @Data145 NVARCHAR(MAX) ,  @totctrOT145 as int=0          
           
    set @Data145=''                
    set @MessBody145=''                          
    set @MESS145=''          
    set @Count145=1
    set @MESS14_NCE=''                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa145 from #NCE          
     SELECT @totctrOT145=count(1) from #aa145           
   SET @MESS145=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
      <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count145 <= @totctrOT145                              
     BEGIN                        
      SELECT @Type145=Type, @Min145=Min,@Per145=Per FROM #aa145 WHERE Srno=@count145                                   
      set @Data145=@Data145+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type145) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min145) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per145) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count145=@Count145+1                                    
     END 
      SET @MESS145=@MESS145 + @Data145 +'</Table>' 
            
  declare @Count145_Old int,@CountEnd145_Old int,@Type145_Old as varchar(20)='',@Min145_Old as varchar(50),@Per145_Old as varchar(50)           
  DECLARE @MessBody145_Old NVARCHAR(MAX) ,@MESS145_Old NVARCHAR(MAX)
  DECLARE @xml145_Old NVARCHAR(MAX)              
   DECLARE @Data145_Old NVARCHAR(MAX) ,  @totctrOT145_Old as int=0          
           
    set @Data145_Old=''                
    set @MessBody145_Old=''                          
    set @MESS145_Old=''          
    set @Count145_Old=1
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa145_Old from #NCE_Old          
     SELECT @totctrOT145_Old=count(1) from #aa145_Old           
   SET @MESS145_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">
      <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count145_Old <= @totctrOT145_Old                              
     BEGIN                        
      SELECT @Type145_Old=Type_Old, @Min145_Old=Min_Old,@Per145_Old=Per_Old FROM #aa145_Old WHERE Srno=@count145_Old                                   
      set @Data145_Old=@Data145_Old+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type145_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min145_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per145_Old) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count145_Old=@Count145_Old+1                                    
     END 
      SET @MESS145_Old=@MESS145_Old + @Data145_Old +'</Table>' 
      --set @MESS14_NCE='<Br><B>NCE</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS145_Old + '</td><td> '+ @MESS145 +'</td></tr></Table>'
      set @MESS14_NCE='<Br><B>NCE</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS145 +'</td></tr></Table>'

IF OBJECT_ID('tempdb..#aa145_Old', 'U') IS NOT NULL
DROP TABLE #aa145_Old
IF OBJECT_ID('tempdb..#aa145', 'U') IS NOT NULL
DROP TABLE #aa145
IF OBJECT_ID('tempdb..#NCE', 'U') IS NOT NULL
drop table #NCE
IF OBJECT_ID('tempdb..#NCE_Old', 'U') IS NOT NULL
drop table #NCE_Old
end
-------------------NCDEX------------------------
select @NCDX1Min=isnull(FRIST_LEG_MIN_NEW,0),@NCDX1Fu=isnull(FRIST_LEG_MAX_NEW,0),@NCDX2Min=isnull(SECOND_LEG_MIN_NEW,0),
 @NCDX2Fu=isnull(SECOND_LEG_MAX_NEW,0),@NCDX1Min_Old=ISNULL(Frist_Leg_min_Old,0),@NCDX1Fu_Old=ISNULL(Frist_Leg_max_Old,0),
 @NCDX2Min_Old=ISNULL(Second_Leg_Min_Old,0),@NCDX2Fu_Old=ISNULL(Second_Leg_max_Old,0)
 from #Client with(nolock) where 
	segment='NCDX' and scheme_type='TRD' 
	and party_code=@M_pcode

if(@NCDX1Min>0 or @NCDX1Fu>0 or @NCDX2Min>0 or @NCDX2Fu>0)
begin
create table #NCDX
(
Type  varchar(50),
Min  varchar(50),
Per  varchar(50)
) 
insert into #NCDX                   
select '1st Leg' as Type,@NCDX1Min as Min,@NCDX1Fu as Per          

insert into #NCDX                                     
select '2nd Leg' as Type,@NCDX2Min as Min,@NCDX2Fu as Per

create table #NCDX_Old
(
Type_Old  varchar(50),
Min_Old  varchar(50),
Per_Old  varchar(50)
) 
insert into #NCDX_Old                   
select '1st Leg' as Type_Old,@NCDX1Min_Old as Min_Old,@NCDX1Fu_Old as Per_Old          

insert into #NCDX_Old                                     
select '2nd Leg' as Type_Old,@NCDX2Min_Old as Min_Old,@NCDX2Fu_Old as Per_Old
            
  declare @Count4 int,@CountEnd4 int,@Type4 as varchar(20)='',@Min4 as varchar(50),@Per4 as varchar(50)           
  DECLARE @MessBody4 NVARCHAR(MAX) ,@MESS4 NVARCHAR(MAX),@MESS4_NCDX NVARCHAR(MAX)
  DECLARE @xml4 NVARCHAR(MAX)              
   DECLARE @Data4 NVARCHAR(MAX) ,  @totctrOT4 as int=0          
           
    set @Data4=''                
    set @MessBody4=''                          
    set @MESS4=''          
    set @Count4=1
    set @MESS4_NCDX=''                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa4 from #NCDX          
     SELECT @totctrOT4=count(1) from #aa4           
   SET @MESS4=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
      <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count4 <= @totctrOT4                              
     BEGIN                        
      SELECT @Type4=Type, @Min4=Min,@Per4=Per FROM #aa4 WHERE Srno=@count4                                   
      set @Data4=@Data4+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type4) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min4) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per4) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count4=@Count4+1                                    
     END 
      SET @MESS4=@MESS4 + @Data4 +'</Table>' 
            
  declare @Count4_Old int,@CountEnd4_Old int,@Type4_Old as varchar(20)='',@Min4_Old as varchar(50),@Per4_Old as varchar(50)           
  DECLARE @MessBody4_Old NVARCHAR(MAX) ,@MESS4_Old NVARCHAR(MAX)
  DECLARE @xml4_Old NVARCHAR(MAX)              
   DECLARE @Data4_Old NVARCHAR(MAX) ,  @totctrOT4_Old as int=0          
           
    set @Data4_Old=''                
    set @MessBody4_Old=''                          
    set @MESS4_Old=''          
    set @Count4_Old=1
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa4_Old from #NCDX_Old          
     SELECT @totctrOT4_Old=count(1) from #aa4_Old           
   SET @MESS4_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">
      <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count4_Old <= @totctrOT4_Old                              
     BEGIN                        
      SELECT @Type4_Old=Type_Old, @Min4_Old=Min_Old,@Per4_Old=Per_Old FROM #aa4_Old WHERE Srno=@count4_Old                                   
      set @Data4_Old=@Data4_Old+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type4_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min4_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per4_Old) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count4_Old=@Count4_Old+1                                    
     END 
      SET @MESS4_Old=@MESS4_Old + @Data4_Old +'</Table>' 
      --set @MESS4_NCDX='<Br><B>NCDX</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS4_Old + '</td><td> '+ @MESS4 +'</td></tr></Table>'   
      set @MESS4_NCDX='<Br><B>NCDX</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS4 +'</td></tr></Table>'   

IF OBJECT_ID('tempdb..#NCDX', 'U') IS NOT NULL
DROP TABLE #NCDX
IF OBJECT_ID('tempdb..#aa4', 'U') IS NOT NULL
DROP TABLE #aa4
IF OBJECT_ID('tempdb..#NCDX_Old', 'U') IS NOT NULL
drop table #NCDX_Old
IF OBJECT_ID('tempdb..#aa4_Old', 'U') IS NOT NULL
drop table #aa4_Old
end
---------------------------NSX----------------------------
 select @NSX1=isnull(FRIST_LEG_MAX_NEW,0),@NSX2=isnull(SECOND_LEG_MAX_NEW,0),@NSX1_Old=ISNULL(Frist_Leg_max_Old,0),
  @NSX2_Old=ISNULL(Second_Leg_max_Old,0)  from #Client with(nolock) where 
	segment='NSE CURFO' and scheme_type='TRD' 
	and party_code=@M_pcode

if(@NSX1>0 or @NSX2>0)
begin
create table #NSXCurr
(
Type  varchar(50),
Future  varchar(50)
) 
insert into #NSXCurr                   
select '1st Leg' as Type,@NSX1 as Future         

insert into #NSXCurr                                     
select '2nd Leg' as Type,@NSX2 as Future

create table #NSXCurr_Old
(
Type_Old  varchar(50),
Future_Old  varchar(50)
) 
insert into #NSXCurr_Old                   
select '1st Leg' as Type_Old,@NSX1_Old as Future_Old         

insert into #NSXCurr_Old                                     
select '2nd Leg' as Type_Old,@NSX2_Old as Future_Old
             
  declare @Count5 int,@CountEnd5 int,@Type5 as varchar(20)='',@Min5 as varchar(50),@Per5 as varchar(50)           
  DECLARE @MessBody5 NVARCHAR(MAX) ,@MESS5 NVARCHAR(MAX),@MESS5_NSX NVARCHAR(MAX)      
  DECLARE @xml5 NVARCHAR(MAX)              
   DECLARE @Data5 NVARCHAR(MAX) ,  @totctrOT5 as int=0          
           
    set @Data5=''                
    set @MessBody5=''                          
    set @MESS5=''          
    set @Count5=1                                    
	set @MESS5_NSX=''              
              
    select  row_number()over (order by Type) As Srno,Type,Future into #aa5 from #NSXCurr          
     SELECT @totctrOT5=count(1) from #aa5           
   SET @MESS5=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
   <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Future (%) </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count5 <= @totctrOT5                              
     BEGIN                        
      SELECT @Type5=Type, @Min5=Future FROM #aa5 WHERE Srno=@count5                                   
      set @Data5=@Data5+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type5) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min5) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count5=@Count5+1                                    
     END
SET @MESS5=@MESS5 + @Data5 +'</Table>' 

 declare @Count5_Old int,@CountEnd5_Old int,@Type5_Old as varchar(20)='',@Min5_Old as varchar(50),@Per5_Old as varchar(50)           
  DECLARE @MessBody5_Old NVARCHAR(MAX) ,@MESS5_Old NVARCHAR(MAX)      
  DECLARE @xml5_Old NVARCHAR(MAX)              
   DECLARE @Data5_Old NVARCHAR(MAX) ,  @totctrOT5_Old as int=0          
           
    set @Data5_Old=''                
    set @MessBody5_Old=''                          
    set @MESS5_Old=''          
    set @Count5_Old=1                                    
              
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Future_Old into #aa5_Old from #NSXCurr_Old          
     SELECT @totctrOT5_Old=count(1) from #aa5_Old           
   SET @MESS5_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
   <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Future (%) </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count5_Old <= @totctrOT5_Old                              
     BEGIN                        
      SELECT @Type5_Old=Type_Old, @Min5_Old=Future_Old FROM #aa5_Old WHERE Srno=@count5_Old                                   
      set @Data5_Old=@Data5_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type5_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min5_Old) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count5_Old=@Count5_Old+1                                    
     END
SET @MESS5_Old=@MESS5_Old + @Data5_Old +'</Table>' 
 --set @MESS5_NSX='<Br><B>NSX</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS5_Old + '</td><td> '+ @MESS5 +'</td></tr></Table>'      
 set @MESS5_NSX='<Br><B>NSX</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS5 +'</td></tr></Table>'      

IF OBJECT_ID('tempdb..#NSXCurr', 'U') IS NOT NULL
DROP TABLE #NSXCurr
IF OBJECT_ID('tempdb..#aa5', 'U') IS NOT NULL
DROP TABLE #aa5
IF OBJECT_ID('tempdb..#NSXCurr_Old', 'U') IS NOT NULL
drop table #NSXCurr_Old
IF OBJECT_ID('tempdb..#aa5_Old', 'U') IS NOT NULL
drop table #aa5_Old
end
------------------BSEFO------------------
select @BSEFOFMin=isnull(FRIST_LEG_MIN_NEW,0),@BSEFOFFu=isnull(FRIST_LEG_MAX_NEW,0),@BSEFOSMin=isnull(SECOND_LEG_MIN_NEW,0),
 @BSEFOSFu=isnull(SECOND_LEG_MAX_NEW,0),@BSEFOFMin_Old=ISNULL(Frist_Leg_min_Old,0),@BSEFOFFu_Old=ISNULL(Frist_Leg_max_Old,0),
 @BSEFOSMin_Old=ISNULL(Second_Leg_Min_Old,0),@BSEFOSFu_Old=ISNULL(Second_Leg_max_Old,0)
	from #Client with(nolock) where segment='BSEFO' and scheme_type='TRD' 
	and party_code=@M_pcode

if(@BSEFOFMin>0 or @BSEFOFFu>0 or @BSEFOSMin>0 or @BSEFOSFu>0)
begin
 	create table #BSEFO
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 
	insert into #BSEFO                   
	select '1st Leg' as Type,@BSEFOFMin as Min,@BSEFOFFu as Per          

	insert into #BSEFO                                     
	select '2nd Leg' as Type,@BSEFOSMin as Min,@BSEFOSFu as Per
	
	create table #BSEFO_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #BSEFO_OLD                   
	select '1st Leg' as Type,@BSEFOFMin_Old as Min,@BSEFOFFu_Old as Per          

	insert into #BSEFO_OLD                                     
	select '2nd Leg' as Type,@BSEFOSMin_Old as Min,@BSEFOSFu_Old as Per

           
	  declare @CountBSEFO int,@CountEndBSEFO1 int,@Type12 as varchar(20)='',@Min12 as varchar(50),@Per12 as varchar(50)           
	  DECLARE @MessBody12 NVARCHAR(MAX) ,@MESS12 NVARCHAR(MAX) ,@Mess2_BSEFO  NVARCHAR(MAX)                       
	   DECLARE @Data12 NVARCHAR(MAX) ,  @totctrOTBSEFO as int=0          
	           
		set @Data12=''                
		--set @MessBody=''                          
		set @MESS12='' 
		set @Mess2_BSEFO=''         
		set @CountBSEFO=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa12 from #BSEFO          
		 SELECT @totctrOTBSEFO=count(1) from #aa12           
	   SET @MESS12=                            
	   '<table border="1" cellpadding="2" cellspacing="2">                            
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr> 
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountBSEFO <= @totctrOTBSEFO                              
		 BEGIN                        
		  SELECT @Type12=Type, @Min12=Min,@Per12=Per FROM #aa12 WHERE Srno=@CountBSEFO                                   
		  set @Data12=@Data12+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type12) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min12) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per12) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountBSEFO=@CountBSEFO+1                                    
		 END             
  SET @MESS12= @MESS12 + @Data12 +'</Table>' 
  
  declare @CountBSEFO_Old int,@CountEndBSEFO1_Old int,@Type12_Old as varchar(20)='',@Min12_Old as varchar(50),@Per12_Old as varchar(50)           
	  DECLARE @MessBody12_Old NVARCHAR(MAX) ,@MESS12_Old NVARCHAR(MAX)                        
	   DECLARE @Data12_Old NVARCHAR(MAX) ,  @totctrOTBSEFO_Old as int=0          
	           
		set @Data12_Old=''                
		--set @MessBody=''                          
		set @MESS12_Old=''          
		set @CountBSEFO_Old=1                                    
	              
	              
		select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa12_Old from #BSEFO_Old          
		 SELECT @totctrOTBSEFO_Old=count(1) from #aa12_Old           
	   SET @MESS12_Old=                            
	   '<table border="1" cellpadding="2" cellspacing="2"> 
	    <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountBSEFO_Old <= @totctrOTBSEFO_Old                              
		 BEGIN                        
		  SELECT @Type12_Old=Type_Old, @Min12_Old=Min_Old,@Per12_Old=Per_Old FROM #aa12_Old WHERE Srno=@CountBSEFO_Old                                   
		  set @Data12_Old=@Data12_Old+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type12_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min12_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per12_Old) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountBSEFO_Old=@CountBSEFO_Old+1                                    
		 END             
  SET @MESS12_Old= @MESS12_Old + @Data12_Old +'</Table>'  
   --set @Mess2_BSEFO='<Br><B>BSEFO</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS12_Old + '</td><td> '+ @MESS12 +'</td></tr></Table>'  
    set @Mess2_BSEFO='<Br><B>BSEFO</B> <Br><Br>'+ '<Table> <tr> <td> '+ @MESS12 +'</td></tr></Table>'  

IF OBJECT_ID('tempdb..#BSEFO', 'U') IS NOT NULL
DROP TABLE #BSEFO
IF OBJECT_ID('tempdb..#aa12', 'U') IS NOT NULL
DROP TABLE #aa12
IF OBJECT_ID('tempdb..#BSEFO_Old', 'U') IS NOT NULL
drop table #BSEFO_Old
IF OBJECT_ID('tempdb..#aa12_Old', 'U') IS NOT NULL
drop table #aa12_Old
end
 
-- -------------NSX Option---------------------
  select @NSXO1=isnull(FRIST_LEG_MAX_NEW,0),@NSXO2=isnull(SECOND_LEG_MAX_NEW,0),@NSXO1_Old=ISNULL(Frist_Leg_max_Old,0),
 @NSXO2_Old=ISNULL(Second_Leg_max_Old,0)  from #Client with(nolock) where 
	segment='NSX OPT' and scheme_type='ALL' 
	and party_code=@M_pcode

if(@NSXO1>0 or @NSXO2>0)
begin
create table #NSXO
(
Type  varchar(50),
PerLot  varchar(50)
) 
insert into #NSXO                   
select '1st Leg' as Type,@NSXO1 as PerLot         

insert into #NSXO                                     
select '2nd Leg' as Type,@NSXO2 as PerLot

create table #NSXO_Old
(
Type_Old  varchar(50),
PerLot_Old  varchar(50)
) 
insert into #NSXO_Old                   
select '1st Leg' as Type_Old,@NSXO1_Old as PerLot_Old         

insert into #NSXO_Old                                     
select '2nd Leg' as Type_Old,@NSXO2_Old as PerLot_Old

  declare @Count8 int,@CountEnd8 int,@Type8 as varchar(20)='',@Min8 as varchar(50),@Per8 as varchar(50)           
  DECLARE @MessBody8 NVARCHAR(MAX) ,@MESS8 NVARCHAR(MAX),@MESS8_NSXOption NVARCHAR(MAX)    
  DECLARE @xml8 NVARCHAR(MAX)              
   DECLARE @Data8 NVARCHAR(MAX) ,  @totctrOT8 as int=0          
           
    set @Data8=''                
    set @MessBody8=''                          
    set @MESS8=''          
    set @Count8=1                                    
    set @MESS8_NSXOption=''          
              
    select  row_number()over (order by Type) As Srno,Type,PerLot into #aa8 from #NSXO          
     SELECT @totctrOT8=count(1) from #aa8           
   SET @MESS8=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
    <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Per Lot Rs. </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count8 <= @totctrOT8                              
     BEGIN                        
      SELECT @Type8=Type, @Min8=PerLot FROM #aa8 WHERE Srno=@count8                                   
      set @Data8=@Data8+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type8) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min8) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count8=@Count8+1                                    
     END
      SET @MESS8=@MESS8 + @Data8 +'</Table>' 
      
       declare @Count8_Old int,@CountEnd8_Old int,@Type8_Old as varchar(20)='',@Min8_Old as varchar(50),@Per8_Old as varchar(50)           
  DECLARE @MessBody8_Old NVARCHAR(MAX) ,@MESS8_Old NVARCHAR(MAX)  
  DECLARE @xml8_Old NVARCHAR(MAX)              
   DECLARE @Data8_Old NVARCHAR(MAX) ,  @totctrOT8_Old as int=0          
           
    set @Data8_Old=''                
    set @MessBody8_Old=''                          
    set @MESS8_Old=''          
    set @Count8_Old=1                                           
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,PerLot_Old into #aa8_Old from #NSXO_Old          
     SELECT @totctrOT8_Old=count(1) from #aa8_Old           
   SET @MESS8_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
    <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Per Lot Rs. </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count8_Old <= @totctrOT8_Old                              
     BEGIN                        
      SELECT @Type8_Old=Type_Old, @Min8_Old=PerLot_Old FROM #aa8_Old WHERE Srno=@count8_Old                                   
      set @Data8_Old=@Data8_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type8_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min8_Old) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count8_Old=@Count8_Old+1                                    
     END
      SET @MESS8_Old= @MESS8_Old + @Data8_Old +'</Table>'
      --set @MESS8_NSXOption='<Br><B>NSX Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS8_Old + '</td><td> '+ @MESS8 +'</td></tr></Table>'                    
      set @MESS8_NSXOption='<Br><B>NSX Option</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS8 +'</td></tr></Table>'                    

IF OBJECT_ID('tempdb..#NSXO', 'U') IS NOT NULL
DROP TABLE #NSXO
IF OBJECT_ID('tempdb..#aa8', 'U') IS NOT NULL
DROP TABLE #aa8
IF OBJECT_ID('tempdb..#NSXO_Old', 'U') IS NOT NULL
drop table #NSXO_Old
IF OBJECT_ID('tempdb..#aa8_old', 'U') IS NOT NULL
drop table #aa8_old
end
-----------------MCX Option-------------------------

  select @MCXOP_Silver1M=isnull(FRIST_LEG_MAX_NEW,0)  ,@MCXOP_Silver2M=isnull(SECOND_LEG_MAX_NEW,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

select @MCXOP_Copper1M =isnull(FRIST_LEG_MAX_NEW,0), @MCXOP_Copper2M=isnull(SECOND_LEG_MAX_NEW,0) 
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

select @MCXOP_Zinc1M =isnull(FRIST_LEG_MAX_NEW,0), @MCXOP_Zinc2M=isnull(SECOND_LEG_MAX_NEW,0)  
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

select @MCXOP_Gold1M=isnull(FRIST_LEG_MAX_NEW,0) , @MCXOP_Gold2M=isnull(SECOND_LEG_MAX_NEW,0) 
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

select @MCXOP_Crudoil1M =isnull(FRIST_LEG_MAX_NEW,0),@MCXOP_Crudoil2M=isnull(SECOND_LEG_MAX_NEW,0) 
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

select @MCXOP_NaturalGas1M=isnull(FRIST_LEG_MAX_NEW,0)  ,@MCXOP_NaturalGas2M=isnull(SECOND_LEG_MAX_NEW,0) 
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

select @MCXOP_ALL1M=isnull(FRIST_LEG_MAX_NEW,0) , @MCXOP_ALL2M =isnull(SECOND_LEG_MAX_NEW,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='ALL' 	and party_code=@M_pcode

select @MCXOP_Silver1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0), @MCXOP_Silver2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

select @MCXOP_Copper1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0) ,@MCXOP_Copper2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)
   from #Client with(nolock) where segment='MCX OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

select @MCXOP_Zinc1M_Old =ISNULL(FRIST_LEG_MAX_OLD,0), @MCXOP_Zinc2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

select @MCXOP_Gold1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0) ,@MCXOP_Gold2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
   from #Client with(nolock) where segment='MCX OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

 select @MCXOP_Crudoil1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0), @MCXOP_Crudoil2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
   from #Client with(nolock) where segment='MCX OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

select @MCXOP_NaturalGas1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0), @MCXOP_NaturalGas2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

select @MCXOP_ALL1M_Old =ISNULL(FRIST_LEG_MAX_OLD,0) , @MCXOP_ALL2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)
  from #Client with(nolock) where segment='MCX OPT' and scheme_type='ALL' 	and party_code=@M_pcode

if(@MCXOP_Silver1M>0 or @MCXOP_Silver2M>0 or @MCXOP_Copper1M>0 or @MCXOP_Copper2M>0 or @MCXOP_Zinc1M>0 or @MCXOP_Zinc2M>0 or
@MCXOP_Gold1M>0 or @MCXOP_Gold2M>0 or @MCXOP_Crudoil1M>0 or @MCXOP_Crudoil2M>0 or @MCXOP_NaturalGas1M>0 or @MCXOP_NaturalGas2M>0
or @MCXOP_ALL1M>0 or @MCXOP_ALL2M>0)
begin

create table #MCXOpt
(
Type  varchar(50),
SilverMin  varchar(50),
CopperMin  varchar(50),
ZincMin  varchar(50),
GoldMin varchar(50),
CrudoilMin varchar(50),
NaturalGasMin varchar(50),
All_Min varchar(50),
) 
insert into #MCXOpt                   
select '1st Leg' as Type,@MCXOP_Silver1M as SilverMin ,@MCXOP_Copper1M as CopperMin,
  @MCXOP_Zinc1M as ZincMin ,@MCXOP_Gold1M as GoldMin,
 @MCXOP_Crudoil1M as  CrudoilMin ,@MCXOP_NaturalGas1M as NaturalGasMin,
 @MCXOP_ALL1M as All_Min   

insert into #MCXOpt                                     
select '2nd Leg' as Type,@MCXOP_Silver2M as SilverMin, @MCXOP_Copper2M as CopperMin,
  @MCXOP_Zinc2M as ZincMin ,@MCXOP_Gold2M as GoldMin,
 @MCXOP_Crudoil2M as  CrudoilMin, @MCXOP_NaturalGas2M as NaturalGasMin,
 @MCXOP_ALL2M as All_Min     


create table #MCXOpt_Old
(
Type_Old  varchar(50),
SilverMin_Old  varchar(50),
CopperMin_Old  varchar(50),
 ZincMin_Old  varchar(50),
 GoldMin_Old varchar(50),
 CrudoilMin_Old varchar(50),
 NaturalGasMin_Old varchar(50),
 All_Min_Old varchar(50),
 ) 
insert into #MCXOpt_Old                   
select '1st Leg' as Type,@MCXOP_Silver1M_Old as SilverMin_Old ,@MCXOP_Copper1M_Old as CopperMin_Old,
 @MCXOP_Zinc1M_Old as ZincMin_Old, 
@MCXOP_Gold1M_Old as GoldMin_Old ,@MCXOP_Crudoil1M_Old as  CrudoilMin_Old,
 @MCXOP_NaturalGas1M_Old as NaturalGasMin_Old,@MCXOP_ALL1M_Old as All_Min_Old  

insert into #MCXOpt_Old                                    
select '2nd Leg' as Type,@MCXOP_Silver2M_Old as SilverMin_Old, 
@MCXOP_Copper2M_Old as CopperMin_Old,  @MCXOP_Zinc2M_Old as ZincMin_Old,
 @MCXOP_Gold2M_Old as GoldMin_Old,
@MCXOP_Crudoil2M_Old as  CrudoilMin_Old,@MCXOP_NaturalGas2M_Old as NaturalGasMin_Old,@MCXOP_ALL2M_Old as All_Min_Old  
            
  declare @Count888 int,@CountEnd888 int,@Type888 as varchar(20)='',@SilverMin as Varchar(50),  
  @CopperMin as Varchar(50)   ,  @ZincMin as Varchar(50), 
 @GoldMin as Varchar(50) , @CrudoilMin as Varchar(50), 
  @NaturalGasMin as Varchar(50),  @All_Min as Varchar(50)
  DECLARE @MessBody888 NVARCHAR(MAX) ,@MESS888 NVARCHAR(MAX)         
  DECLARE @xml888 NVARCHAR(MAX)              
   DECLARE @Data888 NVARCHAR(MAX) ,  @totctrOT888 as int=0 ,@Mess_MCXOpt NVARCHAR(MAX)  =''    
           
    set @Data888=''                
    set @MessBody888=''                          
    set @MESS888=''          
    set @Count888=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,SilverMin,CopperMin,ZincMin,GoldMin,
CrudoilMin,NaturalGasMin,All_Min   into #aa888 from #MCXOpt          

     SELECT @totctrOT888=count(1) from #aa888           
   SET @MESS888=                            
   '<table border="1" cellpadding="2" cellspacing="2">          
	   <tr><th  align="center" colspan="8">New Brokerage </th>
	   </tr>     
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Silver </th>                                                                                 
       <th align="center"> Copper </th>
	   <th align="center"> Zinc </th>
	   <th align="center"> Gold </th>
	   <th align="center"> Crudoil </th>
	   <th align="center"> NaturalGas </th>
	   <th align="center"> All </th>
   </tr>'          
--print @MESS          
   WHILE @Count888 <= @totctrOT888                              
     BEGIN                        
      SELECT @Type888=Type,@SilverMin=SilverMin ,@CopperMin=CopperMin,@ZincMin=ZincMin,
	 @GoldMin=GoldMin ,@CrudoilMin=CrudoilMin, @NaturalGasMin=NaturalGasMin,
	  @All_Min=All_Min FROM #aa888 WHERE Srno=@count888                                   
      set @Data888=@Data888+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type888) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@CopperMin) +' </td>     
   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin) +' </td>     
 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin) +' </td>     
 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@All_Min) +' </td>     
 
       </tr>'           
       print @Data888                         
      SET   @Count888=@Count888+1                                    
     END   
     SET @MESS888=  @MESS888 + @Data888 +'</Table>'
     print  @MESS888         
 --drop table #aa888
 
 declare @Count999 int,@CountEnd999 int,@Type999 as varchar(20)='',@SilverMin_Old as Varchar(50),
  @CopperMin_Old as Varchar(50)  ,  @ZincMin_Old as Varchar(50), 
    @GoldMin_Old as Varchar(50), @CrudoilMin_Old as Varchar(50),  
  @NaturalGasMin_Old as Varchar(50),  @All_Min_Old as Varchar(50)
  DECLARE @MessBody999 NVARCHAR(MAX) ,@MESS999 NVARCHAR(MAX)         
  DECLARE @xml999 NVARCHAR(MAX)              
   DECLARE @Data999 NVARCHAR(MAX) ,  @totctrOT999 as int=0          
           
    set @Data999=''                
    set @MessBody999=''                          
    set @MESS999=''          
    set @Count999=1                                    
              
              
    select  row_number()over (order by Type_Old) as Srno,Type_Old,SilverMin_Old,CopperMin_Old,ZincMin_Old,GoldMin_Old,
CrudoilMin_Old,NaturalGasMin_Old,All_Min_Old   into #aa999 from #MCXOpt_Old          

     SELECT @totctrOT999=count(1) from #aa999           
   SET @MESS999=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
   	   <tr><th  align="center" colspan="8">Old Brokerage </th>
	   </tr>  
   <tr>                       
    <th align="center"> Type_Old </th>                            
       <th align="center"> Silver_Old </th>                                                                                 
        <th align="center"> Copper_Old </th>
 	   <th align="center"> Zinc_Old </th>
 	   <th align="center"> Gold_Old </th>
 	   <th align="center"> Crudoil_Old </th>
 	   <th align="center"> NaturalGas_Old </th>
 	   <th align="center"> All_Old </th>
    </tr>'          
--print @MESS          
   WHILE @Count999 <= @totctrOT999                              
     BEGIN                        
      SELECT @Type999=Type_Old,@SilverMin_Old=SilverMin_Old, @CopperMin_Old=CopperMin_Old ,@ZincMin_Old=ZincMin_Old,
	  @GoldMin_Old=GoldMin_Old, @CrudoilMin_Old=CrudoilMin_Old, @NaturalGasMin_Old=NaturalGasMin_Old,
	  @All_Min_Old=All_Min_Old  FROM #aa999 WHERE Srno=@count999                                   
      set @Data999=@Data999+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type999) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin_Old) +' </td>   
          <td align="center"> '+ CONVERT(VARCHAR,@CopperMin_Old) +' </td>     
   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin_Old) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin_Old) +' </td>     
 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin_Old) +' </td>     
 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin_Old) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@All_Min_Old) +' </td>     
 
       </tr>'           
       print @Data999                         
      SET   @Count999=@Count999+1                                    
     END   
     SET @MESS999=  @MESS999 + @Data999 +'</Table>'
     --set @Mess_MCXOpt='<Br><B>MCX Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS999 + '</td><td> '+ @MESS888 +'</td></tr></Table>'          
     set @Mess_MCXOpt='<Br><B>MCX Option</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS888 +'</td></tr></Table>'          

end
IF OBJECT_ID('tempdb..#MCXOpt', 'U') IS NOT NULL
    DROP TABLE #MCXOpt
IF OBJECT_ID('tempdb..#aa999', 'U') IS NOT NULL
    DROP TABLE #aa999
IF OBJECT_ID('tempdb..#MCXOpt_Old', 'U') IS NOT NULL
drop table #MCXOpt_Old
IF OBJECT_ID('tempdb..#aa888', 'U') IS NOT NULL
drop table #aa888

----------------NCE Option-------------------------

--select @NCEOP_Silver1M=isnull(FRIST_LEG_MIN_NEW,0) , @NCEOP_Silver2M=isnull(SECOND_LEG_MIN_NEW,0)  
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

--select @NCEOP_Copper1M =isnull(FRIST_LEG_MIN_NEW,0), @NCEOP_Copper2M=isnull(SECOND_LEG_MIN_NEW,0)  
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

--select @NCEOP_Zinc1M =isnull(FRIST_LEG_MIN_NEW,0), @NCEOP_Zinc2M=isnull(SECOND_LEG_MIN_NEW,0) 
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

--select @NCEOP_Gold1M=isnull(FRIST_LEG_MIN_NEW,0)  ,@NCEOP_Gold2M=isnull(SECOND_LEG_MIN_NEW,0) 
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

--select @NCEOP_Crudoil1M =isnull(FRIST_LEG_MIN_NEW,0),@NCEOP_Crudoil2M=isnull(SECOND_LEG_MIN_NEW,0)
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

--select @NCEOP_NaturalGas1M=isnull(FRIST_LEG_MIN_NEW,0) , @NCEOP_NaturalGas2M=isnull(SECOND_LEG_MIN_NEW,0)
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

--select @NCEOP_ALL1M=isnull(FRIST_LEG_MIN_NEW,0) , @NCEOP_ALL2M =isnull(SECOND_LEG_MIN_NEW,0)
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='ALL' 	and party_code=@M_pcode

--select @NCEOP_Silver1M_Old=ISNULL(Frist_Leg_max_Old,0) ,@NCEOP_Silver2M_Old =ISNULL(Second_Leg_Min_Old,0)
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

--select @NCEOP_Copper1M_Old=ISNULL(Frist_Leg_max_Old,0),@NCEOP_Copper2M_Old=ISNULL(Second_Leg_Min_Old,0)
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

--select @NCEOP_Zinc1M_Old =ISNULL(Frist_Leg_max_Old,0) ,@NCEOP_Zinc2M_Old =ISNULL(Second_Leg_Min_Old,0)
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

--select @NCEOP_Gold1M_Old=ISNULL(Frist_Leg_max_Old,0), @NCEOP_Gold2M_Old =ISNULL(Second_Leg_Min_Old,0)
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

--select @NCEOP_Crudoil1M_Old=ISNULL(Frist_Leg_max_Old,0),@NCEOP_Crudoil2M_Old =ISNULL(Second_Leg_Min_Old,0)
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

--select @NCEOP_NaturalGas1M_Old=ISNULL(Frist_Leg_max_Old,0), @NCEOP_NaturalGas2M_Old=ISNULL(Second_Leg_Min_Old,0)
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

--select @NCEOP_ALL1M_Old =ISNULL(Frist_Leg_max_Old,0)  ,@NCEOP_ALL2M_Old=ISNULL(Second_Leg_Min_Old,0)  
--from #Client with(nolock) where segment='NCE OPT' and scheme_type='ALL' 	and party_code=@M_pcode


--create table #NCEOpt
--(
--Type  varchar(50),
--SilverMin  varchar(50),
-- CopperMin  varchar(50),
-- ZincMin  varchar(50),
-- GoldMin varchar(50),
-- CrudoilMin varchar(50),
-- NaturalGasMin varchar(50),
-- All_Min varchar(50)) 
--insert into #NCEOpt                   
--select '1st Leg' as Type,@NCEOP_Silver1M as SilverMin ,@NCEOP_Copper1M as CopperMin,
-- @NCEOP_Zinc1M as ZincMin ,@NCEOP_Gold1M as GoldMin,
-- @NCEOP_Crudoil1M as  CrudoilMin ,@NCEOP_NaturalGas1M as NaturalGasMin,
-- @NCEOP_ALL1M as All_Min   

--insert into #NCEOpt                                     
--select '2nd Leg' as Type,@NCEOP_Silver2M as SilverMin, @NCEOP_Copper2M as CopperMin,
-- @NCEOP_Zinc2M as ZincMin ,@NCEOP_Gold2M as GoldMin,
-- @NCEOP_Crudoil2M as  CrudoilMin, @NCEOP_NaturalGas2M as NaturalGasMin,
-- @NCEOP_ALL2M as All_Min   


--create table #NCEOpt_Old
--(
--Type_Old  varchar(50),
--SilverMin_Old  varchar(50),
-- CopperMin_Old  varchar(50),
-- ZincMin_Old  varchar(50),
-- GoldMin_Old varchar(50),
-- CrudoilMin_Old varchar(50),
-- NaturalGasMin_Old varchar(50),
-- All_Min_Old varchar(50)) 
--insert into #NCEOpt_Old                   
--select '1st Leg' as Type,@NCEOP_Silver1M_Old as SilverMin_Old, @NCEOP_Copper1M_Old as CopperMin_Old,
--  @NCEOP_Zinc1M_Old as ZincMin_Old,
--@NCEOP_Gold1M_Old as GoldMin_Old ,@NCEOP_Crudoil1M_Old as  CrudoilMin_Old,
--@NCEOP_NaturalGas1M_Old as NaturalGasMin_Old,@NCEOP_ALL1M_Old as All_Min_Old  

--insert into #NCEOpt_Old                                    
--select '2nd Leg' as Type,@NCEOP_Silver2M_Old as SilverMin_Old, 
--@NCEOP_Copper2M_Old as CopperMin_Old,  @NCEOP_Zinc2M_Old as ZincMin_Old,@NCEOP_Gold2M_Old as GoldMin_Old, 
--@NCEOP_Crudoil2M_Old as  CrudoilMin_Old ,@NCEOP_NaturalGas2M_Old as NaturalGasMin_Old,@NCEOP_ALL2M_Old as All_Min_Old  
            
--  declare @Count111 int,@CountEnd111 int,@Type111 as varchar(20)='',@SilverMin_NCE as Varchar(50), 
--  @CopperMin_NCE as Varchar(50)   , @ZincMin_NCE as Varchar(50), 
--    @GoldMin_NCE as Varchar(50),  @CrudoilMin_NCE as Varchar(50),
--  @NaturalGasMin_NCE as Varchar(50),  @All_Min_NCE as Varchar(50) 
--  DECLARE @MessBody111 NVARCHAR(MAX) ,@MESS111 NVARCHAR(MAX)         
--  DECLARE @xml111 NVARCHAR(MAX)              
--   DECLARE @Data111 NVARCHAR(MAX) ,  @totctrOT111 as int=0 ,@Mess_NCEOpt NVARCHAR(MAX)  =''    
           
--    set @Data111=''                
--    set @MessBody111=''                          
--    set @MESS111=''          
--    set @Count111=1                                    
              
              
--    select  row_number()over (order by Type) As Srno,Type,SilverMin,CopperMin,ZincMin,GoldMin,
--CrudoilMin,NaturalGasMin,All_Min   into #aa111 from #NCEOpt          

--     SELECT @totctrOT111=count(1) from #aa111           
--   SET @MESS111=                            
--   '<table border="1" cellpadding="2" cellspacing="2">                            
--   <tr>                       
--    <th align="center"> Type </th>                            
--       <th align="center"> Silver </th>                                                                                 
--        <th align="center"> Copper </th>
-- 	   <th align="center"> Zinc </th>
-- 	   <th align="center"> Gold </th>
-- 	   <th align="center"> Crudoil </th>
-- 	   <th align="center"> NaturalGas </th>
-- 	   <th align="center"> All </th>
--    </tr>'          
----print @MESS          
--   WHILE @Count111 <= @totctrOT111                              
--     BEGIN                        
--      SELECT @Type111=Type,@SilverMin_NCE=SilverMin ,@CopperMin_NCE=CopperMin, @ZincMin_NCE=ZincMin,
--	 @GoldMin_NCE=GoldMin, @CrudoilMin_NCE=CrudoilMin ,@NaturalGasMin=NaturalGasMin,
--	  @All_Min_NCE=All_Min   FROM #aa111 WHERE Srno=@count111                                   
--      set @Data111=@Data111+                           
--     '<tr>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@Type111) +' </td>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin_NCE) +' </td>   
--          <td align="center"> '+ CONVERT(VARCHAR,@CopperMin_NCE) +' </td>     
--   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin_NCE) +' </td>     
--     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin_NCE) +' </td>     
-- 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin_NCE) +' </td>     
-- 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin) +' </td>     
--     <td align="center"> '+ CONVERT(VARCHAR,@All_Min_NCE) +' </td>     
 
--       </tr>'           
--       print @Data111                         
--      SET   @Count111=@Count111+1                                    
--     END   
--     SET @MESS111=  @MESS111 + @Data111 +'</Table>'
--     print  @MESS111         
-- drop table #aa111
 
-- declare @Count456 int,@CountEnd456 int,@Type456 as varchar(20)='',@SilverMin_NCE_Old as Varchar(50), 
--  @CopperMin_NCE_Old as Varchar(50)  ,   @ZincMin_NCE_Old as Varchar(50), 
--  @GoldMin_NCE_Old as Varchar(50),  @CrudoilMin_NCE_Old as Varchar(50), 
--  @NaturalGasMin_NCE_Old as Varchar(50),   @All_Min_NCE_Old as Varchar(50) 
--  DECLARE @MessBody456 NVARCHAR(MAX) ,@MESS456 NVARCHAR(MAX)         
--  DECLARE @xml456 NVARCHAR(MAX)              
--   DECLARE @Data456 NVARCHAR(MAX) ,  @totctrOT456 as int=0          
           
--    set @Data456=''                
--    set @MessBody456=''                          
--    set @MESS456=''          
--    set @Count456=1                                    
              
              
--    select  row_number()over (order by Type_Old) as Srno,Type_Old,SilverMin_Old,CopperMin_Old,ZincMin_Old,GoldMin_Old,
--CrudoilMin_Old,NaturalGasMin_Old,All_Min_Old   into #aa456 from #NCEOpt_Old          

--     SELECT @totctrOT456=count(1) from #aa456           
--   SET @MESS456=                            
--   '<table border="1" cellpadding="2" cellspacing="2">                            
--   <tr>                       
--    <th align="center"> Type_Old </th>                            
--       <th align="center"> Silver_Old </th>                                                                                 
--        <th align="center"> Copper_Old </th>
-- 	   <th align="center"> Zinc_Old </th>
-- 	   <th align="center"> Gold_Old </th>
-- 	   <th align="center"> Crudoil_Old </th>
-- 	   <th align="center"> NaturalGas_Old </th>
-- 	   <th align="center"> All_Old </th>
--    </tr>'          
----print @MESS          
--   WHILE @Count456 <= @totctrOT456                              
--     BEGIN                        
--      SELECT @Type456=Type_Old,@SilverMin_NCE_Old=SilverMin_Old,@CopperMin_NCE_Old=CopperMin_Old,
--	  @ZincMin_NCE_Old=ZincMin_Old,
--	  @GoldMin_NCE_Old=GoldMin_Old,@CrudoilMin_NCE_Old=CrudoilMin_Old,@NaturalGasMin_Old=NaturalGasMin_Old,
--	  @All_Min_NCE_Old=All_Min_Old  FROM #aa456 WHERE Srno=@count456                                   
--      set @Data456=@Data456+                           
--     '<tr>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@Type456) +' </td>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin_NCE_Old) +' </td>   
--          <td align="center"> '+ CONVERT(VARCHAR,@CopperMin_NCE_Old) +' </td>     
--   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin_NCE_Old) +' </td>     
--     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin_NCE_Old) +' </td>     
-- 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin_NCE_Old) +' </td>     
-- 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin_Old) +' </td>     
--     <td align="center"> '+ CONVERT(VARCHAR,@All_Min_NCE_Old) +' </td>     
--       </tr>'           
--       print @Data456                         
--      SET   @Count456=@Count456+1                                    
--     END   
--     SET @MESS456=  @MESS456 + @Data456 +'</Table>'
--     set @Mess_NCEOpt='<Br><B>NCE Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS111 + '</td><td> '+ @MESS456 +'</td></tr></Table>'          



-----------------------BSEFO Option--------------------------------------
select @BSEFOOAll1=isnull(FRIST_LEG_MAX_NEW,0),@BSEFOOAll2=isnull(SECOND_LEG_MAX_NEW,0),@BSEFOOAll1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@BSEFOOAll2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='BFO OPT' and scheme_type='ALL'

select @BSEFOOSX501=isnull(FRIST_LEG_MAX_NEW,0),@BSEFOOSX502=isnull(SECOND_LEG_MAX_NEW,0),@BSEFOOSX501_Old=isnull(FRIST_LEG_MAX_OLD,0),
@BSEFOOSX502_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='BFO OPT' and scheme_type='SX50OPT'

select @BSEFOOBKX1=isnull(FRIST_LEG_MAX_NEW,0),@BSEFOOBKX2=isnull(SECOND_LEG_MAX_NEW,0),@BSEFOOBKX1_Old=isnull(FRIST_LEG_MAX_OLD,0),
@BSEFOOBKX2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='BFO OPT' and scheme_type='BKXOPT'

select @BSEFOOBSX1=isnull(FRIST_LEG_MAX_NEW,0),@BSEFOOBSX2=isnull(SECOND_LEG_MAX_NEW,0),@BSEFOOBSX1_Old=isnull(FRIST_LEG_MAX_OLD,0)
,@BSEFOOBSX2_Old=isnull(SECOND_LEG_MAX_OLD,0) from #Client with(nolock) where  segment='BFO OPT' and scheme_type='BSXOPT'

if(@BSEFOOAll1>0 or @BSEFOOAll2>0 or @BSEFOOSX501>0 or @BSEFOOSX502>0 or @BSEFOOBKX1>0 or @BSEFOOBKX2>0 or @BSEFOOBSX1>0 or @BSEFOOBSX2>0)
begin
create table #BSEFOOpt
(
Type  varchar(50),
Stock  varchar(50),
SX50OPT  varchar(50),
BKXOPT  varchar(50),
BSXOPT  varchar(50)
) 
insert into #BSEFOOpt                   
select '1st Leg' as Type,@BSEFOOAll1 as Stock ,@BSEFOOSX501 as SX50OPT, @BSEFOOBKX1 as BKXOPT,@BSEFOOBSX1 as BSXOPT      

insert into #BSEFOOpt                                     
select '2nd Leg' as Type,@BSEFOOAll2 as Stock ,@BSEFOOSX502 as SX50OPT, @BSEFOOBKX2 as BKXOPT,@BSEFOOBSX2 as BSXOPT 

create table #BSEFOOpt_Old
(
Type_Old  varchar(50),
ALL_Old  varchar(50),
SX50OPT_Old  varchar(50),
BKXOPT_Old  varchar(50),
BSXOPT_old  varchar(50)
) 
insert into #BSEFOOpt_Old                   
select '1st Leg' as Type_Old,@BSEFOOAll1_Old as ALL_Old ,@BSEFOOSX501_Old as SX50OPT_Old, @BSEFOOBKX1_Old as BKXOPT_Old,
@BSEFOOBSX1_Old as BSXOPT_Old

insert into #BSEFOOpt_Old                                     
select '2nd Leg' as Type_Old,@BSEFOOAll2_Old as ALL_Old ,@BSEFOOSX502_Old as SX50OPT_Old, @BSEFOOBKX2_Old as BKXOPT_Old,
@BSEFOOBSX2_Old as BSXOPT_Old
            
  declare @Count0234 int,@CountEnd0234 int,@Type0234 as varchar(20)='',@All as varchar(50),@SX50 as varchar(50),@BSX as varchar(50)
  ,@BKX as varchar(50)
  DECLARE @MessBody0234 NVARCHAR(MAX) ,@MESS0234 NVARCHAR(MAX) ,@Mess0234_BSEFOOpt NVARCHAR(MAX)        
  DECLARE @xml0234 NVARCHAR(MAX)              
   DECLARE @Data0234 NVARCHAR(MAX) ,  @totctrOT0234 as int=0          
           
    set @Data0234=''                
    set @MessBody0234=''                          
    set @MESS0234=''          
    set @Count0234=1  
    set @Mess0234_BSEFOOpt=''                                  
              
              
    select  row_number()over (order by Type) As Srno,Type,Stock,SX50OPT,BSXOPT,BKXOPT into #aa0234 from #BSEFOOpt          
     SELECT @totctrOT0234=count(1) from #aa0234           
   SET @MESS0234=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
      <tr><th  align="center" colspan="6">New Brokerage </th>
	   </tr>                           
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> ALL Rs./Lot </th>                                                                                 
       <th align="center"> SX50 Rs./Lot </th>
       <th align="center"> BSX Rs./Lot </th>
       <th align="center"> BKX Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count0234 <= @totctrOT0234                              
     BEGIN                        
      SELECT @Type0234=Type,@All=Stock,@SX50=SX50OPT,@BSX=BSXOPT,@BKX=BKXOPT FROM #aa0234 WHERE Srno=@count0234                                   
      set @Data0234=@Data0234+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type0234) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@All) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@SX50) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@BSX) +' </td>                                                                      
         <td align="center"> '+ CONVERT(VARCHAR,@BKX) +' </td>  
       </tr>'           
       print @Data0234                         
      SET   @Count0234=@Count0234+1                                    
     END   
     SET @MESS0234= @MESS0234 + @Data0234 +'</Table>'
     print  @MESS0234 
     
declare @Count0234_Old int,@CountEnd0234_Old int,@Type0234_Old as varchar(20)='',@All_Old as varchar(50),
@SX50_Old as varchar(50),@BSX_Old as varchar(50) ,@BKX_Old as varchar(50)      
  DECLARE @MessBody0234_Old NVARCHAR(MAX) ,@MESS0234_Old NVARCHAR(MAX)         
  DECLARE @xml0234_Old NVARCHAR(MAX)              
   DECLARE @Data0234_Old NVARCHAR(MAX) ,  @totctrOT0234_Old as int=0          
           
    set @Data0234_Old=''                
    set @MessBody0234_Old=''                          
    set @MESS0234_Old=''          
    set @Count0234_Old=1                                    
              
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,ALL_Old,SX50OPT_Old,BSXOPT_old,BKXOPT_Old 
	into #aa0234_Old from #BSEFOOpt_Old          
     SELECT @totctrOT0234_Old=count(1) from #aa0234_Old           
   SET @MESS0234_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
      <tr><th  align="center" colspan="6">Old Brokerage </th>
	   </tr>                           
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> ALL Rs./Lot </th>                                                                                 
       <th align="center"> SX50 Rs./Lot </th>
       <th align="center"> BSX Rs./Lot </th>
       <th align="center"> BKX Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count0234_Old <= @totctrOT0234_Old                              
     BEGIN                        
      SELECT @Type0234_Old=Type_Old,@All_Old=ALL_Old,@SX50_Old=SX50OPT_Old,@BSX_Old=BSXOPT_old,
	  @BKX_Old=BKXOPT_Old FROM #aa0234_Old WHERE Srno=@count0234_Old                                   
      set @Data0234_Old=@Data0234_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type0234_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@All_Old) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@SX50_Old) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@BSX_Old) +' </td>                                                                      
         <td align="center"> '+ CONVERT(VARCHAR,@BKX_Old) +' </td>  
       </tr>'           
       print @Data0234_Old                         
      SET   @Count0234_Old=@Count0234_Old+1                                    
     END   
     SET @MESS0234_Old=@MESS0234_Old + @Data0234_Old +'</Table>' 
     --set @Mess0234_BSEFOOpt='<Br><B>BSEFO Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS0234_OLD + '</td><td> '+ @MESS0234 +'</td></tr></Table>'          
     set @Mess0234_BSEFOOpt='<Br><B>BSEFO Option</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS0234 +'</td></tr></Table>'          

 
IF OBJECT_ID('tempdb..#BSEFOOpt', 'U') IS NOT NULL
    DROP TABLE #BSEFOOpt
IF OBJECT_ID('tempdb..#aa0234', 'U') IS NOT NULL
    DROP TABLE #aa0234
IF OBJECT_ID('tempdb..#BSEFOOpt_Old', 'U') IS NOT NULL
drop table #BSEFOOpt_Old
IF OBJECT_ID('tempdb..#aa0234_Old', 'U') IS NOT NULL
drop table #aa0234_Old
end

---------------NCDEX Option ------------------


select @NCXOP_Silver1M=isnull(FRIST_LEG_MAX_NEW,0) , @NCXOP_Silver2M=isnull(SECOND_LEG_MAX_NEW,0)  
from #Client with(nolock) where segment='NCX OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

select @NCXOP_Copper1M =isnull(FRIST_LEG_MAX_NEW,0), @NCXOP_Copper2M=isnull(SECOND_LEG_MAX_NEW,0)  
from #Client with(nolock) where segment='NCX OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

select @NCXOP_Zinc1M =isnull(FRIST_LEG_MAX_NEW,0), @NCXOP_Zinc2M=isnull(SECOND_LEG_MAX_NEW,0) 
from #Client with(nolock) where segment='NCX OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

select @NCXOP_Gold1M=isnull(FRIST_LEG_MAX_NEW,0)  ,@NCXOP_Gold2M=isnull(SECOND_LEG_MAX_NEW,0) 
from #Client with(nolock) where segment='NCX OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

select @NCXOP_Crudoil1M =isnull(FRIST_LEG_MAX_NEW,0),@NCXOP_Crudoil2M=isnull(SECOND_LEG_MAX_NEW,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

select @NCXOP_NaturalGas1M=isnull(FRIST_LEG_MAX_NEW,0) , @NCXOP_NaturalGas2M=isnull(SECOND_LEG_MAX_NEW,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

select @NCXOP_ALL1M=isnull(FRIST_LEG_MAX_NEW,0) , @NCXOP_ALL2M =isnull(SECOND_LEG_MAX_NEW,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='ALL' 	and party_code=@M_pcode

select @NCXOP_Silver1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0) ,@NCXOP_Silver2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='SILVER' 	and party_code=@M_pcode

select @NCXOP_Copper1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0),@NCXOP_Copper2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='COPPER' 	and party_code=@M_pcode

select @NCXOP_Zinc1M_Old =ISNULL(FRIST_LEG_MAX_OLD,0) ,@NCXOP_Zinc2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='ZINC' 	and party_code=@M_pcode

select @NCXOP_Gold1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0), @NCXOP_Gold2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='GOLD' 	and party_code=@M_pcode

select @NCXOP_Crudoil1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0),@NCXOP_Crudoil2M_Old =ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='CRUDEOIL' 	and party_code=@M_pcode

select @NCXOP_NaturalGas1M_Old=ISNULL(FRIST_LEG_MAX_OLD,0), @NCXOP_NaturalGas2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)
from #Client with(nolock) where segment='NCX OPT' and scheme_type='NaturalGas' 	and party_code=@M_pcode

select @NCXOP_ALL1M_Old =ISNULL(FRIST_LEG_MAX_OLD,0)  ,@NCXOP_ALL2M_Old=ISNULL(SECOND_LEG_MAX_OLD,0)  
from #Client with(nolock) where segment='NCX OPT' and scheme_type='ALL' 	and party_code=@M_pcode

if(@NCXOP_Silver1M>0 or @NCXOP_Silver2M>0 or @NCXOP_Copper1M>0 or @NCXOP_Copper2M>0 or @NCXOP_Zinc1M>0 or @NCXOP_Zinc2M>0 or
@NCXOP_Gold1M>0 or @NCXOP_Gold2M>0 or @NCXOP_Crudoil1M>0 or @NCXOP_Crudoil2M>0 or @NCXOP_NaturalGas1M>0 or @NCXOP_NaturalGas2M>0
or @NCXOP_ALL1M>0 or @NCXOP_ALL2M>0)
begin

create table #NCXOpt
(
Type  varchar(50),
SilverMin  varchar(50),
 CopperMin  varchar(50),
 ZincMin  varchar(50),
 GoldMin varchar(50),
 CrudoilMin varchar(50),
 NaturalGasMin varchar(50),
 All_Min varchar(50)) 
insert into #NCXOpt                   
select '1st Leg' as Type,@NCXOP_Silver1M as SilverMin ,@NCXOP_Copper1M as CopperMin,
 @NCXOP_Zinc1M as ZincMin ,@NCXOP_Gold1M as GoldMin,
 @NCXOP_Crudoil1M as  CrudoilMin ,@NCXOP_NaturalGas1M as NaturalGasMin,
 @NCXOP_ALL1M as All_Min   

insert into #NCXOpt                                     
select '2nd Leg' as Type,@NCXOP_Silver2M as SilverMin, @NCXOP_Copper2M as CopperMin,
 @NCXOP_Zinc2M as ZincMin ,@NCXOP_Gold2M as GoldMin,
 @NCXOP_Crudoil2M as  CrudoilMin, @NCXOP_NaturalGas2M as NaturalGasMin,
 @NCXOP_ALL2M as All_Min   


create table #NCXOpt_Old
(
Type_Old  varchar(50),
SilverMin_Old  varchar(50),
 CopperMin_Old  varchar(50),
 ZincMin_Old  varchar(50),
 GoldMin_Old varchar(50),
 CrudoilMin_Old varchar(50),
 NaturalGasMin_Old varchar(50),
 All_Min_Old varchar(50)) 
insert into #NCXOpt_Old                   
select '1st Leg' as Type,@NCXOP_Silver1M_Old as SilverMin_Old, @NCXOP_Copper1M_Old as CopperMin_Old,
  @NCXOP_Zinc1M_Old as ZincMin_Old,
@NCXOP_Gold1M_Old as GoldMin_Old ,@NCXOP_Crudoil1M_Old as  CrudoilMin_Old,
@NCXOP_NaturalGas1M_Old as NaturalGasMin_Old,@NCXOP_ALL1M_Old as All_Min_Old  

insert into #NCXOpt_Old                                    
select '2nd Leg' as Type,@NCXOP_Silver2M_Old as SilverMin_Old, 
@NCXOP_Copper2M_Old as CopperMin_Old,  @NCXOP_Zinc2M_Old as ZincMin_Old,@NCXOP_Gold2M_Old as GoldMin_Old, 
@NCXOP_Crudoil2M_Old as  CrudoilMin_Old ,@NCXOP_NaturalGas2M_Old as NaturalGasMin_Old,@NCXOP_ALL2M_Old as All_Min_Old  
            
  declare @Count111_4 int,@CountEnd111_4 int,@Type111_4 as varchar(20)='',@SilverMin_NCX as Varchar(50), 
  @CopperMin_NCX as Varchar(50)   , @ZincMin_NCX as Varchar(50), 
    @GoldMin_NCX as Varchar(50),  @CrudoilMin_NCX as Varchar(50),
  @NaturalGasMin_NCX as Varchar(50),  @All_Min_NCX as Varchar(50) 
  DECLARE @MessBody111_4 NVARCHAR(MAX) ,@MESS111_4 NVARCHAR(MAX)         
  DECLARE @xml111_4 NVARCHAR(MAX)              
   DECLARE @Data111_4 NVARCHAR(MAX) ,  @totctrOT111_4 as int=0 ,@Mess_NCXOpt NVARCHAR(MAX)  =''    
           
    set @Data111_4=''                
    set @MessBody111_4=''                          
    set @MESS111_4=''          
    set @Count111_4=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,SilverMin,CopperMin,ZincMin,GoldMin,
CrudoilMin,NaturalGasMin,All_Min   into #aa111_4 from #NCXOpt          

     SELECT @totctrOT111_4=count(1) from #aa111_4           
   SET @MESS111_4=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
   	   <tr><th  align="center" colspan="8">New Brokerage </th>
	   </tr>  
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Silver </th>                                                                                 
        <th align="center"> Copper </th>
 	   <th align="center"> Zinc </th>
 	   <th align="center"> Gold </th>
 	   <th align="center"> Crudoil </th>
 	   <th align="center"> NaturalGas </th>
 	   <th align="center"> All </th>
    </tr>'          
--print @MESS          
   WHILE @Count111_4 <= @totctrOT111_4                              
     BEGIN                        
      SELECT @Type111_4=Type,@SilverMin_NCX=SilverMin ,@CopperMin_NCX=CopperMin, @ZincMin_NCX=ZincMin,
	 @GoldMin_NCX=GoldMin, @CrudoilMin_NCX=CrudoilMin ,@NaturalGasMin_NCX=NaturalGasMin,
	  @All_Min_NCX=All_Min   FROM #aa111_4 WHERE Srno=@count111_4                                   
      set @Data111_4=@Data111_4+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type111_4) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin_NCX) +' </td>   
          <td align="center"> '+ CONVERT(VARCHAR,@CopperMin_NCX) +' </td>     
   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin_NCX) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin_NCX) +' </td>     
 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin_NCX) +' </td>     
 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin_NCX) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@All_Min_NCX) +' </td>     
 
       </tr>'           
       print @Data111_4                         
      SET   @Count111_4=@Count111_4+1                                    
     END   
     SET @MESS111_4=  @MESS111_4 + @Data111_4 +'</Table>'
     print  @MESS111_4         
 --drop table #aa111_4
 
 declare @Count4134 int,@CountEnd4134 int,@Type4134 as varchar(20)='',@SilverMin_NCX_Old as Varchar(50), 
  @CopperMin_NCX_Old as Varchar(50)  ,   @ZincMin_NCX_Old as Varchar(50), 
  @GoldMin_NCX_Old as Varchar(50),  @CrudoilMin_NCX_Old as Varchar(50), 
  @NaturalGasMin_NCX_Old as Varchar(50),   @All_Min_NCX_Old as Varchar(50) 
  DECLARE @MessBody4134 NVARCHAR(MAX) ,@MESS4134 NVARCHAR(MAX)         
  DECLARE @xml4134 NVARCHAR(MAX)              
   DECLARE @Data4134 NVARCHAR(MAX) ,  @totctrOT4134 as int=0          
           
    set @Data4134=''                
    set @MessBody4134=''                          
    set @MESS4134=''          
    set @Count4134=1                                    
              
              
    select  row_number()over (order by Type_Old) as Srno,Type_Old,SilverMin_Old,CopperMin_Old,ZincMin_Old,GoldMin_Old,
CrudoilMin_Old,NaturalGasMin_Old,All_Min_Old   into #aa4134 from #NCXOpt_Old          

     SELECT @totctrOT4134=count(1) from #aa4134           
   SET @MESS4134=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
   	   <tr><th  align="center" colspan="8">Old Brokerage </th>
	   </tr>  
   <tr>                       
    <th align="center"> Type_Old </th>                            
       <th align="center"> Silver_Old </th>                                                                                 
        <th align="center"> Copper_Old </th>
 	   <th align="center"> Zinc_Old </th>
 	   <th align="center"> Gold_Old </th>
 	   <th align="center"> Crudoil_Old </th>
 	   <th align="center"> NaturalGas_Old </th>
 	   <th align="center"> All_Old </th>
    </tr>'          
--print @MESS          
   WHILE @Count4134 <= @totctrOT4134                              
     BEGIN                        
      SELECT @Type4134=Type_Old,@SilverMin_NCX_Old=SilverMin_Old,@CopperMin_NCX_Old=CopperMin_Old,
	  @ZincMin_NCX_Old=ZincMin_Old,
	  @GoldMin_NCX_Old=GoldMin_Old,@CrudoilMin_NCX_Old=CrudoilMin_Old,@NaturalGasMin_NCX_Old=NaturalGasMin_Old,
	  @All_Min_NCX_Old=All_Min_Old  FROM #aa4134 WHERE Srno=@count4134                                   
      set @Data4134=@Data4134+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type4134) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@SilverMin_NCX_Old) +' </td>   
          <td align="center"> '+ CONVERT(VARCHAR,@CopperMin_NCX_Old) +' </td>     
   <td align="center"> '+ CONVERT(VARCHAR,@ZincMin_NCX_Old) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@GoldMin_NCX_Old) +' </td>     
 	  <td align="center"> '+ CONVERT(VARCHAR,@CrudoilMin_NCX_Old) +' </td>     
 	    <td align="center"> '+ CONVERT(VARCHAR,@NaturalGasMin_NCX_Old) +' </td>     
     <td align="center"> '+ CONVERT(VARCHAR,@All_Min_NCX_Old) +' </td>     
       </tr>'           
       print @Data4134                         
      SET   @Count4134=@Count4134+1                                    
     END   
     SET @MESS4134=  @MESS4134 + @Data4134 +'</Table>'
     --set @Mess_NCXOpt='<Br><B>NCDEX Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS4134 + '</td><td> '+ @MESS111_4 +'</td></tr></Table>'          
     set @Mess_NCXOpt='<Br><B>NCDEX Option</B> <Br><Br>'+ '<Table> <tr><td> '+ @MESS111_4 +'</td></tr></Table>'          


IF OBJECT_ID('tempdb..#NCXOpt', 'U') IS NOT NULL
    DROP TABLE #NCXOpt
IF OBJECT_ID('tempdb..#aa111_4', 'U') IS NOT NULL
    DROP TABLE #aa111_4
IF OBJECT_ID('tempdb..#NCXOpt_Old', 'U') IS NOT NULL
drop table #NCXOpt_Old
IF OBJECT_ID('tempdb..#aa4134', 'U') IS NOT NULL
drop table #aa4134
end

	--SET @MessBody =  '<b><font size="4" color="#FF4500">Dear '+@ClientName+'('+@M_pcode+')</font></b>,<br/><br/>'+' We are acknowledging your request for change in brokerage rates as described below  <br/><br/> '+ isnull(@MESSBSE,'') + '<Br>'     
	SET @MessBody =  '<b><font size="4" color="#FF4500">Dear '+@ClientName+'('+@M_pcode+')</font></b>,<br/><br/>'+' We are acknowledging your request for change in brokerage rates as described below  <br/><br/> '+ isnull(@MESSBSE,'') + '<Br>'+ isnull(@MESSNSE,'')+'<Br>'+ isnull(@Mess2_NSEFO,'')+'<Br>'+isnull(@Mess7_NSEFOOpt,'') +'<Br>' +isnull(@MESS14_MCX,'') +'<Br>' +isnull(@MESS4_NCDX,'')+'<Br>' +isnull(@MESS5_NSX,'')+'<Br>'  +isnull(@Mess2_BSEFO,'')+'<Br>' +isnull(@MESS8_NSXOption,'')+'<Br>' +isnull(@Mess_MCXOpt,'')+'<Br>'+isnull(@Mess_NCXOpt,'')+'<Br>' +isnull(@Mess0234_BSEFOOpt,'') +'<Br>'--+isnull(@Mess_NCEOpt,'')+'<Br>'    
	--print @MessBody
	SET @MessBody=@MessBody+'<BR><BR>Regards,<br><Br>Angel One.'                                    
	SET @MessBody=@MessBody+'<BR><BR>This is a system generated message. Please do not Reply.'
	SET @MessBody=@MessBody+'<BR><BR> Please contact- 1800 1020 '
	set @sub='Acknowledgement of Brokerage modification for Client Code-'+@M_pcode+'' 
	                                 
                          
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                    
 @RECIPIENTS =@emailto ,                                    
 @COPY_RECIPIENTS = @emailcc,                                    
 --@blind_copy_recipients =@emailbcc,               
 @PROFILE_NAME = 'AngelBroking',                                    
 @BODY_FORMAT ='HTML',                                    
 @SUBJECT = @sub,                                    
 @FILE_ATTACHMENTS ='',                                    
 @BODY =@MessBody 

 set @pcount=@pcount+1
 --print @MESSBSE
-- print @M_pcode
end
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Brokerage_Files_hist
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Brokerage_Files_hist]         
@fnOperationCode int=0,        
@fsFileName varchar(50)=''        
AS        
BEGIN        
IF(@fnOperationCode=1)        
  BEGIN        
   select TOP 1 Filenames        
   from Brok_Client_forMail_hist         
   WHERE Filenames=@fsFileName        
  END        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DeleteOldSFDCClientResponseData
-- --------------------------------------------------
CREATE PROCEDURE DeleteOldSFDCClientResponseData
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @cutoff_date DATE;

    BEGIN TRY
        -- Calculate the cutoff date as the current date minus 3 months
        SET @cutoff_date = DATEADD(MONTH, -3, GETDATE());

        -- Start transaction
        BEGIN TRANSACTION;

        -- Delete records older than the cutoff date
        DELETE FROM tbl_SFDCClientrepsonseAPI
        WHERE [Date] < @cutoff_date;

        -- Commit transaction
        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        -- Rollback transaction in case of an error
        ROLLBACK TRANSACTION;

        -- Capture the error details
        DECLARE @ErrorMessage NVARCHAR(4000), @ErrorSeverity INT, @ErrorState INT;
        SELECT 
            @ErrorMessage = ERROR_MESSAGE(), 
            @ErrorSeverity = ERROR_SEVERITY(), 
            @ErrorState = ERROR_STATE();

        -- Raise the error to be handled by the calling application
        RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
    END CATCH;
END;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.find_text_in_sp
-- --------------------------------------------------

create PROCEDURE [dbo].[find_text_in_sp]   
  @text varchar(250),   
  @dbname varchar(64) = null  
AS BEGIN  
SET NOCOUNT ON;   
  
if @dbname is null  
  begin  
    --enumerate all databases.   
  DECLARE #db CURSOR FOR Select Name from master..sysdatabases   
  declare @c_dbname varchar(64)   
  
  OPEN #db FETCH #db INTO @c_dbname   
  while @@FETCH_STATUS <> -1 --and @MyCount < 500   
   begin  
     execute find_text_in_sp @text, @c_dbname   
     FETCH #db INTO @c_dbname   
   end     
  CLOSE #db DEALLOCATE #db   
 end --if @dbname is null   
else  
 begin --@dbname is not null   
  declare @sql varchar(250)   
  --create the find like command   
  select @sql = 'select ''' + @dbname + ''' as db, o.name,m.definition '  
  select @sql = @sql + ' from '+@dbname+'.sys.sql_modules m '  
  select @sql = @sql + ' inner join '+@dbname+'..sysobjects o on m.object_id=o.id'  
  select @sql = @sql + ' where [definition] like ''%'+@text+'%'''  
  execute (@sql)   
 end --@dbname is not null   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Get_Inhouse_SMS_SebiPO
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Get_Inhouse_SMS_SebiPO]                                        
As                                         
Begin                                        
                                    
select *  into #sms                                         
from sms.dbo.tbl_SMSMessages with (nolock)                                         
where date= CONVERT(varchar,GETDATE(),103) and flag='P'                   
and purpose in ('Sebi PreSMS','SEBI Circular Funds Payout','SEBI Payout failed SMS','Request Payout Failed')                  
                  
update #sms set message=message+' Regards - Angel One'  where purpose in ('Sebi PreSMS')                     
                                    
insert into tbl_sms_withouturl_processlog_CNS_SebiPO -- order by starttime desc                                      
select getdate(),ss=(select count(1) from #sms),''                                       
                                    
insert into tbl_SMSCNSSent_SebiPO(to_no,message,date,time,flag,ampm,purpose,Request,Response,Response_date,NoOfAttempt,EntryDate)                                    
select to_no,message,date,time,'P',ampm,purpose,'','','',0,GETDATE() from #sms                                   
                            
update I set flag='A' from sms.dbo.tbl_SMSMessages I, tbl_SMSCNSSent_SebiPO S                                             
where I.party_code=S.party_code and I.time=s.time and I.[date]=S.[date] and I.flag='P' and I.message=S.message and I.purpose=S.purpose     
and Convert(datetime,I.[date],103) >getdate()-10
                                   
                     
select top 10000 a.*,b.Template_Name,b.notification_type into #tmpsms                     
from tbl_SMSCNSSent_SebiPO a  with(nolock) join sms.dbo.SMS_TemplateMaster_new  b with(nolock) on a.purpose=b.purpose                     
where flag='P' and  a.entrydate>=getdate()-5 and NoOfAttempt<3                       
order by a.srno                     
                                 
update  a  set  a.NoOfAttempt=a.NoOfAttempt +1                     
from tbl_SMSCNSSent_SebiPO a                    
inner join #tmpsms b on a.srno=b.Srno                     
where   a.flag='P'                            
                    
select * from #tmpsms                    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetFailedResponsesLastTwoDays
-- --------------------------------------------------
CREATE PROCEDURE GetFailedResponsesLastTwoDays
AS
BEGIN
    SELECT *
    FROM tbl_SFDCClientrepsonseAPI
    WHERE FailedIds <>''
	AND Date >= DATEADD(DAY, -2, GETDATE());
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsertSFDCClientResponseAPIs
-- --------------------------------------------------
CREATE PROCEDURE InsertSFDCClientResponseAPIs
    @Status BIT,
    @Message NVARCHAR(255),
    @SuccessIds NVARCHAR(MAX),
    @FailedIds NVARCHAR(MAX),
    @Date DATETIME,
    @AttemptCount INT
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @InsertedId INT;

    BEGIN TRANSACTION;

    BEGIN TRY
        -- Insert into the main table
        INSERT INTO tbl_SFDCClientrepsonseAPI (Status, Message, SuccessIds, FailedIds, Date, AttemptCount)
        VALUES (@Status, @Message, @SuccessIds, @FailedIds, @Date, @AttemptCount);

        -- Get the ID of the newly inserted row
        SET @InsertedId = SCOPE_IDENTITY();

        -- Insert into the SuccessIds table
        INSERT INTO tbl_SFDCClientResponseAPI_SuccessIds (ResponseId, SuccessId)
        SELECT @InsertedId, Value
        FROM dbo.SplitString(@SuccessIds, ',');

        -- Commit the transaction
        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        -- Rollback the transaction if an error occurs
        ROLLBACK TRANSACTION;

        -- Raise an error with the details of the error
        DECLARE @ErrorMessage NVARCHAR(4000);
        DECLARE @ErrorSeverity INT;
        DECLARE @ErrorState INT;

        SELECT
            @ErrorMessage = ERROR_MESSAGE(),
            @ErrorSeverity = ERROR_SEVERITY(),
            @ErrorState = ERROR_STATE();

        RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
    END CATCH
END;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_AE_Cancel_26Jan2024
-- --------------------------------------------------
create procedure [dbo].[NCMS_AE_Cancel_26Jan2024](@id as int,@user as varchar(10),@ip as varchar(15))                             
as                         
set nocount on    
        
 insert into NCMS_PO_Cancel(POrequestID,Userid,UpdatedOn,IP_Address)    
 select @id,@user, GETDATE(),@ip    
    
 declare @pcode as varchar(10) = ''    
 select @pcode=party_Code from ncms_po_request with (nolock) where POrequestID=@id    
    
 update ncms_po_request     
 set PO_Statusid=6    
 --from risk.dbo.Fn_MixedUserSingleClientD(@user,@pcode) y     
 where ncms_po_request.Party_code=@pcode and ncms_po_request.POrequestID=@id    
 and ncms_po_request.PO_Statusid in (0,5)    
   
 exec NCMS_AE_GetPODetail @pcode        
           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_AE_SendMarkingSMS_10Aug2023
-- --------------------------------------------------
--NCMS_AE_SendMarkingSMS 'S1499152','NEFT2022101744014968'  
create PROCEDURE [dbo].[NCMS_AE_SendMarkingSMS_10Aug2023]                       
(@cltcode VARCHAR(20) = NULL,              
 @REFNO VARCHAR(25) = NULL)  
 as  
 begin  
  SELECT A.*,C.mobile_pager,C.long_name,C.email  INTO #SMSFILE1 FROM                   
   (select * from ncms_po_request WITH (NOLOCK) WHERE REQ_REFNO=@REFNO) a inner join                
   (SELECT PARTY_cODE,mobile_pager,long_name,email FROM Risk.dbo.client_Details WITH (NOLOCK) WHERE PARTY_CODE=@cltcode) c                           
   on a.party_code=c.party_code where a.party_code=@cltcode   
  
   declare @datetime varchar(20),@date varchar(11),@time varchar(11),@reqdate varchar(11)  
select @datetime=convert(varchar(20),dbo.udf_getcredittime(req_datetime,'','' ) ,106) from #SMSFILE1  
--select @datetime  
SELECT @date =left(@datetime, charindex(' ', @datetime) - 1)  
SELECT @time = reverse(left(reverse(@datetime), charindex(' ', (reverse(@datetime))+' ' ) -1))  
--select @date  
--select @time  
select @reqdate= Convert(varchar(11),CONVERT(date,cast(@date as date),106),113)  
  
    insert into sms.dbo.sms   
  select mobile_pager as No,--'8976552188' as No,    
 'Dear Client (' + ltrim(rtrim(CONVERT(VARCHAR(10),a.party_code))) +'), Rs.'+ convert(varchar,a.po_request)+' of payout request will be credited to A/C no.xxxx'+right(a.req_paybankid,4)+' by '+@reqdate+' '+@time +' subject to credit available in your ledg
er. Regards - Angel One'  
  ,convert(varchar(10),getdate(), 103)                      
   ,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':'+ ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                                         
   'P', case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end,                            
   'Payout Marking Spark' from #SMSFILE1 A  where len(replace(mobile_pager,' ',''))=10    
  
   drop table #SMSFILE1  
     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_AE_SendMarkingSMS_11Aug2023
-- --------------------------------------------------
--NCMS_AE_SendMarkingSMS_11Aug2023 'S1499152','NEFT2023081161929933'  
CREATE PROCEDURE [dbo].[NCMS_AE_SendMarkingSMS_11Aug2023]                       
(@cltcode VARCHAR(20) = NULL,              
 @REFNO VARCHAR(25) = NULL)  
 as  
 begin  
   
  SELECT A.*,C.mobile_pager,C.long_name,C.email,c.short_name,f.bankname as bank_name  INTO #SMSFILE1 FROM                   
   (select * from ncms_po_request WITH (NOLOCK) WHERE REQ_REFNO=@REFNO) a inner join                
   (SELECT PARTY_cODE,mobile_pager,long_name,email,short_name FROM Risk.dbo.client_Details WITH (NOLOCK) WHERE PARTY_CODE=@cltcode) c                           
   on a.party_code=c.party_code  
     left join       
 NCMS_ClientBankDetails_all f  with (nolock)  on  a.Party_Code=f.cltcode and a.req_paybankid=f.acno  where a.party_code=@cltcode   
  and Domain='AllSegment'  
  
   declare @datetime varchar(20),@date varchar(11),@time varchar(11),@reqdate varchar(11)  
    Declare @Name varchar(100)='',@Body varchar(max)='',@sub nvarchar(200)='',@emailto varchar(500),@emailcc varchar(max)='',  
 @emailbcc varchar(500),@po_request varchar(100)='',@po_request_sub money=0.00,@req_paybankid varchar(200)='',@req_datetime varchar(11)='',  
 @bankname varchar(500)=''  
  
select @datetime=convert(varchar(20),dbo.udf_getcredittime(req_datetime,'','' ) ,106),@Name=short_name,@po_request=PO_Request  
,@po_request_sub=PO_Request  
,@req_paybankid =Req_PayBankId,@req_datetime=Convert(varchar(11),CONVERT(date,cast(Req_datetime as date),106),113),@emailto=email,  
@bankname=bank_name from #SMSFILE1  
--select @datetime  
SELECT @date =left(@datetime, charindex(' ', @datetime) - 1)  
SELECT @time = reverse(left(reverse(@datetime), charindex(' ', (reverse(@datetime))+' ' ) -1))  
--select @date  
--select @time  
select @reqdate= Convert(varchar(11),CONVERT(date,cast(@date as date),106),113)  
  
    insert into sms.dbo.sms   
  select mobile_pager as No,--'8976552188' as No,    
 'Dear Client (' + ltrim(rtrim(CONVERT(VARCHAR(10),a.party_code))) +'), Rs.'+ convert(varchar,a.po_request)+' of payout request will be credited to A/C no.xxxx'+right(a.req_paybankid,4)+' by '+@reqdate+' '+@time +' subject to credit available in your ledg
er. Regards - Angel One'  
  ,convert(varchar(10),getdate(), 103)                      
   ,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':'+ ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                                         
   'P', case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end,                            
   'Payout Marking Spark' from #SMSFILE1 A  where len(replace(mobile_pager,' ',''))=10    
  
   drop table #SMSFILE1  
     
     /**For Sending Email */  
--if(ltrim(rtrim(@cltcode))='S1499152')  
--BEGIN  
     declare @CLIENTCODE AS VARCHAR(MAX) = ''                    
   DECLARE @Object AS INT;                    
   DECLARE @ResponseText AS VARCHAR(8000);                                 
                  
    declare @authHeader varchar(max)=''  
  SET @Body ='{  
  "email": {  
    "from_email": "donotreply@angelone.in",  
    "from_name": "AngelOne",  
    "destination_email": "'+convert(varchar,@emailto)+'",  
    "body": "\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n\t<title><\/title>\r\n<\/head>\r\n<body> \r\n\t\t<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-radius: 10px;border:1px solid #ccc\">\r\n\t\t\t<tr>\r\n\t\t\t  <td><table a
lign=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"min-width:620px;border-top-left-radius:15px;border-top-right-radius:15px;padding: 2px;background:#fff;\" width=\"720\">\r\n\t\t\t    <tbody>\r\n\t\t\t      <tr>\r\n\t\t\t        <td 
align=\"right\" style=\"padding:20px 30px 20px 0;text-align: right;\" valign=\"bottom\"><a><img alt=\"Angel One\" src=\"https:\/\/web.angelbackoffice.com\/angelbroking\/econnect\/AB_Spark_Emailers\/Angel_One_Logo.png\" style=\"width: 150px;\"><\/a><\/td>\
r\n\t\t          <\/tr>\r\n\t\t     <\/tbody>\r\n\t\t\t    <\/table><\/td>\r\n\t\t  <\/tr>\r\n\t\t\t<tr>\r\n\t\t\t\t<td>\r\n\t\t\t\t\t<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"720\">\r\n\t\t\t\t\t\t<tbody> \r\n\t\t\t
\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t\t<td align=\"center\" style=\"padding:30px 50px;font-family: ''Barlow'', sans-serif;font-size:14px;color:#000;text-align:justify;line-height:20px;vertical-align: top;\">\r\n\t\t\t\t\t\t\t\t  Dear '+convert(varchar,@Name)+',<
br><br>\r\n\t\t\t\t\t\t\t\t  We have received your withdrawal request for \u20B9'+convert(varchar,@po_request)+' on '+convert(varchar,@req_datetime)+'. <br><br>\r\n\t\t\t\t\t\t\t\t  The funds will be credited to your registered '+convert(varchar,@bankname
)+' account xxxx'+right(convert(varchar,@req_paybankid),4)+' by '+@time+' on '+@reqdate+', subject to the availability of funds in your Angel One account.<br><br>\r\n\t\t\t\t\t\t\t\t  You can track the status of your withdrawal request <a style=\"font-fam
ily: ''Barlow'', sans-serif;font-size:14px;text-decoration:underline;\" target=\"_blank\" href=\"https:\/\/angeloneapp.page.link\/withdraw-funds\">here<\/a>.<br><br>\r\n\t\t\t\t\t\t\t\t  Regards,<br>\r\n\t\t\t\t\t\t\t    Team Angel One<\/td>\r\n\t\t\t\t\t
\t\t<\/tr>\r\n\t\t\t\t\t\t<\/tbody>\r\n\t\t\t\t\t<\/table>\r\n\t\t\t\t<\/td>\r\n\t\t\t<\/tr>\r\n\t\t\t<tr>\r\n\t\t\t<td>\r\n\t\t\t\t<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" width=\"720\">\r\n\t\t\t\t\t\t<tbody>\r\n\t\t\t\t\t\t\t<tr>\r\n
\t\t\t\t\t\t\t  <td align=\"left\" style=\"padding: 0px;background: #fff;  border-bottom-left-radius: 15px; border-bottom-right-radius:  15px;border-top: 1px solid #ccc\" valign=\"top\"><table align=\"left\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\
" style=\"width: 100%\">\r\n\t\t\t\t\t\t\t    <tbody>\r\n\t\t\t\t\t\t\t      <tr>\r\n\t\t\t\t\t\t\t        <td align=\"left\" style=\"padding: 0px;background: #fff;  border-bottom-left-radius: 15px; border-bottom-right-radius:  15px\" valign=\"top\"><tabl
e align=\"left\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"width: 100%\">\r\n\t\t\t\t\t\t\t          <tbody>\r\n\t\t\t\t\t\t\t            <tr>\r\n\t\t\t\t\t\t\t              <td align=\"left\" valign=\"top\" style=\"font-size: 14px;color: #
131313;font-family: ''Barlow'', sans-serif; font-weight: 400; text-align: center;padding: 15px 20px; \"> Disclaimer - *Investments in securities market are subject to market risk, read all the<br>\r\n\t\t\t\t\t\t\t                related documents careful
ly before investing. <a href=\"http:\/\/bitly.ws\/oTzH\" target=\"_blank\" style=\"color: #2e51ff; text-decoration: none\">Read more...<\/a> <br>\r\n\t\t\t\t\t\t\t                **The information is only for consumption by the client and such material sh
ould not be redistributed. <\/td>\r\n\t\t\t\t\t\t                <\/tr>\r\n\t\t\t\t\t\t              <\/tbody>\r\n\t\t\t\t\t\t\t          <\/table><\/td>\r\n\t\t\t\t\t\t          <\/tr>\r\n\t\t\t\t\t\t        <\/tbody>\r\n\t\t\t\t\t\t\t    <\/table><\/td>
\r\n\t\t\t\t\t\t  <\/tr>\r\n\t\t\t\t\t\t<\/tbody>\r\n\t\t\t\t\t<\/table>\r\n\t\t\t<\/td>\r\n\t\t<\/tr>\r\n\t\t\t\r\n\t\t\t\r\n\t\t<\/table> \r\n<\/body>\r\n<\/html>",  
    "title": "Withdrawal request for \u20B9'+convert(varchar,@po_request)+' received: Angel One"  
  },  
  "template_id": "",  
  "reqid": "12345",  
  "priority": "transaction",  
  "notification_type": "Automation_26c29e59-118d-456f-9e4b-1766f5d7d4ff",  
  "ttl": 100,  
  "enable_history": false,  
  "variable_params": true,  
  "request_timestamp": 1687748450,  
  "count_filter_enable": true  
}'   
 SET @authHeader ='Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZXJ2aWNlIjoiaW5ob3VzZV9iYWNrb2ZmaWNlIiwiaWF0IjoxNjkwODAxODk4LCJleHAiOjE3ODU0OTYyOTYsImVudiI6InByb2QifQ.TOpyBpLdZZki09digm41pm45gtYWYo5kykqCC80RkJg'   
    EXEC sp_OACreate 'MSXML2.ServerXMLHTTP', @Object OUT;                  
    EXEC sp_OAMethod @Object, 'open', NULL, 'POST','http://internal-notification-producer-prod-1221466604.ap-south-1.elb.amazonaws.com/notifications/v2/send', 'false'                  
                     
    EXEC sp_OAMethod @Object, 'setRequestHeader', null, 'Content-Type', 'text/plain'                  
    EXEC sp_OAMethod @Object, 'setRequestHeader', null, 'Authorization',  @authHeader                 
    EXEC sp_OAMethod @Object, 'send', null, @body                  
                     
    EXEC sp_OAMethod @Object, 'responseText', @ResponseText OUTPUT                  
    --SELECT @ResponseText as [RESPONSE]                  
                     
    EXEC sp_OADestroy @Object                
    exec Usp_InsertFundsPayoutEmailer @cltcode,@ResponseText    
      
 if(@ResponseText is null)    
 begin    
  declare @profile_name varchar(100)      
  declare @recipients varchar(100)      
  declare @copy_recipients varchar(100)      
  declare @subject varchar(100)      
  declare @body1 varchar(100)      
  declare  @body_format varchar(100)      
  declare @MSg varchar(1000)    
      
  set @MSg='Mail not sent through CNS Please check.'           
  EXEC msdb.dbo.Sp_send_dbmail                        
  @profile_name='DBA',          
  @recipients='neha.naiwar@angelbroking.com',                
     @subject = 'Funds Payout Mail not sent through CNS',                        
  @body=@MSg ,                        
  @body_format = 'HTML'      
 end    
--END  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_AE_SendMarkingSMS_29Aug2023
-- --------------------------------------------------
--NCMS_AE_SendMarkingSMS 'S1499152','NEFT2022101744014968'  
create PROCEDURE [dbo].[NCMS_AE_SendMarkingSMS_29Aug2023]                       
(@cltcode VARCHAR(20) = NULL,              
 @REFNO VARCHAR(25) = NULL)  
 as  
 begin  
  SELECT A.*,C.mobile_pager,C.long_name,C.email  INTO #SMSFILE1 FROM                   
   (select * from ncms_po_request WITH (NOLOCK) WHERE REQ_REFNO=@REFNO) a inner join                
   (SELECT PARTY_cODE,mobile_pager,long_name,email FROM Risk.dbo.client_Details WITH (NOLOCK) WHERE PARTY_CODE=@cltcode) c                           
   on a.party_code=c.party_code where a.party_code=@cltcode   
  
   declare @datetime varchar(20),@date varchar(11),@time varchar(11),@reqdate varchar(11)  
select @datetime=convert(varchar(20),dbo.udf_getcredittime(req_datetime,'','' ) ,106) from #SMSFILE1  
--select @datetime  
SELECT @date =left(@datetime, charindex(' ', @datetime) - 1)  
SELECT @time = reverse(left(reverse(@datetime), charindex(' ', (reverse(@datetime))+' ' ) -1))  
--select @date  
--select @time  
select @reqdate= Convert(varchar(11),CONVERT(date,cast(@date as date),106),113)  
  
    insert into sms.dbo.sms   
  select mobile_pager as No,--'8976552188' as No,    
 'Dear Client (' + ltrim(rtrim(CONVERT(VARCHAR(10),a.party_code))) +'), Rs.'+ convert(varchar,a.po_request)+' of payout request will be credited to A/C no.xxxx'+right(a.req_paybankid,4)+' by '+@reqdate+' '+@time +' subject to credit available in your ledg
er. Regards - Angel One'  
  ,convert(varchar(10),getdate(), 103)                      
   ,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':'+ ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                                         
   'P', case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end,                            
   'Payout Marking Spark' from #SMSFILE1 A  where len(replace(mobile_pager,' ',''))=10    
  
   drop table #SMSFILE1  
     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_All_Omnysis_EXE
-- --------------------------------------------------
CREATE proc NCMS_All_Omnysis_EXE      
As      
begin       
   EXEC msdb.dbo.sp_start_job 'NCMS Omnysis Limit GM1'         
   EXEC msdb.dbo.sp_start_job 'NCMS Omnysis Limit GM2'         
   EXEC msdb.dbo.sp_start_job 'NCMS Omnysis Limit GM3'         
   EXEC msdb.dbo.sp_start_job 'NCMS Omnysis Limit GM4'          
   EXEC msdb.dbo.sp_start_job 'NCMS Omnysis Limit GM6'         
   EXEC msdb.dbo.sp_start_job 'NCMS Omnysis Limit GM7'         
   EXEC msdb.dbo.sp_start_job 'NCMS Omnysis Limit GM8'         
   EXEC msdb.dbo.sp_start_job 'NCMS Omnysis Limit GM9'         
   EXEC msdb.dbo.sp_start_job 'NCMS Omnysis Limit GM102'         
   --EXEC msdb.dbo.sp_start_job 'NCMS Omnysis Limit GM11'         
      
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_AutoPO_Bill_KYC
-- --------------------------------------------------
    
create Procedure [dbo].[NCMS_AutoPO_Bill_KYC]        
as        
set nocount on        
SET XACT_ABORT ON                                 
BEGIN TRY                                      
   
 select party_code  into #Client_Code 
 from cms.dbo.NCMS_AutoPayout_BillToBill with(nolock) where  auto_payout='Y'    and party_code not in (Select party_code from cms.dbo.NCMS_Commodity_clients  where 
 CAST(updatedOn as date)=CAST(GETDATE() as date) )
    
create table #POForBillOpen        
(        
 id int identity(1,1) ,        
 nSegMinId int,         
 PoRequestId int,        
 Party_code varchar(50),        
 Amount money,        
 AccountNo varchar(50),        
 Paymode varchar(50),        
 LedgerAmout money,        
 sEntity varchar(50),        
 sRefNo varchar(50),        
 sReq_user varchar(50),  
 sReq_datetime datetime   
)
     
select  netpayable,b.Party_code  into #rr from NCMS_EntityDataView_combine a with (nolock) 
join  #Client_Code b on a.Party_code=b.party_code where a.NetPayable>1 
   
select distinct ROW_NUMBER() OVER ( ORDER BY Party_code) AS [SrNo],Party_code,netpayable into #file1 from #rr where netpayable>0

insert into #POForBillOpen(Party_code,Amount,sReq_datetime,LedgerAmout,sEntity)
select party_Code,netpayable,getdate(),netpayable,'AllSegment' from #file1

/*UPDATE SEG MIN ID*/          
          
 UPDATE a          
 SET nSegMinId = b.id          
 FROM #POForBillOpen a          
 JOIN NCMS_EntityDataView_combine b ON a.Party_Code = b.party_code                 
 AND a.sEntity = b.entity   

  /*UPDATE ACCOUNT NUMBER*/          
           
 UPDATE c               
 SET c.AccountNo = b.AccNO ,c.Paymode=b.paymode         
 FROM  #POForBillOpen c          
 LEFT JOIN                 
 (                
  SELECT DISTINCT cltcode,Bank_name,AccNO,paymode                
  FROM (                
     SELECT ROW_NUMBER() OVER(PARTITION BY cltcode ORDER BY cltcode,selforonline DESC) AS 'srno',*                 
     FROM  Acc_master_Online_cli With(Nolock)               
     where payMode='NEFT'       
     --selForOnline = 1          
     ) a  WHERE a.srno = 1                
 )b on c.Party_Code= b.cltcode                 
 where isnull(c.Party_Code,'')<>''   
   
 
 INSERT INTO NCMS_PO_Request(SegMinID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,                
 Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,requestType,remarks)                 
        
 SELECT distinct a.nSegMinId,Party_code,sEntity,LedgerAmout,Amount,sReq_datetime,sReq_datetime,'INTRANET','Bill_KYC',Paymode,AccountNo,                
 '' AS Req_RefNo,0 AS POveriID,0 AS PO_ApprovedAmt,0 AS PO_Statusid,'U','Bill Payout KYC'               
 FROM #POForBillOpen a       

  UPDATE a          
 SET a.req_refno = a.Req_Paymode+REPLACE(CONVERT(VARCHAR(10),GETDATE(),102),'.','')+          
 (SELECT ISNULL(REPLACE(SPACE(5-len(CONVERT(VARCHAR,MAX(porequestid)))),' ','0'),'') + CONVERT(VARCHAR,MAX(porequestid))  
  FROM NCMS_PO_Request b WHERE b.party_code = a.party_code AND b.req_user = 'Bill_KYC' AND NULLIF(b.req_refno,'') IS NULL )           
 FROM NCMS_PO_Request a          
 WHERE NULLIF(req_refno,'') IS NULL AND a.req_user = 'Bill_KYC'        
        
End try                                   
BEGIN CATCH                                      
                                  
  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                            
  select GETDATE(),'NCMS_AutoPO_Bill_KYC',ERROR_LINE(),ERROR_MESSAGE()                                            
      
  DECLARE @ErrorMessage NVARCHAR(4000);                                        
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                        
  RAISERROR (@ErrorMessage , 16, 1);              
                               
End catch                         
                              
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_AutoPO_Bill_KYC_commClients
-- --------------------------------------------------
      
CREATE Procedure [dbo].[NCMS_AutoPO_Bill_KYC_commClients]          
as          
set nocount on          
SET XACT_ABORT ON                                   
BEGIN TRY                                        
     
 select party_code  into #Client_Code   
 from cms.dbo.NCMS_AutoPayout_BillToBill with(nolock) where  auto_payout='Y'    and party_code  in (Select party_code from cms.dbo.NCMS_Commodity_clients  where   
 CAST(updatedOn as date)=CAST(GETDATE() as date) )  
      
create table #POForBillOpen          
(          
 id int identity(1,1) ,          
 nSegMinId int,           
 PoRequestId int,          
 Party_code varchar(50),          
 Amount money,          
 AccountNo varchar(50),          
 Paymode varchar(50),          
 LedgerAmout money,          
 sEntity varchar(50),          
 sRefNo varchar(50),          
 sReq_user varchar(50),    
 sReq_datetime datetime     
)  
       
select  netpayable,b.Party_code  into #rr from NCMS_EntityDataView_combine a with (nolock)   
join  #Client_Code b on a.Party_code=b.party_code where a.NetPayable>1   
     
select distinct ROW_NUMBER() OVER ( ORDER BY Party_code) AS [SrNo],Party_code,netpayable into #file1 from #rr where netpayable>0  
  
insert into #POForBillOpen(Party_code,Amount,sReq_datetime,LedgerAmout,sEntity)  
select party_Code,netpayable,getdate(),netpayable,'AllSegment' from #file1  
  
/*UPDATE SEG MIN ID*/            
            
 UPDATE a            
 SET nSegMinId = b.id            
 FROM #POForBillOpen a            
 JOIN NCMS_EntityDataView_combine b ON a.Party_Code = b.party_code                   
 AND a.sEntity = b.entity     
  
  /*UPDATE ACCOUNT NUMBER*/            
             
 UPDATE c                 
 SET c.AccountNo = b.AccNO ,c.Paymode=b.paymode           
 FROM  #POForBillOpen c            
 LEFT JOIN                   
 (                  
  SELECT DISTINCT cltcode,Bank_name,AccNO,paymode                  
  FROM (                  
     SELECT ROW_NUMBER() OVER(PARTITION BY cltcode ORDER BY cltcode,selforonline DESC) AS 'srno',*                   
     FROM  cms.dbo.Acc_master_Online_cli With(Nolock)                 
     where payMode='NEFT'         
     --selForOnline = 1            
     ) a  WHERE a.srno = 1                  
 )b on c.Party_Code= b.cltcode                   
 where isnull(c.Party_Code,'')<>''     
     
   
 INSERT INTO NCMS_PO_Request(SegMinID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,                  
 Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,requestType,remarks)                   
          
 SELECT distinct a.nSegMinId,Party_code,sEntity,LedgerAmout,Amount,sReq_datetime,sReq_datetime,'INTRANET','Bill_KYC',Paymode,AccountNo,                  
 '' AS Req_RefNo,0 AS POveriID,0 AS PO_ApprovedAmt,0 AS PO_Statusid,'U','Bill Payout KYC'                 
 FROM #POForBillOpen a         
  
  UPDATE a            
 SET a.req_refno = a.Req_Paymode+REPLACE(CONVERT(VARCHAR(10),GETDATE(),102),'.','')+            
 (SELECT ISNULL(REPLACE(SPACE(5-len(CONVERT(VARCHAR,MAX(porequestid)))),' ','0'),'') + CONVERT(VARCHAR,MAX(porequestid))    
  FROM NCMS_PO_Request b WHERE b.party_code = a.party_code AND b.req_user = 'Bill_KYC' AND NULLIF(b.req_refno,'') IS NULL )             
 FROM NCMS_PO_Request a            
 WHERE NULLIF(req_refno,'') IS NULL AND a.req_user = 'Bill_KYC'          
          
End try                                     
BEGIN CATCH                                        
                                    
  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                              
  select GETDATE(),'NCMS_AutoPO_Bill_KYC',ERROR_LINE(),ERROR_MESSAGE()                                              
        
  DECLARE @ErrorMessage NVARCHAR(4000);                                          
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                          
  RAISERROR (@ErrorMessage , 16, 1);                
                                 
End catch                           
                                
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_AutoPOprocess_Equity
-- --------------------------------------------------
  
CREATE Procedure [dbo].[NCMS_AutoPOprocess_Equity]      
as      
set nocount on      
SET XACT_ABORT ON                               
BEGIN TRY                                    
 
 select client_code,FundsLowerlimit,FundsUpperLimit,BSECM,NSECM,NSEFO,NSECF,MCXCDS,BSEMFSS,MCX,NCDEX into #Client_Code1 from NCMS_AutoPO with(nolock) where to_date >= getdate() and 
  (BSECM='Y' or NSECM='Y' or NSEFO='Y' or NSECF='Y' or MCXCDS='Y' or BSEMFSS='Y' Or MCX='Y' or NCDEX='Y') and 
  auto_funds_payout='Y' 
    and  client_code not in (Select party_code from cms.dbo.NCMS_Commodity_clients)  
  
  /***************************Added on 11 Jun 2021****start**********************************/
  
select SUM(NetPayable) as netpayable,b.Client_code,FundsLowerlimit,FundsUpperLimit into #rr from NCMS_SegwiseCldata a
with (nolock) join  #Client_Code1 b on a.Party_code=b.Client_code where netpayable>1
group by b.Client_code,FundsLowerlimit,FundsUpperLimit

select distinct client_code into #Client_Code from #rr where netpayable>=FundsLowerlimit and netpayable<=FundsUpperLimit

  /************************************************end*****************/
/*  
declare @mdt as datetime    
  
select @mdt=MIN(End_Date) from                       
(                
select top 2 * from risk.dbo.sett_mst where Start_date<=GETDATE() and Sett_Type='D'                
order by start_Date desc                
) x   

set @mdt=CAST(CONVERT(VARCHAR(10),@mdt,102) AS DATETIME)
--select @mdt

update NCMS_PO_Request set PO_Statusid=6,remarks='(BOD-A-EXPIRED)'+ltrim(rtrim(isnull(Convert(varchar(50),remarks),'')))     
where POdt_request < @mdt and PO_Statusid in (0,7) and req_paymode='NEFT'  and
 Party_code in(select client_code from #Client_Code)
 */     
 select * into #NCMS_AutoPO_Struc from NCMS_AutoPO_Struc where 1=2       
 declare @pcode as varchar(10) = '',@PO_Amt as money = 0,@acnum as varchar(25) ='',@ctr as int = 1,@totctr as int = 0      
   
 select     
 ROW_NUMBER() OVER ( ORDER BY b.client_Code) AS [SrNo],                      
 b.client_Code,BSECM,NSECM,NSEFO,NSECF,MCXCDS,BSEMFSS,MCX,NCDEX,FundsLowerLimit,FundsUpperLimit      
 into #file1    
 from    
 (select PARTY_CODE,NetPayable from NCMS_Entitydata_po where Entity='AllSegment' and NetPayable > 0 and flag='V') a join    
 (select client_code,FundsLowerlimit,FundsUpperLimit,BSECM,NSECM,NSEFO,NSECF,MCXCDS,BSEMFSS,MCX,NCDEX from NCMS_AutoPO where to_date >= getdate() and 
  (BSECM='Y' or NSECM='Y' or NSEFO='Y' or NSECF='Y' or MCXCDS='Y' or BSEMFSS='Y' Or MCX='Y' or NCDEX='Y') and 
  auto_funds_payout='Y'  ) b    
 on a.party_Code=b.client_code     
 /* where a.NetPayable >= FundsLowerlimit and a.NetPayable <= replace(FundsUpperLimit,-1,99999999) */   
 
 /**********Start************************************************/ 
   select  distinct party_Code into #ehb from NCMS_PO_Request    where Party_code in(select client_code from #file1) and req_user not like 'system%'

delete from #file1 where client_Code in (select party_code from #ehb)
delete from #file1 where client_Code in (Select party_code from cms.dbo.NCMS_Commodity_clients)
/************end***********************************************/

 declare @SegAmt as money = 0,@minlim as money =0, @maxlim as money =0      
 select @totctr=MAX(srno) from #file1      
      
 While @ctr <= @totctr       
 Begin      
	select @pcode=client_Code,@minlim=FundsLowerLimit,@maxlim=FundsUpperLimit from #file1 where srno=@ctr      
	
	set @SegAmt=0
	
	select @SegAmt=SUM(NetPayable) from NCMS_SegwiseCldata a join 
	(
		select srno,Client_code,'BSECM' as exchange from #file1 where BSECM='Y' and srno=@ctr
		union all
		select srno,Client_code,'NSECM' as exchange from #file1 where NSECM='Y' and srno=@ctr
		union all
		select srno,Client_code,'NSEFO' as exchange from #file1 where NSEFO='Y' and srno=@ctr
		union all
		select srno,Client_code,'NSX' as exchange from #file1 where NSECF='Y' and srno=@ctr
		union all
		select srno,Client_code,'MCD' as exchange from #file1 where MCXCDS='Y' and srno=@ctr
		union all
		select srno,Client_code,'BSEMFSS' as exchange from #file1 where BSEMFSS='Y' and srno=@ctr
		union all
		select srno,Client_code,'MCX' as exchange from #file1 where MCX='Y' and srno=@ctr
		union all
		select srno,Client_code,'NCDEX' as exchange from #file1 where NCDEX='Y' and srno=@ctr
	) b 
	on a.Party_code=b.client_Code and a.Segment=b.exchange
	
	if @maxlim=-1
	set  @maxlim=999999999.99
	
	if @SegAmt >=@minlim and @SegAmt <= @maxlim
	BEGIN
	
		select @PO_Amt=(case when SUM(NetPayable) >= @SegAmt then @SegAmt else SUM(NetPayable) end) from NCMS_Entitydata where party_code=@pcode
		and Entity in ('AllSegment','NBFC') and NetPayable>1
		
		truncate table #NCMS_AutoPO_Struc       
		insert into #NCMS_AutoPO_Struc exec NCMS_Marking1 'e01002',@pcode      

		/* select @pcode=a.party_code,@PO_Amt=EQ_amt,@acnum=Acnum       */
		select @pcode=a.party_code,@acnum=Acnum       
		from #NCMS_AutoPO_Struc a join       
		(select SUM(netPayable) as EQ_amt,party_Code from #NCMS_AutoPO_Struc       
		where entity in ('AllSegment','NBFC') group by party_Code) b       
		on a.party_code=b.party_Code where entity='AllSegment' and flag='V'      

		exec NCMS_UPD_Request @pcode,'0.0.0.0','System',@PO_Amt,0,0,@acnum,'','','U','Auto Payout'      

	END
	      
  set @ctr=@ctr+1      
 End      
      
End try                                 
BEGIN CATCH                                    
                                
  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                          
  select GETDATE(),'NCMS_AutoPOprocess_Equity',ERROR_LINE(),ERROR_MESSAGE()                                          
    
  DECLARE @ErrorMessage NVARCHAR(4000);                                      
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                      
  RAISERROR (@ErrorMessage , 16, 1);            
                             
End catch                       
                            
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_AXISBankFileGeneration
-- --------------------------------------------------
create procedure [dbo].[NCMS_AXISBankFileGeneration]                                      
as                                      
Set nocount on                                                          
SET XACT_ABORT ON                                                             
BEGIN TRY  
  
 --Exec NCMS_HDFCBankFileGeneration_For_HDFCAcconts 
                                      
insert into NCMS_Bank_AXIS_hist  
select *,GETDATE() from NCMS_Bank_AXIS  
  
truncate table NCMS_Bank_AXIS  
                          
select ROW_NUMBER() OVER ( ORDER BY segment ) AS [SrNo],segment                          
into #CtrFile                                      
from cms.dbo.ncms_Entity_AXIS where BO_bankname='AXIS BANK' and ActiveStatus=1 /*  and Segment='MCX'*/
order by entity desc,seqid      

select distinct party_code,entity,req_paybankid,req_refno into #Ncms_Po_request from Ncms_Po_request with(nolock)                    
                                      
Declare @ctr int = 1,@totctr int = 0,@segment as varchar(10) = '',@batid as char(4) = ''                                      
select @totctr=MAX(srno) from #CtrFile                                      
                                      
CREATE TABLE #AXISdata                                      
(                                      
Content VARCHAR(8000),                                      
SegApprovedAmt MONEY,                                      
VerifierId INT                                      
)                                      
                          
select                                       
VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,PayMode,/*poid+4000000 as POid*/convert(bigint,poid+4000000) as POid,Batchid                                      
into #NCMS_SegPayoutAppAmt                           
from NCMS_SegPayoutAppAmt where 1=2                                       
                                      
WHILE @ctr <= @totctr                                      
BEGIN                                      
                                      
 select @segment=segment from  #CtrFile where srno=@ctr                                      
                                   
 TRUNCATE TABLE #AXISdata                             
 TRUNCATE TABLE #NCMS_SegPayoutAppAmt                                    
                          

 --update NCMS_SegPayoutAppAmt set Paymode='N06'                             
 --where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment                          
                          
 insert into #NCMS_SegPayoutAppAmt                          
 select top 1                                      
 VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,Paymode,'99'+CONVERT(varchar(15), poid+4000000)  
 ,Batchid                                       
 from NCMS_SegPayoutAppAmt                                       
 where SegApprovedAmt>0-- and batchid='240923151811'and Segment='NSECM'   
   and BANK_gen=0 and Segment=@segment and ODIN_gen=0 and convert(date,ProcessDateTime)>=
 CONVERT(date,GETDATE())

  /*******For Withdraw2*****************************************/
     
insert into #NCMS_SegPayoutAppAmt                                                
 select                                                             
 a.VerifierId,a.Req_RefNo,a.Party_Code,a.Entity,a.Segment,a.SegApprovedAmt,Paymode,POid                      
 ,Batchid                                                             
 from NCMS_SegPayoutAppAmt a join temp_withdraw2 b on a.Party_Code=b.Party_Code and a.Req_RefNo=b.Req_RefNo                                                             
 where a.SegApprovedAmt>0 and BANK_gen=0 and a.Segment=@segment and a.ODIN_gen=2 and convert(date,ProcessDateTime)>=
 CONVERT(date,GETDATE())  and b.Bank_Provider='ICICI'

select c.*,branch_cd,sub_broker,long_name into #df from  temp_withdraw2 c left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client d with(nolock) on                                                           
c.Party_code=d.party_code 
 
 /*******************************/
 
 update #NCMS_SegPayoutAppAmt set Paymode='N06' where paymode is null 
                    
 delete from    #NCMS_SegPayoutAppAmt where paymode is null                         

 if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)
 begin                                       
		 INSERT INTO #AXISdata                                      
 select Content=                                        
   'P^'+ TXN_PAYMODE
     +'^'    
     +b.CorporateCode 
	 +'^'+ltrim(rtrim(upper(a.poid)))
	 +'^'+ltrim(rtrim(BO_AccNo))
	 +'^'+CONVERT(char(10), GetDate(),126)   
	  +'^'+ltrim(rtrim(TXN_CRNCY))
     +'^'+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),SegApprovedAmt))))                  
     +'^'+ltrim(rtrim(convert(char(38),long_name)))+'^'+ltrim(rtrim(a.Party_Code))+'^'+ltrim(rtrim(c.Req_PayBankId))+'^'  
     +'^'+''                  
     +'^'+''             
     +'^'+''                      
     +'^'+''                  
     +'^'+''
	 +'^'+''
	 +'^'+''
	 +LTRIM(rtrim(d.bankname) ) 
	 +'^^^^^^^^^^^'
     +ltrim(rtrim(CorpBatchNo)) 
     +'^^^^^^^^'  
	 +LTRIM(rtrim(PayType)) +'^^^^'  +LTRIM(rtrim(USER_DEPARTMENT))                                              
     +'^^^^^'   
     ,a.SegApprovedAmt,VerifierID                                                
		 from                                      
		 #NCMS_SegPayoutAppAmt a                                       
		 join cms.dbo.ncms_Entity_AXIS b on a.segment=b.segment                                      
		 join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                       
		 left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on ltrim(rtrim(c.Req_PayBankId))=ltrim(rtrim(d.acno)) and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                      
		 and c.Party_code=d.cltcode  and d.paymode='NEFT'                                   
		 left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e   with(nolock)                                  
		 on a.Party_Code=e.party_code  
		 
		 INSERT INTO #AXISdata                                      
 select Content=                                        
   'P^'+ TXN_PAYMODE
     +'^'    
     +b.CorporateCode 
	 +'^'+ltrim(rtrim(upper(a.Req_RefNo)))
	 +'^'+ltrim(rtrim(BO_AccNo))
	 +'^'+CONVERT(char(10), GetDate(),126)   
	  +'^'+ltrim(rtrim(TXN_CRNCY))
     +'^'+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),a.SegApprovedAmt))))                  
     +'^'+ltrim(rtrim(convert(char(38),long_name)))+'^'+ltrim(rtrim(a.Party_Code))+'^'+ltrim(rtrim(c.Accno))+'^'  
     +'^'+''                  
     +'^'+''             
     +'^'+''                      
     +'^'+''                  
     +'^'+''
	 +'^'+''
	 +'^'+''
	 +LTRIM(rtrim(c.IFSC) ) 
	 +'^^^^^^^^^^^'
     +ltrim(rtrim(CorpBatchNo)) 
     +'^^^^^^^^'  
	 +LTRIM(rtrim(PayType)) +'^^^^'  +LTRIM(rtrim(USER_DEPARTMENT))                                              
     +'^^^^^'   
     ,a.SegApprovedAmt,VerifierID                                                
		 from                                      
		    #NCMS_SegPayoutAppAmt a                                 
   join cms.dbo.ncms_Entity_AXIS b on a.segment=b.segment                                                            
   join #df c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
   where c.bank_provider='ICICI' and c.ODIN_gen=2
 
		  /*Start--------------------------------Added on 16 Feb 2017 by Neha Naiwar for Bill2Bill-------------------------------------------*/   
		 INSERT INTO #AXISdata                                  
		 select Content=                                        
   'P^'+ TXN_PAYMODE
     +'^'    
     +b.CorporateCode 
	 +'^'+ltrim(rtrim(upper(a.poid)))
	 +'^'+ltrim(rtrim(BO_AccNo))
	 +'^'+CONVERT(char(10), GetDate(),126)   
	  +'^'+ltrim(rtrim(TXN_CRNCY))
     +'^'+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),SegApprovedAmt))))                  
     +'^'+ltrim(rtrim(convert(char(38),long_name)))+'^'+ltrim(rtrim(a.Party_Code))+'^'+ltrim(rtrim(d.acno))+'^'  
     +'^'+''                  
     +'^'+''             
     +'^'+''                      
     +'^'+''                  
     +'^'+''
	 +'^'+''
	 +'^'+''
	 +LTRIM(rtrim(d.bankname) ) 
	 +'^^^^^^^^^^^'
     +ltrim(rtrim(CorpBatchNo)) 
     +'^^^^^^^^'  
	 +LTRIM(rtrim(PayType)) +'^^^^'  +LTRIM(rtrim(USER_DEPARTMENT))                                              
     +'^^^^^'   
     ,a.SegApprovedAmt,VerifierID                            
		 from                                  
		 #NCMS_SegPayoutAppAmt a                                   
		 join cms.dbo.ncms_Entity_AXIS b on a.segment=b.segment                                  
		 join cms.dbo.NCMS_B2B_PO_Request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                     
		 left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                   
		 and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1                                   
		 /*left outer join risk.dbo.client_Details e */  /*Commented on 01 Dec 2017 For MFSS codes*/
		 left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client  e  with(nolock)  /*vw_NCMS_MFSS_client_details*/                            
		 on a.Party_Code=e.party_code  WHERE c.billamt>0 
		 /*End-------------------------------------------------------------------------------------------------*/    
 
 End
 else
 begin
		 INSERT INTO #AXISdata                                      
		select Content=                                        
   'P^'+ TXN_PAYMODE
     +'^'    
     +b.CorporateCode 
	 +'^'+ltrim(rtrim(upper(a.poid)))
	 +'^'+ltrim(rtrim(BO_AccNo))
	 +'^'+CONVERT(char(10), GetDate()+2,126)   
	  +'^'+ltrim(rtrim(TXN_CRNCY))
     +'^'+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),SegApprovedAmt))))                  
     +'^'+ltrim(rtrim(convert(char(38),long_name)))+'^'+ltrim(rtrim(a.Party_Code))+'^'+ltrim(rtrim(c.Req_PayBankId))+'^'  
     +'^'+''                  
     +'^'+''             
     +'^'+''                      
     +'^'+''                  
     +'^'+''
	 +'^'+''
	 +'^'+''
	 +LTRIM(rtrim(d.bankname) ) 
	 +'^^^^^^^^^^^'
     +ltrim(rtrim(CorpBatchNo)) 
     +'^^^^^^^^'  
	 +LTRIM(rtrim(PayType)) +'^^^^'  +LTRIM(rtrim(USER_DEPARTMENT))                                              
     +'^^^^^'   
     ,a.SegApprovedAmt,VerifierID                        
		 from                                      
		 #NCMS_SegPayoutAppAmt a                                       
		 join ncms_Entity_AXIS b on a.segment=b.segment                                      
		 join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                       
		 left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on ltrim(rtrim(c.Req_PayBankId))=ltrim(rtrim(d.acno)) and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                      
		 and c.Party_code=d.cltcode  and d.paymode='NEFT'                                   
		 /*left outer join risk.dbo.client_Details e */  /*Commented on 01 Dec 2017 For MFSS codes*/
		 left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e /*vw_NCMS_MFSS_client_details*/ with(nolock)                                  
		 on a.Party_Code=e.party_code                                      
 end
 /************Adding Log Table******************************/
 
     insert into NCMS_Bank_AXIS(VerifierId,req_refno,party_code,segment,SegApprovedAmt,paymode,poid,UpdateOn,acno,IFSCCode,
	 batchid)
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),acno,bankname,Batchid from #NCMS_SegPayoutAppAmt a                                       
 join cms.dbo.ncms_Entity_AXIS b on a.segment=b.segment                                      
 join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                       
 left outer join cms.dbo.NCMS_ClientBankDetails_all d on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                      
 and c.Party_code=d.cltcode  and d.paymode='NEFT' 

   insert into  NCMS_BANKfile_DetailData(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                      
 select a.VerifierID,a.Req_RefNo,a.Party_Code,a.Segment,a.SegApprovedAmt,a.PayMode,POid,GETDATE(),c.Accno,c.IFSC,Batchid from 
 #NCMS_SegPayoutAppAmt a                                                             
 join cms.dbo.ncms_Entity_AXIS b on a.segment=b.segment                                                            
 join #df c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
   where c.bank_provider='ICICI'
 
     insert into NCMS_Bank_AXIS(VerifierId,req_refno,party_code,segment,SegApprovedAmt,paymode,poid,UpdateOn,acno,IFSCCode,
	 batchid)
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),acno,bankname,batchid from #NCMS_SegPayoutAppAmt a                                   
 join cms.dbo.ncms_Entity_AXIS b on a.segment=b.segment                                  
 join  cms.dbo.NCMS_B2B_PO_Request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                     
 left outer join cms.dbo.NCMS_ClientBankDetails_all d on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                   
 and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1    WHERE c.billamt>0 

 
 --insert into tbl_RealPayout_Producer(Paymode,acno,bankname,poid,UpdateOn,SegApprovedAmt,party_code,segment,req_refno,VerifierId,batchid)
 --select Paymode,acno,bankname,poid,UpdateOn,SegApprovedAmt,UPPER(RTRIM(LTRIM(Party_code))) Party_code,segment,req_refno,VerifierId,batchid
 --from NCMS_BANKfile_DetailData where  verifierid<>0

 --exec USP_AMX_PAYOUT_KAFKA

 /*******************************************/
              
 delete from #AXISdata where content IS NULL                
                                 
 if (SELECT COUNT(1) FROM #AXISdata) > 0                                      
 BEGIN                                
                              
  if (SELECT COUNT(1) FROM NCMS_AXISBank_log where segment=@segment) > 0                      
   select @batid=risk.dbo.AddZeroPrefox(max(ISNULL(convert(int,BatchNo),0))+1,4) from NCMS_AXISBank_log where segment=@segment                                
  ELSE                      
   SET @batid='0001'                      
                                
  TRUNCATE TABLE NCMS_AXISBank                                       
                                    
  insert into NCMS_AXISBank(flag,content,verifierId,SegApprovedAmt)                                       
  select flag,content,verifierId,SegApprovedAmt from                                      
  (                                                                         
  select flag=1,content,verifierId,SegApprovedAmt  from #AXISdata                                                                           
  )  a                     

  DECLARE @s VARCHAR(MAX) = ''
  declare @FileName as varchar(100) ='',@batchid as varchar(20)='',@corporatecode as varchar(5)=''
  declare @FilePath varchar(200) =''  
  select distinct @batchid=batchid from NCMS_Bank_AXIS
  select @corporatecode=corporatecode from cms.dbo.ncms_Entity_AXIS

    if(@segment='NSECM')
  Begin                                           
   set @FileName = @corporatecode+'_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                    
  End
	 truncate table tmp_NCMS_AXISBank
		insert into tmp_NCMS_AXISBank
		select ROW_NUMBER() over (order by verifierID) Srno,* from NCMS_AXISBank

		declare @cnt as numeric=0,@filecnt as numeric=1
		declare @max as numeric
		select @max=MAX(Srno) from tmp_NCMS_AXISBank
		declare @tmpFileName as varchar(500)
		
		
		while(@cnt<@max)
		Begin
		--declare @cnt as numeric=1
		truncate table tmp_NCMS_AXISBank_batch
		
		 insert into tmp_NCMS_AXISBank_batch                                  
		select flag,content,verifierid from tmp_NCMS_AXISBank where Srno between (@cnt+1) and (@cnt+1) + 29999                                 

			set @tmpFileName = @FileName+'_'+cast(@filecnt as varchar)+'.txt'   
			select @FilePath=ltrim(rtrim(bankfolder))+@tmpFileName  from cms.dbo.ncms_Entity_AXIS where segment=@segment    
			 SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                     
			 SET @s = @s + 'bcp "select content from dustbin.dbo.tmp_NCMS_AXISBank_batch order by flag" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'   
			 SET @s = @s + ''''        
			 EXEC(@s)  
			
			
			DECLARE @s1 VARCHAR(MAX) = ''    
			SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''      
			SET @s1 = @s1 + 'bcp "select content from  tmp_NCMS_AXISBank_batch order by flag" queryout \\INHOUSELIVEAPP1-FS.angelone.in\d\upload\CMS_Test\ICICI_BankFile\'+@tmpFileName+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                 
                               
			SET @s1 = @s1 + ''''                                            
			EXEC(@s1)   
			
			--DECLARE @s2 VARCHAR(MAX) = ''       
		 --   SET @s2 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''          
		 --   SET @s2 = @s2 + 'bcp "select distinct content from INTRANET.cms.dbo.tmp_NCMS_AXISBank_batch" queryout \\INHOUSEHDFCLIVE-FS.angelone.in\hdfcforward\'+@tmpFileName+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                   
                                         
		 --   SET @s2 = @s2 + ''''                                                
		 --   EXEC(@s2)   
     

		set @cnt=@cnt+30000
		set @filecnt= @filecnt+1

		   insert into NCMS_BankFileName_log      
		   select @tmpFileName,SegApprovedAmt,'AXIS',@batchid,GETDATE() from tmp_NCMS_AXISBank with(nolock) where verifierid in      
		   (select verifierid from tmp_NCMS_AXISBank_batch with(nolock) )

		end
                               
  --update NCMS_SegPayoutAppAmt set BANK_gen=1,paymode=b.pmode from                                       
  --(select verifierid,pmode=SUBSTRING(content,2,3) from NCMS_AXISBank where flag=1)b                           
  --where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid                                     
  --and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and NCMS_SegPayoutAppAmt.Paymode is not NULL                                  
    
	 -- update NCMS_SegPayoutAppAmt set BANK_gen=1,BOFF_gen=1,paymode=b.pmode from                                      
  --(select a.verifierId, c.Req_RefNo from NCMS_AXISBank a 
		--join #df c on a.verifierId=c.verifierid
  --       and c.Bank_Provider='ICICI' where flag=1)b                                                   
  --where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid  and NCMS_SegPayoutAppAmt.Req_RefNo  =b.Req_RefNo                                                             
  --and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and
  --NCMS_SegPayoutAppAmt.Paymode is not NULL   and ODIN_gen=2                                                       


  --insert into NCMS_AXISBank_log(flag,content,verifierId,GeneratedOn,BatchNo,segment)                                       
  --select flag,content,verifierId,GETDATE(),@batid,@segment from NCMS_AXISBank                                      
 END                                      
                                      
 set @ctr=@ctr+1 
 drop table #df
                          
END                                      
                                      
DROP TABLE #AXISdata                                      
DROP TABLE #CtrFile                                      
                                      
End try                                                               
BEGIN CATCH                                                 
                                                              
 insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                       
 select GETDATE(),'NCMS_AXISBankFileGeneration',ERROR_LINE(),ERROR_MESSAGE()                                                                        
                                 
 DECLARE @ErrorMessage NVARCHAR(4000);                                                                    
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                    
 RAISERROR (@ErrorMessage , 16, 1);                                       
                                       
End catch                                                     
                                    
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_Batch_Exe
-- --------------------------------------------------
  
CREATE Procedure [dbo].[NCMS_Batch_Exe](@section as int)                          
as                          
                          
set nocount on                          
                       
DECLARE @XACT_ABORT VARCHAR(3) = 'OFF',@XactChg varchar(3) ='No';                          
IF ( (16384 & @@OPTIONS) = 16384 ) SET @XACT_ABORT = 'ON';                          
if @XACT_ABORT='OFF'                          
Begin                          
 SET XACT_ABORT ON                          
 set @XactChg='Yes'                          
End    
  
create table #File1  
(Ctr int ,Srno int,ProcedureName varchar(200),Active_Status int ,StartDate datetime,EndDate datetime,Flag int,spdesc varchar(200),  
Errflag varchar(200),section int)  
  
truncate table #File1   
                        
if(@section=1)  
Begin  
 --exec NCMS_All_PreLDSP                        
   
 insert into #File1                          
 select ROW_NUMBER() OVER ( ORDER BY srno ) AS [Ctr],              
 Srno,ProcedureName,Active_Status,StartDate,EndDate,Flag,spdesc,Errflag,section              
  from ncms_batch_process where active_Status=1 and flag=0 and section=@section  and Srno in (1,2)                     
End  
if(@section=2)  
Begin     
 insert into #File1                     
 select ROW_NUMBER() OVER ( ORDER BY srno ) AS [Ctr],              
 Srno,ProcedureName,Active_Status,StartDate,EndDate,Flag,spdesc,Errflag,section              
 from ncms_batch_process where active_Status=1 and flag=0 and section=@section                       
end                
declare @totctr as int = 0,@ctr as int = 1, @str as varchar(2000),@srno as int,@spname as varchar(200)                          
              
select @totctr=MAX(Ctr) from #file1                          
While @ctr <= @totctr                          
Begin                          
 set @str = ''                          
 select @srno=srno,@str='exec '+procedurename,@spname=procedurename from #File1 where ctr=@ctr                          
 Begin Try       
 if (@spname='NCMS_UPD_ReqVerId_Batchwise')  
 begin  
 return;  
 end  
  update ncms_batch_process set StartDate=GETDATE(),errflag='' where srno=@srno                          
   exec(@str)                 
                   
     /*        
     WAITFOR DELAY '00:00:02';          
     print @str                      
     */              
        
  if @srno < (select MAX(srno) from ncms_batch_process)   
  begin  
   update ncms_batch_process set EndDate=GETDATE(),Flag=1 where srno=@srno    
   --if(@srno=2)  
   -- begin  
   --  exec NCMS_All_PreLDSP    
   -- End  
  end  
  else    
  update ncms_batch_process set EndDate=GETDATE() where srno=@srno          
     
      
  
 End Try                          
 Begin Catch                          
                
  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                  
  select GETDATE(),@spname,ERROR_LINE(),ERROR_MESSAGE()                   
                  
  update ncms_batch_process set errflag='<font color="red">Error</font>' where Srno=@srno                    
                                        
  DECLARE @ErrorMessage NVARCHAR(4000);                                      
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                      
  RAISERROR (@ErrorMessage , 16, 1);                             
                          
  RETURN                          
                            
 End Catch                          
 set @ctr=@ctr+1                          
End                          
                          
if @XactChg='Yes'                          
Begin                          
 SET XACT_ABORT OFF                          
end                          
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_BOapiPush_HDFCAccount
-- --------------------------------------------------

create Proc [dbo].[NCMS_BOapiPush_HDFCAccount]                      
as                      
Set nocount on                                              
SET XACT_ABORT ON                                                 
BEGIN TRY                         
     
--  update a set BOFF_gen=1,BOFF_posted=b.Rowstate from NCMS_SegPayoutAppAmt a inner join           
--(select distinct cltcode,RETURN_FLD4,Rowstate,debitAmt,return_fld2 from anand.MKTAPI.dbo.tbl_post_data  b where b.Return_fld5='NCMS_PO' and
-- b.Vdate>=GETDATE()-3  ) b on           
-- a.VerifierID=b.RETURN_FLD4                    
-- and    a.party_code=b.cltcode              
-- and a.SegApprovedAmt=b.debitAmt               
-- and a.Req_RefNo=b.return_fld2 join NCMS_PO_Request_hist c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
--  left outer join NCMS_ClientBankDetails_all d on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                      
-- and c.Party_code=d.cltcode  and d.paymode='NEFT'          
-- where  d.bankname like 'HDFC%' 
--  and a.SegApprovedAmt>0     
 /* for YES BANK ONLY */  

 select * into #bo from AngelBSECM.MKTAPI.dbo.tbl_post_data  b with(nolock) where b.Return_fld5='NCMS_PO' and b.Vdate>=GETDATE()-3  and left(b.return_fld2,6)='NORMAL'

update a set BOFF_gen=1,BOFF_posted=b.Rowstate from NCMS_SegPayoutAppAmt a inner join             
(select distinct cltcode,RETURN_FLD4,Rowstate,debitAmt,return_fld2 from #bo
) b on             
 a.VerifierID=b.RETURN_FLD4                      
 and    a.party_code=b.cltcode                
 and a.SegApprovedAmt=b.debitAmt                 
 --and a.Req_RefNo=b.return_fld2             
 where            
  a.SegApprovedAmt>0  and a.processdatetime>=CONVERT(varchar(11),getdate()) and a.bank_gen=3 and a.ODIN_gen=0

     
select * into #gh from   AngelBSECM.MKTAPI.dbo.tbl_post_data with(nolock) where Return_fld5='NCMS_PO' and Vdate>=GETDATE()-3 

 update a set BOFF_gen=1,BOFF_posted=Rowstate from NCMS_SegPayoutAppAmt a  inner join                       
 (                        
  select DDNO,Rowstate,RETURN_FLD4,cltcode,debitAmt,return_fld2  from #gh
                    
 ) b on a.VerifierID=b.RETURN_FLD4         
 and a.party_code=b.cltcode        
 and a.SegApprovedAmt=b.debitAmt         
 --and a.Req_RefNo=b.return_fld2  
 and a.processdatetime>=CONVERT(varchar(11),getdate())
 and a.bank_gen=3 and a.ODIN_gen=0

  
  select POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity into #request from NCMS_PO_Request with (nolock) group by 
 POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity

 
 select a.*,e.bank_name into #porequest from #request a left join risk.dbo.v_rtgs_client e with(nolock) on 
 a.Party_Code = e.fld_party_code and a.Req_payBankId=ltrim(rtrim( e.fld_bank_acno ))
  
 if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)
 begin 
		 insert into AngelBSECM.MKTAPI.dbo.tbl_post_data                    
		 /* insert into NCMS_tbl_post_data   */                    
		 (VOUCHERTYPE,SNO,VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,NARRATION,BANKCODE,MARGINCODE,BANKNAME,BRANCHNAME,BRANCHCODE,DDNO,CHEQUEMODE,                      
		 CHEQUEDATE,CHEQUENAME,CLEAR_MODE,TPACCOUNTNUMBER,EXCHANGE,SEGMENT,MKCK_FLAG,Return_fld4,Return_fld5,Rowstate,Return_fld2)                                        
		 select                                     
		 3 as VOUCHERTYPE,                      
		 ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SNo],                      
		 convert(varchar(11),processDatetime) as VDATE,                      
		 convert(varchar(11),processDatetime) as EDATE,                      
		 a.Party_Code as CLTCODE,                      
		 0 as CREDITAMT,                      
		 SegApprovedAmt as DEBITAMT,                      
		 --b.NARRATION as NARRATION,            
		 'Amount transferred to A/C xxxxx'+right(d.req_paybankid,4)+' '+d.bank_name as NARRATION,                                 
		 BO_BankCode as BANKCODE,                      
		 '' as MARGINCODE,                      
		 BO_BankName as BANKNAME,                      
		 '' as BRANCHNAME,                      
		 'HO' as BRANCHCODE,                      
		 poid+4000000 as DDNO,          
		 /*VerifierId as DDNO, */
		 /* convert(varchar(10),VerifierID)+convert(varchar(10),RequestID) as DDNO, */          
		 'A' as CHEQUEMODE,                      
		 convert(varchar(11),processDatetime) as CHEQUEDATE,                      
		 party_name as CHEQUENAME,                      
		 'L' as CLEAR_MODE,                      
		 Req_payBankId as TPACCOUNTNUMBER,                      
		 BO_exchange as EXCHANGE,                      
		 BO_segment as SEGMENT,                      
		 1 as MKCK_FLAG,                      
		 VerifierID as Return_fld4,                      
		 'NCMS_PO' as Return_fld5,                      
		 0 as Rowstate,        
		 left(a.Req_RefNo,20) as Return_fld2                       
		 from                       
		  (select * from NCMS_SegPayoutAppAmt where BANK_gen=3 and BOFF_gen=0 and SegApprovedAmt > 0 and ODIN_gen=0 ) a join NCMS_HDFCbankDetails_for_HDFCAcc b                      
		 on a.Segment=b.Segment                      
		 join (select POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity,bank_name from #porequest with (nolock) ) d                      
		 on d.POrequestID=a.RequestId and A.Req_RefNo=D.Req_RefNo                     
		 /*join risk.dbo.Vw_RMS_Client_Vertical c  */
		 join risk.dbo.vw_rms_client_details_NCMS_Client c /*vw_rms_client_details*/ with (nolock) 
		 on a.Party_Code=c.client
		 --left join   
		 --risk.dbo.v_rtgs_client e with(nolock) on a.Party_Code=e.fld_party_code and d.Req_payBankId=e.fld_bank_acno
 
		  insert into AngelBSECM.MKTAPI.dbo.tbl_post_data                    
		 /* insert into NCMS_tbl_post_data   */                    
		 (VOUCHERTYPE,SNO,VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,NARRATION,BANKCODE,MARGINCODE,BANKNAME,BRANCHNAME,BRANCHCODE,DDNO,CHEQUEMODE,                      
		 CHEQUEDATE,CHEQUENAME,CLEAR_MODE,TPACCOUNTNUMBER,EXCHANGE,SEGMENT,MKCK_FLAG,Return_fld4,Return_fld5,Rowstate,Return_fld2)                                        
		 select                                     
		 3 as VOUCHERTYPE,                      
		 ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SNo],                      
		 convert(varchar(11),processDatetime) as VDATE,                      
		 convert(varchar(11),processDatetime) as EDATE,                      
		 a.Party_Code as CLTCODE,                      
		 0 as CREDITAMT,                      
		 SegApprovedAmt as DEBITAMT,                      
		 --b.NARRATION as NARRATION,            
		 'Amt Transfer A/C xxxxx'+right(d.acno,4)+' '+f.bank_name as NARRATION,                       
		 BO_BankCode as BANKCODE,                      
		 '' as MARGINCODE,                      
		 BO_BankName as BANKNAME,                      
		 '' as BRANCHNAME,                      
		 'HO' as BRANCHCODE,                      
		 poid+4000000 as DDNO,          
		 /*VerifierId as DDNO, */
		 /* convert(varchar(10),VerifierID)+convert(varchar(10),RequestID) as DDNO, */          
		 'A' as CHEQUEMODE,                      
		 convert(varchar(11),processDatetime) as CHEQUEDATE,                      
		 party_name as CHEQUENAME,                      
		 'L' as CLEAR_MODE,                      
		 d.acno as TPACCOUNTNUMBER,                      
		 BO_exchange as EXCHANGE,                      
		 BO_segment as SEGMENT,                      
		 1 as MKCK_FLAG,                      
		 VerifierID as Return_fld4,                      
		 'NCMS_PO' as Return_fld5,                      
		 0 as Rowstate,        
		 left(a.Req_RefNo,20) as Return_fld2                       
		 from                       
		  (select * from NCMS_SegPayoutAppAmt where BANK_gen=3 and BOFF_gen=0 and SegApprovedAmt > 0 and ODIN_gen=0) a join NCMS_HDFCbankDetails_for_HDFCAcc b                      
		 on a.Segment=b.Segment                      
		 join NCMS_B2B_PO_Request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                     
		 left outer join NCMS_ClientBankDetails_all d on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                   
		 and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1                                  
		/* left outer join  risk.dbo.Vw_RMS_Client_Vertical e                                  */
		left outer join  risk.dbo.vw_rms_client_details_NCMS_Client e  /*vw_rms_client_details*/with (nolock) 
		 on a.Party_Code=e.client 
		  left join   
		 risk.dbo.v_rtgs_client f  with (nolock)  on  a.Party_Code=f.fld_party_code  and  d.acno=f.fld_bank_acno

		 /* join risk.dbo.rtgs_master f with(nolock) on f.ifsc_code=d.bankname*/
		--where c.billamt>0 and c.billamt<1000  
End
else
begin
		  insert into AngelBSECM.MKTAPI.dbo.tbl_post_data                    
		 /* insert into NCMS_tbl_post_data   */                    
		 (VOUCHERTYPE,SNO,VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,NARRATION,BANKCODE,MARGINCODE,BANKNAME,BRANCHNAME,BRANCHCODE,DDNO,CHEQUEMODE,                      
		 CHEQUEDATE,CHEQUENAME,CLEAR_MODE,TPACCOUNTNUMBER,EXCHANGE,SEGMENT,MKCK_FLAG,Return_fld4,Return_fld5,Rowstate,Return_fld2)                                        
		 select                                     
		 3 as VOUCHERTYPE,                      
		 ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SNo],                      
		 convert(varchar(11),CAST(CAST(GETDATE()  AS DATE) AS DATETIME)) as VDATE,                                          
		 convert(varchar(11),CAST(CAST('2049-12-31' AS DATE) AS DATETIME)) as EDATE,                                                      
		 a.Party_Code as CLTCODE,                      
		 0 as CREDITAMT,                      
		 SegApprovedAmt as DEBITAMT,                      
		 --b.NARRATION as NARRATION,            
		 'Amount transferred to A/C xxxxx'+right(d.req_paybankid,4)+' '+d.bank_name as NARRATION,                                 
		 BO_BankCode as BANKCODE,                      
		 '' as MARGINCODE,                      
		 BO_BankName as BANKNAME,                      
		 '' as BRANCHNAME,                      
		 'HO' as BRANCHCODE,                      
		 poid+4000000 as DDNO,          
		 /*VerifierId as DDNO, */
		 /* convert(varchar(10),VerifierID)+convert(varchar(10),RequestID) as DDNO, */          
		 'A' as CHEQUEMODE,                      
		 convert(varchar(11),processDatetime) as CHEQUEDATE,                      
		 party_name as CHEQUENAME,                      
		 'L' as CLEAR_MODE,                      
		 Req_payBankId as TPACCOUNTNUMBER,                      
		 BO_exchange as EXCHANGE,                      
		 BO_segment as SEGMENT,                      
		 1 as MKCK_FLAG,                      
		 VerifierID as Return_fld4,                      
		 'NCMS_PO' as Return_fld5,                      
		 0 as Rowstate,        
		 left(a.Req_RefNo,20) as Return_fld2                       
		 from                       
		  (select * from NCMS_SegPayoutAppAmt where BANK_gen=3 and BOFF_gen=0 and SegApprovedAmt > 0 and ODIN_gen=0) a join NCMS_HDFCbankDetails_for_HDFCAcc b                      
		 on a.Segment=b.Segment                      
		 join (select POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity,bank_name from #porequest with (nolock) ) d                      
		 on d.POrequestID=a.RequestId and A.Req_RefNo=D.Req_RefNo                     
		 /*join risk.dbo.Vw_RMS_Client_Vertical c  */
		 join risk.dbo.vw_rms_client_details_NCMS_Client c /*vw_rms_client_details*/ with (nolock) 
		 on a.Party_Code=c.client	
end

select * into #vv from  AngelBSECM.MKTAPI.dbo.tbl_post_data  b with(nolock) where b.Return_fld5='NCMS_PO' and b.Vdate>=GETDATE()-3  and left(b.return_fld2,6)='NORMAL'

update a set BOFF_gen=1,BOFF_posted=b.Rowstate from NCMS_SegPayoutAppAmt a inner join             
(select distinct cltcode,RETURN_FLD4,Rowstate,debitAmt,return_fld2 from #vv
) b on             
 a.VerifierID=b.RETURN_FLD4                      
 and    a.party_code=b.cltcode                
 and a.SegApprovedAmt=b.debitAmt                 
 and a.Req_RefNo=b.return_fld2             
 where            
  a.SegApprovedAmt>0  and a.processdatetime>=CONVERT(varchar(11),getdate()) and a.bank_gen=3   and a.ODIN_gen=0  
  
  select * into #dxc from AngelBSECM.MKTAPI.dbo.tbl_post_data with(nolock) where Return_fld5='NCMS_PO' and Vdate>=GETDATE()-3   
   
update a set BOFF_gen=1,BOFF_posted=b.Rowstate from NCMS_SegPayoutAppAmt a inner join                     
 (                        
  select DDNO,Rowstate,RETURN_FLD4,cltcode,debitAmt,return_fld2 from #dxc
                       
 ) b on   
 a.VerifierID=b.RETURN_FLD4  
 and a.party_code=b.cltcode        
 and a.SegApprovedAmt=b.debitAmt         
 --and a.Req_RefNo=b.return_fld2 
 and a.bank_gen=3 and a.boff_gen=0  and a.ODIN_gen=0
                      
End try                                                   
BEGIN CATCH                                                      
                      
 insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                           
 select GETDATE(),'NCMS_BOapiPush',ERROR_LINE(),ERROR_MESSAGE()                                                            
                      
 DECLARE @ErrorMessage NVARCHAR(4000);                                                        
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                        
 RAISERROR (@ErrorMessage , 16, 1);                           
                           
End catch                                         
                                              
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_BOapiPush_ICICI
-- --------------------------------------------------
CREATE Proc [dbo].[NCMS_BOapiPush_ICICI]                                          
as                                          
Set nocount on                                                                  
SET XACT_ABORT ON                                                                     
BEGIN TRY                                             
                      
--Exec NCMS_BOapiPush_HDFCAccount  /*Commented on 14 FEb 2023 as per JIRA ticket - ORE-1975*/                    
                    
select * into #zz from AngelBSECM.MKTAPI.dbo.tbl_post_data with(nolock) where Return_fld5='NCMS_PO' and Vdate>=GETDATE()-3                    
                                          
 update NCMS_SegPayoutAppAmt set BOFF_gen=1,BOFF_posted=Rowstate from                                          
 (                                          
  select DDNO,Rowstate,RETURN_FLD4,cltcode,debitAmt,return_fld2  from  #zz                                        
 ) b where NCMS_SegPayoutAppAmt.VerifierID=b.RETURN_FLD4                           
 and NCMS_SegPayoutAppAmt.party_code=b.cltcode                          
 and NCMS_SegPayoutAppAmt.SegApprovedAmt=b.debitAmt  and  NCMS_SegPayoutAppAmt.ODIN_gen=0                        
 --and NCMS_SegPayoutAppAmt.Req_RefNo=b.return_fld2                            
                          
 /* for YES BANK ONLY */                      
                     
  select POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity into #request from NCMS_PO_Request with (nolock) group by                     
 POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity                     
                    
 select a.*,e.bank_name into #porequest from #request a left join risk.dbo.v_rtgs_client e with(nolock) on                     
 a.Party_Code = e.fld_party_code and ltrim(rtrim(a.Req_payBankId))=ltrim(rtrim( e.fld_bank_acno ))                    
                    
 select distinct a.POid,a.RequestID,a.VerifierID,a.Req_RefNo,a.Party_Code,a.SegApprovedAmt,a.ProcessDateTime,                    
d.req_paybankid,d.bank_name,BO_BankCode,BO_BankName,party_name,BO_exchange,BO_segment                    
into #NCMS_SegPayoutAppAmt from                    
 (select RequestId,VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,'99'+CONVERT(varchar(15), poid+4000000) as poid,ProcessDateTime                    
 from NCMS_SegPayoutAppAmt with(nolock) where BANK_gen=1 and BOFF_gen=0 and SegApprovedAmt > 0 and ODIN_gen=0) a join ncms_Entity_ICICI b                                          
 on a.Segment=b.Segment                                          
 join (select POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity,bank_name from #porequest with (nolock)) d                                          
 on d.POrequestID=a.RequestId and A.Req_RefNo=D.Req_RefNo                                         
 /*join risk.dbo.Vw_RMS_Client_Vertical c  */                    
 join risk.dbo.vw_rms_client_details_NCMS_Client  c /*vw_rms_client_details*/ with (nolock)                     
 on a.Party_Code=c.client                    
 --left join                       
 --risk.dbo.v_rtgs_client e with(nolock) on  a.Party_Code = e.fld_party_code and d.Req_payBankId=e.fld_bank_acno                    
                     
 if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)                    
 begin                    
 insert into AngelBSECM.MKTAPI.dbo.tbl_post_data                                        
 /* insert into NCMS_tbl_post_data   */                                        
 (VOUCHERTYPE,SNO,VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,NARRATION,BANKCODE,MARGINCODE,BANKNAME,BRANCHNAME,BRANCHCODE,DDNO,CHEQUEMODE,                                          
 CHEQUEDATE,CHEQUENAME,CLEAR_MODE,TPACCOUNTNUMBER,EXCHANGE,SEGMENT,MKCK_FLAG,Return_fld4,Return_fld5,Rowstate,Return_fld2)                                                            
 select                                                         
 3 as VOUCHERTYPE,                                          
 ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SNo],                                         
 convert(varchar(11),processDatetime) as VDATE,                                
 convert(varchar(11),processDatetime) as EDATE,                     
 party_Code as CLTCODE,                                          
 0 as CREDITAMT,                              
 SegApprovedAmt as DEBITAMT,                                          
 /*b.NARRATION as NARRATION,*/                                          
'Amount transferred to A/C xxxxx'+right(req_paybankid,4)+' '+bank_name as NARRATION,                                           
 BO_BankCode as BANKCODE,                                          
 '' as MARGINCODE,                                          
 BO_BankName as BANKNAME,                                          
 '' as BRANCHNAME,                                       
 'HO' as BRANCHCODE,                                          
 /*poid+4000000*/ poid as DDNO,                              
 /*VerifierId as DDNO, */                    
 /* convert(varchar(10),VerifierID)+convert(varchar(10),RequestID) as DDNO, */                              
 'A' as CHEQUEMODE,                                          
 convert(varchar(11),processDatetime) as CHEQUEDATE,                                          
 party_name as CHEQUENAME,                                          
 'L' as CLEAR_MODE,                                          
 Req_payBankId as TPACCOUNTNUMBER,                                          
 BO_exchange as EXCHANGE,                                          
 BO_segment as SEGMENT,                                          
 1 as MKCK_FLAG,                                          
 VerifierID as Return_fld4,                                          
 'NCMS_PO' as Return_fld5,                                          
 0 as Rowstate,                            
 left(Req_RefNo,20) as Return_fld2                                           
 from #NCMS_SegPayoutAppAmt                                          
 /*(select * from NCMS_SegPayoutAppAmt where BANK_gen=1 and BOFF_gen=0 and SegApprovedAmt > 0) a join ncms_Entity_ICICI b                                          
 on a.Segment=b.Segment                                          
 join (select POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity from NCMS_PO_Request with (nolock) group by POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity ) d                                          
 on d.POrequestID=a.RequestId and A.Req_RefNo=D.Req_RefNo                                         
 /*join risk.dbo.Vw_RMS_Client_Vertical c  */                    
 join risk.dbo.vw_rms_client_details_NCMS_Client  c /*vw_rms_client_details*/ with (nolock)                     
 on a.Party_Code=c.client                    
 left join                       
 risk.dbo.v_rtgs_client e with(nolock) on  a.Party_Code = e.fld_party_code and d.Req_payBankId=e.fld_bank_acno*/                    
                       
   /*left outer join NCMS_ClientBankDetails_all e on d.Party_Code=e.Cltcode and replace(d.Entity,'AllSegment','AllSegment')=e.domain  and d.Req_payBankId=e.acno                                                                            
 join risk.dbo.rtgs_master f with(nolock) on f.ifsc_code=e.bankname                    
*/                    
 /*Start--------------------------------Added on 16 Feb 2017 by Neha Naiwar for Bill2Bill-------------------------------------------*/                        
 insert into AngelBSECM.MKTAPI.dbo.tbl_post_data                                        
 /* insert into NCMS_tbl_post_data   */                                        
 (VOUCHERTYPE,SNO,VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,NARRATION,BANKCODE,MARGINCODE,BANKNAME,BRANCHNAME,BRANCHCODE,DDNO,CHEQUEMODE,                                          
 CHEQUEDATE,CHEQUENAME,CLEAR_MODE,TPACCOUNTNUMBER,EXCHANGE,SEGMENT,MKCK_FLAG,Return_fld4,Return_fld5,Rowstate,Return_fld2)                                                            
  select             
 3 as VOUCHERTYPE,                                          
 ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SNo],                                          
 convert(varchar(11),processDatetime) as VDATE,                                          
 convert(varchar(11),processDatetime) as EDATE,                                          
 a.party_Code as CLTCODE,                                          
 0 as CREDITAMT,                                          
 SegApprovedAmt as DEBITAMT,                                          
 /*b.NARRATION as NARRATION,                */                    
 'Amt Transfer A/C xxxxx'+right(d.acno,4)+' '+f.bank_name as NARRATION,                                           
  /* 'Amt Transfer A/C xxxxx'+right(d.acno,4)+' BANK NAME '+f.bank_name as NARRATION,                       */                    
 BO_BankCode as BANKCODE,                                          
 '' as MARGINCODE,                                          
 BO_BankName as BANKNAME,              
 '' as BRANCHNAME,                                          
 'HO' as BRANCHCODE,                                          
 poid  as DDNO,                              
 /*VerifierId as DDNO, */                    
 /* convert(varchar(10),VerifierID)+convert(varchar(10),RequestID) as DDNO, */                              
 'A' as CHEQUEMODE,                                          
 convert(varchar(11),processDatetime) as CHEQUEDATE,                                          
 party_name as CHEQUENAME,                             'L' as CLEAR_MODE,                                          
 d.acno as TPACCOUNTNUMBER,                                          
 BO_exchange as EXCHANGE,                                          
 BO_segment as SEGMENT,                                          
 1 as MKCK_FLAG,                        
 VerifierID as Return_fld4,                                          
 'NCMS_PO' as Return_fld5,                                          
 0 as Rowstate,                            
 left(a.Req_RefNo,20) as Return_fld2                                           
 from                                           
 (select RequestId,VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,'99'+CONVERT(varchar(15), poid+4000000) as poid,ProcessDateTime                    
 ,entity from NCMS_SegPayoutAppAmt where BANK_gen=1 and BOFF_gen=0 and SegApprovedAmt > 0) a join ncms_Entity_ICICI b                                          
 on a.Segment=b.Segment                                          
 join NCMS_B2B_PO_Request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                         
 left outer join cms.dbo.NCMS_ClientBankDetails_all d on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                       
 and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1                                                      
/* left outer join  risk.dbo.Vw_RMS_Client_Vertical e                                  */                    
left outer join  risk.dbo.vw_rms_client_details_NCMS_Client e  /*vw_rms_client_details*/with (nolock)                     
 on a.Party_Code=e.client                     
  left join                       
 risk.dbo.v_rtgs_client f  with (nolock)  on  a.Party_Code=f.fld_party_code and d.acno=f.fld_bank_acno                    
                    
 /* join risk.dbo.rtgs_master f with(nolock) on f.ifsc_code=d.bankname*/                    
where c.billamt>0                                       
 /*eND-------------------------------------------------------------------------------------------*/                    
end                          
else                    
begin                    
 insert into AngelBSECM.MKTAPI.dbo.tbl_post_data                                        
  (VOUCHERTYPE,SNO,VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,NARRATION,BANKCODE,MARGINCODE,BANKNAME,BRANCHNAME,BRANCHCODE,DDNO,CHEQUEMODE,                                          
  CHEQUEDATE,CHEQUENAME,CLEAR_MODE,TPACCOUNTNUMBER,EXCHANGE,SEGMENT,MKCK_FLAG,Return_fld4,Return_fld5,Rowstate,Return_fld2)                                                            
  select                                                         
  3 as VOUCHERTYPE,                                          
  ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SNo],                                          
  convert(varchar(11),CAST(CAST(GETDATE()  AS DATE) AS DATETIME)) as VDATE,                                                              
  convert(varchar(11),CAST(CAST('2049-12-31' AS DATE) AS DATETIME)) as EDATE,                                                       
  party_Code as CLTCODE,                                          
  0 as CREDITAMT,                           
  SegApprovedAmt as DEBITAMT,                                          
  'Amount transferred to A/C xxxxx'+right(req_paybankid,4)+' '+bank_name as NARRATION,                                           
  BO_BankCode as BANKCODE,                                          
  '' as MARGINCODE,                    
  BO_BankName as BANKNAME,                                          
  '' as BRANCHNAME,                                          
  'HO' as BRANCHCODE,                                          
  poid as DDNO,                                     
  'A' as CHEQUEMODE,                                          
  convert(varchar(11),processDatetime) as CHEQUEDATE,                                          
  party_name as CHEQUENAME,                                          
  'L' as CLEAR_MODE,                                          
  Req_payBankId as TPACCOUNTNUMBER,                                          
  BO_exchange as EXCHANGE,                                          
  BO_segment as SEGMENT,                               
  1 as MKCK_FLAG,                                          
  VerifierID as Return_fld4,                                          
  'NCMS_PO' as Return_fld5,                                          
  0 as Rowstate,                            
  left(Req_RefNo,20) as Return_fld2                                           
  from #NCMS_SegPayoutAppAmt                      
end                    
                    
select * into #tt from AngelBSECM.MKTAPI.dbo.tbl_post_data with(nolock) where Return_fld5='NCMS_PO' and Vdate>=GETDATE()-3                     
                    
 update NCMS_SegPayoutAppAmt set BOFF_gen=1,BOFF_posted=Rowstate from                                          
 (                                          
  select DDNO,Rowstate,RETURN_FLD4,cltcode,debitAmt,return_fld2   from #tt                    
                   
 ) b where                     
 NCMS_SegPayoutAppAmt.VerifierID=b.RETURN_FLD4                    
 and NCMS_SegPayoutAppAmt.party_code=b.cltcode                          
 and NCMS_SegPayoutAppAmt.SegApprovedAmt=b.debitAmt  and  NCMS_SegPayoutAppAmt.ODIN_gen=0                       
 --and NCMS_SegPayoutAppAmt.Req_RefNo=b.return_fld2                            
                    
 select * into #oo from  AngelBSECM.MKTAPI.dbo.tbl_post_data where Return_fld5='NCMS_PO' and Vdate>=GETDATE()-3                    
                         
 UPDATE a                            
 SET BOFF_gen=1,BOFF_posted=Rowstate                        
 FROM NCMS_SegPayoutAppAmt a                            
 JOIN ( select DDNO,Rowstate,RETURN_FLD4,cltcode,debitAmt,return_fld2   from #oo                                  
 )b on  a.VerifierID=b.RETURN_FLD4                    
 and a.party_code=b.cltcode                          
 and a.SegApprovedAmt=b.debitAmt AND    a.SegApprovedAmt>0  and a.processdatetime>=CONVERT(varchar(11),getdate())                        
   and a.Req_RefNo like 'NORMAL%' and a.boff_gen=0      and  a.ODIN_gen=0               
                                          
End try                                                                       
BEGIN CATCH                                                    
                                          
 insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                               
 select GETDATE(),'NCMS_BOapiPush',ERROR_LINE(),ERROR_MESSAGE()                                                                                
                                          
 DECLARE @ErrorMessage NVARCHAR(4000);                                                                            
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                            
 RAISERROR (@ErrorMessage , 16, 1);                                               
                                               
End catch                                             
                                                                  
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_BODcleanup
-- --------------------------------------------------
create proc [dbo].[NCMS_BODcleanup]                      
as                      
                      
set nocount on                          
BEGIN TRY                      
              
declare @mdt as datetime  

select @mdt=MIN(start_date) from                     
(              
select top 2 * from risk.dbo.sett_mst where Start_date<=GETDATE() and Sett_Type='D'              
order by start_Date desc              
) x               
  
/* SELECT @mdt=STARTDATE FROM NCMS_BATCH_PROCESS WHERE sRNO=1    */
/* SELECT @mdt=convert(varchar(11),STARTDATE) FROM NCMS_BATCH_PROCESS WHERE sRNO=1 */ 

/*Code added on 30th Jun to identify security sold clients*/
select * into #codes_po from NCMS_PO_Request where  remarks='T'/*'T+2'*/ and PO_Statusid in (0,7) and req_paymode='NEFT'  
  
  
update NCMS_PO_Request set PO_Statusid=6,remarks='(BOD-EXPIRED)'+ltrim(rtrim(isnull(Convert(varchar(50),remarks),'')))   
where POdt_request < @mdt and PO_Statusid in (0,7) and req_paymode='NEFT'  
/*Code added on 30th Jun to identify security sold clients*/
and POrequestID not in (select POrequestID from #codes_po)

/*Added on 10 Oct 2017 by neha*/
declare @mdat as datetime  

select @mdat=MIN(start_date) from                     
(              
select top 3 * from risk.dbo.sett_mst where Start_date<=GETDATE() and Sett_Type='D'              
order by start_Date desc              
) x  

update a set PO_Statusid=6,remarks='(Settlement-EXPIRED)'+ltrim(rtrim(isnull(Convert(varchar(50),a.remarks),''))) 
from NCMS_PO_Request a inner join 
#codes_po b on a.POrequestID=b.POrequestID  
and a.PO_Statusid in (0,7) and a.req_paymode='NEFT' 
/* inner join   
(select Start_date,Sec_Payout from risk.dbo.sett_mst b with (nolock)
where  Sett_Type='D')c on Convert(varchar(11),c.start_date,106)=Convert(varchar(11),a.POdt_request,106)*/
and a.POdt_request<@mdat 
/********************************/

/*Code added on 30th Jun to expiry based on settlement date*/
/*comented on 10 Oct 2017
update a set PO_Statusid=6,remarks='(Settlement-EXPIRED)'+ltrim(rtrim(isnull(Convert(varchar(50),a.remarks),''))) 
 from NCMS_PO_Request a inner join 
#codes_po b on a.POrequestID=b.POrequestID  
and a.PO_Statusid in (0,7) and a.req_paymode='NEFT'  inner join   
(select Start_date,Sec_Payout from risk.dbo.sett_mst b with (nolock)
where  Sett_Type='D')c on Convert(varchar(11),c.start_date,106)=Convert(varchar(11),a.POdt_request,106)
and Sec_Payout<getdate() 
*/
/********************************************************************************************************/

  
/*commented on 11 Feb 2016 for carry forward*/  
/*  
update NCMS_PO_Request set PO_Statusid=6,remarks='(EXPIRED)'+ltrim(rtrim(isnull(remarks,'')))   
where POdt_request >= @mdt and PO_Statusid in (0,7) and req_paymode='NEFT'           */  
/*and right(req_user,2) = '-S' */    
    
/* PAyout Rejected SMS */    
insert into sms.dbo.sms (to_no,message,date,time,flag,ampm,purpose)                            
select  No, sms_msg, sms_dt ,sms_time, flag,ampm,purpose from         
(        
select c.mobile_pager as No, a.party_code                             
,/*'Dear Client ('+CONVERT(VARCHAR,a.party_code)+'), payout request for Rs.'+convert(varchar,PO_Request)+       
' has been rejected due to open position margin requirement or inadequate balance in your account.'*/
'Dear Client '+ltrim(rtrim(CONVERT(VARCHAR(10),a.party_code)))+', Withdrawal request for Rs.'+ convert(varchar,PO_Request)+' has been rejected due 
 to margin requirement and/or inadequate balance in your account. More on Margin Requirement: https://bit.ly/3D9pBxL Regards - Angel One '  as sms_msg ,         
convert(varchar(10), getdate(), 103) as sms_dt                  
,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' + ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate())))))  as sms_time                           
,'P' as flag                               
, case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end  as ampm                             
,'Payout Rejection'   as Purpose         
from (select * from NCMS_PO_Request where PO_Statusid=6 and remarks like '(BOD-EXPIRED)%' and Req_User<> 'Coperate Action') a INNER JOIN
 /*risk.dbo.client_Details c with(nolock) *//**************added on 25 Jan 2021 for removing dependency from client master*/
 NCMS_ClientDetails   c with(nolock)                            
on a.party_code=c.party_code         
) x        
                 
insert into ncms_po_request_hist(SegMinID,POrequestID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,remarks,requestType,ReleaseId,ParentChildID
)                       
select SegMinID,POrequestID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,remarks,requestType  
,ReleaseId,ParentChildID
from ncms_po_request with (nolock) /* where POveriID <> 0*/    


 insert into NCMS_po_request_2MonthData(SegMinID,POrequestID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,remarks,requestType,ReleaseId,ParentChildID)
 select SegMinID,POrequestID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,remarks,requestType,ReleaseId,ParentChildID
 from ncms_po_request with(nolock) where  po_statusid in (2,4,6,3,8) 

 delete from   NCMS_po_request_2MonthData WHERE DATEADD(month, 2, req_datetime) < getdate() 
                  
delete from NCMS_PO_Request where PO_Statusid not in (0,7)      
       
delete from   SEBI_Payout_2MonthData WHERE DATEADD(month, 2, req_datetime) < getdate()
    
delete from   NCMS_UTR_ALLBank WHERE DATEADD(month, 2, Fetchdate) < getdate()       
           
 /*                      
 insert into NCMS_SegVeriData_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                      
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                      
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                      
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                      
 from NCMS_SegVeriData with (nolock)                      
 */                  
 truncate table NCMS_SegVeriData                  
                      
 insert into NCMS_ODINTEMPFILE_hist(POid,RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt)                      
 select POid,RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt from NCMS_ODINTEMPFILE                      
                   
 truncate table NCMS_ODINTEMPFILE                  
                      
 truncate table NCMS_oldCMSdatamigration          
        
        
 /* bILL 2 bILL tABLE ARCHIVE */        
         
 SET IDENTITY_INSERT NCMS_B2B_PO_Request_hist on        
        
 INSERT INTO NCMS_B2B_PO_Request_hist         
 (id,ProcessDate,Entity,Segment,Party_code,Flag,BillAmt,UnsettledCrBill,UnrecoAmt,SttNo,SettType,OtherDebit,NetPayable,PO_Request,Req_date,Req_IP,Req_By,Req_RefNo,ApprovedAmt,AppBy,AppOn,AppIP,Narration,UserAppStatus,AdminAppStatus)        
 SELECT id,ProcessDate,Entity,Segment,Party_code,Flag,BillAmt,UnsettledCrBill,UnrecoAmt,SttNo,SettType,OtherDebit,NetPayable,PO_Request,Req_date,Req_IP,Req_By,Req_RefNo,ApprovedAmt,AppBy,AppOn,AppIP,Narration,UserAppStatus,AdminAppStatus         
 FROM NCMS_B2B_PO_Request WITH (NOLOCK)        
        
 SET IDENTITY_INSERT NCMS_B2B_PO_Request_hist oFF  
 
 /*Flexi On Released Amount History*/      
  insert into  NCMS_Flexi_On_POAmt_hist(RequestID,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,ProcessDateTime,Batchid,Net_payable,PO_Request,Req_datetime,Req_IP,Req_User,Req_Paymode,remarks,requestType,UpdatedOn)               
  select RequestID,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,ProcessDateTime,Batchid,Net_payable,PO_Request,Req_datetime,Req_IP,Req_User,Req_Paymode,remarks,requestType,getdate()
  from NCMS_Flexi_On_POAmt
  
  truncate table NCMS_Flexi_On_POAmt
 /**/   
    
 INSERT INTO CMS.DBO.NCMS_LD_Hist (        
   Client_Code,Client_Name,Branch_Code,Final_Margin,Utilization,Adhoc_DrCr,Ledger_Balance,Stock_After_Haircut,Stock_Before_Haircut,        
   Net_Margin,BSE_MTM,BSE_Var,NSE_MTM,NSE_Var,NSEF_Span,NSEF_MVM,NSEF_FUT_MTM,NSEF_OPT_MTM,NSEF_OPT_Premium,NSEF_MTM,MCX_Span,MCX_MVM,        
   MCX_MTM,NCDX_Span,NCDX_MVM,NCDX_MTM,NSEC_Span,NSEC_MVM,NSEC_FUT_MTM,NSEC_OPT_MTM,NSEC_OPT_Premium,NSEC_MTM,MCXC_Span,MCXC_MVM,        
   MCXC_FUT_MTM,MCXC_OPT_MTM,MCXC_OPT_Premium,MCXC_MTM,Log_Mtm,FetchDateTime)        
   SELECT         
   Client_Code,Client_Name,Branch_Code,Final_Margin,Utilization,Adhoc_DrCr,Ledger_Balance,Stock_After_Haircut,Stock_Before_Haircut,        
   Net_Margin,BSE_MTM,BSE_Var,NSE_MTM,NSE_Var,NSEF_Span,NSEF_MVM,NSEF_FUT_MTM,NSEF_OPT_MTM,NSEF_OPT_Premium,NSEF_MTM,MCX_Span,MCX_MVM,        
   MCX_MTM,NCDX_Span,NCDX_MVM,NCDX_MTM,NSEC_Span,NSEC_MVM,NSEC_FUT_MTM,NSEC_OPT_MTM,NSEC_OPT_Premium,NSEC_MTM,MCXC_Span,MCXC_MVM,        
   MCXC_FUT_MTM,MCXC_OPT_MTM,MCXC_OPT_Premium,MCXC_MTM,Log_Mtm,GETDATE()                                
   FROM CMS.DBO.NCMS_LD                                  
  
  truncate table NCMS_LD
  
  
insert into NCMS_BrokerageCharges_hist(Sauda_Date,PARTY_CODE,ExposureAndNet,Brokerage,Gst,STT,TurnoverCharges,SebiFees,StampDuty,UpdatedOn,segment)    
select Sauda_Date,PARTY_CODE,ExposureAndNet,Brokerage,Gst,STT,TurnoverCharges,SebiFees,StampDuty,GETDATE(),segment   
from NCMS_BrokerageCharges With(Nolock)

truncate table NCMS_BrokerageCharges    

insert into NCMS_PeackMargin_hist
select [client code],total,GETDATE() from NCMS_PeackMargin

truncate table NCMS_PeackMargin

insert into NCMS_BANKfile_DetailData_hist
select *,GETDATE() from NCMS_BANKfile_DetailData

truncate table NCMS_BANKfile_DetailData

truncate table SEBI_PayoutFinal

     
 insert into NCMS_Adhoc_final_hist  
 select *,GETDATE() from NCMS_Adhoc_final  
  
 truncate table NCMS_Adhoc_final 

 
insert into NCMS_RealPayout_Formorning_hist  
select *,getdate() from NCMS_RealPayout_Formorning  
  
truncate table NCMS_RealPayout_Formorning  

truncate table NCMS_batchId
insert into NCMS_batchId
select '100'
                 
End try                                           
                                          
BEGIN CATCH                                              
                                          
   insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                    
   select GETDATE(),'NCMS_BODcleanup',ERROR_LINE(),ERROR_MESSAGE()                                                    
                                          
End catch                                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_BODcleanup_07July2023
-- --------------------------------------------------
create proc [dbo].[NCMS_BODcleanup_07July2023]                        
as                        
                        
set nocount on                            
BEGIN TRY                        
                
declare @mdt as datetime    
  
select @mdt=MIN(start_date) from                       
(                
select top 2 * from risk.dbo.sett_mst where Start_date<=GETDATE() and Sett_Type='D'                
order by start_Date desc                
) x                 
    
/* SELECT @mdt=STARTDATE FROM NCMS_BATCH_PROCESS WHERE sRNO=1    */  
/* SELECT @mdt=convert(varchar(11),STARTDATE) FROM NCMS_BATCH_PROCESS WHERE sRNO=1 */   
  
/*Code added on 30th Jun to identify security sold clients*/  
select * into #codes_po from NCMS_PO_Request where  remarks='T'/*'T+2'*/ and PO_Statusid in (0,7) and req_paymode='NEFT'    
    
    
update NCMS_PO_Request set PO_Statusid=6,remarks='(BOD-EXPIRED)'+ltrim(rtrim(isnull(Convert(varchar(50),remarks),'')))     
where POdt_request < @mdt and PO_Statusid in (0,7) and req_paymode='NEFT'    
/*Code added on 30th Jun to identify security sold clients*/  
and POrequestID not in (select POrequestID from #codes_po)  
  
/*Added on 10 Oct 2017 by neha*/  
declare @mdat as datetime    
  
select @mdat=MIN(start_date) from                       
(                
select top 3 * from risk.dbo.sett_mst where Start_date<=GETDATE() and Sett_Type='D'                
order by start_Date desc                
) x    
  
update a set PO_Statusid=6,remarks='(Settlement-EXPIRED)'+ltrim(rtrim(isnull(Convert(varchar(50),a.remarks),'')))   
from NCMS_PO_Request a inner join   
#codes_po b on a.POrequestID=b.POrequestID    
and a.PO_Statusid in (0,7) and a.req_paymode='NEFT'   
/* inner join     
(select Start_date,Sec_Payout from risk.dbo.sett_mst b with (nolock)  
where  Sett_Type='D')c on Convert(varchar(11),c.start_date,106)=Convert(varchar(11),a.POdt_request,106)*/  
and a.POdt_request<@mdat   
/********************************/  
  
/*Code added on 30th Jun to expiry based on settlement date*/  
/*comented on 10 Oct 2017  
update a set PO_Statusid=6,remarks='(Settlement-EXPIRED)'+ltrim(rtrim(isnull(Convert(varchar(50),a.remarks),'')))   
 from NCMS_PO_Request a inner join   
#codes_po b on a.POrequestID=b.POrequestID    
and a.PO_Statusid in (0,7) and a.req_paymode='NEFT'  inner join     
(select Start_date,Sec_Payout from risk.dbo.sett_mst b with (nolock)  
where  Sett_Type='D')c on Convert(varchar(11),c.start_date,106)=Convert(varchar(11),a.POdt_request,106)  
and Sec_Payout<getdate()   
*/  
/********************************************************************************************************/  
  
    
/*commented on 11 Feb 2016 for carry forward*/    
/*    
update NCMS_PO_Request set PO_Statusid=6,remarks='(EXPIRED)'+ltrim(rtrim(isnull(remarks,'')))     
where POdt_request >= @mdt and PO_Statusid in (0,7) and req_paymode='NEFT'           */    
/*and right(req_user,2) = '-S' */      
      
/* PAyout Rejected SMS */      
insert into sms.dbo.sms (to_no,message,date,time,flag,ampm,purpose)                              
select  No, sms_msg, sms_dt ,sms_time, flag,ampm,purpose from           
(          
select c.mobile_pager as No, a.party_code                               
,/*'Dear Client ('+CONVERT(VARCHAR,a.party_code)+'), payout request for Rs.'+convert(varchar,PO_Request)+         
' has been rejected due to open position margin requirement or inadequate balance in your account.'*/  
'Dear Client '+ltrim(rtrim(CONVERT(VARCHAR(10),a.party_code)))+', Withdrawal request for Rs.'+ convert(varchar,PO_Request)+' has been rejected due   
 to margin requirement and/or inadequate balance in your account. More on Margin Requirement: https://bit.ly/3D9pBxL '  as sms_msg ,           
convert(varchar(10), getdate(), 103) as sms_dt                    
,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' + ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate())))))  as sms_time                             
,'P' as flag   
, case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end  as ampm                               
,'Payout Marking'   as Purpose           
from (select * from NCMS_PO_Request where PO_Statusid=6 and remarks like '(BOD-EXPIRED)%' and Req_User<> 'Coperate Action') a INNER JOIN  
 /*risk.dbo.client_Details c with(nolock) *//**************added on 25 Jan 2021 for removing dependency from client master*/  
 NCMS_ClientDetails   c with(nolock)                              
on a.party_code=c.party_code           
) x          
                   
insert into ncms_po_request_hist(SegMinID,POrequestID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,remarks,requestType,ReleaseId,ParentChildID  
)                         
select SegMinID,POrequestID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,remarks,requestType    
,ReleaseId,ParentChildID  
from ncms_po_request with (nolock) /* where POveriID <> 0*/      
  
  
 insert into NCMS_po_request_2MonthData(SegMinID,POrequestID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,remarks,requestType,ReleaseId,ParentChildID)  
 select SegMinID,POrequestID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,remarks,requestType,ReleaseId,ParentChildID  
 from ncms_po_request with(nolock) where  po_statusid in (2,4,6,3,8)   
  
 delete from   NCMS_po_request_2MonthData WHERE DATEADD(month, 2, req_datetime) < getdate()   
                    
delete from NCMS_PO_Request where PO_Statusid not in (0,7)        
         
delete from   SEBI_Payout_2MonthData WHERE DATEADD(month, 2, req_datetime) < getdate()  
      
delete from   NCMS_UTR_ALLBank WHERE DATEADD(month, 2, Fetchdate) < getdate()         
             
 /*                        
 insert into NCMS_SegVeriData_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                        
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                        
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                        
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                        
 from NCMS_SegVeriData with (nolock)                        
 */                    
 truncate table NCMS_SegVeriData                    
                        
 insert into NCMS_ODINTEMPFILE_hist(POid,RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt)                        
 select POid,RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt from NCMS_ODINTEMPFILE                        
                     
 truncate table NCMS_ODINTEMPFILE                    
                        
 truncate table NCMS_oldCMSdatamigration            
          
          
 /* bILL 2 bILL tABLE ARCHIVE */          
           
 SET IDENTITY_INSERT NCMS_B2B_PO_Request_hist on          
          
 INSERT INTO NCMS_B2B_PO_Request_hist           
 (id,ProcessDate,Entity,Segment,Party_code,Flag,BillAmt,UnsettledCrBill,UnrecoAmt,SttNo,SettType,OtherDebit,NetPayable,PO_Request,Req_date,Req_IP,Req_By,Req_RefNo,ApprovedAmt,AppBy,AppOn,AppIP,Narration,UserAppStatus,AdminAppStatus)          
 SELECT id,ProcessDate,Entity,Segment,Party_code,Flag,BillAmt,UnsettledCrBill,UnrecoAmt,SttNo,SettType,OtherDebit,NetPayable,PO_Request,Req_date,Req_IP,Req_By,Req_RefNo,ApprovedAmt,AppBy,AppOn,AppIP,Narration,UserAppStatus,AdminAppStatus           
 FROM NCMS_B2B_PO_Request WITH (NOLOCK)          
          
 SET IDENTITY_INSERT NCMS_B2B_PO_Request_hist oFF    
   
 /*Flexi On Released Amount History*/        
  insert into  NCMS_Flexi_On_POAmt_hist(RequestID,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,ProcessDateTime,Batchid,Net_payable,PO_Request,Req_datetime,Req_IP,Req_User,Req_Paymode,remarks,requestType,UpdatedOn)                 
  select RequestID,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,ProcessDateTime,Batchid,Net_payable,PO_Request,Req_datetime,Req_IP,Req_User,Req_Paymode,remarks,requestType,getdate()  
  from NCMS_Flexi_On_POAmt  
    
  truncate table NCMS_Flexi_On_POAmt  
 /**/     
      
 INSERT INTO CMS.DBO.NCMS_LD_Hist (          
   Client_Code,Client_Name,Branch_Code,Final_Margin,Utilization,Adhoc_DrCr,Ledger_Balance,Stock_After_Haircut,Stock_Before_Haircut,          
   Net_Margin,BSE_MTM,BSE_Var,NSE_MTM,NSE_Var,NSEF_Span,NSEF_MVM,NSEF_FUT_MTM,NSEF_OPT_MTM,NSEF_OPT_Premium,NSEF_MTM,MCX_Span,MCX_MVM,          
   MCX_MTM,NCDX_Span,NCDX_MVM,NCDX_MTM,NSEC_Span,NSEC_MVM,NSEC_FUT_MTM,NSEC_OPT_MTM,NSEC_OPT_Premium,NSEC_MTM,MCXC_Span,MCXC_MVM,          
   MCXC_FUT_MTM,MCXC_OPT_MTM,MCXC_OPT_Premium,MCXC_MTM,Log_Mtm,FetchDateTime)          
   SELECT           
   Client_Code,Client_Name,Branch_Code,Final_Margin,Utilization,Adhoc_DrCr,Ledger_Balance,Stock_After_Haircut,Stock_Before_Haircut,          
   Net_Margin,BSE_MTM,BSE_Var,NSE_MTM,NSE_Var,NSEF_Span,NSEF_MVM,NSEF_FUT_MTM,NSEF_OPT_MTM,NSEF_OPT_Premium,NSEF_MTM,MCX_Span,MCX_MVM,          
   MCX_MTM,NCDX_Span,NCDX_MVM,NCDX_MTM,NSEC_Span,NSEC_MVM,NSEC_FUT_MTM,NSEC_OPT_MTM,NSEC_OPT_Premium,NSEC_MTM,MCXC_Span,MCXC_MVM,          
   MCXC_FUT_MTM,MCXC_OPT_MTM,MCXC_OPT_Premium,MCXC_MTM,Log_Mtm,GETDATE()                                  
   FROM CMS.DBO.NCMS_LD                                    
    
  truncate table NCMS_LD  
    
    
insert into NCMS_BrokerageCharges_hist(Sauda_Date,PARTY_CODE,ExposureAndNet,Brokerage,Gst,STT,TurnoverCharges,SebiFees,StampDuty,UpdatedOn,segment)      
select Sauda_Date,PARTY_CODE,ExposureAndNet,Brokerage,Gst,STT,TurnoverCharges,SebiFees,StampDuty,GETDATE(),segment     
from NCMS_BrokerageCharges With(Nolock)  
  
truncate table NCMS_BrokerageCharges      
  
insert into NCMS_PeackMargin_hist  
select [client code],total,GETDATE() from NCMS_PeackMargin  
  
truncate table NCMS_PeackMargin  
  
insert into NCMS_BANKfile_DetailData_hist  
select *,GETDATE() from NCMS_BANKfile_DetailData  
  
truncate table NCMS_BANKfile_DetailData  
  
truncate table SEBI_PayoutFinal  
  
       
 insert into NCMS_Adhoc_final_hist    
 select *,GETDATE() from NCMS_Adhoc_final    
    
 truncate table NCMS_Adhoc_final   
  
   
insert into NCMS_RealPayout_Formorning_hist    
select *,getdate() from NCMS_RealPayout_Formorning    
    
truncate table NCMS_RealPayout_Formorning    
  
truncate table NCMS_batchId  
insert into NCMS_batchId  
select '100'  
                   
End try                                             
                                            
BEGIN CATCH                                                
                                            
   insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                      
   select GETDATE(),'NCMS_BODcleanup',ERROR_LINE(),ERROR_MESSAGE()                                                      
                                            
End catch                                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_Calculation_30May2025
-- --------------------------------------------------

create PROCEDURE [dbo].[NCMS_Calculation_30May2025]  
WITH RECOMPILE                         
as                                              
                                              
Set nocount on                                              
SET XACT_ABORT ON                                                 
BEGIN TRY                                                      
                                              
 /* EQUITY */                               
 
 /*

 ** Moved in separate job steps

 /*Exec anand.inhouse.dbo.NCMS_POdet */
 Exec AngelBSECM.inhouse.dbo.NCMS_POdet_morning
 /*Exec anand1.inhouse.dbo.NCMS_POdet*/
  Exec AngelNseCM.inhouse.dbo.NCMS_POdet_morning                                              
 /*Exec angelfo.inhouse.dbo.NCMS_POdet  */
 Exec angelfo.inhouse.dbo.NCMS_POdet_Morning                                            
 /*Exec angelfo.inhouse_curfo.dbo.NCMS_POdet*/
 Exec angelfo.inhouse_curfo.dbo.NCMS_POdet_Morning                                                                                            
 /*Exec angelcommodity.inhouse_BSX.dbo.NCMS_POdet  */
 Exec angelcommodity.inhouse_BSX.dbo.NCMS_POdet_Morning  
 /*Exec angelcommodity.INHOUSE_MCDCS.dbo.NCMS_POdet */
 Exec angelcommodity.INHOUSE_MCDCS.dbo.NCMS_POdet_Morning                                                                                            
 Exec angelfo.inhouse.dbo.NCMS_POdet_NSEMFSS                                              
 Exec angelfo.inhouse.dbo.NCMS_POdet_BSEMFSS 
 /*Exec anand1.MTFTRADE.dbo.NCMS_POdet    */
  Exec AngelNseCM.MTFTRADE.dbo.NCMS_POdet_morning    

                                               
 /* COMMODITY */                                              
/* Exec angelcommodity.inhouse_NCDX.dbo.NCMS_POdet  */
 Exec angelcommodity.inhouse_NCDX.dbo.NCMS_POdet_Morning                                                                                        
 /*Exec angelcommodity.inhouse_MCDX.dbo.NCMS_POdet*/
 Exec angelcommodity.inhouse_MCDX.dbo.NCMS_POdet_Morning    
 
 */
                                               
 /* SHORTAGE */                                              
 --exec risk.dbo.get_shortage                                              
 --exec risk.dbo.Usp_Calc_ShrtVal                                              
 --exec cms.dbo.NCMS_Shortage                
 /* NBFC Process */                                              
 exec [ABVSCITRUS].inhouse.dbo.PROC_NBFC_PF_DATA                                              
 exec [ABVSCITRUS].inhouse.dbo.PR_NBFC_HOLD_DATA                                              
 exec [ABVSCITRUS].inhouse.dbo.NCMS_POdet  
                                         
 /*Fetch Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/
 truncate table NCMS_Intraday_loss
 
 insert into NCMS_Intraday_loss
 exec AngelNseCM.msajag.dbo.Intraday_loss
/****************/
                                               
 /* FETCH DATA */                                              
 select id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_Broker                                              
 into #NCMS_SegwiseCldata from NCMS_SegwiseCldata where 1=2                                              
 
  --CREATE CLUSTERED INDEX IDX_CLGRPSER ON #NCMS_SegwiseCldata(id ASC) 
  -- CREATE NONCLUSTERED INDEX IDX_CLGRPSER_Party ON #NCMS_SegwiseCldata(party_code ASC)                                    
  --  CREATE NONCLUSTERED INDEX IDX_CLGRPSER_Segment ON #NCMS_SegwiseCldata(Segment ASC)                                    
                                                
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','BSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                               
 from AngelBSECM.inhouse.dbo.NCMS_PO with(nolock)                                             
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */                                             
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','NSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                               
 from AngelNseCM.inhouse.dbo.NCMS_PO with(nolock)                                              
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */  
 
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','MTF',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr 
 /*0,0,0,0,0,0,0,0,0,0,0,0,0,0,0*/
 from AngelNseCM.MTFTRADE.dbo.NCMS_PO with(nolock)    
  
 insert into #NCMS_SegwiseCldata  
 (ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','NSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelfo.inhouse.dbo.NCMS_marh  with(nolock)                          
 /* where PayoutValue <> 0 */  
 
 /*******BSEFO***********************/
   insert into #NCMS_SegwiseCldata    
 (ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                
 select UpdDatetime,'AllSegment','BSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                 
 from angelcommodity.bsefo.dbo.NCMS_marh  with(nolock)  
 /*****************************/
                                               
insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                             
 select UpdDatetime,'AllSegment','NSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelfo.inhouse_curfo.dbo.NCMS_marh with(nolock)                                              
 /* where PayoutValue <> 0 */   
 
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                             
 select UpdDatetime,'AllSegment','BSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.inhouse_bsx.dbo.NCMS_marh  with(nolock)  
                                       
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','MCD',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.INHOUSE_MCDCS.dbo.NCMS_marh  with(nolock)                                             
 /* where PayoutValue <> 0 */      
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','NCDEX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.inhouse_NCDX.dbo.NCMS_marh  with(nolock)                                             
 /* where PayoutValue <> 0 */      
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','MCX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.inhouse_MCDX.dbo.NCMS_marh with(nolock)                                              
 /* where PayoutValue <> 0 */      

  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','NCE',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.INHOUSE_NCE.dbo.NCMS_marh with(nolock)    
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','BSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,AfterAdjustedBal/*VBal+UCV+UnRecoCr+OtherDr */        
 from /*angelfo.inhouse.dbo.NCMS_PO_BSEMFSS*/   angelfo.inhouse.dbo.NCMS_PO_BSEMFSS_edt with(nolock)                                 
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */      
                                            
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','NSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                     
 from angelfo.inhouse.dbo.NCMS_PO_NSEMFSS  with(nolock)                                             
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */      
                                     
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                         
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','IPO',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                               
 from NCMS_PO_IPO with(nolock)                                       
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */      
                                           
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select processDate,'NBFC','NBFC',party_Code,'I',ActualLedger,Unsettled,0,ShortValHC,0,0,0,VAHC,0,0,AccruedInt,ShortVal,0,0,NetAmount                                           
 from [ABVSCITRUS].inhouse.dbo.ncms_po with(nolock)/* where netAmount <> 0 */      
  
     CREATE CLUSTERED INDEX IDX_CLGRPSER_Party ON #NCMS_SegwiseCldata(party_code ASC,Segment)  

select * into #final_Auto from mtf_net_position	 where 1=2

if(select COUNT(1)  from mtf_net_position with(nolock)  where CAST(published_date as date)=CAST(GETDATE() as date)      
and release_mode='post-release')>0
begin
	insert into #final_Auto
	select *  from mtf_net_position  with(nolock) where CAST(published_date as date)=CAST(GETDATE() as date) 
	and release_mode='post-release'

	insert into mtf_net_position_log
	select *,getdate()   from mtf_net_position  with(nolock)  where CAST(published_date as date)=CAST(GETDATE() as date) 
	and release_mode='post-release'
end
else
begin
	insert into #final_Auto
	select *   from mtf_net_position  with(nolock)  where CAST(published_date as date)=CAST(GETDATE() as date) 
	and release_mode='Pre-release'

	insert into mtf_net_position_log
	select *,getdate()   from mtf_net_position  with(nolock)  where CAST(published_date as date)=CAST(GETDATE() as date) 
	and release_mode='Pre-release'
end

--select * into #final_Auto from mtf_autorelease_new where CAST(released_date as date)=CAST(GETDATE() as date) --and is_file_generated=1     

  
select distinct party_code,isnull(purchase_value,0) as purchase_value,isnull(mtf_margin,0) as mtf_margin into #MTFReleased
from #final_Auto    

 /* Accrured Charges */                                              
                                               
 --select party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                               
 --from misc.dbo.Accrued_PenalCharges with (nolock) group by party_code    
 
 /******added new margin peneality charges on 05 Jul 2021***********************************/
-- insert into #Accrued1  
--  select party_code,DeductEQ=SUM(Value_amt),DeductComm=0.00 from [196.1.115.182].General.dbo.tbl_EarlyPayin_Charges with(nolock) group by party_code

-- insert into #Accrued1
--  select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code 
  
-- insert into  #Accrued1
-- select party_code,DeductEQ=Balance,DeductComm=0.00 from  NCMS_WO_Master with(nolock) /*Added for W/O Margin on 16 Nov 2021*/         

--insert into  #Accrued1
--SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM anand1.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)
--where cnt_Date=(select max(cnt_Date) from anand1.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))
--group by cltcode

--insert into  #Accrued1
--SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM anand1.MSAJAG.DBO.JVPNC_LOG J with (Nolock) 
--where  PCN_Date=(select max(PCN_Date) from anand1.MSAJAG.DBO.JVPNC_LOG with (Nolock))  
--group by J.cl_code  

-- select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                       

 /****************************************/    
 /**************************************/
 select a.PARTY_CODE,(OTHER_DEBIT*-1) as OTHER_DEBIT into #AccCharges from tbl_other_debit a with (nolock)

 select a.PARTY_CODE,DeductEQ=sum(a.OTHER_DEBIT),DeductComm=0.00 into #Accrued1
 from #AccCharges a with (nolock)
 group by a.PARTY_CODE 

 insert into  #Accrued1
 select party_code,DeductEQ=Balance,DeductComm=0.00 from  NCMS_WO_Master with(nolock) /*Added for W/O Margin on 16 Nov 2021*/   

  select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                         

 /**************************************/
                                               
 update #NCMS_SegwiseCldata set AccruedCharges=-Accured,NetPayable=NetPayable-Accured                                              
 from                                              
 (                                              
  select q.segment,q.party_code,                                              
  (Case when q.entity='AllSegment' then DeductEQ else DeductComm end) as Accured                                              
  from #Accrued p join                                               
  (                                              
  select x.*,y.segment from                                              
  (                                              
  select a.entity,party_Code,min(b.seqid) as seqid                                              
  from #NCMS_SegwiseCldata a join ncms_entity b on a.segment=b.segment                                               
  group by a.entity,party_Code                                              
  ) x join ncms_entity y with(nolock) on x.seqid=y.seqid and x.entity=y.entity                                              
  ) q on p.party_Code=q.party_Code                                               
 ) AC                                              
 where #NCMS_SegwiseCldata.party_code=AC.party_Code and #NCMS_SegwiseCldata.segment=AC.Segment                                              
 and #NCMS_SegwiseCldata.segment <> 'NBFC'                                      
                                               
                                               
 /* Check Valid Client */                                              
       /****Adding Sub_broker on 16 Feb 2022**/
 UPDATE #NCMS_SegwiseCldata SET FLAG='V',sub_BRoker=b.sub_broker  from /*risk.dbo.client_Details*/ NCMS_ClientDetails b  with(nolock)                                              
 where #NCMS_SegwiseCldata.party_code=b.party_code   
 
 /********START: Added on 21 Nov 2017 As per mail of Prakash by Neha(For adding MF Codes)*************************/
select m.party_code into #MFSSCodes from angelfo.bsemfss.dbo.mfss_client m with(nolock) left join /*risk.dbo.client_details*/ NCMS_ClientDetails cd with(nolock)
on m.party_code=cd.party_code
where m.inactive_from>GETDATE() and cd.party_code is null  

 UPDATE #NCMS_SegwiseCldata SET FLAG='V' from #MFSSCodes b                                               
 where #NCMS_SegwiseCldata.party_code=b.party_code                                         
 /********END:****************************************************************************************************/                                           
                                               
 UPDATE #NCMS_SegwiseCldata SET FLAG='X' from cms.dbo.pARTY_cms_BLOCKED b   with(nolock)                                             
 where #NCMS_SegwiseCldata.party_code=b.party_code                                     
                                             
 UPDATE #NCMS_SegwiseCldata SET FLAG='I' from /*risk.dbo.client_Details*/ NCMS_ClientDetails b with(nolock)                                               
 where #NCMS_SegwiseCldata.party_code=b.party_code and left(b.party_Code,2)='ZR'                              
                                       
 /* ***********Comented on 29Dec2017 As per the mail of Rahul Sir******************************     
 UPDATE #NCMS_SegwiseCldata SET FLAG='I' from risk.dbo.client_Details b                                               
 where #NCMS_SegwiseCldata.party_code=b.party_code and (b.cl_type ='ING' or b.cl_type ='CBI')                                      
 */                             

/****************************COMMENTED AS PER SAJEEVAN SIR'S MAIL***************************/
 /*UPDATE #NCMS_SegwiseCldata SET FLAG='I' from risk.dbo.client_Details b                                               
 where #NCMS_SegwiseCldata.party_code=b.party_code and b.cl_type ='ING' */
 
 UPDATE #NCMS_SegwiseCldata SET FLAG='B' from cms.dbo.tbl_manualbill_mark b  with(nolock)                                              
 where #NCMS_SegwiseCldata.party_code=b.partycode and b.PayoutType='B'                                             
    
/*    
 UPDATE #NCMS_SegwiseCldata set balance=0,        
 UnsettledCrBill=0,UnrecoAmt=0,ShortSellValue=0,MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,MarginAdjWithColl=0,        
 MarginShortage=0,AccruedCharges=0,OtherDebit=0,NonCashConsideration=0,ExpoUtilised=0,NetPayable=0        
 where flag='B' and (segment='BSECM' or segment='NSECM')       
 */                                            

/***********************for Adding Delivery Margin Added on 14 Jun 2019 By Neha Naiwar ************************************/
--DECLARE @MARGINDATE AS DATETIME,@sdtcur as datetime         
--SELECT @MARGINDATE=MAX(MARGINDATE) FROM angelfo.NSEFO.dbo.tbl_clientmargin WITH (NOLOCK)   

--SELECT * into #delmargin FROM Angelfo.NSEFo.dbo.FOMARGINNEW with(nolock) WHERE  MDATE =@MARGINDATE/*convert(datetime,convert(varchar(8),getdate(),112))*/
--AND DEL_MARGIN <>0

--UPDATE a                                                        
--  set MarginAmt =  MarginAmt-DEL_MARGIN                     
--  FROM #NCMS_SegwiseCldata a                                             
--  JOIN                                                        
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                      
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'  
  
--UPDATE a                                                        
--  set NetPayable =  NetPayable-DEL_MARGIN                     
--  FROM #NCMS_SegwiseCldata a                                             
--  JOIN                                                        
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                      
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'   
/*************************************************************************************/
    
update #NCMS_SegwiseCldata     
set NetPayable=NetPayable-b.BillAmt,UnsettledCrBill=UnsettledCrBill-b.BillAmt     
from (select Party_code,Segment,sum(BillAmt) as BillAmt from cms.dbo.NCMS_B2B_PO_Request with (nolock) where billamt > 0 group by Party_code,Segment) b    
where #NCMS_SegwiseCldata.party_code=b.Party_code and #NCMS_SegwiseCldata.segment=b.Segment     
and #NCMS_SegwiseCldata.flag='B'    
    
 /* BSECM & NSECM Zero for NBFC Clients */                                              
 /*                                                     
 update  #NCMS_SegwiseCldata                                             
 set NetPayable = 0,ShortSellValue=0,Balance=0 from                                               
 (select Party_code from risk.dbo.client_Details where cl_type in ('NBF','TMF')) b                                              
 where #NCMS_SegwiseCldata.party_code=b.party_code and (#NCMS_SegwiseCldata.segment = 'BSECM' or #NCMS_SegwiseCldata.segment = 'NSECM')                                               
 */                      
                        
  /*---- Only unreco cheque amount of BSECM and NSECM should get deducted from NBFC Net payable */                      
 UPDATE a                                                  
 set NetPayable = UnrecoAmt+AccruedCharges                      
 FROM #NCMS_SegwiseCldata a                                       
 JOIN                                                  
 (select Party_code from /*risk.dbo.client_Details*/ NCMS_ClientDetails  with(nolock) where cl_type in ('NBF','TMF')) b                                       
 ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                          
                                                 
 /* Update Shortage Value */                                              
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                                              
(select seg+'CM' as seg,party_code,shrtval=SUM(NetShortValue) from ncms_shortsell  with(nolock) group by seg,party_Code having sum(NetShortValue) <> 0) b                
 where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.party_Code                                              
 
 /*update net basis of Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/
 
  update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.loss ,OtherDebit=OtherDebit-b.loss from                                              
 (select party_code,loss,exchange+'CM' as segment from NCMS_Intraday_loss with(nolock)) b                                              
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0 and NetPayable>0 
 
/****************/

/***********************Start****************************************/
 /*********Margin added in cash segment as per mail of sajeevn sir on 01Aug 2020****************/
  /*  
DECLARE @MARGINDATE AS DATETIME       
SELECT @MARGINDATE=MAX(MARGINDATE) FROM anand1.msajag.dbo.tbl_combine_reporting_detail WITH (NOLOCK)   
--select @MARGINDATE
select margindate,exchange,segment,party_code,tday_margin,tday_mtm,tday_margin+tday_mtm as margin INTO #MARGIN from
 anand1.msajag.dbo.tbl_combine_reporting_detail with(nolock) where MARGINDATE=@MARGINDATE AND exchange in ('BSE','NSE') and segment='CAPITAL'


  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.margin,NetPayable=NetPayable-b.margin from                                              
 (select party_code,margin,exchange+'CM' as segment from #MARGIN WITH (NOLOCK) where margin>0) b                                              
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0  
  */
  
  DECLARE @MARGINDATE AS DATETIME         
SELECT @MARGINDATE=MAX(MARGIN_DATE) FROM AngelNseCM.msajag.dbo.tbl_mg02 WITH (NOLOCK) 

select a.*,convert(money,varamt/abs(netqty)) as pershare,b.short_qty  into #data from AngelNseCM.msajag.dbo.tbl_mg02 a with(nolock)  join ncms_shortsell b with(nolock) on a.party_code=b.PARTY_cODE and a.scrip_cd=b.SCRIP_CD
	and a.sett_no=b.sett_no where /* a.party_code='A2649' and*/
	  MARGIN_DATE=@MARGINDATE and ABS(netqty)<>0
  
  	 select convert(money,pershare*short_qty) as varmargin ,party_code,scrip_cd,sett_no into #margin from #data

  
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.varmargin,NetPayable=NetPayable-b.varmargin from                                                
 (select 'NSECM' as segment,party_code,varmargin=SUM(varmargin) from #margin /* where party_code='A2649'*/
 group by party_Code having sum(varmargin) <> 0) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0  

  --update a set OtherDebit=OtherDebit-TotalReleaseValue from #NCMS_SegwiseCldata a join #MTFReleased b on a.party_code=b.party_code  
  --where segment='MTF' 
    update a set OtherDebit=OtherDebit-mtf_margin from #NCMS_SegwiseCldata a join #MTFReleased b on a.party_code=b.party_code  
  where segment='MTF' 

  update a set Deposit=Deposit+purchase_value from #NCMS_SegwiseCldata a join #MTFReleased b on a.party_code=b.party_code  
  where segment='MTF' 
 /***********************End****************************************/  

 /*****************peakmargin from bo for NSE BSE MTF************************/
 /*DECLARE @MARGINDATEpeak AS DATETIME   , @MARGINDATEpeakBSE AS DATETIME ,@MARGINDATEpeakMTF as Datetime           
--set @MARGINDATEpeak=cast(CAST(getdate()-1 as date)as datetime)
SELECT @MARGINDATEpeak=MAX(MARGINDATE) FROM [196.1.115.196].Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='NSE' and SEGMENT='CAPITAL'
SELECT @MARGINDATEpeakBSE=MAX(MARGINDATE) FROM [196.1.115.196].Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='BSE' and SEGMENT='CAPITAL'  
SELECT @MARGINDATEpeakMTF=MAX(MARGINDATE) FROM [196.1.115.196].Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='MTF' and SEGMENT='MTF'  

 
 if(select COUNT(1) from [196.1.115.132].cms.dbo.NCMS_PeackMargin with(nolock))=0
begin
		  select cltcode,UDebitV*-1 as UDebitV,'NSE' as exchange into #unSettDr from anand1.inhouse.dbo.NCMS_PO_UnsetDr with(nolock) where UDebitV<0

		select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa  from [196.1.115.196].Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)
		 where margindate =@MARGINDATEpeak
		 and EXCHANGE='NSE' and SEGMENT='CAPITAL' and TDAY_MARGIN>0 group by party_code,EXCHANGE
		 order by party_code    
		 
		 
		   declare @month varchar(10),@peakVar money
		   
		   select @month=convert(char(3), GETDATE(), 0)
		select @month
		if(@month='Dec' or @month='Jan' or @month='Feb')
		begin
		 set @peakVar=0.25 
		 print @peakVar
		end 
		if(@month='Mar' or @month='Apr' or @month='May')
		begin
		 set @peakVar=0.5 
		 print @peakVar
		end
		if(@month='Jun' or @month='Jul' or @month='Aug')
		begin
		 set @peakVar=0.75 
		 print @peakVar
		end
		if(@month='Sep' or @month='Oct' or @month='Nov')
		begin
		 set @peakVar=1 
		 print @peakVar
		end
		select party_code,EXCHANGE,peakMargin/**@peakVar*/ as peakMargin into #peakMr from #aa
		
		/*******************************************/
		select a.exchange,b.party_code,b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00 
																						when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as FinalPeak
																						into #peak from #unSettDr a right join #peakMr b 
		on a.cltcode=b.party_code
		/*******************************************/
		update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.FinalPeak/*,NetPayable=NetPayable-b.FinalPeak*/ from                                                
 (select 'NSECM'  as segment,party_code,FinalPeak from #peak) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code
 
 /*****************BSE***********/
   select cltcode,UDebitV*-1 as UDebitV,'BSE' as exchange into #unSettDrBSE from anand.inhouse.dbo.NCMS_PO_UnsetDr with(nolock) where UDebitV<0

 select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa1  from [196.1.115.196].Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)
		 where margindate =@MARGINDATEpeakBSE
		 and EXCHANGE='BSE' and SEGMENT='CAPITAL' and TDAY_MARGIN>0 group by party_code,EXCHANGE
		 order by party_code    
		 
		 
		   declare @month1 varchar(10),@peakVar1 money
		   
		   select @month1=convert(char(3), GETDATE(), 0)
		
		if(@month1='Dec' or @month1='Jan' or @month1='Feb')
		begin
		 set @peakVar1=0.25 
		 print @peakVar1
		end 
		if(@month1='Mar' or @month1='Apr' or @month1='May')
		begin
		 set @peakVar1=0.5 
		 print @peakVar1
		end
		if(@month1='Jun' or @month1='Jul' or @month1='Aug')
		begin
		 set @peakVar1=0.75 
		 print @peakVar1
		end
		if(@month1='Sep' or @month1='Oct' or @month1='Nov')
		begin
		 set @peakVar1=1 
		 print @peakVar1
		end
		select party_code,EXCHANGE,peakMargin/**@peakVar1*/ as peakMargin into #peakMr1 from #aa1
		
		/*******************************************/
		select a.exchange,b.party_code,b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00 
																						when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as FinalPeak
																						into #peak1 from #unSettDrBSE a right join #peakMr1 b 
		on a.cltcode=b.party_code
		/*******************************************/
		
		update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.FinalPeak,NetPayable=NetPayable-b.FinalPeak from                                                
 (select 'BSECM'  as segment,party_code,FinalPeak from #peak1) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code
 
 
 /*****************MTF***********/
 select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa11  from [196.1.115.196].Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)
		 where margindate =@MARGINDATEpeakMTF
		 and EXCHANGE='MTF' and SEGMENT='MTF' and TDAY_MARGIN>0 group by party_code,EXCHANGE
		 order by party_code    
		 
		 
		   declare @month11 varchar(10),@peakVar11 money
		   
		   select @month11=convert(char(3), GETDATE(), 0)
		
		if(@month11='Dec' or @month11='Jan' or @month11='Feb')
		begin
		 set @peakVar11=0.25 
		 print @peakVar11
		end 
		if(@month11='Mar' or @month11='Apr' or @month11='May')
		begin
		 set @peakVar11=0.5 
		 print @peakVar11
		end
		if(@month11='Jun' or @month11='Jul' or @month11='Aug')
		begin
		 set @peakVar11=0.75 
		 print @peakVar11
		end
		if(@month11='Sep' or @month11='Oct' or @month11='Nov')
		begin
		 set @peakVar11=1 
		 print @peakVar11
		end
		select party_code,EXCHANGE,peakMargin/**@peakVar11*/ as peakMargin into #peak11 from #aa11
		
		update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.peakMargin,NetPayable=NetPayable-b.peakMargin from                                                
 (select EXCHANGE as segment,party_code,peakMargin from #peak11) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code
 
 end*/
 /**************************************/
/*******************added on 10 Mar 2021 for adding unsetteld Holding***************************************************/
 /*declare @NONCASHconsideration as int = 50 
 
  update #NCMS_SegwiseCldata set NonCashConsideration=@NONCASHconsideration where Segment='NSECM'        
      
 update #NCMS_SegwiseCldata set NonCashConsideration=b.CollateralPercent        
 from NCMS_ROI b  WITH (NOLOCK)   where #NCMS_SegwiseCldata.party_code=b.party_code  and  #NCMS_SegwiseCldata.Segment='NSECM'        

select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,
CONVERT(MONEY, 0) as Value_BHC_unsett,
CONVERT(MONEY, 0) as Value_AHC_unsett
  into #unsett_holding from /*[196.1.115.197].msajag.dbo.unclear_hold*/  [196.1.115.197].MSAJAG.dbo.Vw_Todays_Secpayout  a with(nolock) join
 [196.1.115.182].GENERAL.DBO.Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/
a.I_isin=b.security_isin join [196.1.115.182].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.I_isin=c.[isin no]

update #unsett_holding set Value_BHC_unsett=qty*MTM_Price_unsett
update #unsett_holding set Value_AHC_unsett=isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)

select SUM(Value_AHC_unsett) as Value_AHC_unsett,party_code into #holding_AHC from #unsett_holding group by party_code

update #NCMS_SegwiseCldata set noncashcoll=Value_AHC_unsett from                                                
 (select party_code,Value_AHC_unsett from #holding_AHC) b                                                
 where #NCMS_SegwiseCldata.segment='NSECM' and #NCMS_SegwiseCldata.party_code=b.party_Code 
 
  alter table #NCMS_SegwiseCldata add marginAdjustWithLgr money 
 
 update #NCMS_SegwiseCldata set marginAdjustWithLgr=0.00
 
 update #NCMS_SegwiseCldata set ExpoUtilised=ExpoUtilised+
 (case   
 when  noncashcoll=0 then   MarginAmt   
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0       
 then 0         
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll 
 end) ,
 marginAdjustWithLgr=isnull(marginAdjustWithLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)
 from #NCMS_SegwiseCldata where segment='NSECM'	-- and  party_code='D65765'
 
 
update #NCMS_SegwiseCldata set NetPayable=NetPayable+ExpoUtilised+marginAdjustWithLgr  where segment='NSECM' 
*/
/**********************************************************************/

/*              
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                                              
 (select party_code,shrtval=sum(dedVal) from risk.dbo.vw_cms_bsecm_shrtval_verifier_optimized group by party_Code having sum(dedVal) <> 0) b                                              
 where #NCMS_SegwiseCldata.segment='BSECM' and #NCMS_SegwiseCldata.party_code=b.party_Code                                              
                                               
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                    
 (select party_code,shrtval=sum(dedVal) from risk.dbo.vw_cms_nsecm_shrtval_verifier_optimized group by party_Code  having sum(dedVal) <> 0) b                                              
 where #NCMS_SegwiseCldata.segment='NSECM' and #NCMS_SegwiseCldata.party_code=b.party_Code                                              
*/                
   
   /******Commented on 16 Feb 2022***************/
 /*update #NCMS_SegwiseCldata set sub_BRoker=b.SB                                   
 from [196.1.115.182].general.dbo.Vw_RMS_Client_Vertical b with (nolock)                                   
 where #NCMS_SegwiseCldata.party_Code=b.client                                  
 */                   
                    
/* Recalculating NBFC Unsettled Bill and Actual Ledger */                    
 /*                   
select cltcode ,sum(case when drcr='C' then vamt else -vamt end) as UCV                   
 into #nbfcucv                    
from [196.1.115.182].general.dbo.bsecm_cledger where edt>= convert(varchar(11),GETDATE()+1) and vtyp=15                    
group by cltcode                    
                    
insert into #nbfcucv                    
select cltcode,sum(case when drcr='C' then vamt else -vamt end) as UCV                    
from [196.1.115.182].general.dbo.nsecm_cledger where edt>= convert(varchar(11),GETDATE()+1) and vtyp=15                    
group by cltcode                    
                     
update #NCMS_SegwiseCldata set UnsettledCrBill=b.ucv,Balance=Balance+#NCMS_SegwiseCldata.UnsettledCrBill-ucv                     
from (select cltcode,SUM(ucv)  as ucv from #nbfcucv group by cltcode) b                     
where #NCMS_SegwiseCldata.Party_code=b.cltcode  and #NCMS_SegwiseCldata.segment='NBFC'                  
*/                  
/* NBFC Recalculation --- END */                    
                                               
 Truncate table NCMS_SegwiseCldata                                              
 insert into NCMS_SegwiseCldata (ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_broker)                                              
 select ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                  
 NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_broker                                     
 from #NCMS_SegwiseCldata  with(nolock) where Flag <> 'I'                                              
                                  
 --insert into NCMS_SegwiseCldata_hist(id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,                                  
 --MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,                                  
 --NetPayable,Sub_Broker)                                  
 --select id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                  
 --NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_Broker                                   
 --from NCMS_SegwiseCldata   with(nolock)
 

 /************Added for merge all segment***********************************************/
 select * into #new_NCMS_SegwiseCldata from #NCMS_SegwiseCldata  with(nolock) where Flag <> 'I' 

   update #new_NCMS_SegwiseCldata set Balance=0.00,UnsettledCrBill=0.00 where NetPayable=0 and Segment='BSEMFSS'  
  update #new_NCMS_SegwiseCldata  set UnsettledCrBill=0.00 where  Segment='BSEMFSS'  and  NetPayable>0  and UnsettledCrBill<0  
   update #new_NCMS_SegwiseCldata set OtherDebit=0 where Segment='MTF'
update  #new_NCMS_SegwiseCldata set Balance=NetPayable where Balance=0 and AccruedCharges=0 and marginamt=0 and segment='bsemfss' and NetPayable<0  
    
 select max(ProcessDate) ProcessDate,Entity,Party_code,Flag,sum(Balance)Balance,sum(UnsettledCrBill) UnsettledCrBill,sum(UnrecoAmt) UnrecoAmt,    
 sum(ShortSellValue) ShortSellValue,sum(MarginAmt) MarginAmt,SUM(deposit) Deposit,sum(CashColl)CashColl,sum(NonCashColl) NonCashColl,    
 sum(MarginAdjWithColl) MarginAdjWithColl,sum(MarginShortage) MarginShortage,sum(AccruedCharges) AccruedCharges,sum(OtherDebit) OtherDebit,    
 max(100) NonCashConsideration--,SUM(ExpoUtilised) as ExpoUtilised,sum(NetPayable) NetPayable  
 ,case when entity='AllSegment' then 0.00 else SUM(ExpoUtilised) end as ExpoUtilised,  
 case when entity='AllSegment' then 0.00 else sum(NetPayable) end NetPayable,Sub_Broker  
 into #ncms    
 from  #new_NCMS_SegwiseCldata  
 group by Entity,Party_code,Flag,Sub_Broker                                                  
												
  
 update #ncms set ExpoUtilised=ExpoUtilised+    
 (case       
 when  noncashcoll=0 then   MarginAmt       
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0           
 then 0             
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll     
 end)     
 /*,marginAdjustWithCombineLgr=isnull(marginAdjustWithCombineLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3    
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  */   /*added on 08 Oct 2021 by Neha naiwar*/  
 from #ncms where entity='AllSegment'  
   
 update #ncms set NetPayable=Balance+ExpoUtilised+/*marginAdjustWithCombineLgr+*/UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges+OtherDebit   
  where entity='AllSegment' 

  -- update a set NetPayable=NetPayable-TotalReleaseValue from #ncms a join #MTFReleased b on a.party_code=b.party_code  
  --where entity='AllSegment'  
  update a set NetPayable=NetPayable+purchase_value-mtf_margin from #ncms a join #MTFReleased b on a.party_code=b.party_code  
  where entity='AllSegment'  

  truncate table NCMS_EntityDataView_combine  
 insert into NCMS_EntityDataView_combine                                            
  (                                             
  ProcessDate,Entity,sub_Broker,party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable
  )                                              
  select                       
  ProcessDate,Entity,sub_Broker,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                             
  from #ncms    
 /********************************************************/


 
/*Added for including ZR and ING codes in SCFM*/

insert into SCFM_Data_Matchwith_BO (ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,
CashColl,NonCashColl,OtherDebit,NonCashConsideration,Net,UNRECO_DEBIT,UNRECO_CREDIT
)                                 
select ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,0,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                  
 NonCashColl,OtherDebit,NonCashConsideration,NetPayable,0,0                                     
 from #NCMS_SegwiseCldata where Flag = 'I' and Party_code like 'ZR%' 
 
 
insert into SCFM_Data_Matchwith_BO (ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,
CashColl,NonCashColl,OtherDebit,NonCashConsideration,Net,UNRECO_DEBIT,UNRECO_CREDIT
)                                 
select ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,0,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                  
 NonCashColl,OtherDebit,NonCashConsideration,NetPayable,0,0                                     
 from #NCMS_SegwiseCldata where Flag = 'I' and Party_code like 'ING%' 
 
 /***************************/                                
                                  
End try                                                   
                                                  
BEGIN CATCH                                                      
                                                  
   insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                            
   select GETDATE(),'NCMS_calculation',ERROR_LINE(),ERROR_MESSAGE()                                                            
                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                        
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                        
  RAISERROR (@ErrorMessage , 16, 1);                              
                                                                       
End catch                                         
                                              
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_Calculation_Commodity
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[NCMS_Calculation_Commodity]  
WITH RECOMPILE                         
as                                              
                                              
Set nocount on                                              
SET XACT_ABORT ON                                                 
BEGIN TRY                                                      
                                              
Exec AngelBSECM.inhouse.dbo.NCMS_POdet_commodity
Exec AngelNseCM.inhouse.dbo.NCMS_POdet_commodity
Exec angelfo.inhouse.dbo.NCMS_POdet_commodity
Exec angelfo.inhouse_curfo.dbo.NCMS_POdet_commodity
Exec angelcommodity.INHOUSE_MCDCS.dbo.NCMS_POdet_commodity
Exec angelcommodity.inhouse_BSX.dbo.NCMS_POdet_commodity
Exec angelfo.inhouse.dbo.NCMS_POdet_NSEMFSS_commodity
Exec angelfo.inhouse.dbo.NCMS_POdet_BSEMFSS_commodity
Exec angelcommodity.inhouse_NCDX.dbo.NCMS_POdet_commodity
Exec angelcommodity.inhouse_MCDX.dbo.NCMS_POdet_commodity
Exec angelcommodity.INHOUSE_NCE.dbo.NCMS_POdet_commodity
Exec anand1.MTFTRADE.dbo.NCMS_POdet_commodity
Exec angelcommodity.BSEFO.dbo.NCMS_POdet_commodity             

 /*Fetch Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/
 truncate table NCMS_Intraday_loss
 
 insert into NCMS_Intraday_loss
 exec AngelNseCM.msajag.dbo.Intraday_loss
/****************/
                                               
 /* FETCH DATA */                                              
 select id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_Broker                                              
 into #NCMS_SegwiseCldata from NCMS_SegwiseCldata where 1=2                                              
 
  --CREATE CLUSTERED INDEX IDX_CLGRPSER ON #NCMS_SegwiseCldata(id ASC) 
  -- CREATE NONCLUSTERED INDEX IDX_CLGRPSER_Party ON #NCMS_SegwiseCldata(party_code ASC)                                    
  --  CREATE NONCLUSTERED INDEX IDX_CLGRPSER_Segment ON #NCMS_SegwiseCldata(Segment ASC)                                    
                                                
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','BSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                               
 from AngelBSECM.inhouse.dbo.NCMS_PO with(nolock)                                             
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */                                             
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','NSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                               
 from AngelNseCM.inhouse.dbo.NCMS_PO with(nolock)                                              
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */  
 
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','MTF',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr 
 /*0,0,0,0,0,0,0,0,0,0,0,0,0,0,0*/
 from AngelNseCM.MTFTRADE.dbo.NCMS_PO with(nolock)    
  
 insert into #NCMS_SegwiseCldata  
 (ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','NSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelfo.inhouse.dbo.NCMS_marh  with(nolock)                          
 /* where PayoutValue <> 0 */  
 
 /*******BSEFO***********************/
   insert into #NCMS_SegwiseCldata    
 (ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                
 select UpdDatetime,'AllSegment','BSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                 
 from angelcommodity.bsefo.dbo.NCMS_marh  with(nolock)  
 /*****************************/
                                               
insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                             
 select UpdDatetime,'AllSegment','NSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelfo.inhouse_curfo.dbo.NCMS_marh with(nolock)                                              
 /* where PayoutValue <> 0 */   
 
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                             
 select UpdDatetime,'AllSegment','BSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.inhouse_bsx.dbo.NCMS_marh  with(nolock)  
                                       
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','MCD',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.INHOUSE_MCDCS.dbo.NCMS_marh  with(nolock)                                             
 /* where PayoutValue <> 0 */      
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','NCDEX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.inhouse_NCDX.dbo.NCMS_marh  with(nolock)                                             
 /* where PayoutValue <> 0 */      
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','MCX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.inhouse_MCDX.dbo.NCMS_marh with(nolock)                                              
 /* where PayoutValue <> 0 */      

  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','NCE',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.INHOUSE_NCE.dbo.NCMS_marh with(nolock)    
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','BSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,AfterAdjustedBal/*VBal+UCV+UnRecoCr+OtherDr */        
 from /*angelfo.inhouse.dbo.NCMS_PO_BSEMFSS*/   angelfo.inhouse.dbo.NCMS_PO_BSEMFSS_edt with(nolock)                                 
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */      
                                            
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','NSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                     
 from angelfo.inhouse.dbo.NCMS_PO_NSEMFSS  with(nolock)                                             
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */      
                                     
 --insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                         
 --Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 --select ProcessDatetime,'AllSegment','IPO',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                               
 --from NCMS_PO_IPO with(nolock)                                       
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */      
                                           
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select processDate,'NBFC','NBFC',party_Code,'I',ActualLedger,Unsettled,0,ShortValHC,0,0,0,VAHC,0,0,AccruedInt,ShortVal,0,0,NetAmount                                           
 from [ABVSCITRUS].inhouse.dbo.ncms_po with(nolock)/* where netAmount <> 0 */      
  
     CREATE CLUSTERED INDEX IDX_CLGRPSER_Party ON #NCMS_SegwiseCldata(party_code ASC,Segment)
	 
delete from #NCMS_SegwiseCldata where party_code not in (Select party_code from cms.dbo.NCMS_Commodity_clients  where 
 CAST(updatedOn as date)=CAST(GETDATE() as date) )

select * into #final_Auto from cms.dbo.mtf_net_position	 where 1=2

if(select COUNT(1)  from  cms.dbo.mtf_net_position with(nolock)  where CAST(published_date as date)=CAST(GETDATE() as date)      
and release_mode='post-release')>0
begin
	insert into #final_Auto
	select *  from  cms.dbo.mtf_net_position  with(nolock) where CAST(published_date as date)=CAST(GETDATE() as date) 
	and release_mode='post-release'

end
else
begin
	insert into #final_Auto
	select *   from  cms.dbo.mtf_net_position  with(nolock)  where CAST(published_date as date)=CAST(GETDATE() as date) 
	and release_mode='Pre-release'

end

--select * into #final_Auto from mtf_autorelease_new where CAST(released_date as date)=CAST(GETDATE() as date) --and is_file_generated=1     

  
select distinct party_code,isnull(purchase_value,0) as purchase_value,isnull(mtf_margin,0) as mtf_margin into #MTFReleased
from #final_Auto    

 /**************************************/
 select a.PARTY_CODE,(OTHER_DEBIT*-1) as OTHER_DEBIT into #AccCharges from cms.dbo.tbl_other_debit a with (nolock)

 select a.PARTY_CODE,DeductEQ=sum(a.OTHER_DEBIT),DeductComm=0.00 into #Accrued1
 from #AccCharges a with (nolock)
 group by a.PARTY_CODE 

 insert into  #Accrued1
 select party_code,DeductEQ=Balance,DeductComm=0.00 from  cms.dbo.NCMS_WO_Master with(nolock) /*Added for W/O Margin on 16 Nov 2021*/   

  select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                         

 /**************************************/
                                               
 update #NCMS_SegwiseCldata set AccruedCharges=-Accured,NetPayable=NetPayable-Accured                                              
 from                                              
 (                                              
  select q.segment,q.party_code,                                              
  (Case when q.entity='AllSegment' then DeductEQ else DeductComm end) as Accured                                              
  from #Accrued p join                                               
  (                                              
  select x.*,y.segment from                                              
  (                                              
  select a.entity,party_Code,min(b.seqid) as seqid                                              
  from #NCMS_SegwiseCldata a join  cms.dbo.ncms_entity b on a.segment=b.segment                                               
  group by a.entity,party_Code                                              
  ) x join cms.dbo.NCMS_Entity y with(nolock) on x.seqid=y.seqid and x.entity=y.entity                                              
  ) q on p.party_Code=q.party_Code                                               
 ) AC                                              
 where #NCMS_SegwiseCldata.party_code=AC.party_Code and #NCMS_SegwiseCldata.segment=AC.Segment                                              
 and #NCMS_SegwiseCldata.segment <> 'NBFC'                                      
                                               
                                               
 /* Check Valid Client */                                              
       /****Adding Sub_broker on 16 Feb 2022**/
 UPDATE #NCMS_SegwiseCldata SET FLAG='V',sub_BRoker=b.sub_broker  from cms.dbo.NCMS_ClientDetails b  with(nolock)                                              
 where #NCMS_SegwiseCldata.party_code=b.party_code   
 
 /********START: Added on 21 Nov 2017 As per mail of Prakash by Neha(For adding MF Codes)*************************/
select m.party_code into #MFSSCodes from angelfo.bsemfss.dbo.mfss_client m with(nolock) left join  cms.dbo.NCMS_ClientDetails cd with(nolock)
on m.party_code=cd.party_code
where m.inactive_from>GETDATE() and cd.party_code is null  

 UPDATE #NCMS_SegwiseCldata SET FLAG='V' from #MFSSCodes b                                               
 where #NCMS_SegwiseCldata.party_code=b.party_code                                         
 /********END:****************************************************************************************************/                                           
                                               
 UPDATE #NCMS_SegwiseCldata SET FLAG='X' from cms.dbo.pARTY_cms_BLOCKED b   with(nolock)                                             
 where #NCMS_SegwiseCldata.party_code=b.party_code                                     
                                             
 --UPDATE #NCMS_SegwiseCldata SET FLAG='I' from /*risk.dbo.client_Details*/ NCMS_ClientDetails b with(nolock)                                               
 --where #NCMS_SegwiseCldata.party_code=b.party_code and left(b.party_Code,2)='ZR'   
 
 /***SRE - 37292*** blocking FN clients**/
 UPDATE a SET FLAG='I' from #NCMS_SegwiseCldata a ,cms.dbo.NCMS_ClientDetails b                                              
 where a.party_code=b.party_code and  ltrim(rtrim(b.cl_type))='NRI' and b.sub_broker not in ('NKAB', 'NK', 'BH', 'BHKWT')

 UPDATE a SET FLAG='I' from #NCMS_SegwiseCldata a ,cms.dbo.NCMS_ClientDetails b                                              
 where a.party_code=b.party_code and  ltrim(rtrim(b.cl_type))='FN' and b.sub_broker not in ('NKAB', 'NK', 'BH', 'BHKWT')
 
 UPDATE #NCMS_SegwiseCldata SET FLAG='B' from cms.dbo.tbl_manualbill_mark b  with(nolock)                                              
 where #NCMS_SegwiseCldata.party_code=b.partycode and b.PayoutType='B'                                             
    

update #NCMS_SegwiseCldata     
set NetPayable=NetPayable-b.BillAmt,UnsettledCrBill=UnsettledCrBill-b.BillAmt     
from (select Party_code,Segment,sum(BillAmt) as BillAmt from cms.dbo.NCMS_B2B_PO_Request with (nolock) where billamt > 0 group by Party_code,Segment) b    
where #NCMS_SegwiseCldata.party_code=b.Party_code and #NCMS_SegwiseCldata.segment=b.Segment     
and #NCMS_SegwiseCldata.flag='B'    
                     
 UPDATE a                                                  
 set NetPayable = UnrecoAmt+AccruedCharges                      
 FROM #NCMS_SegwiseCldata a                                       
 JOIN                                                  
 (select Party_code from cms.dbo.NCMS_ClientDetails  with(nolock) where cl_type in ('NBF','TMF')) b                                       
 ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                          
                                                 
 /* Update Shortage Value */                                              
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                                              
(select seg+'CM' as seg,party_code,shrtval=SUM(NetShortValue) from cms.dbo.ncms_shortsell  with(nolock) group by seg,party_Code having sum(NetShortValue) <> 0) b                
 where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.party_Code                                              
 
 /*update net basis of Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/
 
  update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.loss ,OtherDebit=OtherDebit-b.loss from                                              
 (select party_code,loss,exchange+'CM' as segment from NCMS_Intraday_loss with(nolock)) b                                              
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0 and NetPayable>0 
 

  DECLARE @MARGINDATE AS DATETIME         
SELECT @MARGINDATE=MAX(MARGIN_DATE) FROM AngelNseCM.msajag.dbo.tbl_mg02 WITH (NOLOCK) 

select a.*,convert(money,varamt/abs(netqty)) as pershare,b.short_qty  into #data from AngelNseCM.msajag.dbo.tbl_mg02 a 
with(nolock)  join cms.dbo.ncms_shortsell b with(nolock) on a.party_code=b.PARTY_cODE and a.scrip_cd=b.SCRIP_CD
	and a.sett_no=b.sett_no where /* a.party_code='A2649' and*/
	  MARGIN_DATE=@MARGINDATE and ABS(netqty)<>0
  
  	 select convert(money,pershare*short_qty) as varmargin ,party_code,scrip_cd,sett_no into #margin from #data

  
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.varmargin,NetPayable=NetPayable-b.varmargin from                                                
 (select 'NSECM' as segment,party_code,varmargin=SUM(varmargin) from #margin /* where party_code='A2649'*/
 group by party_Code having sum(varmargin) <> 0) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0  

  --update a set OtherDebit=OtherDebit-TotalReleaseValue from #NCMS_SegwiseCldata a join #MTFReleased b on a.party_code=b.party_code  
  --where segment='MTF' 
    update a set OtherDebit=OtherDebit-mtf_margin from #NCMS_SegwiseCldata a join #MTFReleased b on a.party_code=b.party_code  
  where segment='MTF' 

  update a set Deposit=Deposit+purchase_value from #NCMS_SegwiseCldata a join #MTFReleased b on a.party_code=b.party_code  
  where segment='MTF' 
 /***********************End****************************************/  
 
 delete from #NCMS_SegwiseCldata where party_code  not in (Select party_code from cms.dbo.NCMS_Commodity_clients  where 
 CAST(updatedOn as date)=CAST(GETDATE() as date) )

 --update a set a.Balance=b.Balance,a.UnsettledCrBill=b.UnsettledCrBill,a.MarginAmt=b.MarginAmt,a.NonCashColl=b.NonCashColl,
 --a.AccruedCharges=b.AccruedCharges,a.OtherDebit=b.OtherDebit,a.NetPayable=b.NetPayable from NCMS_SegwiseCldata a join
 --#NCMS_SegwiseCldata b on a.Party_code=b.Party_code and a.Segment=b.Segment

 delete from NCMS_SegwiseCldata where party_code in (Select party_code from cms.dbo.NCMS_Commodity_clients  where 
 CAST(updatedOn as date)=CAST(GETDATE() as date) )
                                             
 insert into NCMS_SegwiseCldata (ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_broker)                                              
 select ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                  
 NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_broker                                     
 from #NCMS_SegwiseCldata  with(nolock) where Flag <> 'I'                                          

  

  
 /************Added for merge all segment***********************************************/
 select * into #new_NCMS_SegwiseCldata from #NCMS_SegwiseCldata  with(nolock) where Flag <> 'I' 

   update #new_NCMS_SegwiseCldata set Balance=0.00,UnsettledCrBill=0.00 where NetPayable=0 and Segment='BSEMFSS'  
  update #new_NCMS_SegwiseCldata  set UnsettledCrBill=0.00 where  Segment='BSEMFSS'  and  NetPayable>0  and UnsettledCrBill<0  
   update #new_NCMS_SegwiseCldata set OtherDebit=0 where Segment='MTF'
update  #new_NCMS_SegwiseCldata set Balance=NetPayable where Balance=0 and AccruedCharges=0 and marginamt=0 and segment='bsemfss' and NetPayable<0  
    
 select max(ProcessDate) ProcessDate,Entity,Party_code,Flag,sum(Balance)Balance,sum(UnsettledCrBill) UnsettledCrBill,sum(UnrecoAmt) UnrecoAmt,    
 sum(ShortSellValue) ShortSellValue,sum(MarginAmt) MarginAmt,SUM(deposit) Deposit,sum(CashColl)CashColl,sum(NonCashColl) NonCashColl,    
 sum(MarginAdjWithColl) MarginAdjWithColl,sum(MarginShortage) MarginShortage,sum(AccruedCharges) AccruedCharges,sum(OtherDebit) OtherDebit,    
 max(100) NonCashConsideration--,SUM(ExpoUtilised) as ExpoUtilised,sum(NetPayable) NetPayable  
 ,case when entity='AllSegment' then 0.00 else SUM(ExpoUtilised) end as ExpoUtilised,  
 case when entity='AllSegment' then 0.00 else sum(NetPayable) end NetPayable,Sub_Broker  
 into #ncms    
 from  #new_NCMS_SegwiseCldata  
 group by Entity,Party_code,Flag,Sub_Broker                                                  
												
  
 update #ncms set ExpoUtilised=ExpoUtilised+    
 (case       
 when  noncashcoll=0 then   MarginAmt       
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0           
 then 0             
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll     
 end)     
 /*,marginAdjustWithCombineLgr=isnull(marginAdjustWithCombineLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3    
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  */   /*added on 08 Oct 2021 by Neha naiwar*/  
 from #ncms where entity='AllSegment'  
   
 update #ncms set NetPayable=Balance+ExpoUtilised+/*marginAdjustWithCombineLgr+*/UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges+OtherDebit   
  where entity='AllSegment' 

  update a set NetPayable=NetPayable+purchase_value-mtf_margin from #ncms a join #MTFReleased b on a.party_code=b.party_code  
  where entity='AllSegment'  

 
 -- update a set a.Balance=b.Balance,a.UnsettledCrBill=b.UnsettledCrBill,a.MarginAmt=b.MarginAmt,a.NonCashColl=b.NonCashColl,
 --a.AccruedCharges=b.AccruedCharges,a.OtherDebit=b.OtherDebit,a.NetPayable=b.NetPayable from NCMS_EntityDataView_combine a join
 --#ncms b on a.Party_code=b.Party_code and a.Segment=b.Segment
   delete from NCMS_EntityDataView_combine where party_code in (Select party_code from cms.dbo.NCMS_Commodity_clients  where 
 CAST(updatedOn as date)=CAST(GETDATE() as date) )

  insert into NCMS_EntityDataView_combine                                            
  (                                             
  ProcessDate,Entity,sub_Broker,party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable
  )                                              
  select                       
  ProcessDate,Entity,sub_Broker,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                             
  from #ncms    

/*Added for including ZR and ING codes in SCFM*/

--insert into SCFM_Data_Matchwith_BO (ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,
--CashColl,NonCashColl,OtherDebit,NonCashConsideration,Net,UNRECO_DEBIT,UNRECO_CREDIT
--)                                 
--select ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,0,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                  
-- NonCashColl,OtherDebit,NonCashConsideration,NetPayable,0,0                                     
-- from #NCMS_SegwiseCldata where Flag = 'I' and Party_code like 'ZR%' 
 
 
--insert into SCFM_Data_Matchwith_BO (ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,
--CashColl,NonCashColl,OtherDebit,NonCashConsideration,Net,UNRECO_DEBIT,UNRECO_CREDIT
--)                                 
--select ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,0,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                  
-- NonCashColl,OtherDebit,NonCashConsideration,NetPayable,0,0                                     
-- from #NCMS_SegwiseCldata where Flag = 'I' and Party_code like 'ING%' 
 
 /***************************/                                
                                  
End try                                                   
                                                  
BEGIN CATCH                                                      
                                                  
   insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                            
   select GETDATE(),'NCMS_calculation_commodity',ERROR_LINE(),ERROR_MESSAGE()                                                            
                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                        
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                        
  RAISERROR (@ErrorMessage , 16, 1);                              
                                                                       
End catch                                         
                                              
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_Calculation_Equity
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[NCMS_Calculation_Equity]  
WITH RECOMPILE                         
as                                              
                                              
Set nocount on                                              
SET XACT_ABORT ON                                                 
BEGIN TRY                                                      

 --Exec AngelBSECM.inhouse.dbo.NCMS_POdet_morning
 -- Exec AngelNseCM.inhouse.dbo.NCMS_POdet_morning                                              
 --Exec angelfo.inhouse.dbo.NCMS_POdet_Morning                                            
 --Exec angelfo.inhouse_curfo.dbo.NCMS_POdet_Morning                                                                                            
 --Exec angelcommodity.inhouse_BSX.dbo.NCMS_POdet_Morning  
 --Exec angelcommodity.INHOUSE_MCDCS.dbo.NCMS_POdet_Morning                                                                                            
 --Exec angelfo.inhouse.dbo.NCMS_POdet_NSEMFSS                                              
 --Exec angelfo.inhouse.dbo.NCMS_POdet_BSEMFSS 
 -- Exec AngelNseCM.MTFTRADE.dbo.NCMS_POdet_morning    
 --Exec angelcommodity.inhouse_NCDX.dbo.NCMS_POdet_Morning                                                                                        
 --Exec angelcommodity.inhouse_MCDX.dbo.NCMS_POdet_Morning    
 --exec angelcommodity.bsefo.dbo.NCMS_POdet_Morning
 --Exec angelcommodity.INHOUSE_NCE.dbo.NCMS_POdet_Morning


                                         
 /*Fetch Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/
 truncate table NCMS_Intraday_loss
 
 insert into NCMS_Intraday_loss
 exec AngelNseCM.msajag.dbo.Intraday_loss
/****************/
                                               
 /* FETCH DATA */                                              
 select id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_Broker                                              
 into #NCMS_SegwiseCldata from NCMS_SegwiseCldata where 1=2                                                                                    
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','BSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                               
 from AngelBSECM.inhouse.dbo.NCMS_PO with(nolock)                                             
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */                                             
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','NSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                               
 from AngelNseCM.inhouse.dbo.NCMS_PO with(nolock)                                              
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */  
 
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','MTF',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr 
 /*0,0,0,0,0,0,0,0,0,0,0,0,0,0,0*/
 from AngelNseCM.MTFTRADE.dbo.NCMS_PO with(nolock)    
  
 insert into #NCMS_SegwiseCldata  
 (ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','NSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelfo.inhouse.dbo.NCMS_marh  with(nolock)                          
 /* where PayoutValue <> 0 */  
 
 /*******BSEFO***********************/
   insert into #NCMS_SegwiseCldata    
 (ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                
 select UpdDatetime,'AllSegment','BSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                 
 from angelcommodity.bsefo.dbo.NCMS_marh  with(nolock)  
 /*****************************/
                                               
insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                             
 select UpdDatetime,'AllSegment','NSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelfo.inhouse_curfo.dbo.NCMS_marh with(nolock)                                              
 /* where PayoutValue <> 0 */   
 
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                             
 select UpdDatetime,'AllSegment','BSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.inhouse_bsx.dbo.NCMS_marh  with(nolock)  
                                       
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','MCD',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.INHOUSE_MCDCS.dbo.NCMS_marh  with(nolock)                                             
 /* where PayoutValue <> 0 */      
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','NCDEX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.inhouse_NCDX.dbo.NCMS_marh  with(nolock)                                             
 /* where PayoutValue <> 0 */      
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','MCX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.inhouse_MCDX.dbo.NCMS_marh with(nolock)                                              
 /* where PayoutValue <> 0 */      

  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select UpdDatetime,'AllSegment','NCE',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                               
 from angelcommodity.INHOUSE_NCE.dbo.NCMS_marh with(nolock)    
                                               
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','BSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,AfterAdjustedBal/*VBal+UCV+UnRecoCr+OtherDr */        
 from /*angelfo.inhouse.dbo.NCMS_PO_BSEMFSS*/   angelfo.inhouse.dbo.NCMS_PO_BSEMFSS_edt with(nolock)                                 
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */      
                                            
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select ProcessDatetime,'AllSegment','NSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                     
 from angelfo.inhouse.dbo.NCMS_PO_NSEMFSS  with(nolock)                                             
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */      
                                     
 --insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                         
 --Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 --select ProcessDatetime,'AllSegment','IPO',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                               
 --from NCMS_PO_IPO with(nolock)                                       
 /* where VBal+UCV+UnRecoCr+OtherDr <> 0 */      
                                           
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                              
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                              
 select processDate,'NBFC','NBFC',party_Code,'I',ActualLedger,Unsettled,0,ShortValHC,0,0,0,VAHC,0,0,AccruedInt,ShortVal,0,0,NetAmount                                           
 from [ABVSCITRUS].inhouse.dbo.ncms_po with(nolock)/* where netAmount <> 0 */      
  
     CREATE CLUSTERED INDEX IDX_CLGRPSER_Party ON #NCMS_SegwiseCldata(party_code ASC,Segment)
	 
delete from #NCMS_SegwiseCldata where party_code in (Select party_code from cms.dbo.NCMS_Commodity_clients where 
 CAST(updatedOn as date)=CAST(GETDATE() as date) )

select * into #final_Auto from cms.dbo.mtf_net_position	 where 1=2

--if(select COUNT(1)  from cms.dbo.mtf_net_position with(nolock)  where CAST(published_date as date)=CAST(GETDATE() as date)      
--and release_mode='post-release')>0
--begin
--	insert into #final_Auto
--	select *  from cms.dbo.mtf_net_position  with(nolock) where CAST(published_date as date)=CAST(GETDATE() as date) 
--	and release_mode='post-release'
--end
--else
--begin
	insert into #final_Auto
	select *   from cms.dbo.mtf_net_position  with(nolock)  where CAST(published_date as date)=CAST(GETDATE() as date) 
	and release_mode='Pre-release'
--end

--select * into #final_Auto from mtf_autorelease_new where CAST(released_date as date)=CAST(GETDATE() as date) --and is_file_generated=1     

  
select distinct party_code,isnull(purchase_value,0) as purchase_value,isnull(mtf_margin,0) as mtf_margin into #MTFReleased
from #final_Auto    

 /**************************************/
 select a.PARTY_CODE,(OTHER_DEBIT*-1) as OTHER_DEBIT into #AccCharges from cms.dbo.tbl_other_debit a with (nolock)

 select a.PARTY_CODE,DeductEQ=sum(a.OTHER_DEBIT),DeductComm=0.00 into #Accrued1
 from #AccCharges a with (nolock)
 group by a.PARTY_CODE 

 insert into  #Accrued1
 select party_code,DeductEQ=Balance,DeductComm=0.00 from  cms.dbo.NCMS_WO_Master with(nolock) /*Added for W/O Margin on 16 Nov 2021*/   

  select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                         

 /**************************************/
                                               
 update #NCMS_SegwiseCldata set AccruedCharges=-Accured,NetPayable=NetPayable-Accured                                              
 from                                              
 (                                              
  select q.segment,q.party_code,                                              
  (Case when q.entity='AllSegment' then DeductEQ else DeductComm end) as Accured                                              
  from #Accrued p join                                               
  (                                              
  select x.*,y.segment from                                              
  (                                              
  select a.entity,party_Code,min(b.seqid) as seqid                                              
  from #NCMS_SegwiseCldata a join cms.dbo.ncms_entity b on a.segment=b.segment                                               
  group by a.entity,party_Code                                              
  ) x join cms.dbo.ncms_entity y with(nolock) on x.seqid=y.seqid and x.entity=y.entity                                              
  ) q on p.party_Code=q.party_Code                                               
 ) AC                                              
 where #NCMS_SegwiseCldata.party_code=AC.party_Code and #NCMS_SegwiseCldata.segment=AC.Segment                                              
 and #NCMS_SegwiseCldata.segment <> 'NBFC'                                      
                                               
                                               
 /* Check Valid Client */                                              
       /****Adding Sub_broker on 16 Feb 2022**/
 UPDATE #NCMS_SegwiseCldata SET FLAG='V',sub_BRoker=b.sub_broker  from  cms.dbo.NCMS_ClientDetails b  with(nolock)                                              
 where #NCMS_SegwiseCldata.party_code=b.party_code   
 
 /********START: Added on 21 Nov 2017 As per mail of Prakash by Neha(For adding MF Codes)*************************/
select m.party_code into #MFSSCodes from angelfo.bsemfss.dbo.mfss_client m with(nolock) left join  cms.dbo.NCMS_ClientDetails cd with(nolock)
on m.party_code=cd.party_code
where m.inactive_from>GETDATE() and cd.party_code is null  

 UPDATE #NCMS_SegwiseCldata SET FLAG='V' from #MFSSCodes b                                               
 where #NCMS_SegwiseCldata.party_code=b.party_code                                         
 /********END:****************************************************************************************************/                                           
                                               
 UPDATE #NCMS_SegwiseCldata SET FLAG='X' from cms.dbo.pARTY_cms_BLOCKED b   with(nolock)                                             
 where #NCMS_SegwiseCldata.party_code=b.party_code                                     
                                             
 --UPDATE #NCMS_SegwiseCldata SET FLAG='I' from /*risk.dbo.client_Details*/ NCMS_ClientDetails b with(nolock)                                               
 --where #NCMS_SegwiseCldata.party_code=b.party_code and left(b.party_Code,2)='ZR'   
 
 /***SRE - 37292*** blocking FN clients**/
 UPDATE a SET FLAG='I' from #NCMS_SegwiseCldata a ,cms.dbo.NCMS_ClientDetails b                                              
 where a.party_code=b.party_code and  ltrim(rtrim(b.cl_type))='NRI' and b.sub_broker not in ('NKAB', 'NK', 'BH', 'BHKWT')

 UPDATE a SET FLAG='I' from #NCMS_SegwiseCldata a , cms.dbo.NCMS_ClientDetails b                                              
 where a.party_code=b.party_code and  ltrim(rtrim(b.cl_type))='FN' and b.sub_broker not in ('NKAB', 'NK', 'BH', 'BHKWT')
 
 UPDATE #NCMS_SegwiseCldata SET FLAG='B' from cms.dbo.tbl_manualbill_mark b  with(nolock)                                              
 where #NCMS_SegwiseCldata.party_code=b.partycode and b.PayoutType='B'                                             
    

update #NCMS_SegwiseCldata     
set NetPayable=NetPayable-b.BillAmt,UnsettledCrBill=UnsettledCrBill-b.BillAmt     
from (select Party_code,Segment,sum(BillAmt) as BillAmt from cms.dbo.NCMS_B2B_PO_Request with (nolock) where billamt > 0 group by Party_code,Segment) b    
where #NCMS_SegwiseCldata.party_code=b.Party_code and #NCMS_SegwiseCldata.segment=b.Segment     
and #NCMS_SegwiseCldata.flag='B'    
                     
 UPDATE a                                                  
 set NetPayable = UnrecoAmt+AccruedCharges                      
 FROM #NCMS_SegwiseCldata a                                       
 JOIN                                                  
 (select Party_code from /*risk.dbo.client_Details*/ cms.dbo.NCMS_ClientDetails  with(nolock) where cl_type in ('NBF','TMF')) b                                       
 ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                          
                                                 
 /* Update Shortage Value */                                              
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                                              
(select seg+'CM' as seg,party_code,shrtval=SUM(NetShortValue) from cms.dbo.ncms_shortsell  with(nolock) group by seg,party_Code having sum(NetShortValue) <> 0) b                
 where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.party_Code                                              
 
 /*update net basis of Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/
 
  update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.loss ,OtherDebit=OtherDebit-b.loss from                                              
 (select party_code,loss,exchange+'CM' as segment from cms.dbo.NCMS_Intraday_loss with(nolock)) b                                              
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0 and NetPayable>0 
 

  DECLARE @MARGINDATE AS DATETIME         
SELECT @MARGINDATE=MAX(MARGIN_DATE) FROM AngelNseCM.msajag.dbo.tbl_mg02 WITH (NOLOCK) 

select a.*,convert(money,varamt/abs(netqty)) as pershare,b.short_qty  into #data from AngelNseCM.msajag.dbo.tbl_mg02 a with(nolock)  join cms.dbo.ncms_shortsell b with(nolock) on a.party_code=b.PARTY_cODE and a.scrip_cd=b.SCRIP_CD
	and a.sett_no=b.sett_no where /* a.party_code='A2649' and*/
	  MARGIN_DATE=@MARGINDATE and ABS(netqty)<>0
  
  	 select convert(money,pershare*short_qty) as varmargin ,party_code,scrip_cd,sett_no into #margin from #data

  
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.varmargin,NetPayable=NetPayable-b.varmargin from                                                
 (select 'NSECM' as segment,party_code,varmargin=SUM(varmargin) from #margin /* where party_code='A2649'*/
 group by party_Code having sum(varmargin) <> 0) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0  

  --update a set OtherDebit=OtherDebit-TotalReleaseValue from #NCMS_SegwiseCldata a join #MTFReleased b on a.party_code=b.party_code  
  --where segment='MTF' 
    update a set OtherDebit=OtherDebit-mtf_margin from #NCMS_SegwiseCldata a join #MTFReleased b on a.party_code=b.party_code  
  where segment='MTF' 

  update a set Deposit=Deposit+purchase_value from #NCMS_SegwiseCldata a join #MTFReleased b on a.party_code=b.party_code  
  where segment='MTF' 
 /***********************End****************************************/  
 truncate table NCMS_SegwiseCldata_stg

 insert into NCMS_SegwiseCldata_stg (ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_broker)
 select ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,
 NetPayable,Sub_broker from dustbin.dbo.NCMS_SegwiseCldata where party_code in (Select party_code from
 cms.dbo.NCMS_Commodity_clients where CAST(updatedOn as date)=CAST(GETDATE() as date))
 
 delete from #NCMS_SegwiseCldata where party_code in (Select party_code from cms.dbo.NCMS_Commodity_clients
  where CAST(updatedOn as date)=CAST(GETDATE() as date))

 Truncate table  dustbin.dbo.NCMS_SegwiseCldata                                              
 insert into NCMS_SegwiseCldata (ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_broker)                                              
 select ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                  
 NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_broker                                     
 from #NCMS_SegwiseCldata  with(nolock) where Flag <> 'I'  and party_code not in 
 (Select party_code from cms.dbo.NCMS_Commodity_clients  where CAST(updatedOn as date)=CAST(GETDATE() as date))                                            

  
 /************Added for merge all segment***********************************************/
 select * into #new_NCMS_SegwiseCldata from #NCMS_SegwiseCldata  with(nolock) where Flag <> 'I' 

   update #new_NCMS_SegwiseCldata set Balance=0.00,UnsettledCrBill=0.00 where NetPayable=0 and Segment='BSEMFSS'  
  update #new_NCMS_SegwiseCldata  set UnsettledCrBill=0.00 where  Segment='BSEMFSS'  and  NetPayable>0  and UnsettledCrBill<0  
   update #new_NCMS_SegwiseCldata set OtherDebit=0 where Segment='MTF'
update  #new_NCMS_SegwiseCldata set Balance=NetPayable where Balance=0 and AccruedCharges=0 and marginamt=0 and segment='bsemfss' and NetPayable<0  
    
 select max(ProcessDate) ProcessDate,Entity,Party_code,Flag,sum(Balance)Balance,sum(UnsettledCrBill) UnsettledCrBill,sum(UnrecoAmt) UnrecoAmt,    
 sum(ShortSellValue) ShortSellValue,sum(MarginAmt) MarginAmt,SUM(deposit) Deposit,sum(CashColl)CashColl,sum(NonCashColl) NonCashColl,    
 sum(MarginAdjWithColl) MarginAdjWithColl,sum(MarginShortage) MarginShortage,sum(AccruedCharges) AccruedCharges,sum(OtherDebit) OtherDebit,    
 max(100) NonCashConsideration--,SUM(ExpoUtilised) as ExpoUtilised,sum(NetPayable) NetPayable  
 ,case when entity='AllSegment' then 0.00 else SUM(ExpoUtilised) end as ExpoUtilised,  
 case when entity='AllSegment' then 0.00 else sum(NetPayable) end NetPayable,Sub_Broker  
 into #ncms    
 from  #new_NCMS_SegwiseCldata  
 group by Entity,Party_code,Flag,Sub_Broker                                                  
												
  
 update #ncms set ExpoUtilised=ExpoUtilised+    
 (case       
 when  noncashcoll=0 then   MarginAmt       
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0           
 then 0             
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll     
 end)     
 /*,marginAdjustWithCombineLgr=isnull(marginAdjustWithCombineLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3    
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  */   /*added on 08 Oct 2021 by Neha naiwar*/  
 from #ncms where entity='AllSegment'  
   
 update #ncms set NetPayable=Balance+ExpoUtilised+/*marginAdjustWithCombineLgr+*/UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges+OtherDebit   
  where entity='AllSegment' 

  -- update a set NetPayable=NetPayable-TotalReleaseValue from #ncms a join #MTFReleased b on a.party_code=b.party_code  
  --where entity='AllSegment'  
  update a set NetPayable=NetPayable+purchase_value-mtf_margin from #ncms a join #MTFReleased b on a.party_code=b.party_code  
  where entity='AllSegment'  

  truncate table NCMS_EntityDataView_combine_stg
  insert into NCMS_EntityDataView_combine_stg(  ProcessDate,Entity,sub_Broker,party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)
  select  ProcessDate,Entity,sub_Broker,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                             
  from dustbin.dbo.NCMS_EntityDataView_combine where  party_code in (Select party_code from cms.dbo.NCMS_Commodity_clients
   where CAST(updatedOn as date)=CAST(GETDATE() as date)) 

  truncate table dustbin.dbo.NCMS_EntityDataView_combine  
 insert into dustbin.dbo.NCMS_EntityDataView_combine                                            
  (                                             
  ProcessDate,Entity,sub_Broker,party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable
  )                                              
  select                       
  ProcessDate,Entity,sub_Broker,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                             
  from #ncms    
 /********************************************************/

 insert into dustbin.dbo.NCMS_SegwiseCldata (ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_broker)                                              
 select ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                  
 NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,Sub_broker                                     
 from NCMS_SegwiseCldata_stg  with(nolock) where party_code in (Select party_code from cms.dbo.NCMS_Commodity_clients
   where CAST(updatedOn as date)=CAST(GETDATE() as date))  

  insert into dustbin.dbo.NCMS_EntityDataView_combine                                            
  (                                             
  ProcessDate,Entity,sub_Broker,party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable
  )                                              
  select                       
  ProcessDate,Entity,sub_Broker,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                             
  from NCMS_EntityDataView_combine_stg  where party_code in (Select party_code from cms.dbo.NCMS_Commodity_clients 
   where CAST(updatedOn as date)=CAST(GETDATE() as date))  
 
 
End try                                                   
                                                  
BEGIN CATCH                                                      
                                                  
   insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                            
   select GETDATE(),'NCMS_Calculation_Equity',ERROR_LINE(),ERROR_MESSAGE()                                                            
                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                        
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                        
  RAISERROR (@ErrorMessage , 16, 1);                              
                                                                       
End catch                                         
                                              
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_Cancel_SPARK_26Jan2024
-- --------------------------------------------------
  
create procedure [dbo].[NCMS_Cancel_SPARK_26Jan2024](@id as int,@user as varchar(10),@ip as varchar(15))                             
as                         
set nocount on    
   declare  @err as varchar(100)=''     
   
 if(select COUNT(1) from ncms_po_request with(nolock) where Party_code=@user and POrequestID=@id and PO_Statusid in (0,5)  )>0  
 Begin  
 insert into NCMS_PO_Cancel(POrequestID,Userid,UpdatedOn,IP_Address)    
 select @id,@user, GETDATE(),@ip    
 update ncms_po_request     
 set PO_Statusid=6    
 where ncms_po_request.Party_code=@user and ncms_po_request.POrequestID=@id    
 and ncms_po_request.PO_Statusid in (0,5)    
 End  
 else  
 begin  
      set @err='Not_Cancel'    
    Raiserror(@err, 16, 1)    
 end  
    
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_CombinePO_Update_19Dec2023
-- --------------------------------------------------
create proc [dbo].[NCMS_CombinePO_Update_19Dec2023]
As
begin

 select  ROW_NUMBER() OVER ( ORDER BY srno ) as srno1 ,* into #NCMS_APPAMT1 from NCMS_PartialPayout with(nolock) where POSTATUS=4 

	  DECLARE @CTR AS INT = 1,@TOTCTR AS INT =0   ,@STR as VARCHAR(2000) = ''                                             
                                                
  SELECT @TOTCTR = COUNT(1) FROM #NCMS_APPAMT1                                                
                                                    
  WHILE @CTR <= @TOTCTR                                                    
  BEGIN                                                    
                                                
  set @STR=''  
  
    declare @POveriID as int,@PARTY_CODE AS VARCHAR(10)='',@ENTITY AS VARCHAR(10)='',@Req_RefNo AS VARCHAR(25)='',@Child_Refno  AS VARCHAR(25)=''
	DECLARE @ApprovedAmt AS MONEY=0,@POSTATUS AS INT =0,@CF_ReqAmt money = 0,@Remarks as varchar(100)='',@CFminAMT money = 1                                                     

	
  SELECT @POveriID=POveriID,@PARTY_CODE=PARTY_CODE,@ENTITY=ENTITY,@Req_RefNo=Req_RefNo,                                              
  @ApprovedAmt=convert(decimal(20,2),ApprovedAmt),@POSTATUS=POSTATUS,                                              
  @CF_ReqAmt=(Case when PO_Request-convert(decimal(20,2),ApprovedAmt) > @CFminAMT then PO_Request-convert(decimal(20,2),ApprovedAmt) else 0 end)                                               
  FROM #NCMS_APPAMT1 WHERE SRNO1=@CTR                                  
    
  /*Added On 08 July 2017*/  
  select @Remarks=remarks from ncms_po_request_View with (nolock) where Req_RefNo=@Req_RefNo and Entity=@ENTITY and Party_code=@PARTY_CODE   
  /******End*****************/                                        
  --IF @POSTATUS=3                                                
  --BEGIN                                                
  --SET @POSTATUS=0                                                
  --END                                                
     
  IF (@POSTATUS=4 and @CF_ReqAmt > 0)                                                
  BEGIN   
    
       If(@Remarks<>'T'/*'T+2'*/)   
       begin                                         
     select @str='EXEC NCMS_UPD_Request_forPartialRequest '''+Party_code+''','''+req_ip+''','''+Req_user+'-S'','+                                                
     (Case when Entity='AllSegment' then convert(varchar(25),convert(decimal(15,2),/*PO_Request-@ApprovedAmt*/@CF_ReqAmt)) else '0' end)+','+                                                
     (Case when Entity='Commodity' then convert(varchar(25),convert(decimal(15,2),0)) else '0' end)+','+                                           
     (Case when Entity='NBFC' then convert(varchar(25),convert(decimal(15,2),/*PO_Request-@ApprovedAmt*/ @CF_ReqAmt)) else '0' end)                                                
     +','''+Req_PayBAnkId+''','''+Req_PayBAnkId+''','''+Req_PayBAnkId+''','''+requestType+''','''+remarks+''''                                                
     from ncms_po_request_View with (nolock)                                                 
     where Req_RefNo=@Req_RefNo and Entity=@ENTITY and Party_code=@PARTY_CODE    
    end  
    /*Added On 08 July 2017*/  
    else  
    begin  
   select @str='EXEC NCMS_UPD_Request_AE_Partial_PO '''+Party_code+''','''+req_ip+''','''+Req_user+'-S'','+                                                
     (Case when Entity='AllSegment' then convert(varchar(25),convert(decimal(15,2),/*PO_Request-@ApprovedAmt*/ @CF_ReqAmt)) else '0' end)+','+                                                
   (Case when Entity='Commodity' then convert(varchar(25),convert(decimal(15,2),0)) else '0' end)+','+                                             
     (Case when Entity='NBFC' then convert(varchar(25),convert(decimal(15,2),/*PO_Request-@ApprovedAmt*/ @CF_ReqAmt)) else '0' end)                                                
     +','''+Req_PayBAnkId+''','''+Req_PayBAnkId+''','''+Req_PayBAnkId+''','''+requestType+''','''+remarks+''''                                                
     from ncms_po_request_View with (nolock)                                                 
     where Req_RefNo=@Req_RefNo and Entity=@ENTITY and Party_code=@PARTY_CODE   
    end   
    /**************End*/                                             
  END                   
                                                     
  EXEC NCMS_UPDATE_STATUS_WithCombine @PARTY_CODE,@Req_RefNo,@ENTITY,@POSTATUS,@POveriID,@ApprovedAmt    
 -- PRINT(@STR)                                                   
  EXEC(@STR)                                                
  
   select @Child_Refno=child_refno from NCMS_Child_Refno where party_code=@PARTY_CODE

   exec NCMS_UPDATE_ChildID @PARTY_CODE,@Req_RefNo,@ENTITY,@Child_Refno

   --update NCMS_PO_Request set ParentChildID=@Child_Refno where Party_code=@PARTY_CODE and Req_RefNo=@Req_RefNo and ParentChildID is null
   --and PO_Statusid=4

  set @ctr=@ctr+1                                                    
                                          
  END 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_FetchClient_ForRealPO_17Oct2023
-- --------------------------------------------------
-- =============================================  
-- Author:  Neha Naiwar  
-- Create date: 12 July 2022  
-- =============================================  
create PROCEDURE [dbo].[NCMS_FetchClient_ForRealPO_17Oct2023]  
As   
Begin  
   
  /* select a.* into #newdata from Vw_NCMSPayoutMergingView a with(nolock) ,NCMS_EntityDataView_combine b with(nolock)    
 where a.PARTY_CODE=b.Party_code   and  
    req_datetime>=(dateadd(day, datediff(day, 0, getdate()), 0) + '9:51')  order by req_datetime  
 */  
 select distinct  POrequestID,Party_code,Net_payable,PO_Request,Req_PayBankId,entity,RequestType,Req_RefNo,Req_datetime into #Payout_Request from  
 ncms_po_request with(nolock) where po_statusid=0  
  
 select a.* into #newdata from #Payout_Request a with(nolock) ,NCMS_EntityDataView_combine b with(nolock)    
 where a.PARTY_CODE=b.Party_code   and  
    req_datetime>=(dateadd(day, datediff(day, 0, getdate()), 0) + '9:51')  order by req_datetime  
  
 select a.* into #Po from #newdata a,NCMS_EntityDataView_combine b   where  a.PARTY_CODE=b.Party_code and  b.marginamt=0 and b.netpayable>0  
  
   select * into #payout from #Po where party_code not in (select party_code from NCMS_RealPayout where status='NotForRealPO')  
  
   Delete from #payout  where  party_code in (select party_code from NCMS_RealPayout where validationtxt='NOT_OK')  
   Delete from #payout  where  party_code in (select party_code from ncms_po_request with(nolock) where po_statusid=7)  
    
/*  
insert into NCMS_RealPayout_hist  
select * from NCMS_RealPayout  
select distinct status from NCMS_RealPayout  
truncate table NCMS_RealPayout where status='Done'  
*/  
 insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,1,'','',GETDATE(),'','',''  
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=1)      
   group by PARTY_CODE,POrequestID,Req_datetime    
  
 insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,2,'','',GETDATE(),'','',''  
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=2)      
   group by PARTY_CODE,POrequestID,Req_datetime  
  
 insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,3,'','',GETDATE(),'','',''  
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=3)      
   group by PARTY_CODE,POrequestID,Req_datetime  
  
 insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,4,'','',GETDATE(),'','',''      
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=4)      
   group by PARTY_CODE,POrequestID,Req_datetime   
  
 insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,6,'','',GETDATE(),'','',''    
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=6)      
   group by PARTY_CODE,POrequestID,Req_datetime  
  
 insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,7,'','',GETDATE(),'','',''    
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=7)      
   group by PARTY_CODE,POrequestID,Req_datetime  
  
insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,8,'','',GETDATE(),'','',''    
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=8)      
   group by PARTY_CODE,POrequestID,Req_datetime  
  
insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,9,'','',GETDATE(),'','',''    
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=9)      
   group by PARTY_CODE,POrequestID,Req_datetime  
  
insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,104,'','',GETDATE(),'','',''    
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=104)      
   group by PARTY_CODE,POrequestID,Req_datetime  
  
insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,106,'','',GETDATE(),'','',''    
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=106)      
   group by PARTY_CODE,POrequestID,Req_datetime  
  
   insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,102,'','',GETDATE(),'','',''    
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=102)      
   group by PARTY_CODE,POrequestID,Req_datetime  
  
      insert into NCMS_RealPayout(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
   select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,108,'','',GETDATE(),'','',''    
     from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=108)      
   group by PARTY_CODE,POrequestID,Req_datetime  
       
;WITH CTE AS  
(  
   SELECT party_code,porequestid,po_request,  
       RN = ROW_NUMBER()OVER(PARTITION BY porequestid,party_code ORDER BY  porequestid,party_code)  
   FROM NCMS_RealPayout  
)  
delete from CTE WHERE RN > 1 ;  
  
select * from NCMS_RealPayout where status='' and  Req_datetime>=(dateadd(day, datediff(day, 0, getdate()), 0) + '9:51')  -- where party_code in ('Y9901')    
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_FlexiPO_14Dec2023
-- --------------------------------------------------
create Procedure [dbo].[NCMS_FlexiPO_14Dec2023]
as
set nocount on


declare @PrevDayPOdt as datetime
select @PrevDayPOdt =StartDate from ncms_batch_process where Srno=1
select @PrevDayPOdt =max(StartDate) from NCMS_Batch_Process_log where startDate < (select MIN(ProcessDate) from NCMS_SegwiseCldata with (nolock)) and Srno=1


/* Prev.Day Partial Payout only without Full PO Request */
select a.* into #CF from
(select * from NCMS_PO_Request where POdt_request < @PrevDayPOdt and remarks not like '%expired%' and RIGHT(req_USer,2)='-S'
) a left outer join
(select * from NCMS_PO_Request where POdt_request < @PrevDayPOdt and remarks not like '%expired%' and RIGHT(req_USer,2)<>'-S') b
on a.party_code=b.party_Code and a.Entity=b.Entity
and b.Party_code is null

/* Prev.Day Full Payout REquest without any partial PO processed*/
insert into #CF 
select a.* from
(select * from NCMS_PO_Request where POdt_request < @PrevDayPOdt and remarks not like '%expired%' and RIGHT(req_USer,2)<>'-S'
) a left outer join
(select * from NCMS_PO_Request where POdt_request < @PrevDayPOdt and remarks not like '%expired%' and RIGHT(req_USer,2)='-S') b
on a.party_code=b.party_Code and a.Entity=b.Entity
and b.Party_code is null

/* Current DAte All Payout REquest */
/*
insert into #cf
select * from NCMS_PO_Request where POdt_request >= @PrevDayPOdt and remarks not like '%expired%' 
*/
insert into #CF 
select * from NCMS_PO_Request where POdt_request >= @PrevDayPOdt and remarks not like '%expired%' and RIGHT(req_USer,2)<>'-S'


/* Flexi Data */
if((CONVERT(VARCHAR(5),GETDATE(),108)>='16:30') and (CONVERT(VARCHAR(5),GETDATE(),108)<='21:59'))      
Begin   
	truncate table NCMS_FLEXIDATA
	insert into NCMS_FLEXIDATA
	Select GETDATE() AS CURRDATE,POrequestID AS POrequestID,PARTY_CODE,ENTITY      
	FROM
	(
	
		select       
		POrequestID,      
		PARTY_CODE,ENTITY,a.PO_Statusid from #cf a WITH (NOLOCK)           
		join          
		(SELECT PO_Statusid FROM NCMS_POstatus where ConsForFlexi =1) b          
		on isnull(a.PO_Statusid,0) =b.PO_Statusid           
		where req_paymode='NEFT' and req_datetime<=(dateadd(day, datediff(day, 0, getdate()), 0) + '17:35')   
	
	
	) X

End
Else
begin
	truncate table NCMS_FLEXIDATA
	insert into NCMS_FLEXIDATA
	Select GETDATE() AS CURRDATE,POrequestID AS POrequestID,PARTY_CODE,ENTITY      
	FROM
	(
	
		select       
		POrequestID,      
		PARTY_CODE,ENTITY,a.PO_Statusid from #cf a WITH (NOLOCK)           
		join          
		(SELECT PO_Statusid FROM NCMS_POstatus where ConsForFlexi =1) b          
		on isnull(a.PO_Statusid,0) =b.PO_Statusid           
		where req_paymode='NEFT'
	
	
	) X
end
insert into #CF 
select * from NCMS_PO_Request where POdt_request >= @PrevDayPOdt and remarks not like '%expired%' and RIGHT(req_USer,2)='-S'

/* Payout Data */
  insert into  NCMS_PAYOUTDATA_hist
  select * ,GETDATE() from NCMS_PAYOUTDATA with(nolock)

if((CONVERT(VARCHAR(5),GETDATE(),108)>='16:30') and (CONVERT(VARCHAR(5),GETDATE(),108)<='21:59'))      
Begin 

	truncate table NCMS_PAYOUTDATA
	insert into NCMS_PAYOUTDATA
	Select GETDATE() AS CURRDATE,POrequestID AS POrequestID,PARTY_CODE,ENTITY      
	FROM #cf where po_statusid=0 -- and   req_datetime<='2023-07-01 08:30:00.00' 
end
else
begin
	truncate table NCMS_PAYOUTDATA
	insert into NCMS_PAYOUTDATA
	Select GETDATE() AS CURRDATE,POrequestID AS POrequestID,PARTY_CODE,ENTITY      
	FROM #cf where po_statusid=0  and req_datetime<=(dateadd(day, datediff(day, 0, getdate()), 0) + '17:35')   
end

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_ForRealTime_PO_Exe
-- --------------------------------------------------
-- Author:  Neha Naiwar      
-- Create date: 14 July 2022      
-- Description: For Real Time Payout     
-- =============================================        
create Procedure [dbo].[NCMS_ForRealTime_PO_Exe]                         
as                            
   
-- RETURN 0

set nocount on                            
                         
DECLARE @XACT_ABORT VARCHAR(3) = 'OFF',@XactChg varchar(3) ='No';                            
IF ( (16384 & @@OPTIONS) = 16384 ) SET @XACT_ABORT = 'ON';                            
if @XACT_ABORT='OFF'                            
Begin                            
 SET XACT_ABORT ON                            
 set @XactChg='Yes'                            
End      


insert into NCMS_RealTimeProcess_log(SP,UpdatedOn)
select 'NCMS_ForRealTime_PO_Exe',GETDATE()

create table #File1    
(Ctr int ,Srno int,ProcedureName varchar(200),Active_Status int ,StartDate datetime,EndDate datetime,Flag int,spdesc varchar(200),    
Errflag varchar(200),section int)    
    
truncate table #File1     
       
 insert into #File1                       
 select ROW_NUMBER() OVER ( ORDER BY srno ) AS [Ctr],                
 Srno,ProcedureName,Active_Status,StartDate,EndDate,Flag,spdesc,Errflag,section                
 from ncms_batch_process_Forrealtime_PO where active_Status=1 and flag=0                     
  
declare @totctr as int = 0,@ctr as int = 1, @str as varchar(2000),@srno as int,@spname as varchar(200)                            
                
select @totctr=MAX(Ctr) from #file1                            
While @ctr <= @totctr                            
Begin                            
 set @str = ''                            
 select @srno=srno,@str='exec '+procedurename,@spname=procedurename from #File1 where ctr=@ctr                            
 Begin Try                            
  update ncms_batch_process_Forrealtime_PO set StartDate=GETDATE(),errflag='' where srno=@srno                            
   exec(@str)                               
          
  if @srno < (select MAX(srno) from ncms_batch_process_Forrealtime_PO)     
  update ncms_batch_process_Forrealtime_PO set EndDate=GETDATE(),Flag=1 where srno=@srno        
  else      
  update ncms_batch_process_Forrealtime_PO set EndDate=GETDATE() where srno=@srno            
          
 End Try                            
 Begin Catch                            
                  
  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                    
  select GETDATE(),@spname,ERROR_LINE(),ERROR_MESSAGE()                     
                    
  update ncms_batch_process_Forrealtime_PO set errflag='<font color="red">Error</font>' where Srno=@srno                      
                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                        
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                        
  RAISERROR (@ErrorMessage , 16, 1);                               
                            
  RETURN                            
                              
 End Catch                            
 set @ctr=@ctr+1                            
End                            
                            
if @XactChg='Yes'                            
Begin                            
 SET XACT_ABORT OFF                            
end                            
                            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_HDFCBankFileGeneration_For_HDFCAcconts
-- --------------------------------------------------
CREATE procedure [dbo].[NCMS_HDFCBankFileGeneration_For_HDFCAcconts]                                      
as                                      
Set nocount on                                                          
SET XACT_ABORT ON                                                            
BEGIN TRY                                                                  
 
 --insert into NCMS_BANKfile_DetailData_hdfc_hist
 --select *,GETDATE() from NCMS_BANKfile_DetailData_hdfc

truncate table NCMS_BANKfile_DetailData_hdfc
                          
select ROW_NUMBER() OVER ( ORDER BY segment ) AS [SrNo],segment  as segment                         
into #CtrFile                                      
from cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc  with(nolock) where segment='NSECM'

                                      
Declare @ctr int = 1,@totctr int = 0,@segment as varchar(10) = '',@batid as char(4) = ''                                      
select @totctr=MAX(srno) from #CtrFile                                      
                                      
CREATE TABLE #HDFCdata                                      
(                                      
Content VARCHAR(8000),                                      
SegApprovedAmt MONEY,                                      
VerifierId INT                                      
)                                      
                          
select                                       
VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,PayMode,poid+4000000 as POid,Batchid                                      
into #NCMS_SegPayoutAppAmt                           
from NCMS_SegPayoutAppAmt where 1=2 

                         
select                                       
VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,PayMode,poid+4000000 as POid,Batchid                                      
into #NCMS_SegPayoutAppAmt_Bill                           
from NCMS_SegPayoutAppAmt where 1=2                                      
                                      
WHILE @ctr <= @totctr                                      
BEGIN                                      
     print @segment                                 
 select @segment=segment from  #CtrFile where srno=@ctr                                     
                                   
 TRUNCATE TABLE #HDFCdata                             
 TRUNCATE TABLE #NCMS_SegPayoutAppAmt
 TRUNCATE TABLE #NCMS_SegPayoutAppAmt_Bill        
 
                  
 update NCMS_SegPayoutAppAmt set Paymode='N06'--dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt)                           
 where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment                             
                          
 /*update NCMS_SegPayoutAppAmt set Paymode=dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt)                           
 where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment                           
  */                        
 insert into #NCMS_SegPayoutAppAmt                          
 select                                       
 a.VerifierId,a.Req_RefNo,a.Party_Code,a.Entity,a.Segment,a.SegApprovedAmt,a.Paymode,a.poid+4000000 as POid,Batchid                                       
 from NCMS_SegPayoutAppAmt a with(nolock) join NCMS_PO_Request c with(nolock) on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
  left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                      
 and c.Party_code=d.cltcode  and d.paymode='NEFT' where   d.bankname like 'HDFC%'  and  right(d.bankname,4) not LIKE '%[a-z][a-z]' and len(d.acno)=14 
  and SegApprovedAmt>0  and BANK_gen=0 and Segment=@segment and ODIN_gen=0 

   /*******For Withdraw2*****************************************/
     
insert into #NCMS_SegPayoutAppAmt                                                
 select                                                             
 a.VerifierId,a.Req_RefNo,a.Party_Code,a.Entity,a.Segment,a.SegApprovedAmt,Paymode,POid                      
 ,Batchid                                                             
 from NCMS_SegPayoutAppAmt a join temp_withdraw2 b on a.Party_Code=b.Party_Code and a.Req_RefNo=b.Req_RefNo                                                             
 where a.SegApprovedAmt>0 and BANK_gen=0 and a.Segment=@segment and a.ODIN_gen=2 and 
 convert(date,ProcessDateTime)>= CONVERT(date,GETDATE()) and
 b.Bank_Provider='HDFC' and a.ODIN_gen=2

select c.*,branch_cd,sub_broker,long_name into #HD from  temp_withdraw2 c left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client d with(nolock) on                                                           
c.Party_code=d.party_code where c.Bank_Provider='HDFC' 
 
 /*******************************/
  
   insert into #NCMS_SegPayoutAppAmt_Bill                          
 select    distinct                          
 a.VerifierId,a.Req_RefNo,a.Party_Code,a.Entity,a.Segment,a.SegApprovedAmt,a.Paymode,a.poid+4000000 as POid,Batchid                                       
 from NCMS_SegPayoutAppAmt a with(nolock) join cms.dbo.NCMS_B2B_PO_Request c with(nolock) on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
  left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                      
 and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1  
 where   d.bankname like 'HDFC%' and  right(d.bankname,4) not LIKE '%[a-z][a-z]' and len(d.acno)=14       
  and SegApprovedAmt>0 and BANK_gen=0  and c.Segment=@segment and c.billamt>0                          
 
 --where ProcessDateTime>='2020-07-23 08:35:34.493'                                  
 --and SegApprovedAmt>0  and Segment='bsecm'                           
 update #NCMS_SegPayoutAppAmt set Paymode='N06' where paymode is null 
                    
 delete from    #NCMS_SegPayoutAppAmt where paymode is null                         
 
 --declare @segment varchar(50)= 'BSECM'                                  
 if (select COUNT(1) from #NCMS_SegPayoutAppAmt)>0
 begin   
	if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)
	begin  
	INSERT INTO #HDFCdata     
   select Content=                                        
   'I,'+ case when @segment='BSECM' then 'RN1005'  
       when @segment='NSECM' then 'ACCT'  
       when @segment='NSEFO' then 'FOCL'  
       when @segment='MCX' then 'MXCL'  
       when @segment='NCDEX' then 'NCCL'  
       when @segment='NSX' then 'RN50996'  
     when @segment='BSEMFSS' then 'NGB88RBI' else '' end  
       /*when @segment='NSECM' then 'ACCT'  
       when @segment='NSECM' then 'ACCT'  
       when @segment='NSECM' then 'ACCT'*/  
     +','    
     +c.Req_PayBankId                                
     +','+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),SegApprovedAmt))))                  
     +','+ltrim(rtrim(convert(char(38),long_name)))+','+ltrim(rtrim(a.Party_Code))+','  
     +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address1)),35) ))                   
     +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address2)),35)))                    
     +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address3)),35)) )                          
     +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_city)),35))      )                     
     +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_zip)),35))        )             
     +',,'+ltrim(rtrim(convert(char(16),left(upper(a.poid),16))))/*ltrim(rtrim(a.Party_Code))+'IFT'+right(a.Req_RefNo,4 )*/ /*+a.Req_RefNo*/  
     +',,,,,,,,,'  
     + CONVERT(char(10),getdate(),103)                                                       
     +',,,,,,'   
     ,a.SegApprovedAmt,VerifierID                                                
   --a.SegApprovedAmt,VerifierId                              
   from                                        
   #NCMS_SegPayoutAppAmt a with(nolock)                                         
   join cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc b with(nolock) on a.segment=b.segment                                        
   join NCMS_PO_Request c with(nolock) on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                         
   left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                        
   and c.Party_code=d.cltcode  and d.paymode='NEFT'                                     
   left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e  with(nolock)                                     
   on a.Party_Code=e.party_code  where   d.bankname like 'HDFC%' 

		 INSERT INTO #HDFCdata   
		 select Content=                                      
		 'I,'+ case when @segment='BSECM' then 'RN1005'
				   when @segment='NSECM' then 'ACCT'
				   when @segment='NSEFO' then 'FOCL'
				   when @segment='MCX' then 'MXCL'
				   when @segment='NCDEX' then 'NCCL'
				   when @segment='NSX' then 'RN50996'
					when @segment='BSEMFSS' then 'NGB88RBI' else '' end
				   /*when @segment='NSECM' then 'ACCT'
				   when @segment='NSECM' then 'ACCT'
				   when @segment='NSECM' then 'ACCT'*/
			  +','  
			  +c.Accno                              
			  +','+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),a.SegApprovedAmt))))                
			  +','+ltrim(rtrim(convert(char(38),long_name)))+','+ltrim(rtrim(a.Party_Code))+','
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address1)),35) ))                 
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address2)),35)))                  
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address3)),35)) )                        
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_city)),35))      )                   
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_zip)),35))        )           
			  +',,'+ltrim(rtrim(convert(char(16),left(upper(a.Req_RefNo),16))))/*ltrim(rtrim(a.Party_Code))+'IFT'+right(a.Req_RefNo,4 )*/ /*+a.Req_RefNo*/
			  +',,,,,,,,,'
			  + CONVERT(char(10),getdate(),103)                                                     
			  +',,,,,,' 
			  ,a.SegApprovedAmt,a.VerifierID                                              
		 --a.SegApprovedAmt,VerifierId                            
		 from                                      
		 #NCMS_SegPayoutAppAmt a with(nolock)                                       
		 join cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc b with(nolock) on a.segment=b.segment                                      
		 join #HD c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
		 where c.bank_provider='HDFC' and c.ODIN_gen=2
	End
	Else
	Begin
		INSERT INTO #HDFCdata   
		 select Content=                                      
		 'I,'+ case when @segment='BSECM' then 'RN1005'
				   when @segment='NSECM' then 'ACCT'
				   when @segment='NSEFO' then 'FOCL'
				   when @segment='MCX' then 'MXCL'
				   when @segment='NCDEX' then 'NCCL'
				   when @segment='NSX' then 'RN50996'
					when @segment='BSEMFSS' then 'NGB88RBI' else '' end
				   /*when @segment='NSECM' then 'ACCT'
				   when @segment='NSECM' then 'ACCT'
				   when @segment='NSECM' then 'ACCT'*/
			  +','  
			  +c.Req_PayBankId                              
			  +','+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),SegApprovedAmt))))                
			  +','+ltrim(rtrim(convert(char(38),long_name)))+','+ltrim(rtrim(a.Party_Code))+','
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address1)),35) ))                 
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address2)),35)))                  
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address3)),35)) )                        
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_city)),35))      )                   
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_zip)),35))        )           
			  +',,'+ltrim(rtrim(convert(char(16),left(upper(a.poid),16))))/*ltrim(rtrim(a.Party_Code))+'IFT'+right(a.Req_RefNo,4 )*/ /*+a.Req_RefNo*/
			  +',,,,,,,,,'
			  + CONVERT(char(10),getdate()+2,103)                                                     
			  +',,,,,,' 
			  ,a.SegApprovedAmt,VerifierID                                              
		 --a.SegApprovedAmt,VerifierId                            
		 from                                      
		 #NCMS_SegPayoutAppAmt a with(nolock)                                       
		 join cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc b with(nolock) on a.segment=b.segment                                      
		 join  NCMS_PO_Request c with(nolock) on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                       
		 left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                      
		 and c.Party_code=d.cltcode  and d.paymode='NEFT'                                   
		 left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e  with(nolock)                                   
		 on a.Party_Code=e.party_code  where   d.bankname like 'HDFC%' 
	END
    
If(select count(1) from #NCMS_SegPayoutAppAmt_bill)>0
begin 
 INSERT INTO #HDFCdata   
 select Content=                                      
 'I,'+ case when @segment='BSECM' then 'RN1005'
		   when @segment='NSECM' then 'ACCT'
		   when @segment='NSEFO' then 'FOCL'
		   when @segment='MCX' then 'MXCL'
		   when @segment='NCDEX' then 'NCCL'
		   when @segment='NSX' then 'RN50996'
		    when @segment='BSEMFSS' then 'NGB88RBI' else '' end
		   /*when @segment='NSECM' then 'ACCT'
		   when @segment='NSECM' then 'ACCT'
		   when @segment='NSECM' then 'ACCT'*/
	  +','  
	  +d.acno                             
      +','+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),SegApprovedAmt))))                
      +','+ltrim(rtrim(convert(char(38),long_name)))+','+ltrim(rtrim(a.Party_Code))+','
      +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address1)),35) ))                 
      +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address2)),35)))                  
      +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address3)),35)) )                        
      +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_city)),35))      )                   
      +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_zip)),35))        )           
      +',,'+ltrim(rtrim(convert(char(16),left(upper(a.poid),16))))/*ltrim(rtrim(a.Party_Code))+'IFT'+right(a.Req_RefNo,4 )*/ /*+a.Req_RefNo*/
      +',,,,,,,,,'
      + CONVERT(char(10),getdate(),103)                                                     
      +',,,,,,' 
      ,a.SegApprovedAmt,VerifierID                                              
 --a.SegApprovedAmt,VerifierId                            
 from                                      
 #NCMS_SegPayoutAppAmt_Bill a with(nolock)                                       
 join cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc b with(nolock) on a.segment=b.segment                                      
left join cms.dbo.NCMS_B2B_PO_Request c with(nolock) on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                       
 left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on c.Party_Code=d.Cltcode  and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                      
 and c.Party_code=d.cltcode  and d.paymode='NEFT'                                   
 left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e  with(nolock)                                   
 on a.Party_Code=e.party_code  where   d.bankname like 'HDFC%'  and c.billamt>0                                    
end
 
  
 /************Adding Log Table******************************/

     insert into  NCMS_BANKfile_DetailData_hdfc(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,Batchid)
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),acno,bankname,Batchid from #NCMS_SegPayoutAppAmt a                                       
 join cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc b on a.segment=b.segment                                      
 join  Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                       
 left outer join cms.dbo.NCMS_ClientBankDetails_all d on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                      
 and c.Party_code=d.cltcode  and d.paymode='NEFT' 

   insert into  NCMS_BANKfile_DetailData_hdfc(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                      
 select a.VerifierID,a.Req_RefNo,a.Party_Code,a.Segment,a.SegApprovedAmt,a.PayMode,POid,GETDATE(),c.Accno,c.IFSC,Batchid from 
 #NCMS_SegPayoutAppAmt a                                                             
 join cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc b on a.segment=b.segment                                                            
 join #HD c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
   where c.bank_provider='HDFC'
 
 insert into  NCMS_BANKfile_DetailData_hdfc(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,Batchid)
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),acno,bankname,Batchid from #NCMS_SegPayoutAppAmt_Bill a                                   
 join cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc b on a.segment=b.segment                                  
 join cms.dbo.NCMS_B2B_PO_Request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                     
 left outer join cms.dbo.NCMS_ClientBankDetails_all d on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                   
 and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1    WHERE c.billamt>0 

 delete from #HDFCdata where content IS NULL                
                                 
 if (SELECT COUNT(1) FROM #HDFCdata) > 0                                      
 BEGIN                                
                              
  if (SELECT COUNT(1) FROM NCMS_HdfcBankAccuntOnly_log where segment=@segment) > 0                      
   select @batid=risk.dbo.AddZeroPrefox(max(ISNULL(convert(int,BatchNo),0))+1,4) from NCMS_HdfcBankAccuntOnly_log with(nolock)  where segment=@segment                                
  ELSE                      
   SET @batid='0001'                      
                                
  TRUNCATE TABLE NCMS_HDFCBank_ACCOUNT                                       
                                    
  insert into NCMS_HDFCBank_ACCOUNT(flag,content,verifierId)                                       
  select flag,content,verifierId from                                      
  (                                      
  --select flag=0,content='H'+CONVERT(char(10),getdate(),103)+'COMPANY'+replace(CONVERT(char(10),getdate(),103),'/','')+SPACE(5),0 as verifierId                                      
  --union all                                      
  select flag=1,content,verifierId  from #HDFCdata                                      
  --union all                                      
  --select flag=9,content='F'++risk.dbo.AddZeroPrefox(COUNT(1),5)++dbo.AddZeroPrefix(convert(decimal(14,2),SUM(SegApprovedAmt)),14),0 as verifierId                                      
  --from #HDFCdata                                      
  )  a                    
           
   DECLARE @s VARCHAR(MAX) = '', @FileExt varchar(max)='',@batid_n as char(3) = ''  --,@batid_n as char(3) = ''
    if (select count(1) from NCMS_batchId)>0
	   begin
		  select @batid_n =max(batchid) from	NCMS_batchId
		   --set @batid_n=@batid_n+1
		   --insert into NCMS_batchId
		   --select @batid_n

		   set @FileExt=@batid_n  
	   end
	  -- print @FileExt
  -- select @batid_n=risk.dbo.AddZeroPrefox(max(ISNULL(convert(int,BatchNo),0))+1,3) from NCMS_HdfcBankAccuntOnly_log with(nolock)  where segment=@segment                                
   --set @FileExt =replicate('0',3-LEN(@batid_n)) + CONVERT(VARCHAR,@batid_n) 
 --  set @FileExt=RIGHT(@batid_n, LEN(@batid_n) - 1)+'1'
         
         /* delete from NCMS_YesBank where content IS NULL  */ 
  declare @FileName as varchar(100) =''
  declare @FilePath varchar(200) =''  

      truncate table tmp_NCMS_HDFCBank_ACCOUNT  
  insert into tmp_NCMS_HDFCBank_ACCOUNT  
  select ROW_NUMBER() over (order by verifierID) Srno,* from NCMS_HDFCBank_ACCOUNT  
  
  declare @cnt as numeric=0,@filecnt as numeric=1  
  declare @max as numeric  
  select @max=MAX(Srno) from tmp_NCMS_HDFCBank_ACCOUNT  
  declare @tmpFileName as varchar(500)

  while(@cnt<@max)  
  Begin  
  --declare @cnt as numeric=1  
  truncate table tmp_NCMS_HDFCBank_batch  
    
   insert into tmp_NCMS_HDFCBank_batch  
   select flag,content,verifierid from tmp_NCMS_HDFCBank_ACCOUNT where Srno between (@cnt+1) and (@cnt+1) + 19999 
	select count(1) from #HDFCdata

	set @FileExt=@FileExt+1
	insert into NCMS_batchId
	select @FileExt
	
  if(@segment='MCX')
  Begin                                           
   select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from 
        cms.dbo.NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment      
   set @FilePath=@FilePath+@FileName                                 
  End    
    if(@segment='NSEFO')
  Begin                                           
   select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from 
        cms.dbo.NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment  
		set @FilePath=@FilePath+@FileName     
                                                
  End
    if(@segment='BSECM')
  Begin                                           
   select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from 
        cms.dbo.NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment      
      		set @FilePath=@FilePath+@FileName     
                                     
  End
  if(@segment='NSECM')
  Begin                                           
	select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'.'+@FileExt,@FilePath=Fpath from 
        cms.dbo.NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment       
 		set @FilePath=@FilePath+@FileName     

  End
  if(@segment='NSX')
  Begin                                           
		 select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from 
        cms.dbo.NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment  
 		set @FilePath=@FilePath+@FileName     
                                                
  End
    if(@segment='MCD')
  Begin                                           
    select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from 
        cms.dbo.NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment
 		set @FilePath=@FilePath+@FileName     
                                               
  End
     if(@segment='NCDEX')
  Begin                                           
    select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from 
        cms.dbo.NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment   
 		set @FilePath=@FilePath+@FileName     
                                            
  End
  if(@segment='NBFC')
  Begin                                           
	 select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from 
        cms.dbo.NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment   
 		set @FilePath=@FilePath+@FileName     
            
  End
    if(@segment='BSEMFSS')
  Begin                                           
    select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'.'+@FileExt,@FilePath=Fpath from 
        cms.dbo.NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment   
 		set @FilePath=@FilePath+@FileName     
                                               
  End
     if(@segment='BSX')
  Begin                                           
	 select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from 
        cms.dbo.NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment    
         		set @FilePath=@FilePath+@FileName     
                                     
  End
  
   --select @FilePath=ltrim(rtrim(bankfolder))+@FileName  from ncms_Entity_ICICI where segment=@segment        
   /*Exec master.dbo.xp_cmdshell 'net use \\172.31.18.153\hdfcforward\Angel_Broking\src /user:neha.naiwar@angeltrade.com pass@123'*/  --UAT server
      --  Exec master.dbo.xp_cmdshell 'net use \\INHOUSEHDFCLIVE-FS.angelone.in\hdfcforward\Angel_Broking\src /user:neha.naiwar@angelone.in Angel@12345670' --Live Server    

   --PRINT @FilePath                           
   --SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                   
   --     SET @s = @s + 'bcp "select distinct content from INTRANET.cms.dbo.NCMS_HDFCBank_ACCOUNT" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                 
   --     SET @s = @s + ''''      
   --     PRINT (@s)                    
   --     EXEC(@s) 
        
   DECLARE @s1 VARCHAR(MAX) = ''     
   SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''        
   SET @s1 = @s1 + 'bcp "select distinct content from dustbin.dbo.NCMS_HDFCBank_ACCOUNT" queryout \\INHOUSELIVEAPP1-FS.angelone.in\d\upload\CMS_Test\ICICI_BankFile\'+@filename+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                                          
   SET @s1 = @s1 + ''''                                              
   EXEC(@s1) 
   
   set @cnt=@cnt+20000  
  set @filecnt= @filecnt+1  

        insert into NCMS_BankFileName_log      
   select @FileName,SegApprovedAmt,'HDFC',Batchid,GETDATE() from NCMS_BANKfile_DetailData_hdfc with(nolock) where VerifierId in      
   (select verifierid from tmp_NCMS_HDFCBank_batch with(nolock) )     
   
 end 
end
  /* CREATE COPY FILE FOR REFERENCE */        
  --if (select COUNT(1) from NCMS_Entity where bankfolder like '%136%' and Segment=@segment) >= 1        
  --Begin        
  /*
  DECLARE @s1 VARCHAR(MAX) = ''    
  SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                     
  SET @s1 = @s1 + 'bcp "select content from [196.1.115.132].cms.dbo.NCMS_ICICIBank order by flag" queryout \\INHOUSELIVEAPP2-FS.angelone.in\d$\upload\CMS_Test\ICICI_BankFile\'+@FileName+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                          
 
    
                                              
  SET @s1 = @s1 + ''''                                            
  EXEC(@s1)  */                                        
 -- End        

   /*     declare @FileName as varchar(25) = ''                 
        declare @FilePath varchar(200) ='' 
    
        select @FileName=ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'.'+@FileExt,@FilePath=Fpath from 
        NCMS_HDFCbankDetails_For_HDFCAcc where segment=@segment              
		set @FilePath=@FilePath+@FileName     
		 --print @FilePath     
        SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                   
        SET @s = @s + 'bcp "select content from [196.1.115.132].cms.dbo.NCMS_HDFCBank_ACCOUNT order by flag" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uinhouse -Pinh6014'                                 
        SET @s = @s + ''''                          
        EXEC(@s)    */  
                                    
  --update NCMS_SegPayoutAppAmt set BANK_gen=1 from                           
  --      (select verifierid from NCMS_HDFCBank_ACCOUNT where flag=1)b where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid                    
  --      and NCMS_SegPayoutAppAmt.BANK_gen=0  
  
   update NCMS_SegPayoutAppAmt set BANK_gen=3 from                           
        (select verifierid from NCMS_HDFCBank_ACCOUNT where flag=1)b where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid                    
        and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and NCMS_SegPayoutAppAmt.Paymode is not NULL
         and NCMS_SegPayoutAppAmt.verifierid<>0  and ODIN_gen=0 

 update a set BANK_gen=3,BOFF_gen=1  from NCMS_SegPayoutAppAmt a,                                     
  (select a.verifierId,c.Req_RefNo  from NCMS_HDFCBank_ACCOUNT a 
		join #HD c on a.verifierId=c.verifierid
         and c.Bank_Provider='HDFC')b                                                   
  where a.VerifierID=b.verifierid  and a.Req_RefNo  =b.Req_RefNo                                                    
  and a.BANK_gen=0   and a.SegApprovedAmt > 0 and
  a.Paymode is not NULL   and ODIN_gen=2  
        

 update NCMS_SegPayoutAppAmt set BANK_gen=3 from                           
        (select distinct a.verifierid,req_refno,party_code from NCMS_HDFCBank_ACCOUNT a 
		join NCMS_BANKfile_DetailData_hdfc c on a.verifierId=c.verifierid
         and c.req_refno like 'B%'
where flag=1 )b 
        where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid  and  NCMS_SegPayoutAppAmt.req_refno=b.req_refno and NCMS_SegPayoutAppAmt.party_code=b.party_code                 
        and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and NCMS_SegPayoutAppAmt.Paymode is not NULL                                         
                                    
  insert into NCMS_HdfcBankAccuntOnly_log(flag,content,verifierId,GeneratedOn,BatchNo,segment)                                       
  select flag,content,verifierId,GETDATE(),@batid,@segment from NCMS_HDFCBank_ACCOUNT                                      
 END                                      
                                      
 set @ctr=@ctr+1   
 drop table #HD
                          
END                                      
                                      
DROP TABLE #HDFCdata                                      
DROP TABLE #CtrFile                                      

/*exec NCMS_BOapiPush_HDFCAccount                                      */
End try                                                               
BEGIN CATCH                                                 
                                                              
 insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                       
 select GETDATE(),'NCMS_HDFCBankFileGeneration_For_HDFCAcconts',ERROR_LINE(),ERROR_MESSAGE()                                                                        
                                 
 DECLARE @ErrorMessage NVARCHAR(4000);                                                                    
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                    
 RAISERROR (@ErrorMessage , 16, 1);                                       
                                       
End catch                                                     
                                    
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_HDFCFileGeneration_For_ALLClient
-- --------------------------------------------------

CREATE procedure [dbo].[NCMS_HDFCFileGeneration_For_ALLClient]                                      
as                                      
Set nocount on                                                          
SET XACT_ABORT ON                                                             
BEGIN TRY  
  
  declare @StatusDupli varchar(20)                             
  set @StatusDupli=''           
  exec CMS.dbo.Get_JoBStatus 'NCMS Double Entry in ACC no',@StatusDupli  output                             
      
  if(@StatusDupli='In Progress')                              
   print 'job is already running'                          
  else                      
   EXEC msdb.dbo.sp_start_job 'NCMS Double Entry in ACC no'   
    
 --insert into NCMS_BANKfile_DetailData_hdfc_hist  
 --select *,GETDATE() from NCMS_BANKfile_DetailData_hdfc  
  
truncate table NCMS_BANKfile_DetailData_hdfc  
                          

select ROW_NUMBER() OVER ( ORDER BY segment ) AS [SrNo],segment  as segment                           
into #CtrFile                                        
from NCMS_HDFCbankDetails_for_HDFCAcc  with(nolock) where segment<>'nbfc'  

select POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity into #request from NCMS_PO_Request with (nolock) group by   
 POrequestID, Req_payBankId,Req_RefNo,Party_code,Entity   
  
 select a.*,e.bank_name into #porequest from #request a left join risk.dbo.v_rtgs_client e with(nolock) on   
 a.Party_Code = e.fld_party_code and a.Req_payBankId=ltrim(rtrim( e.fld_bank_acno ))  
 
Declare @ctr int = 1,@totctr int = 0,@segment as varchar(10) = '',@batid as char(4) = ''                                      
select @totctr=MAX(srno) from #CtrFile                                      
                                      
CREATE TABLE #HDFCdata                                        
(                                        
Content VARCHAR(8000),                                        
SegApprovedAmt MONEY,                                        
VerifierId INT                                        
)                                       
                          
select                                       
VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,PayMode,poid+4000000 as POid/*convert(bigint,poid+4000000) as POid*/,Batchid                                      
into #NCMS_SegPayoutAppAmt                           
from NCMS_SegPayoutAppAmt where 1=2  

          
select                                         
VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,PayMode,poid+4000000 as POid,Batchid ,convert(varchar(50),'') as ACNO,
convert(varchar(50),'') as bankname
into #NCMS_SegPayoutAppAmt_Bill                             
from NCMS_SegPayoutAppAmt where 1=2      
                                      
WHILE @ctr <= @totctr                                      
BEGIN                                      
                                      
 select @segment=segment from  #CtrFile where srno=@ctr                                      
                                   
 TRUNCATE TABLE #HDFCdata                               
 TRUNCATE TABLE #NCMS_SegPayoutAppAmt                                    
                          
 update NCMS_SegPayoutAppAmt set Paymode='N06'                           
 where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment                           
                          
 insert into #NCMS_SegPayoutAppAmt                          
 select                                       
 VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,Paymode,poid+4000000 as POid/* '99'+CONVERT(varchar(15), poid+4000000)  */
 ,Batchid                                       
 from NCMS_SegPayoutAppAmt                                       
 where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment and ODIN_gen=0 

  /*******For Withdraw2*****************************************/
     
insert into #NCMS_SegPayoutAppAmt                                                
 select                                                             
 a.VerifierId,a.Req_RefNo,a.Party_Code,a.Entity,a.Segment,a.SegApprovedAmt,Paymode,POid                      
 ,Batchid                                                             
 from NCMS_SegPayoutAppAmt a join temp_withdraw2 b on a.Party_Code=b.Party_Code and a.Req_RefNo=b.Req_RefNo                                                             
 where a.SegApprovedAmt>0 and BANK_gen=0 and a.Segment=@segment and a.ODIN_gen=2 and convert(date,ProcessDateTime)>=
 CONVERT(date,GETDATE()) --and b.Bank_Provider='ICICI'

select c.*,branch_cd,sub_broker,long_name into #HD from  temp_withdraw2 c left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client d with(nolock) on                                                           
c.Party_code=d.party_code 
 
 /*******************************/
 
 insert into #NCMS_SegPayoutAppAmt_Bill
   select    distinct                            
 a.VerifierId,a.Req_RefNo,a.Party_Code,a.Entity,a.Segment,a.SegApprovedAmt,a.Paymode,a.poid+4000000 as POid,Batchid,d.acno,d.bankname                                         
   from NCMS_SegPayoutAppAmt a with(nolock) join NCMS_B2B_PO_Request c with(nolock) on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code   
  left outer join NCMS_ClientBankDetails_all d with(nolock) on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                        
 and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1    
 where  SegApprovedAmt>0 and BANK_gen=0    and c.Segment=@segment and c.billamt>0    
 
 update #NCMS_SegPayoutAppAmt set Paymode='N06' where paymode is null 
                    
 delete from    #NCMS_SegPayoutAppAmt where paymode is null                         
 
 INSERT INTO #HDFCdata     
 select Content=                                        
 'N,'+ case when @segment='BSECM' then 'RN1005'  
     when @segment='NSECM' then 'ACCT'  
     when @segment='NSEFO' then 'FOCL'  
     when @segment='MCX' then 'MXCL'  
     when @segment='NCDEX' then 'NCCL'  
     when @segment='NSX' then 'RN50996'  
      when @segment='BSEMFSS' then 'NGB88RBI' else '' end  
   +','    
   +c.Req_PayBankId                                
      +','+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),SegApprovedAmt))))                  
      +','+ltrim(rtrim(convert(char(38),long_name)))+','+ltrim(rtrim(a.Party_Code))+','  
      +','+ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address1)),35) ))                   
      +','+ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address2)),35)))                    
      +','+ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address3)),35)) )                          
      +','+ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_city)),35))      )                     
      +','+ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_zip)),35))        )             
      +',,'+ltrim(rtrim(convert(char(16),left(upper(a.poid),16))))/*ltrim(rtrim(a.Party_Code))+'IFT'+right(a.Req_RefNo,4 )*/ /*+a.Req_RefNo*/  
      +',,,,,,,,,'  
      + CONVERT(char(10),getdate(),103)                                                       
      +',,'+d.bankname
	  +',,,,'   
      ,a.SegApprovedAmt,VerifierID                                                
 --a.SegApprovedAmt,VerifierId                              
 from                                        
 #NCMS_SegPayoutAppAmt a with(nolock)                                         
 join cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc b with(nolock) on a.segment=b.segment                                        
 join #porequest c with(nolock) on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                         
 left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                        
 and c.Party_code=d.cltcode  and d.paymode='NEFT'                                     
 left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e  with(nolock)                                     
 on a.Party_Code=e.party_code                                    
 
  INSERT INTO #HDFCdata   
		 select Content=                                      
		 'I,'+ case when @segment='BSECM' then 'RN1005'
				   when @segment='NSECM' then 'ACCT'
				   when @segment='NSEFO' then 'FOCL'
				   when @segment='MCX' then 'MXCL'
				   when @segment='NCDEX' then 'NCCL'
				   when @segment='NSX' then 'RN50996'
					when @segment='BSEMFSS' then 'NGB88RBI' else '' end
				   /*when @segment='NSECM' then 'ACCT'
				   when @segment='NSECM' then 'ACCT'
				   when @segment='NSECM' then 'ACCT'*/
			  +','  
			  +c.Accno                              
			  +','+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),a.SegApprovedAmt))))                
			  +','+ltrim(rtrim(convert(char(38),long_name)))+','+ltrim(rtrim(a.Party_Code))+','
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address1)),35) ))                 
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address2)),35)))                  
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address3)),35)) )                        
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_city)),35))      )                   
			  +','+''--ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_zip)),35))        )           
			  +',,'+ltrim(rtrim(convert(char(16),left(upper(a.Req_RefNo),16))))/*ltrim(rtrim(a.Party_Code))+'IFT'+right(a.Req_RefNo,4 )*/ /*+a.Req_RefNo*/
			  +',,,,,,,,,'
			  + CONVERT(char(10),getdate(),103)                                                     
			  +',,,,,,' 
			  ,a.SegApprovedAmt,a.VerifierID                                              
		 --a.SegApprovedAmt,VerifierId                            
		 from                                      
		 #NCMS_SegPayoutAppAmt a with(nolock)                                       
		 join cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc b with(nolock) on a.segment=b.segment                                      
		 join #HD c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
		 where c.bank_provider='HDFC' and c.ODIN_gen=2
     
If(select count(1) from #NCMS_SegPayoutAppAmt_bill)>0  
begin   
 INSERT INTO #HDFCdata     
 select Content=                                        
 'N,'+ case when @segment='BSECM' then 'RN1005'  
     when @segment='NSECM' then 'ACCT'  
     when @segment='NSEFO' then 'FOCL'  
     when @segment='MCX' then 'MXCL'  
     when @segment='NCDEX' then 'NCCL'  
     when @segment='NSX' then 'RN50996'  
      when @segment='BSEMFSS' then 'NGB88RBI' else '' end  
     /*when @segment='NSECM' then 'ACCT'  
     when @segment='NSECM' then 'ACCT'  
     when @segment='NSECM' then 'ACCT'*/  
   +','    
   +acno                               
      +','+ltrim(rtrim(convert(varchar(14),convert(decimal(14,2),SegApprovedAmt))))                  
      +','+ltrim(rtrim(convert(char(38),long_name)))+','+ltrim(rtrim(a.Party_Code))+','  
      +','+ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address1)),35) ))                   
      +','+ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address2)),35)))                    
      +','+ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_address3)),35)) )                          
      +','+ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_city)),35))      )                     
      +','+ltrim(rtrim(left(upper(dbo.fn_StripCharacters(e.l_zip)),35))        )             
      +',,'+ltrim(rtrim(convert(char(16),left(upper(a.poid),16))))/*ltrim(rtrim(a.Party_Code))+'IFT'+right(a.Req_RefNo,4 )*/ /*+a.Req_RefNo*/  
      +',,,,,,,,,'  
      + CONVERT(char(10),getdate(),103)                                                       
      +',,'+bankname
	  +',,,,'   
      ,a.SegApprovedAmt,VerifierID                                                
 --a.SegApprovedAmt,VerifierId                              
 from                                        
#NCMS_SegPayoutAppAmt_Bill a with(nolock)                                         
 join NCMS_HDFCbankDetails_for_HDFCAcc b with(nolock) on a.segment=b.segment                                        
 --join NCMS_B2B_PO_Request c with(nolock) on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                         
 --left outer join NCMS_ClientBankDetails_all d with(nolock) on c.Party_Code=d.Cltcode  and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                        
 --and c.Party_code=d.cltcode  and d.paymode='NEFT'                                     
 left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e  with(nolock)                                     
 on a.Party_Code=e.party_code                                
end  --------------------------------------------------------------*/    
   
 /************Adding Log Table******************************/
 
   insert into  NCMS_BANKfile_DetailData_hdfc(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,Batchid)  
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),acno,bankname,Batchid from #NCMS_SegPayoutAppAmt a                                         
 join NCMS_HDFCbankDetails_for_HDFCAcc b on a.segment=b.segment                                        
 join Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                         
 left outer join NCMS_ClientBankDetails_all d on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                        
 and c.Party_code=d.cltcode  and d.paymode='NEFT'  
 
  insert into  NCMS_BANKfile_DetailData_hdfc(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                      
 select a.VerifierID,a.Req_RefNo,a.Party_Code,a.Segment,a.SegApprovedAmt,a.PayMode,POid,GETDATE(),c.Accno,c.IFSC,Batchid from 
 #NCMS_SegPayoutAppAmt a                                                             
 join cms.dbo.NCMS_HDFCbankDetails_for_HDFCAcc b on a.segment=b.segment                                                            
 join #HD c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
   
 insert into  NCMS_BANKfile_DetailData_hdfc(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,Batchid)  
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),a.acno,a.bankname,a.Batchid from #NCMS_SegPayoutAppAmt_Bill a                                     
 join NCMS_HDFCbankDetails_for_HDFCAcc b on a.segment=b.segment                                    
 join NCMS_B2B_PO_Request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                       
 left outer join NCMS_ClientBankDetails_all d on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                     
 and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1    WHERE c.billamt>0  

 
 /*******************************************/
 delete from #HDFCdata where content IS NULL                  
                                   
 if (SELECT COUNT(1) FROM #HDFCdata) > 0                                        
 BEGIN                                  
                                
  if (SELECT COUNT(1) FROM NCMS_HdfcBankAccuntOnly_log where segment=@segment) > 0                        
   select @batid=risk.dbo.AddZeroPrefox(max(ISNULL(convert(int,BatchNo),0))+1,4) from NCMS_HdfcBankAccuntOnly_log with(nolock)  where segment=@segment                                  
  ELSE                        
   SET @batid='0001'                        
                                  
  TRUNCATE TABLE NCMS_HDFCBank_ACCOUNT                                         
                                      
  insert into NCMS_HDFCBank_ACCOUNT(flag,content,verifierId)                                         
  select flag,content,verifierId from                                        
  (                                        
  --select flag=0,content='H'+CONVERT(char(10),getdate(),103)+'COMPANY'+replace(CONVERT(char(10),getdate(),103),'/','')+SPACE(5),0 as verifierId                                        
  --union all                                        
  select flag=1,content,verifierId  from #HDFCdata                                        
  --union all                                        
  --select flag=9,content='F'++risk.dbo.AddZeroPrefox(COUNT(1),5)++dbo.AddZeroPrefix(convert(decimal(14,2),SUM(SegApprovedAmt)),14),0 as verifierId                                        
  --from #HDFCdata                                        
  )  a                      
             
   --DECLARE @s VARCHAR(MAX) = '', @FileExt varchar(max)='',@batid_n as char(3) = ''    
   --select @batid_n=risk.dbo.AddZeroPrefox(max(ISNULL(convert(int,BatchNo),0))+1,3) from NCMS_HdfcBankAccuntOnly_log with(nolock)  where segment=@segment                                  
   --set @FileExt =replicate('0',3-LEN(@batid_n)) + CONVERT(VARCHAR,@batid_n)       

   DECLARE @s VARCHAR(MAX) = '', @FileExt varchar(max)='',@batid_n as char(3) = ''  --,@batid_n as char(3) = ''
    if (select count(1) from NCMS_batchId)>0
	   begin
		  select @batid_n =max(batchid) from	NCMS_batchId
		   --set @batid_n=@batid_n+1
		   --insert into NCMS_batchId
		   --select @batid_n

		   set @FileExt=@batid_n  
	   end
	   
         /* delete from NCMS_YesBank where content IS NULL  */   
  declare @FileName as varchar(100) =''  
  declare @FilePath varchar(200) =''    
  
      truncate table tmp_NCMS_HDFCBank_ACCOUNT    
  insert into tmp_NCMS_HDFCBank_ACCOUNT    
  select ROW_NUMBER() over (order by verifierID) Srno,* from NCMS_HDFCBank_ACCOUNT    
    
  declare @cnt as numeric=0,@filecnt as numeric=1    
  declare @max as numeric    
  select @max=MAX(Srno) from tmp_NCMS_HDFCBank_ACCOUNT    
  declare @tmpFileName as varchar(500)  
  
  while(@cnt<@max)    
  Begin    
  --declare @cnt as numeric=1    
  truncate table tmp_NCMS_HDFCBank_batch    
      
   insert into tmp_NCMS_HDFCBank_batch    
   select flag,content,verifierid from tmp_NCMS_HDFCBank_ACCOUNT where Srno between (@cnt+1) and (@cnt+1) + 9999  order by Srno 
   

	set @FileExt=@FileExt+1
	insert into NCMS_batchId
	select @FileExt
	 
   
  if(@segment='MCX')  
  Begin                                             
   select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from   
        NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment        
   set @FilePath=@FilePath+@FileName                                   
  End      
    if(@segment='NSEFO')  
  Begin                                             
   select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from   
        NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment    
  set @FilePath=@FilePath+@FileName       
                                                  
  End  
    if(@segment='BSECM')  
  Begin                                             
   select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from   
        NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment        
        set @FilePath=@FilePath+@FileName       
                                       
  End  
  if(@segment='NSECM')  
  Begin                                             
 select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'.'+@FileExt,@FilePath=Fpath from   
        NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment         
   set @FilePath=@FilePath+@FileName       
  
  End  
  if(@segment='NSX')  
  Begin                                             
   select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from   
        NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment    
   set @FilePath=@FilePath+@FileName       
                                                  
  End  
    if(@segment='MCD')  
  Begin                                             
    select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from   
        NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment  
   set @FilePath=@FilePath+@FileName       
                                                 
  End  
     if(@segment='NCDEX')  
  Begin                                             
    select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from   
        NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment     
   set @FilePath=@FilePath+@FileName       
                                              
  End  
  if(@segment='NBFC')  
  Begin                                             
  select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from   
        NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment     
   set @FilePath=@FilePath+@FileName       
              
  End  
    if(@segment='BSEMFSS')  
  Begin                                             
    select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'.'+@FileExt,@FilePath=Fpath from   
        NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment     
   set @FilePath=@FilePath+@FileName       
                                                 
  End  
     if(@segment='BSX')  
  Begin                                             
  select @FileName ='ANGEL_'+ltrim(rtrim(fname))+'_'+ltrim(rtrim(fname))+left(replace(CONVERT(varchar(5),getdate(),103),'/',''),4)+'_'+cast(@filecnt as varchar)+'.'+@FileExt,@FilePath=Fpath from   
        NCMS_HDFCbankDetails_For_HDFCAcc where segment= @segment      
           set @FilePath=@FilePath+@FileName       
                                       
  End  
    
   --select @FilePath=ltrim(rtrim(bankfolder))+@FileName  from ncms_Entity_ICICI where segment=@segment          
   /*Exec master.dbo.xp_cmdshell 'net use \\172.31.18.153\hdfcforward\Angel_Broking\src /user:neha.naiwar@angeltrade.com pass@123'*/  --UAT server  
        Exec master.dbo.xp_cmdshell 'net use \\INHOUSEHDFCLIVE-FS.angelone.in\hdfcforward\Angel_Broking\src /user:neha.naiwar@angelone.in Angel@12345670' --Live Server    
  
   PRINT @FilePath                             
   SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                     
        SET @s = @s + 'bcp "select distinct content from INTRANET.cms.dbo.tmp_NCMS_HDFCBank_batch" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                   
        SET @s = @s + ''''        
        PRINT (@s)                      
        EXEC(@s)   
          
   DECLARE @s1 VARCHAR(MAX) = ''       
   SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''          
   SET @s1 = @s1 + 'bcp "select distinct content from INTRANET.cms.dbo.tmp_NCMS_HDFCBank_batch" queryout \\INHOUSELIVEAPP1-FS.angelone.in\d\upload\CMS_Test\ICICI_BankFile\'+@filename+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                            
                                
   SET @s1 = @s1 + ''''                                                
   EXEC(@s1)   
     
   set @cnt=@cnt+10000    
  set @filecnt= @filecnt+1    
  
        insert into NCMS_BankFileName_log        
   select @FileName,SegApprovedAmt,'HDFC',Batchid,GETDATE() from NCMS_BANKfile_DetailData_hdfc with(nolock) where VerifierId in        
   (select verifierid from tmp_NCMS_HDFCBank_batch with(nolock) )       
     
 end   
end     

   update NCMS_SegPayoutAppAmt set BANK_gen=3 from                           
        (select verifierid from NCMS_HDFCBank_ACCOUNT where flag=1)b where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid                    
        and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and NCMS_SegPayoutAppAmt.Paymode is not NULL
         and NCMS_SegPayoutAppAmt.verifierid<>0 and ODIN_gen=0 

		  update a set BANK_gen=3,BOFF_gen=1  from NCMS_SegPayoutAppAmt a,                                     
  (select a.verifierId,c.Req_RefNo  from NCMS_HDFCBank_ACCOUNT a 
		join #HD c on a.verifierId=c.verifierid)b                                                   
  where a.VerifierID=b.verifierid  and a.Req_RefNo  =b.Req_RefNo                                                    
  and a.BANK_gen=0   and a.SegApprovedAmt > 0 and
  a.Paymode is not NULL   and ODIN_gen=2  
        

 update NCMS_SegPayoutAppAmt set BANK_gen=3 from                           
        (select distinct a.verifierid,req_refno,party_code from NCMS_HDFCBank_ACCOUNT a join NCMS_BANKfile_DetailData_hdfc c on a.verifierId=c.verifierid
         and c.req_refno like 'B%'
where flag=1 )b 
        where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid  and  NCMS_SegPayoutAppAmt.req_refno=b.req_refno and NCMS_SegPayoutAppAmt.party_code=b.party_code                 
        and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and NCMS_SegPayoutAppAmt.Paymode is not NULL                                         
                                    
  insert into NCMS_HdfcBankAccuntOnly_log(flag,content,verifierId,GeneratedOn,BatchNo,segment)                                       
  select flag,content,verifierId,GETDATE(),@batid,@segment from NCMS_HDFCBank_ACCOUNT                                       
                                         
                                        
 set @ctr=@ctr+1                                        
   drop table #HD
                          
END                                        
                                        
DROP TABLE #HDFCdata                                        
DROP TABLE #CtrFile                                         
End try                                                               
BEGIN CATCH                                                 
                                                              
 insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                       
 select GETDATE(),'NCMS_HDFCFileGeneration_For_ALLClient',ERROR_LINE(),ERROR_MESSAGE()                                                                        
                                 
 DECLARE @ErrorMessage NVARCHAR(4000);                                                                    
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                    
 RAISERROR (@ErrorMessage , 16, 1);                                       
                                       
End catch                                                     
                                    
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_ICICIBankFileGeneration
-- --------------------------------------------------
--exec [NCMS_YesBankFileGeneration]                         
 --NCMS_SegPayoutAppAmt where SegApprovedAmt>0 and BANK_gen=0  order by processdatetime desc                      
CREATE procedure [dbo].[NCMS_ICICIBankFileGeneration]                                                            
as                                                            
Set nocount on                                                                                
SET XACT_ABORT ON                                                                                   
BEGIN TRY                        

 	 truncate table temp_withdraw2 
if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)                      
begin   
if((CONVERT(VARCHAR(5),GETDATE(),108)>='10:15') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:30'))                            
Begin 
BEGIN TRANSACTION

	 declare @processdate datetime,@maxBatchid varchar(15) = '' 
	 select @processdate=max(ProcessDateTime),@maxBatchid=max(Batchid) from    cms.dbo.NCMS_SegPayoutAppAmt with(nolock)

	 insert into temp_withdraw2 
	 select  * from tbl_withdarw_stag where processedflag='No'

	insert into NCMS_SegPayoutAppAmt(RequestID,VerifierID,Req_RefNo,Party_Code,
	Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt,BOFF_gen,BANK_gen,ODIN_gen,ProcessDateTime,BOFF_Posted,Batchid)
	select RequestID,VerifierID,Req_RefNo,Party_code,Entity,Segment,PO_ApprovedAmt,
	NetPAyable,SegApprovedAmt,0,0,2,@processdate,0,@maxBatchid                                                     
	 from temp_withdraw2 

	update a set processedflag='Yes' from tbl_withdarw_stag a, temp_withdraw2  b where a.party_code= b.party_code and
	a.Req_RefNo=b.Req_RefNo
	and a.processedflag='No'

COMMIT TRANSACTION
end  
end
  Exec NCMS_HDFCBankFileGeneration_For_HDFCAcconts /*Commented on 14 FEb 2023 as per JIRA ticket - ORE-1975*/                        
                      
--insert into NCMS_BANKfile_DetailData_hist                        
--select *,GETDATE() from NCMS_BANKfile_DetailData                        
                        
truncate table NCMS_BANKfile_DetailData                        
                                                
select ROW_NUMBER() OVER ( ORDER BY segment ) AS [SrNo],segment                                                
into #CtrFile                                                            
from cms.dbo.ncms_Entity_ICICI where BO_bankname='ICICI BANK' and ActiveStatus=1   and Segment='NSECM'                      
order by entity desc,seqid                            
                      
select distinct party_code,entity,req_paybankid,req_refno into #Ncms_Po_request from Ncms_Po_request with(nolock)  
truncate table #Ncms_Po_request
                                                            
Declare @ctr int = 1,@totctr int = 0,@segment as varchar(10) = '',@batid as char(4) = ''                                                            
select @totctr=MAX(srno) from #CtrFile                                                            
                                                            
CREATE TABLE #ICICIdata                                                            
(                                                            
Content VARCHAR(8000),                                                            
SegApprovedAmt MONEY,                                                            
VerifierId INT                                                            
)                                                            
                                                
select                                                             
VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,PayMode,/*poid+4000000 as POid*/convert(bigint,poid+4000000) as POid,Batchid                                                            
into #NCMS_SegPayoutAppAmt                                                 
from NCMS_SegPayoutAppAmt where 1=2                                                  
                                                            
WHILE @ctr <= @totctr                                                            
BEGIN            
                                                            
 select @segment=segment from  #CtrFile where srno=@ctr                                                     
                                                         
 TRUNCATE TABLE #ICICIdata                                         
 TRUNCATE TABLE #NCMS_SegPayoutAppAmt                                                          
                                 
                      
 update NCMS_SegPayoutAppAmt set Paymode='N06'--dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt)                                   
 where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment                                                
                     
 insert into #NCMS_SegPayoutAppAmt                                                
 select                                                             
 VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,Paymode,/*poid+4000000 as POid*/  '99'+CONVERT(varchar(15), poid+4000000)                        
 ,Batchid                                                             
 from NCMS_SegPayoutAppAmt                                                             
 where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment and ODIN_gen=0 and convert(date,ProcessDateTime)>=
 CONVERT(date,GETDATE())
 
 /*******For Withdraw2*****************************************/
     
insert into #NCMS_SegPayoutAppAmt                                                
 select                                                             
 a.VerifierId,a.Req_RefNo,a.Party_Code,a.Entity,a.Segment,a.SegApprovedAmt,Paymode,POid                      
 ,Batchid                                                             
 from NCMS_SegPayoutAppAmt a join temp_withdraw2 b on a.Party_Code=b.Party_Code and a.Req_RefNo=b.Req_RefNo                                                             
 where a.SegApprovedAmt>0 and BANK_gen=0 and a.Segment=@segment and a.ODIN_gen=2 and convert(date,ProcessDateTime)>=
 CONVERT(date,GETDATE()) and b.Bank_Provider='ICICI'

select c.*,branch_cd,sub_broker,long_name into #df from  temp_withdraw2 c left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client d with(nolock) on                                                           
c.Party_code=d.party_code 
 
 /*******************************/
                       
 update #NCMS_SegPayoutAppAmt set Paymode='N06' where paymode is null                       
                                          
 delete from    #NCMS_SegPayoutAppAmt where paymode is null                                               
                      
 if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)                      
 begin                                                             
   INSERT INTO #ICICIdata                                                            
   select Content='D'                                                            
   /*+(Case when SegApprovedAmt > 200000 then 'R41' else 'N06' end)     */                                                  
   /* +dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt) */                                          
   +convert(char(3),a.Paymode)                                          
   +convert(char(15),left(BO_AccNo,15))                                                            
   +convert(char(35),substring(upper(CompanyName),1,35))                                                            
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                            
   +convert(char(11),d.bankname)                                                            
   +convert(char(34),d.acno)                       
   +convert(char(35),left(upper(dbo.fn_StripCharacters(e.long_name)),35))                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                            
   +convert(char(16),left(upper(a.poid),16))                                                            
   +CONVERT(char(10),getdate(),103)                                                            
   +dbo.AddZeroPrefix(convert(decimal(14,2),SegApprovedAmt),14)                                                            
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                            
   +convert(char(33),left(e.party_Code,33))                                                            
   +convert(char(33),left(e.branch_cd,33))                                               
   +convert(char(33),left(e.sub_broker,33))                                                            
   +SPACE(33)                            
   ,SegApprovedAmt,VerifierId                                                  
   from                                                            
   #NCMS_SegPayoutAppAmt a                                 
   join cms.dbo.ncms_Entity_ICICI b on a.segment=b.segment                                                            
   join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                             
   left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on ltrim(rtrim(c.Req_PayBankId))=ltrim(rtrim(d.acno)) and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                            
   and c.Party_code=d.cltcode  and d.paymode='NEFT'                                                         
   /*left outer join risk.dbo.client_Details e */  /*Commented on 01 Dec 2017 For MFSS codes*/                      
   left outer join  risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e /*vw_NCMS_MFSS_client_details*/ with(nolock)                                                        
   on a.Party_Code=e.party_code  
   
   INSERT INTO #ICICIdata                                                            
   select Content='D'                                                            
   +convert(char(3),a.Paymode)                                          
   +convert(char(15),left(BO_AccNo,15))                                                            
   +convert(char(35),substring(upper(CompanyName),1,35))                                                            
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                            
   +convert(char(11),c.ifsc)                                                            
   +convert(char(34),c.accno)                       
   +convert(char(35),left(upper(dbo.fn_StripCharacters(c.long_name)),35))                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                            
   +convert(char(16),left(upper(c.Req_RefNo),16))                                                            
   +CONVERT(char(10),getdate(),103)                                                            
   +dbo.AddZeroPrefix(convert(decimal(14,2),a.SegApprovedAmt),14)                                                            
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                            
   +convert(char(33),left(c.party_Code,33))                                                            
   +convert(char(33),left(c.branch_cd,33))                                               
   +convert(char(33),left(c.sub_broker,33))                                                            
   +SPACE(33)                            
   ,a.SegApprovedAmt,a.VerifierID                                                  
   from                                                                                    
   #NCMS_SegPayoutAppAmt a                                 
   join cms.dbo.ncms_Entity_ICICI b on a.segment=b.segment                                                            
   join #df c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
   where c.bank_provider='ICICI' and c.ODIN_gen=2
               
 End                      
 else              
 begin                      
   INSERT INTO #ICICIdata                                                            
   select Content='D'                                                            
   /*+(Case when SegApprovedAmt > 200000 then 'R41' else 'N06' end)     */                                                  
   /* +dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt) */                                          
   +convert(char(3),a.Paymode)                                          
   +convert(char(15),left(BO_AccNo,15))                                                            
   +convert(char(35),substring(upper(CompanyName),1,35))                                                            
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                            
   +convert(char(11),d.bankname)                                                            
   +convert(char(34),d.acno)                       
   +convert(char(35),left(upper(dbo.fn_StripCharacters(e.long_name)),35))                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                              
   +convert(char(35),'')                                                            
   +convert(char(16),left(upper(a.poid),16))                                                            
   +CONVERT(char(10),getdate()+2,103)                                                            
   +dbo.AddZeroPrefix(convert(decimal(14,2),SegApprovedAmt),14)                                                            
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                            
   +convert(char(33),left(e.party_Code,33))                                                            
   +convert(char(33),left(e.branch_cd,33))                                               
   +convert(char(33),left(e.sub_broker,33))                                                            
   +SPACE(33)                                                            
   ,SegApprovedAmt,VerifierId                                                  
   from                                                            
   #NCMS_SegPayoutAppAmt a                                                     
   join cms.dbo.ncms_Entity_ICICI b on a.segment=b.segment                                                            
   join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                             
   left outer join cms.dbo.NCMS_ClientBankDetails_all d with(nolock) on ltrim(rtrim(c.Req_PayBankId))=ltrim(rtrim(d.acno)) and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                            
   and c.Party_code=d.cltcode  and d.paymode='NEFT'                                                         
   /*left outer join risk.dbo.client_Details e */  /*Commented on 01 Dec 2017 For MFSS codes*/                      
   left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e /*vw_NCMS_MFSS_client_details*/ with(nolock)                                                        
   on a.Party_Code=e.party_code                                                            
 end                      
 /************Adding Log Table******************************/                      
                       
     insert into  NCMS_BANKfile_DetailData(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                      
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),acno,bankname,Batchid from #NCMS_SegPayoutAppAmt a                                                             
 join cms.dbo.ncms_Entity_ICICI b on a.segment=b.segment                                                            
 join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                             
 left outer join cms.dbo.NCMS_ClientBankDetails_all d on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                            
 and c.Party_code=d.cltcode  and d.paymode='NEFT'    
 
  insert into  NCMS_BANKfile_DetailData(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                      
 select a.VerifierID,a.Req_RefNo,a.Party_Code,a.Segment,a.SegApprovedAmt,a.PayMode,POid,GETDATE(),c.Accno,c.IFSC,Batchid from 
 #NCMS_SegPayoutAppAmt a                                                             
 join cms.dbo.ncms_Entity_ICICI b on a.segment=b.segment                                                            
 join #df c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code 
   where c.bank_provider='ICICI'

 delete from #ICICIdata where content IS NULL                                      
                                                       
 if (SELECT COUNT(1) FROM #ICICIdata) > 0                                                            
 BEGIN                                                      
                                                    
  if (SELECT COUNT(1) FROM NCMS_ICICIBank_log where segment=@segment) > 0                                            
   select @batid=risk.dbo.AddZeroPrefox(max(ISNULL(convert(int,BatchNo),0))+1,4) from NCMS_ICICIBank_log where segment=@segment                                   
  ELSE                                            
   SET @batid='0001'                                            
                                                      
  TRUNCATE TABLE NCMS_ICICIBank                                                             
                                                          
  insert into NCMS_ICICIBank(flag,content,verifierId,SegApprovedAmt)                                               
  select flag,content,verifierId,SegApprovedAmt from                                                            
  (                                                            
  --select flag=0,content='H'+CONVERT(char(10),getdate(),103)+'COMPANY'+replace(CONVERT(char(10),getdate(),103),'/','')+SPACE(5),0 as verifierId                                                            
  --union all                                       
  select flag=1,content,verifierId,SegApprovedAmt  from #ICICIdata                                                            
  --union all                                                            
  --select flag=9,content='F'++risk.dbo.AddZeroPrefox(COUNT(1),5)++dbo.AddZeroPrefix(convert(decimal(14,2),SUM(SegApprovedAmt)),14),0 as verifierId                                                            
  --from #ICICIdata                                                            
  )  a                                          
                              
  /* delete from NCMS_YesBank where content IS NULL  */                       
  DECLARE @s VARCHAR(MAX) = ''                      
  declare @FileName as varchar(100) ='',@batchid as varchar(20)=''                      
  declare @FilePath varchar(200) =''                        
  select distinct @batchid=batchid from NCMS_BANKfile_DetailData                      
                      
  if(@segment='MCX')               
  Begin                                                                 
   set @FileName = 'ANGELCAP_ANGELCAPUP_MCX31380_ANGMCXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                          
  End                          
    if(@segment='NSEFO')                      
  Begin                                                                 
   set @FileName = 'ANGELCAP_ANGELCAPUP_FO30379_ANGFOUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                    
  End                      
    if(@segment='BSECM')                      
  Begin                                                                 
   set @FileName = 'ANGELCAP_ANGELCAPUP_BSE24924_ANGBSEUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                          
  End                      
    if(@segment='NSECM')                      
  Begin                                                                 
   set @FileName = 'ANGELCAP_ANGELUPLD2_NSE24925_ANGNSEUP_Testing'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                       
  End                      
    if(@segment='NSX')                      
  Begin                                                                 
   set @FileName = 'ANGELCAP_ANGELCAPUP_NSX70663_ANGNSXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                         
  End                      
    if(@segment='MCD')                      
  Begin                                                                 
   set @FileName = 'ANGELCAP_ANGELCAPUP_MCD70752_ANGMCDUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                  
  End                      
     if(@segment='NCDEX')                      
  Begin                                                                 
   set @FileName = 'ANGELCAP_ANGELCAPUP_NCDEX31381_ANGNCDEXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                         
  End                      
  if(@segment='NBFC')                      
  Begin                                               
   /*set @FileName = 'ANGELCAP_ANGELCAPUP_NBFC_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid+'.txt' */                      
   set @FileName = 'ANGELFIN_ANGELFINUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                      
  End                      
    if(@segment='BSEMFSS')                      
  Begin                                                                 
   set @FileName = 'ANGELCAP_ANGELUPLD2_BSEMFSS_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                         
  End                      
     if(@segment='BSX')                      
  Begin                                                                 
--   set @FileName = 'ANGELCAP_ANGELCAPUP_BSX_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid+'.txt'                        
 set @FileName = 'ANGELCAP_ANGELCAPUP_BSX3132_ANGBSXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                          
  End                     
                      
                      
  truncate table tmp_NCMS_ICICIBank                      
  insert into tmp_NCMS_ICICIBank                      
  select ROW_NUMBER() over (order by verifierID) Srno,* from NCMS_ICICIBank                      
                      
  declare @cnt as numeric=0,@filecnt as numeric=1                      
  declare @max as numeric                      
  select @max=MAX(Srno) from tmp_NCMS_ICICIBank                      
  declare @tmpFileName as varchar(500)                      
                        
                        
  while(@cnt<@max)                      
  Begin           
  --declare @cnt as numeric=1                      
  truncate table tmp_NCMS_ICICIBank_batch                      
                        
   insert into tmp_NCMS_ICICIBank_batch                      
  select flag=0,content='H'+CONVERT(char(10),getdate(),103)+'COMPANY'+replace(CONVERT(char(10),getdate(),103),'/','')+SPACE(5),0 as verifierId                                                            
    union all                                                            
  select flag,content,verifierid from tmp_NCMS_ICICIBank where Srno between (@cnt+1) and (@cnt+1) + 14999                                                       
    union all                                                    
  select flag=9,content='F'++risk.dbo.AddZeroPrefox(COUNT(1),5)++dbo.AddZeroPrefix(convert(decimal(14,2),SUM(SegApprovedAmt)),14),0 as verifierId                                                            
  from tmp_NCMS_ICICIBank where Srno between (@cnt+1) and (@cnt+1) + 14999                        
                          
                      
   set @tmpFileName = @FileName+'_'+cast(@filecnt as varchar)+'.txt'                         
   select @FilePath=ltrim(rtrim(bankfolder))+@tmpFileName  from cms.dbo.ncms_Entity_ICICI where segment=@segment                          
   --set @FileName = 'Test_ANGELCAP_ANGELCAPUP_BSX3132_ANGBSXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+cast(@filecnt as varchar)+'.txt'                      
                       
  --      Exec master.dbo.xp_cmdshell 'net use \\INHOUSEHDFCLIVE-FS.angelone.in\hdfcforward\Angel_Broking\src /user:neha.naiwar@angelone.in Angel@12345670' --Live Server                            
                      
                                
    --SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                           
    --SET @s = @s + 'bcp "select content from INTRANET.cms.dbo.tmp_NCMS_ICICIBank_batch order by flag" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                         
    --SET @s = @s + ''''                              
    --EXEC(@s)                        
                         
                         
   DECLARE @s1 VARCHAR(MAX) = ''                          
   SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                            
   SET @s1 = @s1 + 'bcp "select content from dustbin.dbo.tmp_NCMS_ICICIBank_batch order by flag" queryout \\INHOUSELIVEAPP1-FS.angelone.in\d\upload\CMS_Test\ICICI_BankFile\'+@tmpFileName+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                       
                                                     
   SET @s1 = @s1 + ''''                                                                  
   EXEC(@s1)                         
                         
   --DECLARE @s2 VARCHAR(MAX) = ''                             
   --   SET @s2 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                
   --   SET @s2 = @s2 + 'bcp "select distinct content from INTRANET.cms.dbo.tmp_NCMS_ICICIBank_batch" queryout \\INHOUSEHDFCLIVE-FS.angelone.in\hdfcforward\'+@tmpFileName+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                   
   --   SET @s2 = @s2 + ''''                                                                      
   --   EXEC(@s2)                         
                           
                      
  set @cnt=@cnt+15000                      
  set @filecnt= @filecnt+1                      
                      
     insert into NCMS_BankFileName_log                            
     select @tmpFileName,SegApprovedAmt,'ICICI',@batchid,GETDATE() from tmp_NCMS_ICICIBank with(nolock) where verifierid in                            
     (select verifierid from tmp_NCMS_ICICIBank_batch with(nolock) )                      
                      
  end                      
                        
     -- select @FilePath=ltrim(rtrim(bankfolder))+@FileName  from ncms_Entity_ICICI where segment=@segment                              
                                                       
     -- SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                            
     -- SET @s = @s + 'bcp "select content from INTRANET.cms.dbo.NCMS_ICICIBank order by flag" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uinhouse -Pinh6014'                                                                                    
  
    
      
       
           
            
              
                
                  
                    
                           
                           
                       
                       
                             
     -- SET @s = @s + ''''                              
     -- EXEC(@s)                        
                        
     --/* CREATE COPY FILE FOR REFERENCE */                              
     ----if (select COUNT(1) from NCMS_Entity where bankfolder like '%136%' and Segment=@segment) >= 1                              
     ----Begin                              
                        
     --DECLARE @s1 VARCHAR(MAX) = ''                          
     --SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                           
     --SET @s1 = @s1 + 'bcp "select content from INTRANET.cms.dbo.NCMS_ICICIBank order by flag" queryout \\INHOUSELIVEAPP2-FS.angelone.in\d\upload\CMS_Test\ICICI_BankFile\'+@FileName+' -c -t, -SABVSNCMS.angelone.in -Uinhouse -Pinh6014'                    
  
    
      
        
          
            
              
                
                  
                    
                                            
                           
                                 
                       
                          
                                                                    
     --SET @s1 = @s1 + ''''                                                                  
     --EXEC(@s1)                                    
 -- End 
 
  update NCMS_SegPayoutAppAmt set BANK_gen=1,BOFF_gen=1,paymode=b.pmode from                                      
  (select a.verifierId,pmode=SUBSTRING(content,2,3),c.Req_RefNo from NCMS_ICICIBank a 
		join #df c on a.verifierId=c.verifierid
         and c.Bank_Provider='ICICI' where flag=1)b                                                   
  where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid  and NCMS_SegPayoutAppAmt.Req_RefNo  =b.Req_RefNo                                                             
  and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and
  NCMS_SegPayoutAppAmt.Paymode is not NULL   and ODIN_gen=2                                                       

                                                          
  update NCMS_SegPayoutAppAmt set BANK_gen=1,paymode=b.pmode from                                      
  (select verifierid,pmode=SUBSTRING(content,2,3) from NCMS_ICICIBank where flag=1)b                                                   
  where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid                                                             
  and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and 
  NCMS_SegPayoutAppAmt.Paymode is not NULL  and ODIN_gen=0                                                          
                                         
  insert into NCMS_ICICIBank_log(flag,content,verifierId,GeneratedOn,BatchNo,segment)                                                             
  select flag,content,verifierId,GETDATE(),@batid,@segment from NCMS_ICICIBank                                                            
 END                                                            
                                                            
 set @ctr=@ctr+1                                                            
 DROP TABLE #df                                                
END                                                            

                                                           
DROP TABLE #ICICIdata                                                            
DROP TABLE #CtrFile                                                            
                                                            
End try                                                                                     
BEGIN CATCH                                                                       
                                                                                    
 insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                             
 select GETDATE(),'NCMS_ICICIBankFileGeneration',ERROR_LINE(),ERROR_MESSAGE()                                                                                              
                                                       
 DECLARE @ErrorMessage NVARCHAR(4000);                                                                                          
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                                          
 RAISERROR (@ErrorMessage , 16, 1);                                                             
                                                             
End catch                           
                                                          
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_ICICIBankFileGeneration_06May2025
-- --------------------------------------------------
--exec [NCMS_YesBankFileGeneration]                                                                   
 --NCMS_SegPayoutAppAmt where SegApprovedAmt>0 and BANK_gen=0  order by processdatetime desc                                                                
create procedure [dbo].[NCMS_ICICIBankFileGeneration_06May2025]                                                                                                      
as                                                                                                      
Set nocount on                                                                                                                          
SET XACT_ABORT ON                                                                                                                             
BEGIN TRY                                                                  
                                                                  
  declare @StatusDupli varchar(20)                                                                                             
  set @StatusDupli=''                                                                           
  exec CMS.dbo.Get_JoBStatus 'NCMS Double Entry in ACC no',@StatusDupli  output                                                                                             
                                                                      
  if(@StatusDupli='In Progress')                                                                                              
   print 'job is already running'                                                                                          
  else                                                                                      
   EXEC msdb.dbo.sp_start_job 'NCMS Double Entry in ACC no'                                                                   
                                                
   insert into temp_withdraw2_hist(Id,VerifierID,RequestID,Req_RefNo,Party_Code,ENTITY,SEGMENT,PO_ApprovedAmt,NetPAyable,                                          
  SegApprovedAmt,ODIN_gen,Accno,IFSC,Bank_Provider,processedflag,UpdatedOn)                                          
  select Id,VerifierID,RequestID,Req_RefNo,Party_Code,ENTITY,SEGMENT,PO_ApprovedAmt,NetPAyable,                                          
  SegApprovedAmt,ODIN_gen,Accno,IFSC,Bank_Provider,processedflag,UpdatedOn from  temp_withdraw2                                          
                                            
  truncate table temp_withdraw2                                          
                                            
if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)                                                                
begin                                             
if((CONVERT(VARCHAR(5),GETDATE(),108)>='10:15') and (CONVERT(VARCHAR(5),GETDATE(),108)<='17:00'))                                                                      
Begin                                           
BEGIN TRANSACTION                                          
                                          
  declare @processdate datetime,@maxBatchid varchar(15) = ''                                           
  select @processdate=max(ProcessDateTime),@maxBatchid=max(Batchid) from NCMS_SegPayoutAppAmt with(nolock)                                          
                                          
  insert into temp_withdraw2                                           
  select  * from tbl_withdarw_stag where processedflag='No'                                          
                                          
 insert into NCMS_SegPayoutAppAmt(RequestID,VerifierID,Req_RefNo,Party_Code,                                          
 Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt,BOFF_gen,BANK_gen,ODIN_gen,ProcessDateTime,BOFF_Posted,Batchid)                                          
 select RequestID,101,Req_RefNo,Party_code,Entity,Segment,PO_ApprovedAmt,                       
 NetPAyable,SegApprovedAmt,0,0,2,@processdate,0,@maxBatchid                     
  from temp_withdraw2             
           
 update temp_withdraw2 set VerifierID=101          
                                          
 update a set processedflag='Yes' from tbl_withdarw_stag a, temp_withdraw2  b where a.party_code= b.party_code and                          
 a.Req_RefNo=b.Req_RefNo                                          
 and a.processedflag='No'                                          
                                          
COMMIT TRANSACTION                                     
end                                            
end                          
                                                                    
Exec NCMS_HDFCBankFileGeneration_For_HDFCAcconts /*Commented on 14 FEb 2023 as per JIRA ticket - ORE-1975*/                                 
                                                          
insert into NCMS_BANKfile_DetailData_hist                                                      
select *,GETDATE() from NCMS_BANKfile_DetailData                                          
                                                                  
truncate table NCMS_BANKfile_DetailData                                                     
                                                                                          
select ROW_NUMBER() OVER ( ORDER BY segment ) AS [SrNo],segment                                                                                          
into #CtrFile                                                                                                     
from ncms_Entity_ICICI where BO_bankname='ICICI BANK' and ActiveStatus=1 /*  and Segment='MCX'*/                                                                
order by entity desc,seqid                                                         
                                                                
select distinct party_code,entity,req_paybankid,req_refno into #Ncms_Po_request from Ncms_Po_request with(nolock)                                                                                    
                                                                 
Declare @ctr int = 1,@totctr int = 0,@segment as varchar(10) = '',@batid as char(4) = ''                                                                                          
select @totctr=MAX(srno) from #CtrFile                                                                                                      
                                                                                                      
CREATE TABLE #ICICIdata                                                                                                      
(                                                                                                      
Content VARCHAR(8000),                                                                                                      
SegApprovedAmt MONEY,                                                                                                      
VerifierId INT                                                                                                      
)                                                                                                      
                                                                                          
select                                                                                                       
VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,PayMode,/*poid+4000000 as POid*/convert(bigint,poid+4000000) as POid,Batchid                                                                                                      
into #NCMS_SegPayoutAppAmt                                                                                           
from NCMS_SegPayoutAppAmt where 1=2                   
                                                                                                      
WHILE @ctr <= @totctr                                                                                  
BEGIN                                                 
                                                                                                      
 select @segment=segment from  #CtrFile where srno=@ctr                                                                                               
                                               
 TRUNCATE TABLE #ICICIdata                                                                                   
 TRUNCATE TABLE #NCMS_SegPayoutAppAmt                                                                                                    
                                                                           
                                                           
 update NCMS_SegPayoutAppAmt set Paymode='N06'--dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt)                                            
 where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment                                        
                                                               
 insert into #NCMS_SegPayoutAppAmt                                                                                          
 select                                                                                                       
 VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,Paymode,/*poid+4000000 as POid*/  '99'+CONVERT(varchar(15), poid+4000000)                                                                  
 ,Batchid                                                
 from NCMS_SegPayoutAppAmt                                                                                                       
 where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment and ODIN_gen=0                                           
 and convert(date,ProcessDateTime)>= CONVERT(date,GETDATE())                                          
                                           
  /*******For Withdraw2*****************************************/                                          
                                               
insert into #NCMS_SegPayoutAppAmt                                                                                          
 select                                                                             
 a.VerifierId,a.Req_RefNo,a.Party_Code,a.Entity,a.Segment,a.SegApprovedAmt,Paymode,POid                                                                
 ,Batchid                                                                           
 from NCMS_SegPayoutAppAmt a join temp_withdraw2 b on a.Party_Code=b.Party_Code and a.Req_RefNo=b.Req_RefNo                                               
 where a.SegApprovedAmt>0 and BANK_gen=0 and a.Segment=@segment and a.ODIN_gen=2 and convert(date,ProcessDateTime)>=                                          
 CONVERT(date,GETDATE()) --and b.Bank_Provider='ICICI'                                          
                                         
select c.*,branch_cd,sub_broker,long_name into #df from  temp_withdraw2 c left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client d with(nolock) on                                               
c.Party_code=d.party_code                                           
                                           
 /*******************************/                                          
                                                                 
 update #NCMS_SegPayoutAppAmt set Paymode='N06' where paymode is null                                                              
                                                                                    
 delete from    #NCMS_SegPayoutAppAmt where paymode is null                                                                                         
                                                               
 if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)                                                                
 begin                                                                           
   INSERT INTO #ICICIdata                                   
   select Content='D'                                                                                                      
   /*+(Case when SegApprovedAmt > 200000 then 'R41' else 'N06' end)     */                                                                    
   /* +dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt) */                                                                                    
   +convert(char(3),a.Paymode)                                                                                    
   +convert(char(15),left(BO_AccNo,15))                                                                                                      
   +convert(char(35),substring(upper(CompanyName),1,35))                                                                                                      
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                       
   +convert(char(11),d.bankname)                                                                                                      
   +convert(char(34),d.acno)                                                 
   +convert(char(35),left(upper(dbo.fn_StripCharacters(e.long_name)),35))                                                                                                        
   +convert(char(35),'')                                                      
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                   
   +convert(char(35),'')                                                                                                      
   +convert(char(16),left(upper(a.poid),16))                                                            
   +CONVERT(char(10),getdate(),103)                                                                                                      
   +dbo.AddZeroPrefix(convert(decimal(14,2),SegApprovedAmt),14)                                                                  
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                                                                      
   +convert(char(33),left(e.party_Code,33))                                       
   +convert(char(33),left(e.branch_cd,33))                                                                                         
   +convert(char(33),left(e.sub_broker,33))                                                                                                      
   +SPACE(33)                                                            
   ,SegApprovedAmt,VerifierId                                                                                            
   from                                                                                                      
   #NCMS_SegPayoutAppAmt a                                        
   join ncms_Entity_ICICI b on a.segment=b.segment                                                                                                      
   join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                                                                    
   left outer join NCMS_ClientBankDetails_all d with(nolock) on ltrim(rtrim(c.Req_PayBankId))=ltrim(rtrim(d.acno)) and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                  
   and c.Party_code=d.cltcode  and d.paymode='NEFT'                                                                                                   
   /*left outer join risk.dbo.client_Details e */  /*Commented on 01 Dec 2017 For MFSS codes*/                                           
   left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e /*vw_NCMS_MFSS_client_details*/ with(nolock)                                                                                                  
   on a.Party_Code=e.party_code                                            
                                             
   /****For Withdraw2************/               
  INSERT INTO #ICICIdata                                                                                                      
   select Content='D'                                                                                                      
   +convert(char(3),a.Paymode)                                                                                    
   +convert(char(15),left(BO_AccNo,15))                                                                                   
   +convert(char(35),substring(upper(CompanyName),1,35))                                       
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                    
   +convert(char(11),c.ifsc)                                                                                                      
   +convert(char(34),c.accno)                                                     
   +convert(char(35),left(upper(dbo.fn_StripCharacters(c.long_name)),35))                                                                                                        
   +convert(char(35),'')                                                                                                   
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                               
   +convert(char(35),'')                                                                                                      
   +convert(char(16),left(upper(c.Req_RefNo),16))                            
   +CONVERT(char(10),getdate(),103)                                                                                                      
   +dbo.AddZeroPrefix(convert(decimal(14,2),a.SegApprovedAmt),14)                                                     
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                                                                      
   +convert(char(33),left(c.party_Code,33))                                                                                                      
   +convert(char(33),left(c.branch_cd,33))                                                                                         
   +convert(char(33),left(c.sub_broker,33))                                                                                                      
   +SPACE(33)                                                                      
   ,a.SegApprovedAmt,a.VerifierID                                                                                            
   from                                                                                                                              
   #NCMS_SegPayoutAppAmt a                                                                           
   join  ncms_Entity_ICICI b on a.segment=b.segment                                                                                              
   join #df c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                           
   where  c.ODIN_gen=2-- and c.bank_provider='ICICI'                                           
   /***********/                                          
                                                                 
    /*Start--------------------------------Added on 16 Feb 2017 by Neha Naiwar for Bill2Bill-------------------------------------------*/                                                                   
   INSERT INTO #ICICIdata                                                                
   select Content='D'                                                            
   /*+(Case when SegApprovedAmt > 200000 then 'R41' else 'N06' end)     */                                                                                        
   /* +dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt) */                                                                                
   +convert(char(3),a.Paymode)                                           
   +convert(char(15),left(BO_AccNo,15))                                                                              
   +convert(char(35),substring(upper(CompanyName),1,35))                                                                          
   +convert(char(35),'')                                                                                                  
   +convert(char(35),'')                                                                                                  
   +convert(char(35),'')                                                                                          
   +convert(char(11),d.bankname)                                                                                                  
   +convert(char(34),d.acno)                                                                                                  
   +convert(char(35),left(upper(dbo.fn_StripCharacters(e.long_name)),35))                                                                                                  
   +convert(char(35),'')                                                                                                  
   +convert(char(35),'')                                                                   
   +convert(char(35),'')                                                                                                  
   +convert(char(35),'')                                                                                                  
   +convert(char(16),left(upper(a.poid),16))                                                                                                  
   +CONVERT(char(10),getdate(),103)                                                                                                  
   +dbo.AddZeroPrefix(convert(decimal(14,2),SegApprovedAmt),14)                                                                            
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                                                                  
   +convert(char(33),left(e.party_Code,33))                                                                              
   +convert(char(33),left(e.branch_cd,33))                                                                                     
   +convert(char(33),left(e.sub_broker,33))                                        
   +SPACE(33)                                                                                
   ,SegApprovedAmt,VerifierId                                                                                        
   from                                                                                                  
   #NCMS_SegPayoutAppAmt a                                                                                                   
join ncms_Entity_ICICI b on a.segment=b.segment          
   join NCMS_B2B_PO_Request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                                                                     
   left outer join NCMS_ClientBankDetails_all d with(nolock) on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                                   
   and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1                                                                                                   
/*left outer join risk.dbo.client_Details e */  /*Commented on 01 Dec 2017 For MFSS codes*/                                                                
   left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client  e  with(nolock)  /*vw_NCMS_MFSS_client_details*/                                                                                            
   on a.Party_Code=e.party_code  WHERE c.billamt>0                                                                 
   /*End-------------------------------------------------------------------------------------------------*/                                                                    
                                                                 
 End                                                                
 else                                    
 begin                                                                
   INSERT INTO #ICICIdata                                                                                                      
   select Content='D'                                                                                                  
   /*+(Case when SegApprovedAmt > 200000 then 'R41' else 'N06' end)     */                                                                                            
   /* +dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt) */                                                                                    
   +convert(char(3),a.Paymode)                                                  
   +convert(char(15),left(BO_AccNo,15))                                                                                                      
   +convert(char(35),substring(upper(CompanyName),1,35))                                                                                                      
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                              
   +convert(char(35),'')                                                                                                      
   +convert(char(11),d.bankname)                                                                                                      
   +convert(char(34),d.acno)                                                                 
   +convert(char(35),left(upper(dbo.fn_StripCharacters(e.long_name)),35))                                                                                                        
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                                                      
   +convert(char(16),left(upper(a.poid),16))                                                             
   +CONVERT(char(10),getdate()+2,103)                                                                                                      
   +dbo.AddZeroPrefix(convert(decimal(14,2),SegApprovedAmt),14)                             
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                                                                      
   +convert(char(33),left(e.party_Code,33))                                                                                                      
   +convert(char(33),left(e.branch_cd,33))                          
   +convert(char(33),left(e.sub_broker,33))                                                                                      
   +SPACE(33)                                                                                                      
   ,SegApprovedAmt,VerifierId                                                        
   from                                                                                                      
   #NCMS_SegPayoutAppAmt a                                                                                               
   join ncms_Entity_ICICI b on a.segment=b.segment                                                                                                      
   join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                                                                       
   left outer join NCMS_ClientBankDetails_all d with(nolock) on ltrim(rtrim(c.Req_PayBankId))=ltrim(rtrim(d.acno)) and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                                                   
  
    
      
        
          
            
              
          
                  
   and c.Party_code=d.cltcode  and d.paymode='NEFT'                                                                                                   
   /*left outer join risk.dbo.client_Details e */  /*Commented on 01 Dec 2017 For MFSS codes*/                                                                
   left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e /*vw_NCMS_MFSS_client_details*/ with(nolock)                                        
   on a.Party_Code=e.party_code                                                                                                      
 end                                                                
 /************Adding Log Table******************************/                                                                
                                                                 
     insert into  NCMS_BANKfile_DetailData(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                                                                
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),acno,bankname,Batchid from #NCMS_SegPayoutAppAmt a                                                                                                       
 join ncms_Entity_ICICI b on a.segment=b.segment                                                                                                      
 join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                                                                       
 left outer join NCMS_ClientBankDetails_all d on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                                                                
 and c.Party_code=d.cltcode  and d.paymode='NEFT'                                             
                                           
 /***For Withdarw2********/                                          
   insert into  NCMS_BANKfile_DetailData(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                                   
 select a.VerifierID,a.Req_RefNo,a.Party_Code,a.Segment,a.SegApprovedAmt,a.PayMode,POid,GETDATE(),c.Accno,c.IFSC,Batchid from                                           
 #NCMS_SegPayoutAppAmt a                                                                                                       
 join  ncms_Entity_ICICI b on a.segment=b.segment                                                  
 join #df c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code          
   where c.bank_provider='ICICI'                                          
 /**************/                                          
                                                                 
 insert into  NCMS_BANKfile_DetailData(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                                     
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),acno,bankname,batchid from #NCMS_SegPayoutAppAmt a                                                                  
 join ncms_Entity_ICICI b on a.segment=b.segment                                                                                                  
 join NCMS_B2B_PO_Request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                        
 left outer join NCMS_ClientBankDetails_all d on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                                                                   
 and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1    WHERE c.billamt>0                                                                 
                        
--if((CONVERT(VARCHAR(5),GETDATE(),108)>='09:30') and (CONVERT(VARCHAR(5),GETDATE(),108)<='16:59'))                                                                    
--Begin                                                                  
 insert into tbl_RealPayout_Producer(Paymode,acno,bankname,poid,UpdateOn,SegApprovedAmt,party_code,segment,req_refno,VerifierId,batchid)                                                                
 select Paymode,acno,bankname,poid,UpdateOn,SegApprovedAmt,UPPER(RTRIM(LTRIM(Party_code))) Party_code,segment,req_refno,VerifierId,batchid                                                                
 from NCMS_BANKfile_DetailData where  verifierid<>0                                                                
                                                                
 exec USP_AMX_PAYOUT_KAFKA                                                                
--End                                                                
 /*******************************************/                                                                
                                                      
 delete from #ICICIdata where content IS NULL                                             
                                                                                                 
 if (SELECT COUNT(1) FROM #ICICIdata) > 0                                                                                                      
 BEGIN                             
                                                                                              
  if (SELECT COUNT(1) FROM NCMS_ICICIBank_log where segment=@segment) > 0                                                                                      
   select @batid=risk.dbo.AddZeroPrefox(max(ISNULL(convert(int,BatchNo),0))+1,4) from NCMS_ICICIBank_log where segment=@segment                                                                             
  ELSE                      
   SET @batid='0001'                                                                                      
                                                                                                
  TRUNCATE TABLE NCMS_ICICIBank                                                                           
                                                                                                    
insert into NCMS_ICICIBank(flag,content,verifierId,SegApprovedAmt)                                                                                 
  select flag,content,verifierId,SegApprovedAmt from      
  (                                                                                                      
  --select flag=0,content='H'+CONVERT(char(10),getdate(),103)+'COMPANY'+replace(CONVERT(char(10),getdate(),103),'/','')+SPACE(5),0 as verifierId                                                                    --union all                               
  
    
      
         
         
             
             
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                                  
  select flag=1,content,verifierId,SegApprovedAmt  from #ICICIdata                                        
  --union all                                                                                                      
  --select flag=9,content='F'++risk.dbo.AddZeroPrefox(COUNT(1),5)++dbo.AddZeroPrefix(convert(decimal(14,2),SUM(SegApprovedAmt)),14),0 as verifierId                                                                                                      
  --from #ICICIdata                                                             
  )  a                                                                                    
                                                                        
  /* delete from NCMS_YesBank where content IS NULL  */                                                         
  DECLARE @s VARCHAR(MAX) = ''                     
  declare @FileName as varchar(100) ='',@batchid as varchar(20)=''                                                                
  declare @FilePath varchar(200) =''                                                                  
  select distinct @batchid=batchid from NCMS_BANKfile_DetailData                                                                
                                                                
  if(@segment='MCX')                                                         
  Begin                                                                            
   set @FileName = 'ANGELCAP_ANGELCAPUP_MCX31380_ANGMCXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                    
  End                                                                    
    if(@segment='NSEFO')                                                                
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELCAPUP_FO30379_ANGFOUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                              
  End                 
    if(@segment='BSECM')                                                                
  Begin                                                                    
   set @FileName = 'ANGELCAP_ANGELCAPUP_BSE24924_ANGBSEUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                    
  End                                                                
    if(@segment='NSECM')                                                      
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELUPLD2_NSE24925_ANGNSEUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                            
  End                                                                
    if(@segment='NSX')                                                                
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELCAPUP_NSX70663_ANGNSXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                   
  End                                                                
    if(@segment='MCD')                                                                
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELCAPUP_MCD70752_ANGMCDUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                         
  End                                                                
     if(@segment='NCDEX')                                                                
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELCAPUP_NCDEX31381_ANGNCDEXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                   
  End                                                                
  if(@segment='NBFC')                       
  Begin                                                                                         
   /*set @FileName = 'ANGELCAP_ANGELCAPUP_NBFC_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid+'.txt' */                                                                
   set @FileName = 'ANGELFIN_ANGELFINUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                
  End                                                                
    if(@segment='BSEMFSS')            
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELUPLD2_BSEMFSS_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                   
  End                                                                
     if(@segment='BSX')                                                                
  Begin                                           
--   set @FileName = 'ANGELCAP_ANGELCAPUP_BSX_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid+'.txt'             
 set @FileName = 'ANGELCAP_ANGELCAPUP_BSX3132_ANGBSXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                    
  End                                                               
                                                         
                                                                
  truncate table tmp_NCMS_ICICIBank                                                                
  insert into tmp_NCMS_ICICIBank                                                                
  select ROW_NUMBER() over (order by verifierID) Srno,* from NCMS_ICICIBank                                                                
                                                              
  declare @cnt as numeric=0,@filecnt as numeric=1                                                                
  declare @max as numeric                                                                
  select @max=MAX(Srno) from tmp_NCMS_ICICIBank                                                                
  declare @tmpFileName as varchar(500)                                                                
                                                                  
                        
  while(@cnt<@max)                                                                
  Begin               --declare @cnt as numeric=1                                                                
  truncate table tmp_NCMS_ICICIBank_batch                                         
                                                                  
   insert into tmp_NCMS_ICICIBank_batch                                                   
  select flag=0,content='H'+CONVERT(char(10),getdate(),103)+'COMPANY'+replace(CONVERT(char(10),getdate(),103),'/','')+SPACE(5),0 as verifierId                                                                                                      
union all                                                                                                      
  select flag,content,verifierid from tmp_NCMS_ICICIBank where Srno between (@cnt+1) and (@cnt+1) + 14999                                
    union all                                                                               
  select flag=9,content='F'++risk.dbo.AddZeroPrefox(COUNT(1),5)++dbo.AddZeroPrefix(convert(decimal(14,2),SUM(SegApprovedAmt)),14),0 as verifierId                                                                                                      
  from tmp_NCMS_ICICIBank where Srno between (@cnt+1) and (@cnt+1) + 14999                                                                  
                                                                    
                                                                
   set @tmpFileName = @FileName+'_'+cast(@filecnt as varchar)+'.txt'                                            
   select @FilePath=ltrim(rtrim(bankfolder))+@tmpFileName  from ncms_Entity_ICICI where segment=@segment                                                                    
--set @FileName = 'Test_ANGELCAP_ANGELCAPUP_BSX3132_ANGBSXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+cast(@filecnt as varchar)+'.txt'                                                                
                                                                 
  --      Exec master.dbo.xp_cmdshell 'net use \\INHOUSEHDFCLIVE-FS.angelone.in\hdfcforward\Angel_Broking\src /user:neha.naiwar@angelone.in Angel@12345670' --Live Server                                                                      
                                                                
                                                                          
    SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                                                                     
    SET @s = @s + 'bcp "select content from INTRANET.cms.dbo.tmp_NCMS_ICICIBank_batch order by flag" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                               
 
    
     
    SET @s = @s + ''''                                     
    EXEC(@s)                                                                  
                                                                   
                                                                   
   DECLARE @s1 VARCHAR(MAX) = ''                                                                    
   SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                                      
   SET @s1 = @s1 + 'bcp "select content from INTRANET.cms.dbo.tmp_NCMS_ICICIBank_batch order by flag" queryout \\INHOUSELIVEAPP1-FS.angelone.in\d\upload\CMS_Test\ICICI_BankFile\'+@tmpFileName+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455G 
  
    
     
        
          
            
              
                 
                 
                     
                     
                        
                           
                
                              
                                 
                                 
                                     
                                     
                                        
                                          
                                            
                                              
                                                
                                                  
                                                    
                                                      
                                                        
                         
                                                             
                  
ZAcc'                                                                                                 
                                                           
   SET @s1 = @s1 + ''''                                                                                                            
   EXEC(@s1)                                                                   
                                                                   
   DECLARE @s2 VARCHAR(MAX) = ''           
      SET @s2 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                                          
      SET @s2 = @s2 + 'bcp "select distinct content from INTRANET.cms.dbo.tmp_NCMS_ICICIBank_batch" queryout \\INHOUSEHDFCLIVE-FS.angelone.in\hdfcforward\'+@tmpFileName+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                   
  
   
       
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
                                
                                           
                                                  
                                                    
                                                      
                                                        
                                                          
                                                            
                                                              
                                                                                
                                                                       
      SET @s2 = @s2 + ''''                                                                                                                
      EXEC(@s2)                                                                   
                                                                    
                                                                
  set @cnt=@cnt+15000                                                                
  set @filecnt= @filecnt+1                                                                
                                                             
     insert into NCMS_BankFileName_log                                                                      
     select @tmpFileName,SegApprovedAmt,'ICICI',@batchid,GETDATE() from tmp_NCMS_ICICIBank with(nolock) where verifierid in                                                                      
     (select verifierid from tmp_NCMS_ICICIBank_batch with(nolock) )                                                                
                                                                
  end                                                            
                                                                  
     -- select @FilePath=ltrim(rtrim(bankfolder))+@FileName  from ncms_Entity_ICICI where segment=@segment                                                                        
                                                                                                 
     -- SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                           
     -- SET @s = @s + 'bcp "select content from INTRANET.cms.dbo.NCMS_ICICIBank order by flag" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uinhouse -Pinh6014'                                                                                    
  
    
      
        
         
             
              
                
                  
                    
                     
                         
            
                            
                              
                                
                                  
                                                              
                                        
                                          
                                            
                                              
                                                
                                                 
                                                     
                                                      
                                                        
                                                          
                                                            
                                                             
                                                                     
                                                                     
                                                                 
                          
                                                                       
     -- SET @s = @s + ''''                                                                        
     -- EXEC(@s)                                                                  
                                                                  
     --/* CREATE COPY FILE FOR REFERENCE */                                                                        
    ----if (select COUNT(1) from NCMS_Entity where bankfolder like '%136%' and Segment=@segment) >= 1                                                                        
     ----Begin                                                                        
                                                    
     --DECLARE @s1 VARCHAR(MAX) = ''                                                                    
     --SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                  
     --SET @s1 = @s1 + 'bcp "select content from INTRANET.cms.dbo.NCMS_ICICIBank order by flag" queryout \\INHOUSELIVEAPP2-FS.angelone.in\d\upload\CMS_Test\ICICI_BankFile\'+@FileName+' -c -t, -SABVSNCMS.angelone.in -Uinhouse -Pinh6014'                    
  
    
      
        
          
            
              
               
                   
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
          
                                                
                                                  
                                                    
                                                      
                                                        
                                                          
                                                            
                                                              
              
                                                                 
                                                                           
                                                                 
                                                                    
                                                                                                              
     --SET @s1 = @s1 + ''''                                                                                                            
     --EXEC(@s1)                               
 -- End                                                                        
                                            
    update NCMS_SegPayoutAppAmt set BANK_gen=1,BOFF_gen=1/*,paymode=b.pmode*/ from                                                                                
  (select a.verifierId,pmode=SUBSTRING(content,2,3),c.Req_RefNo from NCMS_ICICIBank a                                           
  join #df c on a.verifierId=c.verifierid                                          
         and c.Bank_Provider='ICICI' where flag=1)b                                                                                             
  where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid  and NCMS_SegPayoutAppAmt.Req_RefNo  =b.Req_RefNo                                                                                                       
  and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and                                          
  NCMS_SegPayoutAppAmt.Paymode is not NULL   and NCMS_SegPayoutAppAmt.ODIN_gen=2                                           
                     
  update NCMS_SegPayoutAppAmt set BANK_gen=1,paymode=b.pmode from                                                                              
  (select verifierid,pmode=SUBSTRING(content,2,3) from NCMS_ICICIBank where flag=1)b                                                                         
  where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid                                                                                                     
  and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and                                           
  NCMS_SegPayoutAppAmt.Paymode is not NULL   and NCMS_SegPayoutAppAmt.ODIN_gen=0                                                                                             
                         
  insert into NCMS_ICICIBank_log(flag,content,verifierId,GeneratedOn,BatchNo,segment)                                                                                                       
  select flag,content,verifierId,GETDATE(),@batid,@segment from NCMS_ICICIBank                                       
 END                                                             
                                                                                                      
 set @ctr=@ctr+1                                      
  DROP TABLE #df                                                                                          
                                          
                                                                                          
END                                                                                                      
                                                                                                      
DROP TABLE #ICICIdata                                                                            
DROP TABLE #CtrFile                                                                                                      
                                                                                                      
End try                                                                                      
BEGIN CATCH                                                                                                                 
                                                               
 insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                       
 select GETDATE(),'NCMS_ICICIBankFileGeneration',ERROR_LINE(),ERROR_MESSAGE()                                                                                                                                        
                                                                                                 
 DECLARE @ErrorMessage NVARCHAR(4000);                                                                                                                                    
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                               
 RAISERROR (@ErrorMessage , 16, 1);                                       
                                                                                                       
End catch                                                                     
                                                        
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_ICICIBankFileGeneration_09Oct2025
-- --------------------------------------------------
                                                       
CREATE procedure [dbo].[NCMS_ICICIBankFileGeneration_09Oct2025]                                                                                                      
as                                                                                                      
Set nocount on                                                                                                                          
SET XACT_ABORT ON                                                                                                                             
BEGIN TRY                                                                  
                                                                  
  declare @StatusDupli varchar(20)                                                                                             
  set @StatusDupli=''                                                                           
  exec CMS.dbo.Get_JoBStatus 'NCMS Double Entry in ACC no',@StatusDupli  output                                                                                             
                                                                      
  if(@StatusDupli='In Progress')                                                                                              
   print 'job is already running'                                                                                          
  else                                                                                      
   EXEC msdb.dbo.sp_start_job 'NCMS Double Entry in ACC no'                                                                   
 
if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:30') and (CONVERT(VARCHAR(5),GETDATE(),108)<='17:00'))                                                                      
Begin                                           
	Exec NCMS_HDFCBankFileGeneration_For_HDFCAcconts 
End 

Exec NCMS_AXISBankFileGeneration
return

insert into NCMS_BANKfile_DetailData_hist                                                      
select *,GETDATE() from NCMS_BANKfile_DetailData                                          
                                                                  
truncate table NCMS_BANKfile_DetailData                                                     
                                                                                          
select ROW_NUMBER() OVER ( ORDER BY segment ) AS [SrNo],segment                                                                                          
into #CtrFile                                                                                                     
from ncms_Entity_ICICI where BO_bankname='ICICI BANK' and ActiveStatus=1 /*  and Segment='MCX'*/                                                                
order by entity desc,seqid                                                         
                                                                
select distinct party_code,entity,req_paybankid,req_refno into #Ncms_Po_request from Ncms_Po_request with(nolock)                                                                                    
                                                                 
Declare @ctr int = 1,@totctr int = 0,@segment as varchar(10) = '',@batid as char(5) = ''                                                                                          
select @totctr=MAX(srno) from #CtrFile                                                                                                      
                                                                                                      
CREATE TABLE #ICICIdata                                                                                                      
(                                                                                                      
Content VARCHAR(8000),                                                                                                      
SegApprovedAmt MONEY,                                                                                                      
VerifierId INT                                                                                                      
)                                                                                                      
                                                                                          
select                                                                                                       
VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,PayMode,/*poid+4000000 as POid*/convert(bigint,poid+4000000) as POid,Batchid                                                                                                      
into #NCMS_SegPayoutAppAmt                                                                                           
from NCMS_SegPayoutAppAmt where 1=2                   
                                                                                                      
WHILE @ctr <= @totctr                                                                                  
BEGIN                                                 
                                                                                                      
 select @segment=segment from  #CtrFile where srno=@ctr                                                                                               
                                               
 TRUNCATE TABLE #ICICIdata                                                                                   
 TRUNCATE TABLE #NCMS_SegPayoutAppAmt                                                                                                    
                                                                           
                                                           
 update NCMS_SegPayoutAppAmt set Paymode='N06'--dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt)                                            
 where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment                                        
                                                               
 insert into #NCMS_SegPayoutAppAmt                                                                                          
 select                                                                                                       
 VerifierId,Req_RefNo,Party_Code,Entity,Segment,SegApprovedAmt,Paymode,/*poid+4000000 as POid*/  '99'+CONVERT(varchar(15), poid+4000000)                                                                  
 ,Batchid                                                
 from NCMS_SegPayoutAppAmt                                                                                                       
 where SegApprovedAmt>0 and BANK_gen=0 and Segment=@segment and ODIN_gen=0                                           
 and convert(date,ProcessDateTime)>= CONVERT(date,GETDATE())                                          
                                           
  /*******For Withdraw2*****************************************/                                          
                                               
insert into #NCMS_SegPayoutAppAmt                                                                                          
 select                                                                             
 a.VerifierId,a.Req_RefNo,a.Party_Code,a.Entity,a.Segment,a.SegApprovedAmt,Paymode,POid                                                                
 ,Batchid                                                                           
 from NCMS_SegPayoutAppAmt a join temp_withdraw2 b on a.Party_Code=b.Party_Code and a.Req_RefNo=b.Req_RefNo                                               
 where a.SegApprovedAmt>0 and BANK_gen=0 and a.Segment=@segment and a.ODIN_gen=2 and convert(date,ProcessDateTime)>=                                          
 CONVERT(date,GETDATE()) --and b.Bank_Provider='ICICI'                                          
                                         
select c.*,branch_cd,sub_broker,long_name into #df from  temp_withdraw2 c left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client d with(nolock) on                                               
c.Party_code=d.party_code                                           
                                           
 /*******************************/                                          
                                                                 
 update #NCMS_SegPayoutAppAmt set Paymode='N06' where paymode is null                                                              
                                                                                    
 delete from    #NCMS_SegPayoutAppAmt where paymode is null                                                                                         
                                                               
 if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)                                                                
 begin                                                                           
   INSERT INTO #ICICIdata                                   
   select Content='D'                                                                                                      
   /*+(Case when SegApprovedAmt > 200000 then 'R41' else 'N06' end)     */                                                                    
   /* +dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt) */                                                                                    
   +convert(char(3),a.Paymode)                                                                                    
   +convert(char(15),left(BO_AccNo,15))                                                                                                      
   +convert(char(35),substring(upper(CompanyName),1,35))                                                                                                      
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                       
   +convert(char(11),d.bankname)                                                                                                      
   +convert(char(34),d.acno)                                                 
   +convert(char(35),left(upper(dbo.fn_StripCharacters(e.long_name)),35))                                                                                                        
   +convert(char(35),'')                                                      
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                   
   +convert(char(35),'')                                                                                                      
   +convert(char(16),left(upper(a.poid),16))                                                            
   +CONVERT(char(10),getdate(),103)                                                                                                      
   +dbo.AddZeroPrefix(convert(decimal(14,2),SegApprovedAmt),14)                                                                  
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                                                                      
   +convert(char(33),left(e.party_Code,33))                                       
   +convert(char(33),left(e.branch_cd,33))                                                                                         
   +convert(char(33),left(e.sub_broker,33))                                                                                                      
   +SPACE(33)                                                            
   ,SegApprovedAmt,VerifierId                                                                                            
   from                                                                                                      
   #NCMS_SegPayoutAppAmt a                                        
   join ncms_Entity_ICICI b on a.segment=b.segment                                                                                                      
   join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                                                                    
   left outer join NCMS_ClientBankDetails_all d with(nolock) on ltrim(rtrim(c.Req_PayBankId))=ltrim(rtrim(d.acno)) and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                  
   and c.Party_code=d.cltcode  and d.paymode='NEFT'                                                                                                   
   /*left outer join risk.dbo.client_Details e */  /*Commented on 01 Dec 2017 For MFSS codes*/                                           
   left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e /*vw_NCMS_MFSS_client_details*/ with(nolock)                                                                                                  
   on a.Party_Code=e.party_code                                            
                                             
   /****For Withdraw2************/               
  INSERT INTO #ICICIdata                                                                                                      
   select Content='D'                                                                                                      
   +convert(char(3),a.Paymode)                                                                                    
   +convert(char(15),left(BO_AccNo,15))                                                                                   
   +convert(char(35),substring(upper(CompanyName),1,35))                                       
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                    
   +convert(char(11),c.ifsc)                                                                                                      
   +convert(char(34),c.accno)                                                     
   +convert(char(35),left(upper(dbo.fn_StripCharacters(c.long_name)),35))                                                                                                        
   +convert(char(35),'')                                                                                                   
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                               
   +convert(char(35),'')                                                                                                      
   +convert(char(16),left(upper(c.Req_RefNo),16))                            
   +CONVERT(char(10),getdate(),103)                                                                                                      
   +dbo.AddZeroPrefix(convert(decimal(14,2),a.SegApprovedAmt),14)                                                     
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                                                                      
   +convert(char(33),left(c.party_Code,33))                                                                                                      
   +convert(char(33),left(c.branch_cd,33))                                                                                         
   +convert(char(33),left(c.sub_broker,33))                                                                                                      
   +SPACE(33)                                                                      
   ,a.SegApprovedAmt,a.VerifierID                                                                                            
   from                                                                                                                              
   #NCMS_SegPayoutAppAmt a                                                                           
   join  ncms_Entity_ICICI b on a.segment=b.segment                                                                                              
   join #df c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                           
   where  c.ODIN_gen=2-- and c.bank_provider='ICICI'                                           
   /***********/                                          
                                                                 
    /*Start--------------------------------Added on 16 Feb 2017 by Neha Naiwar for Bill2Bill-------------------------------------------*/                                                                   
   INSERT INTO #ICICIdata                                                                
   select Content='D'                                                            
   /*+(Case when SegApprovedAmt > 200000 then 'R41' else 'N06' end)     */                                                                                        
   /* +dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt) */                                                                                
   +convert(char(3),a.Paymode)                                           
   +convert(char(15),left(BO_AccNo,15))                                                                              
   +convert(char(35),substring(upper(CompanyName),1,35))                                                                          
   +convert(char(35),'')                                                                                                  
   +convert(char(35),'')                                                                                                  
   +convert(char(35),'')                                                                                          
   +convert(char(11),d.bankname)                                                                                                  
   +convert(char(34),d.acno)                                                                                                  
   +convert(char(35),left(upper(dbo.fn_StripCharacters(e.long_name)),35))                                                                                                  
   +convert(char(35),'')                                                                                                  
   +convert(char(35),'')                                                                   
   +convert(char(35),'')                                                                                                  
   +convert(char(35),'')                                                                                                  
   +convert(char(16),left(upper(a.poid),16))                                                                                                  
   +CONVERT(char(10),getdate(),103)                                                                                                  
   +dbo.AddZeroPrefix(convert(decimal(14,2),SegApprovedAmt),14)                                                                            
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                                                                  
   +convert(char(33),left(e.party_Code,33))                                                                              
   +convert(char(33),left(e.branch_cd,33))                                                                                     
   +convert(char(33),left(e.sub_broker,33))                                        
   +SPACE(33)                                                                                
   ,SegApprovedAmt,VerifierId                                                                                        
   from                                                                                                  
   #NCMS_SegPayoutAppAmt a                                                                                                   
join ncms_Entity_ICICI b on a.segment=b.segment          
   join NCMS_B2B_PO_Request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                                                                     
   left outer join NCMS_ClientBankDetails_all d with(nolock) on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                                   
   and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1                                                                                                   
/*left outer join risk.dbo.client_Details e */  /*Commented on 01 Dec 2017 For MFSS codes*/                                                                
   left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client  e  with(nolock)  /*vw_NCMS_MFSS_client_details*/                                                                                            
   on a.Party_Code=e.party_code  WHERE c.billamt>0                                                                 
   /*End-------------------------------------------------------------------------------------------------*/                                                                    
                                                                 
 End                                                                
 else                                    
 begin                                                                
   INSERT INTO #ICICIdata                                                                                                      
   select Content='D'                                                                                                  
   /*+(Case when SegApprovedAmt > 200000 then 'R41' else 'N06' end)     */                                                                                            
   /* +dbo.NCMS_YesBankTag_R41N06(SegApprovedAmt) */                                                                                    
   +convert(char(3),a.Paymode)                                                  
   +convert(char(15),left(BO_AccNo,15))                                                                                                      
   +convert(char(35),substring(upper(CompanyName),1,35))                                                                                                      
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                              
   +convert(char(35),'')                                                                                                      
   +convert(char(11),d.bankname)                                                                                                      
   +convert(char(34),d.acno)                                                                 
   +convert(char(35),left(upper(dbo.fn_StripCharacters(e.long_name)),35))                                                                                                        
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                                                        
   +convert(char(35),'')                                                                                                      
   +convert(char(16),left(upper(a.poid),16))                                                             
   +CONVERT(char(10),getdate()+2,103)                                                                                                      
   +dbo.AddZeroPrefix(convert(decimal(14,2),SegApprovedAmt),14)                             
   +CONVERT(char(27),'RTGS/NEFT Payout Trf.')                                                                                                      
   +convert(char(33),left(e.party_Code,33))                                                                                                      
   +convert(char(33),left(e.branch_cd,33))                          
   +convert(char(33),left(e.sub_broker,33))                                                                                      
   +SPACE(33)                                                                                                      
   ,SegApprovedAmt,VerifierId                                                        
   from                                                                                                      
   #NCMS_SegPayoutAppAmt a                                                                                               
   join ncms_Entity_ICICI b on a.segment=b.segment                                                                                                      
   join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                                                                       
   left outer join NCMS_ClientBankDetails_all d with(nolock) on ltrim(rtrim(c.Req_PayBankId))=ltrim(rtrim(d.acno)) and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                                                   
  
    
      
        
          
            
              
          
                  
   and c.Party_code=d.cltcode  and d.paymode='NEFT'                                                                                                   
   /*left outer join risk.dbo.client_Details e */  /*Commented on 01 Dec 2017 For MFSS codes*/                                                                
   left outer join risk.dbo.vw_NCMS_MFSS_client_details_NCMS_Client e /*vw_NCMS_MFSS_client_details*/ with(nolock)                                        
   on a.Party_Code=e.party_code                                                                                                      
 end                                                                
 /************Adding Log Table******************************/                                                                
                                                                 
     insert into  NCMS_BANKfile_DetailData(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                                                                
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),acno,bankname,Batchid from #NCMS_SegPayoutAppAmt a                                                                                                       
 join ncms_Entity_ICICI b on a.segment=b.segment                                                                                                      
 join #Ncms_Po_request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                                                                       
 left outer join NCMS_ClientBankDetails_all d on c.Req_PayBankId=d.acno and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                                                                
 and c.Party_code=d.cltcode  and d.paymode='NEFT'                                             
                                           
 /***For Withdarw2********/                                          
   insert into  NCMS_BANKfile_DetailData(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                                   
 select a.VerifierID,a.Req_RefNo,a.Party_Code,a.Segment,a.SegApprovedAmt,a.PayMode,POid,GETDATE(),c.Accno,c.IFSC,Batchid from                                           
 #NCMS_SegPayoutAppAmt a                                                                                                       
 join  ncms_Entity_ICICI b on a.segment=b.segment                                                  
 join #df c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code          
   where c.bank_provider='ICICI'                                          
 /**************/                                          
                                                                 
 insert into  NCMS_BANKfile_DetailData(VerifierId,Req_RefNo,Party_Code,Segment,SegApprovedAmt,PayMode,POid,UpdateOn,acno,bankname,batchid)                                     
      select VerifierId,a.Req_RefNo,a.Party_Code,a.Segment,SegApprovedAmt,a.PayMode,POid,GETDATE(),acno,bankname,batchid from #NCMS_SegPayoutAppAmt a                                                                  
 join ncms_Entity_ICICI b on a.segment=b.segment                                                                                                  
 join NCMS_B2B_PO_Request c on a.Req_RefNo=c.Req_RefNo and a.entity=c.entity and a.Party_Code=c.Party_code                                                        
 left outer join NCMS_ClientBankDetails_all d on c.Party_Code=d.Cltcode and replace(c.Entity,'AllSegment','AllSegment')=d.domain                                                                                                   
 and c.Party_code=d.cltcode  and d.paymode='NEFT' and ISNULL(USERaPPsTATUS,0)=2 and d.selforonline=1    WHERE c.billamt>0                                                                 
                        
--if((CONVERT(VARCHAR(5),GETDATE(),108)>='09:30') and (CONVERT(VARCHAR(5),GETDATE(),108)<='16:59'))                                                                    
--Begin                                                                  
 insert into tbl_RealPayout_Producer(Paymode,acno,bankname,poid,UpdateOn,SegApprovedAmt,party_code,segment,req_refno,VerifierId,batchid)                                                                
 select Paymode,acno,bankname,poid,UpdateOn,SegApprovedAmt,UPPER(RTRIM(LTRIM(Party_code))) Party_code,segment,req_refno,VerifierId,batchid                                                                
 from NCMS_BANKfile_DetailData where  verifierid<>0   
 
 insert into tbl_RealPayout_Producer_hist(Paymode,acno,bankname,poid,UpdateOn,SegApprovedAmt,party_code,segment,req_refno,
 VerifierId,batchid,Provider,updatedOn)                                                                
 select Paymode,acno,bankname,poid,UpdateOn,SegApprovedAmt,UPPER(RTRIM(LTRIM(Party_code))) Party_code,segment,req_refno,
 VerifierId,batchid,'ICICI',GETDATE()                                                                
 from NCMS_BANKfile_DetailData where  verifierid<>0  

                                                                
 exec USP_AMX_PAYOUT_KAFKA                                                                
--End                                                                
 /*******************************************/                                                                
                                                      
 delete from #ICICIdata where content IS NULL                                             
                                                                                                 
 if (SELECT COUNT(1) FROM #ICICIdata) > 0                                                                                                      
 BEGIN                             
                                                                                              
  if (SELECT COUNT(1) FROM NCMS_ICICIBank_log where segment=@segment) > 0                                                                                      
   select @batid=risk.dbo.AddZeroPrefox(max(ISNULL(convert(int,BatchNo),0))+1,4) from NCMS_ICICIBank_log where segment=@segment                                                                             
  ELSE                      
   SET @batid='0001'                                                                                      
                                                                                                
  TRUNCATE TABLE NCMS_ICICIBank                                                                           
                                                                                                    
insert into NCMS_ICICIBank(flag,content,verifierId,SegApprovedAmt)                                                                                 
  select flag,content,verifierId,SegApprovedAmt from      
  (                                                                                                      
  --select flag=0,content='H'+CONVERT(char(10),getdate(),103)+'COMPANY'+replace(CONVERT(char(10),getdate(),103),'/','')+SPACE(5),0 as verifierId                                                                    --union all                               
  
    
      
         
         
             
             
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                                  
  select flag=1,content,verifierId,SegApprovedAmt  from #ICICIdata                                        
  --union all                                                                                                      
  --select flag=9,content='F'++risk.dbo.AddZeroPrefox(COUNT(1),5)++dbo.AddZeroPrefix(convert(decimal(14,2),SUM(SegApprovedAmt)),14),0 as verifierId                                                                                                      
  --from #ICICIdata                                                             
  )  a                                                                                    
                                                                        
  /* delete from NCMS_YesBank where content IS NULL  */                                                         
  DECLARE @s VARCHAR(MAX) = ''                     
  declare @FileName as varchar(100) ='',@batchid as varchar(20)=''                                                                
  declare @FilePath varchar(200) =''                                                                  
  select distinct @batchid=batchid from NCMS_BANKfile_DetailData                                                                
                                                                
  if(@segment='MCX')                                                         
  Begin                                                                            
   set @FileName = 'ANGELCAP_ANGELCAPUP_MCX31380_ANGMCXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                    
  End                                                                    
    if(@segment='NSEFO')                                                                
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELCAPUP_FO30379_ANGFOUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                              
  End                 
    if(@segment='BSECM')                                                                
  Begin                                                                    
   set @FileName = 'ANGELCAP_ANGELCAPUP_BSE24924_ANGBSEUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                    
  End                                                                
    if(@segment='NSECM')                                                      
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELUPLD2_NSE24925_ANGNSEUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                            
  End                                                                
    if(@segment='NSX')                                                                
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELCAPUP_NSX70663_ANGNSXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                   
  End                                                                
    if(@segment='MCD')                                                                
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELCAPUP_MCD70752_ANGMCDUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                         
  End                                                                
     if(@segment='NCDEX')                                                                
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELCAPUP_NCDEX31381_ANGNCDEXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                   
  End                                                                
  if(@segment='NBFC')                       
  Begin                                                                                         
   /*set @FileName = 'ANGELCAP_ANGELCAPUP_NBFC_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid+'.txt' */                                                                
   set @FileName = 'ANGELFIN_ANGELFINUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                
  End                                                                
    if(@segment='BSEMFSS')            
  Begin                                                                                                           
   set @FileName = 'ANGELCAP_ANGELUPLD2_BSEMFSS_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                   
  End                                                                
     if(@segment='BSX')                                                                
  Begin                                           
--   set @FileName = 'ANGELCAP_ANGELCAPUP_BSX_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid+'.txt'             
 set @FileName = 'ANGELCAP_ANGELCAPUP_BSX3132_ANGBSXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+@batid                                                                                                    
  End                                                               
                                                         
                                                                
  truncate table tmp_NCMS_ICICIBank                                                                
  insert into tmp_NCMS_ICICIBank                                                                
  select ROW_NUMBER() over (order by verifierID) Srno,* from NCMS_ICICIBank                                                                
                                                              
  declare @cnt as numeric=0,@filecnt as numeric=1                                                                
  declare @max as numeric                                                                
  select @max=MAX(Srno) from tmp_NCMS_ICICIBank                                                                
  declare @tmpFileName as varchar(500)                                                                
                                                                  
                        
  while(@cnt<@max)                                                                
  Begin               --declare @cnt as numeric=1                                                                
  truncate table tmp_NCMS_ICICIBank_batch                                         
                                                                  
   insert into tmp_NCMS_ICICIBank_batch                                                   
  select flag=0,content='H'+CONVERT(char(10),getdate(),103)+'COMPANY'+replace(CONVERT(char(10),getdate(),103),'/','')+SPACE(5),0 as verifierId                                                                                                      
union all                                                                                                      
  select flag,content,verifierid from tmp_NCMS_ICICIBank where Srno between (@cnt+1) and (@cnt+1) + 14999                                
    union all                                                                               
  select flag=9,content='F'++risk.dbo.AddZeroPrefox(COUNT(1),5)++dbo.AddZeroPrefix(convert(decimal(14,2),SUM(SegApprovedAmt)),14),0 as verifierId                                                                                                      
  from tmp_NCMS_ICICIBank where Srno between (@cnt+1) and (@cnt+1) + 14999                                                                  
                                                                    
                                                                
   set @tmpFileName = @FileName+'_'+cast(@filecnt as varchar)+'.txt'                                            
   select @FilePath=ltrim(rtrim(bankfolder))+@tmpFileName  from ncms_Entity_ICICI where segment=@segment                                                                    
--set @FileName = 'Test_ANGELCAP_ANGELCAPUP_BSX3132_ANGBSXUP_'+replace(CONVERT(char(10),getdate(),103),'/','')+'_'+cast(@filecnt as varchar)+'.txt'                                                                
                                                                 
  --      Exec master.dbo.xp_cmdshell 'net use \\INHOUSEHDFCLIVE-FS.angelone.in\hdfcforward\Angel_Broking\src /user:neha.naiwar@angelone.in Angel@12345670' --Live Server                                                                      
                                                                
                                                                          
    SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                                                                     
    SET @s = @s + 'bcp "select content from INTRANET.cms.dbo.tmp_NCMS_ICICIBank_batch order by flag" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                               
 
    
     
    SET @s = @s + ''''                                     
    EXEC(@s)                                                                  
                                                                   
                                                                   
   DECLARE @s1 VARCHAR(MAX) = ''                                                                    
   SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                                      
   SET @s1 = @s1 + 'bcp "select content from INTRANET.cms.dbo.tmp_NCMS_ICICIBank_batch order by flag" queryout \\INHOUSELIVEAPP1-FS.angelone.in\d\upload\CMS_Test\ICICI_BankFile\'+@tmpFileName+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455G 
  
    
     
        
          
            
              
                 
                 
                     
                     
                        
                           
                
                              
                                 
                                 
                                     
                                     
                                        
                                          
                                            
                                              
                                                
                                                  
                                                    
                                                      
                                                        
                         
                                                             
                  
ZAcc'                                                                                                 
                                                           
   SET @s1 = @s1 + ''''                                                                                                            
   EXEC(@s1)                                                                   
                                                                   
   DECLARE @s2 VARCHAR(MAX) = ''           
      SET @s2 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                                          
      SET @s2 = @s2 + 'bcp "select distinct content from INTRANET.cms.dbo.tmp_NCMS_ICICIBank_batch" queryout \\INHOUSEHDFCLIVE-FS.angelone.in\hdfcforward\'+@tmpFileName+' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                   
  
   
       
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
                                
                                           
                                                  
                                                    
                                                      
                                                        
                                                          
                                                            
                                                              
                                                                                
                                                                       
      SET @s2 = @s2 + ''''                                                                                                                
      EXEC(@s2)                                                                   
                                                                    
                                                                
  set @cnt=@cnt+15000                                                                
  set @filecnt= @filecnt+1                                                                
                                                             
     insert into NCMS_BankFileName_log                                                                      
     select @tmpFileName,SegApprovedAmt,'ICICI',@batchid,GETDATE() from tmp_NCMS_ICICIBank with(nolock) where verifierid in                                                                      
     (select verifierid from tmp_NCMS_ICICIBank_batch with(nolock) )                                                                
                                                                
  end                                                            
                                                                  
     -- select @FilePath=ltrim(rtrim(bankfolder))+@FileName  from ncms_Entity_ICICI where segment=@segment                                                                        
                                                                                                 
     -- SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                           
     -- SET @s = @s + 'bcp "select content from INTRANET.cms.dbo.NCMS_ICICIBank order by flag" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uinhouse -Pinh6014'                                                                                    
  
    
      
        
         
             
              
                
                  
                    
                     
                         
            
                            
                              
                                
                                  
                                                              
                                        
                                          
                                            
                                              
                                                
                                                 
                                                     
                                                      
                                                        
                                                          
                                                            
                                                             
                                                                     
                                                                     
                                                                 
                          
                                                                       
     -- SET @s = @s + ''''                                                                        
     -- EXEC(@s)                                                                  
                                                                  
     --/* CREATE COPY FILE FOR REFERENCE */                                                                        
    ----if (select COUNT(1) from NCMS_Entity where bankfolder like '%136%' and Segment=@segment) >= 1                                                                        
     ----Begin                                                                        
                                                    
     --DECLARE @s1 VARCHAR(MAX) = ''                                                                    
     --SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                  
     --SET @s1 = @s1 + 'bcp "select content from INTRANET.cms.dbo.NCMS_ICICIBank order by flag" queryout \\INHOUSELIVEAPP2-FS.angelone.in\d\upload\CMS_Test\ICICI_BankFile\'+@FileName+' -c -t, -SABVSNCMS.angelone.in -Uinhouse -Pinh6014'                    
  
    
      
        
          
            
              
               
                   
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
          
                                                
                                                  
                                                    
                                                      
                                                        
                                                          
                                                            
                                                              
              
                                                                 
                                                                           
                                                                 
                                                                    
                                                                                                              
     --SET @s1 = @s1 + ''''                                                                                                            
     --EXEC(@s1)                               
 -- End                                                                        
                                            
    update NCMS_SegPayoutAppAmt set BANK_gen=1,BOFF_gen=1/*,paymode=b.pmode*/ from                                                                                
  (select a.verifierId,pmode=SUBSTRING(content,2,3),c.Req_RefNo from NCMS_ICICIBank a                                           
  join #df c on a.verifierId=c.verifierid                                          
         and c.Bank_Provider='ICICI' where flag=1)b                                                                                             
  where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid  and NCMS_SegPayoutAppAmt.Req_RefNo  =b.Req_RefNo                                                                                                       
  and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and                                          
  NCMS_SegPayoutAppAmt.Paymode is not NULL   and NCMS_SegPayoutAppAmt.ODIN_gen=2                                           
                     
  update NCMS_SegPayoutAppAmt set BANK_gen=1,paymode=b.pmode from                                                                              
  (select verifierid,pmode=SUBSTRING(content,2,3) from NCMS_ICICIBank where flag=1)b                                                                         
  where NCMS_SegPayoutAppAmt.VerifierID=b.verifierid                                                                                                     
  and NCMS_SegPayoutAppAmt.BANK_gen=0   and NCMS_SegPayoutAppAmt.SegApprovedAmt > 0 and                                           
  NCMS_SegPayoutAppAmt.Paymode is not NULL   and NCMS_SegPayoutAppAmt.ODIN_gen=0                                                                                             
                         
  insert into NCMS_ICICIBank_log(flag,content,verifierId,GeneratedOn,BatchNo,segment)                                                                                                       
  select flag,content,verifierId,GETDATE(),@batid,@segment from NCMS_ICICIBank                                       
 END                                                             
                                                                                                      
 set @ctr=@ctr+1                                      
  DROP TABLE #df                                                                                          
                                          
                                                                                          
END                                                                                                      
                                                                                                      
DROP TABLE #ICICIdata                                                                            
DROP TABLE #CtrFile                                                                                                      
                                                                                                      
End try                                                                                      
BEGIN CATCH                                                                                                                 
                                                               
 insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                       
 select GETDATE(),'NCMS_ICICIBankFileGeneration',ERROR_LINE(),ERROR_MESSAGE()                                                                                                                                        
                                                                                                 
 DECLARE @ErrorMessage NVARCHAR(4000);                                                                                                                                    
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                               
 RAISERROR (@ErrorMessage , 16, 1);                                       
                                                                                                       
End catch                                                                     
                                                        
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_OmnysisAPI_GM_102_EXE
-- --------------------------------------------------
  
  
CREATE Proc [dbo].NCMS_OmnysisAPI_GM_102_EXE  
As  
Begin  
  
update ncms_batch_process set startdate=GETDATE() where srno =28
update ncms_batch_process set enddate=GETDATE(),flag=1 where srno =28
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_OmnysisAPI_GM1_EXE
-- --------------------------------------------------
  
  
CREATE Proc [dbo].[NCMS_OmnysisAPI_GM1_EXE]  
As  
Begin  
  
update ncms_batch_process set startdate=GETDATE() where srno =21  
update ncms_batch_process set enddate=GETDATE(),flag=1 where srno =21  
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_OmnysisAPI_GM2_EXE
-- --------------------------------------------------
  
  
CREATE Proc [dbo].NCMS_OmnysisAPI_GM2_EXE  
As  
Begin  
  
update ncms_batch_process set startdate=GETDATE() where srno =22 
update ncms_batch_process set enddate=GETDATE(),flag=1 where srno =22  
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_OmnysisAPI_GM3_EXE
-- --------------------------------------------------
  
  
CREATE Proc [dbo].NCMS_OmnysisAPI_GM3_EXE  
As  
Begin  
  
update ncms_batch_process set startdate=GETDATE() where srno =23 
update ncms_batch_process set enddate=GETDATE(),flag=1 where srno =23  
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_OmnysisAPI_GM4_EXE
-- --------------------------------------------------
  
  
CREATE Proc [dbo].NCMS_OmnysisAPI_GM4_EXE  
As  
Begin  
  
update ncms_batch_process set startdate=GETDATE() where srno =24 
update ncms_batch_process set enddate=GETDATE(),flag=1 where srno =24
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_OmnysisAPI_GM6_EXE
-- --------------------------------------------------
    
    
CREATE Proc [dbo].NCMS_OmnysisAPI_GM6_EXE    
As    
Begin    
    
update ncms_batch_process set startdate=GETDATE() where srno =25
update ncms_batch_process set enddate=GETDATE(),flag=1 where srno =25 
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_OmnysisAPI_GM7_EXE
-- --------------------------------------------------
    
    
CREATE Proc [dbo].NCMS_OmnysisAPI_GM7_EXE    
As    
Begin    
    
update ncms_batch_process set startdate=GETDATE() where srno =26 
update ncms_batch_process set enddate=GETDATE(),flag=1 where srno =26
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_OmnysisAPI_GM8_EXE
-- --------------------------------------------------
    
    
CREATE Proc [dbo].NCMS_OmnysisAPI_GM8_EXE    
As    
Begin    
    
update ncms_batch_process set startdate=GETDATE() where srno =27  
update ncms_batch_process set enddate=GETDATE(),flag=1 where srno =27  
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_OmnysisAPI_GM9_EXE
-- --------------------------------------------------
  
  
CREATE Proc [dbo].NCMS_OmnysisAPI_GM9_EXE  
As  
Begin  
  
update ncms_batch_process set startdate=GETDATE() where srno =29
update ncms_batch_process set enddate=GETDATE(),flag=1 where srno =29
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_PendingRequest_count
-- --------------------------------------------------
create PROCEDURE [dbo].[NCMS_PendingRequest_count]                           
AS                                      
                                      
SET NOCOUNT ON        
                                                   
DECLARE @HTMLBODY1 NVARCHAR(max)=''                            
                                      
DECLARE @RC INT                                      
IF NOT EXISTS (SELECT * FROM MSDB.SYS.SERVICE_QUEUES WHERE NAME = N'EXTERNALMAILQUEUE' AND IS_RECEIVE_ENABLED = 1)                                      
EXEC @RC = MSDB.DBO.SYSMAIL_START_SP                                      
     
     
DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000)                             
Set @emailto='Banking@angelbroking.com;fundspayout@angelbroking.com'  
Set @emailcc='neha.naiwar@angelbroking.com'                                            
                                        
                                     
                                       
                                    
BEGIN TRY                        
     
 declare @subject as nvarchar(max)              
declare @htmlPEBody as nvarchar(max)='',@batchid as varchar(50)=''                                                  
                           
  begin                  
  declare @htmlPayout as varchar(2000)=''          
          
   declare @TotalMarking as int='',@FullyApproved as int='',@PartialAprroved as int='',@Pending as int='',@cancelled as int='',  
   @Rejected as int='' ,@Pending_Amount1 as Varchar(max)=''           
,@CFRejected as int=''   ,  @date as datetime         
          
select c.*,case when d.bankname like 'HDFC%' then 'HDFC' else 'ICICI' end as bank into #xx from NCMS_PO_Request c with(nolock)   
  left outer join NCMS_ClientBankDetails_all d with(nolock) on c.Req_PayBankId=d.acno and   
  replace(c.Entity,'AllSegment','AllSegment')=d.domain                                          
 and c.Party_code=d.cltcode  and d.paymode='NEFT'  where po_statusid=0  and req_datetime<=(dateadd(day, datediff(day, 0, getdate()), 0) + '17:35')  
                  
select date_time =  convert (varchar(12) ,getdate() , 101),Bank ,  
Pending=FORMAT(Count(party_code), 'N', 'en-us') ,   
Pending_Amount= FORMAT(isnull(SUM(PO_Request),0.00), 'N', 'en-us'),ROW_NUMBER() OVER ( ORDER BY Bank desc ) AS [SrNo] into #final_p from #xx     group by bank        
--select @Pending_Amount1 =FORMAT(@Pending_Amount, 'N', 'en-us')      
 
 select    
Count(party_code) as TotalCount,
SUM(PO_Request) as TotalAmount
into #NCMS_total  
from #xx a with (nolock)      

 select ROW_NUMBER() OVER ( ORDER BY bank ) AS [SrNo],  *                         
 into #final_pending                         
 from                         
 (   
select  date_time,bank,pending,pending_Amount from  #final_p
 union all                        
 select                         
 convert(varchar(25),'') as ProcessDateTime,                        
'TOTAL' as Bank,                              
 convert(varchar(25),FORMAT(TotalCount, 'N', 'en-us')) as TotalCount,                        
 convert(varchar(25),FORMAT(TotalAmount, 'N', 'en-us')) as TotalAmount                       
 --.dbo.AddComma(TotalCount) as TotalCount,                        
 --.dbo.AddComma(TotalAmount) as TotalAmount                        
 from #NCMS_total      (NOLOCK)    
 )x        
      
 select @date =  convert (varchar(12) ,getdate() , 101)     
   
 Declare @ctr as int = 1,@totctr as int = 0                          
    select @totctr =COUNT(1) from #final_pending                          
                           
    while @ctr <= @totctr                          
    begin                          
   select                             
   @HTMLBODY1=@HTMLBODY1+'<tr><td>'+convert(varchar,date_time)+'</td><td>'+convert(varchar,BANK)+'</td><td>'+convert(varchar,Pending)+'</td><td>'+convert(varchar,Pending_Amount)+'</td></tr>'                          
   from #final_pending where SrNo=@ctr                          
                               
  set @ctr=@ctr+1                          
    end       
 
 
 truncate table  dustbin.dbo.NCMS_pendingData
 insert into dustbin.dbo.NCMS_pendingData
  select distinct party_code,po_request,req_user,req_datetime,req_paybankid    from #xx

  DECLARE @s VARCHAR(MAX) = ''

   declare @FileName as varchar(100) = 'Payout_pendingData'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'
      declare @FilePath varchar(200) =''
      select @FilePath='\\INHOUSELIVEAPP2-FS.angelone.in\cusa_mtf\'+@FileName

      SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''
      SET @s = @s + 'bcp "select * from [intranet].dustbin.dbo.NCMS_pendingData" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'



      SET @s = @s + ''''
      EXEC(@s)

	  DECLARE @s1 varchar(500)
 SET @s1 = @FilePath
 
  set @HTMLBODY1='Dear Banking Team,<br><Br>'    
  +' Please find the total pending request details.<br><br>'    
  +'<table border="1"><tr style="font-weight:bold"><td>Date Time</td><td>Bank</td><td>Count</td><td>Amount</td>'       
  +@HTMLBODY1+'</table><BR><BR>'  
  +'This is a System generated Message. Please do not Reply.<BR><BR>'                          
    
                             
   /* set @subject='NCMS: Funds Payout Statistics Batch-id: '*/          
 select @subject='NCMS: Pending Payout Request Count:'       
                              
   EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                      
   @RECIPIENTS =@emailto,                                      
   @COPY_RECIPIENTS = @emailcc,                                      
   @PROFILE_NAME = 'pay-outbanking',                                
   @BODY_FORMAT ='HTML',                                      
   @SUBJECT = @subject,                                      
   @FILE_ATTACHMENTS =@s1,                                      
   @BODY =@HTMLBODY1                            
                             
                                    
 end                                       
                        
END TRY                                      
BEGIN CATCH                                      
                                      
 insert into risk.dbo.Appln_ERROR (ErrTime,ErrObject,ErrLine,ErrMessage,ApplnName,DBname)                                                              
 select GETDATE(),'NCMS_PendingRequest_count',ERROR_LINE(),ERROR_MESSAGE(),'NCMS',DB_NAME(db_id())                                                              
                            
 DECLARE @ErrorMessage NVARCHAR(4000);                                           
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                            
 RAISERROR (@ErrorMessage , 16, 1);                                 
                                      
END CATCH                                      
                                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_PostOmnysis
-- --------------------------------------------------
CREATE procedure [dbo].[NCMS_PostOmnysis]                                                
as                                                      
SET nocount on                                                 
SET XACT_ABORT ON                                                                      
BEGIN TRY                                                                    
          
 update ncms_batch_process set StartDate=getdate() where srno=30      
     
 declare @processdate datetime      
set @processdate=getdate()     
    
 Declare @Batchid varchar(15) = ''                                
                                                
  select @Batchid=RIGHT(convert(varchar(8),getdate(),112),6)+replace(convert(varchar(8),getdate(),108),':','')                                       
    
  create table #NCMS_SegPOAppAmt                                                   
  (                                                
  SRNO int,                                                      
  VerifierID int,                                                      
  RequestID int,                                                   
  Req_RefNo VARCHAR(25),                                                      
  PARTY_CODE VARCHAR(10),                                                      
  ENTITY VARCHAR(10),                                                      
  SEGMENT VARCHAR(10),                                                      
  PO_ApprovedAmt money,                                                      
  NetPAyable money,                                                      
  SegApprovedAmt money,                                      
  Temp_NetPAyable money,    
  RequestType char(1)                                                       
  )                                                      
--print 'hi'                                          
  insert into #NCMS_SegPOAppAmt (SRNO,VerifierID,RequestID,Req_RefNo,PARTY_CODE,ENTITY,SEGMENT,PO_ApprovedAmt,NetPAyable,SegApprovedAmt,Temp_NetPAyable,RequestType)                                               
  select * from NCMS_SegPOAppAmt      
    
   select * into #er from ncms_omnysis_uploader WITH(NOLOCK)     
    
select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse into #sendtoomny from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=1)    
   group by PARTY_CODE,requestid     
    
       
   insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=2)      
   group by PARTY_CODE,requestid     
       
    insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=3)      
   group by PARTY_CODE,requestid      
       
    insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=4)      
   group by PARTY_CODE,requestid      
       
   insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=6)      
   group by PARTY_CODE,requestid      
    
    insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=7)      
   group by PARTY_CODE,requestid      
       
   insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=8)      
   group by PARTY_CODE,requestid      
    
   insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=9)      
   group by PARTY_CODE,requestid    
       
      insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=104)      
   group by PARTY_CODE,requestid      
    
      insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=106)      
   group by PARTY_CODE,requestid      
    
    insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=102)      
   group by PARTY_CODE,requestid      
    
    insert into #sendtoomny      
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,      
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0      
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */      
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=108)      
   group by PARTY_CODE,requestid      
     --WAITFOR DELAY '00:02:00'                    
       
    insert into NCMS_Omnysis_hist      
   select *,GETDATE() from NCMS_Omnysis      
      
   truncate table NCMS_Omnysis                   
         
  /* insert into NCMS_Omnysis      
   select  AccountId,Amount,Validated,dttime from  [172.31.15.69].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate2     
   */    
    insert into NCMS_Omnysis      
   select  UPPER(RTRIM(LTRIM(Party_code))),po_request*(-1),Validationtxt,requestdate from  NCMS_SendOmnysis with(nolock)     
       
   --WAITFOR DELAY '00:02:00'      
       
  /* insert into NCMS_Omnysis      
   select  AccountId,Amount,Validated,dttime from  [172.31.15.154].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate2      
    
   WAITFOR DELAY '00:01:00' */     
    
   --insert into NCMS_Omnysis      
   --select  AccountId,Amount,Validated,dttime from  [172.31.15.169].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate2      
        
 --insert into NCMS_Omnysis      
 --  select  AccountId,Amount,Validated,dttime from  [172.31.15.46].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate2     
    
 insert into NCMS_Omnysis_log      
 select * from NCMS_Omnysis          
/******************Added for removing MFSS codes from Omnisys********************************************************/    
     
 /*select distinct  party_code into #oo from angelfo.BSEMFSS.dbo.MF_CLIENT with(nolock) where party_code not in    
  (select distinct cl_code from AngelNseCM.msajag.dbo.client_brok_details with(nolock))*/ /*commented on 09 Jun2021*/    
      
  select distinct  party_code into #oo from NCMS_OnlyMF_Codes with(nolock)    
      
 DELETE A               
   FROM NCMS_Omnysis_log  A JOIN (SELECT party_code FROM #oo) B              
   ON A.PARTY_CODE=B.PARTy_CODE --where  A.validationtxt<>'OK'    
     
 DELETE A               
   FROM #sendtoomny  A JOIN (SELECT party_code FROM #oo) B              
   ON A.PARTY_CODE=B.PARTy_CODE    
/**************************************************************************/    
/******************Added for removing Inactice codes from Omnisys on 01 Aug 2022********************************************************/      
 select * into #Inactivecodes from NCMS_Omnysis_log  where validationtxt<>'OK' and party_code in     
 (select party_code from [CSOKYC-6].general.dbo.client_details with(nolock) where last_inactive_date<CONVERT(VARCHAR(11), Getdate()) )    
    
 exec SP_NCMS_OmnesysInactiveClientMailer    
    
 DELETE A               
   FROM NCMS_Omnysis_log  A JOIN (SELECT party_code FROM #Inactivecodes) B              
   ON A.PARTY_CODE=B.PARTy_CODE where  A.validationtxt<>'OK'    
     
 DELETE A               
   FROM #sendtoomny  A JOIN (SELECT party_code FROM #Inactivecodes) B              
   ON A.PARTY_CODE=B.PARTy_CODE    
/**************************************************************************/    
update #sendtoomny set reponse=b.validationtxt from NCMS_Omnysis_log b where #sendtoomny.Party_code=b.party_code    
select * into #omny from NCMS_Omnysis_log where validationtxt<>'OK'    
    
 DELETE A               
   FROM #NCMS_SegPOAppAmt  A JOIN (SELECT party_code FROM #omny group by party_code ) B              
   ON A.PARTY_CODE=B.PARTy_CODE    
       
 update ncms_po_Request set po_statusid=0,PO_ApprovedAmt=0 from               
  #sendtoomny  b              
  where ncms_po_Request.porequestid=b.requestid  and b.reponse<>'OK' /*b.reponse='NOT_OK'*/      
                            
  insert into NCMS_SegPayoutAppAmt(RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt,BOFF_gen,BANK_gen,ODIN_gen,ProcessDateTime,BOFF_Posted,Batchid)                                                      
  select RequestID,VerifierID,Req_RefNo,Party_code,Entity,Segment,PO_ApprovedAmt,NetPAyable,SegApprovedAmt,0,0,0,@processdate,0,@Batchid from #NCMS_SegPOAppAmt                                                      
     
 /* BO Data to history */                
 insert into NCMS_SegVeriData_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                              
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                              
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                              
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                              
 from NCMS_SegVeriData a with (nolock)                      
 join                
 (select party_code as Pcode from NCMS_SegPayoutAppAmt where isnull(batchid,'') = (select batchid from NCMS_VerificationGapsStatistics_vw )) b                
 on a.Party_code=b.pcode            
 /* End */        
      
 /***********************----end*/    
update ncms_batch_process set EndDate=getdate(),Flag=1 where srno=30    
                                          
End try                                                                     
                                                                    
BEGIN CATCH                                                                        
                                                                    
  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                              
  select GETDATE(),'NCMS_UPD_ReqVerId_Batchwise',ERROR_LINE(),ERROR_MESSAGE()                                                                              
                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                            
  RAISERROR (@ErrorMessage , 16, 1);                                                  
                                         
End catch                                                                    
                                                        
SET nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_RealTimePayout_exe_30Jan2023
-- --------------------------------------------------
  
      
create Proc [dbo].[NCMS_RealTimePayout_exe_30Jan2023]      
As      
Begin      
declare @mdate as date,@today as date  
select @mdate=max(vdt)+1 from AngelNseCM.account.dbo.ledger WITH(NOLOCK)  
where vtyp=15 and vdt <=convert(varchar(11),getdate())  
and narration like 'SETTNO=_______NSECMNBill Posted'  
  
select top 1 @mdate=Start_date  
from [CSOKYC-6].General.dbo.BO_Sett_Mst WITH(NOLOCK)  
where-- co_code='BSECM' and sett_type='D' and  
 Start_date >= @mdate  
order by Start_date  
  
select @today=CAST (getdate()  as date )  
--select @today  
--select @mdate  
  
if(@mdate=@today)  
Begin  
 if(select count(1) from NCMS_RealPayout_Formorning where  status='')=0  
 Begin      
  declare @cmd1 varchar(5000)      
  set @cmd1 = 'start \\196.1.115.147\d\UploadAdvChart\RealTimePayout\NCMS_RealTime_PO\NCMS_RealTime_PO\bin\Debug\NCMS_RealTime_PO.exe'      
  exec master..xp_cmdshell @cmd1 , no_output      
 End   
End   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_RealTimePayout_ForMorning_Exe_16012024
-- --------------------------------------------------
  
  
-- =============================================  
-- Author:  Neha Naiwar  
-- Create date: 29 July 2022  
-- =============================================  
create PROCEDURE [dbo].[NCMS_RealTimePayout_ForMorning_Exe_16012024]  
As   
Begin  
declare @mdate as date,@today as date  
--select @mdate=max(vdt)+1 from AngelNseCM.account.dbo.ledger WITH(NOLOCK)  
--where vtyp=15 and vdt <=convert(varchar(11),getdate())  
--and narration like 'SETTNO=_______NSECMNBill Posted'  
  
--select top 1 @mdate=Start_date  
--from [CSOKYC-6].General.dbo.BO_Sett_Mst WITH(NOLOCK)  
--where-- co_code='BSECM' and sett_type='D' and  
-- Start_date >= @mdate  
--order by Start_date  
  
select top 1 @mdate=Start_date  
from [CSOKYC-6].General.dbo.BO_Sett_Mst WITH(NOLOCK)  
where co_code='NSECM' and sett_type='M' and  
 Start_date >= convert(varchar(11),getdate())  
order by Start_date  
  
select @today=CAST (getdate()  as date )  
--select @today  
--select @mdate  
  
if(@mdate=@today)  
Begin     
  
     if((CONVERT(VARCHAR(5),GETDATE(),108)>='09:50') and (CONVERT(VARCHAR(5),GETDATE(),108)<='09:55')) --'10:00'   
     begin  
     truncate table NCMS_RealMorning  
  
          select * into #qq from ncms_po_request where  
       PO_statusid=0 and  req_datetime>=(dateadd(day, datediff(day, 0, getdate()), 0) + '7:02') and req_datetime<(dateadd(day, datediff(day, 0, getdate()), 0) + '9:51')     
        
  
       select max(POrequestID ) POrequestID,    
       Party_code,max(Net_payable) Net_payable,    
       sum(PO_Request) PO_Request    
       ,Req_PayBankId ,entity,max(RequestType) RequestType     
       into #data from #qq    
       where  
       PO_statusid=0 and  req_datetime>=(dateadd(day, datediff(day, 0, getdate()), 0) + '7:02') and req_datetime<(dateadd(day, datediff(day, 0, getdate()), 0) + '9:51')     
       group by Party_code,Req_PayBankId,entity    
  
      ;with cte as (    
      select AA.*,BB.Req_RefNo,BB.Req_datetime  from     
      (    
     select * from #data  
      )AA    
      inner join #qq BB     
      on AA.POrequestID=BB.POrequestID    
     )  
     ,    
     CTEMultipleBanks AS(    
      select * from cte    
      where Party_code    
      in (    
       select Party_code    
       from cte    
       group by Party_code    
       having count(1)>1     
      )        
     )  
     
     ,cteMinPOMultipleBank as(    
      select * from cte    
      where POrequestID in (    
       select min(POrequestID ) POrequestID    
       from CTEMultipleBanks    
       group by Party_code)    
     )    
     ,cteFinal as    
     (    
      select * from cte    
      except    
      select * from CTEMultipleBanks    
     )    
   
     select * into #temp1  from (   
     select * from cteFinal   
     union  
     select * from cteMinPOMultipleBank)AA  
    
     select * into #zzx from /*Vw_NCMSPayoutMergingView*/#temp1  with(nolock)  
      
        select * into #fetch from #zzx  with(nolock) where   
     req_datetime>=(dateadd(day, datediff(day, 0, getdate()), 0) + '7:02') and    /* change time from 7:31 to 7:15 as per JIRA ORE-2073*/  
     req_datetime<(dateadd(day, datediff(day, 0, getdate()), 0) + '9:51')    
  
   /*Added on 16 Dec 2022 fro removing previous day marking partially genertatd today*/  
   delete from #fetch where Party_code not in (select Party_code from ncms_po_request where right(req_user,2) <> '-S')  
  
  
     insert into NCMS_RealMorning  
     select *,'' from #fetch  with(nolock) where party_code in (select party_code from NCMS_EntityDataView_combine with(nolock) where  
     marginamt=0 and netpayable>0)  
  
    /*select *,'' from Vw_NCMSPayoutMergingView  with(nolock) where datepart(hh, req_datetime) <= 9 and datepart(minute, req_datetime)<51   
     and party_code in (select party_code from NCMS_EntityDataView_combine with(nolock) where marginamt=0)  
     */  
     end  
     select  * into #Po from  NCMS_RealMorning  with(nolock) where process_status=''  
  
     select * into #payout from #Po where party_code not in (select party_code from NCMS_RealPayout_Formorning where status='NotForRealPO')  
  
     Delete from #payout where  party_code in (select party_code from NCMS_RealPayout_Formorning where validationtxt='NOT_OK')  
  
     /***************************************************************/  
       
    select a.* into #final from #qq a join #payout b on a.Party_code=b.party_code where a.PO_Statusid=0  
  
    update a set a.po_statusid=1 from ncms_po_request a join #final b on a.porequestid=b.porequestid  
    where a.PO_Statusid=0  
  
     /***************************************************************/  
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,1,'','',GETDATE(),'','',''  
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=1)      
     group by PARTY_CODE,POrequestID,Req_datetime    
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,2,'','',GETDATE(),'','',''  
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=2)      
     group by PARTY_CODE,POrequestID,Req_datetime  
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,3,'','',GETDATE(),'','',''  
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=3)      
     group by PARTY_CODE,POrequestID,Req_datetime  
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,4,'','',GETDATE(),'','',''      
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=4)      
     group by PARTY_CODE,POrequestID,Req_datetime   
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,6,'','',GETDATE(),'','',''    
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=6)      
     group by PARTY_CODE,POrequestID,Req_datetime  
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,7,'','',GETDATE(),'','',''    
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=7)      
     group by PARTY_CODE,POrequestID,Req_datetime  
  
     insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,8,'','',GETDATE(),'','',''    
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=8)      
     group by PARTY_CODE,POrequestID,Req_datetime  
  
     insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)        
    select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,9,'','',GETDATE(),'','',''      
   from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)         
    WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=9)        
    group by PARTY_CODE,POrequestID,Req_datetime    
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)        
    select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,104,'','',GETDATE(),'','',''      
   from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)         
    WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=104)        
    group by PARTY_CODE,POrequestID,Req_datetime    
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)        
    select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,106,'','',GETDATE(),'','',''      
   from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)         
    WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=106)        
    group by PARTY_CODE,POrequestID,Req_datetime    
  
    insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)        
    select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,102,'','',GETDATE(),'','',''      
   from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)         
    WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=102)        
    group by PARTY_CODE,POrequestID,Req_datetime   
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)        
    select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,108,'','',GETDATE(),'','',''      
   from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)         
    WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=108)        
    group by PARTY_CODE,POrequestID,Req_datetime   
  
   update NCMS_RealMorning set process_status='AlreadySend'  where  porequestid in (select POrequestID from NCMS_RealPayout_Formorning)  
  
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM2'         
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM3'         
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM4'          
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM6'   
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM7'         
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM8'         
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM9'  
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM1'         
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM104'     
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM106'  
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM 102'  
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM108'  
      
End  
else  
begin  
 declare @profile_name varchar(100)    
 declare @recipients varchar(100)    
 declare @copy_recipients varchar(100)    
 declare @subject varchar(100)    
 declare @body varchar(100)    
 declare  @body_format varchar(100)    
 declare @MSg varchar(1000)    
 set @MSg='Real Time 1st batch Job not started Please check . '         
    
     
         EXEC msdb.dbo.Sp_send_dbmail                      
              @profile_name='DBA',        
              @recipients='neha.naiwar@angelbroking.com;yogen.gandhi@angelbroking.com;fundspayout@angelbroking.com',    
                      
              @subject = 'NCMS RealTime 1st Batch Job not started.',                      
              @body=@MSg ,                      
              @body_format = 'HTML'     
end  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_RealTimePayout_ForMorning_Exe_16Jan2024
-- --------------------------------------------------
  
  
-- =============================================  
-- Author:  Neha Naiwar  
-- Create date: 29 July 2022  
-- =============================================  
create PROCEDURE [dbo].[NCMS_RealTimePayout_ForMorning_Exe_16Jan2024]  
As   
Begin  
declare @mdate as date,@today as date  
--select @mdate=max(vdt)+1 from AngelNseCM.account.dbo.ledger WITH(NOLOCK)  
--where vtyp=15 and vdt <=convert(varchar(11),getdate())  
--and narration like 'SETTNO=_______NSECMNBill Posted'  
  
--select top 1 @mdate=Start_date  
--from [CSOKYC-6].General.dbo.BO_Sett_Mst WITH(NOLOCK)  
--where-- co_code='BSECM' and sett_type='D' and  
-- Start_date >= @mdate  
--order by Start_date  
  
select top 1 @mdate=Start_date  
from [CSOKYC-6].General.dbo.BO_Sett_Mst WITH(NOLOCK)  
where co_code='NSECM' and sett_type='M' and  
 Start_date >= convert(varchar(11),getdate())  
order by Start_date  
  
select @today=CAST (getdate()  as date )  
--select @today  
--select @mdate  
  
if(@mdate=@today)  
Begin     
  
     if((CONVERT(VARCHAR(5),GETDATE(),108)>='09:50') and (CONVERT(VARCHAR(5),GETDATE(),108)<='09:55')) --'10:00'   
     begin  
     truncate table NCMS_RealMorning  
  
       select max(POrequestID ) POrequestID,    
       Party_code,max(Net_payable) Net_payable,    
       sum(PO_Request) PO_Request    
       ,Req_PayBankId ,entity,max(RequestType) RequestType     
       into #data from ncms_po_request    
       where  
       PO_statusid=0 and  req_datetime>=(dateadd(day, datediff(day, 0, getdate()), 0) + '7:02') and req_datetime<(dateadd(day, datediff(day, 0, getdate()), 0) + '9:51')     
       group by Party_code,Req_PayBankId,entity    
  
      ;with cte as (    
      select AA.*,BB.Req_RefNo,BB.Req_datetime  from     
      (    
     select * from #data  
      )AA    
      inner join ncms_po_request BB     
      on AA.POrequestID=BB.POrequestID    
     )  
     ,    
     CTEMultipleBanks AS(    
      select * from cte    
      where Party_code    
      in (    
       select Party_code    
       from cte    
       group by Party_code    
       having count(1)>1     
      )        
     )  
     
     ,cteMinPOMultipleBank as(    
      select * from cte    
      where POrequestID in (    
       select min(POrequestID ) POrequestID    
       from CTEMultipleBanks    
       group by Party_code)    
     )    
     ,cteFinal as    
     (    
      select * from cte    
      except    
      select * from CTEMultipleBanks    
     )    
   
     select * into #temp1  from (   
     select * from cteFinal   
     union  
     select * from cteMinPOMultipleBank)AA  
    
     select * into #zzx from /*Vw_NCMSPayoutMergingView*/#temp1  with(nolock)  
      
        select * into #fetch from #zzx  with(nolock) where   
     req_datetime>=(dateadd(day, datediff(day, 0, getdate()), 0) + '7:02') and    /* change time from 7:31 to 7:15 as per JIRA ORE-2073*/  
     req_datetime<(dateadd(day, datediff(day, 0, getdate()), 0) + '9:51')    
  
   /*Added on 16 Dec 2022 fro removing previous day marking partially genertatd today*/  
   delete from #fetch where Party_code not in (select Party_code from ncms_po_request where right(req_user,2) <> '-S')  
  
     insert into NCMS_RealMorning  
     select *,'' from #fetch  with(nolock) where party_code in (select party_code from NCMS_EntityDataView_combine with(nolock) where  
     marginamt=0 and netpayable>0)  
  
    /*select *,'' from Vw_NCMSPayoutMergingView  with(nolock) where datepart(hh, req_datetime) <= 9 and datepart(minute, req_datetime)<51   
     and party_code in (select party_code from NCMS_EntityDataView_combine with(nolock) where marginamt=0)  
     */  
     end  
     select  * into #Po from  NCMS_RealMorning  with(nolock) where process_status=''  
  
     select * into #payout from #Po where party_code not in (select party_code from NCMS_RealPayout_Formorning where status='NotForRealPO')  
  
     Delete from #payout where  party_code in (select party_code from NCMS_RealPayout_Formorning where validationtxt='NOT_OK')  
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,1,'','',GETDATE(),'','',''  
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=1)      
     group by PARTY_CODE,POrequestID,Req_datetime    
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,2,'','',GETDATE(),'','',''  
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=2)      
     group by PARTY_CODE,POrequestID,Req_datetime  
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,3,'','',GETDATE(),'','',''  
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=3)      
     group by PARTY_CODE,POrequestID,Req_datetime  
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,4,'','',GETDATE(),'','',''      
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=4)      
     group by PARTY_CODE,POrequestID,Req_datetime   
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,6,'','',GETDATE(),'','',''    
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=6)      
     group by PARTY_CODE,POrequestID,Req_datetime  
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,7,'','',GETDATE(),'','',''    
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=7)      
     group by PARTY_CODE,POrequestID,Req_datetime  
  
     insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)      
     select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,8,'','',GETDATE(),'','',''    
    from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)       
     WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=8)      
     group by PARTY_CODE,POrequestID,Req_datetime  
  
     insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)        
    select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,9,'','',GETDATE(),'','',''      
   from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)         
    WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=9)        
    group by PARTY_CODE,POrequestID,Req_datetime    
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)        
    select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,104,'','',GETDATE(),'','',''      
   from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)         
    WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=104)        
    group by PARTY_CODE,POrequestID,Req_datetime    
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)        
    select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,106,'','',GETDATE(),'','',''      
   from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)         
    WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=106)        
    group by PARTY_CODE,POrequestID,Req_datetime    
  
    insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)        
    select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,102,'','',GETDATE(),'','',''      
   from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)         
    WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=102)        
    group by PARTY_CODE,POrequestID,Req_datetime   
  
   insert into NCMS_RealPayout_Formorning(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt,AMX_Response,status)        
    select POrequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(PO_Request) , 0, 1),Req_datetime,108,'','',GETDATE(),'','',''      
   from #payout where EXISTS (SELECT AccountId FROM ncms_omnysis_uploader WITH(NOLOCK)         
    WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=108)        
    group by PARTY_CODE,POrequestID,Req_datetime   
  
   update NCMS_RealMorning set process_status='AlreadySend'  where  porequestid in (select POrequestID from NCMS_RealPayout_Formorning)  
  
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM2'         
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM3'         
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM4'          
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM6'   
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM7'         
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM8'         
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM9'  
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM1'         
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM104'     
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM106'  
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM 102'  
     EXEC msdb.dbo.sp_start_job 'NCMS Real Time PO For GM108'  
      
End  
else  
begin  
 declare @profile_name varchar(100)    
 declare @recipients varchar(100)    
 declare @copy_recipients varchar(100)    
 declare @subject varchar(100)    
 declare @body varchar(100)    
 declare  @body_format varchar(100)    
 declare @MSg varchar(1000)    
 set @MSg='Real Time 1st batch Job not started Please check . '         
    
     
         EXEC msdb.dbo.Sp_send_dbmail                      
              @profile_name='DBA',        
              @recipients='neha.naiwar@angelbroking.com;yogen.gandhi@angelbroking.com;fundspayout@angelbroking.com',    
                      
              @subject = 'NCMS RealTime 1st Batch Job not started.',                      
              @body=@MSg ,                      
              @body_format = 'HTML'     
end  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_Shortage_25Jan2024
-- --------------------------------------------------
CREATE Procedure [dbo].[NCMS_Shortage_25Jan2024]  
as  
  
Set nocount on                                  
BEGIN TRY     
  
  select seg,sett_no,Sett_type,party_code, scrip_cd, short_qty,isin   into #CMSVerified_Cash_ShrtVal   
    from risk.dbo.CMSVerified_Cash_ShrtVal with (nolock)    
  
   
   update a set a.SHORT_QTY=b.final_qty from #CMSVerified_Cash_ShrtVal a join [2024018_shortage_adjustement_revised1] b on a.PARTY_cODE=b.PARTY_cODE   
   and a.isin=b.i_isin  
  
  select   
  ROW_NUMBER() OVER ( ORDER BY a.party_Code,a.isin,a.seg,a.sett_no,a.sett_type) AS [ID],  
  a.*,ShrtHC=isnull(b.ShrtHC,120.00),DedVal=(SHORT_VALUE*isnull(b.ShrtHC,120.00))/100,Sec_payin,    
  NBFC_TotalQty=CONVERT(int,0),NBFC_AdjQty=CONVERT(int,0),NetShortQty=CONVERT(int,0),NetShortValue=CONVERT(money,0)  
  into #ShrtBeforeAdj  
  from    
  (    
   select seg,a.sett_no,a.Sett_type,A.PARTY_cODE,A.SCRIP_CD,a.isin,A.short_qty,SHORT_VALUE=SUM(ISNULL(B.MTM_price,0)*A.SHORT_QTY) from    
   (    
    select seg,sett_no,Sett_type,party_code, scrip_cd, short_qty,isin    
    from #CMSVerified_Cash_ShrtVal with (nolock)   
   ) a    
   left outer join risk.dbo.CP_new B with (Nolock) on A.isin=B.security_isin group by seg,sett_no,Sett_type,PARTY_CODE,SCRIP_CD,short_qty,isin    
  ) a left outer join    
  (    
   select sett_type,sett_No,exchange,  
   /*(Case when Funds_payin > convert(varchar(11),getdate()) and start_date <=convert(varchar(11),getdate()) then 20  
   else 120 end) */  
   (Case when Funds_payin > convert(varchar(11),getdate()) and start_date <=convert(varchar(11),getdate()) and   
      sett_type in ('D','C','N','W','F') then 20    
      when Funds_payin > convert(varchar(11),getdate()) and start_date <=convert(varchar(11),getdate()) and   
      sett_type in ('M','Z') then 120  
      else 120 end) as ShrtHC,Sec_payin   
   from/* risk.dbo.sett_mst WITH (NOLOCK) */ AngelNseCM.MSAJAG.dbo.Sett_mst  with (nolock)  
   where   
   sett_type in ('D','C','N','W','F','M','Z')  /*Added M, Z for T+1 Settelment on 11 Mar 2022*/  
  ) b on a.sett_no=b.sett_no and a.sett_type=b.sett_type and a.seg=b.exchange   
  
  update #ShrtBeforeAdj set SHORT_VALUE=(ISNULL(B.RATE,0)*SHORT_QTY) FROM  
  (  
   select B.ISIN,A.scrip,A.series,rate=a.Cls from risk.dbo.MD (nolock) A    
   LEFT OUTER JOIN risk.dbo.SCRIP_MASTER (nolock) B ON A.scrip=B.NseSymbol AND A.series=B.NseSeries    
  ) B where #ShrtBeforeAdj.isin=b.isin and #ShrtBeforeAdj.seg='NSE' and short_value=0  
  
  update #ShrtBeforeAdj set DedVal=(SHORT_VALUE*isnull(ShrtHC,120.00))/100   
  
  update #ShrtBeforeAdj set NBFC_TotalQty=y.NetQty from  
  (select * from [CSOKYC-6].general.dbo.Vw_MILES_STOCKHOLDINGDATA where netqty > 0 ) y   
  where #ShrtBeforeAdj.PARTY_cODE=y.partycode and #ShrtBeforeAdj.isin=y.isin   
  
  
  select ROW_NUMBER() OVER ( ORDER BY party_Code,seg,isin,seg) AS [SrNo],* into #ShrtAdj   
  from #ShrtBeforeAdj where NBFC_totalQty > 0  
  
  declare @ctr as int = 1,@totctr as int = 0,@isin as varchar(14) ='',@pcode as varchar(10)='',@xisin as varchar(14) ='',@xpcode as varchar(10)=''  
  select @totctr=MAX(Srno) from #ShrtAdj  
  declare @balqty as int = 0  
  
  While @ctr <= @totctr  
  Begin  
   select @pcode=party_Code,@isin=isin from #ShrtAdj where srno=@ctr  
   if @xpcode<> @pcode or @xisin<>@isin  
   Begin  
    select @balqty=NBFC_totalQty from #ShrtAdj where srno=@ctr  
    set @xpcode=@pcode  
    set @xisin=@isin  
   End  
  
   update #ShrtAdj set NBFC_adjQty=(case when @balqty > Short_qty then Short_qty else @balqty end) where srno=@ctr  
   select @balqty=@balqty-NBFC_adjQty from #ShrtAdj where srno=@ctr  
  
   set @ctr=@ctr+1  
  End  
  
  update #ShrtAdj set NetShortQty=Short_qty-nbfc_adjQty  
  
  update #ShrtBeforeAdj   
  set   
  #ShrtBeforeAdj.NBFC_TotalQty=b.NBFC_TotalQty,  
  #ShrtBeforeAdj.NBFC_AdjQty=b.NBFC_AdjQty,  
  #ShrtBeforeAdj.NetShortQty=b.NetShortQty,  
  #ShrtBeforeAdj.NetShortValue=b.NetShortValue  
  from #ShrtAdj b where #ShrtBeforeAdj.id=b.id  
  
  update #ShrtBeforeAdj set NetShortQty=Short_qty where NBFC_TotalQty=0  
    
  /**added on 25 Jan 2024 ***/  
  update a set a.NetShortQty=b.Final_qty ,a.Short_Qty=b.Final_qty from #ShrtBeforeAdj a join [2024018_shortage_adjustement_revised1] b on   
  a.PARTY_cODE=b.PARTY_cODE and a.isin=b.i_isin  
  /******/  
  update #ShrtBeforeAdj set NetShortValue=(((SHORT_VALUE/Short_Qty)*NetShortQty)*isnull(ShrtHC,120.00))/100 where Short_Qty  > 0  
    
  truncate table NCMS_ShortSell  
    
  insert into NCMS_ShortSell  
  (ID,seg,sett_no,Sett_type,PARTY_cODE,SCRIP_CD,isin,short_qty,SHORT_VALUE,ShrtHC,DedVal,Sec_payin,NBFC_TotalQty,  
  NBFC_AdjQty,NetShortQty,NetShortValue,processDate)  
  select ID,seg,sett_no,Sett_type,PARTY_cODE,SCRIP_CD,isin,short_qty,SHORT_VALUE,ShrtHC,DedVal,Sec_payin,NBFC_TotalQty,  
  NBFC_AdjQty,NetShortQty,NetShortValue,GETDATE() as ProcessDate from #ShrtBeforeAdj   
    
  insert into NCMS_ShortSell_hist  
  (ID,seg,sett_no,Sett_type,PARTY_cODE,SCRIP_CD,isin,short_qty,SHORT_VALUE,ShrtHC,DedVal,Sec_payin,NBFC_TotalQty,  
  NBFC_AdjQty,NetShortQty,NetShortValue,processDate)  
  select ID,seg,sett_no,Sett_type,PARTY_cODE,SCRIP_CD,isin,short_qty,SHORT_VALUE,ShrtHC,DedVal,Sec_payin,NBFC_TotalQty,  
  NBFC_AdjQty,NetShortQty,NetShortValue,GETDATE() as ProcessDate from #ShrtBeforeAdj   
  
End try                                       
                                      
BEGIN CATCH                                          
                                      
   insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                
   select GETDATE(),'NCMS_Shortage',ERROR_LINE(),ERROR_MESSAGE()                                                
                  
  DECLARE @ErrorMessage NVARCHAR(4000);                                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                            
  RAISERROR (@ErrorMessage , 16, 1);                  
                                                           
End catch                             
                                  
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_SummaryEmail_02May2024
-- --------------------------------------------------

     
  
create PROCEDURE [dbo].[NCMS_SummaryEmail_02May2024]                      
AS                                
                                
SET NOCOUNT ON  
                                             
DECLARE @HTMLBODY1 NVARCHAR(max)=''                      
                                
DECLARE @RC INT                                
IF NOT EXISTS (SELECT * FROM MSDB.SYS.SERVICE_QUEUES WHERE NAME = N'EXTERNALMAILQUEUE' AND IS_RECEIVE_ENABLED = 1)                                
EXEC @RC = MSDB.DBO.SYSMAIL_START_SP                                

                               
DECLARE @MESS AS VARCHAR(max),@emailto as varchar(max),@emailcc as varchar(max)                         
Set @emailto='krunald.patel@angelbroking.com;hemantp.patel@angelbroking.com;sandip.tote@angelbroking.com;vishal.kanani@angelbroking.com;fundspayout@angelbroking.com;pranita@angelbroking.com;csosurveillance@angelbroking.com;Banking@angelbroking.com;kalpesh.jain@angelbroking.com;bankingqueries@angelbroking.com;sushilkumar.shinde@angelbroking.com;yogen.gandhi@angelbroking.com'                       
Set @emailcc='sajeev@angelbroking.com;neha.naiwar@angelbroking.com'                        
                              
BEGIN TRY                  
 
select * into #aa from NCMS_SegPayoutAppAmt with (nolock) where BOFF_gen=1 and  BANK_gen=1 and ProcessDateTime = (select MAX(ProcessDateTime)
 from NCMS_SegPayoutAppAmt   )
 
 select * into #aaa  from  NCMS_SegPayoutAppAmt with (nolock) where BOFF_gen=1 and  BANK_gen=3 and ProcessDateTime = (select MAX(ProcessDateTime)
 from NCMS_SegPayoutAppAmt   )
 
 select * into #bb11 from AngelBSECM.mktapi.dbo.tbl_post_Data with (nolock) where return_fld5='NCMS_PO' and vdate>=getdate()-3
 
   select distinct return_fld4,debitAmt,cltcode,return_fld2,exchange,segment,ddno,return_fld3,rowstate,vouchertype into #bb1 from #bb11
   
select a.*,b.cltcode,b.DebitAmt,b.exchange,b.segment as BOsegment,b.ddno,b.return_fld3,b.rowstate,b.vouchertype,CONVERT(varchar(10),'') as Bank 
 into #NCMS_BOMKTAPI_count from        
(select * from #aa
union select * from #aaa
)  a left outer join         
(select * from #bb1) b        
on a.verifierid=b.return_fld4 and a.SegApprovedAmt=b.debitAmt and a.Party_Code=b.cltcode and a.Req_RefNo=b.return_fld2


update #NCMS_BOMKTAPI_count set bank= case when BANK_gen=1 then 'ICICI' when BANK_gen=3 then 'HDFC' end

select EntitySeqId,seqid,ProcessDateTime,a.entity,a.Segment,a.bank ,     
COUNT(1) TotalCount,    
sum(BOFF_gen) as BO_Pushed,     
SUM(Case when cltcode is null then 0 else 1 end) as BO_Posted,    
sum(Case when cltcode is null then 0 else 1 end) as Bank_Posted,    
sum(Odin_gen) as Odin_Posted,    
sum(SegApprovedAmt) as PO_amount,  
MAX(SegApprovedAmt) as HPV into #NCMS_BatchStats_Lvl1 
from #NCMS_BOMKTAPI_count a with (nolock) join ncms_entity b     
on a.segment=b.segment     
group by ProcessDateTime,a.entity,a.segment,seqid,EntitySeqId,a.bank 

 
select ProcessDateTime,    
Sum(TotalCount) TotalCount,    
sum(BO_Pushed) as BO_Pushed,     
sum(BO_Posted) as BO_Posted,     
sum(Bank_Posted) as Bank_Posted,    
sum(Odin_Posted) as Odin_Posted,    
SUM(Po_amount) as Po_amount,    
Sum(HPV)  as HPV  into #NCMS_BatchStats_Lvl2  
from #NCMS_BatchStats_Lvl1 a with (nolock)     
group by ProcessDateTime 




 select ROW_NUMBER() OVER ( ORDER BY csrno,ProcessDateTime desc,EntitySeqid,seqid ) AS [SrNo],  *                       
 into #file1_reco                       
 from                       
 (                      
 select 0 as cSrno,                      
 convert(varchar(25),ProcessDateTime) as ProcessDateTime,                      
 entity,Bank,Segment,EntitySeqid,seqid ,                      
 convert(varchar(25),TotalCount) as TotalCount,                      
 convert(varchar(25),BO_Pushed) as BO_Pushed,                      
 convert(varchar(25),BO_Posted) as BO_Posted,                      
 convert(varchar(25),Bank_Posted) as Bank_Posted,                      
 convert(varchar(25),Odin_Posted) as Odin_Posted,                      
 .dbo.AddComma(PO_amount) as PO_amount,                      
 .dbo.AddComma(HPV) as HPV                      
 from #NCMS_BatchStats_Lvl1    (NOLOCK)                   
 where ProcessDateTime = (select MAX(ProcessDateTime) from NCMS_SegPayoutAppAmt  with(nolock) )                      
 union all                      
 select 1 as cSrno,                      
 convert(varchar(25),ProcessDateTime) as ProcessDateTime,                      
 '' as Entity,'' as Bank,'TOTAL' as Segment,                      
 0 as EntitySeqid,0 as seqid ,                      
 convert(varchar(25),TotalCount) as TotalCount,                      
 convert(varchar(25),BO_Pushed) as BO_Pushed,                      
 convert(varchar(25),BO_Posted) as BO_Posted,                      
 convert(varchar(25),Bank_Posted) as Bank_Posted,                      
 convert(varchar(25),Odin_Posted) as Odin_Posted,                      
 .dbo.AddComma(PO_amount) as PO_amount,                      
 .dbo.AddComma(HPV) as HPV                      
 from #NCMS_BatchStats_Lvl2      (NOLOCK)                                   
 where ProcessDateTime = (select MAX(ProcessDateTime) from NCMS_SegPayoutAppAmt  with(nolock))                      
 ) x                      
 order by csrno,ProcessDateTime desc,EntitySeqid,seqid    

/*                    
 select ROW_NUMBER() OVER ( ORDER BY csrno,ProcessDateTime desc,EntitySeqid,seqid ) AS [SrNo],  *                     
 into #file1_reco                     
 from                     
 (                    
 select 0 as cSrno,                    
 convert(varchar(25),ProcessDateTime) as ProcessDateTime,                    
 entity,Segment,EntitySeqid,seqid ,                    
 convert(varchar(5),TotalCount) as TotalCount,                    
 convert(varchar(5),BO_Pushed) as BO_Pushed,                    
 convert(varchar(5),BO_Posted) as BO_Posted,                    
 convert(varchar(5),Bank_Posted) as Bank_Posted,                    
 convert(varchar(5),Odin_Posted) as Odin_Posted,                    
 .dbo.AddComma(PO_amount) as PO_amount,                    
 .dbo.AddComma(HPV) as HPV                    
 from NCMS_BatchStats_Lvl1    (NOLOCK)                 
 where ProcessDateTime = (select MAX(ProcessDateTime) from NCMS_SegPayoutAppAmt  with(nolock) )                    
 union all                    
 select 1 as cSrno,                    
 convert(varchar(25),ProcessDateTime) as ProcessDateTime,                    
 '' as Entity,'TOTAL' as Segment,                    
 0 as EntitySeqid,0 as seqid ,                    
 convert(varchar(5),TotalCount) as TotalCount,                    
 convert(varchar(5),BO_Pushed) as BO_Pushed,                    
 convert(varchar(5),BO_Posted) as BO_Posted,                    
 convert(varchar(5),Bank_Posted) as Bank_Posted,                    
 convert(varchar(5),Odin_Posted) as Odin_Posted,                    
 .dbo.AddComma(PO_amount) as PO_amount,                    
 .dbo.AddComma(HPV) as HPV                    
 from NCMS_BatchStats_Lvl2      (NOLOCK)                                 
 where ProcessDateTime = (select MAX(ProcessDateTime) from NCMS_SegPayoutAppAmt  with(nolock))                    
 ) x                    
 order by csrno,ProcessDateTime desc,EntitySeqid,seqid                     
 */                       
declare @subject as varchar(1000)        
declare @htmlPEBody as varchar(max)='',@batchid as varchar(100)=''              
select @batchid=batchid from NCMS_VerificationGapsStatistics_vw                       
                          
 if (select count(1) from #file1_reco) > 0                      
  begin                        
                     
    Declare @ctr as int = 1,@totctr as int = 0                      
    select @totctr =COUNT(1) from #file1_reco                      
                       
    while @ctr <= @totctr                      
    begin                      
   select                         
   @HTMLBODY1=@HTMLBODY1+'<tr><td>'+ProcessDateTime+'</td><td>'+Entity+'</td><td>'+Bank+'</td><td>'+Segment+'</td><td>'+TotalCount+'</td><td>'+BO_Pushed+'</td><td>'+BO_Posted+'</td>                      
   <td>'+Bank_Posted+'</td><td align=right>'+PO_amount+'</td><td align=right>'+HPV+'</td></tr>'                      
   from #file1_reco where SrNo=@ctr                      
                           
  set @ctr=@ctr+1                      
    end                      
                         
  declare @htmlStatsBody as varchar(max)=''              
  select @htmlStatsBody ='<b>Payout Risk Indicator</b><br><table border=1 CELLSPACING=0>              
  <tr style="font-weight:bold"><td>Batch id</td><td>Last Process Time</td><td>Fetch-Veri.Time Gap (mins)</td><td>Seg.Fetch Time Gap(mins)</td><td>Net-Payable Diff</td><td>              
  Multi Cli.PO</td><td>Payout Exceeds</td></tr><tr><td>'+Batchid+'</td><td>'+CONVERT(varchar(25),processdate)+'</td><td align=center>'+              
  CONVERT(varchar(5),CurrTimeGap)+'</td><td align=center>'+              
  CONVERT(varchar(5),SegTimeGap)+'</td><td align=center>'+              
  CONVERT(varchar(5),NetPayDiff)+'</td><td align=center>'+              
  CONVERT(varchar(5),MultiCli)+'</td><td align=center>'+              
  CONVERT(varchar(5),payexceed)+'</td></tr></table>'              
  from NCMS_VerificationGapsStatistics_vw  with(nolock)           

/*LD Count :: Start */
  declare @htmlLD as varchar(max)=''
    declare @LDCount as int = 0     
  select @LDCount=COUNT(1) from NCMS_LD  with(nolock)
  select  @htmlLD='<b>Payout LD Count</b><br><table border=1 CELLSPACING=0> 
   <tr style="font-weight:bold"><td>LD Count</td></tr><tr><td>'+CONVERT(varchar(max),@LDCount)+'</td></tr></table>'
   --print @htmlLD
/*LD Count :: END */
   
   
 /*flexi Count :: Start */
  declare @htmlflexi as varchar(max)=''
    declare @flexiCount as int = 0     ,@POreleasedcount as int=0
  select @flexiCount=COUNT(1) from NCMS_Flexi_On_POAmt  with(nolock) where Batchid=@batchid
  set @flexiCount=0
   select @POreleasedcount=COUNT(1) from ncms_segpayoutappamt  with(nolock) where Batchid=@batchid and BOFF_gen=1
	and	BANK_gen in (1,3) and Req_RefNo like 'neft%'
  select  @htmlflexi='<b>Flexi Count</b><br><table border=1 CELLSPACING=0> 
   <tr style="font-weight:bold"><td>Flexi Count</td><td>PO Released Count</td></tr><tr><td>'+CONVERT(varchar(max),@flexiCount)+'</td><td>'+CONVERT(varchar(max),@POreleasedcount)+'</td></tr></table>'
   --print @htmlLD
/*flexi Count :: END */
     
  /* Backoffice Posting Rejection Details :: Start */   
  declare @htmlAPIBody as varchar(max)=''   
  if (select count(1) from NCMS_BOAPIpostingError  with(nolock)) > 0  
  BEGIN   
  
  set @htmlAPIBody ='<font color=red><b>BackOffice Posting Rejection List. (Request you to manually update BO. ignore if already updated)</b></font>'            
  set @htmlAPIBody =@htmlAPIBody +'<br><table border=1 CELLSPACING=0><tr style="font-weight:bold"><td>PartyCode</td><td>Entity</td><td>Segment</td>'            
  set @htmlAPIBody =@htmlAPIBody +'<td>Bank</td><td>Payout Amount</td><td>ProcessDateTime</td><td>Rejection Reason</td></tr>'              

  declare @APIctr as int = 1,@APItotctr as int = 0            
  select @APItotctr=COUNT(1) from NCMS_BOAPIpostingError with(nolock)            
  
  While @APIctr <= @APItotctr            
  Begin            
   select  @htmlAPIBody=@htmlAPIBody+'<tr><td align=center>'+Party_Code+'</td><td align=center>'+Entity+            
   '</td><td align=right>'+segment+'</td><td align=right>'+Bank+'</td><td align=right>'+convert(varchar(15),convert(decimal(15,2),PayoutAmount))+            
   '</td><td align=right>'+convert(varchar(25),ProcessDateTime)+            
   '</td><td align=right>'+Reason+'</td></tr>'            
   from NCMS_BOAPIpostingError  with(nolock) where  PayoutAmount>0.00 and Srno=@APIctr            
   set @APIctr=@APIctr+1             
  End            
  set  @htmlAPIBody=@htmlAPIBody+'</table><br><Br>'  
   
  END    
  /* Backoffice Posting Rejection Details :: End*/   
    
    
  /*declare @htmlPEBody as varchar(2000)='',@batchid as varchar(15)=''              
   select @batchid=batchid from NCMS_VerificationGapsStatistics_vw          
     */      
  if (select payexceed from NCMS_VerificationGapsStatistics_vw  with(nolock))>0            
  Begin            
             
   set @htmlPEBody ='<font color=red><b>Payout Exceeding Net-Payable</b></font>'            
   set @htmlPEBody =@htmlPEBody +'<br><table border=1 CELLSPACING=0><tr style="font-weight:bold"><td>PartyCode</td><td>Entity</td>'            
   set @htmlPEBody =@htmlPEBody +'<td>Total Payout Value</td><td>Total Net Payable</td></tr>'            
               
    Select ROW_NUMBER() OVER ( ORDER BY party_code,Entity) AS [SrNo],* into #PEtemp from NCMS_payexceed  with(nolock) where batchid=@batchid           
                
    declare @PEctr as int = 1,@PEtotctr as int = 0            
    select @PEtotctr=COUNT(1) from #PEtemp             
             
     While @PEctr <= @PEtotctr            
     Begin            
      select  @htmlPEBody=@htmlPEBody+'<tr><td align=center>'+Party_Code+'</td><td align=center>'+Entity+            
      '</td><td align=right>'+convert(varchar(15),convert(decimal(15,2),SegApprovedAmt))+            
      '</td><td align=right>'+convert(varchar(15),convert(decimal(15,2),NetPayable))+'</td></tr>'            
      from #PEtemp where Srno=@PEctr            
      set @PEctr=@PEctr+1             
     End            
  set  @htmlPEBody=@htmlPEBody+'</table><br><Br>'            
  End            
             
              
   set @HTMLBODY1='Dear Banking Team,<br><Br>'                        
   +' Funds Payout Statistics of last verification for your reference.<br><br>'                        
   +'<table border="1"><tr style="font-weight:bold"><td>Date Time</td><td>Entity</td><td>Bank</td><td>Segment</td><td>Count</td><td>BO Pushed</td>'                      
   +'<td>BO Posted</td><td>Bank Posted</td><td>Total PO Amt (Rs.)</td><td>HPV (Rs.)</td></tr>'                      
   +@HTMLBODY1+'</table><BR><BR>'+@htmlLD+'<BR><BR>'+@htmlflexi+'<BR><BR>'+@htmlStatsBody+'<BR><BR>'+@htmlPEBody+'<BR><BR>'
   +@htmlAPIBody+'This is a System generated Message. Please do not Reply.<BR><BR>'                      
                       
   /* set @subject='NCMS: Funds Payout Statistics Batch-id: '*/    
 select @subject='NCMS: Funds Payout Statistics Batch-id: '+Batchid from NCMS_VerificationGapsStatistics_vw   with(nolock)  
                        
   EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                
   @RECIPIENTS =@emailto,                                
   @COPY_RECIPIENTS = @emailcc,                                
   @PROFILE_NAME = 'pay-outbanking',                                
   @BODY_FORMAT ='HTML',                                
   @SUBJECT = @subject,                                
   @FILE_ATTACHMENTS ='',                                
   @BODY =@HTMLBODY1                      
                       
   drop table #file1_reco                              
 end                        
    
/* Backup of Flexi Table*/      
insert into NCMS_PO_Request_Flexi_Hist (processDate,POrequestID,Batchid,Updatedon)       
select processDate,POrequestID,@batchid,getdate() from NCMS_PO_Request_Flexi       
                  
END TRY                                
BEGIN CATCH                                
                                
 insert into risk.dbo.Appln_ERROR (ErrTime,ErrObject,ErrLine,ErrMessage,ApplnName,DBname)                                                        
 select GETDATE(),'NCMS_VeriStatsEmail',ERROR_LINE(),ERROR_MESSAGE(),'NCMS',DB_NAME(db_id())                                                        
                      
 DECLARE @ErrorMessage NVARCHAR(4000);                                     
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                      
 RAISERROR (@ErrorMessage , 16, 1);                           
                                
END CATCH                                
                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_UPD_REQUEST_SPARK_09Aug2023
-- --------------------------------------------------
  
CREATE PROC [dbo].[NCMS_UPD_REQUEST_SPARK_09Aug2023](@PCODE AS VARCHAR(11),@IP AS VARCHAR(15),@USER AS VARCHAR(25),@EQ_AMT AS MONEY,@COMM_AMT AS MONEY,@NBFC_AMT AS MONEY                                    
,@EQ_ACCNO AS VARCHAR(25) =null,@COMM_ACCNO AS VARCHAR(25)=null,@NBFC_ACCNO AS VARCHAR(25)=null,@requestType as char(1)=null,@remarks AS VARCHAR(500)=null)                                      
AS                                      
                                      
SET NOCOUNT ON                                      
--SET XACT_ABORT ON                                             
--BEGIN TRY                                                  
          
  SET @requestType  = ISNULL(@requestType,'U')        
          
  declare @postatid int = 0,@paymode as varchar(10)  ='',@err as varchar(100)=''   
    
  /*  
  SELECT @EQ_ACCNO= ACCNO   FROM   
  ncms_approvedaccno WHERE   pcode=@PCODE  AND  (case when LEFT(IFSC,4)='SBIN' THEN RIGHT('000000000000000000'+ACCNO,17) ELSE ACCNO END)=@EQ_ACCNO    
  */ /*Commented on 25 Sep 2021***/         
    
  SELECT @EQ_ACCNO= ACCNO   FROM     
  ncms_approvedaccno with(nolock) WHERE   pcode=@PCODE  AND  (case when LEFT(IFSC,4)='SBIN' THEN RIGHT('0000000000000000'+ltrim(rtrim(ACCNO)),17)   
   WHEN  LEFT(IFSC,4) ='CBIN'  THEN RIGHT('0000000000000000'+LTRIM(RTRIM(ACCNO)),17)  /*added on 25 Sep 2021 by Neha*/    
   ELSE ACCNO END)=@EQ_ACCNO           
                  
  if @requestType='M'                    
   set @postatid =7                    
                      
                              
  /* Req_Paymode,Req_PayBankId PENDING */                                      
  IF @EQ_AMT > 0                                      
  BEGIN                                      
  if (select NetPayable from NCMS_Entitydata_PO with(nolock) where party_code=@PCODE and Entity='AllSegment') >= @EQ_AMT     
  Begin    
   --if (select COUNT(1) from ncms_approvedaccno with (nolock) where pcode=@PCODE and Accno=@EQ_ACCNO) = 0     
   if(@EQ_AMT>=25000)  
   begin  
   if (select COUNT(1) from ncms_approvedaccno with (nolock) where pcode=@PCODE and Accno=@EQ_ACCNO and Flag_firstPO is null) > 0     
   begin                  
    set @postatid =7                    
   End       
   end  
   set @remarks='T'  
   select top 1 @paymode=paymode from ncms_clientBankdetails_all with(nolock) where cltcode=@PCODE and acno=@EQ_ACCNO and domain='AllSegment'                
   if isnull(@paymode,'')='NORMAL'  
 Begin  
      set @err='NORMAL_PAYMODE'  
    Raiserror(@err, 16, 1)  
    return;  
 end  
   if isnull(@paymode,'') <> ''      
   Begin      
    insert into NCMS_PO_Request                                      
    (SegMinID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,requestType,remarks)                                      
    select id,Party_code,Entity,Netpayable,@EQ_AMT,GETDATE(),GETDATE(),@IP,@USER,@paymode,@EQ_ACCNO,'',0,0,@postatid,@requestType,@remarks from /*NCMS_Entitydata*/ /*NCMS_EntityDataView*/ NCMS_EntityDataView_combine  with(nolock)                          
           
    where party_code=@PCODE AND Entity='AllSegment'                                 
   End   
   else  
   begin  
    set @err='PAYMODE_BLANK'  
   end  
  end  
  else  
  begin  
 set @err='NET_LESS_AMOUNT'  
  end  
  END   
  if(@EQ_AMT <= 0 )  
  begin  
   set @err='AMOUNT_LESS_ZERO'  
  end                             
DECLARE @REFNO AS VARCHAR(25)=''    
       
if isnull(@paymode,'') <> ''      
Begin      
 select @REFNO=Req_Paymode+replace(convert(varchar(10),GETDATE(),102),'.','')+                                      
 risk.dbo.AddZeroPrefox(MAX(porequestid),5)                                      
 from NCMS_PO_Request WITH (NOLOCK) where party_code=@PCODE and Req_RefNo=''                                     
 group by Req_Paymode    
   
   select REFNO=Req_Paymode+replace(convert(varchar(10),GETDATE(),102),'.','')+   
 risk.dbo.AddZeroPrefox(MAX(porequestid),5), party_code, porequestid into #ref                                    
 from NCMS_PO_Request WITH (NOLOCK) where party_code=@PCODE and Req_RefNo=''                                     
 group by Req_Paymode, party_code, porequestid    
  
 update a set a.req_refno=b.refno from NCMS_PO_Request a join #ref b on a.Party_code=b.Party_code and a.POrequestID=b.POrequestID  
   
 --select * into #PO_request from NCMS_PO_Request where 1=2  
   
 -- SET IDENTITY_INSERT #PO_request ON     
 -- insert into #PO_request(  SegMinID,POrequestID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,  
 --  Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,remarks,requestType)  
 -- EXEc NCMS_UPDATE_REFNO @pcode,@REFNO    
 -- SET IDENTITY_INSERT #PO_request OFF   
  
end                                  
                           
  /* update NCMS_PO_Request set Req_RefNo=@REFNO where party_code=@PCODE and Req_RefNo='' */                                      
                
  if @USER=@PCODE              
  Begin      
  /*Added on 14 Oct 2022 for sending SMS*/  
 if exists (select * from ncms_po_request with(nolock) where party_code=@PCODE and req_refno=@REFNO /*and ltrim(rtrim(party_code)) in ('B300228','T21077','A303796','S1499152','y9901','H201164')*/)    
 Begin      
    EXEC NCMS_AE_SendMarkingSMS @PCODE,@REFNO  
    if( @PCODE ='P287427')  
    exec NCMS_SendMarking_email @PCODE,@REFNO   
 End  
 /*********************************************************/  
  /*  select Party_code,Entity,PO_Request,Req_datetime,Req_User,Req_Paymode,                                  
    Req_PayBankId,Req_RefNo,Bankname,Acno,Party_name  as person_name,Region,Branch,sb,Party_name into #we from                                      
    (SELECT                                   
    Party_code,Entity,PO_Request,Req_datetime,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo                                  
    FROM NCMS_PO_Request  with (nolock) WHERE Req_RefNo=@REFNO) x                                   
    join NCMS_ClientBankDetails_all y  with (nolock) on x.Req_PayBankid=y.Acno and x.party_code=y.cltcode                             
    and replace(x.entity,'AllSegment','AllSegment')=y.domain                                  
    join risk.dbo.VW_RMS_ALL_CLIENT_VERTICAL a  with (nolock) on x.Party_code=a.Client  */      
 SELECT Party_code,Entity,PO_Request,Req_datetime,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo  into #we  FROM NCMS_PO_Request  with (nolock)   
 WHERE Req_RefNo=@REFNO and Party_code=@PCODE    
  End              
   if(@err='')  
    begin  
    SELECT Party_code,POrequestID,PO_Request,Req_datetime  AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' Req_Datetime,Req_RefNo,  
  CAST(dbo.udf_getcredittime(Req_Datetime,party_code,POrequestID) as DATETIME) AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' AS credit_date_time        
  FROM NCMS_PO_Request  with (nolock)   
  WHERE Req_RefNo=@REFNO and Party_code=@PCODE    
 end  
  if(select count(1) from #we)=0  
  begin  
 -- print 'nn'   
 insert into NCMS_Marking_Error_Log(ErrTime,ErrMessage,party_code)                                                        
 select GETDATE(),@err,@PCODE  
 Raiserror(@err, 16, 1)  
  end  
                 
--End try                                               
                                              
--BEGIN CATCH                                                  
            
--  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                        
--  select GETDATE(),'NCMS_UPD_Request',ERROR_LINE(),ERROR_MESSAGE()                                                        
            
--  DECLARE @ErrorMessage NVARCHAR(4000);                                                    
--  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
--  RAISERROR (@ErrorMessage , 16, 1);            
                                                                   
--End catch                  
                                  
                                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_UPD_REQUEST_SPARK_11July2023
-- --------------------------------------------------
  
CREATE PROC [dbo].[NCMS_UPD_REQUEST_SPARK_11July2023](@PCODE AS VARCHAR(11),@IP AS VARCHAR(15),@USER AS VARCHAR(25),@EQ_AMT AS MONEY,@COMM_AMT AS MONEY,@NBFC_AMT AS MONEY                                    
,@EQ_ACCNO AS VARCHAR(25) =null,@COMM_ACCNO AS VARCHAR(25)=null,@NBFC_ACCNO AS VARCHAR(25)=null,@requestType as char(1)=null,@remarks AS VARCHAR(500)=null)                                      
AS                                      
                                      
SET NOCOUNT ON                                      
--SET XACT_ABORT ON                                             
--BEGIN TRY                                                  
          
  SET @requestType  = ISNULL(@requestType,'U')        
          
  declare @postatid int = 0,@paymode as varchar(10)  ='',@err as varchar(100)=''   
    
  /*  
  SELECT @EQ_ACCNO= ACCNO   FROM   
  ncms_approvedaccno WHERE   pcode=@PCODE  AND  (case when LEFT(IFSC,4)='SBIN' THEN RIGHT('000000000000000000'+ACCNO,17) ELSE ACCNO END)=@EQ_ACCNO    
  */ /*Commented on 25 Sep 2021***/         
    
  SELECT @EQ_ACCNO= ACCNO   FROM     
  ncms_approvedaccno with(nolock) WHERE   pcode=@PCODE  AND  (case when LEFT(IFSC,4)='SBIN' THEN RIGHT('0000000000000000'+ltrim(rtrim(ACCNO)),17)   
   WHEN  LEFT(IFSC,4) ='CBIN'  THEN RIGHT('0000000000000000'+LTRIM(RTRIM(ACCNO)),17)  /*added on 25 Sep 2021 by Neha*/    
   ELSE ACCNO END)=@EQ_ACCNO           
                  
  if @requestType='M'                    
   set @postatid =7                    
                      
                              
  /* Req_Paymode,Req_PayBankId PENDING */                                      
  IF @EQ_AMT > 0                                      
  BEGIN                                      
  if (select NetPayable from NCMS_Entitydata_PO with(nolock) where party_code=@PCODE and Entity='AllSegment') >= @EQ_AMT     
  Begin    
   --if (select COUNT(1) from ncms_approvedaccno with (nolock) where pcode=@PCODE and Accno=@EQ_ACCNO) = 0     
   if(@EQ_AMT>=25000)  
   begin  
   if (select COUNT(1) from ncms_approvedaccno with (nolock) where pcode=@PCODE and Accno=@EQ_ACCNO and Flag_firstPO is null) > 0     
   begin                  
    set @postatid =7                    
   End       
   end  
   set @remarks='T'  
   select top 1 @paymode=paymode from ncms_clientBankdetails_all with(nolock) where cltcode=@PCODE and acno=@EQ_ACCNO and domain='AllSegment'                
   if isnull(@paymode,'')='NORMAL'  
 Begin  
      set @err='NORMAL_PAYMODE'  
    Raiserror(@err, 16, 1)  
    return;  
 end  
   if isnull(@paymode,'') <> ''      
   Begin      
    insert into NCMS_PO_Request                                      
    (SegMinID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,requestType,remarks)                                      
    select id,Party_code,Entity,Netpayable,@EQ_AMT,GETDATE(),GETDATE(),@IP,@USER,@paymode,@EQ_ACCNO,'',0,0,@postatid,@requestType,@remarks from /*NCMS_Entitydata*/ /*NCMS_EntityDataView*/ NCMS_EntityDataView_combine  with(nolock)                          
           
    where party_code=@PCODE AND Entity='AllSegment'                                 
   End   
   else  
   begin  
    set @err='PAYMODE_BLANK'  
   end  
  end  
  else  
  begin  
 set @err='NET_LESS_AMOUNT'  
  end  
  END   
  if(@EQ_AMT <= 0 )  
  begin  
   set @err='AMOUNT_LESS_ZERO'  
  end                             
DECLARE @REFNO AS VARCHAR(25)=''    
       
if isnull(@paymode,'') <> ''      
Begin      
 select @REFNO=Req_Paymode+replace(convert(varchar(10),GETDATE(),102),'.','')+                                      
 risk.dbo.AddZeroPrefox(MAX(porequestid),5)                                      
 from NCMS_PO_Request WITH (NOLOCK) where party_code=@PCODE and Req_RefNo=''                                     
 group by Req_Paymode    
   
   select REFNO=Req_Paymode+replace(convert(varchar(10),GETDATE(),102),'.','')+    
 risk.dbo.AddZeroPrefox(MAX(porequestid),5), party_code, porequestid into #ref                                    
 from NCMS_PO_Request WITH (NOLOCK) where party_code=@PCODE and Req_RefNo=''                                     
 group by Req_Paymode, party_code, porequestid    
  
 update a set a.req_refno=b.refno from NCMS_PO_Request a join #ref b on a.Party_code=b.Party_code and a.POrequestID=b.POrequestID  
   
 --select * into #PO_request from NCMS_PO_Request where 1=2  
   
 -- SET IDENTITY_INSERT #PO_request ON     
 -- insert into #PO_request(  SegMinID,POrequestID,Party_code,Entity,Net_payable,PO_Request,POdt_request,Req_datetime,Req_IP,Req_User,Req_Paymode,  
 --  Req_PayBankId,Req_RefNo,POveriID,PO_ApprovedAmt,PO_Statusid,remarks,requestType)  
 -- EXEc NCMS_UPDATE_REFNO @pcode,@REFNO    
 -- SET IDENTITY_INSERT #PO_request OFF   
  
end                                  
                           
  /* update NCMS_PO_Request set Req_RefNo=@REFNO where party_code=@PCODE and Req_RefNo='' */                                      
                
  if @USER=@PCODE              
  Begin      
  /*Added on 14 Oct 2022 for sending SMS*/  
 if exists (select * from ncms_po_request with(nolock) where party_code=@PCODE and req_refno=@REFNO /*and ltrim(rtrim(party_code)) in ('B300228','T21077','A303796','S1499152','y9901','H201164')*/)    
 Begin      
    EXEC NCMS_AE_SendMarkingSMS @PCODE,@REFNO   
 End  
 /*********************************************************/  
  /*  select Party_code,Entity,PO_Request,Req_datetime,Req_User,Req_Paymode,                                  
    Req_PayBankId,Req_RefNo,Bankname,Acno,Party_name  as person_name,Region,Branch,sb,Party_name into #we from                                      
    (SELECT                                   
    Party_code,Entity,PO_Request,Req_datetime,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo                                  
    FROM NCMS_PO_Request  with (nolock) WHERE Req_RefNo=@REFNO) x                                   
    join NCMS_ClientBankDetails_all y  with (nolock) on x.Req_PayBankid=y.Acno and x.party_code=y.cltcode                             
    and replace(x.entity,'AllSegment','AllSegment')=y.domain                                  
    join risk.dbo.VW_RMS_ALL_CLIENT_VERTICAL a  with (nolock) on x.Party_code=a.Client  */      
 SELECT Party_code,Entity,PO_Request,Req_datetime,Req_User,Req_Paymode,Req_PayBankId,Req_RefNo  into #we  FROM NCMS_PO_Request  with (nolock)   
 WHERE Req_RefNo=@REFNO and Party_code=@PCODE    
  End              
  
  if(select count(1) from #we)=0  
  begin  
 -- print 'nn'   
 insert into NCMS_Marking_Error_Log(ErrTime,ErrMessage,party_code)                                                        
 select GETDATE(),@err,@PCODE  
 Raiserror(@err, 16, 1)  
  end  
                 
--End try                                               
                                              
--BEGIN CATCH                                                  
            
--  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                        
--  select GETDATE(),'NCMS_UPD_Request',ERROR_LINE(),ERROR_MESSAGE()                                                        
            
--  DECLARE @ErrorMessage NVARCHAR(4000);                                                    
--  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
--  RAISERROR (@ErrorMessage , 16, 1);                       
                                                                   
--End catch                  
                                  
                                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_UPD_ReqVerId_Batchwise
-- --------------------------------------------------
CREATE procedure [dbo].[NCMS_UPD_ReqVerId_Batchwise]                                            
as                                                  
SET nocount on                                             
SET XACT_ABORT ON                                                                  
BEGIN TRY                                                                
      
	update ncms_batch_process set StartDate=getdate() where srno=18  
  /* Updating Request ID */                                                  
  /* Start For capturing Records not updated in BO and client done marking again */
	 
		
  /* End For capturing Records not updated in BO and client done marking again */                                      
  create table #NCMS_APPAMT                                             
  (                                                                
  SRNO int,                                                  
  PARTY_CODE VARCHAR(10),                                                  
  ENTITY VARCHAR(10),                                                  
  Req_RefNo VARCHAR(25),                                                  
  poREQUESTID INT,                                                  
  ApprovedAmt MONEY,                                                  
  POSTATUS INT,                                                  
  POveriID INT,                                              
  NetPayable money,                                            
  EQ_NetPayable money,                                            
  /*CO_NetPayable money,                                            */
  NB_NetPayable money,                                            
  PO_Request money,                                            
  PO_allowed MONEY,                                            
  Batchid varchar(15),                                          
  RequestType char(1)                                                  
  )                                                  
      
 /* Blocked Clients payout for all the client in block/unlock client master of CMS */      
             
                                        
  select party_Code,entity,POrequestid,Req_RefNo,PO_request,isnull(RequestType,'U') as RequestType                            
  into #POdata                                             
  from cms.dbo.NCMS_PO_Request_ForPayout  WITH (NOLOCK) /* where PO_Statusid=0 */    
                          
 
 
  /*Declare @CFminAMT money = 5*/ /* Min Partial Rejected Amt Carry forward */
  Declare @CFminAMT money = 1 /*Added on 29 Jul 2017 as per sajeeven Sir Mail*/                                               
  Declare @Batchid varchar(15) = ''                          
                                          
  select @Batchid=RIGHT(convert(varchar(8),getdate(),112),6)+replace(convert(varchar(8),getdate(),108),':','')                                 
                                                  
  INSERT INTO #NCMS_APPAMT                                          
  (SRNO,POveriID,PARTY_CODE,ENTITY,Req_RefNo,poREQUESTID,ApprovedAmt,POSTATUS,NetPayable,PO_Request,EQ_NetPayable,NB_NetPayable,PO_allowed,Batchid,RequestType)                                                  
  select                                                   
  ROW_NUMBER() OVER ( ORDER BY B.poREQUESTID ) AS [SrNo],a.ID,a.party_Code,a.entity,b.Req_RefNo,                                                  
  B.poREQUESTID,                                                  
  ApprovedAmt=(Case                                                   
  when REquestType<>'M' and REquestType<>'B' and PO_Request <= a.NetPayable and a.NetPayable > 0 then PO_Request                                                   
  when REquestType<>'M' and REquestType<>'B' and PO_Request > a.NetPayable and a.NetPayable > 0 then a.NetPayable                                                  
  when REquestType='M' then PO_Request                                                   
  when REquestType='B' then PO_Request                           
  else 0 end),                                                  
  POSTATUS=(Case                                                   
  when REquestType<>'M' and REquestType<>'B' and PO_Request <= a.NetPayable and a.NetPayable > 0 then 2                                                  
  when REquestType<>'M' and REquestType<>'B' and PO_Request > a.NetPayable and a.NetPayable > 0 then 4                                                  
  when REquestType='M'  then 2                                          
  when REquestType='B' then 2                          
  else 3 end),a.NetPayable,PO_Request,0,0,0,@Batchid,b.RequestType                                                   
  from                                             
  (select party_Code,ID,entity,NetPayable from cms.dbo.NCMS_CombineVeriData with (nolock)) a join #POdata b                                      
  on a.entity=b.entity and a.party_code=b.Party_code                                                 
                        
  /* CHECK 1 Start */                        
                        
  declare @CurrTimeGap as int=0,@SegTimeGap as int=0,@NetPayDiff as int = 0,@MultiCli as int = 0,@ValidTimeGap as int =5                          
                        
  /* @CurrTimeGap means Time gap between fetching segmentwise data and payout processing */                        
  /* @@SegTimeGap means Time gap between different segment data */                        
  select @CurrTimeGap=datediff(mi,max(processdate),GETDATE()),                        
  @SegTimeGap=datediff(mi,min(processdate),max(processdate)) from cms.dbo.NCMS_SegVeriData with (nolock)                         
  where segment <> 'NBFC'                         
                        
  /* select segment,processdate from NCMS_SegVeriData with (nolock)  where segment <> 'NBFC' group by segment,processdate */                        
                        
  /* @NetPayDiff means reconconfirming mismatches in entitywise net payable */                        
  select @NetPayDiff=COUNT(1) /* select * */                        
  from #NCMS_APPAMT a left outer join                         
  (select Entity,party_code,sum(NetPayable) as NetPayable from cms.dbo.NCMS_SegVeriData with (nolock) group by Entity,party_code) b                        
  on a.PARTY_CODE=b.Party_code and a.ENTITY=b.Entity                        
  where a.NetPayable<> b.NetPayable                        
                        
  /* @MultiCli - Client with multiple payout from same entity */                        
  select @MultiCli=SUM(cnt) from                        
  (                        
  select count(distinct party_code) as cnt from #NCMS_APPAMT where postatus=2 group by party_code,entity having COUNT(1) > 1                        
  ) z                        
                
  /*                      
  if (@CurrTimeGap>@ValidTimeGap or @SegTimeGap>@ValidTimeGap or  @NetPayDiff>0 or @MultiCli> 0)                         
  Begin                        
                
   insert into sms.dbo.sms                                
   select mobile as No,                          
   'NCMS Risk Indicator: Batchid-'+@Batchid+' Currtime:'+convert(varchar(3),@CurrTimeGap)+'min SegTime:'+convert(varchar(3),@SegTimeGap)+'min NetPayDiff:'+                        
   convert(varchar(3),@NetPayDiff)+' MultiCli:'+convert(varchar(3),@MultiCli)                        
   , convert(varchar(10),getdate(), 103)                                      
   ,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':'+ ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                                                         
   'P', case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end,                                            
   'Payout Marking' from NCMS_mobile                         
                           
   < Verification Stop Command >                        
                           
-- Reverse Bill2Bill Flag                           
     UPDATE NCMS_B2B_PO_Request SET UserAppStatus=1 FROM #PODATA B WHERE NCMS_B2B_PO_Request.REQ_REFNO=B.REQ_REFNO                          
     and ISNULL(NCMS_B2B_PO_Request.USERaPPsTATUS,0)=2                          
     -- Rever Payout Flag                        
     update NCMS_PO_Request set PO_Statusid=0                        
     from #POdata b where NCMS_PO_Request.porequestid=b.porequestid                                             
                   
                           
  End                        
  */              
  /* CHECK 1 End */                        
                        
                                        
  UPDATE #NCMS_APPAMT SET EQ_NetPayable=B.NETPAYABLE FROM                                            
  /*NCMS_EntityVeriData_EQNP*/ cms.dbo.NCMS_EntityVeriData_EQNP_ForCombine B with(nolock) WHERE  #NCMS_APPAMT.PARTY_CODE=B.PARTY_CODE                                           
                                    
  UPDATE #NCMS_APPAMT SET NB_NetPayable=B.NETPAYABLE FROM                                            
  /*NCMS_EntityVeriData_NBNP*/ cms.dbo.NCMS_EntityVeriData_NBNP_ForCombine B  with(nolock) WHERE  #NCMS_APPAMT.PARTY_CODE=B.PARTY_CODE                      
  /*change on 11 jul 2016 */
  UPDATE #NCMS_APPAMT SET NETPAYABLE=NETPAYABLE-B.debitamt FROM                                              
  cms.dbo.NCMS_PendingBOReq_Log B  with(nolock) WHERE  #NCMS_APPAMT.PARTY_CODE=B.PARTY_CODE   
   
                                        
  /*-- Calculation Payout Allowed --*/                                            
  UPDATE #NCMS_APPAMT SET PO_allowed=                                            
  (CASE                                             
  WHEN ENTITY='AllSegment' AND EQ_NETPAYABLE > NETPAYABLE AND NETPAYABLE > 0 THEN NETPAYABLE                                             
  WHEN ENTITY='AllSegment' AND EQ_NETPAYABLE <= NETPAYABLE AND EQ_NETPAYABLE > 0 THEN EQ_NETPAYABLE                                             
 /* WHEN ENTITY='AllSegment' AND CO_NETPAYABLE > NETPAYABLE AND NETPAYABLE > 0 THEN NETPAYABLE                       
  WHEN ENTITY='AllSegment' AND CO_NETPAYABLE <= NETPAYABLE AND CO_NETPAYABLE > 0 THEN CO_NETPAYABLE                                             */
  WHEN ENTITY='NBFC' AND NB_NETPAYABLE > NETPAYABLE AND NETPAYABLE > 0 THEN NETPAYABLE                                       
  WHEN ENTITY='NBFC' AND NB_NETPAYABLE <= NETPAYABLE AND NB_NETPAYABLE > 0 THEN NB_NETPAYABLE                                             
  ELSE 0 END) 
  where #NCMS_APPAMT.RequestType NOT IN ('M','B') /*added on 06 march 2017*/
                                        
 /* UPDATE #NCMS_APPAMT SET PO_allowed=0 where PO_allowed<=@CFminAMT */
 
 -- UPDATE #NCMS_APPAMT SET PO_allowed=0 where PO_allowed<@CFminAMT
  
  /*added on 26 jun 2020 for rejecting request less than 1 rs*/  
  UPDATE #NCMS_APPAMT SET PO_allowed=0 where PO_REQUEST<@CFminAMT                                                                                     
  /*******************/
                                        
  UPDATE #NCMS_APPAMT SET                                             
  ApprovedAmt=(CASE WHEN PO_REQUEST >= PO_ALLOWED THEN PO_ALLOWED ELSE PO_REQUEST END),                                            
  POSTATUS=(CASE                                             
  WHEN PO_REQUEST > PO_ALLOWED AND PO_ALLOWED > 0 THEN 4                                             
  WHEN PO_REQUEST > PO_ALLOWED AND PO_ALLOWED = 0 THEN 3                                            
  WHEN PO_REQUEST <= PO_ALLOWED THEN 2                                            
  ELSE 0 END)                                            
  where #NCMS_APPAMT.RequestType NOT IN ('M','B')                                             
                                       
  /* Calculation Payout for Multiple Transaction of Single Client */                                            
  SELECT PARTY_CODE,ENTITY into #NCMS_MultiCLi                   
  FROM #NCMS_APPAMT GROUP BY PARTY_CODE,ENTITY having COUNT(1) > 1                                            
                                            
  IF (select COUNT(1) from #NCMS_MultiCLi) > 0                                            
  BEGIN                                            
  select                                             
  ROW_NUMBER() OVER ( ORDER BY a.party_code,a.entity,a.srno) AS [SrNoID],                                            
  a.*                                             
  into #NCMS_APPAMT_TEMP                                             
  from #NCMS_APPAMT a join #NCMS_MultiCLi b                                           
  on a.PARTY_CODE=b.party_code and a.ENTITY=b.entity                                           
  where a.RequestType NOT IN ('M','B')                                          
                                             
                                             
  Declare @MC_ctr as int = 1,@MC_Totctr as int = 0,@pcode as varchar(10)='',@entityx as varchar(10)=''                                          
  Declare @M_pcode as varchar(10)='',@M_entity as varchar(10)='',@po_allowed as money = 0                                            
  Declare @SRno as int =0                                            
                                              
  select @MC_Totctr=COUNT(1) from #NCMS_APPAMT_TEMP                                            
                                        
  While @MC_ctr <= @MC_Totctr                                            
  Begin                                            
                                            
  select @M_pcode=party_code,@M_entity=entity,@SRno=srno from #NCMS_APPAMT_TEMP where srnoid=@MC_ctr                                            
  if @M_pcode<> @pcode and @M_entity<>@entityx                                     
  Begin                                            
  set @pcode=@M_pcode                                            
  set @entityx=@M_entity                                            
  select @po_allowed=PO_allowed-approvedAmt from  #NCMS_APPAMT_TEMP where srnoid=@MC_ctr                                            
  End                                            
  Else                      
  Begin                                            
  UPDATE #NCMS_APPAMT SET                                             
  ApprovedAmt=convert(decimal(20,2),(CASE WHEN PO_REQUEST >= @po_allowed THEN @po_allowed ELSE PO_REQUEST END)),                                            
  postatus=(CASE                                             
  WHEN PO_REQUEST > @po_allowed AND @po_allowed > 0 THEN 4                           
  WHEN PO_REQUEST > @po_allowed AND @po_allowed = 0 THEN 3                                            
  WHEN PO_REQUEST <= @po_allowed THEN 2                                            
  ELSE 0 END)                                            
  where srno=@SRno                                            
                                        
  select @po_allowed=@po_allowed-approvedAmt from  #NCMS_APPAMT_TEMP where srnoid=@MC_ctr                                            
  End                                            
  set @MC_ctr=@MC_ctr+1                                            
  End                                            
                                            
  END                                            
                                             
  update  #NCMS_APPAMT  set ApprovedAmt=0,POSTATUS=3 where  ApprovedAmt<@CFminAMT and ApprovedAmt>0 /**added on 09 Aug 2021*/
       
  --insert into NCMS_EntityPayoutAppAmt(SRNO,PARTY_CODE,ENTITY,Req_RefNo,poREQUESTID,ApprovedAmt,POSTATUS,POveriID,NetPayable,EQ_NetPayable,NB_NetPayable,PO_Request,PO_allowed,Batchid,processdate)                                             
  --select SRNO,PARTY_CODE,ENTITY,Req_RefNo,poREQUESTID,ApprovedAmt,POSTATUS,POveriID,NetPayable,                                            
  --EQ_NetPayable,NB_NetPayable,PO_Request,PO_allowed,Batchid,GETDATE() from #NCMS_APPAMT      
  
   /* update      #NCMS_APPAMT set POSTATUS=0 where POSTATUS=3  */
 
  select * into #reject from cms.dbo.ncms_po_request where req_refno in (select req_refno from #NCMS_APPAMT where POSTATUS=3)   
   select * into #reject1  from #NCMS_APPAMT where Req_RefNo in (select Req_RefNo from #reject) and POSTATUS=3  
   
   /*select party_code into #Data from ncms_po_request where party_code in (select party_code from #NCMS_APPAMT where POSTATUS=2) and po_statusid=0
   group by party_code having count(1)>1 /*Added on 18 Feb 2022**/ */ --comented on 10 Jun 2022 by neha
    /******Start*************/
	select party_code into #SingleData from cms.dbo.ncms_po_request where party_code in (select party_code from #NCMS_APPAMT where POSTATUS=2) and
	 Req_PayBankId in (select Req_PayBankId from cms.dbo.NCMS_PO_Request_ForPayout) and	 po_statusid=0  
   group by party_code having count(1)=1 

    select * into #Nws  from #NCMS_APPAMT where party_code in (select party_code from #SingleData) and POSTATUS=2 

 /*******end**************************/

    select party_code into #Data from cms.dbo.ncms_po_request where party_code in (select party_code from #NCMS_APPAMT where POSTATUS=2) and
	 Req_PayBankId in (select Req_PayBankId from cms.dbo.NCMS_PO_Request_ForPayout) and	 po_statusid=0  
   group by party_code having count(1)>1 
   
 --select * into #chk from ncms_po_request where req_refno in (select req_refno from #NCMS_APPAMT where POSTATUS=2) 
 select * into #chk from cms.dbo.ncms_po_request where req_refno in (select req_refno from #NCMS_APPAMT where POSTATUS=2)
 and party_code not in (
 select party_code from #Data) and PO_Statusid=0 
   
 select * into #ee1  from #NCMS_APPAMT where Req_RefNo in (select Req_RefNo from #chk) and POSTATUS=2 
  

 select * into #formultipleReq from cms.dbo.ncms_po_request where   party_code  in (
 select party_code from #Data)  and po_statusid=0

 select party_code,sum(PO_Request) PO_Request into #chk23 from #formultipleReq where party_code in (select party_code from #Data)  
  and Req_PayBankId in (select Req_PayBankId from cms.dbo.NCMS_PO_Request_ForPayout)
   group by party_code 

     /*select * into  #update from #NCMS_APPAMT where  party_code in (select party_code from #Data)  */ /*commented on 09 May 2022*/
     select a.* into #update from #NCMS_APPAMT a join #chk23 b on a.party_code=b.party_code and a.PO_Request=b.PO_Request

/* commented on 14 Dec 2022
 update a set  POveriID= b.POveriID ,PO_Statusid=2 ,PO_ApprovedAmt=case when c.po_request=b.ApprovedAmt then a.PO_Request 
 when c.po_request<b.ApprovedAmt then a.PO_Request end
 from ncms_po_request  a join #update b on a.party_code=b.party_code    join  #chk23 c on a.Party_code=c.Party_code
 and b.PO_Request=c.PO_Request and  a.PO_Statusid=0 and  a.Req_PayBankId in (select Req_PayBankId from NCMS_PO_Request_ForPayout)
 */
 /****Added on 14 Dec 2022*********************/
 select b.party_code,b.ApprovedAmt,b.POveriID,c.po_request,b.Req_RefNo into #fff from #update b  join  #chk23 c 
 on b.party_code=c.party_code and b.PO_Request=c.PO_Request

 CREATE NONCLUSTERED INDEX IDX_NCMS_check1 ON #fff(party_code,PO_Request) 
 
 select  ROW_NUMBER() OVER ( ORDER BY srno ) as srno1 ,* into #NCMS_APPAMT1 from #NCMS_APPAMT where POSTATUS=4    
 
 CREATE NONCLUSTERED INDEX IDX_NCMS_App ON #NCMS_APPAMT1(SRNO1 ASC, POveriID ASC, PARTY_CODE ASC, Req_RefNo ASC, ApprovedAmt ASC, POSTATUS ASC)
                                          
  
 --insert into   NCMS_SEgVeriData_Log_log (SrNo,POrequestID,VerifierID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,
 -- UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                
 -- AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO,RequestID,Req_RefNo,PO_ApprovedAmt,insertdate,Batchid)           
 -- select                                                   
 -- ROW_NUMBER() OVER ( ORDER BY a.party_code,a.entity,c.seqid ) AS [SrNo],                                      
 -- a.POrequestID,a.ID as VerifierID,a.ProcessDate,a.Entity,a.Segment,a.Party_code,a.Flag,a.Balance,a.UnsettledCrBill,a.UnrecoAmt,a.ShortSellValue,                                      
 -- a.MarginAmt,a.Deposit,a.CashColl,a.NonCashColl,a.MarginAdjWithColl,a.MarginShortage,a.AccruedCharges,a.OtherDebit,a.NonCashConsideration,                           
 -- a.ExpoUtilised,a.NetPayable,a.UnPosted_PO,b.PORequestId as RequestID,                                                   
 -- b.Req_RefNo as Req_RefNo,PO_ApprovedAmt,GETDATE() as insertdate,@Batchid                                      
 -- from                                                  
 -- (                                                  
 --  select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,                                      
 --  MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,                                      
 --  ExpoUtilised,NetPayable,UnPosted_PO                                      
 --  from NCMS_SEgVeriData with (nolock)                                              
 -- ) a join                                                   
 -- (                                                  
 --  select party_Code,entity,POrequestid,Req_RefNo,ApprovedAmt as PO_ApprovedAmt from #NCMS_APPAMT WITH (NOLOCK)                                                   
 -- )b                                                   
 -- on a.entity=b.entity  and a.Party_code=b.party_Code                                             
 -- join                                         
 -- ncms_entity c                                
 -- on a.segment=c.segment and a.entity=c.entity    
                                   
  /* Bifurcating Segmentwise Approved Amount */                                                  
                                        
  create table #NCMS_SegPOAppAmt                                               
  (                                            
  SRNO int,                                                  
  VerifierID int,                                                  
  RequestID int,                                               
  Req_RefNo VARCHAR(25),                                                  
  PARTY_CODE VARCHAR(10),                                                  
  ENTITY VARCHAR(10),                                                  
  SEGMENT VARCHAR(10),                                                  
  PO_ApprovedAmt money,                                                  
  NetPAyable money,                                                  
  SegApprovedAmt money,                                  
  Temp_NetPAyable money,
  RequestType char(1)                                                   
  )                                                  
--print 'hi'                                      
  insert into #NCMS_SegPOAppAmt (SRNO,VerifierID,RequestID,Req_RefNo,PARTY_CODE,ENTITY,SEGMENT,PO_ApprovedAmt,NetPAyable,SegApprovedAmt,Temp_NetPAyable,RequestType)                                           
  select                                                   
  ROW_NUMBER() OVER (ORDER BY a.party_code,b.Req_RefNo,a.entity,c.seqid ) AS [SrNo],ID as VerifierID,b.PORequestId as RequestID,                                                   
  b.Req_RefNo as Req_RefNo,a.Party_code,a.Entity,a.Segment,PO_ApprovedAmt,NetPAyable,0 as SegApprovedAmt,NetPAyable,RequestType                                                  
  from                                                  
  (                                                  
  select party_Code,ID,entity,segment,POrequestid,NetPayable from cms.dbo.NCMS_SEgVeriData with (nolock)                                              
 /* where NetPayable > 0      */
  ) a join                                                   
  (                                                  
  select party_Code,entity,POrequestid,Req_RefNo,ApprovedAmt as PO_ApprovedAmt,RequestType from #NCMS_APPAMT WITH (NOLOCK)                                                   
  where ApprovedAmt > 0  and   Req_RefNo is not null   and RequestType<>'B'                                            
  )b                                                   
  on a.entity=b.entity  and a.Party_code=b.party_Code                                             
  join                                               
  cms.dbo.ncms_entity c                                                  
  on a.segment=c.segment and a.entity=c.entity                                                  
 --print 'hello'
 /**************New Logic Start**************************************************************/
/* select party_code,entity,max(NetPayable) as NetPayable into #maxaa from #NCMS_SegPOAppAmt  group by party_code,entity*/
  --commented on 01July2022
  --select *  into #ee from  #NCMS_SegPOAppAmt where segment='bsemfss'
  --Select *  into #we from angelfo.BSEMFSS.DBO.MFSS_Client with(nolock) where Dp_Type ='PHY' and party_code in (select party_code from #ee) /*and inactive_from>=getdate() */
  
  update #NCMS_SegPOAppAmt set  SegApprovedAmt=convert(decimal(19,2),PO_ApprovedAmt) where SEGMENT='nsecm' 
  --and party_code not in (select party_code from #we)
  
    update #NCMS_SegPOAppAmt set  SegApprovedAmt=convert(decimal(19,2),PO_ApprovedAmt) where SEGMENT='Nbfc'
    
--(comented on 01July2022) update #NCMS_SegPOAppAmt set  SegApprovedAmt=convert(decimal(19,2),PO_ApprovedAmt) where SEGMENT='bsemfss' and party_code  in (select party_code from #we)



  /*update #NCMS_SegPOAppAmt set  SegApprovedAmt=convert(decimal(19,2),PO_ApprovedAmt)  from #maxaa where #NCMS_SegPOAppAmt.party_code=#maxaa.party_code
  and #NCMS_SegPOAppAmt.NetPayable=#maxaa.NetPayable
  */
	select * into #bo from #NCMS_SegPOAppAmt where party_code in (select party_code from #NCMS_SegPOAppAmt where NetPayable<SegApprovedAmt )
	order by party_Code
  
	/*select *,case when SegApprovedAmt>0.00 then SegApprovedAmt-NetPayable else 0.00 end as Amount into #Amount from #bo*//*commented on 21Jan 2021*/
	
		select *,case when SegApprovedAmt>0.00 and NetPayable>0 then SegApprovedAmt-NetPayable  
				when NetPayable<0  then NetPayable+SegApprovedAmt else 0.00 end as Amount into #Amount from #bo
	
	select ID =  ROW_NUMBER() OVER(partition BY PARTY_CODE order by SegApprovedAmt desc),/*ROW_NUMBER() OVER(partition BY PARTY_CODE order by NetPayable desc),        *//*Commented on 21 Jan2021*/
	DENSEID = DENSE_RANK() OVER(ORDER BY PARTY_CODE),
	RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt,Amount
	into #NET_AMTADJ 
	from #Amount 
	
	;WITH Hold_CTE AS (  
		SELECT   
		ID,DENSEID,RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,
		PO_ApprovedAmt,NetPayable,
		--SegApprovedAmt=cast(case when (SegApprovedAmt-NetPayable)>0 then NetPayable else SegApprovedAmt end  as money) ,
		SegApprovedAmt,
		/*Amount=cast((case when SegApprovedAmt >= NetPayable then SegApprovedAmt-NetPayable else 0  end ) as money),JV='N'		*//*commented on 21 jan 2021*/
		Amount=cast((case when SegApprovedAmt >= NetPayable and NetPayable>0 then SegApprovedAmt-NetPayable
					when NetPayable<0 then SegApprovedAmt
					when SegApprovedAmt<NetPayable and NetPayable>0 then 0 else 0  end ) as money),JV='N' 
		FROM #NET_AMTADJ e where
		id=1 
		UNION ALL  
		SELECT   
		e.ID,e.DENSEID,e.RequestID,e.VerifierID,e.Req_RefNo,e.Party_Code,e.Entity,e.Segment,
		e.PO_ApprovedAmt,e.NetPayable,

		/*SegApprovedAmt =cast((case when (b.Amount-e.NetPayable >0) then e.NetPayable else b.Amount end ) AS money ),
		Amount=cast(case when b.Amount>=e.NetPayable then b.Amount -e.NetPayable else 0  end as money)*/ /*Commented on 21 Jan 2021*/
		SegApprovedAmt =cast((case when (b.Amount-e.NetPayable >0) and b.Amount>0 and e.NetPayable>=0  then e.NetPayable
									when (b.Amount-e.NetPayable >0) and b.Amount>0 and e.NetPayable<0  then 0 else b.Amount end ) AS money ),
		Amount=cast(case when b.Amount>=e.NetPayable and b.Amount>0 and e.NetPAyable>=0  then  b.Amount -e.NetPayable
						 when b.Amount>=e.NetPayable and b.Amount>0 and e.NetPAyable<0 then  b.Amount else 0  end as money)
		,JV='Y'
		
		FROM #NET_AMTADJ e  inner join  Hold_CTE b ON b.party_code =e.party_code and e.id=b.id+1   
		)  
		SELECT * into  #multiple1 FROM Hold_CTE option(maxrecursion 32767) ;
		
		--DROP TABLE #multiple1 
		
		--SELECT * FROM #multiple1 ORDER BY PARTY_CODE
		
		/*
		 select x.party_code,y.segment as FromSegment,x.segment as ToSegment,y.SegApprovedAmt as Amount from 		
		(select * from #multiple1 where JV='N')x
		 join
		(select * from #multiple1 where JV='Y' and SegApprovedAmt>0)y
		on x.party_code=y.party_code and x.Req_RefNo=y.Req_RefNo
		order by x.party_code
		 */
 


	--insert into  anand.MKTAPI.dbo.tbl_FundTransfer_JV( party_code , FromSegment,ToSegment, Amount , EntryDate , Flag , Remarks)
	--select party_code,FromSegment,ToSegment, Amount ,getdate()  ,Flag,Remarks from #single
	--union
	--select party_code,FromSegment,ToSegment, Amount ,EntryDate ,Flag,'' from #MultipleRecords
 
  /************End****************************************************************/

 /* Commented on 10 March 2018*/
 /*                      
  declare @PO_BalAmt as money = 0,@SegPOValue as money = 0,@netPay as money = 0,@mrefno as varchar(25) ='',@m_refno as varchar(25) =''                                  
  declare @m_Seg as varchar(10) = ''                                  
                                                    
  set @ctr = 1                                                  
  set @totCtr =0                                                  
  set @entity= ''                                             
  set @PARTY_CODE=''                                                 
  set @mrefno=''                                  
  set @m_refno=''                                  
                                                  
  select @totCtr=count(1) from #NCMS_SegPOAppAmt                                        
  While @ctr <= @totctr                                                  
  Begin                                                  
                                  
    set @m_Seg = ''                                             
    Select @M_entity=entity,@M_pcode=party_code,@m_refno=Req_RefNo from #NCMS_SegPOAppAmt where srno=@ctr                                            
    /*                                          
    print @M_entity                                                
    print @ENTITY                                            
    print @M_pcode                                                
    print @PARTY_CODE                                     
    */                                          
                                             
    if (@M_entity<> @ENTITY or @M_pcode<>@PARTY_CODE or @m_refno<>@mrefno)                                            
    Begin                                            
      set @PARTY_CODE=@M_pcode                                            
      set @ENTITY=@M_entity                                    
      set @mrefno=@m_refno                                  
      Select @PO_BalAmt=PO_ApprovedAmt from #NCMS_SegPOAppAmt where srno=@ctr                                                  
      /*                                          
      print @ctr                                            
      print @PARTY_CODE                                         
      print @ENTITY                                            
      print @PO_BalAmt                                                
      */                                          
    End                                            
                                      
    Select @m_Seg=segment,@SegPOValue=(Case when @PO_BalAmt >= Temp_NEtpayable then Temp_NEtpayable
      when  RequestType='B' then @PO_BalAmt else @PO_BalAmt end) from #NCMS_SegPOAppAmt                                   
    where srno=@ctr  and Temp_NEtpayable >= 0                                                 
                                    
    if @SegPOValue<=@CFminAMT                                  
    Begin                                
  set @SegPOValue=0                                
 End                                
    Else                                
    Begin                                  
  update #NCMS_SegPOAppAmt set SegApprovedAmt =convert(decimal(19,2),@SegPOValue) where srno=@ctr                                                  
  update #NCMS_SegPOAppAmt set Temp_NEtpayable=Temp_NEtpayable-convert(decimal(19,2),@SegPOValue) where PARTY_CODE=@M_pcode and SEGMENT=@m_Seg                             
    End                                
                                           
    /* print @SegPOValue  */                                          
    set @PO_BalAmt=@PO_BalAmt-@SegPOValue                                               
    /* print @PO_BalAmt  */                                          
    set @ctr=@ctr+1                                                  
  End                                             
 */                       
/* CHECK 2 START */                        
   
 declare @payexceed as int = 0                        
 select @payexceed=COUNT(1) from cms.dbo.NCMS_payexceed where batchid=@Batchid                  
                        
  if (@payexceed > 0)                         
  Begin                        
                         
          
 /* Remove Client with Excess Payout -- START*/          
           
 SELECT A.* INTO #NCMS_MultiPOcli           
 FROM #NCMS_SegPOAppAmt A JOIN (SELECT * FROM cms.dbo.NCMS_payexceed WHERE BATCHID=@Batchid ) B          
 ON A.PARTY_CODE=B.PARTy_CODE          
          
 DELETE A           
 FROM #NCMS_SegPOAppAmt  A JOIN (SELECT * FROM cms.dbo.NCMS_payexceed WHERE BATCHID=@Batchid ) B          
 ON A.PARTY_CODE=B.PARTy_CODE          
  
 drop table #NCMS_MultiPOcli           
 /* Remove Client with Excess Payout -- END */          
           
  End                        
                        
/* CHECK 2 END */                        
  
declare @processdate datetime
set @processdate=getdate()
--print @processdate
 

  /******************************************************************************/
if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:01') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))  
Begin
 	select * into #er from cms.dbo.ncms_omnysis_uploader WITH(NOLOCK) 

declare @processdate2 datetime  
set @processdate2=getdate()  
 insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),2,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=2)  
   group by PARTY_CODE,RequestID 
 
insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),3,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=3)  
   group by PARTY_CODE,RequestID 
   

insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),1,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=1)  
   group by PARTY_CODE,RequestID    


insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),6,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=6)  
   group by PARTY_CODE,RequestID   


insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),4,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=4)  
   group by PARTY_CODE,RequestID   

insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),8,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=8)  
   group by PARTY_CODE,RequestID  
   
insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),9,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=9)  
   group by PARTY_CODE,RequestID  
   
 insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),7,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=7)  
   group by PARTY_CODE,RequestID 

   
 insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),104,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=104)  
   group by PARTY_CODE,RequestID 

    insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),106,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=106)  
   group by PARTY_CODE,RequestID 

       insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),102,'','',GETDATE(),''  
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=102)  
   group by PARTY_CODE,RequestID 

   insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)  
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),108,'','',GETDATE(),''  
   from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=108)  
   group by PARTY_CODE,RequestID 

   insert into NCMS_SegPOAppAmt_hist
   select *,GETDATE() from NCMS_SegPOAppAmt

   truncate table NCMS_SegPOAppAmt

   insert into NCMS_SegPOAppAmt
   select *   from #NCMS_SegPOAppAmt

      exec NCMS_All_Omnysis_EXE
 
End 
update ncms_batch_process set EndDate=getdate(),Flag=1 where srno=18
                                      
End try                                                                 
                                                                
BEGIN CATCH                                                                    
                                                                
  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          
  select GETDATE(),'NCMS_UPD_ReqVerId_Batchwise',ERROR_LINE(),ERROR_MESSAGE()                                                                          
                                        
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                        
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                        
  RAISERROR (@ErrorMessage , 16, 1);                                              
                                     
End catch                                                                
                                                    
SET nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_UPD_ReqVerId_Batchwise_03Aug2023
-- --------------------------------------------------
create procedure [dbo].[NCMS_UPD_ReqVerId_Batchwise_03Aug2023]                                              
as                                                    
SET nocount on                                               
SET XACT_ABORT ON                                                                    
BEGIN TRY                                                                  
        
 update ncms_batch_process set StartDate=getdate() where srno=18    
  /* Updating Request ID */                                                    
  /* Start For capturing Records not updated in BO and client done marking again */  
  insert into NCMS_PendingBOReq_Log_hist(porequestid,party_code,net_payable,entity,debitamt,UpdatedOn,enteredOn)  
  select porequestid,party_code,net_payable,entity,debitamt,UpdatedOn,getdate() from NCMS_PendingBOReq_Log  
    
  truncate table NCMS_PendingBOReq_Log  
    
  insert into NCMS_PendingBOReq_Log(porequestid,party_code,net_payable,entity,debitamt,UpdatedOn)  
   select requestid,party_code,netpayable,a.entity,debitamt,getdate() from     
  (select requestid,party_code,netpayable,entity from ncms_segpayoutappamt with (nolock)     
   where processdatetime = (select MAX(processdatetime) from ncms_segpayoutappamt  with (nolock) ) and Boff_gen=1)a  
  inner join  
  (select cltcode,entity=case   
  when exchange in ('MCX','NCX') and segment='FUTURES' then 'AllSegment'   
  when exchange='NBF' and segment='NBFC' then 'NBFC'  
  else 'AllSegment' end  
  ,debitamt=sum(debitamt) from   
  AngelBSECM.Account_ab.dbo.PAYOUT_PENDING_ENTRIES with (nolock) group by cltcode,case   
  when exchange in ('MCX','NCX') and segment='FUTURES' then 'AllSegment'   
  when exchange='NBF' and segment='NBFC' then 'NBFC'  
  else 'AllSegment' end)b  
  on a.party_code=b.cltcode  
    
  /* End For capturing Records not updated in BO and client done marking again */                                        
  create table #NCMS_APPAMT                                               
  (                                                                  
  SRNO int,                                                    
  PARTY_CODE VARCHAR(10),                                                    
  ENTITY VARCHAR(10),                                                    
  Req_RefNo VARCHAR(25),                                                    
  poREQUESTID INT,                                                    
  ApprovedAmt MONEY,                                                    
  POSTATUS INT,                                                    
  POveriID INT,                                                
  NetPayable money,                                              
  EQ_NetPayable money,                                              
  /*CO_NetPayable money,                                            */  
  NB_NetPayable money,                                              
  PO_Request money,                                              
  PO_allowed MONEY,                                              
  Batchid varchar(15),                                            
  RequestType char(1)                                                    
  )                                                    
        
 /* Blocked Clients payout for all the client in block/unlock client master of CMS */        
         
 UPDATE NCMS_PO_REQUEST  SET PO_statusid=8,remarks='Blocked Client for Payout'         
 from cms.dbo.pARTY_cms_BLOCKED b  with (nolock)                                                
 where NCMS_PO_REQUEST.party_code=b.party_code and PO_Statusid in (0,7)           
                                          
  select party_Code,entity,POrequestid,Req_RefNo,PO_request,isnull(RequestType,'U') as RequestType                              
  into #POdata                                               
  from NCMS_PO_Request_ForPayout  WITH (NOLOCK) /* where PO_Statusid=0 */      
                            
  /* START - UPDATE BILL TO BILL APPROVED REQUEST */        
  --SET IDENTITY_INSERT #POdata ON                            
  INSERT INTO #POdata (party_Code,entity,POrequestid,Req_RefNo,PO_request,RequestType)                                               
  SELECT Party_code,Entity,ID,Req_RefNo,po_request AS PO_REQUEST,'B' AS REQUESTTYPE                             
  FROM NCMS_B2B_PO_Request  with (nolock) WHERE ISNULL(USERaPPsTATUS,0)=1  and billamt>0                           
  --SET IDENTITY_INSERT #POdata OFF                            
    
  /*******************Added on 29 mar 2017 ****************/  
  SELECT Party_code,Entity,segment,ID,Req_RefNo,netpayable,po_request AS PO_REQUEST,'B' AS REQUESTTYPE   into #ab                          
  FROM NCMS_B2B_PO_Request with (nolock) WHERE ISNULL(USERaPPsTATUS,0)=1 and billamt>0  
  /********************************************************/  
                            
  UPDATE NCMS_B2B_PO_Request SET UserAppStatus=2 FROM #PODATA B WHERE NCMS_B2B_PO_Request.REQ_REFNO=B.REQ_REFNO                            
  /* END - UPDATE BILL TO BILL APPROVED REQUEST */                            
                              
  /*update NCMS_PO_Request set PO_Statusid=1                                               
  from #POdata b where NCMS_PO_Request.porequestid=b.porequestid                                               
  */                        
  /*Declare @CFminAMT money = 5*/ /* Min Partial Rejected Amt Carry forward */  
  Declare @CFminAMT money = 1 /*Added on 29 Jul 2017 as per sajeeven Sir Mail*/                                                 
  Declare @Batchid varchar(15) = ''                            
                                            
  select @Batchid=RIGHT(convert(varchar(8),getdate(),112),6)+replace(convert(varchar(8),getdate(),108),':','')                                   
                                                    
  INSERT INTO #NCMS_APPAMT                                            
  (SRNO,POveriID,PARTY_CODE,ENTITY,Req_RefNo,poREQUESTID,ApprovedAmt,POSTATUS,NetPayable,PO_Request,EQ_NetPayable,NB_NetPayable,PO_allowed,Batchid,RequestType)                                                    
  select                                                     
  ROW_NUMBER() OVER ( ORDER BY B.poREQUESTID ) AS [SrNo],a.ID,a.party_Code,a.entity,b.Req_RefNo,                                                    
  B.poREQUESTID,                                                    
  ApprovedAmt=(Case                                                     
  when REquestType<>'M' and REquestType<>'B' and PO_Request <= a.NetPayable and a.NetPayable > 0 then PO_Request                                                     
  when REquestType<>'M' and REquestType<>'B' and PO_Request > a.NetPayable and a.NetPayable > 0 then a.NetPayable                                                    
  when REquestType='M' then PO_Request                                                     
  when REquestType='B' then PO_Request                             
  else 0 end),                                                    
  POSTATUS=(Case                                                     
  when REquestType<>'M' and REquestType<>'B' and PO_Request <= a.NetPayable and a.NetPayable > 0 then 2                                                    
  when REquestType<>'M' and REquestType<>'B' and PO_Request > a.NetPayable and a.NetPayable > 0 then 4                                                    
  when REquestType='M'  then 2                                            
  when REquestType='B' then 2                            
  else 3 end),a.NetPayable,PO_Request,0,0,0,@Batchid,b.RequestType                                                     
  from                                               
  (select party_Code,ID,entity,NetPayable from /*NCMS_EntityVeriData_batchwise*/ NCMS_CombineVeriData with (nolock)) a join #POdata b                                        
  on a.entity=b.entity and a.party_code=b.Party_code      
                          
  /* CHECK 1 Start */                          
                          
  declare @CurrTimeGap as int=0,@SegTimeGap as int=0,@NetPayDiff as int = 0,@MultiCli as int = 0,@ValidTimeGap as int =5                            
                          
  /* @CurrTimeGap means Time gap between fetching segmentwise data and payout processing */                          
  /* @@SegTimeGap means Time gap between different segment data */                          
  select @CurrTimeGap=datediff(mi,max(processdate),GETDATE()),                          
  @SegTimeGap=datediff(mi,min(processdate),max(processdate)) from NCMS_SegVeriData with (nolock)                           
  where segment <> 'NBFC'                           
                          
  /* select segment,processdate from NCMS_SegVeriData with (nolock)  where segment <> 'NBFC' group by segment,processdate */                          
                          
  /* @NetPayDiff means reconconfirming mismatches in entitywise net payable */                          
  select @NetPayDiff=COUNT(1) /* select * */                          
  from #NCMS_APPAMT a left outer join                           
  (select Entity,party_code,sum(NetPayable) as NetPayable from NCMS_SegVeriData with (nolock) group by Entity,party_code) b                          
  on a.PARTY_CODE=b.Party_code and a.ENTITY=b.Entity                          
  where a.NetPayable<> b.NetPayable                          
                          
  /* @MultiCli - Client with multiple payout from same entity */                          
  select @MultiCli=SUM(cnt) from                          
  (                          
  select count(distinct party_code) as cnt from #NCMS_APPAMT where postatus=2 group by party_code,entity having COUNT(1) > 1                          
  ) z                          
                  
  /*                        
  if (@CurrTimeGap>@ValidTimeGap or @SegTimeGap>@ValidTimeGap or  @NetPayDiff>0 or @MultiCli> 0)                           
  Begin                          
                  
   insert into sms.dbo.sms                                  
   select mobile as No,                            
   'NCMS Risk Indicator: Batchid-'+@Batchid+' Currtime:'+convert(varchar(3),@CurrTimeGap)+'min SegTime:'+convert(varchar(3),@SegTimeGap)+'min NetPayDiff:'+                          
   convert(varchar(3),@NetPayDiff)+' MultiCli:'+convert(varchar(3),@MultiCli)                          
   , convert(varchar(10),getdate(), 103)                                        
   ,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':'+ ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                                                           
   'P', case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end,                                              
   'Payout Marking' from NCMS_mobile                           
                             
   < Verification Stop Command >                          
                             
-- Reverse Bill2Bill Flag                             
     UPDATE NCMS_B2B_PO_Request SET UserAppStatus=1 FROM #PODATA B WHERE NCMS_B2B_PO_Request.REQ_REFNO=B.REQ_REFNO                            
     and ISNULL(NCMS_B2B_PO_Request.USERaPPsTATUS,0)=2                            
     -- Rever Payout Flag                          
     update NCMS_PO_Request set PO_Statusid=0                          
     from #POdata b where NCMS_PO_Request.porequestid=b.porequestid                                               
                     
                             
  End                          
  */                
  /* CHECK 1 End */                          
                          
                                          
  UPDATE #NCMS_APPAMT SET EQ_NetPayable=B.NETPAYABLE FROM                                              
  /*NCMS_EntityVeriData_EQNP*/ NCMS_EntityVeriData_EQNP_ForCombine B with(nolock) WHERE  #NCMS_APPAMT.PARTY_CODE=B.PARTY_CODE                                             
                                      
  UPDATE #NCMS_APPAMT SET NB_NetPayable=B.NETPAYABLE FROM                                              
  /*NCMS_EntityVeriData_NBNP*/ NCMS_EntityVeriData_NBNP_ForCombine B  with(nolock) WHERE  #NCMS_APPAMT.PARTY_CODE=B.PARTY_CODE                        
  /*change on 11 jul 2016 */  
  UPDATE #NCMS_APPAMT SET NETPAYABLE=NETPAYABLE-B.debitamt FROM                                                
  NCMS_PendingBOReq_Log B  with(nolock) WHERE  #NCMS_APPAMT.PARTY_CODE=B.PARTY_CODE     
     
                                          
  /*-- Calculation Payout Allowed --*/                                              
  UPDATE #NCMS_APPAMT SET PO_allowed=                                              
  (CASE                                               
  WHEN ENTITY='AllSegment' AND EQ_NETPAYABLE > NETPAYABLE AND NETPAYABLE > 0 THEN NETPAYABLE                                               
  WHEN ENTITY='AllSegment' AND EQ_NETPAYABLE <= NETPAYABLE AND EQ_NETPAYABLE > 0 THEN EQ_NETPAYABLE                                               
 /* WHEN ENTITY='AllSegment' AND CO_NETPAYABLE > NETPAYABLE AND NETPAYABLE > 0 THEN NETPAYABLE                         
  WHEN ENTITY='AllSegment' AND CO_NETPAYABLE <= NETPAYABLE AND CO_NETPAYABLE > 0 THEN CO_NETPAYABLE                                             */  
  WHEN ENTITY='NBFC' AND NB_NETPAYABLE > NETPAYABLE AND NETPAYABLE > 0 THEN NETPAYABLE                                         
  WHEN ENTITY='NBFC' AND NB_NETPAYABLE <= NETPAYABLE AND NB_NETPAYABLE > 0 THEN NB_NETPAYABLE                                               
  ELSE 0 END)   
  where #NCMS_APPAMT.RequestType NOT IN ('M','B') /*added on 06 march 2017*/  
                                          
 /* UPDATE #NCMS_APPAMT SET PO_allowed=0 where PO_allowed<=@CFminAMT */  
   
 -- UPDATE #NCMS_APPAMT SET PO_allowed=0 where PO_allowed<@CFminAMT  
    
  /*added on 26 jun 2020 for rejecting request less than 1 rs*/    
  UPDATE #NCMS_APPAMT SET PO_allowed=0 where PO_REQUEST<@CFminAMT                                                                                       
  /*******************/  
                                          
  UPDATE #NCMS_APPAMT SET                                               
  ApprovedAmt=(CASE WHEN PO_REQUEST >= PO_ALLOWED THEN PO_ALLOWED ELSE PO_REQUEST END),                                              
  POSTATUS=(CASE                                               
  WHEN PO_REQUEST > PO_ALLOWED AND PO_ALLOWED > 0 THEN 4                                               
  WHEN PO_REQUEST > PO_ALLOWED AND PO_ALLOWED = 0 THEN 3                                              
  WHEN PO_REQUEST <= PO_ALLOWED THEN 2                                              
  ELSE 0 END)                                              
  where #NCMS_APPAMT.RequestType NOT IN ('M','B')                                               
                                         
  /* Calculation Payout for Multiple Transaction of Single Client */                                              
  SELECT PARTY_CODE,ENTITY into #NCMS_MultiCLi                     
  FROM #NCMS_APPAMT GROUP BY PARTY_CODE,ENTITY having COUNT(1) > 1                                              
                                              
  IF (select COUNT(1) from #NCMS_MultiCLi) > 0                                              
  BEGIN                                              
  select                                               
  ROW_NUMBER() OVER ( ORDER BY a.party_code,a.entity,a.srno) AS [SrNoID],                                              
  a.*                                               
  into #NCMS_APPAMT_TEMP                                               
  from #NCMS_APPAMT a join #NCMS_MultiCLi b                                             
  on a.PARTY_CODE=b.party_code and a.ENTITY=b.entity                                             
  where a.RequestType NOT IN ('M','B')                                            
                                               
                                               
  Declare @MC_ctr as int = 1,@MC_Totctr as int = 0,@pcode as varchar(10)='',@entityx as varchar(10)=''                                            
  Declare @M_pcode as varchar(10)='',@M_entity as varchar(10)='',@po_allowed as money = 0                                              
  Declare @SRno as int =0                                              
                                                
  select @MC_Totctr=COUNT(1) from #NCMS_APPAMT_TEMP                                              
                                          
  While @MC_ctr <= @MC_Totctr                                              
  Begin                                              
                                              
  select @M_pcode=party_code,@M_entity=entity,@SRno=srno from #NCMS_APPAMT_TEMP where srnoid=@MC_ctr                                              
  if @M_pcode<> @pcode and @M_entity<>@entityx                                       
  Begin                                              
  set @pcode=@M_pcode                                              
  set @entityx=@M_entity                                              
  select @po_allowed=PO_allowed-approvedAmt from  #NCMS_APPAMT_TEMP where srnoid=@MC_ctr                                              
  End                                              
  Else                        
  Begin                                              
  UPDATE #NCMS_APPAMT SET                                               
  ApprovedAmt=convert(decimal(20,2),(CASE WHEN PO_REQUEST >= @po_allowed THEN @po_allowed ELSE PO_REQUEST END)),                                              
  postatus=(CASE                                               
  WHEN PO_REQUEST > @po_allowed AND @po_allowed > 0 THEN 4                             
  WHEN PO_REQUEST > @po_allowed AND @po_allowed = 0 THEN 3                                              
  WHEN PO_REQUEST <= @po_allowed THEN 2                                              
  ELSE 0 END)                                              
  where srno=@SRno                                              
                                          
  select @po_allowed=@po_allowed-approvedAmt from  #NCMS_APPAMT_TEMP where srnoid=@MC_ctr                                              
  End                                              
  set @MC_ctr=@MC_ctr+1                                              
  End                                              
                                              
  END                                              
                                               
  update  #NCMS_APPAMT  set ApprovedAmt=0,POSTATUS=3 where  ApprovedAmt<@CFminAMT and ApprovedAmt>0 /**added on 09 Aug 2021*/  
         
  insert into NCMS_EntityPayoutAppAmt(SRNO,PARTY_CODE,ENTITY,Req_RefNo,poREQUESTID,ApprovedAmt,POSTATUS,POveriID,NetPayable,EQ_NetPayable,NB_NetPayable,PO_Request,PO_allowed,Batchid,processdate)                                               
  select SRNO,PARTY_CODE,ENTITY,Req_RefNo,poREQUESTID,ApprovedAmt,POSTATUS,POveriID,NetPayable,                                              
  EQ_NetPayable,NB_NetPayable,PO_Request,PO_allowed,Batchid,GETDATE() from #NCMS_APPAMT        
    
   /* update      #NCMS_APPAMT set POSTATUS=0 where POSTATUS=3  */  
   
  select * into #reject from ncms_po_request where req_refno in (select req_refno from #NCMS_APPAMT where POSTATUS=3)     
   select * into #reject1  from #NCMS_APPAMT where Req_RefNo in (select Req_RefNo from #reject) and POSTATUS=3    
     
   /*select party_code into #Data from ncms_po_request where party_code in (select party_code from #NCMS_APPAMT where POSTATUS=2) and po_statusid=0  
   group by party_code having count(1)>1 /*Added on 18 Feb 2022**/ */ --comented on 10 Jun 2022 by neha  
    /******Start*************/  
 select party_code into #SingleData from ncms_po_request where party_code in (select party_code from #NCMS_APPAMT where POSTATUS=2) and  
  Req_PayBankId in (select Req_PayBankId from NCMS_PO_Request_ForPayout) and  po_statusid=0    
   group by party_code having count(1)=1   
  
    select * into #Nws  from #NCMS_APPAMT where party_code in (select party_code from #SingleData) and POSTATUS=2   
  
   update ncms_po_request set  POveriID= b.POveriID  ,PO_ApprovedAmt=b.ApprovedAmt,ReleaseId=b.req_refno from #Nws b where ncms_po_request.party_code=b.party_code    
 and ncms_po_request.req_refno=b.req_refno    
     
 update  ncms_po_request set PO_Statusid= case when convert(decimal(18,2),PO_Request)= convert(decimal(18,2),PO_ApprovedAmt) then 2 else 4 end    
 ,remarks= case when remarks='(EXPIRED)NXT FundsPayout' then 'NXT FundsPayout' when  remarks='(EXPIRED)T' then 'T' when remarks='(EXPIRED)' then ''     
    else remarks end  
 where Req_RefNo in (select Req_RefNo from #Nws)     
  
 /*******end**************************/  
  
    select party_code into #Data from ncms_po_request where party_code in (select party_code from #NCMS_APPAMT where POSTATUS=2) and  
  Req_PayBankId in (select Req_PayBankId from NCMS_PO_Request_ForPayout) and  po_statusid=0    
   group by party_code having count(1)>1   
     
 --select * into #chk from ncms_po_request where req_refno in (select req_refno from #NCMS_APPAMT where POSTATUS=2)   
 select * into #chk from ncms_po_request where req_refno in (select req_refno from #NCMS_APPAMT where POSTATUS=2) and party_code not in (  
 select party_code from #Data)  
     
 select * into #ee1  from #NCMS_APPAMT where Req_RefNo in (select Req_RefNo from #chk) and POSTATUS=2   
    
 update ncms_po_request set  POveriID= b.POveriID  ,PO_ApprovedAmt=b.ApprovedAmt,ReleaseId=b.req_refno from #ee1 b where ncms_po_request.party_code=b.party_code    
 and ncms_po_request.req_refno=b.req_refno    
     
 update  ncms_po_request set PO_Statusid= case when convert(decimal(18,2),PO_Request)= convert(decimal(18,2),PO_ApprovedAmt) then 2 else 4 end    
 ,remarks= case when remarks='(EXPIRED)NXT FundsPayout' then 'NXT FundsPayout' when  remarks='(EXPIRED)T' then 'T' when remarks='(EXPIRED)' then ''     
    else remarks end  
 where Req_RefNo in (select Req_RefNo from #ee1)     
   
   
 select * into #formultipleReq from ncms_po_request where   party_code  in (  
 select party_code from #Data)  and po_statusid=0  
  
 select party_code,sum(PO_Request) PO_Request into #chk23 from #formultipleReq where party_code in (select party_code from #Data)    
  and Req_PayBankId in (select Req_PayBankId from NCMS_PO_Request_ForPayout)  
   group by party_code   
  
     /*select * into  #update from #NCMS_APPAMT where  party_code in (select party_code from #Data)  */ /*commented on 09 May 2022*/  
     select a.* into #update from #NCMS_APPAMT a join #chk23 b on a.party_code=b.party_code and a.PO_Request=b.PO_Request  
  
/* commented on 14 Dec 2022  
 update a set  POveriID= b.POveriID ,PO_Statusid=2 ,PO_ApprovedAmt=case when c.po_request=b.ApprovedAmt then a.PO_Request   
 when c.po_request<b.ApprovedAmt then a.PO_Request end  
 from ncms_po_request  a join #update b on a.party_code=b.party_code    join  #chk23 c on a.Party_code=c.Party_code  
 and b.PO_Request=c.PO_Request and  a.PO_Statusid=0 and  a.Req_PayBankId in (select Req_PayBankId from NCMS_PO_Request_ForPayout)  
 */  
 /****Added on 14 Dec 2022*********************/  
 select b.party_code,b.ApprovedAmt,b.POveriID,c.po_request,b.Req_RefNo into #fff from #update b  join  #chk23 c   
 on b.party_code=c.party_code and b.PO_Request=c.PO_Request  
  
 CREATE NONCLUSTERED INDEX IDX_NCMS_check1 ON #fff(party_code,PO_Request)   
  
 update a set  POveriID= c.POveriID ,PO_Statusid=2,PO_ApprovedAmt=case when c.po_request=c.ApprovedAmt then a.PO_Request     
 when c.po_request<c.ApprovedAmt then a.PO_Request end  ,ReleaseId=c.req_refno   
 from ncms_po_request  a join #fff c on a.Party_code=c.Party_code     
  join NCMS_PO_Request_ForPayout p on a.Req_PayBankId=p.Req_PayBankId    
 where a.PO_Statusid=0  
 /*************************/  
  
 update ncms_po_request set  PO_Statusid=0 from #reject1 b where ncms_po_request.party_code=b.party_code    
 and ncms_po_request.req_refno=b.req_refno    
   
 select  ROW_NUMBER() OVER ( ORDER BY srno ) as srno1 ,* into #NCMS_APPAMT1 from #NCMS_APPAMT where POSTATUS=4      
   
 CREATE NONCLUSTERED INDEX IDX_NCMS_App ON #NCMS_APPAMT1(SRNO1 ASC, POveriID ASC, PARTY_CODE ASC, Req_RefNo ASC, ApprovedAmt ASC, POSTATUS ASC)  
    
  truncate table NCMS_PartialPayout  
    
  insert into NCMS_PartialPayout  
  select * from   #NCMS_APPAMT where POSTATUS in (2,4)                                               
  /* Create New request for Rejected or Partial Transaction */                                              
  /*                         
  DECLARE @CTR AS INT = 1,@TOTCTR AS INT =0,@POveriID as int,@PARTY_CODE AS VARCHAR(10),@ENTITY AS VARCHAR(10),@Req_RefNo AS VARCHAR(25)                                                
  DECLARE @ApprovedAmt AS MONEY=0,@POSTATUS AS INT =0,@STR as VARCHAR(2000) = '',@CF_ReqAmt money = 0,@Remarks as varchar(100)=''                                                    
                                                
  SELECT @TOTCTR = COUNT(1) FROM #NCMS_APPAMT1                                                
                                                    
  WHILE @CTR <= @TOTCTR                                                    
  BEGIN                                                    
                                                
  set @STR=''                                                
                                               
  SELECT @POveriID=POveriID,@PARTY_CODE=PARTY_CODE,@ENTITY=ENTITY,@Req_RefNo=Req_RefNo,                                              
  @ApprovedAmt=convert(decimal(20,2),ApprovedAmt),@POSTATUS=POSTATUS,                                              
  @CF_ReqAmt=(Case when PO_Request-convert(decimal(20,2),ApprovedAmt) > @CFminAMT then PO_Request-convert(decimal(20,2),ApprovedAmt) else 0 end)                                               
  FROM #NCMS_APPAMT1 WHERE SRNO1=@CTR                                  
    
  /*Added On 08 July 2017*/  
  select @Remarks=remarks from ncms_po_request_View with (nolock) where Req_RefNo=@Req_RefNo and Entity=@ENTITY and Party_code=@PARTY_CODE   
  /******End*****************/                                        
  --IF @POSTATUS=3                                                
  --BEGIN                                                
  --SET @POSTATUS=0                                                
  --END                                                
                                          
  IF (@POSTATUS=4 and @CF_ReqAmt > 0)                                                
  BEGIN   
    
       If(@Remarks<>'T'/*'T+2'*/)   
       begin                                         
     select @str='EXEC NCMS_UPD_Request '''+Party_code+''','''+req_ip+''','''+Req_user+'-S'','+                                                
     (Case when Entity='AllSegment' then convert(varchar(25),convert(decimal(15,2),PO_Request-@ApprovedAmt)) else '0' end)+','+                                                
     (Case when Entity='Commodity' then convert(varchar(25),convert(decimal(15,2),0)) else '0' end)+','+                                           
     (Case when Entity='NBFC' then convert(varchar(25),convert(decimal(15,2),PO_Request-@ApprovedAmt)) else '0' end)                                                
     +','''+Req_PayBAnkId+''','''+Req_PayBAnkId+''','''+Req_PayBAnkId+''','''+requestType+''','''+remarks+''''                                                
     from ncms_po_request_View with (nolock)                                                 
     where Req_RefNo=@Req_RefNo and Entity=@ENTITY and Party_code=@PARTY_CODE    
    end  
    /*Added On 08 July 2017*/  
    else  
    begin  
   select @str='EXEC NCMS_UPD_Request_AE_Partial_PO '''+Party_code+''','''+req_ip+''','''+Req_user+'-S'','+                                                
     (Case when Entity='AllSegment' then convert(varchar(25),convert(decimal(15,2),PO_Request-@ApprovedAmt)) else '0' end)+','+                                                
   (Case when Entity='Commodity' then convert(varchar(25),convert(decimal(15,2),0)) else '0' end)+','+                                             
     (Case when Entity='NBFC' then convert(varchar(25),convert(decimal(15,2),PO_Request-@ApprovedAmt)) else '0' end)                                                
     +','''+Req_PayBAnkId+''','''+Req_PayBAnkId+''','''+Req_PayBAnkId+''','''+requestType+''','''+remarks+''''                                                
     from ncms_po_request_View with (nolock)                                                 
     where Req_RefNo=@Req_RefNo and Entity=@ENTITY and Party_code=@PARTY_CODE   
    end   
    /**************End*/                                             
  END                   
                                                     
  EXEC NCMS_UPDATE_STATUS @PARTY_CODE,@Req_RefNo,@ENTITY,@POSTATUS,@POveriID,@ApprovedAmt    
 -- PRINT(@STR)                                                   
  EXEC(@STR)                                                
                                                 
  set @ctr=@ctr+1                                                    
                                          
  END                                                    
*/                                          
 --   print 'neha'                               
  /* Backup Table */                                        
  /*insert into NCMS_SEgVeriData_Log(SrNo,POrequestID,VerifierID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,                */  
  --insert into NCMS_SEgVeriData_Log_hist(SrNo,POrequestID,VerifierID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,  
    --insert into NCMS_SEgVeriData_Log_log(SrNo,POrequestID,VerifierID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,  
 --insert into   NCMS_SEgVeriData_log_details (SrNo,POrequestID,VerifierID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,  
 --insert into   NCMS_SEgVeriData_Log_new (SrNo,POrequestID,VerifierID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,  
 insert into   NCMS_SEgVeriData_Log_log (SrNo,POrequestID,VerifierID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,  
  UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                  
  AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO,RequestID,Req_RefNo,PO_ApprovedAmt,insertdate,Batchid)             
  select                                                     
  ROW_NUMBER() OVER ( ORDER BY a.party_code,a.entity,c.seqid ) AS [SrNo],                                        
  a.POrequestID,a.ID as VerifierID,a.ProcessDate,a.Entity,a.Segment,a.Party_code,a.Flag,a.Balance,a.UnsettledCrBill,a.UnrecoAmt,a.ShortSellValue,                                        
  a.MarginAmt,a.Deposit,a.CashColl,a.NonCashColl,a.MarginAdjWithColl,a.MarginShortage,a.AccruedCharges,a.OtherDebit,a.NonCashConsideration,                             
  a.ExpoUtilised,a.NetPayable,a.UnPosted_PO,b.PORequestId as RequestID,                                                     
  b.Req_RefNo as Req_RefNo,PO_ApprovedAmt,GETDATE() as insertdate,@Batchid                                        
  from                                                    
  (                                                    
   select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,                                        
   MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,                                        
   ExpoUtilised,NetPayable,UnPosted_PO                                        
   from NCMS_SEgVeriData with (nolock)                               
  ) a join                                                     
  (                                                    
   select party_Code,entity,POrequestid,Req_RefNo,ApprovedAmt as PO_ApprovedAmt from #NCMS_APPAMT WITH (NOLOCK)                                                     
  )b                                                     
  on a.entity=b.entity  and a.Party_code=b.party_Code                                               
  join                                           
  ncms_entity c                                  
  on a.segment=c.segment and a.entity=c.entity      
                                     
  /* Bifurcating Segmentwise Approved Amount */                                                    
                                          
  create table #NCMS_SegPOAppAmt                                                 
  (                                              
  SRNO int,                                                    
  VerifierID int,                                                    
  RequestID int,                                                 
  Req_RefNo VARCHAR(25),                                                    
  PARTY_CODE VARCHAR(10),                                                    
  ENTITY VARCHAR(10),                                                    
  SEGMENT VARCHAR(10),                                                    
  PO_ApprovedAmt money,                                                    
  NetPAyable money,                                                    
  SegApprovedAmt money,                                    
  Temp_NetPAyable money,  
  RequestType char(1)                                                     
  )                                                    
--print 'hi'                                        
  insert into #NCMS_SegPOAppAmt (SRNO,VerifierID,RequestID,Req_RefNo,PARTY_CODE,ENTITY,SEGMENT,PO_ApprovedAmt,NetPAyable,SegApprovedAmt,Temp_NetPAyable,RequestType)                                             
  select                                                     
  ROW_NUMBER() OVER (ORDER BY a.party_code,b.Req_RefNo,a.entity,c.seqid ) AS [SrNo],ID as VerifierID,b.PORequestId as RequestID,                                                     
  b.Req_RefNo as Req_RefNo,a.Party_code,a.Entity,a.Segment,PO_ApprovedAmt,NetPAyable,0 as SegApprovedAmt,NetPAyable,RequestType                                                    
  from                                                    
  (                                                    
  select party_Code,ID,entity,segment,POrequestid,NetPayable from NCMS_SEgVeriData with (nolock)                                                
 /* where NetPayable > 0      */  
  ) a join                                                     
  (                                                    
  select party_Code,entity,POrequestid,Req_RefNo,ApprovedAmt as PO_ApprovedAmt,RequestType from #NCMS_APPAMT WITH (NOLOCK)                                                     
  where ApprovedAmt > 0  and   Req_RefNo is not null   and RequestType<>'B'                                              
  )b                                                     
  on a.entity=b.entity  and a.Party_code=b.party_Code                                               
  join                                                 
  ncms_entity c                                                    
  on a.segment=c.segment and a.entity=c.entity                                                    
 --print 'hello'  
 /**************New Logic Start**************************************************************/  
/* select party_code,entity,max(NetPayable) as NetPayable into #maxaa from #NCMS_SegPOAppAmt  group by party_code,entity*/  
  --commented on 01July2022  
  --select *  into #ee from  #NCMS_SegPOAppAmt where segment='bsemfss'  
  --Select *  into #we from angelfo.BSEMFSS.DBO.MFSS_Client with(nolock) where Dp_Type ='PHY' and party_code in (select party_code from #ee) /*and inactive_from>=getdate() */  
    
  update #NCMS_SegPOAppAmt set  SegApprovedAmt=convert(decimal(19,2),PO_ApprovedAmt) where SEGMENT='nsecm'   
  --and party_code not in (select party_code from #we)  
    
    update #NCMS_SegPOAppAmt set  SegApprovedAmt=convert(decimal(19,2),PO_ApprovedAmt) where SEGMENT='Nbfc'  
      
--(comented on 01July2022) update #NCMS_SegPOAppAmt set  SegApprovedAmt=convert(decimal(19,2),PO_ApprovedAmt) where SEGMENT='bsemfss' and party_code  in (select party_code from #we)  
  
  
  
  /*update #NCMS_SegPOAppAmt set  SegApprovedAmt=convert(decimal(19,2),PO_ApprovedAmt)  from #maxaa where #NCMS_SegPOAppAmt.party_code=#maxaa.party_code  
  and #NCMS_SegPOAppAmt.NetPayable=#maxaa.NetPayable  
  */  
 select * into #bo from #NCMS_SegPOAppAmt where party_code in (select party_code from #NCMS_SegPOAppAmt where NetPayable<SegApprovedAmt )  
 order by party_Code  
    
 /*select *,case when SegApprovedAmt>0.00 then SegApprovedAmt-NetPayable else 0.00 end as Amount into #Amount from #bo*//*commented on 21Jan 2021*/  
   
  select *,case when SegApprovedAmt>0.00 and NetPayable>0 then SegApprovedAmt-NetPayable    
    when NetPayable<0  then NetPayable+SegApprovedAmt else 0.00 end as Amount into #Amount from #bo  
   
 select ID =  ROW_NUMBER() OVER(partition BY PARTY_CODE order by SegApprovedAmt desc),/*ROW_NUMBER() OVER(partition BY PARTY_CODE order by NetPayable desc),        *//*Commented on 21 Jan2021*/  
 DENSEID = DENSE_RANK() OVER(ORDER BY PARTY_CODE),  
 RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt,Amount  
 into #NET_AMTADJ   
 from #Amount   
   
 ;WITH Hold_CTE AS (    
  SELECT     
  ID,DENSEID,RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,  
  PO_ApprovedAmt,NetPayable,  
  --SegApprovedAmt=cast(case when (SegApprovedAmt-NetPayable)>0 then NetPayable else SegApprovedAmt end  as money) ,  
  SegApprovedAmt,  
  /*Amount=cast((case when SegApprovedAmt >= NetPayable then SegApprovedAmt-NetPayable else 0  end ) as money),JV='N'  *//*commented on 21 jan 2021*/  
  Amount=cast((case when SegApprovedAmt >= NetPayable and NetPayable>0 then SegApprovedAmt-NetPayable  
     when NetPayable<0 then SegApprovedAmt  
     when SegApprovedAmt<NetPayable and NetPayable>0 then 0 else 0  end ) as money),JV='N'   
  FROM #NET_AMTADJ e where  
  id=1   
  UNION ALL    
  SELECT     
  e.ID,e.DENSEID,e.RequestID,e.VerifierID,e.Req_RefNo,e.Party_Code,e.Entity,e.Segment,  
  e.PO_ApprovedAmt,e.NetPayable,  
  
  /*SegApprovedAmt =cast((case when (b.Amount-e.NetPayable >0) then e.NetPayable else b.Amount end ) AS money ),  
  Amount=cast(case when b.Amount>=e.NetPayable then b.Amount -e.NetPayable else 0  end as money)*/ /*Commented on 21 Jan 2021*/  
  SegApprovedAmt =cast((case when (b.Amount-e.NetPayable >0) and b.Amount>0 and e.NetPayable>=0  then e.NetPayable  
         when (b.Amount-e.NetPayable >0) and b.Amount>0 and e.NetPayable<0  then 0 else b.Amount end ) AS money ),  
  Amount=cast(case when b.Amount>=e.NetPayable and b.Amount>0 and e.NetPAyable>=0  then  b.Amount -e.NetPayable  
       when b.Amount>=e.NetPayable and b.Amount>0 and e.NetPAyable<0 then  b.Amount else 0  end as money)  
  ,JV='Y'  
    
  FROM #NET_AMTADJ e  inner join  Hold_CTE b ON b.party_code =e.party_code and e.id=b.id+1     
  )    
  SELECT * into  #multiple1 FROM Hold_CTE option(maxrecursion 32767) ;  
    
  --DROP TABLE #multiple1   
    
  --SELECT * FROM #multiple1 ORDER BY PARTY_CODE  
    
  /*  
   select x.party_code,y.segment as FromSegment,x.segment as ToSegment,y.SegApprovedAmt as Amount from     
  (select * from #multiple1 where JV='N')x  
   join  
  (select * from #multiple1 where JV='Y' and SegApprovedAmt>0)y  
  on x.party_code=y.party_code and x.Req_RefNo=y.Req_RefNo  
  order by x.party_code  
   */  
  
 --insert into ncms_FundTransfer_JV( party_code , FromSegment,ToSegment, Amount , EntryDate , Flag , Remarks)  
     insert into AngelBSECM.MKTAPI.dbo.tbl_FundTransfer_JV( party_code , FromSegment,ToSegment, Amount , EntryDate , Flag , Remarks)  
     
   select x.party_code,y.segment as FromSegment,x.segment as ToSegment,y.SegApprovedAmt as Amount,getdate() as EntryDate,'Dr' as Flag,'' as Remarks from     
  (select * from #multiple1 where JV='N')x  
   join  
  (select * from #multiple1 where JV='Y' and SegApprovedAmt>0)y  
  on x.party_code=y.party_code and x.Req_RefNo=y.Req_RefNo  
  order by x.party_code  
  
  
  
 --insert into  anand.MKTAPI.dbo.tbl_FundTransfer_JV( party_code , FromSegment,ToSegment, Amount , EntryDate , Flag , Remarks)  
 --select party_code,FromSegment,ToSegment, Amount ,getdate()  ,Flag,Remarks from #single  
 --union  
 --select party_code,FromSegment,ToSegment, Amount ,EntryDate ,Flag,'' from #MultipleRecords  
   
  /************End****************************************************************/  
  
 /* Commented on 10 March 2018*/  
 /*                        
  declare @PO_BalAmt as money = 0,@SegPOValue as money = 0,@netPay as money = 0,@mrefno as varchar(25) ='',@m_refno as varchar(25) =''                                    
  declare @m_Seg as varchar(10) = ''                                    
                                                      
  set @ctr = 1                                                    
  set @totCtr =0                                                    
  set @entity= ''                                               
  set @PARTY_CODE=''                                                   
  set @mrefno=''                                    
  set @m_refno=''                                    
                                                    
  select @totCtr=count(1) from #NCMS_SegPOAppAmt                                          
  While @ctr <= @totctr                                                    
  Begin                                                    
                                    
    set @m_Seg = ''                                               
    Select @M_entity=entity,@M_pcode=party_code,@m_refno=Req_RefNo from #NCMS_SegPOAppAmt where srno=@ctr                                              
    /*                                            
    print @M_entity                                                  
    print @ENTITY                                              
    print @M_pcode                                                  
    print @PARTY_CODE                                       
    */                                            
                                               
    if (@M_entity<> @ENTITY or @M_pcode<>@PARTY_CODE or @m_refno<>@mrefno)                                              
    Begin                                              
      set @PARTY_CODE=@M_pcode                                              
      set @ENTITY=@M_entity                                      
      set @mrefno=@m_refno                                    
      Select @PO_BalAmt=PO_ApprovedAmt from #NCMS_SegPOAppAmt where srno=@ctr                                                    
      /*                                            
      print @ctr                                              
      print @PARTY_CODE                                           
      print @ENTITY                                              
      print @PO_BalAmt                                                  
      */                                            
    End                                              
                                        
    Select @m_Seg=segment,@SegPOValue=(Case when @PO_BalAmt >= Temp_NEtpayable then Temp_NEtpayable  
      when  RequestType='B' then @PO_BalAmt else @PO_BalAmt end) from #NCMS_SegPOAppAmt                                     
    where srno=@ctr  and Temp_NEtpayable >= 0                                                   
                                      
    if @SegPOValue<=@CFminAMT                                    
    Begin                                  
  set @SegPOValue=0                                  
 End                                  
    Else                                  
    Begin                                    
  update #NCMS_SegPOAppAmt set SegApprovedAmt =convert(decimal(19,2),@SegPOValue) where srno=@ctr                                                    
  update #NCMS_SegPOAppAmt set Temp_NEtpayable=Temp_NEtpayable-convert(decimal(19,2),@SegPOValue) where PARTY_CODE=@M_pcode and SEGMENT=@m_Seg                               
    End                                  
                                             
    /* print @SegPOValue  */                                            
    set @PO_BalAmt=@PO_BalAmt-@SegPOValue                                                 
    /* print @PO_BalAmt  */                                            
    set @ctr=@ctr+1                                                    
  End                                               
 */                         
/* CHECK 2 START */                          
                  
 insert into NCMS_payexceed (Batchid,ProcessDate,party_code,Entity,SegApprovedAmt,NetPayable)            
 select @Batchid,getdate(),A.Party_Code,a.Entity,a.SegApprovedAmt,b.NetPayable from                         
 (select Party_Code,Entity,SUM(SegApprovedAmt) as SegApprovedAmt from #NCMS_SegPOAppAmt where req_refno not like 'B2B%' group by Party_Code,Entity ) a left outer join                        
 (select Entity,party_code,sum(NetPayable) as NetPayable from NCMS_CombineVeriData with (nolock) group by Entity,party_code)b                        
 on a.party_code=b.party_code and a.entity=b.entity                        
 where a.SegApprovedAmt > b.NetPayable+1                      
                  
 declare @payexceed as int = 0                          
 select @payexceed=COUNT(1) from NCMS_payexceed where batchid=@Batchid                    
                          
  if (@payexceed > 0)                           
  Begin                          
   insert into sms.dbo.sms                                  
   select mobile as No,                            
   'NCMS Verification Payout Amount Exceeded: Batchid-'+@Batchid+' No of Client(s):'+convert(varchar(3),@payexceed), convert(varchar(10),getdate(), 103)                                        
   ,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':'+ ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                                                           
   'P', case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end,                                              
   'Payout Marking' from NCMS_mobile                           
            
 /* Remove Client with Excess Payout -- START*/            
             
 SELECT A.* INTO #NCMS_MultiPOcli             
 FROM #NCMS_SegPOAppAmt A JOIN (SELECT * FROM NCMS_payexceed WHERE BATCHID=@Batchid ) B            
 ON A.PARTY_CODE=B.PARTy_CODE            
            
 DELETE A             
 FROM #NCMS_SegPOAppAmt  A JOIN (SELECT * FROM NCMS_payexceed WHERE BATCHID=@Batchid ) B            
 ON A.PARTY_CODE=B.PARTy_CODE            
  
  IF (select COUNT(1) from #NCMS_MultiCLi) > 0                                              
  BEGIN   
 insert into NCMS_MultiCliPO  
 (SrNoID,SRNO,PARTY_CODE,ENTITY,Req_RefNo,poREQUESTID,ApprovedAmt,POSTATUS,POveriID,NetPayable,EQ_NetPayable,  
 NB_NetPayable,PO_Request,PO_allowed,Batchid,RequestType)  
 select SrNoID,SRNO,PARTY_CODE,ENTITY,Req_RefNo,poREQUESTID,ApprovedAmt,POSTATUS,POveriID,NetPayable,EQ_NetPayable,  
 NB_NetPayable,PO_Request,PO_allowed,Batchid,RequestType from  #NCMS_APPAMT_TEMP  
   
  DELETE A             
  FROM #NCMS_SegPOAppAmt  A JOIN (SELECT party_code FROM #NCMS_APPAMT_TEMP group by party_code ) B            
  ON A.PARTY_CODE=B.PARTy_CODE            
end             
 update ncms_po_Request set po_statusid=0,POVeriId=0,PO_ApprovedAmt=0 from             
 #NCMS_MultiPOcli  b            
 where ncms_po_Request.porequestid=b.requestid            
            
 drop table #NCMS_MultiPOcli             
 /* Remove Client with Excess Payout -- END */            
             
  End                          
                          
/* CHECK 2 END */                          
  insert into NCMS_VerificationGapsStatistics (Batchid,ProcessDate,CurrTimeGap,SegTimeGap,NetPayDiff,MultiCli,payexceed)                          
  select @Batchid,GETDATE(),isnull(@CurrTimeGap,0),isnull(@SegTimeGap,0),isnull(@NetPayDiff,0),isnull(@MultiCli,0),isnull(@payexceed,0)                          
  
declare @processdate datetime  
set @processdate=getdate()  
--print @processdate  
  
 /**for Bill2Bill  **/  
  insert into NCMS_SegPayoutAppAmt(RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt,BOFF_gen,BANK_gen,ODIN_gen,ProcessDateTime,BOFF_Posted,Batchid)                                                    
  select id,0,Req_RefNo,Party_code,Entity,segment,PO_REQUEST,netpayable,PO_REQUEST,0,0,0,@processdate,0,@Batchid  from #ab  
 /*******************/   
   
  
  /******************************************************************************/  
if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:01') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin  
 --if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)  
 --begin  
 /*  
 insert into  [172.31.15.253].SRI_DB.dbo.SchedRMSPayInOutUpdates_hist(UserId,AccountId,Exchange,Segment,Symbol,Product,Amount,Validated,ValidationText,DtTime,AvailMargin,ReqdMargin,BORefStr,updatedon)  
     select UserId,AccountId,Exchange,Segment,Symbol,Product,Amount,Validated,ValidationText,DtTime,AvailMargin,ReqdMargin,BORefStr,GETDATE() from   
      [172.31.15.253].SRI_DB.dbo.SchedRMSPayInOutUpdates with(nolock)  
        
      Delete from [172.31.15.253].SRI_DB.dbo.SchedRMSPayInOutUpdates  
   */  
        
 --select * into #er from [172.31.15.250].[uploader-db].DBO.V_InvestorName WITH(NOLOCK)   
  
 select * into #er from ncms_omnysis_uploader WITH(NOLOCK)   
  
  /*select a.* into #er from ncms_omnysis_uploader a WITH(NOLOCK) ,NCMS_PO_Request_ForPayout b with(nolock) where AccountId   
  COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE   
  */  
   
/*   
DECLARE @rc INT = 1;  
WHILE @rc > 0  
BEGIN  
  --BEGIN TRANSACTION;Testing_Omnysis  
declare @processdate1 datetime  
set @processdate1=getdate()  
  insert into  [172.31.15.253].SRI_DB.dbo.SchedRMSPayInOutUpdates(UserId,AccountId,Exchange,Segment,product,Amount,DtTime)  
   select TOP (3000) UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code,'','','',  
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1) ,@processdate1 from #NCMS_SegPOAppAmt As s  
   WHERE  
    NOT EXISTS   
    (  
      SELECT 1 FROM [172.31.15.253].SRI_DB.dbo.SchedRMSPayInOutUpdates AS t  
      WHERE t.AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =s.PARTY_CODE -- and  t.DtTime>=@processdate1  
    )  
    and   
    SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)   
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=4)  
   group by PARTY_CODE    
     
   WAITFOR DELAY '00:01:00'   
     
   insert into  NCMS_Omnysis_hist/*NCMS_Omnysis_hist_04Feb2021*/  
   select *,GETDATE() from NCMS_Omnysis  
     
   truncate table NCMS_Omnysis              
     
   insert into NCMS_Omnysis  
   select  AccountId,Amount,Validated,dttime from  [172.31.15.253].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate1  
     
     
   insert into NCMS_Omnysis_log  
      select * from NCMS_Omnysis  
    
 SET @rc = @@ROWCOUNT;  
  --COMMIT TRANSACTION;  
END */  
   
/*   
DECLARE @rc INT = 1;  
WHILE @rc > 0  
BEGIN  
  --BEGIN TRANSACTION;Testing_Omnysis  
declare @processdate1 datetime  
set @processdate1=getdate()  
  insert into  [172.31.15.250].SRI_DB.dbo.SchedRMSPayInOutUpdates(UserId,AccountId,Exchange,Segment,product,Amount,DtTime)  
   select TOP (5000) UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code,'','','',  
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1) ,@processdate1 from #NCMS_SegPOAppAmt As s  
   WHERE  
    NOT EXISTS   
    (  
      SELECT 1 FROM [172.31.15.250].SRI_DB.dbo.SchedRMSPayInOutUpdates AS t  
      WHERE t.AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =s.PARTY_CODE -- and  t.DtTime>=@processdate1  
    )  
    and   
    SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM /*[172.31.15.250].[uploader-db].DBO.V_InvestorName*/#er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=1)  
   group by PARTY_CODE    
     
   WAITFOR DELAY '00:01:00'   
     
   insert into  NCMS_Omnysis_hist/*NCMS_Omnysis_hist_04Feb2021*/  
   select *,GETDATE() from NCMS_Omnysis  
     
   truncate table NCMS_Omnysis              
     
   insert into NCMS_Omnysis  
   select  AccountId,Amount,Validated,dttime from  [172.31.15.250].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate1  
     
     
   insert into NCMS_Omnysis_log  
      select * from NCMS_Omnysis  
    
 SET @rc = @@ROWCOUNT;  
  --COMMIT TRANSACTION;  
END */  
  
declare @processdate2 datetime    
set @processdate2=getdate()    
  
/*  
 insert into  [172.31.15.169].SRI_DB.dbo.SchedRMSPayInOutUpdates_hist(UserId,AccountId,Exchange,Segment,Symbol,Product,Amount,Validated,ValidationText,DtTime,AvailMargin,ReqdMargin,BORefStr,updatedon)  
     select UserId,AccountId,Exchange,Segment,Symbol,Product,Amount,Validated,ValidationText,DtTime,AvailMargin,ReqdMargin,BORefStr,GETDATE() from   
      [172.31.15.169].SRI_DB.dbo.SchedRMSPayInOutUpdates with(nolock)  
        
      Delete from [172.31.15.169].SRI_DB.dbo.SchedRMSPayInOutUpdates    
  
insert into [172.31.15.169].SRI_DB.dbo.SchedRMSPayInOutUpdates(UserId,AccountId,Exchange,Segment,product,Amount,DtTime)    
   select UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code,'','','',    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1),@processdate2  from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM [172.31.15.250].[uploader-db].DBO.V_InvestorName WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=6)    
   group by PARTY_CODE   
*/  
/*  
 insert into  NCMS_GM7(SlNo,UserId,AccountId,Exchange,Segment,Symbol,Product,Amount,Validated,ValidationText,DtTime,AvailMargin,ReqdMargin,BORefStr,updatedon)  
     select SlNo,UserId,AccountId,Exchange,Segment,Symbol,Product,Amount,Validated,ValidationText,DtTime,AvailMargin,ReqdMargin,BORefStr,GETDATE() from   
      [172.31.15.46].SRI_DB.dbo.SchedRMSPayInOutUpdates with(nolock)  
    
  Delete from [172.31.15.46].SRI_DB.dbo.SchedRMSPayInOutUpdates    
  
insert into [172.31.15.46].SRI_DB.dbo.SchedRMSPayInOutUpdates(UserId,AccountId,Exchange,Segment,product,Amount,DtTime)    
   select UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code,'','','',    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1),@processdate2  from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=7)    
   group by PARTY_CODE  
   */  
/*  
insert into  [172.31.15.253].SRI_DB.dbo.SchedRMSPayInOutUpdates_hist(UserId,AccountId,Exchange,Segment,Symbol,Product,Amount,Validated,ValidationText,DtTime,AvailMargin,ReqdMargin,BORefStr,updatedon)  
     select UserId,AccountId,Exchange,Segment,Symbol,Product,Amount,Validated,ValidationText,DtTime,AvailMargin,ReqdMargin,BORefStr,GETDATE() from   
      [172.31.15.253].SRI_DB.dbo.SchedRMSPayInOutUpdates with(nolock)  
        
 Delete from [172.31.15.253].SRI_DB.dbo.SchedRMSPayInOutUpdates    where Validated='In-process'    
*/        
/*  
 --insert into [172.31.15.69].SRI_DB.dbo.SchedRMSPayInOutUpdates(UserId,AccountId,Exchange,Segment,product,Amount,DtTime)    
 --  select UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code,'','','',    
 --  ROUND(sum(SegApprovedAmt*(-1)) , 0, 1) ,@processdate2 from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
 --  AND EXISTS (SELECT AccountId FROM [172.31.15.250].[uploader-db].DBO.V_InvestorName WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
 --  WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=2)    
 --  group by PARTY_CODE     
*/ /*Commented on 09 Nov 2021 by Neha*/    
  
 insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),2,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=2)    
   group by PARTY_CODE,RequestID   
 /*    
--insert into [172.31.15.154].SRI_DB.dbo.SchedRMSPayInOutUpdates(UserId,AccountId,Exchange,Segment,product,Amount,DtTime)    
--   select UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code,'','','',    
--   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1),@processdate2  from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
--   AND EXISTS (SELECT AccountId FROM [172.31.15.250].[uploader-db].DBO.V_InvestorName WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
--   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=3)    
--   group by PARTY_CODE   
 */ /*Commented on 09 Nov 2021 by Neha*/    
  
insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),3,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=3)    
   group by PARTY_CODE,RequestID   
     
  
insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),1,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=1)    
   group by PARTY_CODE,RequestID      
  
  
insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),6,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=6)    
   group by PARTY_CODE,RequestID     
  
  
insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),4,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=4)    
   group by PARTY_CODE,RequestID     
  
insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),8,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=8)    
   group by PARTY_CODE,RequestID    
     
insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),9,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=9)    
   group by PARTY_CODE,RequestID    
     
 insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),7,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=7)    
   group by PARTY_CODE,RequestID   
  
     
 insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),104,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=104)    
   group by PARTY_CODE,RequestID   
  
    insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),106,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=106)    
   group by PARTY_CODE,RequestID   
  
       insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),102,'','',GETDATE(),''    
     from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=102)    
   group by PARTY_CODE,RequestID   
  
   insert into NCMS_SendOmnysis(POrequestID,Party_code,PO_Request,Req_datetime,MangerId,Response,Request,requestdate,Validationtxt)    
   select RequestID,UPPER(RTRIM(LTRIM(Party_code))) Party_code,ROUND(sum(SegApprovedAmt) , 0, 1),GETDATE(),108,'','',GETDATE(),''    
   from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=108)    
   group by PARTY_CODE,RequestID   
  
   --Exec  NCMS_OmnysisAPI_EXE/*Added on 09 Nov 2021 by Neha*/  
   exec NCMS_OmnysisAPI_GM1_EXE  
   exec NCMS_OmnysisAPI_GM2_EXE  
   exec NCMS_OmnysisAPI_GM3_EXE  
   exec NCMS_OmnysisAPI_GM6_EXE  
   exec NCMS_OmnysisAPI_GM4_EXE  
   exec NCMS_OmnysisAPI_GM8_EXE  
   exec NCMS_OmnysisAPI_GM9_EXE  
   exec NCMS_OmnysisAPI_GM7_EXE  
   exec NCMS_OmnysisAPI_GM104_EXE  
   exec NCMS_OmnysisAPI_GM106_EXE  
   exec NCMS_OmnysisAPI_GM_102_EXE  
   exec NCMS_OmnysisAPI_GM_108_EXE  
  
select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,  
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse into #sendtoomny from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE and OmneManagerID=1)  
   group by PARTY_CODE,requestid   
  
     
   insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=2)    
   group by PARTY_CODE,requestid   
     
    insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=3)    
   group by PARTY_CODE,requestid    
     
    insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=4)    
   group by PARTY_CODE,requestid    
     
   insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=6)    
   group by PARTY_CODE,requestid    
  
    insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=7)    
   group by PARTY_CODE,requestid    
     
   insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=8)    
   group by PARTY_CODE,requestid    
  
   insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=9)    
   group by PARTY_CODE,requestid  
     
      insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=104)    
   group by PARTY_CODE,requestid    
  
      insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=106)    
   group by PARTY_CODE,requestid    
  
    insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=102)    
   group by PARTY_CODE,requestid    
  
    insert into #sendtoomny    
    select requestid,UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code1,    
   ROUND(sum(SegApprovedAmt*(-1)) , 0, 1)amt ,CONVERT(varchar(20),'') as reponse from #NCMS_SegPOAppAmt where SegApprovedAmt>0    
   AND EXISTS (SELECT AccountId FROM #er WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */    
   WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE  and OmneManagerID=108)    
   group by PARTY_CODE,requestid    
     --WAITFOR DELAY '00:02:00'                  
     
    insert into NCMS_Omnysis_hist    
   select *,GETDATE() from NCMS_Omnysis    
    
   truncate table NCMS_Omnysis                 
       
  /* insert into NCMS_Omnysis    
   select  AccountId,Amount,Validated,dttime from  [172.31.15.69].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate2   
   */  
    insert into NCMS_Omnysis    
   select  UPPER(RTRIM(LTRIM(Party_code))),po_request*(-1),Validationtxt,requestdate from  NCMS_SendOmnysis with(nolock)   
     
   --WAITFOR DELAY '00:02:00'    
     
  /* insert into NCMS_Omnysis    
   select  AccountId,Amount,Validated,dttime from  [172.31.15.154].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate2    
  
   WAITFOR DELAY '00:01:00' */   
  
   --insert into NCMS_Omnysis    
   --select  AccountId,Amount,Validated,dttime from  [172.31.15.169].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate2    
      
 --insert into NCMS_Omnysis    
 --  select  AccountId,Amount,Validated,dttime from  [172.31.15.46].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate2   
  
 insert into NCMS_Omnysis_log    
 select * from NCMS_Omnysis        
/******************Added for removing MFSS codes from Omnisys********************************************************/  
   
 /*select distinct  party_code into #oo from angelfo.BSEMFSS.dbo.MF_CLIENT with(nolock) where party_code not in  
  (select distinct cl_code from [196.1.115.196].msajag.dbo.client_brok_details with(nolock))*/ /*commented on 09 Jun2021*/  
    
  select distinct  party_code into #oo from NCMS_OnlyMF_Codes with(nolock)  
    
 DELETE A             
   FROM NCMS_Omnysis_log  A JOIN (SELECT party_code FROM #oo) B            
   ON A.PARTY_CODE=B.PARTy_CODE --where  A.validationtxt<>'OK'  
   
 DELETE A             
   FROM #sendtoomny  A JOIN (SELECT party_code FROM #oo) B            
   ON A.PARTY_CODE=B.PARTy_CODE  
/**************************************************************************/  
/******************Added for removing Inactice codes from Omnisys on 01 Aug 2022********************************************************/    
 select * into #Inactivecodes from NCMS_Omnysis_log  where validationtxt<>'OK' and party_code in   
 (select party_code from [196.1.115.182].general.dbo.client_details with(nolock) where last_inactive_date<CONVERT(VARCHAR(11), Getdate()) )  
  
 exec SP_NCMS_OmnesysInactiveClientMailer  
  
 DELETE A             
   FROM NCMS_Omnysis_log  A JOIN (SELECT party_code FROM #Inactivecodes) B            
   ON A.PARTY_CODE=B.PARTy_CODE where  A.validationtxt<>'OK'  
   
 DELETE A             
   FROM #sendtoomny  A JOIN (SELECT party_code FROM #Inactivecodes) B            
   ON A.PARTY_CODE=B.PARTy_CODE  
/**************************************************************************/  
update #sendtoomny set reponse=b.validationtxt from NCMS_Omnysis_log b where #sendtoomny.Party_code=b.party_code  
select * into #omny from NCMS_Omnysis_log where validationtxt<>'OK'  
  
 DELETE A             
   FROM #NCMS_SegPOAppAmt  A JOIN (SELECT party_code FROM #omny group by party_code ) B            
   ON A.PARTY_CODE=B.PARTy_CODE  
     
 update ncms_po_Request set po_statusid=0,PO_ApprovedAmt=0 from             
  #sendtoomny  b            
  where ncms_po_Request.porequestid=b.requestid  and b.reponse<>'OK' /*b.reponse='NOT_OK'*/    
  
/*********Added one more check on 05 may 2022*******************************/  
/*select accountid,amount,Validated,dttime into #inprocess from [172.31.15.169].SRI_DB.dbo.SchedRMSPayInOutUpdates where Validated='in-process'  
  
insert into #inprocess  
select  AccountId,Amount,Validated,dttime from  [172.31.15.253].SRI_DB.dbo.SchedRMSPayInOutUpdates where Validated='in-process'  
  
 DELETE A             
   FROM #NCMS_SegPOAppAmt  A JOIN (SELECT accountid FROM #inprocess group by accountid ) B            
   ON A.PARTY_CODE=B.accountid  
*/  
/************************************************/   
 --end   
end  
-- truncate table NCMS_Omnysis_log  
  /***********************************************************************************/  
                             
  insert into NCMS_SegPayoutAppAmt(RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt,BOFF_gen,BANK_gen,ODIN_gen,ProcessDateTime,BOFF_Posted,Batchid)                                                    
  select RequestID,VerifierID,Req_RefNo,Party_code,Entity,Segment,PO_ApprovedAmt,NetPAyable,SegApprovedAmt,0,0,0,@processdate,0,@Batchid from #NCMS_SegPOAppAmt                                                    
                                        
  /* End of Segmentwise Bifurcation */                                                    
  
/**************Added on 25 July 2019 by Neha naiwar as per mail of Rahul Sir***************************************/  
  
  /*insert into [172.31.18.133].SRI_DB.dbo.SchedRMSPayInOutUpdates(UserId,AccountId,Exchange,Segment,product,Amount,DtTime)*//*UAT server*/  
  /* commented on Sep 30 2019 as suggested by Siva sir.*/  
    
  --SELECT AccountId into #accountid FROM [172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)   
  --where 1=2  
  --- AccountId COLLATE SQL_Latin1_General_CP1_CI_AS   
--  in (select Party_code from #NCMS_SegPOAppAmt )  
   
 --insert into NCMS_Flexi_On_POAmt_For_Testing    
 --   select a.RequestID,a.Req_RefNo,a.Party_Code,a.Entity,a.Segment,a.SegApprovedAmt,    
 --   @processdate,@Batchid,    
 --  b.Net_payable,/*a.PO_Request*/      
 --b.PO_Request      
 --   ,b.Req_datetime,b.Req_IP,            
 --   b.Req_User,b.Req_Paymode,b.remarks,b.requestType from #NCMS_SegPOAppAmt a join ncms_po_request b on a.requestID=b.porequestid where      
 --    not exists (select * from NCMS_Flexi_On_POAmt_For_Testing z where a.requestid=z.requestid and a.Req_RefNo=z.Req_RefNo and    
 --    a.Party_Code=z.Party_Code and a.SegApprovedAmt=z.SegApprovedAmt)  and a.SegApprovedAmt>0  
    
   
 /***********************comented on 23 Oct 2020 by Neha and adding above**************/  
  /*  
  insert into [172.31.15.250].SRI_DB.dbo.SchedRMSPayInOutUpdates(UserId,AccountId,Exchange,Segment,product,Amount,DtTime)  
  select UPPER(RTRIM(LTRIM(Party_code))) Party_code,UPPER(RTRIM(LTRIM(Party_code))) Party_code,'','','',  
  ROUND(sum(SegApprovedAmt*(-1)) , 0, 1) ,@processdate from #NCMS_SegPOAppAmt where SegApprovedAmt>0  
  AND EXISTS (SELECT AccountId FROM [172.31.15.250].[uploader-db].DBO.V_InvestorName WITH(NOLOCK)  /*[172.31.15.250].[uploader-db].DBO.InvestorClient WITH(NOLOCK)  */  
  WHERE   AccountId COLLATE SQL_Latin1_General_CP1_CI_AS =PARTY_CODE)  
  group by PARTY_CODE     
  
    WAITFOR DELAY '00:00:30'                
  
  insert into NCMS_Omnysis_UAT  
  select  AccountId,Amount,Validated,dttime from  [172.31.15.250].SRI_DB.dbo.SchedRMSPayInOutUpdates where DtTime>=@processdate  
  */  
/**********************************************end*/  
 --SELECT * FROM [172.31.15.250].SRI_DB.dbo.SchedRMSPayInOutUpdates  
  /*select Party_code,Party_code,Entity,Segment,0,SegApprovedAmt,@processdate from #NCMS_SegPOAppAmt where SegApprovedAmt>0*/  
/***************************************************************/  
              
 /* BO Data to history */              
 insert into NCMS_SegVeriData_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                            
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                            
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                            
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                            
 from NCMS_SegVeriData a with (nolock)                    
 join              
 (select party_code as Pcode from NCMS_SegPayoutAppAmt where isnull(batchid,'') = (select batchid from NCMS_VerificationGapsStatistics_vw )) b              
 on a.Party_code=b.pcode          
 /* End */      
   
 /*Added For Intrasegment JV -----Stsrt*/           
 --Exec anand.Account_ab.dbo.INT_INHOUSE_JV  
 /***********************----end*/  
update ncms_batch_process set EndDate=getdate(),Flag=1 where srno=18  
                                        
End try                                                                   
                                                                  
BEGIN CATCH                                                                      
                                                                  
  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                            
  select GETDATE(),'NCMS_UPD_ReqVerId_Batchwise',ERROR_LINE(),ERROR_MESSAGE()                                              
                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                          
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                          
  RAISERROR (@ErrorMessage , 16, 1);                                                
                                       
End catch                                                                  
                                                      
SET nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_Upd_status
-- --------------------------------------------------
     
CREATE procedure [dbo].[NCMS_Upd_status](@flag as int)                  
as                  
set nocount on                  
BEGIN TRY 
 
if( DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE())<=6)          	
Begin
if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='10:30'))                            
Begin 
	insert into [bod_batch_start]
	select GETDATE(),'Y'
	WAITFOR DELAY '00:00:05'  
End
End

    
 /**************aDDED ON 12 jUN 2019****************************************/  
  UPDATE ncms_po_request SET remarks='' where remarks IS NULL  
   
 /******************************************************/      
  
 /************ yes bank Blocking**********************/ 

--update T SET PO_Statusid='6',remarks ='YES BANK HOLD'  FROM ncms_po_request T ,
--Acc_master_Online_cli
--where  PARTY_CODE =cltcode AND AccNO=Req_PayBankId
--and Bank_name LIKE 'YE%' AND PO_Statusid=0

/*******************************************************/  
  
  
   
 /**************aDDED ON 10 July 2019 For account opening PO****************************************/  
 --if(@flag=1)
 --Begin
	--exec NCMS_UPD_Request_forAccountOpening  
 --end
 /******************************************************/      
   
      
 update ncms_status  set status = @flag                  
        
 truncate table NCMS_PO_Request_Flexi                
         
     
 /*  commented on 20 Oct 2021     
 TRUNCATE TABLE NCMS_ODINTEMPFILE                           
 INSERT INTO NCMS_ODINTEMPFILE(POid,RequestID,VerifierID,Req_RefNo,Party_Code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt)                           
 select SegMinID,POrequestID,POveriID,Req_RefNo,Party_code,Entity,Segment,PO_ApprovedAmt,NetPayable,SegApprovedAmt                  
 from NCMS_POrequest_OdinClient                   
 */  
 --if(@flag=1)
 --Begin
	-- if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))      
	-- Begin 
	--	exec NCMS_All_PreLDSP 
	-- End
 --end
END TRY                                    
BEGIN CATCH                                    
                                    
 insert into risk.dbo.Appln_ERROR (ErrTime,ErrObject,ErrLine,ErrMessage,ApplnName,DBname)                                                            
 select GETDATE(),'NCMS_Upd_status',ERROR_LINE(),ERROR_MESSAGE(),'NCMS',DB_NAME(db_id())                                                            
                          
 DECLARE @ErrorMessage NVARCHAR(4000);                                         
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                          
 RAISERROR (@ErrorMessage , 16, 1);                               
                                    
END CATCH           
                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_Update_AMX_Omnysis_Response_25May2023
-- --------------------------------------------------
-- =============================================    
-- Author:  Neha Naiwar    
-- Create date: 12 July 2022    
-- =============================================      
Create PROCEDURE [dbo].[NCMS_Update_AMX_Omnysis_Response_25May2023]        
 @partycode varchar(10),        
 --@Amount money,        
 @PoRequestId int,        
 @Response varchar(1000),     
 @AMXResponse varchar(1000),     
 @Request varchar(max) ,  
@Status varchar(500)=null  
as        
BEGIN        
         
      
   update NCMS_RealPayout set Response=@Response, request=@Request,AMX_Response=@AMXResponse, responsedatetime=GETDATE(),   
   Status=case when @Response like '%"status":"SUCCESS"%' then 'Done'      
      when @Response like '%"status":"FAILURE"%' then 'NotForRealPO'      
      else @Status end,     
   Validationtxt = case when @Response like '%"status":"SUCCESS"%' then 'OK'      
      when @Response like '%"status":"FAILURE"%' then 'NOT_OK'      
      end      
   where POrequestID =@PoRequestId     
    
   --update a set po_statusid=1 from ncms_po_Request a join NCMS_RealPayout b on a.party_code=b.party_code    
   --and a.porequestid=b.porequestid   where  a.POrequestID =@PoRequestId   and  b.Validationtxt='OK'     
     
   update a set po_statusid=1 from ncms_po_Request a join NCMS_RealPayout b on a.party_code=b.party_code   
   join Vw_NCMSPayoutMergingView c with(nolock) on  
   a.req_paybankid=c.req_paybankid and a.Party_code=c.Party_code and b.Party_code=c.Party_code  
   where  b.Validationtxt='OK' and a.po_statusid=0 and a.Party_code=@partycode    
       
        
       
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_Update_OtherDebit_30Jan2024
-- --------------------------------------------------
-- =============================================          
-- AUTHOR:  Neha Naiwar       
-- CREATE DATE: July 07 2022          
-- DESCRIPTION: UPDATE OTHER DEBIT CHARGES       
-- =============================================          
create PROCEDURE [dbo].[NCMS_Update_OtherDebit_30Jan2024]          
AS          
BEGIN          
SET XACT_ABORT ON                                                                                                                  
Set nocount on                                                                                                                  
BEGIN TRY                                                                                                                                          
   
     truncate table tbl_EarlyPayin_Charges    
  
CREATE TABLE  #OTHER_DEBIT_DETAILS         
(          
 PARTY_CODE VARCHAR(20),          
 CHARGES_CODE INT,          
 CHARGES_AMT MONEY,          
 CHARGES_NAME VARCHAR(100)          
          
)          
                 
 INSERT INTO #OTHER_DEBIT_DETAILS           
 SELECT A.PARTY_CODE CLIENT, A.CHARGES_CODE, SUM(A.CHARGES_AMT) CHARGES_AMT,B.CHARGES_NAME                                       
 FROM [MISC].DBO.CLI_ACCCHARGES A WITH (NOLOCK)                                                
 INNER JOIN [MISC].DBO.CLI_ACCCHARGESMASTER B WITH (NOLOCK) ON A.CHARGES_CODE = B.CHARGES_CODE                                                
 WHERE CHARGES_DATE > CUTOFFDATE                                                
 --AND A.PARTY_CODE = 'D47172'                                                
 GROUP BY A.PARTY_CODE, A.CHARGES_CODE, B.CHARGES_NAME      --698328       
   
 SELECT PARTY_CODE,CLIENT_CODE,ACTUAL_AMOUNT,ACCRUAL_BAL=isnull(ACCRUAL_BAL,0.00),BRANCH_CODE  
 into #VW_Client_DPBal  
 FROM AngelDP4.inhouse.dbo.Vw_Acc_Curr_Bal with (nolock) where  ACCRUAL_BAL is not null  
  
 TRUNCATE TABLE VW_Client_DPBal  
 INSERT INTO VW_Client_DPBal(PARTY_CODE,CLIENT_CODE,ACTUAL_AMOUNT,ACCRUAL_BAL,BRANCH_CODE)  
 SELECT PARTY_CODE,CLIENT_CODE,ACTUAL_AMOUNT,ACCRUAL_BAL,BRANCH_CODE  
 from #VW_Client_DPBal  
                                                          
 INSERT INTO #OTHER_DEBIT_DETAILS                                                
 SELECT PARTY_CODE,MAX(5),SUM(ACTUAL_AMOUNT),MAX('DP ACTUAL') FROM VW_CLIENT_DPBAL WITH(NOLOCK)                                                 
 --WHERE PARTY_CODE='D47172'                                                 
 GROUP BY PARTY_CODE                                  
                                
 INSERT INTO #OTHER_DEBIT_DETAILS                                                 
 SELECT PARTY_CODE,MAX(5),SUM(ACCRUAL_BAL),MAX('DP ACCRUAL') FROM VW_CLIENT_DPBAL WITH(NOLOCK)                                                 
 --WHERE PARTY_CODE='D47172'                                                 
 GROUP BY PARTY_CODE      
  
--select * from #OTHER_DEBIT_DETAILS where CHARGES_NAME='DP ACCRUAL'                                                                        
 /*ADDED ON REQUEST FROM RAHUL SHAH DATED 20 AUG 2014 TO ADD SD AMT FOR RAJASTHAN*/                                
                  
 UPDATE #OTHER_DEBIT_DETAILS  SET CHARGES_AMT=B.SD_AMT FROM                                               
 (SELECT * FROM [MISC].DBO.RAJASTHAN_SDAMT WITH (NOLOCK))B                                              
 WHERE #OTHER_DEBIT_DETAILS.PARTY_CODE=B.PARTY_CODE                                              
 AND CHARGES_NAME='DP ACCRUAL'     
   
 /*ADDED ON REQUEST FROM RAHUL SHAH DATED Jul 05 2021 to add Margin penalty*/  
 INSERT INTO #OTHER_DEBIT_DETAILS                                                
 SELECT PARTY_CODE,MAX(5),SUM(Penalty_Amt),MAX('Margin Accrual') FROM angelfo.NSECURFO.dbo.MARGIN_Accural WITH(NOLOCK)                                                 
 --WHERE PARTY_CODE='D47172'                                                 
 GROUP BY PARTY_CODE     
                                           
 --truncate table tbl_Settlement_Charges  
 --insert into tbl_Settlement_Charges  
 --EXEC Angeldemat.MSAJAG.dbo.Delivery_DP_Charges_Accural   
  
 EXEC Angeldemat.MSAJAG.dbo.Delivery_DP_Charges_Accural  
 truncate table tbl_Settlement_Charges  
 insert into tbl_Settlement_Charges  
 select * from Angeldemat.MSAJAG.dbo.tbl_angeldemat_Settlement_Charges with (nolock)  
  
 insert into #OTHER_DEBIT_DETAILS  
 select PARTY_CODE,MAX(5),SETT_chrgs,MAX('DP ACCRUAL') from tbl_Settlement_Charges  
 GROUP BY PARTY_CODE ,SETT_chrgs  
  
  
 /*select * into #tbl_EarlyPayin_Charges from [CSOKYC-6].General.dbo.tbl_EarlyPayin_Charges with(nolock)  
  
 insert into #OTHER_DEBIT_DETAILS  
 select PARTY_CODE,MAX(5),Value_AMT,MAX('DP ACCRUAL') from #tbl_EarlyPayin_Charges  
 GROUP BY PARTY_CODE ,Value_AMT  
 */  
  
    
if(DATEPART(DW,GETDATE())>1 and DATEPART(DW,GETDATE()) <= 6) and (CONVERT(VARCHAR(5),GETDATE(),108)>='00:00') and  (DATEPART(HH,GETDATE())<=7)       
begin    
 declare @sdate datetime    
 set @sdate =convert(varchar(11),getdate()-1,120)    
end     
else     
begin     
 set @sdate =convert(varchar(11),getdate(),120)    
end     
    
 insert into tbl_EarlyPayin_Charges    
 Select party_code,CltDpId,sett_no,count(1) as No_CNT,'23.60' as TXN_Rate, count(1)*23.60 as Value_AMT ,@sdate as SD_DATE    
 from ANGELDEMAT.MSAJAG.DBO.deltrans d (Nolock)    
 where   drcr ='C' and filler2=1      
 and reason='Early Pay-In' and exists (select sett_no from ANGELDEMAT.MSAJAG.DBO.sett_mst s where s.sett_no=d.sett_no    
 and s.Sett_Type =d.sett_type  and Start_date <=@sdate and Sec_Payin >@sdate)    
 group by party_code,sett_no,CltDpId    
 order by 3 desc    
    
 insert into #OTHER_DEBIT_DETAILS    
 select PARTY_CODE,MAX(5),Value_AMT,MAX('DP ACCRUAL') from tbl_EarlyPayin_Charges    
 GROUP BY PARTY_CODE ,Value_AMT    
  
 SELECT  cltcode,sum(CHARGAMT+GST_CHARGES) As CNT_Amt  into #CALNT  
 FROM AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG   
 where cnt_Date=(select max(cnt_Date) from AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))  
 group by cltcode  
  
 SELECT J.cl_code,sum(CHARGAMT+GST_CHARGES)as PCN_Amt into #PCN  
 FROM AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock),AngelNseCM.MSAJAG.DBO.client_details c(Nolock)   
 where  PCN_Date=(select max(PCN_Date) from AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock)) and J.cl_code=c.cl_code  
 group by J.cl_code  
  
  insert into #OTHER_DEBIT_DETAILS  
  select cltcode,MAX(5),CNT_Amt,MAX('CALNT ACCRUAL') from #CALNT  
  GROUP BY cltcode ,CNT_Amt  
  
  insert into #OTHER_DEBIT_DETAILS  
  select cl_code,MAX(5),PCN_Amt,MAX('PCN ACCRUAL') from #PCN  
  GROUP BY cl_code ,PCN_Amt  
   
 /*********************************************************************/    
     
    truncate table tbl_otherdebit_chargeswise    
    insert into tbl_otherdebit_chargeswise    
    select *,upd_date=getdate() from #OTHER_DEBIT_DETAILS    
/***********************************************************************/  
  
  SELECT PARTY_CODE,                                                 
  TOTAL = SUM(CASE WHEN CHARGES_NAME = 'PENAL' THEN (CHARGES_AMT)* (-1)                                                 
  WHEN CHARGES_NAME = 'ECN' THEN (CHARGES_AMT)* (-1)                                             
  WHEN CHARGES_NAME = 'DEMAT' THEN (CHARGES_AMT) * (-1)                                                   
  WHEN CHARGES_NAME = 'DP ACTUAL' THEN (CHARGES_AMT)* (-1)                                             
  WHEN CHARGES_NAME = 'DP ACCRUAL' THEN (CHARGES_AMT) * (-1)      
  WHEN CHARGES_NAME = 'Margin Accrual' THEN (CHARGES_AMT) * (-1)  
  WHEN CHARGES_NAME = 'CALNT ACCRUAL' THEN (CHARGES_AMT) * (-1)                                  
  WHEN CHARGES_NAME = 'PCN ACCRUAL' THEN (CHARGES_AMT) * (-1)                                                                  
  WHEN CHARGES_NAME = 'NBFC' THEN (CHARGES_AMT) END)   
  INTO #FINAL_OT    
  FROM #OTHER_DEBIT_DETAILS                                                
  GROUP BY PARTY_CODE  
   
   
  SELECT PARTY_CODE,OTHER_DEBIT=TOTAL            
  INTO #TBL_COLLECTION_OD    from        
  #FINAL_OT    
  
  
  TRUNCATE TABLE TBL_OTHER_DEBIT          
                    
  INSERT INTO TBL_OTHER_DEBIT (party_code,OTHER_DEBIT,Update_date)           
  SELECT *,getdate()    FROM #TBL_COLLECTION_OD  where OTHER_DEBIT<0.00     
          
  drop table #OTHER_DEBIT_DETAILS        
  drop table #FINAL_OT        
         
End try                                                                                                                                       
BEGIN CATCH                                                                                                                                          
                                     
 insert into risk.dbo.Appln_ERROR (ErrTime,ErrObject,ErrLine,ErrMessage,ApplnName,DBname)                                                            
 select GETDATE(),'NCMS_Update_OtherDebit',ERROR_LINE(),ERROR_MESSAGE(),'NCMS',DB_NAME(db_id())                                                                                                                                                          
                            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                  
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                
  RAISERROR (@ErrorMessage , 16, 1);                                        
End catch                                                                                       
                            
SET NOCOUNT OFF           
        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_ValidateToken_18Aug2023
-- --------------------------------------------------
create proc NCMS_ValidateToken_18Aug2023(    
@accountid as varchar(100),    
@token  as varchar(max)    
)    
as    
begin    
 if(select COUNT(1) from ncms_po_request with(nolock) where Party_code=@accountid and POrequestID=@token)>0    
 begin    
  select 'success' as message    
 end    
 else    
 begin    
  select 'fail' as message    
 end     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_VeriData_Batchwise_08Feb2024
-- --------------------------------------------------
create PROCEDURE [dbo].[NCMS_VeriData_Batchwise_08Feb2024]                                
as                                                      
  /* FETCH DATA */    
if(select flag from ncms_batch_process with(nolock) where Srno=15)=1  
Begin   
  begin  
                                                      
   Create table #NCMS_SegwiseCldata (                                                          
   id int,                                              
   ProcessDate datetime,                                              
   Entity varchar(10),                                              
   Segment varchar(10),                                              
   Party_code varchar(10),                                              
   Flag char(1),                                              
   Balance money,                                              
   UnsettledCrBill money,                                              
   UnrecoAmt money,                                              
   ShortSellValue money,                                              
   MarginAmt money,                                              
   Deposit money,                                              
   CashColl money,                                              
   NonCashColl money,                                              
   MarginAdjWithColl money,                                              
   MarginShortage money,                                              
   AccruedCharges money,                                              
   OtherDebit money,                                              
   NonCashConsideration money,                                              
   ExpoUtilised money,                                              
   UnPosted_PO money,                   
   NetPayable money                                          
   )                                                                                                             
                                                
                          
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime,'AllSegment','BSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                       
  from AngelBSECM.inhouse.dbo.NCMS_PO  with(nolock)                                                   
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','NSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                       
  from AngelNseCM.inhouse.dbo.NCMS_PO  with(nolock)                                                        
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                  
select ProcessDatetime,'AllSegment','MTF',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                   
 from AngelNseCM.MTFTRADE.dbo.NCMS_PO  with(nolock)      
                                                         
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelfo.inhouse.dbo.NCMS_marh  with(nolock)                                                        
  /* and PayoutValue <> 0*/     
    
  /******BSEFO***************/  
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','BSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.BSEFO.dbo.NCMS_marh  with(nolock)    
  /*********************/  
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelfo.inhouse_curfo.dbo.NCMS_marh  with(nolock)               
  /* and PayoutValue <> 0*/                                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','MCD',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.INHOUSE_MCDCS.dbo.NCMS_marh  with(nolock)                                                        
  /* and PayoutValue <> 0*/                                                      
    
     
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                 
 select UpdDatetime,'AllSegment','BSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                   
 from angelcommodity.inhouse_bsx.dbo.NCMS_marh  with(nolock)      
                                                         
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NCDEX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.inhouse_NCDX.dbo.NCMS_marh   with(nolock)                                                       
/* and PayoutValue <> 0*/                                                     
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','MCX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.inhouse_MCDX.dbo.NCMS_marh   with(nolock)                                                       
  /* and PayoutValue <> 0*/                                                     
                       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','BSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,AfterAdjustedBal/*VBal+UCV+UnRecoCr+OtherDr */          
 from /*angelfo.inhouse.dbo.NCMS_PO_BSEMFSS*/   angelfo.inhouse.dbo.NCMS_PO_BSEMFSS_edt with(nolock)    
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','NSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                 
  from angelfo.inhouse.dbo.NCMS_PO_NSEMFSS with(nolock)                                                         
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                    
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','IPO',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                           
  from NCMS_PO_IPO with(nolock)                                                        
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                              
  /*                           
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select processDate,'NBFC','NBFC',party_Code,'I',LogicalLedger,Unsettled,0,ShortValHC,0,0,0,VAHC,0,0,AccruedInt,ShortVal,0,0,NetAmount                                                   
from [172.31.16.57].inhouse.dbo.ncms_po /* and netAmount <> 0 */                                    
  */                              
                                
  /* NBFC verification not required. verification is based on BOD processed data */                              
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                              
  select                               
  ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                              
  from NCMS_SegwiseCldata with (nolock) where entity='NBFC'                              
      
    /************************************************************************************************************************************************/     
/************************************************************************************************************************************************/     
    /*Changed in order to consider MTM of cases where there is no ledger added by Neha Naiwar on suggestion from Bhavin Parikh dt: 23th June 2016*/         
     select * into #LD from NCMS_LD_View a with(nolock) ,NCMS_PO_Request_ForPayout b  where a.client_code=b.Party_code  
     
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where BSECM > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSECM' ) and isnull(client_code,'')<>''    
      
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where NSECM > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSECM' ) and isnull(client_code,'')<>''    
       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSEFO',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where NSEFO > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSEFO' ) and isnull(client_code,'')<>''                           
       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)   where NSX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSX' ) and isnull(client_code,'')<>''                                                       
     
   insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCD',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)   where MCD > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCD' ) and isnull(client_code,'')<>''     
     
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)  where BSX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSX' ) and isnull(client_code,'')<>''     
     
     insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NCDEX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock) where NCDEX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NCDEX' ) and isnull(client_code,'')<>''     
     
      insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock) where MCX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCX' ) and isnull(client_code,'')<>''    
    
/************************************************************************************************************************************************/    
/**********************Adding NSECM Clients if not exist*********************************/  
 /*suggestion*/  
 /*insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)     
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSECM',cltcode=Cl_Code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,  
  0,0,0,OtherDr=0,0,0,0                                                       
  from AngelNseCM.msajag.dbo.client_brok_details a with(nolock) where  isnull(Deactive_value,'') not in ('T','C') and exchange='NSE' and segment='CAPITAL'   
    and not exists    
 (select * from #NCMS_SegwiseCldata b where a.Cl_Code=b.party_code and segment='NSECM' ) and isnull(Cl_Code,'')<>''   
 --and exists (select distinct Party_code from NCMS_PO_Request_ForPayout c with(nolock) where a.cl_code=c.Party_code)  
 */  
/************************************************************************************************************************************************/     
  /* Accrured Charges */                                                  
                                                                                      
 --select a.party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                     
 --from /*misc.dbo.Accrued_PenalCharges*/ NCMS_Accrued_PenalCharges a with (nolock) ,NCMS_PO_Request_ForPayout b  where a.party_code=b.Party_code   
 --group by a.party_code     
   
 select a.PARTY_CODE,(OTHER_DEBIT*-1) as OTHER_DEBIT into #AccCharges from tbl_other_debit a with (nolock) ,NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
  
 select a.PARTY_CODE,DeductEQ=sum(a.OTHER_DEBIT),DeductComm=0.00 into #Accrued1  
 from #AccCharges a with (nolock)-- ,NCMS_PO_Request_ForPayout b  where a.client=b.Party_code   
 group by a.PARTY_CODE     
     
 /******added new margin peneality charges on 05 Jul 2021***********************************/    
 --insert into #Accrued1    
 -- select a.party_code,DeductEQ=SUM(Value_amt),DeductComm=0.00 from [CSOKYC-6].General.dbo.tbl_EarlyPayin_Charges a with(nolock)  
 -- ,NCMS_PO_Request_ForPayout b  where a.party_code=b.Party_code group by a.party_code  
  
 --insert into #Accrued1    
 -- select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code              
   
   
 insert into  #Accrued1  
 select a.party_code,DeductEQ=Balance,DeductComm=0.00 from  NCMS_WO_Master a with(nolock),NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
 /*Added for W/O Margin on 16 Nov 2021*/          
   
   
--insert into  #Accrued1  
--SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM anand1.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)  
--where cnt_Date=(select max(cnt_Date) from anand1.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))  
--group by cltcode  
  
--insert into  #Accrued1  
--SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM anand1.MSAJAG.DBO.JVPNC_LOG J (Nolock),anand1.MSAJAG.DBO.client_details c(Nolock)  
--where  PCN_Date=(select max(PCN_Date) from anand1.MSAJAG.DBO.JVPNC_LOG J (Nolock))  
-- and J.cl_code=c.cl_code  
--group by J.cl_code   
  
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                           
    
 --select client as party_code,DeductEQ*-1 as DeductEQ ,DeductComm as DeductComm into #Accrued from #Accrued1 --group by client                                           
    
 /****************************************/                                                  
                                                   
 update #NCMS_SegwiseCldata set AccruedCharges=-Accured,NetPayable=NetPayable-Accured                                                  
 from                                                  
 (                                                  
  select q.segment,q.party_code,                                                  
  (Case when q.entity='AllSegment' then DeductEQ else DeductComm end) as Accured                                                  
  from #Accrued p join                                                   
  (                                                  
  select x.*,y.segment from                                                  
  (                                                  
  select a.entity,party_Code,min(b.seqid) as seqid                                                  
  from #NCMS_SegwiseCldata a join ncms_entity b on a.segment=b.segment                                                   
  group by a.entity,party_Code                                                  
  ) x join ncms_entity y with(nolock) on x.seqid=y.seqid and x.entity=y.entity                                                  
  ) q on p.party_Code=q.party_Code                                                   
 ) AC                                                  
 where #NCMS_SegwiseCldata.party_code=AC.party_Code and #NCMS_SegwiseCldata.segment=AC.Segment                                                  
 and #NCMS_SegwiseCldata.segment <> 'NBFC'                                          
                                                   
    
  /* select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 into #Accrued from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code              
  
UPDATE a                                                          
  set AccruedCharges=AccruedCharges+b.DeductEQ,NetPayable=NetPayable+b.DeductEQ                                                               
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                                             
  (select party_code,DeductEQ=-DeductEQ from #Accrued with (nolock) ) b                                              
  ON a.party_code=b.party_Code         
  where a.Segment <> 'NBFC'   and a.Segment='NSECM'     */                                                 
                
                      
  /* BSECM & NSECM Zero for NBFC Clients */                                                      
                                  
  /*                                                             
  UPDATE a                                                          
  set NetPayable = 0,ShortSellValue=0,Balance=0                                              
  FROM #NCMS_SegwiseCldata a                           
  JOIN                                                          
  (select Party_code from risk.dbo.client_Details where cl_type in ('NBF','TMF')) b                                               
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                       
  */                              
                                
  /*---- Only unreco cheque amount of BSECM and NSECM should get deducted from NBFC Net payable */                              
  UPDATE a                                                          
  set NetPayable =  UnrecoAmt+AccruedCharges                                 
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                                                          
  (select Party_code from risk.dbo.client_Details with(nolock) where cl_type in ('NBF','TMF')) b                                        
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                       
                                                        
  /* Update Shortage Value */                                                      
/*                              
  UPDATE a          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
 FROM #NCMS_SegwiseCldata a                                               
  JOIN                                                          
  (select party_code,shrtval=sum(dedVal) from risk.dbo.Vw_CMSVerified_BSECM_ShrtVal group by party_Code having sum(dedVal) <> 0) b                 
  ON a.segment='BSECM' and a.party_code=b.party_Code                                                      
                                         
  UPDATE a                                                          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
  FROM #NCMS_SegwiseCldata a                       
  JOIN                                                          
  (select party_code,shrtval=sum(dedVal) from risk.dbo.Vw_CMSVerified_NSECM_ShrtVal group by party_Code  having sum(dedVal) <> 0) b                                                      
  ON a.segment='NSECM' and a.party_code=b.party_Code                                                      
*/                              
                           
/* Only BOD shortage is considered in verification */                              
/*                  
  UPDATE a                                                          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                      
  (                              
 select segment,party_code,Shrtval=ShortSellValue from NCMS_SegwiseCldata with (nolock)                              
 where (SEGMENT='BSECM' OR SEGMENT='NSECM') AND ShortSellValue <> 0                              
  ) B                               
  ON a.segment=B.SEGMENT and a.party_code=b.party_Code                                                       
*/                  
                    
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                                                      
(select seg+'CM' as seg,party_code,shrtval=SUM(NetShortValue) from ncms_shortsell with(nolock)                   
group by seg,party_Code having sum(NetShortValue) <> 0) b                        
 where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.party_Code                                                      
                    
/* Reduce LD Data */                    
 /*            
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.BSECM,NetPayable=NetPayable-b.BSECM                    
 from(                    
 select client_code,BSECM from NCMS_LD_View where BSECM > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSECM'                    
 */            
   /*********commented*******************************/   
   /*         
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSECM then 0 else (b.BSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSECM then 0 else (b.BSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,BSECM from NCMS_LD_View with(nolock) where BSECM > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSECM'              
             
 /*            
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSECM,NetPayable=NetPayable-b.NSECM                    
 from(                    
 select client_code,NSECM from NCMS_LD_View where NSECM > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSECM'                    
 */            
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSECM then 0 else (b.NSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSECM then 0 else (b.NSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSECM from NCMS_LD_View with(nolock) where NSECM > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSECM'              
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSEFO,NetPayable=NetPayable-b.NSEFO                    
 from(                    
 select client_code,NSEFO from NCMS_LD_View where NSEFO > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSEFO'                    
 */            
             
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSEFO then 0 else (b.NSEFO+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSEFO then 0 else (b.NSEFO+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSEFO from NCMS_LD_View with(nolock) where NSEFO > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSEFO'              
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.MCD,NetPayable=NetPayable-b.MCD                    
 from(                    
 select client_code,MCD from NCMS_LD_View where MCD > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCD'                    
 */            
             
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCD then 0 else (b.MCD+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCD then 0 else (b.MCD+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,MCD from NCMS_LD_View with(nolock) where MCD > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCD'              
             
               
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSX,NetPayable=NetPayable-b.NSX                    
 from(                    
 select client_code,NSX from NCMS_LD_View where NSX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSX'              
 */            
  update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSX then 0 else (b.NSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSX then 0 else (b.NSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSX from NCMS_LD_View with(nolock) where NSX > 0                   
 ) b             
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSX'                     
    
    
  update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSX then 0 else (b.BSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSX then 0 else (b.BSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,BSX from NCMS_LD_View with(nolock) where BSX > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSX'     
     
                   
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NCDEX,NetPayable=NetPayable-b.NCDEX                    
 from(                    
 select client_code,NCDEX from NCMS_LD_View where NCDEX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NCDEX'                    
*/                
                
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NCDEX then 0 else (b.NCDEX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NCDEX then 0 else (b.NCDEX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NCDEX from NCMS_LD_View with(nolock) where NCDEX > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NCDEX'                    
                    
                    
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCX then 0 else (b.MCX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCX then 0 else (b.MCX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,MCX from NCMS_LD_View with(nolock) where MCX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCX'   
 */                   
 /**********************************************/           
   
 /***********************Start****************************************/  
 /*********Margin added in cash segment as per mail of sajeevn sir on 01Aug 2020****************/  
  /*    
DECLARE @MARGINDATE AS DATETIME         
SELECT @MARGINDATE=MAX(MARGINDATE) FROM anand1.msajag.dbo.tbl_combine_reporting_detail WITH (NOLOCK)     
--select @MARGINDATE  
select margindate,exchange,segment,party_code,tday_margin,tday_mtm,tday_margin+tday_mtm as margin INTO #MARGIN from  
 anand1.msajag.dbo.tbl_combine_reporting_detail with(nolock) where MARGINDATE=@MARGINDATE AND exchange in ('BSE','NSE') and segment='CAPITAL'  
  
  
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.margin,NetPayable=NetPayable-b.margin from                                                
 (select party_code,margin,exchange+'CM' as segment from #MARGIN WITH (NOLOCK) where margin>0) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0    
  */  
    
  DECLARE @MARGINDATE AS DATETIME           
SELECT @MARGINDATE=MAX(MARGIN_DATE) FROM AngelNseCM.msajag.dbo.tbl_mg02 WITH (NOLOCK)   
  
  
select a.* into #mg02 from AngelNseCM.msajag.dbo.tbl_mg02 a with (nolock), NCMS_PO_Request_ForPayout b with(nolock)  
 where a.partY_code=b.Party_code and  MARGIN_DATE=@MARGINDATE   
  
select a.*,convert(money,varamt/abs(netqty)) as pershare,b.short_qty  into #data from #mg02 a with(nolock)  join ncms_shortsell b with(nolock) on a.party_code=b.PARTY_cODE and a.scrip_cd=b.SCRIP_CD    
 and a.sett_no=b.sett_no where /* a.party_code='A2649' and*/    
   --MARGIN_DATE=@MARGINDATE and  
    ABS(netqty)<>0    
    
    select convert(money,pershare*short_qty) as varmargin ,party_code,scrip_cd,sett_no into #margin from #data  
  
    
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.varmargin/*,NetPayable=NetPayable-b.varmargin*/  from                                                  
 (select 'NSECM' as segment,party_code,varmargin=SUM(varmargin) from #margin /* where party_code='A2649'*/  
 group by party_Code having sum(varmargin) <> 0) b                                                  
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0    
    
 /***********************End****************************************/    
  
   
  /*****************peakmargin from bo for NSE BSE MTF************************/  
 DECLARE @MARGINDATEpeak AS DATETIME   , @MARGINDATEpeakBSE AS DATETIME ,@MARGINDATEpeakMTF as Datetime           
/*set @MARGINDATEpeak=cast(CAST(getdate()-1 as date)as datetime)*/  
SELECT @MARGINDATEpeak=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='NSE' and SEGMENT='CAPITAL'  
SELECT @MARGINDATEpeakBSE=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='BSE' and SEGMENT='CAPITAL'  
SELECT @MARGINDATEpeakMTF=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='MTF' and SEGMENT='MTF'  
  
  
--select cltcode,UDebitV*-1 as UDebitV,'NSE' as exchange into #unSettDr from AngelNseCM.inhouse.dbo.NCMS_PO_UnsetDr with(nolock) where UDebitV<0  
  
if((CONVERT(VARCHAR(5),GETDATE(),108)>='16:30') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))      
Begin  
 /*Commented start on 30 Jan 2023 for removing Peak margin*/  
 /*if(select COUNT(1) from  cms.dbo.NCMS_PeackMargin with(nolock))=0  
 begin  
  
   select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeak  
    and EXCHANGE='NSE' and SEGMENT='CAPITAL' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month varchar(10),@peakVar money=1  
       
      select @month=convert(char(3), GETDATE(), 0)  
   --select @month  
   --if(@month='Dec' or @month='Jan' or @month='Feb')  
   --begin  
   -- set @peakVar=0.25   
   -- print @peakVar  
   --end   
   --if(@month='Mar' or @month='Apr' or @month='May')  
   --begin  
   -- set @peakVar=0.5   
   -- print @peakVar  
   --end  
   --if(@month='Jun' or @month='Jul' or @month='Aug')  
   --begin  
   -- set @peakVar=0.75   
   -- print @peakVar  
   --end  
   --if(@month='Sep' or @month='Oct' or @month='Nov')  
   --begin  
   -- set @peakVar=1   
   -- print @peakVar  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar*/ as peakMargin into #peakMr from #aa  
    
    
   /*******************************************/  
   select a.exchange,b.party_code,b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as FinalPeak  
                       into #peak from #unSettDr a right join #peakMr b   
   on a.cltcode=b.party_code  
   /*******************************************/  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.FinalPeak/*,NetPayable=NetPayable-b.FinalPeak*/ from                                                  
  (select 'NSECM'  as segment,party_code,FinalPeak from #peak) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
  /*****************BSE***********/  
 select cltcode,UDebitV*-1 as UDebitV,'BSE' as exchange into #unSettDrBSE from AngelBSECM.inhouse.dbo.NCMS_PO_UnsetDr with(nolock) where UDebitV<0  
  
  select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa1  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeakBSE  
    and EXCHANGE='BSE' and SEGMENT='CAPITAL' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month1 varchar(10),@peakVar1 money=1  
       
   --   select @month1=convert(char(3), GETDATE(), 0)  
    
   --if(@month1='Dec' or @month1='Jan' or @month1='Feb')  
   --begin  
   -- set @peakVar1=0.25   
   -- print @peakVar1  
   --end   
   --if(@month1='Mar' or @month1='Apr' or @month1='May')  
   --begin  
   -- set @peakVar1=0.5   
   -- print @peakVar1  
   --end  
   --if(@month1='Jun' or @month1='Jul' or @month1='Aug')  
   --begin  
   -- set @peakVar1=0.75   
   -- print @peakVar1  
   --end  
   --if(@month1='Sep' or @month1='Oct' or @month1='Nov')  
   --begin  
   -- set @peakVar1=1   
   -- print @peakVar1  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar1*/ as peakMargin into #peakMr1 from #aa1  
    
   /*******************************************/  
   select a.exchange,b.party_code,b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as FinalPeak  
                       into #peak1 from #unSettDrBSE a right join #peakMr1 b   
   on a.cltcode=b.party_code  
   /*******************************************/  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.FinalPeak,NetPayable=NetPayable-b.FinalPeak from                                                  
  (select 'BSECM'  as segment,party_code,FinalPeak from #peak1) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
   
  /*****************MTF***********/  
  select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa11  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeakMTF  
    and EXCHANGE='MTF' and SEGMENT='MTF' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month11 varchar(10),@peakVar11 money=1  
       
   --   select @month11=convert(char(3), GETDATE(), 0)  
    
   --if(@month11='Dec' or @month11='Jan' or @month11='Feb')  
   --begin  
   -- set @peakVar11=0.25   
   -- print @peakVar11  
   --end   
   --if(@month11='Mar' or @month11='Apr' or @month11='May')  
   --begin  
   -- set @peakVar11=0.5   
   -- print @peakVar11  
   --end  
   --if(@month11='Jun' or @month11='Jul' or @month11='Aug')  
   --begin  
   -- set @peakVar11=0.75   
   -- print @peakVar11  
   --end  
   --if(@month11='Sep' or @month11='Oct' or @month11='Nov')  
   --begin  
   -- set @peakVar11=1   
   -- print @peakVar11  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar11*/ as peakMargin into #peak11 from #aa11  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.peakMargin,NetPayable=NetPayable-b.peakMargin from                                                  
  (select EXCHANGE as segment,party_code,peakMargin from #peak11) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
  end  
  /**************************************/  
 else  
  begin  
  */ /*Commented end on 30 Jan 2023 for removing Peak margin*/  
  /********For adding peak maegin********************/  
   /* select client_code,bsecm+nsecm+nsefo+Mcx+ncdex+nsx+mcd as LDAmt into #ee from [NCMS_LD_View]*/--comented on 22 July 2022  
    select Client_code,BSECMMargin+NSECMMargin+NSEFOMargin+MCXMargin+NCDEXMargin+NSXMargin+MCDMargin+BSXMargin as LDAmt into #ee from [NCMS_LD_MTM_Margin_view] with(nolock)  
     
 /*    declare @monthFile varchar(10),@peakVarFile money=1  
       
    SELECT [client code],total*@peakVarFile as peakMargin into #PEakFile FROM NCMS_PeackMargin   
     
    select a.exchange,b.[client code],b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as total  
                       into #PEakFileMain from #unSettDr a right join #PEakFile b   
    on a.cltcode=b.[client code]     
     
   SELECT [client code], MAX(total) as total  
   into #PeckMargin FROM  
   (  
    SELECT [client code], MAX(total) as total  
    FROM #PEakFileMain   
    GROUP BY [client code]  
    UNION ALL  
    SELECT client_code, MAX(LDAmt) as LDAmt  
    FROM #ee   
    GROUP BY client_code  
   ) as subQuery  
   GROUP BY [client code]  
*/  
   SELECT [client code], MAX(total) as total  
   into #LDMargin FROM  
   (  
    SELECT client_code as [client code], MAX(LDAmt) as total  
    FROM #ee   
    GROUP BY client_code  
   ) as subQuery  
   GROUP BY [client code]  
                
    update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.total/*OtherDebit=OtherDebit-b.total              */  
    /*,NetPayable=NetPayable-b.total */             
    from(                    
    select 'NSECM' as segment,[client code],total from #LDMargin with(nolock) where [client code] is not null and total<>0               
    ) b                     
    where #NCMS_SegwiseCldata.Party_code=b.[client code] and  #NCMS_SegwiseCldata.segment=b.segment                     
                    
  --end      
   
 end  
 /**************************/      
   
 /*******************added on 10 Mar 2021 for adding unsetteld Holding***************************************************/  
 declare @NONCASHconsideration as int = 100   
   
  update #NCMS_SegwiseCldata set NonCashConsideration=@NONCASHconsideration where Segment='NSECM'          
  
--select a.* into #NCMS_ROI from NCMS_ROI a with(nolock), NCMS_PO_Request_ForPayout b with(nolock)  
-- where a.partY_code=b.Party_code        
  
-- update #NCMS_SegwiseCldata set NonCashConsideration=b.CollateralPercent          
-- from #NCMS_ROI b  WITH (NOLOCK)   where #NCMS_SegwiseCldata.party_code=b.party_code  and  #NCMS_SegwiseCldata.Segment='NSECM'          
  
select * into #Vw_Todays_Secpayout from  AngelDEMAT.MSAJAG.dbo.Vw_Todays_Secpayout  with(nolock) where  
Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,  
CONVERT(MONEY, 0) as Value_BHC_unsett,  
CONVERT(MONEY, 0) as Value_AHC_unsett  
  into #unsett_holding from /*[196.1.115.197].msajag.dbo.unclear_hold*/ #Vw_Todays_Secpayout a with(nolock) join  
 [CSOKYC-6].GENERAL.DBO.Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/  
a.I_isin=b.security_isin join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.I_isin=c.[isin no]  
where a.party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
update #unsett_holding set Value_BHC_unsett=qty*MTM_Price_unsett  
update #unsett_holding set Value_AHC_unsett=isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)  
  
select SUM(Value_AHC_unsett) as Value_AHC_unsett,party_code into #holding_AHC from #unsett_holding group by party_code  
  
update #NCMS_SegwiseCldata set noncashcoll=Value_AHC_unsett from                            
 (select party_code,Value_AHC_unsett from #holding_AHC) b                                                  
 where #NCMS_SegwiseCldata.segment='NSECM' and #NCMS_SegwiseCldata.party_code=b.party_Code   
   
 -- alter table #NCMS_SegwiseCldata add marginAdjustWithLgr money   
   
 --update #NCMS_SegwiseCldata set marginAdjustWithLgr=0.00  
     
   ALTER TABLE #NCMS_SegwiseCldata ADD marginAdjustWithLgr money NOT NULL DEFAULT 0  
   
 update #NCMS_SegwiseCldata set ExpoUtilised=ExpoUtilised+  
 (case     
 when  noncashcoll=0 then   MarginAmt     
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0         
 then 0           
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll   
 end) ,  
 marginAdjustWithLgr=isnull(marginAdjustWithLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3  
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  
 from #NCMS_SegwiseCldata where segment='NSECM' -- and  party_code='D65765'  
   
   
update #NCMS_SegwiseCldata set NetPayable=NetPayable+ExpoUtilised+marginAdjustWithLgr  where segment='NSECM'   
       
 /*For reducing Bond value change done by Neha on 16 Jul2016*/    
 select client_code,Segment,Total into #bond_client from BondEntry with(nolock)     
     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.Total,NetPayable=NetPayable-b.Total                          
 from(                    
 select * from #bond_client    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment=b.segment      
     
     
      
 update a set POblocked=GETDATE() from BondEntry a,    
 (select * from #bond_client)b where    
 a.client_code=b.client_code     
     
     
 update a set Flexiblocked=b.Flexiblocked,POblocked=b.POblocked from bond.dbo.tbl_BondOrderEntry a with(nolock),    
 (select * from BondEntry with(nolock))b where    
 a.client_code=b.client_code and a.order_Status='PENDING'    
 and a.Verfiedon is null and a.POblocked is null                
    
    
    
    
  /*---------------------------------------------------------*/                   
    
    
 /*For Reducing mf pending orders in Payout*/    
    
DECLARE @Days VARCHAR(20)                          
                          
 SET @Days = (                          
   SELECT DATENAME(dw, GETDATE())                          
   )     
  
 /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF       
                            
IF (@Days = 'Monday' OR @Days = 'Saturday')                          
BEGIN         
    
 --select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund_sat from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)    
 --where cltcode     
 --in     
 --(select clientcode from risk.dbo.vw_MutualFundPendingOrder_NCMS_sat with(nolock)    where segment in ('MF','Trade' ))    
 --and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)      
 --and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 --group by cltcode    
    
 /*    
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal     
 from #MFFund m inner join    
risk.dbo.vw_MutualFundPendingOrder_NCMS o    
 on m.cltcode=o.clientcode    
 where balance<=0    
 group by m.cltcode,m.balance    
 */    
    
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal_sat       
 from     
 risk.dbo.vw_MutualFundPendingOrder_NCMS_sat o  with(nolock)   ,NCMS_PO_Request_ForPayout b where o.clientcode=b.Party_code   
 group by clientcode    
    
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)    
 select cltcode,amount,getdate() from #MFFundFinal_sat    
    
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),   
 a.*,b.amount into #segmentwise_pendingorders_sat    
 from    
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')    
 and NetPayable>0)a    
 inner join  (select cltcode,amount from #MFFundFinal_sat) b    
 on a.party_code=b.cltcode;    
    
 with cte    
 as    
 (    
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,    
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,    
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end    
  from #segmentwise_pendingorders_sat where srno=1 --and party_code='AACW016'    
  union all    
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,    
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,    
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end    
  from #segmentwise_pendingorders_sat a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'    
 )    
 select * into #mf_segamountadjust_sat from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)    
    
    
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                       
  (                    
 select * from #mf_segamountadjust_sat    
  ) b                     
  where a.Party_code=b.party_code and a.Segment=b.segment     
    
 drop table #mf_segamountadjust_sat    
 drop table #segmentwise_pendingorders_sat    
 drop table #MFFundFinal_sat    
end    
else    
begin    
 --select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)    
 --where cltcode     
 --in     
 --(select clientcode from risk.dbo.vw_MutualFundPendingOrder_NCMS with(nolock)    where segment in ('MF','Trade' ))    
 --and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)      
 --and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 --group by cltcode    
    
 /*    
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal     
 from #MFFund m inner join    
 risk.dbo.vw_MutualFundPendingOrder_NCMS o    
 on m.cltcode=o.clientcode    
 where balance<=0    
 group by m.cltcode,m.balance    
 */    
    
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal       
 from     
 risk.dbo.vw_MutualFundPendingOrder_NCMS o with(nolock)    ,NCMS_PO_Request_ForPayout b where o.clientcode=b.Party_code   
 group by clientcode    
    
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)    
 select cltcode,amount,getdate() from #MFFundFinal    
    
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),    
 a.*,b.amount into #segmentwise_pendingorders    
 from    
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')    
 and NetPayable>0)a    
 inner join  (select cltcode,amount from #MFFundFinal) b    
 on a.party_code=b.cltcode;    
    
 with cte    
 as    
 (    
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,    
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,    
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end    
  from #segmentwise_pendingorders where srno=1 --and party_code='AACW016'    
  union all    
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,    
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,    
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end    
  from #segmentwise_pendingorders a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'    
 )    
 select * into #mf_segamountadjust from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)    
    
    
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                       
  (                    
 select * from #mf_segamountadjust    
  ) b                     
  where a.Party_code=b.party_code and a.Segment=b.segment     
     
 drop table #mf_segamountadjust    
 drop table #segmentwise_pendingorders    
 drop table #MFFundFinal    
end    
    
   */  
     
     
 /*************************************************************************************/    
     
 /*For Reducing BSE Orders added on 05 May 2017*/    
              
 IF (@Days = 'Monday')                          
 BEGIN     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                      
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE_sat with(nolock)                   
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                        
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode      
 end     
else    
begin     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                      
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE  with(nolock)                  
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                        
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode      
 end    
 /*---------------------------------------------------------*/       
 /*****Start************For reducing Bills of BSE NSE*************************************************************************/  
DECLARE @billdate AS DATE   
SELECT  @billdate=getdate()  
  
   
if(SELECT COUNT(1) FROM angelnsecm.msajag.dbo.TBL_CASH_PROCESS_LOG WITH (NOLOCK) WHERE BUSINESS_DATE = @billdate AND PROCESS_NAME = 'PRNETTOTAL_RTB'  
AND PROCESS_FLAG = 1)=1  
BEGIN  
  
 insert into NCMS_RTB_log  
 select *,getdate() from angelnsecm.msajag.dbo.PRNETTOTAL_RTB WITH (NOLOCK) WHERE TRADEDATE= @billdate  
  
 SELECT PARTY_CODE,SEGMENT,PAY_IN_PAY_OUT_OBLIGATION into #rtb FROM angelnsecm.msajag.dbo.PRNETTOTAL_RTB WITH (NOLOCK) WHERE   
 TRADEDATE= @billdate  
 select party_code,sum(pay_in_pay_out_obligation) billamount into #club1 from   #rtb group by party_code  
  
  update #NCMS_SegwiseCldata set OtherDebit=isnull(OtherDebit,0)-b.billamount,NetPayable=NetPayable-b.billamount                          
  from(                    
  select distinct billamount*-1 as billamount,PARTY_CODE from #club1 with(nolock)   where billamount<0  
  ) b                     
  where #NCMS_SegwiseCldata.Party_code=b.PARTY_CODE and #NCMS_SegwiseCldata.segment='NSECM'   
  
END  
else  
BEGIN  
 if(select PROCESS_STATUS from AngelNseCM.msajag.dbo.TBL_AUTO_PROCESS_DETAIL with(nolock) where Business_Date=@billdate and PROCESS_FOR ='POSTBILL'  
 and sett_type='M')=0  
 begin  
 if(select PROCESS_STATUS from AngelNseCM.msajag.dbo.TBL_AUTO_PROCESS_DETAIL with(nolock) where Business_Date=@billdate and PROCESS_FOR ='POSTBILL'  
 and sett_type='Z')=0  
 begin  
 if(select posting from AngelNseCM.msajag.dbo.V2_Business_Process with(nolock) where Business_Date=@billdate and sett_type ='M' )=0  
 begin  
 if(select posting from AngelNseCM.msajag.dbo.V2_Business_Process with(nolock) where Business_Date=@billdate and sett_type='Z' )=0  
 begin  
  
   insert into BseCmbillGendata_log  
   select *,getdate() from Mimansa.Clientservice.dbo.BseCmbillGendata with(nolock)  
  
   insert into NseCmbillGendata_log  
   select *,getdate() from Mimansa.Clientservice.dbo.NseCmbillGendata with(nolock)  
  
     select *,AMOUNT+Brokerage+SERVICE_TAX+TURN_TAX+SEBI_TAX+INS_CHRG+BROKER_CHRG as BillAmount  
  into #erNewn  from Mimansa.clientservice.dbo.NseCmbillGendata with(nolock) --where amount>0  
  where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
     select *,AMOUNT+Brokerage+SERVICE_TAX+TURN_TAX+SEBI_TAX+INS_CHRG+BROKER_CHRG as BillAmount  
   into #er1Newn from  Mimansa.Clientservice.dbo.BseCmbillGendata with(nolock)-- where amount>0  
  where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
    update #erNewn  set billamount=case when billamount<0 then billamount*-1 when billamount>0 then billamount*-1 end   
    update #er1Newn  set billamount=case when billamount<0 then billamount*-1 when billamount>0 then billamount*-1 end   
  
  
   select x.party_code,sum(billamount) as billamount into #club from  
   (select party_code,billamount from #erNewn  
   union all  
   select party_code,billamount from #er1Newn)x  group by party_code    
  
   update #NCMS_SegwiseCldata set OtherDebit=isnull(OtherDebit,0)-b.billamount,NetPayable=NetPayable-b.billamount                          
   from(                    
   select distinct billamount*-1 as billamount,PARTY_CODE from #club with(nolock)   where billamount<0  
   ) b                     
   where #NCMS_SegwiseCldata.Party_code=b.PARTY_CODE and #NCMS_SegwiseCldata.segment='NSECM'  /*#NCMS_SegwiseCldata.Segment='NSEFO'     */  
  end  
  end  
  end  
  end  
END  
  
 /*****End****************************************************************************/     
     
/******Start*********************For Deducting Brokerage charges*************************/    
 select distinct Brokerage+Gst+STT+TurnoverCharges+SebiFees+StampDuty as brokerage,PARTY_CODE,segment into #NSECM_Brokerage from NCMS_BrokerageCharges with(nolock)   
 where segment not in ('BSECM','NSECM')  
  
 select party_code,sum(brokerage) as brokerage into #New_brokerage from #NSECM_Brokerage group by party_code  
  
 update a set OtherDebit=isnull(OtherDebit,0)-b.brokerage,NetPayable=NetPayable-b.brokerage                          
 from #NCMS_SegwiseCldata a,(                    
 select party_code,brokerage from #New_brokerage  
 ) b                     
 where a.Party_code=b.PARTY_CODE and a.segment='NSECM' /*#NCMS_SegwiseCldata.segment=b.segment*/ /*#NCMS_SegwiseCldata.Segment='NSEFO'     */  
     
 /*****End****************************************************************************/     
     
   /*update net basis of Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/  
   
  update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.loss ,OtherDebit=isnull(OtherDebit,0)-b.loss from                                                
 (select party_code,loss,exchange+'CM' as segment from NCMS_Intraday_loss with(nolock)) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0 and NetPayable>0   
   
/***********************************************************************************/  
     
  /*********************Added on 30 may 2022 for removing SIP**************************************************************/  
  /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF       
  
select sclientcode,sactualduedate,sum(convert(money,sInstallmentAmt)) as sInstallmentAmt,'BSEMFSS' as segment into #sum FROM   
[196.1.115.253].MutualFund.dbo.vw_sip_installments with(nolock)  
group by sclientcode,sactualduedate     
  
 update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.sInstallmentAmt ,OtherDebit=OtherDebit-b.sInstallmentAmt from                                                
 (select * from #sum with(nolock)) b                    
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.sclientcode  
*/  
  /**********************************************************************************/   
 /***********************for Adding Delivery Margin Added on 14 Jun 2019 By Neha Naiwar ************************************/    
--DECLARE @MARGINDATE AS DATETIME,@sdtcur as datetime             
--SELECT @MARGINDATE=MAX(MARGINDATE) FROM angelfo.NSEFO.dbo.tbl_clientmargin WITH (NOLOCK)       
    
--SELECT * into #delmargin FROM Angelfo.NSEFo.dbo.FOMARGINNEW with(nolock) WHERE  MDATE =@MARGINDATE/*convert(datetime,convert(varchar(8),getdate(),112))*/    
--AND DEL_MARGIN <>0    
    
--  UPDATE a                                                            
--  set MarginAmt =  MarginAmt-DEL_MARGIN                         
--  FROM #NCMS_SegwiseCldata a                                                 
--  JOIN                                                            
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                          
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'      
      
--  UPDATE a                                                            
--  set NetPayable =  NetPayable-DEL_MARGIN                         
--  FROM #NCMS_SegwiseCldata a                                                 
--  JOIN                                                            
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                          
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'       
/*************************************************************************************/    
     
               
  truncate table NCMS_SegVeriData                          
  insert into NCMS_SegVeriData                                            
  (                                            
  POrequestID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,                                            
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                          
  )                                              
  select   /*ROW_NUMBER() OVER ( ORDER BY party_code,segment) AS refno,*/                            
  convert(varchar(6),getdate(),112)+replace(convert(varchar(8),getdate(),108),':','') AS refno,                            
  ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,isnull(OtherDebit,0),NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                             
  from #NCMS_SegwiseCldata                                               
    
  /*******************************************************Added for combine margin****/  
  select * into #new_NCMS_SegwiseCldata from #NCMS_SegwiseCldata with(nolock) where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
    
  update #new_NCMS_SegwiseCldata set Balance=0.00,UnsettledCrBill=0.00 where NetPayable=0 and Segment='BSEMFSS'  
  update #new_NCMS_SegwiseCldata  set UnsettledCrBill=0.00 where  Segment='BSEMFSS'  and  NetPayable>0  and UnsettledCrBill<0  
  
update  #new_NCMS_SegwiseCldata set Balance=NetPayable where Balance=0 and AccruedCharges=0 and marginamt=0 and segment='bsemfss' and NetPayable<0  
    
 select max(ProcessDate) ProcessDate,Entity,Party_code,Flag,sum(Balance)Balance,sum(UnsettledCrBill) UnsettledCrBill,sum(UnrecoAmt) UnrecoAmt,    
 sum(ShortSellValue) ShortSellValue,sum(MarginAmt) MarginAmt,SUM(deposit) Deposit,sum(CashColl)CashColl,sum(NonCashColl) NonCashColl,    
 sum(MarginAdjWithColl) MarginAdjWithColl,sum(MarginShortage) MarginShortage,sum(AccruedCharges) AccruedCharges,sum(OtherDebit) OtherDebit,    
 max(100) NonCashConsideration--,SUM(ExpoUtilised) as ExpoUtilised,sum(NetPayable) NetPayable  
 ,case when entity='AllSegment' then 0.00 else SUM(ExpoUtilised) end as ExpoUtilised,  
 case when entity='AllSegment' then 0.00 else sum(NetPayable) end NetPayable  
 into #ncms    
 from  #new_NCMS_SegwiseCldata  /*where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))*/  
 group by Entity,Party_code,Flag    
   
 --  update #ncms set NonCashConsideration=100.00 --from #ncms     /*added on 08 Oct 2021 by Neha naiwar*/  
  
 -- /*alter table #ncms add marginAdjustWithCombineLgr money */  /*added on 08 Oct 2021 by Neha naiwar*/  
     
 --update #ncms set /*marginAdjustWithCombineLgr=0.00 ,*/ExpoUtilised=0.00 ,NetPayable=0.00 where entity='AllSegment'  
     
 update #ncms set ExpoUtilised=ExpoUtilised+    
 (case       
 when  noncashcoll=0 then   MarginAmt       
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0           
 then 0             
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll     
 end)     
 /*,marginAdjustWithCombineLgr=isnull(marginAdjustWithCombineLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3    
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  */   /*added on 08 Oct 2021 by Neha naiwar*/  
 from #ncms where entity='AllSegment'  
   
 update #ncms set NetPayable=Balance+ExpoUtilised+/*marginAdjustWithCombineLgr+*/UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges+OtherDebit   
  where entity='AllSegment'  
  
/***Added on 22 July 2022************************/  
--select Client_code,BSECMMTM+NSECMMTM+NSEFOMTM+MCXMTM+NCDEXMTM+NSXMTM+MCDMTM+BSXMTM as LDAmtMTM into #LDMTM from [NCMS_LD_MTM_Margin_view]  
if(SELECT COUNT(1) FROM angelnsecm.msajag.dbo.TBL_CASH_PROCESS_LOG WITH (NOLOCK) WHERE BUSINESS_DATE = @billdate AND PROCESS_NAME = 'PRNETTOTAL_RTB'    
AND PROCESS_FLAG = 1)=1    
BEGIN    
select Client_code,NSEFOMTM+MCXMTM+NCDEXMTM+NSXMTM+MCDMTM+BSXMTM as LDAmtMTM into #LDMTMwithRTB from [NCMS_LD_MTM_Margin_view]    
update a set NetPayable=NetPayable-LDAmtMTM from #ncms a join #LDMTMwithRTB b on a.party_code=b.Client_code  
  where entity='AllSegment' and LDAmtMTM<>0  
  
 update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from #ncms a left join #LDMTMwithRTB b on a.party_code=b.Client_code  
  where entity='AllSegment' and LDAmtMTM<>0  
/*********************************/  
 update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from NCMS_SegVeriData a , #LDMTMwithRTB b where a.party_code=b.Client_code    
  and segment='NSECM' and LDAmtMTM<>0    
end  
else  
begin  
select Client_code,BSECMMTM+NSECMMTM+NSEFOMTM+MCXMTM+NCDEXMTM+NSXMTM+MCDMTM+BSXMTM as LDAmtMTM into #LDMTM from [NCMS_LD_MTM_Margin_view]    
  
update a set NetPayable=NetPayable-LDAmtMTM from #ncms a join #LDMTM b on a.party_code=b.Client_code  
  where entity='AllSegment' and LDAmtMTM<>0  
  
 update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from #ncms a left join #LDMTM b on a.party_code=b.Client_code  
  where entity='AllSegment' and LDAmtMTM<>0  
/*********************************/  
  
 update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from NCMS_SegVeriData a , #LDMTM b where a.party_code=b.Client_code    
  and segment='NSECM' and LDAmtMTM<>0    
end  
  
-- update a set NetPayable=NetPayable-LDAmtMTM from #ncms a join #LDMTM b on a.party_code=b.Client_code  
--  where entity='AllSegment' and LDAmtMTM<>0  
  
-- update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from #ncms a left join #LDMTM b on a.party_code=b.Client_code  
--  where entity='AllSegment' and LDAmtMTM<>0  
--/*********************************/  
  
-- update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from NCMS_SegVeriData a , #LDMTM b where a.party_code=b.Client_code    
--  and segment='NSECM' and LDAmtMTM<>0    
  
/***Added on 08 Aug 2022 for adjusting Ad-hoc margin values************************/  
  select a.party_code,(amt*-1) as amt into #adhocdata from risk.dbo.tbl_Omne_CM_MarginData a with(nolock)  ,NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
  
  update a set amt=amount from #adhocdata a join NCMS_tbl_AdhocMargin b on a.party_code=b.party_code   
  
  insert into NCMS_Adhoc_final_hist  
 select *,GETDATE() from NCMS_Adhoc_final  
  
 truncate table NCMS_Adhoc_final  
   
 insert into NCMS_Adhoc_final  
 select * from #adhocdata  
  
  truncate table NCMS_tbl_AdhocMargin  
if( DATEPART(DW,GETDATE())>6 and DATEPART(DW,GETDATE())<=7)    
begin  
 truncate table NCMS_Adhoc_final  
end  
select * into #adhoc from NCMS_Adhoc_final with(nolock) where amt<>0  
   
 update a set NetPayable=NetPayable+Amt,OtherDebit=isnull(OtherDebit,0)+Amt from #ncms a join #adhoc b on a.party_code=b.party_code  
  where entity='AllSegment'  
  
   update a set OtherDebit=isnull(OtherDebit,0)+Amt from NCMS_SegVeriData a join #adhoc b on a.party_code=b.party_code  
  where segment='NSECM'  
  /*******************************************/  
  
truncate table NCMS_CombineVeriData  
 insert into NCMS_CombineVeriData                                            
  (                                            
  POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,                                            
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                          
  )                                              
  select   /*ROW_NUMBER() OVER ( ORDER BY party_code,segment) AS refno,*/                            
  convert(varchar(6),getdate(),112)+replace(convert(varchar(8),getdate(),108),':','') AS refno,                            
  ProcessDate,Entity,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                             
  from #ncms    
    
  insert into NCMS_CombineVeriData_hist  
  (  
  POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,  
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,updatedOn  
  )   
  select POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,  
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,GETDATE() from NCMS_CombineVeriData  
         
/* For checking duplicate Account no.*/                      
                          
  declare @StatusJob varchar(20)                               
  set @StatusJob=''             
  exec CMS.dbo.Get_JoBStatus 'NCMS Double Entry in ACC no',@StatusJob  output                               
  print @StatusJob                      
                      
                      
  if(@StatusJob='In Progress')                                
   print 'job is already running'                            
  else                        
   EXEC msdb.dbo.sp_start_job 'NCMS Double Entry in ACC no'   
  
   
/* For Verify process*/                      
if(select flag from ncms_batch_process with(nolock) where Srno=15)=1  
Begin                           
  declare @StatusJobVerify varchar(20)                               
  set @StatusJobVerify=''             
  exec CMS.dbo.Get_JoBStatus 'NCMS Verifier Step',@StatusJobVerify  output                               
  print @StatusJobVerify                      
                      
                      
  if(@StatusJobVerify='In Progress')                                
   print 'job is already running'                            
  else                     
   EXEC msdb.dbo.sp_start_job 'NCMS Verifier Step'   
End   
 /*         
 insert into NCMS_SegVeriData_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                      
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                      
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                      
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                      
 from NCMS_SegVeriData with (nolock)              
 */        
                                               
  /* exec NCMS_UPD_ReqVerId @pcode,@refno      */                                
                                            
--End try                       
                                                
--BEGIN CATCH                                                        
                                                    
--  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                              
--  select GETDATE(),'NCMS_VeriData_Batchwise',ERROR_LINE(),ERROR_MESSAGE()                                                              
                                
-- DECLARE @ErrorMessage NVARCHAR(4000);                                                              
-- SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                              
-- RAISERROR (@ErrorMessage , 16, 1);                                    
                                                     
--End catch                                                    
                                                      
--Set nocount off   
  
end  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_VeriData_Batchwise_08Sep2023
-- --------------------------------------------------
create PROCEDURE [dbo].[NCMS_VeriData_Batchwise_08Sep2023]                                
as                                                      
  /* FETCH DATA */    
if(select flag from ncms_batch_process with(nolock) where Srno=15)=1  
Begin   
  begin  
                                                      
   Create table #NCMS_SegwiseCldata (                                                          
   id int,                                              
   ProcessDate datetime,                                              
   Entity varchar(10),                                              
   Segment varchar(10),                                              
   Party_code varchar(10),                                              
   Flag char(1),                                              
   Balance money,                                              
   UnsettledCrBill money,                                              
   UnrecoAmt money,                                              
   ShortSellValue money,                                              
   MarginAmt money,                                              
   Deposit money,                                              
   CashColl money,                                              
   NonCashColl money,                                              
   MarginAdjWithColl money,                                              
   MarginShortage money,                                              
   AccruedCharges money,                                              
   OtherDebit money,                                              
   NonCashConsideration money,                                              
   ExpoUtilised money,                                              
   UnPosted_PO money,                   
   NetPayable money                                          
   )                                                                                                             
                                                
                          
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime,'AllSegment','BSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                       
  from AngelBSECM.inhouse.dbo.NCMS_PO  with(nolock)                                                   
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','NSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                       
  from AngelNseCM.inhouse.dbo.NCMS_PO  with(nolock)                                                        
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                  
select ProcessDatetime,'AllSegment','MTF',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                   
 from AngelNseCM.MTFTRADE.dbo.NCMS_PO  with(nolock)      
                                                         
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelfo.inhouse.dbo.NCMS_marh  with(nolock)                                                        
  /* and PayoutValue <> 0*/     
    
  /******BSEFO***************/  
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','BSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.BSEFO.dbo.NCMS_marh  with(nolock)    
  /*********************/  
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelfo.inhouse_curfo.dbo.NCMS_marh  with(nolock)               
  /* and PayoutValue <> 0*/                                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','MCD',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.INHOUSE_MCDCS.dbo.NCMS_marh  with(nolock)                                                        
  /* and PayoutValue <> 0*/                                                      
    
     
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                 
 select UpdDatetime,'AllSegment','BSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                   
 from angelcommodity.inhouse_bsx.dbo.NCMS_marh  with(nolock)      
                                                         
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NCDEX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.inhouse_NCDX.dbo.NCMS_marh   with(nolock)                                                       
/* and PayoutValue <> 0*/                                                     
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','MCX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.inhouse_MCDX.dbo.NCMS_marh   with(nolock)                                                       
  /* and PayoutValue <> 0*/                                                     
                       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','BSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,AfterAdjustedBal/*VBal+UCV+UnRecoCr+OtherDr */          
 from /*angelfo.inhouse.dbo.NCMS_PO_BSEMFSS*/   angelfo.inhouse.dbo.NCMS_PO_BSEMFSS_edt with(nolock)    
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','NSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                 
  from angelfo.inhouse.dbo.NCMS_PO_NSEMFSS with(nolock)                                                         
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                    
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','IPO',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                           
  from NCMS_PO_IPO with(nolock)                                                        
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                              
  /*                           
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select processDate,'NBFC','NBFC',party_Code,'I',LogicalLedger,Unsettled,0,ShortValHC,0,0,0,VAHC,0,0,AccruedInt,ShortVal,0,0,NetAmount                                                   
from [172.31.16.57].inhouse.dbo.ncms_po /* and netAmount <> 0 */                                    
  */                              
                                
  /* NBFC verification not required. verification is based on BOD processed data */                              
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                              
  select                               
  ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                              
  from NCMS_SegwiseCldata with (nolock) where entity='NBFC'                              
      
    /************************************************************************************************************************************************/     
/************************************************************************************************************************************************/     
    /*Changed in order to consider MTM of cases where there is no ledger added by Neha Naiwar on suggestion from Bhavin Parikh dt: 23th June 2016*/         
     select * into #LD from NCMS_LD_View a with(nolock) ,NCMS_PO_Request_ForPayout b  where a.client_code=b.Party_code  
     
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where BSECM > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSECM' ) and isnull(client_code,'')<>''    
      
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where NSECM > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSECM' ) and isnull(client_code,'')<>''    
       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSEFO',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where NSEFO > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSEFO' ) and isnull(client_code,'')<>''                           
       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)   where NSX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSX' ) and isnull(client_code,'')<>''                                                       
     
   insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCD',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)   where MCD > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCD' ) and isnull(client_code,'')<>''     
     
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)  where BSX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSX' ) and isnull(client_code,'')<>''     
     
     insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NCDEX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock) where NCDEX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NCDEX' ) and isnull(client_code,'')<>''     
     
      insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock) where MCX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCX' ) and isnull(client_code,'')<>''    
    
/************************************************************************************************************************************************/    
/**********************Adding NSECM Clients if not exist*********************************/  
 /*suggestion*/  
 /*insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)     
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSECM',cltcode=Cl_Code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,  
  0,0,0,OtherDr=0,0,0,0                                                       
  from [196.1.115.196].msajag.dbo.client_brok_details a with(nolock) where  isnull(Deactive_value,'') not in ('T','C') and exchange='NSE' and segment='CAPITAL'   
    and not exists    
 (select * from #NCMS_SegwiseCldata b where a.Cl_Code=b.party_code and segment='NSECM' ) and isnull(Cl_Code,'')<>''   
 --and exists (select distinct Party_code from NCMS_PO_Request_ForPayout c with(nolock) where a.cl_code=c.Party_code)  
 */  
/************************************************************************************************************************************************/     
  /* Accrured Charges */                                                  
                                                                                      
 --select a.party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                     
 --from /*misc.dbo.Accrued_PenalCharges*/ NCMS_Accrued_PenalCharges a with (nolock) ,NCMS_PO_Request_ForPayout b  where a.party_code=b.Party_code   
 --group by a.party_code     
   
 select a.PARTY_CODE,(OTHER_DEBIT*-1) as OTHER_DEBIT into #AccCharges from tbl_other_debit a with (nolock) ,NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
  
 select a.PARTY_CODE,DeductEQ=sum(a.OTHER_DEBIT),DeductComm=0.00 into #Accrued1  
 from #AccCharges a with (nolock)-- ,NCMS_PO_Request_ForPayout b  where a.client=b.Party_code   
 group by a.PARTY_CODE     
     
 /******added new margin peneality charges on 05 Jul 2021***********************************/    
 --insert into #Accrued1    
 -- select a.party_code,DeductEQ=SUM(Value_amt),DeductComm=0.00 from [196.1.115.182].General.dbo.tbl_EarlyPayin_Charges a with(nolock)  
 -- ,NCMS_PO_Request_ForPayout b  where a.party_code=b.Party_code group by a.party_code  
  
 --insert into #Accrued1    
 -- select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code              
   
   
 insert into  #Accrued1  
 select a.party_code,DeductEQ=Balance,DeductComm=0.00 from  NCMS_WO_Master a with(nolock),NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
 /*Added for W/O Margin on 16 Nov 2021*/          
   
   
--insert into  #Accrued1  
--SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM anand1.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)  
--where cnt_Date=(select max(cnt_Date) from anand1.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))  
--group by cltcode  
  
--insert into  #Accrued1  
--SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM anand1.MSAJAG.DBO.JVPNC_LOG J (Nolock),anand1.MSAJAG.DBO.client_details c(Nolock)  
--where  PCN_Date=(select max(PCN_Date) from anand1.MSAJAG.DBO.JVPNC_LOG J (Nolock))  
-- and J.cl_code=c.cl_code  
--group by J.cl_code   
  
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                           
    
 --select client as party_code,DeductEQ*-1 as DeductEQ ,DeductComm as DeductComm into #Accrued from #Accrued1 --group by client                                           
    
 /****************************************/                                                  
                                                   
 update #NCMS_SegwiseCldata set AccruedCharges=-Accured,NetPayable=NetPayable-Accured                                                  
 from                                                  
 (                                                  
  select q.segment,q.party_code,                                                  
  (Case when q.entity='AllSegment' then DeductEQ else DeductComm end) as Accured                                                  
  from #Accrued p join                                                   
  (                                                  
  select x.*,y.segment from                                                  
  (                                                  
  select a.entity,party_Code,min(b.seqid) as seqid                                                  
  from #NCMS_SegwiseCldata a join ncms_entity b on a.segment=b.segment                                                   
  group by a.entity,party_Code                                                  
  ) x join ncms_entity y with(nolock) on x.seqid=y.seqid and x.entity=y.entity                                                  
  ) q on p.party_Code=q.party_Code                                                   
 ) AC                                                  
 where #NCMS_SegwiseCldata.party_code=AC.party_Code and #NCMS_SegwiseCldata.segment=AC.Segment                                                  
 and #NCMS_SegwiseCldata.segment <> 'NBFC'                                          
                                                   
    
  /* select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 into #Accrued from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code              
  
UPDATE a                                                          
  set AccruedCharges=AccruedCharges+b.DeductEQ,NetPayable=NetPayable+b.DeductEQ                                                               
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                                             
  (select party_code,DeductEQ=-DeductEQ from #Accrued with (nolock) ) b                                              
  ON a.party_code=b.party_Code         
  where a.Segment <> 'NBFC'   and a.Segment='NSECM'     */                                                 
                
                      
  /* BSECM & NSECM Zero for NBFC Clients */                                                      
                                  
  /*                                                             
  UPDATE a                                                          
  set NetPayable = 0,ShortSellValue=0,Balance=0                                              
  FROM #NCMS_SegwiseCldata a                           
  JOIN                                                          
  (select Party_code from risk.dbo.client_Details where cl_type in ('NBF','TMF')) b                                               
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                       
  */                              
                                
  /*---- Only unreco cheque amount of BSECM and NSECM should get deducted from NBFC Net payable */                              
  UPDATE a                                                          
  set NetPayable =  UnrecoAmt+AccruedCharges                                 
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                                                          
  (select Party_code from risk.dbo.client_Details with(nolock) where cl_type in ('NBF','TMF')) b                                        
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                       
                                                        
  /* Update Shortage Value */                                                      
/*                              
  UPDATE a          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
 FROM #NCMS_SegwiseCldata a                                               
  JOIN                                                          
  (select party_code,shrtval=sum(dedVal) from risk.dbo.Vw_CMSVerified_BSECM_ShrtVal group by party_Code having sum(dedVal) <> 0) b                 
  ON a.segment='BSECM' and a.party_code=b.party_Code                                                      
                                         
  UPDATE a                                                          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
  FROM #NCMS_SegwiseCldata a                       
  JOIN                                                          
  (select party_code,shrtval=sum(dedVal) from risk.dbo.Vw_CMSVerified_NSECM_ShrtVal group by party_Code  having sum(dedVal) <> 0) b                                                      
  ON a.segment='NSECM' and a.party_code=b.party_Code                                                      
*/                              
                           
/* Only BOD shortage is considered in verification */                              
/*                  
  UPDATE a                                                          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                      
  (                              
 select segment,party_code,Shrtval=ShortSellValue from NCMS_SegwiseCldata with (nolock)                              
 where (SEGMENT='BSECM' OR SEGMENT='NSECM') AND ShortSellValue <> 0                              
  ) B                               
  ON a.segment=B.SEGMENT and a.party_code=b.party_Code                                                       
*/                  
                    
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                                                      
(select seg+'CM' as seg,party_code,shrtval=SUM(NetShortValue) from ncms_shortsell with(nolock)                   
group by seg,party_Code having sum(NetShortValue) <> 0) b                        
 where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.party_Code                                                      
                    
/* Reduce LD Data */                    
 /*            
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.BSECM,NetPayable=NetPayable-b.BSECM                    
 from(                    
 select client_code,BSECM from NCMS_LD_View where BSECM > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSECM'                    
 */            
   /*********commented*******************************/   
   /*         
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSECM then 0 else (b.BSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSECM then 0 else (b.BSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,BSECM from NCMS_LD_View with(nolock) where BSECM > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSECM'              
             
 /*            
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSECM,NetPayable=NetPayable-b.NSECM                    
 from(                    
 select client_code,NSECM from NCMS_LD_View where NSECM > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSECM'                    
 */            
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSECM then 0 else (b.NSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSECM then 0 else (b.NSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSECM from NCMS_LD_View with(nolock) where NSECM > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSECM'              
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSEFO,NetPayable=NetPayable-b.NSEFO                    
 from(                    
 select client_code,NSEFO from NCMS_LD_View where NSEFO > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSEFO'                    
 */            
             
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSEFO then 0 else (b.NSEFO+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSEFO then 0 else (b.NSEFO+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSEFO from NCMS_LD_View with(nolock) where NSEFO > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSEFO'              
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.MCD,NetPayable=NetPayable-b.MCD                    
 from(                    
 select client_code,MCD from NCMS_LD_View where MCD > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCD'                    
 */            
             
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCD then 0 else (b.MCD+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCD then 0 else (b.MCD+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,MCD from NCMS_LD_View with(nolock) where MCD > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCD'              
             
               
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSX,NetPayable=NetPayable-b.NSX                    
 from(                    
 select client_code,NSX from NCMS_LD_View where NSX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSX'              
 */    
  update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSX then 0 else (b.NSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSX then 0 else (b.NSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSX from NCMS_LD_View with(nolock) where NSX > 0                   
 ) b             
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSX'                     
    
    
  update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSX then 0 else (b.BSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSX then 0 else (b.BSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,BSX from NCMS_LD_View with(nolock) where BSX > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSX'     
     
                   
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NCDEX,NetPayable=NetPayable-b.NCDEX                    
 from(                    
 select client_code,NCDEX from NCMS_LD_View where NCDEX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NCDEX'                    
*/                
                
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NCDEX then 0 else (b.NCDEX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NCDEX then 0 else (b.NCDEX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NCDEX from NCMS_LD_View with(nolock) where NCDEX > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NCDEX'                    
                    
                    
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCX then 0 else (b.MCX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCX then 0 else (b.MCX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,MCX from NCMS_LD_View with(nolock) where MCX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCX'   
 */                   
 /**********************************************/           
   
 /***********************Start****************************************/  
 /*********Margin added in cash segment as per mail of sajeevn sir on 01Aug 2020****************/  
  /*    
DECLARE @MARGINDATE AS DATETIME         
SELECT @MARGINDATE=MAX(MARGINDATE) FROM anand1.msajag.dbo.tbl_combine_reporting_detail WITH (NOLOCK)     
--select @MARGINDATE  
select margindate,exchange,segment,party_code,tday_margin,tday_mtm,tday_margin+tday_mtm as margin INTO #MARGIN from  
 anand1.msajag.dbo.tbl_combine_reporting_detail with(nolock) where MARGINDATE=@MARGINDATE AND exchange in ('BSE','NSE') and segment='CAPITAL'  
  
  
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.margin,NetPayable=NetPayable-b.margin from                                                
 (select party_code,margin,exchange+'CM' as segment from #MARGIN WITH (NOLOCK) where margin>0) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0    
  */  
    
  DECLARE @MARGINDATE AS DATETIME           
SELECT @MARGINDATE=MAX(MARGIN_DATE) FROM AngelNseCM.msajag.dbo.tbl_mg02 WITH (NOLOCK)   
  
  
select a.* into #mg02 from AngelNseCM.msajag.dbo.tbl_mg02 a with (nolock), NCMS_PO_Request_ForPayout b with(nolock)  
 where a.partY_code=b.Party_code and  MARGIN_DATE=@MARGINDATE   
  
select a.*,convert(money,varamt/abs(netqty)) as pershare,b.short_qty  into #data from #mg02 a with(nolock)  join ncms_shortsell b with(nolock) on a.party_code=b.PARTY_cODE and a.scrip_cd=b.SCRIP_CD    
 and a.sett_no=b.sett_no where /* a.party_code='A2649' and*/    
   --MARGIN_DATE=@MARGINDATE and  
    ABS(netqty)<>0    
    
    select convert(money,pershare*short_qty) as varmargin ,party_code,scrip_cd,sett_no into #margin from #data  
  
    
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.varmargin/*,NetPayable=NetPayable-b.varmargin*/  from                                                  
 (select 'NSECM' as segment,party_code,varmargin=SUM(varmargin) from #margin /* where party_code='A2649'*/  
 group by party_Code having sum(varmargin) <> 0) b                                                  
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0    
    
 /***********************End****************************************/    
  
   
  /*****************peakmargin from bo for NSE BSE MTF************************/  
 DECLARE @MARGINDATEpeak AS DATETIME   , @MARGINDATEpeakBSE AS DATETIME ,@MARGINDATEpeakMTF as Datetime           
/*set @MARGINDATEpeak=cast(CAST(getdate()-1 as date)as datetime)*/  
SELECT @MARGINDATEpeak=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='NSE' and SEGMENT='CAPITAL'  
SELECT @MARGINDATEpeakBSE=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='BSE' and SEGMENT='CAPITAL'  
SELECT @MARGINDATEpeakMTF=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='MTF' and SEGMENT='MTF'  
  
  
--select cltcode,UDebitV*-1 as UDebitV,'NSE' as exchange into #unSettDr from AngelNseCM.inhouse.dbo.NCMS_PO_UnsetDr with(nolock) where UDebitV<0  
  
if((CONVERT(VARCHAR(5),GETDATE(),108)>='16:30') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))      
Begin  
 /*Commented start on 30 Jan 2023 for removing Peak margin*/  
 /*if(select COUNT(1) from  cms.dbo.NCMS_PeackMargin with(nolock))=0  
 begin  
  
   select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeak  
    and EXCHANGE='NSE' and SEGMENT='CAPITAL' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month varchar(10),@peakVar money=1  
       
      select @month=convert(char(3), GETDATE(), 0)  
   --select @month  
   --if(@month='Dec' or @month='Jan' or @month='Feb')  
   --begin  
   -- set @peakVar=0.25   
   -- print @peakVar  
   --end   
   --if(@month='Mar' or @month='Apr' or @month='May')  
   --begin  
   -- set @peakVar=0.5   
   -- print @peakVar  
   --end  
   --if(@month='Jun' or @month='Jul' or @month='Aug')  
   --begin  
   -- set @peakVar=0.75   
   -- print @peakVar  
   --end  
   --if(@month='Sep' or @month='Oct' or @month='Nov')  
   --begin  
   -- set @peakVar=1   
   -- print @peakVar  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar*/ as peakMargin into #peakMr from #aa  
    
    
   /*******************************************/  
   select a.exchange,b.party_code,b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as FinalPeak  
                       into #peak from #unSettDr a right join #peakMr b   
   on a.cltcode=b.party_code  
   /*******************************************/  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.FinalPeak/*,NetPayable=NetPayable-b.FinalPeak*/ from                                                  
  (select 'NSECM'  as segment,party_code,FinalPeak from #peak) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
  /*****************BSE***********/  
 select cltcode,UDebitV*-1 as UDebitV,'BSE' as exchange into #unSettDrBSE from AngelBSECM.inhouse.dbo.NCMS_PO_UnsetDr with(nolock) where UDebitV<0  
  
  select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa1  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeakBSE  
    and EXCHANGE='BSE' and SEGMENT='CAPITAL' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month1 varchar(10),@peakVar1 money=1  
       
   --   select @month1=convert(char(3), GETDATE(), 0)  
    
   --if(@month1='Dec' or @month1='Jan' or @month1='Feb')  
   --begin  
   -- set @peakVar1=0.25   
   -- print @peakVar1  
   --end   
   --if(@month1='Mar' or @month1='Apr' or @month1='May')  
   --begin  
   -- set @peakVar1=0.5   
   -- print @peakVar1  
   --end  
   --if(@month1='Jun' or @month1='Jul' or @month1='Aug')  
   --begin  
   -- set @peakVar1=0.75   
   -- print @peakVar1  
   --end  
   --if(@month1='Sep' or @month1='Oct' or @month1='Nov')  
   --begin  
   -- set @peakVar1=1   
   -- print @peakVar1  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar1*/ as peakMargin into #peakMr1 from #aa1  
    
   /*******************************************/  
   select a.exchange,b.party_code,b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as FinalPeak  
                       into #peak1 from #unSettDrBSE a right join #peakMr1 b   
   on a.cltcode=b.party_code  
   /*******************************************/  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.FinalPeak,NetPayable=NetPayable-b.FinalPeak from                                                  
  (select 'BSECM'  as segment,party_code,FinalPeak from #peak1) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
   
  /*****************MTF***********/  
  select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa11  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeakMTF  
    and EXCHANGE='MTF' and SEGMENT='MTF' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month11 varchar(10),@peakVar11 money=1  
       
   --   select @month11=convert(char(3), GETDATE(), 0)  
    
   --if(@month11='Dec' or @month11='Jan' or @month11='Feb')  
   --begin  
   -- set @peakVar11=0.25   
   -- print @peakVar11  
   --end   
   --if(@month11='Mar' or @month11='Apr' or @month11='May')  
   --begin  
   -- set @peakVar11=0.5   
   -- print @peakVar11  
   --end  
   --if(@month11='Jun' or @month11='Jul' or @month11='Aug')  
   --begin  
   -- set @peakVar11=0.75   
   -- print @peakVar11  
   --end  
   --if(@month11='Sep' or @month11='Oct' or @month11='Nov')  
   --begin  
   -- set @peakVar11=1   
   -- print @peakVar11  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar11*/ as peakMargin into #peak11 from #aa11  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.peakMargin,NetPayable=NetPayable-b.peakMargin from                                                  
  (select EXCHANGE as segment,party_code,peakMargin from #peak11) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
  end  
  /**************************************/  
 else  
  begin  
  */ /*Commented end on 30 Jan 2023 for removing Peak margin*/  
  /********For adding peak maegin********************/  
   /* select client_code,bsecm+nsecm+nsefo+Mcx+ncdex+nsx+mcd as LDAmt into #ee from [NCMS_LD_View]*/--comented on 22 July 2022  
    select Client_code,BSECMMargin+NSECMMargin+NSEFOMargin+MCXMargin+NCDEXMargin+NSXMargin+MCDMargin+BSXMargin as LDAmt into #ee from [NCMS_LD_MTM_Margin_view] with(nolock)  
     
 /*    declare @monthFile varchar(10),@peakVarFile money=1  
       
    SELECT [client code],total*@peakVarFile as peakMargin into #PEakFile FROM NCMS_PeackMargin   
     
    select a.exchange,b.[client code],b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as total  
                       into #PEakFileMain from #unSettDr a right join #PEakFile b   
    on a.cltcode=b.[client code]     
     
   SELECT [client code], MAX(total) as total  
   into #PeckMargin FROM  
   (  
    SELECT [client code], MAX(total) as total  
    FROM #PEakFileMain   
    GROUP BY [client code]  
    UNION ALL  
    SELECT client_code, MAX(LDAmt) as LDAmt  
    FROM #ee   
    GROUP BY client_code  
   ) as subQuery  
   GROUP BY [client code]  
*/  
   SELECT [client code], MAX(total) as total  
   into #LDMargin FROM  
   (  
    SELECT client_code as [client code], MAX(LDAmt) as total  
    FROM #ee   
    GROUP BY client_code  
   ) as subQuery  
   GROUP BY [client code]  
                
    update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.total/*OtherDebit=OtherDebit-b.total              */  
    /*,NetPayable=NetPayable-b.total */             
    from(                    
    select 'NSECM' as segment,[client code],total from #LDMargin with(nolock) where [client code] is not null and total<>0               
    ) b                     
    where #NCMS_SegwiseCldata.Party_code=b.[client code] and  #NCMS_SegwiseCldata.segment=b.segment                     
                    
  --end      
   
 end  
 /**************************/      
   
 /*******************added on 10 Mar 2021 for adding unsetteld Holding***************************************************/  
 declare @NONCASHconsideration as int = 100   
   
  update #NCMS_SegwiseCldata set NonCashConsideration=@NONCASHconsideration where Segment='NSECM'          
  
--select a.* into #NCMS_ROI from NCMS_ROI a with(nolock), NCMS_PO_Request_ForPayout b with(nolock)  
-- where a.partY_code=b.Party_code        
  
-- update #NCMS_SegwiseCldata set NonCashConsideration=b.CollateralPercent          
-- from #NCMS_ROI b  WITH (NOLOCK)   where #NCMS_SegwiseCldata.party_code=b.party_code  and  #NCMS_SegwiseCldata.Segment='NSECM'          
  
select * into #Vw_Todays_Secpayout from  AngelDEMAT.MSAJAG.dbo.Vw_Todays_Secpayout  with(nolock) where  
Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,  
CONVERT(MONEY, 0) as Value_BHC_unsett,  
CONVERT(MONEY, 0) as Value_AHC_unsett  
  into #unsett_holding from /*[196.1.115.197].msajag.dbo.unclear_hold*/ #Vw_Todays_Secpayout a with(nolock) join  
 [196.1.115.182].GENERAL.DBO.Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/  
a.I_isin=b.security_isin join [196.1.115.182].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.I_isin=c.[isin no]  
where a.party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
update #unsett_holding set Value_BHC_unsett=qty*MTM_Price_unsett  
update #unsett_holding set Value_AHC_unsett=isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)  
  
select SUM(Value_AHC_unsett) as Value_AHC_unsett,party_code into #holding_AHC from #unsett_holding group by party_code  
  
update #NCMS_SegwiseCldata set noncashcoll=Value_AHC_unsett from                                                
 (select party_code,Value_AHC_unsett from #holding_AHC) b                                                  
 where #NCMS_SegwiseCldata.segment='NSECM' and #NCMS_SegwiseCldata.party_code=b.party_Code   
   
 -- alter table #NCMS_SegwiseCldata add marginAdjustWithLgr money   
   
 --update #NCMS_SegwiseCldata set marginAdjustWithLgr=0.00  
     
   ALTER TABLE #NCMS_SegwiseCldata ADD marginAdjustWithLgr money NOT NULL DEFAULT 0  
   
 update #NCMS_SegwiseCldata set ExpoUtilised=ExpoUtilised+  
 (case     
 when  noncashcoll=0 then   MarginAmt     
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0         
 then 0           
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll   
 end) ,  
 marginAdjustWithLgr=isnull(marginAdjustWithLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3  
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  
 from #NCMS_SegwiseCldata where segment='NSECM' -- and  party_code='D65765'  
   
   
update #NCMS_SegwiseCldata set NetPayable=NetPayable+ExpoUtilised+marginAdjustWithLgr  where segment='NSECM'   
       
 /*For reducing Bond value change done by Neha on 16 Jul2016*/    
 select client_code,Segment,Total into #bond_client from BondEntry with(nolock)     
     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.Total,NetPayable=NetPayable-b.Total                          
 from(                    
 select * from #bond_client    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment=b.segment      
     
     
      
 update a set POblocked=GETDATE() from BondEntry a,    
 (select * from #bond_client)b where    
 a.client_code=b.client_code     
     
     
 update a set Flexiblocked=b.Flexiblocked,POblocked=b.POblocked from bond.dbo.tbl_BondOrderEntry a with(nolock),    
 (select * from BondEntry with(nolock))b where    
 a.client_code=b.client_code and a.order_Status='PENDING'    
 and a.Verfiedon is null and a.POblocked is null                
    
    
    
    
  /*---------------------------------------------------------*/                   
    
    
 /*For Reducing mf pending orders in Payout*/    
    
DECLARE @Days VARCHAR(20)                          
                          
 SET @Days = (                          
   SELECT DATENAME(dw, GETDATE())                          
   )     
  
 /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF       
                            
IF (@Days = 'Monday' OR @Days = 'Saturday')                          
BEGIN         
    
 --select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund_sat from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)    
 --where cltcode     
 --in     
 --(select clientcode from [196.1.115.132].risk.dbo.vw_MutualFundPendingOrder_NCMS_sat with(nolock)    where segment in ('MF','Trade' ))    
 --and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)      
 --and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 --group by cltcode    
    
 /*    
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal     
 from #MFFund m inner join    
 [196.1.115.132].risk.dbo.vw_MutualFundPendingOrder_NCMS o    
 on m.cltcode=o.clientcode    
 where balance<=0    
 group by m.cltcode,m.balance    
 */    
    
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal_sat       
 from     
 risk.dbo.vw_MutualFundPendingOrder_NCMS_sat o  with(nolock)   ,NCMS_PO_Request_ForPayout b where o.clientcode=b.Party_code   
 group by clientcode    
    
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)    
 select cltcode,amount,getdate() from #MFFundFinal_sat    
    
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),    
 a.*,b.amount into #segmentwise_pendingorders_sat    
 from    
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')    
 and NetPayable>0)a    
 inner join  (select cltcode,amount from #MFFundFinal_sat) b    
 on a.party_code=b.cltcode;    
    
 with cte    
 as    
 (    
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,    
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,    
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end    
  from #segmentwise_pendingorders_sat where srno=1 --and party_code='AACW016'    
  union all    
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,    
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,    
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end    
  from #segmentwise_pendingorders_sat a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'    
 )    
 select * into #mf_segamountadjust_sat from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)    
    
    
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                       
  (                    
 select * from #mf_segamountadjust_sat    
  ) b                     
  where a.Party_code=b.party_code and a.Segment=b.segment     
    
 drop table #mf_segamountadjust_sat    
 drop table #segmentwise_pendingorders_sat    
 drop table #MFFundFinal_sat    
end    
else    
begin    
 --select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)    
 --where cltcode     
 --in     
 --(select clientcode from [196.1.115.132].risk.dbo.vw_MutualFundPendingOrder_NCMS with(nolock)    where segment in ('MF','Trade' ))    
 --and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)      
 --and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 --group by cltcode    
    
 /*    
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal     
 from #MFFund m inner join    
 [196.1.115.132].risk.dbo.vw_MutualFundPendingOrder_NCMS o    
 on m.cltcode=o.clientcode    
 where balance<=0    
 group by m.cltcode,m.balance    
 */    
    
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal       
 from     
 risk.dbo.vw_MutualFundPendingOrder_NCMS o with(nolock)    ,NCMS_PO_Request_ForPayout b where o.clientcode=b.Party_code   
 group by clientcode    
    
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)    
 select cltcode,amount,getdate() from #MFFundFinal    
    
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),    
 a.*,b.amount into #segmentwise_pendingorders    
 from    
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')    
 and NetPayable>0)a    
 inner join  (select cltcode,amount from #MFFundFinal) b    
 on a.party_code=b.cltcode;    
    
 with cte    
 as    
 (    
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,    
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,    
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end    
  from #segmentwise_pendingorders where srno=1 --and party_code='AACW016'    
  union all    
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,    
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,    
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end    
  from #segmentwise_pendingorders a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'    
 )    
 select * into #mf_segamountadjust from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)    
    
    
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                       
  (                    
 select * from #mf_segamountadjust    
  ) b                     
  where a.Party_code=b.party_code and a.Segment=b.segment     
     
 drop table #mf_segamountadjust    
 drop table #segmentwise_pendingorders    
 drop table #MFFundFinal    
end    
    
   */  
     
     
 /*************************************************************************************/    
     
 /*For Reducing BSE Orders added on 05 May 2017*/    
              
 IF (@Days = 'Monday')                          
 BEGIN     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                      
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE_sat with(nolock)                   
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                        
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode      
 end     
else    
begin     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                      
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE  with(nolock)                  
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                        
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode      
 end    
 /*---------------------------------------------------------*/       
 /*****Start************For reducing Bills of BSE NSE*************************************************************************/  
DECLARE @billdate AS DATE   
SELECT  @billdate=getdate()  
if(select PROCESS_STATUS from AngelNseCM.msajag.dbo.TBL_AUTO_PROCESS_DETAIL with(nolock) where Business_Date=@billdate and PROCESS_FOR ='POSTBILL'  
and sett_type='M')=0  
begin  
if(select PROCESS_STATUS from AngelNseCM.msajag.dbo.TBL_AUTO_PROCESS_DETAIL with(nolock) where Business_Date=@billdate and PROCESS_FOR ='POSTBILL'  
and sett_type='Z')=0  
begin  
if(select posting from AngelNseCM.msajag.dbo.V2_Business_Process with(nolock) where Business_Date=@billdate and sett_type ='M' )=0  
begin  
if(select posting from AngelNseCM.msajag.dbo.V2_Business_Process with(nolock) where Business_Date=@billdate and sett_type='Z' )=0  
begin  
  
  insert into BseCmbillGendata_log  
  select *,getdate() from [196.1.115.207].Clientservice.dbo.BseCmbillGendata with(nolock)  
  
  insert into NseCmbillGendata_log  
  select *,getdate() from [196.1.115.207].Clientservice.dbo.NseCmbillGendata with(nolock)  
  
    select *,AMOUNT+Brokerage+SERVICE_TAX+TURN_TAX+SEBI_TAX+INS_CHRG+BROKER_CHRG as BillAmount  
 into #erNewn  from [196.1.115.207].clientservice.dbo.NseCmbillGendata with(nolock) --where amount>0  
 where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
    select *,AMOUNT+Brokerage+SERVICE_TAX+TURN_TAX+SEBI_TAX+INS_CHRG+BROKER_CHRG as BillAmount  
  into #er1Newn from  [196.1.115.207].Clientservice.dbo.BseCmbillGendata with(nolock)-- where amount>0  
 where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
   update #erNewn  set billamount=case when billamount<0 then billamount*-1 when billamount>0 then billamount*-1 end   
   update #er1Newn  set billamount=case when billamount<0 then billamount*-1 when billamount>0 then billamount*-1 end   
  
  
  select x.party_code,sum(billamount) as billamount into #club from  
  (select party_code,billamount from #erNewn  
  union all  
  select party_code,billamount from #er1Newn)x  group by party_code    
  
  update #NCMS_SegwiseCldata set OtherDebit=isnull(OtherDebit,0)-b.billamount,NetPayable=NetPayable-b.billamount                          
  from(                    
  select distinct billamount*-1 as billamount,PARTY_CODE from #club with(nolock)   where billamount<0  
  ) b                     
  where #NCMS_SegwiseCldata.Party_code=b.PARTY_CODE and #NCMS_SegwiseCldata.segment='NSECM'  /*#NCMS_SegwiseCldata.Segment='NSEFO'     */  
 end  
 end  
 end  
 end  
 --else  
 --begin  
 -- update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.brokerage,NetPayable=NetPayable-b.brokerage                          
 -- from(                    
 -- select distinct Brokerage+Gst+STT+TurnoverCharges+SebiFees+StampDuty as brokerage,PARTY_CODE,segment from NCMS_BrokerageCharges with(nolock)   
 -- ) b                     
 -- where #NCMS_SegwiseCldata.Party_code=b.PARTY_CODE and #NCMS_SegwiseCldata.segment=b.segment  
 --end  
 /*****End****************************************************************************/     
     
/******Start*********************For Deducting Brokerage charges*************************/    
 select distinct Brokerage+Gst+STT+TurnoverCharges+SebiFees+StampDuty as brokerage,PARTY_CODE,segment into #NSECM_Brokerage from NCMS_BrokerageCharges with(nolock)   
 where segment not in ('BSECM','NSECM')  
  
 select party_code,sum(brokerage) as brokerage into #New_brokerage from #NSECM_Brokerage group by party_code  
  
 update a set OtherDebit=isnull(OtherDebit,0)-b.brokerage,NetPayable=NetPayable-b.brokerage                          
 from #NCMS_SegwiseCldata a,(                    
 select party_code,brokerage from #New_brokerage  
 ) b                     
 where a.Party_code=b.PARTY_CODE and a.segment='NSECM' /*#NCMS_SegwiseCldata.segment=b.segment*/ /*#NCMS_SegwiseCldata.Segment='NSEFO'     */  
     
 /*****End****************************************************************************/     
     
   /*update net basis of Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/  
   
  update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.loss ,OtherDebit=isnull(OtherDebit,0)-b.loss from                                                
 (select party_code,loss,exchange+'CM' as segment from NCMS_Intraday_loss with(nolock)) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0 and NetPayable>0   
   
/***********************************************************************************/  
     
  /*********************Added on 30 may 2022 for removing SIP**************************************************************/  
  /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF       
  
select sclientcode,sactualduedate,sum(convert(money,sInstallmentAmt)) as sInstallmentAmt,'BSEMFSS' as segment into #sum FROM   
[196.1.115.253].MutualFund.dbo.vw_sip_installments with(nolock)  
group by sclientcode,sactualduedate     
  
 update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.sInstallmentAmt ,OtherDebit=OtherDebit-b.sInstallmentAmt from                                                
 (select * from #sum with(nolock)) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.sclientcode  
*/  
  /**********************************************************************************/   
 /***********************for Adding Delivery Margin Added on 14 Jun 2019 By Neha Naiwar ************************************/    
--DECLARE @MARGINDATE AS DATETIME,@sdtcur as datetime             
--SELECT @MARGINDATE=MAX(MARGINDATE) FROM angelfo.NSEFO.dbo.tbl_clientmargin WITH (NOLOCK)       
    
--SELECT * into #delmargin FROM Angelfo.NSEFo.dbo.FOMARGINNEW with(nolock) WHERE  MDATE =@MARGINDATE/*convert(datetime,convert(varchar(8),getdate(),112))*/    
--AND DEL_MARGIN <>0    
    
--  UPDATE a                                                            
--  set MarginAmt =  MarginAmt-DEL_MARGIN                         
--  FROM #NCMS_SegwiseCldata a                                                 
--  JOIN                                                            
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                          
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'      
      
--  UPDATE a                                                            
--  set NetPayable =  NetPayable-DEL_MARGIN                         
--  FROM #NCMS_SegwiseCldata a                                                 
--  JOIN                                                            
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                          
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'       
/*************************************************************************************/    
     
               
  truncate table NCMS_SegVeriData                          
  insert into NCMS_SegVeriData                                            
  (                                            
  POrequestID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,                                            
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                          
  )                                              
  select   /*ROW_NUMBER() OVER ( ORDER BY party_code,segment) AS refno,*/                            
  convert(varchar(6),getdate(),112)+replace(convert(varchar(8),getdate(),108),':','') AS refno,                            
  ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,isnull(OtherDebit,0),NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                             
  from #NCMS_SegwiseCldata                                               
    
  /*******************************************************Added for combine margin****/  
  select * into #new_NCMS_SegwiseCldata from #NCMS_SegwiseCldata with(nolock) where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
    
  update #new_NCMS_SegwiseCldata set Balance=0.00,UnsettledCrBill=0.00 where NetPayable=0 and Segment='BSEMFSS'  
  update #new_NCMS_SegwiseCldata  set UnsettledCrBill=0.00 where  Segment='BSEMFSS'  and  NetPayable>0  and UnsettledCrBill<0  
  
update  #new_NCMS_SegwiseCldata set Balance=NetPayable where Balance=0 and AccruedCharges=0 and marginamt=0 and segment='bsemfss' and NetPayable<0  
    
 select max(ProcessDate) ProcessDate,Entity,Party_code,Flag,sum(Balance)Balance,sum(UnsettledCrBill) UnsettledCrBill,sum(UnrecoAmt) UnrecoAmt,    
 sum(ShortSellValue) ShortSellValue,sum(MarginAmt) MarginAmt,SUM(deposit) Deposit,sum(CashColl)CashColl,sum(NonCashColl) NonCashColl,    
 sum(MarginAdjWithColl) MarginAdjWithColl,sum(MarginShortage) MarginShortage,sum(AccruedCharges) AccruedCharges,sum(OtherDebit) OtherDebit,    
 max(100) NonCashConsideration--,SUM(ExpoUtilised) as ExpoUtilised,sum(NetPayable) NetPayable  
 ,case when entity='AllSegment' then 0.00 else SUM(ExpoUtilised) end as ExpoUtilised,  
 case when entity='AllSegment' then 0.00 else sum(NetPayable) end NetPayable  
 into #ncms    
 from  #new_NCMS_SegwiseCldata  /*where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))*/  
 group by Entity,Party_code,Flag    
   
 --  update #ncms set NonCashConsideration=100.00 --from #ncms     /*added on 08 Oct 2021 by Neha naiwar*/  
  
 -- /*alter table #ncms add marginAdjustWithCombineLgr money */  /*added on 08 Oct 2021 by Neha naiwar*/  
     
 --update #ncms set /*marginAdjustWithCombineLgr=0.00 ,*/ExpoUtilised=0.00 ,NetPayable=0.00 where entity='AllSegment'  
     
 update #ncms set ExpoUtilised=ExpoUtilised+    
 (case       
 when  noncashcoll=0 then   MarginAmt       
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0           
 then 0             
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll     
 end)     
 /*,marginAdjustWithCombineLgr=isnull(marginAdjustWithCombineLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3    
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  */   /*added on 08 Oct 2021 by Neha naiwar*/  
 from #ncms where entity='AllSegment'  
   
 update #ncms set NetPayable=Balance+ExpoUtilised+/*marginAdjustWithCombineLgr+*/UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges+OtherDebit   
  where entity='AllSegment'  
  
/***Added on 22 July 2022************************/  
select Client_code,BSECMMTM+NSECMMTM+NSEFOMTM+MCXMTM+NCDEXMTM+NSXMTM+MCDMTM+BSXMTM as LDAmtMTM into #LDMTM from [NCMS_LD_MTM_Margin_view]  
  
 update a set NetPayable=NetPayable-LDAmtMTM from #ncms a join #LDMTM b on a.party_code=b.Client_code  
  where entity='AllSegment' and LDAmtMTM<>0  
  
 update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from #ncms a left join #LDMTM b on a.party_code=b.Client_code  
  where entity='AllSegment' and LDAmtMTM<>0  
/*********************************/  
  
 update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from NCMS_SegVeriData a , #LDMTM b where a.party_code=b.Client_code    
  and segment='NSECM' and LDAmtMTM<>0    
  
/***Added on 08 Aug 2022 for adjusting Ad-hoc margin values************************/  
  select a.party_code,(amt*-1) as amt into #adhocdata from risk.dbo.tbl_Omne_CM_MarginData a with(nolock)  ,NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
  
  update a set amt=amount from #adhocdata a join NCMS_tbl_AdhocMargin b on a.party_code=b.party_code   
  
  insert into NCMS_Adhoc_final_hist  
 select *,GETDATE() from NCMS_Adhoc_final  
  
 truncate table NCMS_Adhoc_final  
   
 insert into NCMS_Adhoc_final  
 select * from #adhocdata  
  
  truncate table NCMS_tbl_AdhocMargin  
if( DATEPART(DW,GETDATE())>6 and DATEPART(DW,GETDATE())<=7)    
begin  
 truncate table NCMS_Adhoc_final  
end  
select * into #adhoc from NCMS_Adhoc_final with(nolock) where amt<>0  
   
 update a set NetPayable=NetPayable+Amt,OtherDebit=isnull(OtherDebit,0)+Amt from #ncms a join #adhoc b on a.party_code=b.party_code  
  where entity='AllSegment'  
  
   update a set OtherDebit=isnull(OtherDebit,0)+Amt from NCMS_SegVeriData a join #adhoc b on a.party_code=b.party_code  
  where segment='NSECM'  
  /*******************************************/  
  
truncate table NCMS_CombineVeriData  
 insert into NCMS_CombineVeriData                                            
  (                                            
  POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,                                            
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                          
  )                                              
  select   /*ROW_NUMBER() OVER ( ORDER BY party_code,segment) AS refno,*/                            
  convert(varchar(6),getdate(),112)+replace(convert(varchar(8),getdate(),108),':','') AS refno,                            
  ProcessDate,Entity,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                  
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                             
  from #ncms    
    
  insert into NCMS_CombineVeriData_hist  
  (  
  POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,  
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,updatedOn  
  )   
  select POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,  
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,GETDATE() from NCMS_CombineVeriData  
         
/* For checking duplicate Account no.*/                      
                          
  declare @StatusJob varchar(20)                               
  set @StatusJob=''             
  exec CMS.dbo.Get_JoBStatus 'NCMS Double Entry in ACC no',@StatusJob  output                               
  print @StatusJob                      
                      
                      
  if(@StatusJob='In Progress')                                
   print 'job is already running'                            
  else                        
   EXEC msdb.dbo.sp_start_job 'NCMS Double Entry in ACC no'   
  
   
/* For Verify process*/                      
if(select flag from ncms_batch_process with(nolock) where Srno=15)=1  
Begin                           
  declare @StatusJobVerify varchar(20)                               
  set @StatusJobVerify=''             
  exec CMS.dbo.Get_JoBStatus 'NCMS Verifier Step',@StatusJobVerify  output                               
  print @StatusJobVerify                      
                      
                      
  if(@StatusJobVerify='In Progress')                                
   print 'job is already running'                            
  else                        
   EXEC msdb.dbo.sp_start_job 'NCMS Verifier Step'   
End   
 /*         
 insert into NCMS_SegVeriData_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                      
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                      
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                      
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                      
 from NCMS_SegVeriData with (nolock)              
 */        
                                               
  /* exec NCMS_UPD_ReqVerId @pcode,@refno      */                                
                                            
--End try                       
                                                
--BEGIN CATCH                                                        
                                                    
--  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                              
--  select GETDATE(),'NCMS_VeriData_Batchwise',ERROR_LINE(),ERROR_MESSAGE()                                                              
                                
-- DECLARE @ErrorMessage NVARCHAR(4000);                                                              
-- SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                              
-- RAISERROR (@ErrorMessage , 16, 1);                                    
                                                     
--End catch                                                    
                                                      
--Set nocount off   
  
end  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_VeriData_Batchwise_100124
-- --------------------------------------------------
create PROCEDURE [dbo].[NCMS_VeriData_Batchwise_100124]                                
as                                                      
  /* FETCH DATA */    
if(select flag from ncms_batch_process with(nolock) where Srno=15)=1  
Begin   
  begin  
                                                      
   Create table #NCMS_SegwiseCldata (                                                          
   id int,                                              
   ProcessDate datetime,                                              
   Entity varchar(10),                                              
   Segment varchar(10),                                              
   Party_code varchar(10),                                              
   Flag char(1),                                              
   Balance money,                                              
   UnsettledCrBill money,                                              
   UnrecoAmt money,                                              
   ShortSellValue money,                                              
   MarginAmt money,                                              
   Deposit money,                                              
   CashColl money,                                              
   NonCashColl money,                                              
   MarginAdjWithColl money,                                              
   MarginShortage money,                                              
   AccruedCharges money,                                              
   OtherDebit money,                                              
   NonCashConsideration money,                                              
   ExpoUtilised money,                                              
   UnPosted_PO money,                   
   NetPayable money                                          
   )                                                                                                             
                                                
                          
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime,'AllSegment','BSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                       
  from AngelBSECM.inhouse.dbo.NCMS_PO  with(nolock)                                                   
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','NSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                       
  from AngelNseCM.inhouse.dbo.NCMS_PO  with(nolock)                                                        
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                  
 select ProcessDatetime,'AllSegment','MTF',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                   
 from AngelNseCM.MTFTRADE.dbo.NCMS_PO  with(nolock)      
                                                         
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelfo.inhouse.dbo.NCMS_marh  with(nolock)                                                        
  /* and PayoutValue <> 0*/     
    
  /******BSEFO***************/  
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','BSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.BSEFO.dbo.NCMS_marh  with(nolock)    
  /*********************/  
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelfo.inhouse_curfo.dbo.NCMS_marh  with(nolock)               
  /* and PayoutValue <> 0*/                                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','MCD',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.INHOUSE_MCDCS.dbo.NCMS_marh  with(nolock)                                                        
  /* and PayoutValue <> 0*/                                                      
    
     
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                 
 select UpdDatetime,'AllSegment','BSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                   
 from angelcommodity.inhouse_bsx.dbo.NCMS_marh  with(nolock)      
                                                         
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NCDEX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.inhouse_NCDX.dbo.NCMS_marh   with(nolock)                                                       
/* and PayoutValue <> 0*/                                                     
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','MCX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.inhouse_MCDX.dbo.NCMS_marh   with(nolock)                                                       
  /* and PayoutValue <> 0*/                                                     
                       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','BSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,AfterAdjustedBal/*VBal+UCV+UnRecoCr+OtherDr */          
 from /*angelfo.inhouse.dbo.NCMS_PO_BSEMFSS*/   angelfo.inhouse.dbo.NCMS_PO_BSEMFSS_edt with(nolock)    
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','NSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                 
  from angelfo.inhouse.dbo.NCMS_PO_NSEMFSS with(nolock)                                                         
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                    
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','IPO',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                        
  from NCMS_PO_IPO with(nolock)                                                        
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                              
  /*                           
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select processDate,'NBFC','NBFC',party_Code,'I',LogicalLedger,Unsettled,0,ShortValHC,0,0,0,VAHC,0,0,AccruedInt,ShortVal,0,0,NetAmount                                                   
from [172.31.16.57].inhouse.dbo.ncms_po /* and netAmount <> 0 */                                    
  */                              
                                
  /* NBFC verification not required. verification is based on BOD processed data */                              
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                              
  select                               
  ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                              
  from NCMS_SegwiseCldata with (nolock) where entity='NBFC'                              
      
    /************************************************************************************************************************************************/     
/************************************************************************************************************************************************/     
    /*Changed in order to consider MTM of cases where there is no ledger added by Neha Naiwar on suggestion from Bhavin Parikh dt: 23th June 2016*/         
     select * into #LD from NCMS_LD_View a with(nolock) ,NCMS_PO_Request_ForPayout b  where a.client_code=b.Party_code  
     
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where BSECM > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSECM' ) and isnull(client_code,'')<>''    
      
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where NSECM > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSECM' ) and isnull(client_code,'')<>''    
       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSEFO',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where NSEFO > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSEFO' ) and isnull(client_code,'')<>''                           
       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)   where NSX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSX' ) and isnull(client_code,'')<>''                                                       
     
   insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCD',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)   where MCD > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCD' ) and isnull(client_code,'')<>''     
     
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)  where BSX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSX' ) and isnull(client_code,'')<>''     
     
     insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NCDEX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock) where NCDEX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NCDEX' ) and isnull(client_code,'')<>''     
     
      insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock) where MCX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCX' ) and isnull(client_code,'')<>''    
    
/************************************************************************************************************************************************/    
/**********************Adding NSECM Clients if not exist*********************************/  
 /*suggestion*/  
 /*insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)     
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSECM',cltcode=Cl_Code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,  
  0,0,0,OtherDr=0,0,0,0                                                       
  from AngelNseCM.msajag.dbo.client_brok_details a with(nolock) where  isnull(Deactive_value,'') not in ('T','C') and exchange='NSE' and segment='CAPITAL'   
    and not exists    
 (select * from #NCMS_SegwiseCldata b where a.Cl_Code=b.party_code and segment='NSECM' ) and isnull(Cl_Code,'')<>''   
 --and exists (select distinct Party_code from NCMS_PO_Request_ForPayout c with(nolock) where a.cl_code=c.Party_code)  
 */  
/************************************************************************************************************************************************/     
  /* Accrured Charges */                                                  
                                                                                      
 --select a.party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                     
 --from /*misc.dbo.Accrued_PenalCharges*/ NCMS_Accrued_PenalCharges a with (nolock) ,NCMS_PO_Request_ForPayout b  where a.party_code=b.Party_code   
 --group by a.party_code     
   
 select a.PARTY_CODE,(OTHER_DEBIT*-1) as OTHER_DEBIT into #AccCharges from tbl_other_debit a with (nolock) ,NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
  
 select a.PARTY_CODE,DeductEQ=sum(a.OTHER_DEBIT),DeductComm=0.00 into #Accrued1  
 from #AccCharges a with (nolock)-- ,NCMS_PO_Request_ForPayout b  where a.client=b.Party_code   
 group by a.PARTY_CODE     
     
 /******added new margin peneality charges on 05 Jul 2021***********************************/    
 --insert into #Accrued1    
 -- select a.party_code,DeductEQ=SUM(Value_amt),DeductComm=0.00 from [CSOKYC-6].General.dbo.tbl_EarlyPayin_Charges a with(nolock)  
 -- ,NCMS_PO_Request_ForPayout b  where a.party_code=b.Party_code group by a.party_code  
  
 --insert into #Accrued1    
 -- select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code              
   
   
 insert into  #Accrued1  
 select a.party_code,DeductEQ=Balance,DeductComm=0.00 from  NCMS_WO_Master a with(nolock),NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
 /*Added for W/O Margin on 16 Nov 2021*/          
   
   
--insert into  #Accrued1  
--SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM anand1.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)  
--where cnt_Date=(select max(cnt_Date) from anand1.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))  
--group by cltcode  
  
--insert into  #Accrued1  
--SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM anand1.MSAJAG.DBO.JVPNC_LOG J (Nolock),anand1.MSAJAG.DBO.client_details c(Nolock)  
--where  PCN_Date=(select max(PCN_Date) from anand1.MSAJAG.DBO.JVPNC_LOG J (Nolock))  
-- and J.cl_code=c.cl_code  
--group by J.cl_code   
  
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                           
    
 --select client as party_code,DeductEQ*-1 as DeductEQ ,DeductComm as DeductComm into #Accrued from #Accrued1 --group by client                                           
    
 /****************************************/                                                  
                                                   
 update #NCMS_SegwiseCldata set AccruedCharges=-Accured,NetPayable=NetPayable-Accured                                                  
 from                                                  
 (                                                  
  select q.segment,q.party_code,                                                  
  (Case when q.entity='AllSegment' then DeductEQ else DeductComm end) as Accured                                                  
  from #Accrued p join                                                   
  (                                                  
  select x.*,y.segment from                                                  
  (                                                  
  select a.entity,party_Code,min(b.seqid) as seqid                                                  
  from #NCMS_SegwiseCldata a join ncms_entity b on a.segment=b.segment                                                   
  group by a.entity,party_Code                                                  
  ) x join ncms_entity y with(nolock) on x.seqid=y.seqid and x.entity=y.entity                                                  
  ) q on p.party_Code=q.party_Code                                                   
 ) AC                                                  
 where #NCMS_SegwiseCldata.party_code=AC.party_Code and #NCMS_SegwiseCldata.segment=AC.Segment                                                  
 and #NCMS_SegwiseCldata.segment <> 'NBFC'                                          
                                                   
    
  /* select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 into #Accrued from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code              
  
UPDATE a                                                          
  set AccruedCharges=AccruedCharges+b.DeductEQ,NetPayable=NetPayable+b.DeductEQ                                                               
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                                             
  (select party_code,DeductEQ=-DeductEQ from #Accrued with (nolock) ) b                                              
  ON a.party_code=b.party_Code         
  where a.Segment <> 'NBFC'   and a.Segment='NSECM'     */                                                 
                
                      
  /* BSECM & NSECM Zero for NBFC Clients */                                                      
                                  
  /*                                                             
  UPDATE a                                                          
  set NetPayable = 0,ShortSellValue=0,Balance=0                                              
  FROM #NCMS_SegwiseCldata a                           
  JOIN                                                          
  (select Party_code from risk.dbo.client_Details where cl_type in ('NBF','TMF')) b                                               
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                       
  */                              
                                
  /*---- Only unreco cheque amount of BSECM and NSECM should get deducted from NBFC Net payable */                              
  UPDATE a                                                          
  set NetPayable =  UnrecoAmt+AccruedCharges                                 
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                                                          
  (select Party_code from risk.dbo.client_Details with(nolock) where cl_type in ('NBF','TMF')) b                                        
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                       
                                                        
  /* Update Shortage Value */                                                      
/*                              
  UPDATE a          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
 FROM #NCMS_SegwiseCldata a                                               
  JOIN                                                          
  (select party_code,shrtval=sum(dedVal) from risk.dbo.Vw_CMSVerified_BSECM_ShrtVal group by party_Code having sum(dedVal) <> 0) b                 
  ON a.segment='BSECM' and a.party_code=b.party_Code                                                      
                                         
  UPDATE a                                                          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
  FROM #NCMS_SegwiseCldata a                       
  JOIN                                                          
  (select party_code,shrtval=sum(dedVal) from risk.dbo.Vw_CMSVerified_NSECM_ShrtVal group by party_Code  having sum(dedVal) <> 0) b                                                      
  ON a.segment='NSECM' and a.party_code=b.party_Code                                                      
*/                              
                           
/* Only BOD shortage is considered in verification */                              
/*                  
  UPDATE a                                                          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                      
  (                              
 select segment,party_code,Shrtval=ShortSellValue from NCMS_SegwiseCldata with (nolock)                              
 where (SEGMENT='BSECM' OR SEGMENT='NSECM') AND ShortSellValue <> 0                              
  ) B                               
  ON a.segment=B.SEGMENT and a.party_code=b.party_Code                                                       
*/                  
                    
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                                                      
(select seg+'CM' as seg,party_code,shrtval=SUM(NetShortValue) from ncms_shortsell with(nolock)                   
group by seg,party_Code having sum(NetShortValue) <> 0) b                        
 where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.party_Code                                                      
                    
/* Reduce LD Data */                    
 /*            
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.BSECM,NetPayable=NetPayable-b.BSECM                    
 from(                    
 select client_code,BSECM from NCMS_LD_View where BSECM > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSECM'                    
 */            
   /*********commented*******************************/   
   /*       
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSECM then 0 else (b.BSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSECM then 0 else (b.BSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,BSECM from NCMS_LD_View with(nolock) where BSECM > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSECM'              
             
 /*            
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSECM,NetPayable=NetPayable-b.NSECM                    
 from(                    
 select client_code,NSECM from NCMS_LD_View where NSECM > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSECM'                    
 */            
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSECM then 0 else (b.NSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSECM then 0 else (b.NSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSECM from NCMS_LD_View with(nolock) where NSECM > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSECM'              
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSEFO,NetPayable=NetPayable-b.NSEFO                    
 from(                    
 select client_code,NSEFO from NCMS_LD_View where NSEFO > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSEFO'                    
 */            
             
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSEFO then 0 else (b.NSEFO+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSEFO then 0 else (b.NSEFO+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSEFO from NCMS_LD_View with(nolock) where NSEFO > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSEFO'              
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.MCD,NetPayable=NetPayable-b.MCD                    
 from(                    
 select client_code,MCD from NCMS_LD_View where MCD > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCD'                    
 */            
             
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCD then 0 else (b.MCD+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCD then 0 else (b.MCD+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,MCD from NCMS_LD_View with(nolock) where MCD > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCD'              
             
               
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSX,NetPayable=NetPayable-b.NSX                    
 from(                    
 select client_code,NSX from NCMS_LD_View where NSX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSX'              
 */            
  update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSX then 0 else (b.NSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSX then 0 else (b.NSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSX from NCMS_LD_View with(nolock) where NSX > 0                   
 ) b             
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSX'                     
    
    
  update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSX then 0 else (b.BSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSX then 0 else (b.BSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,BSX from NCMS_LD_View with(nolock) where BSX > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSX'     
     
                   
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NCDEX,NetPayable=NetPayable-b.NCDEX                    
 from(                    
 select client_code,NCDEX from NCMS_LD_View where NCDEX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NCDEX'                    
*/                
                
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NCDEX then 0 else (b.NCDEX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NCDEX then 0 else (b.NCDEX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NCDEX from NCMS_LD_View with(nolock) where NCDEX > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NCDEX'                    
                    
                    
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCX then 0 else (b.MCX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCX then 0 else (b.MCX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,MCX from NCMS_LD_View with(nolock) where MCX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCX'   
 */                   
 /**********************************************/           
   
 /***********************Start****************************************/  
 /*********Margin added in cash segment as per mail of sajeevn sir on 01Aug 2020****************/  
  /*    
DECLARE @MARGINDATE AS DATETIME         
SELECT @MARGINDATE=MAX(MARGINDATE) FROM anand1.msajag.dbo.tbl_combine_reporting_detail WITH (NOLOCK)     
--select @MARGINDATE  
select margindate,exchange,segment,party_code,tday_margin,tday_mtm,tday_margin+tday_mtm as margin INTO #MARGIN from  
 anand1.msajag.dbo.tbl_combine_reporting_detail with(nolock) where MARGINDATE=@MARGINDATE AND exchange in ('BSE','NSE') and segment='CAPITAL'  
  
  
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.margin,NetPayable=NetPayable-b.margin from                                                
 (select party_code,margin,exchange+'CM' as segment from #MARGIN WITH (NOLOCK) where margin>0) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0    
  */  
    
  DECLARE @MARGINDATE AS DATETIME           
SELECT @MARGINDATE=MAX(MARGIN_DATE) FROM AngelNseCM.msajag.dbo.tbl_mg02 WITH (NOLOCK)   
  
  
select a.* into #mg02 from AngelNseCM.msajag.dbo.tbl_mg02 a with (nolock), NCMS_PO_Request_ForPayout b with(nolock)  
 where a.partY_code=b.Party_code and  MARGIN_DATE=@MARGINDATE   
  
select a.*,convert(money,varamt/abs(netqty)) as pershare,b.short_qty  into #data from #mg02 a with(nolock)  join ncms_shortsell b with(nolock) on a.party_code=b.PARTY_cODE and a.scrip_cd=b.SCRIP_CD    
 and a.sett_no=b.sett_no where /* a.party_code='A2649' and*/    
   --MARGIN_DATE=@MARGINDATE and  
    ABS(netqty)<>0    
    
    select convert(money,pershare*short_qty) as varmargin ,party_code,scrip_cd,sett_no into #margin from #data  
  
    
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.varmargin/*,NetPayable=NetPayable-b.varmargin*/  from                                                  
 (select 'NSECM' as segment,party_code,varmargin=SUM(varmargin) from #margin /* where party_code='A2649'*/  
 group by party_Code having sum(varmargin) <> 0) b                                                  
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0    
    
 /***********************End****************************************/    
  
   
  /*****************peakmargin from bo for NSE BSE MTF************************/  
 DECLARE @MARGINDATEpeak AS DATETIME   , @MARGINDATEpeakBSE AS DATETIME ,@MARGINDATEpeakMTF as Datetime           
/*set @MARGINDATEpeak=cast(CAST(getdate()-1 as date)as datetime)*/  
SELECT @MARGINDATEpeak=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='NSE' and SEGMENT='CAPITAL'  
SELECT @MARGINDATEpeakBSE=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='BSE' and SEGMENT='CAPITAL'  
SELECT @MARGINDATEpeakMTF=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='MTF' and SEGMENT='MTF'  
  
  
--select cltcode,UDebitV*-1 as UDebitV,'NSE' as exchange into #unSettDr from AngelNseCM.inhouse.dbo.NCMS_PO_UnsetDr with(nolock) where UDebitV<0  
  
if((CONVERT(VARCHAR(5),GETDATE(),108)>='16:30') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))      
Begin  
 /*Commented start on 30 Jan 2023 for removing Peak margin*/  
 /*if(select COUNT(1) from  cms.dbo.NCMS_PeackMargin with(nolock))=0  
 begin  
  
   select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeak  
    and EXCHANGE='NSE' and SEGMENT='CAPITAL' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month varchar(10),@peakVar money=1  
       
      select @month=convert(char(3), GETDATE(), 0)  
   --select @month  
   --if(@month='Dec' or @month='Jan' or @month='Feb')  
   --begin  
   -- set @peakVar=0.25   
   -- print @peakVar  
   --end   
   --if(@month='Mar' or @month='Apr' or @month='May')  
   --begin  
   -- set @peakVar=0.5   
   -- print @peakVar  
   --end  
   --if(@month='Jun' or @month='Jul' or @month='Aug')  
   --begin  
   -- set @peakVar=0.75   
   -- print @peakVar  
   --end  
   --if(@month='Sep' or @month='Oct' or @month='Nov')  
   --begin  
   -- set @peakVar=1   
   -- print @peakVar  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar*/ as peakMargin into #peakMr from #aa  
    
    
   /*******************************************/  
   select a.exchange,b.party_code,b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as FinalPeak  
                       into #peak from #unSettDr a right join #peakMr b   
   on a.cltcode=b.party_code  
   /*******************************************/  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.FinalPeak/*,NetPayable=NetPayable-b.FinalPeak*/ from                                                  
  (select 'NSECM'  as segment,party_code,FinalPeak from #peak) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
  /*****************BSE***********/  
 select cltcode,UDebitV*-1 as UDebitV,'BSE' as exchange into #unSettDrBSE from AngelBSECM.inhouse.dbo.NCMS_PO_UnsetDr with(nolock) where UDebitV<0  
  
  select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa1  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeakBSE  
    and EXCHANGE='BSE' and SEGMENT='CAPITAL' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month1 varchar(10),@peakVar1 money=1  
       
   --   select @month1=convert(char(3), GETDATE(), 0)  
    
   --if(@month1='Dec' or @month1='Jan' or @month1='Feb')  
   --begin  
   -- set @peakVar1=0.25   
   -- print @peakVar1  
   --end   
   --if(@month1='Mar' or @month1='Apr' or @month1='May')  
   --begin  
   -- set @peakVar1=0.5   
   -- print @peakVar1  
   --end  
   --if(@month1='Jun' or @month1='Jul' or @month1='Aug')  
   --begin  
   -- set @peakVar1=0.75   
   -- print @peakVar1  
   --end  
   --if(@month1='Sep' or @month1='Oct' or @month1='Nov')  
   --begin  
   -- set @peakVar1=1   
   -- print @peakVar1  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar1*/ as peakMargin into #peakMr1 from #aa1  
    
   /*******************************************/  
   select a.exchange,b.party_code,b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as FinalPeak  
                       into #peak1 from #unSettDrBSE a right join #peakMr1 b   
   on a.cltcode=b.party_code  
   /*******************************************/  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.FinalPeak,NetPayable=NetPayable-b.FinalPeak from                                                  
  (select 'BSECM'  as segment,party_code,FinalPeak from #peak1) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
   
  /*****************MTF***********/  
  select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa11  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeakMTF  
    and EXCHANGE='MTF' and SEGMENT='MTF' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month11 varchar(10),@peakVar11 money=1  
       
   --   select @month11=convert(char(3), GETDATE(), 0)  
    
   --if(@month11='Dec' or @month11='Jan' or @month11='Feb')  
   --begin  
   -- set @peakVar11=0.25   
   -- print @peakVar11  
   --end   
   --if(@month11='Mar' or @month11='Apr' or @month11='May')  
   --begin  
   -- set @peakVar11=0.5   
   -- print @peakVar11  
   --end  
   --if(@month11='Jun' or @month11='Jul' or @month11='Aug')  
   --begin  
   -- set @peakVar11=0.75   
   -- print @peakVar11  
   --end  
   --if(@month11='Sep' or @month11='Oct' or @month11='Nov')  
   --begin  
   -- set @peakVar11=1   
   -- print @peakVar11  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar11*/ as peakMargin into #peak11 from #aa11  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.peakMargin,NetPayable=NetPayable-b.peakMargin from                                                  
  (select EXCHANGE as segment,party_code,peakMargin from #peak11) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
  end  
  /**************************************/  
 else  
  begin  
  */ /*Commented end on 30 Jan 2023 for removing Peak margin*/  
  /********For adding peak maegin********************/  
   /* select client_code,bsecm+nsecm+nsefo+Mcx+ncdex+nsx+mcd as LDAmt into #ee from [NCMS_LD_View]*/--comented on 22 July 2022  
    select Client_code,BSECMMargin+NSECMMargin+NSEFOMargin+MCXMargin+NCDEXMargin+NSXMargin+MCDMargin+BSXMargin as LDAmt into #ee from [NCMS_LD_MTM_Margin_view] with(nolock)  
     
 /*    declare @monthFile varchar(10),@peakVarFile money=1  
       
    SELECT [client code],total*@peakVarFile as peakMargin into #PEakFile FROM NCMS_PeackMargin   
     
    select a.exchange,b.[client code],b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as total  
                       into #PEakFileMain from #unSettDr a right join #PEakFile b   
    on a.cltcode=b.[client code]     
     
   SELECT [client code], MAX(total) as total  
   into #PeckMargin FROM  
   (  
    SELECT [client code], MAX(total) as total  
    FROM #PEakFileMain   
    GROUP BY [client code]  
    UNION ALL  
    SELECT client_code, MAX(LDAmt) as LDAmt  
    FROM #ee   
    GROUP BY client_code  
   ) as subQuery  
   GROUP BY [client code]  
*/  
   SELECT [client code], MAX(total) as total  
   into #LDMargin FROM  
   (  
    SELECT client_code as [client code], MAX(LDAmt) as total  
    FROM #ee   
    GROUP BY client_code  
   ) as subQuery  
   GROUP BY [client code]  
                
    update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.total/*OtherDebit=OtherDebit-b.total              */  
    /*,NetPayable=NetPayable-b.total */             
    from(                    
    select 'NSECM' as segment,[client code],total from #LDMargin with(nolock) where [client code] is not null and total<>0               
    ) b                     
    where #NCMS_SegwiseCldata.Party_code=b.[client code] and  #NCMS_SegwiseCldata.segment=b.segment                     
                    
  --end      
   
 end  
 /**************************/      
   
 /*******************added on 10 Mar 2021 for adding unsetteld Holding***************************************************/  
 declare @NONCASHconsideration as int = 100   
   
  update #NCMS_SegwiseCldata set NonCashConsideration=@NONCASHconsideration where Segment='NSECM'          
  
--select a.* into #NCMS_ROI from NCMS_ROI a with(nolock), NCMS_PO_Request_ForPayout b with(nolock)  
-- where a.partY_code=b.Party_code        
  
-- update #NCMS_SegwiseCldata set NonCashConsideration=b.CollateralPercent          
-- from #NCMS_ROI b  WITH (NOLOCK)   where #NCMS_SegwiseCldata.party_code=b.party_code  and  #NCMS_SegwiseCldata.Segment='NSECM'          
  
select * into #Vw_Todays_Secpayout from  AngelDEMAT.MSAJAG.dbo.Vw_Todays_Secpayout  with(nolock) where  
Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,  
CONVERT(MONEY, 0) as Value_BHC_unsett,  
CONVERT(MONEY, 0) as Value_AHC_unsett  
  into #unsett_holding from /*[196.1.115.197].msajag.dbo.unclear_hold*/ #Vw_Todays_Secpayout a with(nolock) join  
 [CSOKYC-6].GENERAL.DBO.Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/  
a.I_isin=b.security_isin join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.I_isin=c.[isin no]  
where a.party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
update #unsett_holding set Value_BHC_unsett=qty*MTM_Price_unsett  
update #unsett_holding set Value_AHC_unsett=isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)  
  
select SUM(Value_AHC_unsett) as Value_AHC_unsett,party_code into #holding_AHC from #unsett_holding group by party_code  
  
update #NCMS_SegwiseCldata set noncashcoll=Value_AHC_unsett from                         
 (select party_code,Value_AHC_unsett from #holding_AHC) b                                                  
 where #NCMS_SegwiseCldata.segment='NSECM' and #NCMS_SegwiseCldata.party_code=b.party_Code   
   
 -- alter table #NCMS_SegwiseCldata add marginAdjustWithLgr money   
   
 --update #NCMS_SegwiseCldata set marginAdjustWithLgr=0.00  
     
   ALTER TABLE #NCMS_SegwiseCldata ADD marginAdjustWithLgr money NOT NULL DEFAULT 0  
   
 update #NCMS_SegwiseCldata set ExpoUtilised=ExpoUtilised+  
 (case     
 when  noncashcoll=0 then   MarginAmt     
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0         
 then 0           
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll   
 end) ,  
 marginAdjustWithLgr=isnull(marginAdjustWithLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3  
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  
 from #NCMS_SegwiseCldata where segment='NSECM' -- and  party_code='D65765'  
   
   
update #NCMS_SegwiseCldata set NetPayable=NetPayable+ExpoUtilised+marginAdjustWithLgr  where segment='NSECM'   
       
 /*For reducing Bond value change done by Neha on 16 Jul2016*/    
 select client_code,Segment,Total into #bond_client from BondEntry with(nolock)     
     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.Total,NetPayable=NetPayable-b.Total                          
 from(                    
 select * from #bond_client    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment=b.segment      
     
     
      
 update a set POblocked=GETDATE() from BondEntry a,    
 (select * from #bond_client)b where    
 a.client_code=b.client_code     
     
     
 update a set Flexiblocked=b.Flexiblocked,POblocked=b.POblocked from bond.dbo.tbl_BondOrderEntry a with(nolock),    
 (select * from BondEntry with(nolock))b where    
 a.client_code=b.client_code and a.order_Status='PENDING'    
 and a.Verfiedon is null and a.POblocked is null                
    
    
    
    
  /*---------------------------------------------------------*/                   
    
    
 /*For Reducing mf pending orders in Payout*/    
    
DECLARE @Days VARCHAR(20)                          
                          
 SET @Days = (                          
   SELECT DATENAME(dw, GETDATE())                          
   )     
  
 /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF       
                            
IF (@Days = 'Monday' OR @Days = 'Saturday')                          
BEGIN         
    
 --select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund_sat from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)    
 --where cltcode     
 --in     
 --(select clientcode from risk.dbo.vw_MutualFundPendingOrder_NCMS_sat with(nolock)    where segment in ('MF','Trade' ))    
 --and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)      
 --and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 --group by cltcode    
    
 /*    
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal     
 from #MFFund m inner join    
risk.dbo.vw_MutualFundPendingOrder_NCMS o    
 on m.cltcode=o.clientcode    
 where balance<=0    
 group by m.cltcode,m.balance    
 */    
    
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal_sat       
 from     
 risk.dbo.vw_MutualFundPendingOrder_NCMS_sat o  with(nolock)   ,NCMS_PO_Request_ForPayout b where o.clientcode=b.Party_code   
 group by clientcode    
    
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)    
 select cltcode,amount,getdate() from #MFFundFinal_sat    
    
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),    
a.*,b.amount into #segmentwise_pendingorders_sat    
 from    
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')    
 and NetPayable>0)a    
 inner join  (select cltcode,amount from #MFFundFinal_sat) b    
 on a.party_code=b.cltcode;    
    
 with cte    
 as    
 (    
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,    
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,    
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end    
  from #segmentwise_pendingorders_sat where srno=1 --and party_code='AACW016'    
  union all    
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,    
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,    
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end    
  from #segmentwise_pendingorders_sat a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'    
 )    
 select * into #mf_segamountadjust_sat from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)    
    
    
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                       
  (                    
 select * from #mf_segamountadjust_sat    
  ) b                     
  where a.Party_code=b.party_code and a.Segment=b.segment     
    
 drop table #mf_segamountadjust_sat    
 drop table #segmentwise_pendingorders_sat    
 drop table #MFFundFinal_sat    
end    
else    
begin    
 --select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)    
 --where cltcode     
 --in     
 --(select clientcode from risk.dbo.vw_MutualFundPendingOrder_NCMS with(nolock)    where segment in ('MF','Trade' ))    
 --and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)      
 --and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 --group by cltcode    
    
 /*    
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal     
 from #MFFund m inner join    
 risk.dbo.vw_MutualFundPendingOrder_NCMS o    
 on m.cltcode=o.clientcode    
 where balance<=0    
 group by m.cltcode,m.balance    
 */    
    
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal       
 from     
 risk.dbo.vw_MutualFundPendingOrder_NCMS o with(nolock)    ,NCMS_PO_Request_ForPayout b where o.clientcode=b.Party_code   
 group by clientcode    
    
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)    
 select cltcode,amount,getdate() from #MFFundFinal    
    
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),    
 a.*,b.amount into #segmentwise_pendingorders    
 from    
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')    
 and NetPayable>0)a    
 inner join  (select cltcode,amount from #MFFundFinal) b    
 on a.party_code=b.cltcode;    
    
 with cte    
 as    
 (    
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,    
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,    
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end    
  from #segmentwise_pendingorders where srno=1 --and party_code='AACW016'    
  union all    
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,    
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,    
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end    
  from #segmentwise_pendingorders a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'    
 )    
 select * into #mf_segamountadjust from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)    
    
    
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                       
  (                    
 select * from #mf_segamountadjust    
  ) b                     
  where a.Party_code=b.party_code and a.Segment=b.segment     
     
 drop table #mf_segamountadjust    
 drop table #segmentwise_pendingorders    
 drop table #MFFundFinal    
end    
    
   */  
     
     
 /*************************************************************************************/    
     
 /*For Reducing BSE Orders added on 05 May 2017*/    
              
 IF (@Days = 'Monday')                          
 BEGIN     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                      
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE_sat with(nolock)                   
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                        
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode      
 end     
else    
begin     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                      
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE  with(nolock)                  
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                        
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode      
 end    
 /*---------------------------------------------------------*/       
 /*****Start************For reducing Bills of BSE NSE*************************************************************************/  
DECLARE @billdate AS DATE   
SELECT  @billdate=getdate()  
  
   
if(SELECT COUNT(1) FROM angelnsecm.msajag.dbo.TBL_CASH_PROCESS_LOG WITH (NOLOCK) WHERE BUSINESS_DATE = @billdate AND PROCESS_NAME = 'PRNETTOTAL_RTB'  
AND PROCESS_FLAG = 1)=1  
BEGIN  
  
 insert into NCMS_RTB_log  
 select *,getdate() from angelnsecm.msajag.dbo.PRNETTOTAL_RTB WITH (NOLOCK) WHERE TRADEDATE= @billdate  
  
 SELECT PARTY_CODE,SEGMENT,PAY_IN_PAY_OUT_OBLIGATION into #rtb FROM angelnsecm.msajag.dbo.PRNETTOTAL_RTB WITH (NOLOCK) WHERE   
 TRADEDATE= @billdate  
 select party_code,sum(pay_in_pay_out_obligation) billamount into #club1 from   #rtb group by party_code  
  
  update #NCMS_SegwiseCldata set OtherDebit=isnull(OtherDebit,0)-b.billamount,NetPayable=NetPayable-b.billamount                          
  from(                    
  select distinct billamount*-1 as billamount,PARTY_CODE from #club1 with(nolock)   where billamount<0  
  ) b                     
  where #NCMS_SegwiseCldata.Party_code=b.PARTY_CODE and #NCMS_SegwiseCldata.segment='NSECM'   
  
END  
else  
BEGIN  
 if(select PROCESS_STATUS from AngelNseCM.msajag.dbo.TBL_AUTO_PROCESS_DETAIL with(nolock) where Business_Date=@billdate and PROCESS_FOR ='POSTBILL'  
 and sett_type='M')=0  
 begin  
 if(select PROCESS_STATUS from AngelNseCM.msajag.dbo.TBL_AUTO_PROCESS_DETAIL with(nolock) where Business_Date=@billdate and PROCESS_FOR ='POSTBILL'  
 and sett_type='Z')=0  
 begin  
 if(select posting from AngelNseCM.msajag.dbo.V2_Business_Process with(nolock) where Business_Date=@billdate and sett_type ='M' )=0  
 begin  
 if(select posting from AngelNseCM.msajag.dbo.V2_Business_Process with(nolock) where Business_Date=@billdate and sett_type='Z' )=0  
 begin  
  
   insert into BseCmbillGendata_log  
   select *,getdate() from Mimansa.Clientservice.dbo.BseCmbillGendata with(nolock)  
  
   insert into NseCmbillGendata_log  
   select *,getdate() from Mimansa.Clientservice.dbo.NseCmbillGendata with(nolock)  
  
     select *,AMOUNT+Brokerage+SERVICE_TAX+TURN_TAX+SEBI_TAX+INS_CHRG+BROKER_CHRG as BillAmount  
  into #erNewn  from Mimansa.clientservice.dbo.NseCmbillGendata with(nolock) --where amount>0  
  where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
     select *,AMOUNT+Brokerage+SERVICE_TAX+TURN_TAX+SEBI_TAX+INS_CHRG+BROKER_CHRG as BillAmount  
   into #er1Newn from  Mimansa.Clientservice.dbo.BseCmbillGendata with(nolock)-- where amount>0  
  where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
    update #erNewn  set billamount=case when billamount<0 then billamount*-1 when billamount>0 then billamount*-1 end   
    update #er1Newn  set billamount=case when billamount<0 then billamount*-1 when billamount>0 then billamount*-1 end   
  
  
   select x.party_code,sum(billamount) as billamount into #club from  
   (select party_code,billamount from #erNewn  
   union all  
   select party_code,billamount from #er1Newn)x  group by party_code    
  
   update #NCMS_SegwiseCldata set OtherDebit=isnull(OtherDebit,0)-b.billamount,NetPayable=NetPayable-b.billamount                          
   from(                    
   select distinct billamount*-1 as billamount,PARTY_CODE from #club with(nolock)   where billamount<0  
   ) b                     
   where #NCMS_SegwiseCldata.Party_code=b.PARTY_CODE and #NCMS_SegwiseCldata.segment='NSECM'  /*#NCMS_SegwiseCldata.Segment='NSEFO'     */  
  end  
  end  
  end  
  end  
END  
  
 /*****End****************************************************************************/     
     
/******Start*********************For Deducting Brokerage charges*************************/    
 select distinct Brokerage+Gst+STT+TurnoverCharges+SebiFees+StampDuty as brokerage,PARTY_CODE,segment into #NSECM_Brokerage from NCMS_BrokerageCharges with(nolock)   
 where segment not in ('BSECM','NSECM')  
  
 select party_code,sum(brokerage) as brokerage into #New_brokerage from #NSECM_Brokerage group by party_code  
  
 update a set OtherDebit=isnull(OtherDebit,0)-b.brokerage,NetPayable=NetPayable-b.brokerage                          
 from #NCMS_SegwiseCldata a,(                    
 select party_code,brokerage from #New_brokerage  
 ) b                     
 where a.Party_code=b.PARTY_CODE and a.segment='NSECM' /*#NCMS_SegwiseCldata.segment=b.segment*/ /*#NCMS_SegwiseCldata.Segment='NSEFO'     */  
     
 /*****End****************************************************************************/   
   
DECLARE @billdate1 AS DATE   
SELECT  @billdate1=getdate()  
   
Select Party_code,AMT=Sum(case when sell_buy=1 Then Amount*-1 Else Amount end) into #nsefoRTB  
from [angelfo].NSEFO.dbo.foaccbill with(Nolock) where billdate =@billdate1  
Group by Party_code  
  
  update a set OtherDebit=isnull(OtherDebit,0)-b.Amt,NetPayable=NetPayable-b.Amt                          
 from #NCMS_SegwiseCldata a,(                    
 select party_code,(Amt*-1) as Amt from #nsefoRTB where amt<0  
 ) b                     
 where a.Party_code=b.PARTY_CODE and a.segment='NSEFO'   
 /************************************************************************************/  
     
   /*update net basis of Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/  
   
  update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.loss ,OtherDebit=isnull(OtherDebit,0)-b.loss from                                                
 (select party_code,loss,exchange+'CM' as segment from NCMS_Intraday_loss with(nolock)) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0 and NetPayable>0   
   
/***********************************************************************************/  
     
  /*********************Added on 30 may 2022 for removing SIP**************************************************************/  
  /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF       
  
select sclientcode,sactualduedate,sum(convert(money,sInstallmentAmt)) as sInstallmentAmt,'BSEMFSS' as segment into #sum FROM   
[196.1.115.253].MutualFund.dbo.vw_sip_installments with(nolock)  
group by sclientcode,sactualduedate     
  
 update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.sInstallmentAmt ,OtherDebit=OtherDebit-b.sInstallmentAmt from                                                
 (select * from #sum with(nolock)) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.sclientcode  
*/  
  /**********************************************************************************/   
 /***********************for Adding Delivery Margin Added on 14 Jun 2019 By Neha Naiwar ************************************/    
--DECLARE @MARGINDATE AS DATETIME,@sdtcur as datetime             
--SELECT @MARGINDATE=MAX(MARGINDATE) FROM angelfo.NSEFO.dbo.tbl_clientmargin WITH (NOLOCK)       
    
--SELECT * into #delmargin FROM Angelfo.NSEFo.dbo.FOMARGINNEW with(nolock) WHERE  MDATE =@MARGINDATE/*convert(datetime,convert(varchar(8),getdate(),112))*/    
--AND DEL_MARGIN <>0    
    
--  UPDATE a                                                            
--  set MarginAmt =  MarginAmt-DEL_MARGIN                         
--  FROM #NCMS_SegwiseCldata a                                                 
--  JOIN                                                            
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                          
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'      
      
--  UPDATE a                                                            
--  set NetPayable =  NetPayable-DEL_MARGIN                         
--  FROM #NCMS_SegwiseCldata a                                                 
--  JOIN                                                            
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                          
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'       
/*************************************************************************************/    
     
               
  truncate table NCMS_SegVeriData                          
  insert into NCMS_SegVeriData                                            
  (                                            
  POrequestID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,                                            
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                          
  )                                              
  select   /*ROW_NUMBER() OVER ( ORDER BY party_code,segment) AS refno,*/                            
  convert(varchar(6),getdate(),112)+replace(convert(varchar(8),getdate(),108),':','') AS refno,                            
  ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,isnull(OtherDebit,0),NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                             
  from #NCMS_SegwiseCldata                                               
    
  /*******************************************************Added for combine margin****/  
  select * into #new_NCMS_SegwiseCldata from #NCMS_SegwiseCldata with(nolock) where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
    
  update #new_NCMS_SegwiseCldata set Balance=0.00,UnsettledCrBill=0.00 where NetPayable=0 and Segment='BSEMFSS'  
  update #new_NCMS_SegwiseCldata  set UnsettledCrBill=0.00 where  Segment='BSEMFSS'  and  NetPayable>0  and UnsettledCrBill<0  
  
update  #new_NCMS_SegwiseCldata set Balance=NetPayable where Balance=0 and AccruedCharges=0 and marginamt=0 and segment='bsemfss' and NetPayable<0  
    
 select max(ProcessDate) ProcessDate,Entity,Party_code,Flag,sum(Balance)Balance,sum(UnsettledCrBill) UnsettledCrBill,sum(UnrecoAmt) UnrecoAmt,    
 sum(ShortSellValue) ShortSellValue,sum(MarginAmt) MarginAmt,SUM(deposit) Deposit,sum(CashColl)CashColl,sum(NonCashColl) NonCashColl,    
 sum(MarginAdjWithColl) MarginAdjWithColl,sum(MarginShortage) MarginShortage,sum(AccruedCharges) AccruedCharges,sum(OtherDebit) OtherDebit,    
 max(100) NonCashConsideration--,SUM(ExpoUtilised) as ExpoUtilised,sum(NetPayable) NetPayable  
 ,case when entity='AllSegment' then 0.00 else SUM(ExpoUtilised) end as ExpoUtilised,  
 case when entity='AllSegment' then 0.00 else sum(NetPayable) end NetPayable  
 into #ncms    
 from  #new_NCMS_SegwiseCldata  /*where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))*/  
 group by Entity,Party_code,Flag    
   
 --  update #ncms set NonCashConsideration=100.00 --from #ncms     /*added on 08 Oct 2021 by Neha naiwar*/  
  
 -- /*alter table #ncms add marginAdjustWithCombineLgr money */  /*added on 08 Oct 2021 by Neha naiwar*/  
     
 --update #ncms set /*marginAdjustWithCombineLgr=0.00 ,*/ExpoUtilised=0.00 ,NetPayable=0.00 where entity='AllSegment'  
     
 update #ncms set ExpoUtilised=ExpoUtilised+    
 (case       
 when  noncashcoll=0 then   MarginAmt       
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0           
 then 0             
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll     
 end)     
 /*,marginAdjustWithCombineLgr=isnull(marginAdjustWithCombineLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3    
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  */   /*added on 08 Oct 2021 by Neha naiwar*/  
 from #ncms where entity='AllSegment'  
   
 update #ncms set NetPayable=Balance+ExpoUtilised+/*marginAdjustWithCombineLgr+*/UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges+OtherDebit   
  where entity='AllSegment'  
  
/***Added on 22 July 2022************************/  
/*select Client_code,BSECMMTM+NSECMMTM+NSEFOMTM+MCXMTM+NCDEXMTM+NSXMTM+MCDMTM+BSXMTM as LDAmtMTM into #LDMTM from [NCMS_LD_MTM_Margin_view]*/  
select Client_code,BSECMMTM+NSECMMTM+MCXMTM+NCDEXMTM+NSXMTM+MCDMTM+BSXMTM as LDAmtMTM into #LDMTM from [NCMS_LD_MTM_Margin_view]  
  
  
 update a set NetPayable=NetPayable-LDAmtMTM from #ncms a join #LDMTM b on a.party_code=b.Client_code  
  where entity='AllSegment' and LDAmtMTM<>0  
  
 update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from #ncms a left join #LDMTM b on a.party_code=b.Client_code  
  where entity='AllSegment' and LDAmtMTM<>0  
/*********************************/  
  
 update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from NCMS_SegVeriData a , #LDMTM b where a.party_code=b.Client_code    
  and segment='NSECM' and LDAmtMTM<>0    
  
/***Added on 08 Aug 2022 for adjusting Ad-hoc margin values************************/  
  select a.party_code,(amt*-1) as amt into #adhocdata from risk.dbo.tbl_Omne_CM_MarginData a with(nolock)  ,NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
  
  update a set amt=amount from #adhocdata a join NCMS_tbl_AdhocMargin b on a.party_code=b.party_code   
  
  insert into NCMS_Adhoc_final_hist  
 select *,GETDATE() from NCMS_Adhoc_final  
  
 truncate table NCMS_Adhoc_final  
   
 insert into NCMS_Adhoc_final  
 select * from #adhocdata  
  
  truncate table NCMS_tbl_AdhocMargin  
if( DATEPART(DW,GETDATE())>6 and DATEPART(DW,GETDATE())<=7)    
begin  
 truncate table NCMS_Adhoc_final  
end  
select * into #adhoc from NCMS_Adhoc_final with(nolock) where amt<>0  
   
 update a set NetPayable=NetPayable+Amt,OtherDebit=isnull(OtherDebit,0)+Amt from #ncms a join #adhoc b on a.party_code=b.party_code  
  where entity='AllSegment'  
  
   update a set OtherDebit=isnull(OtherDebit,0)+Amt from NCMS_SegVeriData a join #adhoc b on a.party_code=b.party_code  
  where segment='NSECM'  
  /*******************************************/  
  
truncate table NCMS_CombineVeriData  
 insert into NCMS_CombineVeriData                                            
  (                                            
  POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,                                            
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                          
  )                                              
  select   /*ROW_NUMBER() OVER ( ORDER BY party_code,segment) AS refno,*/                            
  convert(varchar(6),getdate(),112)+replace(convert(varchar(8),getdate(),108),':','') AS refno,                            
  ProcessDate,Entity,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                             
  from #ncms    
    
  insert into NCMS_CombineVeriData_hist  
  (  
  POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,  
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,updatedOn  
  )   
  select POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,  
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,GETDATE() from NCMS_CombineVeriData  
         
/* For checking duplicate Account no.*/                      
                          
  declare @StatusJob varchar(20)                               
  set @StatusJob=''             
  exec CMS.dbo.Get_JoBStatus 'NCMS Double Entry in ACC no',@StatusJob  output                               
  print @StatusJob                      
                      
                      
  if(@StatusJob='In Progress')                                
   print 'job is already running'                            
  else                        
   EXEC msdb.dbo.sp_start_job 'NCMS Double Entry in ACC no'   
  
   
/* For Verify process*/                      
if(select flag from ncms_batch_process with(nolock) where Srno=15)=1  
Begin                           
  declare @StatusJobVerify varchar(20)                               
  set @StatusJobVerify=''             
  exec CMS.dbo.Get_JoBStatus 'NCMS Verifier Step',@StatusJobVerify  output                               
  print @StatusJobVerify                      
                      
                      
  if(@StatusJobVerify='In Progress')                                
   print 'job is already running'                            
  else                        
   EXEC msdb.dbo.sp_start_job 'NCMS Verifier Step'   
End   
 /*         
 insert into NCMS_SegVeriData_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                      
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                      
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                      
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                      
 from NCMS_SegVeriData with (nolock)              
 */        
                                               
  /* exec NCMS_UPD_ReqVerId @pcode,@refno      */                                
                                            
--End try                       
                                                
--BEGIN CATCH                                                        
                                                    
--  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                              
--  select GETDATE(),'NCMS_VeriData_Batchwise',ERROR_LINE(),ERROR_MESSAGE()                                                              
                                
-- DECLARE @ErrorMessage NVARCHAR(4000);                                                              
-- SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                              
-- RAISERROR (@ErrorMessage , 16, 1);                                    
                                                     
--End catch                                                    
                                                      
--Set nocount off   
  
end  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_VeriData_Batchwise_10Jan2024
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[NCMS_VeriData_Batchwise_10Jan2024]                                
as                                                      
  /* FETCH DATA */    
if(select flag from ncms_batch_process with(nolock) where Srno=15)=1  
Begin   
  begin  
                                                      
   Create table #NCMS_SegwiseCldata (                                                          
   id int,                                              
   ProcessDate datetime,                                              
   Entity varchar(10),                                              
   Segment varchar(10),                                              
   Party_code varchar(10),                                              
   Flag char(1),                                              
   Balance money,                                              
   UnsettledCrBill money,                                              
   UnrecoAmt money,                                              
   ShortSellValue money,                                              
   MarginAmt money,                                              
   Deposit money,                                              
   CashColl money,                                              
   NonCashColl money,                                              
   MarginAdjWithColl money,                                              
   MarginShortage money,                                              
   AccruedCharges money,                                              
   OtherDebit money,                                              
   NonCashConsideration money,                                              
   ExpoUtilised money,                                              
   UnPosted_PO money,                   
   NetPayable money                                          
   )                                                                                                             
                                                
                          
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime,'AllSegment','BSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                       
  from AngelBSECM.inhouse.dbo.NCMS_PO  with(nolock)                                                   
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','NSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                       
  from AngelNseCM.inhouse.dbo.NCMS_PO  with(nolock)                                                        
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                            
 select ProcessDatetime,'AllSegment','MTF',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                   
 from AngelNseCM.MTFTRADE.dbo.NCMS_PO  with(nolock)      
                                                         
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelfo.inhouse.dbo.NCMS_marh  with(nolock)                                                        
  /* and PayoutValue <> 0*/     
    
  /******BSEFO***************/  
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','BSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.BSEFO.dbo.NCMS_marh  with(nolock)    
  /*********************/  
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelfo.inhouse_curfo.dbo.NCMS_marh  with(nolock)               
  /* and PayoutValue <> 0*/                                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','MCD',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.INHOUSE_MCDCS.dbo.NCMS_marh  with(nolock)                                                        
  /* and PayoutValue <> 0*/                                                      
    
     
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                  
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                 
 select UpdDatetime,'AllSegment','BSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                   
 from angelcommodity.inhouse_bsx.dbo.NCMS_marh  with(nolock)      
                                                         
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','NCDEX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.inhouse_NCDX.dbo.NCMS_marh   with(nolock)                                                       
/* and PayoutValue <> 0*/                                                     
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select UpdDatetime,'AllSegment','MCX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                       
  from angelcommodity.inhouse_MCDX.dbo.NCMS_marh   with(nolock)                                                       
  /* and PayoutValue <> 0*/                                                     
                       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','BSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,AfterAdjustedBal/*VBal+UCV+UnRecoCr+OtherDr */          
 from /*angelfo.inhouse.dbo.NCMS_PO_BSEMFSS*/   angelfo.inhouse.dbo.NCMS_PO_BSEMFSS_edt with(nolock)    
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                        
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','NSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                 
  from angelfo.inhouse.dbo.NCMS_PO_NSEMFSS with(nolock)                                                         
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                                                    
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select ProcessDatetime,'AllSegment','IPO',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                             
  from NCMS_PO_IPO with(nolock)                                                        
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                    
                              
  /*                           
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                      
  select processDate,'NBFC','NBFC',party_Code,'I',LogicalLedger,Unsettled,0,ShortValHC,0,0,0,VAHC,0,0,AccruedInt,ShortVal,0,0,NetAmount                                                   
from [172.31.16.57].inhouse.dbo.ncms_po /* and netAmount <> 0 */                                    
  */                              
                                
  /* NBFC verification not required. verification is based on BOD processed data */                              
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                              
  select                               
  ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                              
  from NCMS_SegwiseCldata with (nolock) where entity='NBFC'                              
      
    /************************************************************************************************************************************************/     
/************************************************************************************************************************************************/     
    /*Changed in order to consider MTM of cases where there is no ledger added by Neha Naiwar on suggestion from Bhavin Parikh dt: 23th June 2016*/         
     select * into #LD from NCMS_LD_View a with(nolock) ,NCMS_PO_Request_ForPayout b  where a.client_code=b.Party_code  
     
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where BSECM > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSECM' ) and isnull(client_code,'')<>''    
      
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where NSECM > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSECM' ) and isnull(client_code,'')<>''    
       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSEFO',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a  with(nolock)  where NSEFO > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSEFO' ) and isnull(client_code,'')<>''                           
       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)   where NSX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSX' ) and isnull(client_code,'')<>''                                                       
     
   insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCD',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)   where MCD > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCD' ) and isnull(client_code,'')<>''     
     
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock)  where BSX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSX' ) and isnull(client_code,'')<>''     
     
     insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NCDEX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock) where NCDEX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NCDEX' ) and isnull(client_code,'')<>''     
     
      insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                  
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                       
  from #LD a with(nolock) where MCX > 0   and not exists    
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCX' ) and isnull(client_code,'')<>''    
    
/************************************************************************************************************************************************/    
/**********************Adding NSECM Clients if not exist*********************************/  
 /*suggestion*/  
 /*insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                      
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)     
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSECM',cltcode=Cl_Code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,  
  0,0,0,OtherDr=0,0,0,0                                                       
  from AngelNseCM.msajag.dbo.client_brok_details a with(nolock) where  isnull(Deactive_value,'') not in ('T','C') and exchange='NSE' and segment='CAPITAL'   
    and not exists    
 (select * from #NCMS_SegwiseCldata b where a.Cl_Code=b.party_code and segment='NSECM' ) and isnull(Cl_Code,'')<>''   
 --and exists (select distinct Party_code from NCMS_PO_Request_ForPayout c with(nolock) where a.cl_code=c.Party_code)  
 */  
/************************************************************************************************************************************************/     
  /* Accrured Charges */                                                  
                                                                                      
 --select a.party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                     
 --from /*misc.dbo.Accrued_PenalCharges*/ NCMS_Accrued_PenalCharges a with (nolock) ,NCMS_PO_Request_ForPayout b  where a.party_code=b.Party_code   
 --group by a.party_code     
   
 select a.PARTY_CODE,(OTHER_DEBIT*-1) as OTHER_DEBIT into #AccCharges from tbl_other_debit a with (nolock) ,NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
  
 select a.PARTY_CODE,DeductEQ=sum(a.OTHER_DEBIT),DeductComm=0.00 into #Accrued1  
 from #AccCharges a with (nolock)-- ,NCMS_PO_Request_ForPayout b  where a.client=b.Party_code   
 group by a.PARTY_CODE     
     
 /******added new margin peneality charges on 05 Jul 2021***********************************/    
 --insert into #Accrued1    
 -- select a.party_code,DeductEQ=SUM(Value_amt),DeductComm=0.00 from [CSOKYC-6].General.dbo.tbl_EarlyPayin_Charges a with(nolock)  
 -- ,NCMS_PO_Request_ForPayout b  where a.party_code=b.Party_code group by a.party_code  
  
 --insert into #Accrued1    
 -- select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code              
   
   
 insert into  #Accrued1  
 select a.party_code,DeductEQ=Balance,DeductComm=0.00 from  NCMS_WO_Master a with(nolock),NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
 /*Added for W/O Margin on 16 Nov 2021*/          
   
   
--insert into  #Accrued1  
--SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM anand1.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)  
--where cnt_Date=(select max(cnt_Date) from anand1.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))  
--group by cltcode  
  
--insert into  #Accrued1  
--SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM anand1.MSAJAG.DBO.JVPNC_LOG J (Nolock),anand1.MSAJAG.DBO.client_details c(Nolock)  
--where  PCN_Date=(select max(PCN_Date) from anand1.MSAJAG.DBO.JVPNC_LOG J (Nolock))  
-- and J.cl_code=c.cl_code  
--group by J.cl_code   
  
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                           
    
 --select client as party_code,DeductEQ*-1 as DeductEQ ,DeductComm as DeductComm into #Accrued from #Accrued1 --group by client                                           
    
 /****************************************/                                                  
                                                   
 update #NCMS_SegwiseCldata set AccruedCharges=-Accured,NetPayable=NetPayable-Accured                                                  
 from                                                  
 (                                                  
  select q.segment,q.party_code,                                                  
  (Case when q.entity='AllSegment' then DeductEQ else DeductComm end) as Accured                                                  
  from #Accrued p join                                                   
  (                                                  
  select x.*,y.segment from                                                  
  (                                                  
  select a.entity,party_Code,min(b.seqid) as seqid                                                  
  from #NCMS_SegwiseCldata a join ncms_entity b on a.segment=b.segment                                                   
  group by a.entity,party_Code                                                  
  ) x join ncms_entity y with(nolock) on x.seqid=y.seqid and x.entity=y.entity                                                  
  ) q on p.party_Code=q.party_Code                                                   
 ) AC                                                  
 where #NCMS_SegwiseCldata.party_code=AC.party_Code and #NCMS_SegwiseCldata.segment=AC.Segment                                                  
 and #NCMS_SegwiseCldata.segment <> 'NBFC'                                          
                                                   
    
  /* select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 into #Accrued from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code              
  
UPDATE a                                                          
  set AccruedCharges=AccruedCharges+b.DeductEQ,NetPayable=NetPayable+b.DeductEQ                                                               
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                                             
  (select party_code,DeductEQ=-DeductEQ from #Accrued with (nolock) ) b                                              
  ON a.party_code=b.party_Code         
  where a.Segment <> 'NBFC'   and a.Segment='NSECM'     */                                                 
                
                      
  /* BSECM & NSECM Zero for NBFC Clients */                                                      
                                  
  /*                                                             
  UPDATE a                                                          
  set NetPayable = 0,ShortSellValue=0,Balance=0                                              
  FROM #NCMS_SegwiseCldata a                           
  JOIN                                                          
  (select Party_code from risk.dbo.client_Details where cl_type in ('NBF','TMF')) b                                               
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                       
  */                              
                                
  /*---- Only unreco cheque amount of BSECM and NSECM should get deducted from NBFC Net payable */                              
  UPDATE a                                                          
  set NetPayable =  UnrecoAmt+AccruedCharges                                 
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                                                          
  (select Party_code from risk.dbo.client_Details with(nolock) where cl_type in ('NBF','TMF')) b                                        
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                       
                                                        
  /* Update Shortage Value */                                                      
/*                              
  UPDATE a          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
 FROM #NCMS_SegwiseCldata a                                               
  JOIN                                                          
  (select party_code,shrtval=sum(dedVal) from risk.dbo.Vw_CMSVerified_BSECM_ShrtVal group by party_Code having sum(dedVal) <> 0) b                 
  ON a.segment='BSECM' and a.party_code=b.party_Code                                                      
                                         
  UPDATE a                                                          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
  FROM #NCMS_SegwiseCldata a                       
  JOIN                                                          
  (select party_code,shrtval=sum(dedVal) from risk.dbo.Vw_CMSVerified_NSECM_ShrtVal group by party_Code  having sum(dedVal) <> 0) b                                                      
  ON a.segment='NSECM' and a.party_code=b.party_Code                                                      
*/                              
                           
/* Only BOD shortage is considered in verification */                              
/*                  
  UPDATE a                                                          
  set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval                                               
  FROM #NCMS_SegwiseCldata a                                               
  JOIN                      
  (                              
 select segment,party_code,Shrtval=ShortSellValue from NCMS_SegwiseCldata with (nolock)                              
 where (SEGMENT='BSECM' OR SEGMENT='NSECM') AND ShortSellValue <> 0                              
  ) B                               
  ON a.segment=B.SEGMENT and a.party_code=b.party_Code                                                       
*/                  
                    
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                                                      
(select seg+'CM' as seg,party_code,shrtval=SUM(NetShortValue) from ncms_shortsell with(nolock)                   
group by seg,party_Code having sum(NetShortValue) <> 0) b                        
 where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.party_Code                                                      
                    
/* Reduce LD Data */                    
 /*            
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.BSECM,NetPayable=NetPayable-b.BSECM                    
 from(                    
 select client_code,BSECM from NCMS_LD_View where BSECM > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSECM'                    
 */            
   /*********commented*******************************/   
/*         
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSECM then 0 else (b.BSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSECM then 0 else (b.BSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,BSECM from NCMS_LD_View with(nolock) where BSECM > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSECM'              
             
 /*            
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSECM,NetPayable=NetPayable-b.NSECM                    
 from(                    
 select client_code,NSECM from NCMS_LD_View where NSECM > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSECM'                    
 */            
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSECM then 0 else (b.NSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSECM then 0 else (b.NSECM+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSECM from NCMS_LD_View with(nolock) where NSECM > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSECM'              
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSEFO,NetPayable=NetPayable-b.NSEFO                    
 from(                    
 select client_code,NSEFO from NCMS_LD_View where NSEFO > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSEFO'                    
 */            
             
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSEFO then 0 else (b.NSEFO+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSEFO then 0 else (b.NSEFO+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSEFO from NCMS_LD_View with(nolock) where NSEFO > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSEFO'              
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.MCD,NetPayable=NetPayable-b.MCD                    
 from(                    
 select client_code,MCD from NCMS_LD_View where MCD > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCD'                    
 */            
             
   update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCD then 0 else (b.MCD+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCD then 0 else (b.MCD+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,MCD from NCMS_LD_View with(nolock) where MCD > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCD'              
             
               
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NSX,NetPayable=NetPayable-b.NSX                    
 from(                    
 select client_code,NSX from NCMS_LD_View where NSX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSX'              
 */            
  update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSX then 0 else (b.NSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NSX then 0 else (b.NSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NSX from NCMS_LD_View with(nolock) where NSX > 0                   
 ) b             
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NSX'                     
    
    
  update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSX then 0 else (b.BSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.BSX then 0 else (b.BSX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,BSX from NCMS_LD_View with(nolock) where BSX > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSX'     
     
                   
 /*                   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.NCDEX,NetPayable=NetPayable-b.NCDEX                    
 from(                    
 select client_code,NCDEX from NCMS_LD_View where NCDEX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NCDEX'                    
*/                
                
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NCDEX then 0 else (b.NCDEX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.NCDEX then 0 else (b.NCDEX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,NCDEX from NCMS_LD_View with(nolock) where NCDEX > 0                   
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='NCDEX'                    
                    
                    
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit+                
 (Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCX then 0 else (b.MCX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 ,NetPayable=NetPayable+(Case when #NCMS_SegwiseCldata.MArginAmt*-1 > b.MCX then 0 else (b.MCX+#NCMS_SegwiseCldata.MArginAmt)*-1 end)                
 from(                    
 select client_code,MCX from NCMS_LD_View with(nolock) where MCX > 0                    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='MCX'   
 */                   
 /**********************************************/           
   
 /***********************Start****************************************/  
 /*********Margin added in cash segment as per mail of sajeevn sir on 01Aug 2020****************/  
  /*    
DECLARE @MARGINDATE AS DATETIME         
SELECT @MARGINDATE=MAX(MARGINDATE) FROM anand1.msajag.dbo.tbl_combine_reporting_detail WITH (NOLOCK)     
--select @MARGINDATE  
select margindate,exchange,segment,party_code,tday_margin,tday_mtm,tday_margin+tday_mtm as margin INTO #MARGIN from  
 anand1.msajag.dbo.tbl_combine_reporting_detail with(nolock) where MARGINDATE=@MARGINDATE AND exchange in ('BSE','NSE') and segment='CAPITAL'  
  
  
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.margin,NetPayable=NetPayable-b.margin from                                                
 (select party_code,margin,exchange+'CM' as segment from #MARGIN WITH (NOLOCK) where margin>0) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0    
  */  
    
  DECLARE @MARGINDATE AS DATETIME           
SELECT @MARGINDATE=MAX(MARGIN_DATE) FROM AngelNseCM.msajag.dbo.tbl_mg02 WITH (NOLOCK)   
  
  
select a.* into #mg02 from AngelNseCM.msajag.dbo.tbl_mg02 a with (nolock), NCMS_PO_Request_ForPayout b with(nolock)  
 where a.partY_code=b.Party_code and  MARGIN_DATE=@MARGINDATE   
  
select a.*,convert(money,varamt/abs(netqty)) as pershare,b.short_qty  into #data from #mg02 a with(nolock)  join ncms_shortsell b with(nolock) on a.party_code=b.PARTY_cODE and a.scrip_cd=b.SCRIP_CD    
 and a.sett_no=b.sett_no where /* a.party_code='A2649' and*/    
   --MARGIN_DATE=@MARGINDATE and  
    ABS(netqty)<>0    
    
    select convert(money,pershare*short_qty) as varmargin ,party_code,scrip_cd,sett_no into #margin from #data  
  
    
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.varmargin/*,NetPayable=NetPayable-b.varmargin*/  from                                                  
 (select 'NSECM' as segment,party_code,varmargin=SUM(varmargin) from #margin /* where party_code='A2649'*/  
 group by party_Code having sum(varmargin) <> 0) b                                                  
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0    
    
 /***********************End****************************************/    
  
   
  /*****************peakmargin from bo for NSE BSE MTF************************/  
 DECLARE @MARGINDATEpeak AS DATETIME   , @MARGINDATEpeakBSE AS DATETIME ,@MARGINDATEpeakMTF as Datetime           
/*set @MARGINDATEpeak=cast(CAST(getdate()-1 as date)as datetime)*/  
SELECT @MARGINDATEpeak=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='NSE' and SEGMENT='CAPITAL'  
SELECT @MARGINDATEpeakBSE=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='BSE' and SEGMENT='CAPITAL'  
SELECT @MARGINDATEpeakMTF=MAX(MARGINDATE) FROM AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock) WHERE EXCHANGE='MTF' and SEGMENT='MTF'  
  
  
--select cltcode,UDebitV*-1 as UDebitV,'NSE' as exchange into #unSettDr from AngelNseCM.inhouse.dbo.NCMS_PO_UnsetDr with(nolock) where UDebitV<0  
  
if((CONVERT(VARCHAR(5),GETDATE(),108)>='16:30') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))      
Begin  
 /*Commented start on 30 Jan 2023 for removing Peak margin*/  
 /*if(select COUNT(1) from  cms.dbo.NCMS_PeackMargin with(nolock))=0  
 begin  
  
   select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeak  
    and EXCHANGE='NSE' and SEGMENT='CAPITAL' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month varchar(10),@peakVar money=1  
       
      select @month=convert(char(3), GETDATE(), 0)  
   --select @month  
   --if(@month='Dec' or @month='Jan' or @month='Feb')  
   --begin  
   -- set @peakVar=0.25   
   -- print @peakVar  
   --end   
   --if(@month='Mar' or @month='Apr' or @month='May')  
   --begin  
   -- set @peakVar=0.5   
   -- print @peakVar  
   --end  
   --if(@month='Jun' or @month='Jul' or @month='Aug')  
   --begin  
   -- set @peakVar=0.75   
   -- print @peakVar  
   --end  
   --if(@month='Sep' or @month='Oct' or @month='Nov')  
   --begin  
   -- set @peakVar=1   
   -- print @peakVar  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar*/ as peakMargin into #peakMr from #aa  
    
    
   /*******************************************/  
   select a.exchange,b.party_code,b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as FinalPeak  
                       into #peak from #unSettDr a right join #peakMr b   
   on a.cltcode=b.party_code  
   /*******************************************/  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.FinalPeak/*,NetPayable=NetPayable-b.FinalPeak*/ from                                                  
  (select 'NSECM'  as segment,party_code,FinalPeak from #peak) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
  /*****************BSE***********/  
 select cltcode,UDebitV*-1 as UDebitV,'BSE' as exchange into #unSettDrBSE from AngelBSECM.inhouse.dbo.NCMS_PO_UnsetDr with(nolock) where UDebitV<0  
  
  select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa1  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeakBSE  
    and EXCHANGE='BSE' and SEGMENT='CAPITAL' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month1 varchar(10),@peakVar1 money=1  
       
   --   select @month1=convert(char(3), GETDATE(), 0)  
    
   --if(@month1='Dec' or @month1='Jan' or @month1='Feb')  
   --begin  
   -- set @peakVar1=0.25   
   -- print @peakVar1  
   --end   
   --if(@month1='Mar' or @month1='Apr' or @month1='May')  
   --begin  
   -- set @peakVar1=0.5   
   -- print @peakVar1  
   --end  
   --if(@month1='Jun' or @month1='Jul' or @month1='Aug')  
   --begin  
   -- set @peakVar1=0.75   
   -- print @peakVar1  
   --end  
   --if(@month1='Sep' or @month1='Oct' or @month1='Nov')  
   --begin  
   -- set @peakVar1=1   
   -- print @peakVar1  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar1*/ as peakMargin into #peakMr1 from #aa1  
    
   /*******************************************/  
   select a.exchange,b.party_code,b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as FinalPeak  
                       into #peak1 from #unSettDrBSE a right join #peakMr1 b   
   on a.cltcode=b.party_code  
   /*******************************************/  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.FinalPeak,NetPayable=NetPayable-b.FinalPeak from                                                  
  (select 'BSECM'  as segment,party_code,FinalPeak from #peak1) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
   
  /*****************MTF***********/  
  select party_code,sum(TDAY_MARGIN) as peakMargin,EXCHANGE into #aa11  from AngelNseCM.Msajag.dbo.Tbl_Combine_Reporting_peak_Detail with(nolock)  
    where margindate =@MARGINDATEpeakMTF  
    and EXCHANGE='MTF' and SEGMENT='MTF' and TDAY_MARGIN>0 group by party_code,EXCHANGE  
    order by party_code      
     
     
      declare @month11 varchar(10),@peakVar11 money=1  
       
   --   select @month11=convert(char(3), GETDATE(), 0)  
    
   --if(@month11='Dec' or @month11='Jan' or @month11='Feb')  
   --begin  
   -- set @peakVar11=0.25   
   -- print @peakVar11  
   --end   
   --if(@month11='Mar' or @month11='Apr' or @month11='May')  
   --begin  
   -- set @peakVar11=0.5   
   -- print @peakVar11  
   --end  
   --if(@month11='Jun' or @month11='Jul' or @month11='Aug')  
   --begin  
   -- set @peakVar11=0.75   
   -- print @peakVar11  
   --end  
   --if(@month11='Sep' or @month11='Oct' or @month11='Nov')  
   --begin  
   -- set @peakVar11=1   
   -- print @peakVar11  
   --end  
   select party_code,EXCHANGE,peakMargin/**@peakVar11*/ as peakMargin into #peak11 from #aa11  
    
   update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.peakMargin,NetPayable=NetPayable-b.peakMargin from                                                  
  (select EXCHANGE as segment,party_code,peakMargin from #peak11) b                                                  
  where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code  
   
  end  
  /**************************************/  
 else  
  begin  
  */ /*Commented end on 30 Jan 2023 for removing Peak margin*/  
  /********For adding peak maegin********************/  
   /* select client_code,bsecm+nsecm+nsefo+Mcx+ncdex+nsx+mcd as LDAmt into #ee from [NCMS_LD_View]*/--comented on 22 July 2022  
    select Client_code,BSECMMargin+NSECMMargin+NSEFOMargin+MCXMargin+NCDEXMargin+NSXMargin+MCDMargin+BSXMargin as LDAmt into #ee from [NCMS_LD_MTM_Margin_view] with(nolock)  
     
 /*    declare @monthFile varchar(10),@peakVarFile money=1  
       
    SELECT [client code],total*@peakVarFile as peakMargin into #PEakFile FROM NCMS_PeackMargin   
     
    select a.exchange,b.[client code],b.peakMargin,isnull(a.UdebitV,0.00) as UnsetteletDebit,case when isnull(a.UdebitV,0.00)>b.peakMargin then 0.00   
                       when isnull(a.UdebitV,0.00)<b.peakMargin then b.peakMargin-isnull(a.UdebitV,0.00) end as total  
                       into #PEakFileMain from #unSettDr a right join #PEakFile b   
    on a.cltcode=b.[client code]     
     
   SELECT [client code], MAX(total) as total  
   into #PeckMargin FROM  
   (  
    SELECT [client code], MAX(total) as total  
    FROM #PEakFileMain   
    GROUP BY [client code]  
    UNION ALL  
    SELECT client_code, MAX(LDAmt) as LDAmt  
    FROM #ee   
    GROUP BY client_code  
   ) as subQuery  
   GROUP BY [client code]  
*/  
   SELECT [client code], MAX(total) as total  
   into #LDMargin FROM  
   (  
    SELECT client_code as [client code], MAX(LDAmt) as total  
    FROM #ee   
    GROUP BY client_code  
   ) as subQuery  
   GROUP BY [client code]  
                
    update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.total/*OtherDebit=OtherDebit-b.total              */  
    /*,NetPayable=NetPayable-b.total */             
    from(                    
    select 'NSECM' as segment,[client code],total from #LDMargin with(nolock) where [client code] is not null and total<>0               
    ) b                     
    where #NCMS_SegwiseCldata.Party_code=b.[client code] and  #NCMS_SegwiseCldata.segment=b.segment                     
                    
  --end      
   
 end  
 /**************************/      
   
 /*******************added on 10 Mar 2021 for adding unsetteld Holding***************************************************/  
 declare @NONCASHconsideration as int = 100   
   
  update #NCMS_SegwiseCldata set NonCashConsideration=@NONCASHconsideration where Segment='NSECM'          
  
--select a.* into #NCMS_ROI from NCMS_ROI a with(nolock), NCMS_PO_Request_ForPayout b with(nolock)  
-- where a.partY_code=b.Party_code        
  
-- update #NCMS_SegwiseCldata set NonCashConsideration=b.CollateralPercent          
-- from #NCMS_ROI b  WITH (NOLOCK)   where #NCMS_SegwiseCldata.party_code=b.party_code  and  #NCMS_SegwiseCldata.Segment='NSECM'          
  
select * into #Vw_Todays_Secpayout from  AngelDEMAT.MSAJAG.dbo.Vw_Todays_Secpayout  with(nolock) where  
Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,  
CONVERT(MONEY, 0) as Value_BHC_unsett,  
CONVERT(MONEY, 0) as Value_AHC_unsett  
  into #unsett_holding from /*[196.1.115.197].msajag.dbo.unclear_hold*/ #Vw_Todays_Secpayout a with(nolock) join  
 [CSOKYC-6].GENERAL.DBO.Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/  
a.I_isin=b.security_isin join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.I_isin=c.[isin no]  
where a.party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
update #unsett_holding set Value_BHC_unsett=qty*MTM_Price_unsett  
update #unsett_holding set Value_AHC_unsett=isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)  
  
select SUM(Value_AHC_unsett) as Value_AHC_unsett,party_code into #holding_AHC from #unsett_holding group by party_code  
  
update #NCMS_SegwiseCldata set noncashcoll=Value_AHC_unsett from                              
 (select party_code,Value_AHC_unsett from #holding_AHC) b                                                  
 where #NCMS_SegwiseCldata.segment='NSECM' and #NCMS_SegwiseCldata.party_code=b.party_Code   
   
 -- alter table #NCMS_SegwiseCldata add marginAdjustWithLgr money   
   
 --update #NCMS_SegwiseCldata set marginAdjustWithLgr=0.00  
     
   ALTER TABLE #NCMS_SegwiseCldata ADD marginAdjustWithLgr money NOT NULL DEFAULT 0  
   
 update #NCMS_SegwiseCldata set ExpoUtilised=ExpoUtilised+  
 (case     
 when  noncashcoll=0 then   MarginAmt     
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0         
 then 0           
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll   
 end) ,  
 marginAdjustWithLgr=isnull(marginAdjustWithLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3  
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  
 from #NCMS_SegwiseCldata where segment='NSECM' -- and  party_code='D65765'  
   
   
update #NCMS_SegwiseCldata set NetPayable=NetPayable+ExpoUtilised+marginAdjustWithLgr  where segment='NSECM'   
       
 /*For reducing Bond value change done by Neha on 16 Jul2016*/    
 select client_code,Segment,Total into #bond_client from BondEntry with(nolock)     
     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.Total,NetPayable=NetPayable-b.Total                          
 from(                    
 select * from #bond_client    
 ) b                     
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment=b.segment      
     
     
      
 update a set POblocked=GETDATE() from BondEntry a,    
 (select * from #bond_client)b where    
 a.client_code=b.client_code     
     
     
 update a set Flexiblocked=b.Flexiblocked,POblocked=b.POblocked from bond.dbo.tbl_BondOrderEntry a with(nolock),    
 (select * from BondEntry with(nolock))b where    
 a.client_code=b.client_code and a.order_Status='PENDING'    
 and a.Verfiedon is null and a.POblocked is null                
    
    
    
    
  /*---------------------------------------------------------*/                   
    
    
 /*For Reducing mf pending orders in Payout*/    
    
DECLARE @Days VARCHAR(20)                          
                          
 SET @Days = (                          
   SELECT DATENAME(dw, GETDATE())                          
   )     
  
 /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF       
                            
IF (@Days = 'Monday' OR @Days = 'Saturday')                          
BEGIN         
    
 --select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund_sat from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)    
 --where cltcode     
 --in     
 --(select clientcode from risk.dbo.vw_MutualFundPendingOrder_NCMS_sat with(nolock)    where segment in ('MF','Trade' ))    
 --and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)      
 --and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 --group by cltcode    
    
 /*    
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal     
 from #MFFund m inner join    
risk.dbo.vw_MutualFundPendingOrder_NCMS o    
 on m.cltcode=o.clientcode    
 where balance<=0    
 group by m.cltcode,m.balance    
 */    
    
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal_sat       
 from     
 risk.dbo.vw_MutualFundPendingOrder_NCMS_sat o  with(nolock)   ,NCMS_PO_Request_ForPayout b where o.clientcode=b.Party_code   
 group by clientcode    
    
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)    
 select cltcode,amount,getdate() from #MFFundFinal_sat    
    
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),    
 a.*,b.amount into #segmentwise_pendingorders_sat    
 from    
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')    
 and NetPayable>0)a    
 inner join  (select cltcode,amount from #MFFundFinal_sat) b    
 on a.party_code=b.cltcode;    
    
 with cte    
 as    
 (    
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,    
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,    
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end    
  from #segmentwise_pendingorders_sat where srno=1 --and party_code='AACW016'    
  union all    
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,    
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,    
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end    
  from #segmentwise_pendingorders_sat a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'    
 )    
 select * into #mf_segamountadjust_sat from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)    
    
    
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                       
  (                    
 select * from #mf_segamountadjust_sat    
  ) b                     
  where a.Party_code=b.party_code and a.Segment=b.segment     
    
 drop table #mf_segamountadjust_sat    
 drop table #segmentwise_pendingorders_sat    
 drop table #MFFundFinal_sat    
end    
else    
begin    
 --select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)    
 --where cltcode     
 --in     
 --(select clientcode from risk.dbo.vw_MutualFundPendingOrder_NCMS with(nolock)    where segment in ('MF','Trade' ))    
 --and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)      
 --and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 --group by cltcode    
    
 /*    
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal     
 from #MFFund m inner join    
 risk.dbo.vw_MutualFundPendingOrder_NCMS o    
 on m.cltcode=o.clientcode    
 where balance<=0    
 group by m.cltcode,m.balance    
 */    
    
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal       
 from     
 risk.dbo.vw_MutualFundPendingOrder_NCMS o with(nolock)    ,NCMS_PO_Request_ForPayout b where o.clientcode=b.Party_code   
 group by clientcode    
    
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)    
 select cltcode,amount,getdate() from #MFFundFinal    
    
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),    
 a.*,b.amount into #segmentwise_pendingorders    
 from    
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')    
 and NetPayable>0)a    
 inner join  (select cltcode,amount from #MFFundFinal) b    
 on a.party_code=b.cltcode;    
    
 with cte    
 as    
 (    
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,    
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,    
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end    
  from #segmentwise_pendingorders where srno=1 --and party_code='AACW016'    
  union all    
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,    
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,   
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end    
  from #segmentwise_pendingorders a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'    
 )    
 select * into #mf_segamountadjust from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)    
    
    
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                       
  (                    
 select * from #mf_segamountadjust    
  ) b                     
  where a.Party_code=b.party_code and a.Segment=b.segment     
     
 drop table #mf_segamountadjust    
 drop table #segmentwise_pendingorders    
 drop table #MFFundFinal    
end    
    
   */  
     
     
 /*************************************************************************************/    
     
 /*For Reducing BSE Orders added on 05 May 2017*/    
              
 IF (@Days = 'Monday')                          
 BEGIN     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                      
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE_sat with(nolock)                   
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                        
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode      
 end     
else    
begin     
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                      
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE  with(nolock)                  
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                        
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode      
 end    
 /*---------------------------------------------------------*/       
 /*****Start************For reducing Bills of BSE NSE*************************************************************************/  
DECLARE @billdate AS DATE   
SELECT  @billdate=getdate()  
  
   
if(SELECT COUNT(1) FROM angelnsecm.msajag.dbo.TBL_CASH_PROCESS_LOG WITH (NOLOCK) WHERE BUSINESS_DATE = @billdate AND PROCESS_NAME = 'PRNETTOTAL_RTB'  
AND PROCESS_FLAG = 1)=1  
BEGIN  
  
 insert into NCMS_RTB_log  
 select *,getdate() from angelnsecm.msajag.dbo.PRNETTOTAL_RTB WITH (NOLOCK) WHERE TRADEDATE= @billdate  
  
 SELECT PARTY_CODE,SEGMENT,PAY_IN_PAY_OUT_OBLIGATION into #rtb FROM angelnsecm.msajag.dbo.PRNETTOTAL_RTB WITH (NOLOCK) WHERE   
 TRADEDATE= @billdate  
 select party_code,sum(pay_in_pay_out_obligation) billamount into #club1 from   #rtb group by party_code  
  
  update #NCMS_SegwiseCldata set OtherDebit=isnull(OtherDebit,0)-b.billamount,NetPayable=NetPayable-b.billamount                          
  from(                    
  select distinct billamount*-1 as billamount,PARTY_CODE from #club1 with(nolock)   where billamount<0  
  ) b                     
  where #NCMS_SegwiseCldata.Party_code=b.PARTY_CODE and #NCMS_SegwiseCldata.segment='NSECM'   
  
END  
else  
BEGIN  
 if(select PROCESS_STATUS from AngelNseCM.msajag.dbo.TBL_AUTO_PROCESS_DETAIL with(nolock) where Business_Date=@billdate and PROCESS_FOR ='POSTBILL'  
 and sett_type='M')=0  
 begin  
 if(select PROCESS_STATUS from AngelNseCM.msajag.dbo.TBL_AUTO_PROCESS_DETAIL with(nolock) where Business_Date=@billdate and PROCESS_FOR ='POSTBILL'  
 and sett_type='Z')=0  
 begin  
 if(select posting from AngelNseCM.msajag.dbo.V2_Business_Process with(nolock) where Business_Date=@billdate and sett_type ='M' )=0  
 begin  
 if(select posting from AngelNseCM.msajag.dbo.V2_Business_Process with(nolock) where Business_Date=@billdate and sett_type='Z' )=0  
 begin  
  
   insert into BseCmbillGendata_log  
   select *,getdate() from Mimansa.Clientservice.dbo.BseCmbillGendata with(nolock)  
  
   insert into NseCmbillGendata_log  
   select *,getdate() from Mimansa.Clientservice.dbo.NseCmbillGendata with(nolock)  
  
     select *,AMOUNT+Brokerage+SERVICE_TAX+TURN_TAX+SEBI_TAX+INS_CHRG+BROKER_CHRG as BillAmount  
  into #erNewn  from Mimansa.clientservice.dbo.NseCmbillGendata with(nolock) --where amount>0  
  where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
     select *,AMOUNT+Brokerage+SERVICE_TAX+TURN_TAX+SEBI_TAX+INS_CHRG+BROKER_CHRG as BillAmount  
   into #er1Newn from  Mimansa.Clientservice.dbo.BseCmbillGendata with(nolock)-- where amount>0  
  where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
  
    update #erNewn  set billamount=case when billamount<0 then billamount*-1 when billamount>0 then billamount*-1 end   
    update #er1Newn  set billamount=case when billamount<0 then billamount*-1 when billamount>0 then billamount*-1 end   
  
  
   select x.party_code,sum(billamount) as billamount into #club from  
   (select party_code,billamount from #erNewn  
   union all  
   select party_code,billamount from #er1Newn)x  group by party_code    
  
   update #NCMS_SegwiseCldata set OtherDebit=isnull(OtherDebit,0)-b.billamount,NetPayable=NetPayable-b.billamount                          
   from(                    
   select distinct billamount*-1 as billamount,PARTY_CODE from #club with(nolock)   where billamount<0  
   ) b                     
   where #NCMS_SegwiseCldata.Party_code=b.PARTY_CODE and #NCMS_SegwiseCldata.segment='NSECM'  /*#NCMS_SegwiseCldata.Segment='NSEFO'     */  
  end  
  end  
  end  
  end  
END  
  
 /*****End****************************************************************************/     
     
/******Start*********************For Deducting Brokerage charges*************************/    
 select distinct Brokerage+Gst+STT+TurnoverCharges+SebiFees+StampDuty as brokerage,PARTY_CODE,segment into #NSECM_Brokerage from NCMS_BrokerageCharges with(nolock)   
 where segment not in ('BSECM','NSECM')  
  
 select party_code,sum(brokerage) as brokerage into #New_brokerage from #NSECM_Brokerage group by party_code  
  
 update a set OtherDebit=isnull(OtherDebit,0)-b.brokerage,NetPayable=NetPayable-b.brokerage                          
 from #NCMS_SegwiseCldata a,(                    
 select party_code,brokerage from #New_brokerage  
 ) b                     
 where a.Party_code=b.PARTY_CODE and a.segment='NSECM' /*#NCMS_SegwiseCldata.segment=b.segment*/ /*#NCMS_SegwiseCldata.Segment='NSEFO'     */  
     
 /*****End****************************************************************************/     
     
   /*update net basis of Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/  
   
  update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.loss ,OtherDebit=isnull(OtherDebit,0)-b.loss from                                                
 (select party_code,loss,exchange+'CM' as segment from NCMS_Intraday_loss with(nolock)) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0 and NetPayable>0   
   
/***********************************************************************************/  
     
  /*********************Added on 30 may 2022 for removing SIP**************************************************************/  
  /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF       
  
select sclientcode,sactualduedate,sum(convert(money,sInstallmentAmt)) as sInstallmentAmt,'BSEMFSS' as segment into #sum FROM   
[196.1.115.253].MutualFund.dbo.vw_sip_installments with(nolock)  
group by sclientcode,sactualduedate     
  
 update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.sInstallmentAmt ,OtherDebit=OtherDebit-b.sInstallmentAmt from                                                
 (select * from #sum with(nolock)) b                      
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.sclientcode  
*/  
  /**********************************************************************************/   
 /***********************for Adding Delivery Margin Added on 14 Jun 2019 By Neha Naiwar ************************************/    
--DECLARE @MARGINDATE AS DATETIME,@sdtcur as datetime             
--SELECT @MARGINDATE=MAX(MARGINDATE) FROM angelfo.NSEFO.dbo.tbl_clientmargin WITH (NOLOCK)       
    
--SELECT * into #delmargin FROM Angelfo.NSEFo.dbo.FOMARGINNEW with(nolock) WHERE  MDATE =@MARGINDATE/*convert(datetime,convert(varchar(8),getdate(),112))*/    
--AND DEL_MARGIN <>0    
    
--  UPDATE a                                                            
--  set MarginAmt =  MarginAmt-DEL_MARGIN                         
--  FROM #NCMS_SegwiseCldata a                                                 
--  JOIN                                                            
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                          
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'      
      
--  UPDATE a                                                            
--  set NetPayable =  NetPayable-DEL_MARGIN                         
--  FROM #NCMS_SegwiseCldata a                                                 
--  JOIN                                                            
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                          
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'       
/*************************************************************************************/    
     
               
  truncate table NCMS_SegVeriData                          
  insert into NCMS_SegVeriData                                            
  (                                            
  POrequestID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,                                            
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                          
  )                                              
  select   /*ROW_NUMBER() OVER ( ORDER BY party_code,segment) AS refno,*/                            
  convert(varchar(6),getdate(),112)+replace(convert(varchar(8),getdate(),108),':','') AS refno,                            
  ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,isnull(OtherDebit,0),NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                             
  from #NCMS_SegwiseCldata                                               
    
  /*******************************************************Added for combine margin****/  
  select * into #new_NCMS_SegwiseCldata from #NCMS_SegwiseCldata with(nolock) where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))  
    
  update #new_NCMS_SegwiseCldata set Balance=0.00,UnsettledCrBill=0.00 where NetPayable=0 and Segment='BSEMFSS'  
  update #new_NCMS_SegwiseCldata  set UnsettledCrBill=0.00 where  Segment='BSEMFSS'  and  NetPayable>0  and UnsettledCrBill<0  
  
update  #new_NCMS_SegwiseCldata set Balance=NetPayable where Balance=0 and AccruedCharges=0 and marginamt=0 and segment='bsemfss' and NetPayable<0  
    
 select max(ProcessDate) ProcessDate,Entity,Party_code,Flag,sum(Balance)Balance,sum(UnsettledCrBill) UnsettledCrBill,sum(UnrecoAmt) UnrecoAmt,    
 sum(ShortSellValue) ShortSellValue,sum(MarginAmt) MarginAmt,SUM(deposit) Deposit,sum(CashColl)CashColl,sum(NonCashColl) NonCashColl,    
 sum(MarginAdjWithColl) MarginAdjWithColl,sum(MarginShortage) MarginShortage,sum(AccruedCharges) AccruedCharges,sum(OtherDebit) OtherDebit,    
 max(100) NonCashConsideration--,SUM(ExpoUtilised) as ExpoUtilised,sum(NetPayable) NetPayable  
 ,case when entity='AllSegment' then 0.00 else SUM(ExpoUtilised) end as ExpoUtilised,  
 case when entity='AllSegment' then 0.00 else sum(NetPayable) end NetPayable  
 into #ncms    
 from  #new_NCMS_SegwiseCldata  /*where Party_code in (select distinct Party_code from NCMS_PO_Request_ForPayout with(nolock))*/  
 group by Entity,Party_code,Flag    
   
 --  update #ncms set NonCashConsideration=100.00 --from #ncms     /*added on 08 Oct 2021 by Neha naiwar*/  
  
 -- /*alter table #ncms add marginAdjustWithCombineLgr money */  /*added on 08 Oct 2021 by Neha naiwar*/  
     
 --update #ncms set /*marginAdjustWithCombineLgr=0.00 ,*/ExpoUtilised=0.00 ,NetPayable=0.00 where entity='AllSegment'  
     
 update #ncms set ExpoUtilised=ExpoUtilised+    
 (case       
 when  noncashcoll=0 then   MarginAmt       
 when NonCashColl>((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0           
 then 0             
 when noncashcoll<((MarginAmt*-1)*(NonCashConsideration/100)) and NonCashColl>0  then   (MarginAmt*(NonCashConsideration/100)) +  noncashcoll     
 end)     
 /*,marginAdjustWithCombineLgr=isnull(marginAdjustWithCombineLgr,0.00)+ isnull((case when NonCashConsideration=70 and NonCashColl>0 then MarginAmt*0.3    
                        when NonCashConsideration=50 and NonCashColl>0 then MarginAmt*0.5 end),0)  */   /*added on 08 Oct 2021 by Neha naiwar*/  
 from #ncms where entity='AllSegment'  
   
 update #ncms set NetPayable=Balance+ExpoUtilised+/*marginAdjustWithCombineLgr+*/UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges+OtherDebit   
  where entity='AllSegment'  
  
/***Added on 22 July 2022************************/  
/*select Client_code,BSECMMTM+NSECMMTM+NSEFOMTM+MCXMTM+NCDEXMTM+NSXMTM+MCDMTM+BSXMTM as LDAmtMTM into #LDMTM from [NCMS_LD_MTM_Margin_view]*/  
select Client_code,BSECMMTM+NSECMMTM+MCXMTM+NCDEXMTM+NSXMTM+MCDMTM+BSXMTM as LDAmtMTM into #LDMTM from [NCMS_LD_MTM_Margin_view]  
  
  
 update a set NetPayable=NetPayable-LDAmtMTM from #ncms a join #LDMTM b on a.party_code=b.Client_code  
  where entity='AllSegment' and LDAmtMTM<>0  
  
 update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from #ncms a left join #LDMTM b on a.party_code=b.Client_code  
  where entity='AllSegment' and LDAmtMTM<>0  
/*********************************/  
  
 update a set OtherDebit=isnull(OtherDebit,0)-LDAmtMTM from NCMS_SegVeriData a , #LDMTM b where a.party_code=b.Client_code    
  and segment='NSECM' and LDAmtMTM<>0    
  
/***Added on 08 Aug 2022 for adjusting Ad-hoc margin values************************/  
  select a.party_code,(amt*-1) as amt into #adhocdata from risk.dbo.tbl_Omne_CM_MarginData a with(nolock)  ,NCMS_PO_Request_ForPayout b   
 where a.PARTY_CODE=b.Party_code   
  
  update a set amt=amount from #adhocdata a join NCMS_tbl_AdhocMargin b on a.party_code=b.party_code   
  
  insert into NCMS_Adhoc_final_hist  
 select *,GETDATE() from NCMS_Adhoc_final  
  
 truncate table NCMS_Adhoc_final  
   
 insert into NCMS_Adhoc_final  
 select * from #adhocdata  
  
  truncate table NCMS_tbl_AdhocMargin  
if( DATEPART(DW,GETDATE())>6 and DATEPART(DW,GETDATE())<=7)    
begin  
 truncate table NCMS_Adhoc_final  
end  
select * into #adhoc from NCMS_Adhoc_final with(nolock) where amt<>0  
   
 update a set NetPayable=NetPayable+Amt,OtherDebit=isnull(OtherDebit,0)+Amt from #ncms a join #adhoc b on a.party_code=b.party_code  
  where entity='AllSegment'  
  
   update a set OtherDebit=isnull(OtherDebit,0)+Amt from NCMS_SegVeriData a join #adhoc b on a.party_code=b.party_code  
  where segment='NSECM'  
  /*******************************************/  
  
truncate table NCMS_CombineVeriData  
 insert into NCMS_CombineVeriData                                            
  (                                            
  POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,                                     
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                          
  )                                              
  select   /*ROW_NUMBER() OVER ( ORDER BY party_code,segment) AS refno,*/                            
  convert(varchar(6),getdate(),112)+replace(convert(varchar(8),getdate(),108),':','') AS refno,                            
  ProcessDate,Entity,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                            
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                                             
  from #ncms    
    
  insert into NCMS_CombineVeriData_hist  
  (  
  POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,  
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,updatedOn  
  )   
  select POrequestID,ProcessDate,Entity,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,  
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,GETDATE() from NCMS_CombineVeriData  
         
/* For checking duplicate Account no.*/                      
                          
  declare @StatusJob varchar(20)                               
  set @StatusJob=''             
  exec CMS.dbo.Get_JoBStatus 'NCMS Double Entry in ACC no',@StatusJob  output                               
  print @StatusJob                      
                      
                      
  if(@StatusJob='In Progress')                                
   print 'job is already running'                            
  else                        
   EXEC msdb.dbo.sp_start_job 'NCMS Double Entry in ACC no'   
  
   
/* For Verify process*/                      
if(select flag from ncms_batch_process with(nolock) where Srno=15)=1  
Begin                           
  declare @StatusJobVerify varchar(20)                               
  set @StatusJobVerify=''             
  exec CMS.dbo.Get_JoBStatus 'NCMS Verifier Step',@StatusJobVerify  output                               
  print @StatusJobVerify                      
                      
                      
  if(@StatusJobVerify='In Progress')                                
   print 'job is already running'                            
  else                        
   EXEC msdb.dbo.sp_start_job 'NCMS Verifier Step'   
End   
 /*         
 insert into NCMS_SegVeriData_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                      
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                      
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                      
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                      
 from NCMS_SegVeriData with (nolock)              
 */        
                                               
  /* exec NCMS_UPD_ReqVerId @pcode,@refno      */                                
                                            
--End try                       
                                                
--BEGIN CATCH                                                        
                                                    
--  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                              
--  select GETDATE(),'NCMS_VeriData_Batchwise',ERROR_LINE(),ERROR_MESSAGE()                            
                                
-- DECLARE @ErrorMessage NVARCHAR(4000);                                                              
-- SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                              
-- RAISERROR (@ErrorMessage , 16, 1);                                    
                                                     
--End catch                                                    
                                                      
--Set nocount off   
  
end  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_W1_transfer
-- --------------------------------------------------

CREATE PROC [dbo].[NCMS_W1_transfer]
(
    @PCODE        VARCHAR(11),
    @IP           VARCHAR(15),
    @USER         VARCHAR(25),
    @EQ_AMT       MONEY,
    @EQ_ACCNO     VARCHAR(25) = NULL,
    @requestType  CHAR(1) = NULL,
    @remarks      VARCHAR(500) = NULL,
    @reqdatetime  DATETIME
)
AS
SET NOCOUNT ON;

SET @requestType = ISNULL(@requestType, 'U');

DECLARE 
    @postatid INT = 0,
    @paymode  VARCHAR(10) = '',
    @err      VARCHAR(100) = '',
    @IFSC     VARCHAR(200) = '';

SELECT @EQ_ACCNO = ACCNO 
FROM cms.dbo.ncms_approvedaccno WITH (NOLOCK) 
WHERE pcode = @PCODE 
AND (
        CASE 
            WHEN LEFT(IFSC, 4) = 'SBIN' THEN RIGHT('0000000000000000' + LTRIM(RTRIM(ACCNO)), 17)
            WHEN LEFT(IFSC, 4) = 'CBIN' THEN RIGHT('0000000000000000' + LTRIM(RTRIM(ACCNO)), 17)
            ELSE ACCNO 
        END
    ) = @EQ_ACCNO;

IF (
    SELECT COUNT(1) 
    FROM cms.dbo.ncms_approvedaccno WITH (NOLOCK) 
    WHERE pcode = @PCODE 
    AND (
            CASE 
                WHEN LEFT(IFSC, 4) = 'SBIN' THEN RIGHT('0000000000000000' + LTRIM(RTRIM(ACCNO)), 17)
                WHEN LEFT(IFSC, 4) = 'CBIN' THEN RIGHT('0000000000000000' + LTRIM(RTRIM(ACCNO)), 17)
                ELSE ACCNO 
            END
        ) = @EQ_ACCNO
    AND IFSC LIKE 'PYTM%'
) > 0
BEGIN
    SET @err = 'paytm_code';
    RAISERROR(@err, 16, 1);
    RETURN;
END
IF @requestType = 'M'
    SET @postatid = 7;
IF @EQ_AMT > 0
BEGIN
    IF (@EQ_AMT >= 50000)
    BEGIN
        IF (
            SELECT COUNT(1) 
            FROM cms.dbo.ncms_approvedaccno WITH (NOLOCK) 
            WHERE pcode = @PCODE 
            AND Accno = @EQ_ACCNO 
            AND Flag_firstPO IS NULL
        ) > 0
        BEGIN
            SET @postatid = 7;
        END
    END

    SET @remarks = 'T'

    SELECT TOP 1 
        @paymode = paymode 
    FROM cms.dbo.ncms_clientBankdetails_all WITH (NOLOCK)
    WHERE cltcode = @PCODE 
    AND LTRIM(RTRIM(acno)) = LTRIM(RTRIM(@EQ_ACCNO))
    AND domain = 'AllSegment';

    IF ISNULL(@paymode, '') = 'NORMAL'
    BEGIN
        SET @err = 'NORMAL_PAYMODE';
        RAISERROR(@err, 16, 1);
        RETURN;
    END;

    IF ISNULL(@paymode, '') <> ''
    BEGIN

        INSERT INTO dustbin.dbo.Ncms_Po_request
        (
            SegMinID, Party_code, Entity, Net_payable, PO_Request, 
            POdt_request, Req_datetime, Req_IP, Req_User, Req_Paymode,
            Req_PayBankId, Req_RefNo, POveriID, PO_ApprovedAmt, 
            PO_Statusid, requestType, remarks
        )
        SELECT 
            id, @PCODE, Entity, Netpayable, @EQ_AMT, @reqdatetime, 
            @reqdatetime, @IP, @USER, @paymode, @EQ_ACCNO, '',
            0, 0, @postatid, @requestType, @remarks
        FROM cms.dbo.NCMS_EntityDataView_combine WITH (NOLOCK)
        WHERE party_code = @PCODE
        AND Entity = 'AllSegment';
    END
    ELSE
    BEGIN
        SET @err = 'PAYMODE_BLANK';
    END
END
ELSE
BEGIN
    SET @err = 'NET_LESS_AMOUNT';
END;

IF (@EQ_AMT <= 0)
    SET @err = 'AMOUNT_LESS_ZERO';

DECLARE @REFNO AS VARCHAR(25)=''    

IF ISNULL(@paymode, '') <> ''
BEGIN
	 select @REFNO=Req_Paymode+replace(convert(varchar(10),GETDATE(),102),'.','')+                                      
	 risk.dbo.AddZeroPrefox(MAX(porequestid),5)                                      
	 from NCMS_PO_Request WITH (NOLOCK) where party_code=@PCODE and Req_RefNo=''                                     
	 group by Req_Paymode 

    SELECT 
        REFNO = Req_Paymode + REPLACE(CONVERT(VARCHAR(10), GETDATE(), 102), '.', '') +
                risk.dbo.AddZeroPrefox(MAX(porequestid), 5),
        party_code, 
        porequestid
    INTO #ref
    FROM NCMS_PO_Request WITH (NOLOCK)
    WHERE party_code = @PCODE 
    AND Req_RefNo = ''
    GROUP BY Req_Paymode, party_code, porequestid;

    UPDATE a
    SET a.req_refno = b.refno
    FROM NCMS_PO_Request a
    JOIN #ref b 
        ON a.Party_code = b.Party_code 
       AND a.POrequestID = b.POrequestID;
END;

IF (@err = '')
BEGIN
    SELECT 
        Party_code,
        POrequestID,
        PO_Request,
        Req_datetime AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' AS Req_Datetime,
        Req_RefNo,
        CAST(cms.dbo.udf_getcredittime(Req_Datetime, party_code, POrequestID) AS DATETIME)
            AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' AS credit_date_time
    FROM NCMS_PO_Request WITH (NOLOCK)
    WHERE Req_RefNo = @REFNO
    AND Party_code = @PCODE;
END;
SELECT 
    Party_code, Entity, PO_Request, Req_datetime, Req_User, 
    Req_Paymode, Req_PayBankId, Req_RefNo
INTO #we
FROM NCMS_PO_Request WITH (NOLOCK)
WHERE Req_RefNo = @REFNO
AND Party_code = @PCODE;

IF (SELECT COUNT(1) FROM #we) = 0
BEGIN
    INSERT INTO NCMS_Marking_Error_Log(ErrTime, ErrMessage, party_code)
    SELECT GETDATE(), @err, @PCODE;

    RAISERROR(@err, 16, 1);
END;

SET NOCOUNT OFF;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFS_batch_CUG
-- --------------------------------------------------

--[OFS_batch_CUG] 'BSE'          
CREATE proc [dbo].[OFS_batch_CUG](@segment as varchar(10))                
as                       
                      
set nocount on                      
          
/* declare @segment as varchar(10)= 'BSE'*/          
DECLARE @BatchCount AS INT = 0,@RecCount  as int =0,@ctr as int = 1,@cctr as varchar(3) = ''                
          
if (SELECT COUNT(1) FROM dbo.OFS_ORDER with (NOLOCK) where generation_flag in (1,-2,-5)  
and REQUEST_DATE >= CONVERT(varchar(11),getdate())+' 00:00:00' and REQUEST_DATE <= CONVERT(varchar(11),getdate())+' 23:59:59'                
and SEGMENT=@segment) > 0          
Begin          
 SELECT @ctr=MAX(convert(int,Batch_No))+1 FROM dbo.OFS_ORDER with (NOLOCK) where generation_flag in (1,-2,-5)
 and REQUEST_DATE >= CONVERT(varchar(11),getdate())+' 00:00:00' and REQUEST_DATE <= CONVERT(varchar(11),getdate())+' 23:59:59'                
 and SEGMENT=@segment                
end          
          
print @ctr          
                    
SELECT @RecCount=COUNT(1) FROM dbo.OFS_ORDER with (NOLOCK) where generation_flag=0
and REQUEST_DATE >= CONVERT(varchar(11),getdate())+' 00:00:00' and REQUEST_DATE <= CONVERT(varchar(11),getdate())+' 23:59:59'                
and SEGMENT=@segment                
                
SET @BatchCount=99                
                    
WHILE @RecCount >0                      
BEGIN                      
 BEGIN TRAN                     
   
  select @cctr=                
  case                 
  when len(convert(varchar(3),@ctr)) =1 then '00'+convert(varchar(3),@ctr)                
  when len(convert(varchar(3),@ctr)) =2 then '0'+convert(varchar(3),@ctr)                
  else convert(varchar(3),@ctr)                
  end                
                
                   
  update OFS_ORDER set Batch_No=@cctr, StatusCode='110',
  filename='OFS'+@segment+'_'+replace(convert(varchar(10),GETDATE(),103),'/','') where                 
  OFS_ORDER.REQUEST_ID in (                     
   select TOP (@BatchCount) REQUEST_ID FROM dbo.OFS_ORDER  where generation_flag=0
   and REQUEST_DATE >= CONVERT(varchar(11),getdate())+' 00:00:00' and REQUEST_DATE <= CONVERT(varchar(11),getdate())+' 23:59:59'
   and SEGMENT=@segment                
   )                
  COMMIT TRAN
  PRINT ('RECORD'+CAST( @RecCount AS VARCHAR (10)))   PRINT ('BATCH'+CAST( @BatchCount AS VARCHAR (10)))   PRINT ('CTR'+CAST( @ctr AS VARCHAR (10)))
                         
  SET @RecCount=@RecCount - @BatchCount                       
  set @ctr = @ctr + 1                       
  set nocount off                      
END                 
if(@segment='BSE')              
Begin                
select (select BSECode from OFS_ScripMaster where Srno=SCRIPCODE) as SCRIPCODE,CLIENT_TYPE,'' as Blank1,CLIENT_CODE,'' as Blank,QUANTITY,cast (convert(decimal(18,2),[BID_RATE]) as varchar(100)) as BID_RATE
,'2' As [Static Val],CASE WHEN GEN_STATUS='Added' THEN '0' ELSE BID_NO END as BID_NO,
CASE WHEN GEN_STATUS='Modified' THEN 'M' WHEN GEN_STATUS='Cancel' THEN 'C' ELSE 'N' END as [Static Val1],FileName,Batch_No as File_Num 
from OFS_ORDER with (nolock) where isnull(Batch_No,'')<>'' 
and GENERATION_FLAG=0 and SEGMENT=@segment   
and REQUEST_DATE >= CONVERT(varchar(11),getdate())+' 00:00:00' and REQUEST_DATE <= CONVERT(varchar(11),getdate())+' 23:59:59'              
End              
else              
Begin              

	select (select NSESymbol from OFS_ScripMaster where Srno=SCRIPCODE) as SCRIPCODE,
	case when CLIENT_TYPE='RI' then 'RS' else 'RS' end as Series,
	'CLI' As [CLI/PRO],
	CLIENT_CODE as [Walkin Client Code],
	'12798' as [Participant Code],
	'1' as [100margin],
	QUANTITY,
	cast (convert(decimal(18,2),[BID_RATE]) as varchar(100)) as BID_RATE,
	'E' as [orderEntry],FileName,Batch_No as File_Num              
	from OFS_ORDER with (nolock) where isnull(Batch_No,'')<>'' and GENERATION_FLAG=0 and SEGMENT='NSE'                
	and REQUEST_DATE >= CONVERT(varchar(11),getdate())+' 00:00:00' and REQUEST_DATE <= CONVERT(varchar(11),getdate())+' 23:59:59' 


End              
                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFS_Client_NL_NA
-- --------------------------------------------------
  
CREATE procedure [dbo].[OFS_Client_NL_NA](@pcode as varchar(10))      
as      
/*      
exec OFS_Client_NL_NA 'IKW16'      
NOTE: -ve value is Credit and +ve value is Debit      
*/      
    
set nocount on      
/*    
declare @pcode as varchar(10)    
set @pcode ='BP11'    
*/      
declare @AcYrFrom as datetime,@BSECM as money = 0,@NSECM as money = 0,@NSEFO as money = 0,@NSX as money = 0,@MCD as money = 0,@hold as money = 0,@nbfc as money = 0      
select @AcYrFrom=sdtcur from risk.dbo.parameter with (nolock)       
where sdtcur <= GETDATE() and ldtcur >= GETDATE()      
      
select @BSECM=sum(Case when Drcr='C' then -vamt else vamt end) from AngelBSECM.account_ab.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode      
select @NSECM=sum(Case when Drcr='C' then -vamt else vamt end) from AngelNseCM.account.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode      
select @NSEFO=sum(Case when Drcr='C' then -vamt else vamt end) from angelfo.accountfo.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode      
select @NSX=sum(Case when Drcr='C' then -vamt else vamt end) from angelfo.inhouse_curfo.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode      
select @MCD=sum(Case when Drcr='C' then -vamt else vamt end) from ANGELCOMMODITY.inhouse_mcdcs.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode      
/* select @hold=isnull(sum(total),0) from [CSOKYC-6].general.dbo.rms_holding where isnull(source,'XX') not in ('DP','XX') and party_Code=@pcode    */  
select @NBFC=sum(Case when Drcr='C' then -vamt else vamt end) from [ABVSCITRUS].accountnbfc.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode      
select @hold=@hold+isnull(sum(Hold_Total),0) from [CSOKYC-6].general.dbo.tbl_rms_collection_cli where party_Code=@pcode      
SELECT @hold=@hold+isnull(SUM(CASE WHEN CASH_NCASH = 'N' THEN AMOUNT ELSE FINALAMOUNT END),0)      
 FROM [CSOKYC-6].general.dbo.CLIENT_COLLATERALS where Party_Code=@pcode and co_Code not in ('MCX','NCDEX')       
 GROUP BY co_code,Party_Code       
      
select ISNULL(isnull(@BSECM,0)+isnull(@NSECM,0)+isnull(@NSEFO,0)+isnull(@MCD,0)+isnull(@NSX,0)+isnull(@NBFC,0),0)*-1 as NL,      
ISNULL(isnull(@BSECM,0)+isnull(@NSECM,0)+isnull(@NSEFO,0)+isnull(@MCD,0)+isnull(@NSX,0)+isnull(@NBFC,0)-isnull(@hold,0),0)*-1as NA      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFS_GetRECORDS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[OFS_GetRECORDS]                
(@USER AS VARCHAR(10),@REQUEST_ID as int=0)                
AS                
BEGIN                
--declare @USER AS VARCHAR(10),@REQUEST_ID as int                
--set @USER='E02812'                
--set @REQUEST_ID=177                
                
IF @REQUEST_ID <> 0                
 BEGIN                
  select ORD.CLIENT_CODE,cd.short_name as CLIENT_Name,ORD.SEGMENT,SCR.ScripName,ORD.SCRIPCODE, cast(CONVERT(decimal(18,2),BID_RATE) as varchar(100)) as  BID_RATE,QUANTITY,          
  (case when ORD.GENERATION_FLAG = 1 then 'Generated' when ORD.GENERATION_FLAG = -1 then 'Mod Bfr Generation' when ORD.GENERATION_FLAG = 0 then 'Last Modified'           
  else '0' END) as GENERATION_FLAG,           
  ORD.Batch_No,ORD.REQUEST_ID,ORD.BID_NO,ord.client_type                 
  from OFS_ORDER ORD Inner Join                
  OFS_ScripMaster SCR on SCR.Srno=ORD.SCRIPCODE                 
  inner join risk.dbo.client_details cd  
  on ord.Client_code=cd.Party_code  
  /*WHERE CONVERT(VARCHAR(12), ORD.REQUEST_DATE,106) >= CONVERT(VARCHAR(12),GETDATE(),106)  */               
  WHERE convert (varchar(12),ORD.REQUEST_DATE,106) = convert (varchar(12),GETDATE(),106)  
  AND ord.ENTERED_BY=@USER                 
  AND ord.REQUEST_ID = convert(int,@REQUEST_ID)                
 END                 
ELSE                
 BEGIN                
  select ORD.CLIENT_CODE,cd.short_name as CLIENT_Name,ORD.SEGMENT,SCR.ScripName,ORD.SCRIPCODE,cast(CONVERT(decimal(18,2),BID_RATE) as varchar(100)) as BID_RATE,QUANTITY,          
  (case when ORD.GENERATION_FLAG = 1 then 'Generated' when ORD.GENERATION_FLAG = -1 then 'Mod Bfr Generation' when ORD.GENERATION_FLAG = 0 then 'Last Modified'           
  else '0' END) as GENERATION_FLAG,           
  ORD.Batch_No,ORD.REQUEST_ID,ORD.BID_NO,ord.client_type                  
  from OFS_ORDER ORD Inner Join                
  OFS_ScripMaster SCR on SCR.Srno=ORD.SCRIPCODE   
  inner join risk.dbo.client_details cd  
  on ord.Client_code=cd.Party_code                
  /*WHERE CONVERT(VARCHAR(12), ORD.REQUEST_DATE,106) >= CONVERT(VARCHAR(12),GETDATE(),106) */  
  WHERE convert (varchar(12),ORD.REQUEST_DATE,106) = convert (varchar(12),GETDATE(),106)               
  AND ord.ENTERED_BY=@USER     
  AND ORD.GENERATION_FLAG in(1,0)      
  Order by ORD.REQUEST_DATE  DESC                 
 END                 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFS_Update_ofsorder_CUG
-- --------------------------------------------------
CREATE proc [dbo].[OFS_Update_ofsorder_CUG]                
AS                
BEGIN             
  
  --"NEWREQUEST":       "101",   --  "FILEEXPOERTED":    "110",   --  "REJECTED":         "102",   --  "ACCEPTED":         "103",   --  "ALLOTTED":         "104",   --  "NOTALLOTTED":      "105",   --  "MODIFYREQUEST":    "106",   --  "MODIFIEDREQUEST":  "107",   --  "CANCELREQUEST":    "108",   --  "CANCELLEDREQUEST": "109",  
    
  update p          
  set p.BID_NO=c.Bid_No , p.REMARKS= c.Static_val1 , p.StatusCode=CASE WHEN c.Static_val1='D' THEN '109' WHEN C.Static_val1='M' THEN '107' ELSE '103' END  
  --SELECT CASE WHEN c.Static_val1='D' THEN '109' WHEN C.Static_val1='M' THEN '107' ELSE '103' END,*
  from  (      
  select * from Temp_ReversalOFS a       
  join OFS_ScripMaster b          
  on a.SCRIPCODE =b.ScripName) c           
  join ofs_order p          
  on p.CLIENT_CODE=c.Client_Code       
  and p.SCRIPCODE =c.Srno      
  and RTRIM(LTRIM(p.BID_RATE)) = RTRIM(LTRIM(c.BID_RATE))      
  and RTRIM(LTRIM(p.QUANTITY)) = RTRIM(LTRIM(c.Qty))  
  
  --TRUNCATE TABLE Temp_ReversalOFS
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFS_UpdGenFlag_CUG
-- --------------------------------------------------
create procedure OFS_UpdGenFlag_CUG(@segment as varchar(10),@batch_no as varchar(3),@filename as varchar(25))  
as  
 update OFS_ORDER   
 set GENERATION_FLAG=1   
 where SEGMENT=@segment and Batch_No=@batch_no and GENERATION_FLAG=0 and FileName=@filename

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFS_ValidClient
-- --------------------------------------------------
CREATE procedure OFS_ValidClient(@Pcode as varchar(10),@access_to as varchar(10),@access_Code as varchar(10))          
as          
          
declare @str as varchar(2000) = ''          
SEt nocount on          
          
set @str=''          
set @str = @str + ' select a.party_code,a.long_name,BSECM,NSECM, '          
set @str = @str + ' (Case when BSECM=''N'' and NSECM=''N'' then ''Client is not Active in BSE & NSE Cash Segment'''           
set @str = @str + ' else '''' end) as Remarks into #file1 '          
set @str = @str + ' from risk.dbo.client_details a with (nolock) join '          
set @str = @str + ' (select * from risk.dbo.Vw_RMS_Vertical with (nolock) where '        
IF @access_to ='RGMAST'        
BEGIN     
 set @str = @str + 'REGION IN (SELECT REGION_CD FROM risk.dbo.region_master WHERE RGMAST_cd='''+@access_code+''') AND '    
END    
ELSE IF @access_to ='BRMAST'        
BEGIN     
 set @str = @str + 'BRANCH IN (SELECT BRANCH_CD FROM risk.dbo.branch_master WHERE BrMast_cd='''+@access_code+''') AND '    
END    
ELSE IF @access_to ='SBMAST'        
BEGIN    
 set @str = @str + 'SB IN (SELECT SUB_BROKER FROM risk.dbo.SB_master WHERE SBMAST_CD='''+@access_code+''') AND '    
END    
ELSE IF @access_to ='BROKER'        
BEGIN    
 set @str = @str + ' '    
END    
ELSE    
BEGIN    
 set @str = @str + @access_to+'='''+@access_code+''' and '        
END    
    
set @str = @str + ' Client='''+@Pcode+''')'          
set @str = @str + ' b on a.party_code=b.client '          
set @str = @str + ' Select * from #file1 '          
--print (@str)      
exec (@str)          
        
SEt nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFS_ValidORder
-- --------------------------------------------------

--Change By Sandeep on 07 Feb 2015          
--Reason Not to Consider Pool Value          
--Suggested BY Bhavin Sir          
--Change Id 1          
        
-- [OFS_ValidORder] ''        
CREATE procedure [dbo].[OFS_ValidORder]( @pcode as varchar(10)='',@srno as int=0,@bidrate as money=0,@qty as int=0,@Bid_No as varchar(25)=NULL, @ISEMP VARCHAR (10)= 'N')              
as              
  

Set nocount on              
              
/*              
exec OFS_Client_NL_NA 'M709'              
              
declare @pcode as varchar(10),@srno as int,@bidrate as money,@qty as int              
set @pcode='M709'              
set @srno=2              
set @bidrate=359              
set @qty=25000              
*/              
              
/* Get NA_NL */              
    declare @chkDupClientcode bit               
 declare @AcYrFrom as datetime,@BSECM as money = 0,@NSECM as money = 0,@NSEFO as money = 0,@NSX as money = 0,@MCD as money = 0,@hold as money = 0,@nbfc as money = 0              
 , @MCX as money=0 ,@BSEFO as money=0  ,@NCE  as money=0
 select @AcYrFrom=sdtcur from risk.dbo.parameter with (nolock)               
 where sdtcur <= GETDATE() and ldtcur >= GETDATE()              
              
 select @BSECM=sum(Case when Drcr='C' then -vamt else vamt end) from AngelBSECM.account_ab.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode              
 select @NSECM=sum(Case when Drcr='C' then -vamt else vamt end) from AngelNseCM.account.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode              
 select @NSEFO=sum(Case when Drcr='C' then -vamt else vamt end) from angelfo.accountfo.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode              
 select @NSX=sum(Case when Drcr='C' then -vamt else vamt end) from angelfo.inhouse_curfo.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode              
 select @MCD=sum(Case when Drcr='C' then -vamt else vamt end) from ANGELCOMMODITY.inhouse_mcdcs.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode       
 select @MCX =sum(Case when Drcr='C' then -vamt else vamt end) from ANGELCOMMODITY.AccountMCDX.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode       
 select @BSEFO =sum(Case when Drcr='C' then -vamt else vamt end) from angelcommodity.ACCOUNTBFO.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode
 select @NCE =sum(Case when Drcr='C' then -vamt else vamt end) from angelcommodity.accountnce.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode

     
 --commented by sandeep suggested by Bhavin          
 --select @hold=isnull(sum(total),0) from [CSOKYC-6].general.dbo.rms_holding where isnull(source,'XX') not in ('DP','XX') and party_Code=@pcode              
 --commented by sandeep suggested by Bhavin           
 select @NBFC=sum(Case when Drcr='C' then -vamt else vamt end) from [ABVSCITRUS].accountnbfc.dbo.ledger where vdt >= @AcYrFrom and cltcode=@pcode              
 select @hold=@hold+isnull(sum(Hold_Total),0) from [CSOKYC-6].general.dbo.tbl_rms_collection_cli with (nolock) where party_Code=@pcode              
 SELECT @hold=@hold+isnull(SUM(CASE WHEN CASH_NCASH = 'N' THEN AMOUNT ELSE FINALAMOUNT END),0)              
 FROM [CSOKYC-6].general.dbo.CLIENT_COLLATERALS with (nolock) where Party_Code=@pcode and co_Code not in ('MCX','NCDEX')               
 GROUP BY co_code,Party_Code               
               
 select @chkDupClientcode=COUNT(1) from Dustbin.dbo.OFS_ORDER with(nolock) where CLIENT_CODE=@pcode and SCRIPCODE=@srno               
 and REQUEST_DATE >= CONVERT(varchar(11),getdate())+' 00:00:00' and REQUEST_DATE <= CONVERT(varchar(11),getdate())+' 23:59:59'              
               
               
 declare @NA as money = 0,@NL as money = 0,@minBidRate as money = 0,@maxBidRate as money = 0,@PerAlert as int =0,@RILimit as money =0,@MinMargin as int =0 
 declare @NANL as char(2) = ''              
 declare @CliRIStat as varchar(3) = 'RI',@ConfFlag as char(1) = 'N',@succflag as int = 0              
              
 select @NL=ISNULL(isnull(@BSECM,0)+isnull(@NSECM,0)+isnull(@NSEFO,0)+isnull(@BSEFO,0)+isnull(@NCE,0)+isnull(@MCD,0)+isnull(@NSX,0)+isnull(@MCX,0)+isnull(@NBFC,0),0)*-1,              
 @NA=ISNULL(isnull(@BSECM,0)+isnull(@NSECM,0)+isnull(@NSEFO,0)+isnull(@BSEFO,0)+isnull(@NCE,0)+isnull(@MCD,0)+isnull(@NSX,0)+isnull(@MCX,0)+isnull(@NBFC,0)-isnull(@hold,0),0)*-1              
 print  @NL            
/* GEt Scrip dEtails */              
              
 select               
 @minBidRate=MinBidRate,            
 @maxBidRate=MaxBidRate,            
 @PerAlert=PercentAlert,              
 @RILimit=RI_AmtLimit,              
 @MinMargin=MinMarginPercent,              
 @NANL=Checkon_NetA_NetL              
 from Dustbin.dbo.OFS_ScripMaster with (nolock) where ValidForDate >= CONVERT(varchar(11),getdate())+' 00:00:00'              
 and ValidForDate <= CONVERT(varchar(11),getdate())+' 23:59:59' and srno=@Srno              
            
/* Calculation */              

IF @ISEMP='Y'
BEGIN
 SELECT @RILimit=500000.00
END

if (@qty*@bidrate) > @RILimit              
BEGIN 
PRINT 'CAL 1'  PRINT @qty*@bidrate 
 select 'Total Amount is higher than '   + cast(@RILimit  as varchar(10)) as Status,Flag=0,@CliRIStat as RIStat,@ConfFlag as ConfFlag         
 return        
END             
              
if (@qty*@bidrate) > @RILimit        
BEGIN              
 set @CliRIStat = 'NII'              
END                  
               
if (@bidrate > (@minBidRate+(@minBidRate*(@PerAlert/100.00))))              
Begin              
 set @ConfFlag='Y'              
End              
              
if @bidrate < @minBidRate              
Begin               
 set @succflag = 0              
 Select 'please place order for price '+convert(varchar(10),@minBidRate)+' or above.' as Status,Flag=@succflag,@CliRIStat as RIStat,@ConfFlag as ConfFlag              
End              
ELSE IF @bidrate > @maxBidRate              
Begin              
 set @succflag = 0              
 Select 'Bid Rate exceeds Celing Price (Rs.'+convert(varchar(10),@maxBidRate)+').' as Status,Flag=@succflag,@CliRIStat as RIStat,@ConfFlag as ConfFlag              
END              
ELSE IF (@NANL='NA' and ((@qty*@bidrate)*(@MinMargin/100.00)) > @NA)              
Begin              
  Select 'Insufficient required Margin. Net Available is Rs.'+convert(varchar(25),convert(decimal(15,2),@NA))+'.' as Status,Flag=0,@CliRIStat as RIStat,@ConfFlag as ConfFlag              
END              
ELSE IF (@NANL='NL' and (((@qty*@bidrate)*(@MinMargin/100.00)) > @NL))              
Begin              
  Select 'Insufficient required Margin. Net Ledger is Rs.'+convert(varchar(25),convert(decimal(15,2),@NL))+'.' as Status,Flag=0,@CliRIStat as RIStat,@ConfFlag as ConfFlag              
END              
ELSE IF (@chkDupClientcode>=1 AND ISNULL(@Bid_No,'')='')              
BEGIN              
  Select 'Client Code '+@pcode+' already exist. Duplicate Entry Restricted' as Status,Flag=0,@CliRIStat as RIStat,@ConfFlag as ConfFlag              
END              
ELSE IF (@ConfFlag ='Y')              
BEGIN              
  Select 'Bid Rate is Higher than '+convert(varchar(5),@PerAlert)+' of Floor Price.' as Status,Flag=1,@CliRIStat as RIStat,@ConfFlag as ConfFlag              
END              
              
ELSE               
BEGIN              
  Select 'Success' as Status,Flag=1,@CliRIStat as RIStat,@ConfFlag as ConfFlag              
END              
          
          
print @NANL          
  print cast((@qty*@bidrate)*(@MinMargin/100.00) as varchar(100))          
  print 'NA '+cast(@NA as varchar(100))          
  print 'BSE '+cast(isnull(@BSECM,'') as varchar(100))          
  print 'NSe '+cast(isnull(@NSECM,'') as varchar(100))          
  print 'NSEFO '+cast(isnull(@NSEFO,'') as varchar(100))          
  print 'NSX '+cast(isnull(@NSX,'') as varchar(100))          
  print 'MCD '+cast(isnull(@MCD,'') as varchar(100))          
  print 'HOLD '+cast(isnull(@hold,'') as varchar(100))          
  print 'NBFC '+cast(isnull(@NBFC,'') as varchar(100))          
  print 'Hold '+cast(isnull(@hold,'') as varchar(100))                 
              
--set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFS_ValidScrip
-- --------------------------------------------------
CREATE procedure [dbo].[OFS_ValidScrip](@Srno as int = 0)  
as  
  
if (@Srno = 0)  
Begin  
 select Srno,ScripName,BSECode,NSESymbol,ValidForDate,MinBidRate,PercentAlert,RI_AmtLimit,MinMarginPercent,Checkon_NetA_NetL,
 ScripName+'('+bsecode+')' as sname  
 from OFS_ScripMaster with (nolock) where ValidForDate >= CONVERT(varchar(11),getdate())+' 00:00:00'  
 and ValidForDate <= CONVERT(varchar(11),getdate())+' 23:59:59'  
End  
Else  
Begin  
 select Srno,ScripName,BSECode,NSESymbol,ValidForDate,MinBidRate,PercentAlert,RI_AmtLimit,MinMarginPercent,Checkon_NetA_NetL,  
 ScripName+'('+bsecode+')' as sname
 from OFS_ScripMaster with (nolock) where ValidForDate >= CONVERT(varchar(11),getdate())+' 00:00:00'  
 and ValidForDate <= CONVERT(varchar(11),getdate())+' 23:59:59' and srno=@Srno  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFS_ValidScrip_Onload
-- --------------------------------------------------
CREATE procedure [dbo].[OFS_ValidScrip_Onload]  
as  

SEt nocount on

	declare @reccnt as int = 0,@LockStatus as varchar(10) = ''
	select @reccnt=count(1) from OFS_Lock with (nolock) 
	where enteredon >= convert(varchar(11),GETDATE())+' 00:00:00' and enteredon <= convert(varchar(11),GETDATE())+' 23:59:59' 

	if @reccnt  = 0
	Begin
		insert into OFS_Lock select 'System',GETDATE(),'Unlock'
	End

	select @LockStatus=LockStatus from OFS_Lock a with (nolock) join
	(select max(EnteredOn) as EnteredOn from OFS_Lock 
	where enteredon >= convert(varchar(11),GETDATE())+' 00:00:00' and enteredon <= convert(varchar(11),GETDATE())+' 23:59:59' 
	)b on a.EnteredOn=b.EnteredOn

	if @LockStatus='Lock'
	Begin
		Select 0 as TdayCnt,'OFS Order Entry window closed for the day.' as Remarks
	End
	Else
	Begin
		select COUNT(1) as TdayCnt,'Scrip does not exists for Sale for Today' as Remarks  
		from OFS_ScripMaster with (nolock) where ValidForDate >= CONVERT(varchar(11),getdate())+' 00:00:00'  
		and ValidForDate <= CONVERT(varchar(11),getdate())+' 23:59:59'  
	End
	
SEt nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_accno
-- --------------------------------------------------
CREATE procedure pr_accno    --'gold','bse','043010200025512',''                  
 (                    
   @tag varchar(20)                    
  ,@seg varchar(20)                    
  ,@accno varchar(100)                    
  ,@Err_msg varchar(50)  out                      
)                    
AS                    
SELECT REPLACE(Fld_Bank_AcNo,'&nbsp;','') AS aCCNO,MAKER                     
INTO #T1                    
FROM TBL_RTGS_SUBBROKER                    
WHERE Fld_Sub_Code=@tag AND Fld_Segment=@seg    and Fld_Bank_AcNo=@accno                
 and fld_status in('Pending','p')                    
                    
 Declare @count int  
                    
 set @count=(SELECT count(ACCNO) FROM #T1)                    
                    
IF(@count=0)                    
BEGIN                    
                      
 set @err_msg='Invalid AccountNo'                            
SELECT ltrim(rtrim(@err_msg))  as 'errmsg'                           
                        
END                  
                  
else                  
                  
set @err_msg='AccountNo Matched'                            
SELECT ltrim(rtrim(@err_msg)) as 'errmsg'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_Accno_active
-- --------------------------------------------------
CREATE procedure pr_Accno_active  --'MLIN','620401526228','bse,NSE'         
(            
  @Tag varchar(20)            
 ,@accno varchar(20)            
 ,@seg  varchar(50)        
              
)            
            
AS            
            
--select fld_segment from tbl_rtgs_subbroker_temp            
--where fld_status='active'            
--and fld_bank_acno=@accno            
--and fld_sub_code=@Tag            
--and fld_segment=@segment         
--dECLARE @TAG VARCHAR(20)      
      
--SET @TAG='MLIN'      
--DECLARE @ACCNO VARCHAR(100)      
--SET @ACCNO= '620401526228'         
--    DECLARE @SEG VARCHAR(100)      
--    SET @SEG='bse,NSE'         
  SELECT Data INTO  #T2 FROM dbo.Split1(@SEG,',')      
        
  DECLARE @listStr VARCHAR(MAX)          
SELECT @listStr = COALESCE(@listStr+',' , '') + fld_segment          
 from tbl_rtgs_subbroker  where fld_sub_code=@Tag          
 and fld_status='A'  and fld_bank_Acno=@accno  and fld_segment in(SELECT DATA FROM #T2 )         
      
          
          
select distinct fld_sub_code,tradename,@listStr as 'seg' from tbl_rtgs_subbroker            
where fld_status='A'            
and fld_bank_acno=@accno            
and fld_sub_code=@Tag            
and fld_segment in  (SELECT DATA FROM #T2)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_Accno_active_MFSB
-- --------------------------------------------------
CREATE procedure pr_Accno_active_MFSB  --'MLIN','620401526228','bse,NSE'           
(              
  @Tag varchar(20)              
 ,@accno varchar(20)              
 ,@seg  varchar(50)          
                
)              
              
AS              
              
--select fld_segment from tbl_rtgs_subbroker_temp              
--where fld_status='active'              
--and fld_bank_acno=@accno              
--and fld_sub_code=@Tag              
--and fld_segment=@segment           
--dECLARE @TAG VARCHAR(20)        
        
--SET @TAG='MLIN'        
--DECLARE @ACCNO VARCHAR(100)        
--SET @ACCNO= '620401526228'           
--    DECLARE @SEG VARCHAR(100)        
--    SET @SEG='bse,NSE'           
  SELECT Data INTO  #T2 FROM dbo.Split1(@SEG,',')        
          
  DECLARE @listStr VARCHAR(MAX)            
SELECT @listStr = COALESCE(@listStr+',' , '') + fld_segment            
 from TBL_RTGS_SUBBROKER_MFSB  where fld_sub_code=@Tag            
 and fld_status='A'  and fld_bank_Acno=@accno  and fld_segment in(SELECT DATA FROM #T2 )           
        
            
            
select distinct fld_sub_code,tradename,@listStr as 'seg' from TBL_RTGS_SUBBROKER_MFSB              
where fld_status='A'              
and fld_bank_acno=@accno              
and fld_sub_code=@Tag              
and fld_segment in  (SELECT DATA FROM #T2)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_Accno_DACTIVE1_MFSB
-- --------------------------------------------------
CREATE procedure pr_Accno_DACTIVE1_MFSB --'MLIN','620401526228','bse,NSE'               
(                  
  @Tag varchar(20)                  
 ,@accno varchar(20)                  
 ,@seg  varchar(50)              
                    
)                  
                  
AS                  
                  
--select fld_segment from tbl_rtgs_subbroker_temp                  
--where fld_status='active'                  
--and fld_bank_acno=@accno                  
--and fld_sub_code=@Tag                  
--and fld_segment=@segment               
--dECLARE @TAG VARCHAR(20)            
            
--SET @TAG='MLIN'            
--DECLARE @ACCNO VARCHAR(100)            
--SET @ACCNO= '620401526228'               
--    DECLARE @SEG VARCHAR(100)            
--    SET @SEG='bse,NSE'               
                   
--select fld_segment from tbl_rtgs_subbroker_temp                  
--where fld_status='active'                  
--and fld_bank_acno=@accno                  
--and fld_sub_code=@Tag                  
--and fld_segment=@segment               
--dECLARE @TAG VARCHAR(20)            
            
--SET @TAG='MLIN'            
--DECLARE @ACCNO VARCHAR(100)            
--SET @ACCNO= '620401526228'               
--    DECLARE @SEG VARCHAR(100)            
--    SET @SEG='bse,NSE'               
  SELECT Data INTO  #T2 FROM risk.dbo.Split1(@SEG,',')            
              
  DECLARE @listStr VARCHAR(MAX)                
SELECT @listStr = COALESCE(@listStr+',' , '') + fld_segment                
 from tbl_rtgs_subbroker_MFSB  where fld_sub_code=@Tag                
 and fld_status='A'  and fld_bank_Acno<>@accno  and fld_segment in(SELECT DATA FROM #T2 )               
            
                
                
select distinct fld_sub_code,Fld_Bank_AcNo,@listStr as 'seg' from tbl_rtgs_subbroker_MFSB                   
where fld_status='A'                  
and fld_bank_acno<>@accno                  
and fld_sub_code=@Tag                  
and fld_segment in  (SELECT DATA FROM #T2)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_Accno_DEACTIVE1
-- --------------------------------------------------
CREATE procedure pr_Accno_DEACTIVE1 --'MLIN','620401526228','bse,NSE'         
(            
  @Tag varchar(20)            
 ,@accno varchar(20)            
 ,@seg  varchar(50)        
              
)            
            
AS            
            
--select fld_segment from tbl_rtgs_subbroker_temp            
--where fld_status='active'            
--and fld_bank_acno=@accno            
--and fld_sub_code=@Tag            
--and fld_segment=@segment         
--dECLARE @TAG VARCHAR(20)      
      
--SET @TAG='MLIN'      
--DECLARE @ACCNO VARCHAR(100)      
--SET @ACCNO= '620401526228'         
--    DECLARE @SEG VARCHAR(100)      
--    SET @SEG='bse,NSE'         
             
--select fld_segment from tbl_rtgs_subbroker_temp            
--where fld_status='active'            
--and fld_bank_acno=@accno            
--and fld_sub_code=@Tag            
--and fld_segment=@segment         
--dECLARE @TAG VARCHAR(20)      
      
--SET @TAG='MLIN'      
--DECLARE @ACCNO VARCHAR(100)      
--SET @ACCNO= '620401526228'         
--    DECLARE @SEG VARCHAR(100)      
--    SET @SEG='bse,NSE'         
  SELECT Data INTO  #T2 FROM dbo.Split1(@SEG,',')      
        
  DECLARE @listStr VARCHAR(MAX)          
SELECT @listStr = COALESCE(@listStr+',' , '') + fld_segment          
 from tbl_rtgs_subbroker  where fld_sub_code=@Tag          
 and fld_status='A'  and fld_bank_Acno<>@accno  and fld_segment in(SELECT DATA FROM #T2 )         
      
          
          
select distinct fld_sub_code,Fld_Bank_AcNo,@listStr as 'seg' from tbl_rtgs_subbroker             
where fld_status='A'            
and fld_bank_acno<>@accno            
and fld_sub_code=@Tag            
and fld_segment in  (SELECT DATA FROM #T2)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_Accno_DEACTIVE1_MFSB
-- --------------------------------------------------
CREATE procedure pr_Accno_DEACTIVE1_MFSB --'MLIN','620401526228','bse,NSE'           
(              
  @Tag varchar(20)              
 ,@accno varchar(20)              
 ,@seg  varchar(50)          
                
)              
              
AS              
              
--select fld_segment from tbl_rtgs_subbroker_temp              
--where fld_status='active'              
--and fld_bank_acno=@accno              
--and fld_sub_code=@Tag              
--and fld_segment=@segment           
--dECLARE @TAG VARCHAR(20)        
        
--SET @TAG='MLIN'        
--DECLARE @ACCNO VARCHAR(100)        
--SET @ACCNO= '620401526228'           
--    DECLARE @SEG VARCHAR(100)        
--    SET @SEG='bse,NSE'           
               
--select fld_segment from tbl_rtgs_subbroker_temp              
--where fld_status='active'              
--and fld_bank_acno=@accno              
--and fld_sub_code=@Tag              
--and fld_segment=@segment           
--dECLARE @TAG VARCHAR(20)        
        
--SET @TAG='MLIN'        
--DECLARE @ACCNO VARCHAR(100)        
--SET @ACCNO= '620401526228'           
--    DECLARE @SEG VARCHAR(100)        
--    SET @SEG='bse,NSE'           
  SELECT Data INTO  #T2 FROM dbo.Split1(@SEG,',')        
          
  DECLARE @listStr VARCHAR(MAX)            
SELECT @listStr = COALESCE(@listStr+',' , '') + fld_segment            
 from tbl_rtgs_subbroker_MFSB  where fld_sub_code=@Tag            
 and fld_status='A'  and fld_bank_Acno<>@accno  and fld_segment in(SELECT DATA FROM #T2 )           
        
            
            
select distinct fld_sub_code,Fld_Bank_AcNo,@listStr as 'seg' from tbl_rtgs_subbroker_MFSB               
where fld_status='A'              
and fld_bank_acno<>@accno              
and fld_sub_code=@Tag              
and fld_segment in  (SELECT DATA FROM #T2)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_accno_MFSB
-- --------------------------------------------------
create procedure pr_accno_MFSB    --'gold','bse','043010200025512',''                    
 (                      
   @tag varchar(20)                      
  ,@seg varchar(20)                      
  ,@accno varchar(100)                      
  ,@Err_msg varchar(50)  out                        
)                      
AS                      
SELECT REPLACE(Fld_Bank_AcNo,'&nbsp;','') AS aCCNO,MAKER                       
INTO #T1                      
FROM TBL_RTGS_SUBBROKER_MFSB                      
WHERE Fld_Sub_Code=@tag AND Fld_Segment=@seg    and Fld_Bank_AcNo=@accno                  
 and fld_status in('Pending','p')                      
                      
 Declare @count int    
                      
 set @count=(SELECT count(ACCNO) FROM #T1)                      
                      
IF(@count=0)                      
BEGIN                      
                        
 set @err_msg='Invalid AccountNo'                              
SELECT ltrim(rtrim(@err_msg))  as 'errmsg'                             
                          
END                    
                    
else                    
                    
set @err_msg='AccountNo Matched'                              
SELECT ltrim(rtrim(@err_msg)) as 'errmsg'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_BANKDETAILS_MFSB
-- --------------------------------------------------
CREATE PROCEDURE PR_BANKDETAILS_MFSB   --'ADR','BSE,200173113000070'               
(                  
  @TAG VARCHAR(20)                  
 ,@SEG VARCHAR (50)                   
)                  
AS                   
                  
                  
                 
  declare @seg1 varchar(50)                
set @seg1=(select    substring (@seg,(charindex(',',@seg))-5,5))                  
                  
DECLARE @IFSC VARCHAR(100)                  
SET @IFSC=(SELECT DISTINCT IFSC FROM TBL_RTGS_SUBBROKER_MFSB                    
WHERE FLD_SUB_CODE=@TAG AND FLD_SEGMENT=@seg1)                  
                  
DECLARE @BRANCHNAME VARCHAR(20)                  
SET @BRANCHNAME=(SELECT Top 1 BRANCH_NAME FROM Risk.dbo.RTGS_MASTER WHERE IFSC_CODE=@IFSC)                  
                  
                  
DECLARE @BRANCHADD VARCHAR(200)                  
SET @BRANCHADD=(SELECT Top 1 BRANCH_ADDRESS FROM Risk.dbo.RTGS_MASTER WHERE IFSC_CODE=@IFSC AND BRANCH_NAME=@BRANCHNAME)                  
                  
                  
SELECT  NameinBank,Fld_Bank_AcNo,IFSC,FLD_TYPE,MICR                  
,bankname,@BRANCHNAME as 'Branch name',@BRANCHADD as 'Branch Address',fld_type,ChqImage,OtherImage                  
FROM TBL_RTGS_SUBBROKER_MFSB                 
WHERE FLD_SUB_CODE=@TAG AND FLD_SEGMENT=@seg1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_CANCEL_MFSB
-- --------------------------------------------------
CREATE PROCEDURE PR_CANCEL_MFSB                
(                
                
              
             
  @tag varchar(20)                
         
)                
AS                
                
SELECT Fld_Sr_No      
,Fld_Sub_Code      
,Fld_Segment as 'Segment'      
,Fld_RTGS_Sr_No      
,Fld_Bank_AcNo as 'AccountNo'      
,Fld_Status as 'Status'      
,Fld_Docs_Recd      
,Fld_Entered_By      
,Fld_Remark      
,Fld_Entry_Date      
,Fld_Access_Code      
,Fld_Ip      
,Fld_Req_by      
,Fld_CSO_Docs_Recd      
,Fld_Type      
,Fld_Active_By      
,Fld_Active_Date      
,Fld_Active_Ip      
,Fld_UniqueID      
,ChqImage      
,ChqAttach      
,OtherImage      
,OtherAttach      
,NameinBank as 'Name_in_bank'      
,NameasperOracle as 'Name_as_per_Oracle'      
,vendorNo      
,paymode      
,tradename      
,IFSC      
,bankname      
,MAKER      
,CHECKER      
,MICR      
,branchname      
,branchadd       
,ChqAttach as 'Chq'      
,OtherAttach as 'other'      
FROM TBL_RTGS_SUBBROKER_MFSB    
WHERE  fld_sub_code=@tag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_CHECK_TRADENAME
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[PR_CHECK_TRADENAME]              
(              
               
 @TAG VARCHAR(20)              
,@SEG VARCHAR(20)               
               
)              
              
              
AS              
select regtag,regexchangesegment,segment=case when regexchangesegment like  'B%CS' then 'BSE'               
                            when regexchangesegment  like  'N%CS' then 'NSE'                
                            when regexchangesegment  like 'N%CF' then 'NSX'                
                            when regexchangesegment like  'N%MF' then 'MCD'                
                            when regexchangesegment like 'N%FA' then 'NSEFO'                
                            when regexchangesegment LIKE 'M%CX' then 'MCX'                
                            when regexchangesegment LIKE  'N%CX' then 'NCDEX'                
end              
              
              
,regtradename INTO #SBREG               
from [MIS].sb_comp.dbo.bpregmaster              
where regtag=@TAG              
and regexchangesegment not like 'B%cr'              
              
select FLD_SUB_CODE,FLD_SEGMENT,Replace(TRADENAME, '&AMP;','&') as TRADENAME INTO #RTGS from tbl_rtgs_subbroker             
              
 where FLD_SUB_CODE=@TAG              
 AND FLD_SEGMENT=@SEG              
 AND FLD_STATUS in ('PENDING','P')              
               
               
 SELECT * FROM #SBREG              
 INNER JOIN #RTGS              
 ON #SBREG.REGTAG = #RTGS.FLD_SUB_CODE              
 AND #SBREG.SEGMENT=#RTGS.FLD_SEGMENT              
 AND #SBREG.REGTRADENAME=#RTGS.TRADENAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_CHECK_TRADENAME_MFSB
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[PR_CHECK_TRADENAME_MFSB]                
(                
                 
 @TAG VARCHAR(20)                
,@SEG VARCHAR(20)                 
                 
)                
                
                
AS                
select regtag,regexchangesegment,segment=case when regexchangesegment like  'B%CS' then 'BSE'                 
                            when regexchangesegment  like  'N%CS' then 'NSE'                  
                            when regexchangesegment  like 'N%CF' then 'NSX'                  
                            when regexchangesegment like  'N%MF' then 'MCD'                  
                            when regexchangesegment like 'N%FA' then 'NSEFO'                  
                            when regexchangesegment LIKE 'M%CX' then 'MCX'                  
                            when regexchangesegment LIKE  'N%CX' then 'NCDEX'                  
end                
                
                
,regtradename INTO #SBREG                 
from [MIS].sb_comp.dbo.bpregmaster                
where regtag=@TAG                
and regexchangesegment not like 'B%cr'                
                
select FLD_SUB_CODE,FLD_SEGMENT,Replace(TRADENAME, '&AMP;','&') as TRADENAME INTO #RTGS from TBL_RTGS_SUBBROKER_MFSB               
                
 where FLD_SUB_CODE=@TAG                
 AND FLD_SEGMENT=@SEG                
 AND FLD_STATUS in ('PENDING','P')                
                 
                 
 SELECT * FROM #SBREG                
 INNER JOIN #RTGS                
 ON #SBREG.REGTAG = #RTGS.FLD_SUB_CODE                
 AND #SBREG.SEGMENT=#RTGS.FLD_SEGMENT                
 AND #SBREG.REGTRADENAME=#RTGS.TRADENAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_DEACTIVE_SUBBROKER_MFSB
-- --------------------------------------------------
CREATE PROCEDURE PR_DEACTIVE_SUBBROKER_MFSB          
(          
  @tag varchar(20)          
          
)          
AS        
if(@tag='')    
begin    
 set @tag='%'    
end    
      
SELECT FLD_SUB_CODE,Fld_Segment,Fld_Bank_AcNo,tradename,NameasperOracle,bankname      
,IFSC,MAKER,CHECKER          
FROM TBL_RTGS_SUBBROKER_MFSB          
WHERE Fld_Status='A'          
AND Fld_Segment<>'BSE REMISIOR'          
and Fld_Sub_Code like @tag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_IFSC_CODE
-- --------------------------------------------------
CREATE PROCEDURE PR_IFSC_CODE        
(        
  @IFSC varchar(20)        
        
)         
AS         
 SELECT Upper(IFSC_CODE) as IFSC_CODE,BANK_NAME,BRANCH_NAME,BRANCH_ADDRESS,MICR_CODE        
  FROM  Risk.dbo.RTGS_MASTER        
  WHERE IFSC_CODE=@IFSC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pr_maker_check_MFSB
-- --------------------------------------------------
CREATE procedure  Pr_maker_check_MFSB  --'jjii','bse'                 
(                  
                  
  @tag varchar(20)                  
  ,@seg varchar(50)                  
)                  
As                  
                  
select maker,fld_status=case when Fld_Status= 'p' then 'Pending'     
                             when Fld_Status='pending' then 'pending'  else Fld_Status end    
 from TBL_RTGS_SUBBROKER_MFSB              
where fld_sub_code=@tag and fld_segment=@seg             
and fld_status in ('pending','P')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pr_maker_check1_MFSB
-- --------------------------------------------------
CREATE procedure  Pr_maker_check1_MFSB -- 'vrm'--,'bse'                 
(                  
                  
  @tag varchar(20)                  
  --,@seg varchar(50)                  
)                  
As                  
                  
select distinct ISNULL(maker,'') 'maker',fld_status from TBL_RTGS_SUBBROKER_MFSB                 
where fld_sub_code=@tag           
and fld_status in('pending','P')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_maker1
-- --------------------------------------------------
CREATE procedure pr_maker1        
@tag VARCHAR(20)        
,@username VARCHAR(50)        
as        
Select distinct SUBSTRING(maker,CHARINDEX('|',MAKER)-11,11) from tbl_rtgs_subbroker     
where fld_sub_code=@tag        
and fld_status in ('pending','p')        
and maker=@username

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_maker1_MFSB
-- --------------------------------------------------
CREATE procedure pr_maker1_MFSB          
@tag VARCHAR(20)          
,@username VARCHAR(50)          
as          
Select distinct SUBSTRING(maker,CHARINDEX('|',MAKER)-11,11) from TBL_RTGS_SUBBROKER_MFSB       
where fld_sub_code=@tag          
and fld_status in ('pending','p')          
and maker=@username

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_MFSB_SB_APPROVE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[PR_MFSB_SB_APPROVE]                          
(                    
   @Tag varchar(20)                    
)                    
AS                          
                    
SELECT FLD_SUB_CODE,FLD_SEGMENT,Replace(TRADENAME, '&AMP;','&') as TRADENAME,'NameinBank' as NAMEINBANK,NAMEASPERORACLE,BANKNAME,IFSC, PAYMODE              
 ,maker                         
,ChqImage,ChqAttach,OtherImage,OtherAttach,fld_status=case when fld_status='PENDING' then 'PENDING' when fld_status='P' then 'PENDING' end                      ,      
Fld_Bank_AcNo      
FROM  TBL_RTGS_SUBBROKER_MFSB                          
WHERE Fld_Status in ('PENDING','P')                     
AND FLD_sub_code=@Tag        
and Fld_Segment <> 'BSE REMISIOR'                  
order by fld_segment

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pr_MFSB_SB_tag
-- --------------------------------------------------
CREATE PROCEDURE Pr_MFSB_SB_tag  @tag  VARCHAR(20)                          
AS                                          
  BEGIN                                          
                                     
                                    
            SELECT sr=Row_number()                                          
                        OVER (                                          
                          ORDER BY fld_sub_code),                                          
                   case when fld_status='A' then 'Active'       
                        when fld_status='D' then 'Deactive'        
                        when fld_status='P' then 'Pending'      
                        when fld_status='R' then 'Rejected'        
                   else fld_status end as 'status',                                    
                   nameinbank       AS 'name_in_bank',                                          
                  nameasperoracle AS 'name_as_per_oracle',                                          
                   paymode,                                          
                   ifsc,                                          
                   vendorno,                                          
                   fld_segment as 'segment',                                          
                   ChqImage,                                          
                   ChqAttach,                                          
                   OtherImage,                                          
                   OtherAttach,                                          
                   tradename ,                                          
                   fld_bank_acno as 'AccountNo',                                          
                   bankname                                    
                   ,micr                                  
                   ,branchname ,branchadd,Fld_Type,ChqAttach as 'chq',OtherAttach as 'other',maker,case when fld_status='A' then  checker+'|'+FLD_IP+ '|'+CONVERT(varchar(10),getdate(),103)               
                                                                                                        when fld_status='Pending' then ''               
                                                                                                        when fld_status='Rejected' then checker+'|'+FLD_IP+ '|'+CONVERT(varchar(10),getdate(),103)              
                                                                                                        when fld_status='Deactive' then checker+'|'+FLD_IP+ '|'+CONVERT(varchar(10),getdate(),103)              
                                                                                                        end  as 'CheckerID'                                     
            FROM   TBL_RTGS_SUBBROKER_MFSB                                           
            WHERE  fld_sub_code =@tag                        
            and fld_segment<>''      
            order by  fld_status,fld_segment          
                                           
                              
                          
                          
                            
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_oracle_rtgs_MFSB
-- --------------------------------------------------
               
 CREATE procedure [dbo].[pr_oracle_rtgs_MFSB]-- 'hai','bse'              
 (              
               
   @Tag varchar(20)              
  ,@Seg varchar(50)               
  )              
              
AS              
              
              
              
Declare @reg1 varchar(50)              
Declare @reg varchar(50)              
              
set @reg=case when @seg='BSE' then 'B%cs'              
              when @seg='NSE' then 'n%cs'              
              when @seg='MCD' then 'n%mf'              
              when @seg='NSX' then 'n%cf'              
              when @seg='MCX' then 'm%cx'              
              when @seg='NCDEX' then 'n%cx'              
              when @seg='NSEFO' then 'n%fa'              
              End              
                            
                            
                            
set @reg1=case when @seg='BSE' then 'ABLCM'              
              when @seg='NSE' then 'ACDLCM'              
              when @seg='MCD' then 'ACPLMCD'              
              when @seg='NSX' then 'ACDLNSX'              
              when @seg='MCX' then 'ACPLMCX'              
              when @seg='NCDEX' then 'ACPLNCDX'              
              when @seg='NSEFO' then 'ACDLFO'              
              End              
                  
                  
 select               
 regtradename  from [MIS].sb_comp.dbo.bpregmaster              
 where regtag=@TAG and  regexchangesegment =  'NIMF'   
 
 select  isnull(ACname,'') as [Name as per Oracle], isnull('',0) vendorno                 
from anand1.account.dbo.acmast where cltcode like '48%'  and cltcode like '%' +@TAG   
               
 --select               
 --isnull(vendor_name,'') + '-' + convert(varchar(20),isnull(vendor_number,0)) as [Name as per Oracle],isnull(vendor_number,0) as 'vendorno'  from  [MIS].sb_comp.dbo.vendor_mapping              
 --where sbtag=@TAG and  segment  = @reg1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pr_status
-- --------------------------------------------------
CREATE procedure Pr_status            
            
(            
            
  @tag varchar(20)            
 ,@seg varchar(50)          
 ,@accno varchar(50)          
)            
            
as            
            
select distinct case when fld_status='A' then 'ACTIVE' else fld_status end as fld_status  from TBL_RTGS_SUBBROKER           
where fld_sub_code=@tag            
and fld_segment=@seg            
and fld_status='A'          
and Fld_Bank_AcNo not in (@accno)        
and fld_status not in('deactive','pending','D','P')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pr_status_MFSB
-- --------------------------------------------------
CREATE procedure Pr_status_MFSB              
              
(              
              
  @tag varchar(20)              
 ,@seg varchar(50)            
 ,@accno varchar(50)            
)              
              
as              
              
select distinct case when fld_status='A' then 'ACTIVE' else fld_status end as fld_status  from TBL_RTGS_SUBBROKER_MFSB             
where fld_sub_code=@tag              
and fld_segment=@seg              
and fld_status='A'            
and Fld_Bank_AcNo not in (@accno)          
and fld_status not in('deactive','pending','D','P')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_tag
-- --------------------------------------------------
CREATE procedure [dbo].[pr_tag]    
(    
  @tag varchar(20)    
)    
    
As     
    
Select SBtag from [MIS].sb_comp.dbo.sb_broker    
where sbtag=@tag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_tag_MFSB
-- --------------------------------------------------
CREATE procedure [dbo].[pr_tag_MFSB]      
(      
  @tag varchar(20)      
)      
      
As       
      
Select SBtag from [MIS].sb_comp.dbo.sb_broker      
where sbtag=@tag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_OfsInsScriptMst_UAT
-- --------------------------------------------------
  
CREATE Procedure [dbo].[Prc_OfsInsScriptMst_UAT]        
(      
@Srno int=null,      
@ScripName varchar(50),        
@BSECode   varchar(20),        
@NSESymbol varchar(20),        
@ValidForDate varchar(12),        
@MinBidRate money,        
@MaxBidRate money,        
@PercentAlert int,        
@RI_AmtLimit money,        
@MinMarginPercent int,        
@Checkon_NetA_NetL char(2),        
@EnteredBy varchar(10),  
@OfferSize Money,   
@RetailPercent int  
)        
As        
Begin        
    
if(isnull(@Srno,'')='')    
Begin    
    
insert into OFS_ScripMaster_(ScripName,BSECode,NSESymbol,ValidForDate,MinBidRate,MaxBidRate,PercentAlert,RI_AmtLimit,MinMarginPercent,Checkon_NetA_NetL,EnteredBy,EnteredOn,OfferSize,RetailPercent,ReatilSize)   --,ReatilSize ,OfferSize,RetailPercent  
values        
(@ScripName,@BSECode,@NSESymbol,convert(datetime,@ValidForDate,103),@MinBidRate,@MaxBidRate,@PercentAlert,@RI_AmtLimit,@MinMarginPercent,@Checkon_NetA_NetL,@EnteredBy,GETDATE(),@OfferSize,@RetailPercent,(@OfferSize*@RetailPercent/100)) --,(@OfferSize*@RetailPercent/100),@OfferSize,@RetailPercent  
End    
Else    
Begin    
update OFS_ScripMaster    
set ScripName=@ScripName,    
BSECode=@BSECode,NSESymbol=@NSESymbol,ValidForDate=convert(datetime,@ValidForDate,103),MinBidRate=@MinBidRate,MaxBidRate=@MaxBidRate    
,PercentAlert=@PercentAlert,RI_AmtLimit=@RI_AmtLimit,MinMarginPercent=@MinMarginPercent,Checkon_NetA_NetL=@Checkon_NetA_NetL,EnteredBy=@EnteredBy    
where Srno=@Srno    
End    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_GET_Employee_separation_DETAILS_06032024
-- --------------------------------------------------
  
  
  
  
     
  
  
  
-- PROC_GET_Employee_separation_DETAILS 'A'      
  
  
  
Create PROCEDURE [dbo].[PROC_GET_Employee_separation_DETAILS_06032024]      
  
  
  
(      
  
  
  
@STATUS VARCHAR(5)      
  
  
  
)      
  
  
  
AS      
  
  
  
BEGIN       
  
  
  
   
  
  
  
 IF @STATUS='S'    
  
  
  
 BEGIN    
  
  
  
  --SELECT  HED.[Emp No],    
  
  
  
  --CONVERT(VARCHAR(10),HED.[separation Date],121)[separation Date],    
  
  
  
  --B.stServerConn  as [CTCL Sever],    
  
  
  
  --stVsatLLId as [Vsat/LL ID],    
  
  
  
  --stManagerId as [Manager Id],    
  
  
  
  --B.stBrTag as [Branch Code],    
  
  
  
  --B.stSBTag as [SB. Tag],    
  
  
  
  --stodinid as [OdinId],    
  
  
  
  --stPurpose as [Purpose of Ctcl Id],    
  
  
  
  --B.stSegment as [Seg],    
  
  
  
  --stFirstName [User  First Name],    
  
  
  
  --stMiddleName [User  Middle Name],    
  
  
  
  --stLastName [User  Last Name],         
  
  
  
  --'A' as [Terminal Status],    
  
  
  
  --stOfficeNature as [Nature of Office],    
  
  
  
  --B.stCTCLId as [CTCL ID (12 Digit Id)],    
  
  
  
  --e.stCertbase,    
  
  
  
  --(case when e.stCertbase='PRIMARY' then (stRegNoPrifix+'-'+stRegNo) else '' end) as [NCFM / BCSM Regn.No] ,      
  
  
  
  --Convert(char(15),dtValidityDate,103) ValidUpTo,    
  
  
  
  --(case when e.stCertbase='SECONDARY' then (stRegNoPrifix+'-'+stRegNo) else '' end) as [Secondary NCFM / BCSM No] ,    
  
  
  
  --Convert(char(15),dtDOB,103) DOB,          
  
  
  
  --stPaymentNature as [Nature of Payment],    
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrAddress1 else t.TerAddLine1 end as [Terminal Address 1],    
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrAddress2 else TerAddLine2 end as [Terminal Address 2],      
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrAddress3 else TerLandmark end as [Terminal Address 3] ,    
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrCity else t.TerCity end as [Terminal City],    
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrState else TerState end as [Terminal State],      
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrZip else TerPinCode end as [Terminal PinCode],          
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stbrSTD else '' end+' '+case when B.stSBTag=B.stBrtag then C.stbrContactNO else TerTelphoneNo end as [Terminal Telephone],    
  
  
  
  --case when B.stSBTag=B.stBrtag then '' else terMobNo end as [Terminal Mobile]  ,    
  
  
  
  --'' as [Terminal Fax],          
  
  
  
  --case when B.stSBTag=B.stBrtag then stbrEmail else terEmailId end as TerminalEmail ,    
  
  
  
  --stResiAddress1 as [ResiAddress1],          
  
  
  
  --stResiAddress2 as [ResiAddress2],     
  
  
  
  --stResiAddress3 as [ResiAddress3],     
  
  
  
  --stResiCity as City,           
  
  
  
  --stResiState as State,    
  
  
  
  --stResiPinCode as ResiPinCode,     
  
  
  
  --stEmail as Email,     
  
  
  
  --stCertBelongsTo as [Certificate Belongs To],     
  
  
  
  --stMAPINNo as [MAPIN No],           
  
  
  
  --stPanCardNo As [Pan No],    
  
  
  
  --B.stEmpCode as EmpCode,    
  
  
  
  --stConnMode as [Mode of connectivity],          
  
  
  
  --case when Convert(char(14),B.dtUpdatedOn,103) is null then Convert(char(14),B.dtCreatedOn,103) else Convert(char(14),B.dtUpdatedOn,103) end  as [Activation Date]  ,    
  
  
  
  --(Case when B.stCSOStatus='D' then Convert(char(15),B.dtUpdatedOn,103) else '' end ) as [Deactivation Date],    
  
  
  
  --stUserRelationshipWithTM as [User Relatioship],    
  
  
  
  --t.ContactPerson,B.stIntSysRefNo as [Record Number],    
  
  
  
  --B.stRemarks as [(NCFM / BCSM ) Remarks]        
  
  
  
  --from tbl_ctclid B      
  
  
  
  --INNER JOIN tbl_EmpMaster e ON B.stIntSysRefNo=e.stIntSysRefNo      
  
  
  
  --left outer JOIN [196.1.115.167].sb_comp.dbo.VW_SubBroker_Details t ON B.stSBTag=t.SBTag      
  
  
  
  --left outer JOIN tbl_BranchMaster C ON B.stBrTag=C.stBrTag           
  
  
  
  --inner join [196.1.115.239].[Harmony].dbo.VLMSInhouse HED on HED.[Emp No]= B.stEmpCode  and  HED.[separation Date] is not null    
  
  
  
  --where  B.ststatus='A' and B.stCSOStatus='A' and CONVERT(varchar(10),HED.[Separation Date],121)<CONVERT(varchar(10),getdate(),121)    
  
  
  
  
  
  
  
  SELECT  HED.[Emp_No] AS [Emp No],    
  
  
  
  CONVERT(VARCHAR(10),HED.Last_Working_Date,121)[separation Date],    
  
  
  
  B.stServerConn  as [CTCL Sever],    
  
  
  
  stVsatLLId as [Vsat/LL ID],   
  
  
  
  stManagerId as [Manager Id],    
  
  
  
  B.stBrTag as [Branch Code],    
  
  
  
  B.stSBTag as [SB. Tag],    
  
  
  
  stodinid as [OdinId],    
  
  
  
  stPurpose as [Purpose of Ctcl Id],    
  
  
  
  B.stSegment as [Seg],    
  
  
  
  stFirstName [User  First Name],    
  
  
  
  stMiddleName [User  Middle Name],    
  
  
  
  stLastName [User  Last Name],         
  
  
  
  'A' as [Terminal Status],    
  
  
  
  stOfficeNature as [Nature of Office],    
  
  
  
  B.stCTCLId as [CTCL ID (12 Digit Id)],    
  
  
  
  e.stCertbase,    
  
  
  
  (case when e.stCertbase='PRIMARY' then (stRegNoPrifix+'-'+stRegNo) else '' end) as [NCFM / BCSM Regn.No] ,      
  
  
  
  Convert(char(15),dtValidityDate,103) ValidUpTo,    
  
  
  
  (case when e.stCertbase='SECONDARY' then (stRegNoPrifix+'-'+stRegNo) else '' end) as [Secondary NCFM / BCSM No] ,    
  
  
  
  Convert(char(15),dtDOB,103) DOB,          
  
  
  
  stPaymentNature as [Nature of Payment],    
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrAddress1 else t.TerAddLine1 end as [Terminal Address 1],    
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrAddress2 else TerAddLine2 end as [Terminal Address 2],      
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrAddress3 else TerLandmark end as [Terminal Address 3] ,    
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrCity else t.TerCity end as [Terminal City],    
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrState else TerState end as [Terminal State],      
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrZip else TerPinCode end as [Terminal PinCode],          
  
  
  
  case when B.stSBTag=B.stBrtag then C.stbrSTD else '' end+' '+case when B.stSBTag=B.stBrtag then C.stbrContactNO else TerTelphoneNo end as [Terminal Telephone],    
  
  
  
  case when B.stSBTag=B.stBrtag then '' else terMobNo end as [Terminal Mobile]  ,    
  
  
  
  '' as [Terminal Fax],          
  
  
  
  case when B.stSBTag=B.stBrtag then stbrEmail else terEmailId end as TerminalEmail ,    
  
  
  
  stResiAddress1 as [ResiAddress1],          
  
  
  
  stResiAddress2 as [ResiAddress2],     
  
  
  
  stResiAddress3 as [ResiAddress3],     
  
  
  
  stResiCity as City,           
  
  
  
  stResiState as State,    
  
  
  
  stResiPinCode as ResiPinCode,     
  
  
  
  stEmail as Email,     
  
  
  
  stCertBelongsTo as [Certificate Belongs To],     
  
  
  
  stMAPINNo as [MAPIN No],           
  
  
  
  stPanCardNo As [Pan No],    
  
  
  
  B.stEmpCode as EmpCode,    
  
  
  
  stConnMode as [Mode of connectivity],          
  
  
  
  case when Convert(char(14),B.dtUpdatedOn,103) is null then Convert(char(14),B.dtCreatedOn,103) else Convert(char(14),B.dtUpdatedOn,103) end  as [Activation Date]  ,    
  
  
  
  (Case when B.stCSOStatus='D' then Convert(char(15),B.dtUpdatedOn,103) else '' end ) as [Deactivation Date],    
  
  
  
  stUserRelationshipWithTM as [User Relatioship],    
  
  
  
  t.ContactPerson,B.stIntSysRefNo as [Record Number],    
  
  
  
  B.stRemarks as [(NCFM / BCSM ) Remarks]        
  
  
  
  from tbl_ctclid B      
  
  
  
  INNER JOIN tbl_EmpMaster e ON B.stIntSysRefNo=e.stIntSysRefNo      
  
  
  
  left outer JOIN [MIS].sb_comp.dbo.VW_SubBroker_Details t ON B.stSBTag=t.SBTag      
  
  
  
  left outer JOIN tbl_BranchMaster C ON B.stBrTag=C.stBrTag           
  
  
  
  --inner join [196.1.115.239].[Harmony].dbo.VLMSInhouse HED on HED.[Emp No]= B.stEmpCode  and  HED.[separation Date] is not null    
  
  
  
  INNER JOIN [ABVSHRMS.[DarwinBoxMiddleware].[dbo].[tbl_EmployeeMaster] HED on HED.[Emp_No]= B.stEmpCode  and  HED.Last_Working_Date is not null    
  
  
  
  where  B.ststatus='A' and B.stCSOStatus='A' and CONVERT(varchar(10),HED.Last_Working_Date,121)<CONVERT(varchar(10),getdate(),121)    
  
  
  
  
  
  
  
       
  
  
  
 END    
  
  
  
 ELSE    
  
  
  
 BEGIN    
  
  
    --SELECT  HED.[Emp No],    
  
  
  
  --CONVERT(VARCHAR(10),HED.[separation Date],121)[separation Date],    
  
  
  
  --B.stServerConn  as [CTCL Sever],    
  
  
  
  --stVsatLLId as [Vsat/LL ID],    
  
  
  
  --stManagerId as [Manager Id],    
  
  
  
  --B.stBrTag as [Branch Code],    
  
  
  
  --B.stSBTag as [SB. Tag],    
  
  
  
  --stodinid as [OdinId],    
  
  
  
  --stPurpose as [Purpose of Ctcl Id],    
  
  
  
  --B.stSegment as [Seg],    
  
  
  
  --stFirstName [User  First Name],    
  
  
  
  --stMiddleName [User  Middle Name],    
  
  
  
  --stLastName [User  Last Name],         
  
  
  
  --'A' as [Terminal Status],    
  
  
  
  --stOfficeNature as [Nature of Office],    
  
  
  
  --B.stCTCLId as [CTCL ID (12 Digit Id)],    
  
  
  
  --e.stCertbase,    
  
  
  
  --(case when e.stCertbase='PRIMARY' then (stRegNoPrifix+'-'+stRegNo) else '' end) as [NCFM / BCSM Regn.No] ,      
  
  
  
  --Convert(char(15),dtValidityDate,103) ValidUpTo,    
  
  
  
  --(case when e.stCertbase='SECONDARY' then (stRegNoPrifix+'-'+stRegNo) else '' end) as [Secondary NCFM / BCSM No] ,    
  
  
  
  --Convert(char(15),dtDOB,103) DOB,          
  
  
  
  --stPaymentNature as [Nature of Payment],    
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrAddress1 else t.TerAddLine1 end as [Terminal Address 1],    
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrAddress2 else TerAddLine2 end as [Terminal Address 2],      
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrAddress3 else TerLandmark end as [Terminal Address 3] ,    
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrCity else t.TerCity end as [Terminal City],    
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrState else TerState end as [Terminal State],      
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stBrZip else TerPinCode end as [Terminal PinCode],          
  
  
  
  --case when B.stSBTag=B.stBrtag then C.stbrSTD else '' end+' '+case when B.stSBTag=B.stBrtag then C.stbrContactNO else TerTelphoneNo end as [Terminal Telephone],    
  
  
  
  --case when B.stSBTag=B.stBrtag then '' else terMobNo end as [Terminal Mobile]  ,    
  
  
  
  --'' as [Terminal Fax],          
  
  
  
  --case when B.stSBTag=B.stBrtag then stbrEmail else terEmailId end as TerminalEmail ,    
  
  
  
  --stResiAddress1 as [ResiAddress1],          
  
  
  
  --stResiAddress2 as [ResiAddress2],     
  
  
  
  --stResiAddress3 as [ResiAddress3],     
  
  
  
  --stResiCity as City,           
  
  
  
  --stResiState as State,    
  
  
  
  --stResiPinCode as ResiPinCode,     
  
  
  
  --stEmail as Email,     
  
  
  
  --stCertBelongsTo as [Certificate Belongs To],     
  
  
  
  --stMAPINNo as [MAPIN No],           
  
  
  
  --stPanCardNo As [Pan No],    
  
  
  
  --B.stEmpCode as EmpCode,    
  
  
  
  --stConnMode as [Mode of connectivity],          
  
  
  
  --case when Convert(char(14),B.dtUpdatedOn,103) is null then Convert(char(14),B.dtCreatedOn,103) else Convert(char(14),B.dtUpdatedOn,103) end  as [Activation Date]  ,    
  
  
  
  --(Case when B.stCSOStatus='D' then Convert(char(15),B.dtUpdatedOn,103) else '' end ) as [Deactivation Date],    
  
  
  
  --stUserRelationshipWithTM as [User Relatioship],    
  
  
  
  --t.ContactPerson,B.stIntSysRefNo as [Record Number],    
  
  
  
  --B.stRemarks as [(NCFM / BCSM ) Remarks]        
  
  
  
  --from tbl_ctclid B      
  
  
  
  --INNER JOIN tbl_EmpMaster e ON B.stIntSysRefNo=e.stIntSysRefNo      
  
  
  
  --left outer JOIN [196.1.115.167].sb_comp.dbo.VW_SubBroker_Details t ON B.stSBTag=t.SBTag      
  
  
  
  --left outer JOIN tbl_BranchMaster C ON B.stBrTag=C.stBrTag           
  
  
  
  --inner join [196.1.115.239].[Harmony].dbo.VLMSInhouse HED on HED.[Emp No]= B.stEmpCode AND HED.status in('S','A')  and  HED.[separation Date] is not null    
  
  
  
  --where  B.ststatus='A' and B.stCSOStatus='A' and CONVERT(varchar(10),HED.[Separation Date],121)>=CONVERT(varchar(10),getdate(),121)    
  
  
  
      SELECT  HED.[Emp_No] AS [Emp No],    
  
  
  
  CONVERT(VARCHAR(10),HED.Last_Working_Date,121)[separation Date],    
  
  
  
  B.stServerConn  as [CTCL Sever],    
  
  
  
  stVsatLLId as [Vsat/LL ID],    
  
  
  
  stManagerId as [Manager Id],    
  
  
  
  B.stBrTag as [Branch Code],    
  
  
  
  B.stSBTag as [SB. Tag],    
  
  
  
  stodinid as [OdinId],    
  
  
  
  stPurpose as [Purpose of Ctcl Id],    
  
  
  
  B.stSegment as [Seg],    
  
  
  
  stFirstName [User  First Name],    
  
  
  
  stMiddleName [User  Middle Name],    
  
  
  
  stLastName [User  Last Name],         
  
  
  
  'A' as [Terminal Status],    
  
  
  
  stOfficeNature as [Nature of Office],    
  
  
  
  B.stCTCLId as [CTCL ID (12 Digit Id)],    
  
  
  
  e.stCertbase,    
  
  
  
  (case when e.stCertbase='PRIMARY' then (stRegNoPrifix+'-'+stRegNo) else '' end) as [NCFM / BCSM Regn.No] ,      
  
  
  
  Convert(char(15),dtValidityDate,103) ValidUpTo,    
  
  
  
  (case when e.stCertbase='SECONDARY' then (stRegNoPrifix+'-'+stRegNo) else '' end) as [Secondary NCFM / BCSM No] ,    
  
  
  
  Convert(char(15),dtDOB,103) DOB,          
  
  
  
  stPaymentNature as [Nature of Payment],    
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrAddress1 else t.TerAddLine1 end as [Terminal Address 1],    
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrAddress2 else TerAddLine2 end as [Terminal Address 2],      
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrAddress3 else TerLandmark end as [Terminal Address 3] ,    
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrCity else t.TerCity end as [Terminal City],    
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrState else TerState end as [Terminal State],      
  
  
  
  case when B.stSBTag=B.stBrtag then C.stBrZip else TerPinCode end as [Terminal PinCode],          
  
  
  
  case when B.stSBTag=B.stBrtag then C.stbrSTD else '' end+' '+case when B.stSBTag=B.stBrtag then C.stbrContactNO else TerTelphoneNo end as [Terminal Telephone],    
  
  
  
  case when B.stSBTag=B.stBrtag then '' else terMobNo end as [Terminal Mobile]  ,    
  
  
  
  '' as [Terminal Fax],          
  
  
  
  case when B.stSBTag=B.stBrtag then stbrEmail else terEmailId end as TerminalEmail ,    
  
  
  
  stResiAddress1 as [ResiAddress1],          
  
  
  
  stResiAddress2 as [ResiAddress2],     
  
  
  
  stResiAddress3 as [ResiAddress3],     
  
  
  
  stResiCity as City,           
  
  
  
  stResiState as State,    
  
  
  
  stResiPinCode as ResiPinCode,     
  
  
  
  stEmail as Email,     
  
  
  
  stCertBelongsTo as [Certificate Belongs To],     
  
  
  
  stMAPINNo as [MAPIN No],           
  
  
  
  stPanCardNo As [Pan No],    
  
  
  
  B.stEmpCode as EmpCode,    
  
  
  
  stConnMode as [Mode of connectivity],          
  
  
  
  case when Convert(char(14),B.dtUpdatedOn,103) is null then Convert(char(14),B.dtCreatedOn,103) else Convert(char(14),B.dtUpdatedOn,103) end  as [Activation Date]  ,    
  
  
  
  (Case when B.stCSOStatus='D' then Convert(char(15),B.dtUpdatedOn,103) else '' end ) as [Deactivation Date],    
  
  
  
  stUserRelationshipWithTM as [User Relatioship],    
  
  
  
  t.ContactPerson,B.stIntSysRefNo as [Record Number],    
  
  
  
  B.stRemarks as [(NCFM / BCSM ) Remarks]        
  
  
  
  from tbl_ctclid B      
  
  
  
  INNER JOIN tbl_EmpMaster e ON B.stIntSysRefNo=e.stIntSysRefNo      
  
  
  
  left outer JOIN [MIS].sb_comp.dbo.VW_SubBroker_Details t ON B.stSBTag=t.SBTag      
  
  
  
  left outer JOIN tbl_BranchMaster C ON B.stBrTag=C.stBrTag           
  
  
  
  --inner join [196.1.115.239].[Harmony].dbo.VLMSInhouse HED on HED.[Emp No]= B.stEmpCode AND HED.status in('S','A')  and  HED.Last_Working_Date is not null    
  
  
  
    INNER JOIN [ABVSHRMS].[DarwinBoxMiddleware].[dbo].[tbl_EmployeeMaster] HED on HED.[Emp_No]= B.stEmpCode  AND HED.status in('InActive','Active') and  HED.Last_Working_Date is not null    
  
  
  
  where  B.ststatus='A' and B.stCSOStatus='A' and CONVERT(varchar(10),HED.Last_Working_Date,121)>=CONVERT(varchar(10),getdate(),121)    
  
  
  
  
  
  
  
 END    
  
  
  
    
  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Random_password1
-- --------------------------------------------------
CREATE PROC Random_password1 (@len           INT = 8,--Length of the password to be generated          
                              @password_type CHAR(7) = 'simple'  
--Default is to generate a simple password with lowecase letters.           
--Pass anything other than 'simple' to generate a complex password.           
--The complex password includes numbers, special characters, upper case and lower case letters          
)  
AS  
  /*************************************************************************************************          
    Copyright  2001 Angel Broking Ltd. All rights reserved.          
  Purpose: To generate a random password          
  Written by: Manesh Mukherjee          
  Tested on:  SQL Server 7.0 and SQL Server 2000          
  Date modified: March-29-2001 01:15 PM          
  Email:   manesh@angelbroking.com          
  Examples:          
  To generate a simple password with a length of 8 characters:          
  EXEC random_password2          
            
  To generate a simple password with 6 characters:          
  EXEC random_password2 6          
            
  To generate a complex password with 8 characters:          
  EXEC random_password @Password_type = 'complex'          
            
  To generate a comples password with 6 characters:          
  EXEC random_password 6, 'complex'          
  *************************************************************************************************/  
  BEGIN  
      DECLARE @password VARCHAR(25),  
              @type     TINYINT,  
              @bitmap   CHAR(6)  
  
      SET @password=''  
      --SET @bitmap = '#$%^&~!'           
      SET @bitmap = 'aeruoy'  
  
      --@bitmap contains all the vowels, which are a, e, i, o, u and y. These vowels are used to generate slightly readable/rememberable simple passwords          
      IF @password_type <> 'simple'  
        BEGIN  
            SET @password = @password + Substring(@bitmap, CONVERT(INT, Round(1 + ( Rand() * ( 5 ) ), 0)), 1)  
            SET @len = @len - 1  
        END  
  
      SET @bitmap = 'aerouy'  
  
      --set @len =len(@password)        
      WHILE @len > 0  
        BEGIN  
            IF @password_type = 'simple' --Generating a simple password          
              BEGIN  
                  IF ( @len%2 ) = 0 --Appending a random vowel to @password          
                    SET @password = @password + Substring(@bitmap, CONVERT(INT, Round(1 + ( Rand() * ( 5 ) ), 0)), 1)  
                  ELSE --Appending a random alphabet          
                    SET @password = @password + Char(Round(97 + ( Rand() * ( 25 ) ), 0))  
              END  
            ELSE --Generating a complex password          
              BEGIN  
                  SET @type = Round(1 + ( Rand() * ( 3 ) ), 0)  
  
                  IF @type = 1 --Appending a random lower case alphabet to @password          
                    SET @password = @password + Char(Round(97 + ( Rand() * ( 25 ) ), 0))  
                  ELSE IF @type = 2 --Appending a random upper case alphabet to @password          
                    SET @password = @password + Char(Round(65 + ( Rand() * ( 25 ) ), 0))  
                  ELSE IF @type = 3 --Appending a random number between 0 and 9 to @password          
                    --SET @password = @password + Char(Round(48 + ( Rand() * ( 9 ) ), 0))  
     /*to exclude 0 and 1 as per mail received from pawan on jun 21 2013*/  
                    SET @password = @password + Char(Round(50 + ( Rand() * ( 7 ) ), 0))  
                  ELSE IF @type = 4 --Appending a random special character to @password          
                    --    below ascii code is off. replace with numeric code between 0 and 9      
                    --    SET @password = @password + CHAR(ROUND(33 + (RAND() * (13)),0))         
                    SET @password = @password + Char(Round(48 + ( Rand() * ( 9 ) ), 0))  
              END  
  
            SET @len = @len - 1  
        END  
  
      SELECT @password --Here's the result          
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RTGS_AUTO_UPDATE_MFSB
-- --------------------------------------------------
CREATE proc [dbo].[RTGS_AUTO_UPDATE_MFSB]               
@TAG VARCHAR(20)              
as              
begin              
declare              
--@TAG ='SNGY',                                                
@SEG VARCHAR(20)                                                                          
,@STATUS VARCHAR(50)                                                                          
,@TRADENAME VARCHAR(200)                                                                           
,@NAMEINBANK VARCHAR(100)                                                                          
,@ACCNO VARCHAR(100)                                                                          
,@IFSC VARCHAR(20)                                                                          
,@PAYMODE VARCHAR(20)                                                                          
,@VENDORNO VARCHAR(50)                                                                          
,@CHQIMG VARCHAR(50)=null                                                                          
,@CHQATTACH varbinary(MAX)=null                                                                          
,@OTHERIMG VARCHAR(50)  =null                                                                        
,@OTHERATTACH varbinary(MAX)   =null                                                                    
,@MAKER  VARCHAR(100)=null                                                                    
,@ACCTYPE VARCHAR(20)=null                                                                      
,@MICR VARCHAR(20)=null                                                            
,@bankname VARCHAR(20) =null                                                         
,@branchbank VARCHAR(200)  =null                                                           
,@branchadd VARCHAR(200) =null                                                        
,@NameasperOracle VARCHAR(100) =null                                             
,@ip varchar(50)  =null              
          
DECLARE @RTGS_SRNO VARCHAR(50)                                                                          
          
          
--getting subbroker bank details          
select top 1 @ACCNO=AccNo,@ACCTYPE=AccType,@ip='System',@NAMEINBANK=NameInBank,@IFSC=ifsrcode,              
@MICR=micrCode              
from              
[MIS].sb_comp.dbo.sb_bankothers where RefNo in(              
select refno from [MIS].sb_comp.dbo.sb_broker where sbtag=@TAG ) and company='MF'   and   IFSRCode is not NULL  and IFSRCode !=''         
          
          
--getting Actual bank details from RTGS master by IFSC          
SET  @RTGS_SRNO=(SELECT top 1 SR_NO FROM  risk.dbo.RTGS_MASTER WHERE  REPLACE(LTRIM(RTRIM(IFSC_CODE)),' ','')=@IFSC)                  
SELECT top 1 @bankname=Bank_Name,@branchbank=Branch_Name,@branchadd=Branch_Address FROM  risk.dbo.RTGS_MASTER WHERE  REPLACE(LTRIM(RTRIM(IFSC_CODE)),' ','')=@IFSC              
          
          
--getting Trade Name of subbbroker          
select @TRADENAME=tradeName from [MIS].sb_comp.dbo.sb_broker where sbtag=@TAG               
          
set @PAYMODE='RTGS'              
          
          
--insert RTGS if not exists in TBL_RTGS_SUBBROKER_MFSB           
if Exists(select 1 from   risk.dbo.RTGS_MASTER WHERE  REPLACE(LTRIM(RTRIM(IFSC_CODE)),' ','')=@IFSC )        
begin        
if Not Exists(select Fld_Sub_Code  from TBL_RTGS_SUBBROKER_MFSB where Fld_Sub_Code=@TAG)               
begin              
if Exists(select sbtag                
from [MIS].sb_comp.dbo.vendor_mapping where  sbtag=@TAG )              
begin              
          
--select * into #vendor_mapping from [MIS].sb_comp.dbo.vendor_mapping where  sbtag=@TAG  
       
--select  @NameasperOracle=isnull(vendor_name,'') + '-' + convert(varchar(20),isnull(vendor_number,0)),@VENDORNO=isnull(vendor_number,0)               
--from #vendor_mapping where  sbtag=@TAG and  segment  = 'ACDLCM'  

select  @NameasperOracle=isnull(ACname,'') ,@VENDORNO=isnull('',0)               
from anand1.account.dbo.acmast where cltcode like '48%'  and cltcode like '%' +@TAG   

INSERT INTO TBL_RTGS_SUBBROKER_MFSB VALUES              
(@TAG,'MF',@RTGS_SRNO,@ACCNO,'Pending','N','TEST','',GETDATE(),'','','B','',@ACCTYPE,'CHECKER','','',@IP,'',@CHQIMG,@CHQATTACH,@OTHERIMG,@OTHERATTACH,@NAMEINBANK,@NameasperOracle,@VENDORNO,case when (@IFSC='' and @iFSC is null) then 'CMS' else @PAYMODE end,      
@TRADENAME,@IFSC,@bankname,'System' + '|' + convert(varchar(10),getdate(),103),'',REPLACE (@MICR,'&nbsp;',''),REPLACE(replace(@branchbank,'&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;',''),'&nbsp;',''),REPLACE(              
@branchadd,'&nbsp;',''))       
            
drop table #vendor_mapping          
End              
End              
end        
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_Brokerage_Mail_refno_UAT_Live_05Apr2024
-- --------------------------------------------------
--SB_Brokerage_Mail_refno 'SBHS139','SBHS13920170731'
--SB_Brokerage_Mail 'j22077','BSECM',	0.0100,	0.0100,	0.0100,	0.0100,	0.0100,0.1
create procedure [dbo].[SB_Brokerage_Mail_refno_UAT_Live_05Apr2024]  (
@ClientCode as varchar(50),@REFNO as varchar(50)
)        
AS          
SET nocount ON            
 

BEGIN try        
DECLARE @Emp_name as varchar(100),@emp_email as varchar(100)                      
DECLARE @emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)   

declare @SBCode as varchar(50)=''

select @SBCode=sub_broker from client_details where party_code=@ClientCode
select @emp_email=terEmailId from mis.SB_COMP.dbo.VW_SubBroker_Details where sbtag=@SBCode
                             
--declare   @ClientCode as varchar(50)='N51935',@Segment as varchar(50)='BSECM'                           
SELECT @emailto='brokerage.intimation@angelbroking.com'--'hemantp.patel@angelbroking.com'         
SELECT @emailcc=@emp_email  ----'neha.naiwar@angelbroking.com'              
SELECT @emailbcc='hemantp.patel@angelbroking.com;jogendar.dhoble@angelbroking.com;sanket.bhambure@angelbroking.com;codetransferemailcopies@angelbroking.com'           
  DECLARE @MessBody NVARCHAR(MAX) 
  set @MessBody=''  
--declare   @ClientCode as varchar(50)='J22077',@REFNO as varchar(50)='J2207720160915' 
--declare @segment as varchar(50)
--select   row_number()over (order by segment) As Srno,segment  from SB_ClientModiBrk where Clientcode=@ClientCode 	 and Req_RefNo=@REFNO
--print @segment

                                         
declare @BSEL1 as decimal(18,4)=0.00,@BSEM1 as decimal(18,4)=0.00,@BseP1 as decimal(18,4)=0.00,@BSEL2 as decimal(18,4)=0.00,@BSEM2 as decimal(18,4)=0.00,
@BseP2 as decimal(18,4)=0.00,@BSEDel as decimal(18,4)=0.00,@BSEMDel as decimal(18,4)=0.00,@BsePDel as decimal(18,4)=0.00,@NSEL1 as decimal(18,4)=0.00,@NSEM1 as decimal(18,4)=0.00,
@NSEP1 as decimal(18,4)=0.00,@NSEL2 as decimal(18,4)=0.00,@NSEM2 as decimal(18,4)=0.00,@NSEP2 as decimal(18,4)=0.00,
@NSELDel as decimal(18,4)=0.00,@NSEMDel as decimal(18,4)=0.00,@NSEPDel as decimal(18,4)=0.00,@MCXL1 as decimal(18,4)=0.00,@MCX1M as decimal(18,4)=0.00,@MCX1Fu as decimal(18,4)=0.00,
@MCXL2 as decimal(18,4)=0.00,@MCX2M as decimal(18,4)=0.00,@MCX2Fu as decimal(18,4)=0.00,@NCDX1L as decimal(18,4)=0.00,@NCDX1Min as decimal(18,4)=0.00,@NCDX1Fu as decimal(18,4)=0.00,
@NCDX2L as decimal(18,4)=0.00,@NCDX2Min as decimal(18,4)=0.00,@NCDX2Fu as decimal(18,4)=0.00,@NSEFOFL as decimal(18,4)=0.00,
@NSEFOFMin as decimal(18,4)=0.00,@NSEFOFFu as decimal(18,4)=0.00,@NSEFOSL as decimal(18,4)=0.00,@NSEFOSMin as decimal(18,4)=0.00,@NSEFOSFu as decimal(18,4)=0.00,
@NSX1 as decimal(18,4)=0.00,@NSX2 as decimal(18,4)=0.00,@NSEFOOS1 as decimal(18,4)=0.00,@NSEFOOS2 as decimal(18,4)=0.00,@NSEFOON1 as decimal(18,4)=0.00,@NSEFOON2 as decimal(18,4)=0.00,
@NSEFOOB1 as decimal(18,4)=0.00,@NSEFOOB2 as decimal(18,4)=0.00,@NSXO1 as decimal(18,4)=0.00,@NSXO2 as decimal(18,4)=0.00,@MCD1 as decimal(18,4)=0.00,@MCD2 as decimal(18,4)=0.00,
@MCDO1 as decimal(18,4)=0.00,@MCDO2 as decimal(18,4)=0.00,
@TableNoIntr as int=0,@TableNoDel as int=0,@SchemeIDStock as int=0,@SchemeIDNifty as int=0,@SchemeIDBankNifty as int=0,
@SchemeNameBankNifty as varchar(25)='',@SchemeNameNifty as varchar(25)='',@SchemeNameStock as varchar(25)='',@SchemeIDNSX as int=0,
@SchemeNameNSX as varchar(25)='',
@BSEFOFL as money=0.00,    
@BSEFOFMin as money=0.00,@BSEFOFFu as money=0.00,@BSEFOSL as money=0.00,@BSEFOSMin as money=0.00,@BSEFOSFu as money=0.00,  
@BSEFOFL_Old  as money=0.00,@BSEFOFMin_Old as money=0.00,@BSEFOFFu_Old as money=0.00,    
   @BSEFOSL_Old as money=0.00,@BSEFOSMin_Old as money=0.00,@BSEFOSFu_Old as money=0.00
    
 if exists(select * from SB_ClientModiBrk where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='BSECM' and Emailed='N')
 begin           
	select @BSEM1=BSEM1,@BSEP1=BseP1,@BSEM2=BSEM2,@BSEP2=BseP2,@BSEMDEL=BSEMDEL,@BSEPDel=BsePDel,@TableNoIntr=TableNoIntr,@TableNoDel=TableNoDel from SB_ClientModiBrk where Clientcode=@ClientCode
	 and Req_RefNo=@REFNO and segment='BSECM' and Emailed='N'

	create table #BSE
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50),
	Intrady varchar(50),
	Delivery varchar(50)
	) 
	insert into #BSE                   
	select '1st Leg' as Type,@BSEM1 as Min,@BSEP1 as Per,@TableNoIntr as Intrady,@TableNoDel as Delivery 

	insert into #BSE                                     
	select '2nd Leg' as Type,@BSEM2 as Min,@BSEP2 as Per,'' as Intrady,'' as Delivery 

	insert into #BSE                   
	select 'Delivery' as Type,@BSEMDEL as Min,@BSEPDel  as Per,'' as Intrady,'' as Delivery 
            
	  declare @Count int,@CountEnd int,@Type as varchar(20)='',@Min as varchar(50),@Per as varchar(50),@intra as varchar(50),@Deltable as varchar(50)
	  declare @MESS NVARCHAR(MAX)     
	  DECLARE @xml NVARCHAR(MAX)              
	   DECLARE @Data NVARCHAR(MAX) ,  @totctrOT as int=0          
	           
		set @Data=''                
		                        
		set @MESS=''          
		set @Count=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per,Intrady,Delivery  into #aa from #BSE          
		 SELECT @totctrOT=count(1) from #aa           
	   SET @MESS=                            
	   '<table border="1" cellpadding="2" cellspacing="2">                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min  </th>                            
		   <th  align="center"> Per(%)   </th> 
		   <th  align="center"> Intraday Table No. </th>
		   <th  align="center"> Delivery Table No. </th> 		                                                        
	   </tr>'          
	--print @MESS          
	   WHILE @Count <= @totctrOT                              
		 BEGIN                        
		  SELECT @Type=Type, @Min=Min,@Per=Per,@intra=Intrady,@Deltable=Delivery FROM #aa WHERE Srno=@count                                   
		  set @Data=@Data+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per) +' </td>  
		  <td align="center"> '+ CONVERT(VARCHAR,@intra) +' </td>  
		   <td align="center"> '+ CONVERT(VARCHAR,@Deltable) +' </td>  		                                                 
		   </tr>'           
		   --print @Data                         
		  SET   @Count=@Count+1                                    
		 END
		 SET @MESS='<Br><B>BSECM</B> <Br><Br>'+ @MESS + @Data +'</Table>' 
		 print @MESS             
drop table #BSE                          
drop table #aa 
update SB_ClientModiBrk set Emailed='Y'  where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='BSECM' and Emailed='N'
end
 if exists(select * from SB_ClientModiBrk where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='NSECM' and Emailed='N' )
 begin          
	select @NSEM1=NSEM1,@NseP1=NSEP1,@NSEM2=NSEM2,@NseP2=NSEP2,@NSEMDel=NSEMDEL,@NsePDel=NSEPDel,@TableNoIntr=TableNoIntr,@TableNoDel=TableNoDel from SB_ClientModiBrk where Clientcode=@clientcode
	 and Req_RefNo=@REFNO and segment='NSECM' and Emailed='N'

	create table #NSE
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50),
	Intrady varchar(50),
	Delivery varchar(50)
	) 
	insert into #NSE                   
	select '1st Leg' as Type,@NSEM1 as Min,@NseP1 as Per ,@TableNoIntr as Intrady,@TableNoDel as Delivery               

	insert into #NSE                                     
	select '2nd Leg' as Type,@NSEM2 as Min,@NseP2 as Per,'' as Intrady,'' as Delivery 

	insert into #NSE                   
	select 'Delivery' as Type,@NSEMDel as Min,@NsePDel  as Per ,'' as Intrady,'' as Delivery 
           
	  declare @CountNSE int,@CountEnd1 int,@Type1 as varchar(20)='',@Min1 as varchar(50),@Per1 as varchar(50),@intra1 as varchar(50),@Deltable1 as varchar(50)           
	  DECLARE @MessBody1 NVARCHAR(MAX) ,@MESS1 NVARCHAR(MAX)                        
	   DECLARE @Data1 NVARCHAR(MAX) ,  @totctrOTNSE as int=0  
	           
		set @Data1=''                
		--set @MessBody=''                       
		set @MESS1=''          
		set @CountNSE=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per,Intrady,Delivery  into #aa1 from #NSE          
		 SELECT @totctrOTNSE=count(1) from #aa1           
	   SET @MESS1=                            
	   '<table border="1" cellpadding="2" cellspacing="2">                            
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th> 
		   	<th  align="center"> Intraday Table No. </th>
		   <th  align="center"> Delivery Table No. </th> 		                                                        
	   </tr>'          
	--print @MESS          
	   WHILE @CountNSE <= @totctrOTNSE                              
		 BEGIN                        
		  SELECT @Type1=Type, @Min1=Min,@Per1=Per,@intra1=Intrady,@Deltable1=Delivery FROM #aa1 WHERE Srno=@CountNSE                                   
		  set @Data1=@Data1+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type1) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min1) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per1) +' </td>
		 <td align="center"> '+ CONVERT(VARCHAR,@intra1) +' </td>  
		 <td align="center"> '+ CONVERT(VARCHAR,@Deltable1) +' </td>   		                                                   
		   </tr>'           
		   --print @Data                         
		  SET   @CountNSE=@CountNSE+1                                    
		 END             
  SET @MESS1='<Br><B>NSECM</B> <Br><Br>'+ @MESS1 + @Data1 +'</Table>'   
  print @MESS1
drop table #NSE                         
drop table #aa1 
update SB_ClientModiBrk set Emailed='Y'  where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='NSECM' and Emailed='N'

end
 if exists(select * from SB_ClientModiBrk where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='NSEFO' and Emailed='N')
 begin 	              

	select @NSEFOFMin=NSEFOFMin,@NSEFOFFu=NSEFOFFu,@NSEFOSMin=NSEFOSMin,@NSEFOSFu=NSEFOSFu,@TableNoIntr=TableNoIntr,@TableNoDel=TableNoDel from SB_ClientModiBrk where Clientcode=@clientcode 
	and Req_RefNo=@REFNO and segment='NSEFO' and Emailed='N'

create table #NSEFO
(
Type  varchar(50),
Min   varchar(50),
Per   varchar(50),
Intrady varchar(50),
Delivery varchar(50)
) 
insert into #NSEFO                   
select '1st Leg' as Type,@NSEFOFMin as Min,@NSEFOFFu as Per,@TableNoIntr as Intrady,@TableNoDel as Delivery          

insert into #NSEFO                                     
select '2nd Leg' as Type,@NSEFOSMin as Min,@NSEFOSFu as Per,'' as Intrady,'' as Delivery
        
  declare @Count2 int,@CountEnd2 int,@Type2 as varchar(20)='',@Min2 as  varchar(50),@Per2 as  varchar(50),@intra2 as varchar(50),@Deltable2 as varchar(50)           
  DECLARE @MessBody2 NVARCHAR(MAX) ,@MESS2 NVARCHAR(MAX)  
  DECLARE @xml2 NVARCHAR(MAX)              
   DECLARE @Data2 NVARCHAR(MAX) ,  @totctrOT2 as int=0          
           
    set @Data2=''                
    set @MessBody2=''                          
    set @MESS2=''          
    set @Count2=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per,Intrady,Delivery into #aa2 from #NSEFO          
     SELECT @totctrOT2=count(1) from #aa2           
   SET @MESS2=                            
   '<table border="1" cellpadding="2" cellspacing="2">                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Min </th>                            
       <th align="center"> Per(%)  </th> 
		   	<th  align="center"> Intraday Table No. </th>
		   <th  align="center"> Final Day Table No. </th>                                                               
   </tr>'          
--print @MESS          
   WHILE @Count2 <= @totctrOT2                              
     BEGIN                        
      SELECT @Type2=Type, @Min2=Min,@Per2=Per,@intra2=Intrady,@Deltable2=Delivery FROM #aa2 WHERE Srno=@count2                                   
      set @Data2=@Data2+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type2) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min2) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Per2) +' </td> 
		 <td align="center"> '+ CONVERT(VARCHAR,@intra2) +' </td>  
		 <td align="center"> '+ CONVERT(VARCHAR,@Deltable2) +' </td>                                                         
                                                      
       </tr>'           
       --print @Data                         
      SET   @Count2=@Count2+1                                    
     END  
 SET @MESS2='<Br><B>NSEFO</B> <Br><Br>'+ @MESS2 + @Data2 +'</Table>'   
drop table #NSEFO                          
drop table #aa2
update SB_ClientModiBrk set Emailed='Y'  where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='NSEFO' and Emailed='N'
end
---------------
if exists (select * from SB_ClientModiBrk where Clientcode=@clientcode  and Req_RefNo=@REFNO and segment='NSEOption' and Emailed='N')
begin
select @NSEFOOS1=NSEFOOS1,@NSEFOOS2=NSEFOOS2,@NSEFOON1=NSEFOON1,@NSEFOON2=NSEFOON2,@NSEFOOB1=NSEFOOB1,@NSEFOOB2=NSEFOOB2 from SB_ClientModiBrk 
where  Clientcode=@clientcode  and Req_RefNo=@REFNO and segment='NSEOption' and Emailed='N'

create table #NSEFOOpt
(
Type  varchar(50),
Stock  varchar(50),
Nifty  varchar(50),
BankNifty  varchar(50)
) 
insert into #NSEFOOpt                   
select '1st Leg' as Type,@NSEFOOS1 as Stock ,@NSEFOON1 as Nifty, @NSEFOOB1 as BankNifty       

insert into #NSEFOOpt                                     
select '2nd Leg' as Type,@NSEFOOS2 as Stock ,@NSEFOON2 as Nifty, @NSEFOOB2 as BankNifty      
            
  declare @Count7 int,@CountEnd7 int,@Type7 as varchar(20)='',@stock as varchar(50),@nifty as varchar(50),@Banknifty as varchar(50)           
  DECLARE @MessBody7 NVARCHAR(MAX) ,@MESS7 NVARCHAR(MAX)         
  DECLARE @xml7 NVARCHAR(MAX)              
   DECLARE @Data7 NVARCHAR(MAX) ,  @totctrOT7 as int=0          
           
    set @Data7=''                
    set @MessBody7=''                          
    set @MESS7=''          
    set @Count7=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Stock,Nifty,BankNifty into #aa7 from #NSEFOOpt          
     SELECT @totctrOT7=count(1) from #aa7           
   SET @MESS7=                            
   '<table border="1" cellpadding="2" cellspacing="2">                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Stock Rs./Lot </th>                                                                                 
       <th align="center"> Nifty Rs./Lot </th>
       <th align="center"> Bank Nifty Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count7 <= @totctrOT7                              
     BEGIN                        
      SELECT @Type7=Type,@stock=Stock,@nifty=Nifty,@Banknifty=BankNifty FROM #aa7 WHERE Srno=@count7                                   
      set @Data7=@Data7+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type7) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@stock) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@nifty) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@Banknifty) +' </td>                                                                      
       </tr>'           
       print @Data7                         
      SET   @Count7=@Count7+1                                    
     END   
     SET @MESS7='<Br><B>NSEFO Option</B> <Br><Br>'+ @MESS7 + @Data7 +'</Table>'
     print  @MESS7         
drop table #NSEFOOpt                          
drop table #aa7  
update SB_ClientModiBrk set Emailed='Y'  where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='NSEOption' and Emailed='N'    
end
----------------
 if exists(select * from SB_ClientModiBrk where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='MCX' and Emailed='N')
 begin 	              

	select @MCX1M=MCX1M,@MCX1Fu=MCX1Fu,@MCX2M=MCX2M,@MCX2Fu=MCX2Fu,@TableNoIntr=TableNoIntr,@TableNoDel=TableNoDel from SB_ClientModiBrk where Clientcode=@clientcode and Req_RefNo=@REFNO
	and segment='MCX' and Emailed='N'

create table #MCX
(
Type  varchar(50),
Min  varchar(50),
Per  varchar(50),
Intrady varchar(50),
Delivery varchar(50)
) 
insert into #MCX                   
select '1st Leg' as Type,@MCX1M as Min,@MCX1Fu as Per,@TableNoIntr as Intrady,@TableNoDel as Delivery                    

insert into #MCX                                     
select '2nd Leg' as Type,@MCX2M as Min,@MCX2Fu as Per,'' as Intrady,'' as Delivery  
          
  declare @Count3 int,@CountEnd3 int,@Type3 as varchar(20)='',@Min3 as varchar(50),@Per3 as varchar(50),@intra3 as varchar(50),@Deltable3 as varchar(50)           
  DECLARE @MessBody3 NVARCHAR(MAX) ,@MESS3 NVARCHAR(MAX)         
  DECLARE @xml3 NVARCHAR(MAX)              
   DECLARE @Data3 NVARCHAR(MAX) ,  @totctrOT3 as int=0          
           
    set @Data3=''                
    set @MessBody3=''                          
    set @MESS3=''          
    set @Count3=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per,Intrady,Delivery  into #aa3 from #MCX          
     SELECT @totctrOT3=count(1) from #aa3           
   SET @MESS3=                            
   '<table border="1" cellpadding="2" cellspacing="2">                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Min </th>                            
       <th align="center"> Per(%)  </th> 
		   	<th  align="center"> Intraday Table No. </th>
		   <th  align="center"> Final Day Table No. </th>                                                            
   </tr>'          
--print @MESS          
   WHILE @Count3 <= @totctrOT3                              
     BEGIN                        
      SELECT @Type3=Type, @Min3=Min,@Per3=Per,@intra3=Intrady,@Deltable3=Delivery FROM #aa3 WHERE Srno=@count3                                   
      set @Data3=@Data3+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type3) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min3) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Per3) +' </td>  
		 <td align="center"> '+ CONVERT(VARCHAR,@intra3) +' </td>  
		 <td align="center"> '+ CONVERT(VARCHAR,@Deltable3) +' </td>                                                     
       </tr>'           
       --print @Data                         
      SET   @Count3=@Count3+1                                    
     END   
 SET @MESS3='<Br><B>MCX</B> <Br><Br>'+ @MESS3 + @Data3 +'</Table>' 
drop table #MCX                      
drop table #aa3  
update SB_ClientModiBrk set Emailed='Y'  where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='MCX' and Emailed='N'  
end
 if exists(select * from SB_ClientModiBrk where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='NCDEX' and Emailed='N')
 begin 
select @NCDX1Min=NCDX1Min,@NCDX1Fu=NCDX1Fu,@NCDX2Min=NCDX2Min,@NCDX2Fu=NCDX2Fu,@TableNoIntr=TableNoIntr,@TableNoDel=TableNoDel from SB_ClientModiBrk where Clientcode=@clientcode
 and Req_RefNo=@REFNO and segment='NCDEX' and Emailed='N'

create table #NCDX
(
Type  varchar(50),
Min  varchar(50),
Per  varchar(50),
Intrady varchar(50),
Delivery varchar(50)
) 
insert into #NCDX                   
select '1st Leg' as Type,@NCDX1Min as Min,@NCDX1Fu as Per,@TableNoIntr as Intrady,@TableNoDel as Delivery            

insert into #NCDX                                     
select '2nd Leg' as Type,@NCDX2Min as Min,@NCDX2Fu as Per,'' as Intrady,'' as Delivery
        
            
  declare @Count4 int,@CountEnd4 int,@Type4 as varchar(20)='',@Min4 as varchar(50),@Per4 as varchar(50),@intra4 as varchar(50),@Deltable4 as varchar(50)           
  DECLARE @MessBody4 NVARCHAR(MAX) ,@MESS4 NVARCHAR(MAX)
  DECLARE @xml4 NVARCHAR(MAX)              
   DECLARE @Data4 NVARCHAR(MAX) ,  @totctrOT4 as int=0          
           
    set @Data4=''                
    set @MessBody4=''                          
    set @MESS4=''          
    set @Count4=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per,Intrady,Delivery into #aa4 from #NCDX          
     SELECT @totctrOT4=count(1) from #aa4           
   SET @MESS4=                            
   '<table border="1" cellpadding="2" cellspacing="2">                            
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>   
		<th  align="center"> Intraday Table No. </th>
		<th  align="center"> Final Day Table No. </th>                                                             
   </tr>'          
--print @MESS          
   WHILE @Count4 <= @totctrOT4                              
     BEGIN                        
      SELECT @Type4=Type, @Min4=Min,@Per4=Per,@intra4=Intrady,@Deltable4=Delivery  FROM #aa4 WHERE Srno=@count4                                   
      set @Data4=@Data4+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type4) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min4) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per4) +' </td>
     	 <td align="center"> '+ CONVERT(VARCHAR,@intra4) +' </td>  
	 <td align="center"> '+ CONVERT(VARCHAR,@Deltable4) +' </td>                                                     
       </tr>'           
       --print @Data                         
      SET   @Count4=@Count4+1                                    
     END 
      SET @MESS4='<Br><B>NCDX</B> <Br><Br>'+ @MESS4 + @Data4 +'</Table>' 

drop table #NCDX                          
drop table #aa4  
update SB_ClientModiBrk set Emailed='Y'  where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='NCDEX' and Emailed='N'               
end
 if exists(select * from SB_ClientModiBrk where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='NSX' and Emailed='N')
 begin  
	          
select @NSX1=NSX1,@NSX2=NSX2,@TableNoIntr=TableNoIntr,@TableNoDel=TableNoDel from SB_ClientModiBrk where Clientcode=@clientcode and Req_RefNo=@REFNO  and segment='NSX' and Emailed='N'

create table #NSXCurr
(
Type  varchar(50),
Future  varchar(50),
Intrady varchar(50),
Delivery varchar(50)
) 
insert into #NSXCurr                   
select '1st Leg' as Type,@NSX1 as Future,@TableNoIntr as Intrady,@TableNoDel as Delivery        

insert into #NSXCurr                                     
select '2nd Leg' as Type,@NSX2 as Future,'' as Intrady,'' as Delivery     
             
  declare @Count5 int,@CountEnd5 int,@Type5 as varchar(20)='',@Min5 as varchar(50),@Per5 as varchar(50),@intra5 as varchar(50),@Deltable5 as varchar(50)           
  DECLARE @MessBody5 NVARCHAR(MAX) ,@MESS5 NVARCHAR(MAX)      
  DECLARE @xml5 NVARCHAR(MAX)              
   DECLARE @Data5 NVARCHAR(MAX) ,  @totctrOT5 as int=0          
           
    set @Data5=''                
    set @MessBody5=''                          
    set @MESS5=''          
    set @Count5=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Future,Intrady,Delivery into #aa5 from #NSXCurr          
     SELECT @totctrOT5=count(1) from #aa5           
   SET @MESS5=                            
   '<table border="1" cellpadding="2" cellspacing="2">                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Future (%) </th> 
       	<th  align="center"> Intraday Table No. </th>
		<th  align="center"> Final Day Table No. </th>                                                                                         
   </tr>'          
--print @MESS          
   WHILE @Count5 <= @totctrOT5                              
     BEGIN                        
      SELECT @Type5=Type, @Min5=Future,@intra5=Intrady,@Deltable5=Delivery FROM #aa5 WHERE Srno=@count5                                   
      set @Data5=@Data5+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type5) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min5) +' </td> 
	 <td align="center"> '+ CONVERT(VARCHAR,@intra5) +' </td>  
	 <td align="center"> '+ CONVERT(VARCHAR,@Deltable5) +' </td>                                                                             
       </tr>'           
       --print @Data                         
      SET   @Count5=@Count5+1                                    
     END
SET @MESS5='<Br><B>NSX</B> <Br><Br>'+ @MESS5 + @Data5 +'</Table>'      
drop table #NSXCurr                          
drop table #aa5 
update SB_ClientModiBrk set Emailed='Y'  where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='NSX' and Emailed='N'        
end
 if exists(select * from SB_ClientModiBrk where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='MCD' and Emailed='N')
 begin  
	select @MCD1=MCD1,@MCD2=MCD2 from SB_ClientModiBrk where Clientcode=@clientcode and Req_RefNo=@REFNO and segment='MCD' and Emailed='N'

create table #MCD
(
Type  varchar(50),
Future  varchar(100)
) 
insert into #MCD                   
select '1st Leg' as Type,@MCD1 as Future         

insert into #MCD                                     
select '2nd Leg' as Type,@MCD2 as Future
            
  declare @Count6 int,@CountEnd6 int,@Type6 as varchar(20)='',@Min6 as  varchar(50),@Per6 as  varchar(50)           
  DECLARE @MessBody6 NVARCHAR(MAX) ,@MESS6 NVARCHAR(MAX)         
  DECLARE @xml6 NVARCHAR(MAX)              
   DECLARE @Data6 NVARCHAR(MAX) ,  @totctrOT6 as int=0          
           
    set @Data6=''                
    set @MessBody6=''                          
    set @MESS6=''          
    set @Count6=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Future into #aa6 from #MCD          
     SELECT @totctrOT=count(1) from #aa6           
   SET @MESS6=                            
   '<table border="1" cellpadding="2" cellspacing="2">                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Future (%) </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count6 <= @totctrOT6                              
     BEGIN              
      SELECT @Type6=Type, @Min6=Future FROM #aa6 WHERE Srno=@count6                                  
      set @Data6=@Data6+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type6) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min6) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count6=@Count6+1                                    
     END 
     SET @MESS6='<Br><B>MCD</B> <Br><Br>'+ @MESS6 + @Data6 +'</Table>'          
drop table #MCD                          
drop table #aa6       
update SB_ClientModiBrk set Emailed='Y'  where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='MCD' and Emailed='N'  
end

 if exists(select * from SB_ClientModiBrk where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='BSEFO' and Emailed='N')
 begin 	              

	select @BSEFOFMin=BSEFOFMin,@BSEFOFFu=BSEFOFFu,@BSEFOSMin=BSEFOSMin,@BSEFOSFu=BSEFOSFu,@TableNoIntr=TableNoIntr,@TableNoDel=TableNoDel from SB_ClientModiBrk where Clientcode=@clientcode 
	and Req_RefNo=@REFNO and segment='BSEFO' and Emailed='N'

create table #BSEFO
(
Type  varchar(50),
Min   varchar(50),
Per   varchar(50),
Intrady varchar(50),
Delivery varchar(50)
) 
insert into #BSEFO                   
select '1st Leg' as Type,@BSEFOFMin as Min,@BSEFOFFu as Per,@TableNoIntr as Intrady,@TableNoDel as Delivery          

insert into #BSEFO                                     
select '2nd Leg' as Type,@BSEFOSMin as Min,@BSEFOSFu as Per,'' as Intrady,'' as Delivery
        
  declare @Count12 int,@CountEnd12 int,@Type12 as varchar(20)='',@Min12 as  varchar(50),@Per12 as  varchar(50),@intra12 as varchar(50),
  @Deltable12 as varchar(50)           
  DECLARE @MessBody12 NVARCHAR(MAX) ,@MESS12 NVARCHAR(MAX)  
  DECLARE @xml12 NVARCHAR(MAX)              
   DECLARE @Data12 NVARCHAR(MAX) ,  @totctrOT12 as int=0          
           
    set @Data12=''                
    set @MessBody12=''                          
    set @MESS12=''          
    set @Count12=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per,Intrady,Delivery into #aa12 from #BSEFO          
     SELECT @totctrOT12=count(1) from #aa12           
   SET @MESS12=                            
   '<table border="1" cellpadding="2" cellspacing="2">                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Min </th>                            
       <th align="center"> Per(%)  </th> 
		   	<th  align="center"> Intraday Table No. </th>
		   <th  align="center"> Final Day Table No. </th>                                                               
   </tr>'          
--print @MESS          
   WHILE @Count12 <= @totctrOT12                              
     BEGIN                        
      SELECT @Type12=Type, @Min12=Min,@Per12=Per,@intra12=Intrady,@Deltable12=Delivery FROM #aa12 WHERE Srno=@count12                                   
      set @Data12=@Data12+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type12) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min12) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Per12) +' </td> 
		 <td align="center"> '+ CONVERT(VARCHAR,@intra12) +' </td>  
		 <td align="center"> '+ CONVERT(VARCHAR,@Deltable12) +' </td>                                                         
                                                      
       </tr>'           
       --print @Data                         
      SET   @Count12=@Count12+1                                    
     END  
 SET @MESS12='<Br><B>BSEFO</B> <Br><Br>'+ @MESS12 + @Data12 +'</Table>'   
drop table #BSEFO                          
drop table #aa12
update SB_ClientModiBrk set Emailed='Y'  where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='BSEFO' and Emailed='N'
end
---------------


if exists (select * from SB_ClientModiBrk where Clientcode=@clientcode  and Req_RefNo=@REFNO and segment='NSXOption' and Emailed='N')
begin
select @NSXO1=NSXO1,@NSXO2=NSXO2 from SB_ClientModiBrk where Clientcode=@clientcode  and Req_RefNo=@REFNO and segment='NSXOption' and Emailed='N'

create table #NSXO
(
Type  varchar(50),
PerLot  varchar(50)
) 
insert into #NSXO                   
select '1st Leg' as Type,@NSXO1 as PerLot         

insert into #NSXO                                     
select '2nd Leg' as Type,@NSXO2 as PerLot

  declare @Count8 int,@CountEnd8 int,@Type8 as varchar(20)='',@Min8 as varchar(50),@Per8 as varchar(50)           
  DECLARE @MessBody8 NVARCHAR(MAX) ,@MESS8 NVARCHAR(MAX)    
  DECLARE @xml8 NVARCHAR(MAX)              
   DECLARE @Data8 NVARCHAR(MAX) ,  @totctrOT8 as int=0          
           
    set @Data8=''                
    set @MessBody8=''                          
    set @MESS8=''          
    set @Count8=1                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,PerLot into #aa8 from #NSXO          
     SELECT @totctrOT8=count(1) from #aa8           
   SET @MESS8=                            
   '<table border="1" cellpadding="2" cellspacing="2">                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Per Lot Rs. </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count8 <= @totctrOT8                              
     BEGIN                        
      SELECT @Type8=Type, @Min8=PerLot FROM #aa8 WHERE Srno=@count8                                   
      set @Data8=@Data8+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type8) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min8) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count8=@Count8+1                                    
     END
      SET @MESS8='<Br><B>NSX Option</B> <Br><Br>'+ @MESS8 + @Data8 +'</Table>'                
drop table #NSXO                          
drop table #aa8 
update SB_ClientModiBrk set Emailed='Y'  where Clientcode=@ClientCode and Req_RefNo=@REFNO and segment='NSXOption' and Emailed='N'  
end
	--SET @MessBody =  'Dear Team,<br/><br/>'+' Please modify the brokerage slab for Client code-'+@clientcode+'<br/><br/>'+ @MESS + @Data + '<br/><br/>'+ @MESS1 + @Data1 +'<br/><br/>'+ @MESS2 + @Data2 +'<br/><br/>'+ @MESS3 + @Data3 +'<br/><br/>'+ @MESS4 + @Data4 +'<br/><br/>'+ @MESS5 + @Data5 +'<br/><br/>'+ @MESS6 + @Data6 +'</Table>'       
	SET @MessBody =  'Dear Team,<br/><br/>'+' Please modify the brokerage slab for Client code-'+@clientcode+' <br/><br/> '+ isnull(@MESS,'') + '<Br>'+ isnull(@MESS1,'')+'<Br>'+ isnull(@MESS2,'')+'<Br>'+isnull(@MESS7,'') +'<Br>' +isnull(@MESS3,'') +'<Br>' +isnull(@MESS4,'')+'<Br>' +isnull(@MESS5,'')+'<Br>' +isnull(@MESS6,'')+'<Br>' +isnull(@MESS8,'')+'<Br>' +isnull(@MESS12,'')+'<Br>'      
	SET @MessBody=@MessBody+'<BR><BR>Regards,<br><Br>Team In-House'                                    
	set @sub='Brokerage modification for Client Code-'+@clientcode+'' 
	                                 
                          
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                    
 @RECIPIENTS =@emailto,--'neha.naiwar@angelbroking.com' ,                                    
 @COPY_RECIPIENTS = @emailcc,                                    
 @blind_copy_recipients =@emailbcc,--'neha.naiwar@angelbroking.com' ,                
 @PROFILE_NAME = 'AngelBroking',                                    
 @BODY_FORMAT ='HTML',                                    
 @SUBJECT = @sub,                                    
 @FILE_ATTACHMENTS ='',                                    
 @BODY =@MessBody                                    

                         
END try                
          
  BEGIN catch                          
      SET @MessBody=                          
'<BR><BR> ERROR in triggering email: .<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>'                          
                          
   EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                    
 @RECIPIENTS =@emailto,--'neha.naiwar@angelbroking.com' ,                                    
 @COPY_RECIPIENTS = @emailcc,                                    
 @blind_copy_recipients =@emailbcc,--'neha.naiwar@angelbroking.com' ,                
 @PROFILE_NAME = 'AngelBroking',                                    
 @BODY_FORMAT ='HTML',                                    
 @SUBJECT = @sub,                                    
 @FILE_ATTACHMENTS ='',                                    
 @BODY =@MessBody                       
END catch                          
                          
SET nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_Brokerage_Mail_ToClient_UAT_Live_05Apr2024
-- --------------------------------------------------
--SB_Brokerage_Mail_ToClient 'A101904','A10190420161123',0.00900,0.00900,0.00900,0.00900
create procedure [dbo].[SB_Brokerage_Mail_ToClient_UAT_Live_05Apr2024]  (
@ClientCode as varchar(50),@REFNO as varchar(50)
)        
AS          
SET nocount ON            
 

BEGIN try        
DECLARE @Emp_name as varchar(100),@emp_email as varchar(100)                      
DECLARE @emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)   

declare @ClientEmail as varchar(50)='',@ClientName as varchar(100)=''

select @ClientEmail=email,@ClientName=long_name from client_details where party_code=@ClientCode
--select @emp_email=terEmailId from mis.SB_COMP.dbo.VW_SubBroker_Details where sbtag=@SBCode
                             
--declare   @ClientCode as varchar(50)='N51935',@Segment as varchar(50)='BSECM'                           
SELECT @emailto='nxt2-tech@angelbroking.com;neha.naiwar@angelbroking.com'--@ClientEmail--'hemantp.patel@angelbroking.com'         
SELECT @emailcc=''--'renil.pillai@angelbroking.com'--@emp_email  ----'neha.naiwar@angelbroking.com'              
SELECT @emailbcc=''--'neha.naiwar@angelbroking.com'           
  DECLARE @MessBody NVARCHAR(MAX) 
  set @MessBody=''  
--declare   @ClientCode as varchar(50)='J22077',@REFNO as varchar(50)='J2207720160915' 
--declare @segment as varchar(50)
--select   row_number()over (order by segment) As Srno,segment  from SB_ClientModiBrk where Clientcode=@ClientCode 	 and Req_RefNo=@REFNO
--print @segment
declare @BSEL1 as decimal(18,4)=0.00,@BSEM1 as decimal(18,4)=0.00,@BseP1 as decimal(18,4)=0.00,@BSEL2 as decimal(18,4)=0.00,@BSEM2 as decimal(18,4)=0.00,
@BseP2 as decimal(18,4)=0.00,@BSEDel as decimal(18,4)=0.00,@BSEMDel as decimal(18,4)=0.00,@BsePDel as decimal(18,4)=0.00,@NSEL1 as decimal(18,4)=0.00,@NSEM1 as decimal(18,4)=0.00,
@NSEP1 as decimal(18,4)=0.00,@NSEL2 as decimal(18,4)=0.00,@NSEM2 as decimal(18,4)=0.00,@NSEP2 as decimal(18,4)=0.00,
@NSELDel as decimal(18,4)=0.00,@NSEMDel as decimal(18,4)=0.00,@NSEPDel as decimal(18,4)=0.00,@MCXL1 as decimal(18,4)=0.00,@MCX1M as decimal(18,4)=0.00,@MCX1Fu as decimal(18,4)=0.00,
@MCXL2 as decimal(18,4)=0.00,@MCX2M as decimal(18,4)=0.00,@MCX2Fu as decimal(18,4)=0.00,@NCDX1L as decimal(18,4)=0.00,@NCDX1Min as decimal(18,4)=0.00,@NCDX1Fu as decimal(18,4)=0.00,
@NCDX2L as decimal(18,4)=0.00,@NCDX2Min as decimal(18,4)=0.00,@NCDX2Fu as decimal(18,4)=0.00,@NSEFOFL as decimal(18,4)=0.00,
@NSEFOFMin as decimal(18,4)=0.00,@NSEFOFFu as decimal(18,4)=0.00,@NSEFOSL as decimal(18,4)=0.00,@NSEFOSMin as decimal(18,4)=0.00,@NSEFOSFu as decimal(18,4)=0.00,
@NSX1 as decimal(18,4)=0.00,@NSX2 as decimal(18,4)=0.00,@NSEFOOS1 as decimal(18,4)=0.00,@NSEFOOS2 as decimal(18,4)=0.00,@NSEFOON1 as decimal(18,4)=0.00,@NSEFOON2 as decimal(18,4)=0.00,
@NSEFOOB1 as decimal(18,4)=0.00,@NSEFOOB2 as decimal(18,4)=0.00,@NSEFOOFN1 as money=0.00,@NSEFOOFN2 as money=0.00,@NSXO1 as decimal(18,4)=0.00,@NSXO2 as decimal(18,4)=0.00,@MCD1 as decimal(18,4)=0.00,@MCD2 as decimal(18,4)=0.00,
@MCDO1 as decimal(18,4)=0.00,@MCDO2 as decimal(18,4)=0.00,
@BSEFOFL as money=0.00,    
@BSEFOFMin as money=0.00,@BSEFOFFu as money=0.00,@BSEFOSL as money=0.00,@BSEFOSMin as money=0.00,@BSEFOSFu as money=0.00,  
@BSEFOFL_Old  as money=0.00,@BSEFOFMin_Old as money=0.00,@BSEFOFFu_Old as money=0.00,    
   @BSEFOSL_Old as money=0.00,@BSEFOSMin_Old as money=0.00,@BSEFOSFu_Old as money=0.00,  
   @BSXOPT_N1 as decimal(18,4)=0.00,@BSXOPT_N2 as decimal(18,4)=0.00,@SX500PT_N1 as decimal(18,4)=0.00,
@SX500PT_N2 as decimal(18,4)=0.00,@BSEFOOALL_S1 as decimal(18,4)=0.00,@BSEFOOALL_S2 as decimal(18,4)=0.00,
@BKXOPT_B1 as decimal(18,4)=0.00,@BKXOPT_B2 as decimal(18,4)=0.00,
   @BSXOPT_N1_Old as decimal(18,4)=0.00,@BSXOPT_N2_Old as decimal(18,4)=0.00,@SX500PT_N1_Old as decimal(18,4)=0.00,
@SX500PT_N2_Old as decimal(18,4)=0.00,@BSEFOOALL_S1_Old as decimal(18,4)=0.00,@BSEFOOALL_S2_Old as decimal(18,4)=0.00,
@BKXOPT_B1_Old as decimal(18,4)=0.00,@BKXOPT_B2_Old as decimal(18,4)=0.00

declare @BSEL1_Old as decimal(18,4)=0.00,@BSEM1_Old as decimal(18,4)=0.00,@BseP1_Old as decimal(18,4)=0.00,@BSEL2_Old as decimal(18,4)=0.00,@BSEM2_Old as decimal(18,4)=0.00,  
@BseP2_Old as decimal(18,4)=0.00,@BSEDel_Old as decimal(18,4)=0.00,@BSEMDel_Old as decimal(18,4)=0.00,@BsePDel_Old as decimal(18,4)=0.00,@NSEL1_Old as decimal(18,4)=0.00,@NSEM1_Old as decimal(18,4)=0.00,  
@NSEP1_Old as decimal(18,4)=0.00,@NSEL2_Old as decimal(18,4)=0.00,@NSEM2_Old as decimal(18,4)=0.00,@NSEP2_Old as decimal(18,4)=0.00,  
@NSELDel_Old as decimal(18,4)=0.00,@NSEMDel_Old as decimal(18,4)=0.00,@NSEPDel_Old as decimal(18,4)=0.00,@MCXL1_Old as decimal(18,4)=0.00,@MCX1M_Old as decimal(18,4)=0.00,@MCX1Fu_Old as decimal(18,4)=0.00,  
@MCXL2_Old as decimal(18,4)=0.00,@MCX2M_Old as decimal(18,4)=0.00,@MCX2Fu_Old as decimal(18,4)=0.00,@NCDX1L_Old as decimal(18,4)=0.00,@NCDX1Min_Old as decimal(18,4)=0.00,@NCDX1Fu_Old as decimal(18,4)=0.00,  
@NCDX2L_Old as decimal(18,4)=0.00,@NCDX2Min_Old as decimal(18,4)=0.00,@NCDX2Fu_Old as decimal(18,4)=0.00,@NSEFOFL_Old as decimal(18,4)=0.00,  
@NSEFOFMin_Old as decimal(18,4)=0.00,@NSEFOFFu_Old as decimal(18,4)=0.00,@NSEFOSL_Old as decimal(18,4)=0.00,@NSEFOSMin_Old as decimal(18,4)=0.00,@NSEFOSFu_Old as decimal(18,4)=0.00,  
@NSX1_Old as decimal(18,4)=0.00,@NSX2_Old as decimal(18,4)=0.00,@NSEFOOS1_Old as decimal(18,4)=0.00,@NSEFOOS2_Old as decimal(18,4)=0.00,@NSEFOON1_Old as decimal(18,4)=0.00,@NSEFOON2_Old as decimal(18,4)=0.00,  
@NSEFOOB1_Old as decimal(18,4)=0.00,@NSEFOOB2_Old as decimal(18,4)=0.00,@NSEFOOFN1_Old as money=0.00,@NSEFOOFN2_Old as money=0.00,@NSXO1_Old as decimal(18,4)=0.00,@NSXO2_Old as decimal(18,4)=0.00,@MCD1_Old as decimal(18,4)=0.00,@MCD2_Old as decimal(18,4)=0.00,  
@MCDO1_Old as decimal(18,4)=0.00,@MCDO2_Old as decimal(18,4)=0.00  
  
  
 if exists(select * from SB_ClientOldBrok where Clientcode=@ClientCode and RefNo=@REFNO and segment='BSECM' and Email='N')
 begin           
	select @BSEM1=BSEM1,@BSEP1=BseP1,@BSEM2=BSEM2,@BSEP2=BseP2,@BSEMDEL=BSEMDEL,@BSEPDel=BsePDel,
	@BSEM1_Old=BSEM1_Old,@BSEP1_Old=BseP1_Old,@BSEM2_Old=BSEM2_Old,@BSEP2_Old=BseP2_Old,@BSEMDEL_Old=BSEMDEL_Old,@BSEPDel_Old=BsePDel_Old
	 from SB_ClientModiBrk a join
	 SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
	 and b.RefNo=@REFNO and b.segment='BSECM' and b.Email='N'

		create table #BSE
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 
	
	insert into #BSE                   
	select '1st Leg' as Type,@BSEM1 as Min,@BSEP1 as Per          

	insert into #BSE                                     
	select '2nd Leg' as Type,@BSEM2 as Min,@BSEP2 as Per

	insert into #BSE                   
	select 'Delivery' as Type,@BSEMDEL as Min,@BSEPDel  as Per
     
    create table #BSE_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #BSE_OLD                   
	select '1st Leg' as Type,@BSEM1_Old as Min,@BSEP1_OLd as Per          

	insert into #BSE_OLD                                     
	select '2nd Leg' as Type,@BSEM2_Old as Min,@BSEP2_old as Per

	insert into #BSE_OLD                   
	select 'Delivery' as Type,@BSEMDEL_Old as Min,@BSEPDel_old  as Per   
	     
	  declare @Count int,@CountEnd int,@Type as varchar(20)='',@Min as varchar(50),@Per as varchar(50)
	  declare @MESS NVARCHAR(MAX)
	  declare @MESSBSE NVARCHAR(MAX)      
	  DECLARE @xml NVARCHAR(MAX)              
	   DECLARE @Data NVARCHAR(MAX) ,  @totctrOT as int=0          
	           
		set @Data=''                
		--set @MESS1=''                         
		set @MESS=''          
		set @Count=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa from #BSE          
		 SELECT @totctrOT=count(1) from #aa           
	   SET @MESS=                            
	   '<table border="1" cellpadding="2" cellspacing="2">
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr>                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min  </th>                            
		   <th  align="center"> Per(%)   </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @Count <= @totctrOT                              
		 BEGIN                        
		  SELECT @Type=Type, @Min=Min,@Per=Per FROM #aa WHERE Srno=@count                                   
		  set @Data=@Data+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @Count=@Count+1                                    
		 END
		 SET @MESS= @MESS + @Data +'</Table>' 
  declare @Count_OLD int,@CountEnd_OLD int,@Type_OLD as varchar(20)='',@Min_OLD as varchar(50),@Per_OLD as varchar(50)
	  declare @MESS_OLD NVARCHAR(MAX)     
	  DECLARE @xml_OLD NVARCHAR(MAX)              
	   DECLARE @Data_OLD NVARCHAR(MAX) ,  @totctrOT_OLD as int=0          
	           
		set @Data_OLD=''                
		                        
		set @MESS_OLD=''          
		set @Count_OLD=1                                    
	              
	              
		select  row_number()over (order by Type_OLD ) As Srno,Type_OLD ,Min_OLD ,Per_OLD  into #aa_Old from #BSE_OLD          
		 SELECT @totctrOT_OLD=count(1) from #aa_Old           
	   SET @MESS_OLD=                            
	   '<table border="1" cellpadding="2" cellspacing="2">
	   <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                            
	   <tr>                       
		<th align="center"> Type  </th>                            
		   <th  align="center"> Min </th>                            
		   <th  align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @Count_OLD <= @totctrOT_OLD                              
		 BEGIN                        
		  SELECT @Type_OLD=Type_OLD, @Min_OLD=Min_OLD,@Per_OLD=Per_OLD FROM #aa_OLD WHERE Srno=@count_OLD                                   
		  set @Data_OLD=@Data_OLD+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type_OLD) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min_OLD) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per_OLD) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @Count_OLD=@Count_OLD+1                                    
		 END
		 
		 SET @MESS_OLD=  @MESS_OLD + @Data_OLD +'</Table>'
		 print @MESS
		 set @MESSBSE='<Br><B>BSECM</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS_OLD + '</td><td> '+ @MESS +'</td></tr></Table>'            
drop table #BSE                          
drop table #aa
drop table #BSE_Old                          
drop table #aa_Old 
update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='BSECM' and Email='N'
end
 if exists(select * from SB_ClientOldBrok where Clientcode=@ClientCode and RefNo=@REFNO and segment='NSECM' and Email='N' )
 begin          
	select @NSEM1=NSEM1,@NseP1=NSEP1,@NSEM2=NSEM2,@NseP2=NSEP2,@NSEMDel=NSEMDEL,@NsePDel=NSEPDel,
	@NSEM1_Old=NSEM1_Old,@NseP1_Old=NSEP1_Old,@NSEM2_Old=NSEM2_Old,@NseP2_Old=NSEP2_Old,@NSEMDel_Old=NSEMDEL_Old,@NsePDel_Old=NSEPDel_Old
	 from SB_ClientModiBrk a join
	 SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
	 and b.RefNo=@REFNO and b.segment='NSECM' and Email='N'

	create table #NSE
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 
	insert into #NSE                   
	select '1st Leg' as Type,@NSEM1 as Min,@NseP1 as Per          

	insert into #NSE                                     
	select '2nd Leg' as Type,@NSEM2 as Min,@NseP2 as Per

	insert into #NSE                   
	select 'Delivery' as Type,@NSEMDel as Min,@NsePDel  as Per
	
	create table #NSE_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #NSE_OLD                   
	select '1st Leg' as Type,@NSEM1_Old as Min,@NSEP1_OLd as Per          

	insert into #NSE_OLD                                     
	select '2nd Leg' as Type,@NSEM2_Old as Min,@NSEP2_old as Per

	insert into #NSE_OLD                   
	select 'Delivery' as Type,@NSEMDEL_Old as Min,@NSEPDel_old  as Per
           
	  declare @CountNSE int,@CountEnd1 int,@Type1 as varchar(20)='',@Min1 as varchar(50),@Per1 as varchar(50)           
	  DECLARE @MessBody1 NVARCHAR(MAX) ,@MESS1 NVARCHAR(MAX) ,@Mess1_NSE  NVARCHAR(MAX)                       
	   DECLARE @Data1 NVARCHAR(MAX) ,  @totctrOTNSE as int=0          
	           
		set @Data1=''                
		--set @MessBody=''                          
		set @MESS1='' 
		set @Mess1_NSE=''         
		set @CountNSE=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa1 from #NSE          
		 SELECT @totctrOTNSE=count(1) from #aa1           
	   SET @MESS1=                            
	   '<table border="1" cellpadding="2" cellspacing="2">                            
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr> 
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountNSE <= @totctrOTNSE                              
		 BEGIN                        
		  SELECT @Type1=Type, @Min1=Min,@Per1=Per FROM #aa1 WHERE Srno=@CountNSE                                   
		  set @Data1=@Data1+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type1) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min1) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per1) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountNSE=@CountNSE+1                                    
		 END             
  SET @MESS1= @MESS1 + @Data1 +'</Table>' 
  
  declare @CountNSE_Old int,@CountEnd1_Old int,@Type1_Old as varchar(20)='',@Min1_Old as varchar(50),@Per1_Old as varchar(50)           
	  DECLARE @MessBody1_Old NVARCHAR(MAX) ,@MESS1_Old NVARCHAR(MAX)                        
	   DECLARE @Data1_Old NVARCHAR(MAX) ,  @totctrOTNSE_Old as int=0          
	           
		set @Data1_Old=''                
		--set @MessBody=''                          
		set @MESS1_Old=''          
		set @CountNSE_Old=1                                    
	              
	              
		select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa1_Old from #NSE_Old          
		 SELECT @totctrOTNSE_Old=count(1) from #aa1_Old           
	   SET @MESS1_Old=                            
	   '<table border="1" cellpadding="2" cellspacing="2"> 
	    <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountNSE_Old <= @totctrOTNSE_Old                              
		 BEGIN                        
		  SELECT @Type1_Old=Type_Old, @Min1_Old=Min_Old,@Per1_Old=Per_Old FROM #aa1_Old WHERE Srno=@CountNSE_Old                                   
		  set @Data1_Old=@Data1_Old+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type1_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min1_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per1_Old) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountNSE_Old=@CountNSE_Old+1                                    
		 END             
  SET @MESS1_Old= @MESS1_Old + @Data1_Old +'</Table>'  
   set @Mess1_NSE='<Br><B>NSECM</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS1_Old + '</td><td> '+ @MESS1 +'</td></tr></Table>'  
  print @MESS1
drop table #NSE                         
drop table #aa1 
drop table #NSE_Old                         
drop table #aa1_Old 
update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='NSECM' and Email='N'

end
 if exists(select * from SB_ClientOldBrok where Clientcode=@ClientCode and RefNo=@REFNO and segment='NSEFO' and Email='N')
 begin 	              

	select @NSEFOFMin=NSEFOFMin,@NSEFOFFu=NSEFOFFu,@NSEFOSMin=NSEFOSMin,@NSEFOSFu=NSEFOSFu ,
	 @NSEFOFMin_Old=NSEFOFMin_Old,@NSEFOFFu_Old=NSEFOFFu_Old,@NSEFOSMin_Old=NSEFOSMin_Old,@NSEFOSFu_Old=NSEFOSFu_Old
	from SB_ClientModiBrk a join
	 SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
	 and b.RefNo=@REFNO and b.segment='NSEFO' and Email='N'

---------------------------
	create table #NSEFO
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 
	insert into #NSEFO                   
	select '1st Leg' as Type,@NSEFOFMin as Min,@NSEFOFFu as Per          

	insert into #NSEFO                                     
	select '2nd Leg' as Type,@NSEFOSMin as Min,@NSEFOSFu as Per
	
	create table #NSEFO_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #NSEFO_OLD                   
	select '1st Leg' as Type,@NSEFOFMin_Old as Min,@NSEFOFFu_Old as Per          

	insert into #NSEFO_OLD                                     
	select '2nd Leg' as Type,@NSEFOSMin_Old as Min,@NSEFOSFu_Old as Per

           
	  declare @CountNSEFO int,@CountEndNSEFO1 int,@Type2 as varchar(20)='',@Min2 as varchar(50),@Per2 as varchar(50)           
	  DECLARE @MessBody2 NVARCHAR(MAX) ,@MESS2 NVARCHAR(MAX) ,@Mess2_NSEFO  NVARCHAR(MAX)                       
	   DECLARE @Data2 NVARCHAR(MAX) ,  @totctrOTNSEFO as int=0          
	           
		set @Data2=''                
		--set @MessBody=''                          
		set @MESS2='' 
		set @Mess2_NSEFO=''         
		set @CountNSEFO=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa2 from #NSEFO          
		 SELECT @totctrOTNSEFO=count(1) from #aa2           
	   SET @MESS2=                            
	   '<table border="1" cellpadding="2" cellspacing="2">                            
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr> 
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountNSEFO <= @totctrOTNSEFO                              
		 BEGIN                        
		  SELECT @Type2=Type, @Min2=Min,@Per2=Per FROM #aa2 WHERE Srno=@CountNSEFO                                   
		  set @Data2=@Data2+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type2) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min2) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per2) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountNSEFO=@CountNSEFO+1                                    
		 END             
  SET @MESS2= @MESS2 + @Data2 +'</Table>' 
  
  declare @CountNSEFO_Old int,@CountEndNSEFO1_Old int,@Type2_Old as varchar(20)='',@Min2_Old as varchar(50),@Per2_Old as varchar(50)           
	  DECLARE @MessBody2_Old NVARCHAR(MAX) ,@MESS2_Old NVARCHAR(MAX)                        
	   DECLARE @Data2_Old NVARCHAR(MAX) ,  @totctrOTNSEFO_Old as int=0          
	           
		set @Data2_Old=''                
		--set @MessBody=''                          
		set @MESS2_Old=''          
		set @CountNSEFO_Old=1                                    
	              
	              
		select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa2_Old from #NSEFO_Old          
		 SELECT @totctrOTNSEFO_Old=count(1) from #aa2_Old           
	   SET @MESS2_Old=                            
	   '<table border="1" cellpadding="2" cellspacing="2"> 
	    <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountNSEFO_Old <= @totctrOTNSEFO_Old                              
		 BEGIN                        
		  SELECT @Type2_Old=Type_Old, @Min2_Old=Min_Old,@Per2_Old=Per_Old FROM #aa2_Old WHERE Srno=@CountNSEFO_Old                                   
		  set @Data2_Old=@Data2_Old+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type2_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min2_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per2_Old) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountNSEFO_Old=@CountNSEFO_Old+1                                    
		 END             
  SET @MESS2_Old= @MESS2_Old + @Data2_Old +'</Table>'  
   set @Mess2_NSEFO='<Br><B>NSEFO</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS2_Old + '</td><td> '+ @MESS2 +'</td></tr></Table>'  
  print @MESS2
drop table #NSEFO                          
drop table #aa2
drop table #NSEFO_Old                          
drop table #aa2_Old

update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='NSEFO' and Email='N'
end
---------------
if exists (select * from SB_ClientOldBrok where Clientcode=@clientcode  and RefNo=@REFNO and segment='NSEOption' and Email='N')
begin
select @NSEFOOS1=NSEFOOS1,@NSEFOOS2=NSEFOOS2,@NSEFOON1=NSEFOON1,@NSEFOON2=NSEFOON2,@NSEFOOB1=NSEFOOB1,@NSEFOOB2=NSEFOOB2,
@NSEFOOFN1=NSEFOOFN1,@NSEFOOFN2=NSEFOOFN2,
@NSEFOOS1_Old=NSEFOOS1_Old,@NSEFOOS2_Old=NSEFOOS2_Old,@NSEFOON1_Old=NSEFOON1_Old,@NSEFOON2_Old=NSEFOON2_Old,@NSEFOOB1_Old=NSEFOOB1_Old,
@NSEFOOB2_Old=NSEFOOB2_Old,@NSEFOOFN1_Old=NSEFOOFN1_Old,@NSEFOOFN2_Old=NSEFOOFN2_Old
from SB_ClientModiBrk a join
SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
and b.RefNo=@REFNO and b.segment='NSEOption' and Email='N'

create table #NSEFOOpt
(
Type  varchar(50),
Stock  varchar(50),
Nifty  varchar(50),
BankNifty  varchar(50),
FinNifty  varchar(50),
) 
insert into #NSEFOOpt                   
select '1st Leg' as Type,@NSEFOOS1 as Stock ,@NSEFOON1 as Nifty, @NSEFOOB1 as BankNifty,@NSEFOOFN1 as FinNifty       

insert into #NSEFOOpt                                     
select '2nd Leg' as Type,@NSEFOOS2 as Stock ,@NSEFOON2 as Nifty, @NSEFOOB2 as BankNifty,@NSEFOOFN2 as FinNifty  

create table #NSEFOOpt_Old
(
Type_Old  varchar(50),
Stock_Old  varchar(50),
Nifty_Old  varchar(50),
BankNifty_Old  varchar(50),
FinNifty_Old  varchar(50)
) 
insert into #NSEFOOpt_Old                   
select '1st Leg' as Type_Old,@NSEFOOS1_Old as Stock_Old ,@NSEFOON1_Old as Nifty_Old, @NSEFOOB1_Old as BankNifty_Old,
@NSEFOOFN1_Old as FinNifty_Old

insert into #NSEFOOpt_Old                                     
select '2nd Leg' as Type_Old,@NSEFOOS2_Old as Stock_Old ,@NSEFOON2_Old as Nifty_Old, @NSEFOOB2_Old as BankNifty_Old,
@NSEFOOFN2_Old as FinNifty_Old
            
  declare @Count7 int,@CountEnd7 int,@Type7 as varchar(20)='',@stock as varchar(50),@nifty as varchar(50),@Banknifty as varchar(50)
  ,@Finnifty as varchar(50)
  DECLARE @MessBody7 NVARCHAR(MAX) ,@MESS7 NVARCHAR(MAX) ,@Mess7_NSEFOOpt NVARCHAR(MAX)        
  DECLARE @xml7 NVARCHAR(MAX)              
   DECLARE @Data7 NVARCHAR(MAX) ,  @totctrOT7 as int=0          
           
    set @Data7=''                
    set @MessBody7=''                          
    set @MESS7=''          
    set @Count7=1  
    set @Mess7_NSEFOOpt=''                                  
              
              
    select  row_number()over (order by Type) As Srno,Type,Stock,Nifty,BankNifty,FinNifty into #aa7 from #NSEFOOpt          
     SELECT @totctrOT7=count(1) from #aa7           
   SET @MESS7=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
      <tr><th  align="center" colspan="4">New Brokerage </th>
	   </tr>                           
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Stock Rs./Lot </th>                                                                                 
       <th align="center"> Nifty Rs./Lot </th>
       <th align="center"> Bank Nifty Rs./Lot </th>
       <th align="center"> Fin Nifty Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count7 <= @totctrOT7                              
     BEGIN                        
      SELECT @Type7=Type,@stock=Stock,@nifty=Nifty,@Banknifty=BankNifty,@Finnifty=FinNifty FROM #aa7 WHERE Srno=@count7                                   
      set @Data7=@Data7+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type7) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@stock) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@nifty) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@Banknifty) +' </td>                                                                      
         <td align="center"> '+ CONVERT(VARCHAR,@Finnifty) +' </td>                                                                      
       </tr>'           
       print @Data7                         
      SET   @Count7=@Count7+1                                    
     END   
     SET @MESS7= @MESS7 + @Data7 +'</Table>'
     print  @MESS7 
     
declare @Count7_Old int,@CountEnd7_Old int,@Type7_Old as varchar(20)='',@stock_Old as varchar(50),@nifty_Old as varchar(50),@Banknifty_Old as varchar(50) ,@finnifty_Old as varchar(50)          
  DECLARE @MessBody7_Old NVARCHAR(MAX) ,@MESS7_Old NVARCHAR(MAX)         
  DECLARE @xml7_Old NVARCHAR(MAX)              
   DECLARE @Data7_Old NVARCHAR(MAX) ,  @totctrOT7_Old as int=0          
           
    set @Data7_Old=''                
    set @MessBody7_Old=''                          
    set @MESS7_Old=''          
    set @Count7_Old=1                                    
              
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Stock_Old,Nifty_Old,BankNifty_Old,FinNifty_Old into #aa7_Old from #NSEFOOpt_Old          
     SELECT @totctrOT7_Old=count(1) from #aa7_Old           
   SET @MESS7_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
      <tr><th  align="center" colspan="4">Old Brokerage </th>
	   </tr>                           
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Stock Rs./Lot </th>                                                                                 
       <th align="center"> Nifty Rs./Lot </th>
       <th align="center"> Bank Nifty Rs./Lot </th>
       <th align="center"> Fin Nifty Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count7_Old <= @totctrOT7_Old                              
     BEGIN                        
      SELECT @Type7_Old=Type_Old,@stock_Old=Stock_Old,@nifty_Old=Nifty_Old,@Banknifty_Old=BankNifty_Old,@finnifty_Old=FinNifty_Old FROM #aa7_Old WHERE Srno=@count7_Old                                   
      set @Data7_Old=@Data7_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type7_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@stock_Old) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@nifty_Old) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@Banknifty_Old) +' </td>                                                                      
         <td align="center"> '+ CONVERT(VARCHAR,@finnifty_Old) +' </td>                                                                      
       </tr>'           
       print @Data7_Old                         
      SET   @Count7_Old=@Count7_Old+1                                    
     END   
     SET @MESS7_Old=@MESS7_Old + @Data7_Old +'</Table>' 
     set @Mess7_NSEFOOpt='<Br><B>NSEFO Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS7_OLD + '</td><td> '+ @MESS7 +'</td></tr></Table>'          
drop table #NSEFOOpt                          
drop table #aa7
drop table #NSEFOOpt_Old                          
drop table #aa7_Old   
update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='NSEOption' and Email='N'    
end
----------------

if exists (select * from SB_ClientOldBrok where Clientcode=@clientcode  and RefNo=@REFNO and segment='BSEOption' and Email='N')
begin
select @BSEFOOALL_S1=BSEFOOALL_S1,@BSEFOOALL_S2=BSEFOOALL_S2,@BSXOPT_N1=BSXOPT_N1,@BSXOPT_N2=BSXOPT_N2,@BKXOPT_B1=BKXOPT_B1,
@BKXOPT_B2=BKXOPT_B2,
@SX500PT_N1=SX500PT_N1,@SX500PT_N2=SX500PT_N2,
@BSEFOOALL_S1_Old=BSEFOOALL_S1_Old,@BSEFOOALL_S2_Old=BSEFOOALL_S2_Old,@BSXOPT_N1_Old=BSXOPT_N1_Old,@BSXOPT_N2_Old=BSXOPT_N2_Old,
@BKXOPT_B1_Old=BKXOPT_B1_Old,
@BKXOPT_B2_Old=BKXOPT_B2_Old,@SX500PT_N1_Old=SX500PT_N1_Old,@SX500PT_N2_Old=SX500PT_N2_Old
from SB_ClientModiBrk a join
SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
and b.RefNo=@REFNO and b.segment='BSEOption' and Email='N'


create table #BSEFOOpt
(
Type  varchar(50),
Stock  varchar(50),
BSXOPT  varchar(50),
SX500PT  varchar(50),
BKXOPT  varchar(50)
) 
insert into #BSEFOOpt                   
select '1st Leg' as Type,@BSEFOOALL_S1 as Stock ,@BSXOPT_N1 as BSXOPT, @SX500PT_N1 as SX500PT,@BKXOPT_B1 as BKXOPT       
insert into #BSEFOOpt                                     
select '2nd Leg' as Type,@BSEFOOALL_S2 as Stock ,@BSXOPT_N2 as BSXOPT, @SX500PT_N2 as SX500PT,@BKXOPT_B2 as BKXOPT   
create table #BSEFOOpt_Old
(
Type_Old  varchar(50),
Stock_Old  varchar(50),
BSXOPT_Old  varchar(50),
SX500PT_Old  varchar(50),
BKXOPT_Old  varchar(50)
) 
insert into #BSEFOOpt_Old                   
select '1st Leg' as Type_Old,@BSEFOOALL_S1_Old as Stock_Old ,@BSXOPT_N1_Old as BSXOPT_Old,@SX500PT_N1_Old as SX500PT_Old,
@BKXOPT_B1_Old as BKXOPT_Old

insert into #BSEFOOpt_Old                                     
select '2nd Leg' as Type_Old,@BSEFOOALL_S2_Old as Stock_Old ,@BSXOPT_N2_Old as BSXOPT_Old,@SX500PT_N2_Old as SX500PT_Old,
@BKXOPT_B2_Old as BKXOPT_Old
            
  declare @Count77 int,@CountEnd77 int,@Type77 as varchar(20)='',@stock77 as varchar(50),@niftyBSEFO1 as varchar(50),
  @BankniftyBSEFO as varchar(50),@niftyBSEFO2 as varchar(50) 
  DECLARE @MessBody77 NVARCHAR(MAX) ,@MESS77 NVARCHAR(MAX) ,@Mess77_BSEFOOpt NVARCHAR(MAX)        
  DECLARE @xml77 NVARCHAR(MAX)              
   DECLARE @Data77 NVARCHAR(MAX) ,  @totctrOT77 as int=0          
           
    set @Data77=''                
    set @MessBody77=''                          
    set @MESS77=''          
    set @Count77=1  
    set @Mess77_BSEFOOpt=''                                  
              
              
    select  row_number()over (order by Type) As Srno,Type,Stock,BSXOPT,SX500PT, BKXOPT into #aa77 from #BSEFOOpt          
     SELECT @totctrOT77=count(1) from #aa77           
   SET @MESS77=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
      <tr><th  align="center" colspan="5">New Brokerage </th>
	   </tr>                           
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Stock Rs./Lot </th>                                                                                 
       <th align="center"> BSXOPT Rs./Lot </th>
       <th align="center"> SX500PT Rs./Lot </th>
       <th align="center"> BKXOPT Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count77 <= @totctrOT77                              
     BEGIN                        
      SELECT @Type77=Type,@stock77=Stock,@niftyBSEFO1=BSXOPT,@niftyBSEFO2=SX500PT,@BankniftyBSEFO=BKXOPT FROM #aa77 WHERE 
	  Srno=@count77                                   
      set @Data77=@Data77+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type77) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@stock77) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@niftyBSEFO1) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@niftyBSEFO2) +' </td>                                                                      
         <td align="center"> '+ CONVERT(VARCHAR,@BankniftyBSEFO) +' </td>                                                                      
       </tr>'           
       print @Data77                         
      SET   @Count77=@Count77+1                                    
     END   
     SET @MESS77= @MESS77 + @Data77 +'</Table>'
     print  @MESS77 
     
declare @Count77_Old int,@CountEnd77_Old int,@Type77_Old as varchar(20)='',@stock77_Old as varchar(50),
@niftyBSEFO1_Old as varchar(50),@BankniftyBSEFO_Old as varchar(50) ,@niftyBSEFO2_Old as varchar(50)          
  DECLARE @MessBody77_Old NVARCHAR(MAX) ,@MESS77_Old NVARCHAR(MAX)         
  DECLARE @xml77_Old NVARCHAR(MAX)              
   DECLARE @Data77_Old NVARCHAR(MAX) ,  @totctrOT77_Old as int=0          
           
    set @Data77_Old=''                
    set @MessBody77_Old=''                          
    set @MESS77_Old=''          
    set @Count77_Old=1                                    
              
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Stock_Old,BSXOPT_Old,SX500PT_Old,BKXOPT_Old into
	#aa77_Old from #BSEFOOpt_Old          
     SELECT @totctrOT77_Old=count(1) from #aa77_Old           
   SET @MESS77_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
      <tr><th  align="center" colspan="5">Old Brokerage </th>
	   </tr>                           
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Stock Rs./Lot </th>                                                                                 
       <th align="center"> BSXOPT Rs./Lot </th>
       <th align="center"> SX500PT Rs./Lot </th>
       <th align="center"> BKXOPT Rs./Lot </th>
   </tr>'          
--print @MESS          
   WHILE @Count77_Old <= @totctrOT77_Old                              
     BEGIN                        
      SELECT @Type77_Old=Type_Old,@stock77_Old=Stock_Old,@niftyBSEFO1_Old=BSXOPT_Old,@niftyBSEFO2_Old=SX500PT_Old,
	  @BankniftyBSEFO_Old=BKXOPT_Old FROM #aa77_Old WHERE Srno=@count77_Old                                   
      set @Data77_Old=@Data77_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type77_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@stock77_Old) +' </td>   
       <td align="center"> '+ CONVERT(VARCHAR,@niftyBSEFO1_Old) +' </td>   
         <td align="center"> '+ CONVERT(VARCHAR,@niftyBSEFO2_Old) +' </td>                                                                      
         <td align="center"> '+ CONVERT(VARCHAR,@BankniftyBSEFO_Old) +' </td>                                                                      
       </tr>'           
       print @Data77_Old                         
      SET   @Count77_Old=@Count77_Old+1                                    
     END   
     SET @MESS77_Old=@MESS77_Old + @Data77_Old +'</Table>' 
     set @Mess77_BSEFOOpt='<Br><B>BSEFO Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS77_OLD + '</td><td> '+ @MESS77 +'</td></tr></Table>'          

print @Mess77_BSEFOOpt
drop table #BSEFOOpt                          
drop table #aa77
drop table #BSEFOOpt_Old                          
drop table #aa77_Old   
update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='BSEOption' and Email='N'    
end
----------------
 if exists(select * from SB_ClientOldBrok where Clientcode=@ClientCode and RefNo=@REFNO and segment='MCX' and Email='N')
 begin 	              

	select @MCX1M=MCX1M,@MCX1Fu=MCX1Fu,@MCX2M=MCX2M,@MCX2Fu=MCX2Fu,
	@MCX1M_Old=MCX1M_Old,@MCX1Fu_Old=MCX1Fu_Old,@MCX2M_Old=MCX2M_Old,@MCX2Fu_Old=MCX2Fu_Old
	from SB_ClientModiBrk a join
	SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
	and b.RefNo=@REFNO 
	and b.segment='MCX' and Email='N'

create table #MCX
(
Type  varchar(50),
Min  varchar(50),
Per  varchar(50)
) 
insert into #MCX                   
select '1st Leg' as Type,@MCX1M as Min,@MCX1Fu as Per          

insert into #MCX                                     
select '2nd Leg' as Type,@MCX2M as Min,@MCX2Fu as Per

create table #MCX_Old
(
Type_Old  varchar(50),
Min_Old  varchar(50),
Per_Old  varchar(50)
) 
insert into #MCX_Old                   
select '1st Leg' as Type_Old,@MCX1M_Old as Min_Old,@MCX1Fu_Old as Per_Old          

insert into #MCX_Old                                     
select '2nd Leg' as Type_Old,@MCX2M_Old as Min_Old,@MCX2Fu_Old as Per_Old
            
  declare @Count14 int,@CountEnd14 int,@Type14 as varchar(20)='',@Min14 as varchar(50),@Per14 as varchar(50)           
  DECLARE @MessBody14 NVARCHAR(MAX) ,@MESS14 NVARCHAR(MAX),@MESS14_MCX NVARCHAR(MAX)
  DECLARE @xml14 NVARCHAR(MAX)              
   DECLARE @Data14 NVARCHAR(MAX) ,  @totctrOT14 as int=0          
           
    set @Data14=''                
    set @MessBody14=''                          
    set @MESS14=''          
    set @Count14=1
    set @MESS14_MCX=''                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa14 from #MCX          
     SELECT @totctrOT14=count(1) from #aa14           
   SET @MESS14=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
      <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count14 <= @totctrOT14                              
     BEGIN                        
      SELECT @Type14=Type, @Min14=Min,@Per14=Per FROM #aa14 WHERE Srno=@count14                                   
      set @Data14=@Data14+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type14) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min14) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per14) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count14=@Count14+1                                    
     END 
      SET @MESS14=@MESS14 + @Data14 +'</Table>' 
            
  declare @Count14_Old int,@CountEnd14_Old int,@Type14_Old as varchar(20)='',@Min14_Old as varchar(50),@Per14_Old as varchar(50)           
  DECLARE @MessBody14_Old NVARCHAR(MAX) ,@MESS14_Old NVARCHAR(MAX)
  DECLARE @xml14_Old NVARCHAR(MAX)              
   DECLARE @Data14_Old NVARCHAR(MAX) ,  @totctrOT14_Old as int=0          
           
    set @Data14_Old=''                
    set @MessBody14_Old=''                          
    set @MESS14_Old=''          
    set @Count14_Old=1
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa14_Old from #MCX_Old          
     SELECT @totctrOT14_Old=count(1) from #aa14_Old           
   SET @MESS14_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">
      <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count14_Old <= @totctrOT14_Old                              
     BEGIN                        
      SELECT @Type14_Old=Type_Old, @Min14_Old=Min_Old,@Per14_Old=Per_Old FROM #aa14_Old WHERE Srno=@count14_Old                                   
      set @Data14_Old=@Data14_Old+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type14_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min14_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per14_Old) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count14_Old=@Count14_Old+1                                    
     END 
      SET @MESS14_Old=@MESS14_Old + @Data14_Old +'</Table>' 
      set @MESS14_MCX='<Br><B>MCX</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS14_Old + '</td><td> '+ @MESS14 +'</td></tr></Table>'
--create table #MCX
--(
--Type  varchar(50),
--Min  varchar(50),
--Per  varchar(50)
--) 
--insert into #MCX                   
--select '1st Leg' as Type,@MCX1M as Min,@MCX1Fu as Per          

--insert into #MCX                                     
--select '2nd Leg' as Type,@MCX2M as Min,@MCX2Fu as Per

--create table #MCX_Old
--(
--Type_Old  varchar(50),
--Min_Old  varchar(50),
--Per_Old  varchar(50)
--) 
--insert into #MCX_Old                   
--select '1st Leg' as Type_Old,@MCX1M_Old as Min_Old,@MCX1Fu_Old as Per_Old          

--insert into #MCX_Old                                     
--select '2nd Leg' as Type_Old,@MCX2M_Old as Min_Old,@MCX2Fu_Old as Per_Old
          
--  declare @Count3 int,@CountEnd3 int,@Type3 as varchar(20)='',@Min3 as varchar(50),@Per3 as varchar(50)           
--  DECLARE @MessBody3 NVARCHAR(MAX) ,@MESS3 NVARCHAR(MAX),@MESS3_MCX NVARCHAR(MAX)         
--  DECLARE @xml3 NVARCHAR(MAX)              
--   DECLARE @Data3 NVARCHAR(MAX) ,  @totctrOT3 as int=0          
           
--    set @Data3=''                
--    set @MessBody3=''                          
--    set @MESS3=''          
--    set @Count3=1  
--    set @MESS3_MCX=''                                  
              
              
--    select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa3 from #MCX          
--     SELECT @totctrOT3=count(1) from #aa3           
--   SET @MESS3=                            
--   '<table border="1" cellpadding="2" cellspacing="2">   
--      <tr><th  align="center" colspan="3">New Brokerage </th>
--	   </tr>                          
--   <tr>                       
--    <th align="center"> Type </th>                            
--       <th align="center"> Min </th>                            
--       <th align="center"> Per(%)  </th>                                                      
--   </tr>'          
----print @MESS          
--   WHILE @Count3 <= @totctrOT3                              
--     BEGIN                        
--      SELECT @Type3=Type, @Min3=Min,@Per3=Per FROM #aa3 WHERE Srno=@count3                                   
--      set @Data3=@Data3+                           
--     '<tr>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@Type3) +' </td>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@Min3) +' </td>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@Per3) +' </td>                                                  
--       </tr>'           
--       --print @Data                         
--      SET   @Count3=@Count3+1                                    
--     END   
-- SET @MESS3=@MESS3 + @Data3 +'</Table>' 
 
-- declare @Count3_old int,@CountEnd3_old int,@Type3_old as varchar(20)='',@Min3_Old as varchar(50),@Per3_Old as varchar(50)           
--  DECLARE @MessBody3_Old NVARCHAR(MAX) ,@MESS3_Old NVARCHAR(MAX)         
--  DECLARE @xml3_Old NVARCHAR(MAX)              
--   DECLARE @Data3_Old NVARCHAR(MAX) ,  @totctrOT3_Old as int=0          
           
--    set @Data3_Old=''                
--    set @MessBody3_Old=''                          
--    set @MESS3_Old=''          
--    set @Count3_Old=1                                    
              
              
--    select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa3_Old from #MCX_Old          
--     SELECT @totctrOT3_Old=count(1) from #aa3_Old           
--   SET @MESS3_Old=                            
--   '<table border="1" cellpadding="2" cellspacing="2">  
--      <tr><th  align="center" colspan="3">Old Brokerage </th>
--	   </tr>                           
--   <tr>                       
--    <th align="center"> Type </th>                            
--       <th align="center"> Min </th>                            
--       <th align="center"> Per(%)  </th>                                                      
--   </tr>'          
----print @MESS          
--   WHILE @Count3_Old <= @totctrOT3_Old                              
--     BEGIN                        
--      SELECT @Type3_Old=Type_Old, @Min3_Old=Min_Old,@Per3_Old=Per_Old FROM #aa3_Old WHERE Srno=@count3_Old                                   
--      set @Data3_Old=@Data3_Old+                           
--     '<tr>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@Type3_Old) +' </td>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@Min3_Old) +' </td>                          
--     <td align="center"> '+ CONVERT(VARCHAR,@Per3_Old) +' </td>                                                  
--       </tr>'           
--       --print @Data                         
--      SET   @Count3=@Count3+1                                    
--     END   
-- SET @MESS3_Old=@MESS3_Old + @Data3_Old +'</Table>'
-- set @MESS3_MCX='<Br><B>MCX</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS3_OLD + '</td><td> '+ @MESS3 +'</td></tr></Table>'  
drop table #MCX                      
drop table #aa14
drop table #MCX_Old                      
drop table #aa14_Old  
update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='MCX' and Email='N'  
end
 if exists(select * from SB_ClientOldBrok where Clientcode=@ClientCode and RefNo=@REFNO and segment='NCDEX' and Email='N')
 begin     
select @NCDX1Min=NCDX1Min,@NCDX1Fu=NCDX1Fu,@NCDX2Min=NCDX2Min,@NCDX2Fu=NCDX2Fu,
@NCDX1Min_Old=NCDX1Min_Old,@NCDX1Fu_Old=NCDX1Fu_Old,@NCDX2Min_Old=NCDX2Min_Old,@NCDX2Fu_Old=NCDX2Fu_Old
 from SB_ClientModiBrk a join
	SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
	and b.RefNo=@REFNO  and b.segment='NCDEX' and Email='N'

create table #NCDX
(
Type  varchar(50),
Min  varchar(50),
Per  varchar(50)
) 
insert into #NCDX                   
select '1st Leg' as Type,@NCDX1Min as Min,@NCDX1Fu as Per          

insert into #NCDX                                     
select '2nd Leg' as Type,@NCDX2Min as Min,@NCDX2Fu as Per

create table #NCDX_Old
(
Type_Old  varchar(50),
Min_Old  varchar(50),
Per_Old  varchar(50)
) 
insert into #NCDX_Old                   
select '1st Leg' as Type_Old,@NCDX1Min_Old as Min_Old,@NCDX1Fu_Old as Per_Old          

insert into #NCDX_Old                                     
select '2nd Leg' as Type_Old,@NCDX2Min_Old as Min_Old,@NCDX2Fu_Old as Per_Old
            
  declare @Count4 int,@CountEnd4 int,@Type4 as varchar(20)='',@Min4 as varchar(50),@Per4 as varchar(50)           
  DECLARE @MessBody4 NVARCHAR(MAX) ,@MESS4 NVARCHAR(MAX),@MESS4_NCDX NVARCHAR(MAX)
  DECLARE @xml4 NVARCHAR(MAX)              
   DECLARE @Data4 NVARCHAR(MAX) ,  @totctrOT4 as int=0          
           
    set @Data4=''                
    set @MessBody4=''                          
    set @MESS4=''          
    set @Count4=1
    set @MESS4_NCDX=''                                    
              
              
    select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa4 from #NCDX          
     SELECT @totctrOT4=count(1) from #aa4           
   SET @MESS4=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
      <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count4 <= @totctrOT4                              
     BEGIN                        
      SELECT @Type4=Type, @Min4=Min,@Per4=Per FROM #aa4 WHERE Srno=@count4                                   
      set @Data4=@Data4+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type4) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min4) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per4) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count4=@Count4+1                                    
     END 
      SET @MESS4=@MESS4 + @Data4 +'</Table>' 
            
  declare @Count4_Old int,@CountEnd4_Old int,@Type4_Old as varchar(20)='',@Min4_Old as varchar(50),@Per4_Old as varchar(50)           
  DECLARE @MessBody4_Old NVARCHAR(MAX) ,@MESS4_Old NVARCHAR(MAX)
  DECLARE @xml4_Old NVARCHAR(MAX)              
   DECLARE @Data4_Old NVARCHAR(MAX) ,  @totctrOT4_Old as int=0          
           
    set @Data4_Old=''                
    set @MessBody4_Old=''                          
    set @MESS4_Old=''          
    set @Count4_Old=1
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa4_Old from #NCDX_Old          
     SELECT @totctrOT4_Old=count(1) from #aa4_Old           
   SET @MESS4_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">
      <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th  align="center"> Type </th>                            
       <th  align="center"> Min </th>                            
       <th  align="center"> Per(%)  </th>                                                      
   </tr>'          
--print @MESS          
   WHILE @Count4_Old <= @totctrOT4_Old                              
     BEGIN                        
      SELECT @Type4_Old=Type_Old, @Min4_Old=Min_Old,@Per4_Old=Per_Old FROM #aa4_Old WHERE Srno=@count4_Old                                   
      set @Data4_Old=@Data4_Old+                           
     '<tr>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Type4_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Min4_Old) +' </td>                          
     <td  align="center"> '+ CONVERT(VARCHAR,@Per4_Old) +' </td>                                                  
       </tr>'           
       --print @Data                         
      SET   @Count4_Old=@Count4_Old+1                                    
     END 
      SET @MESS4_Old=@MESS4_Old + @Data4_Old +'</Table>' 
      set @MESS4_NCDX='<Br><B>NCDX</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS4_Old + '</td><td> '+ @MESS4 +'</td></tr></Table>'   
drop table #NCDX                          
drop table #aa4 
drop table #NCDX_Old                          
drop table #aa4_Old 
update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='NCDEX' and Email='N'               
end
 if exists(select * from SB_ClientOldBrok where Clientcode=@ClientCode and RefNo=@REFNO and segment='NSX' and Email='N')
 begin  
	          
select @NSX1=NSX1,@NSX2=NSX2,@NSX1_Old=NSX1_Old,@NSX2_Old=NSX2_Old from SB_ClientModiBrk a join
	SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
	and b.RefNo=@REFNO    and b.segment='NSX' and Email='N'

create table #NSXCurr
(
Type  varchar(50),
Future  varchar(50)
) 
insert into #NSXCurr                   
select '1st Leg' as Type,@NSX1 as Future         

insert into #NSXCurr                                     
select '2nd Leg' as Type,@NSX2 as Future

create table #NSXCurr_Old
(
Type_Old  varchar(50),
Future_Old  varchar(50)
) 
insert into #NSXCurr_Old                   
select '1st Leg' as Type_Old,@NSX1_Old as Future_Old         

insert into #NSXCurr_Old                                     
select '2nd Leg' as Type_Old,@NSX2_Old as Future_Old
             
  declare @Count5 int,@CountEnd5 int,@Type5 as varchar(20)='',@Min5 as varchar(50),@Per5 as varchar(50)           
  DECLARE @MessBody5 NVARCHAR(MAX) ,@MESS5 NVARCHAR(MAX),@MESS5_NSX NVARCHAR(MAX)      
  DECLARE @xml5 NVARCHAR(MAX)              
   DECLARE @Data5 NVARCHAR(MAX) ,  @totctrOT5 as int=0          
           
    set @Data5=''                
    set @MessBody5=''                          
    set @MESS5=''          
    set @Count5=1                                    
	set @MESS5_NSX=''              
              
    select  row_number()over (order by Type) As Srno,Type,Future into #aa5 from #NSXCurr          
     SELECT @totctrOT5=count(1) from #aa5           
   SET @MESS5=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
   <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Future (%) </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count5 <= @totctrOT5                              
     BEGIN                        
      SELECT @Type5=Type, @Min5=Future FROM #aa5 WHERE Srno=@count5                                   
      set @Data5=@Data5+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type5) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min5) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count5=@Count5+1                                    
     END
SET @MESS5=@MESS5 + @Data5 +'</Table>' 

 declare @Count5_Old int,@CountEnd5_Old int,@Type5_Old as varchar(20)='',@Min5_Old as varchar(50),@Per5_Old as varchar(50)           
  DECLARE @MessBody5_Old NVARCHAR(MAX) ,@MESS5_Old NVARCHAR(MAX)      
  DECLARE @xml5_Old NVARCHAR(MAX)              
   DECLARE @Data5_Old NVARCHAR(MAX) ,  @totctrOT5_Old as int=0          
           
    set @Data5_Old=''                
    set @MessBody5_Old=''                          
    set @MESS5_Old=''          
    set @Count5_Old=1                                    
              
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Future_Old into #aa5_Old from #NSXCurr_Old          
     SELECT @totctrOT5_Old=count(1) from #aa5_Old           
   SET @MESS5_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
   <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Future (%) </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count5_Old <= @totctrOT5_Old                              
     BEGIN                        
      SELECT @Type5_Old=Type_Old, @Min5_Old=Future_Old FROM #aa5_Old WHERE Srno=@count5_Old                                   
      set @Data5_Old=@Data5_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type5_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min5_Old) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count5_Old=@Count5_Old+1                                    
     END
SET @MESS5_Old=@MESS5_Old + @Data5_Old +'</Table>' 
 set @MESS5_NSX='<Br><B>NSX</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS5_Old + '</td><td> '+ @MESS5 +'</td></tr></Table>'      
drop table #NSXCurr                          
drop table #aa5 
drop table #NSXCurr_Old                          
drop table #aa5_Old 
update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='NSX' and Email='N'        
end
 if exists(select * from SB_ClientOldBrok where Clientcode=@ClientCode and RefNo=@REFNO and segment='MCD' and Email='N')
 begin  
	select @MCD1=MCD1,@MCD2=MCD2,@MCD1_Old=MCD1_Old,@MCD2_Old=MCD2_Old from SB_ClientModiBrk a join
	SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
	and b.RefNo=@REFNO and b.segment='MCD' and Email='N'

create table #MCD
(
Type  varchar(50),
Future  varchar(100)
) 
insert into #MCD                   
select '1st Leg' as Type,@MCD1 as Future         

insert into #MCD                                     
select '2nd Leg' as Type,@MCD2 as Future

create table #MCD_Old
(
Type_Old  varchar(50),
Future_Old  varchar(100)
) 
insert into #MCD_Old                   
select '1st Leg' as Type_Old,@MCD1_Old as Future_Old         

insert into #MCD_Old                                     
select '2nd Leg' as Type_Old,@MCD2_Old as Future_Old
            
  declare @Count6 int,@CountEnd6 int,@Type6 as varchar(20)='',@Min6 as  varchar(50),@Per6 as  varchar(50)           
  DECLARE @MessBody6 NVARCHAR(MAX) ,@MESS6 NVARCHAR(MAX) ,@MESS6_MCD NVARCHAR(MAX)        
  DECLARE @xml6 NVARCHAR(MAX)              
   DECLARE @Data6 NVARCHAR(MAX) ,  @totctrOT6 as int=0          
           
    set @Data6=''                
    set @MessBody6=''                          
    set @MESS6=''          
    set @Count6=1                                    
    Set @MESS6_MCD=''          
              
    select  row_number()over (order by Type) As Srno,Type,Future into #aa6 from #MCD          
     SELECT @totctrOT=count(1) from #aa6           
   SET @MESS6=                            
   '<table border="1" cellpadding="2" cellspacing="2">
   <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                             
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Future (%) </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count6 <= @totctrOT6                              
     BEGIN                        
      SELECT @Type6=Type, @Min6=Future FROM #aa6 WHERE Srno=@count6                                   
      set @Data6=@Data6+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type6) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min6) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count6=@Count6+1                                    
     END 
     SET @MESS6=@MESS6 + @Data6 +'</Table>'
      
     declare @Count6_Old int,@CountEnd6_Old int,@Type6_Old as varchar(20)='',@Min6_Old as  varchar(50),@Per6_Old as  varchar(50)           
  DECLARE @MessBody6_Old NVARCHAR(MAX) ,@MESS6_Old NVARCHAR(MAX)         
  DECLARE @xml6_Old NVARCHAR(MAX)              
   DECLARE @Data6_Old NVARCHAR(MAX) ,  @totctrOT6_Old as int=0          
           
    set @Data6_Old=''                
    set @MessBody6_Old=''                          
    set @MESS6_Old=''          
    set @Count6_Old=1                                    
              
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,Future_Old into #aa6_Old from #MCD_Old          
     SELECT @totctrOT_Old=count(1) from #aa6_Old           
   SET @MESS6_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2"> 
   <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Future (%) </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count6_Old <= @totctrOT6_Old                              
     BEGIN                        
      SELECT @Type6_Old=Type_Old, @Min6_Old=Future_Old FROM #aa6_Old WHERE Srno=@count6_Old                                   
      set @Data6_Old=@Data6_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type6_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min6_Old) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count6_Old=@Count6_Old+1                                    
     END 
     SET @MESS6_Old= @MESS6_Old + @Data6_Old +'</Table>' 
     set @MESS6_MCD='<Br><B>MCD</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS6_Old + '</td><td> '+ @MESS6 +'</td></tr></Table>'         
drop table #MCD                          
drop table #aa6 
drop table #MCD_Old                          
drop table #aa6_Old       
update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='MCD' and Email='N'  
end

if exists (select * from SB_ClientOldBrok where Clientcode=@clientcode  and RefNo=@REFNO and segment='NSXOption' and Email='N')
begin
select @NSXO1=NSXO1,@NSXO2=NSXO2,@NSXO1_Old=NSXO1_Old,@NSXO2_Old=NSXO2_Old from SB_ClientModiBrk a join
	SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
	and b.RefNo=@REFNO  and b.segment='NSXOption' and Email='N'

create table #NSXO
(
Type  varchar(50),
PerLot  varchar(50)
) 
insert into #NSXO                   
select '1st Leg' as Type,@NSXO1 as PerLot         

insert into #NSXO                                     
select '2nd Leg' as Type,@NSXO2 as PerLot

create table #NSXO_Old
(
Type_Old  varchar(50),
PerLot_Old  varchar(50)
) 
insert into #NSXO_Old                   
select '1st Leg' as Type_Old,@NSXO1_Old as PerLot_Old         

insert into #NSXO_Old                                     
select '2nd Leg' as Type_Old,@NSXO2_Old as PerLot_Old

  declare @Count8 int,@CountEnd8 int,@Type8 as varchar(20)='',@Min8 as varchar(50),@Per8 as varchar(50)           
  DECLARE @MessBody8 NVARCHAR(MAX) ,@MESS8 NVARCHAR(MAX),@MESS8_NSXOption NVARCHAR(MAX)    
  DECLARE @xml8 NVARCHAR(MAX)              
   DECLARE @Data8 NVARCHAR(MAX) ,  @totctrOT8 as int=0          
           
    set @Data8=''                
    set @MessBody8=''                          
    set @MESS8=''          
    set @Count8=1                                    
    set @MESS8_NSXOption=''          
              
    select  row_number()over (order by Type) As Srno,Type,PerLot into #aa8 from #NSXO          
     SELECT @totctrOT8=count(1) from #aa8           
   SET @MESS8=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
    <tr><th  align="center" colspan="3">New Brokerage </th>
	   </tr>                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Per Lot Rs. </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count8 <= @totctrOT8                              
     BEGIN                        
      SELECT @Type8=Type, @Min8=PerLot FROM #aa8 WHERE Srno=@count8                                   
      set @Data8=@Data8+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type8) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min8) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count8=@Count8+1                                    
     END
      SET @MESS8=@MESS8 + @Data8 +'</Table>' 
      
       declare @Count8_Old int,@CountEnd8_Old int,@Type8_Old as varchar(20)='',@Min8_Old as varchar(50),@Per8_Old as varchar(50)           
  DECLARE @MessBody8_Old NVARCHAR(MAX) ,@MESS8_Old NVARCHAR(MAX)  
  DECLARE @xml8_Old NVARCHAR(MAX)              
   DECLARE @Data8_Old NVARCHAR(MAX) ,  @totctrOT8_Old as int=0          
           
    set @Data8_Old=''                
    set @MessBody8_Old=''                          
    set @MESS8_Old=''          
    set @Count8_Old=1                                           
              
    select  row_number()over (order by Type_Old) As Srno,Type_Old,PerLot_Old into #aa8_Old from #NSXO_Old          
     SELECT @totctrOT8_Old=count(1) from #aa8_Old           
   SET @MESS8_Old=                            
   '<table border="1" cellpadding="2" cellspacing="2">  
    <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                            
   <tr>                       
    <th align="center"> Type </th>                            
       <th align="center"> Per Lot Rs. </th>                                                                                 
   </tr>'          
--print @MESS          
   WHILE @Count8_Old <= @totctrOT8_Old                              
     BEGIN                        
      SELECT @Type8_Old=Type_Old, @Min8_Old=PerLot_Old FROM #aa8_Old WHERE Srno=@count8_Old                                   
      set @Data8_Old=@Data8_Old+                           
     '<tr>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Type8_Old) +' </td>                          
     <td align="center"> '+ CONVERT(VARCHAR,@Min8_Old) +' </td>                                                                      
       </tr>'           
       --print @Data                         
      SET   @Count8_Old=@Count8_Old+1                                    
     END
      SET @MESS8_Old= @MESS8_Old + @Data8_Old +'</Table>'
      set @MESS8_NSXOption='<Br><B>NSX Option</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS8_Old + '</td><td> '+ @MESS8 +'</td></tr></Table>'                    
drop table #NSXO                          
drop table #aa8 
drop table #NSXO_Old                          
drop table #aa8_old
update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='NSXOption' and Email='N'  
end


 if exists(select * from SB_ClientOldBrok where Clientcode=@ClientCode and RefNo=@REFNO and segment='BSEFO' and Email='N')
 begin 	              

	select @BSEFOFMin=BSEFOFMin,@BSEFOFFu=BSEFOFFu,@BSEFOSMin=BSEFOSMin,@BSEFOSFu=BSEFOSFu ,
	 @BSEFOFMin_Old=BSEFOFMin_Old,@BSEFOFFu_Old=BSEFOFFu_Old,@BSEFOSMin_Old=BSEFOSMin_Old,@BSEFOSFu_Old=BSEFOSFu_Old
	from SB_ClientModiBrk a join
	 SB_ClientOldBrok b on a.Clientcode=b.Clientcode and a.req_RefNo=b.RefNo and a.segment=b.segment where b.Clientcode=@ClientCode
	 and b.RefNo=@REFNO and b.segment='BSEFO' and Email='N'

---------------------------
	create table #BSEFO
	(
	Type  varchar(50),
	Min  varchar(50),
	Per  varchar(50)
	) 
	insert into #BSEFO                   
	select '1st Leg' as Type,@BSEFOFMin as Min,@BSEFOFFu as Per          

	insert into #BSEFO                                     
	select '2nd Leg' as Type,@BSEFOSMin as Min,@BSEFOSFu as Per
	
	create table #BSEFO_OLD
	(
	Type_Old  varchar(50),
	Min_Old  varchar(50),
	Per_old  varchar(50)
	) 
	insert into #BSEFO_OLD                   
	select '1st Leg' as Type,@BSEFOFMin_Old as Min,@BSEFOFFu_Old as Per          

	insert into #BSEFO_OLD                                     
	select '2nd Leg' as Type,@BSEFOSMin_Old as Min,@BSEFOSFu_Old as Per

           
	  declare @CountBSEFO int,@CountEndBSEFO1 int,@Type12 as varchar(20)='',@Min12 as varchar(50),@Per12 as varchar(50)           
	  DECLARE @MessBody12 NVARCHAR(MAX) ,@MESS12 NVARCHAR(MAX) ,@Mess2_BSEFO  NVARCHAR(MAX)                       
	   DECLARE @Data12 NVARCHAR(MAX) ,  @totctrOTBSEFO as int=0          
	           
		set @Data12=''                
		--set @MessBody=''                          
		set @MESS12='' 
		set @Mess2_BSEFO=''         
		set @CountBSEFO=1                                    
	              
	              
		select  row_number()over (order by Type) As Srno,Type,Min,Per into #aa12 from #BSEFO          
		 SELECT @totctrOTBSEFO=count(1) from #aa12           
	   SET @MESS12=                            
	   '<table border="1" cellpadding="2" cellspacing="2">                            
	   <tr><th  align="center" colspan="3" >New Brokerage </th>
	   </tr> 
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountBSEFO <= @totctrOTBSEFO                              
		 BEGIN                        
		  SELECT @Type12=Type, @Min12=Min,@Per12=Per FROM #aa12 WHERE Srno=@CountBSEFO                                   
		  set @Data12=@Data12+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type12) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min12) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per12) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountBSEFO=@CountBSEFO+1                                    
		 END             
  SET @MESS12= @MESS12 + @Data12 +'</Table>' 
  
  declare @CountBSEFO_Old int,@CountEndBSEFO1_Old int,@Type12_Old as varchar(20)='',@Min12_Old as varchar(50),@Per12_Old as varchar(50)           
	  DECLARE @MessBody12_Old NVARCHAR(MAX) ,@MESS12_Old NVARCHAR(MAX)                        
	   DECLARE @Data12_Old NVARCHAR(MAX) ,  @totctrOTBSEFO_Old as int=0          
	           
		set @Data12_Old=''                
		--set @MessBody=''                          
		set @MESS12_Old=''          
		set @CountBSEFO_Old=1                                    
	              
	              
		select  row_number()over (order by Type_Old) As Srno,Type_Old,Min_Old,Per_Old into #aa12_Old from #BSEFO_Old          
		 SELECT @totctrOTBSEFO_Old=count(1) from #aa12_Old           
	   SET @MESS12_Old=                            
	   '<table border="1" cellpadding="2" cellspacing="2"> 
	    <tr><th  align="center" colspan="3">Old Brokerage </th>
	   </tr>                              
	   <tr>                       
		<th align="center"> Type </th>                            
		   <th align="center"> Min </th>                            
		   <th align="center"> Per(%)  </th>                                                      
	   </tr>'          
	--print @MESS          
	   WHILE @CountBSEFO_Old <= @totctrOTBSEFO_Old                              
		 BEGIN                        
		  SELECT @Type12_Old=Type_Old, @Min12_Old=Min_Old,@Per12_Old=Per_Old FROM #aa12_Old WHERE Srno=@CountBSEFO_Old                                   
		  set @Data12_Old=@Data12_Old+                           
		 '<tr>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Type12_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Min12_Old) +' </td>                          
		 <td align="center"> '+ CONVERT(VARCHAR,@Per12_Old) +' </td>                                                  
		   </tr>'           
		   --print @Data                         
		  SET   @CountBSEFO_Old=@CountBSEFO_Old+1                                    
		 END             
  SET @MESS12_Old= @MESS12_Old + @Data12_Old +'</Table>'  
   set @Mess2_BSEFO='<Br><B>BSEFO</B> <Br><Br>'+ '<Table> <tr><td>'+ @MESS12_Old + '</td><td> '+ @MESS12 +'</td></tr></Table>'  
  print @MESS12
drop table #BSEFO                          
drop table #aa12
drop table #BSEFO_Old                          
drop table #aa12_Old

update SB_ClientOldBrok set Email='Y'  where Clientcode=@ClientCode and RefNo=@REFNO and segment='BSEFO' and Email='N'
end
---------------	

	--SET @MessBody =  'Dear Team,<br/><br/>'+' Please modify the brokerage slab for Client code-'+@clientcode+'<br/><br/>'+ @MESS + @Data + '<br/><br/>'+ @MESS1 + @Data1 +'<br/><br/>'+ @MESS2 + @Data2 +'<br/><br/>'+ @MESS3 + @Data3 +'<br/><br/>'+ @MESS4 + @Data4 +'<br/><br/>'+ @MESS5 + @Data5 +'<br/><br/>'+ @MESS6 + @Data6 +'</Table>'       
	SET @MessBody =  '<b><font size="4" color="#FF4500">Dear '+@ClientName+'('+@clientcode+')</font></b>,<br/><br/>'+' We are acknowledging your request for change in brokerage rates as described below  <br/><br/> '+ isnull(@MESSBSE,'') + '<Br>'+ isnull(@Mess1_NSE,'')+'<Br>'+ isnull(@Mess2_NSEFO,'')+'<Br>'+isnull(@Mess7_NSEFOOpt,'') +'<Br>' +isnull(@MESS14_MCX,'') +'<Br>' +isnull(@MESS4_NCDX,'')+'<Br>' +isnull(@MESS5_NSX,'')+'<Br>' +isnull(@MESS6_MCD,'')+'<Br>' +isnull(@MESS8_NSXOption,'')+'<Br>' +isnull(@Mess2_BSEFO,'')+'<Br>'+isnull(@Mess77_BSEFOOpt,'')+'<Br>'       
	SET @MessBody=@MessBody+'<BR><BR>Regards,<br><Br>Angel Broking Pvt. Ltd.'                                    
	SET @MessBody=@MessBody+'<BR><BR>This is a system generated message. Please do not Reply.'
	SET @MessBody=@MessBody+'<BR><BR> Please contact 022-33551111 or 022-42185454.'
	set @sub='Acknowledgement of Brokerage modification for Client Code-'+@clientcode+'' 
	                                 
                          
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                    
 @RECIPIENTS =@emailto,--'neha.naiwar@angelbroking.com' ,                                    
 @COPY_RECIPIENTS = @emailcc,                                    
 --@blind_copy_recipients =@emailbcc,--'neha.naiwar@angelbroking.com' ,                
 @PROFILE_NAME = 'AngelBroking',                                    
 @BODY_FORMAT ='HTML',                                    
 @SUBJECT = @sub,                                    
 @FILE_ATTACHMENTS ='',                                    
 @BODY =@MessBody                                    

                         
END try                
          
  BEGIN catch                          
      SET @MessBody=                          
'<BR><BR> ERROR in triggering email: .<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>'                          
                          
   EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                    
 @RECIPIENTS =@emailto,--'neha.naiwar@angelbroking.com' ,                                    
 @COPY_RECIPIENTS = @emailcc,                                    
 --@blind_copy_recipients =@emailbcc,--'neha.naiwar@angelbroking.com' ,                
 @PROFILE_NAME = 'AngelBroking',                                    
 @BODY_FORMAT ='HTML',                                    
 @SUBJECT = @sub,                                    
 @FILE_ATTACHMENTS ='',                                    
 @BODY =@MessBody                       
END catch                          
                          
SET nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_ClientBrokEntry_UAT_Live
-- --------------------------------------------------
  
create procedure [dbo].[SB_ClientBrokEntry_UAT_Live] (                          
@ClientCode as varchar(50),                              
@Segment as varchar(50),@BSEL1 as money=0.00,@BSEM1 as money=0.00,@BseP1 as money=0.00,@BSEL2 as money=0.00,@BSEM2 as money=0.00,  
@BseP2 as money=0.00,@BSEDel as money=0.00,@BSEMDel as money=0.00,@BsePDel as money=0.00,@NSEL1 as money=0.00,@NSEM1 as money=0.00,  
@NSEP1 as money=0.00,@NSEL2 as money=0.00,@NSEM2 as money=0.00,@NSEP2 as money=0.00,  
@NSELDel as money=0.00,@NSEMDel as money=0.00,@NSEPDel as money=0.00,@MCXL1 as money=0.00,@MCX1M as money=0.00,@MCX1Fu as money=0.00,  
@MCXL2 as money=0.00,@MCX2M as money=0.00,@MCX2Fu as money=0.00,@NCDX1L as money=0.00,@NCDX1Min as money=0.00,@NCDX1Fu as money=0.00,  
@NCDX2L as money=0.00,@NCDX2Min as money=0.00,@NCDX2Fu as money=0.00,@NSEFOFL as money=0.00,  
@NSEFOFMin as money=0.00,@NSEFOFFu as money=0.00,@NSEFOSL as money=0.00,@NSEFOSMin as money=0.00,@NSEFOSFu as money=0.00,
@BSEFOFL as money=0.00,    
@BSEFOFMin as money=0.00,@BSEFOFFu as money=0.00,@BSEFOSL as money=0.00,@BSEFOSMin as money=0.00,@BSEFOSFu as money=0.00,
@NSX1 as money=0.00,@NSX2 as money=0.00,@NSEFOOS1 as money=0.00,@NSEFOOS2 as money=0.00,@NSEFOON1 as money=0.00,@NSEFOON2 as money=0.00,  
@NSEFOOB1 as money=0.00,@NSEFOOB2 as money=0.00,@NSEFOOFN1 as money=0.00,@NSEFOOFN2 as money=0.00
,@NSXO1 as money=0.00,@NSXO2 as money=0.00,@MCD1 as money=0.00,@MCD2 as money=0.00,  
@MCDO1 as money=0.00,@MCDO2 as money=0.00,  
@BSEM1_Old  as money=0.00,@BseP1_Old  as money=0.00,@BSEM2_Old as money=0.00,@BseP2_Old as money=0.00,@BSEMDel_Old as money=0.00,@BsePDel_Old as money=0.00,@NSEM1_Old as money=0.00,  
@NSEP1_Old as money=0.00,@NSEM2_Old as money=0.00,@NSEP2_Old as money=0.00,@NSEMDel_Old as money=0.00,  
   @NSEPDel_Old  as money=0.00,@MCX1M_Old  as money=0.00,@MCX1Fu_Old  as money=0.00,@MCX2M_Old as money=0.00,@MCX2Fu_Old as money=0.00,@NCDX1Min_Old as money=0.00,  
   @NCDX1Fu_Old as money=0.00,@NCDX2Min_Old  as money=0.00,@NCDX2Fu_Old  as money=0.00,@NSEFOFL_Old  as money=0.00,@NSEFOFMin_Old as money=0.00,@NSEFOFFu_Old as money=0.00,  
   @NSEFOSL_Old as money=0.00,@NSEFOSMin_Old as money=0.00,@NSEFOSFu_Old as money=0.00,@NSX1_Old as money=0.00,@NSX2_Old as money=0.00,@NSEFOOS1_Old as money=0.00,@NSEFOOS2_Old as money=0.00,  
   @NSEFOON1_Old as money=0.00,@NSEFOON2_Old as money=0.00,@NSEFOOB1_Old as money=0.00,@NSEFOOB2_Old as money=0.00,
      @NSEFOOFN1_Old as money=0.00,@NSEFOOFN2_Old as money=0.00,
   @NSXO1_Old as money=0.00,@NSXO2_Old as money=0.00,@MCD1_Old as money=0.00,@MCD2_Old as money=0.00,@MCDO1_Old as money=0.00,@MCDO2_Old  as money=0.00 ,       
@UpdatedBy as varchar(50)
,@BSEFOFL_Old  as money=0.00,@BSEFOFMin_Old as money=0.00,@BSEFOFFu_Old as money=0.00,    
   @BSEFOSL_Old as money=0.00,@BSEFOSMin_Old as money=0.00,@BSEFOSFu_Old as money=0.00
)                                
as                                
set nocount on                                  
      
      
begin                                
     
declare @tableno as int,@tablenoDel as int  
declare @m1 as money,@m2 as money  
  
if(@Segment='BSECM')  
begin   
 if (@BSEM1>0 and @BseP1>0 and @BSEM2>0 and @BseP2>0)  
 begin  
  select @m1=round((@BSEM1/@BseP1)*100,0)  
  select @m2=round((@BSEM2/@BseP2)*100,0)  
    
   select * into #aa from AngelBSECM.bsedb_AB.dbo.broktable where table_no >= 2000 and table_no in   
   (  
   select table_no from AngelBSECM.bsedb_AB.dbo.broktable where upper_lim=@m1 and trd_del = 'F' and   
   (day_puc = @BSEM1 and Day_Sales=@BSEM1 and Sett_Purch=@BSEM1 and sett_sales=@BSEM1)   
   and val_perc = 'V'  and Line_no=1 and table_no in   
    (select table_no from AngelBSECM.bsedb_AB.dbo.broktable where trd_del = 'F' and   
    (day_puc = @BseP1 and Day_Sales=@BseP1  and Sett_Purch=@BseP1 and sett_sales=@BseP1)   
    and val_perc = 'P' and Line_no=2 and table_no in   
    (   
    select table_no from AngelBSECM.bsedb_AB.dbo.broktable where  upper_lim=@m2 and trd_del = 'S' and   
    (day_puc = @BSEM2 and Day_Sales=@BSEM2 and Sett_Purch=@BSEM2 and sett_sales=@BSEM2)  
     and val_perc = 'V' and Line_no=3 and table_no in   
     (select table_no from AngelBSECM.bsedb_AB.dbo.broktable where trd_del = 'S' and    
     (day_puc = @BseP2 and Day_Sales=@BseP2 and Sett_Purch=@BseP2 and sett_sales=@BseP2)   
     and val_perc = 'P' and Line_no=4 ) ) ) )  
     order by table_no,line_no  
      
   If Exists(select * from #aa)  
   begin    
     select @tableno=min(table_no) from #aa  
   end  
   else  
   begin  
     set @m1=@m1-1  
     set @m2=@m2-1  
    select * into #aa1 from AngelBSECM.bsedb_AB.dbo.broktable where table_no >= 2000 and table_no in   
    (  
    select table_no from AngelBSECM.bsedb_AB.dbo.broktable where upper_lim=@m1 and trd_del = 'F' and   
    (day_puc = @BSEM1 and Day_Sales=@BSEM1 and Sett_Purch=@BSEM1 and sett_sales=@BSEM1)   
    and val_perc = 'V'  and Line_no=1 and table_no in   
     (select table_no from AngelBSECM.bsedb_AB.dbo.broktable where trd_del = 'F' and   
     (day_puc = @BseP1 and Day_Sales=@BseP1  and Sett_Purch=@BseP1 and sett_sales=@BseP1)   
     and val_perc = 'P' and Line_no=2 and table_no in   
     (   
     select table_no from AngelBSECM.bsedb_AB.dbo.broktable where  upper_lim=@m2 and trd_del = 'S' and   
     (day_puc = @BSEM2 and Day_Sales=@BSEM2 and Sett_Purch=@BSEM2 and sett_sales=@BSEM2)  
      and val_perc = 'V' and Line_no=3 and table_no in   
      (select table_no from AngelBSECM.bsedb_AB.dbo.broktable where trd_del = 'S' and    
      (day_puc = @BseP2 and Day_Sales=@BseP2 and Sett_Purch=@BseP2 and sett_sales=@BseP2)   
      and val_perc = 'P' and Line_no=4 ) ) ) )  
      order by table_no,line_no   
        
        If Exists(select * from #aa1)  
     begin    
       select @tableno=min(table_no) from #aa1  
     end  
     else  
     begin   
       select 'Not Exists' as checkExist  
       return;  
     end      
   end  
       
  end  
  if (@BSEM1>0 and @BseP1>0 and @BSEM2=0 and @BseP2=0)  
  begin  
   select @m1=round((@BSEM1/@BseP1)*100,0)  
     
   select * into #bb  from AngelBSECM.bsedb_AB.dbo.broktable where table_no >= 2000 and table_no in   
   ( select table_no from AngelBSECM.bsedb_AB.dbo.broktable where upper_lim=@m1 and trd_del = 'F' and   
   (day_puc = @BSEM1 and Day_Sales=@BSEM1   
   and Sett_Purch=@BSEM1 and sett_sales=@BSEM1) and val_perc = 'V' and Line_no=1 and table_no in  
    (select table_no from AngelBSECM.bsedb_AB.dbo.broktable where trd_del = 'F'   
   and (day_puc = @BseP1 and Day_Sales=@BseP1 and Sett_Purch=@BseP1 and sett_sales=@BseP1) and val_perc = 'P' and Line_no=2  
    and table_no in (select table_no from AngelBSECM.bsedb_AB.dbo.broktable where trd_del = 'S' and (day_puc = @BseP2 and Day_Sales=@BseP2   
    and Sett_Purch=@BseP2 and sett_sales=@BseP2) and val_perc = 'P' and Line_no=3) ) )  order by table_no,line_no  
      
      
   If Exists(select * from #bb)  
   begin    
     select @tableno=min(table_no) from #bb  
   end  
   else  
   begin  
      set @m1=@m1-1  
        
     select * into #bb1  from AngelBSECM.bsedb_AB.dbo.broktable where table_no >= 2000 and table_no in   
    ( select table_no from AngelBSECM.bsedb_AB.dbo.broktable where upper_lim=@m1 and trd_del = 'F' and   
    (day_puc = @BSEM1 and Day_Sales=@BSEM1   
    and Sett_Purch=@BSEM1 and sett_sales=@BSEM1) and val_perc = 'V' and Line_no=1 and table_no in  
     (select table_no from AngelBSECM.bsedb_AB.dbo.broktable where trd_del = 'F'   
    and (day_puc = @BseP1 and Day_Sales=@BseP1 and Sett_Purch=@BseP1 and sett_sales=@BseP1) and val_perc = 'P' and Line_no=2  
     and table_no in (select table_no from AngelBSECM.bsedb_AB.dbo.broktable where trd_del = 'S' and (day_puc = @BseP2 and Day_Sales=@BseP2   
     and Sett_Purch=@BseP2 and sett_sales=@BseP2) and val_perc = 'P' and Line_no=3) ) )  order by table_no,line_no  
    If Exists(select * from #bb1)  
    begin    
      select @tableno=min(table_no) from #bb1  
    end  
    else  
    begin  
      select 'Not Exists' as checkExist  
      return;  
    end      
   end  
  end  
  if(@BSEMDel>0 and @BsePDel>0)  
  begin   
   select @m1=round((@BSEMDel/@BsePDel)*100,0)  
    
   select * into #cc from AngelBSECM.bsedb_AB.dbo.broktable where table_no >= 2000 and Trd_Del='D' AND table_no in   
   ( select table_no from AngelBSECM.bsedb_AB.dbo.broktable where upper_lim=@m1  
    and trd_del = 'D' and normal =@BSEMDel and val_perc = 'V' and Line_no=1  and   
   table_no in (select table_no from AngelBSECM.bsedb_AB.dbo.broktable  
    where trd_del = 'D' and normal = @BsePDel and val_perc = 'P'  and Line_no=2 ) ) and table_no not in   
    (select table_no from intranet.testdb.dbo.cl_bse)  
     
   If Exists(select * from #cc)  
   begin    
       select @tablenoDel=min(table_no) from #cc   
   end  
   else  
   begin  
    set @m1=@m1-1  
    select * into #we from AngelBSECM.bsedb_AB.dbo.broktable where table_no >= 2000 and Trd_Del='D' AND table_no in   
    ( select table_no from AngelBSECM.bsedb_AB.dbo.broktable where upper_lim=@m1  
     and trd_del = 'D' and normal =@BSEMDel and val_perc = 'V' and Line_no=1  and   
    table_no in (select table_no from AngelBSECM.bsedb_AB.dbo.broktable  
     where trd_del = 'D' and normal = @BsePDel and val_perc = 'P'  and Line_no=2 ) ) and table_no not in   
     (select table_no from intranet.testdb.dbo.cl_bse)   
    If Exists(select * from #we)  
    begin    
        select @tablenoDel=min(table_no) from #we   
        print 'hq'  
    end  
    else  
    begin  
      select 'Not Exists' as checkExist  
      return;    
    end  
   end   
    
  end  
    
end    
--drop table #aa  
--drop table #bb  
--drop table #cc  
  
if(@Segment='NSECM')  
begin   
 if (@NSEM1>0 and @NseP1>0 and @NSEM2>0 and @NseP2>0)  
 begin  
  select @m1=round((@NSEM1/@NseP1)*100,0)  
  select @m2=round((@NSEM2/@NseP2)*100,0)  
    
   select * into #aaNSE from AngelNseCM.msajag.dbo.broktable where table_no >= 2000 and table_no in   
   (  
   select table_no from AngelNseCM.msajag.dbo.broktable where upper_lim=@m1 and trd_del = 'F' and   
   (day_puc = @NSEM1 and Day_Sales=@NSEM1 and Sett_Purch=@NSEM1 and sett_sales=@NSEM1)   
   and val_perc = 'V'  and Line_no=1 and table_no in   
    (select table_no from AngelNseCM.msajag.dbo.broktable where trd_del = 'F' and   
    (day_puc = @NseP1 and Day_Sales=@NseP1  and Sett_Purch=@NseP1 and sett_sales=@NseP1)   
    and val_perc = 'P' and Line_no=2 and table_no in   
    (   
    select table_no from AngelNseCM.msajag.dbo.broktable where  upper_lim=@m2 and trd_del = 'S' and   
    (day_puc = @NSEM2 and Day_Sales=@NSEM2 and Sett_Purch=@NSEM2 and sett_sales=@NSEM2)  
     and val_perc = 'V' and Line_no=3 and table_no in   
     (select table_no from AngelNseCM.msajag.dbo.broktable where trd_del = 'S' and    
     (day_puc = @NseP2 and Day_Sales=@NseP2 and Sett_Purch=@NseP2 and sett_sales=@NseP2)   
     and val_perc = 'P' and Line_no=4 ) ) ) )  
     order by table_no,line_no  
       
   If Exists(select * from #aaNSE)  
   begin    
       select @tableno=min(table_no) from #aaNSE  
   end  
   else  
   begin  
    set @m1=@m1-1  
    set @m2=@m2-1  
      
    select * into #aaNSE1 from AngelNseCM.msajag.dbo.broktable where table_no >= 2000 and table_no in   
   (  
   select table_no from AngelNseCM.msajag.dbo.broktable where upper_lim=@m1 and trd_del = 'F' and   
   (day_puc = @NSEM1 and Day_Sales=@NSEM1 and Sett_Purch=@NSEM1 and sett_sales=@NSEM1)   
   and val_perc = 'V'  and Line_no=1 and table_no in   
    (select table_no from AngelNseCM.msajag.dbo.broktable where trd_del = 'F' and   
    (day_puc = @NseP1 and Day_Sales=@NseP1  and Sett_Purch=@NseP1 and sett_sales=@NseP1)   
    and val_perc = 'P' and Line_no=2 and table_no in   
    (   
    select table_no from AngelNseCM.msajag.dbo.broktable where  upper_lim=@m2 and trd_del = 'S' and   
    (day_puc = @NSEM2 and Day_Sales=@NSEM2 and Sett_Purch=@NSEM2 and sett_sales=@NSEM2)  
     and val_perc = 'V' and Line_no=3 and table_no in   
     (select table_no from AngelNseCM.msajag.dbo.broktable where trd_del = 'S' and    
     (day_puc = @NseP2 and Day_Sales=@NseP2 and Sett_Purch=@NseP2 and sett_sales=@NseP2)   
     and val_perc = 'P' and Line_no=4 ) ) ) )  
     order by table_no,line_no  
     
    If Exists(select * from #aaNSE1)  
    begin    
       select @tableno=min(table_no) from #aaNSE1  
    end  
    else  
    begin   
     select 'Not Exists' as checkExist  
     return;    
   end  
     
    end     
       
  end  
  if (@NSEM1>0 and @NseP1>0 and @NSEM2=0 and @NseP2=0)  
  begin  
   select @m1=round((@NSEM1/@NSEP1)*100,0)  
     
   select * into #bbNSE  from AngelNseCM.msajag.dbo.broktable where table_no >= 2000 and table_no in   
   ( select table_no from AngelNseCM.msajag.dbo.broktable where upper_lim=@m1 and trd_del = 'F' and   
   (day_puc = @NSEM1 and Day_Sales=@NSEM1   
   and Sett_Purch=@NSEM1 and sett_sales=@NSEM1) and val_perc = 'V' and Line_no=1 and table_no in  
    (select table_no from AngelNseCM.msajag.dbo.broktable where trd_del = 'F'   
   and (day_puc = @NSEP1 and Day_Sales=@NSEP1 and Sett_Purch=@NSEP1 and sett_sales=@NSEP1) and val_perc = 'P' and Line_no=2  
    and table_no in (select table_no from AngelNseCM.msajag.dbo.broktable where trd_del = 'S' and (day_puc = @NSEP2 and Day_Sales=@NSEP2   
    and Sett_Purch=@NSEP2 and sett_sales=@NSEP2) and val_perc = 'P' and Line_no=3) ) )  order by table_no,line_no  
      
   If Exists(select * from #bbNSE)  
   begin    
        select @tableno=min(table_no) from #bbNSE  
   end  
   else  
   begin  
    set @m1=@m1-1  
      
   select * into #bbNSE1  from AngelNseCM.msajag.dbo.broktable where table_no >= 2000 and table_no in   
   ( select table_no from AngelNseCM.msajag.dbo.broktable where upper_lim=@m1 and trd_del = 'F' and   
   (day_puc = @NSEM1 and Day_Sales=@NSEM1   
   and Sett_Purch=@NSEM1 and sett_sales=@NSEM1) and val_perc = 'V' and Line_no=1 and table_no in  
    (select table_no from AngelNseCM.msajag.dbo.broktable where trd_del = 'F'   
   and (day_puc = @NSEP1 and Day_Sales=@NSEP1 and Sett_Purch=@NSEP1 and sett_sales=@NSEP1) and val_perc = 'P' and Line_no=2  
    and table_no in (select table_no from AngelNseCM.msajag.dbo.broktable where trd_del = 'S' and (day_puc = @NSEP2 and Day_Sales=@NSEP2   
    and Sett_Purch=@NSEP2 and sett_sales=@NSEP2) and val_perc = 'P' and Line_no=3) ) )  order by table_no,line_no  
      
    If Exists(select * from #bbNSE1)  
    begin    
         select @tableno=min(table_no) from #bbNSE1  
    end  
    else  
    begin   
      select 'Not Exists' as checkExist  
      return;    
    end  
   end   
     
  end  
  if(@NSEMDel>0 and @NSEPDel>0)  
  begin   
   select @m1=round((@NSEMDel/@NSEPDel)*100,0)  
    
   select * into #ccNSE from AngelNseCM.msajag.dbo.broktable where table_no >= 2000 and Trd_Del='D' AND table_no in   
   ( select table_no from AngelNseCM.msajag.dbo.broktable where upper_lim=@m1  
    and trd_del = 'D' and normal =@NSEMDel and val_perc = 'V' and Line_no=1  and   
   table_no in (select table_no from AngelNseCM.msajag.dbo.broktable  
    where trd_del = 'D' and normal = @NSEPDel and val_perc = 'P'  and Line_no=2 ) ) and table_no not in   
    (select table_no from intranet.testdb.dbo.cl_bse)  
     
   If Exists(select * from #ccNSE)  
   begin    
        select @tablenoDel=min(table_no) from #ccNSE   
   end  
   else  
   begin  
    set @m1=@m1-1  
      
    select * into #ere from AngelNseCM.msajag.dbo.broktable where table_no >= 2000 and Trd_Del='D' AND table_no in   
   ( select table_no from AngelNseCM.msajag.dbo.broktable where upper_lim=@m1  
    and trd_del = 'D' and normal =@NSEMDel and val_perc = 'V' and Line_no=1  and   
   table_no in (select table_no from AngelNseCM.msajag.dbo.broktable  
    where trd_del = 'D' and normal = @NSEPDel and val_perc = 'P'  and Line_no=2 ) ) and table_no not in   
    (select table_no from intranet.testdb.dbo.cl_bse)  
      
    If Exists(select * from #ere)  
    begin    
        select @tablenoDel=min(table_no) from #ere   
    end  
    else  
    begin  
      select 'Not Exists' as checkExist  
      return;    
    end  
   end  
      
  end  
    
end    
--drop table #aaNSE  
--drop table #bbNSE  
--drop table #ccNSE  
  
IF(@Segment='NSEFO')  
BEGIN  
 if(@NSEFOFMin >0 and @NSEFOFFu >0 and @NSEFOSMin >0 and @NSEFOSFu>0)  
 begin  
  select @m1=round((@NSEFOFMin/@NSEFOFFu)*100,0)  
  select @m2=round((@NSEFOSMin/@NSEFOSFu)*100,0)  
   
   select * into #aaNSEFO from angelfo.nsefo.dbo.broktable where table_no in ( select table_no from angelfo.nsefo.dbo.broktable  
    where upper_lim=@m1 and trd_del = 'F'  
    and (day_puc = @NSEFOFMin and Day_Sales=@NSEFOFMin and Sett_Purch=@NSEFOFMin and sett_sales=@NSEFOFMin) and val_perc = 'V'  and Line_no=1   
    and table_no in   
    (select table_no from angelfo.nsefo.dbo.broktable where trd_del = 'F' and (day_puc = @NSEFOFFu and Day_Sales=@NSEFOFFu and   
    Sett_Purch=@NSEFOFFu   
    and sett_sales=@NSEFOFFu)   
    and val_perc = 'P' and Line_no=2  and table_no in ( select table_no from angelfo.nsefo.dbo.broktable where upper_lim=@m2 and trd_del = 'S' and   
    (day_puc = @NSEFOSMin and Day_Sales=@NSEFOSMin and Sett_Purch=@NSEFOSMin and sett_sales=@NSEFOSMin) and val_perc = 'V'  and Line_no=3   
    and table_no in   
    (select table_no from angelfo.nsefo.dbo.broktable where trd_del = 'S' and (day_puc =@NSEFOSFu and Day_Sales=@NSEFOSFu and   
    Sett_Purch=@NSEFOSFu   
    and sett_sales=@NSEFOSFu)   
    and val_perc = 'P'  and Line_no=4) ) ) ) order by table_no,line_no  
      
      If Exists(select * from #aaNSEFO)  
   begin    
        select @tableno=min(table_no) from #aaNSEFO  
   end  
   else  
   begin  
     select 'Not Exists' as checkExist  
     return;    
   end  
       
       
      select * into #aaNSEFOExpiry from angelfo.nsefo.dbo.broktable where Table_name like 'NORMAL%' and val_perc = 'P' and   
      round_to=4.00 and day_puc = @NSEFOFFu and Line_no=1  
      and Upper_lim=10000000.00  
        
      If Exists(select * from #aaNSEFOExpiry)  
   begin    
        select @tablenoDel=min(table_no) from #aaNSEFOExpiry     
   end  
   else  
   begin  
     select 'Not Exists' as checkExist  
     return;    
   end  
         
 end  
 if (@NSEFOFMin>0 and @NSEFOFFu>0 and @NSEFOSMin=0 and @NSEFOSFu=0)  
  begin  
   select @m1=round((@NSEFOFMin/@NSEFOFFu)*100,0)  
     
   select * into #bbNSEFO from angelfo.nsefo.dbo.broktable where table_no in ( select table_no from angelfo.nsefo.dbo.broktable   
   where upper_lim=@m1 and trd_del = 'F' and (day_puc = @NSEFOFMin and Day_Sales=@NSEFOFMin and Sett_Purch=@NSEFOFMin and sett_sales=@NSEFOFMin)   
    and val_perc = 'V'   and Line_no=1  and table_no in (select table_no from angelfo.nsefo.dbo.broktable where trd_del = 'F' and   
    (day_puc = @NSEFOFFu  and Day_Sales=@NSEFOFFu  
    and Sett_Purch=@NSEFOFFu and sett_sales=@NSEFOFFu) and val_perc = 'P'  and Line_no=2    
    and table_no in (select table_no from angelfo.nsefo.dbo.broktable where trd_del = 'S' and (day_puc = 0 and Day_Sales=0   
   and Sett_Purch=0 and sett_sales=0) and val_perc = 'P' and Line_no=3)) ) order by table_no,line_no    
       
   If Exists(select * from #bbNSEFO)  
   begin    
    select @tableno=min(table_no) from #bbNSEFO  
   end  
   else  
   begin  
     select 'Not Exists' as checkExist  
     return;    
   end  
     
   select * into #bbNSEFOExpiry from angelfo.nsefo.dbo.broktable where Table_name like 'NORMAL%' and val_perc = 'P' and   
      round_to=4.00 and day_puc = @NSEFOFFu and Line_no=1  
      and Upper_lim=10000000.00  
        
      If Exists(select * from #bbNSEFOExpiry)  
   begin    
     select @tablenoDel=min(table_no) from #bbNSEFOExpiry  
   end  
   else  
   begin  
     select 'Not Exists' as checkExist  
     return;    
   end  
   
  end  
END  

/********BSEFO**************/  
 IF(@Segment='BSEFO')    
BEGIN    
 if(@BSEFOFMin >0 and @BSEFOFFu >0 and @BSEFOSMin >0 and @BSEFOSFu>0)    
 begin    
  select @m1=round((@BSEFOFMin/@BSEFOFFu)*100,0)    
  select @m2=round((@BSEFOSMin/@BSEFOSFu)*100,0)    
     
   select * into #aaBSEFO from angelcommodity.BSEfo.dbo.broktable where table_no in ( select table_no from angelcommodity.BSEfo.dbo.broktable    
    where upper_lim=@m1 and trd_del = 'F'    
    and (day_puc = @BSEFOFMin and Day_Sales=@BSEFOFMin and Sett_Purch=@BSEFOFMin and sett_sales=@BSEFOFMin) and val_perc = 'V'  and Line_no=1     
    and table_no in     
    (select table_no from angelcommodity.BSEfo.dbo.broktable where trd_del = 'F' and (day_puc = @BSEFOFFu and Day_Sales=@BSEFOFFu and     
    Sett_Purch=@BSEFOFFu     
    and sett_sales=@BSEFOFFu)     
    and val_perc = 'P' and Line_no=2  and table_no in ( select table_no from angelcommodity.BSEfo.dbo.broktable where upper_lim=@m2 and trd_del = 'S' and     
    (day_puc = @BSEFOSMin and Day_Sales=@BSEFOSMin and Sett_Purch=@BSEFOSMin and sett_sales=@BSEFOSMin) and val_perc = 'V'  and Line_no=3     
    and table_no in     
    (select table_no from angelcommodity.BSEfo.dbo.broktable where trd_del = 'S' and (day_puc =@BSEFOSFu and Day_Sales=@BSEFOSFu and     
    Sett_Purch=@BSEFOSFu     
    and sett_sales=@BSEFOSFu)     
    and val_perc = 'P'  and Line_no=4) ) ) ) order by table_no,line_no    
        
      If Exists(select * from #aaBSEFO)    
   begin      
        select @tableno=min(table_no) from #aaBSEFO    
   end    
   else    
   begin    
     select 'Not Exists' as checkExist    
     return;      
   end    
         
         
      select * into #aaBSEFOExpiry from angelcommodity.BSEfo.dbo.broktable where Table_name like 'NORMAL%' and val_perc = 'P' and     
      round_to=4.00 and day_puc = @BSEFOFFu and Line_no=1    
      and Upper_lim=10000000.00    
          
      If Exists(select * from #aaBSEFOExpiry)    
   begin      
        select @tablenoDel=min(table_no) from #aaBSEFOExpiry       
   end    
   else    
   begin    
     select 'Not Exists' as checkExist    
     return;      
   end    
           
 end    
 if (@BSEFOFMin>0 and @BSEFOFFu>0 and @BSEFOSMin=0 and @BSEFOSFu=0)    
  begin    
   select @m1=round((@BSEFOFMin/@BSEFOFFu)*100,0)    
       
   select * into #bbBSEFO from angelcommodity.BSEfo.dbo.broktable where table_no in ( select table_no from angelcommodity.BSEfo.dbo.broktable     
   where upper_lim=@m1 and trd_del = 'F' and (day_puc = @BSEFOFMin and Day_Sales=@BSEFOFMin and Sett_Purch=@BSEFOFMin and sett_sales=@BSEFOFMin)     
    and val_perc = 'V'   and Line_no=1  and table_no in (select table_no from angelcommodity.BSEfo.dbo.broktable where trd_del = 'F' and     
    (day_puc = @BSEFOFFu  and Day_Sales=@BSEFOFFu    
    and Sett_Purch=@BSEFOFFu and sett_sales=@BSEFOFFu) and val_perc = 'P'  and Line_no=2      
    and table_no in (select table_no from angelcommodity.BSEfo.dbo.broktable where trd_del = 'S' and (day_puc = 0 and Day_Sales=0     
   and Sett_Purch=0 and sett_sales=0) and val_perc = 'P' and Line_no=3)) ) order by table_no,line_no      
         
   If Exists(select * from #bbBSEFO)    
   begin      
    select @tableno=min(table_no) from #bbBSEFO    
   end    
   else    
   begin    
     select 'Not Exists' as checkExist    
     return;      
   end    
       
   select * into #bbBSEFOExpiry from angelcommodity.BSEfo.dbo.broktable where Table_name like 'NORMAL%' and val_perc = 'P' and     
      round_to=4.00 and day_puc = @BSEFOFFu and Line_no=1    
      and Upper_lim=10000000.00    
          
     If Exists(select * from #bbBSEFOExpiry)    
   begin      
     select @tablenoDel=min(table_no) from #bbBSEFOExpiry    
   end    
   else    
   begin    
     select 'Not Exists' as checkExist    
     return;      
   end    
     
  end    
END    
/***************************/  
IF(@Segment='MCX')  
BEGIN  
 if(@MCX1M >0 and @MCX2M >0 and @MCX1Fu >0 and @MCX2Fu>0)  
 begin  
  select @m1=round((@MCX1M/@MCX1Fu)*100,0)  
  select @m2=round((@MCX2M/@MCX2Fu)*100,0)  
    
  select * into #aaMCX from angelcommodity.MCDX.dbo.broktable where table_no in ( select table_no from angelcommodity.MCDX.dbo.broktable   
  where upper_lim=@m1  
  and   
  trd_del = 'F' and (day_puc =@MCX1M and Day_Sales=@MCX1M and Sett_Purch=@MCX1M and sett_sales=@MCX1M) and val_perc = 'V'  and Line_no=1   
  and table_no in (select table_no from angelcommodity.MCDX.dbo.broktable where trd_del = 'F' and (day_puc =@MCX1Fu and Day_Sales=@MCX1Fu  
   and   
  Sett_Purch=@MCX1Fu  
  and sett_sales=@MCX1Fu) and val_perc = 'P'  and Line_no=2 and table_no in ( select table_no from angelcommodity.MCDX.dbo.broktable  
   where upper_lim=@m2 and  
  trd_del = 'S' and   
  (day_puc =@MCX2M  
  and Day_Sales=@MCX2M and Sett_Purch=@MCX2M and sett_sales=@MCX2M) and val_perc = 'V'  and Line_no=3  and table_no in   
  (select table_no from angelcommodity.MCDX.dbo.broktable where trd_del = 'S' and (day_puc = @MCX2Fu and Day_Sales=@MCX2Fu and Sett_Purch=@MCX2Fu   
  and sett_sales=@MCX2Fu)  
  and val_perc = 'P'  and Line_no=4 ) ) ) ) order by table_no,line_no  
    
     If Exists(select * from #aaMCX)  
  begin    
   select @tableno=min(table_no) from #aaMCX  
  end  
  else  
  begin  
   select 'Not Exists' as checkExist  
   return;    
  end  
    
  select * into #aaMCXExpiry from angelcommodity.MCDX.dbo.broktable where Table_name like 'NORMAL%' and val_perc = 'P' and   
  round_to=4.00 and day_puc = @MCX1Fu and Line_no=1  
  and Upper_lim=10000000.00  
    
  If Exists(select * from #aaMCXExpiry)  
  begin    
   select @tablenoDel=min(table_no) from #aaMCXExpiry   
  end  
  else  
  begin  
   select 'Not Exists' as checkExist  
   return;    
  end      
       
 end  
 if (@MCX1M>0 and @MCX1Fu>0 and @MCX2M=0 and @MCX2Fu=0)  
  begin  
   select @m1=round((@MCX1M/@MCX1Fu)*100,0)  
     
   select * into #bbMCX from angelcommodity.MCDX.dbo.broktable where table_no in ( select table_no from angelfo.nsefo.dbo.broktable   
   where upper_lim=@m1 and  
    trd_del = 'F' and (day_puc = @MCX1M and Day_Sales=@MCX1M and Sett_Purch=@MCX1M and   
    sett_sales=@MCX1M)   
    and val_perc = 'V'   and Line_no=1  and table_no in (select table_no from angelcommodity.MCDX.dbo.broktable where trd_del = 'F' and   
    (day_puc = @MCX1Fu  and Day_Sales=@MCX1Fu  
    and Sett_Purch=@MCX1Fu and sett_sales=@MCX1Fu) and val_perc = 'P'  and Line_no=2    
    and table_no in (select table_no from angelcommodity.MCDX.dbo.broktable where trd_del = 'S' and (day_puc = 0 and Day_Sales=0   
   and Sett_Purch=0 and sett_sales=0) and val_perc = 'P' and Line_no=3)) ) order by table_no,line_no    
     
   If Exists(select * from #bbMCX)  
   begin    
    select @tableno=min(table_no) from #bbMCX  
   end  
   else  
   begin  
    select 'Not Exists' as checkExist  
    return;    
   end      
     
   select * into #bbMCXExpiry from angelcommodity.MCDX.dbo.broktable where Table_name like 'NORMAL%' and val_perc = 'P' and   
      round_to=4.00 and day_puc = @MCX1Fu and Line_no=1  
      and Upper_lim=10000000.00  
        
  
   If Exists(select * from #bbMCXExpiry)  
   begin    
        select @tablenoDel=min(table_no) from #bbMCXExpiry   
   end  
   else  
   begin  
    select 'Not Exists' as checkExist  
    return;    
   end          
  end   
END  
IF(@Segment='NCDEX')  
BEGIN  
 if(@NCDX1Min >0 and @NCDX1Fu >0 and @NCDX2Min >0 and @NCDX2Fu>0)  
 begin  
     select @m1=round((@NCDX1Min/@NCDX1Fu)*100,0)  
  select @m2=round((@NCDX2Min/@NCDX2Fu)*100,0)  
    
    select * into #aaNCDEX from angelcommodity.NCDX.dbo.broktable where table_no in ( select table_no from angelcommodity.NCDX.dbo.broktable where   
  upper_lim=@m1 and trd_del = 'F'  
    and (day_puc =@NCDX1Min and Day_Sales=@NCDX1Min and Sett_Purch=@NCDX1Min and sett_sales=@NCDX1Min) and val_perc = 'V' and   
    Line_no=1 and table_no in   
    (select table_no from angelcommodity.NCDX.dbo.broktable where trd_del = 'F' and (day_puc = @NCDX1Fu and Day_Sales=@NCDX1Fu and   
    Sett_Purch=@NCDX1Fu  
  and sett_sales=@NCDX1Fu) and val_perc = 'P' and Line_no=2 and table_no in ( select table_no from angelcommodity.NCDX.dbo.broktable where  upper_lim=@m2 and trd_del = 'S' and   
  (day_puc =@NCDX2Min and Day_Sales=@NCDX2Min and Sett_Purch=@NCDX2Min and sett_sales=@NCDX2Min) and val_perc = 'V' and Line_no=3 and  
   table_no   
  in (select table_no from angelcommodity.NCDX.dbo.broktable where  trd_del = 'S' and (day_puc =@NCDX2Fu and Day_Sales=@NCDX2Fu  
   and Sett_Purch=@NCDX2Fu  
   and sett_sales=@NCDX2Fu) and val_perc = 'P' and Line_no=4  ) ) ) ) order by table_no,line_no  
    
   If Exists(select * from #aaNCDEX)  
   begin    
      select @tableno=min(table_no) from #aaNCDEX  
   end  
   else  
   begin  
    select 'Not Exists' as checkExist  
    return;    
   end    
  
    
  select * into #aaNCDEXExpiry from angelcommodity.NCDX.dbo.broktable where Table_name like 'NORMAL%' and val_perc = 'P' and   
  round_to=4.00 and day_puc = @NCDX1Fu and Line_no=1  
  and Upper_lim=10000000.00  
  
   If Exists(select * from #aaNCDEXExpiry)  
   begin    
    select @tablenoDel=min(table_no) from #aaNCDEXExpiry   
   end  
   else  
   begin  
    select 'Not Exists' as checkExist  
    return;    
   end          
     
 end  
 if (@NCDX1Min >0 and @NCDX1Fu >0 and @NCDX2Min=0 and @NCDX2Fu=0)  
  begin  
    select @m1=round((@NCDX1Min/@NCDX1Fu)*100,0)  
     
   select * into #bbNCDEX from angelcommodity.NCDX.dbo.broktable where table_no in ( select table_no from angelfo.nsefo.dbo.broktable   
   where upper_lim=@m1 and  
    trd_del = 'F' and (day_puc = @NCDX1Min and Day_Sales=@NCDX1Min and Sett_Purch=@NCDX1Min and   
    sett_sales=@NCDX1Min)   
    and val_perc = 'V'   and Line_no=1  and table_no in (select table_no from angelcommodity.NCDX.dbo.broktable where trd_del = 'F' and   
    (day_puc = @NCDX1Fu  and Day_Sales=@NCDX1Fu  
    and Sett_Purch=@NCDX1Fu and sett_sales=@NCDX1Fu) and val_perc = 'P'  and Line_no=2    
    and table_no in (select table_no from angelcommodity.NCDX.dbo.broktable where trd_del = 'S' and (day_puc = 0 and Day_Sales=0   
   and Sett_Purch=0 and sett_sales=0) and val_perc = 'P' and Line_no=3)) ) order by table_no,line_no    
       
   If Exists(select * from #bbNCDEX)  
   begin    
     select @tableno=min(table_no) from #bbNCDEX  
   end  
   else  
   begin  
    select 'Not Exists' as checkExist  
    return;    
   end       
  
     
   select * into #bbNCDEXExpiry from angelcommodity.NCDX.dbo.broktable where Table_name like 'NORMAL%' and val_perc = 'P' and   
      round_to=4.00 and day_puc = @NCDX1Fu and Line_no=1  
      and Upper_lim=10000000.00  
  
   If Exists(select * from #bbNCDEXExpiry)  
   begin    
    select @tablenoDel=min(table_no) from #bbNCDEXExpiry   
   end  
   else  
   begin  
    select 'Not Exists' as checkExist  
    return;    
   end          
        
  end   
END  
IF(@Segment='NSX')  
BEGIN  
 if(@NSX1 >0 and @NSX2 >0)  
 begin  
  select * into #aaNSX from ANGELFO.NSECURFO.dbo.broktable where table_no in (select table_no from ANGELFO.NSECURFO.dbo.broktable where upper_lim>=10000000   
  and upper_lim<=10000000   
  and trd_del = 'F' and (day_puc = @NSX1 and Day_Sales=@NSX1 and Sett_Purch=@NSX1 and sett_sales=@NSX1) and val_perc = 'P' and   
  line_no=1 and table_no in (select table_no from ANGELFO.NSECURFO.dbo.broktable where trd_del = 'S' and   
  (day_puc =@NSX2 and Day_Sales=@NSX2 and   
  Sett_Purch=@NSX2 and sett_sales=@NSX2) and val_perc = 'P' and line_no=2) ) order by table_no,line_no      
    
   If Exists(select * from #aaNSX)  
   begin    
    select @tableno=min(table_no) from #aaNSX  
   end  
   else  
   begin  
    select 'Not Exists' as checkExist  
    return;    
   end      
   
    
  select * into #aaNSXExpiry from angelfo.NSECURFO.dbo.broktable where Table_name like 'NORMAL%' and val_perc = 'P' and   
  round_to=4.00 and day_puc = @NSX1 and Line_no=1  
  and Upper_lim=10000000.00  
    
   If Exists(select * from #aaNSXExpiry)  
   begin    
    select @tablenoDel=min(table_no) from #aaNSXExpiry     
   end  
   else  
   begin  
    select 'Not Exists' as checkExist  
    return;    
   end      
       
     
 end  
 if (@NSX1 >0 and @NSX2=0)  
  begin  
     
  select * into #bbNSX from ANGELFO.NSECURFO.dbo.broktable where table_no in (select table_no from ANGELFO.NSECURFO.dbo.broktable where upper_lim>=10000000   
  and upper_lim<=10000000   
  and trd_del = 'F' and (day_puc =@NSX1 and Day_Sales=@NSX1 and Sett_Purch=@NSX1 and sett_sales=@NSX1) and val_perc = 'P' and   
  line_no=1 and table_no in (select table_no from ANGELFO.NSECURFO.dbo.broktable where trd_del = 'S' and   
  (day_puc =0 and Day_Sales=0 and   
  Sett_Purch=0 and sett_sales=0) and val_perc = 'P' and line_no=2) ) order by table_no,line_no   
    
   If Exists(select * from #bbNSX)  
   begin    
      select @tableno=min(table_no) from #bbNSX  
   end  
   else  
   begin  
    select 'Not Exists' as checkExist  
    return;    
   end     
  
    
  select * into #bbNSXExpiry from angelfo.NSECURFO.dbo.broktable where Table_name like 'NORMAL%' and val_perc = 'P' and   
  round_to=4.00 and day_puc = @NSX1 and Line_no=1  
  and Upper_lim=10000000.00  
    
   If Exists(select * from #bbNSXExpiry)  
   begin     
    select @tablenoDel=min(table_no) from #bbNSXExpiry    
   end  
   else  
   begin  
    select 'Not Exists' as checkExist  
    return;    
   end         
  end   
END  
If(@Segment='NSEOption')  
Begin  
declare @SchemeIDStock as int=0,@SchemeIDNifty as int=0,@SchemeIDBankNifty as int=0,@SchemeNameBankNifty as varchar(100)='',@SchemeNameNifty as varchar(100)='',@SchemeNameStock as varchar(100)=''  
  
 if(@NSEFOOS1>0 and @NSEFOON1>0 and @NSEFOOB1>0 and @NSEFOOS2=0 and @NSEFOON2=0 and @NSEFOOB2=0)  
 begin  
  Set @SchemeIDStock=3  
  Set @SchemeIDNifty=3  
  Set @SchemeIDBankNifty=3  
  set @SchemeNameBankNifty='Max Buy First Leg'  
  set @SchemeNameNifty='Max Buy First Leg'  
  set @SchemeNameStock='Max Buy First Leg'  
 end  
 if(@NSEFOOS1>0 and @NSEFOON1>0 and @NSEFOOB1>0 and @NSEFOOS2>0 and @NSEFOON2>0 and @NSEFOOB2>0)  
 begin  
  Set @SchemeIDStock=10  
  Set @SchemeIDNifty=10  
  Set @SchemeIDBankNifty=10  
  set @SchemeNameBankNifty='Default'  
  set @SchemeNameNifty='Default'  
  set @SchemeNameStock='Default'  
 end  
End  
If(@Segment='NSXOption')  
Begin  
declare @SchemeIDNSX as int=0,@SchemeNameNSX as varchar(100)=''  
  
 if(@NSXO1>0 and @NSXO2=0)  
 begin  
  Set @SchemeIDNSX=3  
  set @SchemeNameNSX='Max Buy First Leg'  
 end  
 if(@NSXO1>0 and @NSXO2>0)  
 begin  
  Set @SchemeIDNSX=10  
  set @SchemeNameNSX='Default'  
 end  
End  
      
      
   /*added on 17 Nov 2017 for removing duplication entries*/  
   if not exists(select * from SB_ClientModiBrk where ClientCode=@ClientCode and segment=@Segment and dateadd(d, datediff(d, 0,UpdatedOn), 0)=dateadd(d, datediff(d, 0, getdate()), 0))      
   /***********************/  
   begin  
		insert into  SB_ClientModiBrk        
	   (ClientCode,Segment,BSEL1,BSEM1,BseP1,BSEL2,BSEM2,BseP2,BSEDel,BSEMDel,BsePDel,NSEL1,NSEM1,NSEP1,NSEL2,NSEM2,NSEP2,NSELDel,NSEMDel,NSEPDel,  
		MCXL1,MCX1M,MCX1Fu,MCXL2,MCX2M,MCX2Fu,NCDX1L,NCDX1Min,NCDX1Fu,NCDX2L,NCDX2Min,NCDX2Fu,NSEFOFL,NSEFOFMin,NSEFOFFu,NSEFOSL,NSEFOSMin,NSEFOSFu,  
		NSX1,NSX2,NSEFOOS1,NSEFOOS2,NSEFOON1,NSEFOON2,NSEFOOB1,NSEFOOB2,NSEFOOFN1,NSEFOOFN2,NSXO1,NSXO2,MCD1,MCD2,MCDO1,MCDO2,UpdatedOn,UpdatedBy,Emailed,TableNoIntr,  
		TableNoDel,SchemeIDStock,SchemeIDNifty,SchemeIDBankNifty,SchemeNameBankNifty,SchemeNameNifty,SchemeNameStock,SchemeIDNSX,
		SchemeNameNSX,BSEFOFL,BSEFOFMin,BSEFOFFu,BSEFOSL,BSEFOSMin,BSEFOSFu,
		BSXOPT_N1,BSXOPT_N2,SX500PT_N1,SX500PT_N2,BSEFOOALL_S1,BSEFOOALL_S2,BKXOPT_B1,BKXOPT_B2)                              
		select @ClientCode,@Segment,@BSEL1,@BSEM1,@BseP1,@BSEL2,@BSEM2,@BseP2,@BSEDel,@BSEMDel,@BsePDel,@NSEL1,@NSEM1,@NSEP1,@NSEL2,@NSEM2,@NSEP2,  
		@NSELDel,@NSEMDel,@NSEPDel,@MCXL1,@MCX1M,@MCX1Fu,@MCXL2,@MCX2M,@MCX2Fu,@NCDX1L,@NCDX1Min,@NCDX1Fu,@NCDX2L,@NCDX2Min,@NCDX2Fu,@NSEFOFL,  
		@NSEFOFMin,@NSEFOFFu,@NSEFOSL,@NSEFOSMin,@NSEFOSFu,@NSX1,@NSX2,@NSEFOOS1,@NSEFOOS2,@NSEFOON1,@NSEFOON2,@NSEFOOB1,@NSEFOOB2,
		@NSEFOOFN1,@NSEFOOFN2,@NSXO1,  
		@NSXO2,@MCD1,@MCD2,@MCDO1,@MCDO2,Getdate(),@UpdatedBy,'N',@tableno,@tablenoDel,@SchemeIDStock,@SchemeIDNifty,@SchemeIDBankNifty,  
		@SchemeNameBankNifty,@SchemeNameNifty,@SchemeNameStock,@SchemeIDNSX,@SchemeNameNSX,
		@BSEFOFL,@BSEFOFMin,@BSEFOFFu,@BSEFOSL,@BSEFOSMin,@BSEFOSFu,
		0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00

		if(@segment='NSEOption')
		begin
		    insert into  SB_ClientModiBrk        
			(ClientCode,Segment,BSEL1,BSEM1,BseP1,BSEL2,BSEM2,BseP2,BSEDel,BSEMDel,BsePDel,NSEL1,NSEM1,NSEP1,NSEL2,NSEM2,NSEP2,NSELDel,NSEMDel,NSEPDel,  
			MCXL1,MCX1M,MCX1Fu,MCXL2,MCX2M,MCX2Fu,NCDX1L,NCDX1Min,NCDX1Fu,NCDX2L,NCDX2Min,NCDX2Fu,NSEFOFL,NSEFOFMin,NSEFOFFu,NSEFOSL,NSEFOSMin,NSEFOSFu,  
			NSX1,NSX2,NSEFOOS1,NSEFOOS2,NSEFOON1,NSEFOON2,NSEFOOB1,NSEFOOB2,NSEFOOFN1,NSEFOOFN2,NSXO1,NSXO2,MCD1,MCD2,MCDO1,MCDO2,UpdatedOn,UpdatedBy,Emailed,TableNoIntr,  
			TableNoDel,SchemeIDStock,SchemeIDNifty,SchemeIDBankNifty,SchemeNameBankNifty,SchemeNameNifty,SchemeNameStock,SchemeIDNSX,
			SchemeNameNSX,BSEFOFL,BSEFOFMin,BSEFOFFu,BSEFOSL,BSEFOSMin,BSEFOSFu,
			BSXOPT_N1,BSXOPT_N2,SX500PT_N1,SX500PT_N2,BSEFOOALL_S1,BSEFOOALL_S2,BKXOPT_B1,BKXOPT_B2)                              
			select @ClientCode,'BSEOption',@BSEL1,@BSEM1,@BseP1,@BSEL2,@BSEM2,@BseP2,@BSEDel,@BSEMDel,@BsePDel,@NSEL1,@NSEM1,@NSEP1,@NSEL2,@NSEM2,@NSEP2,  
			@NSELDel,@NSEMDel,@NSEPDel,@MCXL1,@MCX1M,@MCX1Fu,@MCXL2,@MCX2M,@MCX2Fu,@NCDX1L,@NCDX1Min,@NCDX1Fu,@NCDX2L,@NCDX2Min,@NCDX2Fu,@NSEFOFL,  
			@NSEFOFMin,@NSEFOFFu,@NSEFOSL,@NSEFOSMin,@NSEFOSFu,@NSX1,@NSX2,0.00,0.00,0.00,0.00,0.00,0.00,
			0.00,0.00,@NSXO1,  
			@NSXO2,@MCD1,@MCD2,@MCDO1,@MCDO2,Getdate(),@UpdatedBy,'N',@tableno,@tablenoDel,@SchemeIDStock,@SchemeIDNifty,@SchemeIDBankNifty,  
			@SchemeNameBankNifty,@SchemeNameNifty,@SchemeNameStock,@SchemeIDNSX,@SchemeNameNSX,
			@BSEFOFL,@BSEFOFMin,@BSEFOFFu,@BSEFOSL,@BSEFOSMin,@BSEFOSFu,
			@NSEFOON1,@NSEFOON2,@NSEFOON1,@NSEFOON2,@NSEFOOS1,@NSEFOOS2,@NSEFOOB1,@NSEFOOB2																													
		end

   end  
   if not exists(select * from SB_ClientOldBrok where ClientCode=@ClientCode and segment=@Segment and dateadd(d, datediff(d, 0,UpdatedOn), 0)=dateadd(d, datediff(d, 0, getdate()), 0))      
   begin     
		insert into SB_ClientOldBrok  
		(ClientCode,Segment,BSEM1_Old,BseP1_Old,BSEM2_Old,BseP2_Old,BSEMDel_Old,BsePDel_Old,NSEM1_Old,NSEP1_Old,NSEM2_Old,NSEP2_Old,NSEMDel_Old,  
		NSEPDel_Old,MCX1M_Old,MCX1Fu_Old,MCX2M_Old,MCX2Fu_Old,NCDX1Min_Old,NCDX1Fu_Old,NCDX2Min_Old,NCDX2Fu_Old,NSEFOFL_Old,NSEFOFMin_Old,NSEFOFFu_Old,  
		NSEFOSL_Old,NSEFOSMin_Old,NSEFOSFu_Old,NSX1_Old,NSX2_Old,NSEFOOS1_Old,NSEFOOS2_Old,NSEFOON1_Old,NSEFOON2_Old,NSEFOOB1_Old,NSEFOOB2_Old,NSEFOOFN1_Old,NSEFOOFN2_Old,  
		NSXO1_Old,NSXO2_Old,MCD1_Old,MCD2_Old,MCDO1_Old,MCDO2_Old,UpdatedOn,UpdatedBy,Email,TableNoIntr,TableNoDel,BSEFOFL_Old,BSEFOFMin_Old,
		BSEFOFFu_Old,BSEFOSL_Old,BSEFOSMin_Old,BSEFOSFu_Old,
		BSXOPT_N1_Old,BSXOPT_N2_Old,SX500PT_N1_Old,SX500PT_N2_Old,BSEFOOALL_S1_Old,BSEFOOALL_S2_Old,BKXOPT_B1_Old,BKXOPT_B2_Old
		)  
		select @ClientCode,@Segment,@BSEM1_Old,@BseP1_Old,@BSEM2_Old,@BseP2_Old,@BSEMDel_Old,@BsePDel_Old,@NSEM1_Old,@NSEP1_Old,@NSEM2_Old,@NSEP2_Old,@NSEMDel_Old,  
		@NSEPDel_Old,@MCX1M_Old,@MCX1Fu_Old,@MCX2M_Old,@MCX2Fu_Old,@NCDX1Min_Old,@NCDX1Fu_Old,@NCDX2Min_Old,@NCDX2Fu_Old,@NSEFOFL_Old,@NSEFOFMin_Old,@NSEFOFFu_Old,  
		@NSEFOSL_Old,@NSEFOSMin_Old,@NSEFOSFu_Old,@NSX1_Old,@NSX2_Old,@NSEFOOS1_Old,@NSEFOOS2_Old,@NSEFOON1_Old,@NSEFOON2_Old,@NSEFOOB1_Old,@NSEFOOB2_Old,@NSEFOOFN1_Old,@NSEFOOFN2_Old,  
		@NSXO1_Old,@NSXO2_Old,@MCD1_Old,@MCD2_Old,@MCDO1_Old,@MCDO2_Old,Getdate(),@UpdatedBy,'N',@tableno,@tablenoDel
		,@BSEFOFL_Old,@BSEFOFMin_Old,
		@BSEFOFFu_Old,@BSEFOSL_Old,@BSEFOSMin_Old,@BSEFOSFu_Old,
		0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
		
		if(@Segment='NSEOption')
		begin
		    insert into SB_ClientOldBrok
			(ClientCode,Segment,BSEM1_Old,BseP1_Old,BSEM2_Old,BseP2_Old,BSEMDel_Old,BsePDel_Old,NSEM1_Old,NSEP1_Old,NSEM2_Old,NSEP2_Old,NSEMDel_Old,  
			NSEPDel_Old,MCX1M_Old,MCX1Fu_Old,MCX2M_Old,MCX2Fu_Old,NCDX1Min_Old,NCDX1Fu_Old,NCDX2Min_Old,NCDX2Fu_Old,NSEFOFL_Old,NSEFOFMin_Old,NSEFOFFu_Old,  
			NSEFOSL_Old,NSEFOSMin_Old,NSEFOSFu_Old,NSX1_Old,NSX2_Old,NSEFOOS1_Old,NSEFOOS2_Old,NSEFOON1_Old,NSEFOON2_Old,NSEFOOB1_Old,NSEFOOB2_Old,NSEFOOFN1_Old,NSEFOOFN2_Old,  
			NSXO1_Old,NSXO2_Old,MCD1_Old,MCD2_Old,MCDO1_Old,MCDO2_Old,UpdatedOn,UpdatedBy,Email,TableNoIntr,TableNoDel,BSEFOFL_Old,BSEFOFMin_Old,
			BSEFOFFu_Old,BSEFOSL_Old,BSEFOSMin_Old,BSEFOSFu_Old,
			BSXOPT_N1_Old,BSXOPT_N2_Old,SX500PT_N1_Old,SX500PT_N2_Old,BSEFOOALL_S1_Old,BSEFOOALL_S2_Old,BKXOPT_B1_Old,BKXOPT_B2_Old
			)  
			select @ClientCode,'BSEOption',@BSEM1_Old,@BseP1_Old,@BSEM2_Old,@BseP2_Old,@BSEMDel_Old,@BsePDel_Old,@NSEM1_Old,@NSEP1_Old,@NSEM2_Old,@NSEP2_Old,@NSEMDel_Old,  
			@NSEPDel_Old,@MCX1M_Old,@MCX1Fu_Old,@MCX2M_Old,@MCX2Fu_Old,@NCDX1Min_Old,@NCDX1Fu_Old,@NCDX2Min_Old,@NCDX2Fu_Old,@NSEFOFL_Old,@NSEFOFMin_Old,@NSEFOFFu_Old,  
			@NSEFOSL_Old,@NSEFOSMin_Old,@NSEFOSFu_Old,@NSX1_Old,@NSX2_Old,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,  
			@NSXO1_Old,@NSXO2_Old,@MCD1_Old,@MCD2_Old,@MCDO1_Old,@MCDO2_Old,Getdate(),@UpdatedBy,'N',@tableno,@tablenoDel
			,@BSEFOFL_Old,@BSEFOFMin_Old,
			@BSEFOFFu_Old,@BSEFOSL_Old,@BSEFOSMin_Old,@BSEFOSFu_Old,
			@NSEFOON1_Old,@NSEFOON2_Old,@NSEFOON1_Old,@NSEFOON2_Old,@NSEFOOS1_Old,@NSEFOOS2_Old,@NSEFOOB1_Old,@NSEFOOB2_Old
		end
  end    
   --end  
   --exec SB_Brokerage_Mail @ClientCode,@Segment,@BSEM1,@BseP1,@BSEM2,@BseP2,@BSEMDel,@BsePDel,@NSEM1,@BseP1,@NSEP1,@NSEM2,@NSEP2,@NSEMDel,@NsePDel,@NSEFOFMin,@NSEFOFFu,@NSEFOSMin,@NSEFOSFu,@MCX1M,@MCX1Fu,@MCX2M,@MCX2Fu,@NCDX1Min,@NCDX1Fu,@NCDX2Min,@NCDX2Fu,@NSX1,@NSX2,@MCD1,@MCD2      
  /*  commented on 15 Sep 2016  
   if(@Segment='BSECM')  
   begin  
 exec SB_Brokerage_Mail_BSE @ClientCode,@Segment,@BSEM1,@BseP1,@BSEM2,@BseP2,@BSEMDel,@BsePDel   
   end    
      if(@Segment='NSECM')  
   begin  
 exec SB_Brokerage_Mail_NSE @ClientCode,@Segment,@BSEM1,@BseP1,@BSEM2,@BseP2,@NSEMDel,@NsePDel   
   end   
      if(@Segment='NSEFO')  
   begin  
 exec SB_Brokerage_Mail_NSEFO @ClientCode,@Segment,@NSEFOFMin,@NSEFOFFu,@NSEFOSMin,@NSEFOSFu   
   end   
      if(@Segment='MCX')  
   begin  
 exec SB_Brokerage_Mail_MCX @ClientCode,@Segment,@MCX1M,@MCX1Fu,@MCX2M,@MCX2Fu   
   end   
      if(@Segment='NCDX')  
   begin  
 exec SB_Brokerage_Mail_NCDX @ClientCode,@Segment,@NCDX1Min,@NCDX1Fu,@NCDX2Min,@NCDX2Fu   
   end   
      if(@Segment='NSX')  
   begin  
 exec SB_Brokerage_Mail_NSX @ClientCode,@Segment,@NSX1,@NSX2  
   end   
      if(@Segment='MCD')  
   begin  
 exec SB_Brokerage_Mail_MCD @ClientCode,@Segment,@MCD1,@MCD2  
   end  
   if(@Segment='NSXOption')  
   begin  
 exec SB_Brokerage_Mail_NSXOption  @ClientCode,@Segment,@NSXO1,@NSXO2  
   end  
     
   if(@Segment='NSEFOOption')  
   begin  
   exec SB_Brokerage_Mail_NSEFOOption   @ClientCode,@Segment,@NSEFOOS1,@NSEFOOS2,@NSEFOON1,@NSEFOON2,@NSEFOOB1,@NSEFOOB2                    
    end   
    */           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_ClientBrokValdation_Ipartner_NXT_UAT_Live_05Apr2024
-- --------------------------------------------------
/*
EXEC [SB_ClientBrokValdation_Ipartner_NXT_UAT]  @ClientCode = 'rcb328', @Segment = 'NSEOption',  
@NSEFOOS1 = 100,@NSEFOON1 = 1, @NSEFOOB1 = 5,@FlagNSEoptS = 'Disable',@FlagNSEoptN = 'Disable',
@FlagNSEoptB = 'Disable'
*/

create PROCEDURE [dbo].[SB_ClientBrokValdation_Ipartner_NXT_UAT_Live_05Apr2024] (  
@ClientCode as varchar(50),@FlagF as varchar(50)='',@FlagS as varchar(50)='',@FlagNSEF as varchar(50)='',@FlagNSES as varchar(50)='',  
@FlagNSEFOF as varchar(50)='',@FlagNSEFOS as varchar(50)='',@FlagBSEFOF as varchar(50)='',@FlagBSEFOS as varchar(50)='',
@FlagMCXF as varchar(50)='',@FlagMCXS as varchar(50)='',  
@FlagNCDXF as varchar(50)='',@FlagNCDXS as varchar(50)='',@FlagNSXS as varchar(50)='',  
@FlagMCDS as varchar(50)='',@FlagNSEoptS as varchar(50)='',@FlagNSEoptN as varchar(50)='',@FlagNSEoptB as varchar(50)='',@FlagNSEoptFN as varchar(50)='',@FlagNSXoptS as varchar(50)='',  
@Segment as varchar(50),@BSEM1 as money=0.00,@BseP1 as money=0.00,@BSEM2 as money=0.00,    
@BseP2 as money=0.00,@BSEMDel as money=0.00,@BsePDel as money=0.00,@NSEM1 as money=0.00,  
@NSEP1 as money=0.00,@NSEM2 as money=0.00,@NSEP2 as money=0.00,    
@NSEMDel as money=0.00,@NSEPDel as money=0.00,@MCX1M as money=0.00,@MCX1Fu as money=0.00,@MCX2M as money=0.00,@MCX2Fu as money=0.00,  
@NCDX1Min as money=0.00,@NCDX1Fu as money=0.00 ,  
@NCDX2Min as money=0.00,@NCDX2Fu as money=0.00,  
@NSEFOFMin as money=0.00,@NSEFOFFu as money=0.00,@NSEFOSMin as money=0.00,@NSEFOSFu as money=0.00,
@BSEFOFMin as money=0.00,@BSEFOFFu as money=0.00,@BSEFOSMin as money=0.00,@BSEFOSFu as money=0.00,  
@NSX1 as money=0.00,@NSX2 as money=0.00,@NSEFOOS1 as money=0.00,@NSEFOOS2 as money=0.00,@NSEFOON1 as money=0.00,@NSEFOON2 as money=0.00 ,  
@NSEFOOB1 as money=0.00,@NSEFOOB2 as money=0.00,@NSEFOOFN1 as money=0.00,@NSEFOOFN2 as money=0.00,@NSXO1 as money=0.00,@NSXO2 as money=0.00,@MCD1 as money=0.00,@MCD2 as money=0.00,   
@MCDO1 as money=0.00,@MCDO2 as money=0.00)  
AS
BEGIN
CREATE TABLE #allResult (
result varchar(100)
)

Insert into #allResult
EXEC SB_ClientBrokValdation_Ipartner_UAT_live @ClientCode ,@FlagF ,@FlagS ,@FlagNSEF ,@FlagNSES ,  
@FlagNSEFOF ,@FlagNSEFOS ,@FlagBSEFOF ,@FlagBSEFOS ,@FlagMCXF ,@FlagMCXS ,  
@FlagNCDXF ,@FlagNCDXS ,@FlagNSXS ,  
@FlagMCDS ,@FlagNSEoptS ,@FlagNSEoptN ,@FlagNSEoptFN,@FlagNSEoptB ,@FlagNSXoptS ,
@Segment ,@BSEM1 ,@BseP1 ,@BSEM2 ,    
@BseP2 ,@BSEMDel ,@BsePDel ,@NSEM1 ,  
@NSEP1 ,@NSEM2 ,@NSEP2 ,    
@NSEMDel ,@NSEPDel ,@MCX1M ,@MCX1Fu ,@MCX2M ,@MCX2Fu ,  
@NCDX1Min ,@NCDX1Fu  ,  
@NCDX2Min ,@NCDX2Fu ,  
@NSEFOFMin ,@NSEFOFFu ,@NSEFOSMin ,@NSEFOSFu ,
@BSEFOFMin ,@BSEFOFFu ,@BSEFOSMin ,@BSEFOSFu ,  
@NSX1 ,@NSX2 ,@NSEFOOS1 ,@NSEFOOS2 ,@NSEFOON1 ,@NSEFOON2  ,  
@NSEFOOB1 ,@NSEFOOB2,@NSEFOOFN1 ,@NSEFOOFN2 ,@NSXO1 ,@NSXO2 ,@MCD1 ,@MCD2 ,   
@MCDO1 ,@MCDO2 

SELECT * FROM #allResult
DROP TABLE #allResult
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_ClientBrokValdation_Ipartner_UAT_live_05Apr2024
-- --------------------------------------------------
create procedure [dbo].[SB_ClientBrokValdation_Ipartner_UAT_live_05Apr2024] (  
@ClientCode as varchar(50),@FlagF as varchar(50)='',@FlagS as varchar(50)='',@FlagNSEF as varchar(50)='',@FlagNSES as varchar(50)='',  
@FlagNSEFOF as varchar(50)='',@FlagNSEFOS as varchar(50)='',@FlagBSEFOF as varchar(50)='',@FlagBSEFOS as varchar(50)='',
@FlagMCXF as varchar(50)='',@FlagMCXS as varchar(50)='',  
@FlagNCDXF as varchar(50)='',@FlagNCDXS as varchar(50)='',@FlagNSXS as varchar(50)='',  
@FlagMCDS as varchar(50)='',@FlagNSEoptS as varchar(50)='',@FlagNSEoptN as varchar(50)='',@FlagNSEoptFN as varchar(50)='',@FlagNSEoptB as varchar(50)='',@FlagNSXoptS as varchar(50)='',  
@Segment as varchar(50),@BSEM1 as money=0.00,@BseP1 as money=0.00,@BSEM2 as money=0.00,    
@BseP2 as money=0.00,@BSEMDel as money=0.00,@BsePDel as money=0.00,@NSEM1 as money=0.00,  
@NSEP1 as money=0.00,@NSEM2 as money=0.00,@NSEP2 as money=0.00,    
@NSEMDel as money=0.00,@NSEPDel as money=0.00,
@MCX1M as money=0.00,@MCX1Fu as money=0.00,@MCX2M as money=0.00,@MCX2Fu as money=0.00,  
@NCDX1Min as money=0.00,@NCDX1Fu as money=0.00 ,  
@NCDX2Min as money=0.00,@NCDX2Fu as money=0.00,  
@NSEFOFMin as money=0.00,@NSEFOFFu as money=0.00,@NSEFOSMin as money=0.00,@NSEFOSFu as money=0.00,
@BSEFOFMin as money=0.00,@BSEFOFFu as money=0.00,@BSEFOSMin as money=0.00,@BSEFOSFu as money=0.00,  
@NSX1 as money=0.00,@NSX2 as money=0.00,@NSEFOOS1 as money=0.00,@NSEFOOS2 as money=0.00,@NSEFOON1 as money=0.00,@NSEFOON2 as money=0.00 ,  
@NSEFOOB1 as money=0.00,@NSEFOOB2 as money=0.00,@NSEFOOFN1 as money=0.00,@NSEFOOFN2 as money=0.00,@NSXO1 as money=0.00,@NSXO2 as money=0.00,@MCD1 as money=0.00,@MCD2 as money=0.00,   
@MCDO1 as money=0.00,@MCDO2 as money=0.00)  
as                                  
set nocount on                                    
      
If(@Segment='BSECM')  
BEGIN  
 If Exists(select * from mis.remisior.dbo.remimast_bsecm where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate())  
 begin  
 print @ClientCode  
  declare @Std_rate as int,@Brok1_TableNo as int,@trd_min as money,@del_min as money,@ClientLevelBrok as money,@ClientLevelBrokD as money,@message as varchar(max)  
  set @message=''  
  select * into #bsecm from mis.remisior.dbo.remimast_bsecm where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate()  
    
  select @Std_rate=Std_rate,@Brok1_TableNo=Brok1_TableNo from #bsecm  
  print 'hi1111'  
  print @Std_rate  
  print @Brok1_TableNo  
  if(@Std_rate=60 and @Brok1_TableNo=60)  
  begin  
  print 'hi1111'  
   select @trd_min=trd_min,@del_min=del_min from #bsecm  
    print @trd_min  
  print @del_min  
   if(@trd_min=0 and @del_min=0)  
   begin  
   print 'hi'  
    select @ClientLevelBrok=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityTrading'  
    select @ClientLevelBrokD=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityDelivery'  
    if(@FlagF='Disable' or @FlagS='Disable')  
    begin  
     if(@BSEM1<@ClientLevelBrok or @BseP1<@ClientLevelBrok OR @BSEMDel<@ClientLevelBrok or @BsePDel<@ClientLevelBrokD)  
     begin  
      set @message='You cannot charge brokerage less than angel capping.'  
      select @message  
     end  
     else  
     Begin  
      set  @message='Proper'  
      select  @message  
     End  
    end  
    else  
    begin  
     if(@BSEM1<@ClientLevelBrok or @BseP1<@ClientLevelBrok or @BSEM2<@ClientLevelBrok or @BseP2<@ClientLevelBrok   
     OR @BSEMDel<@ClientLevelBrok or @BsePDel<@ClientLevelBrokD)  
     begin  
     set @message='You cannot charge brokerage less than angel capping.'  
     select @message  
     end  
     else  
     Begin  
     set  @message='Proper'  
     select  @message  
     End  
    end  
   end   
   else   
   begin  
   print 'bye'  
    if(@FlagF='Disable' or @FlagS='Disable')  
    begin  
     if(@BSEM1<@trd_min or @BseP1<@trd_min or @BSEMDel<@trd_min or @BsePDel<@del_min)  
     begin  
      set @message='Brokerage is incorrect'  
      select @message  
     end  
     else  
     Begin  
      set  @message='Proper'  
      select  @message  
     End  
    end  
    else  
    begin  
     if(@BSEM1<@trd_min or @BseP1<@trd_min or @BSEM2<@trd_min or @BseP2<@trd_min   
     or @BSEMDel<@trd_min or @BsePDel<@del_min)  
     begin  
      set @message='Brokerage for trd min and del min is incorrect'  
      select @message  
     end  
       else  
     Begin  
      set  @message='Proper'  
      select  @message  
     End  
    end   
   end  
  end  
  else  
  begin  
  declare @Day_pucVF as money,@NORMALV as money,@Day_pucPF as money  
  declare @Day_pucVS as money,@NORMALP as money,@Day_pucPS as money  
    
   select @Day_pucVF=Day_puc from AngelBSECM.bsedb_ab.dbo.broktable where table_no=@Std_rate and Val_perc='V' and Trd_Del='F'  
   select @Day_pucPF=Day_puc from AngelBSECM.bsedb_ab.dbo.broktable where table_no=@Std_rate and Val_perc='P' and Trd_Del='F'  
   select @Day_pucVS=Day_puc from AngelBSECM.bsedb_ab.dbo.broktable where table_no=@Std_rate and Val_perc='V' and Trd_Del='S'  
   select @Day_pucPS=Day_puc from AngelBSECM.bsedb_ab.dbo.broktable where table_no=@Std_rate and Val_perc='P' and Trd_Del='S'  
     
   select @NORMALV=NORMAL from AngelBSECM.bsedb_ab.dbo.broktable where table_no=@Brok1_TableNo and Val_perc='V' and Trd_Del='D'  
   select @NORMALP=NORMAL from AngelBSECM.bsedb_ab.dbo.broktable where table_no=@Brok1_TableNo and Val_perc='P' and Trd_Del='D'  
  
   print 'hiueee'  
   if(@FlagF='Disable' or @FlagS='Disable')  
    begin  
     if(@BSEM1<@Day_pucVF or @BseP1<@Day_pucPF   
     or @BSEMDel<@NORMALV or @BsePDel<@NORMALP)  
     begin  
      set @message='Brokerage is incorrect'  
      select @message  
     end  
     else  
     Begin  
      set  @message='Proper'  
      select  @message  
     End  
    end  
    else  
    begin  
    if(@BSEM1<@Day_pucVF or @BseP1<@Day_pucPF or @BSEM2<@Day_pucVS or @BseP2<@Day_pucPS   
     or @BSEMDel<@NORMALV or @BsePDel<@NORMALP)  
     Begin  
      set @message='You cannot charge brokerage less than angel capping.'  
      select @message  
     End  
     else  
     Begin  
      set  @message='Proper'  
      select  @message  
     End  
    end   
  end  
 end  
 else  
 begin  
  If Exists(select * from mis.remisior.dbo.remimast_bsecm where party_code=@ClientCode and Calctype='' and ExceptClient='Yes' and todate>getdate())  
  begin  
   select @ClientLevelBrok=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityTrading'  
   select @ClientLevelBrokD=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityDelivery'  
   if(@FlagF='Disable' or @FlagS='Disable')  
   begin  
    if(@BSEM1<@ClientLevelBrok or @BseP1<@ClientLevelBrok or @BSEMDel<@ClientLevelBrok or @BsePDel<@ClientLevelBrokD)  
    begin  
     set @message='You cannot charge brokerage less than angel capping.'  
     select @message  
    end  
    else  
    Begin  
     set  @message='Proper'  
     select  @message  
    End  
   end  
   else  
   begin  
    if(@BSEM1<@ClientLevelBrok or @BseP1<@ClientLevelBrok or @BSEM2<@ClientLevelBrok or @BseP2<@ClientLevelBrok   
    OR @BSEMDel<@ClientLevelBrok or @BsePDel<@ClientLevelBrokD)  
    begin  
     set @message='You cannot charge brokerage less than angel capping.'  
     select @message  
    end  
    else  
    Begin  
     set  @message='Proper'  
     select  @message  
    End  
   end  
  end  
 end  
END  
If(@Segment='NSECM')  
Begin  
 If Exists(select * from mis.remisior.dbo.remimast_nsecm where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate())  
 begin  
  declare @Std_rate_NSE as int,@Brok1_TableNo_NSE as int,@trd_min_NSE as money,@del_min_NSE as money,@ClientLevelBrokT_NSE as money,@ClientLevelBrokD_NSE as money,@messageNSE as varchar(max)  
  set @messageNSE=''  
  select * into #nsecm from mis.remisior.dbo.remimast_nsecm where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate()  
    
  select @Std_rate_NSE=Std_rate,@Brok1_TableNo_NSE=Brok1_TableNo from #nsecm  
  
  if(@Std_rate_NSE=60 and @Brok1_TableNo_NSE=60)  
  begin  
   select @trd_min_NSE=trd_min,@del_min_NSE=del_min from #nsecm  
   if(@trd_min_NSE=0 and @del_min_NSE=0)  
   begin  
    select @ClientLevelBrokT_NSE=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityTrading'  
    select @ClientLevelBrokD_NSE=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityDelivery'  
    if(@FlagNSEF='Disable' or @FlagNSES='Disable')  
    begin  
     if(@NSEM1<@ClientLevelBrokT_NSE or @NSEP1<@ClientLevelBrokT_NSE OR @NSEMDel<@ClientLevelBrokT_NSE or @NSEPDel<@ClientLevelBrokD_NSE)  
     begin  
      set @messageNSE='You cannot charge brokerage less than angel capping.'  
      select @messageNSE  
     end  
     else  
     Begin  
      set  @messageNSE='Proper'  
      select  @messageNSE  
     End  
    end  
    else  
    begin  
     if(@NSEM1<@ClientLevelBrokT_NSE or @NSEP1<@ClientLevelBrokT_NSE or @NSEM2<@ClientLevelBrokT_NSE or @NSEP2<@ClientLevelBrokT_NSE   
     or @NSEMDel<@ClientLevelBrokT_NSE or @NSEPDel<@ClientLevelBrokD_NSE)  
     begin  
     set @messageNSE='You cannot charge brokerage less than angel capping.'  
     select @messageNSE  
     end  
     else  
     Begin  
     set  @messageNSE='Proper'  
     select  @messageNSE  
     End  
    end  
   end   
   else   
   begin  
    if(@FlagNSEF='Disable' or @FlagNSES='Disable')  
    begin  
     if(@NSEM1<@trd_min_NSE or @NSEP1<@trd_min_NSE or @NSEMDel<@trd_min_NSE or @NSEPDel<@del_min_NSE)  
     begin  
      set @messageNSE='Brokerage is incorrect'  
      select @messageNSE  
     end  
     else  
     Begin  
      set  @messageNSE='Proper'  
      select  @messageNSE  
     End  
    end  
    else  
    begin  
     if(@NSEM1<@trd_min_NSE or @NSEP1<@trd_min_NSE or @NSEM2<@trd_min_NSE or @NSEP2<@trd_min_NSE   
     or @NSEMDel<@trd_min_NSE or @NSEPDel<@del_min_NSE)  
     begin  
        set @messageNSE='Brokerage for trd min and del min is incorrect'  
        select @messageNSE  
       end  
       else  
     Begin  
     set  @messageNSE='Proper'  
     select  @messageNSE  
     End  
    end   
   end  
  end  
  else  
  begin  
  declare @Day_pucVF_NSE as money,@NORMALV_NSE as money,@Day_pucPF_NSE as money  
  declare @Day_pucVS_NSE as money,@NORMALP_NSE as money,@Day_pucPS_NSE as money  
    
   select @Day_pucVF_NSE=Day_puc from AngelNseCM.msajag.DBO.broktable where table_no=@Std_rate_NSE and Val_perc='V' and Trd_Del='F'  
   select @Day_pucPF_NSE=Day_puc from AngelNseCM.msajag.DBO.broktable where table_no=@Std_rate_NSE and Val_perc='P' and Trd_Del='F'  
   select @Day_pucVS_NSE=Day_puc from AngelNseCM.msajag.DBO.broktable where table_no=@Std_rate_NSE and Val_perc='V' and Trd_Del='S'  
   select @Day_pucPS_NSE=Day_puc from AngelNseCM.msajag.DBO.broktable where table_no=@Std_rate_NSE and Val_perc='P' and Trd_Del='S'  
     
   select @NORMALV_NSE=NORMAL from AngelNseCM.msajag.DBO.broktable where table_no=@Brok1_TableNo_NSE and Val_perc='V' and Trd_Del='D'  
   select @NORMALP_NSE=NORMAL from AngelNseCM.msajag.DBO.broktable where table_no=@Brok1_TableNo_NSE and Val_perc='P' and Trd_Del='D'  
    
   if(@FlagNSEF='Disable' or @FlagNSES='Disable')  
    begin  
     if(@NSEM1<@Day_pucVF_NSE or @NSEP1<@Day_pucPF_NSE or @NSEMDel<@NORMALV_NSE or @NSEPDel<@NORMALP_NSE)  
     begin  
      set @messageNSE='Brokerage is incorrect'  
      select @messageNSE  
     end  
     else  
     Begin  
      set  @messageNSE='Proper'  
      select  @messageNSE  
     End  
    end  
    else  
    begin  
    if(@NSEM1<@Day_pucVF_NSE or @NSEP1<@Day_pucPF_NSE or @NSEM2<@Day_pucVS_NSE or @NSEP2<@Day_pucPS_NSE   
     or @NSEMDel<@NORMALV_NSE or @NSEPDel<@NORMALP_NSE)  
     Begin  
     set @messageNSE='You cannot charge brokerage less than angel capping.'  
     select @messageNSE  
     End  
     else  
     Begin  
     set  @messageNSE='Proper'  
     select  @messageNSE  
     End  
    end   
  end  
 end  
else  
 begin  
  If Exists(select * from mis.remisior.dbo.remimast_nsecm where party_code=@ClientCode and Calctype='' and ExceptClient='Yes' and todate>getdate())  
  begin  
   select @ClientLevelBrokT_NSE=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityTrading'  
   select @ClientLevelBrokD_NSE=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityDelivery'  
   if(@FlagNSEF='Disable' or @FlagNSES='Disable')  
   begin  
    if(@NSEM1<@ClientLevelBrokT_NSE or @NSEP1<@ClientLevelBrokT_NSE or @NSEMDel<@ClientLevelBrokT_NSE or @NSEPDel<@ClientLevelBrokD_NSE)  
    begin  
     set @messageNSE='You cannot charge brokerage less than angel capping.'  
     select @messageNSE  
    end  
    else  
    Begin  
     set  @messageNSE='Proper'  
     select  @messageNSE  
    End  
   end  
   else  
   begin  
    if(@NSEM1<@ClientLevelBrokT_NSE or @NSEP1<@ClientLevelBrokT_NSE or @NSEM2<@ClientLevelBrokT_NSE or @NSEP2<@ClientLevelBrokT_NSE   
    OR @NSEMDel<@ClientLevelBrokT_NSE or @NSEPDel<@ClientLevelBrokD_NSE)  
    begin  
     set @messageNSE='You cannot charge brokerage less than angel capping.'  
     select @messageNSE  
    end  
    else  
    Begin  
     set  @messageNSE='Proper'  
     select  @messageNSE  
    End  
   end  
  end  
 end  
END  
If(@Segment='NSEFO')  
Begin  
 If Exists(select * from mis.remisior.dbo.remimast_nsefo where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate())  
 begin  
  declare @Std_rate_NSEFO as int,@Brok1_TableNo_NSEFO as int,@trd_min_NSEFO as money,@del_min_NSEFO as money,@ClientLevelBrokT_NSEFO as money,@ClientLevelBrokD_NSEFO as money,@messageNSEFO as varchar(max)  
  set @messageNSEFO=''  
  select * into #nseFO from mis.remisior.dbo.remimast_nsefo where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate()  
    
  select @Std_rate_NSEFO=Std_rate,@Brok1_TableNo_NSEFO=Brok1_TableNo from #nseFO  
  
  if(@Std_rate_NSEFO=60 /*and @Brok1_TableNo_NSEFO=60*/)  
  begin  
   select @trd_min_NSEFO=trd_min/*,@del_min_NSEFO=del_min*/ from #nseFO  
   if(@trd_min_NSEFO=0 /*and @del_min_NSEFO=0*/)  
   begin  
    select @ClientLevelBrokT_NSEFO=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityTrading'  
    if(@FlagNSEFOF='Disable' or @FlagNSEFOS='Disable')  
    begin  
     if(@NSEFOFMin<@ClientLevelBrokT_NSEFO or @NSEFOFFu<@ClientLevelBrokT_NSEFO)  
     begin  
      set @messageNSEFO='You cannot charge brokerage less than angel capping.'  
      select @messageNSEFO  
     end  
     else  
     Begin  
      set  @messageNSEFO='Proper'  
      select  @messageNSEFO  
     End  
    end  
    else  
    begin  
     if(@NSEFOFMin<@ClientLevelBrokT_NSEFO or @NSEFOFFu<@ClientLevelBrokT_NSEFO or @NSEFOSMin<@ClientLevelBrokT_NSEFO or @NSEFOSFu<@ClientLevelBrokT_NSEFO)  
     begin  
      set @messageNSEFO='You cannot charge brokerage less than angel capping.'  
      select @messageNSEFO  
     end  
     else  
     Begin  
      set  @messageNSEFO='Proper'  
      select  @messageNSEFO  
     End  
    end  
   end   
   else   
   begin  
    if(@FlagNSEFOF='Disable' or @FlagNSEFOS='Disable')  
    begin  
     if(@NSEFOFMin<@trd_min_NSEFO or @NSEFOFFu<@trd_min_NSEFO )  
     begin  
      set @messageNSEFO='Brokerage is incorrect'  
      select @messageNSEFO  
     end  
     else  
     Begin  
      set  @messageNSEFO='Proper'  
      select  @messageNSEFO  
     End  
    end  
    else  
    begin  
     if(@NSEFOFMin<@trd_min_NSEFO or @NSEFOFFu<@trd_min_NSEFO or @NSEFOSMin<@trd_min_NSEFO or @NSEFOSFu<@trd_min_NSEFO )  
     begin  
        set @messageNSEFO='Brokerage for trd min and del min is incorrect'  
        select @messageNSEFO  
       end  
       else  
     Begin  
     set  @messageNSEFO='Proper'  
     select  @messageNSEFO  
     End  
    end   
   end  
  end  
  else  
  begin  
  declare @Day_pucVF_NSEFO as money,@Day_pucPF_NSEFO as money, @Day_pucVS_NSEFO as money,@Day_pucPS_NSEFO as money  
    
   select @Day_pucVF_NSEFO=Day_puc from angelfo.nsefo.dbo.broktable where table_no=@Std_rate_NSEFO and Val_perc='V' and trd_del='F'  
   select @Day_pucPF_NSEFO=Day_puc from angelfo.nsefo.dbo.broktable where table_no=@Std_rate_NSEFO and Val_perc='P' and trd_del='F'  
     
   select @Day_pucVS_NSEFO=Day_puc from angelfo.nsefo.dbo.broktable where table_no=@Std_rate_NSEFO and Val_perc='V' and trd_del='S'  
   select @Day_pucPS_NSEFO=Day_puc from angelfo.nsefo.dbo.broktable where table_no=@Std_rate_NSEFO and Val_perc='P' and trd_del='S'     
      
    if(@FlagNSEFOF='Disable' or @FlagNSEFOS='Disable')  
    begin  
     if(@NSEFOFMin<@Day_pucVF_NSEFO or @NSEFOFFu<@Day_pucPF_NSEFO)  
     begin  
      set @messageNSEFO='Brokerage is incorrect'  
      select @messageNSEFO  
     end  
     else  
     Begin  
      set  @messageNSEFO='Proper'  
      select  @messageNSEFO  
     End  
    end  
    else  
    begin  
     if(@NSEFOFMin<@Day_pucVF_NSEFO or @NSEFOFFu<@Day_pucPF_NSEFO or @NSEFOSMin<@Day_pucVS_NSEFO or @NSEFOSFu<@Day_pucPS_NSEFO)  
     Begin  
     set @messageNSEFO='You cannot charge brokerage less than angel capping.'  
     select @messageNSEFO  
     End  
     else  
     Begin  
     set  @messageNSEFO='Proper'  
     select  @messageNSEFO  
     End  
    end  
  end  
 end  
else  
 begin  
  If Exists(select * from mis.remisior.dbo.remimast_nsefo where party_code=@ClientCode and Calctype='' and ExceptClient='Yes' and todate>getdate())  
  begin  
   select @ClientLevelBrokT_NSEFO=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityTrading'  
   if(@FlagNSEFOF='Disable' or @FlagNSEFOS='Disable')  
   begin  
    if(@NSEFOFMin<@ClientLevelBrokT_NSEFO or @NSEFOFFu<@ClientLevelBrokT_NSEFO )  
    begin  
     set @messageNSEFO='You cannot charge brokerage less than angel capping.'  
     select @messageNSEFO  
    end  
    else  
    Begin  
     set  @messageNSE='Proper'  
     select  @messageNSE  
    End  
   end  
   else  
   begin  
    if(@NSEFOFMin<@ClientLevelBrokT_NSEFO or @NSEFOFFu<@ClientLevelBrokT_NSEFO or @NSEFOSMin<@ClientLevelBrokT_NSEFO or @NSEFOSFu<@ClientLevelBrokT_NSEFO)  
    begin  
     set @messageNSEFO='You cannot charge brokerage less than angel capping.'  
     select @messageNSEFO  
    end  
    else  
    Begin  
     set  @messageNSE='Proper'  
     select  @messageNSE  
    End  
   end  
  end  
 end   
END 
/****BSEFO**************/
If(@Segment='BSEFO')  
Begin  
 If Exists(select * from mis.remisior.dbo.remimast_NSEFO where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate())  
 begin  
  declare @Std_rate_BSEFO as int,@Brok1_TableNo_BSEFO as int,@trd_min_BSEFO as money,@del_min_BSEFO as money,@ClientLevelBrokT_BSEFO as money,@ClientLevelBrokD_BSEFO as money,@messageBSEFO as varchar(max)  
  set @messageBSEFO=''  
  select * into #BSEFO from mis.remisior.dbo.remimast_NSEFO where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate()  
    
  select @Std_rate_BSEFO=Std_rate,@Brok1_TableNo_BSEFO=Brok1_TableNo from #BSEFO  
  
  if(@Std_rate_BSEFO=60 /*and @Brok1_TableNo_BSEFO=60*/)  
  begin  
   select @trd_min_BSEFO=trd_min/*,@del_min_BSEFO=del_min*/ from #BSEFO  
   if(@trd_min_BSEFO=0 /*and @del_min_BSEFO=0*/)  
   begin  
    select @ClientLevelBrokT_BSEFO=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityTrading'  
    if(@FlagBSEFOF='Disable' or @FlagBSEFOS='Disable')  
    begin  
     if(@BSEFOFMin<@ClientLevelBrokT_BSEFO or @BSEFOFFu<@ClientLevelBrokT_BSEFO)  
     begin  
      set @messageBSEFO='You cannot charge brokerage less than angel capping.'  
      select @messageBSEFO  
     end  
     else  
     Begin  
      set  @messageBSEFO='Proper'  
      select  @messageBSEFO  
     End  
    end  
    else  
    begin  
     if(@BSEFOFMin<@ClientLevelBrokT_BSEFO or @BSEFOFFu<@ClientLevelBrokT_BSEFO or @BSEFOSMin<@ClientLevelBrokT_BSEFO or @BSEFOSFu<@ClientLevelBrokT_BSEFO)  
     begin  
      set @messageBSEFO='You cannot charge brokerage less than angel capping.'  
      select @messageBSEFO  
     end  
     else  
     Begin  
      set  @messageBSEFO='Proper'  
      select  @messageBSEFO  
     End  
    end  
   end   
   else   
   begin  
    if(@FlagBSEFOF='Disable' or @FlagBSEFOS='Disable')  
    begin  
     if(@BSEFOFMin<@trd_min_BSEFO or @BSEFOFFu<@trd_min_BSEFO )  
     begin  
      set @messageBSEFO='Brokerage is incorrect'  
      select @messageBSEFO  
     end  
     else  
     Begin  
      set  @messageBSEFO='Proper'  
      select  @messageBSEFO  
     End  
    end  
    else  
    begin  
     if(@BSEFOFMin<@trd_min_BSEFO or @BSEFOFFu<@trd_min_BSEFO or @BSEFOSMin<@trd_min_BSEFO or @BSEFOSFu<@trd_min_BSEFO )  
     begin  
        set @messageBSEFO='Brokerage for trd min and del min is incorrect'  
        select @messageBSEFO  
       end  
       else  
     Begin  
     set  @messageBSEFO='Proper'  
     select  @messageBSEFO  
     End  
    end   
   end  
  end  
  else  
  begin  
  declare @Day_pucVF_BSEFO as money,@Day_pucPF_BSEFO as money, @Day_pucVS_BSEFO as money,@Day_pucPS_BSEFO as money  
    
   select @Day_pucVF_BSEFO=Day_puc from angelcommodity.BSEFO.dbo.broktable where table_no=@Std_rate_BSEFO and Val_perc='V' and trd_del='F'  
   select @Day_pucPF_BSEFO=Day_puc from angelcommodity.BSEFO.dbo.broktable where table_no=@Std_rate_BSEFO and Val_perc='P' and trd_del='F'  
     
   select @Day_pucVS_BSEFO=Day_puc from angelcommodity.BSEFO.dbo.broktable where table_no=@Std_rate_BSEFO and Val_perc='V' and trd_del='S'  
   select @Day_pucPS_BSEFO=Day_puc from angelcommodity.BSEFO.dbo.broktable where table_no=@Std_rate_BSEFO and Val_perc='P' and trd_del='S'     
      
    if(@FlagBSEFOF='Disable' or @FlagBSEFOS='Disable')  
    begin  
     if(@BSEFOFMin<@Day_pucVF_BSEFO or @BSEFOFFu<@Day_pucPF_BSEFO)  
     begin  
      set @messageBSEFO='Brokerage is incorrect'  
      select @messageBSEFO  
     end  
     else  
     Begin  
      set  @messageBSEFO='Proper'  
      select  @messageBSEFO  
     End  
    end  
    else  
    begin  
     if(@BSEFOFMin<@Day_pucVF_BSEFO or @BSEFOFFu<@Day_pucPF_BSEFO or @BSEFOSMin<@Day_pucVS_BSEFO or @BSEFOSFu<@Day_pucPS_BSEFO)  
     Begin  
     set @messageBSEFO='You cannot charge brokerage less than angel capping.'  
     select @messageBSEFO  
     End  
     else  
     Begin  
     set  @messageBSEFO='Proper'  
     select  @messageBSEFO  
     End  
    end  
  end  
 end  
else  
 begin  
  If Exists(select * from mis.remisior.dbo.remimast_NSEFO where party_code=@ClientCode and Calctype='' and ExceptClient='Yes' and todate>getdate())  
  begin  
   select @ClientLevelBrokT_BSEFO=ClientLevelBrok from SB_DefaultBrok_Mast where segment='EquityTrading'  
   if(@FlagBSEFOF='Disable' or @FlagBSEFOS='Disable')  
   begin  
    if(@BSEFOFMin<@ClientLevelBrokT_BSEFO or @BSEFOFFu<@ClientLevelBrokT_BSEFO )  
    begin  
     set @messageBSEFO='You cannot charge brokerage less than angel capping.'  
     select @messageBSEFO  
    end  
    else  
    Begin  
     set  @message='Proper'  
     select  @message  
    End  
   end  
   else  
   begin  
    if(@BSEFOFMin<@ClientLevelBrokT_BSEFO or @BSEFOFFu<@ClientLevelBrokT_BSEFO or @BSEFOSMin<@ClientLevelBrokT_BSEFO or @BSEFOSFu<@ClientLevelBrokT_BSEFO)  
    begin  
     set @messageBSEFO='You cannot charge brokerage less than angel capping.'  
     select @messageBSEFO  
    end  
    else  
    Begin  
     set  @message='Proper'  
     select  @message  
    End  
   end  
  end  
 end   
END  
/****************/
If(@Segment='MCX')  
Begin  
 If Exists(select * from mis.remisior.dbo.remimast_mcdx where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate())  
 begin  
  declare @Std_rate_MCX as int,@Brok1_TableNo_MCX as int,@trd_min_MCX as money,@del_min_MCX as money,@ClientLevelBrokT_MCX as money,@ClientLevelBrokD_MCX as money,@messageMCX as varchar(max)  
  set @messageMCX=''  
  select * into #MCX from mis.remisior.dbo.remimast_mcdx where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate()  
    
  select @Std_rate_MCX=Std_rate,@Brok1_TableNo_MCX=Brok1_TableNo from #MCX  
    
  if(@Std_rate_MCX=60 /*and @Brok1_TableNo_MCX=60*/)  
  begin  
   select @trd_min_MCX=trd_min/*,@del_min_MCX=del_min*/ from #MCX  
   if(@trd_min_MCX=0 /*and @del_min_MCX=0*/)  
   begin  
    select @ClientLevelBrokT_MCX=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Commodity'  
    if(@FlagMCXF='Disable' or @FlagMCXS='Disable')  
    begin  
     if(@MCX1M<@ClientLevelBrokT_MCX or @MCX1Fu<@ClientLevelBrokT_MCX)  
     begin  
      set @messageMCX='You cannot charge brokerage less than angel capping.'  
      select @messageMCX  
     end  
     else  
     Begin  
      set  @messageMCX='Proper'  
      select  @messageMCX  
     End  
    end  
    else  
    begin  
     if(@MCX1M<@ClientLevelBrokT_MCX or @MCX1Fu<@ClientLevelBrokT_MCX or @MCX2M<@ClientLevelBrokT_MCX or @MCX2Fu<@ClientLevelBrokT_MCX)  
     begin  
      set @messageMCX='You cannot charge brokerage less than angel capping.'  
      select @messageMCX  
     end  
     else  
     Begin  
      set  @messageMCX='Proper'  
      select  @messageMCX  
     End   
    end      
   end   
   else   
   begin  
    if(@FlagMCXF='Disable' or @FlagMCXS='Disable')  
    begin  
     if(@MCX1M<@trd_min_MCX or @MCX1Fu<@trd_min_MCX)  
     begin  
      set @messageMCX='Brokerage is incorrect'  
      select @messageMCX  
     end  
     else  
     Begin  
      set  @messageMCX='Proper'  
      select  @messageMCX  
     End  
    end  
    else  
    begin  
     if(@MCX1M<@trd_min_MCX or @MCX1Fu<@trd_min_MCX or @MCX2M<@trd_min_MCX or @MCX2Fu<@trd_min_MCX )  
     BEGIN  
        set @messageMCX='Brokerage for trd min and del min is incorrect'  
        select @messageMCX  
     end  
     else  
     Begin  
     set  @messageMCX='Proper'  
     select  @messageMCX  
     End  
    end  
   end  
  end  
  else  
  begin  
  declare @Day_pucVF_MCX as money,@Day_pucPF_MCX as money, @Day_pucVS_MCX as money,@Day_pucPS_MCX as money  
    
   select @Day_pucVF_MCX=Day_puc from angelcommodity.mcdx.DBO.broktable where table_no=@Std_rate_MCX and Val_perc='V'  and trd_del='F'  
   select @Day_pucPF_MCX=Day_puc from angelcommodity.mcdx.DBO.broktable where table_no=@Std_rate_MCX and Val_perc='P'   and trd_del='F'  
     
   select @Day_pucVS_MCX=Day_puc from angelcommodity.mcdx.DBO.broktable where table_no=@Std_rate_MCX and Val_perc='V'  and trd_del='S'  
   select @Day_pucPS_MCX=Day_puc from angelcommodity.mcdx.DBO.broktable where table_no=@Std_rate_MCX and Val_perc='P'   and trd_del='S'  
     
    if(@FlagMCXF='Disable' or @FlagMCXS='Disable')  
    begin  
     if(@MCX1M<@Day_pucVF_MCX or @MCX1Fu<@Day_pucPF_MCX )  
     begin  
      set @messageMCX='Brokerage is incorrect'  
      select @messageMCX  
     end  
     else  
     Begin  
      set  @messageMCX='Proper'  
      select  @messageMCX  
     End  
    end  
    else  
    begin  
     if(@MCX1M<@Day_pucVF_MCX or @MCX1Fu<@Day_pucPF_MCX or @MCX2M<@Day_pucVS_MCX or @MCX2Fu<@Day_pucPS_MCX)  
     Begin  
     set @messageMCX='You cannot charge brokerage less than angel capping.'  
     Select @messageMCX  
     End  
     else  
     Begin  
     set  @messageMCX='Proper'  
     select  @messageMCX  
     End  
    end  
  end  
 end  
else  
 begin  
  If Exists(select * from mis.remisior.dbo.remimast_mcdx where party_code=@ClientCode and Calctype='' and ExceptClient='Yes' and todate>getdate())  
  begin  
   select @ClientLevelBrokT_MCX=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Commodity'  
   if(@FlagMCXF='Disable' or @FlagMCXS='Disable')  
    begin  
     if(@MCX1M<@ClientLevelBrokT_MCX or @MCX1Fu<@ClientLevelBrokT_MCX)  
     begin  
      set @messageMCX='You cannot charge brokerage less than angel capping.'  
      select @messageMCX  
     end  
     else  
     Begin  
      set  @messageMCX='Proper'  
      select  @messageMCX  
     End  
    end  
    else  
    begin  
     if(@MCX1M<@ClientLevelBrokT_MCX or @MCX1Fu<@ClientLevelBrokT_MCX or @MCX2M<@ClientLevelBrokT_MCX or @MCX2Fu<@ClientLevelBrokT_MCX)  
     begin  
      set @messageMCX='You cannot charge brokerage less than angel capping.'  
      select @messageMCX  
     end  
     else  
     Begin  
      set  @messageMCX='Proper'  
      select  @messageMCX  
     End   
    end    
  end  
 end    
END  
If(@Segment='NCDEX')  
Begin  
 If Exists(select * from mis.remisior.dbo.remimast_ncdx where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate())  
 begin  
  declare @Std_rate_NCDX as int,@Brok1_TableNo_NCDX as int,@trd_min_NCDX as money,@del_min_NCDX as money,@ClientLevelBrokT_NCDX as money,@ClientLevelBrokD_NCDX as money,@messageNCDX as varchar(max)  
  set @messageNCDX=''  
  select * into #ncdx from mis.remisior.dbo.remimast_ncdx where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate()  
    
  select @Std_rate_NCDX=Std_rate,@Brok1_TableNo_NCDX=Brok1_TableNo from #ncdx  
  
  if(@Std_rate_NCDX=60 /*and @Brok1_TableNo_NCDX=60*/)  
  begin  
   select @trd_min_NCDX=trd_min/*,@del_min_NCDX=del_min*/ from #ncdx  
   if(@trd_min_NCDX=0 /*and @del_min_NCDX=0*/)  
   begin  
    select @ClientLevelBrokT_NCDX=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Commodity'  
    if(@FlagNCDXF='Disable' or @FlagNCDXS='Disable')  
    begin  
     if(@NCDX1Min<@ClientLevelBrokT_NCDX or @NCDX1Fu<@ClientLevelBrokT_NCDX)  
     begin  
      set @messageNCDX='You cannot charge brokerage less than angel capping.'  
      select @messageNCDX  
     end  
     else  
     Begin  
      set  @messageNCDX='Proper'  
      select  @messageNCDX  
     End  
    end  
    else  
    begin   
     if(@NCDX1Min<@ClientLevelBrokT_NCDX or @NCDX1Fu<@ClientLevelBrokT_NCDX or @NCDX2Min<@ClientLevelBrokT_NCDX or @NCDX2Fu<@ClientLevelBrokT_NCDX)  
     begin  
      set @messageNCDX='You cannot charge brokerage less than angel capping.'  
      Select @messageNCDX  
     end  
     else  
     Begin  
      set  @messageNCDX='Proper'  
      select  @messageNCDX  
     End   
    end      
   end   
   else   
   begin  
    if(@FlagNCDXF='Disable' or @FlagNCDXS='Disable')  
    begin  
     if(@NCDX1Min<@trd_min_NCDX or @NCDX1Fu<@trd_min_NCDX)  
     begin  
      set @messageNCDX='Brokerage is incorrect'  
      select @messageNCDX  
     end  
     else  
     Begin  
      set  @messageNCDX='Proper'  
      select  @messageNCDX  
     End  
    end  
    else  
    begin   
     if(@NCDX1Min<@trd_min_NCDX or @NCDX1Fu<@trd_min_NCDX or @NCDX2Min<@trd_min_NCDX or @NCDX2Fu<@trd_min_NCDX )  
     begin  
       set @messageNCDX='Brokerage for trd min and del min is incorrect'  
       Select @messageNCDX  
       end  
       else  
     Begin  
     set  @messageNCDX='Proper'  
     select  @messageNCDX  
     End  
    end  
   end  
  end  
  else  
  begin  
  declare @Day_pucVF_NCDX as money,@Day_pucPF_NCDX as money,@Day_pucVS_NCDX as money,@Day_pucPS_NCDX as money  
    
   select @Day_pucVF_NCDX=Day_puc from angelcommodity.ncdx.DBO.broktable where table_no=@Std_rate_NCDX and Val_perc='V'  and trd_del='F'  
   select @Day_pucPF_NCDX=Day_puc from angelcommodity.ncdx.DBO.broktable where table_no=@Std_rate_NCDX and Val_perc='P'  and trd_del='F'  
     
   select @Day_pucVS_NCDX=Day_puc from angelcommodity.ncdx.DBO.broktable where table_no=@Std_rate_NCDX and Val_perc='V'  and trd_del='S'  
   select @Day_pucPS_NCDX=Day_puc from angelcommodity.ncdx.DBO.broktable where table_no=@Std_rate_NCDX and Val_perc='P'  and trd_del='S'  
   if(@FlagNCDXF='Disable' or @FlagNCDXS='Disable')  
    begin  
     if(@NCDX1Min<@Day_pucVF_NCDX or @NCDX1Fu<@Day_pucPF_NCDX)  
     begin  
      set @messageNCDX='Brokerage is incorrect'  
      select @messageNCDX  
     end  
     else  
     Begin  
      set  @messageNCDX='Proper'  
      select  @messageNCDX  
     End  
    end  
    else  
    begin   
     if(@NCDX1Min<@Day_pucVF_NCDX or @NCDX1Fu<@Day_pucPF_NCDX or @NCDX2Min<@Day_pucVS_NCDX or @NCDX2Fu<@Day_pucPS_NCDX)  
     Begin  
     set @messageNCDX='You cannot charge brokerage less than angel capping'  
     Select @messageNCDX  
     End  
     else  
     Begin  
     set  @messageNCDX='Proper'  
     select  @messageNCDX  
     End  
    end  
  end  
 end  
else  
 begin  
  If Exists(select * from mis.remisior.dbo.remimast_ncdx where party_code=@ClientCode and Calctype='' and ExceptClient='Yes' and todate>getdate())  
  begin  
   select @ClientLevelBrokT_NCDX=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Commodity'  
    if(@FlagNCDXF='Disable' or @FlagNCDXS='Disable')  
    begin  
     if(@NCDX1Min<@ClientLevelBrokT_NCDX or @NCDX1Fu<@ClientLevelBrokT_NCDX)  
     begin  
      set @messageNCDX='You cannot charge brokerage less than angel capping.'  
      select @messageNCDX  
     end  
     else  
     Begin  
      set  @messageNCDX='Proper'  
      select  @messageNCDX  
     End  
    end  
    else  
    begin   
     if(@NCDX1Min<@ClientLevelBrokT_NCDX or @NCDX1Fu<@ClientLevelBrokT_NCDX or @NCDX2Min<@ClientLevelBrokT_NCDX or @NCDX2Fu<@ClientLevelBrokT_NCDX)  
     begin  
      set @messageNCDX='You cannot charge brokerage less than angel capping.'  
      Select @messageNCDX  
     end  
     else  
     Begin  
      set  @messageNCDX='Proper'  
      select  @messageNCDX  
     End   
    end     
  end  
 end     
END  
If(@Segment='NSX')  
Begin  
 If Exists(select * from mis.remisior.dbo.remimast_nsx where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate())  
 begin  
  declare @Std_rate_NSX as int,@Brok1_TableNo_NSX as int,@trd_min_NSX as money,@del_min_NSX as money,@ClientLevelBrokT_NSX as money,@ClientLevelBrokD_NSX as money,@messageNSX as varchar(max)  
  set @messageNSX=''  
  select * into #nsx from mis.remisior.dbo.remimast_nsx where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate()  
    
  select @Std_rate_NSX=Std_rate,@Brok1_TableNo_NSX=Brok1_TableNo from #nsx  
   
  if(@Std_rate_NSX=60 /*and @Brok1_TableNo_NSX=60*/)  
  begin  
   select @trd_min_NSX=trd_min/*,@del_min_NSX=del_min*/ from #nsx  
   if(@trd_min_NSX=0 /*and @del_min_NSX=0*/)  
   begin  
    select @ClientLevelBrokT_NSX=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Currency'  
    if(@FlagNSXS='Disable')  
    begin  
     if(@NSX1<@ClientLevelBrokT_NSX)  
     begin  
      set @messageNSX='You cannot charge brokerage less than angel capping.'  
      select @messageNSX  
     end  
     else  
     Begin  
      set  @messageNSX='Proper'  
      select  @messageNSX  
     End  
    end  
    else  
    begin  
     if(@NSX1<@ClientLevelBrokT_NSX or @NSX2<@ClientLevelBrokT_NSX)  
     begin  
     set @messageNSX='You cannot charge brokerage less than angel capping.'  
     Select @messageNSX  
     end  
     else  
     Begin  
     set  @messageNSX='Proper'  
     select  @messageNSX  
     End   
    end      
   end   
   else   
   begin  
    if(@FlagNSXS='Disable')  
    begin  
     if(@NSX1<@trd_min_NSX)  
     begin  
      set @messageNSX='Brokerage is incorrect'  
      select @messageNSX  
     end  
     else  
     Begin  
      set  @messageNSX='Proper'  
      select  @messageNSX  
     End  
    end  
    else  
    begin  
     if(@NSX1<@trd_min_NSX or @NSX2<@trd_min_NSX )  
     begin  
      set @messageNSX='Brokerage for trd min and del min is incorrect'  
      Select @messageNSX  
     end  
     else  
     Begin  
      set  @messageNSX='Proper'  
      select  @messageNSX  
     End  
    end  
   end  
  end  
  else  
  begin  
  declare @Day_pucP_NSX as money,@Day_pucV_NSX as money  
    
   select @Day_pucV_NSX=Day_puc from angelfo.nsecurfo.DBO.broktable where table_no=@Std_rate_NSX and Val_perc='P'  and trd_del='F'  
   select @Day_pucP_NSX=Day_puc from angelfo.nsecurfo.DBO.broktable where table_no=@Std_rate_NSX and Val_perc='P'  and trd_del='S'  
   if(@FlagNSXS='Disable')  
    begin  
     if(@NSX1<@Day_pucV_NSX)  
     begin  
      set @messageNSX='Brokerage is incorrect'  
      select @messageNSX  
     end  
     else  
     Begin  
      set  @messageNSX='Proper'  
      select  @messageNSX  
     End  
    end  
    else  
    begin  
     if(@NSX1<@Day_pucV_NSX or @NSX2<@Day_pucP_NSX )  
     Begin  
     set @messageNSX='You cannot charge brokerage less than angel capping'  
     Select @messageNSX  
     End  
     else  
     Begin  
     set  @messageNSX='Proper'  
     select  @messageNSX  
     End  
    end  
  end  
 end  
else  
 begin  
  If Exists(select * from mis.remisior.dbo.remimast_nsx where party_code=@ClientCode and Calctype='' and ExceptClient='Yes' and todate>getdate())  
  begin  
   select @ClientLevelBrokT_NSX=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Currency'  
    if(@FlagNSXS='Disable')  
    begin  
     if(@NSX1<@ClientLevelBrokT_NSX)  
     begin  
      set @messageNSX='You cannot charge brokerage less than angel capping.'  
      select @messageNSX  
     end  
     else  
     Begin  
      set  @messageNSX='Proper'  
      select  @messageNSX  
     End  
    end  
    else  
    begin  
     if(@NSX1<@ClientLevelBrokT_NSX or @NSX2<@ClientLevelBrokT_NSX)  
     begin  
     set @messageNSX='You cannot charge brokerage less than angel capping.'  
     Select @messageNSX  
     end  
     else  
     Begin  
     set  @messageNSX='Proper'  
     select  @messageNSX  
     End   
    end     
  end  
 end      
END  
If(@Segment='MCD')  
Begin  
 If Exists(select * from mis.remisior.dbo.remimast_mcd where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate())  
 begin  
  declare @Std_rate_MCD as int,@Brok1_TableNo_MCD as int,@trd_min_MCD as money,@del_min_MCD as money,@ClientLevelBrokT_MCD as money,@ClientLevelBrokD_MCD as money,@messageMCD as varchar(max)  
  set @messageMCD=''  
  select * into #mcd from mis.remisior.dbo.remimast_mcd where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate()  
    
  select @Std_rate_MCD=Std_rate,@Brok1_TableNo_MCD=Brok1_TableNo from #mcd  
  
  if(@Std_rate_MCD=60 /*and @Brok1_TableNo_MCD=60*/)  
  begin  
   select @trd_min_MCD=trd_min/*,@del_min_MCD=del_min*/ from #mcd  
   if(@trd_min_MCD=0 /*and @del_min_MCD=0*/)  
   begin  
    select @ClientLevelBrokT_MCD=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Commodity'  
    if(@FlagMCDS='Disable')  
    begin  
     if(@MCD1<@ClientLevelBrokT_MCD)  
     begin  
      set @messageMCD='You cannot charge brokerage less than angel capping.'  
      select @messageMCD  
     end  
     else  
     Begin  
      set  @messageMCD='Proper'  
      select  @messageMCD  
     End  
    end  
    else  
    begin  
     if(@MCD1<@ClientLevelBrokT_MCD or @MCD2<@ClientLevelBrokT_MCD )  
     begin  
     set @messageMCD='You cannot charge brokerage less than angel capping.'  
     Select @messageMCD  
     end  
     else  
     Begin  
     set  @messageMCD='Proper'  
     select  @messageMCD  
     End   
    end      
   end   
   else   
   begin  
    if(@FlagMCDS='Disable')  
    begin  
     if(@MCD1<@trd_min_MCD)  
     begin  
      set @messageMCD='Brokerage is incorrect'  
      select @messageMCD  
     end  
     else  
     Begin  
      set  @messageMCD='Proper'  
      select  @messageMCD  
     End  
    end  
    else  
    begin  
     if(@MCD1<@trd_min_MCD or @MCD2<@trd_min_MCD )  
     begin  
        set @messageMCD='Brokerage for trd min and del min is incorrect'  
        Select @messageMCD  
     end  
     else  
     Begin  
      set  @messageMCD='Proper'  
      select  @messageMCD  
     End  
    end  
   end  
  end  
  else  
  begin  
  declare @Day_pucP_MCD as money,@Day_pucV_MCD as money  
    
   select @Day_pucV_MCD=Day_puc from ANGELCOMMODITY.mcdxcds.DBO.broktable where table_no=@Std_rate_MCD and Val_perc='P' and trd_del='F'  
   select @Day_pucP_MCD=Day_puc from ANGELCOMMODITY.mcdxcds.DBO.broktable where table_no=@Std_rate_MCD and Val_perc='P' and trd_del='S'  
   if(@FlagMCDS='Disable')  
    begin  
     if(@MCD1<@Day_pucV_MCD)  
     begin  
      set @messageMCD='Brokerage is incorrect'  
      select @messageMCD  
     end  
     else  
     Begin  
      set  @messageMCD='Proper'  
      select  @messageMCD  
     End  
    end  
    else  
    begin  
     if(@MCD1<@Day_pucV_MCD or @MCD2<@Day_pucP_MCD)  
     Begin  
      set @messageMCD='You cannot charge brokerage less than angel capping'  
      Select @messageMCD  
     End  
     else  
     Begin  
      set  @messageMCD='Proper'  
      select  @messageMCD  
     End  
   end  
  end  
 end  
else  
 begin  
  If Exists(select * from mis.remisior.dbo.remimast_nsx where party_code=@ClientCode and Calctype='' and ExceptClient='Yes' and todate>getdate())  
  begin  
   select @ClientLevelBrokT_MCD=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Commodity'  
    if(@FlagMCDS='Disable')  
    begin  
     if(@MCD1<@ClientLevelBrokT_MCD)  
     begin  
      set @messageMCD='You cannot charge brokerage less than angel capping.'  
      select @messageMCD  
     end  
     else  
     Begin  
      set  @messageMCD='Proper'  
      select  @messageMCD  
     End  
    end  
    else  
    begin  
     if(@MCD1<@ClientLevelBrokT_MCD or @MCD2<@ClientLevelBrokT_MCD )  
     begin  
     set @messageMCD='You cannot charge brokerage less than angel capping.'  
     Select @messageMCD  
     end  
     else  
     Begin  
     set  @messageMCD='Proper'  
     select  @messageMCD  
     End   
    end    
  end  
 end       
END  
  
----------------------------NSEFO Option---------------------------------------------------------  
  
declare @ClientLevelBrokT_NSEFOOpt as money,@ClientLevelBrokT_NSEFOOptN as money,@ClientLevelBrokT_NSEFOOptBN as money,
@ClientLevelBrokT_NSEFOOptFN as money,@NSEOptionmessage as varchar(max) ,@NSEOptionmessageFN  as varchar(max)
declare @NSEOptionmessageN as varchar(max),@NSEOptionmessageBN as varchar(max),@NSEOptionmessageSO as varchar(max)  
declare @MinPerS as money,@MinPerN as money,@MinPerB as money,@MinPerFN as money,@MinPerSO as money,@ClientLevelBrokT_NSEFOOptSO as money  
declare @FLegStock money,@SlegStock as money  
declare @FLegNifty money,@SlegNifty as money  
declare @FLegFinNifty money,@SlegFinNifty as money  
declare @FLegBankNifty money,@SlegBankNifty as money  
declare @FLegSO money,@SlegSO as money  
set @NSEOptionmessage=''  
set @NSEOptionmessageN=''  
set @NSEOptionmessageBN=''  
set @NSEOptionmessageSO=''  
set @NSEOptionmessageFN=''
declare @SBCode as varchar(50)=''  
select @SBCode=sub_broker from client_details where party_code=@ClientCode  
If(@Segment='NSEOption')  
Begin  
 If Exists(select * from mis.remisior.dbo.remimast_nsefo where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate())  
 begin 
 print 'he'
  If Exists(select * from mis.remisior.dbo.OptionShare_new where party_code=@ClientCode and scrip='STOCK OPTION')  
  begin  
   select * into #nseStockoption from mis.remisior.dbo.OptionShare_new where party_code=@ClientCode and scrip='STOCK OPTION'  
   declare @type as varchar(10)=''  
   select @type=type from #nseStockoption 
   print @type
   if(@type='P')  
   begin  
    select @MinPerS=Minper from #nseStockoption where scrip='STOCK OPTION'  
    if(@MinPerS=0)  
    begin  
     select @ClientLevelBrokT_NSEFOOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='StockOptions'  
     if(@FlagNSEoptS='Disable')  
     begin  
     if(@NSEFOOS1<@ClientLevelBrokT_NSEFOOpt)  
     begin  
      set @NSEOptionmessage='You cannot charge brokerage less than angel capping.-S1'  
      select @NSEOptionmessage  
     end  
     else  
     Begin  
      set  @NSEOptionmessage='Proper'  
      select  @NSEOptionmessage  
     End  
     end  
     else  
     begin  
      if(@NSEFOOS1<@ClientLevelBrokT_NSEFOOpt or @NSEFOOS2<@ClientLevelBrokT_NSEFOOpt )  
      begin  
       set @NSEOptionmessage='Brokerage is incorrect R-nseOthers/bseOthers'  
       Select @NSEOptionmessage  
      end  
      else  
      Begin  
       set  @NSEOptionmessage='Proper'  
       select  @NSEOptionmessage  
      End  
     end       
    end  
    else  
    begin  
     if(@FlagNSEoptS='Disable')  
     begin  
     if(@NSEFOOS1<@MinPerS)  
     begin  
      set @NSEOptionmessage='Brokerage is incorrect-nseOthers/bseOthers'  
      select @NSEOptionmessage  
     end  
     else  
     Begin  
      set  @NSEOptionmessage='Proper'  
      select  @NSEOptionmessage  
     End  
     end  
     else  
     begin  
      if(@NSEFOOS1<@MinPerS or @NSEFOOS2 < @MinPerS)  
      begin  
       set @NSEOptionmessage='Brokerage is incorrect-nseOthers/bseOthers'  
       select @NSEOptionmessage  
      end  
      else  
      Begin  
       set  @NSEOptionmessage='Proper'  
       select  @NSEOptionmessage  
      End  
     end  
    end  
   end  
   else  
   begin  
    If(@type='R')  
    begin  
     select @FLegStock=Fleg,@SlegStock=Sleg from #nseStockoption where scrip='STOCK OPTION'  
     if(@FLegStock=0 and @SlegStock=0)  
     begin  
      select @ClientLevelBrokT_NSEFOOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='StockOptions'  
      if(@FlagNSEoptS='Disable')  
      begin  
      if(@NSEFOOS1<@ClientLevelBrokT_NSEFOOpt)  
      begin  
       set @NSEOptionmessage='You cannot charge brokerage less than angel capping.-nseOthers/bseOthers'  
       select @NSEOptionmessage  
      end  
      else  
      Begin  
       set  @NSEOptionmessage='Proper'  
       select  @NSEOptionmessage  
      End  
      end  
      else  
      begin  
      if(@NSEFOOS1<@ClientLevelBrokT_NSEFOOpt or @NSEFOOS2<@ClientLevelBrokT_NSEFOOpt )  
      begin  
       set @NSEOptionmessage='Brokerage is incorrect R-nseOthers/bseOthers'  
       Select @NSEOptionmessage  
      end  
      else  
      Begin  
       set  @NSEOptionmessage='Proper'  
       select  @NSEOptionmessage  
      End   
      end     
     end  
     else  
     begin  
      --if(@FlagNSEoptS='Disable')  
      --begin  
      --if(@NSEFOOS1<@FLegStock)  
      --begin  
      -- set @NSEOptionmessage='Brokerage is incorrect'  
      -- select @NSEOptionmessage  
      --end  
      --else  
      --Begin  
      -- set  @NSEOptionmessage='Proper'  
      -- select  @NSEOptionmessage  
      --End  
      --end  
      --else  
      --begin  
       if(@NSEFOOS1<@FLegStock or @NSEFOOS2 < @SlegStock)  
       begin  
        set @NSEOptionmessage='Brokerage is incorrect-nseOthers/bseOthers'  
        select @NSEOptionmessage  
       end  
       else  
       Begin  
        set  @NSEOptionmessage='Proper'  
        select  @NSEOptionmessage  
       End  
      --end  
     end  
    end  
   end  
    
 end   
 else  
 begin  
  print 'hi'  
  if Exists(select * from mis.remisior.dbo.OptionShare_sb_new where subbrokercode=@SBCode and scrip='STOCK OPTION')  
  begin
  print 'gbh'
  select * into #nseStockoptionSB from mis.remisior.dbo.OptionShare_sb_new where subbrokercode=@SBCode and scrip='STOCK OPTION'  
   declare @typeSB as varchar(10)=''  
   select @typeSB=type from #nseStockoptionSB
   print @typeSB
   if(@typeSB='P')  
   begin  
    --declare @MinPerS as money,@MinPerN as money,@MinPerB as money  
    select @MinPerS=Minper from #nseStockoptionSB where scrip='STOCK OPTION'  
    if(@MinPerS=0)  
    begin  
     select @ClientLevelBrokT_NSEFOOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='StockOptions'  
     if(@FlagNSEoptS='Disable')  
     begin  
     if(@NSEFOOS1<@ClientLevelBrokT_NSEFOOpt)  
     begin  
      set @NSEOptionmessage='You cannot charge brokerage less than angel capping.-nseOthers/bseOthers'  
      select @NSEOptionmessage  
     end  
     else  
     Begin  
      set  @NSEOptionmessage='Proper'  
      select  @NSEOptionmessage  
     End  
     end  
     else  
     begin  
     if(@NSEFOOS1<@ClientLevelBrokT_NSEFOOpt or @NSEFOOS2<@ClientLevelBrokT_NSEFOOpt )  
     begin  
      set @NSEOptionmessage='Brokerage is incorrect R-nseOthers/bseOthers'  
      Select @NSEOptionmessage  
     end  
     else  
     Begin  
      set  @NSEOptionmessage='Proper'  
      select  @NSEOptionmessage  
     End   
     end     
    end  
    else  
    begin  
     if(@FlagNSEoptS='Disable')  
      begin  
      if(@NSEFOOS1<@MinPerS)  
      begin  
       set @NSEOptionmessage='Brokerage is incorrect-nseOthers/bseOthers'  
       select @NSEOptionmessage  
      end  
      else  
      Begin  
       set  @NSEOptionmessage='Proper'  
       select  @NSEOptionmessage  
      End  
      end  
      else  
      begin  
       if(@NSEFOOS1<@MinPerS or @NSEFOOS2 < @MinPerS)  
       begin  
        set @NSEOptionmessage='Brokerage is incorrect-nseOthers/bseOthers'  
        select @NSEOptionmessage  
       end  
       else  
       Begin  
        set  @NSEOptionmessage='Proper'  
        select  @NSEOptionmessage  
       End  
      end   
    end  
   end  
   else  
   begin  
    If(@typeSB='R')  
    begin  
     --declare @FLegStock money,@SlegStock as money  
     select @FLegStock=Fleg,@SlegStock=Sleg from #nseStockoptionSB where scrip='STOCK OPTION'  
     if(@FLegStock=0 and @SlegStock=0)  
     begin  
      select @ClientLevelBrokT_NSEFOOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='StockOptions'  
      if(@FlagNSEoptS='Disable')  
      begin  
      if(@NSEFOOS1<@ClientLevelBrokT_NSEFOOpt)  
      begin  
       set @NSEOptionmessage='You cannot charge brokerage less than angel capping.-nseOthers/bseOthers'  
       select @NSEOptionmessage  
      end  
      else  
      Begin  
       set  @NSEOptionmessage='Proper'  
       select  @NSEOptionmessage  
      End  
      end  
      else  
      begin  
      if(@NSEFOOS1<@ClientLevelBrokT_NSEFOOpt or @NSEFOOS2<@ClientLevelBrokT_NSEFOOpt )  
      begin  
       set @NSEOptionmessage='Brokerage is incorrect R-nseOthers/bseOthers'  
       Select @NSEOptionmessage  
      end  
      else  
      Begin  
       set  @NSEOptionmessage='Proper'  
       select  @NSEOptionmessage  
      End  
      end      
     end  
     else  
     begin  
      --if(@FlagNSEoptS='Disable')  
      --begin  
      --if(@NSEFOOS1<@FLegStock)  
      --begin  
      -- set @NSEOptionmessage='Brokerage is incorrect'  
      -- select @NSEOptionmessage  
      --end  
      --else  
      --Begin  
      -- set  @NSEOptionmessage='Proper'  
      -- select  @NSEOptionmessage  
      --End  
      --end  
      --else  
      --begin  
       if(@NSEFOOS1<@FLegStock or @NSEFOOS2 < @SlegStock)  
       begin  
        set @NSEOptionmessage='Brokerage is incorrect-nseOthers/bseOthers'  
        select @NSEOptionmessage  
       end  
       else  
       Begin  
        set  @NSEOptionmessage='Proper'  
        select  @NSEOptionmessage  
       End  
      --end  
     end  
    end  
   end  
  end  
  else  
  begin  
    select @ClientLevelBrokT_NSEFOOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='StockOptions'  
     if(@FlagNSEoptS='Disable')  
     begin  
     if(@NSEFOOS1<@ClientLevelBrokT_NSEFOOpt)  
     begin  
      set @NSEOptionmessage='You cannot charge brokerage less than angel capping.-nseOthers/bseOthers'  
      select @NSEOptionmessage  
     end  
     else  
     Begin  
      set  @NSEOptionmessage='Proper'  
      select  @NSEOptionmessage  
     End  
     end  
     else  
     begin  
      if(@NSEFOOS1<@ClientLevelBrokT_NSEFOOpt or @NSEFOOS2<@ClientLevelBrokT_NSEFOOpt )  
      begin  
       set @NSEOptionmessage='Brokerage is incorrect R-nseOthers/bseOthers'  
       Select @NSEOptionmessage  
      end  
      else  
      Begin  
       set  @NSEOptionmessage='Proper'  
       select  @NSEOptionmessage  
      End  
     end     
  end   
 end  
 ----------------------------------------- NIFTY---------------------------------------------------  
 If Exists(select * from mis.remisior.dbo.OptionShare_new where party_code=@ClientCode and scrip='NIFTY')  
  begin  
   select * into #nseNiftyoption from mis.remisior.dbo.OptionShare_new where party_code=@ClientCode and scrip='NIFTY'  
   declare @typeN as varchar(10)=''  
   select @typeN=type from #nseNiftyoption  
   if(@typeN='P')  
   begin  
    select @MinPerN=Minper from #nseNiftyoption where scrip='NIFTY'  
    if(@MinPerN=0)  
    begin  
     select @ClientLevelBrokT_NSEFOOptN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
     if(@FlagNSEoptN='Disable')  
     begin  
     if(@NSEFOON1<@ClientLevelBrokT_NSEFOOptN)  
     begin  
      set @NSEOptionmessageN='You cannot charge brokerage less than angel capping.-nseNifty/bseSensex'  
      select @NSEOptionmessageN  
     end  
     else  
     Begin  
      set  @NSEOptionmessageN='Proper'  
      select  @NSEOptionmessageN  
     End  
     end  
     else  
     begin  
     if(@NSEFOON1<@ClientLevelBrokT_NSEFOOptN or @NSEFOON2<@ClientLevelBrokT_NSEFOOptN )  
     begin  
     set @NSEOptionmessageN='You cannot charge brokerage less than angel capping-nseNifty/bseSensex'  
     Select @NSEOptionmessageN  
     end  
     else  
     Begin  
     set  @NSEOptionmessage='Proper'  
     select  @NSEOptionmessage  
     End  
     end      
    end  
    else  
    begin  
     if(@FlagNSEoptN='Disable')  
     begin  
     if(@NSEFOON1<@MinPerN)  
     begin  
      set @NSEOptionmessageN='Brokerage is incorrect-nseNifty/bseSensex'  
      select @NSEOptionmessageN  
     end  
     else  
     Begin  
      set  @NSEOptionmessageN='Proper'  
      select  @NSEOptionmessageN  
     End  
     end  
     else  
     begin  
      if(@NSEFOON1<@MinPerN or @NSEFOON2 < @MinPerN)  
      begin  
       set @NSEOptionmessageN='You cannot charge brokerage less than angel capping-nseNifty/bseSensex'  
       select  @NSEOptionmessageN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageN='Proper'  
       select  @NSEOptionmessageN  
      End  
     end  
    end  
   end  
   else  
   begin  
    If(@typeN='R')  
    begin  
     select @FLegNifty=Fleg,@SlegNifty=Sleg from #nseNiftyoption where scrip='NIFTY'  
     if(@FLegStock=0 and @SlegStock=0)  
     begin  
      select @ClientLevelBrokT_NSEFOOptN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
      if(@FlagNSEoptN='Disable')  
      begin  
      if(@NSEFOON1<@ClientLevelBrokT_NSEFOOptN)  
      begin  
       set @NSEOptionmessageN='You cannot charge brokerage less than angel capping.-nseNifty/bseSensex'  
       select @NSEOptionmessageN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageN='Proper'  
       select  @NSEOptionmessageN  
      End  
      end  
      else  
      begin  
      if(@NSEFOON1<@ClientLevelBrokT_NSEFOOptN or @NSEFOON2<@ClientLevelBrokT_NSEFOOptN )  
      begin  
      set @NSEOptionmessageN='Brokerage is incorrect R-nseNifty/bseSensex'  
      Select @NSEOptionmessageN  
      end  
      else  
      Begin  
      set  @NSEOptionmessageN='Proper'  
      select  @NSEOptionmessageN  
      End   
      end     
     end  
     else  
     begin  
      --if(@FlagNSEoptN='Disable')  
      --begin  
      --if(@NSEFOON1<@FLegNifty)  
      --begin  
      -- set @NSEOptionmessageN='Brokerage is incorrect'  
      -- select @NSEOptionmessageN  
      --end  
      --else  
      --Begin  
      -- set  @NSEOptionmessageN='Proper'  
      -- select  @NSEOptionmessageN  
      --End  
      --end  
      --else  
      --begin  
       if(@NSEFOON1<@FLegNifty or @NSEFOON2 < @SlegNifty)  
       begin  
        set @NSEOptionmessageN='Brokerage is incorrect-nseNifty/bseSensex'  
        select @NSEOptionmessageN  
       end  
       else  
       Begin  
        set  @NSEOptionmessageN='Proper'  
        select  @NSEOptionmessageN  
       End  
      --end  
     end  
    end  
   end  
    
 end   
 else  
 begin  
 if Exists(select *  from mis.remisior.dbo.OptionShare_sb_new where subbrokercode=@SBCode  and scrip='NIFTY')  
  begin  
  select * into #nseNiftyoptionSB from mis.remisior.dbo.OptionShare_sb_new where subbrokercode=@SBCode  and scrip='NIFTY'  
   declare @typeNSB as varchar(10)=''  
   select @typeNSB=type from #nseNiftyoptionSB  
   if(@typeNSB='P')  
   begin  
    --declare @MinPerS as money,@MinPerN as money,@MinPerB as money  
    select @MinPerN=Minper from #nseNiftyoptionSB where scrip='NIFTY'  
    if(@MinPerN=0)  
    begin  
     select @ClientLevelBrokT_NSEFOOptN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
     if(@FlagNSEoptN='Disable')  
     begin  
     if(@NSEFOON1<@ClientLevelBrokT_NSEFOOptN)  
     begin  
      set @NSEOptionmessageN='You cannot charge brokerage less than angel capping.-nseNifty/bseSensex'  
      select @NSEOptionmessageN  
     end  
     else  
     Begin  
      set  @NSEOptionmessageN='Proper'  
      select  @NSEOptionmessageN  
     End  
     end  
     else  
     begin  
     if(@NSEFOON1<@ClientLevelBrokT_NSEFOOptN or @NSEFOON2<@ClientLevelBrokT_NSEFOOptN )  
     begin  
     set @NSEOptionmessageN='Brokerage is incorrect R-nseNifty/bseSensex'  
     Select @NSEOptionmessageN  
     end  
     else  
     Begin  
     set  @NSEOptionmessageN='Proper'  
     select  @NSEOptionmessageN  
     End   
     end     
    end  
    else  
    begin  
      if(@FlagNSEoptN='Disable')  
      begin  
      if(@NSEFOON1<@MinPerN)  
      begin  
       set @NSEOptionmessageN='Brokerage is incorrect-nseNifty/bseSensex'  
       select @NSEOptionmessageN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageN='Proper'  
       select  @NSEOptionmessageN  
      End  
      end  
      else  
      begin  
      if(@NSEFOON1<@MinPerN or @NSEFOON2 < @MinPerN)  
      begin  
       set @NSEOptionmessageN='Brokerage is incorrect-nseNifty/bseSensex'  
       Select @NSEOptionmessageN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageN='Proper'  
       select  @NSEOptionmessageN  
      End  
      end  
    end  
   end  
   else  
   begin  
    If(@typeSB='R')  
    begin  
     --declare @FLegStock money,@SlegStock as money  
     select @FLegNifty=Fleg,@SlegNifty=Sleg from #nseNiftyoptionSB where scrip='NIFTY'  
     if(@FLegNifty=0 and @SlegNifty=0)  
     begin  
      select @ClientLevelBrokT_NSEFOOptN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
      if(@FlagNSEoptN='Disable')  
      begin  
      if(@NSEFOON1<@ClientLevelBrokT_NSEFOOptN)  
      begin  
       set @NSEOptionmessageN='You cannot charge brokerage less than angel capping.-nseNifty/bseSensex'  
       select @NSEOptionmessageN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageN='Proper'  
       select  @NSEOptionmessageN  
      End  
      end  
      else  
      begin  
      if(@NSEFOON1<@ClientLevelBrokT_NSEFOOptN or @NSEFOON2<@ClientLevelBrokT_NSEFOOptN )  
      begin  
       set @NSEOptionmessageN='Brokerage is incorrect R-nseNifty/bseSensex'  
       Select @NSEOptionmessageN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageN='Proper'  
       select  @NSEOptionmessageN  
      End  
      end      
     end  
     else  
     begin  
      --if(@FlagNSEoptN='Disable')  
      --begin  
      --if(@NSEFOON1<@FLegNifty)  
      --begin  
      -- set @NSEOptionmessageN='Brokerage is incorrect'  
      -- select @NSEOptionmessageN  
      --end  
      --else  
      --Begin  
      -- set  @NSEOptionmessageN='Proper'  
      -- select  @NSEOptionmessageN  
      --End  
      --end  
      --else  
      --begin  
       if(@NSEFOON1<@FLegNifty or @NSEFOON2 < @SlegNifty)  
       begin  
        set @NSEOptionmessageN='Brokerage is incorrect-nseNifty/bseSensex'  
        Select @NSEOptionmessageN  
       end  
       else  
       Begin  
        set  @NSEOptionmessageN='Proper'  
        select  @NSEOptionmessageN  
       End  
      --end  
     end  
    end  
   end  
  end  
  else  
  begin  
      select @ClientLevelBrokT_NSEFOOptN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
      if(@FlagNSEoptN='Disable')  
      begin  
       if(@NSEFOON1<@ClientLevelBrokT_NSEFOOptN)  
       begin  
        set @NSEOptionmessageN='You cannot charge brokerage less than angel capping.-nseNifty/bseSensex'  
        select @NSEOptionmessageN  
       end  
       else  
       Begin  
        set  @NSEOptionmessageN='Proper'  
        select  @NSEOptionmessageN  
       End  
      end  
      else  
      begin  
       if(@NSEFOON1<@ClientLevelBrokT_NSEFOOptN or @NSEFOON2<@ClientLevelBrokT_NSEFOOptN )  
       begin  
       set @NSEOptionmessageN='Brokerage is incorrect R-nseNifty/bseSensex'  
       Select @NSEOptionmessageN  
       end  
       else  
       Begin  
       set  @NSEOptionmessageN='Proper'  
       select  @NSEOptionmessageN  
       End  
      end  
  end  
 end  
 -------------------------------------------------------------------------------------------  
  
   -----------------------------------------FIN NIFTY---------------------------------------------------  
if (@NSEFOOFN1<>0 or @NSEFOOFN2<>0)
begin
 If Exists(select * from mis.remisior.dbo.OptionShare_new where party_code=@ClientCode and scrip='FINNIFTY')  
  begin  
   select * into #nseFinNiftyoption from mis.remisior.dbo.OptionShare_new where party_code=@ClientCode and scrip='FINNIFTY'  
   declare @typeFN as varchar(10)=''  
   select @typeFN=type from #nseFinNiftyoption  
   if(@typeFN='P')  
   begin  
    select @MinPerFN=Minper from #nseFinNiftyoption where scrip='FINNIFTY'  
    if(@MinPerFN=0)  
    begin  
     select @ClientLevelBrokT_NSEFOOptFN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
     if(@FlagNSEoptFN='Disable')  
     begin  
     if(@NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN)  
     begin  
      set @NSEOptionmessageFN='You cannot charge brokerage less than angel capping.-finNifty'  
      select @NSEOptionmessageFN  
     end  
     else  
     Begin  
      set  @NSEOptionmessageFN='Proper'  
      select  @NSEOptionmessageFN  
     End  
     end  
     else  
     begin  
     if(@NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN or @NSEFOOFN2<@ClientLevelBrokT_NSEFOOptFN )  
     begin  
     set @NSEOptionmessageFN='You cannot charge brokerage less than angel capping-finNifty'  
     Select @NSEOptionmessageFN  
     end  
     else  
     Begin  
     set  @NSEOptionmessage='Proper'  
     select  @NSEOptionmessage  
     End  
     end      
    end  
    else  
    begin  
     if(@FlagNSEoptFN='Disable')  
     begin  
     if(@NSEFOOFN1<@MinPerFN)  
     begin  
      set @NSEOptionmessageFN='Brokerage is incorrect-finNifty'  
      select @NSEOptionmessageFN  
     end  
     else  
     Begin  
      set  @NSEOptionmessageFN='Proper'  
      select  @NSEOptionmessageFN  
     End  
     end  
     else  
     begin  
      if(@NSEFOOFN1<@MinPerFN or @NSEFOOFN2 < @MinPerFN)  
      begin  
       set @NSEOptionmessageFN='You cannot charge brokerage less than angel capping-finNifty'  
       select  @NSEOptionmessageFN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageFN='Proper'  
       select  @NSEOptionmessageFN  
      End  
     end  
    end  
   end  
   else  
   begin  
    If(@typeFN='R')  
    begin  
     select @FLegFinNifty=Fleg,@SlegFinNifty=Sleg from #nseFinNiftyoption where scrip='FINNIFTY'  
     if(@FLegStock=0 and @SlegStock=0)  
     begin  
      select @ClientLevelBrokT_NSEFOOptFN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
      if(@FlagNSEoptFN='Disable')  
      begin  
      if(@NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN)  
      begin  
       set @NSEOptionmessageFN='You cannot charge brokerage less than angel capping.-finNifty'  
       select @NSEOptionmessageFN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageFN='Proper'  
       select  @NSEOptionmessageFN  
      End  
      end  
      else  
      begin  
      if(@NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN or @NSEFOOFN2<@ClientLevelBrokT_NSEFOOptFN )  
      begin  
      set @NSEOptionmessageFN='Brokerage is incorrect R-finNifty'  
      Select @NSEOptionmessageFN  
      end  
      else  
      Begin  
      set  @NSEOptionmessageFN='Proper'  
      select  @NSEOptionmessageFN  
      End   
      end     
     end  
     else  
     begin  
      --if(@FlagNSEoptFN='Disable')  
      --begin  
      --if(@NSEFOOFN1<@FLegFinNifty)  
      --begin  
      -- set @NSEOptionmessageFN='Brokerage is incorrect'  
      -- select @NSEOptionmessageFN  
      --end  
      --else  
      --Begin  
      -- set  @NSEOptionmessageFN='Proper'  
      -- select  @NSEOptionmessageFN  
      --End  
      --end  
      --else  
      --begin  
       if(@NSEFOOFN1<@FLegFinNifty or @NSEFOOFN2 < @SlegFinNifty)  
       begin  
        set @NSEOptionmessageFN='Brokerage is incorrect-finNifty'  
        select @NSEOptionmessageFN  
       end  
       else  
       Begin  
        set  @NSEOptionmessageFN='Proper'  
        select  @NSEOptionmessageFN  
       End  
      --end  
     end  
    end  
   end  
    
 end   
 else  
 begin  
 if Exists(select *  from mis.remisior.dbo.OptionShare_sb_new where subbrokercode=@SBCode  and scrip='FINNIFTY')  
  begin  
  select * into #nseFinNiftyoptionSB from mis.remisior.dbo.OptionShare_sb_new where subbrokercode=@SBCode  and scrip='FINNIFTY'  
   declare @typeFNSB as varchar(10)=''  
   select @typeFNSB=type from #nseFinNiftyoptionSB  
   if(@typeFNSB='P')  
   begin  
    --declare @MinPerS as money,@MinPerFN as money,@MinPerB as money  
    select @MinPerFN=Minper from #nseFinNiftyoptionSB where scrip='FINNIFTY'  
    if(@MinPerFN=0)  
    begin  
     select @ClientLevelBrokT_NSEFOOptFN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
     if(@FlagNSEoptFN='Disable')  
     begin  
     if(@NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN)  
     begin  
      set @NSEOptionmessageFN='You cannot charge brokerage less than angel capping.-finNifty'  
      select @NSEOptionmessageFN  
     end  
     else  
     Begin  
      set  @NSEOptionmessageFN='Proper'  
      select  @NSEOptionmessageFN  
     End  
     end  
     else  
     begin  
     if(@NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN or @NSEFOOFN2<@ClientLevelBrokT_NSEFOOptFN )  
     begin  
     set @NSEOptionmessageFN='Brokerage is incorrect R-finNifty'  
     Select @NSEOptionmessageFN  
     end  
     else  
     Begin  
     set  @NSEOptionmessageFN='Proper'  
     select  @NSEOptionmessageFN  
     End   
     end     
    end  
    else  
    begin  
      if(@FlagNSEoptFN='Disable')  
      begin  
      if(@NSEFOOFN1<@MinPerFN)  
      begin  
       set @NSEOptionmessageFN='Brokerage is incorrect-finNifty'  
       select @NSEOptionmessageFN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageFN='Proper'  
       select  @NSEOptionmessageFN  
      End  
      end  
      else  
      begin  
      if(@NSEFOOFN1<@MinPerN or @NSEFOOFN2 < @MinPerN)  
      begin  
       set @NSEOptionmessageFN='Brokerage is incorrect-finNifty'  
       Select @NSEOptionmessageFN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageFN='Proper'  
       select  @NSEOptionmessageFN  
      End  
      end  
    end  
   end  
   else  
   begin  
    If(@typeSB='R')  
    begin  
     --declare @FLegStock money,@SlegStock as money  
     select @FLegFinNifty=Fleg,@SlegFinNifty=Sleg from #nseFinNiftyoptionSB where scrip='FINNIFTY'  
     if(@FLegFinNifty=0 and @SlegFinNifty=0)  
     begin  
      select @ClientLevelBrokT_NSEFOOptFN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
      if(@FlagNSEoptFN='Disable')  
      begin  
      if(@NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN)  
      begin  
       set @NSEOptionmessageFN='You cannot charge brokerage less than angel capping.-finNifty'  
       select @NSEOptionmessageFN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageFN='Proper'  
       select  @NSEOptionmessageFN  
      End  
      end  
      else  
      begin  
      if(@NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN or @NSEFOOFN2<@ClientLevelBrokT_NSEFOOptFN )  
      begin  
       set @NSEOptionmessageFN='Brokerage is incorrect R-finNifty'  
       Select @NSEOptionmessageFN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageFN='Proper'  
       select  @NSEOptionmessageFN  
      End  
      end      
     end  
     else  
     begin  
      --if(@FlagNSEoptFN='Disable')  
      --begin  
      --if(@NSEFOOFN1<@FLegFinNifty)  
      --begin  
      -- set @NSEOptionmessageFN='Brokerage is incorrect'  
      -- select @NSEOptionmessageFN  
      --end  
      --else  
      --Begin  
      -- set  @NSEOptionmessageFN='Proper'  
      -- select  @NSEOptionmessageFN  
      --End  
      --end  
      --else  
      --begin  
       if(@NSEFOOFN1<@FLegFinNifty or @NSEFOOFN2 < @SlegFinNifty)  
       begin  
        set @NSEOptionmessageFN='Brokerage is incorrect-finNifty'  
        Select @NSEOptionmessageFN  
       end  
       else  
       Begin  
        set  @NSEOptionmessageFN='Proper'  
        select  @NSEOptionmessageFN  
       End  
      --end  
     end  
    end  
   end  
  end  
  else  
  begin  
      select @ClientLevelBrokT_NSEFOOptFN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
      if(@FlagNSEoptFN='Disable')  
      begin  
       if(@NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN)  
       begin  
        set @NSEOptionmessageFN='You cannot charge brokerage less than angel capping.-finNifty'  
        select @NSEOptionmessageFN  
       end  
       else  
       Begin  
        set  @NSEOptionmessageFN='Proper'  
        select  @NSEOptionmessageFN  
       End  
      end  
      else  
      begin  
       if(@NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN or @NSEFOOFN2<@ClientLevelBrokT_NSEFOOptFN )  
       begin  
       set @NSEOptionmessageFN='Brokerage is incorrect R-finNifty'  
       Select @NSEOptionmessageFN  
       end  
       else  
       Begin  
       set  @NSEOptionmessageFN='Proper'  
       select  @NSEOptionmessageFN  
       End  
      end  
  end  
 end  
end
 -------------------------------------------------------------------------------------------  


 -----------------------------------------BANK NIFTY---------------------------------------------------  
 If Exists(select * from mis.remisior.dbo.OptionShare_new where party_code=@ClientCode and scrip='BANKNIFTY')  
  begin  
   select * into #nseBNiftyoption from mis.remisior.dbo.OptionShare_new where party_code=@ClientCode and scrip='BANKNIFTY'  
   declare @typeBN as varchar(10)=''  
   select @typeBN=type from #nseBNiftyoption  
   if(@typeBN='P')  
   begin  
    select @MinPerB=Minper from #nseBNiftyoption where scrip='BANKNIFTY'  
    if(@MinPerB=0)  
    begin  
     select @ClientLevelBrokT_NSEFOOptBN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
     if(@FlagNSEoptB='Disable')  
     begin  
     if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptBN)  
     begin  
      set @NSEOptionmessageBN='You cannot charge brokerage less than angel capping.-bankNifty/bankEx'  
      select @NSEOptionmessageBN  
     end  
     else  
     Begin  
      set  @NSEOptionmessageBN='Proper'  
      select  @NSEOptionmessageBN  
     End  
     end  
     else  
     begin  
     if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptBN or @NSEFOOB2<@ClientLevelBrokT_NSEFOOptBN )  
     begin  
     set @NSEOptionmessageBN='You cannot charge brokerage less than angel capping-bankNifty/bankEx'  
     Select @NSEOptionmessageBN  
     end  
     else  
     Begin  
     set  @NSEOptionmessageBN='Proper'  
     select  @NSEOptionmessageBN  
     End  
     end      
    end  
    else  
    begin  
     if(@FlagNSEoptB='Disable')  
     begin  
     if(@NSEFOOB1<@MinPerB)  
     begin  
      set @NSEOptionmessageBN='Brokerage is incorrect-bankNifty/bankEx'  
      select @NSEOptionmessageBN  
     end  
     else  
     Begin  
      set  @NSEOptionmessageBN='Proper'  
      select  @NSEOptionmessageBN  
     End  
     end  
     else  
     begin  
      if(@NSEFOOB1<@MinPerB or @NSEFOOB2 < @MinPerB)  
      begin  
       set @NSEOptionmessageBN='You cannot charge brokerage less than angel capping-bankNifty/bankEx'  
       select  @NSEOptionmessageBN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageBN='Proper'  
       select  @NSEOptionmessageBN  
      End  
     end  
    end  
   end  
   else  
   begin  
    If(@typeBN='R')  
    begin  
     select @FLegBankNifty=Fleg,@SlegBankNifty=Sleg from #nseBNiftyoption where scrip='BANKNIFTY'  
     if(@FLegBankNifty=0 and @SlegBankNifty=0)  
     begin  
      select @ClientLevelBrokT_NSEFOOptBN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
      if(@FlagNSEoptB='Disable')  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptBN)  
      begin  
       set @NSEOptionmessageBN='You cannot charge brokerage less than angel capping.-bankNifty/bankEx'  
       select @NSEOptionmessageBN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageBN='Proper'  
       select  @NSEOptionmessageBN  
      End  
      end  
      else  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptBN or @NSEFOOB2<@ClientLevelBrokT_NSEFOOptBN )  
      begin  
      set @NSEOptionmessageBN='Brokerage is incorrect R-bankNifty/bankEx'  
      Select @NSEOptionmessageBN  
      end  
      else  
      Begin  
      set  @NSEOptionmessageBN='Proper'  
      select  @NSEOptionmessageBN  
      End  
      end      
     end  
     else  
     begin  
      --if(@FlagNSEoptB='Disable')  
      --begin  
      --if(@NSEFOOB1<@FLegNifty)  
      --begin  
      -- set @NSEOptionmessageBN='Brokerage is incorrect'  
      -- select @NSEOptionmessageBN  
      --end  
      --else  
      --Begin  
      -- set  @NSEOptionmessageBN='Proper'  
      -- select  @NSEOptionmessageBN  
      --End  
      --end  
      --else  
      --begin  
       if(@NSEFOOB1<@FLegNifty or @NSEFOOB2 < @SlegBankNifty)  
       begin  
        set @NSEOptionmessageBN='Brokerage is incorrect-bankNifty/bankEx'  
        select @NSEOptionmessageBN  
       end  
       else  
       Begin  
        set  @NSEOptionmessageBN='Proper'  
        select  @NSEOptionmessageBN  
       End  
      --end  
     end  
    end  
   end  
    
 end   
 else  
 begin  
 If Exists(select * from mis.remisior.dbo.OptionShare_sb_new where subbrokercode=@SBCode  and scrip='BANKNIFTY')  
 begin  
  print 'hi'  
  select * into #nseBNiftyoptionSB from mis.remisior.dbo.OptionShare_sb_new where subbrokercode=@SBCode  and scrip='BANKNIFTY'  
   declare @typeBNSB as varchar(10)=''  
   select @typeBNSB=type from #nseBNiftyoptionSB  
   if(@typeBNSB='P')  
   begin  
    --declare @MinPerS as money,@MinPerN as money,@MinPerB as money  
    select @MinPerB=Minper from #nseBNiftyoptionSB where scrip='BANKNIFTY'  
    if(@MinPerB=0)  
    begin  
     select @ClientLevelBrokT_NSEFOOptBN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
     if(@FlagNSEoptB='Disable')  
     begin  
     if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptBN)  
     begin  
      set @NSEOptionmessageBN='You cannot charge brokerage less than angel capping.-bankNifty/bankEx'  
      select @NSEOptionmessageBN  
     end  
     else  
     Begin  
      set  @NSEOptionmessageBN='Proper'  
      select  @NSEOptionmessageBN  
     End  
     end  
     else  
     begin  
     if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptBN or @NSEFOOB2<@ClientLevelBrokT_NSEFOOptBN )  
     begin  
     set @NSEOptionmessageBN='Brokerage is incorrect R-bankNifty/bankEx'  
     Select @NSEOptionmessageBN  
     end  
     else  
     Begin  
	 
     set  @NSEOptionmessageBN='Proper'  
     select  @NSEOptionmessageBN  
     End   
     end     
    end  
    else  
    begin  
      if(@FlagNSEoptB='Disable')  
      begin  
      if(@NSEFOOB1<@MinPerB)  
      begin 
	  
       set @NSEOptionmessageBN='Brokerage is incorrect-bankNifty/bankEx'  
       select @NSEOptionmessageBN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageBN='Proper'  
       select  @NSEOptionmessageBN  
      End  
      end  
      else  
      begin  
      if(@NSEFOOB1<@MinPerB or @NSEFOOB2 < @MinPerB)  
      begin 
	  print 'check1'
	  print @MinPerB
	  print @NSEFOOB1
	  print @NSEFOOB2
	  print @NSEOptionmessageBN
	  print 'neha'
       set @NSEOptionmessageBN='Brokerage is incorrect-bankNifty/bankEx'  
       Select @NSEOptionmessageBN  
      end  
      else  
      Begin  
	  print 'check'
       set  @NSEOptionmessageBN='Proper'  
       select  @NSEOptionmessageBN  
      End  
      end  
    end  
   end  
   else  
   begin  
    If(@typeBNSB='R')  
    begin  
     --declare @FLegStock money,@SlegStock as money  
     select @FLegBankNifty=Fleg,@FLegBankNifty=Sleg from #nseBNiftyoptionSB where scrip='BANKNIFTY'  
     if(@FLegBankNifty=0 and @FLegBankNifty=0)  
     begin  
      select @ClientLevelBrokT_NSEFOOptBN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
      if(@FlagNSEoptB='Disable')  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptBN)  
      begin  
       set @NSEOptionmessageBN='You cannot charge brokerage less than angel capping.-bankNifty/bankEx'  
       select @NSEOptionmessageBN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageBN='Proper'  
       select  @NSEOptionmessageBN  
      End  
      end  
      else  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptBN or @NSEFOOB2<@ClientLevelBrokT_NSEFOOptBN )  
      begin  
      set @NSEOptionmessageBN='Brokerage is incorrect R-bankNifty/bankEx'  
      Select @NSEOptionmessageBN  
      end  
      else  
      Begin  
      set  @NSEOptionmessageBN='Proper'  
      select  @NSEOptionmessageBN  
      End  
      end      
     end  
     else  
     begin  
      --if(@FlagNSEoptB='Disable')  
      --begin  
      --if(@NSEFOOB1<@FLegBankNifty)  
      --begin  
      -- set @NSEOptionmessageBN='Brokerage is incorrect'  
      -- select @NSEOptionmessageBN  
      --end  
      --else  
      --Begin  
      -- set  @NSEOptionmessageBN='Proper'  
      -- select  @NSEOptionmessageBN  
      --End  
      --end  
      --else  
      --begin  
       if(@NSEFOOB1<@FLegBankNifty or @NSEFOOB2 < @FLegBankNifty)  
       begin  
        set @NSEOptionmessageBN='Brokerage is incorrect-bankNifty/bankEx'  
        Select @NSEOptionmessageBN  
       end  
       else  
       Begin  
        set  @NSEOptionmessageBN='Proper'  
        select  @NSEOptionmessageBN  
       End  
      --end  
     end  
    end  
   end  
  end  
  else  
  begin  
  /************************************If not exist for Bank nifty in SB**************************************/      
  If Exists(select * from mis.remisior.dbo.OptionShare_new where party_code=@ClientCode and scrip='STOCK OPTION')  
  begin  
   select * into #nseStockoptionA from mis.remisior.dbo.OptionShare_new where party_code=@ClientCode and scrip='STOCK OPTION'  
   declare @typeSO as varchar(10)=''  
   select @typeSO=type from #nseStockoptionA  
   if(@typeSO='P')  
   begin  
    select @MinPerSO=Minper from #nseStockoptionA where scrip='STOCK OPTION'  
    if(@MinPerSO=0)  
    begin  
     select @ClientLevelBrokT_NSEFOOptSO=ClientLevelBrok from SB_DefaultBrok_Mast where segment='StockOptions'  
     if(@FlagNSEoptB='Disable')  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptSO)  
      begin  
       set @NSEOptionmessageSO='You cannot charge brokerage less than angel capping.-bankNifty/bankEx'  
       select @NSEOptionmessageSO  
      end  
      else  
      Begin  
       set  @NSEOptionmessageSO='Proper'  
       select  @NSEOptionmessageSO  
      End  
      end  
      else  
      begin  
     if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptSO or @NSEFOOB2<@ClientLevelBrokT_NSEFOOptSO )  
     begin  
     set @NSEOptionmessageSO='Brokerage is incorrect R-bankNifty/bankEx'  
     Select @NSEOptionmessageSO  
     end  
     else  
     Begin  
     set  @NSEOptionmessageSO='Proper'  
     select  @NSEOptionmessageSO  
     End  
     end      
    end  
    else  
    begin  
      if(@FlagNSEoptB='Disable')  
      begin  
      if(@NSEFOOB1<@MinPerSO)  
      begin  
       set @NSEOptionmessageBN='Brokerage is incorrect-bankNifty/bankEx'  
       select @NSEOptionmessageBN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageBN='Proper'  
       select  @NSEOptionmessageBN  
      End  
      end  
      else  
      begin  
      if(@NSEFOOB1<@MinPerSO or @NSEFOOB2 < @MinPerSO)  
      begin  
       set @NSEOptionmessageSO='Brokerage is incorrect-bankNifty/bankEx'  
       select @NSEOptionmessageSO  
      end  
      else  
      Begin  
       set  @NSEOptionmessageSO='Proper'  
       select  @NSEOptionmessageSO  
      End  
      end  
    end  
   end  
   else  
   begin  
    If(@typeSO='R')  
    begin  
     select @FLegSO=Fleg,@SlegSO=Sleg from #nseStockoption where scrip='STOCK OPTION'  
     if(@FLegSO=0 and @SlegSO=0)  
     begin  
      select @ClientLevelBrokT_NSEFOOptSO=ClientLevelBrok from SB_DefaultBrok_Mast where segment='StockOptions'  
      if(@FlagNSEoptB='Disable')  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptSO)  
      begin  
       set @NSEOptionmessageSO='You cannot charge brokerage less than angel capping.-bankNifty/bankEx'  
       select @NSEOptionmessageSO  
      end  
      else  
      Begin  
       set  @NSEOptionmessageSO='Proper'  
       select  @NSEOptionmessageSO  
      End  
      end  
      else  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptSO or @NSEFOOB2<@ClientLevelBrokT_NSEFOOptSO )  
      begin  
       set @NSEOptionmessageSO='Brokerage is incorrect R-bankNifty/bankEx'  
       Select @NSEOptionmessageSO  
      end  
      else  
      Begin  
       set  @NSEOptionmessageSO='Proper'  
       select  @NSEOptionmessageSO  
      End   
      end     
     end  
     else  
     begin  
      --if(@FlagNSEoptB='Disable')  
      --begin  
      --if(@NSEFOOB1<@FLegSO)  
      --begin  
      -- set @NSEOptionmessageBN='Brokerage is incorrect'  
      -- select @NSEOptionmessageBN  
      --end  
      --else  
      --Begin  
      -- set  @NSEOptionmessageBN='Proper'  
      -- select  @NSEOptionmessageBN  
      --End  
      --end  
      --else  
      --begin  
       if(@NSEFOOB1<@FLegSO or @NSEFOOB2 < @SlegSO)  
       begin  
        set @NSEOptionmessageSO='Brokerage is incorrect-bankNifty/bankEx'  
        Select @NSEOptionmessageSO  
       end  
       else  
       Begin  
        set  @NSEOptionmessageSO='Proper'  
        select  @NSEOptionmessageSO  
       End  
      --end  
     end  
     end  
    end  
  end   
 else  
  begin  
    
  select * into #nseStockoptionSOSB from mis.remisior.dbo.OptionShare_sb_new where subbrokercode=@SBCode  and scrip='STOCK OPTION'  
   declare @typeSOSB as varchar(10)=''  
   select @typeSOSB=type from #nseStockoptionSOSB  
   if(@typeSOSB='P')  
   begin  
    --declare @MinPerS as money,@MinPerN as money,@MinPerB as money  
    select @MinPerSO=Minper from #nseStockoptionSOSB where scrip='STOCK OPTION'  
    if(@MinPerSO=0)  
    begin  
     select @ClientLevelBrokT_NSEFOOptSO=ClientLevelBrok from SB_DefaultBrok_Mast where segment='StockOptions'  
     if(@FlagNSEoptB='Disable')  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptSO)  
      begin  
       set @NSEOptionmessageSO='You cannot charge brokerage less than angel capping.-bankNifty/bankEx'  
       select @NSEOptionmessageSO  
      end  
      else  
      Begin  
       set  @NSEOptionmessageSO='Proper'  
       select  @NSEOptionmessageSO  
      End  
      end  
      else  
      begin  
     if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptSO or @NSEFOOB2<@ClientLevelBrokT_NSEFOOptSO )  
     begin  
      set @NSEOptionmessageSO='Brokerage is incorrect R-bankNifty/bankEx'  
      Select @NSEOptionmessageSO  
     end  
     else  
     Begin  
      set  @NSEOptionmessageSO='Proper'  
      select  @NSEOptionmessageSO  
     End  
     end      
    end  
    else  
    begin  
      if(@FlagNSEoptB='Disable')  
      begin  
      if(@NSEFOOB1<@MinPerSO)  
      begin  
       set @NSEOptionmessageBN='Brokerage is incorrect-bankNifty/bankEx'  
       select @NSEOptionmessageBN  
      end  
      else  
      Begin  
       set  @NSEOptionmessageBN='Proper'  
       select  @NSEOptionmessageBN  
      End  
      end  
      else  
      begin  
       if(@NSEFOOB1<@MinPerSO or @NSEFOOB2 < @MinPerSO)  
       begin  
        set @NSEOptionmessageSO='Brokerage is incorrect-bankNifty/bankEx'  
        Select @NSEOptionmessageSO  
       end  
       else  
       Begin  
        set  @NSEOptionmessageSO='Proper'  
        select  @NSEOptionmessageSO  
       End  
      end  
    end  
   end  
   else  
   begin  
   If(@typeSOSB='R')  
   begin  
     --declare @FLegStock money,@SlegStock as money  
     select @FLegSO=Fleg,@SlegSO=Sleg from #nseStockoptionSOSB where scrip='STOCK OPTION'  
     if(@FLegSO=0 and @SlegSO=0)  
     begin  
      select @ClientLevelBrokT_NSEFOOptSO=ClientLevelBrok from SB_DefaultBrok_Mast where segment='StockOptions'  
      if(@FlagNSEoptB='Disable')  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptSO)  
      begin  
       set @NSEOptionmessageSO='You cannot charge brokerage less than angel capping.-bankNifty/bankEx'  
       select @NSEOptionmessageSO  
      end  
      else  
      Begin  
       set  @NSEOptionmessageSO='Proper'  
       select  @NSEOptionmessageSO  
      End  
      end  
      else  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptSO or @NSEFOOB2<@ClientLevelBrokT_NSEFOOptSO )  
      begin  
       set @NSEOptionmessageSO='Brokerage is incorrect R-bankNifty/bankEx'  
       Select @NSEOptionmessageSO  
      end  
      else  
      Begin  
       set  @NSEOptionmessageSO='Proper'  
       select  @NSEOptionmessageSO  
      End   
      end     
     end  
     else  
     begin  
      --if(@FlagNSEoptB='Disable')  
      --begin  
      --if(@NSEFOOB1<@FLegSO)  
      --begin  
      -- set @NSEOptionmessageSO='Brokerage is incorrect'  
      -- select @NSEOptionmessageSO  
      --end  
      --else  
      --Begin  
      -- set  @NSEOptionmessageSO='Proper'  
      -- select  @NSEOptionmessageSO  
      --End  
      --end  
      --else  
      --begin  
      if(@NSEFOOB1<@FLegSO or @NSEFOOB2 < @SlegSO)  
      begin  
       set @NSEOptionmessageSO='Brokerage is incorrect-bankNifty/bankEx'  
       select @NSEOptionmessageSO  
      end  
      else  
      Begin  
       set  @NSEOptionmessageSO='Proper'  
       select  @NSEOptionmessageSO  
      End  
      --end  
     end  
    end  
   end  
  end   
  end  
 end  
 -----------------------------------------  
   
 end  
else  
 begin  
  If Exists(select * from mis.remisior.dbo.remimast_nsefo where party_code=@ClientCode and Calctype='' and ExceptClient='Yes' and todate>getdate())  
  begin  
   select @ClientLevelBrokT_NSEFOOptN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
   select @ClientLevelBrokT_NSEFOOptBN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
   select @ClientLevelBrokT_NSEFOOptFN=ClientLevelBrok from SB_DefaultBrok_Mast where segment='IndexOptions'  
   select @ClientLevelBrokT_NSEFOOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='StockOptions'  
     if(@FlagNSEoptB='Disable' or @FlagNSEoptN='Disable' or @FlagNSEoptS='Disable' or @FlagNSEoptFN='Disable')  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptBN or @NSEFOON1<@ClientLevelBrokT_NSEFOOptN or  @NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN or @NSEFOOS1<@ClientLevelBrokT_NSEFOOpt)  
      begin  
       set @NSEOptionmessageSO='You cannot charge brokerage less than angel capping.-ALL'  
       select @NSEOptionmessageSO  
      end  
      else  
      Begin  
       set  @NSEOptionmessageSO='Proper'  
       select  @NSEOptionmessageSO  
      End  
      end  
      else  
      begin  
      if(@NSEFOOB1<@ClientLevelBrokT_NSEFOOptSO or @NSEFOOB2<@ClientLevelBrokT_NSEFOOptSO or @NSEFOON1<@ClientLevelBrokT_NSEFOOptN or @NSEFOON2<@ClientLevelBrokT_NSEFOOptN or @NSEFOOFN1<@ClientLevelBrokT_NSEFOOptFN or @NSEFOOFN2<@ClientLevelBrokT_NSEFOOptFN or @NSEFOOS1<@ClientLevelBrokT_NSEFOOpt or @NSEFOOS2<@ClientLevelBrokT_NSEFOOpt ) 
 
      begin  
       set @NSEOptionmessageSO='Brokerage is incorrect R-ALL'  
       Select @NSEOptionmessageSO  
      end  
      else  
      Begin  
       set  @NSEOptionmessageSO='Proper'  
       select  @NSEOptionmessageSO  
      End   
      end  
 end  
 end         
   
   
End   
/********************************* NSX Option *******************************************/  
declare @SBCodeNSX as varchar(50)=''  
select @SBCodeNSX=sub_broker from client_details where party_code=@ClientCode  
declare @MinPerNSX as money,@ClientLevelBrokT_NSXOpt as money  
declare @messageNSXOpt as varchar(50),@FLegNSXOption as money, @SlegNSXOption as money  
set @messageNSXOpt=''  
If(@Segment='NSXOption')  
Begin  
 If Exists(select * from mis.remisior.dbo.remimast_nsx where party_code=@ClientCode and Calctype='' and ExceptClient='No' and todate>getdate())  
 begin  
  If Exists(select * from mis.remisior.dbo.OptionShare_new_nsx where party_code=@ClientCode and scrip='STOCK OPTION')  
  begin  
   select * into #nsxoption from mis.remisior.dbo.OptionShare_new_nsx where party_code=@ClientCode and scrip='STOCK OPTION'  
   declare @typeNSX as varchar(10)=''  
   select @typeNSX=type from #nsxoption  
   if(@typeNSX='P')  
   begin  
    select @MinPerNSX=Minper from #nsxoption where scrip='STOCK OPTION'  
    if(@MinPerNSX=0)  
    begin  
     select @ClientLevelBrokT_NSXOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Currency Options'  
     if(@FlagNSXoptS='Disable')  
      begin  
      if(@NSXO1<@ClientLevelBrokT_NSXOpt)  
      begin  
       set @messageNSXOpt='You cannot charge brokerage less than angel capping.-nsxOptions'  
       select @messageNSXOpt  
      end  
      else  
      Begin  
       set  @messageNSXOpt='Proper'  
       select  @messageNSXOpt  
      End  
      end  
      else  
      begin  
     if(@NSXO1<@ClientLevelBrokT_NSXOpt or @NSXO2<@ClientLevelBrokT_NSXOpt )  
     begin  
      set @messageNSXOpt='Brokerage is incorrect R-nsxOptions'  
      Select @messageNSXOpt  
     end  
     else  
     Begin  
      set  @messageNSXOpt='Proper'  
      select  @messageNSXOpt  
     End   
     end     
    end  
    else  
    begin  
      if(@FlagNSXoptS='Disable')  
      begin  
      if(@NSXO1<@MinPerNSX)  
      begin  
       set @messageNSXOpt='Brokerage is incorrect-nsxOptions'  
       select @messageNSXOpt  
      end  
      else  
      Begin  
       set  @messageNSXOpt='Proper'  
       select  @messageNSXOpt  
      End  
      end  
      else  
      begin  
      if(@NSXO1<@MinPerNSX or @NSXO2< @MinPerNSX)  
      begin  
       set @messageNSXOpt='Brokerage is incorrect-nsxOptions'  
       Select @messageNSXOpt  
      end  
      else  
      Begin  
       set  @messageNSXOpt='Proper'  
       select @messageNSXOpt  
      End  
      end  
    end  
   end  
   else  
   begin  
    If(@typeNSX='R')  
    begin  
     select @FLegNSXOption=Fleg,@SlegNSXOption=Sleg from #nsxoption where scrip='STOCK OPTION'  
     if(@FLegNSXOption=0 and @SlegNSXOption=0)  
     begin  
      select @ClientLevelBrokT_NSXOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Currency Options'  
      if(@FlagNSXoptS='Disable')  
      begin  
      if(@NSXO1<@ClientLevelBrokT_NSXOpt)  
      begin  
       set @messageNSXOpt='You cannot charge brokerage less than angel capping.-nsxOptions'  
       select @messageNSXOpt  
      end  
      else  
      Begin  
       set  @messageNSXOpt='Proper'  
       select  @messageNSXOpt  
      End  
      end  
      else  
      begin  
      if(@NSXO1<@ClientLevelBrokT_NSXOpt or @NSXO2<@ClientLevelBrokT_NSXOpt )  
      begin  
       set @messageNSXOpt='Brokerage is incorrect R-nsxOptions'  
       Select @messageNSXOpt  
      end  
      else  
      Begin  
       set  @messageNSXOpt='Proper'  
       select  @messageNSXOpt  
      End  
      end      
     end  
     else  
     begin  
      --if(@FlagNSXoptS='Disable')  
      --begin  
      --if(@NSXO1<@FLegNSXOption)  
      --begin  
      -- set @messageNSXOpt='Brokerage is incorrect'  
      -- select @messageNSXOpt  
      --end  
      --else  
      --Begin  
      -- set  @messageNSXOpt='Proper'  
      -- select  @messageNSXOpt  
      --End  
      --end  
      --else  
      --begin  
       if(@NSXO1<@FLegNSXOption or @NSXO2 < @SlegNSXOption)  
       begin  
        set @messageNSXOpt='Brokerage is incorrect-nsxOptions'  
        Select @messageNSXOpt  
       end  
       else  
       Begin  
        set  @messageNSXOpt='Proper'  
        select  @messageNSXOpt  
       End  
      --end  
     end  
    end  
   end  
    
 end   
else  
  begin   
  print 'hiii'  
  if exists (select * from mis.remisior.dbo.OptionShare_sb_new_nsx where subbrokercode=@SBCodeNSX and scrip='STOCK OPTION')  
  begin  
  select * into #nsxoptionSB from mis.remisior.dbo.OptionShare_sb_new_nsx where subbrokercode=@SBCodeNSX and scrip='STOCK OPTION'  
   declare @typeNSXSB as varchar(10)=''  
   select @typeNSXSB=type from #nsxoptionSB  
   if(@typeNSXSB='P')  
   begin  
    --declare @MinPerS as money,@MinPerN as money,@MinPerB as money  
    select @MinPerNSX=Minper from #nsxoptionSB where scrip='STOCK OPTION'  
    if(@MinPerNSX=0)  
    begin  
     select @ClientLevelBrokT_NSXOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Currency Options'  
     if(@FlagNSXoptS='Disable')  
      begin  
      if(@NSXO1<@ClientLevelBrokT_NSXOpt)  
      begin  
       set @messageNSXOpt='You cannot charge brokerage less than angel capping.-nsxOptions'  
       select @messageNSXOpt  
      end  
      else  
      Begin  
       set  @messageNSXOpt='Proper'  
       select  @messageNSXOpt  
      End  
      end  
      else  
      begin  
     if(@NSXO1<@ClientLevelBrokT_NSXOpt or @NSXO2<@ClientLevelBrokT_NSXOpt )  
     begin  
     set @messageNSXOpt='Brokerage is incorrect R-nsxOptions'  
     Select @messageNSXOpt  
     end  
     else  
     Begin  
     set  @messageNSXOpt='Proper'  
     select  @messageNSXOpt  
     End   
     end     
    end  
    else  
    begin  
    if(@FlagNSXoptS='Disable')  
      begin  
      if(@NSXO1<@MinPerNSX)  
      begin  
       set @messageNSXOpt='Brokerage is incorrect-nsxOptions'  
       select @messageNSXOpt  
      end  
      else  
      Begin  
       set  @messageNSXOpt='Proper'  
       select  @messageNSXOpt  
      End  
      end  
      else  
      begin  
     if(@NSXO1<@MinPerNSX or @NSXO2 < @MinPerNSX)  
     begin  
      set @messageNSXOpt='Brokerage is incorrect-nsxOptions'  
      Select @messageNSXOpt  
     end  
     else  
     Begin  
      set  @messageNSXOpt='Proper'  
      select  @messageNSXOpt  
     End  
     end  
    end  
   end  
   else  
   begin  
    If(@typeNSXSB='R')  
    begin  
     --declare @FLegStock money,@SlegStock as money  
     select @FLegNSXOption=Fleg,@SlegNSXOption=Sleg from #nsxoptionSB where scrip='STOCK OPTION'  
     if(@FLegNSXOption=0 and @SlegNSXOption=0)  
     begin  
      select @ClientLevelBrokT_NSXOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Currency Options'  
      if(@FlagNSXoptS='Disable')  
      begin  
      if(@NSXO1<@ClientLevelBrokT_NSXOpt)  
      begin  
       set @messageNSXOpt='You cannot charge brokerage less than angel capping.-nsxOptions'  
       select @messageNSXOpt  
      end  
      else  
      Begin  
       set  @messageNSXOpt='Proper'  
       select  @messageNSXOpt  
      End  
      end  
      else  
      begin  
      if(@NSXO1<@ClientLevelBrokT_NSXOpt or @NSXO2<@ClientLevelBrokT_NSXOpt )  
      begin  
       set @messageNSXOpt='Brokerage is incorrect R-nsxOptions'  
       Select @messageNSXOpt  
      end  
      else  
      Begin  
      set  @messageNSXOpt='Proper'  
      select  @messageNSXOpt  
      End  
      end      
     end  
     else  
     begin  
      --if(@FlagNSXoptS='Disable')  
      --begin  
      --if(@NSXO1<@FLegNSXOption)  
      --begin  
      -- set @messageNSXOpt='Brokerage is incorrect'  
      -- select @messageNSXOpt  
      --end  
      --else  
      --Begin  
      -- set  @messageNSXOpt='Proper'  
      -- select  @messageNSXOpt  
      --End  
      --end  
      --else  
      --begin  
       if(@NSXO1<@FLegNSXOption or @NSXO2 < @SlegNSXOption)  
       begin  
        set @messageNSXOpt='Brokerage is incorrect-nsxOptions'  
        Select @messageNSXOpt  
       end  
       else  
       Begin  
        set  @messageNSXOpt='Proper'  
        select  @messageNSXOpt  
       End  
      --end  
     end  
    end  
   end  
   end  
   else  
   begin  
   print 'hi'  
   select @ClientLevelBrokT_NSXOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Currency Options'  
      if(@FlagNSXoptS='Disable')  
      begin  
       if(@NSXO1<@ClientLevelBrokT_NSXOpt)  
       begin  
       print @ClientLevelBrokT_NSXOpt  
        set @messageNSXOpt='You cannot charge brokerage less than angel capping.-nsxOptions'  
        select @messageNSXOpt  
       end  
       else  
       Begin  
        set  @messageNSXOpt='Proper'  
        select  @messageNSXOpt  
       End  
      end  
      else  
      begin  
       if(@NSXO1<@ClientLevelBrokT_NSXOpt or @NSXO2<@ClientLevelBrokT_NSXOpt )  
       begin  
       print 'hi'  
        set @messageNSXOpt='Brokerage is incorrect R-nsxOptions'  
        Select @messageNSXOpt  
       end  
       else  
       Begin  
        set  @messageNSXOpt='Proper'  
        select  @messageNSXOpt  
       End   
              end   
   end  
   end  
 end  
else  
 begin  
  If Exists(select * from mis.remisior.dbo.remimast_nsx where party_code=@ClientCode and Calctype='' and ExceptClient='Yes' and todate>getdate())  
  begin  
    select @ClientLevelBrokT_NSXOpt=ClientLevelBrok from SB_DefaultBrok_Mast where segment='Currency Options'  
      if(@FlagNSXoptS='Disable')  
      begin  
       if(@NSXO1<@ClientLevelBrokT_NSXOpt)  
       begin  
       print @ClientLevelBrokT_NSXOpt  
        set @messageNSXOpt='You cannot charge brokerage less than angel capping.-nsxOptions'  
        select @messageNSXOpt  
       end  
       else  
       Begin  
        set  @messageNSXOpt='Proper'  
        select  @messageNSXOpt  
       End  
      end  
      else  
      begin  
       if(@NSXO1<@ClientLevelBrokT_NSXOpt or @NSXO2<@ClientLevelBrokT_NSXOpt )  
       begin  
       print 'hi'  
        set @messageNSXOpt='Brokerage is incorrect R-nsxOptions'  
        Select @messageNSXOpt  
       end  
       else  
       Begin  
        set  @messageNSXOpt='Proper'  
        select  @messageNSXOpt  
       End   
              end     
   end  
 end       
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Cusa_Payout
-- --------------------------------------------------


CREATE proc [dbo].[SP_Cusa_Payout]
as

begin


 Exec AngelBSECM.inhouse.dbo.Fetch_CliUnreco                                                
 Exec AngelNseCM.inhouse.dbo.Fetch_CliUnreco                                                
 Exec angelfo.inhouse.dbo.Fetch_CliUnreco                                                
 Exec angelfo.inhouse_curfo.dbo.Fetch_CliUnreco                                                
 Exec angelcommodity.inhouse_BSX.dbo.Fetch_CliUnreco    
 Exec angelcommodity.INHOUSE_MCDCS.dbo.Fetch_CliUnreco                                                
 Exec angelfo.inhouse.dbo.Fetch_CliUnreco                                                
 Exec angelfo.inhouse.dbo.Fetch_CliUnreco 
  --uncomment below query when making BSEFO live
 Exec angelcommodity.bsefo.dbo.Fetch_CliUnreco 
  Exec angelcommodity.dustbin.dbo.Fetch_CliUnreco    

 
 ---94 server issue commented
  /* SHORTAGE */                                                
 exec risk.dbo.get_shortage                                                
 exec risk.dbo.Usp_Calc_ShrtVal                                                
 exec cms.dbo.NCMS_Shortage
 /************/  


/******Added by Neha Naiwar on 30 Apr 2021 fro Relesing Due Settelment*************************************************************/
exec [CSOKYC-6].general.dbo.Cusa_Due_settNo
/*************************End*********************************************************/ 
/************Added for removing multiple isin with blank name from scrip master (Added on 04 Jun 2021)***************************************/
        drop table cusa_scrip
        select * into cusa_scrip from [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS with(nolock)
        select [isin no] into #scrip from cusa_scrip group by [isin no] having COUNT(1)>1
        delete from cusa_scrip where  [isin no] in (select [isin no] from #scrip) and  [co name]='-'
/****************************************************/

select Security_Symbol,Security_ISIN,MAX(mtm_price) as mtm_price  into #Combine_Closing_File from [CSOKYC-6].GENERAL.DBO.Combine_Closing_File with(nolock) group by Security_Symbol,Security_ISIN

/*****Added on 10 Apr 2023 for taking sett no from sett master****************/
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty,'Cusa' as Flag,transdate into #CUSA_code1 from AngelDemat.msajag.dbo.deltrans with(nolock) where  
drcr='d' and delivered ='0' and filler2='1' and bcltdpid in ('1203320186015090','IN30134820306643')  /*'1203320018512051',*/
group by bcltdpid,party_code,certno,sett_no,transdate   
union all   
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty,'Cusa' as Flag,transdate  from AngelDemat.bsedb.dbo.deltrans with (nolock) where   
drcr='d' and delivered ='0' and filler2='1' and bcltdpid in ('1203320186015090','IN30134820306643')/*='1203320018512051'*/  
group by bcltdpid,party_code,certno,sett_no,transdate  
  
  --update #CUSA_code1 set  transdate='2023-04-03 00:00:00.000' where  transdate='2023-04-04 00:00:00.000'
    update #CUSA_code1 set  transdate='2023-12-01 00:00:00.000' where  transdate='2023-12-02 00:00:00.000'  


--update a set a.sett_no=b.sett_no from #CUSA_code1 a left join [CSOKYC-6].General.dbo.BO_Sett_Mst b  WITH(NOLOCK)  on a.transdate=b.Sec_Payin
--where    co_code='NSECM' and sett_type='M' and a.bcltdpid in ('1203320186015090','IN30134820306643')

 select Sec_Payin,max(sett_no) sett_no into #sett_master from [CSOKYC-6].General.dbo.BO_Sett_Mst b  WITH(NOLOCK) 
where    co_code='NSECM' and sett_type='M'  group by Sec_Payin

update a set a.sett_no=b.sett_no from #CUSA_code1 a left join #sett_master b  WITH(NOLOCK)  on a.transdate=b.Sec_Payin
where  a.bcltdpid in ('1203320186015090','IN30134820306643')

select distinct bcltdpid,party_code,certno,sett_no,qty,Flag into #CUSA_code from #CUSA_code1 with (nolock)
/**********************************/

select *,qty+Mtf_qty as FinalQty into #Uncusa from AngelDemat.Msajag.dbo.UNSETTLED_CUSA_PAYOUT with(nolock) 

insert into #CUSA_code
select partipantcode,party_code,i_isin,sett_no,SUM(FinalQty) as qty,'Un' as Flag from #Uncusa with(nolock) where FinalQty>0
group by partipantcode,party_code,i_isin,sett_no

/*
declare @sdtcur as datetime,@Todate as datetime = convert(varchar(11),getdate())+' 23:59:59'     
select @sdtcur=sdtcur from anand.account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()           
*/

declare @sdtcur as datetime,@Todate as datetime = convert(varchar(11),getdate())+' 23:59:59'       
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            

/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter where ldtcur        =
(select ldtprv from AngelBSECM.account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE())  

  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,
  UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/
  UnRecoCr =0           
  INTO #BSECMcltop                             
  from AngelBSECM.account_ab.dbo.ledger a with (nolock)                 
  where VDT>=@sdtcur and VDT <= @Todate --  and cltcode in (select party_code from #CUSA_code) 
   /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from AngelBSECM.account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  group by cltcode   
    
    select * into #BSECMOpn from #BSECMcltop where cltcode in (select party_code from #CUSA_code)   
    
     update #BSECMOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  AngelBSECM.inhouse.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #BSECMOpn.cltcode=b.cltcode            
  
 select CLTCODE,              
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,
  UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/
  UnRecoCr=0                    
  into  #NSECMcltop             
  from AngelNseCM.account.dbo.ledger a with (nolock)                     
  where VDT>=@sdtcur and VDT <= @Todate     
   /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from AngelNseCM.account.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  group by cltcode    
    
  select * into #NSECMOpn from #NSECMcltop where cltcode in (select party_code from #CUSA_code)                
   
   update #NSECMOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  AngelNseCM.inhouse.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #NSECMOpn.cltcode=b.cltcode        
  
  select CLTCODE,              
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)   ,
  UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/
  UnRecoCr =0        
  into #NSEFOcltop              
  from angelfo.accountfo.dbo.ledger a with (nolock)                     
  where VDT>=@sdtcur and  VDT <= @Todate  
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from angelfo.accountfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  group by cltcode                  
  
  select * into #NSEFOOpn from #NSEFOcltop where cltcode in (select party_code from #CUSA_code)                
  
  update #NSEFOOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #NSEFOOpn.cltcode=b.cltcode  
              
  select CLTCODE,              
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,
  UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/
  UnRecoCr=0           
  into #NSXcltop              
  from angelfo.accountcurfo.dbo.ledger a with (nolock)                     
  where VDT>=@sdtcur and  VDT <= @Todate 
     /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from angelfo.accountcurfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  group by cltcode       
    
    select * into #NSXOpn from #NSXcltop where cltcode in (select party_code from #CUSA_code)                
  
  update #NSXOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse_curfo.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #NSXOpn.cltcode=b.cltcode 
    
  select CLTCODE,              
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,
  UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/
  UnRecoCr=0             
  into #BSXcltop              
  from angelcommodity.ACCOUNTcurbfo.dbo.ledger  a with (nolock)                     
  where VDT>=@sdtcur and  VDT <= @Todate 
   /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTcurbfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  group by cltcode   
    
      select * into #BSXOpn from #BSXcltop where cltcode in (select party_code from #CUSA_code)                
  
  update #BSXOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_BSX.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #BSXOpn.cltcode=b.cltcode 
             
  select CLTCODE,        
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,
  UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/
  UnRecoCr=0            
  into #MCDcltop              
  from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                     
  where VDT>=@sdtcur and  VDT <= @Todate   
  /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdxcds.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  group by cltcode                  
    
   select * into #MCDOpn from #MCDcltop where cltcode in (select party_code from #CUSA_code)                
  
  update #MCDOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.INHOUSE_MCDCS.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #MCDOpn.cltcode=b.cltcode 
          
  /*select CLTCODE,              
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,
  UnsettledCrBill=0,/*sum(case when drcr='D' then -VAMT else VAMT end) ,*/
  UnRecoCr=0           
  into #MTFcltop             
  from anand1.MTFTRADE.dbo.ledger  a with (nolock)                     
  where VDT>=@sdtcur and  VDT <= @Todate                 
  group by cltcode*/                  
    
  select party_code as CLTCODE,vbal=0,--case when SUM(Available_Cash_bal)>0 then 0 else SUM(Available_Cash_bal) end, /*SUM(Available_Cash_bal), */
  UnsettledCrBill=0,/*sum(case when drcr='D' then -VAMT else VAMT end) ,*/
  UnRecoCr=0
  into #MTFcltop   
  from   AngelNseCM.MTFTrade.dbo.MTF_Avilable_Cash with(nolock) where sauda_date>=@sdtcur and sauda_date <= @Todate
  group by party_code  
   
   select * into #MTFOpn from #MTFcltop where cltcode in (select party_code from #CUSA_code) 
   select * into #MTFAvaliableCash from #MTFcltop where cltcode in (select party_code from #CUSA_code)                 
 --#MTFOpn  where cltcode='A1002431'
    /*********Adjust Unsetteled holding in MTF avaiable cash************************/
   
select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,
CONVERT(MONEY, 0) as Value_BHC_unsett,
CONVERT(MONEY, 0) as Value_AHC_unsett
  into #unsett_holding from /*AngelDemat.msajag.dbo.unclear_hold*/  AngelDemat.msajag.dbo.unclear_Hold_New  a with(nolock) join
 /*[CSOKYC-6].GENERAL.DBO.Combine_Closing_File*/#Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/
a.I_isin=b.security_isin join /*[CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS*/ cusa_scrip c with(nolock) on a.I_isin=c.[isin no]

--AngelDemat.msajag.dbo.unclear_hold where party_code='G48414'                                          

update #unsett_holding set Value_BHC_unsett=0/*qty*MTM_Price_unsett*/
update #unsett_holding set Value_AHC_unsett=0/*isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)*/

/*insert into Cusa_unsett_holding
select * from #unsett_holding    
*/ 

select SUM(Value_BHC_unsett) as Unsetteled_BHC,party_code into #unsett_holding_Final from #unsett_holding group by party_code            
  
  update #MTFOpn set  vbal=case when vbal=0 then Unsetteled_BHC else vbal-Unsetteled_BHC end from #unsett_holding_Final b where #MTFOpn.cltcode=b.party_code
  /*  update #MTFOpn set  vbal=Unsetteled_BHC-vbal from #unsett_holding_Final b where #MTFOpn.cltcode=b.party_code*/
  --select a.* ,b.Unsetteled_BHC from #MTFOpn a join #unsett_holding_Final b on a.CLTCODE=b.party_code
   
insert into #MTFOpn
select party_code,0 as Unsetteled_AHC,0 as UnsettledCrBill,0 as UnRecoCr  from #unsett_holding_Final where party_code not in (select cltcode from #MTFOpn )

  /****************************************************/
   
 /*   update #MTFOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #MTFOpn.cltcode=b.cltcode */
                   
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,
  UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/
  UnRecoCr=0                 
  into #MCDXcltop                  
  from angelcommodity.accountmcdx.dbo.ledger a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate 
   /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  group by cltcode                      
      
   select * into #MCDXOpn from #MCDXcltop where cltcode in (select party_code from #CUSA_code)                 
  
    update #MCDXOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_MCDX.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #MCDXOpn.cltcode=b.cltcode     
                      
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,
  UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/
  UnRecoCr=0                  
  into #NCDXcltop                 
  from angelcommodity.accountncdx.dbo.ledger a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate    
   /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountncdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  group by cltcode   
    
  select * into #NCDXOpn from #NCDXcltop where cltcode in (select party_code from #CUSA_code)                 

 update #NCDXOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_NCDX.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #NCDXOpn.cltcode=b.cltcode  

  /**********NSE Commodity*********ORE-3463************************************************/
   select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)      
  into #NCEcltop                   
  from angelcommodity.ACCOUNTNCE.dbo.ledger a with (nolock)                           
  where VDT>=@sdtcur and  VDT <= @Todate      
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTNCE.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
  select * into #NCEOpn from #NCEcltop where cltcode in (select party_code from #CUSA_code)  
  
   update #NCEOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.Dustbin.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #NCEOpn.cltcode=b.cltcode  
 /*******************************************************************/


 /*************BSEFO*******************************/
  --uncomment below query when making BSEFO live
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),
   UnsettledCrBill=0, 
   UnRecoCr=0            
  into #BSEFOcltop                
  from angelcommodity.ACCOUNTBFO.dbo.ledger  a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate   
   /*Added to exclude opening balance of current year*/  
 /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTBFO.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
  and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
  select * into #BSEFOOpn from #BSEFOcltop where cltcode in (select party_code from #CUSA_code) 
  
  update #BSEFOOpn set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.BSEFO.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b            
 where #BSEFOOpn.cltcode=b.cltcode  
 --/*******************************************/
 select CLTCODE,              
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,
  UnsettledCrBill=0,/*sum(case when drcr='D' then -VAMT else VAMT end) ,*/
  UnRecoCr=0           
  into #MTFClientcodes             
  from AngelNseCM.MTFTRADE.dbo.ledger  a with (nolock)                     
  where VDT>=@sdtcur and  VDT <= @Todate                 
  group by cltcode

    select * into #MTFLedgerBal from #MTFClientcodes where cltcode in (select party_code from #CUSA_code)      
	
 select cltcode,sum(vbal) as Net_Ledger into #Tbl_rms from (                                            
  select CLTCODE,VBal from #NSECMOpn              
  union all                                            
  select CLTCODE,VBal from #BSECMOpn 
  union all                                            
  select CLTCODE,VBal from #NSEFOOpn 
  union all                                            
  select CLTCODE,VBal from #NSXOpn 
  union all                                            
  select CLTCODE,VBal from #MCDOpn 
  union all                                            
  select CLTCODE,VBal from #MTFLedgerBal                    
  union all                                  
  select CLTCODE,VBal from #MCDXOpn                                         
  union all                                            
  select CLTCODE,VBal from #NCDXOpn                                                                  
  union all                                            
  select CLTCODE,VBal from #BSXOpn 
  --uncomment below query when making BSEFO live 
  union all
  select CLTCODE,VBAL FROM  #BSEFOOpn 
  union all 
   select CLTCODE,VBal from #NCEOpn
  )x  group by cltcode
 
 select * into #Bal from (                                            
  select * from #NSECMOpn              
  union all                                            
  select * from #BSECMOpn 
  union all                                            
  select * from #NSEFOOpn 
  union all                                            
  select * from #NSXOpn 
  union all                                            
  select * from #MCDOpn 
  union all                                            
  select * from #MTFOpn                    
  union all                                  
  select * from #MCDXOpn                                         
  union all                                            
  select * from #NCDXOpn                                                                  
  union all                                            
  select * from #BSXOpn 
  --uncomment below query when making BSEFO live 
  union all
  select * FROM  #BSEFOOpn
    union all 
   select CLTCODE,VBal from #NCEOpn
  )x 
 
 select * into #actualBal from (                                            
  select * from #NSECMOpn  
  union all                                            
  select * from #BSECMOpn 
  union all                                            
  select * from #NSEFOOpn  
  union all                                            
  select * from #NSXOpn
  union all                                            
  select * from #MCDOpn 
  --union all                                            
  --select * from #MTFOpn
  union all                                  
  select * from #MCDXOpn                                            
  union all                                            
  select * from #NCDXOpn                                                                    
  union all                                            
  select * from #BSXOpn  
    --uncomment below query when making BSEFO live 
  union all
  select * FROM  #BSEFOOpn 
    union all 
   select CLTCODE,VBal from #NCEOpn
  )x 
  
  select  CLTCODE,sum(VBal) as val,sum(UnsettledCrBill) as UnsettledCrBill,sum(UnRecoCr) as UnRecoCr  into #ActualLedgerBAl from #actualBal  group by  cltcode  

  select  CLTCODE,sum(VBal) as val,sum(UnsettledCrBill) as UnsettledCrBill,sum(UnRecoCr) as UnRecoCr,CONVERT(money,0.00) as AccruedCharges
  ,CONVERT(money,0.00) as ShortSellValue  into #All from #Bal  group by  cltcode  
  
  /*
 select party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                 
 from misc.dbo.Accrued_PenalCharges with (nolock) group by party_code 
 
  /******added new margin peneality charges on 05 Jul 2021***********************************/  
 insert into #Accrued1  
  select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code   
  
 
insert into  #Accrued1
SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)
where cnt_Date=(select max(cnt_Date) from AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))
group by cltcode

insert into  #Accrued1
SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock),AngelNseCM.MSAJAG.DBO.client_details c(Nolock)
where  PCN_Date=(select max(PCN_Date) from AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock))
 and J.cl_code=c.cl_code
group by J.cl_code           
  
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                         
*/  
select a.PARTY_CODE,(OTHER_DEBIT*-1) as OTHER_DEBIT into #AccCharges from tbl_other_debit_MTF a with (nolock)  
  
 select a.PARTY_CODE,DeductEQ=sum(a.OTHER_DEBIT),DeductComm=0.00 into #Accrued1  
 from #AccCharges a with (nolock)  
 group by a.PARTY_CODE   

   select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                           

 /****************************************/        
 
 update #Accrued set DeductEQ=0 where DeductEQ<200 /**Added on 30 Apr 2021 by Neha Naiwar **/
 
 update #All set AccruedCharges=-DeductEQ  from #Accrued b                                                 
 where #All.CLTCODE=b.party_code  
                                               
 update #All set ShortSellValue=-b.shrtval from                                                
(select party_code,shrtval=SUM(SHORT_VALUE) from ncms_shortsell group by party_Code having sum(SHORT_VALUE) <> 0) b                  
 where   #All.CLTCODE=b.party_Code 

 SELECT CLTCODE,val,UnsettledCrBill,UnRecoCr,AccruedCharges,ShortSellValue,val+ UnRecoCr+ /*(ShortSellValue*1.2)+*/AccruedCharges as LedgerBal 
 into #LedgerBal from #All

select bcltdpid,party_code,certno,sett_no,sum(qty) as qty into #MarginPleadge  from AngelDemat.msajag.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'
group by bcltdpid,party_code,certno,sett_no
union all
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty  from AngelDemat.bsedb.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'
group by bcltdpid,party_code,certno,sett_no

select * into #client_col from  [CSOKYC-6].GENERAL.DBO.client_collaterals with(nolock) 

select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,
CONVERT(MONEY, 0) as Var_margin,
CONVERT(varchar(10), '') as series,
CONVERT(MONEY, 0) as Value_BHC,
CONVERT(MONEY, 0) as Value_AHC
  into #marPledge from #MarginPleadge a left join #Combine_Closing_File b with(nolock) on 
a.certno=b.security_isin

select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre from #client_col where party_code in (select distinct party_code from #marPledge)


update #marPledge set series=b.series,var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre b
where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin 
 
update #marPledge set MTM_Price=b.cl_rate from #wre b where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin and #marPledge.MTM_Price=0.00


update #marPledge set Value_BHC=qty*MTM_Price
update #marPledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)

select SUM(Value_AHC) as Margin_pleadge_AHC,party_code into #marPledge_Final from #marPledge group by party_code

/*****Unpleadge**/
select party_code,scrip,isin,sum(markedqty) as qty into #unpledge_code from tbl_UnpledgeFile with(nolock)
 group by party_code,scrip,isin

select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,
CONVERT(MONEY, 0) as Var_margin,  
CONVERT(MONEY, 0) as Value_BHC,  
CONVERT(MONEY, 0) as Value_AHC  
  into #unpledge from #unpledge_code a left join #Combine_Closing_File b with(nolock) on 
a.isin=b.security_isin  
  
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre1 from #client_col
  
update #unpledge set var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre1 b  
where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin   
   
update #unpledge set MTM_Price=b.cl_rate from #wre1 b where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin and #unpledge.MTM_Price=0.00  
   
update #unpledge set Value_BHC=qty*MTM_Price  
update #unpledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100) 

select sum(Value_AHC) as Unpledge_AHC,party_Code into #unpledge_codes from #unpledge   group by party_code  

select a.party_code,isnull(Margin_pleadge_AHC,0.00)-isnull(Unpledge_AHC,0.00)  as Margin_Pledge_final_AHC into #Final_Margin_Pledge 
from #marPledge_Final a left join #unpledge_codes b on a.party_code=b.party_code

update #Final_Margin_Pledge set Margin_Pledge_final_AHC=0.00 where Margin_Pledge_final_AHC<0

/******End*******************************************************/

select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price_cusa,c.[Angel scrip category] as Angel_Scrip_cusa,
case when c.[isin no] like 'INF%' and c.[angel_var %]=100.00 then 15.00 
									when c.[ANGEL_VAR %]<20.00 then 20.00 else c.[ANGEL_VAR %]   end  as Var_margin_cusa
,c.series,
CONVERT(MONEY, 0) as Value_BHC_cusa,
CONVERT(MONEY, 0) as Value_AHC_cusa,[BSE code] as BSEcode,[NSE symbol] as NSEsymbol
  into #CUSA_code_Main from #CUSA_code a left join #Combine_Closing_File b with(nolock) on 
a.certno=b.security_isin join  cusa_scrip c with(nolock) on a.certno=c.[isin no]

alter table #CUSA_code_Main add value_BHC_UnNew money

update #CUSA_code_Main set Value_BHC_cusa=qty*MTM_Price_cusa
update #CUSA_code_Main set Value_AHC_cusa=isnull(Value_BHC_cusa,0)-(isnull(Value_BHC_cusa,0)*isnull(Var_margin_cusa,0)/100)
update #CUSA_code_Main set value_BHC_UnNew=Value_BHC_cusa where flag='Un'

select sum(Value_AHC_cusa) as Value_AHC_cusa,party_Code into #CUSA_code_final from #CUSA_code_Main  group by party_code

select SUM(Value_AHC_unsett) as Unsetteled_AHC,party_code into #unsett_holding_Final1 from #unsett_holding group by party_code

 select a.party_code,a.Value_AHC_cusa,
 b.Margin_pleadge_AHC,c.Unsetteled_AHC,
isnull(a.Value_AHC_cusa,0) as final_value_AHC into #final_marginpleadge
 from #CUSA_code_final a left join  #marPledge_Final b 
on a.party_code=b.party_code 
left join #unsett_holding_Final1 c on a.party_code=c.party_code 

declare @MARGINDATE AS DATETIME  , @MARGINDATE_peak AS DATETIME  
         
SELECT @MARGINDATE=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock) 
SELECT @MARGINDATE_peak=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock) 

/**************************************added for MTF Margin *********************/
/*
select isnull(margin_Req,0.00) as margin_Req ,party_code,sauda_date into #MTF_margin from Anand1.MTFTrade.dbo.MTF_Avilable_Cash with(nolock) where margin_Req>0 and
sauda_date=@MARGINDATE
*/
/******************************************************************************/

select /*TDAY_MARGIN*//*+TDAY_MTM*/ 0 as margin ,party_code,margindate into #margin from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock) where margindate=@MARGINDATE--'2020-12-29 00:00:00.000'		

select party_code, SUM(margin) as Margin into #mar from #margin group by party_code
  
--select TDAY_MARGIN/*+TDAY_MTM*/ as margin ,party_code,margindate into #marginPk from ANAND1.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock) where margindate=@MARGINDATE_peak--'2020-12-29 00:00:00.000'		
select /*TDAY_MARGIN*//*+TDAY_MTM*/0.00 as margin ,party_code,margindate into #marginPk from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock) where margindate=@MARGINDATE_peak--'2020-12-29 00:00:00.000'		

select party_code, SUM(margin) as Margin into #marpk from #marginPk group by party_code

 SELECT party_code, MAX(Margin) as margin  
		into #mainMargin FROM  
		(  
			SELECT party_code, MAX(margin) as  Margin 
			FROM #mar   
			GROUP BY party_code  
			UNION ALL  
			SELECT party_code, MAX(margin) as   Margin
			FROM #marpk   
			GROUP BY party_code  
		) as subQuery  
		GROUP BY party_code 

 select party_code,SUM(Value_AHC_cusa) as Value_AHC_cusa into #cusa_combined from #CUSA_code_Main group by party_code
 
 select party_code,isnull(Margin_pleadge_AHC,0.00) as Margin_pleadge_AHC, isnull(Unsetteled_AHC,0.00) as Unsetteled_AHC,sum(final_value_AHC) as final_value_AHC
  into #main_marPleadge
   from #final_marginpleadge group by party_code,Margin_pleadge_AHC,Unsetteled_AHC
 

 select a.party_code,a.Margin_pleadge_AHC,a.Unsetteled_AHC,a.final_value_AHC,b.val as Balance,b.UnRecoCr,b.ShortSellValue,b.AccruedCharges,b.LedgerBal,
 isnull(c.margin*-1,0.00) as margin,
  (case when (isnull(a.Margin_pleadge_AHC,0.00)+(b.ShortSellValue*1.2))>0 then 0 else  (isnull(a.Margin_pleadge_AHC,0.00)+(b.ShortSellValue*1.2)) end) 
 as shortsellWithMarginPledge
 into #final12 from #main_marPleadge a 
 left join #LedgerBal b on a.party_code=b.cltcode
 left join #mainMargin c on a.party_code=c.party_code
 
  update b  set LedgerBal = isnull(b.LedgerBal,0.00)+ isnull(b.shortsellWithMarginPledge,0.00)  from #final12 b
 
select  party_code,Margin_pleadge_AHC,Unsetteled_AHC,final_value_AHC,Balance,UnRecoCr,ShortSellValue,AccruedCharges,LedgerBal,margin
,isnull(0,0.00)+isnull(LedgerBal,0.00)  as finalRelease into #final1 from #final12
 
 SELECT party_code, min(finalRelease) as finalRelease  
		into #main FROM  
		(  
			SELECT party_code, min(finalRelease) as  finalRelease 
			FROM #final1   
			GROUP BY party_code  
			UNION ALL  
			SELECT party_code, min(Value_AHC_cusa) as   finalRelease
			FROM #cusa_combined   
			GROUP BY party_code  
		) as subQuery  
		GROUP BY party_code

select distinct a.bcltdpid,a.Flag,a.party_code,a.certno as isin,a.sett_no,a.qty as MarkedQty,MTM_Price_cusa as MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,
Value_AHC_cusa as Value_AHC,CONVERT(MONEY, 0) as  approved
,b.finalRelease as Net,BSEcode,NSEsymbol into #final_release1  from #CUSA_code_Main a left join #main b on a.party_code=b.party_code order by a.party_code		

select distinct a.*,b.Margin_pleadge_AHC,b.Unsetteled_AHC,b.final_value_AHC as HoldingPostHC,b.Balance,b.UnRecoCr,b.ShortSellValue,
b.AccruedCharges,
b.LedgerBal,b.margin,CONVERT(money,0.00) as Unsetteled_BHC,CONVERT(money,0.00) as MTF_Available_Cash,CONVERT(money,0.00) as Actual_Ledger_Bal
 into #final_release from #final_release1 a left join #final1 b on a.party_code=b.party_code
 
alter table #final_release add Seq_approve_status varchar(50)  

alter table #final_release add ReleasedQty int
alter table #final_release add BlockedQty int
alter table #final_release add Releasedvalue money


update #final_release set Unsetteled_BHC =ISNULL(b.Unsetteled_BHC,0.00) from #unsett_holding_Final b
where #final_release.party_code=b.party_code

update #final_release set MTF_Available_Cash =ISNULL(b.vbal,0.00) from #MTFAvaliableCash b
where #final_release.party_code=b.cltcode


update #final_release set Actual_Ledger_Bal =ISNULL(b.val,0.00) from #ActualLedgerBAl b
where #final_release.party_code=b.cltcode

update #final_release set Seq_approve_status='Released',ReleasedQty=MarkedQty,BlockedQty=0
where sett_no< (select SETT_NO from [CSOKYC-6].general.dbo.Cusa_due_SETT_NO)  and  Seq_approve_status is null  

/**Start***************CUSAPA for Net debit 100/1000********** added on 05 May 2023**********************************************************/

update a set ReleasedQty=MarkedQty,BlockedQty=0,Seq_approve_status='Released' from #final_release a where NET>=-100 and NET<0  and 
Seq_approve_status is null

update a set Seq_approve_status= case when (NET+Margin_pleadge_AHC)>=0 then 'Released' end, 
ReleasedQty= case when (NET+Margin_pleadge_AHC)>=0 then markedqty end ,
BlockedQty=case when (NET+Margin_pleadge_AHC)>=0 then 0 end from #final_release a where NET>=-1000 and NET<0 and Margin_pleadge_AHC>0 and
Seq_approve_status is null 

/**End***************************************************************************************************************************************/

update #final_release set Seq_approve_status=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then 'Blocked' else 'Released' end),
ReleasedQty=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then 0 else MarkedQty end),
BlockedQty=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then MarkedQty else 0 end)
where NET>=0  and Seq_approve_status is null 

update #final_release set Seq_approve_status=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then 'Blocked' else 'Released' end),
ReleasedQty=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then 0 else MarkedQty end),
BlockedQty=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then MarkedQty else 0 end)
where net>=0 and Value_AHC =0.00 and Seq_approve_status is null 
 
update #final_release set Seq_approve_status='Released' where ReleasedQty>0

 select * into #var_100 from #final_release where  Var_margin_cusa=100.00 and Net<0 and Seq_approve_status is null

update #var_100 set Var_margin_cusa=99.00  

update #var_100 set Value_BHC_cusa=MarkedQty*MTM_Price
update #var_100 set Value_AHC=isnull(Value_BHC_cusa,0)-(isnull(Value_BHC_cusa,0)*isnull(Var_margin_cusa,0)/100)

  update a set Var_margin_cusa=b.Var_margin_cusa,Value_BHC_cusa=B.Value_BHC_cusa,Value_AHC=b.Value_AHC from #final_release a,  
  (  
  select sett_no,party_code,isin,Var_margin_cusa,MarkedQty,Value_BHC_cusa,Value_AHC from #var_100  
  )b where ltrim(rtrim(a.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(a.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(a.sett_no))=ltrim(rtrim(b.sett_no)) and a.Var_margin_cusa=100  

select  convert(decimal(18,2),SUM(value_AHC)) as  value_AHC,party_code,convert(decimal(18,2),NET) as NET into  #ee from #final_release
 where Seq_approve_status is null and Net<0 group by party_code,NET  
  
Select * into #data from #ee where (NET*-1)>=value_AHC  
    
update #final_release set  Seq_approve_status = 'Blocked' from  
(select party_code from #data) b where #final_release.party_code=b.party_code and Seq_approve_status is null  --and  Flag='Cusa'

/************************/
select  convert(decimal(18,2),SUM(value_AHC)) as  value_AHC,party_code,convert(decimal(18,2),NET) as NET into  #eew from #final_release
 where Seq_approve_status is null  and Net>0 group by party_code,NET  
  
Select * into  #data1 from #eew where (NET)>=value_AHC  
   
update #final_release set  Seq_approve_status = 'Released' from  
(select party_code from #data1) b where #final_release.party_code=b.party_code and Seq_approve_status is null  
/*************************/
  
update  #final_release set ReleasedQty=MarkedQty,BlockedQty=0  where Seq_approve_status='Released' --and  Flag='Cusa'  
update  #final_release set ReleasedQty=0,BlockedQty=MarkedQty where Seq_approve_status='Blocked'  --and  Flag='Cusa'
 update #final_release set ReleasedValue=(ReleasedQty*mtm_price)*(100-var_margin_cusa)/100  where Seq_approve_status='Released' 

 select * into #final from #final_release  where Seq_approve_status is null  and  Flag='Cusa'  and Net<0
 
select id=row_number() over(order by  sett_no )          
,denseid=dense_rank() over(order by party_code),
scrip_shortage=isnull(mtm_price,0)*MarkedQty
,adjval=convert(money,0),bal=convert(money,0) ,         
*         
into  #holding_CUSA         
from #final


select 
id,denseid,
sqoffsseg=row_number() over(partition by party_code order by scrip_shortage desc )/*Added on 27Jan 2022*/ 
,scrip_shortage,adjval,bal,bcltdpid,Flag,party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series, 
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr,
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status
,BlockedQty=0
,releasedQty=0,sqoffseq=0,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),
shortagereduction=Value_AHC,shortage=convert(money,0),
[holding value after HC]=convert(money,0) ,ReleasedValue,rate=CAST(Value_AHC/MarkedQty AS DECIMAL(18,2) )
--final_AHC_for_adjust,NewNet 
into  #hld_Cusa
from #holding_CUSA-- where party_code='A159174'
order by sqoffsseg

update a set a.shortage=(case when a.Net<0 then (a.Net*-1) else a.Net end)  from #hld_Cusa a  where a.sqoffsseg=1  


;with hold_cte as (  
select   
sqoffsseg,scrip_shortage,adjval,bal,bcltdpid,Flag, party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series, 
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr,
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status,BlockedQty,releasedQty,ReleasedValue,rate,
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,  
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hld_Cusa x   
where  sqoffsseg=1 --and party_Code='A14876'      
union all  
select   
e.sqoffsseg,scrip_shortage,adjval,bal,bcltdpid,Flag ,e.party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series, 
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr,
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status,BlockedQty,releasedQty,ReleasedValue,rate,shortagereduction,  
shortage= (ecte.shortage-shortagereduction)  
from #hld_Cusa e inner join (select party_code,sqoffsseg,shortage from  hold_cte) ecte on ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
--and ecte.shortage>0  
)  
select * into  #holdd_CUSA  
from hold_cte option  (maxrecursion 32767) ; 
--#holdd_CUSA where party_code='K582315'
update #holdd_CUSA set shortagereduction=shortagereduction+shortage,shortage=0  where shortage<0 

update a set BlockedQty=(case when ceiling(convert(money,shortagereduction)/convert(money,rate)) <= markedqty then
ceiling(convert(money,shortagereduction)/convert(money,rate)) else markedqty end)
from #holdd_CUSA a where isnull(rate,0)>0 and shortagereduction>=0

update a set releasedQty=isnull(markedqty,0)-isnull(BlockedQty,0) from #holdd_CUSA a-- where BlockedQty>0
 
 update a set ReleasedValue=(ReleasedQty*mtm_price)*(100-var_margin_cusa)/100  from #holdd_CUSA a where  isnull(MTM_Price,0)>0 


update a set releasedQty=0,BlockedQty=markedqty,ReleasedValue=0,Seq_approve_status='Blocked' from #holdd_CUSA a where releasedQty<0
 
update a set Seq_approve_status=case when MarkedQty=ReleasedQty then 'Released'  
  when MarkedQty=BlockedQty then 'Blocked'  
  when  MarkedQty>ReleasedQty  and BlockedQty<>0 and ReleasedQty<>0 then 'Partially Released' end from #holdd_CUSA a where releasedQty>0
 --#final where party_code='G16378'

   update #final set ReleasedQty=isnull(b.ReleasedQty,0),BlockedQty=isnull(b.BlockedQty  ,0),ReleasedValue=ISNULL(b.ReleasedValue,0.00)
 ,Seq_approve_status=b.Seq_approve_status
   from  
  (  
  select sett_no,party_code,isin,ReleasedQty,markedqty,BlockedQty,ReleasedValue,Seq_approve_status from #holdd_CUSA  
  )b where ltrim(rtrim(#final.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(#final.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#final.markedqty))=ltrim(rtrim(b.markedqty)) 
  and #final.Flag='Cusa'

  
  update #final_release set approved=b.approved,Seq_approve_status=B.Seq_approve_status,ReleasedQty=b.ReleasedQty,  
  BlockedQty=b.BlockedQty,ReleasedValue=ISNULL(b.ReleasedValue,0.00)  
   from  
  (  
  select sett_no,party_code,isin,approved,Seq_approve_status,ReleasedQty,MarkedQty,BlockedQty,ReleasedValue from #final  
  )b where ltrim(rtrim(#final_release.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_release.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(#final_release.sett_no))=ltrim(rtrim(b.sett_no))  and  #final_release.Flag='Cusa'
  
update a set BlockedQty=MarkedQty,ReleasedQty=0,Seq_approve_status='blocked' from #final_release a where
Seq_approve_status is null
and flag='cusa' and BlockedQty>0

update a set releasedValue= (ReleasedQty*mtm_price)*(100-var_margin_cusa)/100 from #final_release a
where ReleasedQty>0 and isnull(releasedValue,0)=0 

select *,Value_BHC_cusaBlocked=Blockedqty*MTM_Price,CONVERT(MONEY, 0) as Value_AHC_cusaBlocked into #CUSA_BlockedShare
from #final_release where Blockedqty>0 and flag='cusa'


update #CUSA_BlockedShare set Value_AHC_cusaBlocked=isnull(Value_BHC_cusaBlocked,0)-(isnull(Value_BHC_cusaBlocked,0)*isnull(Var_margin_cusa,0)/100)  

select party_code, SUM(Value_AHC_cusaBlocked)Value_AHC_cusaBlocked into #CUSA_blockClub from #CUSA_BlockedShare group by party_code
 
select *,CONVERT(money,0)Value_AHC_cusaBlocked,CONVERT(money,0)FinalNet
into  #unsetCode from #final_release a where a.Seq_approve_status is null and a.Flag='un'  

update a set  a.Value_AHC_cusaBlocked=b.Value_AHC_cusaBlocked from #unsetCode a,#CUSA_blockClub b where  a.party_code=b.party_code   
 
--select a.*,isnull(b.Value_AHC_cusaBlocked,0) Value_AHC_cusaBlocked,CONVERT(money,0) as FinalNet into  #unsetCode from #final_release a left join #CUSA_BlockedShare b on a.party_code=b.party_code 
--where a.Seq_approve_status is null and a.Flag='un'

update #unsetCode set FinalNet=Net+isnull(Value_AHC_cusaBlocked,0) 

update a set ReleasedQty=MarkedQty,blockedQty=0,Seq_approve_status='Released' from #unsetCode a where FinalNet>=0

update a set releasedValue= (ReleasedQty*mtm_price)*(100-var_margin_cusa)/100 from #unsetCode a
where ReleasedQty>0 and isnull(releasedValue,0)=0 

 update #final_release set ReleasedQty=isnull(b.ReleasedQty,0),BlockedQty=isnull(b.BlockedQty  ,0),ReleasedValue=ISNULL(b.ReleasedValue,0.00)
 ,Seq_approve_status=b.Seq_approve_status
   from  
  (  
  select sett_no,party_code,isin,ReleasedQty,markedqty,BlockedQty,ReleasedValue,Seq_approve_status from #unsetCode where Flag='un' and
  FinalNet>0
  )b where ltrim(rtrim(#final_release.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_release.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(#final_release.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#final_release.markedqty))=ltrim(rtrim(b.markedqty)) 
  and #final_release.Flag='Un'

select id=row_number() over(order by  sett_no )          
,denseid=dense_rank() over(order by party_code),
/*sqoffsseg=row_number() over(partition by party_code order by qty desc ) */ /*commented on 27Jan 2022*/           
--,scrip_shortage=total 
scrip_shortage=isnull(mtm_price,0)*MarkedQty
,adjval=convert(money,0),bal=convert(money,0) ,         
--,ReleasedQty=convert(money,0),
*          
into #holding_un          
from #unsetCode where Flag='un' and  Seq_approve_status is null and FinalNet<0


select 
id,denseid,
sqoffsseg=row_number() over(partition by party_code order by scrip_shortage desc )/*Added on 27Jan 2022*/ 
,scrip_shortage,adjval,bal,bcltdpid,Flag,party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series, 
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr,[ShortSellValue],
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status
,BlockedQty=0
,releasedQty=0,sqoffseq=0,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),
shortagereduction=Value_AHC,shortage=convert(money,0),
[holding value after HC]=convert(money,0) ,ReleasedValue,FinalNet,rate= CAST(Value_AHC/MarkedQty AS DECIMAL(18,2) )
into #hld_un
from #holding_un-- where party_code='A159174'
order by sqoffsseg

update a set a.shortage=(case when a.FinalNet<0 then (a.FinalNet*-1) else a.FinalNet end)  from #hld_un a  where a.sqoffsseg=1  


;with hold_cte as (  
select   
sqoffsseg,scrip_shortage,adjval,bal,bcltdpid,Flag, party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series, 
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr,
[ShortSellValue],
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status,BlockedQty,releasedQty,ReleasedValue,
FinalNet,rate,
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,  
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hld_un x   
where  sqoffsseg=1 --and party_Code='CP6249'      
union all  
select   
e.sqoffsseg,scrip_shortage,adjval,bal,bcltdpid,Flag ,e.party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series, 
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr, [ShortSellValue],
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status,BlockedQty,releasedQty,ReleasedValue,
FinalNet,rate,shortagereduction,  
shortage= (ecte.shortage-shortagereduction)  
from #hld_un e inner join (select party_code,sqoffsseg,shortage from  hold_cte) ecte on ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
--and ecte.shortage>0  
)  
select * into  #holdd_un  
from hold_cte option  (maxrecursion 32767) ;  

update #holdd_un set shortagereduction=shortagereduction+shortage,shortage=0  where shortage<0 
 

update a set BlockedQty=(case when ceiling(convert(money,shortagereduction)/convert(money,rate)) <= markedqty then
ceiling(convert(money,shortagereduction)/convert(money,rate)) else markedqty end)
from #holdd_un a where isnull(rate,0)>0  and shortagereduction>=0

 update a set releasedQty=isnull(markedqty,0)-isnull(BlockedQty,0) from #holdd_un a --where BlockedQty>0
  
 update a set ReleasedValue=(ReleasedQty*mtm_price)*(100-var_margin_cusa)/100  from #holdd_un a where  isnull(MTM_Price,0)>0 and ReleasedQty<>0  

update a set releasedQty=0,BlockedQty=markedqty,ReleasedValue=0,Seq_approve_status='Blocked' from #holdd_un a where releasedQty<0
 
update a set Seq_approve_status=case when MarkedQty=ReleasedQty then 'Released'  
  when MarkedQty=BlockedQty then 'Blocked'  
  when  MarkedQty>ReleasedQty  and BlockedQty<>0 and ReleasedQty<>0 then 'Partially Released' end from #holdd_un a where releasedQty>0

update a set Seq_approve_status=case when MarkedQty=ReleasedQty then 'Released'    
  when MarkedQty=BlockedQty then 'Blocked'    
  when  MarkedQty>ReleasedQty  and BlockedQty<>0 and ReleasedQty<>0 then 'Partially Released' end from #holdd_un a where BlockedQty>0 
 
 update #final_release set ReleasedQty=isnull(b.ReleasedQty,0),BlockedQty=isnull(b.BlockedQty  ,0),ReleasedValue=ISNULL(b.ReleasedValue,0.00)
 ,Seq_approve_status=b.Seq_approve_status
   from  
  (  
  select sett_no,party_code,isin,ReleasedQty,markedqty,BlockedQty,ReleasedValue,Seq_approve_status from #holdd_un  
  )b where ltrim(rtrim(#final_release.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_release.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(#final_release.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#final_release.markedqty))=ltrim(rtrim(b.markedqty)) 
  and #final_release.Flag='Un'

/**********Added on 05 Jan 2022 by Neha as per Vishal's Mail******************************/
truncate table tbl_ProjectedRisk
 
insert into tbl_ProjectedRisk
select *  from [CSOKYC-6].General.dbo.Tbl_scripwiseSqoffdata with(nolock)

select party_code,sqtype,isin,accno into #ProjRisk from [CSOKYC-6].General.dbo.Tbl_scripwiseSqoffdata with(nolock) where sqtype in ('ProjRisk','ASB7','MTF Ageing') and
  AccNo in ('''1203320186015090''','''IN30134820306643''')
     
  insert into CUSA_ProjRisk_ASB7(party_code,sqtype,isin,accno,bcltdpid,cltcode,ISIN_Proj,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,ShortSellValue,AccruedCharges,LedgerBal,margin,Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status,ReleasedQty,BlockedQty,UpdatedOn)
  select a.*,b.bcltdpid,b.party_code as cltcode,b.isin as ISIN_Proj,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,
  NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,ShortSellValue,AccruedCharges,LedgerBal,margin,Unsetteled_BHC,MTF_Available_Cash,
  Actual_Ledger_Bal,Seq_approve_status,ReleasedQty,BlockedQty
 ,GETDATE() as UpdatedOn from #ProjRisk a left join #final_release b on a.party_code=b.party_code and a.isin=b.isin where b.Seq_approve_status in ('Partially Released','Released')
 
  
update #final_release set ReleasedQty = 0,BlockedQty=MarkedQty ,Seq_approve_status='Blocked' from #ProjRisk b  
where #final_release.party_code=b.party_code and #final_release.isin=b.isin  and #final_release.Seq_approve_status in ('Partially Released','Released')
 
/***************End*************************/
update #final_release set Seq_approve_status='Blocked' where Seq_approve_status is null and blockedqty>0 and releasedqty=0
update a set Seq_approve_status='Released' from #final_release a where Seq_approve_status is null and blockedqty=0 and releasedqty>0


insert into Cusa_Po_hist(bcltdpid,party_code,isin,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,
approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,[ShortSellValue_Into_120%],AccruedCharges,
LedgerBal,margin,Seq_approve_status,ReleasedQty,BlockedQty,Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,squareoffqty,Squareoffdate,flag,
ReleasedValue,
UpdatedOn)
select bcltdpid,party_code,isin,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,
NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,[ShortSellValue_Into_120%],AccruedCharges,LedgerBal,margin,
Seq_approve_status,ReleasedQty,BlockedQty,Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,squareoffqty,Squareoffdate,Flag,ReleasedValue
,GETDATE() from Cusa_Po

truncate table Cusa_Po

insert into Cusa_Po(bcltdpid,party_code,isin,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,[ShortSellValue_Into_120%],AccruedCharges,LedgerBal,margin,Seq_approve_status,ReleasedQty,BlockedQty,Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,flag,ReleasedValue)
select bcltdpid,party_code,isin,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,ShortSellValue,AccruedCharges,LedgerBal,margin,Seq_approve_status,ReleasedQty,BlockedQty
,isnull(Unsetteled_BHC,0.00),ISNULL(MTF_Available_Cash,0.00),ISNULL(Actual_Ledger_Bal,0.00),Flag,ReleasedValue  from #final_release

exec Cusa_PO_ForSquareOffQty


update Cusa_Po set squareoffqty=ISNULL(b.squareoffqty,0) from Tbl_cusa_SquareOffQty b
where Cusa_Po.party_code=b.party_code and Cusa_Po.sett_no=b.sett_no and
Cusa_Po.BSEcode=b.bsecode and Cusa_Po.NSEsymbol=b.nsesymbol and 
Cusa_Po.isin=b.isin and /*Cusa_Po.MarkedQty=b.markedqty and */Cusa_Po.MTM_Price=b.MTM_Price

/************************************************/
 select * into #due from [CSOKYC-6].general.dbo.Cusa_Due_sett_date with(nolock)
 
 update Cusa_Po set Squareoffdate=b.start_date from #due b where Cusa_Po.sett_no=b.sett_no and 
 Seq_approve_status in ('Partially Released','Blocked') and squareoffqty is not null

update Cusa_Po set Squareoffdate=b.start_date from 
(select min(start_date) start_date from #due)b where Cusa_Po.sett_no< (select min(sett_no) from #due) and Seq_approve_status in ('Partially Released','Blocked')
and squareoffqty is not null
/************************************************/
/****Start******Added on 28 Oct 2022 as per Vishal G for M settelment**************************************/
select * into #fg from
 [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)        
where /*co_code='BSECM' and sett_type='D' */
 co_code='NSECM' and sett_type='M' and sett_no <=(select min(Sett_No) from [CSOKYC-6].general.dbo.Cusa_M_settelment with(nolock)) order by Sett_No desc

   select * into #due1 from [CSOKYC-6].general.dbo.Cusa_M_settelment with(nolock)
 
update Cusa_Po set Squareoffdate=b.start_date from 
(select min(start_date) start_date from #due1)b  
where sett_no in (select SETT_NO from #fg) and Seq_approve_status in ('Partially Released','Blocked')
and squareoffqty is not null

   select top 2 * into #sett from [CSOKYC-6].general.dbo.Cusa_M_settelment with(nolock) order by sett_no desc

    update Cusa_Po set Squareoffdate=b.start_date from #sett b where Cusa_Po.sett_no=b.sett_no and 
 Seq_approve_status in ('Partially Released','Blocked') and squareoffqty is not null
/*****************************************************************************************/
/****Start******Added on 02 July 2021 as per Vishal G mail**************************************/

select * into #cusa1 from Cusa_Po where sett_no<= (select SETT_NO from [CSOKYC-6].general.dbo.Cusa_due_SETT_NO)  

--delete from #cusa1 where sett_no in (select sett_no from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)  where  sett_type='F' )  --exclude sttelment type 'F'


select *,MarkedQty-ReleasedQty-ISNULL(squareoffqty,0) as BalanceQty into #cusa2 from #cusa1 where ISNULL(squareoffqty,0)>0

update #cusa2 set ReleasedQty=ReleasedQty+BalanceQty ,BlockedQty=BlockedQty-BalanceQty  where BalanceQty>0

update #cusa2  set Seq_approve_status=case when MarkedQty=ReleasedQty then 'Released'  
  when MarkedQty=BlockedQty then 'Blocked'  
  when MarkedQty>ReleasedQty  and BlockedQty<>0 and ReleasedQty<>0 then 'Partially Released' end   where BalanceQty>0


update Cusa_Po set ReleasedQty=b.ReleasedQty,BlockedQty=b.BlockedQty,Seq_approve_status=b.Seq_approve_status  from  
(  
select Sett_no,party_code,isin,approved,Seq_approve_status,BlockedQty,ReleasedQty,MarkedQty,BalanceQty from #cusa2 where BalanceQty>0  
)b where ltrim(rtrim(Cusa_Po.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(Cusa_Po.isin))=ltrim(rtrim(b.isin))  
and ltrim(rtrim(Cusa_Po.Sett_no))=ltrim(rtrim(b.Sett_no)) and Cusa_Po.MarkedQty=b.MarkedQty  


update Cusa_Po set ReleasedValue=(ReleasedQty*mtm_price)*(100-var_margin_cusa)/100  where isnull(ReleasedValue,0)=0.00 and releasedqty>0
and ReleasedValue=0.00


/****End********************************************/

exec USP_CUSA_PO_File_Generation

Exec USP_CUSA_PO_File_Unsettel_Generation

truncate table Cusa_Po_heading

insert into Cusa_Po_heading
/*select 'bcltdpid','party_code','isin','sett_no','MarkedQty','MTM_Price','Angel_Scrip_cusa','Var_margin_cusa','series','Value_BHC_cusa','Value_AHC','approved',
'Net','BSEcode','NSEsymbol','HoldingPostHC','LedgerBal','margin','Seq_approve_status','ReleasedQty','BlockedQty'
*/
select 'bcltdpid','party_code','isin','sett_no','MarkedQty','MTM_Price','Angel_Scrip_cusa','Var_margin_cusa','series','Value_BHC_cusa','Value_AHC','approved'
,'Net','BSEcode','NSEsymbol','Margin_pleadge_AHC','Unsetteled_AHC','HoldingPostHC','Balance','UnRecoCr','ShortSellValue','AccruedCharges',
'LedgerBal','margin','Seq_approve_status','ReleasedQty','BlockedQty','Unsetteled_BHC','MTF_Available_Cash','Actual_Ledger_Bal','squareoffqty',
'Squareoffdate','Flag','ReleasedValue'


insert into Cusa_Po_heading
select *
from Cusa_Po

DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)                              
   SELECT @emailto='Vishal@angelbroking.com;manish.shah@angelbroking.com;sanjay.chavan@angelbroking.com;himanshu.patil@angelbroking.com;sai.jagdale@angelbroking.com;pradeep.mhatre@angelbroking.com'     
   select @emailcc=''--'rahulc.shah@angelbroking.com'    
   select @emailbcc='neha.naiwar@angelbroking.com' 
   
  DECLARE @s VARCHAR(MAX) = ''                                      
   /*declare @FileName as varchar(100) = 'LD_File'+replace(CONVERT(char(10),getdate(),103),'/','-')+'.csv'*/  
   declare @FileName as varchar(100) = 'CUSA_PO'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                                             
      declare @FilePath varchar(200) ='' /* '\\INHOUSELIVEAPP2-FS.angelone.in\d$\upload\CMS_Test\'+@FileName  */                     
 	    --select @FilePath='\\INHOUSELIVEAPP2-FS.angelone.in\cusa_mtf\'+@FileName    
		  select @FilePath='\\10.253.19.11\cusa_mtf\'+@FileName 
                                   
      SET @s = 'exec  MASTER.dbo.xp_cmdshell ' + ''''                                       
      SET @s = @s + 'bcp "select * from INTRANET.cms.dbo.Cusa_Po_heading" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                                                                 
   
         
      SET @s = @s + ''''          
      EXEC(@s) 
        
 /*                                    
SET @MESS='Dear All,<br><Br>Good Morning!!!<br><Br>Please refer the below path for CUSA Payout File.<Br><Br><b>\\172.29.19.16\public\NehaN\</b><Br>'                                      
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(In-house system)'                                  
set @sub ='CUSA Payout Release file'                     
                      
                        
 DECLARE @s1 varchar(500)                      
 SET @s1 = @FilePath               
                        
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                  
 @RECIPIENTS =@emailto,                                  
 @COPY_RECIPIENTS = @emailcc,                                  
 @blind_copy_recipients=@emailbcc,                        
 @PROFILE_NAME = 'AngelBroking',                                  
 @BODY_FORMAT ='HTML',                                  
 @SUBJECT = @sub ,                                  
 @FILE_ATTACHMENTS ='',--@s1,                                  
 @BODY =@MESS   
*/
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Cusa_Payout_25July2023
-- --------------------------------------------------
  
  
create proc [dbo].[SP_Cusa_Payout_25July2023]  
as  
  
begin  
  
/******Added by Neha Naiwar on 30 Apr 2021 fro Relesing Due Settelment*************************************************************/  
exec [CSOKYC-6].general.dbo.Cusa_Due_settNo  
/*************************End*********************************************************/   
/************Added for removing multiple isin with blank name from scrip master (Added on 04 Jun 2021)***************************************/  
        drop table cusa_scrip  
        select * into cusa_scrip from [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS with(nolock)  
        select [isin no] into #scrip from cusa_scrip group by [isin no] having COUNT(1)>1  
        delete from cusa_scrip where  [isin no] in (select [isin no] from #scrip) and  [co name]='-'  
/****************************************************/  
  
select Security_Symbol,Security_ISIN,MAX(mtm_price) as mtm_price  into #Combine_Closing_File from [CSOKYC-6].GENERAL.DBO.Combine_Closing_File with(nolock) group by Security_Symbol,Security_ISIN  
  
/*****Added on 10 Apr 2023 for taking sett no from sett master****************/  
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty,'Cusa' as Flag,transdate into #CUSA_code1 from AngelDemat.msajag.dbo.deltrans with(nolock) where    
drcr='d' and delivered ='0' and filler2='1' and bcltdpid in ('1203320186015090','IN30134820306643')  /*'1203320018512051',*/  
group by bcltdpid,party_code,certno,sett_no,transdate     
union all     
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty,'Cusa' as Flag,transdate  from AngelDemat.bsedb.dbo.deltrans with (nolock) where     
drcr='d' and delivered ='0' and filler2='1' and bcltdpid in ('1203320186015090','IN30134820306643')/*='1203320018512051'*/    
group by bcltdpid,party_code,certno,sett_no,transdate    
    
  update #CUSA_code1 set  transdate='2023-04-03 00:00:00.000' where  transdate='2023-04-04 00:00:00.000'  
  
update a set a.sett_no=b.sett_no from #CUSA_code1 a left join [CSOKYC-6].General.dbo.BO_Sett_Mst b  WITH(NOLOCK)  on a.transdate=b.Sec_Payin  
where    co_code='NSECM' and sett_type='M' and a.bcltdpid in ('1203320186015090','IN30134820306643')  
  
select distinct bcltdpid,party_code,certno,sett_no,qty,Flag into #CUSA_code from #CUSA_code1 with (nolock)  
/**********************************/  
  
select *,qty+Mtf_qty as FinalQty into #Uncusa from AngelDemat.Msajag.dbo.UNSETTLED_CUSA_PAYOUT with(nolock)   
  
insert into #CUSA_code  
select partipantcode,party_code,i_isin,sett_no,SUM(FinalQty) as qty,'Un' as Flag from #Uncusa with(nolock) where FinalQty>0  
group by partipantcode,party_code,i_isin,sett_no  
  
 Exec AngelBSECM.inhouse.dbo.Fetch_CliUnreco                                                  
 Exec AngelNseCM.inhouse.dbo.Fetch_CliUnreco                                                  
 Exec angelfo.inhouse.dbo.Fetch_CliUnreco                                                  
 Exec angelfo.inhouse_curfo.dbo.Fetch_CliUnreco                                                  
 Exec angelcommodity.inhouse_BSX.dbo.Fetch_CliUnreco      
 Exec angelcommodity.INHOUSE_MCDCS.dbo.Fetch_CliUnreco                                                  
 Exec angelfo.inhouse.dbo.Fetch_CliUnreco                                                  
 Exec angelfo.inhouse.dbo.Fetch_CliUnreco   
   
 ---94 server issue commented  
  /* SHORTAGE */                                                  
 exec risk.dbo.get_shortage                                                  
 exec risk.dbo.Usp_Calc_ShrtVal                                                  
 exec cms.dbo.NCMS_Shortage  
 /************/    
  
/*  
declare @sdtcur as datetime,@Todate as datetime = convert(varchar(11),getdate())+' 23:59:59'       
select @sdtcur=sdtcur from anand.account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()             
*/  
  
declare @sdtcur as datetime,@Todate as datetime = convert(varchar(11),getdate())+' 23:59:59'         
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()              
  
/*Code added to handle Financial year end issue on 3rd April 2017*/  
/********************************************************************************/  
declare @ccsy datetime,@ccse datetime  
set @ccsy=@sdtcur  
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'  
  
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter where ldtcur        =  
(select ldtprv from AngelBSECM.account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE())    
  
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,  
  UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/  
  UnRecoCr =0             
  INTO #BSECMcltop                               
  from AngelBSECM.account_ab.dbo.ledger a with (nolock)                   
  where VDT>=@sdtcur and VDT <= @Todate --  and cltcode in (select party_code from #CUSA_code)   
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from AngelBSECM.account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
    select * into #BSECMOpn from #BSECMcltop where cltcode in (select party_code from #CUSA_code)     
      
     update #BSECMOpn set UNRecoCr=-b.UnRecoCr from               
 (select cltcode,SUM(Cramt) as UnRecoCr from  AngelBSECM.inhouse.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b              
 where #BSECMOpn.cltcode=b.cltcode              
    
 select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,  
  UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/  
  UnRecoCr=0                      
  into  #NSECMcltop               
  from AngelNseCM.account.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and VDT <= @Todate       
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from AngelNseCM.account.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode      
      
  select * into #NSECMOpn from #NSECMcltop where cltcode in (select party_code from #CUSA_code)                  
     
   update #NSECMOpn set UNRecoCr=-b.UnRecoCr from               
 (select cltcode,SUM(Cramt) as UnRecoCr from  AngelNseCM.inhouse.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b              
 where #NSECMOpn.cltcode=b.cltcode          
    
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)   ,  
  UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/  
  UnRecoCr =0          
  into #NSEFOcltop                
  from angelfo.accountfo.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate    
    /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelfo.accountfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode                    
    
  select * into #NSEFOOpn from #NSEFOcltop where cltcode in (select party_code from #CUSA_code)                  
    
  update #NSEFOOpn set UNRecoCr=-b.UnRecoCr from               
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b              
 where #NSEFOOpn.cltcode=b.cltcode    
                
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,  
  UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/  
  UnRecoCr=0             
  into #NSXcltop                
  from angelfo.accountcurfo.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate   
     /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelfo.accountcurfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode         
      
    select * into #NSXOpn from #NSXcltop where cltcode in (select party_code from #CUSA_code)                  
    
  update #NSXOpn set UNRecoCr=-b.UnRecoCr from               
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse_curfo.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b              
 where #NSXOpn.cltcode=b.cltcode   
      
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,  
  UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/  
  UnRecoCr=0               
  into #BSXcltop                
  from angelcommodity.ACCOUNTcurbfo.dbo.ledger  a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate   
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTcurbfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
      select * into #BSXOpn from #BSXcltop where cltcode in (select party_code from #CUSA_code)                  
    
  update #BSXOpn set UNRecoCr=-b.UnRecoCr from               
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_BSX.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b              
 where #BSXOpn.cltcode=b.cltcode   
               
  select CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,  
  UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/  
  UnRecoCr=0              
  into #MCDcltop                
  from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate     
  /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdxcds.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode                    
      
   select * into #MCDOpn from #MCDcltop where cltcode in (select party_code from #CUSA_code)                  
    
  update #MCDOpn set UNRecoCr=-b.UnRecoCr from               
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.INHOUSE_MCDCS.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b              
 where #MCDOpn.cltcode=b.cltcode   
            
  /*select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,  
  UnsettledCrBill=0,/*sum(case when drcr='D' then -VAMT else VAMT end) ,*/  
  UnRecoCr=0             
  into #MTFcltop               
  from anand1.MTFTRADE.dbo.ledger  a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate                   
  group by cltcode*/                    
      
  select party_code as CLTCODE,vbal=0,--case when SUM(Available_Cash_bal)>0 then 0 else SUM(Available_Cash_bal) end, /*SUM(Available_Cash_bal), */  
  UnsettledCrBill=0,/*sum(case when drcr='D' then -VAMT else VAMT end) ,*/  
  UnRecoCr=0  
  into #MTFcltop     
  from   AngelNseCM.MTFTrade.dbo.MTF_Avilable_Cash with(nolock) where sauda_date>=@sdtcur and sauda_date <= @Todate  
  group by party_code    
     
   select * into #MTFOpn from #MTFcltop where cltcode in (select party_code from #CUSA_code)   
   select * into #MTFAvaliableCash from #MTFcltop where cltcode in (select party_code from #CUSA_code)                   
 --#MTFOpn  where cltcode='A1002431'  
    /*********Adjust Unsetteled holding in MTF avaiable cash************************/  
     
select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,  
CONVERT(MONEY, 0) as Value_BHC_unsett,  
CONVERT(MONEY, 0) as Value_AHC_unsett  
  into #unsett_holding from /*[196.1.115.197].msajag.dbo.unclear_hold*/  AngelDemat.msajag.dbo.unclear_Hold_New  a with(nolock) join  
 /*[CSOKYC-6].GENERAL.DBO.Combine_Closing_File*/#Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/  
a.I_isin=b.security_isin join /*[CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS*/ cusa_scrip c with(nolock) on a.I_isin=c.[isin no]  
  
--[196.1.115.197].msajag.dbo.unclear_hold where party_code='G48414'                                            
  
update #unsett_holding set Value_BHC_unsett=0/*qty*MTM_Price_unsett*/  
update #unsett_holding set Value_AHC_unsett=0/*isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)*/  
  
/*insert into Cusa_unsett_holding  
select * from #unsett_holding      
*/   
  
select SUM(Value_BHC_unsett) as Unsetteled_BHC,party_code into #unsett_holding_Final from #unsett_holding group by party_code              
    
  update #MTFOpn set  vbal=case when vbal=0 then Unsetteled_BHC else vbal-Unsetteled_BHC end from #unsett_holding_Final b where #MTFOpn.cltcode=b.party_code  
  /*  update #MTFOpn set  vbal=Unsetteled_BHC-vbal from #unsett_holding_Final b where #MTFOpn.cltcode=b.party_code*/  
  --select a.* ,b.Unsetteled_BHC from #MTFOpn a join #unsett_holding_Final b on a.CLTCODE=b.party_code  
     
insert into #MTFOpn  
select party_code,0 as Unsetteled_AHC,0 as UnsettledCrBill,0 as UnRecoCr  from #unsett_holding_Final where party_code not in (select cltcode from #MTFOpn )  
  
  /****************************************************/  
     
 /*   update #MTFOpn set UNRecoCr=-b.UnRecoCr from               
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b              
 where #MTFOpn.cltcode=b.cltcode */  
                     
  select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,  
  UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/  
  UnRecoCr=0                   
  into #MCDXcltop                    
  from angelcommodity.accountmcdx.dbo.ledger a with (nolock)                           
  where VDT>=@sdtcur and  VDT <= @Todate   
   /*Added to exclude opening balance of current year*/    /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode                        
        
   select * into #MCDXOpn from #MCDXcltop where cltcode in (select party_code from #CUSA_code)                   
    
    update #MCDXOpn set UNRecoCr=-b.UnRecoCr from               
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_MCDX.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b              
 where #MCDXOpn.cltcode=b.cltcode       
                        
  select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,  
  UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/  
  UnRecoCr=0                    
  into #NCDXcltop                   
  from angelcommodity.accountncdx.dbo.ledger a with (nolock)                           
  where VDT>=@sdtcur and  VDT <= @Todate      
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountncdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
  select * into #NCDXOpn from #NCDXcltop where cltcode in (select party_code from #CUSA_code)                   
  
 update #NCDXOpn set UNRecoCr=-b.UnRecoCr from               
 (select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_NCDX.dbo.BO_client_deposit_recno with (nolock) group by cltcode) b              
 where #NCDXOpn.cltcode=b.cltcode    
  
 select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,  
  UnsettledCrBill=0,/*sum(case when drcr='D' then -VAMT else VAMT end) ,*/  
  UnRecoCr=0             
  into #MTFClientcodes               
  from AngelNseCM.MTFTRADE.dbo.ledger  a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate                   
  group by cltcode  
  
    select * into #MTFLedgerBal from #MTFClientcodes where cltcode in (select party_code from #CUSA_code)        
   
 select cltcode,sum(vbal) as Net_Ledger into #Tbl_rms from (                                              
  select CLTCODE,VBal from #NSECMOpn                
  union all                                              
  select CLTCODE,VBal from #BSECMOpn   
  union all                                              
  select CLTCODE,VBal from #NSEFOOpn   
  union all                                              
  select CLTCODE,VBal from #NSXOpn   
  union all                                              
  select CLTCODE,VBal from #MCDOpn   
  union all                                              
  select CLTCODE,VBal from #MTFLedgerBal                      
  union all                                    
  select CLTCODE,VBal from #MCDXOpn                                           
  union all                                              
  select CLTCODE,VBal from #NCDXOpn                                                                    
  union all                                              
  select CLTCODE,VBal from #BSXOpn                              
  )x  group by cltcode  
   
 select * into #Bal from (                                              
  select * from #NSECMOpn                
  union all                                              
  select * from #BSECMOpn   
  union all                                              
  select * from #NSEFOOpn   
  union all                                              
  select * from #NSXOpn   
  union all                                              
  select * from #MCDOpn   
  union all                                              
  select * from #MTFOpn                      
  union all                                    
  select * from #MCDXOpn                                           
  union all                                              
  select * from #NCDXOpn                                                                    
  union all                                              
  select * from #BSXOpn   
                                 
  )x   
   
 select * into #actualBal from (                                              
  select * from #NSECMOpn    
  union all                                              
  select * from #BSECMOpn   
  union all                                              
  select * from #NSEFOOpn    
  union all                                              
  select * from #NSXOpn  
  union all                                              
  select * from #MCDOpn   
  --union all                                              
  --select * from #MTFOpn  
  union all                                    
  select * from #MCDXOpn                                              
  union all                                              
  select * from #NCDXOpn                                                                      
  union all                                              
  select * from #BSXOpn    
                                 
  )x   
    
  select  CLTCODE,sum(VBal) as val,sum(UnsettledCrBill) as UnsettledCrBill,sum(UnRecoCr) as UnRecoCr  into #ActualLedgerBAl from #actualBal  group by  cltcode    
  
  select  CLTCODE,sum(VBal) as val,sum(UnsettledCrBill) as UnsettledCrBill,sum(UnRecoCr) as UnRecoCr,CONVERT(money,0.00) as AccruedCharges  
  ,CONVERT(money,0.00) as ShortSellValue  into #All from #Bal  group by  cltcode    
                          
 select party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                   
 from misc.dbo.Accrued_PenalCharges with (nolock) group by party_code   
   
  /******added new margin peneality charges on 05 Jul 2021***********************************/    
 insert into #Accrued1    
  select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code     
    
   
insert into  #Accrued1  
SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)  
where cnt_Date=(select max(cnt_Date) from AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))  
group by cltcode  
  
insert into  #Accrued1  
SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock),AngelNseCM.MSAJAG.DBO.client_details c(Nolock)  
where  PCN_Date=(select max(PCN_Date) from AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock))  
 and J.cl_code=c.cl_code  
group by J.cl_code             
    
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                           
    
 /****************************************/          
   
 update #Accrued set DeductEQ=0 where DeductEQ<200 /**Added on 30 Apr 2021 by Neha Naiwar **/  
   
 update #All set AccruedCharges=-DeductEQ  from #Accrued b                                                   
 where #All.CLTCODE=b.party_code    
                                                 
 update #All set ShortSellValue=-b.shrtval from                                                  
(select party_code,shrtval=SUM(SHORT_VALUE) from ncms_shortsell group by party_Code having sum(SHORT_VALUE) <> 0) b                    
 where   #All.CLTCODE=b.party_Code   
  
 SELECT CLTCODE,val,UnsettledCrBill,UnRecoCr,AccruedCharges,ShortSellValue,val+ UnRecoCr+ /*(ShortSellValue*1.2)+*/AccruedCharges as LedgerBal   
 into #LedgerBal from #All  
  
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty into #MarginPleadge  from AngelDemat.msajag.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'  
group by bcltdpid,party_code,certno,sett_no  
union all  
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty  from AngelDemat.bsedb.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'  
group by bcltdpid,party_code,certno,sett_no  
  
select * into #client_col from  [CSOKYC-6].GENERAL.DBO.client_collaterals with(nolock)   
  
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,  
CONVERT(MONEY, 0) as Var_margin,  
CONVERT(varchar(10), '') as series,  
CONVERT(MONEY, 0) as Value_BHC,  
CONVERT(MONEY, 0) as Value_AHC  
  into #marPledge from #MarginPleadge a left join #Combine_Closing_File b with(nolock) on   
a.certno=b.security_isin  
  
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre from #client_col where party_code in (select distinct party_code from #marPledge)  
  
  
update #marPledge set series=b.series,var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre b  
where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin   
   
update #marPledge set MTM_Price=b.cl_rate from #wre b where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin and #marPledge.MTM_Price=0.00  
  
  
update #marPledge set Value_BHC=qty*MTM_Price  
update #marPledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)  
  
select SUM(Value_AHC) as Margin_pleadge_AHC,party_code into #marPledge_Final from #marPledge group by party_code  
  
/*****Unpleadge**/  
select party_code,scrip,isin,sum(markedqty) as qty into #unpledge_code from tbl_UnpledgeFile with(nolock)  
 group by party_code,scrip,isin  
  
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,  
CONVERT(MONEY, 0) as Var_margin,    
CONVERT(MONEY, 0) as Value_BHC,    
CONVERT(MONEY, 0) as Value_AHC    
  into #unpledge from #unpledge_code a left join #Combine_Closing_File b with(nolock) on   
a.isin=b.security_isin    
    
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre1 from #client_col  
    
update #unpledge set var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre1 b    
where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin     
     
update #unpledge set MTM_Price=b.cl_rate from #wre1 b where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin and #unpledge.MTM_Price=0.00    
     
update #unpledge set Value_BHC=qty*MTM_Price    
update #unpledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)   
  
select sum(Value_AHC) as Unpledge_AHC,party_Code into #unpledge_codes from #unpledge   group by party_code    
  
select a.party_code,isnull(Margin_pleadge_AHC,0.00)-isnull(Unpledge_AHC,0.00)  as Margin_Pledge_final_AHC into #Final_Margin_Pledge   
from #marPledge_Final a left join #unpledge_codes b on a.party_code=b.party_code  
  
update #Final_Margin_Pledge set Margin_Pledge_final_AHC=0.00 where Margin_Pledge_final_AHC<0  
  
/******End*******************************************************/  
  
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price_cusa,c.[Angel scrip category] as Angel_Scrip_cusa,  
case when c.[isin no] like 'INF%' and c.[angel_var %]=100.00 then 15.00   
         when c.[ANGEL_VAR %]<20.00 then 20.00 else c.[ANGEL_VAR %]   end  as Var_margin_cusa  
,c.series,  
CONVERT(MONEY, 0) as Value_BHC_cusa,  
CONVERT(MONEY, 0) as Value_AHC_cusa,[BSE code] as BSEcode,[NSE symbol] as NSEsymbol  
  into #CUSA_code_Main from #CUSA_code a left join #Combine_Closing_File b with(nolock) on   
a.certno=b.security_isin join  cusa_scrip c with(nolock) on a.certno=c.[isin no]  
  
alter table #CUSA_code_Main add value_BHC_UnNew money  
  
update #CUSA_code_Main set Value_BHC_cusa=qty*MTM_Price_cusa  
update #CUSA_code_Main set Value_AHC_cusa=isnull(Value_BHC_cusa,0)-(isnull(Value_BHC_cusa,0)*isnull(Var_margin_cusa,0)/100)  
update #CUSA_code_Main set value_BHC_UnNew=Value_BHC_cusa where flag='Un'  
  
select sum(Value_AHC_cusa) as Value_AHC_cusa,party_Code into #CUSA_code_final from #CUSA_code_Main  group by party_code  
  
select SUM(Value_AHC_unsett) as Unsetteled_AHC,party_code into #unsett_holding_Final1 from #unsett_holding group by party_code  
  
 select a.party_code,a.Value_AHC_cusa,  
 b.Margin_pleadge_AHC,c.Unsetteled_AHC,  
isnull(a.Value_AHC_cusa,0) as final_value_AHC into #final_marginpleadge  
 from #CUSA_code_final a left join  #marPledge_Final b   
on a.party_code=b.party_code   
left join #unsett_holding_Final1 c on a.party_code=c.party_code   
  
declare @MARGINDATE AS DATETIME  , @MARGINDATE_peak AS DATETIME    
           
SELECT @MARGINDATE=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock)   
SELECT @MARGINDATE_peak=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock)   
  
/**************************************added for MTF Margin *********************/  
/*  
select isnull(margin_Req,0.00) as margin_Req ,party_code,sauda_date into #MTF_margin from Anand1.MTFTrade.dbo.MTF_Avilable_Cash with(nolock) where margin_Req>0 and  
sauda_date=@MARGINDATE  
*/  
/******************************************************************************/  
  
select /*TDAY_MARGIN*//*+TDAY_MTM*/ 0 as margin ,party_code,margindate into #margin from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock) where margindate=@MARGINDATE--'2020-12-29 00:00:00.000'    
  
select party_code, SUM(margin) as Margin into #mar from #margin group by party_code  
    
--select TDAY_MARGIN/*+TDAY_MTM*/ as margin ,party_code,margindate into #marginPk from ANAND1.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock) where margindate=@MARGINDATE_peak--'2020-12-29 00:00:00.000'    
select /*TDAY_MARGIN*//*+TDAY_MTM*/0.00 as margin ,party_code,margindate into #marginPk from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock) where margindate=@MARGINDATE_peak--'2020-12-29 00:00:00.000'    
  
select party_code, SUM(margin) as Margin into #marpk from #marginPk group by party_code  
  
 SELECT party_code, MAX(Margin) as margin    
  into #mainMargin FROM    
  (    
   SELECT party_code, MAX(margin) as  Margin   
   FROM #mar     
   GROUP BY party_code    
   UNION ALL    
   SELECT party_code, MAX(margin) as   Margin  
   FROM #marpk     
   GROUP BY party_code    
  ) as subQuery    
  GROUP BY party_code   
  
 select party_code,SUM(Value_AHC_cusa) as Value_AHC_cusa into #cusa_combined from #CUSA_code_Main group by party_code  
   
 select party_code,isnull(Margin_pleadge_AHC,0.00) as Margin_pleadge_AHC, isnull(Unsetteled_AHC,0.00) as Unsetteled_AHC,sum(final_value_AHC) as final_value_AHC  
  into #main_marPleadge  
   from #final_marginpleadge group by party_code,Margin_pleadge_AHC,Unsetteled_AHC  
   
  
 select a.party_code,a.Margin_pleadge_AHC,a.Unsetteled_AHC,a.final_value_AHC,b.val as Balance,b.UnRecoCr,b.ShortSellValue,b.AccruedCharges,b.LedgerBal,  
 isnull(c.margin*-1,0.00) as margin,  
  (case when (isnull(a.Margin_pleadge_AHC,0.00)+(b.ShortSellValue*1.2))>0 then 0 else  (isnull(a.Margin_pleadge_AHC,0.00)+(b.ShortSellValue*1.2)) end)   
 as shortsellWithMarginPledge  
 into #final12 from #main_marPleadge a   
 left join #LedgerBal b on a.party_code=b.cltcode  
 left join #mainMargin c on a.party_code=c.party_code  
   
  update b  set LedgerBal = isnull(b.LedgerBal,0.00)+ isnull(b.shortsellWithMarginPledge,0.00)  from #final12 b  
   
select  party_code,Margin_pleadge_AHC,Unsetteled_AHC,final_value_AHC,Balance,UnRecoCr,ShortSellValue,AccruedCharges,LedgerBal,margin  
,isnull(0,0.00)+isnull(LedgerBal,0.00)  as finalRelease into #final1 from #final12  
   
 SELECT party_code, min(finalRelease) as finalRelease    
  into #main FROM    
  (    
   SELECT party_code, min(finalRelease) as  finalRelease   
   FROM #final1     
   GROUP BY party_code    
   UNION ALL    
   SELECT party_code, min(Value_AHC_cusa) as   finalRelease  
   FROM #cusa_combined     
   GROUP BY party_code    
  ) as subQuery    
  GROUP BY party_code  
  
select distinct a.bcltdpid,a.Flag,a.party_code,a.certno as isin,a.sett_no,a.qty as MarkedQty,MTM_Price_cusa as MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,  
Value_AHC_cusa as Value_AHC,CONVERT(MONEY, 0) as  approved  
,b.finalRelease as Net,BSEcode,NSEsymbol into #final_release1  from #CUSA_code_Main a left join #main b on a.party_code=b.party_code order by a.party_code    
  
select distinct a.*,b.Margin_pleadge_AHC,b.Unsetteled_AHC,b.final_value_AHC as HoldingPostHC,b.Balance,b.UnRecoCr,b.ShortSellValue,  
b.AccruedCharges,  
b.LedgerBal,b.margin,CONVERT(money,0.00) as Unsetteled_BHC,CONVERT(money,0.00) as MTF_Available_Cash,CONVERT(money,0.00) as Actual_Ledger_Bal  
 into #final_release from #final_release1 a left join #final1 b on a.party_code=b.party_code  
   
alter table #final_release add Seq_approve_status varchar(50)    
  
alter table #final_release add ReleasedQty int  
alter table #final_release add BlockedQty int  
alter table #final_release add Releasedvalue money  
  
  
update #final_release set Unsetteled_BHC =ISNULL(b.Unsetteled_BHC,0.00) from #unsett_holding_Final b  
where #final_release.party_code=b.party_code  
  
update #final_release set MTF_Available_Cash =ISNULL(b.vbal,0.00) from #MTFAvaliableCash b  
where #final_release.party_code=b.cltcode  
  
  
update #final_release set Actual_Ledger_Bal =ISNULL(b.val,0.00) from #ActualLedgerBAl b  
where #final_release.party_code=b.cltcode  
  
update #final_release set Seq_approve_status='Released',ReleasedQty=MarkedQty,BlockedQty=0  
where sett_no< (select SETT_NO from [CSOKYC-6].general.dbo.Cusa_due_SETT_NO)  and  Seq_approve_status is null    
  
/**Start***************CUSAPA for Net debit 100/1000********** added on 05 May 2023**********************************************************/  
  
update a set ReleasedQty=MarkedQty,BlockedQty=0,Seq_approve_status='Released' from #final_release a where NET>=-100 and NET<0  and   
Seq_approve_status is null  
  
update a set Seq_approve_status= case when (NET+Margin_pleadge_AHC)>=0 then 'Released' end,   
ReleasedQty= case when (NET+Margin_pleadge_AHC)>=0 then markedqty end ,  
BlockedQty=case when (NET+Margin_pleadge_AHC)>=0 then 0 end from #final_release a where NET>=-1000 and NET<0 and Margin_pleadge_AHC>0 and  
Seq_approve_status is null   
  
/**End***************************************************************************************************************************************/  
  
update #final_release set Seq_approve_status=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then 'Blocked' else 'Released' end),  
ReleasedQty=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then 0 else MarkedQty end),  
BlockedQty=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then MarkedQty else 0 end)  
where NET>=0  and Seq_approve_status is null   
  
update #final_release set Seq_approve_status=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then 'Blocked' else 'Released' end),  
ReleasedQty=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then 0 else MarkedQty end),  
BlockedQty=(case when  Actual_Ledger_Bal+UnRecoCr+AccruedCharges<0 then MarkedQty else 0 end)  
where net>=0 and Value_AHC =0.00 and Seq_approve_status is null   
   
update #final_release set Seq_approve_status='Released' where ReleasedQty>0  
  
 select * into #var_100 from #final_release where  Var_margin_cusa=100.00 and Net<0 and Seq_approve_status is null  
  
update #var_100 set Var_margin_cusa=99.00    
  
update #var_100 set Value_BHC_cusa=MarkedQty*MTM_Price  
update #var_100 set Value_AHC=isnull(Value_BHC_cusa,0)-(isnull(Value_BHC_cusa,0)*isnull(Var_margin_cusa,0)/100)  
  
  update a set Var_margin_cusa=b.Var_margin_cusa,Value_BHC_cusa=B.Value_BHC_cusa,Value_AHC=b.Value_AHC from #final_release a,    
  (    
  select sett_no,party_code,isin,Var_margin_cusa,MarkedQty,Value_BHC_cusa,Value_AHC from #var_100    
  )b where ltrim(rtrim(a.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(a.isin))=ltrim(rtrim(b.isin))    
  and ltrim(rtrim(a.sett_no))=ltrim(rtrim(b.sett_no)) and a.Var_margin_cusa=100    
  
select  convert(decimal(18,2),SUM(value_AHC)) as  value_AHC,party_code,convert(decimal(18,2),NET) as NET into  #ee from #final_release  
 where Seq_approve_status is null and Net<0 group by party_code,NET    
    
Select * into #data from #ee where (NET*-1)>=value_AHC    
      
update #final_release set  Seq_approve_status = 'Blocked' from    
(select party_code from #data) b where #final_release.party_code=b.party_code and Seq_approve_status is null  --and  Flag='Cusa'  
  
/************************/  
select  convert(decimal(18,2),SUM(value_AHC)) as  value_AHC,party_code,convert(decimal(18,2),NET) as NET into  #eew from #final_release  
 where Seq_approve_status is null  and Net>0 group by party_code,NET    
    
Select * into  #data1 from #eew where (NET)>=value_AHC    
     
update #final_release set  Seq_approve_status = 'Released' from    
(select party_code from #data1) b where #final_release.party_code=b.party_code and Seq_approve_status is null    
/*************************/  
    
update  #final_release set ReleasedQty=MarkedQty,BlockedQty=0  where Seq_approve_status='Released' --and  Flag='Cusa'    
update  #final_release set ReleasedQty=0,BlockedQty=MarkedQty where Seq_approve_status='Blocked'  --and  Flag='Cusa'  
 update #final_release set ReleasedValue=(ReleasedQty*mtm_price)*(100-var_margin_cusa)/100  where Seq_approve_status='Released'   
  
 select * into #final from #final_release  where Seq_approve_status is null  and  Flag='Cusa'  and Net<0  
   
select id=row_number() over(order by  sett_no )            
,denseid=dense_rank() over(order by party_code),  
scrip_shortage=isnull(mtm_price,0)*MarkedQty  
,adjval=convert(money,0),bal=convert(money,0) ,           
*           
into  #holding_CUSA           
from #final  
  
  
select   
id,denseid,  
sqoffsseg=row_number() over(partition by party_code order by scrip_shortage desc )/*Added on 27Jan 2022*/   
,scrip_shortage,adjval,bal,bcltdpid,Flag,party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series,   
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr,  
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status  
,BlockedQty=0  
,releasedQty=0,sqoffseq=0,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),  
shortagereduction=Value_AHC,shortage=convert(money,0),  
[holding value after HC]=convert(money,0) ,ReleasedValue,rate=CAST(Value_AHC/MarkedQty AS DECIMAL(18,2) )  
--final_AHC_for_adjust,NewNet   
into  #hld_Cusa  
from #holding_CUSA-- where party_code='A159174'  
order by sqoffsseg  
  
update a set a.shortage=(case when a.Net<0 then (a.Net*-1) else a.Net end)  from #hld_Cusa a  where a.sqoffsseg=1    
  
  
;with hold_cte as (    
select     
sqoffsseg,scrip_shortage,adjval,bal,bcltdpid,Flag, party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series,   
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr,  
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status,BlockedQty,releasedQty,ReleasedValue,rate,  
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,    
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hld_Cusa x     
where  sqoffsseg=1 --and party_Code='A14876'        
union all    
select     
e.sqoffsseg,scrip_shortage,adjval,bal,bcltdpid,Flag ,e.party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series,   
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr,  
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status,BlockedQty,releasedQty,ReleasedValue,rate,shortagereduction,    
shortage= (ecte.shortage-shortagereduction)    
from #hld_Cusa e inner join (select party_code,sqoffsseg,shortage from  hold_cte) ecte on ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1     
--and ecte.shortage>0    
)    
select * into  #holdd_CUSA    
from hold_cte option  (maxrecursion 32767) ;   
--#holdd_CUSA where party_code='K582315'  
update #holdd_CUSA set shortagereduction=shortagereduction+shortage,shortage=0  where shortage<0   
  
update a set BlockedQty=(case when ceiling(convert(money,shortagereduction)/convert(money,rate)) <= markedqty then  
ceiling(convert(money,shortagereduction)/convert(money,rate)) else markedqty end)  
from #holdd_CUSA a where isnull(rate,0)>0 and shortagereduction>=0  
  
update a set releasedQty=isnull(markedqty,0)-isnull(BlockedQty,0) from #holdd_CUSA a-- where BlockedQty>0  
   
 update a set ReleasedValue=(ReleasedQty*mtm_price)*(100-var_margin_cusa)/100  from #holdd_CUSA a where  isnull(MTM_Price,0)>0   
  
  
update a set releasedQty=0,BlockedQty=markedqty,ReleasedValue=0,Seq_approve_status='Blocked' from #holdd_CUSA a where releasedQty<0  
   
update a set Seq_approve_status=case when MarkedQty=ReleasedQty then 'Released'    
  when MarkedQty=BlockedQty then 'Blocked'    
  when  MarkedQty>ReleasedQty  and BlockedQty<>0 and ReleasedQty<>0 then 'Partially Released' end from #holdd_CUSA a where releasedQty>0  
 --#final where party_code='G16378'  
  
   update #final set ReleasedQty=isnull(b.ReleasedQty,0),BlockedQty=isnull(b.BlockedQty  ,0),ReleasedValue=ISNULL(b.ReleasedValue,0.00)  
 ,Seq_approve_status=b.Seq_approve_status  
   from    
  (    
  select sett_no,party_code,isin,ReleasedQty,markedqty,BlockedQty,ReleasedValue,Seq_approve_status from #holdd_CUSA    
  )b where ltrim(rtrim(#final.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final.isin))=ltrim(rtrim(b.isin))    
  and ltrim(rtrim(#final.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#final.markedqty))=ltrim(rtrim(b.markedqty))   
  and #final.Flag='Cusa'  
  
    
  update #final_release set approved=b.approved,Seq_approve_status=B.Seq_approve_status,ReleasedQty=b.ReleasedQty,    
  BlockedQty=b.BlockedQty,ReleasedValue=ISNULL(b.ReleasedValue,0.00)    
   from    
  (    
  select sett_no,party_code,isin,approved,Seq_approve_status,ReleasedQty,MarkedQty,BlockedQty,ReleasedValue from #final    
  )b where ltrim(rtrim(#final_release.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_release.isin))=ltrim(rtrim(b.isin))    
  and ltrim(rtrim(#final_release.sett_no))=ltrim(rtrim(b.sett_no))  and  #final_release.Flag='Cusa'  
    
update a set BlockedQty=MarkedQty,ReleasedQty=0,Seq_approve_status='blocked' from #final_release a where  
Seq_approve_status is null  
and flag='cusa' and BlockedQty>0  
  
update a set releasedValue= (ReleasedQty*mtm_price)*(100-var_margin_cusa)/100 from #final_release a  
where ReleasedQty>0 and isnull(releasedValue,0)=0   
  
select *,Value_BHC_cusaBlocked=Blockedqty*MTM_Price,CONVERT(MONEY, 0) as Value_AHC_cusaBlocked into #CUSA_BlockedShare  
from #final_release where Blockedqty>0 and flag='cusa'  
  
  
update #CUSA_BlockedShare set Value_AHC_cusaBlocked=isnull(Value_BHC_cusaBlocked,0)-(isnull(Value_BHC_cusaBlocked,0)*isnull(Var_margin_cusa,0)/100)    
  
select party_code, SUM(Value_AHC_cusaBlocked)Value_AHC_cusaBlocked into #CUSA_blockClub from #CUSA_BlockedShare group by party_code  
   
select *,CONVERT(money,0)Value_AHC_cusaBlocked,CONVERT(money,0)FinalNet  
into  #unsetCode from #final_release a where a.Seq_approve_status is null and a.Flag='un'    
  
update a set  a.Value_AHC_cusaBlocked=b.Value_AHC_cusaBlocked from #unsetCode a,#CUSA_blockClub b where  a.party_code=b.party_code     
   
--select a.*,isnull(b.Value_AHC_cusaBlocked,0) Value_AHC_cusaBlocked,CONVERT(money,0) as FinalNet into  #unsetCode from #final_release a left join #CUSA_BlockedShare b on a.party_code=b.party_code   
--where a.Seq_approve_status is null and a.Flag='un'  
  
update #unsetCode set FinalNet=Net+isnull(Value_AHC_cusaBlocked,0)   
  
update a set ReleasedQty=MarkedQty,blockedQty=0,Seq_approve_status='Released' from #unsetCode a where FinalNet>=0  
  
update a set releasedValue= (ReleasedQty*mtm_price)*(100-var_margin_cusa)/100 from #unsetCode a  
where ReleasedQty>0 and isnull(releasedValue,0)=0   
  
 update #final_release set ReleasedQty=isnull(b.ReleasedQty,0),BlockedQty=isnull(b.BlockedQty  ,0),ReleasedValue=ISNULL(b.ReleasedValue,0.00)  
 ,Seq_approve_status=b.Seq_approve_status  
   from    
  (    
  select sett_no,party_code,isin,ReleasedQty,markedqty,BlockedQty,ReleasedValue,Seq_approve_status from #unsetCode where Flag='un' and  
  FinalNet>0  
  )b where ltrim(rtrim(#final_release.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_release.isin))=ltrim(rtrim(b.isin))    
  and ltrim(rtrim(#final_release.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#final_release.markedqty))=ltrim(rtrim(b.markedqty))   
  and #final_release.Flag='Un'  
  
select id=row_number() over(order by  sett_no )            
,denseid=dense_rank() over(order by party_code),  
/*sqoffsseg=row_number() over(partition by party_code order by qty desc ) */ /*commented on 27Jan 2022*/             
--,scrip_shortage=total   
scrip_shortage=isnull(mtm_price,0)*MarkedQty  
,adjval=convert(money,0),bal=convert(money,0) ,           
--,ReleasedQty=convert(money,0),  
*            
into #holding_un            
from #unsetCode where Flag='un' and  Seq_approve_status is null and FinalNet<0  
  
  
select   
id,denseid,  
sqoffsseg=row_number() over(partition by party_code order by scrip_shortage desc )/*Added on 27Jan 2022*/   
,scrip_shortage,adjval,bal,bcltdpid,Flag,party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series,   
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr,[ShortSellValue],  
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status  
,BlockedQty=0  
,releasedQty=0,sqoffseq=0,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),  
shortagereduction=Value_AHC,shortage=convert(money,0),  
[holding value after HC]=convert(money,0) ,ReleasedValue,FinalNet,rate= CAST(Value_AHC/MarkedQty AS DECIMAL(18,2) )  
into #hld_un  
from #holding_un-- where party_code='A159174'  
order by sqoffsseg  
  
update a set a.shortage=(case when a.FinalNet<0 then (a.FinalNet*-1) else a.FinalNet end)  from #hld_un a  where a.sqoffsseg=1    
  
  
;with hold_cte as (    
select     
sqoffsseg,scrip_shortage,adjval,bal,bcltdpid,Flag, party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series,   
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr,  
[ShortSellValue],  
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status,BlockedQty,releasedQty,ReleasedValue,  
FinalNet,rate,  
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,    
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hld_un x     
where  sqoffsseg=1 --and party_Code='CP6249'        
union all    
select     
e.sqoffsseg,scrip_shortage,adjval,bal,bcltdpid,Flag ,e.party_code,isin,sett_no,MarkedQty,MTM_Price, Angel_Scrip_cusa,Var_margin_cusa, series,   
Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance, UnRecoCr, [ShortSellValue],  
AccruedCharges,LedgerBal,margin, Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status,BlockedQty,releasedQty,ReleasedValue,  
FinalNet,rate,shortagereduction,    
shortage= (ecte.shortage-shortagereduction)    
from #hld_un e inner join (select party_code,sqoffsseg,shortage from  hold_cte) ecte on ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1     
--and ecte.shortage>0    
)    
select * into  #holdd_un    
from hold_cte option  (maxrecursion 32767) ;    
  
update #holdd_un set shortagereduction=shortagereduction+shortage,shortage=0  where shortage<0   
   
  
update a set BlockedQty=(case when ceiling(convert(money,shortagereduction)/convert(money,rate)) <= markedqty then  
ceiling(convert(money,shortagereduction)/convert(money,rate)) else markedqty end)  
from #holdd_un a where isnull(rate,0)>0  and shortagereduction>=0  
  
 update a set releasedQty=isnull(markedqty,0)-isnull(BlockedQty,0) from #holdd_un a --where BlockedQty>0  
    
 update a set ReleasedValue=(ReleasedQty*mtm_price)*(100-var_margin_cusa)/100  from #holdd_un a where  isnull(MTM_Price,0)>0 and ReleasedQty<>0    
  
update a set releasedQty=0,BlockedQty=markedqty,ReleasedValue=0,Seq_approve_status='Blocked' from #holdd_un a where releasedQty<0  
   
update a set Seq_approve_status=case when MarkedQty=ReleasedQty then 'Released'    
  when MarkedQty=BlockedQty then 'Blocked'    
  when  MarkedQty>ReleasedQty  and BlockedQty<>0 and ReleasedQty<>0 then 'Partially Released' end from #holdd_un a where releasedQty>0  
  
update a set Seq_approve_status=case when MarkedQty=ReleasedQty then 'Released'      
  when MarkedQty=BlockedQty then 'Blocked'      
  when  MarkedQty>ReleasedQty  and BlockedQty<>0 and ReleasedQty<>0 then 'Partially Released' end from #holdd_un a where BlockedQty>0   
   
 update #final_release set ReleasedQty=isnull(b.ReleasedQty,0),BlockedQty=isnull(b.BlockedQty  ,0),ReleasedValue=ISNULL(b.ReleasedValue,0.00)  
 ,Seq_approve_status=b.Seq_approve_status  
   from    
  (    
  select sett_no,party_code,isin,ReleasedQty,markedqty,BlockedQty,ReleasedValue,Seq_approve_status from #holdd_un    
  )b where ltrim(rtrim(#final_release.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_release.isin))=ltrim(rtrim(b.isin))    
  and ltrim(rtrim(#final_release.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#final_release.markedqty))=ltrim(rtrim(b.markedqty))   
  and #final_release.Flag='Un'  
  
/**********Added on 05 Jan 2022 by Neha as per Vishal's Mail******************************/  
truncate table tbl_ProjectedRisk  
   
insert into tbl_ProjectedRisk  
select *  from [CSOKYC-6].General.dbo.Tbl_scripwiseSqoffdata with(nolock)  
  
select party_code,sqtype,isin,accno into #ProjRisk from [CSOKYC-6].General.dbo.Tbl_scripwiseSqoffdata with(nolock) where sqtype in ('ProjRisk','ASB7','MTF Ageing') and  
  AccNo in ('''1203320186015090''','''IN30134820306643''')  
       
  insert into CUSA_ProjRisk_ASB7(party_code,sqtype,isin,accno,bcltdpid,cltcode,ISIN_Proj,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,ShortSellValue,AccruedCharges,LedgerBal,margin,Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,Seq_approve_status,ReleasedQty,BlockedQty,UpdatedOn)  
  select a.*,b.bcltdpid,b.party_code as cltcode,b.isin as ISIN_Proj,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,  
  NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,ShortSellValue,AccruedCharges,LedgerBal,margin,Unsetteled_BHC,MTF_Available_Cash,  
  Actual_Ledger_Bal,Seq_approve_status,ReleasedQty,BlockedQty  
 ,GETDATE() as UpdatedOn from #ProjRisk a left join #final_release b on a.party_code=b.party_code and a.isin=b.isin where b.Seq_approve_status in ('Partially Released','Released')  
   
    
update #final_release set ReleasedQty = 0,BlockedQty=MarkedQty ,Seq_approve_status='Blocked' from #ProjRisk b    
where #final_release.party_code=b.party_code and #final_release.isin=b.isin  and #final_release.Seq_approve_status in ('Partially Released','Released')  
   
/***************End*************************/  
update #final_release set Seq_approve_status='Blocked' where Seq_approve_status is null and blockedqty>0 and releasedqty=0  
update a set Seq_approve_status='Released' from #final_release a where Seq_approve_status is null and blockedqty=0 and releasedqty>0  
  
  
insert into Cusa_Po_hist(bcltdpid,party_code,isin,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,  
approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,[ShortSellValue_Into_120%],AccruedCharges,  
LedgerBal,margin,Seq_approve_status,ReleasedQty,BlockedQty,Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,squareoffqty,Squareoffdate,flag,  
ReleasedValue,  
UpdatedOn)  
select bcltdpid,party_code,isin,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,  
NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,[ShortSellValue_Into_120%],AccruedCharges,LedgerBal,margin,  
Seq_approve_status,ReleasedQty,BlockedQty,Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,squareoffqty,Squareoffdate,Flag,ReleasedValue  
,GETDATE() from Cusa_Po  
  
truncate table Cusa_Po  
  
insert into Cusa_Po(bcltdpid,party_code,isin,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,[ShortSellValue_Into_
120%],AccruedCharges,LedgerBal,margin,Seq_approve_status,ReleasedQty,BlockedQty,Unsetteled_BHC,MTF_Available_Cash,Actual_Ledger_Bal,flag,ReleasedValue)  
select bcltdpid,party_code,isin,sett_no,MarkedQty,MTM_Price,Angel_Scrip_cusa,Var_margin_cusa,series,Value_BHC_cusa,Value_AHC,approved,Net,BSEcode,NSEsymbol,Margin_pleadge_AHC,Unsetteled_AHC,HoldingPostHC,Balance,UnRecoCr,ShortSellValue,AccruedCharges,Ledg
erBal,margin,Seq_approve_status,ReleasedQty,BlockedQty  
,isnull(Unsetteled_BHC,0.00),ISNULL(MTF_Available_Cash,0.00),ISNULL(Actual_Ledger_Bal,0.00),Flag,ReleasedValue  from #final_release  
  
exec Cusa_PO_ForSquareOffQty  
  
  
update Cusa_Po set squareoffqty=ISNULL(b.squareoffqty,0) from Tbl_cusa_SquareOffQty b  
where Cusa_Po.party_code=b.party_code and Cusa_Po.sett_no=b.sett_no and  
Cusa_Po.BSEcode=b.bsecode and Cusa_Po.NSEsymbol=b.nsesymbol and   
Cusa_Po.isin=b.isin and /*Cusa_Po.MarkedQty=b.markedqty and */Cusa_Po.MTM_Price=b.MTM_Price  
  
/************************************************/  
 select * into #due from [CSOKYC-6].general.dbo.Cusa_Due_sett_date with(nolock)  
   
 update Cusa_Po set Squareoffdate=b.start_date from #due b where Cusa_Po.sett_no=b.sett_no and   
 Seq_approve_status in ('Partially Released','Blocked') and squareoffqty is not null  
  
update Cusa_Po set Squareoffdate=b.start_date from   
(select min(start_date) start_date from #due)b where Cusa_Po.sett_no< (select min(sett_no) from #due) and Seq_approve_status in ('Partially Released','Blocked')  
and squareoffqty is not null  
/************************************************/  
/****Start******Added on 28 Oct 2022 as per Vishal G for M settelment**************************************/  
select * into #fg from  
 [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)          
where /*co_code='BSECM' and sett_type='D' */  
 co_code='NSECM' and sett_type='M' and sett_no <=(select min(Sett_No) from [CSOKYC-6].general.dbo.Cusa_M_settelment with(nolock)) order by Sett_No desc  
  
   select * into #due1 from [CSOKYC-6].general.dbo.Cusa_M_settelment with(nolock)  
   
update Cusa_Po set Squareoffdate=b.start_date from   
(select min(start_date) start_date from #due1)b    
where sett_no in (select SETT_NO from #fg) and Seq_approve_status in ('Partially Released','Blocked')  
and squareoffqty is not null  
  
   select top 2 * into #sett from [CSOKYC-6].general.dbo.Cusa_M_settelment with(nolock) order by sett_no desc  
  
    update Cusa_Po set Squareoffdate=b.start_date from #sett b where Cusa_Po.sett_no=b.sett_no and   
 Seq_approve_status in ('Partially Released','Blocked') and squareoffqty is not null  
/*****************************************************************************************/  
/****Start******Added on 02 July 2021 as per Vishal G mail**************************************/  
  
select * into #cusa1 from Cusa_Po where sett_no<= (select SETT_NO from [CSOKYC-6].general.dbo.Cusa_due_SETT_NO)    
  
--delete from #cusa1 where sett_no in (select sett_no from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)  where  sett_type='F' )  --exclude sttelment type 'F'  
  
  
select *,MarkedQty-ReleasedQty-ISNULL(squareoffqty,0) as BalanceQty into #cusa2 from #cusa1 where ISNULL(squareoffqty,0)>0  
  
update #cusa2 set ReleasedQty=ReleasedQty+BalanceQty ,BlockedQty=BlockedQty-BalanceQty  where BalanceQty>0  
  
update #cusa2  set Seq_approve_status=case when MarkedQty=ReleasedQty then 'Released'    
  when MarkedQty=BlockedQty then 'Blocked'    
  when MarkedQty>ReleasedQty  and BlockedQty<>0 and ReleasedQty<>0 then 'Partially Released' end   where BalanceQty>0  
  
  
update Cusa_Po set ReleasedQty=b.ReleasedQty,BlockedQty=b.BlockedQty,Seq_approve_status=b.Seq_approve_status  from    
(    
select Sett_no,party_code,isin,approved,Seq_approve_status,BlockedQty,ReleasedQty,MarkedQty,BalanceQty from #cusa2 where BalanceQty>0    
)b where ltrim(rtrim(Cusa_Po.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(Cusa_Po.isin))=ltrim(rtrim(b.isin))    
and ltrim(rtrim(Cusa_Po.Sett_no))=ltrim(rtrim(b.Sett_no)) and Cusa_Po.MarkedQty=b.MarkedQty    
  
  
update Cusa_Po set ReleasedValue=(ReleasedQty*mtm_price)*(100-var_margin_cusa)/100  where isnull(ReleasedValue,0)=0.00 and releasedqty>0  
and ReleasedValue=0.00  
  
  
/****End********************************************/  
  
exec USP_CUSA_PO_File_Generation  
  
Exec USP_CUSA_PO_File_Unsettel_Generation  
  
truncate table Cusa_Po_heading  
  
insert into Cusa_Po_heading  
/*select 'bcltdpid','party_code','isin','sett_no','MarkedQty','MTM_Price','Angel_Scrip_cusa','Var_margin_cusa','series','Value_BHC_cusa','Value_AHC','approved',  
'Net','BSEcode','NSEsymbol','HoldingPostHC','LedgerBal','margin','Seq_approve_status','ReleasedQty','BlockedQty'  
*/  
select 'bcltdpid','party_code','isin','sett_no','MarkedQty','MTM_Price','Angel_Scrip_cusa','Var_margin_cusa','series','Value_BHC_cusa','Value_AHC','approved'  
,'Net','BSEcode','NSEsymbol','Margin_pleadge_AHC','Unsetteled_AHC','HoldingPostHC','Balance','UnRecoCr','ShortSellValue','AccruedCharges',  
'LedgerBal','margin','Seq_approve_status','ReleasedQty','BlockedQty','Unsetteled_BHC','MTF_Available_Cash','Actual_Ledger_Bal','squareoffqty',  
'Squareoffdate','Flag','ReleasedValue'  
  
  
insert into Cusa_Po_heading  
select *  
from Cusa_Po  
  
DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)                                
   SELECT @emailto='anil.wandre@angelbroking.com;lalit.lathe@angelbroking.com;ashok.maniyar@angelbroking.com;kunal.pachkude@angelbroking.com;Vishal@angelbroking.com;manish.shah@angelbroking.com;sanjay.chavan@angelbroking.com'       
   select @emailcc=''--'rahulc.shah@angelbroking.com'      
   select @emailbcc='neha.naiwar@angelbroking.com'   
     
  DECLARE @s VARCHAR(MAX) = ''                                        
   /*declare @FileName as varchar(100) = 'LD_File'+replace(CONVERT(char(10),getdate(),103),'/','-')+'.csv'*/    
   declare @FileName as varchar(100) = 'CUSA_PO'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                                               
      declare @FilePath varchar(200) ='' /* '\\196.1.115.183\d$\upload\CMS_Test\'+@FileName  */                       
     -- select @FilePath='\\172.29.19.16\public\NehaN\'+@FileName   
     select @FilePath='\\196.1.115.183\cusa_mtf\'+@FileName            
                                     
      SET @s = 'exec  MASTER.dbo.xp_cmdshell ' + ''''                                       
      SET @s = @s + 'bcp "select * from [196.1.115.132].cms.dbo.Cusa_Po_heading" queryout '+ @FilePath + ' -c -t, -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                                                              
     
     
           
      SET @s = @s + ''''            
      EXEC(@s)   
          
 /*                                      
SET @MESS='Dear All,<br><Br>Good Morning!!!<br><Br>Please refer the below path for CUSA Payout File.<Br><Br><b>\\172.29.19.16\public\NehaN\</b><Br>'                                        
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(In-house system)'                                    
set @sub ='CUSA Payout Release file'                       
                        
                          
 DECLARE @s1 varchar(500)                        
 SET @s1 = @FilePath                 
                          
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                    
 @RECIPIENTS =@emailto,                                    
 @COPY_RECIPIENTS = @emailcc,                                    
 @blind_copy_recipients=@emailbcc,                          
 @PROFILE_NAME = 'AngelBroking',                                    
 @BODY_FORMAT ='HTML',                                    
 @SUBJECT = @sub ,                                    
 @FILE_ATTACHMENTS ='',--@s1,                                    
 @BODY =@MESS     
*/  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_DRA_MailSend_RFRL_Branch
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SP_DRA_MailSend_RFRL_Branch]
(
--Declare 
@Name varchar(250)='Testinggg',
	@Email varchar(250)='yogesh.rewatkar@angelone.in',
	@UserID varchar(50)='XYZ',
	@PWD varchar(50)='Asmnvbal'
)
AS
BEGIN

	Begin Try    

		INSERT INTO TBL_DRA_MailLog(Name, Email, UserID, PWD, status, LogDate)
		SELECT @Name, @Email, @UserID, @PWD, 'RFRL Email Process Start', GETDATE()

			IF ISNULL(@Name, '') <> '' AND ISNULL(@Email, '') <> '' AND ISNULL(@UserID, '') <> '' AND ISNULL(@PWD, '') <> ''
			BEGIN
			
					DECLARe @link VARCHAR(max)
					
					SELECT	@link = CAST(N'' AS XML).value('xs:base64Binary(xs:hexBinary(sql:column("encCode")))', 'VARCHAR(MAX)')
							
					FROM (      
							SELECT CAST(UPPER(@UserID) AS VARBINARY(MAX)) AS encCode
					) AS bin_sql_server_temp;
					
					
					--set @link = 'https://online.angelbroking.com/Diykyc/SubbrokerLead?SbTag=' + @link


					set @link='https://itrade.angelone.in/Diykyc/SubbrokerLead?SbTag='+ @link

					Create table #TinyUrl (url varchar(max));
					insert into #TinyUrl
					EXEC [ABVSKYCMIS].[kyc].dbo.spx_Campaign_GetTinyUrl @link 


					set @link= (select url from #TinyUrl)

					print @link
					drop table #TinyUrl
					Declare @Content varchar(max) = '', @subject varchar(250) = '', @BCCEmailIDs varchar(500) = ''

					--SET @BCCEmailIDs = 'planit.maaz@angelbroking.com;neha.1joshi@angelbroking.com;varinda.khurana@angelbroking.com;sanjeev.k@angelbroking.com;raj.onayak@angelbroking.com'
					
					SET @BCCEmailIDs = 'laksh.garg@angelone.in'
					
					SET @subject = 'Welcome to AngelOne Partner Platform'


SET @Content = '
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Angel One</title>
</head>
<body>
	<table width="800" align="center" cellpadding="0" cellspacing="0">
		<tr>
			<td>
				<a href="#">
					<img src="https://cdn.angelone.in/nxt/images/Digital-Referral-Program-6th-March.jpg" alt="" style="display: block; width: 100%">
				</a>
			</td>
		</tr>
		<tr>
			<td style="background: #ebebeb;">
				<table width="670" align="center" cellpadding="0" cellspacing="0">
					<td>
						<tr>
							<td height="30px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.8em; color: #333">
								Dear '+ @Name +', 
							</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
								We would like to extend a warm welcome to you on behalf of the entire Angel
One family. We are delighted to onboard you to our AngelOne Partner
program.
							</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
								We have received and processed your registration details. Please find your partner
credentials below.
							</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333; font-weight: 700;">
								Login Details : 
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.8em; color: #333; padding-top: 10px;">
								Dashboard link: <a href="https://nxt.angelone.in/auth/referral-associate" target="_blank">https://nxt.angelone.in/auth/referral-associate</a>
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.8em; color: #333">
								Username: <a href="https://nxt.angelone.in/auth/referral-associate" target="_blank">'+@UserID+'</a>
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.8em; color: #333">
								Password:  <a href="https://nxt.angelone.in/auth/referral-associate" target="_blank">'+@PWD+'</a>
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 14px; line-height: 1.8em; color: #333; font-weight: 700;">
								<strong>Note: You can also log in through OTP with your registered mobile number. </strong>
							</td>
						</tr>

						<tr>
							<td height="25px">&nbsp;	
							</td>
						</tr>

						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333; font-weight: 700; "> 
								Your Client Referral Link is available on the right side of the Home Page.
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.8em; color: #333; padding-top: 10px;">
								You may also find it under Sales > MIS > Client Referral > Click on Refer a Client
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.8em; color: #333; padding-top: 10px;">
								You can copy and share the link across your social media platforms (adhering to the partnership guidelines)
							</td>
						</tr>
			
						<tr>
							<td height="15px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333; font-weight: 700;">
								DRA Content support telegram channel joining link

							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333; padding-top: 10px;">
								 <a href="https://telegram.me/+TDzH8Qbnv0Y2YThl" target="_blank">https://telegram.me/+TDzH8Qbnv0Y2YThl</a>
							</td>
						</tr>
						<tr>
							<td height="15px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333; font-weight: 700;">
								Other Useful Links 

							</td>
						</tr>
						
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333; padding-top: 10px;">
								Dashboard NXT 2.0 Demo Videos <br>
								 <a href="https://drive.google.com/drive/folders/1ZgF7c_8Z0W9UWp2lpy_SfwY1sVkLXc6i?usp=sharing" target="_blank">
									https://drive.google.com/drive/folders/1ZgF7c_8Z0W9UWp2lpy_SfwY1sVkLXc6i?usp=sharing
								</a>
							</td>
						</tr>
						<tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333; padding-top: 10px;">
						Daily /Weekly/Rollover Technical reports: <br>
								 <a href="https://www.angelone.in/research/technical/overview" target="_blank">https://www.angelone.in/research/technical/overview</a>
							</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
						Our Products and Services : <br>
								 <a href="https://www.angelone.in/products-and-services" target="_blank">https://www.angelone.in/products-and-services</a>
							</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
							
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
						Podcast :  <br>
								 <a href="https://www.angelone.in/podcast" target="_blank">https://www.angelone.in/podcast</a>
							</td>
						</tr>
						<!-- <tr>
							<td height="30px">&nbsp;
								
							</td>
						</tr> -->
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
								Please feel free to get in touch for any query at drasupport@angelbroking.com.
							</td>
						</tr>
						<tr>
							<td height="30px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
								We would want to introduce you to our team as fun-loving and dedicated business professionals who aspire to achieve our common business goals by valuing sincerity, honesty, boldness, and timely resolution of any issues related to our business.</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
								We assure you that with our exceptional teamwork & rigorous three decades of
experience in the retail trading industry, we comprehend the complete harmony
between quality-in-process and the need for constant improvement to deliver
excellent services that will enchant our customers.</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
								As you are already aware Angel One, as a brand, consistently offers the most competitive
prices in the industry and provides the best and most effective value-added services in the
financial space.</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
								We want to reiterate that with our best processes, technologies, and one of
the most insightful research teams, our platform will provide you with a
substantial competitive edge. Furthermore, we also assure you of the
uninterrupted availability of exceptional services for your referred clients.</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
								We believe, If you want to go fast, go alone. If you want to go far, go together."</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333">
								We look forward to your long-term association with the Angel One family. We would
love to hear your thoughts and any feedback you might have for us.</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333; font-weight: 700;">
								Let''s Grow Together 
							</td>
						</tr>
						<tr>
							<td height="10px">&nbsp;
								
							</td>
						</tr>
						<tr>
							<td style="font-family: Arial,sans-serif; font-size: 15px; line-height: 1.4em; color: #333;">
								Team AngelOne 
							</td>
						</tr>
						<tr>
							<td height="30px">&nbsp;
								
							</td>
						</tr>
					</td>
				</table>
			</td>
		</tr>
		<tr>
			<td style="background: #000000; padding: 10px 0 5px 0;">
				<table width="780" align="center" cellpadding="0" cellspacing="0">
					<tr>
						<td width="22">
							<a href="https://www.facebook.com/AngelBrokingLtd" target="_blank">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/draemail/fb.jpg" alt="">
							</a>
						</td>
						<td width="22">
							<a href="https://www.instagram.com/angelbroking/?hl=en" target="_blank">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/draemail/insta.jpg" alt="">
							</a>
						</td>
						<td width="22">
							<a href="https://www.youtube.com/user/AngelBrokingVideos" target="_blank">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/draemail/youtube.jpg" alt="">
							</a>
						</td>
						<td width="22">
							<a href="https://www.linkedin.com/company/angel-broking" target="_blank">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/draemail/in.jpg" alt="">
							</a>
						</td>
						<td width="22">
							<a href="https://twitter.com/angelbrokingltd" target="_blank">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/draemail/tw.jpg" alt="">
							</a>
						</td>
						<td width="251"  align="right" style="text-align:right">
							<a href="tel:022-33551111">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/draemail/call1.jpg" alt="">
							</a>
						</td>
						<td width="66"  align="right" style="text-align:right">
							<a href="tel:42185454">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/draemail/call2.jpg" alt="">
							</a>
						</td>
						<td width="199"  align="right" style="text-align:right">
							<a href="mailto:dra@angelbroking.com">
								<img src="http://web.angelbackoffice.com/angelbroking/econnect/jm/draemail/email.jpg" alt="">
							</a>
						</td>
						<td width="152" align="right" style="text-align:right">
							<a href="https://www.angelone.in/" target="_blank">
								<img src="https://mf.angelmf.com/Images/angelone.jpg" alt="">
							</a>
						</td>
					</tr>
				</table>
			</td>
		</tr>
		<tr>
			<td style="background: #e3e5e4;">
				<table width="780" border="0" cellspacing="0" cellpadding="0" align="center"><tbody><tr><td style="font-family:Arial,sans-serif;font-size:10px;padding:5px 0px;color:rgb(51,51,51);line-height:1.2em;text-align:justify">Disclaimer: Investments in securi
ties market are subject to market risk, read all the related documents carefully before investing. Brokerage will not exceed the SEBI prescribed limit. Statutory Levies and Taxes will be levied to the clients as prescribed by the regulators. Angel One Limited (formerly known as Angel One Private Limited), Registered Office: G-1, Ackruti Trade Center, Road No. 7, MIDC, Andheri (E), Mumbai - 400 093. Tel: (022) 42319600 .Fax: (022) 42319607, CIN: U67120MH1996PLC101709, SEBI Regn. No.: INZ000161534-
BSE Cash/F&amp;O/CD (Member ID: 612), NSE Cash/F&amp;O/CD (Member ID: 12798), MSEI Cash/F&amp;O/CD (Member ID: 10500), MCX Commodity Derivatives (Member ID: 12685) and NCDEX Commodity Derivatives (Member ID: 220), CDSL Regn. No.: IN-DP-384-2018, PMS Regn.
 No.: INP000001546, Research Analyst SEBI Regn. No.: INH000000164, Investment Adviser SEBI Regn. No.: INA000008172, AMFI Regn. No.: ARN77404, PFRDA Registration No.19092018. Compliance officer: Mr. Rajiv Kejriwal, Tel: (022) 39413940 Email:&nbsp;<a href=
"mailto:compliance@angelbroking.com" target="_blank">compliance@<wbr>angelbroking.com</a></td></tr>
				</tbody>
				</table>
			</td>
		</tr>
	</table>
</body>
</html>
'

 

					EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL
						@RECIPIENTS = @Email,
						--@COPY_RECIPIENTS = @emailcc, 
						@blind_copy_recipients= @BCCEmailIDs,
						@PROFILE_NAME = 'AngelBroking',
						@BODY_FORMAT ='HTML',
						@SUBJECT = @subject,
						@FILE_ATTACHMENTS ='',
						@BODY =@Content


						INSERT INTO TBL_DRA_MailLog(Name, Email, UserID, PWD, status, LogDate)
						SELECT @Name, @Email, @UserID, @PWD, 'RFRL Email Process END', GETDATE()
						
						----//////////////Changes by Prashant patade and Sharvan Yadvan on 15Sept2020 /////--------------------------------------------------
--						exec SP_DRA_MailSend_TechSupport  @Name,@Email
						-------//////////END///////////////////--------------------------------------


						--dra welcome sms integration
						Declare @SmsCont varchar(300)='', @SmsThank varchar(200)=''
						Declare @MobileNo varchar(10)

						select top 1 @MobileNo= MobNo from [MIS].[SB_COMP].[DBO].SB_Broker data with(nolock)
							inner join [MIS].[SB_COMP].[DBO].sb_Contact  cont with(nolock) on data.RefNo=cont.RefNo
							where data.sbtag=@UserID

							print @MobileNo;

						set @SmsCont = 'Thank you for partnering with Angel One. We are delighted to have you onboard. Login to dashboard using User ID:'+@UserID+' Password:'+@PWD+'. Regards - Angel One' 


						EXEC [ABVSKYCMIS].[kyc].[dbo].[spx_Campaign_trigger_sms]
							@mobileNo = @MobileNo,
							@smsContent = @SmsCont,
							@smsUserId = N'mfKycWebUser',
							@smsPassword = N'5540gw5',
							@smsPurpose = N'DRAWelcome',
							@smsSource = N'DRAWelcome',
							@smsTeam = N'DRA'

							set @SmsThank='Congrats, We welcome you as our Digital Referral Associate. Use your unique referral link & start earning '+@link;

							EXEC [ABVSKYCMIS].[kyc].[dbo].[spx_Campaign_trigger_sms]
							@mobileNo = @MobileNo,
							@smsContent = @SmsThank,
							@smsUserId = N'mfKycWebUser',
							@smsPassword = N'5540gw5',
							@smsPurpose = N'DRAWelcome',
							@smsSource = N'DRAWelcome',
							@smsTeam = N'DRA'

			END		

	End Try    
	Begin Catch    

		Declare @ErrorMessage NVarchar(4000)

		Select @ErrorMessage = 'SP_DRA_MailSend_RFRL_Branch - Error : '  + ERROR_MESSAGE()
				
		INSERT INTO TBL_DRA_MailLog(Name, Email, UserID, PWD, status, LogDate)
		SELECT @Name, @Email, @UserID, @PWD, @ErrorMessage, GETDATE()

	End Catch 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_FundsWithDrawl_API_03Oct2023
-- --------------------------------------------------
-- AUTHOR: ABHA JAISWAL  
-- CREATE DATE: 18/02/2020  
-- DESCRIPTION: SEND DATE AND TIME ON FUND WITHDRAWAL API  
-- =============================================  
CREATE PROCEDURE [dbo].[SP_FundsWithDrawl_API_03Oct2023]  
AS  
BEGIN  
  
--select credittimedate ='9:30AM,06 Sep 2022', credittime=''  
  
--End  
 ---return   
--return 0  
  
DECLARE @CALL_DAY VARCHAR(1) ,@CALL_TIME TIME,@SPLIT_TIME VARCHAR(25),@CALL_DATE VARCHAR (20),@DAY_TYPE varchar(30)  
SET @CALL_DAY=DATEPART(DW,GETDATE())  
SET @CALL_TIME = CONVERT(VARCHAR(5),'17:56',108)    
SET @CALL_DATE=CONVERT(VARCHAR(10), CONVERT(date, GETDATE(), 105), 23)  
  
print @CALL_DAY  
print @CALL_TIME  
print @CALL_DATE  
  
if @CALL_DAY=7  
set @DAY_TYPE='Saturdays'  
else  
set @DAY_TYPE='WEEKDAYS'  
IF OBJECT_ID('#tbl_PO_Credit_DateTime', 'U') IS NOT NULL   
DROP TABLE #tbl_PO_Credit_DateTime  
create table #tbl_PO_Credit_DateTime  
(  
Credit_Date varchar(11),  
Credit_Time varchar(30),  
)  
   
IF EXISTS (SELECT [DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@CALL_DATE)  
BEGIN  
DECLARE @HOLIDAY_DATE VARCHAR(20) ,@nxtholiday date  
SELECT @HOLIDAY_DATE =[DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@CALL_DATE  
print 'hi'  
--print @HOLIDAY_DATE  
insert into #tbl_PO_Credit_DateTime  
select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < convert(date, @HOLIDAY_DATE) and Sett_Type='M')  
  
 select @nxtholiday=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @HOLIDAY_DATE) and Sett_Type='M')  
 print 'df'  
 print @nxtholiday  
 IF EXISTS (SELECT [DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@nxtholiday)  
 begin  
    
  print 'nnn'  
  truncate table #tbl_PO_Credit_DateTime  
  insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
  AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @nxtholiday) and Sett_Type='M')  
    
  select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,credittime='' from #tbl_PO_Credit_DateTime   
    
  return  
 end  
 else  
 begin   
   truncate table #tbl_PO_Credit_DateTime  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
  AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @HOLIDAY_DATE) and Sett_Type='M')  
  select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,credittime='' from #tbl_PO_Credit_DateTime   
 return  
 end  
  
END  
  
IF OBJECT_ID('#FINAL', 'U') IS NOT NULL   
DROP TABLE #FINAL  
  
CREATE TABLE #FINAL  
(   
ID INT IDENTITY (1,1),  
TIMESLOT TIME  
)  
  
-- MONDAY TO SATURDAY PROCESS  
IF(@CALL_DAY BETWEEN 2 AND 6)or(@CALL_DAY=7 and @CALL_TIME<='12:00')   
BEGIN  
 IF(@CALL_TIME<='17:30')  
 BEGIN  
 print 'neha'  
 print @CALL_TIME  
 IF OBJECT_ID('#AA', 'U') IS NOT NULL   
 DROP TABLE #AA   
 SELECT * INTO #AA FROM FN_SPLIT((SELECT TIMESLOT FROM  TBL_CMS_PO_API_29Aug2023 WHERE DAY_TYPE=@DAY_TYPE),',')  
 INSERT INTO #FINAL  
 SELECT STRINGVALUE FROM #AA  
  
 DECLARE @TOTCTR AS INT = 0,@CTR AS INT = 1,@TIMESLOT VARCHAR(25)    
 SELECT @TOTCTR=MAX(ID) FROM #FINAL     
 PRINT @CALL_TIME   
 WHILE @CTR <= @TOTCTR        
 BEGIN  
  SELECT @TIMESLOT=TIMESLOT FROM #FINAL WHERE ID=@CTR  
     IF(@TIMESLOT>=@CALL_TIME)  
     BEGIN  
    PRINT @TIMESLOT  
    BREAK;  
     END   
     SET @CTR=@CTR+1  
 END  
 declare @timez varchar(2)  
 set @timez=(case when CONVERT(VARCHAR(5),DATEADD(HOUR,2,CAST(@TIMESLOT AS VARCHAR(10))),108) >='12:00' then 'pm' else 'am' end)  
 print @timez+'fg'  
 if( @CALL_TIME>'16:30' and @CALL_TIME<'17:30')  
    begin  
   
  insert into #tbl_PO_Credit_DateTime  
  select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,150,CAST('21:00:00.0000000' AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)  
  
    end  
    else  
    begin  
  if(@TIMESLOT<='09:00:00.0000000')  
  begin  
  print 'checking'  
   insert into #tbl_PO_Credit_DateTime  
  select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,270,CAST(@TIMESLOT AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,   
  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)  
  end  
  else  
  begin  
  print 'checking123'  
    PRINT @TIMESLOT  
  insert into #tbl_PO_Credit_DateTime  
  select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,420,CAST(@TIMESLOT AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,   
  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)  
  end  
 end  
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ convert(varchar(11),convert(varchar,Credit_Time),108)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 return  
   
END  
ELSE IF(@CALL_TIME>='17:30')  
BEGIN   
  
declare @Sat VARCHAR (20)  
set @Sat=@CALL_DATE  
if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@sat)  
 begin  
 print 'hello'  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
  where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
  select convert(varchar(15),cast(Credit_Date as time),100) +', '+ CONVERT(VARCHAR(11),Credit_Time, 106) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
  return  
 end  
 else   
 begin  
 print 'abha'  
 declare @sat_W date=''  
 set @sat_W=cast(CONVERT(VARCHAR(11), convert(datetime,@CALL_DATE)+1, 106)as date)  
 print @sat_W  
 if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@sat_W)  
 begin  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
  where start_date < =convert(date, @sat_W) and Sett_Type='D')   
   
  select convert(varchar(15),cast(Credit_Date as time),100) +', '+ CONVERT(VARCHAR(11),Credit_Time, 106) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
  return  
 end  
 else  
 begin  
   
 --if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@CALL_DATE)  
 --begin  
   
 -- insert into #tbl_PO_Credit_DateTime  
 -- select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'7:00:00'),108)  + ' am'AS CREDITTIME ,    
 -- [CREDITTIMEDATE]=cast(CONVERT(VARCHAR(11), convert(datetime,MIN(Start_date)), 106)as date)/*MIN(Start_date)*//*Commented on 20 may 2022*/ /*MIN(Start_date))-2 commented on 22 Jun 2022*/  
 -- from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
 -- (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
 -- where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
 --    select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+   
 -- Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,  
 -- credittime='' from #tbl_PO_Credit_DateTime   
  
 -- --select convert(varchar(15),cast(Credit_Date as time),100) +','+ CONVERT(VARCHAR(11),Credit_Time, 106)   as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 -- return  
 --    end  
 -- else  
 -- begin  
 -- print 'ghj'  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108)  + ' am'AS CREDITTIME ,    
  [CREDITTIMEDATE]=cast(CONVERT(VARCHAR(11), convert(datetime,MIN(Start_date)), 106)as date)/*MIN(Start_date)*//*Commented on 20 may 2022*/ /*MIN(Start_date))-2 commented on 22 Jun 2022*/  
  from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
  where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
     select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+   
  Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,  
  credittime='' from #tbl_PO_Credit_DateTime   
  
  --select convert(varchar(15),cast(Credit_Date as time),100) +','+ CONVERT(VARCHAR(11),Credit_Time, 106)   as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
  return  
 -- end  
 end  
 end  
END  
ELSE   
BEGIN  
 --SELECT CONVERT(VARCHAR(5),DATEADD(HOUR,2,'07:45:00'),108) AS CREDITTIME,  GETDATE()+1 AS [CREDITTIMEDATE]  
 insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'09:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
    (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ CONVERT(VARCHAR(11),Credit_Time, 106)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 --select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+convert(varchar(2),DATEPART(dd, Credit_Time)) +' '+convert(varchar(3),datename(month,DATEPART(month, Credit_Time)))+' '+ convert(varchar(4),DATEPART(yy, Credit_Time))  as credittimedate ,credittime=''  from #tbl_PO_Credit_DateTime  
 return  
   
 END  
  
END  
-- SATURDAY PROCESS  
IF(@CALL_DAY=7 and @CALL_TIME>'12:00')  
BEGIN  
print 'Abha'  
    insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
 (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 return  
END  
  
IF(@CALL_DAY=1)  
BEGIN  
   insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'09:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
    (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')  
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 return  
END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_FundsWithDrawl_API_04Oct2023
-- --------------------------------------------------
  
  
  
         
-- AUTHOR: ABHA JAISWAL  
-- CREATE DATE: 18/02/2020  
-- DESCRIPTION: SEND DATE AND TIME ON FUND WITHDRAWAL API  
-- =============================================  
create PROCEDURE [dbo].[SP_FundsWithDrawl_API_04Oct2023]  
AS  
BEGIN  
  
--select credittimedate ='9:30AM,06 Sep 2022', credittime=''  
  
--End  
 ---return   
--return 0  
  
DECLARE @CALL_DAY VARCHAR(1) ,@CALL_TIME TIME,@SPLIT_TIME VARCHAR(25),@CALL_DATE VARCHAR (20),@DAY_TYPE varchar(30)  
SET @CALL_DAY=DATEPART(DW,GETDATE())  
SET @CALL_TIME =CONVERT(VARCHAR(5),GETDATE(),108)    
SET @CALL_DATE=CONVERT(VARCHAR(10), CONVERT(date, GETDATE(), 105), 23)  
  
print @CALL_DAY  
print @CALL_TIME  
print @CALL_DATE  
  
if @CALL_DAY=7  
set @DAY_TYPE='Saturdays'  
else  
set @DAY_TYPE='WEEKDAYS'  
IF OBJECT_ID('#tbl_PO_Credit_DateTime', 'U') IS NOT NULL   
DROP TABLE #tbl_PO_Credit_DateTime  
create table #tbl_PO_Credit_DateTime  
(  
Credit_Date varchar(11),  
Credit_Time varchar(30),  
)  
   
IF EXISTS (SELECT [DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@CALL_DATE)  
BEGIN  
DECLARE @HOLIDAY_DATE VARCHAR(20) ,@nxtholiday date  
SELECT @HOLIDAY_DATE =[DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@CALL_DATE  
print 'hi'  
--print @HOLIDAY_DATE  
insert into #tbl_PO_Credit_DateTime  
select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < convert(date, @HOLIDAY_DATE) and Sett_Type='M')  
  
 select @nxtholiday=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @HOLIDAY_DATE) and Sett_Type='M')  
 print 'df'  
 print @nxtholiday  
 IF EXISTS (SELECT [DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@nxtholiday)  
 begin  
    
  print 'nnn'  
  truncate table #tbl_PO_Credit_DateTime  
  insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
  AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @nxtholiday) and Sett_Type='M')  
    
  select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,credittime='' from #tbl_PO_Credit_DateTime   
    
  return  
 end  
 else  
 begin   
   truncate table #tbl_PO_Credit_DateTime  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
  AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @HOLIDAY_DATE) and Sett_Type='M')  
  select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,credittime='' from #tbl_PO_Credit_DateTime   
 return  
 end  
  
END  
  
IF OBJECT_ID('#FINAL', 'U') IS NOT NULL   
DROP TABLE #FINAL  
  
CREATE TABLE #FINAL  
(   
ID INT IDENTITY (1,1),  
TIMESLOT TIME  
)  
  
-- MONDAY TO SATURDAY PROCESS  
IF(@CALL_DAY BETWEEN 2 AND 6)or(@CALL_DAY=7 and @CALL_TIME<='12:00')   
BEGIN  
 IF(@CALL_TIME<='17:30')  
 BEGIN  
 print 'neha'  
 print @CALL_TIME  
 IF OBJECT_ID('#AA', 'U') IS NOT NULL   
 DROP TABLE #AA   
 SELECT * INTO #AA FROM FN_SPLIT((SELECT TIMESLOT FROM  TBL_CMS_PO_API WHERE DAY_TYPE=@DAY_TYPE),',')  
 INSERT INTO #FINAL  
 SELECT STRINGVALUE FROM #AA  
  
 DECLARE @TOTCTR AS INT = 0,@CTR AS INT = 1,@TIMESLOT VARCHAR(25)    
 SELECT @TOTCTR=MAX(ID) FROM #FINAL     
 PRINT @CALL_TIME   
 WHILE @CTR <= @TOTCTR          
 BEGIN  
  SELECT @TIMESLOT=TIMESLOT FROM #FINAL WHERE ID=@CTR  
     IF(@TIMESLOT>=@CALL_TIME)  
     BEGIN  
    PRINT @TIMESLOT  
    BREAK;  
     END   
     SET @CTR=@CTR+1  
 END  
 declare @timez varchar(2)  
 set @timez=(case when CONVERT(VARCHAR(5),DATEADD(HOUR,2,CAST(@TIMESLOT AS VARCHAR(10))),108) >='12:00' then 'pm' else 'am' end)  
  
 if( @CALL_TIME>'16:30' and @CALL_TIME<'17:30')  
    begin  
   
  insert into #tbl_PO_Credit_DateTime  
  select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,150,CAST('21:00:00.0000000' AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)  
  
    end  
    else  
    begin  
  if(@TIMESLOT<='09:00:00.0000000')  
  begin  
  print 'bvbn'  
  print @TIMESLOT  
   insert into #tbl_PO_Credit_DateTime  
  select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,150,CAST(@TIMESLOT AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,   
  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)  
  end  
  else  
  begin  
  insert into #tbl_PO_Credit_DateTime  
  select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,300,CAST(@TIMESLOT AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,   
  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)  
  end  
 end  
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ convert(varchar(11),convert(varchar,Credit_Time),108)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 return  
   
END  
ELSE IF(@CALL_TIME>='17:30')  
BEGIN   
  
declare @Sat VARCHAR (20)  
set @Sat=@CALL_DATE  
if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@sat)  
 begin  
 print 'hello'  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
  where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
  select convert(varchar(15),cast(Credit_Date as time),100) +', '+ CONVERT(VARCHAR(11),Credit_Time, 106) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
  return  
 end  
 else   
 begin  
 print 'abha'  
 declare @sat_W date=''  
 set @sat_W=cast(CONVERT(VARCHAR(11), convert(datetime,@CALL_DATE)+1, 106)as date)  
 print @sat_W  
 if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@sat_W)  
 begin  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
  where start_date < =convert(date, @sat_W) and Sett_Type='D')   
   
  select convert(varchar(15),cast(Credit_Date as time),100) +', '+ CONVERT(VARCHAR(11),Credit_Time, 106) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
  return  
 end  
 else  
 begin  
   
 --if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@CALL_DATE)  
 --begin  
   
 -- insert into #tbl_PO_Credit_DateTime  
 -- select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'7:00:00'),108)  + ' am'AS CREDITTIME ,    
 -- [CREDITTIMEDATE]=cast(CONVERT(VARCHAR(11), convert(datetime,MIN(Start_date)), 106)as date)/*MIN(Start_date)*//*Commented on 20 may 2022*/ /*MIN(Start_date))-2 commented on 22 Jun 2022*/  
 -- from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
 -- (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
 -- where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
 --    select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+   
 -- Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,  
 -- credittime='' from #tbl_PO_Credit_DateTime   
  
 -- --select convert(varchar(15),cast(Credit_Date as time),100) +','+ CONVERT(VARCHAR(11),Credit_Time, 106)   as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 -- return  
 --    end  
 -- else  
 -- begin  
 -- print 'ghj'  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108)  + ' am'AS CREDITTIME ,    
  [CREDITTIMEDATE]=cast(CONVERT(VARCHAR(11), convert(datetime,MIN(Start_date)), 106)as date)/*MIN(Start_date)*//*Commented on 20 may 2022*/ /*MIN(Start_date))-2 commented on 22 Jun 2022*/  
  from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
  where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
     select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+   
  Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,  
  credittime='' from #tbl_PO_Credit_DateTime   
  
  --select convert(varchar(15),cast(Credit_Date as time),100) +','+ CONVERT(VARCHAR(11),Credit_Time, 106)   as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
  return  
 -- end  
 end  
 end  
END  
ELSE   
BEGIN  
 --SELECT CONVERT(VARCHAR(5),DATEADD(HOUR,2,'07:45:00'),108) AS CREDITTIME,  GETDATE()+1 AS [CREDITTIMEDATE]  
 insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'09:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
    (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ CONVERT(VARCHAR(11),Credit_Time, 106)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 --select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+convert(varchar(2),DATEPART(dd, Credit_Time)) +' '+convert(varchar(3),datename(month,DATEPART(month, Credit_Time)))+' '+ convert(varchar(4),DATEPART(yy, Credit_Time))  as credittimedate  ,credittime=''  from #tbl_PO_Credit_DateTime  
 return  
   
 END  
  
END  
-- SATURDAY PROCESS  
IF(@CALL_DAY=7 and @CALL_TIME>'12:00')  
BEGIN  
print 'Abha'  
    insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
 (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 return  
END  
  
IF(@CALL_DAY=1)  
BEGIN  
   insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'09:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
    (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')  
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 return  
END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_FundsWithDrawl_API_09May2025
-- --------------------------------------------------



       
-- AUTHOR:	ABHA JAISWAL
-- CREATE DATE: 18/02/2020
-- DESCRIPTION:	SEND DATE AND TIME ON FUND WITHDRAWAL API
-- =============================================
create PROCEDURE [dbo].[SP_FundsWithDrawl_API_09May2025]
AS
BEGIN

--select credittimedate ='23:30PM,12 Feb 2024',	credittime=''

--End
	--return 
--return 0

DECLARE @CALL_DAY VARCHAR(1) ,@CALL_TIME TIME,@SPLIT_TIME VARCHAR(25),@CALL_DATE VARCHAR (20),@DAY_TYPE varchar(30)
SET @CALL_DAY=DATEPART(DW,GETDATE())
SET @CALL_TIME =CONVERT(VARCHAR(5),GETDATE(),108) 	
SET @CALL_DATE=CONVERT(VARCHAR(10), CONVERT(date, GETDATE(), 105), 23)

print @CALL_DAY
print @CALL_TIME
print @CALL_DATE

if @CALL_DAY=7
set @DAY_TYPE='Saturdays'
else
set @DAY_TYPE='WEEKDAYS'
IF OBJECT_ID('#tbl_PO_Credit_DateTime', 'U') IS NOT NULL 
DROP TABLE #tbl_PO_Credit_DateTime
create table #tbl_PO_Credit_DateTime
(
Credit_Date varchar(11),
Credit_Time varchar(30),
)
 
IF EXISTS (SELECT [DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@CALL_DATE)
BEGIN
DECLARE @HOLIDAY_DATE VARCHAR(20) ,@nxtholiday date
SELECT @HOLIDAY_DATE =[DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@CALL_DATE
print 'hi'
--print @HOLIDAY_DATE
insert into #tbl_PO_Credit_DateTime
select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm' 
 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < convert(date, @HOLIDAY_DATE) and Sett_Type='M')

 select @nxtholiday=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm' 
 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @HOLIDAY_DATE) and Sett_Type='M')
 print 'df'
 print @nxtholiday
 IF EXISTS (SELECT [DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@nxtholiday)
 begin
  
  print 'nnn'
	 truncate table #tbl_PO_Credit_DateTime
	 insert into #tbl_PO_Credit_DateTime
	select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm' 
	 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @nxtholiday) and Sett_Type='M')
	 
	 select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,credittime='' from #tbl_PO_Credit_DateTime 
		
		return
 end
 else
 begin 
	  truncate table #tbl_PO_Credit_DateTime
	 insert into #tbl_PO_Credit_DateTime
	 select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm' 
	 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @HOLIDAY_DATE) and Sett_Type='M')
	 select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,credittime='' from #tbl_PO_Credit_DateTime 
	return
 end

END

IF OBJECT_ID('#FINAL', 'U') IS NOT NULL 
DROP TABLE #FINAL

CREATE TABLE #FINAL
( 
ID INT IDENTITY (1,1),
TIMESLOT TIME
)

-- MONDAY TO SATURDAY PROCESS
IF(@CALL_DAY BETWEEN 2 AND 6)or(@CALL_DAY=7 and @CALL_TIME<='12:00') 
BEGIN
	IF(@CALL_TIME<='17:30')
	BEGIN
	print 'neha'
	print @CALL_TIME
	IF OBJECT_ID('#AA', 'U') IS NOT NULL 
	DROP TABLE #AA	
	SELECT * INTO #AA FROM FN_SPLIT((SELECT TIMESLOT FROM  TBL_CMS_PO_API WHERE DAY_TYPE=@DAY_TYPE),',')
	INSERT INTO #FINAL
	SELECT STRINGVALUE FROM #AA

	DECLARE @TOTCTR AS INT = 0,@CTR AS INT = 1,@TIMESLOT VARCHAR(25)  
	SELECT @TOTCTR=MAX(ID) FROM #FINAL   
	PRINT @CALL_TIME 
	WHILE @CTR <= @TOTCTR        
	BEGIN
		SELECT @TIMESLOT=TIMESLOT FROM #FINAL WHERE ID=@CTR
		   IF(@TIMESLOT>=@CALL_TIME)
		   BEGIN
				PRINT @TIMESLOT
				BREAK;
		   END 
		   SET @CTR=@CTR+1
	END
	declare @timez varchar(2)
	set @timez=(case when CONVERT(VARCHAR(5),DATEADD(HOUR,2,CAST(@TIMESLOT AS VARCHAR(10))),108) >='12:00' then 'pm' else 'am' end)
	PRINT @TIMESLOT
	print 'bn'
	print @CALL_TIME
 if( @CALL_TIME>'16:30' and @CALL_TIME<'17:30')
    begin
	print 'qz1'
		insert into #tbl_PO_Credit_DateTime
		select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,150,CAST('21:00:00.0000000' AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)

    end
    else
    begin
		if(@TIMESLOT<='07:00:00.0000000')
		begin
		
		print @TIMESLOT
			insert into #tbl_PO_Credit_DateTime
		select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,270,CAST(@TIMESLOT AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) , 
		[CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)
		end
		else
		begin
		insert into #tbl_PO_Credit_DateTime
		select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,420,CAST(@TIMESLOT AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) , 
		[CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)
		print 'check'
		print @TIMESLOT
		print @timez
		print @CALL_DATE
		end
	end
	select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ convert(varchar(11),convert(varchar,Credit_Time),108)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
	return
	print 'gbnm'
	
END
ELSE IF(@CALL_TIME>='17:30')
BEGIN 

declare @Sat VARCHAR (20)
set @Sat=@CALL_DATE
if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@sat)
	begin
	print 'hello'
		insert into #tbl_PO_Credit_DateTime
		select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
		(select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst 
		where start_date < =convert(date, @CALL_DATE) and Sett_Type='D') 
	
		select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ CONVERT(VARCHAR(11),Credit_Time, 106) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
		return
	end
	else 
	begin
	print 'abha'
	declare @sat_W date=''
	set @sat_W=cast(CONVERT(VARCHAR(11), convert(datetime,@CALL_DATE)+1, 106)as date)
	print @sat_W
	if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@sat_W)
	begin
		insert into #tbl_PO_Credit_DateTime
		select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
		(select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst 
		where start_date < =convert(date, @sat_W) and Sett_Type='D') 
	
		select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ CONVERT(VARCHAR(11),Credit_Time, 106) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
		return
	end
	else
	begin
	
	--if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@CALL_DATE)
	--begin
	
	--	insert into #tbl_PO_Credit_DateTime
	--	select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'7:00:00'),108)  + ' am'AS CREDITTIME ,  
	--	[CREDITTIMEDATE]=cast(CONVERT(VARCHAR(11), convert(datetime,MIN(Start_date)), 106)as date)/*MIN(Start_date)*//*Commented on 20 may 2022*/ /*MIN(Start_date))-2 commented on 22 Jun 2022*/
	--	from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
	--	(select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst 
	--	where start_date < =convert(date, @CALL_DATE) and Sett_Type='D') 
	
	--    select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ 
	--	Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,
	--	credittime='' from #tbl_PO_Credit_DateTime 

	--	--select convert(varchar(15),cast(Credit_Date as time),100)	+','+ CONVERT(VARCHAR(11),Credit_Time, 106)   as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
	--	return
 --    end
	-- else
	-- begin
	-- print 'ghj'
		insert into #tbl_PO_Credit_DateTime
		select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108)  + ' am'AS CREDITTIME ,  
		[CREDITTIMEDATE]=cast(CONVERT(VARCHAR(11), convert(datetime,MIN(Start_date)), 106)as date)/*MIN(Start_date)*//*Commented on 20 may 2022*/ /*MIN(Start_date))-2 commented on 22 Jun 2022*/
		from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
		(select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst 
		where start_date < =convert(date, @CALL_DATE) and Sett_Type='D') 
	
	    select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ 
		Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,
		credittime='' from #tbl_PO_Credit_DateTime 

		--select convert(varchar(15),cast(Credit_Date as time),100)	+','+ CONVERT(VARCHAR(11),Credit_Time, 106)   as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
		return
	-- end
	end
	end
END
ELSE 
BEGIN
	--SELECT CONVERT(VARCHAR(5),DATEADD(HOUR,2,'07:45:00'),108) AS CREDITTIME,  GETDATE()+1 AS [CREDITTIMEDATE]
	insert into #tbl_PO_Credit_DateTime
	select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'09:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
    (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D') 
	select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ CONVERT(VARCHAR(11),Credit_Time, 106)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
	--select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+convert(varchar(2),DATEPART(dd, Credit_Time)) +' '+convert(varchar(3),datename(month,DATEPART(month, Credit_Time)))+' '+ convert(varchar(4),DATEPART(yy, Credit_Time))  as credittimedate  ,credittime=''  from #tbl_PO_Credit_DateTime
	return
	
	END

END
-- SATURDAY PROCESS
IF(@CALL_DAY=7 and @CALL_TIME>'12:00')
BEGIN
print 'Abha'
    insert into #tbl_PO_Credit_DateTime
	select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
	(select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D') 
	
	select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
	return
END

IF(@CALL_DAY=1)
BEGIN
   insert into #tbl_PO_Credit_DateTime
	select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'09:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
    (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where 
	start_date < =convert(date, @CALL_DATE) and Sett_Type='D')  and start_date <>'2024-02-19'
	select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
	return
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_FundsWithDrawl_API_10Nov2023
-- --------------------------------------------------



       
-- AUTHOR:	ABHA JAISWAL
-- CREATE DATE: 18/02/2020
-- DESCRIPTION:	SEND DATE AND TIME ON FUND WITHDRAWAL API
-- =============================================
create PROCEDURE [dbo].[SP_FundsWithDrawl_API_10Nov2023]
AS
BEGIN

--select credittimedate ='9:30AM,06 Sep 2022',	credittime=''

--End
	---return 
--return 0

DECLARE @CALL_DAY VARCHAR(1) ,@CALL_TIME TIME,@SPLIT_TIME VARCHAR(25),@CALL_DATE VARCHAR (20),@DAY_TYPE varchar(30)
SET @CALL_DAY=DATEPART(DW,GETDATE())
SET @CALL_TIME =CONVERT(VARCHAR(5),GETDATE(),108) 	
SET @CALL_DATE=CONVERT(VARCHAR(10), CONVERT(date, GETDATE(), 105), 23)

print @CALL_DAY
print @CALL_TIME
print @CALL_DATE

if @CALL_DAY=7
set @DAY_TYPE='Saturdays'
else
set @DAY_TYPE='WEEKDAYS'
IF OBJECT_ID('#tbl_PO_Credit_DateTime', 'U') IS NOT NULL 
DROP TABLE #tbl_PO_Credit_DateTime
create table #tbl_PO_Credit_DateTime
(
Credit_Date varchar(11),
Credit_Time varchar(30),
)
 
IF EXISTS (SELECT [DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@CALL_DATE)
BEGIN
DECLARE @HOLIDAY_DATE VARCHAR(20) ,@nxtholiday date
SELECT @HOLIDAY_DATE =[DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@CALL_DATE
print 'hi'
--print @HOLIDAY_DATE
insert into #tbl_PO_Credit_DateTime
select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm' 
 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < convert(date, @HOLIDAY_DATE) and Sett_Type='M')

 select @nxtholiday=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm' 
 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @HOLIDAY_DATE) and Sett_Type='M')
 print 'df'
 print @nxtholiday
 IF EXISTS (SELECT [DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@nxtholiday)
 begin
  
  print 'nnn'
	 truncate table #tbl_PO_Credit_DateTime
	 insert into #tbl_PO_Credit_DateTime
	select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm' 
	 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @nxtholiday) and Sett_Type='M')
	 
	 select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,credittime='' from #tbl_PO_Credit_DateTime 
		
		return
 end
 else
 begin 
	  truncate table #tbl_PO_Credit_DateTime
	 insert into #tbl_PO_Credit_DateTime
	 select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'9:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm' 
	 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @HOLIDAY_DATE) and Sett_Type='M')
	 select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,credittime='' from #tbl_PO_Credit_DateTime 
	return
 end

END

IF OBJECT_ID('#FINAL', 'U') IS NOT NULL 
DROP TABLE #FINAL

CREATE TABLE #FINAL
( 
ID INT IDENTITY (1,1),
TIMESLOT TIME
)

-- MONDAY TO SATURDAY PROCESS
IF(@CALL_DAY BETWEEN 2 AND 6)or(@CALL_DAY=7 and @CALL_TIME<='12:00') 
BEGIN
	IF(@CALL_TIME<='17:30')
	BEGIN
	print 'neha'
	print @CALL_TIME
	IF OBJECT_ID('#AA', 'U') IS NOT NULL 
	DROP TABLE #AA	
	SELECT * INTO #AA FROM FN_SPLIT((SELECT TIMESLOT FROM  TBL_CMS_PO_API_29Aug2023 WHERE DAY_TYPE=@DAY_TYPE),',')
	INSERT INTO #FINAL
	SELECT STRINGVALUE FROM #AA

	DECLARE @TOTCTR AS INT = 0,@CTR AS INT = 1,@TIMESLOT VARCHAR(25)  
	SELECT @TOTCTR=MAX(ID) FROM #FINAL   
	PRINT @CALL_TIME 
	WHILE @CTR <= @TOTCTR        
	BEGIN
		SELECT @TIMESLOT=TIMESLOT FROM #FINAL WHERE ID=@CTR
		   IF(@TIMESLOT>=@CALL_TIME)
		   BEGIN
				PRINT @TIMESLOT
				BREAK;
		   END 
		   SET @CTR=@CTR+1
	END
	declare @timez varchar(2)
	set @timez=(case when CONVERT(VARCHAR(5),DATEADD(HOUR,2,CAST(@TIMESLOT AS VARCHAR(10))),108) >='12:00' then 'pm' else 'am' end)

 if( @CALL_TIME>'16:30' and @CALL_TIME<'17:30')
    begin
	
		insert into #tbl_PO_Credit_DateTime
		select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,150,CAST('21:00:00.0000000' AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)

    end
    else
    begin
		if(@TIMESLOT<='07:00:00.0000000')
		begin
		print 'bvbn'
		print @TIMESLOT
			insert into #tbl_PO_Credit_DateTime
		select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,270,CAST(@TIMESLOT AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) , 
		[CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)
		end
		else
		begin
		insert into #tbl_PO_Credit_DateTime
		select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,420,CAST(@TIMESLOT AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) , 
		[CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)
		end
	end
	select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ convert(varchar(11),convert(varchar,Credit_Time),108)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
	return
	
END
ELSE IF(@CALL_TIME>='17:30')
BEGIN 

declare @Sat VARCHAR (20)
set @Sat=@CALL_DATE
if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@sat)
	begin
	print 'hello'
		insert into #tbl_PO_Credit_DateTime
		select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
		(select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst 
		where start_date < =convert(date, @CALL_DATE) and Sett_Type='D') 
	
		select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ CONVERT(VARCHAR(11),Credit_Time, 106) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
		return
	end
	else 
	begin
	print 'abha'
	declare @sat_W date=''
	set @sat_W=cast(CONVERT(VARCHAR(11), convert(datetime,@CALL_DATE)+1, 106)as date)
	print @sat_W
	if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@sat_W)
	begin
		insert into #tbl_PO_Credit_DateTime
		select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
		(select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst 
		where start_date < =convert(date, @sat_W) and Sett_Type='D') 
	
		select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ CONVERT(VARCHAR(11),Credit_Time, 106) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
		return
	end
	else
	begin
	
	--if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@CALL_DATE)
	--begin
	
	--	insert into #tbl_PO_Credit_DateTime
	--	select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'7:00:00'),108)  + ' am'AS CREDITTIME ,  
	--	[CREDITTIMEDATE]=cast(CONVERT(VARCHAR(11), convert(datetime,MIN(Start_date)), 106)as date)/*MIN(Start_date)*//*Commented on 20 may 2022*/ /*MIN(Start_date))-2 commented on 22 Jun 2022*/
	--	from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
	--	(select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst 
	--	where start_date < =convert(date, @CALL_DATE) and Sett_Type='D') 
	
	--    select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ 
	--	Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,
	--	credittime='' from #tbl_PO_Credit_DateTime 

	--	--select convert(varchar(15),cast(Credit_Date as time),100)	+','+ CONVERT(VARCHAR(11),Credit_Time, 106)   as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
	--	return
 --    end
	-- else
	-- begin
	-- print 'ghj'
		insert into #tbl_PO_Credit_DateTime
		select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108)  + ' am'AS CREDITTIME ,  
		[CREDITTIMEDATE]=cast(CONVERT(VARCHAR(11), convert(datetime,MIN(Start_date)), 106)as date)/*MIN(Start_date)*//*Commented on 20 may 2022*/ /*MIN(Start_date))-2 commented on 22 Jun 2022*/
		from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
		(select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst 
		where start_date < =convert(date, @CALL_DATE) and Sett_Type='D') 
	
	    select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ 
		Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,
		credittime='' from #tbl_PO_Credit_DateTime 

		--select convert(varchar(15),cast(Credit_Date as time),100)	+','+ CONVERT(VARCHAR(11),Credit_Time, 106)   as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
		return
	-- end
	end
	end
END
ELSE 
BEGIN
	--SELECT CONVERT(VARCHAR(5),DATEADD(HOUR,2,'07:45:00'),108) AS CREDITTIME,  GETDATE()+1 AS [CREDITTIMEDATE]
	insert into #tbl_PO_Credit_DateTime
	select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'09:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
    (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D') 
	select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ CONVERT(VARCHAR(11),Credit_Time, 106)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
	--select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+convert(varchar(2),DATEPART(dd, Credit_Time)) +' '+convert(varchar(3),datename(month,DATEPART(month, Credit_Time)))+' '+ convert(varchar(4),DATEPART(yy, Credit_Time))  as credittimedate  ,credittime=''  from #tbl_PO_Credit_DateTime
	return
	
	END

END
-- SATURDAY PROCESS
IF(@CALL_DAY=7 and @CALL_TIME>'12:00')
BEGIN
print 'Abha'
    insert into #tbl_PO_Credit_DateTime
	select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'9:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
	(select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D') 
	
	select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
	return
END

IF(@CALL_DAY=1)
BEGIN
   insert into #tbl_PO_Credit_DateTime
	select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'09:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                 
    (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')
	select convert(varchar(15),cast(Credit_Date as time),100)	+', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime
	return
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_FundsWithDrawl_API_29Aug2023
-- --------------------------------------------------
-- DESCRIPTION: SEND DATE AND TIME ON FUND WITHDRAWAL API  
-- =============================================  
CREATE PROCEDURE [dbo].[SP_FundsWithDrawl_API_29Aug2023]  
AS  
BEGIN  
  
--select credittimedate ='9:30AM,06 Sep 2022', credittime=''  
  
--End  
 ---return   
--return 0  
  
DECLARE @CALL_DAY VARCHAR(1) ,@CALL_TIME TIME,@SPLIT_TIME VARCHAR(25),@CALL_DATE VARCHAR (20),@DAY_TYPE varchar(30)  
SET @CALL_DAY=DATEPART(DW,GETDATE())  
SET @CALL_TIME =CONVERT(VARCHAR(5),'06:25',108)    
SET @CALL_DATE=CONVERT(VARCHAR(10), CONVERT(date, GETDATE(), 105), 23)  
  
print @CALL_DAY  
print @CALL_TIME  
print @CALL_DATE  
  
if @CALL_DAY=7  
set @DAY_TYPE='Saturdays'  
else  
set @DAY_TYPE='WEEKDAYS'  
IF OBJECT_ID('#tbl_PO_Credit_DateTime', 'U') IS NOT NULL   
DROP TABLE #tbl_PO_Credit_DateTime  
create table #tbl_PO_Credit_DateTime  
(  
Credit_Date varchar(11),  
Credit_Time varchar(30),  
)  
   
IF EXISTS (SELECT [DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@CALL_DATE)  
BEGIN  
DECLARE @HOLIDAY_DATE VARCHAR(20) ,@nxtholiday date  
SELECT @HOLIDAY_DATE =[DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@CALL_DATE  
print 'hi'  
--print @HOLIDAY_DATE  
insert into #tbl_PO_Credit_DateTime  
select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'7:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < convert(date, @HOLIDAY_DATE) and Sett_Type='M')  
  
 select @nxtholiday=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
 AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @HOLIDAY_DATE) and Sett_Type='M')  
 print 'df'  
 print @nxtholiday  
 IF EXISTS (SELECT [DATE] FROM TBL_HOLIDAY_MASTER WHERE [DATE]=@nxtholiday)  
 begin  
    
  print 'nnn'  
  truncate table #tbl_PO_Credit_DateTime  
  insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'7:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
  AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @nxtholiday) and Sett_Type='M')  
    
  select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,credittime='' from #tbl_PO_Credit_DateTime   
    
  return  
 end  
 else  
 begin   
   truncate table #tbl_PO_Credit_DateTime  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(HOUR,2,'7:30:00'),108) + ' am'  ,  [CREDITTIMEDATE]=MIN(Start_date)  FROM [CSOKYC-6].General.dbo.BO_Sett_Mst WHERE Sett_Type='M' AND CO_CODE='nsecm'   
  AND start_date >  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date <= convert(date, @HOLIDAY_DATE) and Sett_Type='M')  
  select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,credittime='' from #tbl_PO_Credit_DateTime   
 return  
 end  
  
END  
  
IF OBJECT_ID('#FINAL', 'U') IS NOT NULL   
DROP TABLE #FINAL  
  
CREATE TABLE #FINAL  
(   
ID INT IDENTITY (1,1),  
TIMESLOT TIME  
)  
  
-- MONDAY TO SATURDAY PROCESS  
IF(@CALL_DAY BETWEEN 2 AND 6)or(@CALL_DAY=7 and @CALL_TIME<='12:00')   
BEGIN  
 IF(@CALL_TIME<='17:30')  
 BEGIN  
 print 'neha'  
 print @CALL_TIME  
 IF OBJECT_ID('#AA', 'U') IS NOT NULL   
 DROP TABLE #AA   
 SELECT * INTO #AA FROM FN_SPLIT((SELECT TIMESLOT FROM  TBL_CMS_PO_API_29Aug2023 WHERE DAY_TYPE=@DAY_TYPE),',')  
 INSERT INTO #FINAL  
 SELECT STRINGVALUE FROM #AA  
  
 DECLARE @TOTCTR AS INT = 0,@CTR AS INT = 1,@TIMESLOT VARCHAR(25)    
 SELECT @TOTCTR=MAX(ID) FROM #FINAL     
 PRINT @CALL_TIME   
 WHILE @CTR <= @TOTCTR          
 BEGIN  
  SELECT @TIMESLOT=TIMESLOT FROM #FINAL WHERE ID=@CTR  
     IF(@TIMESLOT>=@CALL_TIME)  
     BEGIN  
    PRINT @TIMESLOT  
    BREAK;  
     END   
     SET @CTR=@CTR+1  
 END  
 declare @timez varchar(2)  
 set @timez=(case when CONVERT(VARCHAR(5),DATEADD(HOUR,2,CAST(@TIMESLOT AS VARCHAR(10))),108) >='12:00' then 'pm' else 'am' end)  
  
 if( @CALL_TIME>'16:30' and @CALL_TIME<'17:30')  
    begin  
 print 'new'  
  insert into #tbl_PO_Credit_DateTime  
  select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,150,CAST('19:00:00.0000000' AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)  
  
    end  
    else  
    begin  
 print 'new1'  
  if(@TIMESLOT<='07:00:00.0000000')  
  begin  
  print 'new23'  
   insert into #tbl_PO_Credit_DateTime  
  select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,270,CAST(@TIMESLOT AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,   
  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)  
  end  
  else  
  begin  
  insert into #tbl_PO_Credit_DateTime  
  select CREDITTIME=CONVERT(VARCHAR(5),DATEADD(MINUTE,420,CAST('16:30:00.0000000' AS VARCHAR(10))),108) +' '+ CONVERT(varchar(2),@timez) ,   
  [CREDITTIMEDATE]= Convert(varchar(11),CONVERT(date,cast(@CALL_DATE as date),106),113)  
  end  
 end  
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ convert(varchar(11),convert(varchar,Credit_Time),108)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 return  
   
END  
ELSE IF(@CALL_TIME>='17:30')  
BEGIN   
  
declare @Sat VARCHAR (20)  
set @Sat=@CALL_DATE  
if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@sat)  
 begin  
 print 'hello'  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'7:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
  where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
  select convert(varchar(15),cast(Credit_Date as time),100) +', '+ CONVERT(VARCHAR(11),Credit_Time, 106) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
  return  
 end  
 else   
 begin  
 print 'abha'  
 declare @sat_W date=''  
 set @sat_W=cast(CONVERT(VARCHAR(11), convert(datetime,@CALL_DATE)+1, 106)as date)  
 print @sat_W  
 if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@sat_W)  
 begin  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'7:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
  where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
  select convert(varchar(15),cast(Credit_Date as time),100) +', '+ CONVERT(VARCHAR(11),Credit_Time, 106) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
  return  
 end  
 else  
 begin  
   
 --if exists(select [date] from TBL_HOLIDAY_MASTER where [date]=@CALL_DATE)  
 --begin  
   
 -- insert into #tbl_PO_Credit_DateTime  
 -- select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'7:00:00'),108)  + ' am'AS CREDITTIME ,    
 -- [CREDITTIMEDATE]=cast(CONVERT(VARCHAR(11), convert(datetime,MIN(Start_date)), 106)as date)/*MIN(Start_date)*//*Commented on 20 may 2022*/ /*MIN(Start_date))-2 commented on 22 Jun 2022*/  
 -- from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
 -- (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
 -- where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
 --    select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+   
 -- Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,  
 -- credittime='' from #tbl_PO_Credit_DateTime   
  
 -- --select convert(varchar(15),cast(Credit_Date as time),100) +','+ CONVERT(VARCHAR(11),Credit_Time, 106)   as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 -- return  
 --    end  
 -- else  
 -- begin  
 -- print 'ghj'  
  insert into #tbl_PO_Credit_DateTime  
  select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'7:00:00'),108)  + ' am'AS CREDITTIME ,    
  [CREDITTIMEDATE]=cast(CONVERT(VARCHAR(11), convert(datetime,MIN(Start_date)), 106)as date)/*MIN(Start_date)*//*Commented on 20 may 2022*/ /*MIN(Start_date))-2 commented on 22 Jun 2022*/  
  from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
  (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst   
  where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
     select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+   
  Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate ,  
  credittime='' from #tbl_PO_Credit_DateTime   
  
  --select convert(varchar(15),cast(Credit_Date as time),100) +','+ CONVERT(VARCHAR(11),Credit_Time, 106)   as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
  return  
 -- end  
 end  
 end  
END  
ELSE   
BEGIN  
 --SELECT CONVERT(VARCHAR(5),DATEADD(HOUR,2,'07:45:00'),108) AS CREDITTIME,  GETDATE()+1 AS [CREDITTIMEDATE]  
 insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'07:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
    (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ CONVERT(VARCHAR(11),Credit_Time, 106)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 --select  convert(varchar(15),cast(Credit_Date as time),100)+ ', '+convert(varchar(2),DATEPART(dd, Credit_Time)) +' '+convert(varchar(3),datename(month,DATEPART(month, Credit_Time)))+' '+ convert(varchar(4),DATEPART(yy, Credit_Time))  as credittimedate  ,credittime=''  from #tbl_PO_Credit_DateTime  
 return  
   
 END  
  
END  
-- SATURDAY PROCESS  
IF(@CALL_DAY=7 and @CALL_TIME>'12:00')  
BEGIN  
print 'Abha'  
    insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'7:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
 (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')   
   
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113)  as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 return  
END  
  
IF(@CALL_DAY=1)  
BEGIN  
   insert into #tbl_PO_Credit_DateTime  
 select CONVERT(VARCHAR(5),DATEADD(MINUTE,150,'07:00:00'),108) + ' am'AS CREDITTIME ,  [CREDITTIMEDATE]=MIN(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where Sett_Type='D' and start_date >                   
    (select MAX(Start_date) from [CSOKYC-6].General.dbo.BO_Sett_Mst where start_date < =convert(date, @CALL_DATE) and Sett_Type='D')  
 select convert(varchar(15),cast(Credit_Date as time),100) +', '+ Convert(varchar(11),CONVERT(date,cast(Credit_Time as date),106),113) as credittimedate,credittime='' from #tbl_PO_Credit_DateTime  
 return  
END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_imps_MFSB
-- --------------------------------------------------
  
 CREATE proc sp_imps_MFSB    
  @mode nvarchar(50),    
   @IFSR nvarchar(50)=null,    
  @AccNo nvarchar(50)=null,    
  @CrtBy nvarchar(50)=null,    
  @ServiceMessage nvarchar(max)=null,    
  @ServiceBeneficaryName nvarchar(max)=null,    
  @ServiceSuccess nvarchar(max)=null    
  as    
  begin    
      
  if @mode='insertUpdate'    
  begin    
      
   if not Exists(select 1 from tbl_imps where AccNo=@AccNo and IFSR=@IFSR )    
   begin    
    if (@ServiceMessage!='All the parameter in request are mandatory')  
    begin   
   insert into tbl_imps(IFSR,AccNo,CrtBy,ServiceMessage,ServiceBeneficaryName,ServiceSuccess,CrtAt)    
   values(@IFSR,@AccNo,@CrtBy,@ServiceMessage,@ServiceBeneficaryName,@ServiceSuccess,GETDATE())     
    end  
   End    
      
  end    
      
  if @mode='Search'    
  begin    
      
 select * from tbl_imps where AccNo=@AccNo and IFSR=@IFSR    
    
  End    
      
  if @mode='All'    
  begin     
     
 select * from tbl_imps    
      
  End    
      
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_OFS_ORDER_Delete
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SP_OFS_ORDER_Delete]                
(@REQUEST_ID as int=0)                
AS                
BEGIN                
--set @REQUEST_ID=177                
                
IF @REQUEST_ID <> 0                
 BEGIN                
  DELETE FROM OFS_ORDER  WHERE  REQUEST_ID=@REQUEST_ID                 
  AND CONVERT(VARCHAR(12),REQUEST_DATE,106) >= CONVERT(VARCHAR(12),GETDATE(),106)                                
  AND REQUEST_ID = convert(int,@REQUEST_ID)                
 END                                
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_OFS_ORDER_INSERT
-- --------------------------------------------------
--207   Coral
--208  acc

--use MISC        
        
CREATE PROC [dbo].[SP_OFS_ORDER_INSERT]        
(
	@CLIENT_CODE as varchar(10),@SCRIPCODE as int,@SEGMENT as varchar(5),
	@QUANTITY int,@BID_RATE as money,@ENTERED_BY  as varchar(10),@CLIENT_TYPE as varchar(5),@Bid_No as varchar(25)=NUll)        
AS        

--if(@SEGMENT='NSE')
--Begin
-- return
--End


If @SCRIPCODE=207 and @SEGMENT='NSE'
begin

		Set @SEGMENT='BSE'

END
--ELSe

--begin

        
declare @MIN_BID_RATE as money,@MinMarginPercent int,@Checkon_NetA_NetL char        
        
select  @MIN_BID_RATE = MinBidRate,@MinMarginPercent= MinMarginPercent,@Checkon_NetA_NetL = Checkon_NetA_NetL from  OFS_Scripmaster         
where Srno= @SCRIPCODE        
        
declare @NL money ,@NA money     
DECLARE @RecCount as int        
        
Create table #t        
(        
NL decimal(20,2),        
NA decimal(20,2)        
)        
        
truncate table #t        
insert into #t(NL,NA)         
exec OFS_Client_NL_NA @CLIENT_CODE        
        
select @NL=NL,@NA =NA from #t      
     
        
if(ISNULL(@Bid_No,'')<>'')      
 BEGIN        
     
 SELECT @RecCount=COUNT(*)FROM OFS_ORDER WHERE CLIENT_CODE=@CLIENT_CODE AND BID_NO=@Bid_No AND      
    REQUEST_DATE >= convert(varchar(11),GETDATE())+' 00:00:00' and REQUEST_DATE <= convert(varchar(11),GETDATE())+' 23:59:59'      
print   @RecCount
print   @Bid_No
print   @CLIENT_CODE
 IF (@RecCount > 1)    
  BEGIN    
  /*When entry already exist then it update first and then inserted the record with gerenation flag 0. */    
   UPDATE OFS_ORDER    
   SET GENERATION_FLAG = -1,    
   BID_NO=BID_NO,    
   REQUEST_DATE=REQUEST_DATE       
   FROM OFS_ORDER WHERE CLIENT_CODE=@CLIENT_CODE AND GENERATION_FLAG=0 AND BID_NO=@Bid_No    
       
   INSERT INTO OFS_ORDER(        
   REQUEST_DATE,CLIENT_CODE,SEGMENT,SCRIPCODE,QUANTITY,BID_RATE,MIN_BID_RATE,CLIENT_TYPE,MinMarginPercent,Checkon_NetA_NetL,NET_AVAILABLE,        
   NET_LEDGER,MARGIN_AVAILABLE,ENTERED_BY,REMARKS,GENERATION_FLAG,GEN_STATUS,BID_NO,[FileName],Batch_No)        
   VALUES(        
   GETDATE(),@CLIENT_CODE,@SEGMENT,@SCRIPCODE,@QUANTITY,@BID_RATE,@MIN_BID_RATE,@CLIENT_TYPE,@MinMarginPercent,@Checkon_NetA_NetL,@NA,@NL,        
   (CASE WHEN @Checkon_NetA_NetL = 'NA' THEN 'V' WHEN @Checkon_NetA_NetL = 'NL' THEN 'W' ELSE '' END),        
   @ENTERED_BY,'',0,'Added',@Bid_No,'',''        
   )      
  END     
 ELSE     
  BEGIN    
   INSERT INTO OFS_ORDER(        
   REQUEST_DATE,CLIENT_CODE,SEGMENT,SCRIPCODE,QUANTITY,BID_RATE,MIN_BID_RATE,CLIENT_TYPE,MinMarginPercent,Checkon_NetA_NetL,NET_AVAILABLE,        
   NET_LEDGER,MARGIN_AVAILABLE,ENTERED_BY,REMARKS,GENERATION_FLAG,GEN_STATUS,BID_NO,[FileName],Batch_No)        
   VALUES(        
   GETDATE(),@CLIENT_CODE,@SEGMENT,@SCRIPCODE,@QUANTITY,@BID_RATE,@MIN_BID_RATE,@CLIENT_TYPE,@MinMarginPercent,@Checkon_NetA_NetL,@NA,@NL,        
   (CASE WHEN @Checkon_NetA_NetL = 'NA' THEN 'V' WHEN @Checkon_NetA_NetL = 'NL' THEN 'W' ELSE '' END),        
   @ENTERED_BY,'',0,'Added',@Bid_No,'',''        
   )    
  END     
 END      
ELSE      
 BEGIN      
 INSERT INTO OFS_ORDER(        
 REQUEST_DATE,CLIENT_CODE,SEGMENT,SCRIPCODE,QUANTITY,BID_RATE,MIN_BID_RATE,CLIENT_TYPE,MinMarginPercent,Checkon_NetA_NetL,NET_AVAILABLE,        
 NET_LEDGER,MARGIN_AVAILABLE,ENTERED_BY,REMARKS,GENERATION_FLAG,GEN_STATUS,BID_NO,[FileName],Batch_No)        
 VALUES(        
 GETDATE(),@CLIENT_CODE,@SEGMENT,@SCRIPCODE,@QUANTITY,@BID_RATE,@MIN_BID_RATE,@CLIENT_TYPE,@MinMarginPercent,@Checkon_NetA_NetL,@NA,@NL,        
 (CASE WHEN @Checkon_NetA_NetL = 'NA' THEN 'V' WHEN @Checkon_NetA_NetL = 'NL' THEN 'W' ELSE '' END),        
 @ENTERED_BY,'',0,'Added','','',''        
 )        
 End    

--END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_OFS_ORDER_Soft_Delete
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SP_OFS_ORDER_Soft_Delete]                      
(@REQUEST_ID as int=0)                      
AS                      
BEGIN                      
--set @REQUEST_ID=177                      
                      
IF @REQUEST_ID <> 0                      
 BEGIN                      
  --Generation flag -3 means Record sent for soft delete..        
  UPDATE OFS_ORDER        
  set GENERATION_FLAG = -5    
    --[FileName]='',Batch_No=''    
  WHERE  REQUEST_ID=@REQUEST_ID                       
  AND CONVERT(VARCHAR(12),REQUEST_DATE,106) >= CONVERT(VARCHAR(12),GETDATE(),106)                                      
  AND REQUEST_ID = convert(int,@REQUEST_ID)                      
    
    
 insert into OFS_ORDER(REQUEST_DATE,CLIENT_CODE,SEGMENT,SCRIPCODE,QUANTITY,BID_RATE,MIN_BID_RATE,CLIENT_TYPE,MinMarginPercent,Checkon_NetA_NetL,NET_AVAILABLE,NET_LEDGER,MARGIN_AVAILABLE,ENTERED_BY,REMARKS,GENERATION_FLAG,GEN_STATUS,BID_NO,FileName,Batch_No)  
 (select REQUEST_DATE,CLIENT_CODE,SEGMENT,SCRIPCODE,QUANTITY,BID_RATE,MIN_BID_RATE,CLIENT_TYPE,MinMarginPercent,Checkon_NetA_NetL,NET_AVAILABLE,NET_LEDGER,MARGIN_AVAILABLE,ENTERED_BY,REMARKS,-3,GEN_STATUS,BID_NO,'','' from OFS_ORDER where REQUEST_ID=@REQUEST_ID)  
    
    
    
 END                                      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_RTGS_AUTO_MFSB
-- --------------------------------------------------
CREATE proc [dbo].[sp_RTGS_AUTO_MFSB]                
          
as                
          
begin                
          
             
          
 BEGIN TRY               
          
DECLARE @MyCursor CURSOR;                
          
DECLARE @MyField nvarchar(100);                
          
BEGIN                
          
declare @count int=0                
          
                
          
    SET @MyCursor = CURSOR FOR                
          
 select distinct sbtag  from [MIS].sb_comp.dbo.sb_broker a with (nolock) where sbtag not in(                
          
select Fld_Sub_Code from TBL_RTGS_SUBBROKER_MFSB with (nolock) where Fld_Sub_Code is not NULL or Fld_Sub_Code!=''               
          
 ) and cast(taggenerateddate as date)>='1 apr 2018' and sbtag!='T A G'  and orgtype in( 'I','CO','P','PF')
 and exists  (Select 1 from [MIS].sb_comp.dbo.sb_bankothers where Refno=a.Refno)
          
                
          
    OPEN @MyCursor                 
          
    FETCH NEXT FROM @MyCursor                 
          
    INTO @MyField                
          
                
          
    WHILE @@FETCH_STATUS = 0                
          
    BEGIN                
          
    set @count=@count+1                
          
      print @MyField                
          
      exec Dustbin.dbo.RTGS_AUTO_UPDATE_MFSB @MyField                
          
      print @count                
          
      FETCH NEXT FROM @MyCursor                 
          
      INTO @MyField                 
          
    END;                 
          
                  
          
  EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL                            
          
  @RECIPIENTS = 'vinod.borhade@angelbroking.com',                          
          
  @PROFILE_NAME = 'angelbroking',                            
          
  @BODY_FORMAT ='HTML',                            
          
  @SUBJECT = 'Success, RTGS Maker Entry Job',                          
          
  @BODY = 'RTGS Maker Entry Run Successfully.'             
          
                
          
    CLOSE @MyCursor ;                
          
    DEALLOCATE @MyCursor;              
          
                  
          
END;                
          
    END TRY            
          
    BEGIN CATCH            
          
                
          
    declare @errMessage nvarchar(1000)=ERROR_MESSAGE()            
          
               
          
            
          
  EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL                            
          
  @RECIPIENTS = 'vinod.borhade@angelbroking.com',                          
          
  @PROFILE_NAME = 'angelbroking',                            
          
  @BODY_FORMAT ='HTML',                            
          
  @SUBJECT = 'Error, Occured on RTGS Maker Entry Job',                          
          
  @BODY = @errMessage               
          
                
          
 END CATCH            
          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_SyncMismatch_clientdetails
-- --------------------------------------------------
 create proc sp_SyncMismatch_clientdetails
 as
 Begin
	select  a.Party_code,b.comb_LAST_DATE into #cli_combDate from  Risk.dbo.client_details a                          
   inner join [CSOKYC-6].general.dbo.client_details b with(nolock) on a.party_code=b.party_code where isnull(a.comb_LAST_DATE,'')!=isnull(b.comb_LAST_DATE,'') 

  if exists (select top 1 Party_code from #cli_combDate)                  
	Begin                   
	 update Risk.dbo.client_details                          
	 set comb_LAST_DATE=b.comb_LAST_DATE ,ModifidedOn=getdate()                         
	 from  Risk.dbo.client_details a                          
	 inner join #cli_combDate b with(nolock) on a.party_code=b.party_code where isnull(a.comb_LAST_DATE,'')!=isnull(b.comb_LAST_DATE,'')                       
	End    
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_buyback_ScripMaster_DropdownList
-- --------------------------------------------------
Create PROCEDURE [dbo].[spx_buyback_ScripMaster_DropdownList]
AS
BEGIN
	SET NOCOUNT ON;
	
	SELECT [Id]
      ,[ScripName]
      --,[IsActive]
      --,[CreationDate]
      --,[FromDate]
      --,[ToDate]
  FROM [dbo].[tbl_buyback_ScripMaster] WITH(NOLOCK)
  WHERE IsActive = 1
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UnPleadge_VeriData_Batchwise
-- --------------------------------------------------


--Select * from UnPleadge_Segveridata

create PROCEDURE [dbo].[UnPleadge_VeriData_Batchwise]                              
as                                                    
                                                    
--Set nocount on                                       
--SET XACT_ABORT ON                                                 
--BEGIN TRY                                                      
                                                 
  /* FETCH DATA */  
  
  begin
                                                    
   Create table #NCMS_SegwiseCldata (                                                        
   id int,                                            
   ProcessDate datetime,                                            
   Entity varchar(10),                                            
   Segment varchar(10),                                            
   Party_code varchar(10),                                            
   Flag char(1),                                            
   Balance money,                                            
   UnsettledCrBill money,                                            
   UnrecoAmt money,                                            
   ShortSellValue money,                                            
   MarginAmt money,                                            
   Deposit money,                                            
   CashColl money,                                            
   NonCashColl money,                                            
   MarginAdjWithColl money,                                            
   MarginShortage money,                                            
   AccruedCharges money,                                            
   OtherDebit money,                                            
   NonCashConsideration money,                                            
   ExpoUtilised money,                                            
   UnPosted_PO money,                 
   NetPayable money                                        
   )                                                                                                           
                                              
                        
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime,'AllSegment','BSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                     
  from AngelBSECM.inhouse.dbo.Unpleadge_PO  with(nolock)                                                 
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                  
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select ProcessDatetime,'AllSegment','NSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                     
  from AngelNseCM.inhouse.dbo.Unpleadge_PO  with(nolock)                                                      
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                  
    
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                
 select ProcessDatetime,'AllSegment','MTF',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                 
 from AngelNseCM.MTFTRADE.dbo.Unpleadge_PO  with(nolock)    
                                                       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','NSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelfo.inhouse.dbo.Unpleadge_marh  with(nolock)                                                      
  /* and PayoutValue <> 0*/                                  
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','NSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelfo.inhouse_curfo.dbo.Unpleadge_marh  with(nolock)             
  /* and PayoutValue <> 0*/                                                  
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','MCD',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelcommodity.INHOUSE_MCDCS.dbo.Unpleadge_marh  with(nolock)                                                      
  /* and PayoutValue <> 0*/                                                    
  
   
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                               
 select UpdDatetime,'AllSegment','BSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                 
 from angelcommodity.inhouse_bsx.dbo.Unpleadge_marh  with(nolock)    
                                                       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','NCDEX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelcommodity.inhouse_NCDX.dbo.Unpleadge_marh   with(nolock)                                                     
/* and PayoutValue <> 0*/                                                   
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','MCX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelcommodity.inhouse_MCDX.dbo.Unpleadge_marh   with(nolock)                                                     
  /* and PayoutValue <> 0*/                                                   
                     
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select ProcessDatetime,'AllSegment','BSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                     
  from angelfo.inhouse.dbo.Unpleadge_po_BSEMFSS  with(nolock)          
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                  
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select ProcessDatetime,'AllSegment','NSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                               
  from angelfo.inhouse.dbo.Unpleadge_po_NSEMFSS with(nolock)                                                       
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                  
                              
  /* NBFC verification not required. verification is based on BOD processed data */                            
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                            
  select                             
  ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                            
  from NCMS_SegwiseCldata with (nolock) where entity='NBFC'    
  
  --Uncomment when BSEFO live
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','BSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelcommodity.BSEFO.dbo.Unpleadge_marh  with(nolock)   
  
  -------NSE Commodity
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','NCE',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelcommodity.Dustbin.dbo.Unpleadge_marh   with(nolock)    
    
    /************************************************************************************************************************************************/   
/************************************************************************************************************************************************/   
    /*Changed in order to consider MTM of cases where there is no ledger added by Neha Naiwar on suggestion from Bhavin Parikh dt: 23th June 2016*/       
      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a  with(nolock)  where BSECM > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSECM' ) and isnull(client_code,'')<>''  
    
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a  with(nolock)  where NSECM > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSECM' ) and isnull(client_code,'')<>''  
     
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSEFO',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a  with(nolock)  where NSEFO > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSEFO' ) and isnull(client_code,'')<>''                         
     
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a with(nolock)   where NSX > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSX' ) and isnull(client_code,'')<>''                                                     
   
   insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCD',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a with(nolock)   where MCD > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCD' ) and isnull(client_code,'')<>''   
   
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a with(nolock)  where BSX > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSX' ) and isnull(client_code,'')<>''   
   
     insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NCDEX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a with(nolock) where NCDEX > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NCDEX' ) and isnull(client_code,'')<>''   
   
      insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a with(nolock) where MCX > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCX' ) and isnull(client_code,'')<>''  
  
/************************************************************************************************************************************************/   
/************************************************************************************************************************************************/   
                                                     
  /* Accrured Charges */                         
                                              
                                                
 select party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                 
 from misc.dbo.Accrued_PenalCharges with (nolock) group by party_code     
 
  /******added new margin peneality charges on 05 Jul 2021***********************************/  
 insert into #Accrued1  
  select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code            
 
 
insert into  #Accrued1
SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)
where cnt_Date=(select max(cnt_Date) from AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))
group by cltcode

insert into  #Accrued1
SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock),AngelNseCM.MSAJAG.DBO.client_details c(Nolock)
where  PCN_Date=(select max(PCN_Date) from AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock))
 and J.cl_code=c.cl_code
group by J.cl_code 
  
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                         
  
 /****************************************/                                                              
                                                 
 update #NCMS_SegwiseCldata set AccruedCharges=-Accured,NetPayable=NetPayable-Accured                                                
 from                                                
 (                                                
  select q.segment,q.party_code,                                                
  (Case when q.entity='AllSegment' then DeductEQ else DeductComm end) as Accured                                                
  from #Accrued p join                                                 
  (                                                
  select x.*,y.segment from                                                
  (                                                
  select a.entity,party_Code,min(b.seqid) as seqid                                                
  from #NCMS_SegwiseCldata a join ncms_entity b on a.segment=b.segment                                                 
  group by a.entity,party_Code                                                
  ) x join ncms_entity y on x.seqid=y.seqid and x.entity=y.entity                                                
  ) q on p.party_Code=q.party_Code                                                 
 ) AC                                                
 where #NCMS_SegwiseCldata.party_code=AC.party_Code and #NCMS_SegwiseCldata.segment=AC.Segment                                                
 and #NCMS_SegwiseCldata.segment <> 'NBFC'                                        
                                                       
              
                    
  /* BSECM & NSECM Zero for NBFC Clients */                                                    
                                
  /*                                                           
  UPDATE a                                                        
  set NetPayable = 0,ShortSellValue=0,Balance=0                                            
  FROM #NCMS_SegwiseCldata a                         
  JOIN                                                        
  (select Party_code from risk.dbo.client_Details where cl_type in ('NBF','TMF')) b                                             
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                     
  */                            
                              
  /*---- Only unreco cheque amount of BSECM and NSECM should get deducted from NBFC Net payable */                            
  UPDATE a                                                        
  set NetPayable =  UnrecoAmt+AccruedCharges                               
  FROM #NCMS_SegwiseCldata a                                             
  JOIN                                                        
  (select Party_code from risk.dbo.client_Details with(nolock) where cl_type in ('NBF','TMF')) b                                      
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                     
           
                  
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                                                    
(select seg+'CM' as seg,party_code,shrtval=SUM(NetShortValue) from ncms_shortsell with(nolock)                 
group by seg,party_Code having sum(NetShortValue) <> 0) b                      
 where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.party_Code                                                    
  
     
 /*update net basis of Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/  
   
  update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.loss ,OtherDebit=OtherDebit-b.loss from                                                
 (select party_code,loss,exchange+'CM' as segment from NCMS_Intraday_loss) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0 and NetPayable>0   
                 
/* Reduce LD Data */                  
 /*          
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.BSECM,NetPayable=NetPayable-b.BSECM                  
 from(                  
 select client_code,BSECM from NCMS_LD_View where BSECM > 0                  
 ) b                   
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSECM'                  
 */          
           
                   
  
 /*For Reducing mf pending orders in Payout*/  
 
DECLARE @Days VARCHAR(20)                        
                        
 SET @Days = (                        
   SELECT DATENAME(dw, GETDATE())                        
   )   
     /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF     
                       
IF (@Days = 'Monday' OR @Days = 'Saturday')                        
BEGIN       
  
 select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund_sat from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)  
 where cltcode   
 in   
 (select clientcode from  risk.dbo.vw_MutualFundPendingOrder_NCMS_sat with(nolock)    where segment in ('MF','Trade' ))  
 and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
 group by cltcode  
  
 /*  
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal   
 from #MFFund m inner join  
 risk.dbo.vw_MutualFundPendingOrder_NCMS o  
 on m.cltcode=o.clientcode  
 where balance<=0  
 group by m.cltcode,m.balance  
 */  
  
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal_sat     
 from   
 risk.dbo.vw_MutualFundPendingOrder_NCMS_sat o  with(nolock)  
 group by clientcode  
  
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)  
 select cltcode,amount,getdate() from #MFFundFinal_sat  
  
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),  
 a.*,b.amount into #segmentwise_pendingorders_sat  
 from  
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')  
 and NetPayable>0)a  
 inner join  (select cltcode,amount from #MFFundFinal_sat) b  
 on a.party_code=b.cltcode;  
  
 with cte  
 as  
 (  
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,  
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,  
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end  
  from #segmentwise_pendingorders_sat where srno=1 --and party_code='AACW016'  
  union all  
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,  
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,  
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end  
  from #segmentwise_pendingorders_sat a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'  
 )  
 select * into #mf_segamountadjust_sat from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)  
  
  
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                     
  (                  
 select * from #mf_segamountadjust_sat  
  ) b                   
  where a.Party_code=b.party_code and a.Segment=b.segment   
  
 drop table #mf_segamountadjust_sat  
 drop table #segmentwise_pendingorders_sat  
 drop table #MFFundFinal_sat  
 drop table #MFFund_sat     
end  
else  
begin  
 select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)  
 where cltcode   
 in   
 (select clientcode from  risk.dbo.vw_MutualFundPendingOrder_NCMS with(nolock)    where segment in ('MF','Trade' ))  
 and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
 group by cltcode  
  
 /*  
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal   
 from #MFFund m inner join  
risk.dbo.vw_MutualFundPendingOrder_NCMS o  
 on m.cltcode=o.clientcode  
 where balance<=0  
 group by m.cltcode,m.balance  
 */  
  
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal     
 from   
 risk.dbo.vw_MutualFundPendingOrder_NCMS o with(nolock)   
 group by clientcode  
  
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)  
 select cltcode,amount,getdate() from #MFFundFinal  
  
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),  
 a.*,b.amount into #segmentwise_pendingorders  
 from  
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')  
 and NetPayable>0)a  
 inner join  (select cltcode,amount from #MFFundFinal) b  
 on a.party_code=b.cltcode;  
  
 with cte  
 as  
 (  
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,  
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,  
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end  
  from #segmentwise_pendingorders where srno=1 --and party_code='AACW016'  
  union all  
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,  
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,  
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end  
  from #segmentwise_pendingorders a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'  
 )  
 select * into #mf_segamountadjust from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)  
  
  
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                     
  (                  
 select * from #mf_segamountadjust  
  ) b                   
  where a.Party_code=b.party_code and a.Segment=b.segment   
   
 drop table #mf_segamountadjust  
 drop table #segmentwise_pendingorders  
 drop table #MFFundFinal  
 drop table #MFFund  
end  
 */ 
   
   
   
 /*************************************************************************************/  
   
 /*For Reducing BSE Orders added on 05 May 2017*/  
            
 IF (@Days = 'Monday')                        
 BEGIN   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                    
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE_sat with(nolock)                 
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                      
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode    
 end   
else  
begin   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                    
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE  with(nolock)                
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                      
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode    
 end  
 /*---------------------------------------------------------*/       
    
 
  /*********Margin added in cash segment as per mail of sajeevn sir on 01Aug 2020****************/  
 --commented as per JIRA ID : ORE2766 

 
DECLARE @MARGINDATE AS DATETIME         
SELECT @MARGINDATE=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.tbl_combine_reporting_detail WITH (NOLOCK)     
--select @MARGINDATE  
/* 
select margindate,exchange,segment,party_code,tday_margin,tday_mtm,tday_margin+tday_mtm as margin INTO #MARGIN from  
 AngelNseCM.msajag.dbo.tbl_combine_reporting_detail with(nolock) where MARGINDATE=@MARGINDATE AND exchange in ('BSE','NSE') and segment='CAPITAL'  
  
  
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.margin,NetPayable=NetPayable-b.margin from                                                
 (select party_code,margin,exchange+'CM' as segment from #MARGIN WITH (NOLOCK) where margin>0) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0    
 */   
    
 /***********************End****************************************/    
  
   
 /***********************for Adding Delivery Margin Added on 14 Jun 2019 By Neha Naiwar ************************************/  
--DECLARE @MARGINDATE AS DATETIME,@sdtcur as datetime           
--SELECT @MARGINDATE=MAX(MARGINDATE) FROM angelfo.NSEFO.dbo.tbl_clientmargin WITH (NOLOCK)     
  
--SELECT * into #delmargin FROM Angelfo.NSEFo.dbo.FOMARGINNEW with(nolock) WHERE  MDATE =@MARGINDATE/*convert(datetime,convert(varchar(8),getdate(),112))*/  
--AND DEL_MARGIN <>0  
  
--  UPDATE a                                                          
--  set MarginAmt =  MarginAmt-DEL_MARGIN                       
--  FROM #NCMS_SegwiseCldata a                                               
--  JOIN                                                          
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                        
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'    
    
--  UPDATE a                                                          
--  set NetPayable =  NetPayable-DEL_MARGIN                       
--  FROM #NCMS_SegwiseCldata a                                               
--  JOIN                                                          
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                        
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'     
/*************************************************************************************/  
    insert into UnPleadge_Segveridata_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                            
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                            
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                            
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                            
 from UnPleadge_Segveridata  with (nolock)                    

             
  truncate table UnPleadge_Segveridata                        
  insert into UnPleadge_Segveridata                                          
  (                                          
  POrequestID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,                                          
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                        
  )                                            
  select   /*ROW_NUMBER() OVER ( ORDER BY party_code,segment) AS refno,*/                          
  convert(varchar(6),getdate(),112)+replace(convert(varchar(8),getdate(),108),':','') AS refno,                          
  ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                          
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                           
  from #NCMS_SegwiseCldata                                             
       
 /*       
 insert into NCMS_SegVeriData_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                    
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                    
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                    
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                    
 from NCMS_SegVeriData with (nolock)            
 */      
                                             
  /* exec NCMS_UPD_ReqVerId @pcode,@refno      */                              
                                          
--End try                     
                                              
--BEGIN CATCH                                                      
                                                  
--  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                            
--  select GETDATE(),'NCMS_VeriData_Batchwise',ERROR_LINE(),ERROR_MESSAGE()                                                            
                              
-- DECLARE @ErrorMessage NVARCHAR(4000);                                                            
-- SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                            
-- RAISERROR (@ErrorMessage , 16, 1);                                  
                                                   
--End catch                                                  
                                                    
--Set nocount off 

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UnPleadge_VeriData_Batchwise_01Aug2024
-- --------------------------------------------------


--Select * from UnPleadge_Segveridata

create PROCEDURE [dbo].[UnPleadge_VeriData_Batchwise_01Aug2024]                              
as                                                    
                                                    
--Set nocount on                                       
--SET XACT_ABORT ON                                                 
--BEGIN TRY                                                      
                                                 
  /* FETCH DATA */  
  
  begin
                                                    
   Create table #NCMS_SegwiseCldata (                                                        
   id int,                                            
   ProcessDate datetime,                                            
   Entity varchar(10),                                            
   Segment varchar(10),                                            
   Party_code varchar(10),                                            
   Flag char(1),                                            
   Balance money,                                            
   UnsettledCrBill money,                                            
   UnrecoAmt money,                                            
   ShortSellValue money,                                            
   MarginAmt money,                                            
   Deposit money,                                            
   CashColl money,                                            
   NonCashColl money,                                            
   MarginAdjWithColl money,                                            
   MarginShortage money,                                            
   AccruedCharges money,                                            
   OtherDebit money,                                            
   NonCashConsideration money,                                            
   ExpoUtilised money,                                            
   UnPosted_PO money,                 
   NetPayable money                                        
   )                                                                                                           
                                              
                        
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime,'AllSegment','BSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                     
  from AngelBSECM.inhouse.dbo.Unpleadge_PO  with(nolock)                                                 
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                  
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select ProcessDatetime,'AllSegment','NSECM',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                     
  from AngelNseCM.inhouse.dbo.Unpleadge_PO  with(nolock)                                                      
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                  
    
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                
 select ProcessDatetime,'AllSegment','MTF',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                 
 from AngelNseCM.MTFTRADE.dbo.Unpleadge_PO  with(nolock)    
                                                       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','NSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelfo.inhouse.dbo.Unpleadge_marh  with(nolock)                                                      
  /* and PayoutValue <> 0*/                                  
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','NSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelfo.inhouse_curfo.dbo.Unpleadge_marh  with(nolock)             
  /* and PayoutValue <> 0*/                                                  
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','MCD',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelcommodity.INHOUSE_MCDCS.dbo.Unpleadge_marh  with(nolock)                                                      
  /* and PayoutValue <> 0*/                                                    
  
   
 insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                
 Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                               
 select UpdDatetime,'AllSegment','BSX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                 
 from angelcommodity.inhouse_bsx.dbo.Unpleadge_marh  with(nolock)    
                                                       
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','NCDEX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelcommodity.inhouse_NCDX.dbo.Unpleadge_marh   with(nolock)                                                     
/* and PayoutValue <> 0*/                                                   
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','MCX',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelcommodity.inhouse_MCDX.dbo.Unpleadge_marh   with(nolock)                                                     
  /* and PayoutValue <> 0*/                                                   
                     
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select ProcessDatetime,'AllSegment','BSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                                                     
  from angelfo.inhouse.dbo.Unpleadge_po_BSEMFSS  with(nolock)          
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                  
                                                      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select ProcessDatetime,'AllSegment','NSEMFSS',cltcode,'I',Vbal,UCV,UnrecoCr,0,0,0,0,0,0,0,0,OtherDr,0,0,VBal+UCV+UnRecoCr+OtherDr                               
  from angelfo.inhouse.dbo.Unpleadge_po_NSEMFSS with(nolock)                                                       
  /* and VBal+UCV+UnRecoCr+OtherDr <> 0 */                                  
                              
  /* NBFC verification not required. verification is based on BOD processed data */                            
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                            
  select                             
  ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable                            
  from NCMS_SegwiseCldata with (nolock) where entity='NBFC'    
  
  --Uncomment when BSEFO live
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','BSEFO',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelcommodity.BSEFO.dbo.Unpleadge_marh  with(nolock)    

                              
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                                    
  select UpdDatetime,'AllSegment','NCE',Clcode,'I',ledgeramount,-received,UnrecoCr,0,imargin,deposit,cash_coll,non_cash,0,shortage,0,OtherDr,NonCashConsideration,0,PayoutValue-received                                                     
  from angelcommodity.INHOUSE_NCE.dbo.Unpleadge_marh   with(nolock)    
    
    /************************************************************************************************************************************************/   
/************************************************************************************************************************************************/   
    /*Changed in order to consider MTM of cases where there is no ledger added by Neha Naiwar on suggestion from Bhavin Parikh dt: 23th June 2016*/       
      
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a  with(nolock)  where BSECM > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSECM' ) and isnull(client_code,'')<>''  
    
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSECM',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a  with(nolock)  where NSECM > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSECM' ) and isnull(client_code,'')<>''  
     
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSEFO',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a  with(nolock)  where NSEFO > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSEFO' ) and isnull(client_code,'')<>''                         
     
  insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a with(nolock)   where NSX > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NSX' ) and isnull(client_code,'')<>''                                                     
   
   insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCD',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a with(nolock)   where MCD > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCD' ) and isnull(client_code,'')<>''   
   
    insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','BSX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a with(nolock)  where BSX > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='BSX' ) and isnull(client_code,'')<>''   
   
     insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','NCDEX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a with(nolock) where NCDEX > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='NCDEX' ) and isnull(client_code,'')<>''   
   
      insert into #NCMS_SegwiseCldata(ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,                                                    
  Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable)                                
  select ProcessDatetime=(select max(ProcessDate) from #NCMS_SegwiseCldata),'AllSegment','MCX',cltcode=client_code,'I',Vbal=0,UCV=0,UnrecoCr=0,0,0,0,0,0,0,0,0,OtherDr=0,0,0,0                                                     
  from NCMS_LD_View a with(nolock) where MCX > 0   and not exists  
 (select * from #NCMS_SegwiseCldata b where a.client_code=b.party_code and segment='MCX' ) and isnull(client_code,'')<>''  
  
/************************************************************************************************************************************************/   
/************************************************************************************************************************************************/   
                                                     
  /* Accrured Charges */                         
                                              
                                                
 select party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                 
 from misc.dbo.Accrued_PenalCharges with (nolock) group by party_code     
 
  /******added new margin peneality charges on 05 Jul 2021***********************************/  
 insert into #Accrued1  
  select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) group by party_code            
 
 
insert into  #Accrued1
SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)
where cnt_Date=(select max(cnt_Date) from AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))
group by cltcode

insert into  #Accrued1
SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock),AngelNseCM.MSAJAG.DBO.client_details c(Nolock)
where  PCN_Date=(select max(PCN_Date) from AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock))
 and J.cl_code=c.cl_code
group by J.cl_code 
  
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                         
  
 /****************************************/                                                              
                                                 
 update #NCMS_SegwiseCldata set AccruedCharges=-Accured,NetPayable=NetPayable-Accured                                                
 from                                                
 (                                                
  select q.segment,q.party_code,                                                
  (Case when q.entity='AllSegment' then DeductEQ else DeductComm end) as Accured                                                
  from #Accrued p join                                                 
  (                                                
  select x.*,y.segment from                                                
  (                                                
  select a.entity,party_Code,min(b.seqid) as seqid                                                
  from #NCMS_SegwiseCldata a join ncms_entity b on a.segment=b.segment                                                 
  group by a.entity,party_Code                                                
  ) x join ncms_entity y on x.seqid=y.seqid and x.entity=y.entity                                                
  ) q on p.party_Code=q.party_Code                                                 
 ) AC                                                
 where #NCMS_SegwiseCldata.party_code=AC.party_Code and #NCMS_SegwiseCldata.segment=AC.Segment                                                
 and #NCMS_SegwiseCldata.segment <> 'NBFC'                                        
                                                       
              
                    
  /* BSECM & NSECM Zero for NBFC Clients */                                                    
                                
  /*                                                           
  UPDATE a                                                        
  set NetPayable = 0,ShortSellValue=0,Balance=0                                            
  FROM #NCMS_SegwiseCldata a                         
  JOIN                                                        
  (select Party_code from risk.dbo.client_Details where cl_type in ('NBF','TMF')) b                                             
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                     
  */                            
                              
  /*---- Only unreco cheque amount of BSECM and NSECM should get deducted from NBFC Net payable */                            
  UPDATE a                                                        
  set NetPayable =  UnrecoAmt+AccruedCharges                               
  FROM #NCMS_SegwiseCldata a                                             
  JOIN                                                        
  (select Party_code from risk.dbo.client_Details with(nolock) where cl_type in ('NBF','TMF')) b                                      
  ON a.party_code=b.party_code and (a.segment = 'BSECM' or a.segment = 'NSECM')                                                     
           
                  
 update #NCMS_SegwiseCldata set ShortSellValue=-b.shrtval,NetPayable=NetPayable-b.shrtval from                                                    
(select seg+'CM' as seg,party_code,shrtval=SUM(NetShortValue) from ncms_shortsell with(nolock)                 
group by seg,party_Code having sum(NetShortValue) <> 0) b                      
 where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.party_Code                                                    
  
     
 /*update net basis of Intradayloss data as per mail of sajeeven sir added by neha naiwar on 17 july 2020*/  
   
  update #NCMS_SegwiseCldata set NetPayable=NetPayable-b.loss ,OtherDebit=OtherDebit-b.loss from                                                
 (select party_code,loss,exchange+'CM' as segment from NCMS_Intraday_loss) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0 and NetPayable>0   
                 
/* Reduce LD Data */                  
 /*          
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.BSECM,NetPayable=NetPayable-b.BSECM                  
 from(                  
 select client_code,BSECM from NCMS_LD_View where BSECM > 0                  
 ) b                   
 where #NCMS_SegwiseCldata.Party_code=b.client_code and #NCMS_SegwiseCldata.Segment='BSECM'                  
 */          
           
                   
  
 /*For Reducing mf pending orders in Payout*/  
 
DECLARE @Days VARCHAR(20)                        
                        
 SET @Days = (                        
   SELECT DATENAME(dw, GETDATE())                        
   )   
     /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF     
                       
IF (@Days = 'Monday' OR @Days = 'Saturday')                        
BEGIN       
  
 select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund_sat from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)  
 where cltcode   
 in   
 (select clientcode from  risk.dbo.vw_MutualFundPendingOrder_NCMS_sat with(nolock)    where segment in ('MF','Trade' ))  
 and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
 group by cltcode  
  
 /*  
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal   
 from #MFFund m inner join  
 risk.dbo.vw_MutualFundPendingOrder_NCMS o  
 on m.cltcode=o.clientcode  
 where balance<=0  
 group by m.cltcode,m.balance  
 */  
  
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal_sat     
 from   
 risk.dbo.vw_MutualFundPendingOrder_NCMS_sat o  with(nolock)  
 group by clientcode  
  
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)  
 select cltcode,amount,getdate() from #MFFundFinal_sat  
  
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),  
 a.*,b.amount into #segmentwise_pendingorders_sat  
 from  
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')  
 and NetPayable>0)a  
 inner join  (select cltcode,amount from #MFFundFinal_sat) b  
 on a.party_code=b.cltcode;  
  
 with cte  
 as  
 (  
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,  
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,  
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end  
  from #segmentwise_pendingorders_sat where srno=1 --and party_code='AACW016'  
  union all  
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,  
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,  
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end  
  from #segmentwise_pendingorders_sat a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'  
 )  
 select * into #mf_segamountadjust_sat from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)  
  
  
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                     
  (                  
 select * from #mf_segamountadjust_sat  
  ) b                   
  where a.Party_code=b.party_code and a.Segment=b.segment   
  
 drop table #mf_segamountadjust_sat  
 drop table #segmentwise_pendingorders_sat  
 drop table #MFFundFinal_sat  
 drop table #MFFund_sat     
end  
else  
begin  
 select  cltcode,isnull(Sum(cramount) - Sum(dramount),0) AS BALANCE into #MFFund from angelfo.bbo_fa.dbo.mfss_ledger_bse with (nolock)  
 where cltcode   
 in   
 (select clientcode from  risk.dbo.vw_MutualFundPendingOrder_NCMS with(nolock)    where segment in ('MF','Trade' ))  
 and VDT BETWEEN (SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)    
 and EDT>=(SELECT SDTCUR FROM risk.dbo.PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
 group by cltcode  
  
 /*  
 select cltcode,m.balance,sum(o.amount) as amount  into #MFFundFinal   
 from #MFFund m inner join  
risk.dbo.vw_MutualFundPendingOrder_NCMS o  
 on m.cltcode=o.clientcode  
 where balance<=0  
 group by m.cltcode,m.balance  
 */  
  
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal     
 from   
 risk.dbo.vw_MutualFundPendingOrder_NCMS o with(nolock)   
 group by clientcode  
  
 insert into Ncms_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)  
 select cltcode,amount,getdate() from #MFFundFinal  
  
 select srno=row_number() over ( partition by party_code order by party_code,netpayable desc ),  
 a.*,b.amount into #segmentwise_pendingorders  
 from  
 (select party_code,segment,balance,OtherDebit,NetPayable from #NCMS_SegwiseCldata where segment in ('BSECM','NSECM','MCD','NSEFO','NSX','BSX','BSEMFSS','MCX','NCDEX')  
 and NetPayable>0)a  
 inner join  (select cltcode,amount from #MFFundFinal) b  
 on a.party_code=b.cltcode;  
  
 with cte  
 as  
 (  
 select srno,party_code,segment,balance,OtherDebit,NetPayable,amount,  
 amount_tobeadjusted=case when netpayable>=amount then amount else netpayable end,  
 balamount_tobeadjusted=case when netpayable>=amount then 0 else amount-netpayable end  
  from #segmentwise_pendingorders where srno=1 --and party_code='AACW016'  
  union all  
  select a.srno,a.party_code,a.segment,a.balance,a.OtherDebit,a.NetPayable,a.amount,  
 amount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then balamount_tobeadjusted else a.netpayable end,  
 balamount_tobeadjusted=case when a.netpayable>=balamount_tobeadjusted then 0 else balamount_tobeadjusted-a.netpayable end  
  from #segmentwise_pendingorders a inner join  cte b on a.party_code=b.party_code where a.srno=b.srno+1 --and a.party_code='AACW016'  
 )  
 select * into #mf_segamountadjust from cte where amount_tobeadjusted<>0  OPTION (MAXRECURSION 1000)  
  
  
 update a set OtherDebit=a.OtherDebit-b.amount_tobeadjusted,NetPayable=a.NetPayable-b.amount_tobeadjusted from #NCMS_SegwiseCldata a  ,                     
  (                  
 select * from #mf_segamountadjust  
  ) b                   
  where a.Party_code=b.party_code and a.Segment=b.segment   
   
 drop table #mf_segamountadjust  
 drop table #segmentwise_pendingorders  
 drop table #MFFundFinal  
 drop table #MFFund  
end  
 */ 
   
   
   
 /*************************************************************************************/  
   
 /*For Reducing BSE Orders added on 05 May 2017*/  
            
 IF (@Days = 'Monday')                        
 BEGIN   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                    
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE_sat with(nolock)                 
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                      
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode    
 end   
else  
begin   
 update #NCMS_SegwiseCldata set OtherDebit=OtherDebit-b.amount ,NetPayable=NetPayable-b.amount from                                                    
 (select segment+'CM' as seg,clientcode,amount=SUM(convert(money,amount)) from risk.dbo.vw_MutualFundPendingOrderBSE  with(nolock)                
 group by segment,clientcode having SUM(convert(money,amount)) <> 0) b                      
  where #NCMS_SegwiseCldata.segment=b.seg and #NCMS_SegwiseCldata.party_code=b.clientcode    
 end  
 /*---------------------------------------------------------*/       
    
 
  /*********Margin added in cash segment as per mail of sajeevn sir on 01Aug 2020****************/  
 --commented as per JIRA ID : ORE2766 

 
DECLARE @MARGINDATE AS DATETIME         
SELECT @MARGINDATE=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.tbl_combine_reporting_detail WITH (NOLOCK)     
--select @MARGINDATE  
/* 
select margindate,exchange,segment,party_code,tday_margin,tday_mtm,tday_margin+tday_mtm as margin INTO #MARGIN from  
 AngelNseCM.msajag.dbo.tbl_combine_reporting_detail with(nolock) where MARGINDATE=@MARGINDATE AND exchange in ('BSE','NSE') and segment='CAPITAL'  
  
  
  update #NCMS_SegwiseCldata set MarginAmt=MarginAmt-b.margin,NetPayable=NetPayable-b.margin from                                                
 (select party_code,margin,exchange+'CM' as segment from #MARGIN WITH (NOLOCK) where margin>0) b                                                
 where #NCMS_SegwiseCldata.segment=b.segment and #NCMS_SegwiseCldata.party_code=b.party_Code and ShortSellValue<0    
 */   
    
 /***********************End****************************************/    
  
   
 /***********************for Adding Delivery Margin Added on 14 Jun 2019 By Neha Naiwar ************************************/  
--DECLARE @MARGINDATE AS DATETIME,@sdtcur as datetime           
--SELECT @MARGINDATE=MAX(MARGINDATE) FROM angelfo.NSEFO.dbo.tbl_clientmargin WITH (NOLOCK)     
  
--SELECT * into #delmargin FROM Angelfo.NSEFo.dbo.FOMARGINNEW with(nolock) WHERE  MDATE =@MARGINDATE/*convert(datetime,convert(varchar(8),getdate(),112))*/  
--AND DEL_MARGIN <>0  
  
--  UPDATE a                                                          
--  set MarginAmt =  MarginAmt-DEL_MARGIN                       
--  FROM #NCMS_SegwiseCldata a                                               
--  JOIN                                                          
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                        
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'    
    
--  UPDATE a                                                          
--  set NetPayable =  NetPayable-DEL_MARGIN                       
--  FROM #NCMS_SegwiseCldata a                                               
--  JOIN                                                          
--  (select Party_code,DEL_MARGIN from #delmargin with(nolock)) b                                        
--  ON a.party_code=b.party_code   and a.segment = 'NSEFO'     
/*************************************************************************************/  
    insert into UnPleadge_Segveridata_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                            
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                            
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                            
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                            
 from UnPleadge_Segveridata  with (nolock)                    

             
  truncate table UnPleadge_Segveridata                        
  insert into UnPleadge_Segveridata                                          
  (                                          
  POrequestID,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,                                          
  MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                        
  )                                            
  select   /*ROW_NUMBER() OVER ( ORDER BY party_code,segment) AS refno,*/                          
  convert(varchar(6),getdate(),112)+replace(convert(varchar(8),getdate(),108),':','') AS refno,                          
  ProcessDate,Entity,Segment,Party_code,flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,                                          
  NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                                           
  from #NCMS_SegwiseCldata                                             
       
 /*       
 insert into NCMS_SegVeriData_hist(POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,                    
 MarginShortage,AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO)                    
 select POrequestID,id,ProcessDate,Entity,Segment,Party_code,Flag,Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,MarginAmt,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,                    
 AccruedCharges,OtherDebit,NonCashConsideration,ExpoUtilised,NetPayable,UnPosted_PO                    
 from NCMS_SegVeriData with (nolock)            
 */      
                                             
  /* exec NCMS_UPD_ReqVerId @pcode,@refno      */                              
                                          
--End try                     
                                              
--BEGIN CATCH                                                      
                                                  
--  insert into NCMS_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                            
--  select GETDATE(),'NCMS_VeriData_Batchwise',ERROR_LINE(),ERROR_MESSAGE()                                                            
                              
-- DECLARE @ErrorMessage NVARCHAR(4000);                                                            
-- SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                            
-- RAISERROR (@ErrorMessage , 16, 1);                                  
                                                   
--End catch                                                  
                                                    
--Set nocount off 

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Unpledge_Batch_Exe_09Nov2023
-- --------------------------------------------------

    
create procedure [dbo].[Unpledge_Batch_Exe_09Nov2023]                         
as                            
                            
set nocount on                            
                            
DECLARE @XACT_ABORT VARCHAR(3) = 'OFF',@XactChg varchar(3) ='No';                            
IF ( (16384 & @@OPTIONS) = 16384 ) SET @XACT_ABORT = 'ON';                            
if @XACT_ABORT='OFF'                            
Begin                            
 SET XACT_ABORT ON                            
 set @XactChg='Yes'                            
End                            
                            
select ROW_NUMBER() OVER ( ORDER BY srno ) AS [Ctr],                
Srno,ProcedureName,Active_Status,StartDate,EndDate,Flag,spdesc,Errflag,section                
into #File1 from UnPleadge_Batch_Process where active_Status=1 and flag=0                    
                
declare @totctr as int = 0,@ctr as int = 1, @str as varchar(2000),@srno as int,@spname as varchar(200)                            
                
select @totctr=MAX(Ctr) from #file1                            
While @ctr <= @totctr                            
Begin                            
 set @str = ''                            
 select @srno=srno,@str='exec '+procedurename,@spname=procedurename from #File1 where ctr=@ctr                            
 Begin Try                            
  update UnPleadge_Batch_Process set StartDate=GETDATE(),errflag='' where srno=@srno                            
   exec(@str)                   
                     
     /*          
     WAITFOR DELAY '00:00:02';            
     print @str                        
     */                
          
  if @srno < (select MAX(srno) from UnPleadge_Batch_Process)     
  update UnPleadge_Batch_Process set EndDate=GETDATE(),Flag=1 where srno=@srno        
  else      
  update UnPleadge_Batch_Process set EndDate=GETDATE() where srno=@srno            
          
 End Try                            
 Begin Catch                            
                  
  insert into risk.dbo.Appln_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)         
 select GETDATE(),'UnPledge_Batch_initialise',ERROR_LINE(),ERROR_MESSAGE()                         
                    
  update UnPleadge_Batch_Process set errflag='<font color="red">Error</font>' where Srno=@srno                      
                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                        
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                        
  RAISERROR (@ErrorMessage , 16, 1);                               
                            
  RETURN                            
                              
 End Catch                            
 set @ctr=@ctr+1                            
End                            
                            
if @XactChg='Yes'                            
Begin                            
 SET XACT_ABORT OFF                            
end                            
                            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPD_DEACTIVE_SUBBROKER_MFSB
-- --------------------------------------------------
CREATE PROCEDURE UPD_DEACTIVE_SUBBROKER_MFSB          
(          
  @tag varchar(20)          
 , @SEG varchar(20)         
 ,@acc varchar(30)        
 ,@rem  varchar(1000)        
          
)          
AS          
          
          
UPDATE TBL_RTGS_SUBBROKER_MFSB          
SET Fld_Status='Deactive'          
,Fld_Remark=@rem ,    
fld_Deactive_date=getdate()     
WHERE Fld_Sub_Code=@tag          
AND Fld_Segment=@SEG          
and Fld_Status='A'  and Fld_Bank_AcNo=@acc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPD_MFSB_SB_APPROVE
-- --------------------------------------------------
CREATE PROCEDURE UPD_MFSB_SB_APPROVE                              
-- 'deactive','aaa','mcx','','','',''                                         
(@flag    VARCHAR(20),                              
 @tag     VARCHAR(20),                              
 @seg     VARCHAR(20),                              
 @remark  VARCHAR(100),                              
 @paymode VARCHAR(20),                              
 @accno   VARCHAR(100),                              
 @checker VARCHAR(100))                              
AS                          
                          
                              
  BEGIN                              
                          
                          
                          
                          
      IF( @FLAG = 'REJECT' )                              
        BEGIN                              
            UPDATE tbl_rtgs_subbroker_MFSB                              
            SET    fld_status = 'REJECTED',                              
                   fld_remark = @remark,                              
                   checker = @checker + '|' + convert(varchar(10),getdate(),103)                              
            WHERE  fld_sub_code = @tag                              
                   AND fld_status in( 'pending','p')                              
                   AND fld_segment = @seg                              
                   AND fld_bank_acno = @accno                              
        END                              
                                
                              
      IF( @FLAG = 'APPROVE' )                         
      begin            
      select *,Company=case when SEGMENT= 'ABLCM' then 'BSE'            
                            when SEGMENT= 'ACDLCM' then 'NSE'            
                            when SEGMENT= 'ACDLFO' then 'NSEFO'            
                            when SEGMENT= 'ACPLMCD' then 'MCD'            
                            when SEGMENT= 'ACDLNSX' then 'NSX'            
                            when SEGMENT= 'ACPLMCX' then 'MCX'            
                            when SEGMENT= 'ACPLNCDX' then 'NCDEX'            
      end            
                    
      into #vendormapping  from [MIS].sb_comp.dbo.vendor_mapping            
      where sbtag=@tag              
             
             
             
                      
        UPDATE tbl_rtgs_subbroker_MFSB                              
        SET    fld_status = 'A',                              
               fld_remark = '',                        
               fld_active_date=getdate(),                              
               paymode = @paymode,                              
               checker = @checker + '|' + convert(varchar(10),getdate(),103)                                    
        WHERE  fld_sub_code = @tag                              
               AND fld_status in( 'pending','P')                              
               AND fld_segment = @seg                              
               AND fld_bank_acno = @accno                             
                                    
                        update  tbl_rtgs_subbroker_MFSB            
                        set vendorNo=a.vendor_number            
                        from #vendormapping a            
                        where tbl_rtgs_subbroker_MFSB.Fld_Sub_Code=a.sbtag            
                        and tbl_rtgs_subbroker_MFSB.Fld_Segment=a.Company            
                        and vendorNo =0 and fld_sub_code = @tag and fld_segment = @seg              
                        AND fld_bank_acno = @accno               
                                         
                                         
                 UPDATE tbl_rtgs_subbroker_MFSB                           
            SET    fld_status = 'DeACTIVE'  ,fld_Deactive_date=getdate()                               
            WHERE  fld_sub_code = @tag                             
             
                   AND fld_segment = @seg                              
                   AND fld_status ='A'                               
                   AND fld_bank_acno NOT IN ( @accno )                
                               
                             
                   drop table #vendormapping            
                             
        end                                    
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPD_MFSB_SB_DETAIL
-- --------------------------------------------------
CREATE procedure  UPD_MFSB_SB_DETAIL                  
@Tag varchar(20)                  
as                  
SELECT  Fld_Segment as 'Segment',Fld_Bank_AcNo as 'Account No',Fld_Status  as 'Status'                  
,NameinBank,NameasperOracle,vendorNo,paymode,tradename as 'Tradname',IFSC,micr,bankname,branchname                  
,IFSC,ChqImage,ChqAttach,OtherImage,OtherAttach,branchadd,Fld_Type,ChqAttach as 'chq',OtherAttach as 'other'                   
from TBL_RTGS_SUBBROKER_MFSB                  
where Fld_Sub_Code=@tag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPD_RTGS_DETAIL_MFSB
-- --------------------------------------------------
CREATE PROCEDURE UPD_RTGS_DETAIL_MFSB (                                     
@TAG VARCHAR(20),                                    
@SEG VARCHAR(20)                                                              
,@STATUS VARCHAR(50)                                                              
,@TRADENAME VARCHAR(200)                                                               
,@NAMEINBANK VARCHAR(100)                                                              
,@ACCNO VARCHAR(100)                                                              
,@IFSC VARCHAR(20)                                                              
,@PAYMODE VARCHAR(20)                                                              
,@VENDORNO VARCHAR(50)                                                              
,@CHQIMG VARCHAR(50)                                                              
,@CHQATTACH varbinary(MAX)                                                              
,@OTHERIMG VARCHAR(50)                                                              
,@OTHERATTACH varbinary(MAX)                                                           
,@MAKER  VARCHAR(100)                                                           
,@ACCTYPE VARCHAR(20)                                                          
,@MICR VARCHAR(20)                                                
,@bankname VARCHAR(20)                                              
,@branchbank VARCHAR(200)                                                 
,@branchadd VARCHAR(200)                                             
,@NameasperOracle VARCHAR(100)                                  
,@ip varchar(50)                                                            
)                                                              
AS                                                              
                                          
                                           
                                          
                                           
                                           
                                                              
DECLARE @RTGS_SRNO VARCHAR(50)                                                              
SET @RTGS_SRNO=(SELECT top 1 SR_NO FROM  Risk.dbo.RTGS_MASTER WHERE  REPLACE(LTRIM(RTRIM(IFSC_CODE)),' ','')=@IFSC)                                   
                            
                              
--DECLARE @MAKER1 VARCHAR(100)                                  
--SET @MAKER1=@MAKER + '|' +  @IpAddress                                                             
                                                              
--DECLARE @CHQATTACH1 VARBINARY(MAX)                                                              
--SET @CHQATTACH1=(SELECT CONVERT(VARBINARY(MAX),@CHQATTACH)                                                               
-- )                                                              
-- DECLARE @OTHERATTACH1 VARBINARY(MAX)                                                              
-- SET @OTHERATTACH1=CONVERT(VARBINARY(MAX),@OTHERATTACH)                                                              
                                                  
/*                                                    
SELECT * INTO #RTGS                                                    
FROM tbl_rtgs_subbroker_MFSB_TEMP WHERE FLD_SUB_CODE=@TAG AND FLD_SEGMENT=@SEG AND FLD_STATUS != 'PENDING'                                                    
  */                                                  
IF  EXISTS (SELECT * FROM tbl_rtgs_subbroker_MFSB WHERE FLD_SUB_CODE=@TAG AND FLD_SEGMENT=@SEG and fld_status IN ('P','Pending'))                                                            
BEGIN                                                              
                        
--DELETE FROM tbl_rtgs_subbroker_MFSB_log                        
--WHERE FLD_STATUS='REJECTED'                        
                        
--SET IDENTITY_INSERT tbl_rtgs_subbroker_MFSB_log ON                                     
                                                  
INSERT INTO tbl_rtgs_subbroker_MFSB_log (Fld_Sr_No,Fld_Sub_Code,Fld_Segment,Fld_RTGS_Sr_No,Fld_Bank_AcNo,Fld_Status,              
Fld_Docs_Recd,Fld_Entered_By,Fld_Remark,Fld_Entry_Date,Fld_Access_Code,Fld_Ip,Fld_Req_by,Fld_CSO_Docs_Recd,Fld_Type,                                                  
Fld_Active_By,Fld_Active_Date,Fld_Deative_Date,Fld_Active_Ip,Fld_UniqueID,ACTIONDATE,ChqImage,ChqAttach,OtherImage,OtherAttach,NameinBank,                                                  
NameasperOracle,vendorNo,paymode,tradename,IFSC,bankname,MAKER,CHECKER,MICR,BRANCHNAME,BRANCHADD,UPDATE_ON,Action)                                                  
SELECT Fld_Sr_No,Fld_Sub_Code,Fld_Segment,Fld_RTGS_Sr_No,Fld_Bank_AcNo,Fld_Status,                                   
Fld_Docs_Recd,Fld_Entered_By,Fld_Remark,Fld_Entry_Date,Fld_Access_Code,Fld_Ip,Fld_Req_by,Fld_CSO_Docs_Recd,Fld_Type,                                                  
Fld_Active_By,Fld_Active_Date,Fld_Deactive_Date,Fld_Active_Ip,Fld_UniqueID,GETDATE(),ChqImage,ChqAttach,OtherImage,OtherAttach,NameinBank,                                                  
NameasperOracle,vendorNo,paymode,tradename,IFSC,bankname,MAKER,CHECKER,MICR,BRANCHNAME,BRANCHADD,GETDATE(),'UPDATED' FROM tbl_rtgs_subbroker_MFSB                                                   
WHERE FLD_SUB_CODE=@TAG AND FLD_SEGMENT=@SEG                          
--SET IDENTITY_INSERT tbl_rtgs_subbroker_MFSB_log OFF                                   
                        
                    
DECLARE @DATE DATETIME                    
set @DATE=(SELECT MAX(FLD_ENTRY_DATE) FROM tbl_rtgs_subbroker_MFSB  WHERE FLD_SUB_CODE=@TAG AND FLD_SEGMENT=@SEG AND FLD_STATUS IN('PENDING'))                    
                        
DELETE FROM tbl_rtgs_subbroker_MFSB  WHERE FLD_SUB_CODE=@TAG AND FLD_SEGMENT=@SEG AND FLD_STATUS IN('PENDING','P')                                                    
                            
INSERT INTO tbl_rtgs_subbroker_MFSB  VALUES(@TAG,@SEG,@RTGS_SRNO,@ACCNO,@STATUS,'N','TEST','',@DATE,'','','B','',@ACCTYPE,'CHECKER','','',@IP,'',@CHQIMG,@CHQATTACH,@OTHERIMG,@OTHERATTACH,@NAMEINBANK,@NameasperOracle,@VENDORNO,  
case when (@IFSC='' and @iFSC is null) then 'CMS' else @PAYMODE end,@TRADENAME,@IFSC,@bankname,@MAKER + '|' + convert(varchar(10),getdate(),103),'',@MICR,replace(@branchbank,'&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;',''),@branchadd)        
                                     
   
       
        
              
                
                  
                       
                        
DELETE T FROM                         
tbl_rtgs_subbroker_MFSB_log T                        
INNER JOIN                         
tbl_rtgs_subbroker_MFSB  R                        
ON T.FLD_SUB_CODE=R.FLD_SUB_CODE                        
AND T.FLD_SEGMENT=R.FLD_SEGMENT                        
WHERE T.Fld_Bank_AcNo=R.Fld_Bank_AcNo                        
AND T.ChqImage=R.ChqImage                        
AND T.OtherImage=R.OtherImage                        
AND T.IFSC=R.IFSC                        
AND T.CHECKER=R.CHECKER                        
AND R.FLD_STATUS IN('Pending','REJECTED','A','P','R')       
and t.Fld_Status<>'A'                       
--AND R.FLD_SUB_CODE=@TAG                        
--AND R.FLD_SEGMENT=@SEG                        
                        
                        
END                                            
                        
ELSE                        
BEGIN                        
                        
DELETE FROM tbl_rtgs_subbroker_MFSB  WHERE FLD_SUB_CODE=@TAG AND FLD_SEGMENT=@SEG AND FLD_STATUS in('PENDING','P')                                                    
                            
INSERT INTO tbl_rtgs_subbroker_MFSB VALUES(@TAG,@SEG,@RTGS_SRNO,@ACCNO,@STATUS,'N','TEST','',GETDATE(),'','','B','',@ACCTYPE,'CHECKER','','',@IP,'',@CHQIMG,@CHQATTACH,@OTHERIMG,@OTHERATTACH,@NAMEINBANK,@NameasperOracle,@VENDORNO,  
case when (@IFSC='' and @iFSC is null) then 'CMS' else @PAYMODE end,@TRADENAME,@IFSC,@bankname,@MAKER + '|' + convert(varchar(10),getdate(),103),'',REPLACE (@MICR,'&nbsp;',''),REPLACE(replace(@branchbank,'&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#
160;',''),'&nbsp;',''),REPLACE(@branchadd,'&nbsp;',''))                              
                                                    
                        
                        
END             
                        
--ELSE                                                            
--BEGIN                         
                        
                                                           
                                                  
                                            
/*SET IDENTITY_INSERT tbl_rtgs_subbroker_MFSB_TEMP ON                                                  
                                                  
INSERT INTO tbl_rtgs_subbroker_MFSB_TEMP (Fld_Sr_No,Fld_Sub_Code,Fld_Segment,Fld_RTGS_Sr_No,Fld_Bank_AcNo,Fld_Status,                                                  
Fld_Docs_Recd,Fld_Entered_By,Fld_Remark,Fld_Entry_Date,Fld_Access_Code,Fld_Ip,Fld_Req_by,Fld_CSO_Docs_Recd,Fld_Type,                                                  
Fld_Active_By,Fld_Active_Date,Fld_Active_Ip,Fld_UniqueID,ChqImage,ChqAttach,OtherImage,OtherAttach,NameinBank,                                                  
NameasperOracle,vendorNo,paymode,tradename,IFSC,bankname,MAKER,CHECKER,MICR)                                                  
SELECT Fld_Sr_No,Fld_Sub_Code,Fld_Segment,Fld_RTGS_Sr_No,Fld_Bank_AcNo,Fld_Status,                                             
Fld_Docs_Recd,Fld_Entered_By,Fld_Remark,Fld_Entry_Date,Fld_Access_Code,Fld_Ip,Fld_Req_by,Fld_CSO_Docs_Recd,Fld_Type,                                                  
Fld_Active_By,Fld_Active_Date,Fld_Active_Ip,Fld_UniqueID,ChqImage,ChqAttach,OtherImage,OtherAttach,NameinBank,                                                  
NameasperOracle,vendorNo,paymode,tradename,IFSC,bankname,MAKER,CHECKER,MICR FROM #RTGS                                                  
                                                  
SET IDENTITY_INSERT tbl_rtgs_subbroker_MFSB_TEMP OFF                                                  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_APAudit_updateStatus
-- --------------------------------------------------
CREATE proc usp_APAudit_updateStatus  
AS  
BEGIN  
  update tbl_SBPlannedAuditMIS    
  Set AuditStatus='Pending'  
  where AuditStartDate < getdate() and AuditStatus='New'  
  
update a  
  Set AuditStatus='Completed',AuditCompleteddate=b.Logdate ,  AuditFile=c.Filepath,
  AuditObservation= case when  b.AuditStatus=3 then 'Compliant' else 'Non-Compliant' end
  from  tbl_SBPlannedAuditMIS a  
  inner join  SbAudit.dbo.tbl_AuditStatus  b on A.APTag =b.Sbtag  
  inner join SbAudit.[dbo].[tbl_SBAuditpdfLogs] c on a.APTag = c.SbTag
  where A.AuditStatus not in ('Completed','Cancelled') and b.AuditStatus in(3,6)
  and b.Logdate = (select max(logdate) from SbAudit.dbo.tbl_AuditStatus where sbtag=A.APTag)  
  and c.pdfdownloaddate = (select max(pdfdownloaddate) from SbAudit.dbo.[tbl_SBAuditpdfLogs] where sbtag=A.APTag)   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ApListfileUpload
-- --------------------------------------------------
create proc USP_ApListfileUpload
(@FileName varchar(200))
AS
BEGIN
--select top 0 APTag,FY,AuditStartDate,AuditorID,AuditorName,AuditorEmail into tmp_SBPlannedAuditMIS from tbl_SBPlannedAuditMIS
   -- declare @FileName as varchar(100)='DummyAplist.csv'                            
    truncate table tmp_SBPlannedAuditMIS                    
                 
    Declare @filePath varchar(500)=''                                               
    set @filePath ='\\INHOUSELIVEAPP1-FS.angelone.in\upload1\SBAuditAPList\'+@FileName+''                                 
    DECLARE @sql NVARCHAR(4000) = 'BULK INSERT tmp_SBPlannedAuditMIS FROM ''' + @filePath + ''' WITH ( FIELDTERMINATOR ='','', ROWTERMINATOR =''\n'',FirstRow=1 )';                                            
    EXEC(@sql)  

    truncate table tbl_SBPlannedAuditMIS
    insert into tbl_SBPlannedAuditMIS
	select * ,'New',null,'','',getdate() from tmp_SBPlannedAuditMIS
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Brokerage_Mailer_For_ITradePremierPlusVBB
-- --------------------------------------------------


-- =============================================
-- Author:		HRISHI YERUNKAR
-- Create date: 17 NOV 2025
-- Description:	Auto Mailer For Brokerage
-- =============================================
CREATE PROCEDURE [dbo].[usp_Brokerage_Mailer_For_ITradePremierPlusVBB]  
(@Party_code varchar(20))
AS
BEGIN
	Declare @Name varchar(100)='',@Body varchar(max)='',@sub varchar(200)='',@emailto varchar(500),@emailcc varchar(max)='',@emailbcc varchar(500)
	set @emailcc = 'yogen.gandhi@angelbroking.com'
	set @emailbcc ='brokerage.intimation@angelone.in;codetransferemailcopies@angelbroking.com'-- 'brokerage.modification@angelbroking.com'
	
	insert into itrade_SMS_Mail_log(party_code,source,UpdatedOn)  
 select @Party_code,'Email',GETDATE()  
   
 -- Select @Name= long_name +' (' + party_code+')',  
 Select @Name = long_name,  
   @emailto=email    
 from client_details with(nolock)   
 where party_code=@Party_code 
	
	 set @Body='<table align="center" border="0" cellpadding="0" cellspacing="0" style="max-width: 720px;width:100%;" width="100%">
		<tr>
			<td style="padding: 20px 20px 0 20px;background: #EBEDF0;">
				<table align="center" cellpadding="0" cellspacing="0" style="width:720px" width="100%">
					<tr>
					  <td><table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:720px;border-top-left-radius:15px;border-top-right-radius:15px;padding: 2px;background: #fff;max-width: 720px;" width="100%">
					    <tbody>
					      <tr>
					        <td align="right" style="padding:15px 10px 10px 0;text-align: right;" valign="bottom"><a><img alt="Angel One" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/logo.png" style="width:170px;"></a></td>
				          </tr>
				        </tbody>
					    </table></td>
				  </tr>
					<tr>
					  <td style="padding:30px;font-family: ''Barlow'', sans-serif;font-size: 16px;display: block;color:#000;text-align: justify;border-bottom-left-radius:15px;border-bottom-right-radius:15px;background:#fff;line-height: 22px">Dear '+@Name+',<br>
					    <br>
						As requested, we are pleased to change your Brokerage plan to the <strong style="font-weight: 600">I Trade Premier Plus Plan</strong>. The following are the revised Trading and Demat Tariff which will be applicable from the next trading day.
						<br>
					    <br>
					    <table cellpadding="0" cellspacing="0" width="100%" style="border: 1px solid #58CD7F;border-bottom: none">
					      <thead>
					        <tr>
					          <td width="60%" align="left" style="padding: 5px 8px;background:#eefaf2;color: #000;border-right: 1px solid #58CD7F;border-bottom: 1px solid #58CD7F;vertical-align: top;font-family: ''Barlow'', sans-serif;font-size: 16px;"><strong>Plan Name</strong></td>
					          <td align="center" style="padding: 5px 8px;background:#eefaf2;color: #000;border-right: 0px solid #58CD7F;border-bottom: 1px solid #58CD7F;vertical-align: top;font-family: ''Barlow'', sans-serif;font-size: 16px;"><strong>I Trade Premier Plus</strong></td>
				            </tr>
				          </thead>
					      <tbody>
							  
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">
								<strong style="font-weight: 600">BSDA Category</strong> - DP AMC Charges Nil (Holding Value up to &#8377;4,00,000/-)<br>
								<strong style="font-weight: 600">BSDA Category</strong> - DP AMC Charges Free for 1 Year / From 2nd Year 100/-p.a.+Taxes. (Holding Value More than &#8377;4,00,000 / and upto &#8377;10,00,000)<br>
								<strong style="font-weight: 600">Non BSDA Category</strong>- DP AMC Charges Free for 1 year INR 60 per quarter of Non-BSDA accounts from 2<sup>nd</sup> year onwards.
							</td>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">&nbsp;</td>
				            </tr>
					        
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">Equity Delivery</td>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;text-align: left;vertical-align: top">INR 20 or 0.1% whichever is lower per executed order (minimum brokerage of INR 5 will be levied)</td>
				            </tr>
							  <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top"> Intraday</td>
					          <td align="center" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;text-align: left;vertical-align: top">INR 20 or 0.1% whichever is lower per executed order (minimum brokerage of INR 5 will be levied)</td>
				            </tr>
					        
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">Futures, Options, Commodity, Currency</td>
					          <td align="center" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;text-align: left;vertical-align: top">INR 20 per executed order</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">Call and Trade Charges</td>
					          <td align="center" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;text-align: left;vertical-align: top">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">Transaction charges for sell (Debit)<br>
								&amp; Inter-settlement Debit per<br>
								transaction ( Refer Note No. 6 a )</td>
					          <td align="center" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;text-align: left;vertical-align: top">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">Auto square off charges</td>
					          <td align="center" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;text-align: left;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;">Pledge / Unpledge Creation / Closure / Invocation (Refer Note No.6 b) </td>
					          <td align="center" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;text-align: left;vertical-align: top">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">Demat / Remat (Per Certificate) Additional DIS requisition Additional statements Physical Contract Note</td>
					          <td align="center" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;text-align: left;vertical-align: top">&#8377;50</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">Cheque Bounce Charges</td>
					          <td align="center" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;text-align: left;vertical-align: top">&#8377;350</td>
				            </tr>
					        
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">Delay Payment Charges (DPC) on outstanding bill amount if not paid within due date</td>
					          <td align="center" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;text-align: left;vertical-align: top">1.5 % Per month (levied every 15 days) for normal trades.</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px 8px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 16px;border-bottom: 1px solid #58CD7F;vertical-align: top">Interest on outstanding dues under Margin Trading facility (MTF)</td>
					          <td align="center" style="padding: 5px 8px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;text-align: left;vertical-align: top">14.99 % per annum (Levied every 15 days)</td>
				            </tr>
					        
				          </tbody>
				        </table>
					    <br>
					    <strong>Notes :</strong><br>
					    <ul style="margin:10px 0 15px 0;font-size: 16px;color: #000;line-height: 22px;padding: 0 0 0 20px">
					      <li style="padding-bottom:7px">Brokerage is levied per executed order across all segments Brokerage is also charged on expired, exercised and assigned options contract. Brokerage levied to your trading account will never exceed more than the maximum brokerage permissible as per the rules, regulations and bye-laws of the relevant stock exchanges and/or rules and regulations of SEBI.</li>
							
					      <li style="padding-bottom:7px">Stamp Duty, GST, Education Cess &amp; Statutory Levies will be charges as applicable. Details of such charges are provided here- <a href="https://www.angelone.in/exchange -transaction-charge" style="color: #1127EB">https://www.angelone.in/exchange -transaction-charge</a>. The said levies are subject to statutory and regulatory changes, as notified by the Government / Regulators / Exchange from time to time.</li>
							
							<li style="padding-bottom:7px">Above tariff is subject to changes. Price Changes, if any (other than statutory / regulatory price changes as stipulated in Point 2.above) will be notified 30 (thirty) days in advance.</li>
							
					      <li style="padding-bottom: 7px">For availing Easiest facilities of CDSL, the charges as levied by CDSL would be collected from client at actuals.</li>
							
					      <li style="padding-bottom: 7px">
							  In case of BSDA, if there are no transactions in any quarter, no transaction statements will be sent for that quarter.
							  <ul style="margin: 0;padding: 0;list-style-type: lower-alpha">
							  	<li style="margin-left: 15px;padding-bottom: 5px;">
									Depository Participant Charges: &#8377;20 + GST, split as below<br>
								    Male: INR 3.5 (CDSL) + INR 16.5 (Angel One Charge)<br>
								    Female: INR 3.25 (CDSL) + INR 16.75 (Angle One Charge))
								</li>
								  
								 <li style="margin-left: 15px">
									Pledge / Unpledge Charges:<br>
									Margin pledge/unpledge/invoke: INR 20 + GST, split as below:<br>
									INR 5 (CDSL) + INR 15 (Angel One Charge) + GST<br>
									MTF pledge/unpledge/invoke: INR 20 + GST split as below:<br>
									INR 12 (CDSL) + INR 8 (Angel One Charge) + GST<br>
									CUSPA pledge/unpledge/invoke: INR 20 + GST split as below:<br>
									INR 5 (CDSL) + INR 15 (Angel One Charge) + GST
								</li>
							  </ul>
						 </li>
							
						 <li style="padding-bottom: 7px">BSDA facility is subject to approval from CDSL. You will be eligible for BSDA subject to following conditions:
							 <ul style="margin: 0;padding: 0;list-style-type: lower-alpha">
							  	<li style="margin-left: 15px;padding-bottom: 5px;">
									The individual has or proposes to have only one demat account where he/she is the sole or first holder.
								</li>
								  
								 <li style="margin-left: 15px">
									The individual shall have only one BSDA in his/her name across all depositories
								</li>
								 
								  <li style="margin-left: 15px">
									Value of securities held in the demat account shall not exceed 10 Lakhs for debt and other than debt securities combined at any point of time.
								</li>
							  </ul>
						 </li>	
							<li style="padding-bottom: 7px">If you do not wish to avail BSDA facilities, you will have to specifically provide your consent on <a href="mailto:support@angelone.in" style="color: #1127EB">support@angelone.in</a> by way of email from your registered e-mail ID to avail the facility of regular demat account.</li>
							<li style="padding-bottom: 7px">Interest on Cash Collateral Margin Shortfall - 12.5% per annum chargeable every 15 days.</li>
							</ul>
					   
					    In case of any discrepancy in the above information, kindly notify us immediately on <a href="mailto:support@angelbroking.com" style="color:#1127EB;text-decoration: underline;" target="_blank">support@angelbroking.com</a> or call on <a href="tel:08047480048" style="color:#1127EB;text-decoration: underline;" target="_blank">080-47480048</a> <br>
					    <br>
					    For investment advisory, <a href="mailto:advisory@angelbroking.com" style="color:#1127EB;text-decoration: underline;" target="_blank">advisory@angelbroking.com</a></td>
				  </tr>
					<tr>
					  <td style="max-width:580px;width: 100%;"><table align="center" cellpadding="0" cellspacing="0" style="width: 100%;max-width: 580px;" width="100%">
					    
					    <tr>
					      <td align="left" style="font-size: 13px;color: #131313;font-family: ''Barlow'', sans-serif; font-weight: 400; text-align: center;padding-bottom: 20px;padding-top: 20px;" valign="top">
							
							<a href="https://absite-mumbai.s3.ap-south-1.amazonaws.com/Disclaimer/MF.html" style="color: #2e51ff; text-decoration: none;font-family: ''Barlow'', sans-serif; font-size: 13px;" target="_blank"></a><a href="https://absite-mumbai.s3.ap-south-1.amazonaws.com/Disclaimer/ABL_Disclaimer.html" style="color: #2e51ff; text-decoration: none;font-family: ''Barlow'', sans-serif; font-size: 13px;" target="_blank">*Disclaimer</a> - Investments in securities market are subject to market risk, read all the related documents carefully before investing.<br>
										<br>
										
										
										This mail provides vital information. Still if you want to risk missing such essential updates, you have the option to <a href="[UNSUBSCRIBEURL]" style="color: #2e51ff; text-decoration: underline; font-size: 13px;" target="_blank">unsubscribe</a></td>
				        </tr>
					    </table></td>
				  </tr>
				</table>
			</td>
		</tr>
	</table>'



	set @sub ='REVISED BROKERAGE FOR TRADING CODE - ' +@Party_code+' '             
		  
		 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
		 @RECIPIENTS =@emailto,                              
		 --@COPY_RECIPIENTS = @emailcc,                              
		 @blind_copy_recipients=@emailbcc,
		 @PROFILE_NAME = 'AngelBroking',                              
		 @BODY_FORMAT ='HTML',                              
		 @SUBJECT = @sub ,                              
		 @FILE_ATTACHMENTS ='',                              
		 @BODY =@Body    


	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Brokerage_Mailer_For_ItradePrime_newMailer
-- --------------------------------------------------

-- =============================================
-- Author:		Neha Naiwar
-- Create date: 15 Apr 2019
-- Description:	Auto Mailer For Brokerage
-- =============================================
-- usp_Brokerage_Mailer_For_ItradePrime 'P117327'
create PROCEDURE [dbo].[usp_Brokerage_Mailer_For_ItradePrime_newMailer]
( @Party_code varchar(20) )
 as
 begin
	Declare @Name varchar(100)='',@Body varchar(max)='',@sub varchar(200)='',@emailto varchar(500),@emailcc varchar(max)='',@emailbcc varchar(500)
	set @emailcc = 'neha.naiwar@angelbroking.com'
	set @emailbcc = 'nilesh@angelbroking.com'--'brokerage.modification@angelbroking.com'
	
 
	
	-- Select	@Name= long_name +' (' + party_code+')',
	Select	@Name = long_name,
			@emailto=email  
	from	client_details with(nolock) 
	where party_code=@Party_code
	
	set @Body='<table align="center" border="0" cellpadding="0" cellspacing="0" style="max-width: 720px;width:100%;" width="100%">
		<tr>
			<td style="padding: 20px 20px 0 20px;background: #EBEDF0;">
				<table align="center" cellpadding="0" cellspacing="0" style="width:720px" width="100%">
					<tr>
					  <td><table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:720px;border-top-left-radius:15px;border-top-right-radius:15px;padding: 2px;background: #fff;max-width: 720px;" width="100%">
					    <tbody>
					      <tr>
					        <td align="right" style="padding:15px 10px 10px 0;text-align: right;" valign="bottom"><a><img alt="Angel One" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/logo.png" style="width:170px;"></a></td>
				          </tr>
				        </tbody>
					    </table></td>
				  </tr>
					<tr>
					  <td style="padding:30px;font-family: ''Barlow'', sans-serif;font-size: 15px;display: block;color:#4e4e4e;text-align: justify;border-bottom-left-radius:15px;border-bottom-right-radius:15px;background:#fff;">Dear [NAME],<br>
					    <br>
					    As per your request, We are pleased to change your Brokerage plan to Angel iTrade Prime. The following are the revised Trading and Demat Tariff which will be applicable from the next trading day. <br>
					    <br>
					    <strong>TRADING BROKERAGE AND DEMAT TARIFF</strong><br>
					    <br>
					    <table cellpadding="0" cellspacing="0" width="100%" style="border: 1px solid #58CD7F">
					      <thead>
					        <tr>
					          <td colspan="2" align="center" style="padding: 5px;background: #eefaf2;color: #000;border-right: 0px solid #58CD7F;border-bottom: 1px solid #58CD7F;vertical-align: top;font-family: ''Barlow'', sans-serif;font-size: 15px;"><strong>iTrade Prime </strong></td>
				            </tr>
				          </thead>
					      <tbody>
					         <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- DP AMC Charges @ &#8377;20 Per Traded Month</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&nbsp; </td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px; border-bottom: 1px solid #58CD7F;"><strong>Online Brokerage per executed order</strong></td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&nbsp;</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Equity Delivery</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Intra-day, Futures, Options, Commodity, Currency</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&nbsp;</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&nbsp;</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"><strong>Value Added Services</strong></td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Call and Trade Charges per Order</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Premium Advisory</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Dedicated Relationship Manager</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Online Wealth Builder Training Program (Once a Month)</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Financial Planning </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Online Fund Transfer via Net Banking &amp; UPI</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- ARQ  - Robo based Advisory </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Technical &amp; Derivatives trading ideas </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Email statements / Electronic contract notes</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Transaction charges for Sell (Debit) &amp;<br>
					            Inter-settlement Debit per transaction</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Pledge Creation/Closure/Invocation/Unpledged</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Demat / Remat (Per Certificate) <br>
					            - Physical statements request/ DIS request/ Physical contract notes</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;50</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Cheque Bounce Charges</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;350</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 0px solid #58CD7F;">- Delay Payment Charges (DPC) on outstanding bill amount if not paid within due date </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 0px solid #58CD7F;">1.5% Per month (levied every 15 days)</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-top: 1px solid #58CD7F;">- Auto square off charges</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-top: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
				          </tbody>
				        </table>
					    <br>
					    <strong>Notes :</strong><br>
					    <ul>
					      <li>Brokerage is levied per executed order across all segments.</li>
					      <li> Order value for Options is calculated as (Strike + Premium) x Lot size. Brokerage is also charged on expired, exercised and assigned options contract.</li>
					      <li>Stamp duty, GST, Education cess &amp; other statutory levies (if any) will be charged as applicable.</li>
					      <li>Above tariff is subject to change. Changes if any will be intimated 30 days in advance.</li>
				        </ul>
					    <br>
					    In case of any discrepancy in the above information, kindly notify us immediately on <a href="mailto:support@angelbroking.com" style="color:#0071BB;text-decoration: underline;" target="_blank">support@angelbroking.com</a> or call on <a href="tel:08047480048" style="color:#0071BB;text-decoration: underline;" target="_blank">080-47480048</a> <br>
					    <br>
					    For investment advisory, <a href="mailto:advisory@angelbroking.com" style="color:#0071BB;text-decoration: underline;" target="_blank">advisory@angelbroking.com</a></td>
				  </tr>
					<tr>
						<td style="max-width:720px;width: 100%;">
							<table align="center" cellpadding="0" cellspacing="0" style="width: 100%;max-width: 720px;" width="100%">
								<tr>
								  <td align="center" valign="middle" style="font-size: 15px;color: #231f20;font-weight: 400; font-family: ''Barlow'', sans-serif;padding: 20px; vertical-align: middle; "><a href="https://www.facebook.com/OfficialAngelOne" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/FB.png" style="vertical-align: top; "></a>&nbsp; <a href="https://www.instagram.com/angelone/?utm_medium=copy_link" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Insta.png" style="vertical-align: top; "></a>&nbsp; <a href="https://twitter.com/AngelOne?t=Qx3rxyE9ZhQBJ-jSi7R3tQ&s=09" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Twitter.png" style="vertical-align: top; "></a>&nbsp; <a href="https://youtube.com/user/AngelBrokingVideos" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/YourTube.png" style="vertical-align: top; "></a>&nbsp; <a href="https://www.linkedin.com/company/angelone" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/LinkedIn.png" style="vertical-align: top; "></a>&nbsp; <a href="https://t.me/AngelOneAdvisory" target="_blank"  style="font-family: ''Barlow'', sans-serif;"  ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Telegram.png" style="vertical-align: top; "></a>&nbsp; <a href="https://wa.me/917400180180?&text=Start" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Whatsapp.png" style="vertical-align: top; "></a>&nbsp; <a href="https://www.jio.com/en-in/apps/jio-chat" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/chat.png" style="vertical-align: top; "></a></td>
							  </tr>
								<tr>
									<td align="left" style="font-size: 13px;color: #131313;font-family: ''Barlow'', sans-serif; font-weight: 400; text-align: center;padding-bottom: 20px;" valign="top">
										<a href="http://bitly.ws/oTzH" style="color: #2e51ff; text-decoration: none;font-family: ''Barlow'', sans-serif; font-size: 13px;" target="_blank">*Disclaimer</a> - Investments in securities market are subject to market risk, read<br>
										all the related documentscarefully before investing. <a href="http://bitly.ws/oTzH" style="color: #2e51ff; text-decoration: none;font-family: ''Barlow'', sans-serif; font-size: 13px;" target="_blank">Read more...</a><br>
										Copyright &copy; 2021 AngelOne. All rights Reserved.
									</td>
								</tr>
							</table>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table> '
	set @sub ='REVISED BROKERAGE FOR TRADING CODE_testing - ' +@Party_code+' '             
		  
		 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
		 @RECIPIENTS =@emailto,                              
		 --@COPY_RECIPIENTS = @emailcc,                              
		 @blind_copy_recipients=@emailbcc,
		 @PROFILE_NAME = 'AngelBroking',                              
		 @BODY_FORMAT ='HTML',                              
		 @SUBJECT = @sub ,                              
		 @FILE_ATTACHMENTS ='',                              
		 @BODY =@Body    

	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Brokerage_Mailer_For_ItradePrimePlus_newMailer
-- --------------------------------------------------

-- =============================================
-- Author:		Neha Naiwar
-- Create date: 09 Mar 2022
-- Description:	Auto Mailer For Brokerage
-- =============================================
create PROCEDURE [dbo].[usp_Brokerage_Mailer_For_ItradePrimePlus_newMailer]  
(@Party_code varchar(20))
AS
BEGIN
	Declare @Name varchar(100)='',@Body varchar(max)='',@sub varchar(200)='',@emailto varchar(500),@emailcc varchar(max)='',@emailbcc varchar(500)
	set @emailcc = 'yogen.gandhi@angelbroking.com'
	set @emailbcc ='brokerage.intimation@angelbroking.com;codetransferemailcopies@angelbroking.com'-- 'brokerage.modification@angelbroking.com'
	
	insert into itrade_SMS_Mail_log(party_code,source,UpdatedOn)  
 select @Party_code,'Email',GETDATE()  
   
 -- Select @Name= long_name +' (' + party_code+')',  
 Select @Name = long_name,  
   @emailto=email    
 from client_details with(nolock)   
 where party_code=@Party_code 
	
	set @Body='<table align="center" border="0" cellpadding="0" cellspacing="0" style="max-width: 720px;width:100%;" width="100%">
		<tr>
			<td style="padding: 20px 20px 0 20px;background: #EBEDF0;">
				<table align="center" cellpadding="0" cellspacing="0" style="width:720px" width="100%">
					<tr>
					  <td><table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:720px;border-top-left-radius:15px;border-top-right-radius:15px;padding: 2px;background: #fff;max-width: 720px;" width="100%">
					    <tbody>
					      <tr>
					        <td align="right" style="padding:15px 10px 10px 0;text-align: right;" valign="bottom"><a><img alt="Angel One" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/logo.png" style="width:170px;"></a></td>
				          </tr>
				        </tbody>
					    </table></td>
				  </tr>
					<tr>
					  <td style="padding:30px;font-family: ''Barlow'', sans-serif;font-size: 15px;display: block;color:#4e4e4e;text-align: justify;border-bottom-left-radius:15px;border-bottom-right-radius:15px;background:#fff;">Dear [NAME],<br>
					    <br>
					    As per your request, We are pleased to change your Brokerage plan to Angel iTrade Prime Plus. The following are the revised Trading and Demat Tariff which will be applicable from the next trading day. <br>
					    <br>
					    <table cellpadding="0" cellspacing="0" width="100%" style="border: 1px solid #58CD7F">
					      <thead>
					        <tr>
					          <td colspan="2" align="center" style="padding: 5px;background:#eefaf2;color: #000;border-right: 0px solid #58CD7F;border-bottom: 1px solid #58CD7F;vertical-align: top;font-family: ''Barlow'', sans-serif;font-size: 15px;"><strong>iTrade Prime Plus </strong></td>
				            </tr>
				          </thead>
					      <tbody>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px; border-bottom: 1px solid #58CD7F;"><strong>Initial Margin</strong></td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Nil</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- DP AMC Charges @ &#8377;20 Per Traded Month</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&nbsp; </td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Online Brokerage per executed Order</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Equity Delivery</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"><strong>Value Added Services</strong></td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Call and Trade Charges per Order</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Premium Advisory</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Dedicated Relationship Manager</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Online Wealth Builder Training Program (Once a Month)</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Financial Planning </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Online Fund Transfer via Net Banking & UPI</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- ARQ  - Robo based Advisory </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Technical & Derivatives trading ideas </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Franking , KRA , CKYC ,eSignature Charges<br>
					            - Email statement /Electronic Contract notes</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">-Transactions charges for sell ( Debit) & <br>
					            - Inter-settlement  Debit per transactions</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Pledge Creation/Closure/Invocation </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Demat / Remat (Per Certificate) <br>
					            -Physical Statements request/ DIS request/Physical contract notes</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;50</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">-Cheque bounce charges </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;350</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 0px solid #58CD7F;">-Delay Payment Charges (DPC) on outstanding bill amount if not paid within due date </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 0px solid #58CD7F;">1.5% per month(levied every 15 days)</td>
				            </tr>
				          </tbody>
				        </table>
					    <br>
					    <strong>Notes :</strong><br>
					    <ul>
					      <li>Brokerage is levied per executed order across all segments.</li>
					      <li>Order value for Options is calculated as ( Strike + Premium ) x Lot size. Brokerage is also charged on expired, exercised and assigned options contract.</li>
					      <li>Stamp duty, GST, Education cess &amp; other statutory levies (if any) will be charged as applicable.</li>
					      <li>The above tariff is subject to change. Changes if any will be intimated 30 days in advance.</li>
				        </ul>
					    <br>
					    In case of any discrepancy in the above information, kindly notify us immediately on <a href="mailto:support@angelbroking.com" style="color:#0071BB;text-decoration: underline;" target="_blank">support@angelbroking.com</a> or call on <a href="tel:08047480048" style="color:#0071BB;text-decoration: underline;" target="_blank">080-47480048</a> <br>
					    <br>
					    For investment advisory, advisory@angelbroking.com <a href="mailto:advisory@angelbroking.com" style="color:#0071BB;text-decoration: underline;" target="_blank">advisory@angelbroking.com</a></td>
				  </tr>
					<tr>
						<td style="max-width:720px;width: 100%;">
							<table align="center" cellpadding="0" cellspacing="0" style="width: 100%;max-width: 720px;" width="100%">
								<tr>
								  <td align="center" valign="middle" style="font-size: 15px;color: #231f20;font-weight: 400; font-family: ''Barlow'', sans-serif;padding: 20px; vertical-align: middle; "><a href="https://www.facebook.com/OfficialAngelOne" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/FB.png" style="vertical-align: top; "></a>&nbsp; <a href="https://www.instagram.com/angelone/?utm_medium=copy_link" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Insta.png" style="vertical-align: top; "></a>&nbsp; <a href="https://twitter.com/AngelOne?t=Qx3rxyE9ZhQBJ-jSi7R3tQ&s=09" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Twitter.png" style="vertical-align: top; "></a>&nbsp; <a href="https://youtube.com/user/AngelBrokingVideos" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/YourTube.png" style="vertical-align: top; "></a>&nbsp; <a href="https://www.linkedin.com/company/angelone" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/LinkedIn.png" style="vertical-align: top; "></a>&nbsp; <a href="https://t.me/AngelOneAdvisory" target="_blank"  style="font-family: ''Barlow'', sans-serif;"  ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Telegram.png" style="vertical-align: top; "></a>&nbsp; <a href="https://wa.me/917400180180?&text=Start" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Whatsapp.png" style="vertical-align: top; "></a>&nbsp; <a href="https://www.jio.com/en-in/apps/jio-chat" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/chat.png" style="vertical-align: top; "></a></td>
							  </tr>
								<tr>
									<td align="left" style="font-size: 13px;color: #131313;font-family: ''Barlow'', sans-serif; font-weight: 400; text-align: center;padding-bottom: 20px;" valign="top">
										<a href="http://bitly.ws/oTzH" style="color: #2e51ff; text-decoration: none;font-family: ''Barlow'', sans-serif; font-size: 13px;" target="_blank">*Disclaimer</a> - Investments in securities market are subject to market risk, read<br>
										all the related documentscarefully before investing. <a href="http://bitly.ws/oTzH" style="color: #2e51ff; text-decoration: none;font-family: ''Barlow'', sans-serif; font-size: 13px;" target="_blank">Read more...</a><br>
										Copyright &copy; 2021 AngelOne. All rights Reserved.
									</td>
								</tr>
							</table>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>'


	set @sub ='REVISED BROKERAGE FOR TRADING CODE - ' +@Party_code+' '             
		  
		 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
		 @RECIPIENTS =@emailto,                              
		 --@COPY_RECIPIENTS = @emailcc,                              
		 @blind_copy_recipients=@emailbcc,
		 @PROFILE_NAME = 'AngelBroking',                              
		 @BODY_FORMAT ='HTML',                              
		 @SUBJECT = @sub ,                              
		 @FILE_ATTACHMENTS ='',                              
		 @BODY =@Body    


	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Brokerage_Mailer_new_html
-- --------------------------------------------------

-- =============================================
-- Author:		Neha Naiwar
-- Create date: 15 Apr 2019
-- Description:	Auto Mailer For Brokerage
-- =============================================
-- Usp_Brokerage_Mailer 'P99400'
create PROCEDURE [dbo].[usp_Brokerage_Mailer_new_html]
(
	@Party_code varchar(20)
)
AS
BEGIN
	Declare @Name varchar(100)='',@Body varchar(max)='',@sub varchar(200)='',@emailto varchar(500),@emailcc varchar(max)='',@emailbcc varchar(500)
	
	set @emailcc = 'neha.naiwar@angelbroking.com'
	set @emailbcc = 'nilesh@angelbroking.com'
	
	
	
	
	-- Select	@Name= long_name +' (' + party_code+')',
	Select	@Name = long_name,
			@emailto=email  
	from	client_details with(nolock) 
	where party_code=@Party_code
	
	set @Body= '<table align="center" border="0" cellpadding="0" cellspacing="0" style="max-width: 720px;width:100%;" width="100%">
		<tr>
			<td style="padding: 20px 20px 0 20px;background: #EBEDF0;">
				<table align="center" cellpadding="0" cellspacing="0" style="width:720px" width="100%">
					<tr>
					  <td><table align="center" border="0" cellpadding="0" cellspacing="0" style="min-width:720px;border-top-left-radius:15px;border-top-right-radius:15px;padding: 2px;background: #fff;max-width: 720px;" width="100%">
					    <tbody>
					      <tr>
					        <td align="right" style="padding:15px 10px 10px 0;text-align: right;" valign="bottom"><a><img alt="Angel One" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/logo.png" style="width:170px;"></a></td>
				          </tr>
				        </tbody>
					    </table></td>
				  </tr>
					<tr>
					  <td style="padding:30px;font-family: ''Barlow'', sans-serif;font-size: 15px;display: block;color:#4e4e4e;text-align: justify;border-bottom-left-radius:15px;border-bottom-right-radius:15px;background:#fff;">Dear [NAME],<br>
					    <br>
					    As per your request, we have revised your Trading &amp; Demat Tariff. Please find below the charges as applicable. <br>
					    <br>
					    <strong>TRADING BROKERAGE AND DEMAT TARIFF</strong><br>
					    <br>
					    <table cellpadding="0" cellspacing="0" width="100%" style="border: 1px solid #58CD7F">
					      <thead>
					        <tr>
					          <td colspan="2" align="center" style="padding: 5px;background: #eefaf2;color: #000;border-right: 0px solid #58CD7F;border-bottom: 1px solid #58CD7F;vertical-align: top;font-family: ''Barlow'', sans-serif;font-size: 15px;">iTrade </td>
				            </tr>
				          </thead>
					      <tbody>
					         <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- DP AMC Charges @ &#8377;20 Per Traded Month</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&nbsp; </td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px; border-bottom: 1px solid #58CD7F;"><strong>Online Brokerage per executed order</strong></td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&nbsp;</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Order value less than equal to &#8377;50,000 / order</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;15</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Order value greater than &#8377;50,000 / order</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;30</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&nbsp;</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&nbsp;</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"><strong>Value Added Services</strong></td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Call and Trade Charges per Order</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Premium Advisory</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Dedicated Relationship Manager</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Online Wealth Builder Training Program (Once a Month)</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Financial Planning </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;"></td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Online Fund Transfer via Net Banking &amp; UPI</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- ARQ  - Robo based Advisory </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Technical &amp; Derivatives trading ideas </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Email statements / Electronic contract notes</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">Free</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Transaction charges for Sell (Debit) &amp;<br>
					            Inter-settlement Debit per transaction</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Pledge Creation/Closure/Invocation/Unpledged</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Demat / Remat (Per Certificate) <br>
					            - Physical statements request/ DIS request/ Physical contract notes</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;50</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">- Cheque Bounce Charges</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 1px solid #58CD7F;">&#8377;350</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 0px solid #58CD7F;">- Delay Payment Charges (DPC) on outstanding bill amount if not paid within due date </td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-bottom: 0px solid #58CD7F;">1.5% Per month (levied every 15 days)</td>
				            </tr>
					        <tr>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 1px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-top: 1px solid #58CD7F;">- Auto square off charges</td>
					          <td align="left" style="padding: 5px;background: #fff;color: #000;border-right: 0px solid #58CD7F;font-family: ''Barlow'', sans-serif;font-size: 15px;border-top: 1px solid #58CD7F;">&#8377;20</td>
				            </tr>
				          </tbody>

				        </table>
					    <br>
					    <strong>Notes :</strong><br>
					    <ul>
					      <li>Brokerage is levied per executed order across all segments.
				          
				          </li>
					      
					      <li> Order value for Options is calculated as (Strike + Premium) x Lot size. Brokerage is also charged on expired, exercised and assigned options contract.</li>
					      <li>Stamp duty, GST, Education cess &amp; other statutory levies (if any) will be charged as applicable.</li>
					      <li>Above tariff is subject to change. Changes if any will be intimated 30 days in advance.</li>
				        </ul>
					    <br>
					    In case of any discrepancy in the above information, kindly notify us immediately on <a href="mailto:support@angelbroking.com" style="color:#0071BB;text-decoration: underline;" target="_blank">support@angelbroking.com</a> or call on <a href="tel:08047480048" style="color:#0071BB;text-decoration: underline;" target="_blank">080-47480048</a> <br>
					    <br>
					    For investment advisory, <a href="mailto:advisory@angelbroking.com" style="color:#0071BB;text-decoration: underline;" target="_blank">advisory@angelbroking.com</a></td>
				  </tr>
					<tr>
						<td style="max-width:720px;width: 100%;">
							<table align="center" cellpadding="0" cellspacing="0" style="width: 100%;max-width: 720px;" width="100%">
								<tr>
								  <td align="center" valign="middle" style="font-size: 15px;color: #231f20;font-weight: 400; font-family: ''Barlow'', sans-serif;padding: 20px; vertical-align: middle; "><a href="https://www.facebook.com/OfficialAngelOne" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/FB.png" style="vertical-align: top; "></a>&nbsp; <a href="https://www.instagram.com/angelone/?utm_medium=copy_link" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Insta.png" style="vertical-align: top; "></a>&nbsp; <a href="https://twitter.com/AngelOne?t=Qx3rxyE9ZhQBJ-jSi7R3tQ&s=09" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Twitter.png" style="vertical-align: top; "></a>&nbsp; <a href="https://youtube.com/user/AngelBrokingVideos" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/YourTube.png" style="vertical-align: top; "></a>&nbsp; <a href="https://www.linkedin.com/company/angelone" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/LinkedIn.png" style="vertical-align: top; "></a>&nbsp; <a href="https://t.me/AngelOneAdvisory" target="_blank"  style="font-family: ''Barlow'', sans-serif;"  ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Telegram.png" style="vertical-align: top; "></a>&nbsp; <a href="https://wa.me/917400180180?&text=Start" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/Whatsapp.png" style="vertical-align: top; "></a>&nbsp; <a href="https://www.jio.com/en-in/apps/jio-chat" target="_blank" style="font-family: ''Barlow'', sans-serif;" ><img alt="" src="https://absite-mumbai.s3.ap-south-1.amazonaws.com/10102023/sandesh/chat.png" style="vertical-align: top; "></a></td>
							  </tr>
								<tr>
									<td align="left" style="font-size: 13px;color: #131313;font-family: ''Barlow'', sans-serif; font-weight: 400; text-align: center;padding-bottom: 20px;" valign="top">
										<a href="http://bitly.ws/oTzH" style="color: #2e51ff; text-decoration: none;font-family: ''Barlow'', sans-serif; font-size: 13px;" target="_blank">*Disclaimer</a> - Investments in securities market are subject to market risk, read<br>
										all the related documentscarefully before investing. <a href="http://bitly.ws/oTzH" style="color: #2e51ff; text-decoration: none;font-family: ''Barlow'', sans-serif; font-size: 13px;" target="_blank">Read more...</a><br>
										Copyright &copy; 2021 AngelOne. All rights Reserved.
									</td>
								</tr>
							</table>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>'
	set @sub ='Revised Brokerage modification_testing - ' +@Party_code+' '             
		  
		 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
		 @RECIPIENTS =@emailto,                              
		 --@COPY_RECIPIENTS = @emailcc,                              
		 @blind_copy_recipients=@emailbcc,
		 @PROFILE_NAME = 'AngelBroking',                              
		 @BODY_FORMAT ='HTML',                              
		 @SUBJECT = @sub ,                              
		 @FILE_ATTACHMENTS ='',                              
		 @BODY =@Body    

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CHANGE_PASS_FRM
-- --------------------------------------------------

CREATE PROC USP_CHANGE_PASS_FRM (@ACTION VARCHAR (50)='', @USERNAME VARCHAR (50), @CPASS VARCHAR (50), @NPASS VARCHAR (50), @NVPASS VARCHAR (50) )
AS

BEGIN

IF LEN(@USERNAME)<='6'
BEGIN

IF @ACTION='SELECT'
BEGIN
	SELECT * FROM ROLEMGM.DBO.USER_LOGIN WHERE USERNAME=@USERNAME AND USERPASSWORD=@CPASS
END

IF @ACTION='UPDATE' --AND @NPASS=@NVPASS
BEGIN
	PRINT 'UPATE'
	--UPDATE ROLEMGM.DBO.USER_LOGIN SET USERPASSWORD = @NVPASS ,LOGIN_INACTIVE_DATE=GETDATE()+30 WHERE USERNAME=@USERNAME
END
END

ELSE
SELECT 'USERNAME EXCEED THE LIMIT'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CMS_GETALLDETAILS
-- --------------------------------------------------
 -- USP_CMS_GETALLDETAILS '1','15/09/2025','C','NSECM','SB','1','03014','CBHO','SB'   
CREATE PROC [DBO].[USP_CMS_GETALLDETAILS]                                                                                                
(                                                                                                
 @FLAG VARCHAR(15),                                                              
 @DATE VARCHAR(11),                        
 @DEPTYPE VARCHAR(2),                                                                                              
 @SEGMENT VARCHAR(20),                                                                                                
 @SB VARCHAR(20),                                                                                                
 @PARTYCODE VARCHAR(20),                                                    
 @BANK VARCHAR(100),                                                                                              
 @CREATEDBY VARCHAR(20),                                                                                        
 @ACCESS_TO VARCHAR(20),    
 @DDNO varchar(50)='%',    
 @AccountNo varchar(50)='%'    
)                                                                                                
AS                                                                                    
SET NOCOUNT ON                                                
                                          
                                                            
---------------------------------------------------------------------------------------------------------                                                             
IF @FLAG='1'                                                                                                
BEGIN                                                   
    -- CMS.dbo.PAYIN  where entered_by='CBHO' and depdate= '09/15/2025'  and bankcode='03014'  
   insert into tbl_tmpVoucherlog(SB,DDNO,Accno)
   values(@CREATEDBY,@DDNO,@AccountNo)

 if(@DDNO='') set @DDNO='%'  
 if(@AccountNo='' )set @AccountNo='%'  
 SELECT A.*,STATUS=CASE WHEN ISNULL(B.FLD_DDNO,'')='' THEN 'NOT PRINTED'ELSE 'PRINTED' END                                                        
 FROM                                                        
 (SELECT ENTERED_BY,SEGMENT,BANKCODE=CASE WHEN @DEPTYPE='N' THEN TARGET_ACCNO ELSE BANKCODE END,DEPTYPE=@DEPTYPE,        
  CLTCODE,DEPDATE=CONVERT(VARCHAR(11),DEPDATE,103),                                                            
  CHQDATE=CONVERT(VARCHAR(11),CHQDATE,103),DDNO,AMOUNT=CONVERT(DECIMAL(10,2),AMOUNT),ACCOUNTNO                                                            
 FROM CMS.dbo.PAYIN                                                             
 WHERE DEPDATE=CONVERT(DATETIME,@DATE,103)                              
  AND ISNULL(APP_STATUS,'')<>'R'                                
  AND ENTERED_BY=@CREATEDBY                                                    
  AND SEGMENT=@SEGMENT      
  and DDNO like isnull(@DDNO ,'%')   
  and AccountNo like isnull(@AccountNo ,'%')   
  AND  CASE WHEN @DEPTYPE='C' THEN BANKCODE                
            WHEN @DEPTYPE='N' THEN TARGET_ACCNO                
       END=@BANK              
  AND  CASE WHEN @DEPTYPE='N' THEN CLTCODE ELSE '1' END=@PARTYCODE            
  AND  ISNULL(DEPTYPE,'C')=@DEPTYPE              
  )A                                                           
  LEFT OUTER JOIN                                                        
  (SELECT DISTINCT FLD_DDNO,FLD_ACNO FROM CMS.DBO.TBL_CMS_SLIP WITH(NOLOCK)WHERE FLD_DEPDATE=CONVERT(DATETIME,@DATE,103))B                                                      
  ON A.DDNO=B.FLD_DDNO          
    AND A.ACCOUNTNO=B.FLD_ACNO          
END                                                             
---------------------------------------------------------------------------------------------------------                                                       
                                                      
---------------------------------------------------------------------------------------------------------                                                             
IF @FLAG='2'                                                                                     
BEGIN                                            
                                        
 SELECT DISTINCT SEGMENT AS SEGVALUE,                                                      
    SEGTEXT=CASE WHEN SEGMENT='ABLCM'THEN 'BSECM'                                                      
     WHEN SEGMENT='ACDLCM'THEN 'NSECM'                                           
     WHEN SEGMENT='ACDLFO'THEN 'NSEFO'                                                      
 WHEN SEGMENT='MCX'THEN 'MCX'                                                      
     WHEN SEGMENT='NCDEX'THEN 'NCDEX'                                            
     ELSE SEGMENT END                
 FROM CMS.DBO.PAYIN WITH(NOLOCK)                                                       
 WHERE DEPDATE=CONVERT(DATETIME,@DATE,103)                              
 AND   ISNULL(APP_STATUS,'')<>'R'                                          
 AND   ENTERED_BY=@CREATEDBY                      
 --AND   ISNULL(DEPTYPE,'C')=@DEPTYPE                    
                                             
END                                                             
---------------------------------------------------------------------------------------------------------                                                       
---------------------------------------------------------------------------------------------------------                                    
IF @FLAG='3'                                                        
BEGIN                                            
                  
    IF @DEPTYPE='C'                  
    BEGIN                  
     SELECT DISTINCT A.BANKCODE,B.BANKNAME                                    
     FROM CMS.DBO.PAYIN A WITH(NOLOCK)                                                    
     INNER JOIN CMS.dbo.VOUCHER_ENTRY_ACC_DETAILS B WITH(NOLOCK)                                                   
     ON A.BANKCODE=B.BANKCODE                                                 
     WHERE A.DEPDATE=CONVERT(DATETIME,@DATE,103)                                
     AND A.Segment=@SEGMENT                                    
     AND ENTERED_BY=@CREATEDBY                       
     AND ISNULL(DEPTYPE,'C')='C'                  
     AND ISNULL(APP_STATUS,'')<>'R'                  
    END                  
                      
    IF @DEPTYPE='N'                  
    BEGIN                  
     SELECT DISTINCT TARGET_ACCNO,TARGET_ACCNAME                                  
     FROM CMS.DBO.PAYIN A WITH(NOLOCK)                                                    
     WHERE A.DEPDATE=CONVERT(DATETIME,@DATE,103)                                
     AND A.Segment=@SEGMENT                                    
     AND ENTERED_BY=@CREATEDBY                              
     AND ISNULL(APP_STATUS,'')<>'R'                  
     AND ISNULL(DEPTYPE,'C')='N'                  
    END                  
                                             
END                                                             
---------------------------------------------------------------------------------------------------------                                                       
                                                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CURRSLAB_BROKERAGEMODIFICATION_UAT_04Apr2024
-- --------------------------------------------------
-- USP_CURRSLAB_BROKERAGEMODIFICATION_UAT 'R81438','cso','broker'  

create Procedure [dbo].[USP_CURRSLAB_BROKERAGEMODIFICATION_UAT_04Apr2024](@CLIENTCODE VARCHAR(50),@access_code varchar(15),@access_to varchar(15))        
as        
--select Fld_srno,Fld_partycode,Fld_VoucherAmt,Fld_BrkSlabCash,Fld_DelBrkSlabCash,        
--Future=substring(Fld_BrkSlabFO,1,charindex('/',Fld_BrkSlabFO)-1),        
--Options=substring(Fld_BrkSlabFO,charindex('/',Fld_BrkSlabFO)+1,5),        
--Com1=substring(Fld_BrkSlabCommodities,1,charindex('/',Fld_BrkSlabCommodities)-1),        
--Com2=substring(Fld_BrkSlabCommodities,charindex('/',Fld_BrkSlabCommodities)+1,5) into #file1        
--from         
--(select Fld_srno,Fld_partycode,Fld_SchemeID from tbl_prepaid_brkclientdetails)a        
--left outer join        
--(select FLd_SchemeId,Fld_VoucherAmt,Fld_BrkSlabCash,Fld_BrkSlabFO,Fld_BrkSlabCommodities,Fld_DelBrkSlabCash from tbl_prepaid_brkmaster)b        
-- on a.Fld_SchemeId=b.Fld_SchemeId        
--where Fld_Srno=@FLd_Srno        
      
      
select * into #file2 from AngelNseCM.msajag.dbo.client_brok_details where Cl_code in (@CLIENTCODE) and InActive_From>getdate()    
  
select * into #file3 from (    
   
/*BSE*/      
select  Segment='CAPITAL',Exchange='BSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
  
  
,round_to [Round To ],Normal,Trd_Del [Slab Type ]          
 from AngelBSECM.bsedb_AB.dbo.broktable where Table_no in (select Trd_Brok from #file2 where Segment='CAPITAL' and Exchange='BSE') and  Val_perc='P'         
union          
select  Segment='CAPITAL',Exchange='BSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
  
  
,round_to [Round To ],Normal,Trd_Del [Slab Type ]          
 from AngelBSECM.bsedb_AB.dbo.broktable where Table_no in (select Del_Brok from #file2 where Segment='CAPITAL' and Exchange='BSE') and  Val_perc='P'         
union  
select  Segment='CAPITAL',Exchange='BSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
  
  
,round_to [Round To ],Normal,Trd_Del [Slab Type ]          
 from AngelBSECM.bsedb_AB.dbo.broktable where Table_no in (select Trd_Brok from #file2 where Segment='CAPITAL' and Exchange='BSE') and  Val_perc='V'         
union          
select  Segment='CAPITAL',Exchange='BSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
  
  
,round_to [Round To ],Normal,Trd_Del [Slab Type ]          
 from AngelBSECM.bsedb_AB.dbo.broktable where Table_no in (select Del_Brok from #file2 where Segment='CAPITAL' and Exchange='BSE') and  Val_perc='V'  
   
union        
select  Segment='CAPITAL',Exchange='NSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from AngelNseCM.msajag.dbo.broktable where Table_no in (select Trd_Brok from #file2 where Segment='CAPITAL' and Exchange='NSE') and  Val_perc='P'       
union       
select  Segment='CAPITAL',Exchange='NSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from AngelNseCM.msajag.dbo.broktable where Table_no in (select Del_Brok from #file2 where Segment='CAPITAL' and Exchange='NSE') and  Val_perc='P'       
union   
select  Segment='CAPITAL',Exchange='NSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
  
  
,round_to [Round To ],Normal,Trd_Del [Slab Type ]          
 from AngelBSECM.bsedb_AB.dbo.broktable where Table_no in (select Trd_Brok from #file2 where Segment='CAPITAL' and Exchange='NSE') and  Val_perc='V'         
union          
select  Segment='CAPITAL',Exchange='NSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
  
  
,round_to [Round To ],Normal,Trd_Del [Slab Type ]          
 from AngelBSECM.bsedb_AB.dbo.broktable where Table_no in (select Del_Brok from #file2 where Segment='CAPITAL' and Exchange='NSE') and  Val_perc='V'  
  
union      
select  Segment='FUTURES',Exchange='NSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelfo.nsefo.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Segment='FUTURES' and Exchange='NSE') and  Val_perc='P'        
union  
select  Segment='FUTURES',Exchange='NSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelfo.nsefo.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Segment='FUTURES' and Exchange='NSE') and  Val_perc='V'        
union  
        
select  Segment='COMMODITIES',Exchange='MCX',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]
  
  
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelcommodity.MCDX.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Exchange='MCX')  and  Val_perc='P'      
union   
select  Segment='COMMODITIES',Exchange='MCX',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]
  
  
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelcommodity.MCDX.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Exchange='MCX')  and  Val_perc='V'      
   
 union       
select  Segment='COMMODITIES',Exchange='NCX',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]
  
  
  ,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelcommodity.NCDX.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Exchange='NCX') and  Val_perc='P'   
 union       
select  Segment='COMMODITIES',Exchange='NCX',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]
  
  
  ,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelcommodity.NCDX.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Exchange='NCX') and  Val_perc='V'   
   
 union       
select  Segment='FUTURES',Exchange='NSX',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelfo.nsecurfo.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Segment='FUTURES' and Exchange='NSX') and  Val_perc='P'   
  union            
select  Segment='FUTURES',Exchange='NSX',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelfo.nsecurfo.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Segment='FUTURES' and Exchange='NSX') and  Val_perc='V'   
  
union  
select  Segment='FUTURES',Exchange='MCD',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelfo.nsefo.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Segment='FUTURES' and Exchange='MCD') and  Val_perc='P'   
 union  
 select  Segment='FUTURES',Exchange='MCD',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]   
  
   
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelfo.nsefo.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Segment='FUTURES' and Exchange='MCD') and  Val_perc='V'   
    
    union       
select  Segment='FUTURES',Exchange='BSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelfo.nsefo.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Segment='FUTURES' and Exchange='BSE') and  Val_perc='P'   
     union       
select  Segment='FUTURES',Exchange='BSE',Table_No [Table No ],Line_No [Line No ],Upper_lim [Upper Limit (Rs.)],Val_perc [Val/Per ],Day_puc [Day Purchase],Day_Sales [Day Sales ],Sett_Purch [Sett. Purchase],sett_sales [Sett. Sales],def_table [Delivery ]    
,round_to [Round To ],Normal,Trd_Del [Slab Type ]        
 from angelfo.nsefo.dbo.broktable where Table_no in (select Fut_Brok from #file2 where Segment='FUTURES' and Exchange='BSE') and  Val_perc='P'   
  
union  
select Segment='OPTIONS',Exchange='NSEFO',SP_Scheme_Id [Table No ],SP_Scheme_Id [Line No ],SP_Scheme_Id [Upper Limit (Rs.)],SP_Scrip [Val/Per ],  
SP_Min_BrokAmt [Day Purchase],SP_Min_BrokAmt [Day Sales ],SP_Min_BrokAmt [Sett. Purchase],SP_Min_BrokAmt [Sett. Sales],SP_Min_BrokAmt [Delivery ]   
,SP_Scheme_Id [Round To ],SP_Min_BrokAmt,SP_Inst_Type [Slab Type ]   
from [AngelFO].nsefo.dbo.scheme_mapping  where sp_party_code in (select Cl_code from #file2) and sp_date_to>getdate()/*= @CLIENTCODE*/  
  
union  
select Segment='OPTIONS',Exchange='NSX',SP_Scheme_Id [Table No ],SP_Scheme_Id [Line No ],SP_Scheme_Id [Upper Limit (Rs.)],SP_Scrip [Val/Per ],  
SP_Min_BrokAmt [Day Purchase],SP_Min_BrokAmt [Day Sales ],SP_Min_BrokAmt [Sett. Purchase],SP_Min_BrokAmt [Sett. Sales],SP_Min_BrokAmt [Delivery ]   
,SP_Scheme_Id [Round To ],SP_Min_BrokAmt,SP_Inst_Type [Slab Type ]   
from [AngelFO].nsecurfo.dbo.scheme_mapping  where sp_party_code in (select Cl_code from #file2) and sp_date_to>getdate()/*= @CLIENTCODE*/  
  
  
  )abc  
    
/* select * from #file3 order by [Val/Per ],[Slab Type] */  
  
select  case when Segment='CAPITAL' and Exchange='BSE' then 'BSECM'   
 else case when Segment='CAPITAL' and Exchange='NSE' then 'NSECM'  
  else case when Segment='FUTURES' and Exchange='NSE' then 'NSEFO'  
   else case when Segment='COMMODITIES' and Exchange='MCX' then 'MCX'  
    else case when Segment='COMMODITIES' and Exchange='NCX' then 'NCDEX'  
else case when Segment='FUTURES' and Exchange='NSX' then 'NSX'  
else case when Segment='FUTURES' and Exchange='MCD' then 'MCD'  
else case when Segment='FUTURES' and Exchange='BSE' then 'BSEFO'  
else case when Segment='OPTIONS' and Exchange='NSEFO' then 'NSEOption'  
else case when Segment='OPTIONS' and Exchange='NSX' then 'NSXOption'  
end  
end  
  end  
 end  
 end   
 end  
 end   
 end  
end  
end  
 as 'SegmentList','N' as enteredFlag,* into #aa from #file3   
   
 update aa set enteredFlag='Y' from #aa aa join  SB_ClientModiBrk bb on aa.SegmentList=bb.segment  
 WHERE bb.ClientCode = @CLIENTCODE and convert(date,bb.UpdatedOn, 103)=convert(date, getdate(), 103)  
  
select * from #aa order by [Val/Per ],[Slab Type]   
  
 select distinct Segment,Exchange into #file4 from #file3  
  
 select case when Segment='CAPITAL' and Exchange='BSE' then 'BSECM'   
 else case when Segment='CAPITAL' and Exchange='NSE' then 'NSECM'  
  else case when Segment='FUTURES' and Exchange='NSE' then 'NSEFO'  
   else case when Segment='COMMODITIES' and Exchange='MCX' then 'MCX'  
    else case when Segment='COMMODITIES' and Exchange='NCX' then 'NCDEX'  
else case when Segment='FUTURES' and Exchange='NSX' then 'NSX'  
else case when Segment='FUTURES' and Exchange='MCD' then 'MCD'  
else case when Segment='FUTURES' and Exchange='BSE' then 'BSEFO'  
else case when Segment='OPTIONS' and Exchange='NSEFO' then 'NSEOption'  
else case when Segment='OPTIONS' and Exchange='NSX' then 'NSXOption'  
end  
end  
  end  
 end  
 end   
 end  
 end   
 end  
end  
end  
 as 'SegmentList'  
   
 from #file4

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FN_CLIENT_REPORT
-- --------------------------------------------------
      
/*  DESCRIPTION:- FN CLIENT REPORT FOR FN CLIENTS.  ORE-4781      
 REQUESTED BY :- BHAVIKA TIWARI.        
 DEVELPOED BY :- HRISHI ON 16 AUG 2025                      
*/        
CREATE PROC USP_FN_CLIENT_REPORT      
      
AS      
BEGIN      
      
SELECT * INTO #FN_CLIENT FROM RISK.DBO.CLIENT_DETAILS WHERE CL_TYPE IN ('FN')      
SELECT * INTO #CL_BROK FROM ANGELNSECM.MSAJAG.DBO.CLIENT_BROK_DETAILS WHERE CL_CODE IN (SELECT PARTY_CODE FROM #FN_CLIENT)      
SELECT SP_Party_Code,SP_Buy_Brok,SP_Sell_Brok,SP_SCHEME_ID INTO #SCHEME FROM ANGELNSECM.MSAJAG.DBO.SCHEME_MAPPING WHERE SP_Party_Code IN (SELECT PARTY_CODE FROM #FN_CLIENT) AND SP_Trd_Type='DEL'     
    
IF OBJECT_ID(N'TEMPDB..#LEDGER_DATA') IS NOT NULL      
DROP TABLE #LEDGER_DATA      
SELECT * INTO #LEDGER_DATA FROM [CSOKYC-6].GENERAL.DBO.RMS_DTCLFI WHERE PARTY_CODE IN (SELECT PARTY_CODE FROM #FN_CLIENT)    
    
IF OBJECT_ID(N'TEMPDB..#MAIN_DATA') IS NOT NULL      
DROP TABLE #MAIN_DATA      
SELECT CONVERT(DATE,RMS_DATE) AS RMS_DATE,PARTY_CODE,SUM(LEDGER) AS LEDGER      
INTO #MAIN_DATA      
FROM #LEDGER_DATA      
--WHERE PARTY_CODE ='ZR1009N'      
GROUP BY CONVERT(DATE,RMS_DATE),PARTY_CODE --1271      
    
--SELECT * FROM #CL_BROK WHERE EXCHANGE='NSE' AND SEGMENT='CAPITAL'    
     
SELECT FN.PARTY_CODE, CL_TYPE, LONG_NAME AS CLIENT_NAME,SUB_BROKER, 
CASE WHEN LAST_INACTIVE_DATE LIKE '%2049%' THEN 'ACTIVE' ELSE 'INACTIVE' END AS STATUS,
Replace(CONVERT(VARCHAR (10), FIRST_ACTIVE_DATE,103),'/','-') AS ACTIVE_DATE,
Replace(CONVERT(VARCHAR (10), INACTIVE_FROM,103),'/','-') AS INACTIVE_FROM,
S.SP_BUY_BROK AS BUY_BROKRAGE, 
S.SP_SELL_BROK AS SELL_BROKRAGE,  
CASE WHEN S.SP_SCHEME_ID='92' THEN 'ITRADE PREMIER' ELSE 'NA' END AS BROKRAGE_PLAN, 
M.LEDGER AS LEDGER_BAL    
FROM #FN_CLIENT FN INNER JOIN #CL_BROK BR ON FN.PARTY_CODE=BR.CL_CODE AND BR.EXCHANGE='NSE' AND BR.SEGMENT='CAPITAL'  
LEFT JOIN #SCHEME S ON S.SP_PARTY_CODE=FN.PARTY_CODE  
LEFT JOIN #MAIN_DATA M ON M.PARTY_CODE=FN.PARTY_CODE    
      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FN_MIS_REPORT
-- --------------------------------------------------
    
/*  DESCRIPTION:- MIS REPORT FOR FN CLIENTS.  ORE-4783  
 REQUESTED BY :- BHAVIKA TIWARI.  
 DEVELPOED BY :- HRISHI ON 16 AUG 2025  
*/      
CREATE PROC USP_FN_MIS_REPORT  ( @REPORT_TYP VARCHAR (100), @FDATE VARCHAR (11), @TDATE VARCHAR (11), @PARTY_CODE VARCHAR (50)='' )  

AS
BEGIN

--DECLARE @REPORT_TYP VARCHAR (100)='SUMMARY', @FDATE VARCHAR (11)='Aug  1 2025' , @TDATE VARCHAR (11)='Aug 20 2025' , @PARTY_CODE VARCHAR (50)=''
--DECLARE @REPORT_TYP VARCHAR (100)='DETAIL', @FDATE VARCHAR (11)='Aug  1 2025' , @TDATE VARCHAR (11)='Aug 20 2025' , @PARTY_CODE VARCHAR (50)='A1010048'

IF OBJECT_ID(N'TEMPDB..#FN_CLIENT') IS NOT NULL
DROP TABLE #FN_CLIENT
SELECT * INTO #FN_CLIENT FROM RISK.DBO.CLIENT_DETAILS WHERE cl_type IN ('FN')  OR CL_CODE IN ('ZR0050096R','A1010048')  

IF @REPORT_TYP='SUMMARY'
BEGIN

IF OBJECT_ID(N'TEMPDB..#SUMMARY_RPT_NSE') IS NOT NULL
DROP TABLE #SUMMARY_RPT_NSE
SELECT S.PARTY_CODE, TOTALAMT=SUM(S.TRDAMT), TRADEAMT=(SUM(S.TRDAMT)-SUM(S.DELAMT)) , DELAMT=SUM(DELAMT), BUYBROKERAGE = SUM(PBROKTRD), SELBROKERAGE= SUM(SBROKTRD),
BUYDELIVERYCHRG = SUM(PBROKDEL), SELLDELIVERYCHRG = SUM(SBROKDEL), TOTALBROKRAGE= (SUM(PBROKTRD)+SUM(SBROKTRD)+SUM(PBROKDEL)+SUM(SBROKDEL)), SERVICE_TAX= SUM(SERVICE_TAX), SEG='NSE'
INTO #SUMMARY_RPT_NSE
FROM ANGELNSECM.MSAJAG.DBO.CMBILLVALAN S INNER JOIN #FN_CLIENT FN ON S.PARTY_CODE=FN.CL_CODE
WHERE S.SAUDA_DATE BETWEEN @FDATE AND @TDATE
--AND S.PARTY_CODE = @PARTY_CODE
GROUP BY S.PARTY_CODE

IF OBJECT_ID(N'TEMPDB..#SUMMARY_RPT_BSE') IS NOT NULL
DROP TABLE #SUMMARY_RPT_BSE
SELECT S.PARTY_CODE, TOTALAMT=SUM(S.TRDAMT), TRADEAMT=(SUM(S.TRDAMT)-SUM(S.DELAMT)) , DELAMT=SUM(DELAMT), BUYBROKERAGE = SUM(PBROKTRD), SELBROKERAGE= SUM(SBROKTRD),
BUYDELIVERYCHRG = SUM(PBROKDEL), SELLDELIVERYCHRG = SUM(SBROKDEL), TOTALBROKRAGE= (SUM(PBROKTRD)+SUM(SBROKTRD)+SUM(PBROKDEL)+SUM(SBROKDEL)), SERVICE_TAX= SUM(SERVICE_TAX), SEG='BSE'
INTO #SUMMARY_RPT_BSE
FROM ANGELBSECM.BSEDB_AB.DBO.CMBILLVALAN S INNER JOIN #FN_CLIENT FN ON S.PARTY_CODE=FN.CL_CODE
WHERE S.SAUDA_DATE BETWEEN @FDATE AND @TDATE
--AND S.PARTY_CODE = @PARTY_CODE
GROUP BY S.PARTY_CODE

END

IF @REPORT_TYP='DETAIL'
BEGIN

IF OBJECT_ID(N'TEMPDB..#DETAIL_RPT_NSE') IS NOT NULL
DROP TABLE #DETAIL_RPT_NSE
SELECT S.PARTY_CODE, S.SCRIP_CD, S.SERIES, S.SCRIP_NAME, TOTALAMT=SUM(S.TRDAMT), TRADEAMT=(SUM(S.TRDAMT)-SUM(S.DELAMT)) , DELAMT=SUM(DELAMT), BUYBROKERAGE = SUM(PBROKTRD), SELBROKERAGE= SUM(SBROKTRD),
BUYDELIVERYCHRG = SUM(PBROKDEL), SELLDELIVERYCHRG = SUM(SBROKDEL), TOTALBROKRAGE= (SUM(PBROKTRD)+SUM(SBROKTRD)+SUM(PBROKDEL)+SUM(SBROKDEL)), SERVICE_TAX= SUM(SERVICE_TAX), SEG='NSE'
INTO #DETAIL_RPT_NSE
FROM ANGELNSECM.MSAJAG.DBO.CMBILLVALAN S INNER JOIN #FN_CLIENT FN ON S.PARTY_CODE=FN.CL_CODE
WHERE S.SAUDA_DATE BETWEEN @FDATE AND @TDATE
--AND S.PARTY_CODE = @PARTY_CODE
GROUP BY S.PARTY_CODE,S.SCRIP_CD,S.SERIES,S.SCRIP_NAME

IF OBJECT_ID(N'TEMPDB..#DETAIL_RPT_BSE') IS NOT NULL
DROP TABLE #DETAIL_RPT_BSE
SELECT S.PARTY_CODE, S.SCRIP_CD, S.SERIES, S.SCRIP_NAME, TOTALAMT=SUM(S.TRDAMT), TRADEAMT=(SUM(S.TRDAMT)-SUM(S.DELAMT)) , DELAMT=SUM(DELAMT), BUYBROKERAGE = SUM(PBROKTRD), SELBROKERAGE= SUM(SBROKTRD),
BUYDELIVERYCHRG = SUM(PBROKDEL), SELLDELIVERYCHRG = SUM(SBROKDEL), TOTALBROKRAGE= (SUM(PBROKTRD)+SUM(SBROKTRD)+SUM(PBROKDEL)+SUM(SBROKDEL)), SERVICE_TAX= SUM(SERVICE_TAX), SEG='BSE'
INTO #DETAIL_RPT_BSE
FROM ANGELBSECM.BSEDB_AB.DBO.CMBILLVALAN S INNER JOIN #FN_CLIENT FN ON S.PARTY_CODE=FN.CL_CODE
WHERE S.SAUDA_DATE BETWEEN @FDATE AND @TDATE
--AND S.PARTY_CODE = @PARTY_CODE
GROUP BY S.PARTY_CODE,S.SCRIP_CD,S.SERIES,S.SCRIP_NAME

END


IF ( @REPORT_TYP='SUMMARY' AND @PARTY_CODE <>'' )			---- SUMMARY REPORT ALL
BEGIN
	PRINT 'IN line 71'
	SELECT * FROM #SUMMARY_RPT_NSE WHERE PARTY_CODE=@PARTY_CODE
	UNION ALL
	SELECT * FROM #SUMMARY_RPT_BSE WHERE PARTY_CODE=@PARTY_CODE
END
IF ( @REPORT_TYP='SUMMARY' AND @PARTY_CODE = '' )			---- SUMMARY REPORT PARTY CODE WISE
BEGIN
	PRINT 'IN line 79'
	SELECT * FROM #SUMMARY_RPT_NSE
	UNION ALL
	SELECT * FROM #SUMMARY_RPT_BSE
END


IF ( @REPORT_TYP='DETAIL' AND @PARTY_CODE <>'' )			---- DETAIL REPORT
BEGIN
	PRINT 'IN line 88'
	SELECT * FROM #DETAIL_RPT_NSE WHERE PARTY_CODE=@PARTY_CODE
	UNION ALL
	SELECT * FROM #DETAIL_RPT_BSE WHERE PARTY_CODE=@PARTY_CODE
END
IF ( @REPORT_TYP='DETAIL' AND @PARTY_CODE = '' )			---- DETAIL REPORT PARTY CODE WISE
BEGIN
	PRINT 'IN line 96'
	SELECT * FROM #DETAIL_RPT_NSE
	UNION ALL
	SELECT * FROM #DETAIL_RPT_BSE
END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FN_TRADE_REPORT
-- --------------------------------------------------
    
/*  DESCRIPTION:- TRADE REPORT FOR FN CLIENTS.    
 REQUESTED BY :- BHAVIKA TIWARI.    
 DEVELPOED BY :- HRISHI ON 16 AUG 2025                  
*/    
    
CREATE PROC USP_FN_TRADE_REPORT (@SAUDA_DATE VARCHAR (11))    
    
AS    
BEGIN    
  
--DECLARE @SAUDA_DATE VARCHAR (11)='AUG 18 2025'  
  
SELECT CL_CODE AS PARTY_CODE, CL_TYPE, PAN_GIR_NO AS PAN_NUMBER, L_ADDRESS1+','+L_ADDRESS2+','+L_ADDRESS3+','+L_CITY+','+L_NATION AS CLIENT_ADDRESS ,CltDpId1 AS DPID      
INTO #FN_CODE FROM ANGELNSECM.MSAJAG.DBO.CLIENT_DETAILS WHERE CL_TYPE IN ('FN') OR  PARTY_CODE ='ZR1628R'  
  
SELECT *,SELL_BUY=( CASE PAMT WHEN 0 THEN 'SELL' ELSE 'BUY' END )  
INTO   #NSE    
FROM   ANGELNSECM.MSAJAG.DBO.CMBILLVALAN    
WHERE  (PARTY_CODE IN (SELECT PARTY_CODE FROM #FN_CODE) OR PARTY_CODE ='ZR1628R')    
AND SAUDA_DATE =  @SAUDA_DATE    
    
SELECT *,SELL_BUY=( CASE PAMT WHEN 0 THEN 'SELL' ELSE 'BUY' END )    
INTO   #BSE    
FROM   ANGELBSECM.BSEDB_AB.DBO.CMBILLVALAN    
WHERE  (PARTY_CODE IN (SELECT PARTY_CODE FROM #FN_CODE) OR PARTY_CODE ='ZR1628R')    
AND SAUDA_DATE =  @SAUDA_DATE    
    
CREATE TABLE #ALL_DATA    
(    
SETT_NO VARCHAR (50),    
SETT_TYPE VARCHAR (50),    
EXCHANGE VARCHAR (50),    
SEGMENT VARCHAR (50),    
PARTY_CODE VARCHAR (50),    
CONTRACTNO VARCHAR (50),    
PARTY_NAME VARCHAR (50),    
SAUDA_DATE DATETIME,    
PAMT MONEY,    
SAMT MONEY,    
SELL_BUY VARCHAR (50)    
)    
    
INSERT INTO #ALL_DATA    
SELECT SETT_NO, SETT_TYPE,EXCHANGE, SEGMENT, PARTY_CODE, CONTRACTNO, MIN(PARTY_NAME) PARTY_NAME, SAUDA_DATE, SUM(PAMT) PAMT, SUM(SAMT) SAMT,SELL_BUY    
FROM   #NSE                          
GROUP  BY PARTY_CODE, CONTRACTNO, SAUDA_DATE, SELL_BUY, SETT_NO, SETT_TYPE,EXCHANGE, SEGMENT    
    
INSERT INTO #ALL_DATA    
SELECT SETT_NO, SETT_TYPE,EXCHANGE, SEGMENT, PARTY_CODE, CONTRACTNO, MIN(PARTY_NAME) PARTY_NAME, SAUDA_DATE, SUM(PAMT) PAMT, SUM(SAMT) SAMT,SELL_BUY    
FROM   #BSE                          
GROUP  BY PARTY_CODE, CONTRACTNO, SAUDA_DATE, SELL_BUY, SETT_NO, SETT_TYPE,EXCHANGE, SEGMENT    
    
--SELECT * FROM #ALL_DATA    
    
TRUNCATE TABLE TBL_FNTRADE_REPORTS    
    
INSERT INTO TBL_FNTRADE_REPORTS    
SELECT CAST (A.SAUDA_DATE+1 AS VARCHAR (11)) AS SETTLEMENT_DATE, A.SETT_NO, A.PARTY_CODE, A.CONTRACTNO AS ECN, A.EXCHANGE AS SEGMENT, CAST (A.SAUDA_DATE AS VARCHAR (11)) AS BILL_DATE, SELL_BUY, 
CASE WHEN SELL_BUY = 'BUY' THEN PAMT ELSE SAMT END AS AMOUNT, F.CL_TYPE, F.DPID,     
A.PARTY_NAME AS CLIENT_NAME, F.PAN_NUMBER, F.CLIENT_ADDRESS, C.FLD_BANK_NAME, C.FLD_BANK_ADDRESS, C.FLD_BANK_ACCOUNT_NO ,C.FLD_SWIFTID, C.FLD_IBAN_NUMBER, C.FLD_SORT_CODE,    
C.FLD_CURRENCY_REMITTANCE, B.FLD_BROKER_BANK_CODE, B.FLD_BROKER_BANK_NAME, B.FLD_BROKER_BANK_ACC_NO, 'ANGEL ONE LIMITED' AS [BROKER],  
'6th Floor, Ackruti Star, Central Road, MIDC, Andheri East, Mumbai - 400093' AS BROKER_ADDRESS    
FROM #ALL_DATA A LEFT JOIN #FN_CODE F ON A.PARTY_CODE=F.PARTY_CODE    
LEFT JOIN [TBL_FNCLIENTMASTER] C ON A.PARTY_CODE=C.FLD_CLIENT_CODE    
LEFT JOIN [TBL_FNBANKMASTER] B ON C.FLD_BANKID=B.FLD_SRNO    
    
SELECT * FROM TBL_FNTRADE_REPORTS    
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FNBANKMASTER_DML
-- --------------------------------------------------


--// DESCRIPTION :- TO FETCH FN BANK MASTER AND INSERT/UPDATE OPERTION FROM FRONTEND  
--// CREATED BY  :- HRISHI ON 14 AUG 2025  

CREATE PROC [DBO].[USP_FNBANKMASTER_DML]
(
@ACTION VARCHAR (50),
@BROKER_BANK_CODE VARCHAR (50),
@BROKER_BANK_NAME VARCHAR (50),
@BROKER_BANK_ACC_NO VARCHAR (50),
@ISACTIVE VARCHAR (50)
)
AS  
BEGIN  

----DECLARE @ACTION VARCHAR (50)='GETDATA',
----@BROKER_BANK_CODE VARCHAR (50)='2',
----@BROKER_BANK_NAME VARCHAR (50)='TEST',
----@BROKER_BANK_ACC_NO VARCHAR (50)='0100',
----@ISACTIVE VARCHAR (50)='0'

IF @ACTION='GETDATA'
BEGIN
SELECT FLD_SRNO, FLD_BROKER_BANK_CODE, FLD_BROKER_BANK_NAME, FLD_BROKER_BANK_ACC_NO, CASE WHEN ISACTIVE='1' THEN 'ACTIVE' ELSE 'INACTIVE' END AS ISACTIVE,FLD_INSERTED_ON, FLD_MODIFIED_ON
FROM [TBL_FNBANKMASTER] WHERE FLD_BROKER_BANK_NAME LIKE '%'+ @BROKER_BANK_NAME +'%' 
END

IF @ACTION='INSERT'
BEGIN
INSERT INTO [TBL_FNBANKMASTER] VALUES ( @BROKER_BANK_CODE,@BROKER_BANK_NAME,@BROKER_BANK_ACC_NO,1,GETDATE(),NULL,NULL)

SELECT 'RECORD SAVED' AS MSG   
END

IF @ACTION='UPDATE'
BEGIN
UPDATE [TBL_FNBANKMASTER] SET FLD_BROKER_BANK_NAME=@BROKER_BANK_NAME, FLD_BROKER_BANK_ACC_NO=@BROKER_BANK_ACC_NO,ISACTIVE=@ISACTIVE, FLD_MODIFIED_ON=GETDATE(), FLD_MODIFIED_BY=HOST_NAME()
WHERE FLD_BROKER_BANK_CODE=@BROKER_BANK_CODE

SELECT 'RECORD UPDATE' AS MSG
END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FNCLIENTMASTER_DML
-- --------------------------------------------------
  
--// DESCRIPTION :- TO FETCH FN CLIENTS AND DML OPERTION FROM FRONTEND    
--// CREATED BY  :- HRISHI ON 14 AUG 2025    
  
CREATE PROC [dbo].[USP_FNCLIENTMASTER_DML]   
(  
@ACTION VARCHAR (50),  
@BANKID INT ,  
@CLIENT_CODE VARCHAR (50),  
@SWIFTID VARCHAR (50),  
@IBAN_NUMBER VARCHAR (50),  
@SORT_CODE VARCHAR (50),  
@CURRENCY_REMITTANCE VARCHAR (50),  
@BANK_NAME VARCHAR (50),  
@BANK_ACCOUNT_NO BIGINT,  
@BANK_ADDRESS VARCHAR (100)  
)  
AS    
BEGIN    
  
----DECLARE @ACTION VARCHAR (50)='GETDATA',  
----@BANKID INT ='2',  
----@CLIENT_CODE VARCHAR (50)='TEST002',  
----@SWIFTID VARCHAR (50)='SWIFT_TEST02',  
----@IBAN_NUMBER VARCHAR (50)='dwdw',  
----@SORT_CODE VARCHAR (50)='grdgt',  
----@CURRENCY_REMITTANCE VARCHAR (50)='feaf',  
----@BANK_NAME VARCHAR (50)='eagse',  
----@BANK_ACCOUNT_NO BIGINT='008',  
----@BANK_ADDRESS VARCHAR (100)='feafe'  
  
  
IF @ACTION='GETDATA'  
BEGIN  
SELECT FLD_BANKID, FLD_CLIENT_CODE, FLD_SWIFTID, FLD_IBAN_NUMBER, FLD_SORT_CODE, FLD_CURRENCY_REMITTANCE, FLD_BANK_NAME, FLD_BANK_ACCOUNT_NO, FLD_BANK_ADDRESS   
FROM [TBL_FNCLIENTMASTER] WHERE FLD_CLIENT_CODE=@CLIENT_CODE  
END  
  
IF @ACTION='INSERT'  
BEGIN  
INSERT INTO [TBL_FNCLIENTMASTER] VALUES ( @BANKID,@CLIENT_CODE,@SWIFTID,@IBAN_NUMBER,@SORT_CODE,@CURRENCY_REMITTANCE,@BANK_NAME,@BANK_ACCOUNT_NO,@BANK_ADDRESS,GETDATE(),NULL,NULL)  
  
SELECT 'RECORD SAVED' AS MSG     
END  
  
IF @ACTION='UPDATE'  
BEGIN  
UPDATE [TBL_FNCLIENTMASTER] SET FLD_SWIFTID=@SWIFTID, FLD_IBAN_NUMBER=@IBAN_NUMBER, FLD_SORT_CODE=@SORT_CODE, FLD_CURRENCY_REMITTANCE=@CURRENCY_REMITTANCE,  
FLD_BANK_NAME=@BANK_NAME, FLD_BANK_ACCOUNT_NO=@BANK_ACCOUNT_NO, FLD_BANK_ADDRESS=@BANK_ADDRESS, FLD_MODIFIED_ON=GETDATE(), FLD_MODIFIED_BY=HOST_NAME()  
WHERE FLD_CLIENT_CODE=@CLIENT_CODE  
  
SELECT 'RECORD UPDATE' AS MSG  
END  
  
----IF @ACTION='DELETE'  
----BEGIN  
----DELETE FROM [TBL_FNCLIENTMASTER] WHERE FLD_CLIENT_CODE=@CLIENT_CODE  
  
----SELECT 'RECORD DELETED' AS MSG  
----END  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Get_FDSClientTradeDetails_test
-- --------------------------------------------------
--exec USP_Get_FDSClientTradeDetails_test

CREATE procedure  [dbo].[USP_Get_FDSClientTradeDetails_test]

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	 Declare @TradeDate Date 
	 select @TradeDate = Tradedate from [RISK].dbo.FDS_ClientDetailsForEmail
	
	select Party_code,Symbol,Type,Option_Type,ExpiryDate,Strike_Price,Pqty,Prate,Sqty,Srate,Brokerage,TotalTax,convert(varchar(100),SAUDA_DATE,106) as SAUDA_DATE into #temp from
	(

		(select  Party_code,SCRIP_CD as Symbol,SERIES as Type,'' as Option_Type,'' as ExpiryDate,'' as Strike_Price,(PQTYTRD + PQTYDEL) as Pqty,
		case when (PQTYTRD + PQTYDEL) != 0 then Round(((PAMTTRD + PAMTDEL)/(PQTYTRD + PQTYDEL)),2) else (PQTYTRD + PQTYDEL) end as PRate,
		(SQTYTRD + SQTYDEL) as Sqty,
		case when (SQTYTRD + SQTYDEL) != 0 then Round(((SAMTTRD + SAMTDEL)/(SQTYTRD + SQTYDEL)),2) else (SQTYTRD + SQTYDEL) end as SRate ,
		Round((PBROKTRD + SBROKTRD + PBROKDEL + SBROKDEL),2) as Brokerage, Round((SERVICE_TAX+EXSERVICE_TAX+TURN_TAX+SEBI_TAX+INS_CHRG + BROKER_CHRG),2) as TotalTax,convert(varchar(100),SAUDA_DATE,106) as SAUDA_DATE
		from AngelNseCM.msajag.dbo.cmbillvalan
		where Party_code in (select ClientCode from [RISK].dbo.FDS_ClientDetailsForEmail where ClientCode = 'DHJH3200') and convert(date,SAUDA_DATE)= @TradeDate and Tradetype in ('BT','S')
	)
	union 
	Select Party_code,Symbol,Inst_Type as Type,Option_Type,convert(varchar,ExpiryDate,103)as ExpiryDate,convert(varchar(100),Strike_Price),Pqty,Round(Prate,2)Prate,Sqty,Round(SRate,2)SRate,Round(Brokerage,2)Brokerage,Round(OTHER_CHRG,2) as TotalTax,convert(varchar(100),SAUDA_DATE,106) as SAUDA_DATE from
	(	
			select Party_code,Symbol,ExpiryDate,Inst_Type,Option_Type,cast(Strike_Price as int)Strike_Price,sum(Pqty)Pqty,sum(Prate)Prate,sum(Sqty)Sqty,sum(SRate)SRate,sum((PBrokAmt + SBrokAmt)) as Brokerage,sum(Service_Tax+ExSer_Tax+InExSerFlag+sebi_tax+turn_tax+Broker_note+Ins_Chrg+Other_Chrg) as OTHER_CHRG,SAUDA_DATE 
			from angelfo.nsecurfo.dbo.fobillvalan with (nolock)where Party_code in (select ClientCode from [RISK].dbo.FDS_ClientDetailsForEmail where ClientCode = 'DHJH3200') and convert(date,SAUDA_DATE)=@TradeDate and Tradetype in ('BT','S')
			group by party_code,Symbol,Inst_Type,Option_Type,ExpiryDate,SAUDA_DATE,Strike_Price
			union all
			select Party_code,Symbol,ExpiryDate,Inst_Type,Option_Type,cast(Strike_Price as int)Strike_Price,sum(Pqty)Pqty,sum(Prate)Prate,sum(Sqty)Sqty,sum(SRate)SRate,sum(PBrokAmt + SBrokAmt) as Brokerage,sum(Service_Tax+ExSer_Tax+InExSerFlag+sebi_tax+turn_tax+Broker_note+Ins_Chrg+Other_Chrg) as OTHER_CHRG,SAUDA_DATE 
			from angelfo.nsefo.dbo.fobillvalan with (nolock) where Party_code in (select ClientCode from [RISK].dbo.FDS_ClientDetailsForEmail where ClientCode = 'DHJH3200') and convert(date,SAUDA_DATE)=@TradeDate and Tradetype in ('BT','S')
			group by party_code,Symbol,Inst_Type,Option_Type,ExpiryDate,SAUDA_DATE,Strike_Price
			union all
			select Party_code,Symbol,ExpiryDate,Inst_Type,Option_Type,cast(Strike_Price as int)Strike_Price,sum(Pqty)Pqty,sum(Prate)Prate,sum(Sqty)Sqty,sum(SRate)SRate,sum(PBrokAmt + SBrokAmt) as Brokerage,sum(Service_Tax+ExSer_Tax+InExSerFlag+sebi_tax+turn_tax+Broker_note+Ins_Chrg+Other_Chrg) as OTHER_CHRG,SAUDA_DATE 
			from angelcommodity.mcdx.dbo.fobillvalan with (nolock) where Party_code in (select ClientCode from [RISK].dbo.FDS_ClientDetailsForEmail where ClientCode = 'DHJH3200') and convert(date,SAUDA_DATE)=@TradeDate and Tradetype in ('BT','S')
			group by party_code,Symbol,Inst_Type,Option_Type,ExpiryDate,SAUDA_DATE,Strike_Price
			union all
			select Party_code,Symbol,ExpiryDate,Inst_Type,Option_Type,cast(Strike_Price as int)Strike_Price,sum(Pqty)Pqty,sum(Prate)Prate,sum(Sqty)Sqty,sum(SRate)SRate,sum(PBrokAmt + SBrokAmt) as Brokerage,sum(Service_Tax+ExSer_Tax+InExSerFlag+sebi_tax+turn_tax+Broker_note+Ins_Chrg+Other_Chrg) as OTHER_CHRG,SAUDA_DATE 
			from angelcommodity.ncdx.dbo.fobillvalan with (nolock) where Party_code in (select ClientCode from [RISK].dbo.FDS_ClientDetailsForEmail where ClientCode = 'DHJH3200') and convert(date,SAUDA_DATE)=@TradeDate and Tradetype in ('BT','S')
			group by party_code,Symbol,Inst_Type,Option_Type,ExpiryDate,SAUDA_DATE,Strike_Price
		) a 
	) b where (Pqty != 0 or Sqty != 0) order by Party_code,Type,Symbol


	select LTRIM(RTRIM(t.Party_code))Party_code,Symbol,Type,Option_Type,ExpiryDate,Strike_Price,Pqty,Prate,Sqty,Srate,Brokerage,TotalTax,SAUDA_DATE,C.email
	from #temp t
	inner join [Risk].dbo.client_Details C on t.Party_code = C.party_code

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getAPList
-- --------------------------------------------------
CREATE proc [dbo].[usp_getAPList]      
(  
@Auditor as varchar(20)=null,  
@SBtag as varchar(20)=null,  
@AuditObservation as varchar(50)='ALL',  
@AuditStatus  as varchar(20)='ALL' ,  
@startdate  as varchar(25)=null,  
@todate  as varchar(25)=null,  
@CompletionStartdate  as varchar(25)=null,  
@CompletionEnddate  as varchar(25)=null,  
@flag  as varchar(25)=null  
)  
AS      
BEGIN      
  
if(@CompletionEnddate is not null and @CompletionEnddate !='')  
 Begin  
 set @CompletionEnddate = @CompletionEnddate +' 23:50:50'  
 End  
 if(@todate is not null and @todate !='')  
 Begin  
 set @todate = @todate +' 23:50:50'  
 End  
  
 if(@Auditor='')  
 set @Auditor=null  
  
 if(@SBtag='')  
 set @SBtag = null  
  
 if(@AuditStatus='All')  
 set @AuditStatus =null  
  
 if(@AuditObservation='All' or @AuditObservation='')  
 set @AuditObservation =null  

 declare  @CompletionStartdatetemp as varchar(25)=@CompletionStartdate
  
 select  @startdate =case when @startdate is null  or @startdate='' then Convert(varchar,min(AuditStartDate),103) else @startdate end,   
     @todate= case when @todate is null  or @todate='' then convert(varchar,max(AuditStartDate),103) else @todate end, 
     @CompletionStartdate =case when @CompletionStartdate is null or @CompletionStartdate='' then Convert(varchar,min(AuditCompleteddate),103) else @CompletionStartdate end ,   
     @CompletionEnddate= case when @CompletionEnddate is null or @CompletionEnddate='' then convert(varchar,max(AuditCompleteddate),103) else @CompletionEnddate end   
 from tbl_SBPlannedAuditMIS  
  
  --print (@startdate)
  --print(@todate)
  --print (@CompletionStartdate)
  --print(@CompletionEnddate)
  
  
if (@flag is null)  
Begin  
  
 select APTag,FY,Convert(varchar,AuditStartDate,103)AuditStartDate,AuditorID,AuditorName,AuditStatus,Convert(varchar,AuditCompleteddate,103)AuditCompleteddate,      
 AuditObservation,replace(replace(AuditFile,'\\INHOUSELIVEAPP1-FS.angelone.in\','//rm.angelbroking.com/'),'\','/') Auditfile,    
 case when Auditfile='' then '' else 'AuditPDF_'+APTag end ApAuditLink    
 from dbo.tbl_SBPlannedAuditMIS  
 where AuditorID= isnull(@Auditor,AuditorID)  
  and  APTag = isnull(@SBtag,APTag)  
  and AuditObservation  = isnull(@AuditObservation,AuditObservation)  
  and AuditStatus = isnull(@AuditStatus,AuditStatus)  
  and AuditStartDate between Convert(datetime,@startdate,103) and Convert(datetime,@todate,103)  
  and (isnull(AuditCompleteddate,'') = isnull(Convert(datetime,@CompletionStartdatetemp,103),'') 
   or AuditCompleteddate between Convert(datetime,@CompletionStartdate,103) and Convert(datetime,@CompletionEnddate,103)  
  )
End  
Else  
 Begin  
  
 truncate table tbl_SBPlannedAuditMIS_dwnload  
  
 insert into tbl_SBPlannedAuditMIS_dwnload  
 select 'APTag','FY','AuditStartDate','AuditorID','AuditorName','AuditStatus','AuditCompleteddate','AuditObservation','Auditfile'  
  
 insert into tbl_SBPlannedAuditMIS_dwnload  
 select APTag,FY,Convert(varchar,AuditStartDate,103)AuditStartDate,AuditorID,AuditorName,AuditStatus,Convert(varchar,AuditCompleteddate,103)AuditCompleteddate,      
AuditObservation,replace(replace(AuditFile,'\\INHOUSELIVEAPP1-FS.angelone.in\','//rm.angelbroking.com/'),'\','/') Auditfile    
--case when Auditfile='' then '' else 'AuditPDF_'+APTag end ApAuditLink  
from dbo.tbl_SBPlannedAuditMIS  
where AuditorID= isnull(@Auditor,AuditorID)  
 and  APTag = isnull(@SBtag,APTag)  
 and AuditObservation  = isnull(@AuditObservation,AuditObservation)  
 and AuditStatus = isnull(@AuditStatus,AuditStatus)  
 and AuditStartDate between Convert(datetime,@startdate,103) and Convert(datetime,@todate,103)  
  and (isnull(AuditCompleteddate,'') = isnull(Convert(datetime,@CompletionStartdatetemp,103),'') 
  or AuditCompleteddate between Convert(datetime,@CompletionStartdate,103) and Convert(datetime,@CompletionEnddate,103)  
  )
   
  DECLARE @BCPCOMMAND1 VARCHAR(500)              
  --declare @s2 as varchar(max)                              
  DECLARE @filename2 as varchar(100)              
                   
                               
  SET @FILENAME2 = '\\INHOUSELIVEAPP1-FS.angelone.in\upload1\SBAuditAPList\ApAuditList_'+replace (convert (varchar(12),GETDATE(),103),'/','')+'.csv'                                                                                             
  --SET @FILENAME = '\\196.1.115.182\upload1\OmnesysFileFormat\CodeCreationFileFormat'+replace (convert (varchar(12),GETDATE(),103),'/','')+'.txt'                  
                                                            
                                
  SET @BCPCOMMAND1 = 'BCP "select * from dustbin.dbo.tbl_SBPlannedAuditMIS_dwnload " QUERYOUT "'                              
     print(@BCPCOMMAND1)                        
  SET @BCPCOMMAND1 = @BCPCOMMAND1 + @FILENAME2 + '" -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                    
  EXEC MASTER..XP_CMDSHELL @BCPCOMMAND1         
    
  select replace(@FILENAME2,'INHOUSELIVEAPP1-FS.angelone.in','rm.angelbroking.com')   
  
End  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetFile_IMP
-- --------------------------------------------------
CREATE procedure usp_GetFile_IMP                
 (                
                 
    @tag varchar(20)                
  ,@flag varchar(20)        
  ,@seg varchar(20)            
   ,@ID int              
 )                
 AS                
                 
if(@flag='chqimage')                
 begin                
                
  if(@ID=0)              
  begin              
   select Distinct ChqImage as File_Name,ChqAttach as  File_Content  from tbl_rtgs_subbroker                
   where fld_sub_code=@tag    and   fld_segment=@seg        
  end              
                
  else              
   begin               
    select Distinct ChqImage as File_Name,ChqAttach as  File_Content  from tbl_rtgs_subbroker_log                
   where fld_sub_code=@tag   and   fld_segment=@seg                
  end              
                
                
end                 
                
if(@flag='otherimage')                
 begin                
                
  if(@ID=0)              
  begin              
  select Distinct OtherImage as File_Name,OtherAttach as  File_Content  from tbl_rtgs_subbroker                 
 where fld_sub_code=@tag   and  fld_segment=@seg             
 end                
                 
   else              
   begin               
    select Distinct OtherImage as File_Name,OtherAttach as  File_Content  from tbl_rtgs_subbroker_log              
    where fld_sub_code=@tag    and  fld_segment=@seg            
   end               
                  
                  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetFile_IMP_MFSB
-- --------------------------------------------------
CREATE procedure usp_GetFile_IMP_MFSB                  
 (                  
                   
    @tag varchar(20)                  
  ,@flag varchar(20)          
  ,@seg varchar(20)              
   ,@ID int                
 )                  
 AS                  
                   
if(@flag='chqimage')                  
 begin                  
                  
  if(@ID=0)                
  begin                
   select Distinct ChqImage as File_Name,ChqAttach as  File_Content  from TBL_RTGS_SUBBROKER_MFSB                  
   where fld_sub_code=@tag    and   fld_segment=@seg          
  end                
                  
  else                
   begin                 
    select Distinct ChqImage as File_Name,ChqAttach as  File_Content  from tbl_rtgs_subbroker_MFSB_log                  
   where fld_sub_code=@tag   and   fld_segment=@seg                  
  end                
                  
                  
end                   
                  
if(@flag='otherimage')                  
 begin                  
                  
  if(@ID=0)                
  begin                
  select Distinct OtherImage as File_Name,OtherAttach as  File_Content  from TBL_RTGS_SUBBROKER_MFSB                   
 where fld_sub_code=@tag   and  fld_segment=@seg               
 end                  
                   
   else                
   begin                 
    select Distinct OtherImage as File_Name,OtherAttach as  File_Content  from tbl_rtgs_subbroker_MFSB_log                
    where fld_sub_code=@tag    and  fld_segment=@seg              
   end                 
                    
                    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetFile_MFSB
-- --------------------------------------------------
CREATE procedure usp_GetFile_MFSB                        
 (                        
                         
    @tag varchar(20)            
    ,@seg varchar(20)          
    ,@acc varchar(30)                      
  ,@flag varchar(20)                        
   ,@ID int                      
 )                        
 AS                        
                         
if(@flag='chqimage')                        
 begin                        
                        
  if(@ID=0)                      
  begin                      
   select Distinct ChqImage as File_Name,ChqAttach as  File_Content  from TBL_RTGS_SUBBROKER_MFSB                         
   where fld_sub_code=@tag       and fld_segment=@seg  and Fld_Bank_AcNo=@acc     
                 
  end                      
                        
  else                      
   begin                       
    select Distinct ChqImage as File_Name,ChqAttach as  File_Content  from tbl_rtgs_subbroker_MFSB_log                        
   where fld_sub_code=@tag  and fld_segment=@seg and Fld_Bank_AcNo=@acc     
                   
  end                      
                        
                        
end                         
                        
if(@flag='otherimage')                        
 begin                        
                        
  if(@ID=0)                      
  begin                      
  select Distinct OtherImage as File_Name,OtherAttach as  File_Content  from TBL_RTGS_SUBBROKER_MFSB                       
 where fld_sub_code=@tag   and fld_segment=@seg    and Fld_Bank_AcNo=@acc     
     
               
 end                        
                         
   else                      
   begin                       
    select Distinct OtherImage as File_Name,OtherAttach as  File_Content  from tbl_rtgs_subbroker_MFSB_log                      
    where fld_sub_code=@tag  and fld_segment=@seg            and Fld_Bank_AcNo=@acc    
        
   end                       
                          
                          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetKotakClientMappingDetails
-- --------------------------------------------------
CREATE PROCEDURE usp_GetKotakClientMappingDetails
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        ROW_NUMBER() OVER (ORDER BY A.Fld_ClientCode) AS SRNO,
        B.long_name AS NAME,
        A.Fld_ClientPISAc AS PIS_ACCOUNT_NUMBER,
        A.Fld_ClientCode AS TRADING_CODE,
        'KOTAK MAHINDRA BANK' AS Branch
    FROM 
        tbl_NRIClientMaster A
    JOIN 
        risk.dbo.client_Details B 
        ON A.Fld_ClientCode = B.cl_code
    WHERE 
        A.fld_bankid = 102;
END;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetMinBidRate
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[usp_GetMinBidRate] 
	 @ScripNo INT =0
AS
BEGIN
	SELECT MinBidRate FROM OFS_ScripMaster WHERE Srno = @ScripNo
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getSebPayoutSMScount
-- --------------------------------------------------
 CREATE proc usp_getSebPayoutSMScount      
 AS      
 BEGIN      
   Select count(1) SMScount, sum(b.SegApprovedAmt)Amount from [SebiPayout].sebi.dbo.tbl_SebiProcessedSMS a --where  bank_gen=1  
   left outer join [SebiPayout].sebi.dbo.SEBI_PayoutAppAmt b on a.party_code=b.party_code
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_InternalauditMISReport
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[usp_InternalauditMISReport]  
    @FromDate VARCHAR(50),  
    @ToDate VARCHAR(50),  
    @SbTag VARCHAR(10)  
AS  
BEGIN  
    SET NOCOUNT ON;  
  DECLARE @StartDate DATETIME;  
    DECLARE @EndDate DATETIME;  

	--set @ToDate = @ToDate + ' 23:50:50'
 SET @StartDate = TRY_CONVERT(DATETIME, @FromDate, 101);  
    SET @EndDate = TRY_CONVERT(DATETIME, @ToDate, 101);  
	 set @EndDate= @EndDate + ' 23:50:50'
    -- Validate parameters  
    SELECT  distinct
    SB.sbtag AS APTag,  
    SB.tradename AS APName,  
    Convert(varchar,SBA.updateddate,103) as AuditSubmitDate,  
  COALESCE(  
        CASE   
            WHEN LEFT(SBA.updatedby, 1) = 'E' THEN APD.AuditorsName   
            WHEN CHARINDEX('E', SBA.updatedby) > 0 AND CHARINDEX(' ', SBA.updatedby, CHARINDEX('E', SBA.updatedby)) = CHARINDEX('E', SBA.updatedby) + 1  
                THEN (SELECT AuditorsName FROM  SBAudit.[dbo].[tbl_APDetails] WHERE emp_no = SUBSTRING(SBA.updatedby, CHARINDEX('E', SBA.updatedby), LEN(SBA.updatedby) - CHARINDEX('E', SBA.updatedby) + 1))  
            ELSE SBA.updatedby   
        END,  
        SBA.updatedby  
    ) AS updatedby ,   
    Asts.AuditStatus,  
     replace(replace(Logs.Filepath,'INHOUSELIVEAPP1-FS.angelone.in','rm.angelbroking.com'),'\','/') AS Filepath  
FROM  
SBAudit.[dbo].[tbl_SubBrokerAuditAnswers] SBA WITH (NOLOCK)  
 left outer JOIN  
    [MIS].sb_comp.dbo.sb_broker SB WITH (NOLOCK) ON SBA.sbtag = SB.sbtag  
left outer JOIN   
      SBAudit.dbo.[tbl_AuditStatus] Asts WITH (NOLOCK) ON SBA.SBtag = Asts.sbTag  
left outer join      
   SBAudit.[dbo].[tbl_APDetails] APD WITH (NOLOCK) ON SBA.updatedby = APD.emp_no  
LEFT outer JOIN  
    SBAudit.[dbo].[tbl_SBAuditpdfLogs] Logs WITH (NOLOCK) ON SBA.sbtag = Logs.SbTag  
WHERE  
    (SBA.updateddate BETWEEN @StartDate AND @EndDate)  
	and  Logs.pdfdownloaddate between  @StartDate AND @EndDate  
    AND  (SB.sbtag = case when(@SbTag)='' then SB.sbtag else @SbTag end )     
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MTF_Request_Process
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_MTF_Request_Process]
AS
BEGIN

--exec MTF_Update_OtherDebit

select * into #partyCode from [CSOKYC-6].general.dbo.rms_holding with(nolock) where accno='1203320030135829'


--Select Distinct foea_party_code,foea_position_date into #commoditycodes from angelcommodity.mcdx.dbo.foexerciseallocation with (Nolock) 
--where foea_position_date = (Select MAX(foea_position_date) as foea_position_date
--from angelcommodity.mcdx.dbo.foexerciseallocation with(nolock) where foea_position_date >GETDATE()-10)

--insert into MTF_code_CommodityCodes
--select * from #partyCode where party_code in (select foea_party_code from #commoditycodes)

--delete from #partyCode where party_code in (select foea_party_code from #commoditycodes)

/*
select party_code,BSE_Ledger+NSE_Ledger+NSEFO_Ledger+MCD_Ledger+NSX_Ledger+MCX_Ledger+NCDEX_Ledger as BrokingLedger,MTf_Ledger,margin_total,unreco_credit
,Coll_TotalHC as NonCash into #aa from  [CSOKYC-6].general.dbo.tbl_rms_collection_cli with (nolock) where party_code in (select distinct party_code from #partyCode) 
*/ /*Commented on 08 July 2022 for removing dependency from NRMS*/

/*****Add Bo source*******************/

declare @sdtcur as datetime,@Todate as datetime = convert(varchar(11),getdate())+' 23:59:59'         
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()              
  
/*Code added to handle Financial year end issue on 3rd April 2017*/  
/********************************************************************************/  
declare @ccsy datetime,@ccse datetime  
set @ccsy=@sdtcur  
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'  
  
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter where ldtcur        =  
(select ldtprv from AngelBSECM.account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()) 
 
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #MTFclient               
  from AngelNseCM.MTFTRADE.dbo.ledger  a with (nolock)                
  where VDT>=@sdtcur and  VDT <= @Todate                   
   /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from AngelNseCM.account.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
   group by cltcode

     select * into #MTFOpn from #MTFclient where cltcode in (select party_code from #partyCode)                   

  
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)       
  INTO #BSECMcltop                               
  from AngelBSECM.account_ab.dbo.ledger a with (nolock)                   
  where VDT>=@sdtcur and VDT <= @Todate --  and cltcode in (select party_code from #partyCode)   
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from AngelBSECM.account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
    select * into #BSECMOpn from #BSECMcltop where cltcode in (select party_code from #partyCode)     
               
    
 select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) 
  into  #NSECMcltop               
  from AngelNseCM.account.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and VDT <= @Todate       
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from AngelNseCM.account.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode      
      
  select * into #NSECMOpn from #NSECMcltop where cltcode in (select party_code from #partyCode)                        
    
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)          
  into #NSEFOcltop                
  from angelfo.accountfo.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate    
    /*Added to exclude opening balance of current year*/  
 -- /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelfo.accountfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode                    
    
  select * into #NSEFOOpn from #NSEFOcltop where cltcode in (select party_code from #partyCode)                  
  
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #NSXcltop                
  from angelfo.accountcurfo.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate   
     /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelfo.accountcurfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode         
      
    select * into #NSXOpn from #NSXcltop where cltcode in (select party_code from #partyCode)                  
      
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #BSXcltop                
  from angelcommodity.ACCOUNTcurbfo.dbo.ledger  a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate   
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTcurbfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
      select * into #BSXOpn from #BSXcltop where cltcode in (select party_code from #partyCode)                  
 
  select CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #MCDcltop                
  from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate     
  /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdxcds.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode                    
      
   select * into #MCDOpn from #MCDcltop where cltcode in (select party_code from #partyCode)                  
    
 
  select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #MCDXcltop                    
  from angelcommodity.accountmcdx.dbo.ledger a with (nolock)                           
  where VDT>=@sdtcur and  VDT <= @Todate   
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode                        
        
   select * into #MCDXOpn from #MCDXcltop where cltcode in (select party_code from #partyCode)         
                        
  select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)      
  into #NCDXcltop                   
  from angelcommodity.accountncdx.dbo.ledger a with (nolock)                           
  where VDT>=@sdtcur and  VDT <= @Todate      
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountncdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
  select * into #NCDXOpn from #NCDXcltop where cltcode in (select party_code from #partyCode)                   
 
 /**********NSE Commodity*********ORE-3462************************************************/
   select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)      
  into #NCEcltop                   
  from angelcommodity.ACCOUNTNCE.dbo.ledger a with (nolock)                           
  where VDT>=@sdtcur and  VDT <= @Todate      
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTNCE.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
  select * into #NCEOpn from #NCEcltop where cltcode in (select party_code from #partyCode)   
 /*******************************************************************/

 /*************BSEFO*********************************/
 --uncomment below query when making BSEFO live
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #BSEFOcltop                
  from angelcommodity.ACCOUNTBFO.dbo.ledger  a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate   
   /*Added to exclude opening balance of current year*/  
 /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTBFO.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
  and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
  select * into #BSEFOOpn from #BSEFOcltop where cltcode in (select party_code from #partyCode)                  
 /***************************************************/
 select * into #Bal from (                                              
  select * from #NSECMOpn                
  union all                                              
  select * from #BSECMOpn   
  union all                                              
  select * from #NSEFOOpn   
  union all                                              
  select * from #NSXOpn   
  union all                                              
  select * from #MCDOpn   
  --union all                                              
  --select * from #MTFOpn                      
  union all                                    
  select * from #MCDXOpn                                           
  union all                                              
  select * from #NCDXOpn   
  union all                                              
  select * from #NCEOpn
  union all                                              
  select * from #BSXOpn 
  --uncomment below query when making BSEFO live
  union all
  select * from #BSEFOOpn
  )x

  select cltcode,sum(vbal) as BrokingLedger into #BrokingValue from #Bal group by cltcode
  
  select cltcode ,sum(vbal) as MTf_Ledger into #mtfvalue from   #MTFOpn  group by cltcode   
  
  select cltcode as party_code,sum(BrokingLedger) BrokingLedger,sum(MTf_Ledger) MTf_Ledger into #aa from
  (
  select cltcode,isnull(BrokingLedger,0.00) BrokingLedger, CONVERT(money,0.00) MTf_Ledger from #BrokingValue
  union all
  select cltcode,CONVERT(money,0.00) BrokingLedger,ISNULL(MTf_Ledger,0.00) MTf_Ledger from #mtfvalue
  )x group by cltcode

/***********************/

select * into #client_col from  [CSOKYC-6].GENERAL.DBO.client_collaterals with(nolock)   
select Security_Symbol,Security_ISIN,MAX(mtm_price) as mtm_price  into #Combine_Closing_File from [CSOKYC-6].GENERAL.DBO.Combine_Closing_File with(nolock) group by Security_Symbol,Security_ISIN  

/******Start*********************Unsettle Non MTF Trade*********************************/
select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,  
CONVERT(MONEY, 0) as Value_BHC_unsett,  
CONVERT(MONEY, 0) as Value_AHC_unsett  
  into #mtf from AngelDemat.msajag.dbo.unclear_Hold_New  a with(nolock) left join  
#Combine_Closing_File b with(nolock) on  
a.I_isin=b.security_isin left join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.I_isin=c.[isin no] where 
party_code in (select party_code from #partycode) 
    
update #mtf set Value_BHC_unsett=qty*MTM_Price_unsett  
update #mtf set Value_AHC_unsett=isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)  
  
select SUM(Value_AHC_unsett) as Value_AHC_UnsettNonMTF_Trade,party_code into #MTF_Codes from #mtf group by party_code 
/*****End*******************************************/

/*****start***************CUSA Payout *****************************/
select BlockedQty,MTM_Price,party_Code,Var_margin_cusa,CONVERT(money,0.00) as Value_BHC_CUSA,CONVERT(money,0.00) as Value_AHC_Cusa into #Cusa 
from cusa_po with(nolock) where party_code in (select party_code from #partycode) and Seq_approve_status in ('Blocked' ,'Partially Released')   

update #Cusa set Value_BHC_CUSA=BlockedQty*MTM_Price  
update #Cusa set Value_AHC_Cusa=isnull(Value_BHC_CUSA,0)-(isnull(Value_BHC_CUSA,0)*isnull(Var_margin_cusa,0)/100)  
select sum(Value_AHC_Cusa) as Value_AHC_Cusa,party_Code into #Cusa_Codes from #Cusa /*where party_code in (select party_code from #partycode) and Seq_approve_status='Blocked'    */
group by party_code
/*****End***************************************************/

/*****Start*****************Margin Pleadge-Unpleadge*******************/
 /******Margin**/   
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty into #MarginPleadge  from AngelDemat.msajag.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'  
group by bcltdpid,party_code,certno,sett_no  
union all  
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty  from AngelDemat.bsedb.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'  
group by bcltdpid,party_code,certno,sett_no  

select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,  
CONVERT(MONEY, 0) as Var_margin,  
CONVERT(varchar(10), '') as series,  
CONVERT(MONEY, 0) as Value_BHC,  
CONVERT(MONEY, 0) as Value_AHC  
  into #marPledge from #MarginPleadge a left join   #Combine_Closing_File b with(nolock) on
a.certno=b.security_isin where  party_code in (select party_code from #partycode)

select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre from #client_col where party_code in (select distinct party_code from #marPledge)  
 
  
update #marPledge set series=b.series,var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre b  
where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin   
   
update #marPledge set MTM_Price=b.cl_rate from #wre b where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin and #marPledge.MTM_Price=0.00  
  
  
update #marPledge set Value_BHC=qty*MTM_Price  
update #marPledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)  
  
select SUM(Value_AHC) as Margin_pleadge_AHC,party_code into #marPledge_Final from #marPledge group by party_code  
    
/*****Unpleadge**/
select party_code,scrip,isin,sum(markedqty) as qty into #unpledge_code from tbl_UnpledgeFile with(nolock) where party_code in (select party_code from #partycode)
 group by party_code,scrip,isin


select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,
CONVERT(MONEY, 0) as Var_margin,  
CONVERT(MONEY, 0) as Value_BHC,  
CONVERT(MONEY, 0) as Value_AHC  
  into #unpledge from #unpledge_code a left join #Combine_Closing_File b with(nolock) on 
a.isin=b.security_isin  
  
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre1 from #client_col where party_code in (select distinct party_code from #unpledge_code)  
  
  
update #unpledge set var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre1 b  
where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin   
   
update #unpledge set MTM_Price=b.cl_rate from #wre1 b where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin and #unpledge.MTM_Price=0.00  
  
  
update #unpledge set Value_BHC=qty*MTM_Price  
update #unpledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100) 

select sum(Value_AHC) as Unpledge_AHC,party_Code into #unpledge_codes from #unpledge   group by party_code  

select a.party_code,isnull(Margin_pleadge_AHC,0.00)-isnull(Unpledge_AHC,0.00)  as Margin_Pledge_final_AHC into #Final_Margin_Pledge 
from #marPledge_Final a left join #unpledge_codes b on a.party_code=b.party_code

update #Final_Margin_Pledge set Margin_Pledge_final_AHC=0.00 where Margin_Pledge_final_AHC<0

/******End*******************************************************/
/*
 select party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                   
 from misc.dbo.Accrued_PenalCharges with (nolock) where party_code in (select party_code from #partycode) group by party_code 
 
 /******added new margin peneality charges on 05 Jul 2021***********************************/    
 insert into #Accrued1    
 select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) where party_code in (select party_code from #partycode) group by party_code              
 
 
insert into  #Accrued1
SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)
where cnt_Date=(select max(cnt_Date) from AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))  and cltcode in (select party_code from #partycode) 
group by cltcode

insert into  #Accrued1
SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock),AngelNseCM.MSAJAG.DBO.client_details c(Nolock)
where  PCN_Date=(select max(PCN_Date) from AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock)) and j.cl_code in (select party_code from #partycode) 
 and J.cl_code=c.cl_code
group by J.cl_code 
    
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                           
  */ 
  select a.PARTY_CODE,(OTHER_DEBIT*-1) as OTHER_DEBIT into #AccCharges from tbl_other_debit_MTF a with (nolock)  
  
 select a.PARTY_CODE,DeductEQ=sum(a.OTHER_DEBIT),DeductComm=0.00 into #Accrued1  
 from #AccCharges a with (nolock)  
 group by a.PARTY_CODE   

   select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                           

 /****************************************/  

select e.BrokingLedger,e.MTf_Ledger,isnull(Value_AHC_UnsettNonMTF_Trade,0.00)Value_AHC_UnsettNonMTF_Trade,isnull(Value_AHC_Cusa,0.00)Value_AHC_Cusa,
isnull(Margin_Pledge_final_AHC,0.00)Margin_Pledge_final_AHC,CONVERT(money,0.00) as NetLedger,CONVERT(money,0.00) as AccruedCharges 
,a.* into #main1 from #partyCode a 
left join #aa e on a.party_code=e.party_code 
left join #MTF_Codes b on a.party_code=b.party_code 
left join #Cusa_Codes c on a.party_code=c.party_code 
left join #Final_Margin_Pledge d on a.party_code=d.party_code 


 update #main1 set AccruedCharges=-DeductEQ  from #Accrued b                                                   
 where #main1.party_code=b.party_code  
 
 select *,BrokingLedger+AccruedCharges as BrokingLedgerAdWithAccrual into #main11 from #main1                                       

select *,BrokingLedgerAdWithAccrual+Value_AHC_UnsettNonMTF_Trade+Value_AHC_Cusa+Margin_Pledge_final_AHC as Netl into #nn from #main11


select *,CONVERT(money,0.00) as margin,CONVERT(money,0.00) as [ShortSellValue_Into_120%],CONVERT(money,0.00) as UnRecoCr ,
CONVERT(money,0.00) as MTF_Available_Cash,CONVERT(money,0.00) as MFPendingOrder,CONVERT(money,0.00) as MarginShortfall into #final from #nn /* a left join Cusa_Po b on a.party_code=b.party_code
and a.isin=b.isin and a.sett_no=b.sett_no*/


create table #MarginShortfall(
REPORTDATE varchar(20),PARTY_CODE varchar(50),PARTY_NAME varchar(100),BRANCH_cD varchar(50),SUB_BROKER varchar(30),FUDEDVAL money,MTOM money,MARGIN_REQ money,
FUDEDVALAFM money,MTFLEDBAL money,AVALABLECASH money,COLLATERALBHC money,COLLATERALAHC money,MARGIN_SHORTFALL money,ORDERBYDATE varchar(20))

declare @mdate as varchar(11),@dd as varchar(11)          
         
--select @mdate=max(vdt)+1 from AngelNseCM.account.dbo.ledger WITH(NOLOCK)          
--where vtyp=15 and vdt <=convert(varchar(11),getdate())          
--and narration like 'SETTNO=_______NSECMNBill Posted'            
         
select top 1 @mdate=start_date          
from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)          
where co_code='BSECM' and sett_type='D'          
and start_Date >=convert(varchar(11),getdate())-- @mdate            
order by Start_date    
  
select top 2 start_date,Row_number() Over(Order By start_Date desc) As Row_num          
into #day3        
from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)          
where co_code='BSECM'          
and sett_type='D'          
and start_Date <= @mdate   

select @dd =convert(varchar(11),Start_date)     from #day3 where Start_date< convert(varchar(11),getdate())  
print @dd
insert into #MarginShortfall                     
EXEC AngelNseCM.MTFTrade.dbo.RPT_MTF_SUMMARY 'BROKER', 'BROKER', @dd,@dd, '0', 'ZZZZZZ'      

update #final set MarginShortfall=MARGIN_SHORTFALL from                                                  
(select party_code,MARGIN_SHORTFALL=SUM(MARGIN_SHORTFALL) from #MarginShortfall where MARGIN_SHORTFALL<0 group by party_Code having sum(MARGIN_SHORTFALL) <> 0) b                    
 where   #final.party_Code=b.party_Code   

--truncate table #MarginShortfall   
                                                 
 update #final set [ShortSellValue_Into_120%]=-(b.shrtval*1.2) from                                                  
(select party_code,shrtval=SUM(SHORT_VALUE) from ncms_shortsell with(nolock) group by party_Code having sum(SHORT_VALUE) <> 0) b                    
 where   #final.party_Code=b.party_Code   
 
 select cltcode,SUM(Cramt) as UnRecoCr into #unreco from  AngelBSECM.inhouse.dbo.BO_client_deposit_recno with (nolock) where cltcode in (select distinct party_code from #partycode)  group by cltcode

 insert into #unreco
 select cltcode,SUM(Cramt) as UnRecoCr from  AngelNseCM.inhouse.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode
  
  insert into #unreco
 select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode            
 
 insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse_curfo.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode      

 insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_BSX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode             

 insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.INHOUSE_MCDCS.dbo.BO_client_deposit_recno with (nolock) where cltcode in (select distinct party_code from #partycode) group by cltcode          

 insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_MCDX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode               

 insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_NCDX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode
--uncomment below query when making BSEFO live
--insert into #unreco
--select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.bsefo.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode

select cltcode , SUM(UnRecoCr) as UnRecoCr into #UnrecoCr from #unreco group by cltcode
 
 update #final set UnRecoCr=-b.UnRecoCr  from #UnrecoCr b                                                   
 where #final.party_code=b.cltcode 
 
 select party_code ,MTF_Available_Cash=case when SUM(Available_Cash_bal)>0 then 0 else SUM(Available_Cash_bal) end
  into #MTFcltop     
  from   AngelNseCM.MTFTrade.dbo.MTF_Avilable_Cash with(nolock) where party_code in (select distinct party_code from #partycode) 
  group by party_code  
 
 update #final set MTF_Available_Cash=b.MTF_Available_Cash  from #MTFcltop b                                                   
 where #final.party_code=b.party_code 


 --update #final set margin=-b.margin_total  from #aa b                                                   
 --where #final.party_code=b.party_code 
 
 declare @MARGINDATE AS DATETIME  , @MARGINDATE_peak AS DATETIME    
           
SELECT @MARGINDATE=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock)   
SELECT @MARGINDATE_peak=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock)   
 
select TDAY_MARGIN/*+TDAY_MTM*/ as margin ,party_code,margindate into #margin from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock) where margindate=@MARGINDATE--'2020-12-29 00:00:00.000'    
  
select party_code, SUM(margin) as Margin into #mar from #margin group by party_code  
    
select /*TDAY_MARGIN*//*+TDAY_MTM*/0.00 as margin ,party_code,margindate into #marginPk from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock) where margindate=@MARGINDATE_peak--'2020-12-29 00:00:00.000'    
  
select party_code, SUM(margin) as Margin into #marpk from #marginPk group by party_code  
  
 SELECT party_code, MAX(Margin) as margin    
  into #mainMargin FROM    
  (    
   SELECT party_code, MAX(margin) as  Margin   
   FROM #mar     
   GROUP BY party_code    
   UNION ALL    
   SELECT party_code, MAX(margin) as   Margin  
   FROM #marpk     
   GROUP BY party_code    
  ) as subQuery    
  GROUP BY party_code   
  
 update #final set margin=-b.margin  from #mainMargin b                                                   
 where #final.party_code=b.party_code 
 /*******************For Reducing mf pending orders in MTF Payout**********/      
 /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF     
DECLARE @Days VARCHAR(20)                            
                            
 SET @Days = (                            
   SELECT DATENAME(dw, GETDATE())                            
   )       
                              
IF (@Days = 'Monday' OR @Days = 'Saturday')                            
BEGIN           
       
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal_sat         
 from       
 risk.dbo.vw_MutualFundPendingOrder_NCMS_sat o  with(nolock)      
 group by clientcode      
      
 insert into MTF_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)      
 select cltcode,amount,getdate() from #MFFundFinal_sat      
 
 update #final set MFPendingOrder=-b.amount  from #MFFundFinal_sat b                                                   
 where #final.party_code=b.cltcode   
      
 --drop table #segmentwise_pendingorders_sat      
 --drop table #MFFundFinal_sat      
end    
else      
begin      
   
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal         
 from       
 risk.dbo.vw_MutualFundPendingOrder_NCMS o with(nolock)       
 group by clientcode      
      
 insert into MTF_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)      
 select cltcode,amount,getdate() from #MFFundFinal      
      
 update #final set MFPendingOrder=-b.amount  from #MFFundFinal b                                                   
 where #final.party_code=b.cltcode    
     
 --drop table #segmentwise_pendingorders      
 --drop table #MFFundFinal      
end        
*/
/*****************************************************/  
--#final where margin<0='madn1050' 

update #final set netl=Netl+margin/*+AccruedCharges*/+[ShortSellValue_Into_120%]+UnRecoCr+MTF_Available_Cash+MFPendingOrder+MarginShortfall

Select distinct sauda_date,sett_no,party_code,Netamt,isin,qty into #MktPosition from AngelNseCM.mtftrade.dbo.TBL_PRODUCT_POSITION with(Nolock)
where sell_buy =1 and ADJUST_DATE ='2049-12-31 23:59:00.000' and party_code in (select distinct party_code from #final) and qty>0 order by sauda_date

insert into tbl_Postion_MTF
select *,getdate() from #MktPosition

select sauda_date,party_code,isin,sum(qty) qty,SUM(netamt) netamt into #cv from #MktPosition 
group by party_code,isin,sauda_date

select MIN(sauda_date)sauda_date,party_code,isin,CONVERT(money,0.00) as PositionAmt,CONVERT(int,0) as Qty,CONVERT(money,0.00) as PositionRate into #aa1 from #cv 
--#aa1 where party_code='PPYL174' and isin='INE095N01031'
group by party_code,isin


update #aa1 set PositionAmt=m.Netamt,Qty=m.qty from #cv m where #aa1.party_code=m.party_code and #aa1.isin=m.isin and #aa1.sauda_date=m.sauda_date

update #aa1 set PositionRate=PositionAmt/qty

alter table #final add PositionRate money

update #final set PositionRate=m.PositionRate from #aa1 m where #final.party_code=m.party_code and #final.isin=m.isin 

/*******Added on 07 Sep 2022***********/
update #final set PositionRate=convert(money,MTM_Price) from #Combine_Closing_File m where #final.isin=m.Security_ISIN and #final.PositionRate is null
/******************/
 --select *,case when BrokingLedger<netl then BrokingLedger
 --             when BrokingLedger>Netl then Netl else netl end  as FinalNet into #netdebit from #final

select *,case when BrokingLedgerAdWithAccrual<netl then BrokingLedgerAdWithAccrual
              when BrokingLedgerAdWithAccrual>Netl then Netl else netl end  as FinalNet into #netdebit from #final
	
	
alter table #netdebit add ReleasedQty int
alter table #netdebit add BlockedQty int

--commented on 24 Mar2023/*update a set ReleasedQty=qty,BlockedQty=0  from #netdebit a,MTF_Exception_ISIN b  where a.isin=b.ISIN and FinalNet>0*/ --added on 06 Jan 2023 as per JIRA ORE-1959

update #netdebit set ReleasedQty=0,BlockedQty=qty where /*BrokingLedger*/BrokingLedgerAdWithAccrual<0
update #netdebit set ReleasedQty=0,BlockedQty=qty  where FinalNet<0 and /*BrokingLedger*/BrokingLedgerAdWithAccrual>0  

update #netdebit set ReleasedQty=0,BlockedQty=qty  where PositionRate is null

update #netdebit set ReleasedQty=qty,BlockedQty=0   where FinalNet>=0 and FinalNet>=mtf_ledger*-1 and PositionRate is not null

alter table #netdebit add ReleasedValue money

update a set ReleasedValue=releasedQty* PositionRate from #netdebit a where  isnull(PositionRate,0)>0  and  ReleasedQty<>0
 
 select id=row_number() over(order by  sett_no )          
,denseid=dense_rank() over(order by party_code),
[PRiority]=(Case
	when isin='INE001A01036' then '1'
	else '2' end),
scrip_shortage=case when isnull(PositionRate,0.00)=0 then total else isnull(PositionRate,0)*Qty end
,adjval=convert(money,0),bal=convert(money,0) ,         
*          
into #holding          
from #netdebit where  /*BrokingLedger*/BrokingLedgerAdWithAccrual>0 and ReleasedQty is null and blockedqty is null
 
select 
id,denseid,
sqoffsseg=row_number() over(partition by party_code order by [PRiority],scrip_shortage  )/*Added on 27Jan 2022*/ 
,scrip_shortage,adjval,bal,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,
series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,BlockedQty=0
,releasedQty=0,sqoffseq=0,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),
shortagereduction=case when isnull(PositionRate,0.00)=0 then total else isnull(PositionRate,0)*Qty end,shortage=convert(money,0),[holding value after HC]=convert(money,0) ,ReleasedValue=convert(money,0)
into #hld
from #holding-- where party_code='A159174'
order by sqoffsseg

update a set a.shortage=(case when a.FinalNet<0 then (a.FinalNet*-1) else a.FinalNet end)  from #hld a  where a.sqoffsseg=1
--update a set a.shortage=(case when FinalNet<shortagereduction then 0 else a.FinalNet end)  from #hld a  where a.sqoffsseg=1 
/*Added on 27Jan 2022*/  /*Commeted on 07 Jul 2022*/


;with hold_cte as (
select 
sqoffsseg,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,
series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,
BlockedQty,releasedQty,ReleasedValue,
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hld x 
where  sqoffsseg=1 --and party_Code='CP6249'

   
union all
select 
e.sqoffsseg,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,
series,sett_no,sett_type,e.party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,
BlockedQty,releasedQty,ReleasedValue,shortagereduction,
shortage= (ecte.shortage-shortagereduction)
from #hld e inner join (select party_code,sqoffsseg,shortage from  hold_cte) ecte on ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
--and ecte.shortage>0
)
select * into #holdd
from hold_cte option  (maxrecursion 32767) ;

update #holdd set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0 


update a set releasedQty=(case when floor(convert(money,shortagereduction)/convert(money,PositionRate)) <= qty then floor(convert(money,shortagereduction)/convert(money,PositionRate)) else qty end)
from #holdd a where isnull(PositionRate,0)>0 

update a set ReleasedValue=releasedQty* PositionRate from #holdd a where  isnull(PositionRate,0)>0 

update a set releasedQty=0,BlockedQty=qty,ReleasedValue=0 from #holdd a where releasedQty<=0
update a set BlockedQty=isnull(qty,0)-isnull(releasedQty,0) from #holdd a where releasedQty>0

--alter table #netdebit add ReleasedValue money

  update #netdebit set ReleasedQty=isnull(b.ReleasedQty,0),BlockedQty=isnull(b.BlockedQty  ,0),ReleasedValue=ISNULL(b.ReleasedValue,0.00)
   from  
  (  
  select sett_no,party_code,isin,ReleasedQty,qty,BlockedQty,scrip_cd,ReleasedValue from #holdd  
  )b where ltrim(rtrim(#netdebit.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#netdebit.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(#netdebit.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#netdebit.qty))=ltrim(rtrim(b.qty))  

update #netdebit  set ReleasedValue=0.00 where  ReleasedValue is null
update #netdebit set releasedqty=0,blockedqty=qty where releasedqty is null

/****Added on 07 July 2022 by Neha*******************/
select * into #finalData from #netdebit  where releasedqty=qty

/****Release value reduced from 25000 to 1000 changes done by siva SRE NO: 10335*/

insert into #finalData
select * from #netdebit where FinalNet>=1000 and blockedqty>0 and FinalNet>0 and
BrokingLedgerAdWithAccrual>0 and releasedqty>0
/************************/
/*******Added on 09 Jan 2023 for argin benift**********************/
--select * into #finalData from MTF_AutoRelease
 declare @sauda_Date AS DATETIME   
           
SELECT @sauda_Date=MAX(sauda_Date) FROM AngelNseCM.MTFTRADE.dbo.TBL_MTF_DATA with (Nolock)

select * into #MarginBenifit from AngelNseCM.MTFTRADE.dbo.TBL_MTF_DATA with (Nolock) where  sauda_Date=@sauda_Date  and MTFNONCASHCOLLATERAL=0

select a.*,b.CURR_CL_RATE,b.margin_req,case when PositionRate>CURR_CL_RATE then (PositionRate-CURR_CL_RATE)*ReleasedQty else 0 end MTMRelease,
convert(decimal(18,2),(margin_req/a.qty)*ReleasedQty) as MarginRelease 
into #MTF_release from #finalData a join
#MarginBenifit b on a.party_code=b.party_code and a.isin=b.isin where a. blockedqty<>0

select *,MTMRelease+MarginRelease as finalRelease,convert(int,0) newReleasedQty,convert(int,0) TotalReleasedQty,
convert(money,0) TotalReleaseValue into #MTF_Final from #MTF_release

/*Added on 01 Mar 2023 by Neha*start*/

update #MTF_Final set finalRelease=case when (MarginShortfall*-1)>finalRelease then 0 
						 when (MarginShortfall*-1)<finalRelease then finalRelease+MarginShortfall end  where finalRelease<>0
/*End**/
update a set newReleasedQty=(case when floor(convert(money,finalRelease)/convert(money,PositionRate)) <= qty then
floor(convert(money,finalRelease)/convert(money,PositionRate)) else qty end)
from #MTF_Final a where isnull(PositionRate,0)>0 

update #MTF_Final set TotalReleasedQty=ReleasedQty+newReleasedQty,TotalReleaseValue=finalRelease+ReleasedValue where newReleasedQty>0 and blockedqty<>0 

select *,convert(money,0) CURR_CL_RATE,convert(money,0) margin_req,convert(money,0) MTMRelease,convert(money,0) MarginRelease,
convert(money,0) finalRelease,convert(int,0) newReleasedQty,convert(int,0) TotalReleasedQty,
convert(money,0) TotalReleaseValue into #finalData_MTFPO from #finalData

 update #finalData_MTFPO set CURR_CL_RATE=isnull(b.CURR_CL_RATE,0),margin_req=isnull(b.margin_req  ,0),MTMRelease=ISNULL(b.MTMRelease,0.00)
 ,MarginRelease=ISNULL(b.MarginRelease,0.00),finalRelease=ISNULL(b.finalRelease,0.00),newReleasedQty=isnull(b.newReleasedQty,0),
 TotalReleasedQty=case when b.newReleasedQty>0 and b.blockedqty<>0  then b.TotalReleasedQty else #finalData_MTFPO.ReleasedQty end,TotalReleaseValue=isnull(b.TotalReleaseValue,0)
   from  
  (  
  select sett_no,party_code,isin,ReleasedQty,qty,BlockedQty,scrip_cd,ReleasedValue,CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,
  finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue from #MTF_Final 
  )b where ltrim(rtrim(#finalData_MTFPO.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#finalData_MTFPO.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(#finalData_MTFPO.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#finalData_MTFPO.qty))=ltrim(rtrim(b.qty))  
 
  update #finalData_MTFPO set TotalReleasedQty=ReleasedQty,TotalReleaseValue=ReleasedValue  where TotalReleasedQty=0

update #finalData_MTFPO set TotalReleaseValue=ReleasedValue  where newreleasedqty=0 and TotalReleaseValue=0
 /********************************/
insert into MTF_AutoRelease_hist(BrokingLedger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,
isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,
partyname,[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],
UnRecoCr,MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,MTf_Ledger,Updatedon,
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue
)
select BrokingLedger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,isin,scrip_cd,series,sett_no,
sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,[pool],total,DUMMY1,DUMMY2,
nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,MTF_Available_Cash,MFPendingOrder,
MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,MTf_Ledger,GETDATE(),
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue
from MTF_AutoRelease

truncate table MTF_AutoRelease

insert into MTF_AutoRelease(BrokingLedger,MTf_Ledger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,isin,
scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,
[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,
MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue
) 
select BrokingLedger,MTf_Ledger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,isin,
scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,
[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,
MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue
from #finalData_MTFPO
--select *  from #netdebit  where releasedqty=qty /*Commentd on 07 July 2022*/

insert into MTF_AutoRelease_log(ProcessName,TableName,UpdatedOn)
select 'USP_MTF_Request_Process','MTF_AutoRelease',getdate()

truncate table MTF_AutoRelease_AllData

insert into MTF_AutoRelease_AllData(BrokingLedger,MTf_Ledger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,
isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,
partyname,[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],
UnRecoCr,MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue)
select *  from #netdebit
/*where party_code in (select partycode from [tbl_MTFData_20Oct2021] with(nolock))*/

/*delete from MTF_AutoRelease where party_Code not in (select partycode from [tbl_MTFData_20Oct2021] with(nolock))*/

exec USP_MTFAutoRelease_File_Generation

truncate table MTF_AutoRelease_Heading

 insert into MTF_AutoRelease_Heading(BrokingLedger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges
 ,isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,
 partyname,[pool],total,DUMMY500,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],
 UnRecoCr,MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,MTf_Ledger,
 CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue
)
 select  'BrokingLedger','Value_AHC_UnsettNonMTF_Trade','Value_AHC_Cusa','Margin_Pledge_final_AHC','NetLedger','AccruedCharges','isin','scrip_cd','series','sett_no','sett_type','party_Code','bs','exchange','qty','clsrate','accno','dpid','clid','flag','aben',
 'apool','nben','npool','approved','scripname','partyname','pool','total','DUMMY1','DUMMY2','nse_approved','source','upd_date','AdjQty',
 'BrokingLedgerAdWithAccrual','Netl','margin','ShortSellValue_Into_120%','UnRecoCr','MTF_Available_Cash','MFPendingOrder','MarginShortfall','PositionRate'
 ,'FinalNet','ReleasedQty','BlockedQty','ReleasedValue','MTf_Ledger',
 'CURR_CL_RATE','margin_req','MTMRelease','MarginRelease','finalRelease','newReleasedQty','TotalReleasedQty','TotalReleaseValue'

 
 insert into MTF_AutoRelease_Heading
 select * from MTF_AutoRelease
 
  DECLARE @s VARCHAR(MAX) = ''                                        
   /*declare @FileName as varchar(100) = 'LD_File'+replace(CONVERT(char(10),getdate(),103),'/','-')+'.csv'*/    
   declare @FileName as varchar(100) = 'MTF_Release'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                                               
      declare @FilePath varchar(200) ='' /* '\\INHOUSELIVEAPP2-FS.angelone.in\d$\upload\CMS_Test\'+@FileName  */                       
	   select @FilePath='\\10.253.19.11\cusa_mtf\'+@FileName          
                                     
      SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                         
      SET @s = @s + 'bcp "select * from INTRANET.cms.dbo.MTF_AutoRelease_Heading" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                                                                   
     
           
      SET @s = @s + ''''            
      EXEC(@s) 
	  
	  /************************************/
	  Select sauda_date,sett_no,party_code,Netamt,isin,qty into #NewPosition from AngelNseCM.mtftrade.dbo.TBL_PRODUCT_POSITION 
		with(Nolock)
		where sell_buy =1 and ADJUST_DATE ='2049-12-31 23:59:00.000' and party_code in (select distinct party_code from MTF_AutoRelease)and qty>0
		 order by sauda_date

		 select sauda_date,party_code,isin,sum(qty) qty,SUM(netamt) netamt into #Club from #NewPosition 
		 group by party_code,isin,sauda_date

	select a.party_code,a.scrip_cd,a.isin,b.sauda_date,a.ReleasedQty,b.qty as MTFQty,b.netamt as MTFValue,a.ReleasedValue,a.Marginrelease,
		(ISNULL(ReleasedValue,0.00)+ISNULL(Marginrelease,0.00)) as toatl,CONVERT(int,0) as NewQty into #fix from MTF_AutoRelease a join
		#Club b on a.party_Code=b.party_code and a.isin=b.isin

		/********************added*/
		select party_code,isin,releasedqty,SUM(MTFQty)MTFQty into #xx from #fix group by  party_code,isin,releasedqty
		
		update a set a.NewQty=a.releasedqty from #fix a join #xx b on a.party_Code=b.party_Code and a.isin=b.isin 
		where b.releasedqty>b.MTFQty

		select 
		 id=row_number() over(order by sauda_date )          
		,denseid=dense_rank() over(order by party_code),sqoffsseg=row_number() over(partition by party_code,isin order by sauda_date  ),party_code,scrip_cd,isin,
		sauda_date,ReleasedQty,MTFQty,MTFValue,ReleasedValue,Marginrelease,toatl,shortagereduction=ReleasedQty,
		shortage=convert(int,0) into #hld_fix from #fix where NewQty=0   order by sqoffsseg

		 update a set a.shortage=MTFQty  from #hld_fix a  where a.sqoffsseg=1

			--;with hold_cte as (
			--select 
			--sqoffsseg,party_code,scrip_cd,isin,sauda_date,ReleasedQty,MTFQty,MTFValue,ReleasedValue,Marginrelease,toatl,
			-- shortagereduction=case when shortagereduction<shortage then shortagereduction else shortage end,
			--shortage--=case when (shortagereduction-shortage)<0 then 0 else(shortagereduction-shortage) end 
			--from #hld_fix x 
			--where  sqoffsseg=1-- and party_Code='A1095005' and isin='INE855B01025' 
			--union all
			--select 
			--e.sqoffsseg,e.party_code,scrip_cd,e.isin,sauda_date,ReleasedQty,MTFQty,MTFValue,ReleasedValue,Marginrelease,toatl,
			--shortagereduction= case when (e.shortagereduction-ecte.shortage)<0 or ecte.shortage=0 then 0 else e.shortagereduction-ecte.shortage end,
			--e.shortage--= case when (shortagereduction-ecte.shortage)>0 then 0 else shortagereduction-ecte.shortage end
			--from #hld_fix e inner join (select party_code,sqoffsseg,shortage,isin from  hold_cte) ecte on ecte.party_code = e.party_code 
			--and e.sqoffsseg=ecte.sqoffsseg+1 
			--)
			--select * into #holdd_fix
			--from hold_cte option  (maxrecursion 32767) ;

			--update #holdd_fix set shortagereduction=0,shortage=0 where shortage<=0 --and sqoffsseg<>1

			--update a set NewQty=isnull(b.shortagereduction,0)
			--from  #fix a ,#holdd_fix b where a.party_Code=b.party_Code and a.isin=b.isin and a.sauda_date=b.sauda_date and a.scrip_cd=b.scrip_cd
			--and a.newqty=0
			/************************************/
		
		insert into AngelNseCM.MTFTRADE.dbo.mtf_ctd_auto_release(Party_code,scrip_cd,isin,sauda_date,released_date,auto_closure_released_qty,mtf_loan_released_value,
		mtf_margin_released_value,net_broking_ledger_debit_amount,mtf_qty,mtf_value)

		select party_code,scrip_cd,isin,sauda_date,GETDATE(),NewQty,ReleasedValue,Marginrelease,toatl,mtfqty,mtfvalue
		from #fix  order by party_code,isin,sauda_date

		--insert into AngelNseCM.MTFTRADE.dbo.mtf_ctd_auto_release(Party_code,scrip_cd,isin,sauda_date,released_date,auto_closure_released_qty,mtf_loan_released_value,
		--mtf_margin_released_value,net_broking_ledger_debit_amount)

		--select party_code,scrip_cd,isin,sauda_date,GETDATE(),ReleasedQty,ReleasedValue,Marginrelease,toatl
		--from #fix order by party_code,isin,sauda_date

	  /************************************/

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MTF_Request_Process_11Aug2025_derivative
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_MTF_Request_Process_11Aug2025_derivative]
AS
BEGIN

--exec MTF_Update_OtherDebit

select * into #partyCode from [CSOKYC-6].general.dbo.rms_holding with(nolock) where accno='1203320030135829'

Declare @sauda_date1 datetime
select @sauda_date1=max(sauda_date) from  AngelNSECM.mtftrade.dbo.tbl_mtf_data with (Nolock)
Select Distinct party_code,Sauda_date into #extra_party from  AngelNSECM.mtftrade.dbo.tbl_mtf_data with(Nolock) Where
sauda_date=@sauda_date1

insert into #partyCode(party_code)
select Distinct party_code from #extra_party where party_code not in (select party_code from #partyCode)


--Select Distinct foea_party_code,foea_position_date into #commoditycodes from angelcommodity.mcdx.dbo.foexerciseallocation with (Nolock) 
--where foea_position_date = (Select MAX(foea_position_date) as foea_position_date
--from angelcommodity.mcdx.dbo.foexerciseallocation with(nolock) where foea_position_date >GETDATE()-10)

--insert into MTF_code_CommodityCodes
--select * from #partyCode where party_code in (select foea_party_code from #commoditycodes)

--delete from #partyCode where party_code in (select foea_party_code from #commoditycodes)

/*
select party_code,BSE_Ledger+NSE_Ledger+NSEFO_Ledger+MCD_Ledger+NSX_Ledger+MCX_Ledger+NCDEX_Ledger as BrokingLedger,MTf_Ledger,margin_total,unreco_credit
,Coll_TotalHC as NonCash into #aa from  [CSOKYC-6].general.dbo.tbl_rms_collection_cli with (nolock) where party_code in (select distinct party_code from #partyCode) 
*/ /*Commented on 08 July 2022 for removing dependency from NRMS*/

/*****Add Bo source*******************/

declare @sdtcur as datetime,@Todate as datetime = convert(varchar(11),getdate())+' 23:59:59'         
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()              
  
/*Code added to handle Financial year end issue on 3rd April 2017*/  
/********************************************************************************/  
declare @ccsy datetime,@ccse datetime  
set @ccsy=@sdtcur  
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'  
  
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter where ldtcur        =  
(select ldtprv from AngelBSECM.account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()) 
 
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #MTFclient               
  from AngelNseCM.MTFTRADE.dbo.ledger  a with (nolock)                
  where VDT>=@sdtcur and  VDT <= @Todate                   
   /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from AngelNseCM.account.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
   group by cltcode

     select * into #MTFOpn from #MTFclient where cltcode in (select party_code from #partyCode)                   

  
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)       
  INTO #BSECMcltop                               
  from AngelBSECM.account_ab.dbo.ledger a with (nolock)                   
  where VDT>=@sdtcur and VDT <= @Todate --  and cltcode in (select party_code from #partyCode)   
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from AngelBSECM.account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
    select * into #BSECMOpn from #BSECMcltop where cltcode in (select party_code from #partyCode)     
               
    
 select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end) 
  into  #NSECMcltop               
  from AngelNseCM.account.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and VDT <= @Todate       
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from AngelNseCM.account.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode      
      
  select * into #NSECMOpn from #NSECMcltop where cltcode in (select party_code from #partyCode)                        
    
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)          
  into #NSEFOcltop                
  from angelfo.accountfo.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate    
    /*Added to exclude opening balance of current year*/  
 -- /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelfo.accountfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode                    
    
  select * into #NSEFOOpn from #NSEFOcltop where cltcode in (select party_code from #partyCode)                  
  
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #NSXcltop                
  from angelfo.accountcurfo.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate   
     /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelfo.accountcurfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode         
      
    select * into #NSXOpn from #NSXcltop where cltcode in (select party_code from #partyCode)                  
      
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #BSXcltop                
  from angelcommodity.ACCOUNTcurbfo.dbo.ledger  a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate   
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTcurbfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
      select * into #BSXOpn from #BSXcltop where cltcode in (select party_code from #partyCode)                  
 
  select CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #MCDcltop                
  from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate     
  /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdxcds.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode                    
      
   select * into #MCDOpn from #MCDcltop where cltcode in (select party_code from #partyCode)                  
    
 
  select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #MCDXcltop                    
  from angelcommodity.accountmcdx.dbo.ledger a with (nolock)                           
  where VDT>=@sdtcur and  VDT <= @Todate   
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode                        
        
   select * into #MCDXOpn from #MCDXcltop where cltcode in (select party_code from #partyCode)         
                        
  select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)      
  into #NCDXcltop                   
  from angelcommodity.accountncdx.dbo.ledger a with (nolock)                           
  where VDT>=@sdtcur and  VDT <= @Todate      
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountncdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
  select * into #NCDXOpn from #NCDXcltop where cltcode in (select party_code from #partyCode)                   
 
 /*************BSEFO*********************************/
 --uncomment below query when making BSEFO live
  select CLTCODE,                
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)
  into #BSEFOcltop                
  from angelcommodity.ACCOUNTBFO.dbo.ledger  a with (nolock)                       
  where VDT>=@sdtcur and  VDT <= @Todate   
   /*Added to exclude opening balance of current year*/  
 /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTBFO.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
  and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
  select * into #BSEFOOpn from #BSEFOcltop where cltcode in (select party_code from #partyCode)                  
 /***************************************************/
  /**********NSE Commodity*********ORE-3462************************************************/
   select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)      
  into #NCEcltop                   
  from angelcommodity.ACCOUNTNCE.dbo.ledger a with (nolock)                           
  where VDT>=@sdtcur and  VDT <= @Todate      
   /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTNCE.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
  group by cltcode     
      
  select * into #NCEOpn from #NCEcltop where cltcode in (select party_code from #partyCode)   
 /*******************************************************************/

 select * into #Bal from (                                              
  select * from #NSECMOpn                
  union all                                              
  select * from #BSECMOpn   
  union all                                              
  select * from #NSEFOOpn   
  union all                                              
  select * from #NSXOpn   
  union all                                              
  select * from #MCDOpn   
  --union all                                              
  --select * from #MTFOpn                      
  union all                                    
  select * from #MCDXOpn                                           
  union all                                              
  select * from #NCDXOpn                                                                    
  union all                                              
  select * from #BSXOpn 
  --uncomment below query when making BSEFO live
  union all
  select * from #BSEFOOpn
  union all                                              
  select * from #NCEOpn
  )x

  select cltcode,sum(vbal) as BrokingLedger into #Brokingledger from #Bal group by cltcode
  
  
create table #Margintbl  
(  
party_code  varchar(50),  
margin  money  
)  
  
/*declare @party_code as varchar(50)='g27811'*/  
DECLARE @MARGINDATE_NSEFO AS DATETIME,@MARGINDATE_NSX AS DATETIME,@MARGINDATE_MCDX AS DATETIME,@MARGINDATE_BSX AS DATETIME   
,@MARGINDATE_NCDX AS DATETIME ,@MARGINDATE_MTF AS DATETIME  ,@MARGINDATE_T7 AS DATETIME,@MARGINDATE_MCD as DATETIME ,
@MARGINDATE_NCE AS DATETIME
           
SELECT @MARGINDATE_NSEFO=MAX(MARGINDATE) FROM angelfo.NSEFO.dbo.tbl_clientmargin with(nolock)    
    
SELECT @MARGINDATE_NSX=MAX(MARGINDATE) FROM angelfo.NSECURFO.dbo.tbl_clientmargin with(nolock)    
  
SELECT @MARGINDATE_BSX=MAX(MARGINDATE) FROM angelcommodity.BSECURFO.dbo.tbl_clientmargin with(nolock)    
    
SELECT @MARGINDATE_MCDX=MAX(MARGINDATE) FROM angelcommodity.MCDX.dbo.tbl_clientmargin with(nolock)    
    
SELECT @MARGINDATE_NCDX=MAX(MARGINDATE) FROM angelcommodity.NCDX.dbo.tbl_clientmargin  with(nolock)  

SELECT @MARGINDATE_MCD=MAX(MARGINDATE) FROM angelcommodity.MCDXCDS.dbo.tbl_clientmargin  WITH (NOLOCK)            

SELECT @MARGINDATE_NCE=MAX(MARGINDATE) FROM angelcommodity.NCE.dbo.tbl_clientmargin WITH (NOLOCK)                     

 
  
insert into #Margintbl(party_code,margin)  
select party_code,initialmargin+addmargin+mtmmargin as margin from  angelfo.nsefo.dbo.tbl_clientmargin  with (nolock) where    
margindate=@MARGINDATE_NSEFO   
  
insert into #Margintbl(party_code,margin)  
select party_code,initialmargin+addmargin+mtmmargin as margin  from  angelfo.nsecurfo.dbo.tbl_clientmargin  with (nolock) where    
margindate=@MARGINDATE_NSX  

insert into #Margintbl(party_code,margin)  
select party_code,initialmargin+addmargin+mtmmargin+PREMIUM_MARGIN as margin  from  angelcommodity.MCDXCDS.dbo.tbl_clientmargin  with (nolock) where    
margindate=@MARGINDATE_MCD 
  
insert into #Margintbl(party_code,margin)  
select  party_code,initialmargin+addmargin+mtmmargin as margin from   angelcommodity.bsecurfo.dbo.tbl_clientmargin  with (nolock) where    
margindate=@MARGINDATE_BSX    
   
insert into #Margintbl(party_code,margin)   
select party_code,initialmargin+addmargin+mtmmargin as margin from  angelcommodity.MCDX.dbo.tbl_clientmargin  with (nolock) where    
margindate=@MARGINDATE_MCDX 
   
insert into #Margintbl(party_code,margin)   
select party_code,initialmargin+addmargin+mtmmargin as margin from   angelcommodity.NCDX.dbo.tbl_clientmargin  with (nolock) where    
margindate=@MARGINDATE_NCDX 

insert into #Margintbl(party_code,margin)   
select party_code,initialmargin+addmargin as margin from   angelcommodity.NCE.dbo.tbl_clientmargin  with (nolock) where    
margindate=@MARGINDATE_NCE 
  
  
select party_code,sum(margin) as margin into #finalMArgin from #Margintbl with (nolock) group by party_code 
select party_code,margin *-1 as margin into #NetMArgin from #finalMArgin 

 select a.* into #NewcollNSEFO from angelfo.msajag.dbo.CollateralDetails a WITH (NOLOCK)         
   where exchange='NSE' and segment='FUTURES' and effdate = (select max(effdate) from angelfo.msajag.dbo.CollateralDetails WITH (NOLOCK)           
   where effDate <= getdate() and exchange='NSE' and segment='FUTURES')       
    
       
select a.*, case when haircut<20 then 20.00 else haircut end Var_margin,CONVERT(MONEY, 0) as Value_BHC,          
CONVERT(MONEY, 0) as Value_AHC          
into #we  from #NewcollNSEFO a      
    
     
update #we set Value_BHC=  qty*cl_rate          
update #we set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)         
     
    
select a.party_code, sum(Value_AHC) noncash into #qq from #we a   group by a.party_code 
  

select 
    m.party_code,
    m.margin,
    isnull(q.noncash, 0) as noncash,
    case 
        when (m.margin*-1) > isnull(q.noncash, 0) then m.margin + isnull(q.noncash, 0)
        else 0
    end as remaining_margin_after_noncash
into #marginAdjusted
from #NetMArgin m
left join #qq q on m.party_code = q.party_code


select 
    b.cltcode,
    a.margin,
    a.noncash,
    a.remaining_margin_after_noncash,
    isnull(b.BrokingLedger, 0) as BrokingLedger1,
    case 
        when a.remaining_margin_after_noncash <>0
            then  isnull(b.BrokingLedger, 0)+ a.remaining_margin_after_noncash 
        else BrokingLedger
    end as Brokingledger
into #BrokingValue 
from #Brokingledger b
left join #marginAdjusted a on b.cltcode=a.party_code 

  
  select cltcode ,sum(vbal) as MTf_Ledger into #mtfvalue from   #MTFOpn  group by cltcode   
  
  select cltcode as party_code,sum(BrokingLedger) BrokingLedger,sum(MTf_Ledger) MTf_Ledger into #aa from
  (
  select cltcode,isnull(BrokingLedger,0.00) BrokingLedger, CONVERT(money,0.00) MTf_Ledger from #BrokingValue
  union all
  select cltcode,CONVERT(money,0.00) BrokingLedger,ISNULL(MTf_Ledger,0.00) MTf_Ledger from #mtfvalue
  )x group by cltcode

/***********************/

select * into #client_col from  [CSOKYC-6].GENERAL.DBO.client_collaterals with(nolock)   
select Security_Symbol,Security_ISIN,MAX(mtm_price) as mtm_price  into #Combine_Closing_File from [CSOKYC-6].GENERAL.DBO.Combine_Closing_File with(nolock) group by Security_Symbol,Security_ISIN  

/******Start*********************Unsettle Non MTF Trade*********************************/
select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,  
CONVERT(MONEY, 0) as Value_BHC_unsett,  
CONVERT(MONEY, 0) as Value_AHC_unsett  
  into #mtf from AngelDemat.msajag.dbo.unclear_Hold_New  a with(nolock) left join  
#Combine_Closing_File b with(nolock) on  
a.I_isin=b.security_isin left join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.I_isin=c.[isin no] where 
party_code in (select party_code from #partycode) 
    
update #mtf set Value_BHC_unsett=qty*MTM_Price_unsett  
update #mtf set Value_AHC_unsett=isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)  
  
select SUM(Value_AHC_unsett) as Value_AHC_UnsettNonMTF_Trade,party_code into #MTF_Codes from #mtf group by party_code 
/*****End*******************************************/

/*****start***************CUSA Payout *****************************/
select BlockedQty,MTM_Price,party_Code,Var_margin_cusa,CONVERT(money,0.00) as Value_BHC_CUSA,CONVERT(money,0.00) as Value_AHC_Cusa into #Cusa 
from cms.dbo.cusa_po with(nolock) where party_code in (select party_code from #partycode) and Seq_approve_status in ('Blocked' ,'Partially Released')   

update #Cusa set Value_BHC_CUSA=BlockedQty*MTM_Price  
update #Cusa set Value_AHC_Cusa=isnull(Value_BHC_CUSA,0)-(isnull(Value_BHC_CUSA,0)*isnull(Var_margin_cusa,0)/100)  
select sum(Value_AHC_Cusa) as Value_AHC_Cusa,party_Code into #Cusa_Codes from #Cusa /*where party_code in (select party_code from #partycode) and Seq_approve_status='Blocked'    */
group by party_code
/*****End***************************************************/

/*****Start*****************Margin Pleadge-Unpleadge*******************/
 /******Margin**/   
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty into #MarginPleadge  from AngelDemat.msajag.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'  
group by bcltdpid,party_code,certno,sett_no  
union all  
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty  from AngelDemat.bsedb.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'  
group by bcltdpid,party_code,certno,sett_no  

select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,  
CONVERT(MONEY, 0) as Var_margin,  
CONVERT(varchar(10), '') as series,  
CONVERT(MONEY, 0) as Value_BHC,  
CONVERT(MONEY, 0) as Value_AHC  
  into #marPledge from #MarginPleadge a left join   #Combine_Closing_File b with(nolock) on
a.certno=b.security_isin where  party_code in (select party_code from #partycode)

select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre from #client_col where party_code in (select distinct party_code from #marPledge)  
 
  
update #marPledge set series=b.series,var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre b  
where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin   
   
update #marPledge set MTM_Price=b.cl_rate from #wre b where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin and #marPledge.MTM_Price=0.00  
  
  
update #marPledge set Value_BHC=qty*MTM_Price  
update #marPledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)  
  
select SUM(Value_AHC) as Margin_pleadge_AHC,party_code into #marPledge_Final from #marPledge group by party_code  
    
/*****Unpleadge**/
select party_code,scrip,isin,sum(markedqty) as qty into #unpledge_code from cms.dbo.tbl_UnpledgeFile with(nolock) where party_code in (select party_code from #partycode)
 group by party_code,scrip,isin


select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,
CONVERT(MONEY, 0) as Var_margin,  
CONVERT(MONEY, 0) as Value_BHC,  
CONVERT(MONEY, 0) as Value_AHC  
  into #unpledge from #unpledge_code a left join #Combine_Closing_File b with(nolock) on 
a.isin=b.security_isin  
  
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre1 from #client_col where party_code in (select distinct party_code from #unpledge_code)  
  
  
update #unpledge set var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre1 b  
where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin   
   
update #unpledge set MTM_Price=b.cl_rate from #wre1 b where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin and #unpledge.MTM_Price=0.00  
  
  
update #unpledge set Value_BHC=qty*MTM_Price  
update #unpledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100) 

select sum(Value_AHC) as Unpledge_AHC,party_Code into #unpledge_codes from #unpledge   group by party_code  

select a.party_code,isnull(Margin_pleadge_AHC,0.00)-isnull(Unpledge_AHC,0.00)  as Margin_Pledge_final_AHC into #Final_Margin_Pledge 
from #marPledge_Final a left join #unpledge_codes b on a.party_code=b.party_code

update #Final_Margin_Pledge set Margin_Pledge_final_AHC=0.00 where Margin_Pledge_final_AHC<0

/******End*******************************************************/
/*
 select party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                   
 from misc.dbo.Accrued_PenalCharges with (nolock) where party_code in (select party_code from #partycode) group by party_code 
 
 /******added new margin peneality charges on 05 Jul 2021***********************************/    
 insert into #Accrued1    
 select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) where party_code in (select party_code from #partycode) group by party_code              
 
 
insert into  #Accrued1
SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)
where cnt_Date=(select max(cnt_Date) from AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))  and cltcode in (select party_code from #partycode) 
group by cltcode

insert into  #Accrued1
SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock),AngelNseCM.MSAJAG.DBO.client_details c(Nolock)
where  PCN_Date=(select max(PCN_Date) from AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock)) and j.cl_code in (select party_code from #partycode) 
 and J.cl_code=c.cl_code
group by J.cl_code 
    
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                           
  */ 
  select a.PARTY_CODE,(OTHER_DEBIT*-1) as OTHER_DEBIT into #AccCharges from cms.dbo.tbl_other_debit_MTF a with (nolock)  
  
 select a.PARTY_CODE,DeductEQ=sum(a.OTHER_DEBIT),DeductComm=0.00 into #Accrued1  
 from #AccCharges a with (nolock)  
 group by a.PARTY_CODE   

   select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                           

 /****************************************/  

select e.BrokingLedger,e.MTf_Ledger,isnull(Value_AHC_UnsettNonMTF_Trade,0.00)Value_AHC_UnsettNonMTF_Trade,isnull(Value_AHC_Cusa,0.00)Value_AHC_Cusa,
isnull(Margin_Pledge_final_AHC,0.00)Margin_Pledge_final_AHC,CONVERT(money,0.00) as NetLedger,CONVERT(money,0.00) as AccruedCharges 
,a.* into #main1 from #partyCode a 
left join #aa e on a.party_code=e.party_code 
left join #MTF_Codes b on a.party_code=b.party_code 
left join #Cusa_Codes c on a.party_code=c.party_code 
left join #Final_Margin_Pledge d on a.party_code=d.party_code 


 update #main1 set AccruedCharges=-DeductEQ  from #Accrued b                                                   
 where #main1.party_code=b.party_code  
 
 select *,BrokingLedger+AccruedCharges as BrokingLedgerAdWithAccrual into #main11 from #main1                                       

select *,BrokingLedgerAdWithAccrual+Value_AHC_UnsettNonMTF_Trade+Value_AHC_Cusa+Margin_Pledge_final_AHC as Netl into #nn from #main11


select *,CONVERT(money,0.00) as margin,CONVERT(money,0.00) as [ShortSellValue_Into_120%],CONVERT(money,0.00) as UnRecoCr ,
CONVERT(money,0.00) as MTF_Available_Cash,CONVERT(money,0.00) as MFPendingOrder,CONVERT(money,0.00) as MarginShortfall,
CONVERT(money,0.00) as Noncash,CONVERT(money,0.00) as Margin_new into #final from #nn /* a left join Cusa_Po b on a.party_code=b.party_code
and a.isin=b.isin and a.sett_no=b.sett_no*/


create table #MarginShortfall(
REPORTDATE varchar(20),PARTY_CODE varchar(50),PARTY_NAME varchar(100),BRANCH_cD varchar(50),SUB_BROKER varchar(30),FUDEDVAL money,MTOM money,MARGIN_REQ money,
FUDEDVALAFM money,MTFLEDBAL money,AVALABLECASH money,COLLATERALBHC money,COLLATERALAHC money,MARGIN_SHORTFALL money,ORDERBYDATE varchar(20))

declare @mdate as varchar(11),@dd as varchar(11)          
         
--select @mdate=max(vdt)+1 from AngelNseCM.account.dbo.ledger WITH(NOLOCK)          
--where vtyp=15 and vdt <=convert(varchar(11),getdate())          
--and narration like 'SETTNO=_______NSECMNBill Posted'            
         
select top 1 @mdate=start_date          
from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)          
where co_code='BSECM' and sett_type='D'          
and start_Date >=convert(varchar(11),getdate())-- @mdate            
order by Start_date    
  
select top 2 start_date,Row_number() Over(Order By start_Date desc) As Row_num          
into #day3        
from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)          
where co_code='BSECM'          
and sett_type='D'          
and start_Date <= @mdate   

select @dd =convert(varchar(11),Start_date)     from #day3 where Start_date< convert(varchar(11),getdate())  
print @dd
insert into #MarginShortfall                     
EXEC AngelNseCM.MTFTrade.dbo.RPT_MTF_SUMMARY 'BROKER', 'BROKER', @dd,@dd, '0', 'ZZZZZZ'      

update #final set MarginShortfall=MARGIN_SHORTFALL from                                                  
(select party_code,MARGIN_SHORTFALL=SUM(MARGIN_SHORTFALL) from #MarginShortfall where MARGIN_SHORTFALL<0 group by party_Code having sum(MARGIN_SHORTFALL) <> 0) b                    
 where   #final.party_Code=b.party_Code   

--truncate table #MarginShortfall   
                                                 
 update #final set [ShortSellValue_Into_120%]=-(b.shrtval*1.2) from                                                  
(select party_code,shrtval=SUM(SHORT_VALUE) from cms.dbo.ncms_shortsell with(nolock) group by party_Code having sum(SHORT_VALUE) <> 0) b                    
 where   #final.party_Code=b.party_Code   
 
 select cltcode,SUM(Cramt) as UnRecoCr into #unreco from  AngelBSECM.inhouse.dbo.BO_client_deposit_recno with (nolock) where cltcode in (select distinct party_code from #partycode)  group by cltcode

 insert into #unreco
 select cltcode,SUM(Cramt) as UnRecoCr from  AngelNseCM.inhouse.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode
  
  insert into #unreco
 select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode            
 
 insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse_curfo.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode      

 insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_BSX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode             

 insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.INHOUSE_MCDCS.dbo.BO_client_deposit_recno with (nolock) where cltcode in (select distinct party_code from #partycode) group by cltcode          

 insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_MCDX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode               

 insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_NCDX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode
--uncomment below query when making BSEFO live
insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.bsefo.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode

insert into #unreco
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.Inhouse_NCE.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode
select cltcode , SUM(UnRecoCr) as UnRecoCr into #UnrecoCr from #unreco group by cltcode
 
 update #final set UnRecoCr=-b.UnRecoCr  from #UnrecoCr b                                                   
 where #final.party_code=b.cltcode 

  update #final set Margin_new=b.margin,Noncash=b.noncash  from #BrokingValue b                                                   
 where #final.party_code=b.cltcode 
 
 select party_code ,MTF_Available_Cash=case when SUM(Available_Cash_bal)>0 then 0 else SUM(Available_Cash_bal) end
  into #MTFcltop     
  from   AngelNseCM.MTFTrade.dbo.MTF_Avilable_Cash with(nolock) where party_code in (select distinct party_code from #partycode) 
  group by party_code  
 
 update #final set MTF_Available_Cash=b.MTF_Available_Cash  from #MTFcltop b                                                   
 where #final.party_code=b.party_code 


 --update #final set margin=-b.margin_total  from #aa b                                                   
 --where #final.party_code=b.party_code 
 
 declare @MARGINDATE AS DATETIME  , @MARGINDATE_peak AS DATETIME    
           
SELECT @MARGINDATE=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock)   
SELECT @MARGINDATE_peak=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock)   
 
select TDAY_MARGIN/*+TDAY_MTM*/ as margin ,party_code,margindate into #margin from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock) where margindate=@MARGINDATE--'2020-12-29 00:00:00.000'    
  
select party_code, SUM(margin) as Margin into #mar from #margin group by party_code  
    
select /*TDAY_MARGIN*//*+TDAY_MTM*/0.00 as margin ,party_code,margindate into #marginPk from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock) where margindate=@MARGINDATE_peak--'2020-12-29 00:00:00.000'    
  
select party_code, SUM(margin) as Margin into #marpk from #marginPk group by party_code  
  
 SELECT party_code, MAX(Margin) as margin    
  into #mainMargin FROM    
  (    
   SELECT party_code, MAX(margin) as  Margin   
   FROM #mar     
   GROUP BY party_code    
   UNION ALL    
   SELECT party_code, MAX(margin) as   Margin  
   FROM #marpk     
   GROUP BY party_code    
  ) as subQuery    
  GROUP BY party_code   
  
 update #final set margin=-b.margin  from #mainMargin b                                                   
 where #final.party_code=b.party_code 
 /*******************For Reducing mf pending orders in MTF Payout**********/      
 /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF     
DECLARE @Days VARCHAR(20)                            
                            
 SET @Days = (                            
   SELECT DATENAME(dw, GETDATE())                            
   )       
                              
IF (@Days = 'Monday' OR @Days = 'Saturday')                            
BEGIN           
       
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal_sat         
 from       
 risk.dbo.vw_MutualFundPendingOrder_NCMS_sat o  with(nolock)      
 group by clientcode      
      
 insert into MTF_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)      
 select cltcode,amount,getdate() from #MFFundFinal_sat      
 
 update #final set MFPendingOrder=-b.amount  from #MFFundFinal_sat b                                                   
 where #final.party_code=b.cltcode   
      
 --drop table #segmentwise_pendingorders_sat      
 --drop table #MFFundFinal_sat      
end    
else      
begin      
   
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal         
 from       
 risk.dbo.vw_MutualFundPendingOrder_NCMS o with(nolock)       
 group by clientcode      
      
 insert into MTF_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)      
 select cltcode,amount,getdate() from #MFFundFinal      
      
 update #final set MFPendingOrder=-b.amount  from #MFFundFinal b                                                   
 where #final.party_code=b.cltcode    
     
 --drop table #segmentwise_pendingorders      
 --drop table #MFFundFinal      
end        
*/
/*****************************************************/  
--#final where margin<0='madn1050' 

update #final set netl=Netl+margin/*+AccruedCharges*/+[ShortSellValue_Into_120%]+UnRecoCr+MTF_Available_Cash+MFPendingOrder+MarginShortfall

Select distinct sauda_date,sett_no,party_code,Netamt,isin,qty into #MktPosition from AngelNseCM.mtftrade.dbo.TBL_PRODUCT_POSITION with(Nolock)
where sell_buy =1 and ADJUST_DATE ='2049-12-31 23:59:00.000' and party_code in (select distinct party_code from #final) and qty>0 order by sauda_date

select sauda_date,party_code,isin,sum(qty) qty,SUM(netamt) netamt into #cv from #MktPosition 
group by party_code,isin,sauda_date

select MIN(sauda_date)sauda_date,party_code,isin,CONVERT(money,0.00) as PositionAmt,CONVERT(int,0) as Qty,CONVERT(money,0.00) as PositionRate into #aa1 from #cv 
--#aa1 where party_code='PPYL174' and isin='INE095N01031'
group by party_code,isin


update #aa1 set PositionAmt=m.Netamt,Qty=m.qty from #cv m where #aa1.party_code=m.party_code and #aa1.isin=m.isin and #aa1.sauda_date=m.sauda_date

update #aa1 set PositionRate=PositionAmt/qty

alter table #final add PositionRate money

update #final set PositionRate=m.PositionRate from #aa1 m where #final.party_code=m.party_code and #final.isin=m.isin 

/*******Added on 07 Sep 2022***********/
update #final set PositionRate=convert(money,MTM_Price) from #Combine_Closing_File m where #final.isin=m.Security_ISIN and #final.PositionRate is null
/******************/
 --select *,case when BrokingLedger<netl then BrokingLedger
 --             when BrokingLedger>Netl then Netl else netl end  as FinalNet into #netdebit from #final

select *,case when BrokingLedgerAdWithAccrual<netl then BrokingLedgerAdWithAccrual
              when BrokingLedgerAdWithAccrual>Netl then Netl else netl end  as FinalNet into #netdebit from #final
	
	
alter table #netdebit add ReleasedQty int
alter table #netdebit add BlockedQty int

--commented on 24 Mar2023/*update a set ReleasedQty=qty,BlockedQty=0  from #netdebit a,MTF_Exception_ISIN b  where a.isin=b.ISIN and FinalNet>0*/ --added on 06 Jan 2023 as per JIRA ORE-1959

update #netdebit set ReleasedQty=0,BlockedQty=qty where /*BrokingLedger*/BrokingLedgerAdWithAccrual<0
update #netdebit set ReleasedQty=0,BlockedQty=qty  where FinalNet<0 and /*BrokingLedger*/BrokingLedgerAdWithAccrual>0  

update #netdebit set ReleasedQty=0,BlockedQty=qty  where PositionRate is null

update #netdebit set ReleasedQty=qty,BlockedQty=0   where FinalNet>=0 and FinalNet>=mtf_ledger*-1 and PositionRate is not null

alter table #netdebit add ReleasedValue money

update a set ReleasedValue=releasedQty* PositionRate from #netdebit a where  isnull(PositionRate,0)>0  and  ReleasedQty<>0
 
 select id=row_number() over(order by  sett_no )          
,denseid=dense_rank() over(order by party_code),
[PRiority]=(Case
	when isin='INE001A01036' then '1'
	else '2' end),
scrip_shortage=case when isnull(PositionRate,0.00)=0 then total else isnull(PositionRate,0)*Qty end
,adjval=convert(money,0),bal=convert(money,0) ,         
*          
into #holding          
from #netdebit where  /*BrokingLedger*/BrokingLedgerAdWithAccrual>0 and ReleasedQty is null and blockedqty is null
 
select 
id,denseid,
sqoffsseg=row_number() over(partition by party_code order by [PRiority],scrip_shortage  )/*Added on 27Jan 2022*/ 
,scrip_shortage,adjval,bal,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,
series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,BlockedQty=0
,releasedQty=0,sqoffseq=0,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),
shortagereduction=case when isnull(PositionRate,0.00)=0 then total else isnull(PositionRate,0)*Qty end,shortage=convert(money,0),[holding value after HC]=convert(money,0) ,ReleasedValue=convert(money,0)
into #hld
from #holding-- where party_code='A159174'
order by sqoffsseg

update a set a.shortage=(case when a.FinalNet<0 then (a.FinalNet*-1) else a.FinalNet end)  from #hld a  where a.sqoffsseg=1
--update a set a.shortage=(case when FinalNet<shortagereduction then 0 else a.FinalNet end)  from #hld a  where a.sqoffsseg=1 
/*Added on 27Jan 2022*/  /*Commeted on 07 Jul 2022*/


;with hold_cte as (
select 
sqoffsseg,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,
series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,
BlockedQty,releasedQty,ReleasedValue,
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hld x 
where  sqoffsseg=1 --and party_Code='CP6249'

   
union all
select 
e.sqoffsseg,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,
series,sett_no,sett_type,e.party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,
BlockedQty,releasedQty,ReleasedValue,shortagereduction,
shortage= (ecte.shortage-shortagereduction)
from #hld e inner join (select party_code,sqoffsseg,shortage from  hold_cte) ecte on ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
--and ecte.shortage>0
)
select * into #holdd
from hold_cte option  (maxrecursion 32767) ;

update #holdd set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0 


update a set releasedQty=(case when floor(convert(money,shortagereduction)/convert(money,PositionRate)) <= qty then floor(convert(money,shortagereduction)/convert(money,PositionRate)) else qty end)
from #holdd a where isnull(PositionRate,0)>0 

update a set ReleasedValue=releasedQty* PositionRate from #holdd a where  isnull(PositionRate,0)>0 

update a set releasedQty=0,BlockedQty=qty,ReleasedValue=0 from #holdd a where releasedQty<=0
update a set BlockedQty=isnull(qty,0)-isnull(releasedQty,0) from #holdd a where releasedQty>0

--alter table #netdebit add ReleasedValue money

  update #netdebit set ReleasedQty=isnull(b.ReleasedQty,0),BlockedQty=isnull(b.BlockedQty  ,0),ReleasedValue=ISNULL(b.ReleasedValue,0.00)
   from  
  (  
  select sett_no,party_code,isin,ReleasedQty,qty,BlockedQty,scrip_cd,ReleasedValue from #holdd  
  )b where ltrim(rtrim(#netdebit.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#netdebit.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(#netdebit.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#netdebit.qty))=ltrim(rtrim(b.qty))  

update #netdebit  set ReleasedValue=0.00 where  ReleasedValue is null
update #netdebit set releasedqty=0,blockedqty=qty where releasedqty is null

/****Added on 07 July 2022 by Neha*******************/
--select * into #finalData from #netdebit  where isnull(releasedqty,0)=isnull(qty,0)

--/****Release value reduced from 25000 to 1000 changes done by siva SRE NO: 10335*/

--insert into #finalData
--select * from #netdebit where  blockedqty>=0 and FinalNet>0 and
--BrokingLedgerAdWithAccrual>0 and releasedqty>=0 /*FinalNet>=1000 */
select * into #finalData from #netdebit  where isnull(releasedqty,0)=0 and isnull(blockedqty,0)=0 and FinalNet>0 

insert into #finalData
select * from #netdebit where  isnull(blockedqty,0)>0 and FinalNet>0 and
BrokingLedgerAdWithAccrual>0 and isnull(releasedqty,0)>0 

insert into #finalData
select * from #netdebit where  isnull(blockedqty,0)=0 and FinalNet>0 and
BrokingLedgerAdWithAccrual>0 and isnull(releasedqty,0)>0 

insert into #finalData
select * from #netdebit where  isnull(blockedqty,0)>0 and FinalNet>0 and
BrokingLedgerAdWithAccrual>0 and isnull(releasedqty,0)=0 

/************************/
/*******Added on 09 Jan 2023 for argin benift**********************/
--select * into #finalData from MTF_AutoRelease
 declare @sauda_Date AS DATETIME   
           
SELECT @sauda_Date=MAX(sauda_Date) FROM AngelNseCM.MTFTRADE.dbo.TBL_MTF_DATA with (Nolock)

select * into #MarginBenifit from AngelNseCM.MTFTRADE.dbo.TBL_MTF_DATA with (Nolock) where  sauda_Date=@sauda_Date  and MTFNONCASHCOLLATERAL=0

select a.*,b.CURR_CL_RATE,b.margin_req,case when PositionRate>CURR_CL_RATE then (PositionRate-CURR_CL_RATE)*ReleasedQty else 0 end MTMRelease,
convert(decimal(18,2),(margin_req/a.qty)*ReleasedQty) as MarginRelease 
into #MTF_release from #finalData a join
#MarginBenifit b on a.party_code=b.party_code and a.isin=b.isin where a. blockedqty<>0

select *,MTMRelease+MarginRelease as finalRelease,convert(int,0) newReleasedQty,convert(int,0) TotalReleasedQty,
convert(money,0) TotalReleaseValue into #MTF_Final from #MTF_release

/*Added on 01 Mar 2023 by Neha*start*/

update #MTF_Final set finalRelease=case when (MarginShortfall*-1)>finalRelease then 0 
						 when (MarginShortfall*-1)<finalRelease then finalRelease+MarginShortfall end  where finalRelease<>0
/*End**/
update a set newReleasedQty=(case when floor(convert(money,finalRelease)/convert(money,PositionRate)) <= qty then
floor(convert(money,finalRelease)/convert(money,PositionRate)) else qty end)
from #MTF_Final a where isnull(PositionRate,0)>0 

update #MTF_Final set TotalReleasedQty=ReleasedQty+newReleasedQty,TotalReleaseValue=finalRelease+ReleasedValue where newReleasedQty>0 and blockedqty<>0 

select *,convert(money,0) CURR_CL_RATE,convert(money,0) margin_req,convert(money,0) MTMRelease,convert(money,0) MarginRelease,
convert(money,0) finalRelease,convert(int,0) newReleasedQty,convert(int,0) TotalReleasedQty,
convert(money,0) TotalReleaseValue into #finalData_MTFPO from #finalData

 update #finalData_MTFPO set CURR_CL_RATE=isnull(b.CURR_CL_RATE,0),margin_req=isnull(b.margin_req  ,0),MTMRelease=ISNULL(b.MTMRelease,0.00)
 ,MarginRelease=ISNULL(b.MarginRelease,0.00),finalRelease=ISNULL(b.finalRelease,0.00),newReleasedQty=isnull(b.newReleasedQty,0),
 TotalReleasedQty=case when b.newReleasedQty>0 and b.blockedqty<>0  then b.TotalReleasedQty else #finalData_MTFPO.ReleasedQty end,TotalReleaseValue=isnull(b.TotalReleaseValue,0)
   from  
  (  
  select sett_no,party_code,isin,ReleasedQty,qty,BlockedQty,scrip_cd,ReleasedValue,CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,
  finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue from #MTF_Final 
  )b where ltrim(rtrim(#finalData_MTFPO.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#finalData_MTFPO.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(#finalData_MTFPO.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#finalData_MTFPO.qty))=ltrim(rtrim(b.qty))  
 
  update #finalData_MTFPO set TotalReleasedQty=ReleasedQty,TotalReleaseValue=ReleasedValue  where TotalReleasedQty=0

update #finalData_MTFPO set TotalReleaseValue=ReleasedValue  where newreleasedqty=0 and TotalReleaseValue=0
 /********************************/

truncate table MTF_AutoRelease_11Aug2025

insert into MTF_AutoRelease_11Aug2025(BrokingLedger,MTf_Ledger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,isin,
scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,
[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,
MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue,noncash,
margin_new
) 
select isnull(BrokingLedger,0)BrokingLedger,isnull(MTf_Ledger,0)MTf_Ledger,isnull(Value_AHC_UnsettNonMTF_Trade,0)Value_AHC_UnsettNonMTF_Trade
,isnull(Value_AHC_Cusa,0)Value_AHC_Cusa,isnull(Margin_Pledge_final_AHC,0)Margin_Pledge_final_AHC,isnull(NetLedger,0)NetLedger,
isnull(AccruedCharges,0)AccruedCharges,isnull(isin,'')isin,
isnull(scrip_cd,'')scrip_cd,isnull(series,'')series,isnull(sett_no,0)sett_no,isnull(sett_type,0)sett_type,isnull(party_Code,'')party_Code
,isnull(bs,'')bs,isnull(exchange,'')exchange,isnull(qty,0)qty,isnull(clsrate,0)clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,isnull(scripname,'')scripname,partyname,
[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,
MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,isnull(FinalNet,0) FinalNet,isnull(ReleasedQty,0)ReleasedQty,
isnull(BlockedQty,0)BlockedQty,isnull(ReleasedValue,0)ReleasedValue,
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,isnull(finalRelease,0)finalRelease,isnull(newReleasedQty,0)newReleasedQty,isnull(TotalReleasedQty,0)TotalReleasedQty,
isnull(TotalReleaseValue,0)TotalReleaseValue,isnull(Noncash,0)Noncash,isnull(Margin_new,0)Margin_new
from #finalData_MTFPO
 
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MTF_Request_Process_16Oct2023
-- --------------------------------------------------
  
create PROCEDURE [dbo].[USP_MTF_Request_Process_16Oct2023]  
AS  
BEGIN  
  
select * into #partyCode from [CSOKYC-6].general.dbo.rms_holding with(nolock) where accno='1203320030135829'  
  
--delete from #partyCode where isin='INE081A01012'  
  
/*  
select party_code,BSE_Ledger+NSE_Ledger+NSEFO_Ledger+MCD_Ledger+NSX_Ledger+MCX_Ledger+NCDEX_Ledger as BrokingLedger,MTf_Ledger,margin_total,unreco_credit  
,Coll_TotalHC as NonCash into #aa from  [CSOKYC-6].general.dbo.tbl_rms_collection_cli with (nolock) where party_code in (select distinct party_code from #partyCode)   
*/ /*Commented on 08 July 2022 for removing dependency from NRMS*/  
  
/*****Add Bo source*******************/  
  
declare @sdtcur as datetime,@Todate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()                
    
/*Code added to handle Financial year end issue on 3rd April 2017*/    
/********************************************************************************/    
declare @ccsy datetime,@ccse datetime    
set @ccsy=@sdtcur    
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'    
    
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter where ldtcur        =    
(select ldtprv from AngelBSECM.account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE())   
   
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #MTFclient                 
  from AngelNseCM.MTFTRADE.dbo.ledger  a with (nolock)                  
  where VDT>=@sdtcur and  VDT <= @Todate                     
   /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountncdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
   group by cltcode  
  
     select * into #MTFOpn from #MTFclient where cltcode in (select party_code from #partyCode)                     
  
    
  select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)         
  INTO #BSECMcltop                                 
  from AngelBSECM.account_ab.dbo.ledger a with (nolock)                     
  where VDT>=@sdtcur and VDT <= @Todate --  and cltcode in (select party_code from #partyCode)     
   /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from anand.account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode       
        
    select * into #BSECMOpn from #BSECMcltop where cltcode in (select party_code from #partyCode)       
                 
      
 select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)   
  into  #NSECMcltop                 
  from AngelNseCM.account.dbo.ledger a with (nolock)                         
  where VDT>=@sdtcur and VDT <= @Todate         
   /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from anand1.account.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode        
        
  select * into #NSECMOpn from #NSECMcltop where cltcode in (select party_code from #partyCode)       
      
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)            
  into #NSEFOcltop                  
  from angelfo.accountfo.dbo.ledger a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate      
    /*Added to exclude opening balance of current year*/    
 -- /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelfo.accountfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode                      
      
  select * into #NSEFOOpn from #NSEFOcltop where cltcode in (select party_code from #partyCode)                    
    
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #NSXcltop                  
  from angelfo.accountcurfo.dbo.ledger a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate     
     /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelfo.accountcurfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode           
        
    select * into #NSXOpn from #NSXcltop where cltcode in (select party_code from #partyCode)                    
        
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #BSXcltop                  
  from angelcommodity.ACCOUNTcurbfo.dbo.ledger  a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate     
   /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTcurbfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode       
        
      select * into #BSXOpn from #BSXcltop where cltcode in (select party_code from #partyCode)                    
   
  select CLTCODE,            
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #MCDcltop                  
  from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate       
  /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdxcds.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode                      
        
   select * into #MCDOpn from #MCDcltop where cltcode in (select party_code from #partyCode)                    
      
   
  select CLTCODE,                      
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #MCDXcltop                      
  from angelcommodity.accountmcdx.dbo.ledger a with (nolock)                             
  where VDT>=@sdtcur and  VDT <= @Todate     
   /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode                          
          
   select * into #MCDXOpn from #MCDXcltop where cltcode in (select party_code from #partyCode)           
                          
  select CLTCODE,                      
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)        
  into #NCDXcltop                     
  from angelcommodity.accountncdx.dbo.ledger a with (nolock)                             
  where VDT>=@sdtcur and  VDT <= @Todate        
   /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountncdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode       
        
  select * into #NCDXOpn from #NCDXcltop where cltcode in (select party_code from #partyCode)                     
   
 /*************BSEFO*********************************/  
 --uncomment below query when making BSEFO live  
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #BSEFOcltop                  
  from angelcommodity.ACCOUNTBFO.dbo.ledger  a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate     
   /*Added to exclude opening balance of current year*/    
 /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTBFO.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
  and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode       
        
  select * into #BSEFOOpn from #BSEFOcltop where cltcode in (select party_code from #partyCode)                    
 /***************************************************/  
 select * into #Bal from (                                                
  select * from #NSECMOpn                  
  union all                                                
  select * from #BSECMOpn     
  union all                                                
  select * from #NSEFOOpn     
  union all                                                
  select * from #NSXOpn     
  union all                                                
  select * from #MCDOpn     
  --union all                                                
  --select * from #MTFOpn                        
  union all                                      
  select * from #MCDXOpn                                             
  union all                                                
  select * from #NCDXOpn                                                                      
  union all                                                
  select * from #BSXOpn   
  --uncomment below query when making BSEFO live  
  union all  
  select * from #BSEFOOpn  
  )x  
  
  select cltcode,sum(vbal) as BrokingLedger into #BrokingValue from #Bal group by cltcode  
    
  select cltcode ,sum(vbal) as MTf_Ledger into #mtfvalue from   #MTFOpn  group by cltcode     
    
  select cltcode as party_code,sum(BrokingLedger) BrokingLedger,sum(MTf_Ledger) MTf_Ledger into #aa from  
  (  
  select cltcode,isnull(BrokingLedger,0.00) BrokingLedger, CONVERT(money,0.00) MTf_Ledger from #BrokingValue  
  union all  
  select cltcode,CONVERT(money,0.00) BrokingLedger,ISNULL(MTf_Ledger,0.00) MTf_Ledger from #mtfvalue  
  )x group by cltcode  
  
/***********************/  
  
select * into #client_col from  [CSOKYC-6].GENERAL.DBO.client_collaterals with(nolock)     
select Security_Symbol,Security_ISIN,MAX(mtm_price) as mtm_price  into #Combine_Closing_File from [CSOKYC-6].GENERAL.DBO.Combine_Closing_File with(nolock) group by Security_Symbol,Security_ISIN    
  
/******Start*********************Unsettle Non MTF Trade*********************************/  
select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,    
CONVERT(MONEY, 0) as Value_BHC_unsett,    
CONVERT(MONEY, 0) as Value_AHC_unsett    
  into #mtf from AngelDemat.msajag.dbo.unclear_Hold_New  a with(nolock) left join    
#Combine_Closing_File b with(nolock) on    
a.I_isin=b.security_isin left join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.I_isin=c.[isin no] where   
party_code in (select party_code from #partycode)   
      
update #mtf set Value_BHC_unsett=qty*MTM_Price_unsett    
update #mtf set Value_AHC_unsett=isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)    
    
select SUM(Value_AHC_unsett) as Value_AHC_UnsettNonMTF_Trade,party_code into #MTF_Codes from #mtf group by party_code   
/*****End*******************************************/  
  
/*****start***************CUSA Payout *****************************/  
select BlockedQty,MTM_Price,party_Code,Var_margin_cusa,CONVERT(money,0.00) as Value_BHC_CUSA,CONVERT(money,0.00) as Value_AHC_Cusa into #Cusa   
from cusa_po with(nolock) where party_code in (select party_code from #partycode) and Seq_approve_status in ('Blocked' ,'Partially Released')     
  
update #Cusa set Value_BHC_CUSA=BlockedQty*MTM_Price    
update #Cusa set Value_AHC_Cusa=isnull(Value_BHC_CUSA,0)-(isnull(Value_BHC_CUSA,0)*isnull(Var_margin_cusa,0)/100)    
select sum(Value_AHC_Cusa) as Value_AHC_Cusa,party_Code into #Cusa_Codes from #Cusa /*where party_code in (select party_code from #partycode) and Seq_approve_status='Blocked'    */  
group by party_code  
/*****End***************************************************/  
  
/*****Start*****************Margin Pleadge-Unpleadge*******************/  
 /******Margin**/     
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty into #MarginPleadge  from AngelDemat.msajag.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'    
group by bcltdpid,party_code,certno,sett_no    
union all    
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty  from AngelDemat.bsedb.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'    
group by bcltdpid,party_code,certno,sett_no    
  
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,    
CONVERT(MONEY, 0) as Var_margin,    
CONVERT(varchar(10), '') as series,    
CONVERT(MONEY, 0) as Value_BHC,    
CONVERT(MONEY, 0) as Value_AHC    
  into #marPledge from #MarginPleadge a left join   #Combine_Closing_File b with(nolock) on  
a.certno=b.security_isin where  party_code in (select party_code from #partycode)  
  
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre from #client_col where party_code in (select distinct party_code from #marPledge)    
   
    
update #marPledge set series=b.series,var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre b    
where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin     
     
update #marPledge set MTM_Price=b.cl_rate from #wre b where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin and #marPledge.MTM_Price=0.00    
    
    
update #marPledge set Value_BHC=qty*MTM_Price    
update #marPledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)    
    
select SUM(Value_AHC) as Margin_pleadge_AHC,party_code into #marPledge_Final from #marPledge group by party_code    
      
/*****Unpleadge**/  
select party_code,scrip,isin,sum(markedqty) as qty into #unpledge_code from tbl_UnpledgeFile with(nolock) where party_code in (select party_code from #partycode)  
 group by party_code,scrip,isin  
  
  
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,  
CONVERT(MONEY, 0) as Var_margin,    
CONVERT(MONEY, 0) as Value_BHC,    
CONVERT(MONEY, 0) as Value_AHC    
  into #unpledge from #unpledge_code a left join #Combine_Closing_File b with(nolock) on   
a.isin=b.security_isin    
    
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre1 from #client_col where party_code in (select distinct party_code from #unpledge_code)    
    
    
update #unpledge set var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre1 b    
where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin     
     
update #unpledge set MTM_Price=b.cl_rate from #wre1 b where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin and #unpledge.MTM_Price=0.00    
    
    
update #unpledge set Value_BHC=qty*MTM_Price    
update #unpledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)   
  
select sum(Value_AHC) as Unpledge_AHC,party_Code into #unpledge_codes from #unpledge   group by party_code    
  
select a.party_code,isnull(Margin_pleadge_AHC,0.00)-isnull(Unpledge_AHC,0.00)  as Margin_Pledge_final_AHC into #Final_Margin_Pledge   
from #marPledge_Final a left join #unpledge_codes b on a.party_code=b.party_code  
  
update #Final_Margin_Pledge set Margin_Pledge_final_AHC=0.00 where Margin_Pledge_final_AHC<0  
  
/******End*******************************************************/  
  
 select party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                     
 from misc.dbo.Accrued_PenalCharges with (nolock) where party_code in (select party_code from #partycode) group by party_code   
   
 /******added new margin peneality charges on 05 Jul 2021***********************************/      
 insert into #Accrued1      
 select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) where party_code in (select party_code from #partycode) group by party_code                
   
   
insert into  #Accrued1  
SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)  
where cnt_Date=(select max(cnt_Date) from AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))  and cltcode in (select party_code from #partycode)   
group by cltcode  
  
insert into  #Accrued1  
SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock),AngelNseCM.MSAJAG.DBO.client_details c(Nolock)  
where  PCN_Date=(select max(PCN_Date) from AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock)) and j.cl_code in (select party_code from #partycode)   
 and J.cl_code=c.cl_code  
group by J.cl_code   
      
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                             
      
 /****************************************/    
  
select e.BrokingLedger,e.MTf_Ledger,isnull(Value_AHC_UnsettNonMTF_Trade,0.00)Value_AHC_UnsettNonMTF_Trade,isnull(Value_AHC_Cusa,0.00)Value_AHC_Cusa,  
isnull(Margin_Pledge_final_AHC,0.00)Margin_Pledge_final_AHC,CONVERT(money,0.00) as NetLedger,CONVERT(money,0.00) as AccruedCharges   
,a.* into #main1 from #partyCode a   
left join #aa e on a.party_code=e.party_code   
left join #MTF_Codes b on a.party_code=b.party_code   
left join #Cusa_Codes c on a.party_code=c.party_code   
left join #Final_Margin_Pledge d on a.party_code=d.party_code   
  
  
 update #main1 set AccruedCharges=-DeductEQ  from #Accrued b                                                     
 where #main1.party_code=b.party_code    
   
 select *,BrokingLedger+AccruedCharges as BrokingLedgerAdWithAccrual into #main11 from #main1                                         
  
select *,BrokingLedgerAdWithAccrual+Value_AHC_UnsettNonMTF_Trade+Value_AHC_Cusa+Margin_Pledge_final_AHC as Netl into #nn from #main11  
  
  
select *,CONVERT(money,0.00) as margin,CONVERT(money,0.00) as [ShortSellValue_Into_120%],CONVERT(money,0.00) as UnRecoCr ,  
CONVERT(money,0.00) as MTF_Available_Cash,CONVERT(money,0.00) as MFPendingOrder,CONVERT(money,0.00) as MarginShortfall into #final from #nn /* a left join Cusa_Po b on a.party_code=b.party_code  
and a.isin=b.isin and a.sett_no=b.sett_no*/  
  
  
create table #MarginShortfall(  
REPORTDATE varchar(20),PARTY_CODE varchar(50),PARTY_NAME varchar(100),BRANCH_cD varchar(50),SUB_BROKER varchar(30),FUDEDVAL money,MTOM money,MARGIN_REQ money,  
FUDEDVALAFM money,MTFLEDBAL money,AVALABLECASH money,COLLATERALBHC money,COLLATERALAHC money,MARGIN_SHORTFALL money,ORDERBYDATE varchar(20))  
  
declare @mdate as varchar(11),@dd as varchar(11)            
           
--select @mdate=max(vdt)+1 from AngelNseCM.account.dbo.ledger WITH(NOLOCK)            
--where vtyp=15 and vdt <=convert(varchar(11),getdate())            
--and narration like 'SETTNO=_______NSECMNBill Posted'              
           
select top 1 @mdate=start_date            
from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)            
where co_code='BSECM' and sett_type='D'            
and start_Date >=convert(varchar(11),getdate())-- @mdate              
order by Start_date      
    
select top 2 start_date,Row_number() Over(Order By start_Date desc) As Row_num            
into #day3          
from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)            
where co_code='BSECM'            
and sett_type='D'            
and start_Date <= @mdate     
  
select @dd =convert(varchar(11),Start_date)     from #day3 where Start_date< convert(varchar(11),getdate())    
print @dd  
insert into #MarginShortfall                       
EXEC AngelNseCM.MTFTrade.dbo.RPT_MTF_SUMMARY 'BROKER', 'BROKER', @dd,@dd, '0', 'ZZZZZZ'        
  
update #final set MarginShortfall=MARGIN_SHORTFALL from                                                    
(select party_code,MARGIN_SHORTFALL=SUM(MARGIN_SHORTFALL) from #MarginShortfall where MARGIN_SHORTFALL<0 group by party_Code having sum(MARGIN_SHORTFALL) <> 0) b                      
 where   #final.party_Code=b.party_Code     
  
--truncate table #MarginShortfall     
                                                   
 update #final set [ShortSellValue_Into_120%]=-(b.shrtval*1.2) from                                                    
(select party_code,shrtval=SUM(SHORT_VALUE) from ncms_shortsell with(nolock) group by party_Code having sum(SHORT_VALUE) <> 0) b                      
 where   #final.party_Code=b.party_Code     
   
 select cltcode,SUM(Cramt) as UnRecoCr into #unreco from  AngelBSECM.inhouse.dbo.BO_client_deposit_recno with (nolock) where cltcode in (select distinct party_code from #partycode)  group by cltcode  
  
 insert into #unreco  
 select cltcode,SUM(Cramt) as UnRecoCr from  AngelNseCM.inhouse.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode  
    
  insert into #unreco  
 select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode              
   
 insert into #unreco  
select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse_curfo.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode        
  
 insert into #unreco  
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_BSX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode               
  
 insert into #unreco  
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.INHOUSE_MCDCS.dbo.BO_client_deposit_recno with (nolock) where cltcode in (select distinct party_code from #partycode) group by cltcode            
  
 insert into #unreco  
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_MCDX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode                 
  
 insert into #unreco  
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_NCDX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode  
--uncomment below query when making BSEFO live  
--insert into #unreco  
--select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.bsefo.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode  
  
select cltcode , SUM(UnRecoCr) as UnRecoCr into #UnrecoCr from #unreco group by cltcode  
   
 update #final set UnRecoCr=-b.UnRecoCr  from #UnrecoCr b                                                     
 where #final.party_code=b.cltcode   
   
 select party_code ,MTF_Available_Cash=case when SUM(Available_Cash_bal)>0 then 0 else SUM(Available_Cash_bal) end  
  into #MTFcltop       
  from   AngelNseCM.MTFTrade.dbo.MTF_Avilable_Cash with(nolock) where party_code in (select distinct party_code from #partycode)   
  group by party_code    
   
 update #final set MTF_Available_Cash=b.MTF_Available_Cash  from #MTFcltop b                                                     
 where #final.party_code=b.party_code   
  
  
 --update #final set margin=-b.margin_total  from #aa b                                                     
 --where #final.party_code=b.party_code   
   
 declare @MARGINDATE AS DATETIME  , @MARGINDATE_peak AS DATETIME      
             
SELECT @MARGINDATE=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock)     
SELECT @MARGINDATE_peak=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock)     
   
select TDAY_MARGIN/*+TDAY_MTM*/ as margin ,party_code,margindate into #margin from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock) where margindate=@MARGINDATE--'2020-12-29 00:00:00.000'      
    
select party_code, SUM(margin) as Margin into #mar from #margin group by party_code    
      
select /*TDAY_MARGIN*//*+TDAY_MTM*/0.00 as margin ,party_code,margindate into #marginPk from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock) where margindate=@MARGINDATE_peak--'2020-12-29 00:00:00.000'      
    
select party_code, SUM(margin) as Margin into #marpk from #marginPk group by party_code    
    
 SELECT party_code, MAX(Margin) as margin      
  into #mainMargin FROM      
  (      
   SELECT party_code, MAX(margin) as  Margin     
   FROM #mar       
   GROUP BY party_code      
   UNION ALL      
   SELECT party_code, MAX(margin) as   Margin    
   FROM #marpk       
   GROUP BY party_code      
  ) as subQuery      
  GROUP BY party_code     
    
 update #final set margin=-b.margin  from #mainMargin b                                                     
 where #final.party_code=b.party_code   
 /*******************For Reducing mf pending orders in MTF Payout**********/        
 /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF       
DECLARE @Days VARCHAR(20)                              
                              
 SET @Days = (                              
   SELECT DATENAME(dw, GETDATE())                              
   )         
                                
IF (@Days = 'Monday' OR @Days = 'Saturday')                              
BEGIN             
         
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal_sat           
 from         
 risk.dbo.vw_MutualFundPendingOrder_NCMS_sat o  with(nolock)        
 group by clientcode        
        
 insert into MTF_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)        
 select cltcode,amount,getdate() from #MFFundFinal_sat        
   
 update #final set MFPendingOrder=-b.amount  from #MFFundFinal_sat b                                                     
 where #final.party_code=b.cltcode     
        
 --drop table #segmentwise_pendingorders_sat        
 --drop table #MFFundFinal_sat        
end      
else        
begin        
     
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal           
 from         
 risk.dbo.vw_MutualFundPendingOrder_NCMS o with(nolock)         
 group by clientcode        
        
 insert into MTF_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)        
 select cltcode,amount,getdate() from #MFFundFinal        
        
 update #final set MFPendingOrder=-b.amount  from #MFFundFinal b                                                     
 where #final.party_code=b.cltcode      
       
 --drop table #segmentwise_pendingorders        
 --drop table #MFFundFinal        
end          
*/  
/*****************************************************/    
--#final where margin<0='madn1050'   
  
update #final set netl=Netl+margin/*+AccruedCharges*/+[ShortSellValue_Into_120%]+UnRecoCr+MTF_Available_Cash+MFPendingOrder+MarginShortfall  
  
Select distinct sauda_date,sett_no,party_code,Netamt,isin,qty into #MktPosition from AngelNseCM.mtftrade.dbo.TBL_PRODUCT_POSITION with(Nolock)  
where sell_buy =1 and ADJUST_DATE ='2049-12-31 23:59:00.000' and party_code in (select distinct party_code from #final) and qty>0 order by sauda_date  
  
insert into tbl_Postion_MTF  
select *,getdate() from #MktPosition  
  
select sauda_date,party_code,isin,sum(qty) qty,SUM(netamt) netamt into #cv from #MktPosition   
group by party_code,isin,sauda_date  
  
select MIN(sauda_date)sauda_date,party_code,isin,CONVERT(money,0.00) as PositionAmt,CONVERT(int,0) as Qty,CONVERT(money,0.00) as PositionRate into #aa1 from #cv   
--#aa1 where party_code='PPYL174' and isin='INE095N01031'  
group by party_code,isin  
  
  
update #aa1 set PositionAmt=m.Netamt,Qty=m.qty from #cv m where #aa1.party_code=m.party_code and #aa1.isin=m.isin and #aa1.sauda_date=m.sauda_date  
  
update #aa1 set PositionRate=PositionAmt/qty  
  
alter table #final add PositionRate money  
  
update #final set PositionRate=m.PositionRate from #aa1 m where #final.party_code=m.party_code and #final.isin=m.isin   
  
/*******Added on 07 Sep 2022***********/  
update #final set PositionRate=convert(money,MTM_Price) from #Combine_Closing_File m where #final.isin=m.Security_ISIN and #final.PositionRate is null  
/******************/  
 --select *,case when BrokingLedger<netl then BrokingLedger  
 --             when BrokingLedger>Netl then Netl else netl end  as FinalNet into #netdebit from #final  
  
select *,case when BrokingLedgerAdWithAccrual<netl then BrokingLedgerAdWithAccrual  
              when BrokingLedgerAdWithAccrual>Netl then Netl else netl end  as FinalNet into #netdebit from #final  
   
   
alter table #netdebit add ReleasedQty int  
alter table #netdebit add BlockedQty int  
  
--commented on 24 Mar2023/*update a set ReleasedQty=qty,BlockedQty=0  from #netdebit a,MTF_Exception_ISIN b  where a.isin=b.ISIN and FinalNet>0*/ --added on 06 Jan 2023 as per JIRA ORE-1959  
  
update #netdebit set ReleasedQty=0,BlockedQty=qty where /*BrokingLedger*/BrokingLedgerAdWithAccrual<0  
update #netdebit set ReleasedQty=0,BlockedQty=qty  where FinalNet<0 and /*BrokingLedger*/BrokingLedgerAdWithAccrual>0    
  
update #netdebit set ReleasedQty=0,BlockedQty=qty  where PositionRate is null  
  
update #netdebit set ReleasedQty=qty,BlockedQty=0   where FinalNet>=0 and FinalNet>=mtf_ledger*-1 and PositionRate is not null  
  
alter table #netdebit add ReleasedValue money  
  
update a set ReleasedValue=releasedQty* PositionRate from #netdebit a where  isnull(PositionRate,0)>0  and  ReleasedQty<>0  
   
 select id=row_number() over(order by  sett_no )            
,denseid=dense_rank() over(order by party_code),  
[PRiority]=(Case  
 when isin='INE001A01036' then '1'  
 else '2' end),  
scrip_shortage=case when isnull(PositionRate,0.00)=0 then total else isnull(PositionRate,0)*Qty end  
,adjval=convert(money,0),bal=convert(money,0) ,           
*            
into #holding            
from #netdebit where  /*BrokingLedger*/BrokingLedgerAdWithAccrual>0 and ReleasedQty is null and blockedqty is null  
   
select   
id,denseid,  
sqoffsseg=row_number() over(partition by party_code order by [PRiority],scrip_shortage  )/*Added on 27Jan 2022*/   
,scrip_shortage,adjval,bal,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,  
series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,  
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,BlockedQty=0  
,releasedQty=0,sqoffseq=0,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),  
shortagereduction=case when isnull(PositionRate,0.00)=0 then total else isnull(PositionRate,0)*Qty end,shortage=convert(money,0),[holding value after HC]=convert(money,0) ,ReleasedValue=convert(money,0)  
into #hld  
from #holding-- where party_code='A159174'  
order by sqoffsseg  
  
update a set a.shortage=(case when a.FinalNet<0 then (a.FinalNet*-1) else a.FinalNet end)  from #hld a  where a.sqoffsseg=1  
--update a set a.shortage=(case when FinalNet<shortagereduction then 0 else a.FinalNet end)  from #hld a  where a.sqoffsseg=1   
/*Added on 27Jan 2022*/  /*Commeted on 07 Jul 2022*/  
  
  
;with hold_cte as (  
select   
sqoffsseg,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,  
series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,  
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,  
BlockedQty,releasedQty,ReleasedValue,  
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,  
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hld x   
where  sqoffsseg=1 --and party_Code='CP6249'  
  
     
union all  
select   
e.sqoffsseg,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,  
series,sett_no,sett_type,e.party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,  
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,  
BlockedQty,releasedQty,ReleasedValue,shortagereduction,  
shortage= (ecte.shortage-shortagereduction)  
from #hld e inner join (select party_code,sqoffsseg,shortage from  hold_cte) ecte on ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
--and ecte.shortage>0  
)  
select * into #holdd  
from hold_cte option  (maxrecursion 32767) ;  
  
update #holdd set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0   
  
  
update a set releasedQty=(case when floor(convert(money,shortagereduction)/convert(money,PositionRate)) <= qty then floor(convert(money,shortagereduction)/convert(money,PositionRate)) else qty end)  
from #holdd a where isnull(PositionRate,0)>0   
  
update a set ReleasedValue=releasedQty* PositionRate from #holdd a where  isnull(PositionRate,0)>0   
  
update a set releasedQty=0,BlockedQty=qty,ReleasedValue=0 from #holdd a where releasedQty<=0  
update a set BlockedQty=isnull(qty,0)-isnull(releasedQty,0) from #holdd a where releasedQty>0  
  
--alter table #netdebit add ReleasedValue money  
  
  update #netdebit set ReleasedQty=isnull(b.ReleasedQty,0),BlockedQty=isnull(b.BlockedQty  ,0),ReleasedValue=ISNULL(b.ReleasedValue,0.00)  
   from    
  (    
  select sett_no,party_code,isin,ReleasedQty,qty,BlockedQty,scrip_cd,ReleasedValue from #holdd    
  )b where ltrim(rtrim(#netdebit.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#netdebit.isin))=ltrim(rtrim(b.isin))    
  and ltrim(rtrim(#netdebit.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#netdebit.qty))=ltrim(rtrim(b.qty))    
  
update #netdebit  set ReleasedValue=0.00 where  ReleasedValue is null  
update #netdebit set releasedqty=0,blockedqty=qty where releasedqty is null  
  
/****Added on 07 July 2022 by Neha*******************/  
select * into #finalData from #netdebit  where releasedqty=qty  
  
/****Release value reduced from 25000 to 1000 changes done by siva SRE NO: 10335*/  
  
insert into #finalData  
select * from #netdebit where FinalNet>=1000 and blockedqty>0 and FinalNet>0 and  
BrokingLedgerAdWithAccrual>0 and releasedqty>0  
/************************/  
/*******Added on 09 Jan 2023 for argin benift**********************/  
--select * into #finalData from MTF_AutoRelease  
 declare @sauda_Date AS DATETIME     
             
SELECT @sauda_Date=MAX(sauda_Date) FROM AngelNseCM.MTFTRADE.dbo.TBL_MTF_DATA with (Nolock)  
  
select * into #MarginBenifit from AngelNseCM.MTFTRADE.dbo.TBL_MTF_DATA with (Nolock) where  sauda_Date=@sauda_Date  and MTFNONCASHCOLLATERAL=0  
  
select a.*,b.CURR_CL_RATE,b.margin_req,case when PositionRate>CURR_CL_RATE then (PositionRate-CURR_CL_RATE)*ReleasedQty else 0 end MTMRelease,  
convert(decimal(18,2),(margin_req/a.qty)*ReleasedQty) as MarginRelease   
into #MTF_release from #finalData a join  
#MarginBenifit b on a.party_code=b.party_code and a.isin=b.isin where a. blockedqty<>0  
  
select *,MTMRelease+MarginRelease as finalRelease,convert(int,0) newReleasedQty,convert(int,0) TotalReleasedQty,  
convert(money,0) TotalReleaseValue into #MTF_Final from #MTF_release  
  
/*Added on 01 Mar 2023 by Neha*start*/  
  
update #MTF_Final set finalRelease=case when (MarginShortfall*-1)>finalRelease then 0   
       when (MarginShortfall*-1)<finalRelease then finalRelease+MarginShortfall end  where finalRelease<>0  
/*End**/  
update a set newReleasedQty=(case when floor(convert(money,finalRelease)/convert(money,PositionRate)) <= qty then  
floor(convert(money,finalRelease)/convert(money,PositionRate)) else qty end)  
from #MTF_Final a where isnull(PositionRate,0)>0   
  
update #MTF_Final set TotalReleasedQty=ReleasedQty+newReleasedQty,TotalReleaseValue=finalRelease+ReleasedValue where newReleasedQty>0 and blockedqty<>0   
  
select *,convert(money,0) CURR_CL_RATE,convert(money,0) margin_req,convert(money,0) MTMRelease,convert(money,0) MarginRelease,  
convert(money,0) finalRelease,convert(int,0) newReleasedQty,convert(int,0) TotalReleasedQty,  
convert(money,0) TotalReleaseValue into #finalData_MTFPO from #finalData  
  
 update #finalData_MTFPO set CURR_CL_RATE=isnull(b.CURR_CL_RATE,0),margin_req=isnull(b.margin_req  ,0),MTMRelease=ISNULL(b.MTMRelease,0.00)  
 ,MarginRelease=ISNULL(b.MarginRelease,0.00),finalRelease=ISNULL(b.finalRelease,0.00),newReleasedQty=isnull(b.newReleasedQty,0),  
 TotalReleasedQty=case when b.newReleasedQty>0 and b.blockedqty<>0  then b.TotalReleasedQty else #finalData_MTFPO.ReleasedQty end,TotalReleaseValue=isnull(b.TotalReleaseValue,0)  
   from    
  (    
  select sett_no,party_code,isin,ReleasedQty,qty,BlockedQty,scrip_cd,ReleasedValue,CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,  
  finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue from #MTF_Final   
  )b where ltrim(rtrim(#finalData_MTFPO.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#finalData_MTFPO.isin))=ltrim(rtrim(b.isin))    
  and ltrim(rtrim(#finalData_MTFPO.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#finalData_MTFPO.qty))=ltrim(rtrim(b.qty))    
   
  update #finalData_MTFPO set TotalReleasedQty=ReleasedQty,TotalReleaseValue=ReleasedValue  where TotalReleasedQty=0  
  
update #finalData_MTFPO set TotalReleaseValue=ReleasedValue  where newreleasedqty=0 and TotalReleaseValue=0  
 /********************************/  
insert into MTF_AutoRelease_hist(BrokingLedger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,  
isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,  
partyname,[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],  
UnRecoCr,MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,MTf_Ledger,Updatedon,  
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue  
)  
select BrokingLedger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,isin,scrip_cd,series,sett_no,  
sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,[pool],total,DUMMY1,DUMMY2,  
nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,MTF_Available_Cash,MFPendingOrder,  
MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,MTf_Ledger,GETDATE(),  
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue  
from MTF_AutoRelease  
  
truncate table MTF_AutoRelease  
  
insert into MTF_AutoRelease(BrokingLedger,MTf_Ledger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,isin,  
scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,  
[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,  
MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,  
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue  
)   
select BrokingLedger,MTf_Ledger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,isin,  
scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,  
[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,  
MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,  
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue  
from #finalData_MTFPO  
--select *  from #netdebit  where releasedqty=qty /*Commentd on 07 July 2022*/  
  
truncate table MTF_AutoRelease_AllData  
  
insert into MTF_AutoRelease_AllData(BrokingLedger,MTf_Ledger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,  
isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,  
partyname,[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],  
UnRecoCr,MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue)  
select *  from #netdebit  
/*where party_code in (select partycode from [tbl_MTFData_20Oct2021] with(nolock))*/  
  
/*delete from MTF_AutoRelease where party_Code not in (select partycode from [tbl_MTFData_20Oct2021] with(nolock))*/  
  
exec USP_MTFAutoRelease_File_Generation  
  
truncate table MTF_AutoRelease_Heading  
  
 insert into MTF_AutoRelease_Heading(BrokingLedger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges  
 ,isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,  
 partyname,[pool],total,DUMMY500,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],  
 UnRecoCr,MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,MTf_Ledger,  
 CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue  
)  
 select  'BrokingLedger','Value_AHC_UnsettNonMTF_Trade','Value_AHC_Cusa','Margin_Pledge_final_AHC','NetLedger','AccruedCharges','isin','scrip_cd','series','sett_no','sett_type','party_Code','bs','exchange','qty','clsrate','accno','dpid','clid','flag','ab
en',  
 'apool','nben','npool','approved','scripname','partyname','pool','total','DUMMY1','DUMMY2','nse_approved','source','upd_date','AdjQty',  
 'BrokingLedgerAdWithAccrual','Netl','margin','ShortSellValue_Into_120%','UnRecoCr','MTF_Available_Cash','MFPendingOrder','MarginShortfall','PositionRate'  
 ,'FinalNet','ReleasedQty','BlockedQty','ReleasedValue','MTf_Ledger',  
 'CURR_CL_RATE','margin_req','MTMRelease','MarginRelease','finalRelease','newReleasedQty','TotalReleasedQty','TotalReleaseValue'  
  
   
 insert into MTF_AutoRelease_Heading  
 select * from MTF_AutoRelease  
   
  DECLARE @s VARCHAR(MAX) = ''                                          
   /*declare @FileName as varchar(100) = 'LD_File'+replace(CONVERT(char(10),getdate(),103),'/','-')+'.csv'*/      
   declare @FileName as varchar(100) = 'MTF_Release'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                                                 
      declare @FilePath varchar(200) ='' /* '\\196.1.115.183\d$\upload\CMS_Test\'+@FileName  */                         
      --select @FilePath='\\172.29.19.16\public\NehaN\'+@FileName       
    select @FilePath='\\196.1.115.183\cusa_mtf\'+@FileName            
                                       
      SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                           
      SET @s = @s + 'bcp "select * from [196.1.115.132].cms.dbo.MTF_AutoRelease_Heading" queryout '+ @FilePath + ' -c -t, -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                                                       
              
       
             
      SET @s = @s + ''''              
      EXEC(@s)     
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MTF_Request_Process_24July2023
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_MTF_Request_Process_24July2023]  
AS  
BEGIN  
  
select * into #partyCode from [CSOKYC-6].general.dbo.rms_holding with(nolock) where accno='1203320030135829'  
  
--delete from #partyCode where isin='INE081A01012'  
  
/*  
select party_code,BSE_Ledger+NSE_Ledger+NSEFO_Ledger+MCD_Ledger+NSX_Ledger+MCX_Ledger+NCDEX_Ledger as BrokingLedger,MTf_Ledger,margin_total,unreco_credit  
,Coll_TotalHC as NonCash into #aa from  [CSOKYC-6].general.dbo.tbl_rms_collection_cli with (nolock) where party_code in (select distinct party_code from #partyCode)   
*/ /*Commented on 08 July 2022 for removing dependency from NRMS*/  
  
/*****Add Bo source*******************/  
  
declare @sdtcur as datetime,@Todate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()                
    
/*Code added to handle Financial year end issue on 3rd April 2017*/    
/********************************************************************************/    
declare @ccsy datetime,@ccse datetime    
set @ccsy=@sdtcur    
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'    
    
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter where ldtcur        =    
(select ldtprv from AngelBSECM.account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE())   
   
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #MTFclient                 
  from AngelNseCM.MTFTRADE.dbo.ledger  a with (nolock)                  
  where VDT>=@sdtcur and  VDT <= @Todate                     
   /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountncdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
   group by cltcode  
  
     select * into #MTFOpn from #MTFclient where cltcode in (select party_code from #partyCode)                     
  
    
  select CLTCODE,                    
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)         
  INTO #BSECMcltop                                 
  from AngelBSECM.account_ab.dbo.ledger a with (nolock)                     
  where VDT>=@sdtcur and VDT <= @Todate --  and cltcode in (select party_code from #partyCode)     
   /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from anand.account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode       
        
    select * into #BSECMOpn from #BSECMcltop where cltcode in (select party_code from #partyCode)       
                 
      
 select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)   
  into  #NSECMcltop                 
  from AngelNseCM.account.dbo.ledger a with (nolock)                         
  where VDT>=@sdtcur and VDT <= @Todate         
   /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from anand1.account.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode        
        
  select * into #NSECMOpn from #NSECMcltop where cltcode in (select party_code from #partyCode)        
      
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)            
  into #NSEFOcltop                  
  from angelfo.accountfo.dbo.ledger a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate      
    /*Added to exclude opening balance of current year*/    
 -- /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelfo.accountfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode                      
      
  select * into #NSEFOOpn from #NSEFOcltop where cltcode in (select party_code from #partyCode)                    
    
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #NSXcltop                  
  from angelfo.accountcurfo.dbo.ledger a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate     
     /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelfo.accountcurfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode           
        
    select * into #NSXOpn from #NSXcltop where cltcode in (select party_code from #partyCode)                    
        
  select CLTCODE,                  
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #BSXcltop                  
  from angelcommodity.ACCOUNTcurbfo.dbo.ledger  a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate     
   /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.ACCOUNTcurbfo.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode       
        
      select * into #BSXOpn from #BSXcltop where cltcode in (select party_code from #partyCode)                    
   
  select CLTCODE,            
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #MCDcltop                  
  from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                         
  where VDT>=@sdtcur and  VDT <= @Todate       
  /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdxcds.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode                      
        
   select * into #MCDOpn from #MCDcltop where cltcode in (select party_code from #partyCode)                    
      
   
  select CLTCODE,                      
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)  
  into #MCDXcltop                      
  from angelcommodity.accountmcdx.dbo.ledger a with (nolock)                             
  where VDT>=@sdtcur and  VDT <= @Todate     
   /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountmcdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode                          
          
   select * into #MCDXOpn from #MCDXcltop where cltcode in (select party_code from #partyCode)           
                          
  select CLTCODE,                      
  VBal=sum(case when drcr='D' then -VAMT else VAMT end)        
  into #NCDXcltop                     
  from angelcommodity.accountncdx.dbo.ledger a with (nolock)                             
  where VDT>=@sdtcur and  VDT <= @Todate        
   /*Added to exclude opening balance of current year*/    
  /********************************************************************************/    
  and not exists (select cltcode,vdt,vtyp from angelcommodity.accountncdx.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse    
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )    
 /********************************************************************************/    
  group by cltcode       
        
  select * into #NCDXOpn from #NCDXcltop where cltcode in (select party_code from #partyCode)                     
   
  
 select * into #Bal from (                                                
  select * from #NSECMOpn                  
  union all                                                
  select * from #BSECMOpn     
  union all                                                
  select * from #NSEFOOpn     
  union all                                                
  select * from #NSXOpn     
  union all                                                
  select * from #MCDOpn     
  --union all                                                
  --select * from #MTFOpn                        
  union all                                      
  select * from #MCDXOpn                                             
  union all                                                
  select * from #NCDXOpn                                                                      
  union all                                                
  select * from #BSXOpn     
                                   
  )x  
  
  select cltcode,sum(vbal) as BrokingLedger into #BrokingValue from #Bal group by cltcode  
    
  select cltcode ,sum(vbal) as MTf_Ledger into #mtfvalue from   #MTFOpn  group by cltcode     
    
  select cltcode as party_code,sum(BrokingLedger) BrokingLedger,sum(MTf_Ledger) MTf_Ledger into #aa from  
  (  
  select cltcode,isnull(BrokingLedger,0.00) BrokingLedger, CONVERT(money,0.00) MTf_Ledger from #BrokingValue  
  union all  
  select cltcode,CONVERT(money,0.00) BrokingLedger,ISNULL(MTf_Ledger,0.00) MTf_Ledger from #mtfvalue  
  )x group by cltcode  
  
/***********************/  
  
select * into #client_col from  [CSOKYC-6].GENERAL.DBO.client_collaterals with(nolock)     
select Security_Symbol,Security_ISIN,MAX(mtm_price) as mtm_price  into #Combine_Closing_File from [CSOKYC-6].GENERAL.DBO.Combine_Closing_File with(nolock) group by Security_Symbol,Security_ISIN    
  
/******Start*********************Unsettle Non MTF Trade*********************************/  
select a.i_isin,a.party_code,a.scrip_cd,a.qty,convert(money,MTM_Price) as MTM_Price_unsett,c.[Angel scrip category] as Angel_Scrip_unsett,c.[ANGEL_VAR %] as Var_margin_unsett,c.series,    
CONVERT(MONEY, 0) as Value_BHC_unsett,    
CONVERT(MONEY, 0) as Value_AHC_unsett    
  into #mtf from AngelDemat.msajag.dbo.unclear_Hold_New  a with(nolock) left join    
#Combine_Closing_File b with(nolock) on    
a.I_isin=b.security_isin left join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.I_isin=c.[isin no] where   
party_code in (select party_code from #partycode)   
      
update #mtf set Value_BHC_unsett=qty*MTM_Price_unsett    
update #mtf set Value_AHC_unsett=isnull(Value_BHC_unsett,0)-(isnull(Value_BHC_unsett,0)*isnull(Var_margin_unsett,0)/100)    
    
select SUM(Value_AHC_unsett) as Value_AHC_UnsettNonMTF_Trade,party_code into #MTF_Codes from #mtf group by party_code   
/*****End*******************************************/  
  
/*****start***************CUSA Payout *****************************/  
select BlockedQty,MTM_Price,party_Code,Var_margin_cusa,CONVERT(money,0.00) as Value_BHC_CUSA,CONVERT(money,0.00) as Value_AHC_Cusa into #Cusa   
from cusa_po with(nolock) where party_code in (select party_code from #partycode) and Seq_approve_status in ('Blocked' ,'Partially Released')     
  
update #Cusa set Value_BHC_CUSA=BlockedQty*MTM_Price    
update #Cusa set Value_AHC_Cusa=isnull(Value_BHC_CUSA,0)-(isnull(Value_BHC_CUSA,0)*isnull(Var_margin_cusa,0)/100)    
select sum(Value_AHC_Cusa) as Value_AHC_Cusa,party_Code into #Cusa_Codes from #Cusa /*where party_code in (select party_code from #partycode) and Seq_approve_status='Blocked'    */  
group by party_code  
/*****End***************************************************/  
  
/*****Start*****************Margin Pleadge-Unpleadge*******************/  
 /******Margin**/     
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty into #MarginPleadge  from AngelDemat.msajag.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'    
group by bcltdpid,party_code,certno,sett_no    
union all    
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty  from AngelDemat.bsedb.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'    
group by bcltdpid,party_code,certno,sett_no    
  
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,    
CONVERT(MONEY, 0) as Var_margin,    
CONVERT(varchar(10), '') as series,    
CONVERT(MONEY, 0) as Value_BHC,    
CONVERT(MONEY, 0) as Value_AHC    
  into #marPledge from #MarginPleadge a left join   #Combine_Closing_File b with(nolock) on  
a.certno=b.security_isin where  party_code in (select party_code from #partycode)  
  
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre from #client_col where party_code in (select distinct party_code from #marPledge)    
   
    
update #marPledge set series=b.series,var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre b    
where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin     
     
update #marPledge set MTM_Price=b.cl_rate from #wre b where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin and #marPledge.MTM_Price=0.00    
    
    
update #marPledge set Value_BHC=qty*MTM_Price    
update #marPledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)    
    
select SUM(Value_AHC) as Margin_pleadge_AHC,party_code into #marPledge_Final from #marPledge group by party_code    
      
/*****Unpleadge**/  
select party_code,scrip,isin,sum(markedqty) as qty into #unpledge_code from tbl_UnpledgeFile with(nolock) where party_code in (select party_code from #partycode)  
 group by party_code,scrip,isin  
  
  
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,  
CONVERT(MONEY, 0) as Var_margin,    
CONVERT(MONEY, 0) as Value_BHC,    
CONVERT(MONEY, 0) as Value_AHC    
  into #unpledge from #unpledge_code a left join #Combine_Closing_File b with(nolock) on   
a.isin=b.security_isin    
    
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre1 from #client_col where party_code in (select distinct party_code from #unpledge_code)    
    
    
update #unpledge set var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre1 b    
where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin     
     
update #unpledge set MTM_Price=b.cl_rate from #wre1 b where #unpledge.party_code=b.party_code and  #unpledge.isin=b.isin and #unpledge.MTM_Price=0.00    
    
    
update #unpledge set Value_BHC=qty*MTM_Price    
update #unpledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)   
  
select sum(Value_AHC) as Unpledge_AHC,party_Code into #unpledge_codes from #unpledge   group by party_code    
  
select a.party_code,isnull(Margin_pleadge_AHC,0.00)-isnull(Unpledge_AHC,0.00)  as Margin_Pledge_final_AHC into #Final_Margin_Pledge   
from #marPledge_Final a left join #unpledge_codes b on a.party_code=b.party_code  
  
update #Final_Margin_Pledge set Margin_Pledge_final_AHC=0.00 where Margin_Pledge_final_AHC<0  
  
/******End*******************************************************/  
  
 select party_code,DeductEQ=sum(EQ_IntAmt),DeductComm=sum(Commo_IntAmt) into #Accrued1                                                     
 from misc.dbo.Accrued_PenalCharges with (nolock) where party_code in (select party_code from #partycode) group by party_code   
   
 /******added new margin peneality charges on 05 Jul 2021***********************************/      
 insert into #Accrued1      
 select party_code,DeductEQ=SUM(penalty_amt),DeductComm=0.00 from angelfo.NSECURFO.dbo.MARGIN_Accural with(nolock) where party_code in (select party_code from #partycode) group by party_code                
   
   
insert into  #Accrued1  
SELECT  cltcode,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00  FROM AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with(nolock)  
where cnt_Date=(select max(cnt_Date) from AngelNseCM.MSAJAG.DBO.TBL_CNTDATA_LOG with (Nolock))  and cltcode in (select party_code from #partycode)   
group by cltcode  
  
insert into  #Accrued1  
SELECT J.cl_code,DeductEQ=sum(CHARGAMT+GST_CHARGES),DeductComm=0.00 FROM AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock),AngelNseCM.MSAJAG.DBO.client_details c(Nolock)  
where  PCN_Date=(select max(PCN_Date) from AngelNseCM.MSAJAG.DBO.JVPNC_LOG J (Nolock)) and j.cl_code in (select party_code from #partycode)   
 and J.cl_code=c.cl_code  
group by J.cl_code   
      
 select party_code,SUM(DeductEQ) as DeductEQ ,SUM(DeductComm) as DeductComm into #Accrued from #Accrued1 group by party_code                                             
      
 /****************************************/    
  
select e.BrokingLedger,e.MTf_Ledger,isnull(Value_AHC_UnsettNonMTF_Trade,0.00)Value_AHC_UnsettNonMTF_Trade,isnull(Value_AHC_Cusa,0.00)Value_AHC_Cusa,  
isnull(Margin_Pledge_final_AHC,0.00)Margin_Pledge_final_AHC,CONVERT(money,0.00) as NetLedger,CONVERT(money,0.00) as AccruedCharges   
,a.* into #main1 from #partyCode a   
left join #aa e on a.party_code=e.party_code   
left join #MTF_Codes b on a.party_code=b.party_code   
left join #Cusa_Codes c on a.party_code=c.party_code   
left join #Final_Margin_Pledge d on a.party_code=d.party_code   
  
  
 update #main1 set AccruedCharges=-DeductEQ  from #Accrued b                                                     
 where #main1.party_code=b.party_code    
   
 select *,BrokingLedger+AccruedCharges as BrokingLedgerAdWithAccrual into #main11 from #main1                                         
  
select *,BrokingLedgerAdWithAccrual+Value_AHC_UnsettNonMTF_Trade+Value_AHC_Cusa+Margin_Pledge_final_AHC as Netl into #nn from #main11  
  
  
select *,CONVERT(money,0.00) as margin,CONVERT(money,0.00) as [ShortSellValue_Into_120%],CONVERT(money,0.00) as UnRecoCr ,  
CONVERT(money,0.00) as MTF_Available_Cash,CONVERT(money,0.00) as MFPendingOrder,CONVERT(money,0.00) as MarginShortfall into #final from #nn /* a left join Cusa_Po b on a.party_code=b.party_code  
and a.isin=b.isin and a.sett_no=b.sett_no*/  
  
  
create table #MarginShortfall(  
REPORTDATE varchar(20),PARTY_CODE varchar(50),PARTY_NAME varchar(100),BRANCH_cD varchar(50),SUB_BROKER varchar(30),FUDEDVAL money,MTOM money,MARGIN_REQ money,  
FUDEDVALAFM money,MTFLEDBAL money,AVALABLECASH money,COLLATERALBHC money,COLLATERALAHC money,MARGIN_SHORTFALL money,ORDERBYDATE varchar(20))  
  
declare @mdate as varchar(11),@dd as varchar(11)            
           
--select @mdate=max(vdt)+1 from AngelNseCM.account.dbo.ledger WITH(NOLOCK)            
--where vtyp=15 and vdt <=convert(varchar(11),getdate())            
--and narration like 'SETTNO=_______NSECMNBill Posted'              
           
select top 1 @mdate=start_date            
from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)            
where co_code='BSECM' and sett_type='D'            
and start_Date >=convert(varchar(11),getdate())-- @mdate              
order by Start_date      
    
select top 2 start_date,Row_number() Over(Order By start_Date desc) As Row_num            
into #day3          
from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)            
where co_code='BSECM'            
and sett_type='D'            
and start_Date <= @mdate     
  
select @dd =convert(varchar(11),Start_date)     from #day3 where Start_date< convert(varchar(11),getdate())    
print @dd  
insert into #MarginShortfall                       
EXEC AngelNseCM.MTFTrade.dbo.RPT_MTF_SUMMARY 'BROKER', 'BROKER', @dd,@dd, '0', 'ZZZZZZ'        
  
update #final set MarginShortfall=MARGIN_SHORTFALL from                                                    
(select party_code,MARGIN_SHORTFALL=SUM(MARGIN_SHORTFALL) from #MarginShortfall where MARGIN_SHORTFALL<0 group by party_Code having sum(MARGIN_SHORTFALL) <> 0) b                      
 where   #final.party_Code=b.party_Code     
  
--truncate table #MarginShortfall     
                                                   
 update #final set [ShortSellValue_Into_120%]=-(b.shrtval*1.2) from                                                    
(select party_code,shrtval=SUM(SHORT_VALUE) from ncms_shortsell with(nolock) group by party_Code having sum(SHORT_VALUE) <> 0) b                      
 where   #final.party_Code=b.party_Code     
   
 select cltcode,SUM(Cramt) as UnRecoCr into #unreco from  AngelBSECM.inhouse.dbo.BO_client_deposit_recno with (nolock) where cltcode in (select distinct party_code from #partycode)  group by cltcode  
  
 insert into #unreco  
 select cltcode,SUM(Cramt) as UnRecoCr from  AngelNseCM.inhouse.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode  
    
  insert into #unreco  
 select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode              
   
 insert into #unreco  
select cltcode,SUM(Cramt) as UnRecoCr from  angelfo.inhouse_curfo.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode        
  
 insert into #unreco  
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_BSX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode               
  
 insert into #unreco  
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.INHOUSE_MCDCS.dbo.BO_client_deposit_recno with (nolock) where cltcode in (select distinct party_code from #partycode) group by cltcode            
  
 insert into #unreco  
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_MCDX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode                 
  
 insert into #unreco  
select cltcode,SUM(Cramt) as UnRecoCr from  angelcommodity.inhouse_NCDX.dbo.BO_client_deposit_recno with (nolock)where cltcode in (select distinct party_code from #partycode)  group by cltcode  
  
select cltcode , SUM(UnRecoCr) as UnRecoCr into #UnrecoCr from #unreco group by cltcode  
   
 update #final set UnRecoCr=-b.UnRecoCr  from #UnrecoCr b                                                     
 where #final.party_code=b.cltcode   
   
 select party_code ,MTF_Available_Cash=case when SUM(Available_Cash_bal)>0 then 0 else SUM(Available_Cash_bal) end  
  into #MTFcltop       
  from   AngelNseCM.MTFTrade.dbo.MTF_Avilable_Cash with(nolock) where party_code in (select distinct party_code from #partycode)   
  group by party_code    
   
 update #final set MTF_Available_Cash=b.MTF_Available_Cash  from #MTFcltop b                                                   
 where #final.party_code=b.party_code   
  
  
 --update #final set margin=-b.margin_total  from #aa b                                                     
 --where #final.party_code=b.party_code   
   
 declare @MARGINDATE AS DATETIME  , @MARGINDATE_peak AS DATETIME      
             
SELECT @MARGINDATE=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock)     
SELECT @MARGINDATE_peak=MAX(MARGINDATE) FROM AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock)     
   
select TDAY_MARGIN/*+TDAY_MTM*/ as margin ,party_code,margindate into #margin from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING with(nolock) where margindate=@MARGINDATE--'2020-12-29 00:00:00.000'      
    
select party_code, SUM(margin) as Margin into #mar from #margin group by party_code    
      
select /*TDAY_MARGIN*//*+TDAY_MTM*/0.00 as margin ,party_code,margindate into #marginPk from AngelNseCM.msajag.dbo.TBL_COMBINE_REPORTING_PEAK with(nolock) where margindate=@MARGINDATE_peak--'2020-12-29 00:00:00.000'      
    
select party_code, SUM(margin) as Margin into #marpk from #marginPk group by party_code    
    
 SELECT party_code, MAX(Margin) as margin      
  into #mainMargin FROM      
  (      
   SELECT party_code, MAX(margin) as  Margin     
   FROM #mar       
   GROUP BY party_code      
   UNION ALL      
   SELECT party_code, MAX(margin) as   Margin    
   FROM #marpk       
   GROUP BY party_code      
  ) as subQuery      
  GROUP BY party_code     
    
 update #final set margin=-b.margin  from #mainMargin b                                                     
 where #final.party_code=b.party_code   
 /*******************For Reducing mf pending orders in MTF Payout**********/        
 /* commeted on 30 Jun2022 as Per SEBI Circular for removing MF       
DECLARE @Days VARCHAR(20)                              
                              
 SET @Days = (                              
   SELECT DATENAME(dw, GETDATE())                              
   )         
                                
IF (@Days = 'Monday' OR @Days = 'Saturday')                              
BEGIN             
         
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal_sat           
 from         
 risk.dbo.vw_MutualFundPendingOrder_NCMS_sat o  with(nolock)        
 group by clientcode        
        
 insert into MTF_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)        
 select cltcode,amount,getdate() from #MFFundFinal_sat        
   
 update #final set MFPendingOrder=-b.amount  from #MFFundFinal_sat b                                                     
 where #final.party_code=b.cltcode     
        
 --drop table #segmentwise_pendingorders_sat        
 --drop table #MFFundFinal_sat        
end      
else        
begin        
     
 select cltcode=clientcode,sum(o.amount) as amount  into #MFFundFinal           
 from         
 risk.dbo.vw_MutualFundPendingOrder_NCMS o with(nolock)         
 group by clientcode        
        
 insert into MTF_tblMutualFundPendingOrder_log (cltcode,amount,UpdatedOn)        
 select cltcode,amount,getdate() from #MFFundFinal        
        
 update #final set MFPendingOrder=-b.amount  from #MFFundFinal b                                                     
 where #final.party_code=b.cltcode      
       
 --drop table #segmentwise_pendingorders        
 --drop table #MFFundFinal        
end          
*/  
/*****************************************************/    
--#final where margin<0='madn1050'   
  
update #final set netl=Netl+margin/*+AccruedCharges*/+[ShortSellValue_Into_120%]+UnRecoCr+MTF_Available_Cash+MFPendingOrder+MarginShortfall  
  
Select distinct sauda_date,sett_no,party_code,Netamt,isin,qty into #MktPosition from AngelNseCM.mtftrade.dbo.TBL_PRODUCT_POSITION with(Nolock)  
where sell_buy =1 and ADJUST_DATE ='2049-12-31 23:59:00.000' and party_code in (select distinct party_code from #final) and qty>0 order by sauda_date  
  
insert into tbl_Postion_MTF  
select *,getdate() from #MktPosition  
  
select sauda_date,party_code,isin,sum(qty) qty,SUM(netamt) netamt into #cv from #MktPosition   
group by party_code,isin,sauda_date  
  
select MIN(sauda_date)sauda_date,party_code,isin,CONVERT(money,0.00) as PositionAmt,CONVERT(int,0) as Qty,CONVERT(money,0.00) as PositionRate into #aa1 from #cv   
--#aa1 where party_code='PPYL174' and isin='INE095N01031'  
group by party_code,isin  
  
  
update #aa1 set PositionAmt=m.Netamt,Qty=m.qty from #cv m where #aa1.party_code=m.party_code and #aa1.isin=m.isin and #aa1.sauda_date=m.sauda_date  
  
update #aa1 set PositionRate=PositionAmt/qty  
  
alter table #final add PositionRate money  
  
update #final set PositionRate=m.PositionRate from #aa1 m where #final.party_code=m.party_code and #final.isin=m.isin   
  
/*******Added on 07 Sep 2022***********/  
update #final set PositionRate=convert(money,MTM_Price) from #Combine_Closing_File m where #final.isin=m.Security_ISIN and #final.PositionRate is null  
/******************/  
 --select *,case when BrokingLedger<netl then BrokingLedger  
 --             when BrokingLedger>Netl then Netl else netl end  as FinalNet into #netdebit from #final  
  
select *,case when BrokingLedgerAdWithAccrual<netl then BrokingLedgerAdWithAccrual  
              when BrokingLedgerAdWithAccrual>Netl then Netl else netl end  as FinalNet into #netdebit from #final  
   
   
alter table #netdebit add ReleasedQty int  
alter table #netdebit add BlockedQty int  
  
--commented on 24 Mar2023/*update a set ReleasedQty=qty,BlockedQty=0  from #netdebit a,MTF_Exception_ISIN b  where a.isin=b.ISIN and FinalNet>0*/ --added on 06 Jan 2023 as per JIRA ORE-1959  
  
update #netdebit set ReleasedQty=0,BlockedQty=qty where /*BrokingLedger*/BrokingLedgerAdWithAccrual<0  
update #netdebit set ReleasedQty=0,BlockedQty=qty  where FinalNet<0 and /*BrokingLedger*/BrokingLedgerAdWithAccrual>0    
  
update #netdebit set ReleasedQty=0,BlockedQty=qty  where PositionRate is null  
  
update #netdebit set ReleasedQty=qty,BlockedQty=0   where FinalNet>=0 and FinalNet>=mtf_ledger*-1 and PositionRate is not null  
  
alter table #netdebit add ReleasedValue money  
  
update a set ReleasedValue=releasedQty* PositionRate from #netdebit a where  isnull(PositionRate,0)>0  and  ReleasedQty<>0  
   
 select id=row_number() over(order by  sett_no )            
,denseid=dense_rank() over(order by party_code),  
[PRiority]=(Case  
 when isin='INE001A01036' then '1'  
 else '2' end),  
scrip_shortage=case when isnull(PositionRate,0.00)=0 then total else isnull(PositionRate,0)*Qty end  
,adjval=convert(money,0),bal=convert(money,0) ,           
*            
into #holding            
from #netdebit where  /*BrokingLedger*/BrokingLedgerAdWithAccrual>0 and ReleasedQty is null and blockedqty is null  
   
select   
id,denseid,  
sqoffsseg=row_number() over(partition by party_code order by [PRiority],scrip_shortage  )/*Added on 27Jan 2022*/   
,scrip_shortage,adjval,bal,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,  
series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,  
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,BlockedQty=0  
,releasedQty=0,sqoffseq=0,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),  
shortagereduction=case when isnull(PositionRate,0.00)=0 then total else isnull(PositionRate,0)*Qty end,shortage=convert(money,0),[holding value after HC]=convert(money,0) ,ReleasedValue=convert(money,0)  
into #hld  
from #holding-- where party_code='A159174'  
order by sqoffsseg  
  
update a set a.shortage=(case when a.FinalNet<0 then (a.FinalNet*-1) else a.FinalNet end)  from #hld a  where a.sqoffsseg=1  
--update a set a.shortage=(case when FinalNet<shortagereduction then 0 else a.FinalNet end)  from #hld a  where a.sqoffsseg=1   
/*Added on 27Jan 2022*/  /*Commeted on 07 Jul 2022*/  
  
  
;with hold_cte as (  
select   
sqoffsseg,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,  
series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,  
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,  
BlockedQty,releasedQty,ReleasedValue,  
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,  
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hld x   
where  sqoffsseg=1 --and party_Code='CP6249'  
  
     
union all  
select   
e.sqoffsseg,BrokingLedger,BrokingLedgerAdWithAccrual,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,isin,scrip_cd,  
series,sett_no,sett_type,e.party_Code,bs,exchange,qty,clsrate,accno,scripname,total,PositionRate,  
DUMMY1,DUMMY2,nse_approved,source,upd_date,Netl,margin,[ShortSellValue_Into_120%],MarginShortfall,AccruedCharges,UnRecoCr,MTF_Available_Cash,FinalNet,  
BlockedQty,releasedQty,ReleasedValue,shortagereduction,  
shortage= (ecte.shortage-shortagereduction)  
from #hld e inner join (select party_code,sqoffsseg,shortage from  hold_cte) ecte on ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
--and ecte.shortage>0  
)  
select * into #holdd  
from hold_cte option  (maxrecursion 32767) ;  
  
update #holdd set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0   
  
  
update a set releasedQty=(case when floor(convert(money,shortagereduction)/convert(money,PositionRate)) <= qty then floor(convert(money,shortagereduction)/convert(money,PositionRate)) else qty end)  
from #holdd a where isnull(PositionRate,0)>0   
  
update a set ReleasedValue=releasedQty* PositionRate from #holdd a where  isnull(PositionRate,0)>0   
  
update a set releasedQty=0,BlockedQty=qty,ReleasedValue=0 from #holdd a where releasedQty<=0  
update a set BlockedQty=isnull(qty,0)-isnull(releasedQty,0) from #holdd a where releasedQty>0  
  
--alter table #netdebit add ReleasedValue money  
  
  update #netdebit set ReleasedQty=isnull(b.ReleasedQty,0),BlockedQty=isnull(b.BlockedQty  ,0),ReleasedValue=ISNULL(b.ReleasedValue,0.00)  
   from    
  (    
  select sett_no,party_code,isin,ReleasedQty,qty,BlockedQty,scrip_cd,ReleasedValue from #holdd    
  )b where ltrim(rtrim(#netdebit.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#netdebit.isin))=ltrim(rtrim(b.isin))    
  and ltrim(rtrim(#netdebit.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#netdebit.qty))=ltrim(rtrim(b.qty))    
  
update #netdebit  set ReleasedValue=0.00 where  ReleasedValue is null  
update #netdebit set releasedqty=0,blockedqty=qty where releasedqty is null  
  
/****Added on 07 July 2022 by Neha*******************/  
select * into #finalData from #netdebit  where releasedqty=qty  
  
/****Release value reduced from 25000 to 1000 changes done by siva SRE NO: 10335*/  
  
insert into #finalData  
select * from #netdebit where FinalNet>=1000 and blockedqty>0 and FinalNet>0 and  
BrokingLedgerAdWithAccrual>0 and releasedqty>0  
/************************/  
/*******Added on 09 Jan 2023 for argin benift**********************/  
--select * into #finalData from MTF_AutoRelease  
 declare @sauda_Date AS DATETIME     
             
SELECT @sauda_Date=MAX(sauda_Date) FROM AngelNseCM.MTFTRADE.dbo.TBL_MTF_DATA with (Nolock)  
  
select * into #MarginBenifit from AngelNseCM.MTFTRADE.dbo.TBL_MTF_DATA with (Nolock) where  sauda_Date=@sauda_Date  and MTFNONCASHCOLLATERAL=0  
  
select a.*,b.CURR_CL_RATE,b.margin_req,case when PositionRate>CURR_CL_RATE then (PositionRate-CURR_CL_RATE)*ReleasedQty else 0 end MTMRelease,  
convert(decimal(18,2),(margin_req/a.qty)*ReleasedQty) as MarginRelease   
into #MTF_release from #finalData a join  
#MarginBenifit b on a.party_code=b.party_code and a.isin=b.isin where a. blockedqty<>0  
  
select *,MTMRelease+MarginRelease as finalRelease,convert(int,0) newReleasedQty,convert(int,0) TotalReleasedQty,  
convert(money,0) TotalReleaseValue into #MTF_Final from #MTF_release  
  
/*Added on 01 Mar 2023 by Neha*start*/  
  
update #MTF_Final set finalRelease=case when (MarginShortfall*-1)>finalRelease then 0   
       when (MarginShortfall*-1)<finalRelease then finalRelease+MarginShortfall end  where finalRelease<>0  
/*End**/  
update a set newReleasedQty=(case when floor(convert(money,finalRelease)/convert(money,PositionRate)) <= qty then  
floor(convert(money,finalRelease)/convert(money,PositionRate)) else qty end)  
from #MTF_Final a where isnull(PositionRate,0)>0   
  
update #MTF_Final set TotalReleasedQty=ReleasedQty+newReleasedQty,TotalReleaseValue=finalRelease+ReleasedValue where newReleasedQty>0 and blockedqty<>0   
  
select *,convert(money,0) CURR_CL_RATE,convert(money,0) margin_req,convert(money,0) MTMRelease,convert(money,0) MarginRelease,  
convert(money,0) finalRelease,convert(int,0) newReleasedQty,convert(int,0) TotalReleasedQty,  
convert(money,0) TotalReleaseValue into #finalData_MTFPO from #finalData  
  
 update #finalData_MTFPO set CURR_CL_RATE=isnull(b.CURR_CL_RATE,0),margin_req=isnull(b.margin_req  ,0),MTMRelease=ISNULL(b.MTMRelease,0.00)  
 ,MarginRelease=ISNULL(b.MarginRelease,0.00),finalRelease=ISNULL(b.finalRelease,0.00),newReleasedQty=isnull(b.newReleasedQty,0),  
 TotalReleasedQty=case when b.newReleasedQty>0 and b.blockedqty<>0  then b.TotalReleasedQty else #finalData_MTFPO.ReleasedQty end,TotalReleaseValue=isnull(b.TotalReleaseValue,0)  
   from    
  (    
  select sett_no,party_code,isin,ReleasedQty,qty,BlockedQty,scrip_cd,ReleasedValue,CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,  
  finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue from #MTF_Final   
  )b where ltrim(rtrim(#finalData_MTFPO.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#finalData_MTFPO.isin))=ltrim(rtrim(b.isin))    
  and ltrim(rtrim(#finalData_MTFPO.sett_no))=ltrim(rtrim(b.sett_no))    and ltrim(rtrim(#finalData_MTFPO.qty))=ltrim(rtrim(b.qty))    
   
  update #finalData_MTFPO set TotalReleasedQty=ReleasedQty,TotalReleaseValue=ReleasedValue  where TotalReleasedQty=0  
  
update #finalData_MTFPO set TotalReleaseValue=ReleasedValue  where newreleasedqty=0 and TotalReleaseValue=0  
 /********************************/  
insert into MTF_AutoRelease_hist(BrokingLedger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,  
isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,  
partyname,[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],  
UnRecoCr,MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,MTf_Ledger,Updatedon,  
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue  
)  
select BrokingLedger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,isin,scrip_cd,series,sett_no,  
sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,[pool],total,DUMMY1,DUMMY2,  
nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,MTF_Available_Cash,MFPendingOrder,  
MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,MTf_Ledger,GETDATE(),  
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue  
from MTF_AutoRelease  
  
truncate table MTF_AutoRelease  
  
insert into MTF_AutoRelease(BrokingLedger,MTf_Ledger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,isin,  
scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,  
[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,  
MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,  
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue  
)   
select BrokingLedger,MTf_Ledger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,isin,  
scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,  
[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],UnRecoCr,  
MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,  
CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue  
from #finalData_MTFPO  
--select *  from #netdebit  where releasedqty=qty /*Commentd on 07 July 2022*/  
  
truncate table MTF_AutoRelease_AllData  
  
insert into MTF_AutoRelease_AllData(BrokingLedger,MTf_Ledger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges,  
isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,  
partyname,[pool],total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],  
UnRecoCr,MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue)  
select *  from #netdebit  
/*where party_code in (select partycode from [tbl_MTFData_20Oct2021] with(nolock))*/  
  
/*delete from MTF_AutoRelease where party_Code not in (select partycode from [tbl_MTFData_20Oct2021] with(nolock))*/  
  
exec USP_MTFAutoRelease_File_Generation  
  
truncate table MTF_AutoRelease_Heading  
  
 insert into MTF_AutoRelease_Heading(BrokingLedger,Value_AHC_UnsettNonMTF_Trade,Value_AHC_Cusa,Margin_Pledge_final_AHC,NetLedger,AccruedCharges  
 ,isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,  
 partyname,[pool],total,DUMMY500,DUMMY2,nse_approved,source,upd_date,AdjQty,BrokingLedgerAdWithAccrual,Netl,margin,[ShortSellValue_Into_120%],  
 UnRecoCr,MTF_Available_Cash,MFPendingOrder,MarginShortfall,PositionRate,FinalNet,ReleasedQty,BlockedQty,ReleasedValue,MTf_Ledger,  
 CURR_CL_RATE,margin_req,MTMRelease,MarginRelease,finalRelease,newReleasedQty,TotalReleasedQty,TotalReleaseValue  
)  
 select  'BrokingLedger','Value_AHC_UnsettNonMTF_Trade','Value_AHC_Cusa','Margin_Pledge_final_AHC','NetLedger','AccruedCharges','isin','scrip_cd','series','sett_no','sett_type','party_Code','bs','exchange','qty','clsrate','accno','dpid','clid','flag','ab
en',  
 'apool','nben','npool','approved','scripname','partyname','pool','total','DUMMY1','DUMMY2','nse_approved','source','upd_date','AdjQty',  
 'BrokingLedgerAdWithAccrual','Netl','margin','ShortSellValue_Into_120%','UnRecoCr','MTF_Available_Cash','MFPendingOrder','MarginShortfall','PositionRate'  
 ,'FinalNet','ReleasedQty','BlockedQty','ReleasedValue','MTf_Ledger',  
 'CURR_CL_RATE','margin_req','MTMRelease','MarginRelease','finalRelease','newReleasedQty','TotalReleasedQty','TotalReleaseValue'  
  
   
 insert into MTF_AutoRelease_Heading  
 select * from MTF_AutoRelease  
   
  DECLARE @s VARCHAR(MAX) = ''                                          
   /*declare @FileName as varchar(100) = 'LD_File'+replace(CONVERT(char(10),getdate(),103),'/','-')+'.csv'*/      
   declare @FileName as varchar(100) = 'MTF_Release'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                                                 
      declare @FilePath varchar(200) ='' /* '\\196.1.115.183\d$\upload\CMS_Test\'+@FileName  */                         
      --select @FilePath='\\172.29.19.16\public\NehaN\'+@FileName       
    select @FilePath='\\196.1.115.183\cusa_mtf\'+@FileName            
                                       
      SET @s = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                           
      SET @s = @s + 'bcp "select * from Intranet.cms.dbo.MTF_AutoRelease_Heading" queryout '+ @FilePath + ' -c -t, -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                                                       
              
       
             
      SET @s = @s + ''''              
      EXEC(@s)     
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_NOCProcess_Email_UAT
-- --------------------------------------------------
CREATE  Procedure [dbo].[Usp_NOCProcess_Email_UAT]                              
as                              
                              
--Set nocount on                              
 --- date                          
               
                            
Begin                
              
 update tbl_MailClient_NOC          
 set IsApprove=4          
 where  Existing_SubBroker=New_SubBroker and insert_on between Convert(varchar,(getdate()-1),101) +' 16:55:00' and getdate() and IsApprove!=4          
          
 ----if (select count(1) from [196.1.115.182].General.dbo.BO_Sett_Mst where [Start_DATE] =Convert(varchar,getdate(),101)) =0            
 ----  Begin            
 ----   return             
 ----   /*Noc File not to be sent on Holidays*/            
 ----  End            
                
 DECLARE @Emp_name as varchar(100),@emp_email as varchar(100)  ,@job_maxdate as varchar(100)                            
 DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)                                        
   SET @emailto='prashant.patade@angelbroking.com'                
   --SET @emailto='prashant.patade@angelbroking.com'                
    --SET @emailto='prashant.patade@angelbroking.com;abdulk.choudhary@angelbroking.com'                                      
                                             
  DECLARE @filename1 as varchar(100)                                            
                               
  select @filename1='I:\Adv_Chart_email\Email_NOC_rpt_UAT'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                                       
                   
              
   truncate table tbl_Email_NOC_Process              
   truncate table tbl_NOC_Process_Heading              
   truncate table tbl_NOC_Process_Heading_MF              
                 
            
                 
  select @job_maxdate= max(maxdate) from risk.dbo.tbl_NOC_Process_MaxDate              
                 
   insert into tbl_Email_NOC_Process( Update_Date,ClientCode,Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From],CodeAdded,ClientType,ClientStatus)              
  --select  Update_Date,UPPER (ClientCode),Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,'Approved' as Remarks ,'Inhouse'as[From]               
  --from tbl_MailClient_NOC where IsApprove='2' and Existing_SubBroker<>New_SubBroker              
  --   and Update_Date between @job_maxdate and DATEADD(hh,17,DATEDIFF(dd,0,getdate()))              
  ----------------------Changes done for remove duplicate record----------06-09-2022-------------------------------            
    select distinct max(Update_Date),UPPER (ClientCode),Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,'Approved' as Remarks ,'NXT'as[From],getdate(),B2B_B2C,
  Case when (ActiveCLI='Y') then 'Traded' else 'Non-Traaded' end                    
    from risk.dbo.tbl_MailClient_NOC where IsApprove='2' and Existing_SubBroker<>New_SubBroker              
    and Update_Date between @job_maxdate and DATEADD(hh,17,DATEDIFF(dd,0,getdate()))              
 group by ClientCode,Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,remarks,B2B_B2C,ActiveCLI            
----------------------------------------------------------------------------------------------------------------------------------            
     --@job_maxdate between DATEADD(hh,17,DATEDIFF(dd,0,DATEADD( dd,-1, getdate()))) and DATEADD(hh,17,DATEDIFF(dd,0,getdate()))              
                        
     select * into #aa from risk.dbo.tbl_MailClient_NOC              
  if  exists(select * from risk.dbo.tbl_MailClient_NOC where DATEDIFF(DAY, Link_Update_Date, GETDATE())>0 AND DATEDIFF(hh, Link_Update_Date, GETDATE())>=48 and  IsApprove <>'2')              
   begin
      
	  DECLARE @TableVarNocstatusLogs TABLE (
		Noc_Id numeric,
		IsApprove VARCHAR(5),
		UpdatedDate datetime,
		UpdatedBy varchar(20)
         )

        update a                
        set a.IsApprove='2',              
        a.[48hr_insertDate]=GETDATE() 
		output inserted.SRNO ,INSERTED.IsApprove,INSERTED.[48hr_insertDate],INSERTED.Clientcode
		INTO @TableVarNocstatusLogs
        from tbl_MailClient_NOC a                
        join #aa b on a.ClientCode = b.ClientCode    
        where  a.IsApprove in('1')              
        and DATEDIFF(DAY, a.Link_Update_Date, GETDATE())>0 AND DATEDIFF(hh, a.Link_Update_Date, GETDATE())>=48              
        and a.Existing_SubBroker<>a.New_SubBroker 

		 ---Insert into dbo.tbl_NOCstatusLOGS
		 select *,'AutoUpdate' From @TableVarNocstatusLogs

   END              
   ELSE              
   BEGIN              
     select 'bye'              
   END              
              
     insert into tbl_Email_NOC_Process( Update_Date,ClientCode,Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From],CodeAdded,ClientType,ClientStatus)              
  select  Link_Update_Date,UPPER (ClientCode),Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,'Shifted as per Policy' as Remarks,'NXT'as[From],getdate(),B2B_B2C,
  Case when (ActiveCLI='Y') then 'Traded' else 'Non-Traaded' end               
  from risk.dbo.tbl_MailClient_NOC where IsApprove in ('2')               
  and [48hr_insertDate] between DATEADD(hh,17,DATEDIFF(dd,0,DATEADD( dd,-1, getdate()))) and DATEADD(hh,18,DATEDIFF(dd,0,getdate()))              
  --and [48hr_insertDate] between @job_maxdate and DATEADD(hh,17,DATEDIFF(dd,0,getdate()))               
     --and @job_maxdate between DATEADD(hh,17,DATEDIFF(dd,0,DATEADD( dd,-1, getdate()))) and DATEADD(hh,17,DATEDIFF(dd,0,getdate()))              
            
 /*Manual Insertion-- Remove*/      
   ------ insert into tbl_Email_NOC_Process( Update_Date,ClientCode,Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From])        
   ------select  Link_Update_Date,UPPER (ClientCode),Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,'Shifted as per Policy' as Remarks,'Inhouse'as[From]               
   ------from tbl_MailClient_NOC where IsApprove in ('2')               
   ------and [48hr_insertDate] between DATEADD(hh,17,DATEDIFF(dd,0,DATEADD( dd,-5, getdate()))) and DATEADD(hh,18,DATEDIFF(dd,0,getdate()))       
   ------and clientcode in (      
   ------select A.Clientcode from tbl_MailClient_NOC a      
   ------left outer join (select * from tbl_Email_NOC_Process_Hist where update_on >getdate()-8) b on a.clientcode=b.ClientCode        
   ------where a.IsApprove =2   and a.insert_on > '08/30/2023' and a.insert_on <'09/01/2023' and b.ClientCode is null      
   ------)      
  /*Manual Insertion-- Remove*/  
  
   update  a
   set Propcode = Case when (b.pan_gir_no=c.PANNO) then'Yes' Else 'No' end
   from tbl_Email_NOC_Process a
    inner join risk.dbo.Client_details b on a.clientcode=b.party_code
    inner join [MIS].sb_comp.dbo.sb_brokerView c on a.new_subBroker=c.sbtag

               
  Insert into tbl_NOC_Process_Heading(Update_Date,ClientCode,Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From],CodeAdded,ClientType,Clientstatus,PropCode)                 
  select  'Update_Date','ClientCode','Existing_Branch','Existing_SubBroker','New_Branch','New_SubBroker','Remarks','From','CodeAdded','ClientType','Clientstatus','PropCode'              
              
  Insert into tbl_NOC_Process_Heading_MF(Update_Date,ClientCode,Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From],CodeAdded,ClientType,Clientstatus,PropCode)                 
  select  'Update_Date','ClientCode','Existing_Branch','Existing_SubBroker','New_Branch','New_SubBroker','Remarks','From','CodeAdded','ClientType','Clientstatus','PropCode'               
                
  insert into tbl_NOC_Process_Heading( Update_Date,ClientCode,Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From],CodeAdded,ClientType,Clientstatus,PropCode)                
  SELECT Update_Date,UPPER (ClientCode),Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From],Convert(varchar,CodeAdded,103),ClientType,Clientstatus,PropCode --FROM TBL_ADVCHART_ACTIVATE                
  FROM tbl_Email_NOC_Process a left outer join Risk.dbo.client_details b on a.ClientCode=b.party_code --where clientcode !='ClientCode' and b.MF is null              
      and b.bsecm='N' and b.NSECM='N' and b.NSEFO='N' and b.mcdx='N' and b.ncdx='N' and b.bsefo='N' and b.MF='Y' --and party_code='K84274'              
      where b.party_code is  null              
              
  insert into tbl_NOC_Process_Heading_MF( Update_Date,ClientCode,Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From],CodeAdded,ClientType,Clientstatus,PropCode)                
  SELECT Update_Date,UPPER (ClientCode),Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From],Convert(varchar,CodeAdded,103),ClientType,Clientstatus,PropCode --FROM TBL_ADVCHART_ACTIVATE                
  FROM tbl_Email_NOC_Process a left outer join Risk.dbo.client_details b on a.ClientCode=b.party_code --where clientcode !='ClientCode' and b.MF is null              
      and b.bsecm='N' and b.NSECM='N' and b.NSEFO='N' and b.mcdx='N' and b.ncdx='N' and b.bsefo='N' and b.MF='Y' --and party_code='K84274'              
      where b.party_code is not null              
              
                
  insert into tbl_Email_NOC_Process_Hist (Update_Date,ClientCode,Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From],update_on,CodeAdded,ClientType,Clientstatus,PropCode)              
  SELECT Update_Date,UPPER (ClientCode),Existing_Branch,Existing_SubBroker,New_Branch,New_SubBroker,Remarks,[From],getdate(),CodeAdded,ClientType,Clientstatus,PropCode --FROM TBL_ADVCHART_ACTIVATE                
  FROM tbl_Email_NOC_Process ;             
   
  with cte as (  
  Select clientcode,existing_branch,existing_subbroker,update_on,ROW_NUMBER() over(partition by clientcode, existing_branch, existing_subbroker order by update_on) As RowNodd  
  From tbl_Email_NOC_Process_Hist where update_on between '01/01/2024' and getdate()   
  )  
  delete from cte where RowNodd >1  
  
               
    DECLARE @BCPCOMMAND VARCHAR(250)                        
    DECLARE @FILENAME VARCHAR(250)                
    DECLARE @FILENAME2 VARCHAR(250)                
    declare @s1 as varchar(max)                 
                       
                       
  --SET @PATH ='\\'+@server+'\D$\Upload\GenerateIPOCSV\'                        
  SET @FILENAME = '\\INHOUSELIVEAPP1-FS.angelone.in\upload1\Adv_Chart_email\Email_NOC_Equity_Rpt_UAT'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                
   
                     
      
        
          
             
  SET @BCPCOMMAND = 'BCP "SELECT * FROM dustbin.dbo.tbl_NOC_Process_Heading" QUERYOUT "'                        
  SET @BCPCOMMAND = @BCPCOMMAND + @filename + '" -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                        
    EXEC MASTER..XP_CMDSHELL @BCPCOMMAND                 
               
               
  SET @FILENAME2 = '\\INHOUSELIVEAPP1-FS.angelone.in\upload1\Adv_Chart_email\Email_NOC_MF_Rpt_UAT'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                    
  
                     
      
        
          
  SET @BCPCOMMAND = 'BCP "SELECT * FROM dustbin.dbo.tbl_NOC_Process_Heading_MF" QUERYOUT "'                        
  SET @BCPCOMMAND = @BCPCOMMAND + @filename2 + '" -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                        
    EXEC MASTER..XP_CMDSHELL @BCPCOMMAND                
                          
               
                                         
SET @MESS='Dear All,<br><Br>Please refer the attached NOC file for the day .'                                                
SET @MESS=@MESS+'<BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(In-house system)'                                          
set @sub ='Test - NOC File '+replace(CONVERT(char(10),getdate(),103),'/','-')+''                                                                               
 --print @filename1                              
                                  
 DECLARE @s varchar(1000)                                
 SET @s = @filename +';'+@FILENAME2                          
                                  
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                            
 @RECIPIENTS =@emailto,                                            
 @COPY_RECIPIENTS ='Leon.Vaz@angelbroking.com',                                        
 @PROFILE_NAME = 'AngelBroking',                                            
 @BODY_FORMAT ='HTML',                                            
 @SUBJECT = @sub ,                                            
 @FILE_ATTACHMENTS =@s,                                            
 @BODY =@MESS                                            
               
               
          
  ----------------------------------insert into tbl_NOC_Process_MaxDate            
  ----------------------------------select DATEADD(hh,17,DATEDIFF(dd,0,DATEADD( dd,0, getdate())))     
      
  --------------------------------------exec usp_NOCSendFamTradeData_NXT2    
          
  --DECLARE @Days VARCHAR(20)                                      
                                     
  --SET @Days = (SELECT DATENAME(dw, GETDATE()))                
                 
                                         
   --  IF (@Days = 'Saturday')               
   --BEGIN               
   -- insert into tbl_NOC_Process_MaxDate  select  getdate()              
   --END              
   --ELSE              
   -- insert into tbl_NOC_Process_MaxDate  select DATEADD(hh,17,DATEDIFF(dd,0,DATEADD( dd,0, getdate())))              
   --END            
             
          
          
--insert into tbl_NOC_Process_MaxDate  select DATEADD(hh,17,DATEDIFF(dd,0,DATEADD( dd,0, getdate())))              
--insert into tbl_NOC_Process_MaxDate  select  getdate()              
                              
                                             
 --EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                            
 --@RECIPIENTS ='Prashant.patade@angelbroking.com',        
 ----@COPY_RECIPIENTS ='renil.pillai@angelbroking.com;sandeep.rai@angelbroking.com;bi.dba@angelbroking.com',                                     
 --@PROFILE_NAME = 'AngelBroking',                                            
 --@BODY_FORMAT ='HTML',                                            
 --@SUBJECT = 'ERROR in ADV-Chart : Testing',                                            
 --@FILE_ATTACHMENTS ='',                                            
 --@BODY ='ERROR'           
          
 END 

 /*-https://angelbrokingpl.atlassian.net/browse/SRE-28666*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_NXT_NOC_Process_Outgoing_Rpt_UAT
-- --------------------------------------------------
CREATE proc [dbo].[USP_NXT_NOC_Process_Outgoing_Rpt_UAT]       
(                       
@ClientCode varchar(20)=null,                         
@Fromdate varchar(12),                       
@Todate varchar(12),                       
@ACCESS_TO AS VARCHAR(20),                                           
@ACCESS_CODE AS VARCHAR(20),                       
@UserName as varchar(20)=null                       
)                       
as                    
BEGIN                   
       
/*       
       
exec [USP_NXT_NOC_Process_Outgoing_Rpt] @Fromdate='2022-01-01',@Todate='2023-07-01',@ACCESS_TO='SB',@ACCESS_CODE='CBHO'       
       
*/       
       
Set @Fromdate=replace(CONVERT(VARCHAR(12),convert(datetime,@Fromdate,103),106), '/', ' ')+' 00:00:00'                    
set @Todate= replace(CONVERT(VARCHAR(12),convert(datetime,@Todate,103),106), '/', ' ')+' 23:59:59'       
       
Declare @startdate datetime=getdate()      
      
--if(@CLientCode='E46548')                       
--Begin                       
-- set @CLientCode='%'                       
--End                    
  select distinct ClientCode,ClientName,IsApprove,New_SubBroker,Existing_SubBroker,New_Branch,Existing_Branch,    
  Case when IsApprove=0  then  'Client Approval Pending.'                    
                when IsApprove=1  then  'Existing Sub-broker Approval Pending.'                    
                when IsApprove=2  then  'Request will be processed within 24 Hrs.'                   
                when IsApprove=3 then   'Request Rejected reapproval Link sent.' 
				when IsApprove=4 then  'Request Deleted'                 
                when IsApprove=5 then  'Request Reapproved by Client Existing Sub-broker to trigger withdrawal Link.'                 
                when IsApprove=6 then  'Withdrawal link sent to the client.'                 
                when IsApprove=7 then  'Request withdrawn by the client.'  
				END as Status ,ReasonForShifting,Remarks,
			case when (noc.B2B_B2C='B2C') then 'Y' else 'N' end b2c,                   
        Insert_On as [Request_submitted_on] from RIsk.dbo.tbl_MailClient_NOC  noc with(nolock)           
        inner join Risk.dbo.client_details clt with(nolock) on clt.party_code=noc.ClientCode                  
  where Existing_SubBroker =  @ACCESS_CODE and Insert_On>=@Fromdate       
  and Insert_On<=@Todate order by  Insert_On desc               
      
--insert into NOC_Process_Outgoing_Rpt_log_testing      
--select datediff(second,@startdate,getdate()),getdate()      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_NXT_NOC_Process_Rpt_NXT2
-- --------------------------------------------------
CREATE PROCEDURE USP_NXT_NOC_Process_Rpt_NXT2     
(
    @ClientCode VARCHAR(20) = NULL,                            
    @Fromdate VARCHAR(12),
    @Todate VARCHAR(12),
    @ACCESS_TO VARCHAR(20),                                              
    @ACCESS_CODE VARCHAR(20),                          
    @UserName VARCHAR(20) = NULL                          
)                          
AS                       
BEGIN                      
    SELECT DISTINCT 
        ClientCode,
        ClientName,
        noc.IsApprove,
        New_SubBroker,
        Existing_SubBroker,
        New_Branch,
        Existing_Branch,        
        CASE 
            WHEN ActiveCLI = 'Y' THEN 'Traded' 
            ELSE 'Non-Traded' 
        END AS SubType,        
        CASE 
            WHEN noc.IsApprove = 0 THEN 'Client has not clicked on the NOC link sent on his registered email ID.'
            WHEN noc.IsApprove = 1 THEN 'Request approved by Client- awaiting confirmation from existing Sub-Broker.'
            WHEN noc.IsApprove = 2 THEN 'Request will be processed within 24 Hrs.'
            WHEN noc.IsApprove = 3 THEN 'Request rejected by existing Sub-Broker'
            WHEN noc.IsApprove = 4 THEN 'Request Deleted'
            WHEN noc.IsApprove = 5 THEN 'Request Re-Approved'
            WHEN noc.IsApprove = 6 THEN 'Withdrawal Request'
            WHEN noc.IsApprove = 7 THEN 'Request Withdrawn'
        END AS Status,
        ReasonForShifting,
        Remarks,
        CASE 
            WHEN noc.B2B_B2C = 'B2C' THEN 'Y' 
            ELSE 'N' 
        END AS b2c,
        Insert_On AS Request_submitted_on,
        UpdatedDate AS [Request Authorized]        
    FROM 
        tbl_MailClient_NOC noc WITH (NOLOCK)              
    INNER JOIN 
        client_details clt WITH (NOLOCK) ON clt.party_code = noc.ClientCode           
    INNER JOIN 
        tbl_NOCstatusLOGS nsl WITH (NOLOCK) ON nsl.NOC_ID = noc.SRNO  
                                               AND noc.IsApprove = nSl.IsApprove      
    WHERE 
        Access_Code = @ACCESS_CODE
        AND Insert_On >= CONVERT(DATETIME, @Fromdate, 101) + ' 00:00:00'
        AND Insert_On <= CONVERT(DATETIME, @Todate, 101) + ' 23:59:59'
    ORDER BY  
        Insert_On DESC;
END;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_NXT_NOC_Process_Rpt_NXT2_UAT
-- --------------------------------------------------
CREATE proc [dbo].[USP_NXT_NOC_Process_Rpt_NXT2_UAT]       
(                            
@ClientCode varchar(20)=null,                              
@Fromdate varchar(12),                            
@Todate varchar(12),                            
@ACCESS_TO AS VARCHAR(20),                                                
@ACCESS_CODE AS VARCHAR(20),                            
@UserName as varchar(20)=null                            
)                            
as                         
BEGIN                        
--if(@CLientCode='E46548')                            
--Begin                            
-- set @CLientCode='%'                            
--End                         
  select distinct ClientCode,ClientName,noc.IsApprove,New_SubBroker,Existing_SubBroker,New_Branch,Existing_Branch,          
  Case when ActiveCLI='Y' then 'Traded' else 'Non-Traded' end as SubType,   
		 Case   when noc.IsApprove=4 then  'Request Deleted'       
				when nsl.IsApprove=0  then  'Client Approval Pending.'                         
                when nsl.IsApprove=1  then  'Existing Sub-broker Approval Pending.'                         
                when nsl.IsApprove=2  then  'Request will be processed within 24 Hrs.'                        
                when nsl.IsApprove=3 then   'Request Rejected reapproval Link sent.'
                when nsl.IsApprove=5 then  'Request Reapproved by Client Existing Sub-broker to trigger withdrawal Link.'                 
                when nsl.IsApprove=6 then  'Withdrawal link sent to the client.'                 
                when nsl.IsApprove=7 then  'Request withdrawn by the client.'              
    END as Status ,ReasonForShifting,Remarks,            
--    clt.b2c,                       
    case when (noc.B2B_B2C='B2C') then 'Y' else 'N' end b2c,            
        Insert_On as [Request_submitted_on] ,UpdatedDate as 'Request Authorized'          
  from risk.dbo.tbl_MailClient_NOC  noc with(nolock)                
        inner join risk.dbo.client_details clt with(nolock) on clt.party_code=noc.ClientCode             
  Left outer join (select NOC_ID, max(IsApprove)IsApprove,max(UpdatedDate)UpdatedDate  from risk.dbo.tbl_NOCstatusLOGS a with(nolock) group by NOC_ID) nsl on nsl.NOC_ID=noc.SRNO       
  where Access_Code=  @ACCESS_CODE and Insert_On>=replace(CONVERT(VARCHAR(12),convert(datetime,@Fromdate,103),106), '/', ' ')+' 00:00:00'                         
  and Insert_On<=replace(CONVERT(VARCHAR(12),convert(datetime,@Todate,103),106), '/', ' ')+' 23:59:59' order by  Insert_On desc                    
          
  --exec USP_NXT_NOC_Process_Rpt_NXT2_UAT @ClientCode =null, @Fromdate ='01-08-2024', @Todate ='31-08-2024', @ACCESS_TO ='sb', @ACCESS_CODE ='CBHO', @UserName =null           
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_P_L_REPORT
-- --------------------------------------------------
  
  
CREATE PROC USP_P_L_REPORT (@SDATE VARCHAR (11) , @SEGMENT VARCHAR (50))  
AS  
BEGIN  
  
IF @SEGMENT='MCX'  
BEGIN  
  
SELECT DISTINCT *,TIME_GAP=CONVERT(VARCHAR(8), DATEADD(MS, DATEDIFF(MS, MIN_TIME, MAX_TIME), 0), 114)            
FROM MISC.DBO.ANGEL_OPTIONPL (NOLOCK) WHERE SAUDA_DATE = @SDATE            
ORDER BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE       
END  
  
IF @SEGMENT='NCDX'  
BEGIN  
  
SELECT DISTINCT *,TIME_GAP=CONVERT(VARCHAR(8), DATEADD(MS, DATEDIFF(MS, MIN_TIME, MAX_TIME), 0), 114)    
FROM MISC.DBO.ANGEL_OPTIONPL_NCDEX (NOLOCK) WHERE SAUDA_DATE = @SDATE  
ORDER BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE    
END  

IF @SEGMENT=''  
BEGIN 
SELECT 'KINDLY SELECT THE SEGMENT' AS REMARKS
END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_PayOut_Emailer_08Aug2023
-- --------------------------------------------------
 --exec Usp_PayOut_Emailer            
CREATE  proc [dbo].[Usp_PayOut_Emailer_08Aug2023]            
AS            
BEGIN            
      
  --select * from NCMS_LastPayout_Emailer order by PArty_Code         
      
  declare @datetime varchar(20),@date varchar(11),@time varchar(11),@reqdate varchar(11)      
select convert(varchar(20),dbo.udf_getcredittime(updateon,'','' ) ,106) Crdatetime,* into #Date from NCMS_SEND_EMAIL_FullPartial_08Aug2023      
----select @datetime      
--SELECT crdate=Convert(varchar(11),CONVERT(date,cast(left(Crdatetime, charindex(' ', Crdatetime) - 1) as date),106),113) ,     
--crtime = reverse(left(reverse(Crdatetime), charindex(' ', (reverse(Crdatetime))+' ' ) -1)),* from #Date     
--select @reqdate= Convert(varchar(11),CONVERT(date,cast(@date as date),106),113)    
    
    
  select  crdate=Convert(varchar(11),CONVERT(date,cast(left(Crdatetime, charindex(' ', Crdatetime) - 1) as date),106),113) ,     
crtime = reverse(left(reverse(Crdatetime), charindex(' ', (reverse(Crdatetime))+' ' ) -1)),PArty_Code,Entity,convert(varchar(30), ApprovedAmt, 1) as ApprovedAmt,'4'PO_statusid,CONVERT(VARCHAR(20), SUBSTRING(CONVERT(VARCHAR(20),req_PayBAnkid),1,0)) +      
  
 'xxxxx' +        
 CONVERT(VARCHAR(20), SUBSTRING(CONVERT(VARCHAR(20),req_PayBAnkid),LEN(req_PayBAnkid) - 3, LEN(req_PayBAnkid)))        
 AS req_PayBAnkid,convert(varchar(30), po_request, 1) as po_request,short_name,Bank_Name,UTRNo,'neha.naiwar@angelbroking.com' email from #Date                
            
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_PayOut_Emailer_09Aug2023
-- --------------------------------------------------
--exec Usp_PayOut_Emailer      
create  proc [dbo].[Usp_PayOut_Emailer_09Aug2023]      
AS      
BEGIN      

  declare @datetime varchar(20),@date varchar(11),@time varchar(11),@reqdate varchar(11)      
select convert(varchar(20),dbo.udf_getcredittime(updateon,'','' ) ,106) Crdatetime,* into #Date from NCMS_SEND_EMAIL_FullPartial_08Aug2023      

    
  select  crdate=Convert(varchar(11),CONVERT(date,cast(left(Crdatetime, charindex(' ', Crdatetime) - 1) as date),106),113) ,     
crtime = reverse(left(reverse(Crdatetime), charindex(' ', (reverse(Crdatetime))+' ' ) -1)),PArty_Code,Entity,convert(varchar(30), ApprovedAmt, 1) as ApprovedAmt,'4'PO_statusid,CONVERT(VARCHAR(20), SUBSTRING(CONVERT(VARCHAR(20),req_PayBAnkid),1,0)) +      
  
 'xxxxx' +        
 CONVERT(VARCHAR(20), SUBSTRING(CONVERT(VARCHAR(20),req_PayBAnkid),LEN(req_PayBAnkid) - 3, LEN(req_PayBAnkid)))        
 AS req_PayBAnkid,convert(varchar(30), po_request, 1) as po_request,short_name,Bank_Name,UTRNo,'neha.naiwar@angelbroking.com' email from #Date                
 --where party_code in ('S1499152','P287427')     
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_RevOrderOFSFile
-- --------------------------------------------------

CREATE proc [dbo].[Usp_RevOrderOFSFile]  

As  
  
Begin   
  
    --declare @FileName as varchar(100)='trades.txt'  
    --truncate table Temp_ReversalOFS_NSE1      
         
   -- Declare @filePath varchar(500)=''                     
    --set @filePath ='\\196.1.115.147\upload1\OmnesysFileFormat\PP.csv'    
    --set @filePath ='\\196.1.115.147\upload1\OmnesysFileFormat\'+@FileName+''       
    --DECLARE @sql NVARCHAR(4000) = 'BULK INSERT Temp_ReversalOFS_NSE1 FROM ''' + @FileName + ''' WITH ( FIELDTERMINATOR ='','', ROWTERMINATOR =''\n'',FirstRow=2 )';                  
   -- EXEC(@sql) 
    
	  update OFS_ORDER
	  set REMARKS='N',BID_NO=b.OrderID
	  from OFS_ORDER a
	  inner join Temp_ReversalOFS_NSE1 b    --a1 join OFS_ScripMaster b  on SUBSTRING (a1.Symbol ,0,CHARINDEX ('-',a1.Symbol))  =b.ScripName)c 
	  on a.CLIENT_CODE=b.ClientId and a.SCRIPCODE = (select top 1 SrNo from OFS_ScripMaster  where  left(ScripName,3) = left(symbol,3) order by EnteredOn desc ) 
	  and a.QUANTITY=b.Quantity and a.BID_RATE=b.Price
	  where a.SEGMENT='NSE' and a.REQUEST_DATE between convert(varchar,getdate(),101) and convert(varchar,getdate(),101)+' 23:59:50' and remarks=''
	  and a.GENERATION_FLAG=1

	--update p  
	--set p.REMARKS=c.[OrderStatus] --+', '+ ISNULL ( c.Remarks ,'')   
	--from  (select * from Temp_ReversalOFS_NSE1 a join OFS_ScripMaster b  
	--on SUBSTRING (a.Symbol ,0,CHARINDEX ('-',a.Symbol))  =b.ScripName) c   
	--join ofs_order p  
	--on p.CLIENT_CODE=c.[ClientId]  and p.SCRIPCODE =c.Srno   
    

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_RevOrderOFSFile_CUG
-- --------------------------------------------------
  
CREATE proc [dbo].[Usp_RevOrderOFSFile_CUG]    
  
As    
    
Begin     
 
   --update OFS_ORDER  
   --set BID_NO=b.OrderID
   --from OFS_ORDER a  
   --inner join Temp_ReversalOFS_NSE1 b
   --on a.CLIENT_CODE=b.ClientId and a.SCRIPCODE = (select top 1 SrNo from OFS_ScripMaster  where  left(ScripName,3) = left(symbol,3) order by EnteredOn desc )   
   --and a.QUANTITY=b.Quantity and a.BID_RATE=b.Price  
   --where a.SEGMENT='NSE' and a.REQUEST_DATE between convert(varchar,getdate(),101) and convert(varchar,getdate(),101)+' 23:59:50' and a.GENERATION_FLAG=1  

   --TRUNCATE TABLE Temp_ReversalOFS_NSE1
   SELECT '1'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Send_BrokerageSMS_For_ITradePremierPlusVBB
-- --------------------------------------------------
-- =============================================  
-- Author:  HRISHI YERUNKAR
-- Create date: 17 NOV 2025
-- Description: Brokerage SMS  
-- =============================================  
CREATE PROCEDURE [dbo].[USP_Send_BrokerageSMS_For_ITradePremierPlusVBB](@Party_code varchar(20))  
AS  
BEGIN  
 
   
insert into itrade_SMS_Mail_log(party_code,source,UpdatedOn)  
 select @Party_code,'SMS',GETDATE()  
   
insert into sms.dbo.tbl_SMS (party_code,message,date,time,flag,ampm,purpose)                                   
 select  party_code, sms_msg, sms_dt ,sms_time, flag,ampm,purpose from           
 (          
  select  party_code,  
  'Dear Client  '+ltrim(rtrim(CONVERT(VARCHAR(15),party_code)))+'  , Your Brokerage plan has been changed to Angel ITrade Premier Plus VBB. For more details visit your Profile section. Regards - Angel One' as sms_msg,  
  convert(varchar(10), getdate(), 103) as sms_dt,  
  ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' + ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate())))))  as sms_time,  
  'P' as flag,   
  case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end  as ampm,  
  'Brokerage ITrade Premier Plus VBB'   as Purpose           
  from risk.dbo.client_Details where party_code=@Party_code   
 ) x   
   
-- NEW  
 --Dear Subodh Salvi, we are pleased to change your Brokerage plan to Angel iTrade Prime - Zero brokerage   
 --for Equity Delivery & Rs.20/- per executed order for Intraday, F&O, Currency & Commodity.   
 --Statutory taxes as applicable.  
   
-- OLD   
--'Dear ' +ltrim(rtrim(CONVERT(VARCHAR(10),party_code)))+' As requested,   
-- your Online Trading and Demat Tariff per executed order,   
-- has been revised to Rs.15  for order value less than or equal to Rs.50000 and Rs.30    
-- for order value greater than Rs.50000. '  as sms_msg,           
   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_sfdc_getblkClientdetails_Test
-- --------------------------------------------------



CREATE proc [dbo].[usp_sfdc_getblkClientdetails_Test]  

AS  
BEGIN  

	 select top 8700 PArty_code,
	 Sub_broker,
	 pan_gir_no,
	 Sex,
	 email,
	 sub_broker as  SubType,
	 l_address1+l_address2+l_address3 as street,
	 l_city,
	 l_nation as Country,
	 l_Zip as PostalCode,
	 l_State as  [State],
	 '' as FirstName,
	 Long_name as LastName,
	 Long_name as FullName,
	 '' as [Login],  
	 --replace (convert(varchar, DOB, 23),'-','/'),
	 (convert(varchar, DOB, 23)) as DOB,
	 case when (b2c='y') then 'B2C' else 'B2B'End B2B ,
	 case when Last_inactive_date>GETDATE() then 'TRUE' else 'FALSE' end as AccountActive,
	 mobile_pager as OfficePhone,
	 mobile_pager as MobilePhone,
	 branch_cd as SubTag_BranchTag,
	 Bank_Name as Bank_Name ,
	 AC_Num as AccountNumber,
	 AC_Type as AccountType,
	 Micr_No as MICR,
	 '' as IFSCCode, 
	 '' as OnlineBankFacility,
	 branch_cd as BranchCode,
	 Sub_broker as SubBrokerCategory,
	 Sub_broker as SBCategory,
	 '' as SBName
	 from risk.dbo.Client_details with (nolock) where  cl_code in ('A1209664','G145313')
	 --into #Client_Data  Client_details_05062024
	 --from client_details_test_24052024 where Cl_code in  ('A1044891','A1045722','A1044916','A1044140','A1044565','A1045710','A1044891')  --('RP61','P94526','K79105')  --('L16659') --Last_inactive_date <getdate(

	 --from risk.dbo.client_details where cl_code in ('G145313')

	 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_SMEIPO_FinalClientData_UAT
-- --------------------------------------------------
Create proc [dbo].[Usp_SMEIPO_FinalClientData_UAT]  
  
@Username varchar(10) = null  
  
AS  
BEGIN  
     
 exec [AGMUBODPL3].[Scratchpad].dbo.USP_SME_IPO_DP1_UAT   
  
 exec [AngelDP5].[Scratchpad].dbo.USP_SME_IPO_DP2_UAT   
  
 exec [ATMUMBODPL03].[Scratchpad].dbo.USP_SME_IPO_DP3_UAT 
   
 select * from [AGMUBODPL3].[Scratchpad].dbo.SMEClientData_DP1 
 union  
 select * from [AngelDP5].[Scratchpad].dbo.SMEClientData_DP2   
 union  
 select * from [ATMUMBODPL03].[Scratchpad].dbo.SMEClientData_DP3 
   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_SubBrokerMailSend
-- --------------------------------------------------
CREATE proc [dbo].[usp_SubBrokerMailSend]    
@SbTag varchar(max)=null,  
@other_email varchar(max)=null,  
@To_Email varchar(max)=null,  
@mode int  
as    
begin     
 if @mode=1  
 begin  
  insert into MailListSbTag values(@SbTag,@other_email,@To_Email)  
 end  
 if @mode=2  
 begin  
   Declare @Other_Emails nvarchar(MAX) = '',@RECIPIENTS_Emails nvarchar(max)    
   Select @Other_Emails = coalesce(@Other_Emails + ';', '') + other_email from MailListSbTag    
   Select @RECIPIENTS_Emails = coalesce(@RECIPIENTS_Emails + ';', '') + to_email from MailListSbTag    
   select @Other_Emails   
   --select @Other_Emails+@RECIPIENTS_Emails  
       
  Declare @Init int= 1,@Rowcount int     
  Declare @Emails nvarchar(MAX),@APTag varchar(10),@APName varchar(200),@QuestionsList varchar(max),@AuditorName varchar(100),@AuditDate varchar(20)    
  Declare @subjectMessage varchar(max), @bodyMessage varchar(max)    
     
   truncate table tbl_Sbtaglist  
  
   insert into tbl_Sbtaglist  
   select distinct sbtag from tbl_SbTag_Mail  
  
  select @Rowcount=count(*) from MailListSbTag      
  while @Init<=@Rowcount  
  begin    
    select @APTag=sbtag from MailListSbTag where id=@Init  
    select distinct @Emails=Emailid,@APName=APName,@AuditorName=b.person_name,@AuditDate=Convert(varchar(20),Audit_Date,103) from tbl_SbTag_Mail a  
    inner join INTRANET.Rolemgm.dbo.user_login b on b.username=a.updatedby  
    where sbtag=@APTag      
      
    declare @html as varchar(max)    
    set @html='<table border=''1''><tr style="background-color:#F4DACD"><th style="width:800px;">Audit Observations</th><th>Corrective Action</th><th>Applicable Penalty</th></tr>'    
    select  @html= @html+ '<tr><td>'+NonCompliantRemarks +'</td><td>Refer Annexure A</td><td>Refer Annexure A</td></tr>' from tbl_SbTag_Mail where sbtag=@APTag    
    set @html= @html + '</table>'    
      
    Set @subjectMessage='Clarification for Non-compliance/Discrepancies observed during the internal audit/inspection at your office  (AP tag- '+@APTag+')'    
            
     Set @bodyMessage='Dear Sir,<br>   
       '+@APName+' ('+@APTag+')<br/>    
       This is further to the inspection of your books of accounts and other records carried out by our Inspecting team on dt. '+@AuditDate+'  below mentioned are the observations raised by the Auditors Mr. '+@AuditorName+' during inspection.     
    ' +@html +'<br/>You are requested to kindly go through the said observations and provide us necessary explanation or initiate corrective action, wherever required, within 7 days from the date of the email failing which you shall be liable for necessar
y action including penalties as per the policy of the Company. <br/>  
    Kindly treat this as utmost important and revert at the earliest. <br/>  
    Note :- Please submit your documents to vishwajeet.singh@angelbroking.com mail ID.<br/>  
    Regards,<br/>      
    Internal Audit Department'  
      
   select @APTag 'APTag',@Emails 'Email',@subjectMessage 'Subject',@bodyMessage 'Body',@html 'Questions'    
  
   DECLARE @FILENAME1 as varchar(100)   
   SET @FILENAME1 = '\\196.1.115.147\d\upload1\IFSCUpdate\AP Audit Annexure.docx'  
       
    EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                            
          @RECIPIENTS = @Other_Emails,      
          @blind_copy_recipients='Leon.vaz@angelbroking.com;',  
          @PROFILE_NAME = 'AngelBroking',                                            
          @BODY_FORMAT ='HTML',                                            
          @SUBJECT = @subjectMessage,      
       @FILE_ATTACHMENTS =@FILENAME1,     
          @BODY =@bodyMessage        
      
    insert into tbl_SubBrokerMailSendLog(sbtag,email,logdate,AuditDate)    
    select sbtag,emailid,getdate(),max(Audit_Date) from tbl_SbTag_Mail  where sbtag=@APTag   
    group by Sbtag,emailid   
      
    SET @Init=@Init+1     
  end    
 end  
 if @mode=3  
 begin  
  truncate table MailListSbTag  
 end    
 if @mode=4  
 begin  
  SELECT Sbtag,NonCompliantRemarks FROM tbl_SbTag_Mail where sbtag=@SbTag  
 end  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Unpledge_Request_Process_16Oct2023
-- --------------------------------------------------
  
  
  
  
-- =============================================  
-- Author: <Neha Naiwar>  
-- Create date: <14 Aug 2020>  
-- Description: <Description>  
-- =============================================  
create PROCEDURE [dbo].[USP_Unpledge_Request_Process_16Oct2023]  
AS  
BEGIN  
  
  
insert into tbl_unpledge_Request_hist  
select *,GETDATE() from tbl_unpledge_Request  --where status=201  
  
  
select * into #Sq_UnPleadge from tbl_unpledge_Request where status=201  
  
--delete from #Sq_UnPleadge where party_code='L32608'  
  
select a.*,convert(money,MTM_Price) as MTM_Price,c.[Angel scrip category] as Angel_Scrip,c.[ANGEL_VAR %] as Var_margin,c.series,CONVERT(MONEY, 0) as Value_BHC,  
CONVERT(MONEY, 0) as Value_AHC,  
convert(int,0) as Priority_scrip,convert(int,0) as Priority_scripwise,convert(int,0) as Priority_Valuewise,convert(varchar(20),'') as cl_type  
  into #unPleadge from #Sq_UnPleadge a join  
 [196.1.115.182].GENERAL.DBO.Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/  
a.ISIN=b.security_isin join [196.1.115.182].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.ISIN=c.[isin no]  
  
  
/*******************************************************/  
select distinct isin,nav_value into #inf from [172.31.16.75].ANGEL_WMS.dbo.dw_mst_bse_mf_scheme with(nolock) where nav_value is not null  
  
--select distinct [isin no],series,[Angel scrip category] into #MfSeries from  [196.1.115.182].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS with(nolock)  
--where series='MF'  
  
insert into #unPleadge  
select a.*,convert(money,nav_value) as MTM_Price,c.[Angel scrip category] as Angel_Scrip,10.00 as Var_margin,c.series,CONVERT(MONEY, 0) as Value_BHC,  
CONVERT(MONEY, 0) as Value_AHC,  
convert(int,0) as Priority_scrip,convert(int,0) as Priority_scripwise,convert(int,0) as Priority_Valuewise,convert(varchar(20),'') as cl_type  
  from #Sq_UnPleadge a  join  
 #inf  b with(nolock) on /*a.scrip =b.Security_Symbol and*/  
a.ISIN=b.isin  /*and a.scrip=b.scheme_name*/ join [196.1.115.182].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.ISIN=c.[isin no]  
--and a.ISIN like 'INF%'  
and a.isin not in (select isin from #unPleadge)  
order by a.party_code  
/****************************************************/  
  
  
update #unPleadge set Value_BHC=MarkedQty*MTM_Price  
update #unPleadge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)  
  
select ROW_NUMBER() OVER ( ORDER BY a.party_code) AS Srno,a.scrip,a.series,a.MarkedQty,a.party_code,a.ISIN,a.requestdate,a.MTM_Price,a.Priority_scrip,a.Angel_Scrip,a.Var_margin,  
a.Value_BHC,a.Value_AHC,b.netpayable,b.MarginAmt,b.Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,  
MarginShortage,AccruedCharges,OtherDebit,CONVERT(MONEY, 0) as  NET,CONVERT(MONEY, 0) as  
approved,a.Priority_scripwise,a.Priority_Valuewise,Req_refno,a.cl_type  
into #final_Code from #unPleadge a left outer join UnPleadge_Segveridata_VW b with(nolock) on a.Party_code=b.Party_code  
  
alter table #final_Code add Seq_approve_status varchar(50)  
  
alter table #final_Code add ReleasedQty int  
alter table #final_Code add BlockedQty int  
  
/*update #final_Code set NET=netpayable where MarginAmt=0    
update #final_Code set NET=Balance+MarginAmt+NonCashColl where MarginAmt<0  
update #final_Code set NET=NET+UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges where MarginAmt<0  */  
update #final_Code set NET=Balance+MarginAmt+NonCashColl+UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges    
  
update #final_Code set  cl_type =b.cl_type from  
(select party_code,cl_type from risk.dbo.client_details  with(nolock)) b where #final_Code.party_code=b.party_code and Seq_approve_status is null  
  
--select * from #final_Code where cl_type='nbf' and MarginAmt=0  
  
update #final_Code set   Seq_approve_status =  'Released' where cl_type='nbf' and MarginAmt=0  
  
update #final_Code set   Seq_approve_status =  'Blocked' where NET<0  and Seq_approve_status is null  
  
/*update #final_Code set   Seq_approve_status =  'Released' where NET>=0 and MarginAmt=0 and Seq_approve_status is null  
  
update #final_Code set   Seq_approve_status =  'Released' where NET>=0 and Seq_approve_status is null*/  
  
/********************************/  
  
--update  #final_Code set  Seq_approve_status='Released' where   MarginAmt=0  and NET>=-500 and NET<0  
--and Seq_approve_status is null  
  
  
--update  #final set  Seq_approve_status='Released' where   MarginAmt=0  and netpayable>=-500 and netpayable<0  
--and Seq_approve_status is null  
  
--/********************************/  
  
/*select * into #final from #final_Code  where  netpayable<0*/  
  
/********************************/  
/*  
update  #final_Code set  Seq_approve_status='Released' where   MarginAmt=0  and netpayable>=-500 and netpayable<0  
and Seq_approve_status is null  
  
update  #final set  Seq_approve_status='Released' where   MarginAmt=0  and netpayable>=-500 and netpayable<0  
and Seq_approve_status is null  
*/  
/********************************/  
  
/*select SUM(value_AHC) as  value_AHC,party_code,NetPayable into #ee from #final group by party_code,NetPayable*/  
select SUM(value_AHC) as  value_AHC,party_code,NET into #ee from #final_Code where Seq_approve_status is null group by party_code,NET  
  
Select * into #data from #ee where NET>=value_AHC  
  
  
update #final_Code set  Seq_approve_status = 'Released' from  
(select party_code from #data) b where #final_Code.party_code=b.party_code and Seq_approve_status is null  
  
--update #final set  Seq_approve_status = 'Blocked' from  
--(select party_code from #data) b where #final.party_code=b.party_code  and Seq_approve_status is null  
  
  
  
select ROW_NUMBER() OVER ( ORDER BY party_code) AS [SrNo],party_code into #single from #final_Code /*#final*/ where Seq_approve_status is null group by party_code having COUNT(1)=1  
  
  
  
update  #final_Code set  Seq_approve_status=case when NET>=value_AHC then 'Released'  
 when NET<=value_AHC then 'Blocked' end from  
(select party_code from #single) b where #final_Code.party_code=b.party_code and Seq_approve_status is null  
  
update  #final_Code set ReleasedQty=MarkedQty,BlockedQty=0 where Seq_approve_status='Released'  
update  #final_Code set ReleasedQty=0,BlockedQty=MarkedQty where Seq_approve_status='Blocked'  
  
  
select * into #final from #final_Code  where Seq_approve_status is null  
  
--select *,netpayable*0.5+MarginAmt as newNet from #final_Code where MarginAmt<0 and NetPayable>0  
--update #final set NetPayable=netpayable*0.5+MarginAmt where MarginAmt<0 and NetPayable>0 and Seq_approve_status is null  
  
--select *,MarginAmt+NetPayable as newNet from #final_Code where MarginAmt<0 and NetPayable<0  
--update #final set NetPayable=MarginAmt+NetPayable where MarginAmt<0 and NetPayable<0 and Seq_approve_status is null  
  
  
  
  
--update #final set NetPayable=NetPayable*-1 where NetPayable>0 and MarginAmt<0  
  
  
ALTER TABLE #final_Code ADD PRIORITY_ALL INT  
  
select ROW_NUMBER() OVER ( ORDER BY party_code) AS [SrNo],party_code  into #multiscrip_SameCli from  #final where Seq_approve_status is null group by party_code having COUNT(1)>1  
IF (select COUNT(1) from #multiscrip_SameCli) > 0                                              
BEGIN  
select ROW_NUMBER() OVER ( ORDER BY a.party_code) AS [SrNoID],                                              
a.*,CONVERT(int,0) as   priority_all                                            
into #NCMS_APPAMT_TEMP                                              
from #final a join #multiscrip_SameCli b                                            
on a.PARTY_CODE=b.party_code  
  
   Declare @MC_ctr as int , @pcode_count as int=0,@pcount as int=1, @MC_Totctr as int = 0,@pcode as varchar(10)='',@entityx as varchar(10)=''                                            
Declare @M_pcode as varchar(10)='',@M_ISIN as varchar(10)='',@po_allowed as money = 0  ,@value_AHC as money=0 ,@approved as money=0  ,@appforqty as money=0.00                                         
Declare @SRno as int =0  ,@net as money=0,@qty int,@rate money,@blockqty int,@netamonut money,@releaseQty int                                                   
  
select @pcode_count=COUNT(1)  from #multiscrip_SameCli  
  
while    @pcount<=   @pcode_count  
begin  
select @M_pcode=party_code from #multiscrip_SameCli where SrNo=@pcount  
--print convert(varchar(50),@pcount)+@M_pcode  
  
select @MC_Totctr=COUNT(1) from #NCMS_APPAMT_TEMP  where party_code=@M_pcode  
  
SELECT  
SrNoID,Srno,scrip,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Angel_Scrip,Var_margin,Value_BHC,Value_AHC,  
netpayable,approved,Seq_approve_status,Net,  
dense_rank () OVER ( ORDER BY Var_margin) Priority_scrip,    
--dense_rank () OVER ( ORDER BY Angel_Scrip) Priority_scripwise,  
case when Angel_Scrip='Bluechip' then 1  
    when Angel_Scrip='Good' then 2  
    when Angel_Scrip='Average' then 3  
    when Angel_Scrip='Poor' then 4 end Priority_scripwise,  
dense_rank () OVER ( ORDER BY value_AHC) Priority_Valuewise  
   into #unPleadge_code  
FROM #NCMS_APPAMT_TEMP where party_code=@M_pcode    --'C8716'  
  
update #NCMS_APPAMT_TEMP set Priority_scrip=b.Priority_scrip,Priority_scripwise=b.Priority_scripwise,Priority_Valuewise=b.Priority_Valuewise  from  
(select Priority_scrip,Angel_Scrip,Value_AHC,Priority_Valuewise,party_code,Var_margin,Priority_scripwise from #unPleadge_code) b where  
#NCMS_APPAMT_TEMP.party_code=b.party_code and  
#NCMS_APPAMT_TEMP.Var_margin=b.Var_margin and #NCMS_APPAMT_TEMP.Angel_Scrip=b.Angel_Scrip and  #NCMS_APPAMT_TEMP.Value_AHC=b.Value_AHC  
  
  
select  ROW_NUMBER() OVER ( ORDER BY party_code) AS Sr,SrNoID,Srno,scrip,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,Value_AHC,netpayable,approved,Priority_scripwise,Priority_Valuewise,Seq_approve_statu
s,Net,releasedQty,BlockedQty,  
priority_all=convert(varchar(10),Priority_scrip)+convert(varchar(10),Priority_scripwise)+convert(varchar(10),Priority_Valuewise)  
into #PARTY_wise from   #NCMS_APPAMT_TEMP where party_code=@M_pcode--'C8716'  
  
update #NCMS_APPAMT_TEMP set priority_all=b.priority_all  from  
(select Priority_scrip,Angel_Scrip,Value_AHC,Priority_Valuewise,party_code,Var_margin,Priority_scripwise,priority_all from #PARTY_wise) b where  
#NCMS_APPAMT_TEMP.party_code=b.party_code and  
#NCMS_APPAMT_TEMP.Var_margin=b.Var_margin and #NCMS_APPAMT_TEMP.Angel_Scrip=b.Angel_Scrip and  #NCMS_APPAMT_TEMP.Value_AHC=b.Value_AHC  
  
  
select ROW_NUMBER() OVER ( ORDER BY Priority_scrip desc) AS Sn, * into #PARTY from #PARTY_wise order by Priority_scrip/*priority_all*/ desc  
  
alter table #PARTY add cntnegative int  
  
set @MC_ctr=1  
---select @MC_Totctr=COUNT(1) from #NCMS_APPAMT_TEMP  where party_code=@M_pcode  
  
while @MC_ctr<=@MC_Totctr  
begin  
--insert into #partycode  
--select @MC_ctr,@M_pcode  
select @po_allowed=case when @MC_ctr=1 then (Net)-value_AHC else 0.00 end from #PARTY where Sn=@MC_ctr  
  
update #PARTY set approved=@po_allowed where Sn=@MC_ctr  
  
select @value_AHC=value_AHC,@qty=MarkedQty from #PARTY where Sn=@MC_ctr  
  
select @approved=isnull(approved,0) from #party where Sn=@MC_ctr-1  
  
select @net=Net from  #party where Sn=@MC_ctr  
/* if( @approved<@net*-1)  
 begin  
  print 'hi'*/  
  
update #PARTY set approved=case when @MC_ctr>1 then @approved-@value_AHC else approved end where Sn=@MC_ctr and sn>1 and @approved<=(Net)  
--update #PARTY set Seq_approve_status=case when  @MC_ctr=1 and Net*-1<approved*-1 then 'Blocked' else '' end  where Sn=@MC_ctr  
--update #PARTY set Seq_approve_status=case when  @MC_ctr=1 and Net*-1<@value_AHC then 'Blocked' else '' end  where Sn=@MC_ctr  
select @approved=approved,@value_AHC=value_AHC,@qty=MarkedQty from #PARTY where  Sn=@MC_ctr  
if(@approved>0)  
begin  
 update #PARTY set releasedqty=MarkedQty,blockedqty=0 where Sn=@MC_ctr  
end  
  
--if(@approved<0)  
--update #PARTY set cntnegative=@MC_ctr where Sn=@MC_ctr  
if(@approved<0)  
begin  
 select @appforqty=isnull(approved,0) from #party where Sn=@MC_ctr-1  
 print @appforqty  
 select @rate=@value_AHC/@qty  
 print @rate  
 select @releaseQty=floor(@appforqty/@rate)  
 print @MC_ctr  
 print @releaseQty  
 update #party set releasedQty=case when @releaseQty<0 then 0 else @releaseQty end where Sn=@MC_ctr  
 update #party set blockedqty=case when releasedQty=0 then MarkedQty else MarkedQty-releasedQty end where Sn=@MC_ctr  
   
end  
   
set @MC_ctr=@MC_ctr+1  
--update #PARTY set Seq_approve_status='Blocked' where cntnegative is  null  
end  
/*  
UPDATE #PARTY set Seq_approve_status=case when approved>0.00 then 'Blocked' else 'Released' end  where party_code=@M_pcode  
and isnull (Seq_approve_status,'')=''  
  
update #PARTY set releasedqty=MarkedQty, BlockedQty=0 where Seq_approve_status='Released'  
 update #PARTY set releasedqty=0, BlockedQty=MarkedQty where Seq_approve_status='Blocked'*/  
  
update #NCMS_APPAMT_TEMP set approved=b.approved,Seq_approve_status=case when b.MarkedQty=b.ReleasedQty then 'Released'  
  when b.MarkedQty=b.BlockedQty then 'Blocked'  
  when  b.MarkedQty>b.ReleasedQty  and b.BlockedQty<>0 and b.ReleasedQty<>0 then 'Partially Released' end,ReleasedQty=b.ReleasedQty,BlockedQty=b.BlockedQty from  
(  
select scrip,party_code,isin,approved,Seq_approve_status,ReleasedQty,MarkedQty,BlockedQty from #PARTY where party_code=@M_pcode  
)b where #NCMS_APPAMT_TEMP.scrip=b.scrip and #NCMS_APPAMT_TEMP.party_code=b.party_code and #NCMS_APPAMT_TEMP.isin=b.isin  
  
set @pcount=@pcount+1  
     
   DROP TABLE #unPleadge_code  
DROP TABLE #PARTY_wise  
DROP TABLE #PARTY  
end  
  
  
  update #final_Code set approved=b.approved,Seq_approve_status=B.Seq_approve_status,PRIORITY_ALL=B.PRIORITY_ALL,ReleasedQty=b.ReleasedQty,  
  BlockedQty=b.BlockedQty  
   from  
  (  
  select Angel_Scrip,scrip,party_code,isin,approved,Seq_approve_status,PRIORITY_ALL,ReleasedQty,MarkedQty,BlockedQty from #NCMS_APPAMT_TEMP  
  )b where ltrim(rtrim(#final_Code.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_Code.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(#final_Code.scrip))=ltrim(rtrim(b.scrip))  
  
end  
--update  #final_Code set ReleasedQty=MarkedQty,BlockedQty=0 where Seq_approve_status='Released'  
--update  #final_Code set ReleasedQty=0,BlockedQty=MarkedQty where Seq_approve_status='Blocked'  
--drop table #SinglePt  
--drop table #singlePartial  
/*  
select  party_code into #SinglePt from #final_Code where Seq_approve_status='Blocked'  
 group by party_code having COUNT(1)=1*/  
  
select  ROW_NUMBER() OVER ( ORDER BY party_code) AS Sr,* into #singlePartial from  
#final_Code where Seq_approve_status='Blocked' and party_code in (select party_code from #single) and Value_AHC<>0  
  
--update #singlePartial set releasedqty=0,blockedqty=0  
  
declare @ctr int,@count int=0,@Partial_count int=1,@code varchar='',@V_AHC money,@qtyS int,@rateS money,@blockqtyS int,@netamonutS money,@releaseQtyS int  
select @count=COUNT(1)  from #singlePartial  
while    @Partial_count<=   @count  
begin  
select @code=party_code,@V_AHC=Value_AHC,@qtyS=MarkedQty,@netamonutS=Net from #singlePartial where Sr=@Partial_count  
select @rateS=@V_AHC/@qtyS  
select @releaseQtyS=Floor(@netamonutS/@rateS)  
select @blockqtyS=@qtyS-@releaseQtyS  
update #singlePartial set BlockedQty=@blockqtyS,ReleasedQty=@releaseQtyS where Sr=@Partial_count  
set @Partial_count=@Partial_count+1  
end  
  
update #singlePartial set BlockedQty=markedqty ,ReleasedQty=0 where ReleasedQty<0  
update #singlePartial set BlockedQty=markedqty ,ReleasedQty=0 where BlockedQty<0  
  
update #final_Code set Seq_approve_status=case when b.MarkedQty=b.ReleasedQty then 'Released'  
  when b.MarkedQty=b.BlockedQty then 'Blocked'  
  when  b.MarkedQty>b.ReleasedQty  and b.BlockedQty<>0 and b.ReleasedQty<>0 then 'Partially Released' end  
   ,ReleasedQty=b.ReleasedQty,BlockedQty=b.BlockedQty from  
(  
select Angel_Scrip,scrip,party_code,isin,approved,Seq_approve_status,BlockedQty,ReleasedQty,MarkedQty from #singlePartial  
)b where ltrim(rtrim(#final_Code.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_Code.isin))=ltrim(rtrim(b.isin))  
and ltrim(rtrim(#final_Code.scrip))=ltrim(rtrim(b.scrip)) and #final_Code.MarkedQty=b.MarkedQty  
  
/*  
select  ROW_NUMBER() OVER ( ORDER BY party_code) AS Sr,party_code into #multiplecodes from #final_Code where Seq_approve_status='Blocked'  
 --and party_code in (select party_code from #multiscrip_SameCli)  
 group by party_code having COUNT(1)>1  
  
select  ROW_NUMBER() OVER ( ORDER BY party_code) AS Sr,*,convert(money,0.00) as net_Afetr_Adjust into  
 #multiplePartial1 from  
#final_Code where  Seq_approve_status='Blocked' and party_code in (select party_code from #multiplecodes) and Value_AHC<>0  
  
declare @count_mlP int=0,@PartialMulti_count int=1,@Muti_pcode varchar(40)='',@ct as int,@Totctr int=0  
select @count_mlP=COUNT(1)  from #multiplePartial1  
while    @PartialMulti_count<=   @count_mlP  
begin  
--set @Muti_pcode='B98855'  
  
  select @Muti_pcode=party_code from #multiplecodes where Sr=@PartialMulti_count  
select ROW_NUMBER() OVER ( ORDER BY party_code) AS num,* into #partial_party from #multiplePartial1 where party_code=@Muti_pcode order by Var_margin  
     select @Totctr=COUNT(1) from #partial_party  where party_code=@Muti_pcode    
   
  
set @ct=1  
  
declare @codemul varchar(100)='',@V_AHC_mul money=0.00,@qty_mul int=0,@rate_mul money=0.00,@blockqty_mul int=0,@netamonut_mul money=0.00,  
        @releaseQty_mul int=0,@netpamain as money=0.00  
   while @ct<=@Totctr    
   begin    
select @codemul=party_code,@V_AHC_mul=Value_AHC,@qty_mul=MarkedQty,@netamonut_mul=Net,@netpamain=Net from #partial_party where num=@ct  
--print @codemul  
--print @V_AHC_mul  
--print @qty_mul  
print @netamonut_mul  
select @netamonut_mul=net_Afetr_Adjust from #partial_party where num=@ct-1  
print @V_AHC_mul  
print @netamonut_mul  
if(@V_AHC_mul>=@netamonut_mul*-1)  
begin  
print 'hi'  
if(@netamonut_mul<=0.00)  
begin  
print 'hello'  
set @rate_mul=@V_AHC_mul/@qty_mul  
--print @rate_mul  
set @blockqty_mul=CEILING(@netamonut_mul*-1/@rate_mul)  
print @blockqty_mul  
update #partial_party set blockedqty =case when @blockqty_mul>@qty_mul then @qty_mul else  @blockqty_mul end where num=@ct  
--select @releaseQty_mul=@qty_mul-@blockqty_mul  
update #partial_party set ReleasedQty=MarkedQty-blockedqty where num=@ct  
update #partial_party set net_Afetr_Adjust=@V_AHC_mul+@netamonut_mul  where num=@ct  
end  
else  
update #partial_party set ReleasedQty=MarkedQty,blockedqty=0 where num=@ct  
end  
else  
begin  
if(@netamonut_mul<=0.00)  
begin  
set @blockqty_mul=@qty_mul  
set @releaseQty_mul=@qty_mul-@blockqty_mul  
--set @netamonut_mul=@V_AHC_mul+@netamonut_mul  
update #partial_party set blockedqty =@blockqty_mul  where num=@ct  
update #partial_party set ReleasedQty=MarkedQty-blockedqty where num=@ct  
update #partial_party set net_Afetr_Adjust=@netamonut_mul+@V_AHC_mul  where num=@ct  
end  
else  
update #partial_party set ReleasedQty=MarkedQty,blockedqty=0 where num=@ct  
end  
update #multiplePartial1 set blockedqty=B.blockedqty,ReleasedQty=B.ReleasedQty,net_Afetr_Adjust=b.net_Afetr_Adjust from    
  (    
  select scrip,party_code,isin,approved,ReleasedQty,blockedqty,net_Afetr_Adjust from #partial_party where party_code=@Muti_pcode    
  )b where #multiplePartial1.scrip=b.scrip and #multiplePartial1.party_code=b.party_code and #multiplePartial1.isin=b.isin    
  
set @ct=@ct+1  
  
end  
set @PartialMulti_count=@PartialMulti_count+1  
drop table #partial_party  
end  
  
--alter table #final_code add net_Afetr_Adjust money  
  
--update #final_code set net_Afetr_Adjust=b.net_Afetr_Adjust,blockqty=B.blockqty, ReleaseQty=B.ReleaseQty from  
-- (  
-- select scrip,party_code,isin,approved,ReleaseQty,BLOCKQTy,net_Afetr_Adjust from #multiplePartial1  
-- )b where ltrim(rtrim(#final_code.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_code.isin))=ltrim(rtrim(b.isin))  
-- and ltrim(rtrim(#final_code.scrip))=ltrim(rtrim(b.scrip))  
  
  
update #final_Code set Seq_approve_status=case when b.MarkedQty=b.ReleasedQty then 'Released'  
  when b.MarkedQty=b.BlockedQty then 'Blocked'  
  when  b.MarkedQty>b.ReleasedQty  and b.BlockedQty<>0 and b.ReleasedQty<>0 then 'Partially Released' end  
   ,ReleasedQty=b.ReleasedQty,BlockedQty=b.BlockedQty from  
(  
select Angel_Scrip,scrip,party_code,isin,approved,Seq_approve_status,BlockedQty,ReleasedQty,MarkedQty from  #multiplePartial1  
)b where ltrim(rtrim(#final_Code.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_Code.isin))=ltrim(rtrim(b.isin))  
and ltrim(rtrim(#final_Code.scrip))=ltrim(rtrim(b.scrip)) and #final_Code.MarkedQty=b.MarkedQty  
*/  
--select * from #final_Code  
select rate=value_AHC/Markedqty ,* into #ss from #final_Code where Seq_approve_status='Partially Released'  
  
select rate*releasedqty as adjfromNCMS,* into #adjust_NCMS from #ss  
  
insert into  #adjust_NCMS  
select value_Ahc  as  adjfromNCMS,MTM_Price as rate, * from  #final_Code where Seq_approve_status= 'Released'  
  
   
 insert into NCMS_unpleadge_adjust_hist  
 select *,getdate() from NCMS_unpleadge_adjust  
  
truncate table NCMS_unpleadge_adjust  
  
  
insert into NCMS_unpleadge_adjust  
select * from #adjust_NCMS  
  
  
 --update #final_Code set MarkedQty=case when  Seq_approve_status='Partially Released' then ReleasedQty else MarkedQty end  
 -- where Seq_approve_status='Partially Released'  
  
/*************Added on 18 May 2023 by Neha***********************************************************/  
 insert into tbl_Unpleadge_partial_req  
 select *,CONVERT(datetime,getdate()) UpdateOn   from #final_Code   where Seq_approve_status='Partially Released'  
  
  update   #final_Code set Seq_approve_status='Blocked',ReleasedQty=0,blockedqty=MarkedQty  
  where Seq_approve_status='Partially Released'  
/************************************************************************/  
  
update tbl_unpledge_Request set [status]=case when b.Seq_approve_status='Released' then 204  
 when b.Seq_approve_status='Partially Released' then 204  
  when b.Seq_approve_status='Blocked' then 206  
  else [status] end,  
  MarkedQty=case when  b.Seq_approve_status='Partially Released' then ReleasedQty else MarkedQty end from  
(select party_code,ISIN,req_refno,Seq_approve_status,ReleasedQty from #final_Code)b  
where tbl_unpledge_Request.ISIN=b.isin and tbl_unpledge_Request.party_code=b.party_code and tbl_unpledge_Request.req_refno=b.req_refno  
  
  
update a set [status]=case when b.Seq_approve_status='Released' then 204  
 when b.Seq_approve_status='Partially Released' then 204  
  when b.Seq_approve_status='Blocked' then 206  
  else [status] end,  
  MarkedQty=case when  b.Seq_approve_status='Partially Released' then ReleasedQty else MarkedQty end  
  from tbl_unpledge_Request_testing a,  
(select party_code,ISIN,req_refno,Seq_approve_status,ReleasedQty from #final_Code)b  
where a.ISIN=b.isin and a.party_code=b.party_code  
and a.req_refno=b.req_refno  
/*  
insert into  tbl_Unpledge_Final_hist  
select *,GETDATE() from tbl_Unpledge_Final  
*/  
  
  
insert into  tbl_Unpledge_Final_hist(Srno,scrip,series,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,  
Value_AHC,netpayable,MarginAmt,  
Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NET,  
approved,Priority_scripwise,Priority_Valuewise,Req_refno,Seq_approve_status,PRIORITY_ALL,cl_type,ReleasedQty,BlockedQty,updatedOn)  
select Srno,scrip,series,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,Value_AHC,  
netpayable,MarginAmt,  
Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NET,  
approved,Priority_scripwise,Priority_Valuewise,Req_refno,Seq_approve_status,PRIORITY_ALL,cl_type,ReleasedQty,BlockedQty  
,GETDATE() from tbl_Unpledge_Final  
  
truncate table tbl_Unpledge_Final  
  
insert into tbl_Unpledge_Final(Srno,scrip,series,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,  
Value_AHC,netpayable,marginamt,  
Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NET,  
approved,Priority_scripwise,Priority_Valuewise,Req_refno,Seq_approve_status,PRIORITY_ALL,cl_type,ReleasedQty,BlockedQty)  
select Srno,scrip,series,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,Value_AHC,netpayable,MarginAmt,  
Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NET,approved,  
Priority_scripwise,Priority_Valuewise,Req_refno,Seq_approve_status,PRIORITY_ALL,cl_type,ReleasedQty,BlockedQty from #final_Code where Seq_approve_status is not null  
  
truncate table tbl_Unpledge_Final_heading    
    
insert into tbl_Unpledge_Final_heading    
select 'scrip','series','MarkedQty','party_code','ISIN','requestdate','MTM_Price','Priority_scrip','Angel_Scrip','Var_margin','Value_BHC','Value_AHC','netpayable','marginamt','Balance','UnsettledCrBill','UnrecoAmt','ShortSellValue','Deposit','CashColl','N
onCashColl','MarginAdjWithColl','MarginShortage','AccruedCharges','OtherDebit','NET','approved','Priority_scripwise','Priority_Valuewise','Req_refno','Seq_approve_status','PRIORITY_ALL','cl_type','ReleasedQty','BlockedQty'  
  
insert into tbl_Unpledge_Final_heading    
select scrip,series,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,  
Value_AHC,netpayable,marginamt,  
Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NET,  
approved,Priority_scripwise,Priority_Valuewise,Req_refno,Seq_approve_status,PRIORITY_ALL,cl_type,ReleasedQty,BlockedQty    
from tbl_Unpledge_Final    
  
  
 DECLARE @s VARCHAR(MAX) = ''                                          
   /*declare @FileName as varchar(100) = 'LD_File'+replace(CONVERT(char(10),getdate(),103),'/','-')+'.csv'*/      
   declare @FileName as varchar(100) = 'Unpleadge'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                                                 
      declare @FilePath varchar(200) ='' /* '\\196.1.115.183\d$\upload\CMS_Test\'+@FileName  */                         
     -- select @FilePath='\\172.29.19.16\public\NehaN\'+@FileName     
     select @FilePath='\\196.1.115.183\cusa_mtf\'+@FileName              
                                       
      SET @s = 'exec  MASTER.dbo.xp_cmdshell ' + ''''                                           
      SET @s = @s + 'bcp "select * from [196.1.115.132].cms.dbo.tbl_Unpledge_Final_heading" queryout '+ @FilePath + ' -c -t, -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                                                    
             
      
       
             
      SET @s = @s + ''''              
      EXEC(@s)     
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Unpledge_Request_Process_30Jan2024
-- --------------------------------------------------
  
  
  
  
-- =============================================  
-- Author: <Neha Naiwar>  
-- Create date: <14 Aug 2020>  
-- Description: <Description>  
-- =============================================  
CREATE PROCEDURE [dbo].[USP_Unpledge_Request_Process_30Jan2024]  
AS  
BEGIN  
  
  
insert into tbl_unpledge_Request_hist  
select *,GETDATE() from tbl_unpledge_Request  --where status=201  
  
--Select Distinct foea_party_code,foea_position_date into #commoditycodes from angelcommodity.mcdx.dbo.foexerciseallocation with (Nolock)   
--where foea_position_date = (Select MAX(foea_position_date) as foea_position_date  
--from angelcommodity.mcdx.dbo.foexerciseallocation with(nolock) where foea_position_date >GETDATE()-10)  
  
select distinct scrip,MarkedQty,party_code,ISIN,requestdate,Status,Req_refno into #Sq_UnPleadge from tbl_unpledge_Request where status=201  
  
--insert into tbl_unpledge_Request_commodityCodes  
--select *,getdate() from  #Sq_UnPleadge where party_code in (select foea_party_code from #commoditycodes)  
  
--delete from #Sq_UnPleadge where party_code in (select foea_party_code from #commoditycodes)  
  
select a.*,convert(money,MTM_Price) as MTM_Price,c.[Angel scrip category] as Angel_Scrip,c.[ANGEL_VAR %] as Var_margin,c.series,CONVERT(MONEY, 0) as Value_BHC,  
CONVERT(MONEY, 0) as Value_AHC,  
convert(int,0) as Priority_scrip,convert(int,0) as Priority_scripwise,convert(int,0) as Priority_Valuewise,convert(varchar(20),'') as cl_type  
  into #unPleadge from #Sq_UnPleadge a join  
 [CSOKYC-6].GENERAL.DBO.Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/  
a.ISIN=b.security_isin join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.ISIN=c.[isin no]  
  
  
/*******************************************************/  
select distinct isin,nav_value into #inf from [172.31.16.75].ANGEL_WMS.dbo.dw_mst_bse_mf_scheme with(nolock) where nav_value is not null  
  
--select distinct [isin no],series,[Angel scrip category] into #MfSeries from  [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS with(nolock)  
--where series='MF'  
  
insert into #unPleadge  
select a.*,convert(money,nav_value) as MTM_Price,c.[Angel scrip category] as Angel_Scrip,10.00 as Var_margin,c.series,CONVERT(MONEY, 0) as Value_BHC,  
CONVERT(MONEY, 0) as Value_AHC,  
convert(int,0) as Priority_scrip,convert(int,0) as Priority_scripwise,convert(int,0) as Priority_Valuewise,convert(varchar(20),'') as cl_type  
  from #Sq_UnPleadge a  join  
 #inf  b with(nolock) on /*a.scrip =b.Security_Symbol and*/  
a.ISIN=b.isin  /*and a.scrip=b.scheme_name*/ join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.ISIN=c.[isin no]  
--and a.ISIN like 'INF%'  
and a.isin not in (select isin from #unPleadge)  
order by a.party_code  
/****************************************************/  
  
  
update #unPleadge set Value_BHC=MarkedQty*MTM_Price  
update #unPleadge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)  
  
select ROW_NUMBER() OVER ( ORDER BY a.party_code) AS Srno,a.scrip,a.series,a.MarkedQty,a.party_code,a.ISIN,a.requestdate,a.MTM_Price,a.Priority_scrip,a.Angel_Scrip,a.Var_margin,  
a.Value_BHC,a.Value_AHC,b.netpayable,b.MarginAmt,b.Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,  
MarginShortage,AccruedCharges,OtherDebit,CONVERT(MONEY, 0) as  NET,CONVERT(MONEY, 0) as  
approved,a.Priority_scripwise,a.Priority_Valuewise,Req_refno,a.cl_type  
into #final_Code from #unPleadge a left outer join UnPleadge_Segveridata_VW b with(nolock) on a.Party_code=b.Party_code  
  
alter table #final_Code add Seq_approve_status varchar(50)  
  
alter table #final_Code add ReleasedQty int  
alter table #final_Code add BlockedQty int  
  
/*update #final_Code set NET=netpayable where MarginAmt=0    
update #final_Code set NET=Balance+MarginAmt+NonCashColl where MarginAmt<0  
update #final_Code set NET=NET+UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges where MarginAmt<0  */  
update #final_Code set NET=Balance+MarginAmt+NonCashColl+UnsettledCrBill+UnrecoAmt+ShortSellValue+AccruedCharges    
  
update #final_Code set  cl_type =b.cl_type from  
(select party_code,cl_type from risk.dbo.client_details  with(nolock)) b where #final_Code.party_code=b.party_code and Seq_approve_status is null  
  
--select * from #final_Code where cl_type='nbf' and MarginAmt=0  
  
update #final_Code set   Seq_approve_status =  'Released' where cl_type='nbf' and MarginAmt=0  
  
update #final_Code set   Seq_approve_status =  'Blocked' where NET<0  and Seq_approve_status is null  
  
/*update #final_Code set   Seq_approve_status =  'Released' where NET>=0 and MarginAmt=0 and Seq_approve_status is null  
  
update #final_Code set   Seq_approve_status =  'Released' where NET>=0 and Seq_approve_status is null*/  
  
/********************************/  
  
--update  #final_Code set  Seq_approve_status='Released' where   MarginAmt=0  and NET>=-500 and NET<0  
--and Seq_approve_status is null  
  
  
--update  #final set  Seq_approve_status='Released' where   MarginAmt=0  and netpayable>=-500 and netpayable<0  
--and Seq_approve_status is null  
  
--/********************************/  
  
/*select * into #final from #final_Code  where  netpayable<0*/  
  
/********************************/  
/*  
update  #final_Code set  Seq_approve_status='Released' where   MarginAmt=0  and netpayable>=-500 and netpayable<0  
and Seq_approve_status is null  
  
update  #final set  Seq_approve_status='Released' where   MarginAmt=0  and netpayable>=-500 and netpayable<0  
and Seq_approve_status is null  
*/  
/********************************/  
  
/*select SUM(value_AHC) as  value_AHC,party_code,NetPayable into #ee from #final group by party_code,NetPayable*/  
select SUM(value_AHC) as  value_AHC,party_code,NET into #ee from #final_Code where Seq_approve_status is null group by party_code,NET  
  
Select * into #data from #ee where NET>=value_AHC  
  
  
update #final_Code set  Seq_approve_status = 'Released' from  
(select party_code from #data) b where #final_Code.party_code=b.party_code and Seq_approve_status is null  
  
--update #final set  Seq_approve_status = 'Blocked' from  
--(select party_code from #data) b where #final.party_code=b.party_code  and Seq_approve_status is null  
  
  
  
select ROW_NUMBER() OVER ( ORDER BY party_code) AS [SrNo],party_code into #single from #final_Code /*#final*/ where Seq_approve_status is null group by party_code having COUNT(1)=1  
  
  
  
update  #final_Code set  Seq_approve_status=case when NET>=value_AHC then 'Released'  
 when NET<=value_AHC then 'Blocked' end from  
(select party_code from #single) b where #final_Code.party_code=b.party_code and Seq_approve_status is null  
  
update  #final_Code set ReleasedQty=MarkedQty,BlockedQty=0 where Seq_approve_status='Released'  
update  #final_Code set ReleasedQty=0,BlockedQty=MarkedQty where Seq_approve_status='Blocked'  
  
  
select * into #final from #final_Code  where Seq_approve_status is null  
  
--select *,netpayable*0.5+MarginAmt as newNet from #final_Code where MarginAmt<0 and NetPayable>0  
--update #final set NetPayable=netpayable*0.5+MarginAmt where MarginAmt<0 and NetPayable>0 and Seq_approve_status is null  
  
--select *,MarginAmt+NetPayable as newNet from #final_Code where MarginAmt<0 and NetPayable<0  
--update #final set NetPayable=MarginAmt+NetPayable where MarginAmt<0 and NetPayable<0 and Seq_approve_status is null  
  
  
  
  
--update #final set NetPayable=NetPayable*-1 where NetPayable>0 and MarginAmt<0  
  
  
ALTER TABLE #final_Code ADD PRIORITY_ALL INT  
  
select ROW_NUMBER() OVER ( ORDER BY party_code) AS [SrNo],party_code  into #multiscrip_SameCli from  #final where Seq_approve_status is null group by party_code having COUNT(1)>1  
IF (select COUNT(1) from #multiscrip_SameCli) > 0                                              
BEGIN  
select ROW_NUMBER() OVER ( ORDER BY a.party_code) AS [SrNoID],                                              
a.*,CONVERT(int,0) as   priority_all    
into #NCMS_APPAMT_TEMP                                              
from #final a join #multiscrip_SameCli b                                            
on a.PARTY_CODE=b.party_code  
  
   Declare @MC_ctr as int , @pcode_count as int=0,@pcount as int=1, @MC_Totctr as int = 0,@pcode as varchar(10)='',@entityx as varchar(10)=''                                            
Declare @M_pcode as varchar(10)='',@M_ISIN as varchar(10)='',@po_allowed as money = 0  ,@value_AHC as money=0 ,@approved as money=0  ,@appforqty as money=0.00                                         
Declare @SRno as int =0  ,@net as money=0,@qty int,@rate money,@blockqty int,@netamonut money,@releaseQty int                                                   
  
select @pcode_count=COUNT(1)  from #multiscrip_SameCli  
  
while    @pcount<=   @pcode_count  
begin  
select @M_pcode=party_code from #multiscrip_SameCli where SrNo=@pcount  
--print convert(varchar(50),@pcount)+@M_pcode  
  
select @MC_Totctr=COUNT(1) from #NCMS_APPAMT_TEMP  where party_code=@M_pcode  
  
SELECT  
SrNoID,Srno,scrip,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Angel_Scrip,Var_margin,Value_BHC,Value_AHC,  
netpayable,approved,Seq_approve_status,Net,  
dense_rank () OVER ( ORDER BY Var_margin) Priority_scrip,    
--dense_rank () OVER ( ORDER BY Angel_Scrip) Priority_scripwise,  
case when Angel_Scrip='Bluechip' then 1  
    when Angel_Scrip='Good' then 2  
    when Angel_Scrip='Average' then 3  
    when Angel_Scrip='Poor' then 4 end Priority_scripwise,  
dense_rank () OVER ( ORDER BY value_AHC) Priority_Valuewise  
   into #unPleadge_code  
FROM #NCMS_APPAMT_TEMP where party_code=@M_pcode    --'C8716'  
  
update #NCMS_APPAMT_TEMP set Priority_scrip=b.Priority_scrip,Priority_scripwise=b.Priority_scripwise,Priority_Valuewise=b.Priority_Valuewise  from  
(select Priority_scrip,Angel_Scrip,Value_AHC,Priority_Valuewise,party_code,Var_margin,Priority_scripwise from #unPleadge_code) b where  
#NCMS_APPAMT_TEMP.party_code=b.party_code and  
#NCMS_APPAMT_TEMP.Var_margin=b.Var_margin and #NCMS_APPAMT_TEMP.Angel_Scrip=b.Angel_Scrip and  #NCMS_APPAMT_TEMP.Value_AHC=b.Value_AHC  
  
  
select  ROW_NUMBER() OVER ( ORDER BY party_code) AS Sr,SrNoID,Srno,scrip,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,Value_AHC,netpayable,approved,Priority_scripwise,Priority_Valuewise,Seq_approve_statu
s,Net,releasedQty,BlockedQty,  
priority_all=convert(varchar(10),Priority_scrip)+convert(varchar(10),Priority_scripwise)+convert(varchar(10),Priority_Valuewise)  
into #PARTY_wise from   #NCMS_APPAMT_TEMP where party_code=@M_pcode--'C8716'  
  
update #NCMS_APPAMT_TEMP set priority_all=b.priority_all  from  
(select Priority_scrip,Angel_Scrip,Value_AHC,Priority_Valuewise,party_code,Var_margin,Priority_scripwise,priority_all from #PARTY_wise) b where  
#NCMS_APPAMT_TEMP.party_code=b.party_code and  
#NCMS_APPAMT_TEMP.Var_margin=b.Var_margin and #NCMS_APPAMT_TEMP.Angel_Scrip=b.Angel_Scrip and  #NCMS_APPAMT_TEMP.Value_AHC=b.Value_AHC  
  
  
select ROW_NUMBER() OVER ( ORDER BY Priority_scrip desc) AS Sn, * into #PARTY from #PARTY_wise order by Priority_scrip/*priority_all*/ desc  
  
alter table #PARTY add cntnegative int  
  
set @MC_ctr=1  
---select @MC_Totctr=COUNT(1) from #NCMS_APPAMT_TEMP  where party_code=@M_pcode  
  
while @MC_ctr<=@MC_Totctr  
begin  
--insert into #partycode  
--select @MC_ctr,@M_pcode  
select @po_allowed=case when @MC_ctr=1 then (Net)-value_AHC else 0.00 end from #PARTY where Sn=@MC_ctr  
  
update #PARTY set approved=@po_allowed where Sn=@MC_ctr  
  
select @value_AHC=value_AHC,@qty=MarkedQty from #PARTY where Sn=@MC_ctr  
  
select @approved=isnull(approved,0) from #party where Sn=@MC_ctr-1  
  
select @net=Net from  #party where Sn=@MC_ctr  
/* if( @approved<@net*-1)  
 begin  
  print 'hi'*/  
  
update #PARTY set approved=case when @MC_ctr>1 then @approved-@value_AHC else approved end where Sn=@MC_ctr and sn>1 and @approved<=(Net)  
--update #PARTY set Seq_approve_status=case when  @MC_ctr=1 and Net*-1<approved*-1 then 'Blocked' else '' end  where Sn=@MC_ctr  
--update #PARTY set Seq_approve_status=case when  @MC_ctr=1 and Net*-1<@value_AHC then 'Blocked' else '' end  where Sn=@MC_ctr  
select @approved=approved,@value_AHC=value_AHC,@qty=MarkedQty from #PARTY where  Sn=@MC_ctr  
if(@approved>0)  
begin  
 update #PARTY set releasedqty=MarkedQty,blockedqty=0 where Sn=@MC_ctr  
end  
  
--if(@approved<0)  
--update #PARTY set cntnegative=@MC_ctr where Sn=@MC_ctr  
if(@approved<0)  
begin  
 select @appforqty=isnull(approved,0) from #party where Sn=@MC_ctr-1  
 print @appforqty  
 select @rate=@value_AHC/@qty  
 print @rate  
 select @releaseQty=floor(@appforqty/@rate)  
 print @MC_ctr  
 print @releaseQty  
 update #party set releasedQty=case when @releaseQty<0 then 0 else @releaseQty end where Sn=@MC_ctr  
 update #party set blockedqty=case when releasedQty=0 then MarkedQty else MarkedQty-releasedQty end where Sn=@MC_ctr  
   
end  
   
set @MC_ctr=@MC_ctr+1  
--update #PARTY set Seq_approve_status='Blocked' where cntnegative is  null  
end  
/*  
UPDATE #PARTY set Seq_approve_status=case when approved>0.00 then 'Blocked' else 'Released' end  where party_code=@M_pcode  
and isnull (Seq_approve_status,'')=''  
  
update #PARTY set releasedqty=MarkedQty, BlockedQty=0 where Seq_approve_status='Released'  
 update #PARTY set releasedqty=0, BlockedQty=MarkedQty where Seq_approve_status='Blocked'*/  
  
update #NCMS_APPAMT_TEMP set approved=b.approved,Seq_approve_status=case when b.MarkedQty=b.ReleasedQty then 'Released'  
  when b.MarkedQty=b.BlockedQty then 'Blocked'  
  when  b.MarkedQty>b.ReleasedQty  and b.BlockedQty<>0 and b.ReleasedQty<>0 then 'Partially Released' end,ReleasedQty=b.ReleasedQty,BlockedQty=b.BlockedQty from  
(  
select scrip,party_code,isin,approved,Seq_approve_status,ReleasedQty,MarkedQty,BlockedQty from #PARTY where party_code=@M_pcode  
)b where #NCMS_APPAMT_TEMP.scrip=b.scrip and #NCMS_APPAMT_TEMP.party_code=b.party_code and #NCMS_APPAMT_TEMP.isin=b.isin  
  
set @pcount=@pcount+1  
     
   DROP TABLE #unPleadge_code  
DROP TABLE #PARTY_wise  
DROP TABLE #PARTY  
end  
  
  
  update #final_Code set approved=b.approved,Seq_approve_status=B.Seq_approve_status,PRIORITY_ALL=B.PRIORITY_ALL,ReleasedQty=b.ReleasedQty,  
  BlockedQty=b.BlockedQty  
   from  
  (  
  select Angel_Scrip,scrip,party_code,isin,approved,Seq_approve_status,PRIORITY_ALL,ReleasedQty,MarkedQty,BlockedQty from #NCMS_APPAMT_TEMP  
  )b where ltrim(rtrim(#final_Code.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_Code.isin))=ltrim(rtrim(b.isin))  
  and ltrim(rtrim(#final_Code.scrip))=ltrim(rtrim(b.scrip))  
  
end  
--update  #final_Code set ReleasedQty=MarkedQty,BlockedQty=0 where Seq_approve_status='Released'  
--update  #final_Code set ReleasedQty=0,BlockedQty=MarkedQty where Seq_approve_status='Blocked'  
--drop table #SinglePt  
--drop table #singlePartial  
/*  
select  party_code into #SinglePt from #final_Code where Seq_approve_status='Blocked'  
 group by party_code having COUNT(1)=1*/  
  
select  ROW_NUMBER() OVER ( ORDER BY party_code) AS Sr,* into #singlePartial from  
#final_Code where Seq_approve_status='Blocked' and party_code in (select party_code from #single) and Value_AHC<>0  
  
--update #singlePartial set releasedqty=0,blockedqty=0  
  
declare @ctr int,@count int=0,@Partial_count int=1,@code varchar='',@V_AHC money,@qtyS int,@rateS money,@blockqtyS int,@netamonutS money,@releaseQtyS int  
select @count=COUNT(1)  from #singlePartial  
while    @Partial_count<=   @count  
begin  
select @code=party_code,@V_AHC=Value_AHC,@qtyS=MarkedQty,@netamonutS=Net from #singlePartial where Sr=@Partial_count  
select @rateS=@V_AHC/@qtyS  
select @releaseQtyS=Floor(@netamonutS/@rateS)  
select @blockqtyS=@qtyS-@releaseQtyS  
update #singlePartial set BlockedQty=@blockqtyS,ReleasedQty=@releaseQtyS where Sr=@Partial_count  
set @Partial_count=@Partial_count+1  
end  
  
update #singlePartial set BlockedQty=markedqty ,ReleasedQty=0 where ReleasedQty<0  
update #singlePartial set BlockedQty=markedqty ,ReleasedQty=0 where BlockedQty<0  
  
update #final_Code set Seq_approve_status=case when b.MarkedQty=b.ReleasedQty then 'Released'  
  when b.MarkedQty=b.BlockedQty then 'Blocked'  
  when  b.MarkedQty>b.ReleasedQty  and b.BlockedQty<>0 and b.ReleasedQty<>0 then 'Partially Released' end  
   ,ReleasedQty=b.ReleasedQty,BlockedQty=b.BlockedQty from  
(  
select Angel_Scrip,scrip,party_code,isin,approved,Seq_approve_status,BlockedQty,ReleasedQty,MarkedQty from #singlePartial  
)b where ltrim(rtrim(#final_Code.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_Code.isin))=ltrim(rtrim(b.isin))  
and ltrim(rtrim(#final_Code.scrip))=ltrim(rtrim(b.scrip)) and #final_Code.MarkedQty=b.MarkedQty  
  
/*  
select  ROW_NUMBER() OVER ( ORDER BY party_code) AS Sr,party_code into #multiplecodes from #final_Code where Seq_approve_status='Blocked'  
 --and party_code in (select party_code from #multiscrip_SameCli)  
 group by party_code having COUNT(1)>1  
  
select  ROW_NUMBER() OVER ( ORDER BY party_code) AS Sr,*,convert(money,0.00) as net_Afetr_Adjust into  
 #multiplePartial1 from  
#final_Code where  Seq_approve_status='Blocked' and party_code in (select party_code from #multiplecodes) and Value_AHC<>0  
  
declare @count_mlP int=0,@PartialMulti_count int=1,@Muti_pcode varchar(40)='',@ct as int,@Totctr int=0  
select @count_mlP=COUNT(1)  from #multiplePartial1  
while    @PartialMulti_count<=   @count_mlP  
begin  
--set @Muti_pcode='B98855'  
  
  select @Muti_pcode=party_code from #multiplecodes where Sr=@PartialMulti_count  
select ROW_NUMBER() OVER ( ORDER BY party_code) AS num,* into #partial_party from #multiplePartial1 where party_code=@Muti_pcode order by Var_margin  
     select @Totctr=COUNT(1) from #partial_party  where party_code=@Muti_pcode    
   
  
set @ct=1  
  
declare @codemul varchar(100)='',@V_AHC_mul money=0.00,@qty_mul int=0,@rate_mul money=0.00,@blockqty_mul int=0,@netamonut_mul money=0.00,  
        @releaseQty_mul int=0,@netpamain as money=0.00  
   while @ct<=@Totctr    
   begin    
select @codemul=party_code,@V_AHC_mul=Value_AHC,@qty_mul=MarkedQty,@netamonut_mul=Net,@netpamain=Net from #partial_party where num=@ct  
--print @codemul  
--print @V_AHC_mul  
--print @qty_mul  
print @netamonut_mul  
select @netamonut_mul=net_Afetr_Adjust from #partial_party where num=@ct-1  
print @V_AHC_mul  
print @netamonut_mul  
if(@V_AHC_mul>=@netamonut_mul*-1)  
begin  
print 'hi'  
if(@netamonut_mul<=0.00)  
begin  
print 'hello'  
set @rate_mul=@V_AHC_mul/@qty_mul  
--print @rate_mul  
set @blockqty_mul=CEILING(@netamonut_mul*-1/@rate_mul)  
print @blockqty_mul  
update #partial_party set blockedqty =case when @blockqty_mul>@qty_mul then @qty_mul else  @blockqty_mul end where num=@ct  
--select @releaseQty_mul=@qty_mul-@blockqty_mul  
update #partial_party set ReleasedQty=MarkedQty-blockedqty where num=@ct  
update #partial_party set net_Afetr_Adjust=@V_AHC_mul+@netamonut_mul  where num=@ct  
end  
else  
update #partial_party set ReleasedQty=MarkedQty,blockedqty=0 where num=@ct  
end  
else  
begin  
if(@netamonut_mul<=0.00)  
begin  
set @blockqty_mul=@qty_mul  
set @releaseQty_mul=@qty_mul-@blockqty_mul  
--set @netamonut_mul=@V_AHC_mul+@netamonut_mul  
update #partial_party set blockedqty =@blockqty_mul  where num=@ct  
update #partial_party set ReleasedQty=MarkedQty-blockedqty where num=@ct  
update #partial_party set net_Afetr_Adjust=@netamonut_mul+@V_AHC_mul  where num=@ct  
end  
else  
update #partial_party set ReleasedQty=MarkedQty,blockedqty=0 where num=@ct  
end  
update #multiplePartial1 set blockedqty=B.blockedqty,ReleasedQty=B.ReleasedQty,net_Afetr_Adjust=b.net_Afetr_Adjust from    
  (    
  select scrip,party_code,isin,approved,ReleasedQty,blockedqty,net_Afetr_Adjust from #partial_party where party_code=@Muti_pcode    
  )b where #multiplePartial1.scrip=b.scrip and #multiplePartial1.party_code=b.party_code and #multiplePartial1.isin=b.isin    
  
set @ct=@ct+1  
  
end  
set @PartialMulti_count=@PartialMulti_count+1  
drop table #partial_party  
end  
  
--alter table #final_code add net_Afetr_Adjust money  
  
--update #final_code set net_Afetr_Adjust=b.net_Afetr_Adjust,blockqty=B.blockqty, ReleaseQty=B.ReleaseQty from  
-- (  
-- select scrip,party_code,isin,approved,ReleaseQty,BLOCKQTy,net_Afetr_Adjust from #multiplePartial1  
-- )b where ltrim(rtrim(#final_code.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_code.isin))=ltrim(rtrim(b.isin))  
-- and ltrim(rtrim(#final_code.scrip))=ltrim(rtrim(b.scrip))  
  
  
update #final_Code set Seq_approve_status=case when b.MarkedQty=b.ReleasedQty then 'Released'  
  when b.MarkedQty=b.BlockedQty then 'Blocked'  
  when  b.MarkedQty>b.ReleasedQty  and b.BlockedQty<>0 and b.ReleasedQty<>0 then 'Partially Released' end  
   ,ReleasedQty=b.ReleasedQty,BlockedQty=b.BlockedQty from  
(  
select Angel_Scrip,scrip,party_code,isin,approved,Seq_approve_status,BlockedQty,ReleasedQty,MarkedQty from  #multiplePartial1  
)b where ltrim(rtrim(#final_Code.party_code))=ltrim(rtrim(b.party_code)) and ltrim(rtrim(#final_Code.isin))=ltrim(rtrim(b.isin))  
and ltrim(rtrim(#final_Code.scrip))=ltrim(rtrim(b.scrip)) and #final_Code.MarkedQty=b.MarkedQty  
*/  
--select * from #final_Code  
select rate=value_AHC/Markedqty ,* into #ss from #final_Code where Seq_approve_status='Partially Released'  
  
select rate*releasedqty as adjfromNCMS,* into #adjust_NCMS from #ss  
  
insert into  #adjust_NCMS  
select value_Ahc  as  adjfromNCMS,MTM_Price as rate, * from  #final_Code where Seq_approve_status= 'Released'  
  
   
 insert into NCMS_unpleadge_adjust_hist  
 select *,getdate() from NCMS_unpleadge_adjust  
  
truncate table NCMS_unpleadge_adjust  
  
  
insert into NCMS_unpleadge_adjust  
select * from #adjust_NCMS  
  
  
 --update #final_Code set MarkedQty=case when  Seq_approve_status='Partially Released' then ReleasedQty else MarkedQty end  
 -- where Seq_approve_status='Partially Released'  
  
/*************Added on 18 May 2023 by Neha***********************************************************/  
 insert into tbl_Unpleadge_partial_req  
 select *,CONVERT(datetime,getdate()) UpdateOn   from #final_Code   where Seq_approve_status='Partially Released'  
  
  update   #final_Code set Seq_approve_status='Blocked',ReleasedQty=0,blockedqty=MarkedQty  
  where Seq_approve_status='Partially Released'  
/************************************************************************/  
  
update tbl_unpledge_Request set [status]=case when b.Seq_approve_status='Released' then 204  
 when b.Seq_approve_status='Partially Released' then 204  
  when b.Seq_approve_status='Blocked' then 206  
  else [status] end,  
  MarkedQty=case when  b.Seq_approve_status='Partially Released' then ReleasedQty else MarkedQty end from  
(select party_code,ISIN,req_refno,Seq_approve_status,ReleasedQty from #final_Code)b  
where tbl_unpledge_Request.ISIN=b.isin and tbl_unpledge_Request.party_code=b.party_code and tbl_unpledge_Request.req_refno=b.req_refno  
  
  
update a set [status]=case when b.Seq_approve_status='Released' then 204  
 when b.Seq_approve_status='Partially Released' then 204  
  when b.Seq_approve_status='Blocked' then 206  
  else [status] end,  
  MarkedQty=case when  b.Seq_approve_status='Partially Released' then ReleasedQty else MarkedQty end  
  from tbl_unpledge_Request_testing a,  
(select party_code,ISIN,req_refno,Seq_approve_status,ReleasedQty from #final_Code)b  
where a.ISIN=b.isin and a.party_code=b.party_code  
and a.req_refno=b.req_refno  
/*  
insert into  tbl_Unpledge_Final_hist  
select *,GETDATE() from tbl_Unpledge_Final  
*/  
  
  
insert into unpleadge_Process_log(ProcessName,TableName,UpdatedOn)    
select 'unpleadge_Process','tbl_unpledge_Request',getdate()    
  
insert into  tbl_Unpledge_Final_hist(Srno,scrip,series,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,  
Value_AHC,netpayable,MarginAmt,  
Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NET,  
approved,Priority_scripwise,Priority_Valuewise,Req_refno,Seq_approve_status,PRIORITY_ALL,cl_type,ReleasedQty,BlockedQty,updatedOn)  
select Srno,scrip,series,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,Value_AHC,  
netpayable,MarginAmt,  
Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NET,  
approved,Priority_scripwise,Priority_Valuewise,Req_refno,Seq_approve_status,PRIORITY_ALL,cl_type,ReleasedQty,BlockedQty  
,GETDATE() from tbl_Unpledge_Final  
  
truncate table tbl_Unpledge_Final  
  
insert into tbl_Unpledge_Final(Srno,scrip,series,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,  
Value_AHC,netpayable,marginamt,  
Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NET,  
approved,Priority_scripwise,Priority_Valuewise,Req_refno,Seq_approve_status,PRIORITY_ALL,cl_type,ReleasedQty,BlockedQty)  
select Srno,scrip,series,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,Value_AHC,netpayable,MarginAmt,  
Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NET,approved,  
Priority_scripwise,Priority_Valuewise,Req_refno,Seq_approve_status,PRIORITY_ALL,cl_type,ReleasedQty,BlockedQty from #final_Code where Seq_approve_status is not null  
  
truncate table tbl_Unpledge_Final_heading    
    
insert into tbl_Unpledge_Final_heading    
select 'scrip','series','MarkedQty','party_code','ISIN','requestdate','MTM_Price','Priority_scrip','Angel_Scrip','Var_margin','Value_BHC','Value_AHC','netpayable','marginamt','Balance','UnsettledCrBill','UnrecoAmt','ShortSellValue','Deposit','CashColl','N
onCashColl','MarginAdjWithColl','MarginShortage','AccruedCharges','OtherDebit','NET','approved','Priority_scripwise','Priority_Valuewise','Req_refno','Seq_approve_status','PRIORITY_ALL','cl_type','ReleasedQty','BlockedQty'  
  
insert into tbl_Unpledge_Final_heading    
select scrip,series,MarkedQty,party_code,ISIN,requestdate,MTM_Price,Priority_scrip,Angel_Scrip,Var_margin,Value_BHC,  
Value_AHC,netpayable,marginamt,  
Balance,UnsettledCrBill,UnrecoAmt,ShortSellValue,Deposit,CashColl,NonCashColl,MarginAdjWithColl,MarginShortage,AccruedCharges,OtherDebit,NET,  
approved,Priority_scripwise,Priority_Valuewise,Req_refno,Seq_approve_status,PRIORITY_ALL,cl_type,ReleasedQty,BlockedQty    
from tbl_Unpledge_Final    
  
  
 DECLARE @s VARCHAR(MAX) = ''                                          
   /*declare @FileName as varchar(100) = 'LD_File'+replace(CONVERT(char(10),getdate(),103),'/','-')+'.csv'*/      
   declare @FileName as varchar(100) = 'Unpleadge'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                                                 
      declare @FilePath varchar(200) ='' /* '\\INHOUSELIVEAPP2-FS.angelone.in\d$\upload\CMS_Test\'+@FileName  */                         
     -- select @FilePath='\\172.29.19.16\public\NehaN\'+@FileName     
     select @FilePath='\\10.253.19.11\cusa_mtf\'+@FileName              
                                       
      SET @s = 'exec  MASTER.dbo.xp_cmdshell ' + ''''                                           
      SET @s = @s + 'bcp "select * from INTRANET.cms.dbo.tbl_Unpledge_Final_heading" queryout '+ @FilePath + ' -c -t, -SABVSNCMS.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                                               
                  
      
       
             
      SET @s = @s + ''''              
      EXEC(@s)     
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateAuditList
-- --------------------------------------------------
CREATE proc USP_UpdateAuditList  
(  
@ApTag as varchar(20),  
@AuditorID as varchar(200),  
@AuditorName as varchar(200),  
@startdate as varchar(50),
@AuditStatus as varchar(50)
)  
AS  
Begin  
  
update tbl_SBPlannedAuditMIS  
set AuditorID=@AuditorID,AuditorName=@AuditorName,AuditStartDate=convert(datetime,@startdate,103),
AuditStatus=@AuditStatus
where APTag=@ApTag  
  
End

GO

-- --------------------------------------------------
-- TABLE dbo.1 Sept Ledger vdt balance
-- --------------------------------------------------
CREATE TABLE [dbo].[1 Sept Ledger vdt balance]
(
    ["cltcode"] VARCHAR(50) NULL,
    ["closingBalance"] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.A98703
-- --------------------------------------------------
CREATE TABLE [dbo].[A98703]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AC Details
-- --------------------------------------------------
CREATE TABLE [dbo].[AC Details]
(
    [Account No] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Acc_master_Online_cli
-- --------------------------------------------------
CREATE TABLE [dbo].[Acc_master_Online_cli]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [Bank_name] VARCHAR(20) NULL,
    [AccNO] VARCHAR(20) NOT NULL,
    [flag] VARCHAR(1) NOT NULL,
    [defaultBank] INT NULL,
    [SelForOnline] INT NOT NULL,
    [payMode] VARCHAR(5) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.accrual_29Jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[accrual_29Jul2025]
(
    [Notional Cash] VARCHAR(50) NULL,
    [Column 1] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Angel_OptionPL
-- --------------------------------------------------
CREATE TABLE [dbo].[Angel_OptionPL]
(
    [sauda_date] DATETIME NULL,
    [branch_code] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Party_name] VARCHAR(55) NULL,
    [inst_type] VARCHAR(6) NULL,
    [symbol] VARCHAR(12) NULL,
    [option_type] VARCHAR(2) NULL,
    [expirydate] VARCHAR(11) NULL,
    [Strike_Price] MONEY NULL,
    [pqty] INT NULL,
    [prate] MONEY NULL,
    [pval] MONEY NULL,
    [sqty] INT NULL,
    [srate] MONEY NULL,
    [sval] MONEY NULL,
    [pl] MONEY NULL,
    [stat] VARCHAR(25) NULL,
    [cls_rate] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [PercMktGross] MONEY NULL,
    [TimeGap] INT NULL,
    [PriceVariation] MONEY NULL,
    [SellPriceVariation] MONEY NULL,
    [Min_Time] DATETIME NULL,
    [Max_Time] DATETIME NULL,
    [NOD30Days] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Angel_OptionPL_BKP_25NOV2024
-- --------------------------------------------------
CREATE TABLE [dbo].[Angel_OptionPL_BKP_25NOV2024]
(
    [sauda_date] DATETIME NULL,
    [branch_code] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Party_name] VARCHAR(55) NULL,
    [inst_type] VARCHAR(6) NULL,
    [symbol] VARCHAR(12) NULL,
    [option_type] VARCHAR(2) NULL,
    [expirydate] VARCHAR(11) NULL,
    [Strike_Price] MONEY NULL,
    [pqty] INT NULL,
    [prate] MONEY NULL,
    [pval] MONEY NULL,
    [sqty] INT NULL,
    [srate] MONEY NULL,
    [sval] MONEY NULL,
    [pl] MONEY NULL,
    [stat] VARCHAR(25) NULL,
    [cls_rate] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [PercMktGross] MONEY NULL,
    [TimeGap] INT NULL,
    [PriceVariation] MONEY NULL,
    [SellPriceVariation] MONEY NULL,
    [Min_Time] DATETIME NULL,
    [Max_Time] DATETIME NULL,
    [NOD30Days] INT NULL,
    [Time_Gap] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angelclient1_26Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[angelclient1_26Nov2025]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(100) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(MAX) NULL,
    [L_Address2] VARCHAR(MAX) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(MAX) NULL,
    [Res_Phone1] VARCHAR(MAX) NULL,
    [Res_Phone2] VARCHAR(MAX) NULL,
    [Off_Phone1] VARCHAR(MAX) NULL,
    [Off_Phone2] VARCHAR(MAX) NULL,
    [Email] VARCHAR(MAX) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] NUMERIC(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Ac_Type] VARCHAR(10) NULL,
    [Ac_Num] VARCHAR(MAX) NULL,
    [PrintF] VARCHAR(2) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] NUMERIC(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] VARCHAR(50) NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(MAX) NULL,
    [Mobilevalidatedby] VARCHAR(20) NULL,
    [MobilevalidatedOn] DATETIME NULL,
    [pan_gir_no] VARCHAR(MAX) NULL,
    [trader] VARCHAR(20) NOT NULL,
    [Ward_No] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Area] VARCHAR(10) NULL,
    [PerDay] MONEY NULL,
    [TradeDays] INT NULL,
    [ActiveFrom] DATETIME NULL,
    [InActiveFrom] DATETIME NULL,
    [ActiveFromEq] DATETIME NULL,
    [InactiveFromEq] DATETIME NULL,
    [ActiveFromComm] DATETIME NULL,
    [InactiveFromComm] DATETIME NULL,
    [CTActiveFrom] DATETIME NULL,
    [CTInactiveFrom] DATETIME NULL,
    [FirstTrade] DATETIME NULL,
    [LastTrade] DATETIME NULL,
    [FirstTradeComm] DATETIME NULL,
    [LastTradeComm] DATETIME NULL,
    [Clrating] VARCHAR(10) NULL,
    [AngelClRating] CHAR(10) NULL,
    [YearBrok] MONEY NULL,
    [Trend] CHAR(10) NULL,
    [RmDealer] VARCHAR(20) NULL,
    [CommDealer1] VARCHAR(20) NULL,
    [Commdealer2] VARCHAR(20) NULL,
    [Service] VARCHAR(10) NULL,
    [LastCommunication] DATETIME NULL,
    [ECN] VARCHAR(10) NULL,
    [B2C] CHAR(1) NULL,
    [FirstLedger] MONEY NULL,
    [FirstLedgerDate] DATETIME NULL,
    [EbrokingClient] CHAR(1) NULL,
    [NbFcClient] CHAR(1) NULL,
    [NbFcActivefrom] DATETIME NULL,
    [NbFcInactiveFrom] DATETIME NULL,
    [EbrokingTerminal] VARCHAR(20) NULL,
    [PastClient] VARCHAR(10) NULL,
    [ClientFlag] CHAR(1) NULL,
    [BlockSms] CHAR(1) NULL,
    [PureRisk] MONEY NOT NULL,
    [ProjectedRisk] MONEY NOT NULL,
    [PanInactiveFrom] DATETIME NULL,
    [BOBranch] VARCHAR(10) NULL,
    [Birthdate] VARCHAR(MAX) NULL,
    [Gender] VARCHAR(2) NULL,
    [TradingPlatform] VARCHAR(10) NULL,
    [ActiveFromCurr] DATETIME NULL,
    [InactiveFromCurr] DATETIME NULL,
    [FirstTradeCurr] DATETIME NULL,
    [LastTradeCurr] DATETIME NULL,
    [CurrencyDealer] VARCHAR(20) NULL,
    [ActiveFromMcxNcx] DATETIME NULL,
    [InActiveFromMcxNcx] DATETIME NULL,
    [FirstTradeMcxNcx] DATETIME NULL,
    [LastTradeMcxNcx] DATETIME NULL,
    [DPIDs] VARCHAR(200) NULL,
    [DPIDWithPOA] VARCHAR(100) NULL,
    [DPIDForPayout] VARCHAR(100) NULL,
    [IsActiveForEbrokingProduct] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.APP_16_26_WEB_CONFIG_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[APP_16_26_WEB_CONFIG_DATA]
(
    [DATA] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AUDIT_USER_CHECK
-- --------------------------------------------------
CREATE TABLE [dbo].[AUDIT_USER_CHECK]
(
    [USERNAME] VARCHAR(50) NULL,
    [PERSON_NAME] VARCHAR(100) NULL,
    [ACTIVE] VARCHAR(10) NULL,
    [STATUS] INT NULL,
    [LOGIN_INACTIVE_DATE] DATETIME NULL,
    [DARWIN_SEPERATION_DATE] DATETIME NULL,
    [REMARKS] VARCHAR(7) NOT NULL,
    [DIFF_IN_DAYS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.axis_15072025
-- --------------------------------------------------
CREATE TABLE [dbo].[axis_15072025]
(
    [POid] INT IDENTITY(1,1) NOT NULL,
    [RequestID] INT NULL,
    [VerifierID] INT NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [NetPayable] MONEY NULL,
    [SegApprovedAmt] MONEY NULL,
    [BOFF_gen] INT NULL,
    [BANK_gen] INT NULL,
    [ODIN_gen] INT NULL,
    [ProcessDateTime] DATETIME NULL,
    [BOFF_posted] INT NULL,
    [Paymode] VARCHAR(10) NULL,
    [Batchid] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_AngelHarmony_bak_26Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_AngelHarmony_bak_26Nov2025]
(
    [Emp_No] VARCHAR(20) NULL,
    [Sb_Tag] VARCHAR(15) NULL,
    [First_Name] VARCHAR(50) NULL,
    [Middle_Name] VARCHAR(50) NULL,
    [Last_Name] VARCHAR(50) NULL,
    [Emp_Name] VARCHAR(150) NULL,
    [Address1] VARCHAR(MAX) NULL,
    [Address2] VARCHAR(MAX) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Pincode] VARCHAR(20) NULL,
    [MobileNumber] VARCHAR(MAX) NULL,
    [EmailAdd] VARCHAR(MAX) NULL,
    [JoiningDate] DATETIME NULL,
    [Status] VARCHAR(1) NULL,
    [CTC] MONEY NULL,
    [Emp_pass] VARCHAR(25) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Landline_no] VARCHAR(30) NULL,
    [isAdmin] BIT NULL,
    [isDealer] BIT NULL,
    [isTurnover] BIT NULL,
    [isBrokerage] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_AngelHarmonyLog_26Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_AngelHarmonyLog_26Nov2025]
(
    [Emp_No] VARCHAR(20) NULL,
    [Sb_Tag] VARCHAR(15) NULL,
    [First_Name] VARCHAR(50) NULL,
    [Middle_Name] VARCHAR(50) NULL,
    [Last_Name] VARCHAR(50) NULL,
    [Emp_Name] VARCHAR(150) NULL,
    [Address1] VARCHAR(MAX) NULL,
    [Address2] VARCHAR(MAX) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Pincode] VARCHAR(20) NULL,
    [MobileNumber] VARCHAR(MAX) NULL,
    [EmailAdd] VARCHAR(MAX) NULL,
    [JoiningDate] DATETIME NULL,
    [Status] VARCHAR(1) NULL,
    [CTC] MONEY NULL,
    [Emp_pass] VARCHAR(25) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Landline_no] VARCHAR(MAX) NULL,
    [isAdmin] BIT NULL,
    [isDealer] BIT NULL,
    [isTurnover] BIT NULL,
    [isBrokerage] BIT NULL,
    [updatingdatetime] DATETIME NOT NULL,
    [remark] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Block Codes 21012025 _ BSEFO
-- --------------------------------------------------
CREATE TABLE [dbo].[Block Codes 21012025 _ BSEFO]
(
    [Client Code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BM97
-- --------------------------------------------------
CREATE TABLE [dbo].[BM97]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_CLIENT_PASSWORD
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_CLIENT_PASSWORD]
(
    [party_code] VARCHAR(30) NULL,
    [password] VARCHAR(25) NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [encruppswd] VARCHAR(25) NULL,
    [Source] VARCHAR(25) NULL,
    [GeneratedBy] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.brok_17Jun2025
-- --------------------------------------------------
CREATE TABLE [dbo].[brok_17Jun2025]
(
    [SegmentList] VARCHAR(11) NOT NULL,
    [enteredFlag] VARCHAR(1) NOT NULL,
    [Segment] VARCHAR(11) NOT NULL,
    [Exchange] VARCHAR(5) NOT NULL,
    [Table No ] INT NOT NULL,
    [Line No ] NUMERIC(10, 0) NOT NULL,
    [Upper Limit (Rs.)] NUMERIC(19, 4) NULL,
    [Val/Per ] VARCHAR(12) NULL,
    [Day Purchase] NUMERIC(36, 12) NULL,
    [Day Sales ] NUMERIC(36, 12) NULL,
    [Sett. Purchase] NUMERIC(36, 12) NULL,
    [Sett. Sales] NUMERIC(36, 12) NULL,
    [Delivery ] NUMERIC(36, 12) NULL,
    [Round To ] NUMERIC(12, 2) NULL,
    [Normal] NUMERIC(36, 12) NULL,
    [Slab Type ] VARCHAR(3) NULL,
    [party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Brok_Client_forMail
-- --------------------------------------------------
CREATE TABLE [dbo].[Brok_Client_forMail]
(
    [party_code] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Brok_Client_forMail_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[Brok_Client_forMail_hist]
(
    [party_Code] VARCHAR(100) NULL,
    [Filenames] VARCHAR(500) NULL,
    [updatedon] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.call_trade
-- --------------------------------------------------
CREATE TABLE [dbo].[call_trade]
(
    [cltcode] VARCHAR(20) NULL,
    [CNT_Amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.call_trade_all_21May2025
-- --------------------------------------------------
CREATE TABLE [dbo].[call_trade_all_21May2025]
(
    [CNT_DATE] DATETIME NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [GLCODE] VARCHAR(20) NULL,
    [GSTCODE] VARCHAR(50) NULL,
    [CHARGAMT] MONEY NULL,
    [GST_CHARGES] MONEY NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCH] VARCHAR(12) NULL,
    [PRODUCT] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(5) NOT NULL,
    [RUNTIME] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping_02Apr2024
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping_02Apr2024]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping_19Apr2024
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping_19Apr2024]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat_mapping_29feb2024
-- --------------------------------------------------
CREATE TABLE [dbo].[cat_mapping_29feb2024]
(
    [cat_code] INT NULL,
    [menu_code] INT NULL,
    [MappedBy] VARCHAR(50) NULL,
    [MappedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHANGE_NRI_CL_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[CHANGE_NRI_CL_MASTER]
(
    [Fld_SrNo] INT NULL,
    [Fld_ClientCode] VARCHAR(100) NULL,
    [Fld_BankId] INT NULL,
    [Final] VARCHAR(100) NULL,
    [Final_code] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cl_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[cl_bse]
(
    [Type] NVARCHAR(255) NULL,
    [Table_No] INT NULL,
    [Lower Lim] FLOAT NULL,
    [Upper Lim] FLOAT NULL,
    [Minimum] FLOAT NULL,
    [Val/Perc] NVARCHAR(255) NULL,
    [Trd#Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_details
-- --------------------------------------------------
CREATE TABLE [dbo].[client_details]
(
    [clientcode] VARCHAR(50) NULL,
    [dpid] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_poa_tbl
-- --------------------------------------------------
CREATE TABLE [dbo].[client_poa_tbl]
(
    [clientcode] VARCHAR(50) NULL,
    [POAflag] INT NULL,
    [DDPI_Flag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clients_block_12Dec2025
-- --------------------------------------------------
CREATE TABLE [dbo].[clients_block_12Dec2025]
(
    [PartyCode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.codelist
-- --------------------------------------------------
CREATE TABLE [dbo].[codelist]
(
    [code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ctcl_user_details_NXT_11_4_25
-- --------------------------------------------------
CREATE TABLE [dbo].[Ctcl_user_details_NXT_11_4_25]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [stIntSysRefNo] VARCHAR(50) NULL,
    [stSalute] VARCHAR(10) NULL,
    [stFirstName] VARCHAR(255) NULL,
    [stMiddleName] VARCHAR(255) NULL,
    [stLastName] VARCHAR(255) NULL,
    [stResiAddress1] VARCHAR(255) NULL,
    [stResiAddress2] VARCHAR(255) NULL,
    [stResiCity] VARCHAR(60) NULL,
    [stResiState] VARCHAR(60) NULL,
    [stResiPinCode] VARCHAR(10) NULL,
    [stContactNo] VARCHAR(25) NULL,
    [dealeraddressprooffile] IMAGE NULL,
    [dealeraddressprooffiletype] VARCHAR(255) NULL,
    [terminaladdressprooffile] IMAGE NULL,
    [terminaladdressprooffiletype] VARCHAR(255) NULL,
    [stEmail] VARCHAR(255) NULL,
    [dtDOB] DATETIME NULL,
    [dtValidityDate] DATETIME NULL,
    [certificatedetail] VARCHAR(255) NULL,
    [certificatebase] VARCHAR(255) NULL,
    [regno] VARCHAR(255) NULL,
    [imCertImage] IMAGE NULL,
    [stCertImgType] VARCHAR(255) NULL,
    [stCertBelongsTo] VARCHAR(255) NULL,
    [imUnderImg] IMAGE NULL,
    [stUnderType] VARCHAR(255) NULL,
    [stMAPINNo] VARCHAR(255) NULL,
    [stUserRelationshipWithTM] VARCHAR(255) NULL,
    [panno] VARCHAR(25) NULL,
    [imPanImage] IMAGE NULL,
    [stPanImgType] VARCHAR(255) NULL,
    [aadhaar_no] VARCHAR(25) NULL,
    [aadhaar_file] IMAGE NULL,
    [aadhaar_file_type] VARCHAR(255) NULL,
    [imDealerImg] IMAGE NULL,
    [stDealerImgType] VARCHAR(255) NULL,
    [imCPEUnderImg] IMAGE NULL,
    [stCPEUnderType] VARCHAR(255) NULL,
    [additionalfile] IMAGE NULL,
    [additionalfiletype] VARCHAR(255) NULL,
    [stCreatedBy] VARCHAR(255) NULL,
    [dtCreatedOn] DATETIME NULL,
    [stModifiedBy] VARCHAR(255) NULL,
    [dtModifiedOn] DATETIME NULL,
    [aadhaarname] VARCHAR(250) NULL,
    [stResiAddress3] VARCHAR(255) NULL,
    [RefID] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ctcl_user_details_NXT_18112024
-- --------------------------------------------------
CREATE TABLE [dbo].[Ctcl_user_details_NXT_18112024]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [stIntSysRefNo] VARCHAR(50) NULL,
    [stSalute] VARCHAR(10) NULL,
    [stFirstName] VARCHAR(255) NULL,
    [stMiddleName] VARCHAR(255) NULL,
    [stLastName] VARCHAR(255) NULL,
    [stResiAddress1] VARCHAR(255) NULL,
    [stResiAddress2] VARCHAR(255) NULL,
    [stResiCity] VARCHAR(60) NULL,
    [stResiState] VARCHAR(60) NULL,
    [stResiPinCode] VARCHAR(10) NULL,
    [stContactNo] VARCHAR(25) NULL,
    [dealeraddressprooffile] IMAGE NULL,
    [dealeraddressprooffiletype] VARCHAR(255) NULL,
    [terminaladdressprooffile] IMAGE NULL,
    [terminaladdressprooffiletype] VARCHAR(255) NULL,
    [stEmail] VARCHAR(255) NULL,
    [dtDOB] DATETIME NULL,
    [dtValidityDate] DATETIME NULL,
    [certificatedetail] VARCHAR(255) NULL,
    [certificatebase] VARCHAR(255) NULL,
    [regno] VARCHAR(255) NULL,
    [imCertImage] IMAGE NULL,
    [stCertImgType] VARCHAR(255) NULL,
    [stCertBelongsTo] VARCHAR(255) NULL,
    [imUnderImg] IMAGE NULL,
    [stUnderType] VARCHAR(255) NULL,
    [stMAPINNo] VARCHAR(255) NULL,
    [stUserRelationshipWithTM] VARCHAR(255) NULL,
    [panno] VARCHAR(25) NULL,
    [imPanImage] IMAGE NULL,
    [stPanImgType] VARCHAR(255) NULL,
    [aadhaar_no] VARCHAR(25) NULL,
    [aadhaar_file] IMAGE NULL,
    [aadhaar_file_type] VARCHAR(255) NULL,
    [imDealerImg] IMAGE NULL,
    [stDealerImgType] VARCHAR(255) NULL,
    [imCPEUnderImg] IMAGE NULL,
    [stCPEUnderType] VARCHAR(255) NULL,
    [additionalfile] IMAGE NULL,
    [additionalfiletype] VARCHAR(255) NULL,
    [stCreatedBy] VARCHAR(255) NULL,
    [dtCreatedOn] DATETIME NULL,
    [stModifiedBy] VARCHAR(255) NULL,
    [dtModifiedOn] DATETIME NULL,
    [aadhaarname] VARCHAR(250) NULL,
    [stResiAddress3] VARCHAR(255) NULL,
    [RefID] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cusa_03May2024
-- --------------------------------------------------
CREATE TABLE [dbo].[cusa_03May2024]
(
    [bcltdpid] VARCHAR(16) NULL,
    [party_code] VARCHAR(10) NULL,
    [isin] VARCHAR(16) NULL,
    [sett_no] VARCHAR(7) NULL,
    [MarkedQty] NUMERIC(38, 0) NULL,
    [MTM_Price] MONEY NOT NULL,
    [Angel_Scrip_cusa] VARCHAR(20) NULL,
    [Var_margin_cusa] NUMERIC(10, 2) NULL,
    [series] VARCHAR(15) NOT NULL,
    [Value_BHC_cusa] MONEY NULL,
    [Value_AHC] MONEY NULL,
    [approved] MONEY NULL,
    [Net] MONEY NULL,
    [BSEcode] VARCHAR(15) NOT NULL,
    [NSEsymbol] VARCHAR(15) NOT NULL,
    [Margin_pleadge_AHC] MONEY NULL,
    [Unsetteled_AHC] MONEY NULL,
    [HoldingPostHC] MONEY NULL,
    [Balance] MONEY NULL,
    [UnRecoCr] INT NULL,
    [ShortSellValue] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [LedgerBal] MONEY NULL,
    [margin] NUMERIC(38, 2) NULL,
    [Seq_approve_status] VARCHAR(50) NULL,
    [ReleasedQty] INT NULL,
    [BlockedQty] INT NULL,
    [Unsetteled_BHC] MONEY NOT NULL,
    [MTF_Available_Cash] MONEY NOT NULL,
    [Actual_Ledger_Bal] MONEY NOT NULL,
    [Flag] VARCHAR(4) NOT NULL,
    [ReleasedValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cusa_po_24Feb2025
-- --------------------------------------------------
CREATE TABLE [dbo].[cusa_po_24Feb2025]
(
    [bcltdpid] VARCHAR(16) NULL,
    [party_code] VARCHAR(10) NULL,
    [isin] VARCHAR(16) NULL,
    [sett_no] VARCHAR(7) NULL,
    [MarkedQty] NUMERIC(38, 0) NULL,
    [MTM_Price] MONEY NULL,
    [Angel_Scrip_cusa] VARCHAR(20) NULL,
    [Var_margin_cusa] NUMERIC(10, 2) NULL,
    [series] VARCHAR(15) NOT NULL,
    [Value_BHC_cusa] MONEY NULL,
    [Value_AHC] MONEY NULL,
    [approved] MONEY NULL,
    [Net] NUMERIC(38, 4) NULL,
    [BSEcode] VARCHAR(15) NOT NULL,
    [NSEsymbol] VARCHAR(15) NOT NULL,
    [Margin_pleadge_AHC] MONEY NULL,
    [Unsetteled_AHC] MONEY NULL,
    [HoldingPostHC] MONEY NULL,
    [Balance] NUMERIC(38, 4) NULL,
    [UnRecoCr] INT NULL,
    [ShortSellValue_Into_120%] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [LedgerBal] NUMERIC(38, 4) NULL,
    [margin] NUMERIC(38, 4) NULL,
    [Seq_approve_status] VARCHAR(50) NULL,
    [ReleasedQty] INT NULL,
    [BlockedQty] INT NULL,
    [Unsetteled_BHC] MONEY NULL,
    [MTF_Available_Cash] MONEY NULL,
    [Actual_Ledger_Bal] MONEY NULL,
    [squareoffqty] INT NULL,
    [Squareoffdate] DATETIME NULL,
    [Flag] VARCHAR(10) NULL,
    [ReleasedValue] MONEY NULL,
    [DeliveryCLT_Series] VARCHAR(3) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cusa_po_26Apr2024
-- --------------------------------------------------
CREATE TABLE [dbo].[cusa_po_26Apr2024]
(
    [bcltdpid] VARCHAR(16) NULL,
    [party_code] VARCHAR(10) NULL,
    [isin] VARCHAR(16) NULL,
    [sett_no] VARCHAR(7) NULL,
    [MarkedQty] NUMERIC(38, 0) NULL,
    [MTM_Price] MONEY NULL,
    [Angel_Scrip_cusa] VARCHAR(20) NULL,
    [Var_margin_cusa] NUMERIC(10, 2) NULL,
    [series] VARCHAR(15) NOT NULL,
    [Value_BHC_cusa] MONEY NULL,
    [Value_AHC] MONEY NULL,
    [approved] MONEY NULL,
    [Net] NUMERIC(38, 4) NULL,
    [BSEcode] VARCHAR(15) NOT NULL,
    [NSEsymbol] VARCHAR(15) NOT NULL,
    [Margin_pleadge_AHC] MONEY NULL,
    [Unsetteled_AHC] MONEY NULL,
    [HoldingPostHC] MONEY NULL,
    [Balance] NUMERIC(38, 4) NULL,
    [UnRecoCr] INT NULL,
    [ShortSellValue_Into_120%] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [LedgerBal] NUMERIC(38, 4) NULL,
    [margin] NUMERIC(38, 4) NULL,
    [Seq_approve_status] VARCHAR(50) NULL,
    [ReleasedQty] INT NULL,
    [BlockedQty] INT NULL,
    [Unsetteled_BHC] MONEY NULL,
    [MTF_Available_Cash] MONEY NULL,
    [Actual_Ledger_Bal] MONEY NULL,
    [squareoffqty] INT NULL,
    [Squareoffdate] DATETIME NULL,
    [Flag] VARCHAR(10) NULL,
    [ReleasedValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cusa_unsettQty_26Mau2025
-- --------------------------------------------------
CREATE TABLE [dbo].[cusa_unsettQty_26Mau2025]
(
    [partipantcode] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [i_isin] VARCHAR(12) NULL,
    [sett_no] VARCHAR(7) NOT NULL,
    [qty] NUMERIC(38, 0) NULL,
    [Flag] VARCHAR(2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.D11030
-- --------------------------------------------------
CREATE TABLE [dbo].[D11030]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Data_10082025
-- --------------------------------------------------
CREATE TABLE [dbo].[Data_10082025]
(
    [old_cl_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DCR101
-- --------------------------------------------------
CREATE TABLE [dbo].[DCR101]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] NVARCHAR(255) NULL,
    [Pldg Debit] NVARCHAR(255) NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.deactive_users
-- --------------------------------------------------
CREATE TABLE [dbo].[deactive_users]
(
    [emp_no] VARCHAR(20) NULL,
    [emp_name] VARCHAR(100) NULL,
    [hod_name] VARCHAR(100) NULL,
    [Div_name] VARCHAR(100) NULL,
    [join_date] DATETIME NULL,
    [Last_working_date] DATETIME NULL,
    [status] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELP988
-- --------------------------------------------------
CREATE TABLE [dbo].[DELP988]
(
    [TransDate] DATETIME NULL,
    [TransDate1] DATETIME NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.e5635b95-7a2d-4e59-8764-38facd028cbf
-- --------------------------------------------------
CREATE TABLE [dbo].[e5635b95-7a2d-4e59-8764-38facd028cbf]
(
    ["cltcode"] VARCHAR(50) NULL,
    ["closingBalance"] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking_BSETrade
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking_BSETrade]
(
    [ScripCd] VARCHAR(50) NULL,
    [ScripName] VARCHAR(100) NULL,
    [TradeNo] VARCHAR(30) NULL,
    [Rate] MONEY NULL,
    [Qty] INT NULL,
    [Dummy1] VARCHAR(50) NULL,
    [Dummy2] VARCHAR(50) NULL,
    [TradeTime] DATETIME NULL,
    [Sauda_Date] DATETIME NULL,
    [Dummy5] VARCHAR(20) NULL,
    [Buy_Sell] VARCHAR(10) NULL,
    [Dummy3] VARCHAR(50) NULL,
    [OrderNo] VARCHAR(20) NULL,
    [Pro_Client] VARCHAR(20) NULL,
    [Segement] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [party_code2] VARCHAR(20) NULL,
    [Dummy4] VARCHAR(50) NULL,
    [ISINNO] VARCHAR(20) NULL,
    [Series] VARCHAR(20) NULL,
    [SettNo] VARCHAR(50) NULL,
    [ProductType] VARCHAR(20) NULL,
    [TradeTime1] DATETIME NULL,
    [OrderTime] VARCHAR(50) NULL,
    [DealerID] VARCHAR(50) NULL,
    [Dummy6] VARCHAR(20) NULL,
    [FName] VARCHAR(50) NULL,
    [UploadDate] DATETIME NULL,
    [Mgr] VARCHAR(20) NULL,
    [Initiated_By] VARCHAR(50) NULL,
    [Modified_By] VARCHAR(50) NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking_MCXSXTrade
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking_MCXSXTrade]
(
    [TradeNo] VARCHAR(30) NULL,
    [Dummy1] VARCHAR(30) NULL,
    [Dummy2] VARCHAR(30) NULL,
    [InstType] VARCHAR(30) NULL,
    [Symbol] VARCHAR(30) NULL,
    [Expiry] DATETIME NULL,
    [Dummy3] VARCHAR(30) NULL,
    [Dummy4] VARCHAR(30) NULL,
    [Dummy5] VARCHAR(30) NULL,
    [Symbol1] VARCHAR(50) NULL,
    [Dummy6] VARCHAR(30) NULL,
    [OrderType1] VARCHAR(30) NULL,
    [Dummy7] VARCHAR(30) NULL,
    [DealerID] VARCHAR(30) NULL,
    [Dummy8] VARCHAR(30) NULL,
    [Buy_Sell] CHAR(1) NULL,
    [Qty] INT NULL,
    [Rate] MONEY NULL,
    [Dummy9] VARCHAR(30) NULL,
    [party_code] VARCHAR(30) NULL,
    [MemberID1] VARCHAR(30) NULL,
    [Dummy10] VARCHAR(30) NULL,
    [MemberID2] VARCHAR(30) NULL,
    [Dummy11] VARCHAR(30) NULL,
    [sauda_date] DATETIME NULL,
    [OrderDateTime] DATETIME NULL,
    [OrderNo] VARCHAR(30) NULL,
    [Dummy12] VARCHAR(30) NULL,
    [Dummy13] VARCHAR(50) NULL,
    [sauda_date1] DATETIME NULL,
    [Dummy14] VARCHAR(30) NULL,
    [Dummy15] VARCHAR(30) NULL,
    [Dummy16] VARCHAR(30) NULL,
    [Dummy23] VARCHAR(10) NULL,
    [ISV_Unique_No] VARCHAR(20) NULL,
    [Product_Month] VARCHAR(10) NULL,
    [OrderType2] VARCHAR(30) NULL,
    [Dummy17] VARCHAR(30) NULL,
    [Dummy18] VARCHAR(30) NULL,
    [Dummy19] VARCHAR(30) NULL,
    [Dummy20] VARCHAR(30) NULL,
    [Mgr] VARCHAR(20) NULL,
    [FName] VARCHAR(50) NULL,
    [UploadDate] DATETIME NULL,
    [Dummy21] VARCHAR(50) NULL,
    [Initiated_By] VARCHAR(50) NULL,
    [Modified_By] VARCHAR(50) NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking_MCXTrade
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking_MCXTrade]
(
    [TradeNo] VARCHAR(20) NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [InstType] VARCHAR(20) NULL,
    [Symbol] VARCHAR(50) NULL,
    [Expiry] DATETIME NULL,
    [Dummy3] VARCHAR(20) NULL,
    [Dummy4] VARCHAR(20) NULL,
    [Dummy5] VARCHAR(20) NULL,
    [ContractDescription] VARCHAR(50) NULL,
    [Dummy6] VARCHAR(20) NULL,
    [OrderType1] VARCHAR(30) NULL,
    [Dummy7] VARCHAR(20) NULL,
    [DealerID] VARCHAR(20) NULL,
    [Dummy8] VARCHAR(20) NULL,
    [Buy_Sell] CHAR(1) NULL,
    [Qty] INT NULL,
    [Rate] MONEY NULL,
    [Dummy9] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [Member_ID1] VARCHAR(20) NULL,
    [Dummy10] VARCHAR(20) NULL,
    [MemberID2] VARCHAR(20) NULL,
    [Dummy11] VARCHAR(20) NULL,
    [sauda_date] DATETIME NULL,
    [OrderDateTime] DATETIME NULL,
    [OrderNo] VARCHAR(20) NULL,
    [Dummy12] VARCHAR(20) NULL,
    [Dummy13] VARCHAR(50) NULL,
    [DateTime] DATETIME NULL,
    [Dummy14] VARCHAR(20) NULL,
    [Segement] VARCHAR(20) NULL,
    [Dummy15] VARCHAR(20) NULL,
    [Dummy16] VARCHAR(20) NULL,
    [Dummy17] VARCHAR(40) NULL,
    [Dummy18] VARCHAR(20) NULL,
    [OrderType2] VARCHAR(50) NULL,
    [Mgr] VARCHAR(20) NULL,
    [FName] VARCHAR(50) NULL,
    [UploadDate] DATETIME NULL,
    [Product_Type] VARCHAR(50) NULL,
    [Segement1] VARCHAR(50) NULL,
    [DealerID1] VARCHAR(50) NULL,
    [Dummy19] VARCHAR(50) NULL,
    [Initiated_By] VARCHAR(50) NULL,
    [Modified_By] VARCHAR(50) NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking_mis_to
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking_mis_to]
(
    [Company] VARCHAR(10) NULL,
    [sauda_date] DATETIME NULL,
    [Dealer] VARCHAR(20) NULL,
    [Region] VARCHAR(50) NULL,
    [branch_cd] VARCHAR(20) NULL,
    [Sub_broker] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [party_name] VARCHAR(100) NULL,
    [B2C] CHAR(1) NULL,
    [Ebrok_Cli] CHAR(1) NULL,
    [No_Of_trade] INT NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [Product] VARCHAR(20) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL,
    [ManagerIP] VARCHAR(20) NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking_NSDEXTrade
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking_NSDEXTrade]
(
    [TradeNo] VARCHAR(30) NULL,
    [Dummy1] VARCHAR(30) NULL,
    [InstType] VARCHAR(30) NULL,
    [Symbol] VARCHAR(30) NULL,
    [Expiry] DATETIME NULL,
    [Dummy2] VARCHAR(30) NULL,
    [Dummy3] VARCHAR(30) NULL,
    [ContractDescription] VARCHAR(30) NULL,
    [Dummy4] VARCHAR(30) NULL,
    [OrderType1] VARCHAR(50) NULL,
    [Dummy5] VARCHAR(30) NULL,
    [DealerID] VARCHAR(20) NULL,
    [Dummy6] VARCHAR(30) NULL,
    [Buy_Sell] CHAR(1) NULL,
    [Qty] INT NULL,
    [Rate] MONEY NULL,
    [Dummy7] VARCHAR(30) NULL,
    [party_code] VARCHAR(30) NULL,
    [MemberID] VARCHAR(30) NULL,
    [Dummy8] VARCHAR(30) NULL,
    [Dummy9] VARCHAR(30) NULL,
    [sauda_date] DATETIME NULL,
    [OrderDateTime] DATETIME NULL,
    [OrderNo] VARCHAR(30) NULL,
    [Dummy10] VARCHAR(30) NULL,
    [Segement] VARCHAR(20) NULL,
    [Dummy11] VARCHAR(30) NULL,
    [Dummy12] VARCHAR(30) NULL,
    [Dummy13] VARCHAR(30) NULL,
    [OrderType2] VARCHAR(50) NULL,
    [Dummy14] VARCHAR(30) NULL,
    [Mgr] VARCHAR(20) NULL,
    [FName] VARCHAR(50) NULL,
    [UploadDate] DATETIME NULL,
    [Initiated_By] VARCHAR(50) NULL,
    [Modified_By] VARCHAR(50) NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking_NSEFOTrade
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking_NSEFOTrade]
(
    [TradeNo] VARCHAR(20) NULL,
    [Dummy1] VARCHAR(20) NULL,
    [InstType] VARCHAR(20) NULL,
    [Symbol] VARCHAR(20) NULL,
    [ExpiryDate] VARCHAR(20) NULL,
    [StrikePrice] VARCHAR(20) NULL,
    [OptionType] VARCHAR(20) NULL,
    [ContractDescription] VARCHAR(50) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [OrderType] VARCHAR(20) NULL,
    [Dummy3] VARCHAR(20) NULL,
    [DealerID] VARCHAR(20) NULL,
    [Dummy4] VARCHAR(20) NULL,
    [Buy_Sell] CHAR(1) NULL,
    [Qty] INT NULL,
    [Rate] MONEY NULL,
    [Dummy5] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [MemberID] VARCHAR(20) NULL,
    [Dummy6] VARCHAR(20) NULL,
    [Dummy7] VARCHAR(20) NULL,
    [sauda_date] DATETIME NULL,
    [OrderDateTime] DATETIME NULL,
    [OrderNo] VARCHAR(20) NULL,
    [Dummy8] VARCHAR(20) NULL,
    [InstrumentType] VARCHAR(20) NULL,
    [party_code2] VARCHAR(20) NULL,
    [party_code3] VARCHAR(20) NULL,
    [Dummy9] VARCHAR(20) NULL,
    [sauda_date1] DATETIME NULL,
    [OrderDateTime1] DATETIME NULL,
    [OrderType1] VARCHAR(20) NULL,
    [Mgr] VARCHAR(20) NULL,
    [FName] VARCHAR(50) NULL,
    [UploadDate] DATETIME NULL,
    [Initiated_By] VARCHAR(50) NULL,
    [Modified_By] VARCHAR(50) NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking_NSETrade
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking_NSETrade]
(
    [TradeNo] VARCHAR(20) NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Symbol] VARCHAR(20) NULL,
    [Series] VARCHAR(20) NULL,
    [ScripName] VARCHAR(50) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [Dummy3] VARCHAR(20) NULL,
    [Dummy5] VARCHAR(20) NULL,
    [DealerID] VARCHAR(20) NULL,
    [Dummy6] VARCHAR(20) NULL,
    [Buy_Sell] CHAR(1) NULL,
    [Qty] INT NULL,
    [Rate] MONEY NULL,
    [Dummy7] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [MemberID] VARCHAR(20) NULL,
    [MarketType] VARCHAR(20) NULL,
    [Dummy8] VARCHAR(20) NULL,
    [Dummy9] VARCHAR(20) NULL,
    [sauda_date] DATETIME NULL,
    [OrderDateTime] DATETIME NULL,
    [OrderNumber] VARCHAR(20) NULL,
    [Dummy10] VARCHAR(20) NULL,
    [Segement] VARCHAR(20) NULL,
    [party_code2] VARCHAR(20) NULL,
    [party_code3] VARCHAR(20) NULL,
    [Dummy11] VARCHAR(30) NULL,
    [ProductType] VARCHAR(20) NULL,
    [sauda_date1] DATETIME NULL,
    [OrderTime] DATETIME NULL,
    [Mgr] VARCHAR(20) NULL,
    [FName] VARCHAR(50) NULL,
    [UploadDate] DATETIME NULL,
    [Initiated_By] VARCHAR(50) NULL,
    [Modified_By] VARCHAR(50) NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking_NSXTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking_NSXTRADE]
(
    [TRADENO] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [INSTTYPE] VARCHAR(50) NULL,
    [SYMBOL1] VARCHAR(50) NULL,
    [EXPIRY] DATETIME NULL,
    [STRIKEPRICE] VARCHAR(50) NULL,
    [OPTIONTYPE] VARCHAR(50) NULL,
    [SYMBOL2] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [ORDERTYPE] VARCHAR(50) NULL,
    [DUMMY3] VARCHAR(50) NULL,
    [Clientdealercode] VARCHAR(50) NULL,
    [DUMMY4] VARCHAR(50) NULL,
    [buy_sell] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [RATE] MONEY NULL,
    [dummy8] VARCHAR(50) NULL,
    [PARTY_CODE] VARCHAR(50) NULL,
    [MEMBERID1] VARCHAR(50) NULL,
    [DUMMY5] VARCHAR(50) NULL,
    [DUMMY6] VARCHAR(50) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [MEMBERID2] DATETIME NULL,
    [ORDERNO] VARCHAR(50) NULL,
    [ORDERNUMBER] VARCHAR(50) NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [CLIENTCODE1] VARCHAR(50) NULL,
    [CLIENTCODE2] VARCHAR(50) NULL,
    [DUMMY7] VARCHAR(50) NULL,
    [TRADEDATE2] DATETIME NULL,
    [MODIFIED_DATE] DATETIME NULL,
    [DUMMY9] VARCHAR(MAX) NULL,
    [ORDERINITIATEDFORM] VARCHAR(MAX) NULL,
    [ORDERMODIFIEDFROM] VARCHAR(MAX) NULL,
    [fname] VARCHAR(MAX) NULL,
    [MGR] VARCHAR(MAX) NULL,
    [uploaddate] DATETIME NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Employees
-- --------------------------------------------------
CREATE TABLE [dbo].[Employees]
(
    [EmployeeID] INT NOT NULL,
    [FirstName] NVARCHAR(50) NULL,
    [LastName] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exclude_cat_mapping_BKP_19_jan_2026
-- --------------------------------------------------
CREATE TABLE [dbo].[exclude_cat_mapping_BKP_19_jan_2026]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXTRA_CAT_MAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[EXTRA_CAT_MAPPING]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXTRA_CAT_MAPPING_19Apr2024
-- --------------------------------------------------
CREATE TABLE [dbo].[EXTRA_CAT_MAPPING_19Apr2024]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXTRA_CAT_MAPPING_29feb2024
-- --------------------------------------------------
CREATE TABLE [dbo].[EXTRA_CAT_MAPPING_29feb2024]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXTRA_CAT_MAPPING_29feb2024_1785
-- --------------------------------------------------
CREATE TABLE [dbo].[EXTRA_CAT_MAPPING_29feb2024_1785]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.extra_cat_mapping_BKP_19_jan_2026
-- --------------------------------------------------
CREATE TABLE [dbo].[extra_cat_mapping_BKP_19_jan_2026]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXTRA_CAT_MAPPING_BKP19JAN2026
-- --------------------------------------------------
CREATE TABLE [dbo].[EXTRA_CAT_MAPPING_BKP19JAN2026]
(
    [EMP_NO] VARCHAR(20) NULL,
    [MENU_CODE] INT NOT NULL,
    [MAPPED_BY] VARCHAR(10) NULL,
    [MAPPED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FEF_JDemail
-- --------------------------------------------------
CREATE TABLE [dbo].[FEF_JDemail]
(
    [SenderEmailAddress] VARCHAR(500) NULL,
    [senton] DATETIME NULL,
    [guid] VARCHAR(500) NULL,
    [Name] VARCHAR(500) NULL,
    [City] VARCHAR(200) NULL,
    [Phone] VARCHAR(200) NULL,
    [Src] VARCHAR(10) NULL,
    [DNC] VARCHAR(10) NULL,
    [phone1] VARCHAR(15) NULL,
    [FEF_EnquiryNo] VARCHAR(10) NULL,
    [FEF_MemberNo] VARCHAR(10) NULL,
    [NoOfCalls] INT NULL,
    [EnquiryFor] VARCHAR(500) NULL,
    [Area] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FO_data_10Jun2024
-- --------------------------------------------------
CREATE TABLE [dbo].[FO_data_10Jun2024]
(
    [trade_no] INT NULL,
    [trade_type] VARCHAR(3) NULL,
    [inst_type] VARCHAR(50) NULL,
    [symbol] VARCHAR(50) NULL,
    [expiry_date] VARCHAR(20) NULL,
    [strike_price] MONEY NULL,
    [option_type] VARCHAR(25) NULL,
    [scrip_name] VARCHAR(50) NULL,
    [aa] VARCHAR(25) NULL,
    [lot_type] VARCHAR(25) NULL,
    [bb] VARCHAR(10) NULL,
    [user_id] VARCHAR(10) NULL,
    [location] VARCHAR(10) NULL,
    [buy_sell] INT NULL,
    [qty] INT NULL,
    [rate] MONEY NULL,
    [cl_type] VARCHAR(10) NULL,
    [party_code] VARCHAR(25) NULL,
    [broker_code] VARCHAR(25) NULL,
    [style] VARCHAR(10) NULL,
    [c_u] VARCHAR(10) NULL,
    [trade_date] SMALLDATETIME NULL,
    [order_date] SMALLDATETIME NULL,
    [order_no] VARCHAR(20) NULL,
    [broker_code_a] VARCHAR(10) NULL,
    [order_mod_date] SMALLDATETIME NULL,
    [ctclid] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FO_trad_codes_01Jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[FO_trad_codes_01Jan2025]
(
    [trade_no] INT NULL,
    [trade_type] VARCHAR(3) NULL,
    [inst_type] VARCHAR(50) NULL,
    [symbol] VARCHAR(50) NULL,
    [expiry_date] VARCHAR(20) NULL,
    [strike_price] MONEY NULL,
    [option_type] VARCHAR(25) NULL,
    [scrip_name] VARCHAR(50) NULL,
    [aa] VARCHAR(25) NULL,
    [lot_type] VARCHAR(25) NULL,
    [bb] VARCHAR(10) NULL,
    [user_id] VARCHAR(10) NULL,
    [location] VARCHAR(10) NULL,
    [buy_sell] INT NULL,
    [qty] INT NULL,
    [rate] MONEY NULL,
    [cl_type] VARCHAR(10) NULL,
    [party_code] VARCHAR(25) NULL,
    [broker_code] VARCHAR(25) NULL,
    [style] VARCHAR(10) NULL,
    [c_u] VARCHAR(10) NULL,
    [trade_date] SMALLDATETIME NULL,
    [order_date] SMALLDATETIME NULL,
    [order_no] VARCHAR(20) NULL,
    [broker_code_a] VARCHAR(10) NULL,
    [order_mod_date] SMALLDATETIME NULL,
    [ctclid] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.GRGN4507
-- --------------------------------------------------
CREATE TABLE [dbo].[GRGN4507]
(
    [TransDate] DATETIME NULL,
    [TransDate1] DATETIME NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.I162
-- --------------------------------------------------
CREATE TABLE [dbo].[I162]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] NVARCHAR(255) NULL,
    [Pldg Debit] NVARCHAR(255) NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.INGV_BankFile_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[INGV_BankFile_hist]
(
    [Updated_on] DATETIME NULL,
    [FileType] VARCHAR(10) NULL,
    [BatchNo] VARCHAR(10) NULL,
    [Flag] VARCHAR(10) NULL,
    [Srno] INT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [AccNum] VARCHAR(15) NULL,
    [Segment] VARCHAR(10) NULL,
    [FileContent] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.itrade_SMS_Mail_log
-- --------------------------------------------------
CREATE TABLE [dbo].[itrade_SMS_Mail_log]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [party_code] VARCHAR(20) NULL,
    [source] VARCHAR(20) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.J777
-- --------------------------------------------------
CREATE TABLE [dbo].[J777]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.K42004
-- --------------------------------------------------
CREATE TABLE [dbo].[K42004]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.K58843
-- --------------------------------------------------
CREATE TABLE [dbo].[K58843]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kunal
-- --------------------------------------------------
CREATE TABLE [dbo].[kunal]
(
    [id] INT NULL,
    [name] VARCHAR(50) NULL,
    [native] VARCHAR(100) NULL,
    [DOB] DATE NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kunal_new
-- --------------------------------------------------
CREATE TABLE [dbo].[kunal_new]
(
    [id] INT NULL,
    [name] VARCHAR(50) NULL,
    [native] VARCHAR(100) NULL,
    [DOB] DATE NULL,
    [age] INT NULL,
    [Gardian_name] VARCHAR(100) NULL,
    [Gender] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KycModificationRequests
-- --------------------------------------------------
CREATE TABLE [dbo].[KycModificationRequests]
(
    [modification_request_date] DATE NULL,
    [dp_id] VARCHAR(50) NULL,
    [client_code] VARCHAR(20) NULL,
    [app_number] VARCHAR(20) NULL,
    [mobile_changed] VARCHAR(3) NULL,
    [email_changed] VARCHAR(3) NULL,
    [address_changed] VARCHAR(3) NULL,
    [new_email] VARCHAR(100) NULL,
    [new_mobile] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Last Payout Date and Bank Details required
-- --------------------------------------------------
CREATE TABLE [dbo].[Last Payout Date and Bank Details required]
(
    [PartyCode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.log_Emp_Master_26Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[log_Emp_Master_26Nov2025]
(
    [Emp_No] VARCHAR(15) NOT NULL,
    [Sb_Tag] VARCHAR(15) NULL,
    [First_Name] VARCHAR(50) NULL,
    [Middle_Name] VARCHAR(50) NULL,
    [Last_Name] VARCHAR(50) NULL,
    [Emp_Name] VARCHAR(150) NULL,
    [Address1] VARCHAR(MAX) NULL,
    [Address2] VARCHAR(MAX) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Pincode] VARCHAR(20) NULL,
    [Mobile] VARCHAR(MAX) NULL,
    [Email] VARCHAR(MAX) NULL,
    [Dt_ActiveFrom] DATETIME NULL,
    [isSuspended] BIT NULL,
    [isTerminated] BIT NULL,
    [Salary] DECIMAL(18, 0) NULL,
    [User_ID] VARCHAR(25) NULL,
    [Password] VARCHAR(50) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Log_UpdationDate] DATETIME NULL,
    [LandLine] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.M88472
-- --------------------------------------------------
CREATE TABLE [dbo].[M88472]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] NVARCHAR(255) NULL,
    [Pldg Debit] NVARCHAR(255) NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL,
    [F40] NVARCHAR(255) NULL,
    [F41] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.M97935
-- --------------------------------------------------
CREATE TABLE [dbo].[M97935]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL,
    [F40] NVARCHAR(255) NULL,
    [F41] NVARCHAR(255) NULL,
    [F42] NVARCHAR(255) NULL,
    [F43] NVARCHAR(255) NULL,
    [F44] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MADR1085
-- --------------------------------------------------
CREATE TABLE [dbo].[MADR1085]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] NVARCHAR(255) NULL,
    [Pldg Debit] NVARCHAR(255) NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL,
    [F40] NVARCHAR(255) NULL,
    [F41] NVARCHAR(255) NULL,
    [F42] NVARCHAR(255) NULL,
    [F43] NVARCHAR(255) NULL,
    [F44] NVARCHAR(255) NULL,
    [F45] NVARCHAR(255) NULL,
    [F46] NVARCHAR(255) NULL,
    [F47] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MailAttachment
-- --------------------------------------------------
CREATE TABLE [dbo].[MailAttachment]
(
    [gc_parent_guid] UNIQUEIDENTIFIER NOT NULL,
    [gc_attach_number] INT NOT NULL,
    [GC_ATTACH_FILENAME] VARCHAR(100) NULL,
    [GC_ATTACH_LONG_FILENAME] VARCHAR(100) NULL,
    [GC_ATTACH_METHOD] INT NULL,
    [GC_ATTACH_MIME_TAG] VARCHAR(200) NULL,
    [GC_RENDERING_POSITION] INT NULL,
    [GC_ATTACH_CONTENT_LOCATION] VARCHAR(200) NULL,
    [GC_ATTACH_BINARY] IMAGE NULL,
    [GC_ATTACH_CONTENT_ID] VARCHAR(200) NULL,
    [GC_ATTACH_FULL_PATH_AND_NAME] VARCHAR(400) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MailListSbTag
-- --------------------------------------------------
CREATE TABLE [dbo].[MailListSbTag]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [SbTag] VARCHAR(255) NULL,
    [other_email] VARCHAR(255) NULL,
    [To_Email] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MAY052025
-- --------------------------------------------------
CREATE TABLE [dbo].[MAY052025]
(
    [username] VARCHAR(50) NULL,
    [Emp_name] VARCHAR(150) NULL,
    [Sub_department] VARCHAR(150) NULL,
    [Sr_Name] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_27mar2024
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_27mar2024]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_BKP_APR_3_2025
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_BKP_APR_3_2025]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item_bkp30092024
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item_bkp30092024]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.menu_item30092024
-- --------------------------------------------------
CREATE TABLE [dbo].[menu_item30092024]
(
    [menu_code] INT IDENTITY(1,1) NOT NULL,
    [Head] VARCHAR(100) NULL,
    [Sub_Head] VARCHAR(100) NULL,
    [menu_name] VARCHAR(100) NULL,
    [menu_url] VARCHAR(250) NULL,
    [seq_no] INT NULL,
    [active] VARCHAR(1) NULL,
    [menu_desc] VARCHAR(250) NULL,
    [Owner_name] VARCHAR(50) NULL,
    [developer_name] VARCHAR(50) NULL,
    [applicable_to] VARCHAR(400) NULL,
    [update_by] VARCHAR(50) NULL,
    [update_on] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_MCDX_ord_client_info
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_MCDX_ord_client_info]
(
    [zone] VARCHAR(20) NULL,
    [region] VARCHAR(10) NULL,
    [ctcl_id] VARCHAR(20) NULL,
    [dealer_id] VARCHAR(50) NULL,
    [sub_broker] VARCHAR(15) NULL,
    [party_code] VARCHAR(10) NULL,
    [location] VARCHAR(25) NULL,
    [orderno] VARCHAR(20) NULL,
    [OrderEntryDateTime] DATETIME NULL,
    [SaudaDate] DATETIME NULL,
    [Trade_no] VARCHAR(18) NULL,
    [Tradeqty] VARCHAR(15) NULL,
    [Price] VARCHAR(8) NULL,
    [brokapplied] VARCHAR(8) NULL,
    [instrument] VARCHAR(8) NULL,
    [T] VARCHAR(25) NULL,
    [B] VARCHAR(25) NULL,
    [Emp_cd] VARCHAR(25) NULL,
    [Branch] VARCHAR(20) NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_MCXSX_ord_client_info
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_MCXSX_ord_client_info]
(
    [zone] VARCHAR(20) NULL,
    [region] VARCHAR(10) NULL,
    [ctcl_id] VARCHAR(20) NULL,
    [dealer_id] VARCHAR(50) NULL,
    [sub_broker] VARCHAR(15) NULL,
    [party_code] VARCHAR(10) NULL,
    [location] VARCHAR(25) NULL,
    [orderno] VARCHAR(20) NULL,
    [OrderEntryDateTime] DATETIME NULL,
    [SaudaDate] DATETIME NULL,
    [Trade_no] VARCHAR(18) NULL,
    [Tradeqty] VARCHAR(15) NULL,
    [Price] VARCHAR(8) NULL,
    [brokapplied] VARCHAR(8) NULL,
    [instrument] VARCHAR(8) NULL,
    [T] VARCHAR(25) NULL,
    [B] VARCHAR(25) NULL,
    [Emp_cd] VARCHAR(25) NULL,
    [Branch] VARCHAR(20) NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_NCDX_ord_client_info
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_NCDX_ord_client_info]
(
    [zone] VARCHAR(20) NULL,
    [region] VARCHAR(10) NULL,
    [ctcl_id] VARCHAR(10) NULL,
    [dealer_id] VARCHAR(50) NULL,
    [sub_broker] VARCHAR(15) NULL,
    [party_code] VARCHAR(10) NULL,
    [location] VARCHAR(10) NULL,
    [orderno] VARCHAR(16) NULL,
    [OrderEntryDateTime] DATETIME NULL,
    [SaudaDate] DATETIME NULL,
    [Trade_no] VARCHAR(8) NULL,
    [Tradeqty] VARCHAR(8) NULL,
    [Price] VARCHAR(8) NULL,
    [brokapplied] VARCHAR(8) NULL,
    [instrument] VARCHAR(8) NULL,
    [T] VARCHAR(25) NULL,
    [B] VARCHAR(25) NULL,
    [Emp_cd] VARCHAR(15) NULL,
    [Branch] VARCHAR(20) NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_tbl_Ctcl_Diet_Alloted_new
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_tbl_Ctcl_Diet_Alloted_new]
(
    [PARTY_CODE] VARCHAR(12) NULL,
    [DEPOSIT] MONEY NULL,
    [Opt_deposit] MONEY NULL,
    [mcd_limit] MONEY NOT NULL,
    [updated_on] DATETIME NOT NULL,
    [BlockPurchase] VARCHAR(3) NULL,
    [MinimumLimit] VARCHAR(3) NULL,
    [UnRecoLimit] VARCHAR(3) NULL,
    [DepositeHolding] VARCHAR(3) NULL,
    [DPHold] MONEY NULL,
    [Remark] VARCHAR(100) NULL,
    [category] VARCHAR(5) NULL,
    [DefultMulti] MONEY NULL,
    [ArchivedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_TO_Khedbkp_2025
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_TO_Khedbkp_2025]
(
    [Company] VARCHAR(10) NULL,
    [sauda_date] DATETIME NULL,
    [Dealer] VARCHAR(20) NULL,
    [Region] VARCHAR(50) NULL,
    [branch_cd] VARCHAR(20) NULL,
    [Sub_broker] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [party_name] VARCHAR(100) NULL,
    [B2C] CHAR(1) NULL,
    [Ebrok_Cli] CHAR(1) NULL,
    [No_Of_trade] INT NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [Product] VARCHAR(50) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL,
    [ManagerIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_TObkp_2025
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_TObkp_2025]
(
    [Company] VARCHAR(10) NULL,
    [sauda_date] DATETIME NULL,
    [Dealer] VARCHAR(20) NULL,
    [Region] VARCHAR(50) NULL,
    [branch_cd] VARCHAR(20) NULL,
    [Sub_broker] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [party_name] VARCHAR(100) NULL,
    [B2C] CHAR(1) NULL,
    [Ebrok_Cli] CHAR(1) NULL,
    [No_Of_trade] INT NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [Product] VARCHAR(50) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL,
    [ManagerIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mismatch_ledger_balance_22Jul
-- --------------------------------------------------
CREATE TABLE [dbo].[mismatch_ledger_balance_22Jul]
(
    [exchange] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [client_code] VARCHAR(50) NULL,
    [balance_modernized] VARCHAR(50) NULL,
    [balance_backoffice] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mismatch_net_payable_22Jul
-- --------------------------------------------------
CREATE TABLE [dbo].[mismatch_net_payable_22Jul]
(
    [exchange] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [client_code] VARCHAR(50) NULL,
    [net_payable_modernized] VARCHAR(50) NULL,
    [net_payable_backoffice] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_AutoRelease_11Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_AutoRelease_11Aug2025]
(
    [BrokingLedger] MONEY NULL,
    [Value_AHC_UnsettNonMTF_Trade] MONEY NOT NULL,
    [Value_AHC_Cusa] MONEY NOT NULL,
    [Margin_Pledge_final_AHC] MONEY NOT NULL,
    [NetLedger] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(10) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(50) NULL,
    [partyname] VARCHAR(100) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [source] VARCHAR(2) NULL,
    [upd_date] DATETIME NULL,
    [AdjQty] FLOAT NULL,
    [BrokingLedgerAdWithAccrual] MONEY NULL,
    [Netl] MONEY NULL,
    [margin] MONEY NULL,
    [ShortSellValue_Into_120%] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [MTF_Available_Cash] MONEY NULL,
    [MFPendingOrder] MONEY NULL,
    [MarginShortfall] MONEY NULL,
    [PositionRate] MONEY NULL,
    [FinalNet] MONEY NULL,
    [ReleasedQty] INT NULL,
    [BlockedQty] INT NULL,
    [ReleasedValue] MONEY NULL,
    [MTf_Ledger] MONEY NULL,
    [CURR_CL_RATE] MONEY NULL,
    [margin_req] MONEY NULL,
    [MTMRelease] MONEY NULL,
    [MarginRelease] MONEY NULL,
    [finalRelease] MONEY NULL,
    [newReleasedQty] INT NULL,
    [TotalReleasedQty] INT NULL,
    [TotalReleaseValue] MONEY NULL,
    [Noncash] MONEY NULL,
    [Margin_New] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_AutoRelease_11Aug2025_12aug
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_AutoRelease_11Aug2025_12aug]
(
    [BrokingLedger] MONEY NULL,
    [Value_AHC_UnsettNonMTF_Trade] MONEY NOT NULL,
    [Value_AHC_Cusa] MONEY NOT NULL,
    [Margin_Pledge_final_AHC] MONEY NOT NULL,
    [NetLedger] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(10) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(50) NULL,
    [partyname] VARCHAR(100) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [source] VARCHAR(2) NULL,
    [upd_date] DATETIME NULL,
    [AdjQty] FLOAT NULL,
    [BrokingLedgerAdWithAccrual] MONEY NULL,
    [Netl] MONEY NULL,
    [margin] MONEY NULL,
    [ShortSellValue_Into_120%] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [MTF_Available_Cash] MONEY NULL,
    [MFPendingOrder] MONEY NULL,
    [MarginShortfall] MONEY NULL,
    [PositionRate] MONEY NULL,
    [FinalNet] MONEY NULL,
    [ReleasedQty] INT NULL,
    [BlockedQty] INT NULL,
    [ReleasedValue] MONEY NULL,
    [MTf_Ledger] MONEY NULL,
    [CURR_CL_RATE] MONEY NULL,
    [margin_req] MONEY NULL,
    [MTMRelease] MONEY NULL,
    [MarginRelease] MONEY NULL,
    [finalRelease] MONEY NULL,
    [newReleasedQty] INT NULL,
    [TotalReleasedQty] INT NULL,
    [TotalReleaseValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_AutoRelease_11Aug2025_14082025
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_AutoRelease_11Aug2025_14082025]
(
    [BrokingLedger] MONEY NULL,
    [Value_AHC_UnsettNonMTF_Trade] MONEY NOT NULL,
    [Value_AHC_Cusa] MONEY NOT NULL,
    [Margin_Pledge_final_AHC] MONEY NOT NULL,
    [NetLedger] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(10) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(50) NULL,
    [partyname] VARCHAR(100) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [source] VARCHAR(2) NULL,
    [upd_date] DATETIME NULL,
    [AdjQty] FLOAT NULL,
    [BrokingLedgerAdWithAccrual] MONEY NULL,
    [Netl] MONEY NULL,
    [margin] MONEY NULL,
    [ShortSellValue_Into_120%] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [MTF_Available_Cash] MONEY NULL,
    [MFPendingOrder] MONEY NULL,
    [MarginShortfall] MONEY NULL,
    [PositionRate] MONEY NULL,
    [FinalNet] MONEY NULL,
    [ReleasedQty] INT NULL,
    [BlockedQty] INT NULL,
    [ReleasedValue] MONEY NULL,
    [MTf_Ledger] MONEY NULL,
    [CURR_CL_RATE] MONEY NULL,
    [margin_req] MONEY NULL,
    [MTMRelease] MONEY NULL,
    [MarginRelease] MONEY NULL,
    [finalRelease] MONEY NULL,
    [newReleasedQty] INT NULL,
    [TotalReleasedQty] INT NULL,
    [TotalReleaseValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_autorelease_new
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_autorelease_new]
(
    [sauda_date] DATETIME NOT NULL,
    [party_code] VARCHAR(15) NOT NULL,
    [isin] VARCHAR(12) NOT NULL,
    [open_qty] INT NOT NULL,
    [net_amount] DECIMAL(16, 4) NOT NULL,
    [purchase_price] DECIMAL(16, 4) NOT NULL,
    [closing_price] DECIMAL(16, 4) NOT NULL,
    [haircut] DECIMAL(8, 4) NOT NULL,
    [released_date] DATETIME NOT NULL,
    [released_qty] INT NOT NULL,
    [released_amount] DECIMAL(16, 4) NOT NULL,
    [cash_margin_released] DECIMAL(16, 4) NOT NULL,
    [broking_ledger_used] DECIMAL(16, 4) NOT NULL,
    [last_updated] DATETIME NOT NULL,
    [is_file_generated] INT NOT NULL,
    [finalnet] MONEY NULL,
    [mtf_ledger] MONEY NULL,
    [total_release_amount] MONEY NULL,
    [net_payout] MONEY NULL,
    [is_unsettled] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_autorelease_new_10Aug2024
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_autorelease_new_10Aug2024]
(
    [sauda_date] DATETIME NOT NULL,
    [party_code] VARCHAR(15) NOT NULL,
    [isin] VARCHAR(12) NOT NULL,
    [open_qty] INT NOT NULL,
    [net_amount] DECIMAL(16, 4) NOT NULL,
    [purchase_price] DECIMAL(16, 4) NOT NULL,
    [closing_price] DECIMAL(16, 4) NOT NULL,
    [haircut] DECIMAL(8, 4) NOT NULL,
    [released_date] DATETIME NOT NULL,
    [released_qty] INT NOT NULL,
    [released_amount] DECIMAL(16, 4) NOT NULL,
    [cash_margin_released] DECIMAL(16, 4) NOT NULL,
    [broking_ledger_used] DECIMAL(16, 4) NOT NULL,
    [last_updated] DATETIME NOT NULL,
    [is_file_generated] INT NOT NULL,
    [finalnet] MONEY NULL,
    [mtf_ledger] MONEY NULL,
    [total_release_amount] MONEY NULL,
    [net_payout] MONEY NULL,
    [is_unsettled] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_autorelease_new_18Oct2024
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_autorelease_new_18Oct2024]
(
    [sauda_date] DATETIME NOT NULL,
    [party_code] VARCHAR(15) NOT NULL,
    [isin] VARCHAR(12) NOT NULL,
    [open_qty] INT NOT NULL,
    [net_amount] DECIMAL(16, 4) NOT NULL,
    [purchase_price] DECIMAL(16, 4) NOT NULL,
    [closing_price] DECIMAL(16, 4) NOT NULL,
    [haircut] DECIMAL(8, 4) NOT NULL,
    [released_date] DATETIME NOT NULL,
    [released_qty] INT NOT NULL,
    [released_amount] DECIMAL(16, 4) NOT NULL,
    [cash_margin_released] DECIMAL(16, 4) NOT NULL,
    [broking_ledger_used] DECIMAL(16, 4) NOT NULL,
    [last_updated] DATETIME NOT NULL,
    [is_file_generated] INT NOT NULL,
    [finalnet] MONEY NULL,
    [mtf_ledger] MONEY NULL,
    [total_release_amount] MONEY NULL,
    [net_payout] MONEY NULL,
    [is_unsettled] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_autorelease_new_27Dec2024
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_autorelease_new_27Dec2024]
(
    [sauda_date] DATETIME NOT NULL,
    [party_code] VARCHAR(15) NOT NULL,
    [isin] VARCHAR(12) NOT NULL,
    [open_qty] INT NOT NULL,
    [net_amount] DECIMAL(16, 4) NOT NULL,
    [purchase_price] DECIMAL(16, 4) NOT NULL,
    [closing_price] DECIMAL(16, 4) NOT NULL,
    [haircut] DECIMAL(8, 4) NOT NULL,
    [released_date] DATETIME NOT NULL,
    [released_qty] INT NOT NULL,
    [released_amount] DECIMAL(16, 4) NOT NULL,
    [cash_margin_released] DECIMAL(16, 4) NOT NULL,
    [broking_ledger_used] DECIMAL(16, 4) NOT NULL,
    [last_updated] DATETIME NOT NULL,
    [is_file_generated] INT NOT NULL,
    [finalnet] MONEY NULL,
    [mtf_ledger] MONEY NULL,
    [total_release_amount] MONEY NULL,
    [net_payout] MONEY NULL,
    [is_unsettled] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_autorelease_new_status
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_autorelease_new_status]
(
    [processdate] DATETIME NOT NULL,
    [recordcount] DECIMAL(16, 4) NOT NULL,
    [last_updated_at] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_autorelease_new_status_test
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_autorelease_new_status_test]
(
    [processdate] DATETIME NOT NULL,
    [recordcount] DECIMAL(16, 4) NOT NULL,
    [last_updated_at] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_autorelease_new_test
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_autorelease_new_test]
(
    [sauda_date] DATETIME NOT NULL,
    [party_code] VARCHAR(15) NOT NULL,
    [isin] VARCHAR(12) NOT NULL,
    [open_qty] INT NOT NULL,
    [net_amount] DECIMAL(16, 4) NOT NULL,
    [purchase_price] DECIMAL(16, 4) NOT NULL,
    [closing_price] DECIMAL(16, 4) NOT NULL,
    [haircut] DECIMAL(8, 4) NOT NULL,
    [released_date] DATETIME NOT NULL,
    [released_qty] INT NOT NULL,
    [released_amount] DECIMAL(16, 4) NOT NULL,
    [cash_margin_released] DECIMAL(16, 4) NOT NULL,
    [broking_ledger_used] DECIMAL(16, 4) NOT NULL,
    [last_updated] DATETIME NOT NULL,
    [is_file_generated] INT NOT NULL,
    [finalnet] MONEY NULL,
    [mtf_ledger] MONEY NULL,
    [total_release_amount] MONEY NULL,
    [net_payout] MONEY NULL,
    [is_unsettled] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_autorelease_positions_margin_test
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_autorelease_positions_margin_test]
(
    [sauda_date] DATETIME NOT NULL,
    [party_code] VARCHAR(15) NOT NULL,
    [isin] VARCHAR(12) NOT NULL,
    [open_qty] INT NOT NULL,
    [net_amount] DECIMAL(16, 4) NOT NULL,
    [purchase_price] DECIMAL(16, 4) NOT NULL,
    [closing_price] DECIMAL(16, 4) NOT NULL,
    [haircut] DECIMAL(8, 4) NOT NULL,
    [sett_no] VARCHAR(15) NOT NULL DEFAULT '999999',
    [sett_type] VARCHAR(4) NOT NULL DEFAULT '',
    [released_date] DATETIME NOT NULL,
    [released_qty] INT NOT NULL,
    [released_amount] DECIMAL(16, 4) NOT NULL,
    [margin_released] DECIMAL(16, 4) NOT NULL,
    [margin_used] DECIMAL(16, 4) NOT NULL,
    [broking_ledger_used] DECIMAL(16, 4) NOT NULL,
    [last_updated] DATETIME NOT NULL,
    [final_net] DECIMAL(16, 4) NOT NULL,
    [mtf_ledger] DECIMAL(16, 4) NOT NULL,
    [is_unsettled] VARCHAR(4) NOT NULL DEFAULT ''
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_client
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_client]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.N47712
-- --------------------------------------------------
CREATE TABLE [dbo].[N47712]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] NVARCHAR(255) NULL,
    [Pldg Debit] NVARCHAR(255) NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL,
    [F40] NVARCHAR(255) NULL,
    [F41] NVARCHAR(255) NULL,
    [F42] NVARCHAR(255) NULL,
    [F43] NVARCHAR(255) NULL,
    [F44] NVARCHAR(255) NULL,
    [F45] NVARCHAR(255) NULL,
    [F46] NVARCHAR(255) NULL,
    [F47] NVARCHAR(255) NULL,
    [F48] NVARCHAR(255) NULL,
    [F49] NVARCHAR(255) NULL,
    [F50] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.N49326
-- --------------------------------------------------
CREATE TABLE [dbo].[N49326]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] NVARCHAR(255) NULL,
    [Pldg Debit] NVARCHAR(255) NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL,
    [F40] NVARCHAR(255) NULL,
    [F41] NVARCHAR(255) NULL,
    [F42] NVARCHAR(255) NULL,
    [F43] NVARCHAR(255) NULL,
    [F44] NVARCHAR(255) NULL,
    [F45] NVARCHAR(255) NULL,
    [F46] NVARCHAR(255) NULL,
    [F47] NVARCHAR(255) NULL,
    [F48] NVARCHAR(255) NULL,
    [F49] NVARCHAR(255) NULL,
    [F50] NVARCHAR(255) NULL,
    [F51] NVARCHAR(255) NULL,
    [F52] NVARCHAR(255) NULL,
    [F53] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_AMXGM
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_AMXGM]
(
    [message] VARCHAR(50) NULL,
    [accesstoken] VARCHAR(MAX) NULL,
    [updatedOn] DATETIME NULL,
    [AccesstokenValue] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_AMXLogin
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_AMXLogin]
(
    [Userid] VARCHAR(100) NULL,
    [Pwd] VARCHAR(500) NULL,
    [message] VARCHAR(50) NULL,
    [accesstoken] VARCHAR(MAX) NULL,
    [updatedOn] DATETIME NULL,
    [AccesstokenValue] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_approvedaccno_09May2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_approvedaccno_09May2025]
(
    [pcode] VARCHAR(10) NULL,
    [IFSC] VARCHAR(20) NULL,
    [AccNo] VARCHAR(25) NULL,
    [Bankid] INT IDENTITY(1,1) NOT NULL,
    [FirstPOdt] DATETIME NULL,
    [remarks] VARCHAR(50) NULL,
    [RTGS_InwardDate] DATETIME NULL,
    [Flag_firstPO] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_approvedaccno_23042025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_approvedaccno_23042025]
(
    [pcode] VARCHAR(10) NULL,
    [IFSC] VARCHAR(20) NULL,
    [AccNo] VARCHAR(25) NULL,
    [Bankid] INT IDENTITY(1,1) NOT NULL,
    [FirstPOdt] DATETIME NULL,
    [remarks] VARCHAR(50) NULL,
    [RTGS_InwardDate] DATETIME NULL,
    [Flag_firstPO] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_approvedaccno_23Apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_approvedaccno_23Apr2025]
(
    [pcode] VARCHAR(10) NULL,
    [IFSC] VARCHAR(20) NULL,
    [AccNo] VARCHAR(25) NULL,
    [Bankid] INT IDENTITY(1,1) NOT NULL,
    [FirstPOdt] DATETIME NULL,
    [remarks] VARCHAR(50) NULL,
    [RTGS_InwardDate] DATETIME NULL,
    [Flag_firstPO] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_approvedaccno_24Feb2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_approvedaccno_24Feb2025]
(
    [pcode] VARCHAR(10) NULL,
    [IFSC] VARCHAR(20) NULL,
    [AccNo] VARCHAR(25) NULL,
    [Bankid] INT IDENTITY(1,1) NOT NULL,
    [FirstPOdt] DATETIME NULL,
    [remarks] VARCHAR(50) NULL,
    [RTGS_InwardDate] DATETIME NULL,
    [Flag_firstPO] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ncms_auto_range_23Dec2025
-- --------------------------------------------------
CREATE TABLE [dbo].[Ncms_auto_range_23Dec2025]
(
    [Client_code] VARCHAR(10) NULL,
    [share_payout] CHAR(1) NULL,
    [auto_funds_payout] CHAR(1) NULL,
    [from_date] DATETIME NULL,
    [to_date] DATETIME NULL,
    [updated_by] VARCHAR(10) NULL,
    [updtaed_on] DATETIME NULL,
    [BSECM] VARCHAR(1) NULL,
    [NSECM] VARCHAR(1) NULL,
    [NSEFO] VARCHAR(1) NULL,
    [MCX] VARCHAR(1) NULL,
    [NCDEX] VARCHAR(1) NULL,
    [NSECF] VARCHAR(1) NULL,
    [MCXCDS] VARCHAR(1) NULL,
    [BSEFO] VARCHAR(1) NULL,
    [FundsLowerLimit] MONEY NULL,
    [FundsUpperLimit] MONEY NULL,
    [BSEMFSS] VARCHAR(1) NULL,
    [NSEMFSS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_AutoPayout_BillToBill_05Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_AutoPayout_BillToBill_05Nov2025]
(
    [party_code] VARCHAR(100) NOT NULL,
    [Auto_Payout] VARCHAR(1) NULL,
    [From_date] DATETIME NULL,
    [To_date] DATETIME NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_AutoPayout_BillToBill_28Feb2024
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_AutoPayout_BillToBill_28Feb2024]
(
    [party_code] VARCHAR(100) NOT NULL,
    [Auto_Payout] VARCHAR(1) NULL,
    [From_date] DATETIME NULL,
    [To_date] DATETIME NULL,
    [UpdatedBy] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_AXISBank
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_AXISBank]
(
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL,
    [SegApprovedAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_AXISBank_log
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_AXISBank_log]
(
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [BatchNo] VARCHAR(4) NULL,
    [segment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_AXSIS_03Mar2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_AXSIS_03Mar2025]
(
    [VerifierId] INT NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [SegApprovedAmt] MONEY NULL,
    [Paymode] VARCHAR(10) NULL,
    [poid] VARCHAR(17) NULL,
    [Batchid] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_Bank_AXIS
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_Bank_AXIS]
(
    [Paymode] VARCHAR(20) NULL,
    [poid] VARCHAR(20) NULL,
    [SegApprovedAmt] MONEY NULL,
    [party_code] VARCHAR(50) NULL,
    [acno] VARCHAR(30) NULL,
    [IFSCCode] VARCHAR(50) NULL,
    [UpdateOn] DATETIME NULL,
    [segment] VARCHAR(10) NULL,
    [req_refno] VARCHAR(50) NULL,
    [VerifierId] INT NULL,
    [batchid] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_Bank_AXIS_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_Bank_AXIS_hist]
(
    [Paymode] VARCHAR(20) NULL,
    [poid] VARCHAR(20) NULL,
    [SegApprovedAmt] MONEY NULL,
    [party_code] VARCHAR(50) NULL,
    [acno] VARCHAR(30) NULL,
    [IFSCCode] VARCHAR(50) NULL,
    [UpdateOn] DATETIME NULL,
    [segment] VARCHAR(10) NULL,
    [req_refno] VARCHAR(50) NULL,
    [VerifierId] INT NULL,
    [batchid] VARCHAR(15) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_BANKfile_DetailData
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_BANKfile_DetailData]
(
    [Paymode] VARCHAR(20) NULL,
    [acno] VARCHAR(30) NULL,
    [bankname] VARCHAR(50) NULL,
    [poid] VARCHAR(20) NULL,
    [UpdateOn] DATETIME NULL,
    [SegApprovedAmt] MONEY NULL,
    [party_code] VARCHAR(50) NULL,
    [segment] VARCHAR(10) NULL,
    [req_refno] VARCHAR(50) NULL,
    [VerifierId] INT NULL,
    [batchid] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_BANKfile_DetailData_hdfc
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_BANKfile_DetailData_hdfc]
(
    [Paymode] VARCHAR(20) NULL,
    [acno] VARCHAR(30) NULL,
    [bankname] VARCHAR(50) NULL,
    [poid] VARCHAR(20) NULL,
    [UpdateOn] DATETIME NULL,
    [SegApprovedAmt] MONEY NULL,
    [party_code] VARCHAR(50) NULL,
    [segment] VARCHAR(10) NULL,
    [req_refno] VARCHAR(50) NULL,
    [VerifierId] INT NULL,
    [batchid] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_BankFileName_log
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_BankFileName_log]
(
    [Filenames] VARCHAR(500) NULL,
    [Segapprovedamt] MONEY NULL,
    [Bank] VARCHAR(100) NULL,
    [BatchId] VARCHAR(20) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_BankMaster_ForAllBnk
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_BankMaster_ForAllBnk]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Bank] VARCHAR(50) NULL,
    [IsSelected] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_batch_process
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_batch_process]
(
    [Srno] INT NOT NULL,
    [ProcedureName] VARCHAR(200) NULL,
    [Active_Status] INT NULL,
    [StartDate] DATETIME NULL,
    [EndDate] DATETIME NULL,
    [Flag] INT NULL,
    [spdesc] VARCHAR(200) NULL,
    [Errflag] VARCHAR(100) NULL,
    [section] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_batch_process_06May2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_batch_process_06May2025]
(
    [Srno] INT NOT NULL,
    [ProcedureName] VARCHAR(200) NULL,
    [Active_Status] INT NULL,
    [StartDate] DATETIME NULL,
    [EndDate] DATETIME NULL,
    [Flag] INT NULL,
    [spdesc] VARCHAR(200) NULL,
    [Errflag] VARCHAR(100) NULL,
    [section] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_batch_process_07Oct2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_batch_process_07Oct2025]
(
    [Srno] INT NOT NULL,
    [ProcedureName] VARCHAR(200) NULL,
    [Active_Status] INT NULL,
    [StartDate] DATETIME NULL,
    [EndDate] DATETIME NULL,
    [Flag] INT NULL,
    [spdesc] VARCHAR(200) NULL,
    [Errflag] VARCHAR(100) NULL,
    [section] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_batch_process_30Jun2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_batch_process_30Jun2025]
(
    [Srno] INT NOT NULL,
    [ProcedureName] VARCHAR(200) NULL,
    [Active_Status] INT NULL,
    [StartDate] DATETIME NULL,
    [EndDate] DATETIME NULL,
    [Flag] INT NULL,
    [spdesc] VARCHAR(200) NULL,
    [Errflag] VARCHAR(100) NULL,
    [section] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_Batch_process_ForRealTime_PO_06May2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_Batch_process_ForRealTime_PO_06May2025]
(
    [Srno] INT NOT NULL,
    [ProcedureName] VARCHAR(200) NULL,
    [Active_Status] INT NULL,
    [StartDate] DATETIME NULL,
    [EndDate] DATETIME NULL,
    [Flag] INT NULL,
    [spdesc] VARCHAR(200) NULL,
    [Errflag] VARCHAR(100) NULL,
    [section] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_batchId
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_batchId]
(
    [batchid] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_ClientDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_ClientDetails]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(20) NULL,
    [long_name] VARCHAR(100) NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [l_address1] VARCHAR(1000) NULL,
    [l_city] VARCHAR(100) NULL,
    [l_address2] VARCHAR(100) NULL,
    [l_state] VARCHAR(100) NULL,
    [l_address3] VARCHAR(100) NULL,
    [l_nation] VARCHAR(15) NULL,
    [l_zip] VARCHAR(10) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [ward_no] VARCHAR(50) NULL,
    [sebi_regn_no] VARCHAR(25) NULL,
    [res_phone1] VARCHAR(15) NULL,
    [res_phone2] VARCHAR(15) NULL,
    [off_phone1] VARCHAR(15) NULL,
    [off_phone2] VARCHAR(15) NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [fax] VARCHAR(15) NULL,
    [email] VARCHAR(50) NULL,
    [cl_type] VARCHAR(3) NOT NULL,
    [cl_status] VARCHAR(3) NOT NULL,
    [family] VARCHAR(1000) NULL,
    [region] VARCHAR(50) NULL,
    [area] VARCHAR(10) NULL,
    [p_address1] VARCHAR(100) NULL,
    [p_city] VARCHAR(50) NULL,
    [p_address2] VARCHAR(100) NULL,
    [p_state] VARCHAR(100) NULL,
    [p_address3] VARCHAR(100) NULL,
    [p_nation] VARCHAR(15) NULL,
    [p_zip] VARCHAR(10) NULL,
    [p_phone] VARCHAR(15) NULL,
    [addemailid] VARCHAR(230) NULL,
    [sex] CHAR(1) NULL,
    [dob] DATETIME NULL,
    [introducer] VARCHAR(30) NULL,
    [approver] VARCHAR(30) NULL,
    [interactmode] TINYINT NULL,
    [passport_no] VARCHAR(30) NULL,
    [passport_issued_at] VARCHAR(30) NULL,
    [passport_issued_on] DATETIME NULL,
    [passport_expires_on] DATETIME NULL,
    [licence_no] VARCHAR(30) NULL,
    [licence_issued_at] VARCHAR(30) NULL,
    [licence_issued_on] DATETIME NULL,
    [licence_expires_on] DATETIME NULL,
    [rat_card_no] VARCHAR(30) NULL,
    [rat_card_issued_at] VARCHAR(30) NULL,
    [rat_card_issued_on] DATETIME NULL,
    [votersid_no] VARCHAR(30) NULL,
    [votersid_issued_at] VARCHAR(30) NULL,
    [votersid_issued_on] DATETIME NULL,
    [it_return_yr] VARCHAR(30) NULL,
    [it_return_filed_on] DATETIME NULL,
    [regr_no] VARCHAR(50) NULL,
    [regr_at] VARCHAR(50) NULL,
    [regr_on] DATETIME NULL,
    [regr_authority] VARCHAR(50) NULL,
    [client_agreement_on] DATETIME NULL,
    [sett_mode] VARCHAR(50) NULL,
    [dealing_with_other_tm] VARCHAR(50) NULL,
    [other_ac_no] VARCHAR(50) NULL,
    [introducer_id] VARCHAR(50) NULL,
    [introducer_relation] VARCHAR(50) NULL,
    [repatriat_bank] NUMERIC(18, 0) NULL,
    [repatriat_bank_ac_no] VARCHAR(30) NULL,
    [chk_kyc_form] TINYINT NULL,
    [chk_corporate_deed] TINYINT NULL,
    [chk_bank_certificate] TINYINT NULL,
    [chk_annual_report] TINYINT NULL,
    [chk_networth_cert] TINYINT NULL,
    [chk_corp_dtls_recd] TINYINT NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [AC_Type] VARCHAR(10) NULL,
    [AC_Num] VARCHAR(20) NULL,
    [Depository1] VARCHAR(7) NULL,
    [DpId1] VARCHAR(16) NULL,
    [CltDpId1] VARCHAR(16) NULL,
    [Poa1] CHAR(1) NULL,
    [Depository2] VARCHAR(7) NULL,
    [DpId2] VARCHAR(16) NULL,
    [CltDpId2] VARCHAR(16) NULL,
    [Poa2] CHAR(1) NULL,
    [Depository3] VARCHAR(7) NULL,
    [DpId3] VARCHAR(16) NULL,
    [CltDpId3] VARCHAR(16) NULL,
    [Poa3] CHAR(1) NULL,
    [rel_mgr] VARCHAR(10) NULL,
    [c_group] VARCHAR(10) NULL,
    [sbu] VARCHAR(10) NULL,
    [Status] CHAR(1) NULL,
    [Imp_Status] TINYINT NULL,
    [ModifidedBy] VARCHAR(25) NULL,
    [ModifidedOn] DATETIME NULL,
    [Bank_id] NUMERIC(18, 0) NULL,
    [Mapin_id] VARCHAR(12) NULL,
    [UCC_Code] VARCHAR(12) NULL,
    [Micr_No] VARCHAR(10) NULL,
    [Director_name] VARCHAR(200) NULL,
    [paylocation] VARCHAR(20) NULL,
    [FMCode] VARCHAR(10) NULL,
    [BSE_LAST_DATE] DATETIME NULL,
    [NSE_LAST_DATE] DATETIME NULL,
    [FO_LAST_DATE] DATETIME NULL,
    [NCDX_LAST_DATE] DATETIME NULL,
    [MCDX_LAST_DATE] DATETIME NULL,
    [comb_LAST_DATE] DATETIME NULL,
    [bsecm] VARCHAR(1) NULL,
    [nsecm] VARCHAR(1) NULL,
    [nsefo] VARCHAR(1) NULL,
    [mcdx] VARCHAR(1) NULL,
    [ncdx] VARCHAR(1) NULL,
    [bsefo] VARCHAR(1) NULL,
    [Last_inactive_date] DATETIME NULL,
    [First_Active_date] DATETIME NULL,
    [NBFC_cli] VARCHAR(1) NULL,
    [nsx_last_Date] DATETIME NULL,
    [mcd_last_Date] DATETIME NULL,
    [bsefo_last_Date] DATETIME NULL,
    [mcd] VARCHAR(1) NULL,
    [nsx] VARCHAR(1) NULL,
    [Ori_branch_cd] VARCHAR(10) NULL,
    [Ori_sub_Broker] VARCHAR(10) NULL,
    [b2c] VARCHAR(1) NULL,
    [Ebroking] VARCHAR(1) NULL,
    [bsx] VARCHAR(1) NULL,
    [MF] VARCHAR(1) NULL,
    [MF_LAST_DATE] DATETIME NULL,
    [NCE] VARCHAR(50) NULL,
    [NCE_LAST_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_EntityDataView_combine
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_EntityDataView_combine]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_EntityDataView_combine_03Apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_EntityDataView_combine_03Apr2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_EntityDataView_combine_06Jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_EntityDataView_combine_06Jan2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_EntityDataView_combine_11Dec2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_EntityDataView_combine_11Dec2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_EntityDataView_combine_13Jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_EntityDataView_combine_13Jan2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_EntityDataView_combine_17Apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_EntityDataView_combine_17Apr2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_EntityDataView_combine_21May2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_EntityDataView_combine_21May2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_EntityDataView_combine_23Sep2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_EntityDataView_combine_23Sep2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_EntityDataView_combine_stg
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_EntityDataView_combine_stg]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_EntityDataView_combine_wrongAccrual_03Apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_EntityDataView_combine_wrongAccrual_03Apr2025]
(
    [id] INT NOT NULL,
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_ERROR
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_ERROR]
(
    [ErrID] INT IDENTITY(1,1) NOT NULL,
    [ErrTime] DATETIME NULL,
    [ErrObject] VARCHAR(8000) NULL,
    [ErrLine] INT NULL,
    [ErrMessage] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_FileData
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_FileData]
(
    [Paymode] VARCHAR(20) NULL,
    [acno] VARCHAR(30) NULL,
    [bankname] VARCHAR(50) NULL,
    [poid] VARCHAR(20) NULL,
    [UpdateOn] DATETIME NULL,
    [SegApprovedAmt] MONEY NULL,
    [party_code] VARCHAR(50) NULL,
    [segment] VARCHAR(10) NULL,
    [req_refno] VARCHAR(50) NULL,
    [VerifierId] INT NULL,
    [batchid] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_FileData_heading
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_FileData_heading]
(
    [Paymode] VARCHAR(20) NULL,
    [acno] VARCHAR(30) NULL,
    [bankname] VARCHAR(50) NULL,
    [poid] VARCHAR(20) NULL,
    [UpdateOn] VARCHAR(50) NULL,
    [SegApprovedAmt] VARCHAR(50) NULL,
    [party_code] VARCHAR(50) NULL,
    [segment] VARCHAR(10) NULL,
    [req_refno] VARCHAR(50) NULL,
    [VerifierId] VARCHAR(50) NULL,
    [batchid] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_HDFCBank_ACCOUNT
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_HDFCBank_ACCOUNT]
(
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_HdfcBankAccuntOnly_log
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_HdfcBankAccuntOnly_log]
(
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [BatchNo] VARCHAR(4) NULL,
    [segment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_HDFCbankDetails_for_HDFCAcc
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_HDFCbankDetails_for_HDFCAcc]
(
    [segment] VARCHAR(10) NULL,
    [Fname] VARCHAR(25) NULL,
    [Fpath] VARCHAR(100) NULL,
    [BO_BankCode] VARCHAR(20) NULL,
    [BO_BankName] VARCHAR(50) NULL,
    [NARRATION] VARCHAR(250) NULL,
    [BO_exchange] VARCHAR(50) NULL,
    [BO_segment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_ICICIBank
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_ICICIBank]
(
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL,
    [SegApprovedAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_ICICIBank_log
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_ICICIBank_log]
(
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [BatchNo] VARCHAR(4) NULL,
    [segment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_Intraday_loss
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_Intraday_loss]
(
    [party_code] VARCHAR(50) NULL,
    [loss] MONEY NULL,
    [exchange] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_Marking_Error_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_Marking_Error_Log]
(
    [ErrID] INT IDENTITY(1,1) NOT NULL,
    [ErrTime] DATETIME NULL,
    [ErrMessage] VARCHAR(8000) NULL,
    [party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_Omnysis
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_Omnysis]
(
    [party_code] VARCHAR(50) NULL,
    [amount] MONEY NULL,
    [validationtxt] VARCHAR(100) NULL,
    [dttime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_Omnysis_log
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_Omnysis_log]
(
    [party_code] VARCHAR(50) NULL,
    [amount] MONEY NULL,
    [validationtxt] VARCHAR(100) NULL,
    [dttime] DATETIME NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_omnysis_uploader
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_omnysis_uploader]
(
    [AccountId] VARCHAR(20) NOT NULL,
    [AccountName] VARCHAR(50) NOT NULL,
    [BranchId] VARCHAR(12) NOT NULL,
    [Email-ID] VARCHAR(50) NOT NULL,
    [CellNo] VARCHAR(30) NULL,
    [FamilyId] VARCHAR(30) NULL,
    [DPId] VARCHAR(30) NULL,
    [DPAccountNo] VARCHAR(30) NULL,
    [Pan Number] VARCHAR(20) NOT NULL,
    [BankAccountNo] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(30) NULL,
    [ClientStatus] CHAR(1) NOT NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAddress] VARCHAR(200) NULL,
    [Validated] VARCHAR(50) NULL,
    [ValidationText] VARCHAR(500) NULL,
    [DtTime] DATETIME NULL,
    [OmneManagerID] INT NULL,
    [DC] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_omnysis_uploader_06Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_omnysis_uploader_06Nov2025]
(
    [AccountId] VARCHAR(20) NOT NULL,
    [AccountName] VARCHAR(50) NOT NULL,
    [BranchId] VARCHAR(12) NOT NULL,
    [Email-ID] VARCHAR(50) NOT NULL,
    [CellNo] VARCHAR(30) NULL,
    [FamilyId] VARCHAR(30) NULL,
    [DPId] VARCHAR(30) NULL,
    [DPAccountNo] VARCHAR(30) NULL,
    [Pan Number] VARCHAR(20) NOT NULL,
    [BankAccountNo] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(30) NULL,
    [ClientStatus] CHAR(1) NOT NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAddress] VARCHAR(200) NULL,
    [Validated] VARCHAR(50) NULL,
    [ValidationText] VARCHAR(500) NULL,
    [DtTime] DATETIME NULL,
    [OmneManagerID] INT NULL,
    [DC] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ncms_payout_data_05Jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[Ncms_payout_data_05Jan2025]
(
    [party_code] VARCHAR(10) NULL,
    [req_paybankid] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_pendingData
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_pendingData]
(
    [party_code] VARCHAR(10) NULL,
    [po_request] MONEY NULL,
    [req_user] VARCHAR(25) NULL,
    [req_datetime] DATETIME NULL,
    [req_paybankid] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ncms_Po_request
-- --------------------------------------------------
CREATE TABLE [dbo].[Ncms_Po_request]
(
    [SegMinID] INT NULL,
    [POrequestID] INT IDENTITY(1,1) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Entity] VARCHAR(10) NULL,
    [Net_payable] MONEY NULL,
    [PO_Request] MONEY NULL,
    [POdt_request] DATETIME NULL,
    [Req_datetime] DATETIME NULL,
    [Req_IP] VARCHAR(15) NULL,
    [Req_User] VARCHAR(25) NULL,
    [Req_Paymode] VARCHAR(10) NULL,
    [Req_PayBankId] VARCHAR(25) NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [POveriID] INT NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [PO_Statusid] INT NULL,
    [remarks] VARCHAR(100) NULL,
    [requestType] CHAR(1) NULL,
    [ReleaseId] VARCHAR(100) NULL,
    [ParentChildID] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_po_request_07Oct2024
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_po_request_07Oct2024]
(
    [SegMinID] INT NULL,
    [POrequestID] INT IDENTITY(1,1) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Entity] VARCHAR(10) NULL,
    [Net_payable] MONEY NULL,
    [PO_Request] MONEY NULL,
    [POdt_request] DATETIME NULL,
    [Req_datetime] DATETIME NULL,
    [Req_IP] VARCHAR(15) NULL,
    [Req_User] VARCHAR(25) NULL,
    [Req_Paymode] VARCHAR(10) NULL,
    [Req_PayBankId] VARCHAR(25) NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [POveriID] INT NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [PO_Statusid] INT NULL,
    [remarks] VARCHAR(100) NULL,
    [requestType] CHAR(1) NULL,
    [ReleaseId] VARCHAR(100) NULL,
    [ParentChildID] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_po_request_14Feb2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_po_request_14Feb2025]
(
    [SegMinID] INT NULL,
    [POrequestID] INT IDENTITY(1,1) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Entity] VARCHAR(10) NULL,
    [Net_payable] MONEY NULL,
    [PO_Request] MONEY NULL,
    [POdt_request] DATETIME NULL,
    [Req_datetime] DATETIME NULL,
    [Req_IP] VARCHAR(15) NULL,
    [Req_User] VARCHAR(25) NULL,
    [Req_Paymode] VARCHAR(10) NULL,
    [Req_PayBankId] VARCHAR(25) NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [POveriID] INT NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [PO_Statusid] INT NULL,
    [remarks] VARCHAR(100) NULL,
    [requestType] CHAR(1) NULL,
    [ReleaseId] VARCHAR(100) NULL,
    [ParentChildID] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_po_request_15oct24_Status_cancel
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_po_request_15oct24_Status_cancel]
(
    [SegMinID] INT NULL,
    [POrequestID] INT NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Entity] VARCHAR(10) NULL,
    [Net_payable] MONEY NULL,
    [PO_Request] MONEY NULL,
    [POdt_request] DATETIME NULL,
    [Req_datetime] DATETIME NULL,
    [Req_IP] VARCHAR(15) NULL,
    [Req_User] VARCHAR(25) NULL,
    [Req_Paymode] VARCHAR(10) NULL,
    [Req_PayBankId] VARCHAR(25) NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [POveriID] INT NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [PO_Statusid] INT NULL,
    [remarks] VARCHAR(100) NULL,
    [requestType] CHAR(1) NULL,
    [ReleaseId] VARCHAR(100) NULL,
    [ParentChildID] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_po_request_18Sep2024
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_po_request_18Sep2024]
(
    [SegMinID] INT NULL,
    [POrequestID] INT IDENTITY(1,1) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Entity] VARCHAR(10) NULL,
    [Net_payable] MONEY NULL,
    [PO_Request] MONEY NULL,
    [POdt_request] DATETIME NULL,
    [Req_datetime] DATETIME NULL,
    [Req_IP] VARCHAR(15) NULL,
    [Req_User] VARCHAR(25) NULL,
    [Req_Paymode] VARCHAR(10) NULL,
    [Req_PayBankId] VARCHAR(25) NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [POveriID] INT NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [PO_Statusid] INT NULL,
    [remarks] VARCHAR(100) NULL,
    [requestType] CHAR(1) NULL,
    [ReleaseId] VARCHAR(100) NULL,
    [ParentChildID] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_PO_Request_Flexi
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_PO_Request_Flexi]
(
    [processDate] DATETIME NULL,
    [POrequestID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_POstatus
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_POstatus]
(
    [PO_Statusid] INT NOT NULL,
    [PO_Status] VARCHAR(25) NULL,
    [ConsForFlexi] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_RealPayout_Formorning_23Aug2024
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_RealPayout_Formorning_23Aug2024]
(
    [SegMinID] INT NULL,
    [POrequestID] INT IDENTITY(1,1) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Entity] VARCHAR(10) NULL,
    [Net_payable] MONEY NULL,
    [PO_Request] MONEY NULL,
    [POdt_request] DATETIME NULL,
    [Req_datetime] DATETIME NULL,
    [Req_IP] VARCHAR(15) NULL,
    [Req_User] VARCHAR(25) NULL,
    [Req_Paymode] VARCHAR(10) NULL,
    [Req_PayBankId] VARCHAR(25) NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [POveriID] INT NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [PO_Statusid] INT NULL,
    [remarks] VARCHAR(100) NULL,
    [requestType] CHAR(1) NULL,
    [ReleaseId] VARCHAR(100) NULL,
    [ParentChildID] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_SegPayoutAppAmt
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_SegPayoutAppAmt]
(
    [POid] INT IDENTITY(1,1) NOT NULL,
    [RequestID] INT NULL,
    [VerifierID] INT NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [NetPayable] MONEY NULL,
    [SegApprovedAmt] MONEY NULL,
    [BOFF_gen] INT NULL,
    [BANK_gen] INT NULL,
    [ODIN_gen] INT NULL,
    [ProcessDateTime] DATETIME NULL,
    [BOFF_posted] INT NULL,
    [Paymode] VARCHAR(10) NULL,
    [Batchid] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_SegPOAppAmt
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_SegPOAppAmt]
(
    [SRNO] INT NULL,
    [VerifierID] INT NULL,
    [RequestID] INT NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ENTITY] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [NetPAyable] MONEY NULL,
    [SegApprovedAmt] MONEY NULL,
    [Temp_NetPAyable] MONEY NULL,
    [RequestType] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_SegPOAppAmt_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_SegPOAppAmt_hist]
(
    [SRNO] INT NULL,
    [VerifierID] INT NULL,
    [RequestID] INT NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ENTITY] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [NetPAyable] MONEY NULL,
    [SegApprovedAmt] MONEY NULL,
    [Temp_NetPAyable] MONEY NULL,
    [RequestType] CHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_Segwisecldata
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_Segwisecldata]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [ProcessDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_segwisecldata_06Jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_segwisecldata_06Jan2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [ProcessDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_segwisecldata_11122025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_segwisecldata_11122025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [ProcessDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_segwisecldata_11Dec2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_segwisecldata_11Dec2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [ProcessDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_SegwiseCldata_14Jan2026
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_SegwiseCldata_14Jan2026]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [ProcessDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_segwisecldata_17Apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_segwisecldata_17Apr2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [ProcessDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_SegwiseCldata_25Sep2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_SegwiseCldata_25Sep2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [ProcessDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_SegwiseCldata_stg
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_SegwiseCldata_stg]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [ProcessDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL,
    [Sub_Broker] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_SendOmnysis
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_SendOmnysis]
(
    [POrequestID] INT NULL,
    [Party_code] VARCHAR(10) NULL,
    [PO_Request] MONEY NULL,
    [Req_datetime] DATETIME NULL,
    [MangerId] INT NULL,
    [Response] VARCHAR(MAX) NULL,
    [Request] VARCHAR(MAX) NULL,
    [requestdate] DATETIME NULL,
    [Validationtxt] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_SendOmnysis_02Apr2024
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_SendOmnysis_02Apr2024]
(
    [POrequestID] INT NULL,
    [Party_code] VARCHAR(10) NULL,
    [PO_Request] MONEY NULL,
    [Req_datetime] DATETIME NULL,
    [MangerId] INT NULL,
    [Response] VARCHAR(MAX) NULL,
    [Request] VARCHAR(MAX) NULL,
    [requestdate] DATETIME NULL,
    [Validationtxt] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_SendOmnysis_06Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_SendOmnysis_06Nov2025]
(
    [POrequestID] INT NULL,
    [Party_code] VARCHAR(10) NULL,
    [PO_Request] MONEY NULL,
    [Req_datetime] DATETIME NULL,
    [MangerId] INT NULL,
    [Response] VARCHAR(MAX) NULL,
    [Request] VARCHAR(MAX) NULL,
    [requestdate] DATETIME NULL,
    [Validationtxt] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_shortsell_17Apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_shortsell_17Apr2025]
(
    [ID] BIGINT NULL,
    [seg] VARCHAR(5) NULL,
    [sett_no] VARCHAR(7) NULL,
    [Sett_type] VARCHAR(2) NULL,
    [PARTY_cODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [isin] VARCHAR(20) NULL,
    [short_qty] NUMERIC(17, 4) NULL,
    [SHORT_VALUE] NUMERIC(38, 8) NULL,
    [ShrtHC] INT NOT NULL,
    [DedVal] NUMERIC(38, 6) NULL,
    [Sec_payin] DATETIME NULL,
    [NBFC_TotalQty] INT NULL,
    [NBFC_AdjQty] INT NULL,
    [NetShortQty] INT NULL,
    [NetShortValue] MONEY NULL,
    [ProcessDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ncms_shortsell_29Jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ncms_shortsell_29Jul2025]
(
    [ID] BIGINT NULL,
    [seg] VARCHAR(5) NULL,
    [sett_no] VARCHAR(7) NULL,
    [Sett_type] VARCHAR(2) NULL,
    [PARTY_cODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [isin] VARCHAR(20) NULL,
    [short_qty] NUMERIC(17, 4) NULL,
    [SHORT_VALUE] NUMERIC(38, 8) NULL,
    [ShrtHC] INT NOT NULL,
    [DedVal] NUMERIC(38, 6) NULL,
    [Sec_payin] DATETIME NULL,
    [NBFC_TotalQty] INT NULL,
    [NBFC_AdjQty] INT NULL,
    [NetShortQty] INT NULL,
    [NetShortValue] MONEY NULL,
    [ProcessDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_BATCH
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_BATCH]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [scrip] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [filename] VARCHAR(100) NULL,
    [batchnum] INT NULL,
    [recordcount] INT NULL,
    [createdon] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_CNSLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_CNSLOG]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [subject] VARCHAR(100) NULL,
    [email] VARCHAR(500) NULL,
    [reqid] VARCHAR(200) NULL,
    [entryon] DATETIME NOT NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_Lock
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_Lock]
(
    [EnteredBy] VARCHAR(10) NULL,
    [EnteredOn] DATETIME NULL,
    [LockStatus] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_ORDER_29JAN2026
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_ORDER_29JAN2026]
(
    [REQUEST_ID] INT IDENTITY(1,1) NOT NULL,
    [REQUEST_DATE] DATETIME NULL,
    [CLIENT_CODE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(5) NULL,
    [SCRIPCODE] VARCHAR(25) NULL,
    [QUANTITY] INT NULL,
    [BID_RATE] MONEY NULL,
    [MIN_BID_RATE] MONEY NULL,
    [CLIENT_TYPE] VARCHAR(3) NULL,
    [MinMarginPercent] INT NULL,
    [Checkon_NetA_NetL] CHAR(2) NULL,
    [NET_AVAILABLE] MONEY NULL,
    [NET_LEDGER] MONEY NULL,
    [MARGIN_AVAILABLE] MONEY NULL,
    [ENTERED_BY] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(500) NULL,
    [GENERATION_FLAG] INT NULL,
    [GEN_STATUS] VARCHAR(100) NULL,
    [BID_NO] VARCHAR(25) NULL,
    [FileName] VARCHAR(25) NULL,
    [Batch_No] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_ORDER_BKP_06JAN2026
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_ORDER_BKP_06JAN2026]
(
    [REQUEST_ID] INT IDENTITY(1,1) NOT NULL,
    [REQUEST_DATE] DATETIME NULL,
    [CLIENT_CODE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(5) NULL,
    [SCRIPCODE] VARCHAR(25) NULL,
    [QUANTITY] INT NULL,
    [BID_RATE] MONEY NULL,
    [MIN_BID_RATE] MONEY NULL,
    [CLIENT_TYPE] VARCHAR(3) NULL,
    [MinMarginPercent] INT NULL,
    [Checkon_NetA_NetL] CHAR(2) NULL,
    [NET_AVAILABLE] MONEY NULL,
    [NET_LEDGER] MONEY NULL,
    [MARGIN_AVAILABLE] MONEY NULL,
    [ENTERED_BY] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(500) NULL,
    [GENERATION_FLAG] INT NULL,
    [GEN_STATUS] VARCHAR(100) NULL,
    [BID_NO] VARCHAR(25) NULL,
    [FileName] VARCHAR(25) NULL,
    [Batch_No] VARCHAR(3) NULL,
    [Source] VARCHAR(25) NULL,
    [IP] VARCHAR(25) NULL,
    [Scrip] VARCHAR(50) NULL,
    [StatusCode] VARCHAR(10) NULL,
    [IsEmployee] BIT NOT NULL,
    [IsCutOff] BIT NOT NULL,
    [ModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_ORDER_BKP_29APR2025
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_ORDER_BKP_29APR2025]
(
    [REQUEST_ID] INT IDENTITY(1,1) NOT NULL,
    [REQUEST_DATE] DATETIME NULL,
    [CLIENT_CODE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(5) NULL,
    [SCRIPCODE] VARCHAR(25) NULL,
    [QUANTITY] INT NULL,
    [BID_RATE] MONEY NULL,
    [MIN_BID_RATE] MONEY NULL,
    [CLIENT_TYPE] VARCHAR(3) NULL,
    [MinMarginPercent] INT NULL,
    [Checkon_NetA_NetL] CHAR(2) NULL,
    [NET_AVAILABLE] MONEY NULL,
    [NET_LEDGER] MONEY NULL,
    [MARGIN_AVAILABLE] MONEY NULL,
    [ENTERED_BY] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(500) NULL,
    [GENERATION_FLAG] INT NULL,
    [GEN_STATUS] VARCHAR(100) NULL,
    [BID_NO] VARCHAR(25) NULL,
    [FileName] VARCHAR(25) NULL,
    [Batch_No] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_ORDER_HISTORY
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_ORDER_HISTORY]
(
    [HistoryID] INT IDENTITY(1,1) NOT NULL,
    [REQUEST_ID] INT NULL,
    [REQUEST_DATE] DATETIME NULL,
    [CLIENT_CODE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(5) NULL,
    [SCRIPCODE] VARCHAR(25) NULL,
    [QUANTITY] INT NULL,
    [BID_RATE] MONEY NULL,
    [MIN_BID_RATE] MONEY NULL,
    [CLIENT_TYPE] VARCHAR(3) NULL,
    [MinMarginPercent] INT NULL,
    [Checkon_NetA_NetL] CHAR(2) NULL,
    [NET_AVAILABLE] MONEY NULL,
    [NET_LEDGER] MONEY NULL,
    [MARGIN_AVAILABLE] MONEY NULL,
    [ENTERED_BY] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(500) NULL,
    [GENERATION_FLAG] INT NULL,
    [GEN_STATUS] VARCHAR(100) NULL,
    [BID_NO] VARCHAR(25) NULL,
    [FileName] VARCHAR(25) NULL,
    [Batch_No] VARCHAR(3) NULL,
    [Source] VARCHAR(25) NULL,
    [IP] VARCHAR(25) NULL,
    [Scrip] VARCHAR(50) NULL,
    [StatusCode] VARCHAR(10) NULL,
    [IsEmployee] BIT NULL,
    [IsCutOff] BIT NULL,
    [ModifiedOn] DATETIME NULL,
    [CL_TYPE] VARCHAR(50) NULL,
    [AuditAction] VARCHAR(10) NULL DEFAULT 'UPDATE',
    [AuditDate] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_ORDER_V1
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_ORDER_V1]
(
    [REQUEST_ID] INT IDENTITY(1,1) NOT NULL,
    [REQUEST_DATE] DATETIME NULL,
    [CLIENT_CODE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(5) NULL,
    [SCRIPCODE] VARCHAR(25) NULL,
    [QUANTITY] INT NULL,
    [BID_RATE] MONEY NULL,
    [MIN_BID_RATE] MONEY NULL,
    [CLIENT_TYPE] VARCHAR(3) NULL,
    [MinMarginPercent] INT NULL,
    [Checkon_NetA_NetL] CHAR(2) NULL,
    [NET_AVAILABLE] MONEY NULL,
    [NET_LEDGER] MONEY NULL,
    [MARGIN_AVAILABLE] MONEY NULL,
    [ENTERED_BY] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(500) NULL,
    [GENERATION_FLAG] INT NULL,
    [GEN_STATUS] VARCHAR(100) NULL,
    [BID_NO] VARCHAR(25) NULL,
    [FileName] VARCHAR(25) NULL,
    [Batch_No] VARCHAR(3) NULL,
    [Source] VARCHAR(25) NULL,
    [IP] VARCHAR(25) NULL,
    [Scrip] VARCHAR(50) NULL,
    [StatusCode] VARCHAR(10) NULL,
    [IsEmployee] BIT NOT NULL DEFAULT ((0)),
    [IsCutOff] BIT NOT NULL DEFAULT ((0)),
    [ModifiedOn] DATETIME NULL,
    [CL_TYPE] VARCHAR(50) NULL DEFAULT 'CLI'
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_REVERSE_UPLOAD
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_REVERSE_UPLOAD]
(
    [ID] BIGINT IDENTITY(1,1) NOT NULL,
    [Scrip] VARCHAR(50) NOT NULL,
    [Category] VARCHAR(20) NOT NULL,
    [ClType] VARCHAR(20) NULL,
    [UCC] VARCHAR(50) NOT NULL,
    [Qty] INT NOT NULL,
    [Price] DECIMAL(18, 2) NOT NULL,
    [BidID] VARCHAR(50) NOT NULL,
    [ActionCode] CHAR(1) NOT NULL,
    [Segment] VARCHAR(10) NOT NULL,
    [FileName] VARCHAR(150) NULL,
    [BatchNo] INT NULL,
    [ExchangeStatus] VARCHAR(20) NULL DEFAULT 'SUCCESS',
    [ExchangeRefNo] VARCHAR(100) NULL,
    [CreatedOn] DATETIME NULL DEFAULT (getdate()),
    [CreatedBy] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_ScripMaster_
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_ScripMaster_]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ScripName] VARCHAR(50) NULL,
    [BSECode] VARCHAR(20) NULL,
    [NSESymbol] VARCHAR(20) NULL,
    [ValidForDate] DATETIME NULL,
    [MinBidRate] MONEY NULL,
    [MaxBidRate] MONEY NULL,
    [PercentAlert] INT NULL,
    [RI_AmtLimit] MONEY NULL,
    [MinMarginPercent] INT NULL,
    [Checkon_NetA_NetL] CHAR(2) NULL,
    [EnteredBy] VARCHAR(10) NULL,
    [EnteredOn] DATETIME NULL,
    [OfferSize] MONEY NULL,
    [RetailPercent] INT NULL,
    [ReatilSize] MONEY NULL,
    [series] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_ScripMaster_BKP_12JAN2026
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_ScripMaster_BKP_12JAN2026]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ScripName] VARCHAR(50) NULL,
    [BSECode] VARCHAR(20) NULL,
    [NSESymbol] VARCHAR(20) NULL,
    [ValidForDate] DATETIME NULL,
    [MinBidRate] MONEY NULL,
    [MaxBidRate] MONEY NULL,
    [PercentAlert] INT NULL,
    [RI_AmtLimit] MONEY NULL,
    [MinMarginPercent] INT NULL,
    [Checkon_NetA_NetL] CHAR(2) NULL,
    [EnteredBy] VARCHAR(10) NULL,
    [EnteredOn] DATETIME NULL,
    [OfferSize] MONEY NULL,
    [RetailPercent] INT NULL,
    [ReatilSize] MONEY NULL,
    [series] VARCHAR(10) NULL,
    [UserType] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [SEGMENT] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_ScripMaster_V1
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_ScripMaster_V1]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ScripName] VARCHAR(50) NULL,
    [BSECode] VARCHAR(20) NULL,
    [NSESymbol] VARCHAR(20) NULL,
    [ValidForDate] DATETIME NULL,
    [MinBidRate] MONEY NULL,
    [MaxBidRate] MONEY NULL,
    [PercentAlert] INT NULL,
    [RI_AmtLimit] MONEY NULL,
    [MinMarginPercent] INT NULL,
    [Checkon_NetA_NetL] CHAR(2) NULL,
    [EnteredBy] VARCHAR(10) NULL,
    [EnteredOn] DATETIME NULL,
    [OfferSize] MONEY NULL,
    [RetailPercent] INT NULL,
    [ReatilSize] MONEY NULL,
    [series] VARCHAR(10) NULL,
    [UserType] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [SEGMENT] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_ScripMasterB
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_ScripMasterB]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ScripName] VARCHAR(50) NULL,
    [BSECode] VARCHAR(20) NULL,
    [NSESymbol] VARCHAR(20) NULL,
    [ValidForDate] DATETIME NULL,
    [MinBidRate] MONEY NULL,
    [MaxBidRate] MONEY NULL,
    [PercentAlert] INT NULL,
    [RI_AmtLimit] MONEY NULL,
    [MinMarginPercent] INT NULL,
    [Checkon_NetA_NetL] CHAR(2) NULL,
    [EnteredBy] VARCHAR(10) NULL,
    [EnteredOn] DATETIME NULL,
    [OfferSize] MONEY NULL,
    [RetailPercent] INT NULL,
    [ReatilSize] MONEY NULL,
    [series] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFS_StatusMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[OFS_StatusMaster]
(
    [StatusCode] VARCHAR(20) NOT NULL,
    [StatusId] INT NOT NULL,
    [Description] NVARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.omnysis_GM12_Req
-- --------------------------------------------------
CREATE TABLE [dbo].[omnysis_GM12_Req]
(
    [requestid] INT NULL,
    [party_code] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL,
    [Data_log] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.omnysis_GM12_Res
-- --------------------------------------------------
CREATE TABLE [dbo].[omnysis_GM12_Res]
(
    [requestid] INT NULL,
    [party_code] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL,
    [Data_log] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PDFEmailLog
-- --------------------------------------------------
CREATE TABLE [dbo].[PDFEmailLog]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [FromEmailID] VARCHAR(200) NULL,
    [ToEmailID] VARCHAR(MAX) NULL,
    [Sbtag] VARCHAR(20) NULL,
    [Filepath] VARCHAR(300) NULL,
    [updateddate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RAHUL
-- --------------------------------------------------
CREATE TABLE [dbo].[RAHUL]
(
    [ID] INT NULL,
    [NAME] VARCHAR(100) NULL,
    [GENDER] VARCHAR(10) NULL,
    [DOB] DATE NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RiskMonDetails15042024151129
-- --------------------------------------------------
CREATE TABLE [dbo].[RiskMonDetails15042024151129]
(
    [Client Code] VARCHAR(50) NULL,
    [Client Name] VARCHAR(50) NULL,
    [Branch Code] VARCHAR(50) NULL,
    [Final Margin] VARCHAR(50) NULL,
    [Utilization] VARCHAR(50) NULL,
    [Adhoc Dr Cr] VARCHAR(50) NULL,
    [Ledger Balance] VARCHAR(50) NULL,
    [Stock After Haircut] VARCHAR(50) NULL,
    [Stock Before Haircut] VARCHAR(50) NULL,
    [Free POA After Haircut] VARCHAR(50) NULL,
    [Free POA Before Haircut] VARCHAR(50) NULL,
    [Net Margin] VARCHAR(50) NULL,
    [BSE MTM] VARCHAR(50) NULL,
    [BSE Var] VARCHAR(50) NULL,
    [NSE MTM] VARCHAR(50) NULL,
    [NSE Var] VARCHAR(50) NULL,
    [NSEF Span] VARCHAR(50) NULL,
    [NSEF MVM] VARCHAR(50) NULL,
    [NSEF FUT MTM] VARCHAR(50) NULL,
    [NSEF OPT MTM] VARCHAR(50) NULL,
    [NSEF OPT Premium] VARCHAR(50) NULL,
    [NSEF MTM] VARCHAR(50) NULL,
    [MCX Span] VARCHAR(50) NULL,
    [MCX MVM] VARCHAR(50) NULL,
    [MCX FUT MTM] VARCHAR(50) NULL,
    [MCX OPT MTM] VARCHAR(50) NULL,
    [MCX OPT Premium] VARCHAR(50) NULL,
    [MCX MTM] VARCHAR(50) NULL,
    [NCDX Span] VARCHAR(50) NULL,
    [NCDX MVM] VARCHAR(50) NULL,
    [NCDX MTM] VARCHAR(50) NULL,
    [NSEC Span] VARCHAR(50) NULL,
    [NSEC MVM] VARCHAR(50) NULL,
    [NSEC FUT MTM] VARCHAR(50) NULL,
    [NSEC OPT MTM] VARCHAR(50) NULL,
    [NSEC OPT Premium] VARCHAR(50) NULL,
    [NSEC MTM] VARCHAR(50) NULL,
    [MCXC Span] VARCHAR(50) NULL,
    [MCXC MVM] VARCHAR(50) NULL,
    [MCXC FUT MTM] VARCHAR(50) NULL,
    [MCXC OPT MTM] VARCHAR(50) NULL,
    [MCXC OPT Premium] VARCHAR(50) NULL,
    [MCXC MTM] VARCHAR(50) NULL,
    [Log Mtm] VARCHAR(50) NULL,
    [BSEC SPAN] VARCHAR(50) NULL,
    [BSEC MVM] VARCHAR(50) NULL,
    [BSEC FUT MTM] VARCHAR(50) NULL,
    [BSEC OPT MTM] VARCHAR(50) NULL,
    [BSEC OPT Premium] VARCHAR(50) NULL,
    [BSEC MTM] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rtgs_update_forPO
-- --------------------------------------------------
CREATE TABLE [dbo].[rtgs_update_forPO]
(
    [Fld_Sr_No] INT NOT NULL,
    [Fld_Party_Code] VARCHAR(15) NOT NULL,
    [Fld_RTGS_Sr_No] VARCHAR(15) NULL,
    [Fld_Bank_AcNo] VARCHAR(22) NOT NULL,
    [Fld_Status] VARCHAR(2) NOT NULL,
    [Fld_Docs_Recd] VARCHAR(2) NULL,
    [Fld_Entered_By] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(150) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(50) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Req_by] CHAR(1) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(15) NULL,
    [Fld_Type] VARCHAR(15) NULL,
    [Fld_Active_By] VARCHAR(15) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(15) NULL,
    [party_code] VARCHAR(10) NULL,
    [req_datetime] DATETIME NULL,
    [req_paybankid] VARCHAR(25) NULL,
    [req_user] VARCHAR(25) NULL,
    [rn] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.S57493
-- --------------------------------------------------
CREATE TABLE [dbo].[S57493]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL,
    [F40] NVARCHAR(255) NULL,
    [F41] NVARCHAR(255) NULL,
    [F42] NVARCHAR(255) NULL,
    [F43] NVARCHAR(255) NULL,
    [F44] NVARCHAR(255) NULL,
    [F45] NVARCHAR(255) NULL,
    [F46] NVARCHAR(255) NULL,
    [F47] NVARCHAR(255) NULL,
    [F48] NVARCHAR(255) NULL,
    [F49] NVARCHAR(255) NULL,
    [F50] NVARCHAR(255) NULL,
    [F51] NVARCHAR(255) NULL,
    [F52] NVARCHAR(255) NULL,
    [F53] NVARCHAR(255) NULL,
    [F54] NVARCHAR(255) NULL,
    [F55] NVARCHAR(255) NULL,
    [F56] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SbTag_Mail
-- --------------------------------------------------
CREATE TABLE [dbo].[SbTag_Mail]
(
    [sbtag] VARCHAR(255) NOT NULL,
    [Emailid] VARCHAR(255) NOT NULL,
    [APName] VARCHAR(200) NULL,
    [AuditorName] VARCHAR(100) NULL,
    [Audit_Date] DATE NULL,
    [NonCompliantRemarks] VARCHAR(255) NULL,
    [updatedby] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SBVisit_Profile_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[SBVisit_Profile_tobedeleted]
(
    [SBtag] VARCHAR(25) NULL,
    [SBName] VARCHAR(100) NULL,
    [BusinessMangedBy] VARCHAR(100) NULL,
    [Relationship] VARCHAR(100) NULL,
    [OfficeAddress] VARBINARY(8000) NULL,
    [TerminalAddress] VARCHAR(5000) NULL,
    [TerminalUser] VARCHAR(100) NULL,
    [PreviousEx] VARCHAR(100) NULL,
    [Recordingfacility] VARCHAR(100) NULL,
    [Bankinghouse] VARCHAR(100) NULL,
    [VisitingRegister] VARCHAR(100) NULL,
    [DisplayOfRegis] VARCHAR(100) NULL,
    [UpdatedOn] VARCHAR(100) NULL,
    [TeminalUserKeyvalue] VARCHAR(20) NULL,
    [key] VARCHAR(200) NULL,
    [ID] INT IDENTITY(1,1) NOT NULL,
    [NewOfficeAddress] VARCHAR(MAX) NULL,
    [NewTerminalAddress] VARBINARY(8000) NULL,
    [CreatedBy] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SEBI_Payout_2MonthData_07Feb2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SEBI_Payout_2MonthData_07Feb2025]
(
    [POrequestID] BIGINT NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Entity] VARCHAR(10) NULL,
    [PO_Request] MONEY NULL,
    [Req_datetime] DATETIME NULL,
    [Req_Paymode] VARCHAR(10) NULL,
    [Req_PayBankId] VARCHAR(25) NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [PO_Statusid] INT NULL,
    [remarks] VARCHAR(100) NULL,
    [PO_Status] VARCHAR(100) NULL,
    [credit_date_time] DATETIME NULL,
    [bankIFSC] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SFDC_client_details_06AUG2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SFDC_client_details_06AUG2025]
(
    [Party_code] VARCHAR(10) NOT NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [Sex] CHAR(1) NULL,
    [email] VARCHAR(50) NULL,
    [SubType] VARCHAR(10) NOT NULL,
    [street] VARCHAR(300) NULL,
    [l_city] VARCHAR(100) NULL,
    [Country] VARCHAR(15) NULL,
    [PostalCode] VARCHAR(10) NULL,
    [State] VARCHAR(100) NULL,
    [FirstName] VARCHAR(1) NOT NULL,
    [LastName] VARCHAR(100) NULL,
    [FullName] VARCHAR(100) NULL,
    [Login] VARCHAR(1) NOT NULL,
    [DOB] VARCHAR(30) NULL,
    [B2B] VARCHAR(3) NOT NULL,
    [AccountActive] VARCHAR(5) NOT NULL,
    [OfficePhone] VARCHAR(40) NULL,
    [MobilePhone] VARCHAR(40) NULL,
    [SubTag_BranchTag] VARCHAR(10) NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [AccountNumber] VARCHAR(20) NULL,
    [AccountType] VARCHAR(10) NULL,
    [MICR] VARCHAR(10) NULL,
    [IFSCCode] VARCHAR(1) NOT NULL,
    [OnlineBankFacility] VARCHAR(1) NOT NULL,
    [BranchCode] VARCHAR(10) NULL,
    [SubBrokerCategory] VARCHAR(10) NOT NULL,
    [SBCategory] VARCHAR(10) NOT NULL,
    [SBName] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sheet1$
-- --------------------------------------------------
CREATE TABLE [dbo].[Sheet1$]
(
    [Fld_SrNo] NVARCHAR(255) NULL,
    [Fld_ClientCode] NVARCHAR(255) NULL,
    [Fld_BankId] NVARCHAR(255) NULL,
    [Final] NVARCHAR(255) NULL,
    [Final_code] NVARCHAR(255) NULL,
    [Fld_ClientPISAc] NVARCHAR(255) NULL,
    [Fld_FromDate] NVARCHAR(255) NULL,
    [Fld_ToDate] NVARCHAR(255) NULL,
    [fld_CustodianAccno] NVARCHAR(255) NULL,
    [Fld_status_NRI_PIO] NVARCHAR(255) NULL,
    [Fld_Dp_Name] NVARCHAR(255) NULL,
    [Fld_DematAcNo] NVARCHAR(255) NULL,
    [Fld_Intersettlementban] NVARCHAR(255) NULL,
    [Fld_Status_PIS_NON_PIS] NVARCHAR(255) NULL,
    [Fld_BankAcno] NVARCHAR(255) NULL,
    [Fld_NREACNO] NVARCHAR(255) NULL,
    [Fld_NROACNO] NVARCHAR(255) NULL,
    [Fld_NROPISNO] NVARCHAR(255) NULL,
    [Fld_Countryofresidence] NVARCHAR(255) NULL,
    [Fld_Custodiancode] NVARCHAR(255) NULL,
    [Fld_Custodianname] NVARCHAR(255) NULL,
    [RBI_RefNo] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SMS
-- --------------------------------------------------
CREATE TABLE [dbo].[SMS]
(
    [to_no] VARCHAR(50) NOT NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(20) NULL,
    [time] VARCHAR(20) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(3) NULL,
    [purpose] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SMS_Template_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[SMS_Template_Master]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [TemplateID] VARCHAR(500) NULL,
    [SMSContent] VARCHAR(2000) NULL,
    [Purpose] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL,
    [notification_type] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SMS_Template_Master_14sep2024
-- --------------------------------------------------
CREATE TABLE [dbo].[SMS_Template_Master_14sep2024]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [TemplateID] VARCHAR(500) NULL,
    [SMSContent] VARCHAR(2000) NULL,
    [Purpose] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL,
    [notification_type] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SMS_Template_Master_18Feb2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SMS_Template_Master_18Feb2025]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [TemplateID] VARCHAR(500) NULL,
    [SMSContent] VARCHAR(2000) NULL,
    [Purpose] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL,
    [notification_type] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SMS_Template_Master_21Jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SMS_Template_Master_21Jan2025]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [TemplateID] VARCHAR(500) NULL,
    [SMSContent] VARCHAR(2000) NULL,
    [Purpose] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL,
    [notification_type] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SMS_Template_Master_22apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SMS_Template_Master_22apr2025]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [TemplateID] VARCHAR(500) NULL,
    [SMSContent] VARCHAR(2000) NULL,
    [Purpose] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL,
    [notification_type] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SMS_Template_Master_23Jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SMS_Template_Master_23Jan2025]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [TemplateID] VARCHAR(500) NULL,
    [SMSContent] VARCHAR(2000) NULL,
    [Purpose] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL,
    [notification_type] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SMS_Template_Master_24apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SMS_Template_Master_24apr2025]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [TemplateID] VARCHAR(500) NULL,
    [SMSContent] VARCHAR(2000) NULL,
    [Purpose] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL,
    [notification_type] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SubBrokerMailSendLog
-- --------------------------------------------------
CREATE TABLE [dbo].[SubBrokerMailSendLog]
(
    [sbtag] VARCHAR(255) NOT NULL,
    [email] VARCHAR(255) NOT NULL,
    [logdate] DATETIME NOT NULL,
    [AuditDate] DATE NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_ADDRESS_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_ADDRESS_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [ENTRYID] INT NOT NULL,
    [ADDRESS1] VARCHAR(MAX) NULL,
    [ADDRESS2] VARCHAR(MAX) NULL,
    [ADDRESS3] VARCHAR(200) NULL,
    [AREA] VARCHAR(50) NULL,
    [CITY] VARCHAR(50) NULL,
    [EMAIL] VARCHAR(MAX) NULL,
    [MOBILE] VARCHAR(MAX) NULL,
    [PHONE] VARCHAR(MAX) NULL,
    [PIN] VARCHAR(50) NULL,
    [STATE] VARCHAR(50) NULL,
    [STD] VARCHAR(50) NULL,
    [ISPERMANENT] BIT NULL,
    [SAMEASCORR] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AuditStatus
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AuditStatus]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [SbTag] VARCHAR(20) NULL,
    [APName] VARCHAR(100) NULL,
    [AuditStatus] VARCHAR(20) NULL,
    [Logdate] DATETIME NULL,
    [Version] VARCHAR(20) NULL,
    [Remarks] VARCHAR(100) NULL,
    [AuditType] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AuditStatus_29apr2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AuditStatus_29apr2024]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [SbTag] VARCHAR(20) NULL,
    [APName] VARCHAR(100) NULL,
    [AuditStatus] VARCHAR(20) NULL,
    [Logdate] DATETIME NULL,
    [Version] VARCHAR(20) NULL,
    [Remarks] VARCHAR(100) NULL,
    [AuditType] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_B2B_CRMS_SMS_DEALER_MAPPING_26Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_B2B_CRMS_SMS_DEALER_MAPPING_26Nov2025]
(
    [auto_id] BIGINT IDENTITY(1,1) NOT NULL,
    [party_code] VARCHAR(30) NULL,
    [party_mobile] VARCHAR(MAX) NULL,
    [sub_broker] VARCHAR(20) NULL,
    [sub_broker_name] VARCHAR(100) NULL,
    [DealerCode] VARCHAR(30) NULL,
    [DealerName] VARCHAR(100) NULL,
    [DealerContact] VARCHAR(50) NULL,
    [entry_date] DATETIME NULL,
    [smsflag] VARCHAR(50) NULL,
    [updatingdatetime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_B2BBranchManager_temp_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_B2BBranchManager_temp_tobedeleted]
(
    [BCode] VARCHAR(50) NULL,
    [BMName] VARCHAR(200) NULL,
    [BMContact] VARCHAR(50) NULL,
    [Email] VARBINARY(8000) NULL,
    [IsDelete] INT NULL,
    [Region] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_B2BHIRING_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_B2BHIRING_tobedeleted]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [PURPOSEID] INT NULL,
    [BMID] VARCHAR(20) NULL,
    [SBID] VARCHAR(20) NULL,
    [NAME] VARCHAR(20) NULL,
    [BUSINESSPARTNERTAG] VARCHAR(20) NULL,
    [ADDRESS] VARBINARY(8000) NULL,
    [CONTACTPERSON] VARCHAR(50) NULL,
    [CONTACTEMAILID] VARBINARY(8000) NULL,
    [DESIGNATION] VARCHAR(50) NULL,
    [SALARYMIN] VARCHAR(50) NULL,
    [SALARYMAX] VARCHAR(50) NULL,
    [EDUQUALIFICATION] VARCHAR(50) NULL,
    [EXPERIENCEYEAR] VARCHAR(50) NULL,
    [EXPERIENCEMONTHS] VARCHAR(50) NULL,
    [RESOURCES] VARCHAR(300) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_B2BMailMatrix_text_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_B2BMailMatrix_text_tobedeleted]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [PID] INT NULL,
    [Region] VARCHAR(50) NULL,
    [ResponsibleID1] VARBINARY(8000) NULL,
    [ResponsibleID2] VARBINARY(8000) NULL,
    [EscalationId] VARBINARY(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_B2BMicrosite_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_B2BMicrosite_tobedeleted]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [BMID] VARCHAR(50) NULL,
    [SBID] VARCHAR(50) NULL,
    [PURPOSEID] INT NULL,
    [QUESTIONS] VARCHAR(MAX) NULL,
    [BUSINESSOFFERING] VARCHAR(500) NULL,
    [SBTAG] VARCHAR(50) NULL,
    [FIRMESTABLISHEDYEAR] VARCHAR(50) NULL,
    [WEBSITENAME] VARCHAR(500) NULL,
    [LEAFLET] VARCHAR(500) NULL,
    [WHYUSOTHER] VARCHAR(500) NULL,
    [NAME] VARCHAR(200) NULL,
    [COMPANY] VARCHAR(200) NULL,
    [ADDRESS] VARBINARY(8000) NULL,
    [ADDRESS2] VARBINARY(8000) NULL,
    [CITY] VARCHAR(50) NULL,
    [STATE] VARCHAR(50) NULL,
    [POSTALCODE] VARCHAR(50) NULL,
    [EMAILID] VARBINARY(8000) NULL,
    [PHONE] VARBINARY(8000) NULL,
    [FACEBOOKLINK] VARBINARY(8000) NULL,
    [TWITTERLINK] VARCHAR(50) NULL,
    [THEME] VARCHAR(50) NULL,
    [COMPANYLOGO] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_B2BMKTCOLLATERAL_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_B2BMKTCOLLATERAL_tobedeleted]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [PURPOSEID] INT NULL,
    [BMID] VARCHAR(20) NULL,
    [SBID] VARCHAR(20) NULL,
    [ZONE] VARCHAR(50) NULL,
    [REGION] VARCHAR(50) NULL,
    [BRANCHTAG] VARCHAR(50) NULL,
    [BUSINESSPARTNERTAG] VARCHAR(50) NULL,
    [PARTNERNAME] VARCHAR(200) NULL,
    [MATERIALTYPE] VARCHAR(200) NULL,
    [MATERIALSIZE] VARCHAR(50) NULL,
    [DISPATCHLOCATION] VARBINARY(8000) NULL,
    [CONTACTPERSONNAME] VARCHAR(200) NULL,
    [PARTNERADDRESS] VARBINARY(8000) NULL,
    [CITY] VARCHAR(50) NULL,
    [STATE] VARCHAR(50) NULL,
    [CONTACTNUMBER] VARBINARY(8000) NULL,
    [QUANTITY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_B2BMKTDIRECTCOLLATERAL_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_B2BMKTDIRECTCOLLATERAL_tobedeleted]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [BMID] VARCHAR(20) NULL,
    [SBID] VARCHAR(20) NULL,
    [ZONE] VARCHAR(50) NULL,
    [REGION] VARCHAR(50) NULL,
    [BRANCHTAG] VARCHAR(50) NULL,
    [BUSINESSPARTNERTAG] VARCHAR(50) NULL,
    [PARTNERNAME] VARCHAR(200) NULL,
    [MATERIALTYPE] VARCHAR(200) NULL,
    [MATERIALSIZE] VARCHAR(50) NULL,
    [DISPATCHLOCATION] VARCHAR(500) NULL,
    [CONTACTPERSONNAME] VARCHAR(200) NULL,
    [PARTNERADDRESS] VARBINARY(8000) NULL,
    [CITY] VARCHAR(50) NULL,
    [STATE] VARCHAR(50) NULL,
    [CONTACTNUMBER] VARBINARY(8000) NULL,
    [QUANTITY] VARCHAR(50) NULL,
    [KEY] VARCHAR(200) NULL,
    [REQUESTED_DATE] DATETIME NULL,
    [LANDMARK] VARCHAR(200) NULL,
    [PINCODE] VARCHAR(200) NULL,
    [LEAFLETTYPE] VARCHAR(200) NULL,
    [LENGTH] VARCHAR(100) NULL,
    [BREADTH] VARCHAR(100) NULL,
    [MATERIALCOST] VARCHAR(100) NULL,
    [materialSubType] VARCHAR(300) NULL,
    [leafletEmailId] VARBINARY(8000) NULL,
    [angelWealthType] VARCHAR(300) NULL,
    [oneWayVisionType] VARCHAR(300) NULL,
    [orientation] VARCHAR(300) NULL,
    [voiceLoggerType] VARCHAR(300) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_B2BVCARD_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_B2BVCARD_tobedeleted]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [PURPOSEID] INT NULL,
    [BMID] VARCHAR(20) NULL,
    [SBID] VARCHAR(20) NULL,
    [SRNUM] VARCHAR(50) NULL,
    [PARTNARNAME] VARCHAR(200) NULL,
    [PARTNERTAG] VARCHAR(50) NULL,
    [DESIGNATION] VARCHAR(50) NULL,
    [DEPARTMENT] VARCHAR(50) NULL,
    [QTY] VARCHAR(50) NULL,
    [LINEOFBUSINESS] VARCHAR(500) NULL,
    [FIRSTNAME] VARCHAR(100) NULL,
    [BRANCHTAG] VARCHAR(50) NULL,
    [ADDRESS] VARBINARY(8000) NULL,
    [PINCODE] VARCHAR(50) NULL,
    [LANDLINENUM] VARCHAR(50) NULL,
    [EXTNUM] VARCHAR(50) NULL,
    [FAXNUM] VARCHAR(50) NULL,
    [MOBILENUM] VARBINARY(8000) NULL,
    [EMAIL] VARBINARY(8000) NULL,
    [REQUESTEDBY] VARCHAR(50) NULL,
    [APPROVEDBY] VARCHAR(50) NULL,
    [MICROSITE] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_BANKDETAILS_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_BANKDETAILS_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [ENTRYID] INT NULL,
    [ACCOUNTNO] VARCHAR(MAX) NULL,
    [ACCOUNTTYPE] VARCHAR(10) NULL,
    [ADDRESS] VARCHAR(MAX) NULL,
    [BANKNAME] VARCHAR(100) NULL,
    [BRANCH] VARCHAR(50) NULL,
    [IFSCRGTS] VARCHAR(50) NULL,
    [MICR] VARCHAR(50) NULL,
    [NAMEINBANK] VARCHAR(100) NULL,
    [ISCOMMODITY] BIT NULL,
    [sameAs] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CMS_BLOCK_CODES
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CMS_BLOCK_CODES]
(
    [CODE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CMS_PO_API_29Aug2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CMS_PO_API_29Aug2023]
(
    [Day_Type] VARCHAR(50) NULL,
    [TimeSlot] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CTCL_GROUPID
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CTCL_GROUPID]
(
    [INSRNO] BIGINT NULL,
    [STCTCLID] VARCHAR(18) NULL,
    [STINTSYSREFNO] VARCHAR(150) NULL,
    [STGROUPID] VARCHAR(20) NULL,
    [STGROUPNAME] VARCHAR(20) NULL,
    [STSTATUS] VARCHAR(1) NULL,
    [STCREATEDBY] VARCHAR(20) NULL,
    [DTCREATEDON] DATETIME NULL,
    [STUPDATEDBY] VARCHAR(20) NULL,
    [DTUPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CTCL_GROUPID_04032025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CTCL_GROUPID_04032025]
(
    [INSRNO] BIGINT NULL,
    [STCTCLID] VARCHAR(18) NULL,
    [STINTSYSREFNO] VARCHAR(150) NULL,
    [STGROUPID] VARCHAR(20) NULL,
    [STGROUPNAME] VARCHAR(20) NULL,
    [STSTATUS] VARCHAR(1) NULL,
    [STCREATEDBY] VARCHAR(20) NULL,
    [DTCREATEDON] DATETIME NULL,
    [STUPDATEDBY] VARCHAR(20) NULL,
    [DTUPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Ctcl_user_details_NXT_27122024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Ctcl_user_details_NXT_27122024]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [stIntSysRefNo] VARCHAR(50) NULL,
    [stSalute] VARCHAR(10) NULL,
    [stFirstName] VARCHAR(255) NULL,
    [stMiddleName] VARCHAR(255) NULL,
    [stLastName] VARCHAR(255) NULL,
    [stResiAddress1] VARCHAR(255) NULL,
    [stResiAddress2] VARCHAR(255) NULL,
    [stResiCity] VARCHAR(60) NULL,
    [stResiState] VARCHAR(60) NULL,
    [stResiPinCode] VARCHAR(10) NULL,
    [stContactNo] VARCHAR(25) NULL,
    [dealeraddressprooffile] IMAGE NULL,
    [dealeraddressprooffiletype] VARCHAR(255) NULL,
    [terminaladdressprooffile] IMAGE NULL,
    [terminaladdressprooffiletype] VARCHAR(255) NULL,
    [stEmail] VARCHAR(255) NULL,
    [dtDOB] DATETIME NULL,
    [dtValidityDate] DATETIME NULL,
    [certificatedetail] VARCHAR(255) NULL,
    [certificatebase] VARCHAR(255) NULL,
    [regno] VARCHAR(255) NULL,
    [imCertImage] IMAGE NULL,
    [stCertImgType] VARCHAR(255) NULL,
    [stCertBelongsTo] VARCHAR(255) NULL,
    [imUnderImg] IMAGE NULL,
    [stUnderType] VARCHAR(255) NULL,
    [stMAPINNo] VARCHAR(255) NULL,
    [stUserRelationshipWithTM] VARCHAR(255) NULL,
    [panno] VARCHAR(25) NULL,
    [imPanImage] IMAGE NULL,
    [stPanImgType] VARCHAR(255) NULL,
    [aadhaar_no] VARCHAR(25) NULL,
    [aadhaar_file] IMAGE NULL,
    [aadhaar_file_type] VARCHAR(255) NULL,
    [imDealerImg] IMAGE NULL,
    [stDealerImgType] VARCHAR(255) NULL,
    [imCPEUnderImg] IMAGE NULL,
    [stCPEUnderType] VARCHAR(255) NULL,
    [additionalfile] IMAGE NULL,
    [additionalfiletype] VARCHAR(255) NULL,
    [stCreatedBy] VARCHAR(255) NULL,
    [dtCreatedOn] DATETIME NULL,
    [stModifiedBy] VARCHAR(255) NULL,
    [dtModifiedOn] DATETIME NULL,
    [aadhaarname] VARCHAR(250) NULL,
    [stResiAddress3] VARCHAR(255) NULL,
    [RefID] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CtclAddTransaction
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CtclAddTransaction]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [stCtclId] VARCHAR(18) NULL,
    [stIntSysRefNo] VARCHAR(150) NULL,
    [stOdinId] VARCHAR(15) NULL,
    [SBTag] VARCHAR(20) NULL,
    [AddressType] VARCHAR(50) NULL,
    [AddTransType] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDTim] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDTime] DATETIME NULL,
    [stLowerLimit] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CtclAddTransaction_04032025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CtclAddTransaction_04032025]
(
    [RecID] INT IDENTITY(1,1) NOT NULL,
    [stCtclId] VARCHAR(18) NULL,
    [stIntSysRefNo] VARCHAR(150) NULL,
    [stOdinId] VARCHAR(15) NULL,
    [SBTag] VARCHAR(20) NULL,
    [AddressType] VARCHAR(50) NULL,
    [AddTransType] VARCHAR(50) NULL,
    [CreatedBy] VARCHAR(50) NULL,
    [CreatedDTim] DATETIME NULL,
    [UpdatedBy] VARCHAR(50) NULL,
    [UpdatedDTime] DATETIME NULL,
    [stLowerLimit] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ctclId
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ctclId]
(
    [inSrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [stCtclId] VARCHAR(18) NULL,
    [stSegment] VARCHAR(50) NULL,
    [stBrTag] VARCHAR(50) NULL,
    [stConnMode] VARCHAR(50) NULL,
    [stServerConn] VARCHAR(50) NULL,
    [stVsatLLId] VARCHAR(50) NULL,
    [stTerminalStatus] VARCHAR(50) NULL,
    [dtAllotDate] DATETIME NULL,
    [stPaymentNature] VARCHAR(50) NULL,
    [stOdinId] VARCHAR(15) NULL,
    [stManagerId] VARCHAR(15) NULL,
    [stSBTag] VARCHAR(15) NULL,
    [stOfficeNature] VARCHAR(150) NULL,
    [stEmpCode] VARCHAR(15) NULL,
    [stPurpose] VARCHAR(150) NULL,
    [stIntSysRefNo] VARCHAR(150) NULL,
    [stStatus] VARCHAR(1) NULL,
    [stProgram] VARCHAR(10) NULL,
    [stVendorCode] VARCHAR(10) NULL,
    [stVendorName] VARCHAR(100) NULL,
    [stRelationship] VARCHAR(130) NULL,
    [stRemarks] VARCHAR(200) NULL,
    [stTerminalType] VARCHAR(15) NULL,
    [stCSOStatus] VARCHAR(1) NULL,
    [stCreatedBy] VARCHAR(20) NULL,
    [dtCreatedOn] DATETIME NULL,
    [stUpdatedBy] VARCHAR(20) NULL,
    [dtUpdatedOn] DATETIME NULL,
    [stLowerLimit] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ctclId_04032025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ctclId_04032025]
(
    [inSrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [stCtclId] VARCHAR(18) NULL,
    [stSegment] VARCHAR(50) NULL,
    [stBrTag] VARCHAR(50) NULL,
    [stConnMode] VARCHAR(50) NULL,
    [stServerConn] VARCHAR(50) NULL,
    [stVsatLLId] VARCHAR(50) NULL,
    [stTerminalStatus] VARCHAR(50) NULL,
    [dtAllotDate] DATETIME NULL,
    [stPaymentNature] VARCHAR(50) NULL,
    [stOdinId] VARCHAR(15) NULL,
    [stManagerId] VARCHAR(15) NULL,
    [stSBTag] VARCHAR(15) NULL,
    [stOfficeNature] VARCHAR(150) NULL,
    [stEmpCode] VARCHAR(15) NULL,
    [stPurpose] VARCHAR(150) NULL,
    [stIntSysRefNo] VARCHAR(150) NULL,
    [stStatus] VARCHAR(1) NULL,
    [stProgram] VARCHAR(10) NULL,
    [stVendorCode] VARCHAR(10) NULL,
    [stVendorName] VARCHAR(100) NULL,
    [stRelationship] VARCHAR(130) NULL,
    [stRemarks] VARCHAR(200) NULL,
    [stTerminalType] VARCHAR(15) NULL,
    [stCSOStatus] VARCHAR(1) NULL,
    [stCreatedBy] VARCHAR(20) NULL,
    [dtCreatedOn] DATETIME NULL,
    [stUpdatedBy] VARCHAR(20) NULL,
    [dtUpdatedOn] DATETIME NULL,
    [stLowerLimit] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ctclId_NXT_11_4_25
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ctclId_NXT_11_4_25]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [stIntSysRefNo] VARCHAR(50) NULL,
    [stCtclId] VARCHAR(18) NULL,
    [stSegment] VARCHAR(50) NULL,
    [stBrTag] VARCHAR(50) NULL,
    [stSBTag] VARCHAR(50) NULL,
    [RequestType] VARCHAR(50) NULL,
    [RequestFor] VARCHAR(50) NULL,
    [stOdinId] VARCHAR(15) NULL,
    [stConnMode] VARCHAR(50) NULL,
    [stServerConn] VARCHAR(50) NULL,
    [stVsatLLId] VARCHAR(50) NULL,
    [dtAllotDate] DATETIME NULL,
    [stPaymentNature] VARCHAR(50) NULL,
    [stManagerId] VARCHAR(50) NULL,
    [stOfficeNature] VARCHAR(150) NULL,
    [stEmpCode] VARCHAR(15) NULL,
    [stPurpose] VARCHAR(150) NULL,
    [stStatus] VARCHAR(50) NULL,
    [stRemarks] NVARCHAR(500) NULL,
    [stCreatedBy] VARCHAR(15) NULL,
    [dtCreatedOn] DATETIME NULL,
    [stUpdatedBy] VARCHAR(15) NULL,
    [dtUpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ctclId_NXT_18112024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ctclId_NXT_18112024]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [stIntSysRefNo] VARCHAR(50) NULL,
    [stCtclId] VARCHAR(18) NULL,
    [stSegment] VARCHAR(50) NULL,
    [stBrTag] VARCHAR(50) NULL,
    [stSBTag] VARCHAR(50) NULL,
    [RequestType] VARCHAR(50) NULL,
    [RequestFor] VARCHAR(50) NULL,
    [stOdinId] VARCHAR(15) NULL,
    [stConnMode] VARCHAR(50) NULL,
    [stServerConn] VARCHAR(50) NULL,
    [stVsatLLId] VARCHAR(50) NULL,
    [dtAllotDate] DATETIME NULL,
    [stPaymentNature] VARCHAR(50) NULL,
    [stManagerId] VARCHAR(50) NULL,
    [stOfficeNature] VARCHAR(150) NULL,
    [stEmpCode] VARCHAR(15) NULL,
    [stPurpose] VARCHAR(150) NULL,
    [stStatus] VARCHAR(50) NULL,
    [stRemarks] NVARCHAR(500) NULL,
    [stCreatedBy] VARCHAR(15) NULL,
    [dtCreatedOn] DATETIME NULL,
    [stUpdatedBy] VARCHAR(15) NULL,
    [dtUpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ctclId_NXT_27122024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ctclId_NXT_27122024]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [stIntSysRefNo] VARCHAR(50) NULL,
    [stCtclId] VARCHAR(18) NULL,
    [stSegment] VARCHAR(50) NULL,
    [stBrTag] VARCHAR(50) NULL,
    [stSBTag] VARCHAR(50) NULL,
    [RequestType] VARCHAR(50) NULL,
    [RequestFor] VARCHAR(50) NULL,
    [stOdinId] VARCHAR(15) NULL,
    [stConnMode] VARCHAR(50) NULL,
    [stServerConn] VARCHAR(50) NULL,
    [stVsatLLId] VARCHAR(50) NULL,
    [dtAllotDate] DATETIME NULL,
    [stPaymentNature] VARCHAR(50) NULL,
    [stManagerId] VARCHAR(50) NULL,
    [stOfficeNature] VARCHAR(150) NULL,
    [stEmpCode] VARCHAR(15) NULL,
    [stPurpose] VARCHAR(150) NULL,
    [stStatus] VARCHAR(50) NULL,
    [stRemarks] NVARCHAR(500) NULL,
    [stCreatedBy] VARCHAR(15) NULL,
    [dtCreatedOn] DATETIME NULL,
    [stUpdatedBy] VARCHAR(15) NULL,
    [dtUpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_DRA_MailLog
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_DRA_MailLog]
(
    [PID] INT IDENTITY(1,1) NOT NULL,
    [Name] VARCHAR(250) NULL,
    [Email] VARCHAR(250) NULL,
    [UserID] VARCHAR(50) NULL,
    [PWD] VARCHAR(50) NULL,
    [status] VARCHAR(MAX) NULL,
    [LogDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EarlyPayin_Charges_20082025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EarlyPayin_Charges_20082025]
(
    [party_code] VARCHAR(10) NOT NULL,
    [CltDpId] VARCHAR(16) NULL,
    [sett_no] VARCHAR(7) NOT NULL,
    [No_CNT] INT NULL,
    [TXN_Rate] VARCHAR(5) NOT NULL,
    [Value_AMT] NUMERIC(15, 2) NULL,
    [SD_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EarlyPayin_Charges_20Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EarlyPayin_Charges_20Aug2025]
(
    [party_code] VARCHAR(10) NOT NULL,
    [CltDpId] VARCHAR(16) NULL,
    [sett_no] VARCHAR(7) NOT NULL,
    [No_CNT] INT NULL,
    [TXN_Rate] VARCHAR(5) NOT NULL,
    [Value_AMT] NUMERIC(15, 2) NULL,
    [SD_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ebrok_detail_cli_bkp_2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ebrok_detail_cli_bkp_2025]
(
    [segment] VARCHAR(10) NULL,
    [branch] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [sauda_date] DATETIME NULL,
    [Overall_turnover] MONEY NOT NULL,
    [ebrok_Turnover] MONEY NOT NULL,
    [TO_percent] MONEY NOT NULL,
    [Overall_brok_earned] MONEY NOT NULL,
    [Overall_Angel_share] MONEY NOT NULL,
    [Overall_percent] MONEY NOT NULL,
    [ebrok_brok_earned] MONEY NOT NULL,
    [ebrok_Angel_share] MONEY NOT NULL,
    [ebrok_percent] MONEY NOT NULL,
    [b2c_overall_turnover] MONEY NOT NULL,
    [b2c_overall_brok_earned] MONEY NOT NULL,
    [b2c_overall_angel_share] MONEY NOT NULL,
    [b2c_ebrok_turnover] MONEY NOT NULL,
    [b2c_ebrok_brok_earned] MONEY NOT NULL,
    [b2c_ebrok_angel_share] MONEY NOT NULL,
    [Add_Brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ebrok_detail_cli_Khed_2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ebrok_detail_cli_Khed_2025]
(
    [segment] VARCHAR(10) NULL,
    [branch] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [sauda_date] DATETIME NULL,
    [Overall_turnover] MONEY NOT NULL,
    [ebrok_Turnover] MONEY NOT NULL,
    [TO_percent] MONEY NOT NULL,
    [Overall_brok_earned] MONEY NOT NULL,
    [Overall_Angel_share] MONEY NOT NULL,
    [Overall_percent] MONEY NOT NULL,
    [ebrok_brok_earned] MONEY NOT NULL,
    [ebrok_Angel_share] MONEY NOT NULL,
    [ebrok_percent] MONEY NOT NULL,
    [b2c_overall_turnover] MONEY NOT NULL,
    [b2c_overall_brok_earned] MONEY NOT NULL,
    [b2c_overall_angel_share] MONEY NOT NULL,
    [b2c_ebrok_turnover] MONEY NOT NULL,
    [b2c_ebrok_brok_earned] MONEY NOT NULL,
    [b2c_ebrok_angel_share] MONEY NOT NULL,
    [Add_Brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Email_NOC_Process
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Email_NOC_Process]
(
    [Update_Date] VARCHAR(20) NULL,
    [ClientCode] VARCHAR(50) NULL,
    [Existing_Branch] VARCHAR(50) NULL,
    [Existing_SubBroker] VARCHAR(50) NULL,
    [New_Branch] VARCHAR(50) NULL,
    [New_SubBroker] VARCHAR(50) NULL,
    [Remarks] VARCHAR(500) NULL,
    [From] VARCHAR(50) NULL,
    [CodeAdded] DATETIME NULL,
    [ClientType] VARCHAR(20) NULL,
    [ClientStatus] VARCHAR(20) NULL,
    [PropCode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Email_NOC_Process_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Email_NOC_Process_Hist]
(
    [Update_Date] VARCHAR(20) NULL,
    [ClientCode] VARCHAR(50) NULL,
    [Existing_Branch] VARCHAR(50) NULL,
    [Existing_SubBroker] VARCHAR(50) NULL,
    [New_Branch] VARCHAR(50) NULL,
    [New_SubBroker] VARCHAR(50) NULL,
    [Remarks] VARCHAR(500) NULL,
    [From] VARCHAR(50) NULL,
    [update_on] DATETIME NULL,
    [CodeAdded] DATETIME NULL,
    [ClientType] VARCHAR(20) NULL,
    [ClientStatus] VARCHAR(20) NULL,
    [PropCode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Email_NOC_Process_Hist_13Mar2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Email_NOC_Process_Hist_13Mar2024]
(
    [Update_Date] VARCHAR(20) NULL,
    [ClientCode] VARCHAR(50) NULL,
    [Existing_Branch] VARCHAR(50) NULL,
    [Existing_SubBroker] VARCHAR(50) NULL,
    [New_Branch] VARCHAR(50) NULL,
    [New_SubBroker] VARCHAR(50) NULL,
    [Remarks] VARCHAR(500) NULL,
    [From] VARCHAR(50) NULL,
    [update_on] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Email_NOC_Process_Hist_29feb2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Email_NOC_Process_Hist_29feb2024]
(
    [Update_Date] VARCHAR(20) NULL,
    [ClientCode] VARCHAR(50) NULL,
    [Existing_Branch] VARCHAR(50) NULL,
    [Existing_SubBroker] VARCHAR(50) NULL,
    [New_Branch] VARCHAR(50) NULL,
    [New_SubBroker] VARCHAR(50) NULL,
    [Remarks] VARCHAR(500) NULL,
    [From] VARCHAR(50) NULL,
    [update_on] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Email_NOC_Process_Hist_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Email_NOC_Process_Hist_log]
(
    [Update_Date] VARCHAR(20) NULL,
    [ClientCode] VARCHAR(50) NULL,
    [Existing_Branch] VARCHAR(50) NULL,
    [Existing_SubBroker] VARCHAR(50) NULL,
    [New_Branch] VARCHAR(50) NULL,
    [New_SubBroker] VARCHAR(50) NULL,
    [Remarks] VARCHAR(500) NULL,
    [From] VARCHAR(50) NULL,
    [update_on] DATETIME NULL,
    [RowNodd] BIGINT NULL,
    [Logdate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_Master_26Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_Master_26Nov2025]
(
    [Emp_No] VARCHAR(15) NOT NULL,
    [Sb_Tag] VARCHAR(15) NULL,
    [First_Name] VARCHAR(50) NULL,
    [Middle_Name] VARCHAR(50) NULL,
    [Last_Name] VARCHAR(50) NULL,
    [Emp_Name] VARCHAR(150) NULL,
    [Address1] VARCHAR(MAX) NULL,
    [Address2] VARCHAR(MAX) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Pincode] VARCHAR(20) NULL,
    [Mobile] VARCHAR(MAX) NULL,
    [Email] VARCHAR(MAX) NULL,
    [Dt_ActiveFrom] DATETIME NULL,
    [isSuspended] BIT NULL,
    [isTerminated] BIT NULL,
    [Salary] DECIMAL(18, 0) NULL,
    [User_ID] VARCHAR(25) NULL,
    [Password] VARCHAR(50) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [LandLine] VARCHAR(50) NULL,
    [isAdmin] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EmpMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EmpMaster]
(
    [inId] BIGINT IDENTITY(1,1) NOT NULL,
    [stIntSysRefNo] VARCHAR(255) NULL,
    [stEmpCode] VARCHAR(255) NULL,
    [stCertDetail] VARCHAR(255) NULL,
    [stCertBase] VARCHAR(255) NULL,
    [stRegNoPrifix] VARCHAR(255) NULL,
    [stRegNo] VARCHAR(255) NULL,
    [stSalute] VARCHAR(255) NULL,
    [stFirstName] VARCHAR(255) NULL,
    [stMiddleName] VARCHAR(255) NULL,
    [stLastName] VARCHAR(255) NULL,
    [dtDOB] DATETIME NULL,
    [dtTestDate] DATETIME NULL,
    [dtValidityDate] DATETIME NULL,
    [stPercentage] VARCHAR(255) NULL,
    [stQualification] VARCHAR(255) NULL,
    [stPanCardNo] VARCHAR(255) NULL,
    [stResiAddress1] VARCHAR(255) NULL,
    [stResiAddress2] VARCHAR(255) NULL,
    [stResiAddress3] VARCHAR(255) NULL,
    [stResiCity] VARCHAR(55) NULL,
    [stResiState] VARCHAR(55) NULL,
    [stResiPinCode] VARCHAR(10) NULL,
    [stSTDNo] VARCHAR(5) NULL,
    [stContactNo] VARCHAR(25) NULL,
    [stSTDFAX] VARCHAR(5) NULL,
    [stFAXNo] VARCHAR(55) NULL,
    [stEmail] VARCHAR(255) NULL,
    [stCertBelongsTo] VARCHAR(255) NULL,
    [stMAPINNo] VARCHAR(255) NULL,
    [stUserRelationshipWithTM] VARCHAR(255) NULL,
    [imPanImage] IMAGE NULL,
    [stPanImgType] VARCHAR(255) NULL,
    [imCertImage] IMAGE NULL,
    [stCertImgType] VARCHAR(255) NULL,
    [imDealerImg] IMAGE NULL,
    [stDealerImgType] VARCHAR(255) NULL,
    [imSBUnderImg] IMAGE NULL,
    [stSBUnderType] VARCHAR(255) NULL,
    [imSBEmpUnderImg] IMAGE NULL,
    [stSBEmpUnderType] VARCHAR(255) NULL,
    [stCreatedBy] VARCHAR(255) NULL,
    [dtCreatedOn] DATETIME NULL,
    [stModifiedBy] VARCHAR(255) NULL,
    [dtModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EmpMaster_04032025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EmpMaster_04032025]
(
    [inId] BIGINT IDENTITY(1,1) NOT NULL,
    [stIntSysRefNo] VARCHAR(255) NULL,
    [stEmpCode] VARCHAR(255) NULL,
    [stCertDetail] VARCHAR(255) NULL,
    [stCertBase] VARCHAR(255) NULL,
    [stRegNoPrifix] VARCHAR(255) NULL,
    [stRegNo] VARCHAR(255) NULL,
    [stSalute] VARCHAR(255) NULL,
    [stFirstName] VARCHAR(255) NULL,
    [stMiddleName] VARCHAR(255) NULL,
    [stLastName] VARCHAR(255) NULL,
    [dtDOB] DATETIME NULL,
    [dtTestDate] DATETIME NULL,
    [dtValidityDate] DATETIME NULL,
    [stPercentage] VARCHAR(255) NULL,
    [stQualification] VARCHAR(255) NULL,
    [stPanCardNo] VARCHAR(255) NULL,
    [stResiAddress1] VARCHAR(255) NULL,
    [stResiAddress2] VARCHAR(255) NULL,
    [stResiAddress3] VARCHAR(255) NULL,
    [stResiCity] VARCHAR(55) NULL,
    [stResiState] VARCHAR(55) NULL,
    [stResiPinCode] VARCHAR(10) NULL,
    [stSTDNo] VARCHAR(5) NULL,
    [stContactNo] VARCHAR(25) NULL,
    [stSTDFAX] VARCHAR(5) NULL,
    [stFAXNo] VARCHAR(55) NULL,
    [stEmail] VARCHAR(255) NULL,
    [stCertBelongsTo] VARCHAR(255) NULL,
    [stMAPINNo] VARCHAR(255) NULL,
    [stUserRelationshipWithTM] VARCHAR(255) NULL,
    [imPanImage] IMAGE NULL,
    [stPanImgType] VARCHAR(255) NULL,
    [imCertImage] IMAGE NULL,
    [stCertImgType] VARCHAR(255) NULL,
    [imDealerImg] IMAGE NULL,
    [stDealerImgType] VARCHAR(255) NULL,
    [imSBUnderImg] IMAGE NULL,
    [stSBUnderType] VARCHAR(255) NULL,
    [imSBEmpUnderImg] IMAGE NULL,
    [stSBEmpUnderType] VARCHAR(255) NULL,
    [stCreatedBy] VARCHAR(255) NULL,
    [dtCreatedOn] DATETIME NULL,
    [stModifiedBy] VARCHAR(255) NULL,
    [dtModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_FNBankMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_FNBankMaster]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Broker_Bank_Code] VARCHAR(50) NULL,
    [Fld_Broker_Bank_Name] VARCHAR(50) NULL,
    [Fld_Broker_Bank_Acc_NO] VARCHAR(50) NULL,
    [ISACTIVE] VARCHAR(50) NULL,
    [Fld_INSERTED_ON] DATETIME NULL,
    [Fld_MODIFIED_ON] DATETIME NULL,
    [Fld_MODIFIED_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_FNCLIENTMASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_FNCLIENTMASTER]
(
    [FLD_SRNO] INT IDENTITY(1,1) NOT NULL,
    [FLD_BANKID] INT NULL,
    [FLD_CLIENT_CODE] VARCHAR(50) NULL,
    [FLD_SWIFTID] VARCHAR(50) NULL,
    [FLD_IBAN_NUMBER] VARCHAR(50) NULL,
    [FLD_SORT_CODE] VARCHAR(50) NULL,
    [FLD_CURRENCY_REMITTANCE] VARCHAR(50) NULL,
    [FLD_BANK_NAME] VARCHAR(50) NULL,
    [FLD_BANK_ACCOUNT_NO] VARCHAR(100) NULL,
    [FLD_BANK_ADDRESS] VARCHAR(100) NULL,
    [FLD_INSERTED_ON] DATETIME NULL,
    [FLD_MODIFIED_ON] DATETIME NULL,
    [FLD_MODIFIED_BY] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_FNCLIENTMASTER_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_FNCLIENTMASTER_TRIG]
(
    [FLD_BANKID] INT NULL,
    [FLD_CLIENT_CODE] VARCHAR(50) NULL,
    [FLD_SWIFTID] VARCHAR(50) NULL,
    [FLD_IBAN_NUMBER] VARCHAR(50) NULL,
    [FLD_SORT_CODE] VARCHAR(50) NULL,
    [FLD_CURRENCY_REMITTANCE] VARCHAR(50) NULL,
    [FLD_BANK_NAME] VARCHAR(50) NULL,
    [FLD_BANK_ACCOUNT_NO] VARCHAR(100) NULL,
    [FLD_BANK_ADDRESS] VARCHAR(100) NULL,
    [FLD_INSERTED_ON] DATETIME NULL,
    [FLD_MODIFIED_ON] DATETIME NULL,
    [FLD_MODIFIED_BY] VARCHAR(100) NULL,
    [UPDATED_DATE] DATETIME NULL,
    [DBACTION] VARCHAR(50) NULL,
    [APP_NAME] VARCHAR(50) NULL,
    [IPADDRESS] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_FNTRADE_REPORTS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_FNTRADE_REPORTS]
(
    [SETTLEMENT_DATE] VARCHAR(11) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(50) NULL,
    [ECN] VARCHAR(50) NOT NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [BILL_DATE] VARCHAR(11) NULL,
    [SELL_BUY] VARCHAR(50) NULL,
    [AMOUNT] MONEY NULL,
    [CL_TYPE] VARCHAR(10) NULL,
    [DPID] VARCHAR(16) NULL,
    [CLIENT_NAME] VARCHAR(50) NULL,
    [PAN_NUMBER] VARCHAR(50) NULL,
    [CLIENT_ADDRESS] VARCHAR(500) NULL,
    [FLD_BANK_NAME] VARCHAR(50) NULL,
    [FLD_BANK_ADDRESS] VARCHAR(100) NULL,
    [FLD_BANK_ACCOUNT_NO] BIGINT NULL,
    [FLD_SWIFTID] VARCHAR(50) NULL,
    [FLD_IBAN_NUMBER] VARCHAR(50) NULL,
    [FLD_SORT_CODE] VARCHAR(50) NULL,
    [FLD_CURRENCY_REMITTANCE] VARCHAR(50) NULL,
    [FLD_BROKER_BANK_CODE] VARCHAR(50) NULL,
    [FLD_BROKER_BANK_NAME] VARCHAR(50) NULL,
    [FLD_BROKER_BANK_ACC_NO] VARCHAR(50) NULL,
    [BROKER] VARCHAR(50) NULL,
    [BROKER_ADDRESS] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_GST_AGENTCODE_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_GST_AGENTCODE_MASTER]
(
    [GSTCODE] VARCHAR(100) NULL,
    [ANGENTCODE] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_IDENTITYDETAILS_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_IDENTITYDETAILS_04Aug2025]
(
    [ENTRYID] INT IDENTITY(1,1) NOT NULL,
    [AADHAARNO] VARCHAR(MAX) NULL,
    [DOB] VARCHAR(MAX) NULL,
    [PAN] VARCHAR(MAX) NULL,
    [ISAPPROVED] INT NULL,
    [ENTRY_DATE] DATETIME NULL,
    [ENTRYBY] VARCHAR(50) NULL,
    [MODIFY_DATE] DATETIME NULL,
    [MODIFY_BY] VARCHAR(50) NULL,
    [APPROVE_DATE] DATETIME NULL,
    [APPROVE_BY] VARCHAR(50) NULL,
    [Remark] VARCHAR(5000) NULL,
    [IsInhouseIntegrated] INT NULL,
    [RefNo] NUMERIC(18, 0) NULL,
    [U_ID] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_imps
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_imps]
(
    [Id] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [IFSR] NVARCHAR(50) NULL,
    [AccNo] NVARCHAR(50) NULL,
    [CrtBy] NVARCHAR(50) NULL,
    [ServiceMessage] NVARCHAR(MAX) NULL,
    [ServiceBeneficaryName] NVARCHAR(MAX) NULL,
    [ServiceSuccess] NVARCHAR(MAX) NULL,
    [CrtAt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_imps_02dec2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_imps_02dec2025]
(
    [Id] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [IFSR] NVARCHAR(50) NULL,
    [AccNo] NVARCHAR(50) NULL,
    [CrtBy] NVARCHAR(50) NULL,
    [ServiceMessage] NVARCHAR(MAX) NULL,
    [ServiceBeneficaryName] NVARCHAR(MAX) NULL,
    [ServiceSuccess] NVARCHAR(MAX) NULL,
    [CrtAt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_imps_02jun2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_imps_02jun2025]
(
    [Id] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [IFSR] NVARCHAR(50) NULL,
    [AccNo] NVARCHAR(50) NULL,
    [CrtBy] NVARCHAR(50) NULL,
    [ServiceMessage] NVARCHAR(MAX) NULL,
    [ServiceBeneficaryName] NVARCHAR(MAX) NULL,
    [ServiceSuccess] NVARCHAR(MAX) NULL,
    [CrtAt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_imps_11dec024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_imps_11dec024]
(
    [Id] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [IFSR] NVARCHAR(50) NULL,
    [AccNo] NVARCHAR(50) NULL,
    [CrtBy] NVARCHAR(50) NULL,
    [ServiceMessage] NVARCHAR(MAX) NULL,
    [ServiceBeneficaryName] NVARCHAR(MAX) NULL,
    [ServiceSuccess] NVARCHAR(MAX) NULL,
    [CrtAt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_imps_30jan2026
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_imps_30jan2026]
(
    [Id] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [IFSR] NVARCHAR(50) NULL,
    [AccNo] NVARCHAR(50) NULL,
    [CrtBy] NVARCHAR(50) NULL,
    [ServiceMessage] NVARCHAR(MAX) NULL,
    [ServiceBeneficaryName] NVARCHAR(MAX) NULL,
    [ServiceSuccess] NVARCHAR(MAX) NULL,
    [CrtAt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_INHOUSE_PII_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_INHOUSE_PII_MASTER]
(
    [SERVER] NVARCHAR(255) NULL,
    [INHOUSE_OBJECT] NVARCHAR(255) NULL,
    [TYPEDESC] NVARCHAR(255) NULL,
    [INHOUSE_DB] NVARCHAR(255) NULL,
    [KYC_DB] NVARCHAR(255) NULL,
    [TABLENAME] NVARCHAR(255) NULL,
    [Remark] NVARCHAR(255) NULL,
    [Assign] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IPartner_SB_Manager_Contact_Details_BEENXT_18dec2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IPartner_SB_Manager_Contact_Details_BEENXT_18dec2025]
(
    [SBCode] VARCHAR(100) NULL,
    [Zone] VARCHAR(100) NULL,
    [Region] VARCHAR(100) NULL,
    [Branch] VARCHAR(100) NULL,
    [CSO_B2B_Manager_Name] VARCHAR(100) NULL,
    [CSO_B2B_Manager_Emp_Code] VARCHAR(100) NULL,
    [CSO_B2B_Manager_Email_ID] VARCHAR(100) NULL,
    [CSO_B2B_Manager_Mobile_No] VARCHAR(100) NULL,
    [BM_CM_Name_Angel] VARCHAR(100) NULL,
    [BMEmpCode] VARCHAR(100) NULL,
    [BM_Mobile_No] VARCHAR(100) NULL,
    [BM_Email_ID] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_KYC_PII
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_KYC_PII]
(
    [DBNAM] VARCHAR(50) NULL,
    [TBLNAME] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_LEAFLET_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_LEAFLET_tobedeleted]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [PURPOSEID] INT NULL,
    [BMID] VARCHAR(20) NULL,
    [SBID] VARCHAR(20) NULL,
    [PARTNERTAG] VARCHAR(50) NULL,
    [PARTNARNAME] VARCHAR(200) NULL,
    [LANDLINENUM] VARBINARY(8000) NULL,
    [MOBILENUM] VARBINARY(8000) NULL,
    [EMAIL] VARBINARY(8000) NULL,
    [ADDRESS] VARBINARY(8000) NULL,
    [LEAFLET] VARCHAR(500) NULL,
    [PARTICULARS] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MailClient_NOCV
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MailClient_NOCV]
(
    [SRNO] INT NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(50) NULL,
    [EmailId] VARCHAR(50) NULL,
    [ClientLedger] VARCHAR(50) NULL,
    [Existing_SubBroker] VARCHAR(50) NULL,
    [Existing_Branch] VARCHAR(50) NULL,
    [New_SubBroker] VARCHAR(50) NULL,
    [New_Branch] VARCHAR(50) NULL,
    [IsApprove] VARCHAR(50) NULL,
    [Remarks] VARCHAR(500) NULL,
    [Access_to] VARCHAR(50) NULL,
    [Access_Code] VARCHAR(50) NULL,
    [Insert_On] DATETIME NULL,
    [Update_Date] DATETIME NULL,
    [48hr_insertDate] DATETIME NULL,
    [B2B_B2C] VARCHAR(20) NULL,
    [Link_Update_Date] DATETIME NULL,
    [ReasonForShifting] VARCHAR(100) NULL,
    [Source] VARCHAR(50) NULL,
    [ActiveCLI] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_manualbill_mark_05Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_manualbill_mark_05Nov2025]
(
    [Partycode] VARCHAR(20) NULL,
    [PartyName] VARCHAR(200) NULL,
    [PayoutType] VARCHAR(1) NULL,
    [BseMarked] MONEY NULL,
    [NseMarked] MONEY NULL,
    [NsefoMarked] MONEY NULL,
    [McxMarked] MONEY NULL,
    [NcdexMarked] MONEY NULL,
    [McdMarked] MONEY NULL,
    [NsxMarked] MONEY NULL,
    [Status] VARCHAR(10) NULL,
    [Remarks] VARCHAR(1000) NULL,
    [UpdatedBy] VARCHAR(200) NULL,
    [UpdatedOn] DATETIME NULL,
    [srno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MEETINGSCHEDULE_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MEETINGSCHEDULE_tobedeleted]
(
    [BMID] VARCHAR(50) NULL,
    [SBCODE] VARCHAR(50) NULL,
    [SBNAME] VARCHAR(200) NULL,
    [SBADDRESS] VARBINARY(8000) NULL,
    [PLANDATE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_ADDRESS_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_ADDRESS_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [ENTRYID] INT NOT NULL,
    [ADDRESS1] VARCHAR(MAX) NULL,
    [ADDRESS2] VARCHAR(MAX) NULL,
    [ADDRESS3] VARCHAR(200) NULL,
    [AREA] VARCHAR(50) NULL,
    [CITY] VARCHAR(50) NULL,
    [EMAIL] VARCHAR(MAX) NULL,
    [MOBILE] VARCHAR(MAX) NULL,
    [PHONE] VARCHAR(50) NULL,
    [PIN] VARCHAR(50) NULL,
    [STATE] VARCHAR(50) NULL,
    [STD] VARCHAR(50) NULL,
    [ISPERMANENT] BIT NULL,
    [AddedOn] DATETIME NULL,
    [modifiedOn] DATETIME NULL,
    [IsSameAsAadhaar] BIT NULL,
    [IsSameAsPermanent] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_ADDRESS_ARCHIVAL_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_ADDRESS_ARCHIVAL_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [ADDRESSID] INT NOT NULL,
    [ENTRYID] INT NOT NULL,
    [ADDRESS1] VARCHAR(MAX) NULL,
    [ADDRESS2] VARCHAR(MAX) NULL,
    [ADDRESS3] VARCHAR(200) NULL,
    [AREA] VARCHAR(50) NULL,
    [CITY] VARCHAR(50) NULL,
    [EMAIL] VARCHAR(MAX) NULL,
    [MOBILE] VARCHAR(MAX) NULL,
    [PHONE] VARCHAR(50) NULL,
    [PIN] VARCHAR(50) NULL,
    [STATE] VARCHAR(50) NULL,
    [STD] VARCHAR(50) NULL,
    [ISPERMANENT] BIT NULL,
    [AddedOn] DATETIME NULL,
    [modifiedOn] DATETIME NULL,
    [IsSameAsAadhaar] BIT NULL,
    [IsSameAsPermanent] BIT NULL,
    [ArchivalDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_BANKDETAILS_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_BANKDETAILS_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [ENTRYID] INT NULL,
    [ACCOUNTNO] VARCHAR(MAX) NULL,
    [ACCOUNTTYPE] VARCHAR(10) NULL,
    [ADDRESS] VARCHAR(MAX) NULL,
    [BANKNAME] VARCHAR(100) NULL,
    [BRANCH] VARCHAR(50) NULL,
    [IFSCRGTS] VARCHAR(50) NULL,
    [MICR] VARCHAR(50) NULL,
    [NAMEINBANK] VARCHAR(100) NULL,
    [AddedOn] DATETIME NULL,
    [modifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_BANKDETAILS_ARCHIVAL_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_BANKDETAILS_ARCHIVAL_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [BANKID] INT NOT NULL,
    [ENTRYID] INT NULL,
    [ACCOUNTNO] VARCHAR(MAX) NULL,
    [ACCOUNTTYPE] VARCHAR(10) NULL,
    [ADDRESS] VARCHAR(MAX) NULL,
    [BANKNAME] VARCHAR(100) NULL,
    [BRANCH] VARCHAR(MAX) NULL,
    [IFSCRGTS] VARCHAR(50) NULL,
    [MICR] VARCHAR(50) NULL,
    [NAMEINBANK] VARCHAR(100) NULL,
    [AddedOn] DATETIME NULL,
    [modifiedOn] DATETIME NULL,
    [ArchivalDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_BASICDETAILS_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_BASICDETAILS_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [ENTRYID] INT NULL,
    [Salutation] VARCHAR(20) NULL,
    [FIRSTNAME] VARCHAR(100) NULL,
    [MIDDLENAME] VARCHAR(100) NULL,
    [LASTNAME] VARCHAR(100) NULL,
    [MobileNO] VARCHAR(MAX) NULL,
    [EmailID] VARCHAR(MAX) NULL,
    [OrganizationType] VARCHAR(100) NULL,
    [TradeName] VARCHAR(500) NULL,
    [Photo] VARCHAR(MAX) NULL,
    [AddedOn] DATETIME NULL,
    [ModifiedOn] DATETIME NULL,
    [martialStatus] VARCHAR(50) NULL,
    [Gender] VARCHAR(50) NULL,
    [BranchTag] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_BASICDETAILS_ARCHIVAL_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_BASICDETAILS_ARCHIVAL_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [BASICID] INT NOT NULL,
    [ENTRYID] INT NULL,
    [Salutation] VARCHAR(20) NULL,
    [FIRSTNAME] VARCHAR(100) NULL,
    [MIDDLENAME] VARCHAR(100) NULL,
    [LASTNAME] VARCHAR(100) NULL,
    [MobileNO] VARCHAR(MAX) NULL,
    [EmailID] VARCHAR(MAX) NULL,
    [OrganizationType] VARCHAR(100) NULL,
    [TradeName] VARCHAR(500) NULL,
    [Photo] VARCHAR(MAX) NULL,
    [AddedOn] DATETIME NULL,
    [ModifiedOn] DATETIME NULL,
    [martialStatus] VARCHAR(50) NULL,
    [Gender] VARCHAR(50) NULL,
    [BranchTag] VARCHAR(20) NULL,
    [ArchivalDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_IDENTITYDETAILS_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_IDENTITYDETAILS_04Aug2025]
(
    [ENTRYID] INT IDENTITY(1,1) NOT NULL,
    [DOB] VARCHAR(MAX) NULL,
    [PAN] VARCHAR(MAX) NULL,
    [ISAPPROVED] INT NULL,
    [ENTRY_DATE] DATETIME NULL,
    [ENTRYBY] VARCHAR(50) NULL,
    [MODIFY_DATE] DATETIME NULL,
    [MODIFY_BY] VARCHAR(50) NULL,
    [APPROVE_DATE] DATETIME NULL,
    [APPROVE_BY] VARCHAR(50) NULL,
    [Remark] VARCHAR(5000) NULL,
    [IsInhouseIntegrated] INT NULL,
    [RefNo] NUMERIC(18, 0) NULL,
    [SBTag] VARCHAR(100) NULL,
    [AadharVaultKey] VARCHAR(500) NULL,
    [U_ID] VARCHAR(15) NULL,
    [PANName] VARCHAR(500) NULL,
    [IsOnlineEntry] BIT NULL,
    [AadharName] VARCHAR(250) NULL,
    [IsAadhaar] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_IDENTITYDETAILS_05Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_IDENTITYDETAILS_05Aug2025]
(
    [ENTRYID] INT IDENTITY(1,1) NOT NULL,
    [DOB] VARCHAR(100) NULL,
    [PAN] VARCHAR(100) NULL,
    [ISAPPROVED] INT NULL,
    [ENTRY_DATE] DATETIME NULL,
    [ENTRYBY] VARCHAR(50) NULL,
    [MODIFY_DATE] DATETIME NULL,
    [MODIFY_BY] VARCHAR(50) NULL,
    [APPROVE_DATE] DATETIME NULL,
    [APPROVE_BY] VARCHAR(50) NULL,
    [Remark] VARCHAR(5000) NULL,
    [IsInhouseIntegrated] INT NULL,
    [RefNo] NUMERIC(18, 0) NULL,
    [SBTag] VARCHAR(100) NULL,
    [AadharVaultKey] VARCHAR(500) NULL,
    [U_ID] VARCHAR(15) NULL,
    [PANName] VARCHAR(500) NULL,
    [IsOnlineEntry] BIT NULL,
    [AadharName] VARCHAR(250) NULL,
    [IsAadhaar] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_IDENTITYDETAILS_ARCHIVAL_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_IDENTITYDETAILS_ARCHIVAL_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [ENTRYID] INT NOT NULL,
    [DOB] VARCHAR(MAX) NULL,
    [PAN] VARCHAR(MAX) NULL,
    [ISAPPROVED] INT NULL,
    [ENTRY_DATE] DATETIME NULL,
    [ENTRYBY] VARCHAR(50) NULL,
    [MODIFY_DATE] DATETIME NULL,
    [MODIFY_BY] VARCHAR(50) NULL,
    [APPROVE_DATE] DATETIME NULL,
    [APPROVE_BY] VARCHAR(50) NULL,
    [Remark] VARCHAR(5000) NULL,
    [IsInhouseIntegrated] INT NULL,
    [RefNo] NUMERIC(18, 0) NULL,
    [SBTag] VARCHAR(100) NULL,
    [AadharVaultKey] VARCHAR(500) NULL,
    [U_ID] VARCHAR(15) NULL,
    [PANName] VARCHAR(500) NULL,
    [ArchivalDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_LS_ARN_EUINS_DUST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_LS_ARN_EUINS_DUST]
(
    [SR NO] VARCHAR(100) NULL,
    [SB EQUITY TAG] VARCHAR(100) NULL,
    [SB NAME] VARCHAR(100) NULL,
    [ARN NO] VARCHAR(100) NULL,
    [ARN HOLDER NAME] VARCHAR(100) NULL,
    [VALIDITY FROM] VARCHAR(100) NULL,
    [VALIDITY TO] VARCHAR(100) NULL,
    [EUIN NO] VARCHAR(100) NULL,
    [SIF_VALIDITY_FROM] VARCHAR(100) NULL,
    [SIF_VALIDITY_TO] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_NomineeDetails_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_NomineeDetails_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [EntryId] INT NULL,
    [FirstName] VARCHAR(100) NULL,
    [MiddleName] VARCHAR(100) NULL,
    [LastName] VARCHAR(100) NULL,
    [DOB] VARCHAR(MAX) NULL,
    [PanNumber] VARCHAR(MAX) NULL,
    [AddressLine1] VARCHAR(MAX) NULL,
    [AddressLine2] VARCHAR(MAX) NULL,
    [AddressLine3] VARCHAR(MAX) NULL,
    [State] VARCHAR(200) NULL,
    [City] VARCHAR(100) NULL,
    [Pincode] VARCHAR(100) NULL,
    [RelationShip] VARCHAR(100) NULL,
    [GuardianFname] VARCHAR(100) NULL,
    [GuardianMname] VARCHAR(100) NULL,
    [GuardianLname] VARCHAR(100) NULL,
    [GuardianDOB] VARCHAR(100) NULL,
    [GuardianPAN] VARCHAR(100) NULL,
    [GuardianAddressLine1] VARCHAR(700) NULL,
    [GuardianAddressLine2] VARCHAR(700) NULL,
    [GuardianAddressLine3] VARCHAR(700) NULL,
    [GuardianState] VARCHAR(200) NULL,
    [GuardianCity] VARCHAR(200) NULL,
    [GuardianPincode] VARCHAR(100) NULL,
    [AddedOn] DATETIME NULL,
    [ModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_NomineeDetails_Archival_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_NomineeDetails_Archival_04Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [NomineeID] INT NOT NULL,
    [EntryId] INT NULL,
    [FirstName] VARCHAR(100) NULL,
    [MiddleName] VARCHAR(100) NULL,
    [LastName] VARCHAR(100) NULL,
    [DOB] VARCHAR(MAX) NULL,
    [PanNumber] VARCHAR(MAX) NULL,
    [AddressLine1] VARCHAR(MAX) NULL,
    [AddressLine2] VARCHAR(MAX) NULL,
    [AddressLine3] VARCHAR(700) NULL,
    [State] VARCHAR(200) NULL,
    [City] VARCHAR(100) NULL,
    [Pincode] VARCHAR(100) NULL,
    [RelationShip] VARCHAR(100) NULL,
    [GuardianFname] VARCHAR(100) NULL,
    [GuardianMname] VARCHAR(100) NULL,
    [GuardianLname] VARCHAR(100) NULL,
    [GuardianDOB] VARCHAR(100) NULL,
    [GuardianPAN] VARCHAR(100) NULL,
    [GuardianAddressLine1] VARCHAR(700) NULL,
    [GuardianAddressLine2] VARCHAR(700) NULL,
    [GuardianAddressLine3] VARCHAR(700) NULL,
    [GuardianState] VARCHAR(200) NULL,
    [GuardianCity] VARCHAR(200) NULL,
    [GuardianPincode] VARCHAR(100) NULL,
    [AddedOn] DATETIME NULL,
    [ModifiedOn] DATETIME NULL,
    [ArchivalDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MF_REGISTRATIONRELATED_01Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MF_REGISTRATIONRELATED_01Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [ENTRYID] INT NULL,
    [AADHAARNO] VARCHAR(MAX) NULL,
    [EDUQUALI] VARCHAR(200) NULL,
    [OTHERQUALI] VARCHAR(200) NULL,
    [OCCUPATION] VARCHAR(200) NULL,
    [NATUREOFOCCUPATION] VARCHAR(200) NULL,
    [OTHEROCCUPATION] VARCHAR(200) NULL,
    [CAPITALMARKET] VARCHAR(200) NULL,
    [OTHEREXPERIENCE] VARCHAR(200) NULL,
    [PREBROKER] VARCHAR(200) NULL,
    [AUTHPERSON] VARCHAR(50) NULL,
    [WHETHERANY] VARCHAR(50) NULL,
    [MEMBERSHIPDETAILS] VARCHAR(200) NULL,
    [TRADINGACC] VARCHAR(50) NULL,
    [FATHERHUSBAND] VARCHAR(50) NULL,
    [contactPerson] VARCHAR(200) NULL,
    [contactPersonOccupation] VARCHAR(200) NULL,
    [CONTRACTSIGNATORY] VARCHAR(200) NULL,
    [AddedOn] DATETIME NULL,
    [modifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MFSB_AadharData_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MFSB_AadharData_04Aug2025]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [EntryId] BIGINT NULL,
    [IpAddress] VARCHAR(50) NULL,
    [AuthType] VARCHAR(15) NULL,
    [Name] VARCHAR(150) NULL,
    [FirstName] VARCHAR(50) NULL,
    [MiddleName] VARCHAR(50) NULL,
    [LastName] VARCHAR(50) NULL,
    [Address] VARCHAR(MAX) NULL,
    [AddressLine1] VARCHAR(MAX) NULL,
    [AddressLine2] VARCHAR(MAX) NULL,
    [AddressLine3] VARCHAR(250) NULL,
    [State] VARCHAR(50) NULL,
    [City] VARCHAR(50) NULL,
    [PinCode] VARCHAR(12) NULL,
    [Dob] VARCHAR(MAX) NULL,
    [Gender] VARCHAR(15) NULL,
    [Photo] VARCHAR(MAX) NULL,
    [CreateDate] DATETIME NULL,
    [ModifiedDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MFSB_Otp_01Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MFSB_Otp_01Aug2025]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [Mobile] VARCHAR(MAX) NULL,
    [Otp] VARCHAR(10) NULL,
    [Source] VARCHAR(30) NULL,
    [CreatedAt] DATETIME NULL,
    [UpdatedAt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MFSB_Registration_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MFSB_Registration_04Aug2025]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [Pan] VARCHAR(MAX) NULL,
    [Mobile] VARCHAR(MAX) NULL,
    [IsARN] VARCHAR(1) NULL,
    [ARNName] VARCHAR(100) NULL,
    [DeviceId] VARCHAR(25) NULL,
    [ReferralTag] VARCHAR(12) NULL,
    [SbTag] VARCHAR(12) NULL,
    [Url] VARCHAR(12) NULL,
    [SessionKey] VARCHAR(500) NULL,
    [CreatedDate] DATETIME NULL,
    [ModifyDate] DATETIME NULL,
    [EntryID] INT NULL,
    [ReferralSource] VARCHAR(50) NULL,
    [Version] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MFSB_Registration_Archival_04Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MFSB_Registration_Archival_04Aug2025]
(
    [Id] BIGINT IDENTITY(1,1) NOT NULL,
    [RegistrationId] BIGINT NOT NULL,
    [Pan] VARCHAR(MAX) NULL,
    [Mobile] VARCHAR(MAX) NULL,
    [IsARN] VARCHAR(1) NULL,
    [ARNName] VARCHAR(100) NULL,
    [DeviceId] VARCHAR(25) NULL,
    [ReferralTag] VARCHAR(12) NULL,
    [SbTag] VARCHAR(12) NULL,
    [Url] VARCHAR(12) NULL,
    [SessionKey] VARCHAR(500) NULL,
    [CreatedDate] DATETIME NULL,
    [ModifyDate] DATETIME NULL,
    [EntryID] INT NULL,
    [ArchivalDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NOC_Process_Heading
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NOC_Process_Heading]
(
    [Update_Date] VARCHAR(20) NULL,
    [ClientCode] VARCHAR(50) NULL,
    [Existing_Branch] VARCHAR(50) NULL,
    [Existing_SubBroker] VARCHAR(50) NULL,
    [New_Branch] VARCHAR(50) NULL,
    [New_SubBroker] VARCHAR(50) NULL,
    [Remarks] VARCHAR(500) NULL,
    [From] VARCHAR(50) NULL,
    [CodeAdded] VARCHAR(25) NULL,
    [ClientType] VARCHAR(20) NULL,
    [Clientstatus] VARCHAR(20) NULL,
    [PropCode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NOC_Process_Heading_MF
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NOC_Process_Heading_MF]
(
    [Update_Date] VARCHAR(20) NULL,
    [ClientCode] VARCHAR(50) NULL,
    [Existing_Branch] VARCHAR(50) NULL,
    [Existing_SubBroker] VARCHAR(50) NULL,
    [New_Branch] VARCHAR(50) NULL,
    [New_SubBroker] VARCHAR(50) NULL,
    [Remarks] VARCHAR(500) NULL,
    [From] VARCHAR(50) NULL,
    [CodeAdded] VARCHAR(25) NULL,
    [ClientType] VARCHAR(20) NULL,
    [ClientStatus] VARCHAR(20) NULL,
    [PropCode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NOCstatusLOGS
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NOCstatusLOGS]
(
    [SRNO_old] NUMERIC(18, 0) NULL,
    [NOC_ID] VARCHAR(20) NULL,
    [IsApprove] VARCHAR(20) NULL,
    [UpdatedDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [source] VARCHAR(20) NULL,
    [SRNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NOCstatusLOGS_05Aug2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NOCstatusLOGS_05Aug2024]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [NOC_ID] VARCHAR(20) NULL,
    [IsApprove] VARCHAR(20) NULL,
    [UpdatedDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [source] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NOCstatusLOGS_06aug2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NOCstatusLOGS_06aug2024]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [NOC_ID] VARCHAR(20) NULL,
    [IsApprove] VARCHAR(20) NULL,
    [UpdatedDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [source] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NOCstatusLOGS_17sep2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NOCstatusLOGS_17sep2024]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [NOC_ID] VARCHAR(20) NULL,
    [IsApprove] VARCHAR(20) NULL,
    [UpdatedDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [source] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NOCstatusLOGS_26apr2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NOCstatusLOGS_26apr2024]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [NOC_ID] VARCHAR(20) NULL,
    [IsApprove] VARCHAR(20) NULL,
    [UpdatedDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [source] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NOCstatusLOGS_28jun2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NOCstatusLOGS_28jun2024]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [NOC_ID] VARCHAR(20) NULL,
    [IsApprove] VARCHAR(20) NULL,
    [UpdatedDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [source] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NRIBankMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NRIBankMaster]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_BankName] VARCHAR(50) NULL,
    [Fld_Segment] VARCHAR(50) NULL,
    [Fld_BankPISAc] VARCHAR(50) NULL,
    [Fld_AngelAcc] VARCHAR(50) NULL,
    [Fld_BranchLocation] VARCHAR(50) NULL,
    [Fld_Bankcode] VARCHAR(10) NULL,
    [Fld_Username] VARCHAR(20) NULL,
    [Fld_Date] DATETIME NULL,
    [Fld_bankcode_Payin] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NRIBankMaster_BKP_30SEP2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NRIBankMaster_BKP_30SEP2025]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_BankName] VARCHAR(50) NULL,
    [Fld_Segment] VARCHAR(50) NULL,
    [Fld_BankPISAc] VARCHAR(50) NULL,
    [Fld_AngelAcc] VARCHAR(50) NULL,
    [Fld_BranchLocation] VARCHAR(50) NULL,
    [Fld_Bankcode] VARCHAR(10) NULL,
    [Fld_Username] VARCHAR(20) NULL,
    [Fld_Date] DATETIME NULL,
    [Fld_bankcode_Payin] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NRIClientMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NRIClientMaster]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_ClientCode] VARCHAR(20) NULL,
    [Fld_BankId] INT NULL,
    [Fld_ClientPISAc] VARCHAR(20) NULL,
    [Fld_FromDate] DATETIME NULL,
    [Fld_ToDate] DATETIME NULL,
    [fld_CustodianAccno] VARCHAR(15) NULL,
    [Fld_status_NRI_PIO] VARCHAR(10) NULL,
    [Fld_Dp_Name] VARCHAR(50) NULL,
    [Fld_DematAcNo] VARCHAR(25) NULL,
    [Fld_Intersettlementban] CHAR(1) NULL,
    [Fld_Status_PIS_NON_PIS] VARCHAR(10) NULL,
    [Fld_BankAcno] VARCHAR(25) NULL,
    [Fld_NREACNO] VARCHAR(50) NULL,
    [Fld_NROACNO] VARCHAR(50) NULL,
    [Fld_NROPISNO] VARCHAR(20) NULL,
    [Fld_Countryofresidence] VARCHAR(100) NULL,
    [Fld_Custodiancode] VARCHAR(20) NULL,
    [Fld_Custodianname] VARCHAR(50) NULL,
    [RBI_RefNo] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NRIClientMaster_BKP_30SEP2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NRIClientMaster_BKP_30SEP2025]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_ClientCode] VARCHAR(20) NULL,
    [Fld_BankId] INT NULL,
    [Fld_ClientPISAc] VARCHAR(20) NULL,
    [Fld_FromDate] DATETIME NULL,
    [Fld_ToDate] DATETIME NULL,
    [fld_CustodianAccno] VARCHAR(15) NULL,
    [Fld_status_NRI_PIO] VARCHAR(10) NULL,
    [Fld_Dp_Name] VARCHAR(50) NULL,
    [Fld_DematAcNo] VARCHAR(25) NULL,
    [Fld_Intersettlementban] CHAR(1) NULL,
    [Fld_Status_PIS_NON_PIS] VARCHAR(10) NULL,
    [Fld_BankAcno] VARCHAR(25) NULL,
    [Fld_NREACNO] VARCHAR(50) NULL,
    [Fld_NROACNO] VARCHAR(50) NULL,
    [Fld_NROPISNO] VARCHAR(20) NULL,
    [Fld_Countryofresidence] VARCHAR(100) NULL,
    [Fld_Custodiancode] VARCHAR(20) NULL,
    [Fld_Custodianname] VARCHAR(50) NULL,
    [RBI_RefNo] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_NRO_NONPIS_CLIENTMASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_NRO_NONPIS_CLIENTMASTER]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_ClientCode] VARCHAR(20) NULL,
    [Fld_BankId] INT NULL,
    [Fld_ClientPISAc] VARCHAR(20) NULL,
    [Fld_FromDate] DATETIME NULL,
    [Fld_ToDate] DATETIME NULL,
    [fld_CustodianAccno] VARCHAR(15) NULL,
    [Fld_status_NRI_PIO] VARCHAR(10) NULL,
    [Fld_Dp_Name] VARCHAR(50) NULL,
    [Fld_DematAcNo] VARCHAR(25) NULL,
    [Fld_Intersettlementban] CHAR(1) NULL,
    [Fld_Status_PIS_NON_PIS] VARCHAR(10) NULL,
    [Fld_BankAcno] VARCHAR(25) NULL,
    [Fld_NREACNO] VARCHAR(50) NULL,
    [Fld_NROACNO] VARCHAR(50) NULL,
    [Fld_NROPISNO] VARCHAR(20) NULL,
    [Fld_Countryofresidence] VARCHAR(100) NULL,
    [Fld_Custodiancode] VARCHAR(20) NULL,
    [Fld_Custodianname] VARCHAR(50) NULL,
    [RBI_RefNo] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_OFS_BATCH
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_OFS_BATCH]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [scrip] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [filename] VARCHAR(100) NULL,
    [batchnum] INT NULL,
    [recordcount] INT NULL,
    [createdon] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ONES_QuestionPapers_NewFormatBGSir
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ONES_QuestionPapers_NewFormatBGSir]
(
    [QNo] VARCHAR(10) NULL,
    [QuestionText] NVARCHAR(4000) NULL,
    [QuestionImg] VARBINARY(MAX) NULL,
    [QuestionImgFormat] VARCHAR(25) NULL,
    [Op1] NVARCHAR(4000) NULL,
    [Op1Img] VARBINARY(MAX) NULL,
    [Op1ImgFormat] VARCHAR(25) NULL,
    [Op2] NVARCHAR(4000) NULL,
    [Op2Img] VARBINARY(MAX) NULL,
    [Op2ImgFormat] VARCHAR(25) NULL,
    [Op3] NVARCHAR(4000) NULL,
    [Op3Img] VARBINARY(MAX) NULL,
    [Op3ImgFormat] VARCHAR(25) NULL,
    [Op4] NVARCHAR(4000) NULL,
    [Op4Img] VARBINARY(MAX) NULL,
    [Op4ImgFormat] VARCHAR(25) NULL,
    [Answer] NVARCHAR(4000) NULL,
    [AnswerImg] VARBINARY(MAX) NULL,
    [AnswerImgFormat] VARCHAR(25) NULL,
    [Marks] NVARCHAR(50) NULL,
    [Unit] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_OTB_ScripMaster_arc
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_OTB_ScripMaster_arc]
(
    [Sr] INT IDENTITY(1,1) NOT NULL,
    [Symbol] VARCHAR(100) NULL,
    [BSE_Code] VARCHAR(100) NULL,
    [Rate] DECIMAL(18, 2) NULL,
    [Settlement_No] VARCHAR(30) NULL,
    [NSE_Symbol] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_other_debit
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_other_debit]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [OTHER_DEBIT] MONEY NULL,
    [Update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_other_debit_05Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_other_debit_05Aug2025]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [OTHER_DEBIT] MONEY NULL,
    [Update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_OTHER_DEBIT_20Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_OTHER_DEBIT_20Aug2025]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [OTHER_DEBIT] MONEY NULL,
    [Update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_other_debit_MTF_unpledge_28Jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_other_debit_MTF_unpledge_28Jul2025]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [OTHER_DEBIT] MONEY NULL,
    [Update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_otherdebit_chargeswise
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_otherdebit_chargeswise]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [CHARGES_CODE] INT NULL,
    [CHARGES_AMT] MONEY NULL,
    [CHARGES_NAME] VARCHAR(100) NULL,
    [upd_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_otherdebit_chargeswise_20Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_otherdebit_chargeswise_20Aug2025]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [CHARGES_CODE] INT NULL,
    [CHARGES_AMT] MONEY NULL,
    [CHARGES_NAME] VARCHAR(100) NULL,
    [upd_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RealPayout_Producer_21May2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RealPayout_Producer_21May2025]
(
    [Paymode] VARCHAR(20) NULL,
    [acno] VARCHAR(30) NULL,
    [bankname] VARCHAR(50) NULL,
    [poid] VARCHAR(20) NULL,
    [UpdateOn] DATETIME NULL,
    [SegApprovedAmt] MONEY NULL,
    [party_code] VARCHAR(50) NULL,
    [segment] VARCHAR(10) NULL,
    [req_refno] VARCHAR(50) NULL,
    [VerifierId] INT NULL,
    [batchid] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_REGISTRATIONRELATED_01Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_REGISTRATIONRELATED_01Aug2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [ENTRYID] INT NULL,
    [AADHAARNO] VARCHAR(MAX) NULL,
    [EDUQUALI] VARCHAR(200) NULL,
    [OTHERQUALI] VARCHAR(200) NULL,
    [OCCUPATION] VARCHAR(200) NULL,
    [NATUREOFOCCUPATION] VARCHAR(200) NULL,
    [OTHEROCCUPATION] VARCHAR(200) NULL,
    [CAPITALMARKET] VARCHAR(200) NULL,
    [OTHEREXPERIENCE] VARCHAR(200) NULL,
    [PREBROKER] VARCHAR(200) NULL,
    [AUTHPERSON] VARCHAR(50) NULL,
    [WHETHERANY] VARCHAR(50) NULL,
    [MEMBERSHIPDETAILS] VARCHAR(200) NULL,
    [TRADINGACC] VARCHAR(50) NULL,
    [FATHERHUSBAND] VARCHAR(50) NULL,
    [contactPerson] VARCHAR(200) NULL,
    [contactPersonOccupation] VARCHAR(200) NULL,
    [CONTRACTSIGNATORY] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_report_24Oct2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_report_24Oct2024]
(
    [Rpt_srno] INT IDENTITY(1,1) NOT NULL,
    [Rpt_ServerName] VARCHAR(100) NULL,
    [Rpt_Username] VARCHAR(100) NULL,
    [Rpt_Pswd] VARCHAR(100) NULL,
    [Rpt_DatabaseName] VARCHAR(100) NULL,
    [Rpt_QueryName] VARCHAR(100) NULL,
    [Rpt_Parameter] VARCHAR(150) NULL,
    [Rpt_Title] VARCHAR(200) NULL,
    [Rpt_ComputeColNo] VARCHAR(100) NULL,
    [Rpt_Paging] INT NULL,
    [Rpt_WithSrno] INT NULL,
    [FooterNote] VARCHAR(1000) NULL,
    [AddedBy] VARCHAR(100) NULL,
    [AddedOn] DATETIME NULL,
    [MachineIP] VARCHAR(100) NULL,
    [ColHide] VARCHAR(25) NULL,
    [RowColor] VARCHAR(25) NULL,
    [TableHead] VARCHAR(8000) NULL,
    [FooterNote1] VARCHAR(1000) NULL,
    [ReportHead] VARCHAR(500) NULL,
    [Rpt_ExportOnly] VARCHAR(1) NULL,
    [ColFreeze] INT NULL,
    [ColBold] INT NULL,
    [TitleFromQuery] VARCHAR(1) NULL,
    [RecordToDisplay] VARCHAR(1000) NULL,
    [Rpt_opt] VARCHAR(9) NULL,
    [helppage] VARCHAR(100) NULL,
    [RptInfo] VARCHAR(100) NULL,
    [ColColour] VARCHAR(20) NULL,
    [Delimiter] VARCHAR(10) NULL,
    [forExcel] BIT NULL,
    [forCSV] BIT NULL,
    [forPDF] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_RM_DUP_CODE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_RM_DUP_CODE]
(
    [RMCODE] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_clients_03Apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_clients_03Apr2025]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Party_Code] VARCHAR(15) NOT NULL,
    [Fld_RTGS_Sr_No] VARCHAR(15) NULL,
    [Fld_Bank_AcNo] VARCHAR(22) NOT NULL,
    [Fld_Status] VARCHAR(2) NOT NULL,
    [Fld_Docs_Recd] VARCHAR(2) NULL,
    [Fld_Entered_By] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(150) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(50) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Req_by] CHAR(1) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(15) NULL,
    [Fld_Type] VARCHAR(15) NULL,
    [Fld_Active_By] VARCHAR(15) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_clients_05Feb2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_clients_05Feb2025]
(
    [Fld_Sr_No] INT NOT NULL,
    [Fld_Party_Code] VARCHAR(15) NOT NULL,
    [Fld_RTGS_Sr_No] VARCHAR(15) NULL,
    [Fld_Bank_AcNo] VARCHAR(22) NOT NULL,
    [Fld_Status] VARCHAR(2) NOT NULL,
    [Fld_Docs_Recd] VARCHAR(2) NULL,
    [Fld_Entered_By] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(150) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(50) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Req_by] CHAR(1) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(15) NULL,
    [Fld_Type] VARCHAR(15) NULL,
    [Fld_Active_By] VARCHAR(15) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_clients_06Mar2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_clients_06Mar2025]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Party_Code] VARCHAR(15) NOT NULL,
    [Fld_RTGS_Sr_No] VARCHAR(15) NULL,
    [Fld_Bank_AcNo] VARCHAR(22) NOT NULL,
    [Fld_Status] VARCHAR(2) NOT NULL,
    [Fld_Docs_Recd] VARCHAR(2) NULL,
    [Fld_Entered_By] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(150) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(50) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Req_by] CHAR(1) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(15) NULL,
    [Fld_Type] VARCHAR(15) NULL,
    [Fld_Active_By] VARCHAR(15) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_clients_19Jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_clients_19Jan2025]
(
    [Fld_Sr_No] INT NOT NULL,
    [Fld_Party_Code] VARCHAR(15) NOT NULL,
    [Fld_RTGS_Sr_No] VARCHAR(15) NULL,
    [Fld_Bank_AcNo] VARCHAR(22) NOT NULL,
    [Fld_Status] VARCHAR(2) NOT NULL,
    [Fld_Docs_Recd] VARCHAR(2) NULL,
    [Fld_Entered_By] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(150) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(50) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Req_by] CHAR(1) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(15) NULL,
    [Fld_Type] VARCHAR(15) NULL,
    [Fld_Active_By] VARCHAR(15) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_clients_20Jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_clients_20Jan2025]
(
    [Fld_Sr_No] INT NOT NULL,
    [Fld_Party_Code] VARCHAR(15) NOT NULL,
    [Fld_RTGS_Sr_No] VARCHAR(15) NULL,
    [Fld_Bank_AcNo] VARCHAR(22) NOT NULL,
    [Fld_Status] VARCHAR(2) NOT NULL,
    [Fld_Docs_Recd] VARCHAR(2) NULL,
    [Fld_Entered_By] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(150) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(50) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Req_by] CHAR(1) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(15) NULL,
    [Fld_Type] VARCHAR(15) NULL,
    [Fld_Active_By] VARCHAR(15) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_clients_27Feb2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_clients_27Feb2025]
(
    [Fld_Sr_No] INT NOT NULL,
    [Fld_Party_Code] VARCHAR(15) NOT NULL,
    [Fld_RTGS_Sr_No] VARCHAR(15) NULL,
    [Fld_Bank_AcNo] VARCHAR(22) NOT NULL,
    [Fld_Status] VARCHAR(2) NOT NULL,
    [Fld_Docs_Recd] VARCHAR(2) NULL,
    [Fld_Entered_By] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(150) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(50) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Req_by] CHAR(1) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(15) NULL,
    [Fld_Type] VARCHAR(15) NULL,
    [Fld_Active_By] VARCHAR(15) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RTGS_Online_data
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RTGS_Online_data]
(
    [fld_party_code] VARCHAR(15) NOT NULL,
    [Fld_bank_Acno] VARCHAR(22) NOT NULL,
    [RTGSDefault] VARCHAR(15) NULL,
    [Bank_name] VARCHAR(20) NULL,
    [AccOnline_default] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RTGS_Online_data_05Feb2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RTGS_Online_data_05Feb2025]
(
    [fld_party_code] VARCHAR(15) NOT NULL,
    [Fld_bank_Acno] VARCHAR(22) NOT NULL,
    [RTGSDefault] VARCHAR(15) NULL,
    [RTGS_IFSC] VARCHAR(255) NOT NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Bank_name] VARCHAR(20) NULL,
    [accOnlineAcc] VARCHAR(20) NULL,
    [AccOnline_default] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RTGS_Online_data_27Feb2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RTGS_Online_data_27Feb2025]
(
    [fld_party_code] VARCHAR(15) NOT NULL,
    [Fld_bank_Acno] VARCHAR(22) NOT NULL,
    [RTGSDefault] VARCHAR(15) NULL,
    [RTGS_IFSC] VARCHAR(255) NOT NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Bank_name] VARCHAR(20) NULL,
    [accOnlineAcc] VARCHAR(20) NULL,
    [AccOnline_default] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RTGS_Online_data_27Feb2025_Notdeafult_in_RTGS
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RTGS_Online_data_27Feb2025_Notdeafult_in_RTGS]
(
    [fld_party_code] VARCHAR(15) NOT NULL,
    [Fld_bank_Acno] VARCHAR(22) NOT NULL,
    [RTGSDefault] VARCHAR(15) NULL,
    [RTGS_IFSC] VARCHAR(255) NOT NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Bank_name] VARCHAR(20) NULL,
    [accOnlineAcc] VARCHAR(20) NULL,
    [AccOnline_default] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_subbroker_02dec2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_subbroker_02dec2025]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Sub_Code] VARCHAR(50) NULL,
    [Fld_Segment] VARCHAR(100) NULL,
    [Fld_RTGS_Sr_No] VARCHAR(100) NULL,
    [Fld_Bank_AcNo] VARCHAR(100) NULL,
    [Fld_Status] VARCHAR(150) NULL,
    [Fld_Docs_Recd] VARCHAR(100) NULL,
    [Fld_Entered_By] VARCHAR(50) NULL,
    [Fld_Remark] VARCHAR(300) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(100) NULL,
    [Fld_Ip] VARCHAR(50) NULL,
    [Fld_Req_by] CHAR(10) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(150) NULL,
    [Fld_Type] VARCHAR(150) NULL,
    [Fld_Active_By] VARCHAR(100) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(150) NULL,
    [Fld_UniqueID] VARCHAR(150) NULL,
    [Fld_Deactive_Date] DATETIME NULL,
    [ChqImage] VARCHAR(50) NULL,
    [ChqAttach] VARBINARY(MAX) NULL,
    [OtherImage] VARCHAR(50) NULL,
    [OtherAttach] VARBINARY(MAX) NULL,
    [NameinBank] VARCHAR(500) NULL,
    [NameasperOracle] VARCHAR(500) NULL,
    [vendorNo] VARCHAR(50) NULL,
    [paymode] VARCHAR(20) NULL,
    [tradename] VARCHAR(500) NULL,
    [IFSC] VARCHAR(25) NULL,
    [bankname] VARCHAR(255) NULL,
    [MAKER] VARCHAR(100) NULL,
    [CHECKER] VARCHAR(100) NULL,
    [MICR] VARCHAR(100) NULL,
    [branchname] VARCHAR(200) NULL,
    [branchadd] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_subbroker_ADQR
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_subbroker_ADQR]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Sub_Code] VARCHAR(50) NULL,
    [Fld_Segment] VARCHAR(100) NULL,
    [Fld_RTGS_Sr_No] VARCHAR(100) NULL,
    [Fld_Bank_AcNo] VARCHAR(100) NULL,
    [Fld_Status] VARCHAR(150) NULL,
    [Fld_Docs_Recd] VARCHAR(100) NULL,
    [Fld_Entered_By] VARCHAR(50) NULL,
    [Fld_Remark] VARCHAR(300) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(100) NULL,
    [Fld_Ip] VARCHAR(50) NULL,
    [Fld_Req_by] CHAR(10) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(150) NULL,
    [Fld_Type] VARCHAR(150) NULL,
    [Fld_Active_By] VARCHAR(100) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(150) NULL,
    [Fld_UniqueID] VARCHAR(150) NULL,
    [Fld_Deactive_Date] DATETIME NULL,
    [ChqImage] VARCHAR(50) NULL,
    [ChqAttach] VARBINARY(MAX) NULL,
    [OtherImage] VARCHAR(50) NULL,
    [OtherAttach] VARBINARY(MAX) NULL,
    [NameinBank] VARCHAR(500) NULL,
    [NameasperOracle] VARCHAR(500) NULL,
    [vendorNo] VARCHAR(50) NULL,
    [paymode] VARCHAR(20) NULL,
    [tradename] VARCHAR(500) NULL,
    [IFSC] VARCHAR(25) NULL,
    [bankname] VARCHAR(255) NULL,
    [MAKER] VARCHAR(100) NULL,
    [CHECKER] VARCHAR(100) NULL,
    [MICR] VARCHAR(100) NULL,
    [branchname] VARCHAR(200) NULL,
    [branchadd] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_subbroker_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_subbroker_log]
(
    [Fld_Sr_No] INT NOT NULL,
    [Fld_Sub_Code] VARCHAR(50) NULL,
    [Fld_Segment] VARCHAR(100) NULL,
    [Fld_RTGS_Sr_No] VARCHAR(100) NULL,
    [Fld_Bank_AcNo] VARCHAR(100) NULL,
    [Fld_Status] VARCHAR(150) NULL,
    [Fld_Docs_Recd] VARCHAR(100) NULL,
    [Fld_Entered_By] VARCHAR(50) NULL,
    [Fld_Remark] VARCHAR(300) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(100) NULL,
    [Fld_Ip] VARCHAR(50) NULL,
    [Fld_Req_by] CHAR(10) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(150) NULL,
    [Fld_Type] VARCHAR(150) NULL,
    [Fld_Active_By] VARCHAR(100) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(150) NULL,
    [Fld_UniqueID] VARCHAR(150) NULL,
    [actiontype] VARCHAR(10) NULL,
    [ActionDate] DATETIME NOT NULL,
    [host] VARCHAR(20) NULL,
    [ipAddress] VARCHAR(20) NULL,
    [Fld_Deative_Date] DATETIME NULL,
    [ChqImage] VARCHAR(50) NULL,
    [ChqAttach] VARBINARY(MAX) NULL,
    [OtherImage] VARCHAR(50) NULL,
    [OtherAttach] VARBINARY(MAX) NULL,
    [NameinBank] VARCHAR(500) NULL,
    [NameasperOracle] VARCHAR(500) NULL,
    [vendorNo] VARCHAR(50) NULL,
    [paymode] VARCHAR(20) NULL,
    [tradename] VARCHAR(500) NULL,
    [IFSC] VARCHAR(25) NULL,
    [bankname] VARCHAR(255) NULL,
    [MAKER] VARCHAR(100) NULL,
    [CHECKER] VARCHAR(100) NULL,
    [MICR] VARCHAR(100) NULL,
    [branchname] VARCHAR(255) NULL,
    [branchadd] VARCHAR(255) NULL,
    [update_on] DATETIME NULL,
    [Action] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_RTGS_SUBBROKER_MFSB
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_RTGS_SUBBROKER_MFSB]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Sub_Code] VARCHAR(50) NULL,
    [Fld_Segment] VARCHAR(100) NULL,
    [Fld_RTGS_Sr_No] VARCHAR(100) NULL,
    [Fld_Bank_AcNo] VARCHAR(100) NULL,
    [Fld_Status] VARCHAR(150) NULL,
    [Fld_Docs_Recd] VARCHAR(100) NULL,
    [Fld_Entered_By] VARCHAR(50) NULL,
    [Fld_Remark] VARCHAR(300) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(100) NULL,
    [Fld_Ip] VARCHAR(50) NULL,
    [Fld_Req_by] CHAR(10) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(150) NULL,
    [Fld_Type] VARCHAR(150) NULL,
    [Fld_Active_By] VARCHAR(100) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(150) NULL,
    [Fld_UniqueID] VARCHAR(150) NULL,
    [Fld_Deactive_Date] DATETIME NULL,
    [ChqImage] VARCHAR(50) NULL,
    [ChqAttach] VARBINARY(MAX) NULL,
    [OtherImage] VARCHAR(50) NULL,
    [OtherAttach] VARBINARY(MAX) NULL,
    [NameinBank] VARCHAR(500) NULL,
    [NameasperOracle] VARCHAR(500) NULL,
    [vendorNo] VARCHAR(50) NULL,
    [paymode] VARCHAR(20) NULL,
    [tradename] VARCHAR(500) NULL,
    [IFSC] VARCHAR(25) NULL,
    [bankname] VARCHAR(255) NULL,
    [MAKER] VARCHAR(100) NULL,
    [CHECKER] VARCHAR(100) NULL,
    [MICR] VARCHAR(100) NULL,
    [branchname] VARCHAR(200) NULL,
    [branchadd] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rtgs_subbroker_MFSB_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rtgs_subbroker_MFSB_log]
(
    [Fld_Sr_No] INT NOT NULL,
    [Fld_Sub_Code] VARCHAR(50) NULL,
    [Fld_Segment] VARCHAR(100) NULL,
    [Fld_RTGS_Sr_No] VARCHAR(100) NULL,
    [Fld_Bank_AcNo] VARCHAR(100) NULL,
    [Fld_Status] VARCHAR(150) NULL,
    [Fld_Docs_Recd] VARCHAR(100) NULL,
    [Fld_Entered_By] VARCHAR(50) NULL,
    [Fld_Remark] VARCHAR(300) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Access_Code] VARCHAR(100) NULL,
    [Fld_Ip] VARCHAR(50) NULL,
    [Fld_Req_by] CHAR(10) NULL,
    [Fld_CSO_Docs_Recd] VARCHAR(150) NULL,
    [Fld_Type] VARCHAR(150) NULL,
    [Fld_Active_By] VARCHAR(100) NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Active_Ip] VARCHAR(150) NULL,
    [Fld_UniqueID] VARCHAR(150) NULL,
    [actiontype] VARCHAR(10) NULL,
    [ActionDate] DATETIME NOT NULL,
    [host] VARCHAR(20) NULL,
    [ipAddress] VARCHAR(20) NULL,
    [Fld_Deative_Date] DATETIME NULL,
    [ChqImage] VARCHAR(50) NULL,
    [ChqAttach] VARBINARY(MAX) NULL,
    [OtherImage] VARCHAR(50) NULL,
    [OtherAttach] VARBINARY(MAX) NULL,
    [NameinBank] VARCHAR(500) NULL,
    [NameasperOracle] VARCHAR(500) NULL,
    [vendorNo] VARCHAR(50) NULL,
    [paymode] VARCHAR(20) NULL,
    [tradename] VARCHAR(500) NULL,
    [IFSC] VARCHAR(25) NULL,
    [bankname] VARCHAR(255) NULL,
    [MAKER] VARCHAR(100) NULL,
    [CHECKER] VARCHAR(100) NULL,
    [MICR] VARCHAR(100) NULL,
    [branchname] VARCHAR(255) NULL,
    [branchadd] VARCHAR(255) NULL,
    [update_on] DATETIME NULL,
    [Action] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SB_ACCESSCONTROL_01Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SB_ACCESSCONTROL_01Aug2025]
(
    [USERID] VARCHAR(30) NULL,
    [USERTYPE] VARCHAR(30) NULL,
    [isdelete] INT NULL,
    [modifydate] DATETIME NULL,
    [modifyby] VARCHAR(50) NULL,
    [AddedBy] VARCHAR(50) NULL,
    [addedon] DATETIME NULL,
    [id] INT IDENTITY(1,1) NOT NULL,
    [aadhaar] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBAuditpdfLogs
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBAuditpdfLogs]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SbTag] VARCHAR(20) NULL,
    [Filepath] VARCHAR(200) NULL,
    [pdfdownloaddate] DATETIME NULL DEFAULT (getdate()),
    [pdfMailsent] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBAuditpdfLogs_28mar2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBAuditpdfLogs_28mar2025]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SbTag] VARCHAR(20) NULL,
    [Filepath] VARCHAR(200) NULL,
    [pdfdownloaddate] DATETIME NULL,
    [pdfMailsent] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SbContact_Detail_26Nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SbContact_Detail_26Nov2025]
(
    [pid] INT IDENTITY(1,1) NOT NULL,
    [Sb_Tag] VARCHAR(20) NULL,
    [Landline_No] VARCHAR(MAX) NULL,
    [Mobile_No] VARCHAR(20) NULL,
    [Email_Add] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBPlannedAuditMIS_dwnload
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBPlannedAuditMIS_dwnload]
(
    [APTag] VARCHAR(20) NULL,
    [FY] VARCHAR(50) NULL,
    [AuditStartDate] VARCHAR(30) NULL,
    [AuditorID] VARCHAR(200) NULL,
    [AuditorName] VARCHAR(200) NULL,
    [AuditStatus] VARCHAR(100) NULL,
    [AuditCompleteddate] VARCHAR(30) NULL,
    [AuditObservation] VARCHAR(100) NULL,
    [Auditfile] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Sbtaglist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Sbtaglist]
(
    [ID] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sbtag] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Settlement_Charges_20Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Settlement_Charges_20Aug2025]
(
    [party_code] VARCHAR(25) NULL,
    [SETT_chrgs] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SFDCClientrepsonseAPI
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SFDCClientrepsonseAPI]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [Status] BIT NULL,
    [Message] NVARCHAR(255) NULL,
    [SuccessIds] NVARCHAR(MAX) NULL,
    [FailedIds] NVARCHAR(MAX) NULL,
    [Date] DATETIME NULL,
    [AttemptCount] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SFDCClientResponseAPI_SuccessIds
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SFDCClientResponseAPI_SuccessIds]
(
    [ResponseId] INT NULL,
    [SuccessId] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_sms
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_sms]
(
    [Party_code] VARCHAR(50) NOT NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(20) NULL,
    [time] VARCHAR(20) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(3) NULL,
    [purpose] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SMS_13May2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SMS_13May2025]
(
    [Party_code] VARCHAR(50) NOT NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(20) NULL,
    [time] VARCHAR(20) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(3) NULL,
    [purpose] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SMS_CNS_13May2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SMS_CNS_13May2025]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Party_code] VARCHAR(50) NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(500) NULL,
    [time] VARCHAR(500) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(10) NULL,
    [purpose] VARCHAR(100) NULL,
    [Request] VARCHAR(MAX) NULL,
    [Response] VARCHAR(MAX) NULL,
    [Response_date] DATETIME NULL,
    [NoOfAttempt] INT NULL,
    [EntryDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SMSCNSSent_SebiPO
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SMSCNSSent_SebiPO]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Party_code] VARCHAR(50) NULL,
    [Amount_R] MONEY NULL,
    [Amount_A] MONEY NULL,
    [accountNo] VARCHAR(50) NULL,
    [UTR] VARCHAR(50) NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(500) NULL,
    [time] VARCHAR(500) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(10) NULL,
    [purpose] VARCHAR(100) NULL,
    [Request] VARCHAR(MAX) NULL,
    [Response] VARCHAR(MAX) NULL,
    [Response_date] DATETIME NULL,
    [NoOfAttempt] INT NULL,
    [EntryDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBroker_JV_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBroker_JV_TEST]
(
    [AgentCode] VARCHAR(20) NULL,
    [Upfront] VARCHAR(20) NULL,
    [Trail] VARCHAR(20) NULL,
    [Clawback] VARCHAR(20) NULL,
    [Recovery] VARCHAR(20) NULL,
    [PendingBrok] VARCHAR(20) NULL,
    [StateCode] VARCHAR(20) NULL,
    [IGST] VARCHAR(8000) NULL,
    [CGST] VARCHAR(8000) NULL,
    [SGST] VARCHAR(8000) NULL,
    [UGST] VARCHAR(8000) NULL,
    [Srno] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerAuditAnswers
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerAuditAnswers]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SBtag] VARCHAR(20) NULL,
    [Qno] VARCHAR(5) NULL,
    [Answer] VARCHAR(50) NULL,
    [Remarks] VARCHAR(200) NULL,
    [updateddate] DATETIME NULL DEFAULT (getdate()),
    [updatedby] VARCHAR(100) NULL,
    [AuditProofDoc] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerAuditAnswers_10oct2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerAuditAnswers_10oct2024]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SBtag] VARCHAR(20) NULL,
    [Qno] VARCHAR(5) NULL,
    [Answer] VARCHAR(50) NULL,
    [Remarks] VARCHAR(200) NULL,
    [updateddate] DATETIME NULL,
    [updatedby] VARCHAR(100) NULL,
    [AuditProofDoc] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerAuditAnswers_22nov2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerAuditAnswers_22nov2024]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SBtag] VARCHAR(20) NULL,
    [Qno] VARCHAR(5) NULL,
    [Answer] VARCHAR(50) NULL,
    [Remarks] VARCHAR(200) NULL,
    [updateddate] DATETIME NULL,
    [updatedby] VARCHAR(100) NULL,
    [AuditProofDoc] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerAuditAnswers_28mar2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerAuditAnswers_28mar2025]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SBtag] VARCHAR(20) NULL,
    [Qno] VARCHAR(5) NULL,
    [Answer] VARCHAR(50) NULL,
    [Remarks] VARCHAR(200) NULL,
    [updateddate] DATETIME NULL,
    [updatedby] VARCHAR(100) NULL,
    [AuditProofDoc] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerAuditAnswers_SRRC_12sep2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerAuditAnswers_SRRC_12sep2024]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SBtag] VARCHAR(20) NULL,
    [Qno] VARCHAR(5) NULL,
    [Answer] VARCHAR(50) NULL,
    [Remarks] VARCHAR(200) NULL,
    [updateddate] DATETIME NULL,
    [updatedby] VARCHAR(100) NULL,
    [AuditProofDoc] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerAuditAnswers_VIAO14oct2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerAuditAnswers_VIAO14oct2024]
(
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SBtag] VARCHAR(20) NULL,
    [Qno] VARCHAR(5) NULL,
    [Answer] VARCHAR(50) NULL,
    [Remarks] VARCHAR(200) NULL,
    [updateddate] DATETIME NULL,
    [updatedby] VARCHAR(100) NULL,
    [AuditProofDoc] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerAuditQustionMaster_15Apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerAuditQustionMaster_15Apr2025]
(
    [nId] INT IDENTITY(1,1) NOT NULL,
    [sQuestion] VARCHAR(MAX) NULL,
    [sStatus] CHAR(1) NULL,
    [dtCreationDate] DATETIME NULL,
    [SBType] VARCHAR(5) NULL,
    [Version] VARCHAR(20) NULL,
    [IsActive] VARCHAR(20) NULL,
    [Compliant] VARCHAR(50) NULL,
    [NonCompliant] VARCHAR(50) NULL,
    [NotApplicable] VARCHAR(50) NULL,
    [AuditType] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerAuditQustionMaster_19sep2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerAuditQustionMaster_19sep2024]
(
    [nId] INT IDENTITY(1,1) NOT NULL,
    [sQuestion] VARCHAR(MAX) NULL,
    [sStatus] CHAR(1) NULL,
    [dtCreationDate] DATETIME NULL,
    [SBType] VARCHAR(5) NULL,
    [Version] VARCHAR(20) NULL,
    [IsActive] VARCHAR(20) NULL,
    [Compliant] VARCHAR(50) NULL,
    [NonCompliant] VARCHAR(50) NULL,
    [NotApplicable] VARCHAR(50) NULL,
    [AuditType] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerAuditQustionMasterIntermediate_19sep2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerAuditQustionMasterIntermediate_19sep2024]
(
    [nId] INT IDENTITY(1,1) NOT NULL,
    [sQuestion] VARCHAR(MAX) NULL,
    [sStatus] CHAR(1) NULL,
    [dtCreationDate] DATETIME NULL,
    [SBType] VARCHAR(5) NULL,
    [Version] VARCHAR(20) NULL,
    [IsActive] VARCHAR(20) NULL,
    [Compliant] VARCHAR(50) NULL,
    [NonCompliant] VARCHAR(50) NULL,
    [NotApplicable] VARCHAR(50) NULL,
    [AuditType] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerMailSendLog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerMailSendLog]
(
    [sbtag] VARCHAR(20) NULL,
    [email] VARCHAR(100) NULL,
    [logdate] DATETIME NULL,
    [AuditDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_tmpSBMasterPayout_30JUL2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_tmpSBMasterPayout_30JUL2025]
(
    [SBtag] VARCHAR(20) NULL,
    [BankAccName] VARCHAR(500) NULL,
    [BankAccountNo] VARCHAR(100) NULL,
    [IFSCCode] VARCHAR(50) NULL,
    [MICRcode] VARCHAR(50) NULL,
    [ARN_PANNo] VARCHAR(20) NULL,
    [AgentCodeDion] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_tmpVoucherlog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_tmpVoucherlog]
(
    [sb] VARCHAR(10) NULL,
    [createdon] DATETIME NULL DEFAULT (getdate()),
    [ddno] VARCHAR(50) NULL,
    [Accno] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_final_17Jun2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_final_17Jun2025]
(
    [Srno] BIGINT NULL,
    [scrip] VARCHAR(2000) NULL,
    [series] VARCHAR(15) NOT NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(100) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [MTM_Price] MONEY NULL,
    [Priority_scrip] INT NULL,
    [Angel_Scrip] VARCHAR(20) NULL,
    [Var_margin] NUMERIC(10, 2) NULL,
    [Value_BHC] MONEY NULL,
    [Value_AHC] MONEY NULL,
    [netpayable] MONEY NULL,
    [approved] MONEY NULL,
    [Priority_scripwise] INT NULL,
    [Priority_Valuewise] INT NULL,
    [Req_refno] INT NULL,
    [Seq_approve_status] VARCHAR(50) NULL,
    [PRIORITY_ALL] INT NULL,
    [marginamt] MONEY NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NET] MONEY NULL,
    [cl_type] VARCHAR(10) NULL,
    [ReleasedQty] INT NULL,
    [BlockedQty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_06Aug2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_06Aug2024]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_08Apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_08Apr2025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_08May2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_08May2025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_09Apr2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_09Apr2025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_13Dec2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_13Dec2024]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_17Jun2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_17Jun2025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_18Mar2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_18Mar2025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_19Feb2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_19Feb2025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_23042025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_23042025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_24Dec2024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_24Dec2024]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_24Jun2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_24Jun2025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_25Jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_25Jul2025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_26Jun2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_26Jun2025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_29Jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_29Jul2025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_30Aug204
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_30Aug204]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unpledge_Request_Jan162025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unpledge_Request_Jan162025]
(
    [scrip] VARCHAR(2000) NULL,
    [MarkedQty] INT NULL,
    [party_code] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [requestdate] DATETIME NULL,
    [Status] INT NULL,
    [Req_refno] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblMask
-- --------------------------------------------------
CREATE TABLE [dbo].[tblMask]
(
    [AutoID] INT IDENTITY(1,1) NOT NULL,
    [FirstName] NVARCHAR(50) NULL,
    [LastName] VARCHAR(50) NULL,
    [EMail] NVARCHAR(50) NULL,
    [PANNo] VARCHAR(50) NULL,
    [MobileNo] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_ReversalOFS
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_ReversalOFS]
(
    [SCRIPCODE] VARCHAR(50) NULL,
    [CLIENT_TYPE] VARCHAR(3) NULL,
    [Blank_1] VARCHAR(5) NULL,
    [Client_Code] VARCHAR(10) NULL,
    [Blank_2] VARCHAR(5) NULL,
    [Qty] VARCHAR(5) NULL,
    [Bid_Rate] VARCHAR(10) NULL,
    [Static_val] VARCHAR(2) NULL,
    [Bid_No] VARCHAR(25) NULL,
    [Static_val1] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_ReversalOFS_NSE1
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_ReversalOFS_NSE1]
(
    [Symbol] VARCHAR(50) NULL,
    [Series] VARCHAR(50) NULL,
    [ORderType] VARCHAR(50) NULL,
    [ClientId] VARCHAR(50) NULL,
    [ParticipantId] VARCHAR(50) NULL,
    [MarginType] VARCHAR(50) NULL,
    [Quantity] VARCHAR(50) NULL,
    [Price] VARCHAR(50) NULL,
    [OrderStatus] VARCHAR(50) NULL,
    [OrderId] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_withdraw2_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_withdraw2_hist]
(
    [Id] INT NULL,
    [VerifierID] INT NULL,
    [RequestID] INT NULL,
    [Req_RefNo] VARCHAR(25) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [ENTITY] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [PO_ApprovedAmt] MONEY NULL,
    [NetPAyable] MONEY NULL,
    [SegApprovedAmt] MONEY NULL,
    [ODIN_gen] INT NULL,
    [Accno] VARCHAR(30) NULL,
    [IFSC] VARCHAR(20) NULL,
    [Bank_Provider] VARCHAR(10) NULL,
    [processedflag] VARCHAR(3) NULL,
    [UpdatedOn] DATETIME NULL,
    [LastUpdatedOn] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.test_27nov2025
-- --------------------------------------------------
CREATE TABLE [dbo].[test_27nov2025]
(
    [party_code] VARCHAR(50) NULL,
    [cltype] VARCHAR(50) NULL,
    [sb] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp_NCMS_AXISBank
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp_NCMS_AXISBank]
(
    [Srno] BIGINT NULL,
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL,
    [SegApprovedAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp_NCMS_AXISBank_batch
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp_NCMS_AXISBank_batch]
(
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp_NCMS_HDFCBank_ACCOUNT
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp_NCMS_HDFCBank_ACCOUNT]
(
    [Srno] BIGINT NULL,
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp_NCMS_HDFCBank_batch
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp_NCMS_HDFCBank_batch]
(
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp_NCMS_ICICIBank
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp_NCMS_ICICIBank]
(
    [Srno] BIGINT NULL,
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL,
    [SegApprovedAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp_NCMS_ICICIBank_batch
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp_NCMS_ICICIBank_batch]
(
    [flag] INT NOT NULL,
    [content] VARCHAR(8000) NULL,
    [verifierId] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Trade_MCX_CO_0_CM_12685_20260113_F_0000
-- --------------------------------------------------
CREATE TABLE [dbo].[Trade_MCX_CO_0_CM_12685_20260113_F_0000]
(
    [TradDt] VARCHAR(50) NULL,
    [BizDt] VARCHAR(50) NULL,
    [Sgmt] VARCHAR(50) NULL,
    [Src] VARCHAR(50) NULL,
    [Xchg] VARCHAR(50) NULL,
    [ClrMmbId] VARCHAR(50) NULL,
    [Brkr] VARCHAR(50) NULL,
    [FinInstrmTp] VARCHAR(50) NULL,
    [FinInstrmId] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [TckrSymb] VARCHAR(50) NULL,
    [SctySrs] VARCHAR(50) NULL,
    [XpryDt] VARCHAR(50) NULL,
    [FininstrmActlXpryDt] VARCHAR(50) NULL,
    [StrkPric] VARCHAR(50) NULL,
    [OptnTp] VARCHAR(50) NULL,
    [FinInstrmNm] VARCHAR(50) NULL,
    [ClntTp] VARCHAR(50) NULL,
    [ClntId] VARCHAR(50) NULL,
    [FullyExctdConfSnt] VARCHAR(50) NULL,
    [OrgnlCtdnPtcptId] VARCHAR(50) NULL,
    [CtdnPtcptId] VARCHAR(50) NULL,
    [SttlmTp] VARCHAR(50) NULL,
    [SctiesSttlmTxId] VARCHAR(50) NULL,
    [BuySellInd] VARCHAR(50) NULL,
    [TradQty] VARCHAR(50) NULL,
    [NewBrdLotQty] VARCHAR(50) NULL,
    [Pric] VARCHAR(50) NULL,
    [UnqTradIdr] VARCHAR(50) NULL,
    [RptdTxSts] VARCHAR(50) NULL,
    [TradDtTm] VARCHAR(50) NULL,
    [UpdDt] VARCHAR(50) NULL,
    [OrdrRef] VARCHAR(50) NULL,
    [OrdrDtTm] VARCHAR(50) NULL,
    [InstgUsr] VARCHAR(50) NULL,
    [CtclId] VARCHAR(50) NULL,
    [TradRegnOrgn] VARCHAR(50) NULL,
    [OrdrTp] VARCHAR(50) NULL,
    [BlckDealInd] VARCHAR(50) NULL,
    [SttlmCycl] VARCHAR(50) NULL,
    [MktTpandId] VARCHAR(50) NULL,
    [Rmks] VARCHAR(50) NULL,
    [Rsvd1] VARCHAR(50) NULL,
    [Rsvd2] VARCHAR(50) NULL,
    [Rsvd3] VARCHAR(50) NULL,
    [Rsvd4] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.unpleadge_batch_process
-- --------------------------------------------------
CREATE TABLE [dbo].[unpleadge_batch_process]
(
    [Srno] INT NOT NULL,
    [ProcedureName] VARCHAR(200) NULL,
    [Active_Status] INT NULL,
    [StartDate] DATETIME NULL,
    [EndDate] DATETIME NULL,
    [Flag] INT NULL,
    [spdesc] VARCHAR(200) NULL,
    [Errflag] VARCHAR(100) NULL,
    [section] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_26dec2024
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_26dec2024]
(
    [userid] INT IDENTITY(1,1) NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.user_login_BKP_19JAN2026
-- --------------------------------------------------
CREATE TABLE [dbo].[user_login_BKP_19JAN2026]
(
    [userid] INT NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USER_LOGIN_LOG_21JUL2025_U
-- --------------------------------------------------
CREATE TABLE [dbo].[USER_LOGIN_LOG_21JUL2025_U]
(
    [userid] INT NOT NULL,
    [person_name] VARCHAR(100) NULL,
    [username] VARCHAR(50) NULL,
    [userpassword] VARCHAR(50) NULL,
    [usertype] VARCHAR(50) NULL,
    [access_to] VARCHAR(50) NULL,
    [access_code] VARCHAR(50) NULL,
    [cat_code] INT NULL,
    [status] INT NULL,
    [last_login] DATETIME NULL,
    [NoOfTry] INT NULL,
    [NoOfLogin] INT NULL,
    [login_Activated] DATETIME NULL,
    [login_inactive_date] DATETIME NULL,
    [active] VARCHAR(10) NULL,
    [email] VARCHAR(100) NULL,
    [IP] VARCHAR(500) NULL,
    [IP_active] VARCHAR(10) NULL,
    [Gateway] VARCHAR(50) NULL,
    [Gateway_active] VARCHAR(50) NULL,
    [session_id] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [CreatedOn] VARCHAR(50) NULL,
    [LastModifiedBy] VARCHAR(50) NULL,
    [LastModifiedOn] VARCHAR(50) NULL,
    [history_date] DATETIME NULL,
    [action] VARCHAR(6) NULL,
    [Host] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERNOTLOGIN_01APR2024
-- --------------------------------------------------
CREATE TABLE [dbo].[USERNOTLOGIN_01APR2024]
(
    [username] VARCHAR(100) NULL,
    [EMP_NAME] VARCHAR(500) NULL,
    [Sub_department] VARCHAR(500) NULL,
    [Sr_Name] VARCHAR(500) NULL,
    [access_date] DATETIME NULL,
    [SERVERIPFROM] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USP_GSTIN_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[USP_GSTIN_MASTER]
(
    [SBTAG] VARCHAR(100) NULL,
    [GSTIN] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USP_GSTIN_MASTER_30JUL2025
-- --------------------------------------------------
CREATE TABLE [dbo].[USP_GSTIN_MASTER_30JUL2025]
(
    [SBTAG] VARCHAR(100) NULL,
    [GSTIN] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USP_GSTIN_MASTER_BKP_27MAR2025
-- --------------------------------------------------
CREATE TABLE [dbo].[USP_GSTIN_MASTER_BKP_27MAR2025]
(
    [SBTAG] VARCHAR(100) NULL,
    [GSTIN] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2098
-- --------------------------------------------------
CREATE TABLE [dbo].[V2098]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL,
    [F33] NVARCHAR(255) NULL,
    [F34] NVARCHAR(255) NULL,
    [F35] NVARCHAR(255) NULL,
    [F36] NVARCHAR(255) NULL,
    [F37] NVARCHAR(255) NULL,
    [F38] NVARCHAR(255) NULL,
    [F39] NVARCHAR(255) NULL,
    [F40] NVARCHAR(255) NULL,
    [F41] NVARCHAR(255) NULL,
    [F42] NVARCHAR(255) NULL,
    [F43] NVARCHAR(255) NULL,
    [F44] NVARCHAR(255) NULL,
    [F45] NVARCHAR(255) NULL,
    [F46] NVARCHAR(255) NULL,
    [F47] NVARCHAR(255) NULL,
    [F48] NVARCHAR(255) NULL,
    [F49] NVARCHAR(255) NULL,
    [F50] NVARCHAR(255) NULL,
    [F51] NVARCHAR(255) NULL,
    [F52] NVARCHAR(255) NULL,
    [F53] NVARCHAR(255) NULL,
    [F54] NVARCHAR(255) NULL,
    [F55] NVARCHAR(255) NULL,
    [F56] NVARCHAR(255) NULL,
    [F57] NVARCHAR(255) NULL,
    [F58] NVARCHAR(255) NULL,
    [F59] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V71105
-- --------------------------------------------------
CREATE TABLE [dbo].[V71105]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VW_Client_DPBal_20Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[VW_Client_DPBal_20Aug2025]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [CLIENT_CODE] VARCHAR(16) NULL,
    [ACTUAL_AMOUNT] MONEY NOT NULL,
    [ACCRUAL_BAL] MONEY NOT NULL,
    [BRANCH_CODE] VARCHAR(6) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VW_Client_DPBal_31Jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[VW_Client_DPBal_31Jan2025]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [CLIENT_CODE] VARCHAR(16) NULL,
    [ACTUAL_AMOUNT] MONEY NOT NULL,
    [ACCRUAL_BAL] MONEY NOT NULL,
    [BRANCH_CODE] VARCHAR(6) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Y10224
-- --------------------------------------------------
CREATE TABLE [dbo].[Y10224]
(
    [TransDate] DATETIME NULL,
    [TransDate1] DATETIME NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL,
    [F31] NVARCHAR(255) NULL,
    [F32] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Y11222
-- --------------------------------------------------
CREATE TABLE [dbo].[Y11222]
(
    [TransDate] NVARCHAR(255) NULL,
    [TransDate1] NVARCHAR(255) NULL,
    [Sett_No] NVARCHAR(255) NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Long_Name] NVARCHAR(255) NULL,
    [CertNo] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [CQty] FLOAT NULL,
    [DQty] FLOAT NULL,
    [Pldg Credit] FLOAT NULL,
    [Pldg Debit] FLOAT NULL,
    [DpId] NVARCHAR(255) NULL,
    [CltDpId] NVARCHAR(255) NULL,
    [Reason] NVARCHAR(255) NULL,
    [BDpId] NVARCHAR(255) NULL,
    [BCltDpId] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.TRG_OFS_ORDER_UPDATE_AUDIT
-- --------------------------------------------------
CREATE TRIGGER [dbo].[TRG_OFS_ORDER_UPDATE_AUDIT]
    ON [dbo].[OFS_ORDER_V1]
    AFTER UPDATE
    AS 
BEGIN
    SET NOCOUNT ON;

    INSERT INTO dbo.OFS_ORDER_HISTORY
    (
        REQUEST_ID,
        REQUEST_DATE,
        CLIENT_CODE,
        SEGMENT,
        SCRIPCODE,
        QUANTITY,
        BID_RATE,
        MIN_BID_RATE,
        CLIENT_TYPE,
        MinMarginPercent,
        Checkon_NetA_NetL,
        NET_AVAILABLE,
        NET_LEDGER,
        MARGIN_AVAILABLE,
        ENTERED_BY,
        REMARKS,
        GENERATION_FLAG,
        GEN_STATUS,
        BID_NO,
        FileName,
        Batch_No,
        Source,
        IP,
        Scrip,
        StatusCode,
        IsEmployee,
        IsCutOff,
        ModifiedOn,
        CL_TYPE,
        AuditAction,
        AuditDate
    )
    SELECT
        d.REQUEST_ID,
        d.REQUEST_DATE,
        d.CLIENT_CODE,
        d.SEGMENT,
        d.SCRIPCODE,
        d.QUANTITY,
        d.BID_RATE,
        d.MIN_BID_RATE,
        d.CLIENT_TYPE,
        d.MinMarginPercent,
        d.Checkon_NetA_NetL,
        d.NET_AVAILABLE,
        d.NET_LEDGER,
        d.MARGIN_AVAILABLE,
        d.ENTERED_BY,
        d.REMARKS,
        d.GENERATION_FLAG,
        d.GEN_STATUS,
        d.BID_NO,
        d.FileName,
        d.Batch_No,
        d.Source,
        d.IP,
        d.Scrip,
        d.StatusCode,
        d.IsEmployee,
        d.IsCutOff,
        d.ModifiedOn,
        d.CL_TYPE,
        'UPDATE',
        GETDATE()
    FROM deleted d;
END;

GO

-- --------------------------------------------------
-- TRIGGER dbo.TRG_TBL_FNCLIENTMASTER
-- --------------------------------------------------

CREATE TRIGGER [dbo].[TRG_TBL_FNCLIENTMASTER]   
    ON [dbo].[TBL_FNCLIENTMASTER]   
    FOR INSERT, UPDATE, DELETE   
AS

DECLARE @IPADDRESS AS VARCHAR(20)            
        
SELECT @IPADDRESS = CLIENT_NET_ADDRESS            
FROM SYS.DM_EXEC_CONNECTIONS            
WHERE SESSION_ID = @@SPID

    IF (SELECT COUNT(*) FROM inserted) > 0   
    BEGIN   
        IF (SELECT COUNT(*) FROM deleted) > 0   
        BEGIN   
            -- Update!  
            INSERT INTO TBL_FNCLIENTMASTER_TRIG  
            (  FLD_BANKID, FLD_CLIENT_CODE, FLD_SWIFTID, FLD_IBAN_NUMBER, FLD_SORT_CODE, FLD_CURRENCY_REMITTANCE, FLD_BANK_NAME, FLD_BANK_ACCOUNT_NO, FLD_BANK_ADDRESS, 
			FLD_INSERTED_ON, FLD_MODIFIED_ON, FLD_MODIFIED_BY, [UPDATED_DATE], DBACTION, [APP_NAME], IPADDRESS )  
            SELECT FLD_BANKID, FLD_CLIENT_CODE, FLD_SWIFTID, FLD_IBAN_NUMBER, FLD_SORT_CODE, FLD_CURRENCY_REMITTANCE, FLD_BANK_NAME, FLD_BANK_ACCOUNT_NO, FLD_BANK_ADDRESS, 
			FLD_INSERTED_ON, FLD_MODIFIED_ON, FLD_MODIFIED_BY, [UPDATED_DATE]=GETDATE(), DBACTION='UPDATED', [APP_NAME]=APP_NAME(), IPADDRESS=@IPADDRESS  FROM INSERTED  
              
        END   
        ELSE   
        BEGIN   
			-- insert!   
            INSERT INTO TBL_FNCLIENTMASTER_TRIG  
            (  FLD_BANKID, FLD_CLIENT_CODE, FLD_SWIFTID, FLD_IBAN_NUMBER, FLD_SORT_CODE, FLD_CURRENCY_REMITTANCE, FLD_BANK_NAME, FLD_BANK_ACCOUNT_NO, FLD_BANK_ADDRESS, 
			FLD_INSERTED_ON, FLD_MODIFIED_ON, FLD_MODIFIED_BY, [UPDATED_DATE], DBACTION, [APP_NAME], IPADDRESS )  
            SELECT  FLD_BANKID, FLD_CLIENT_CODE, FLD_SWIFTID, FLD_IBAN_NUMBER, FLD_SORT_CODE, FLD_CURRENCY_REMITTANCE, FLD_BANK_NAME, FLD_BANK_ACCOUNT_NO, FLD_BANK_ADDRESS, 
			FLD_INSERTED_ON, FLD_MODIFIED_ON, FLD_MODIFIED_BY, [UPDATED_DATE]=GETDATE(), DBACTION='INSERTED', [APP_NAME]=APP_NAME(), IPADDRESS=@IPADDRESS FROM INSERTED  
        END   
    END   
    ELSE
    BEGIN   
            -- delete!   
			INSERT INTO TBL_FNCLIENTMASTER_TRIG  
            (  FLD_BANKID, FLD_CLIENT_CODE, FLD_SWIFTID, FLD_IBAN_NUMBER, FLD_SORT_CODE, FLD_CURRENCY_REMITTANCE, FLD_BANK_NAME, FLD_BANK_ACCOUNT_NO, FLD_BANK_ADDRESS, 
			FLD_INSERTED_ON, FLD_MODIFIED_ON, FLD_MODIFIED_BY, [UPDATED_DATE], DBACTION, [APP_NAME], IPADDRESS )  
            SELECT  FLD_BANKID, FLD_CLIENT_CODE, FLD_SWIFTID, FLD_IBAN_NUMBER, FLD_SORT_CODE, FLD_CURRENCY_REMITTANCE, FLD_BANK_NAME, FLD_BANK_ACCOUNT_NO, FLD_BANK_ADDRESS, 
			FLD_INSERTED_ON, FLD_MODIFIED_ON, FLD_MODIFIED_BY, [UPDATED_DATE]=GETDATE(), DBACTION='DELETED', [APP_NAME]=APP_NAME(), IPADDRESS=@IPADDRESS FROM deleted  
    END

GO

-- --------------------------------------------------
-- VIEW dbo.V_NCMS_PO_Request_All_new
-- --------------------------------------------------
CREATE view [dbo].[V_NCMS_PO_Request_All_new]        
as        
select source,POrequestID,x.party_code,Entity,x.Req_RefNo,Req_Datetime,PO_Request,Req_Paymode,Req_PayBankId,PO_ApprovedAmt,  
x.PO_Statusid,s.PO_Status,remarks,        
credit_date_time,isnull(bb.utrno,'') UTRNo,isnull(bb.bankmsg,'') bankmsg,x.parentchildid,x.PendingAmount,      
c.IFSC_Code,c.bank_name,x.Req_User,x.Req_IP,      
b.sb,b.Party_name from        
(        
SELECT distinct        
    'main' source,        
 a.POrequestID,            
 a.party_code,            
 a.Entity,            
 a.Req_RefNo,            
 a.Req_Datetime AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' Req_Datetime,            
 a.PO_Request,            
 a.Req_Paymode,            
 a.Req_PayBankId,            
 a.PO_ApprovedAmt,            
 a.PO_Statusid,            
 a.remarks,        
 a.ReleaseId,        
 a.parentchildid,        
 b.po_request as PendingAmount,       
 a.req_user,      
 a.req_ip,      
 CAST(cms.dbo.udf_getcredittime(a.Req_Datetime, a.party_code, a.POrequestID) as DATETIME) AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' AS credit_date_time            
FROM cms.dbo.ncms_po_request a with(nolock) left join         
cms.dbo.ncms_po_request b with(nolock) on a.Party_code=b.Party_code and a.parentchildid=b.req_refno         
where  a.Req_User<>'Bill_KYC'        
UNION ALL        
SELECT distinct        
    'history' source,        
 a.POrequestID,            
 a.party_code,            
 a.Entity,            
 a.Req_RefNo,            
 a.Req_Datetime AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' Req_Datetime,            
 a.PO_Request,            
 a.Req_Paymode,            
 a.Req_PayBankId,            
 a.PO_ApprovedAmt,            
 a.PO_Statusid,            
 a.remarks,         
a.ReleaseId,           
a.parentchildid,        
 /*b.po_request as PendingAmount,*/        
  case when  isnull(b.po_request,0)=0  then c.po_request else b.po_request end as PendingAmount,       
  a.req_user,      
  a.req_ip,      
 CAST(cms.dbo.udf_getcredittime(a.Req_Datetime, a.party_code, a.POrequestID) as DATETIME) AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' AS credit_date_time            
FROM cms.dbo.NCMS_po_request_2MonthData a with(nolock)  left join         
cms.dbo.NCMS_po_request_2MonthData b with(nolock) on a.Party_code=b.Party_code and a.parentchildid=b.req_refno         
left join cms.dbo.NCMS_po_request c on  a.Party_code=c.Party_code and a.parentchildid=c.req_refno           
WHERE a.po_statusid IN (2, 3, 4, 6)   and  a.Req_User<>'Bill_KYC'        
union All        
SELECT distinct        
    'AutoPayout' source,        
 a.POrequestID,            
 a.party_code,            
 a.Entity,            
 a.Req_RefNo,            
 a.Req_Datetime AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' Req_Datetime,            
 a.PO_Request,            
 a.Req_Paymode,            
 a.Req_PayBankId,            
 a.PO_ApprovedAmt,            
 a.PO_Statusid,            
 a.remarks,        
 a.ReleaseId,        
 a.parentchildid,        
 b.po_request as PendingAmount,       
  a.req_user,      
  a.req_ip,      
 CAST(cms.dbo.udf_getcredittime(a.Req_Datetime, a.party_code, a.POrequestID) as DATETIME) AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' AS credit_date_time            
FROM cms.dbo.ncms_po_request a with(nolock) left join         
cms.dbo.ncms_po_request b with(nolock) on a.Party_code=b.Party_code and a.parentchildid=b.req_refno         
where a.Req_User='Bill_KYC'        
UNION ALL        
SELECT distinct        
    'AutoPayout' source,        
 a.POrequestID,            
 a.party_code,            
 a.Entity,            
 a.Req_RefNo,            
 a.Req_Datetime AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' Req_Datetime,            
 a.PO_Request,            
 a.Req_Paymode,            
 a.Req_PayBankId,            
 a.PO_ApprovedAmt,            
 a.PO_Statusid,            
 a.remarks,         
a.ReleaseId,           
a.parentchildid,        
 /*b.po_request as PendingAmount,*/        
  case when  isnull(b.po_request,0)=0  then c.po_request else b.po_request end as PendingAmount,      
   a.req_user,      
   a.req_ip,      
 CAST(cms.dbo.udf_getcredittime(a.Req_Datetime, a.party_code, a.POrequestID) as DATETIME) AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' AS credit_date_time            
FROM cms.dbo.NCMS_po_request_2MonthData a with(nolock)  left join         
cms.dbo.NCMS_po_request_2MonthData b with(nolock) on a.Party_code=b.Party_code and a.parentchildid=b.req_refno         
left join cms.dbo.NCMS_po_request c on  a.Party_code=c.Party_code and a.parentchildid=c.req_refno           
WHERE a.po_statusid IN (2, 3, 4, 6) and  a.Req_User='Bill_KYC'        
UNION ALL        
SELECT distinct         
    'sebi' source,        
 POrequestID,        
 party_code,        
 Entity,        
 Req_RefNo,        
 Req_Datetime AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' Req_Datetime,        
 PO_Request,        
 Req_Paymode,        
 Req_PayBankId,        
 PO_ApprovedAmt,        
 PO_Statusid,        
 remarks,        
   Req_RefNo as ReleaseId,         
    '' as parentchildid,        
0 PendingAmount,        
 party_code as req_user,      
 '00.00.00.00' req_ip,      
 Req_Datetime AT TIME ZONE 'India Standard Time' AT TIME ZONE 'UTC' AS credit_date_time        
FROM cms.dbo.SEBI_Payout_2MonthData  with(nolock)        
WHERE po_statusid IN (2, 3, 4, 6)        
)x        
left join  cms.dbo.VW_NCMS_UTR_ALLBank BB with(nolock)   on x.party_code=bb.party_code                  
and x.ReleaseId=BB.req_refno and x.ReleaseId <>''         
left outer join risk.dbo.vw_rms_client_vertical b on x.party_Code=b.Client       
left join risk.dbo.V_Rtgs_client c on x.Party_code=c.fld_party_code and       
ltrim(rtrim(x.Req_PayBankId))= ltrim(rtrim(c.Fld_bank_Acno))  
left join cms.dbo.ncms_postatus s on x.PO_Statusid=s.PO_Statusid

GO

-- --------------------------------------------------
-- VIEW dbo.V_NriBank_Details
-- --------------------------------------------------
CREATE VIEW V_NriBank_Details        
AS        
  SELECT a.Fld_ClientCode,        
         a.Fld_ClientPISAc,        
         /*changes as per Dattu mail- 05/12/2012        
        -- Fld_AngelAcc=328010200004855,        
        */      
        /* Mittal-revert back as per mail -12/17/2012  */       
        b.Fld_AngelAcc,     
  b.Fld_BankPISAc,  
        -- b.Fld_AngelAcc,        
         b.Fld_Srno BankId,        
         b.Fld_BankName,        
         b.Fld_BranchLocation        
  FROM   DUSTBIN.DBO.tbl_NRIClientMaster a        
         LEFT OUTER JOIN DUSTBIN.DBO.tbl_NRIBankMaster b        
           ON a.Fld_BankID = b.Fld_Srno

GO

-- --------------------------------------------------
-- VIEW dbo.V_NriBank_Details_nse_TEST
-- --------------------------------------------------
CREATE VIEW V_NriBank_Details_nse_TEST       
AS        
  SELECT a.Fld_ClientCode,        
         a.Fld_ClientPISAc,        
         /*changes as per Dattu mail- 05/12/2012        
         -- Fld_AngelAcc=328010200004879,        
         */      
         /* Mittal -revert back as per mail - 12/17/2012*/       
         b.Fld_AngelAcc,  
   b.Fld_BankPISAc,  
         --b.Fld_AngelAcc,        
         Fld_BankID,        
         b.Fld_BankName,        
         b.Fld_BranchLocation        
  FROM   RISK.DBO.tbl_NRIClientMaster_BKP_07OCT2025 a        
         LEFT OUTER JOIN RISK.DBO.tbl_NRIBankMaster_BKP_07OCT2025 b        
           ON a.Fld_BankID = b.Fld_Srno

GO

-- --------------------------------------------------
-- VIEW dbo.V_NriBank_Details_TEST
-- --------------------------------------------------
CREATE VIEW V_NriBank_Details_TEST        
AS        
  SELECT a.Fld_ClientCode,        
         a.Fld_ClientPISAc,        
         /*changes as per Dattu mail- 05/12/2012        
        -- Fld_AngelAcc=328010200004855,        
        */      
        /* Mittal-revert back as per mail -12/17/2012  */       
        b.Fld_AngelAcc,     
  b.Fld_BankPISAc,  
        -- b.Fld_AngelAcc,        
         b.Fld_Srno BankId,        
         b.Fld_BankName,        
         b.Fld_BranchLocation        
  FROM   RISK.DBO.tbl_NRIClientMaster_BKP_07OCT2025 a        
         LEFT OUTER JOIN RISK.DBO.tbl_NRIBankMaster_BKP_07OCT2025 b        
           ON a.Fld_BankID = b.Fld_Srno

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_CP_MCX_New
-- --------------------------------------------------

CREATE VIEW  [dbo].[Vw_CP_MCX_New]            
as            
     
SELECT         
    TradeDate = TradDt,        
    MarketType = 'NORMAL', -- Adding MarketType with constant value 'NORMAL'        
    InstType,        
    Symbol,        
    ExpiryDate,        
    PrevCls = PrvsClsgPric,        
    Opening = OpnPric,        
    High = HghPric,        
    Low = LwPric,        
    Cl_rate,        
    StrikePrice = Strike_Price,        
    Optiontype,      
 ee = TtlTradgVol     
FROM  [CSOKYC-6].general.dbo.cp_mcx;

GO

