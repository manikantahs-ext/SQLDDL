-- DDL Export
-- Server: 10.253.33.89
-- Database: Mimansa
-- Exported: 2026-02-05T02:38:50.715411

USE Mimansa;
GO

-- --------------------------------------------------
-- FUNCTION dbo.b2b_crms_mimansa_status
-- --------------------------------------------------
--select * from b2b_crms_mimansa_status('ETA001')
  
CREATE FUNCTION [dbo].[b2b_crms_mimansa_status]        
(        
    @emp_no varchar(20)  
)       
RETURNS @sb_location table  
(  
 sb_tag varchar(20)  
)        
/*      
PRINT dbo.getWorkingDays('mar  1 2010', 'mar 31 2010')      
SELECT *  
FROM dbo.b2b_crms_mimansa_status('eta001');   
*/      
AS        
BEGIN       
 declare @isAdmin varchar(10)  
 declare @isDealer varchar(10)  
   
 select @isAdmin=isAdmin, @isDealer=isDealer from B2B_AngelHarmony  with(nolock) where emp_no= @emp_no  
 if(upper(@isAdmin)= '1')  
 begin  
  Declare @sb_tag varchar(20)  
  Declare @parenttag varchar(20)  
    
  select @sb_tag=sb_tag from B2B_AngelHarmony with(nolock) where emp_no=@emp_no  
    
  select   
   @parenttag=parenttag   
  from   
   MIS.sb_comp.dbo.sb_broker WITH (nolock)   
  where   
   sbtag=upper(@sb_tag)  
    
  if @parenttag is null  
  begin  
       
   insert into @sb_location   
   select distinct sbtag from  
   (  
    select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock)   
    where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock)  where sbtag=@sb_tag)  
    Union   
    select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock)   
    where parenttag=@sb_tag  
    union   
    select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock)   
    where sbtag=@sb_tag  
    union  
    select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock)   
    where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) where sbtag=@sb_tag)  
   )a   
   --where  sbtag >=@@From_Sub_Broker and  sbtag <=@@TO_Sub_Broker   
  end  
  else  
  begin  
   insert into @sb_location select @sb_tag  
  end    
  return  
 end  
 else if(upper(@isDealer)= '1')  
 begin  
  insert into @sb_location (sb_tag)   
  select sb_tag from  B2B_AngelHarmony  with(nolock) where emp_no= @emp_no  
  --select distinct branch_cd from B2B_CommonPartyServices ps with(nolock) where Emp_No=@emp_no 	
  return  
 end  
 return;  
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.B2bCrms_ParentSb
-- --------------------------------------------------
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION B2bCrms_ParentSb 
(
	@UserEmp_No varchar(20)
)
RETURNS varchar(50)
AS
BEGIN
	
	declare @parenttag varchar(10)
	declare @count int
	declare @sb_tag varchar(10)
	
	
	select @sb_tag=sb_tag from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No
	if(@sb_tag is null)
	begin
		Return 'Incorrect Subbroker'
	end
	
	select 
			@parenttag=isnull(parenttag,'N.A') 
		from 
			MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		where 
			sbtag=upper(@sb_tag)
	
	RETURN  @parenttag

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_GetEmpNameWithEcode
-- --------------------------------------------------

/*
	select dbo.fn_GetEmpNameWithEcode('ETA002')
*/
create function fn_GetEmpNameWithEcode(@EmpNo varchar(7))
returns varchar(100)
as
begin
	declare @Employee varchar(1000)  
	select @Employee =@EmpNo+' - '+emp_name from tbl_emp_master where emp_no=@EmpNo                       
	return @Employee
end

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_Split
-- --------------------------------------------------
    
CREATE FUNCTION [dbo].[fn_Split](@text VARCHAR(max),  @delimiter VARCHAR(5) = ',')     
RETURNS @Strings TABLE    
(       
  StringValue VARCHAR(max)    
)    
AS    
    
BEGIN    
    
DECLARE @index int     
    
SET @index = -1     
    
WHILE (LEN(@text) > 0)    
BEGIN      
    
    SET @index = CHARINDEX(@delimiter , @text)      
    
    IF (@index = 0) AND (LEN(@text) > 0)      
 BEGIN       
  INSERT INTO @Strings VALUES (LTRIM(RTRIM(@text)))    
  BREAK      
 END      
    
    IF (@index > 1)      
      BEGIN       
        INSERT INTO @Strings VALUES (LTRIM(RTRIM(LEFT(@text,@index - 1))))       
        SET @text = RIGHT(@text, (LEN(@text) - @index))      
      END      
    ELSE     
      SET @text = RIGHT(@text, (LEN(@text) - @index))     
    END    
 RETURN    
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetWorkingDays
-- --------------------------------------------------
CREATE FUNCTION dbo.GetWorkingDays      
(      
    @startDate SMALLDATETIME,      
    @endDate SMALLDATETIME      
)     
RETURNS INT      
/*    
PRINT dbo.getWorkingDays('mar  1 2010', 'mar 31 2010')     
*/    
AS      
BEGIN     
 Declare @@startDate SMALLDATETIME,      
   @@endDate SMALLDATETIME,      
   @@range INT;     
  
 set @@startDate = @startDate  
 set @@endDate = @endDate  
     
    SET @@range = DATEDIFF(DAY, @@startDate, @@endDate)+1;     
     
    RETURN      
    (     
        SELECT      
            @@range / 7 * 5 + @@range % 7 -      
            (     
                SELECT COUNT(*)      
            FROM     
                (     
                    SELECT 1 AS d     
                    UNION ALL SELECT 2      
                    UNION ALL SELECT 3      
                    UNION ALL SELECT 4      
                    UNION ALL SELECT 5      
                    UNION ALL SELECT 6      
                    UNION ALL SELECT 7     
                ) weekdays     
                WHERE d <= @@range % 7      
                AND DATENAME(WEEKDAY, @@endDate - d + 1)      
                IN     
                (     
                    'Saturday',     
                    'Sunday'     
                )     
            )     
    );     
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.RoundTime
-- --------------------------------------------------
CREATE FUNCTION [dbo].[RoundTime] (@Time DATETIME, @RoundToMin INT)
RETURNS DATETIME
AS
BEGIN
RETURN ROUND(CAST(CAST(CONVERT(VARCHAR,@Time,121) AS DATETIME) AS FLOAT) * (1440/@RoundToMin),0)/(1440/@RoundToMin)
END

GO

-- --------------------------------------------------
-- INDEX dbo.AngelBOMenu
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_AngelBOMenu_HarmonyEmployeeCode] ON [dbo].[AngelBOMenu] ([HarmonyEmployeeCode])

GO

-- --------------------------------------------------
-- INDEX dbo.angelclient1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [INDX_AngelClient1] ON [dbo].[angelclient1] ([Party_Code], [Short_Name], [Long_Name], [Sub_Broker], [ActiveFrom], [InActiveFrom], [ActiveFromEq], [InactiveFromEq], [ActiveFromComm], [InactiveFromComm], [FirstTrade], [AngelClRating], [B2C], [EbrokingClient], [ActiveFromCurr], [InactiveFromCurr])

GO

-- --------------------------------------------------
-- INDEX dbo.angelclient1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_angelclient1_Party_Code_Cl_type] ON [dbo].[angelclient1] ([Party_Code], [Cl_type]) INCLUDE ([Long_Name], [Sub_Broker])

GO

-- --------------------------------------------------
-- INDEX dbo.AngelUsers
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_AngelUsers_HarmonyEmployeeCode_MimansaStatusid] ON [dbo].[AngelUsers] ([HarmonyEmployeeCode], [MimansaStatusid])

GO

-- --------------------------------------------------
-- INDEX dbo.B2B_CommonPartyServices
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Index_B2BMIS] ON [dbo].[B2B_CommonPartyServices] ([Branch_cd], [FromDate], [ToDate]) INCLUDE ([Party_Code], [Emp_No])

GO

-- --------------------------------------------------
-- INDEX dbo.B2B_CommonPartyServices
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Index_CommonPartyServices] ON [dbo].[B2B_CommonPartyServices] ([Party_Code], [Emp_No], [FromDate], [ToDate], [Valid], [CommRank], [Branch_cd], [Segment_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.B2B_CommonPartyServices
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Index_ForOptimization] ON [dbo].[B2B_CommonPartyServices] ([FromDate], [ToDate]) INCLUDE ([Party_Code], [Emp_No], [Branch_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.B2B_CommonPartyServices
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NC_B2B_CommonPartyServices_EmpNo_Valid_ToDate] ON [dbo].[B2B_CommonPartyServices] ([Emp_No], [Valid], [ToDate]) INCLUDE ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.B2B_CommonPartyServices_Offline
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NonClusteredIndex-20220722-175820] ON [dbo].[B2B_CommonPartyServices_Offline] ([Party_Code], [To_Be_Processed])

GO

-- --------------------------------------------------
-- INDEX dbo.TABLE_DATE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Idx_Table_date] ON [dbo].[TABLE_DATE] ([CMTradingDay], [DATE], [Sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.TABLE_DATE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDX_Table_Sauda_Date] ON [dbo].[TABLE_DATE] ([CurrTradingDay], [Sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.TABLE_DATE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [INDX_FOR_TBLDATE] ON [dbo].[TABLE_DATE] ([EffSauda_date]) INCLUDE ([Sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.TABLE_DATE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [INDX_TABLEDATE] ON [dbo].[TABLE_DATE] ([CMTradingDay], [CommTradingday], [EffSauda_date], [Sauda_date], [CurrTradingDay])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_AppLog
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_Usercode] ON [dbo].[tbl_AppLog] ([UserCode], [LogDateTime]) INCLUDE ([Emp_no])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_B2B_CRMS_SelfCertification_DSC
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NonClusteredIndex-20170911-143659] ON [dbo].[tbl_B2B_CRMS_SelfCertification_DSC] ([Sub_Broker])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Capability_Master
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UQ__tbl_Capability_M__339FAB6E] ON [dbo].[tbl_Capability_Master] ([pid_tbl_Capability_mst])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Capability_Master
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UQ__tbl_Capability_M__3493CFA7] ON [dbo].[tbl_Capability_Master] ([Capability_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_Client_ProfileSubProfile
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [INDX_PROFILESUBPROFILE] ON [dbo].[Tbl_Client_ProfileSubProfile] ([Party_Code]) INCLUDE ([Profile], [Sub_Profile])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Emp_Master
-- --------------------------------------------------
CREATE CLUSTERED INDEX [cluidx_Emp_No] ON [dbo].[tbl_Emp_Master] ([Emp_No])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Emp_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_tbl_Emp_Master_Sb_Tag] ON [dbo].[tbl_Emp_Master] ([Sb_Tag])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Emp_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_tbl_Emp_Master_User_ID] ON [dbo].[tbl_Emp_Master] ([User_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Emp_Master
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UQ__tbl_Emp_Master__17F790F9] ON [dbo].[tbl_Emp_Master] ([Emp_No])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_EmployeeView
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_tbl_EmployeeView_emp_no] ON [dbo].[tbl_EmployeeView] ([emp_no])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_MailMessage_Master
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UQ__tbl_MailMessage___2EDAF651] ON [dbo].[tbl_MailMessage_Master] ([MM_Id])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Role_Master
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UQ__tbl_Role_Master__30C33EC3] ON [dbo].[tbl_Role_Master] ([pid_tbl_Role_mst])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Role_Master
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UQ__tbl_Role_Master__31B762FC] ON [dbo].[tbl_Role_Master] ([Role_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_SbContact_Detail
-- --------------------------------------------------
CREATE CLUSTERED INDEX [cluidx_pid] ON [dbo].[tbl_SbContact_Detail] ([pid])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.B2B_CommonPartyServices
-- --------------------------------------------------
ALTER TABLE [dbo].[B2B_CommonPartyServices] ADD CONSTRAINT [PK_PartyDealerMapping] PRIMARY KEY ([ServiceID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sqlmapoutput
-- --------------------------------------------------
ALTER TABLE [dbo].[sqlmapoutput] ADD CONSTRAINT [PK__sqlmapou__3213E83FEF8194E2] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_BIMenu
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_BIMenu] ADD CONSTRAINT [PK_tbl_BIMenu] PRIMARY KEY ([MenuID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Capability_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Capability_Master] ADD CONSTRAINT [UQ__tbl_Capability_M__339FAB6E] UNIQUE ([pid_tbl_Capability_mst])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Capability_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Capability_Master] ADD CONSTRAINT [UQ__tbl_Capability_M__3493CFA7] UNIQUE ([Capability_Name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Emp_Capability
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Emp_Capability] ADD CONSTRAINT [PK__tbl_Emp_Capabili__22751F6C] PRIMARY KEY ([Emp_No], [Fkid_tbl_Capability_mst])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Emp_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Emp_Master] ADD CONSTRAINT [UQ__tbl_Emp_Master__17F790F9] UNIQUE ([Emp_No])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Emp_Role
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Emp_Role] ADD CONSTRAINT [PK__tbl_Emp_Role__1F98B2C1] PRIMARY KEY ([Emp_No], [Fkid_tbl_Role_mst])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Emp_Salary_Increment_Dashboard
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Emp_Salary_Increment_Dashboard] ADD CONSTRAINT [PK__tbl_Emp___3214EC07178D7CA5] PRIMARY KEY ([Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_MailMessage_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_MailMessage_Master] ADD CONSTRAINT [UQ__tbl_MailMessage___2EDAF651] UNIQUE ([MM_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Role_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Role_Master] ADD CONSTRAINT [UQ__tbl_Role_Master__30C33EC3] UNIQUE ([pid_tbl_Role_mst])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Role_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Role_Master] ADD CONSTRAINT [UQ__tbl_Role_Master__31B762FC] UNIQUE ([Role_Name])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.add_notice
-- --------------------------------------------------
CREATE procedure [dbo].[add_notice]
(
@nid varchar(50),
@reqID varchar(20),
@hodNo varchar(20),
@empno varchar(20),
@pino varchar(20),
@note varchar(100),
@noteDate varchar(20),
@message varchar(100),
@subject varchar(100),
@ischecked int,
@catname varchar(100),
@itemName varchar(100),
@status varchar(4)
)
as 
insert into Notifications values(@nid, @reqID, @hodNo, @empno,@pino, @note, @noteDate,@message,@subject,@ischecked,@catname,@itemname,@status)
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.addToOrderQueue
-- --------------------------------------------------
CREATE procedure [dbo].[addToOrderQueue]
(
@ordid varchar(50),
@hodid varchar(25),
@itemid varchar(50),
@qty float,
@reqid varchar(25)
--,@stat integer--,@initQty float,@newQty float
)
as
--@initQty = select qty from Order_Queue where hod_no = @hodid and itemid = @itemid
--@newQty = @qty - @initQty
Declare @rate float

select @rate=rate from InventoryItem where Itemid = @itemId

insert into Order_Queue values(@ordid,@hodid,@itemid,@qty,0,0,@rate)
update UserRequest set orderID=@ordiD where ReqID = @ReqID

return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.auto_complete_extender_all
-- --------------------------------------------------
CREATE procedure [dbo].[auto_complete_extender_all]
(
	@UserEmp_No varchar(20),
	@StatusId varchar(10),
	@StatusName varchar(20),
	@Sub_Broker varchar(10),
	@Dealer Varchar(20),
	@key varchar(10)
	
)
as 
begin
/*
	--exec auto_complete_extender_all 'Et001','SUBBROKER','ET','et','','SUBBROKER'
	--exec auto_complete_extender_all 'Eta002','SBDEALER','Eta002','','','SBDEALER'
	--exec auto_complete_extender_all @UserEmp_No='ET001',@StatusId='SUBBROKER',@StatusName='ET', @Sub_Broker='et', @Dealer='', @key='SUBBROKER'
	--exec auto_complete_extender_all @UserEmp_No='ET001',@StatusId='SUBBROKER',@StatusName='ET', @Sub_Broker='et', @Dealer='', @key='SUBBROKER'
exec auto_complete_extender_all @UserEmp_No='CA001',@StatusId='SUBBROKER',@StatusName='CA', @Sub_Broker='CA', @Dealer='ca', @key='SBDEALER'
*/	
	declare @tempbranch  table                                                                
	(                                                                
		sb_tag varchar(20)--,dealers varchar(30)                                                                                                                          
	)
	
	insert into @tempbranch 
	select distinct sb_tag=sb_tag FROM dbo.b2b_crms_mimansa_status(@UserEmp_No)
	
	
	
	if(@key='SUBBROKER')
	begin
		select 
			distinct item=a.sb_tag 
		from 
			@tempbranch a ,B2B_AngelHarmony a1 with(nolock)
		where 
			a.sb_tag=a1.sb_tag and
			a.sb_tag like '%' + @Sub_Broker +'%' and
			a1.emp_no like '%' + @Dealer     +'%'
		order by a.sb_tag	
	end
	else if(@key='SBDEALER')
	begin
		select 
			distinct item=emp_no 
		from 
			@tempbranch a ,B2B_AngelHarmony a1 with(nolock)
		where 
			a.sb_tag=a1.sb_tag and
			a.sb_tag like '%' + @Sub_Broker +'%' and
			a1.emp_no like '%' + @Dealer     +'%' and
			a1.isdealer=1
		order by emp_no
	end	
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.auto_complete_extender_dealer_mapping
-- --------------------------------------------------
CREATE procedure [dbo].[auto_complete_extender_dealer_mapping]
(
	@UserEmp_No varchar(20),
	@StatusId varchar(10),
	@StatusName varchar(20),
	@Sub_Broker varchar(10),
	@Dealer Varchar(20),
	@dealer1 varchar(20),
	@key varchar(10)
	
)
as 
begin
/*
	--exec auto_complete_extender_all 'Et001','SUBBROKER','ET','et','','SBDEALER'
	--exec auto_complete_extender_all 'Eta002','SBDEALER','Eta002','','','DEALER'
	--exec auto_complete_extender_all @UserEmp_No='ET001',@StatusId='SUBBROKER',@StatusName='ET', @Sub_Broker='et', @Dealer='', @key='SUBBROKER'
exec auto_complete_extender_all_bak @UserEmp_No='ET001',@StatusId='SUBBROKER',@StatusName='ET', @Sub_Broker='', @Dealer='et', @Dealer1='et001',@key='SBDEALER'
exec auto_complete_extender_all_bak @UserEmp_No='CA001',@StatusId='SUBBROKER',@StatusName='CA', @Sub_Broker='CA', @Dealer='ca', @dealer1='ca001',@key='SBDEALER'
*/	
	declare @tempbranch  table                                                                
	(                                                                
		sb_tag varchar(20)--,dealers varchar(30)                                                                                                                          
	)
	
	insert into @tempbranch 
	select distinct sb_tag=sb_tag FROM dbo.b2b_crms_mimansa_status(@UserEmp_No)
	
	
	
	if(@key='SUBBROKER')
	begin
		select 
			distinct item=a.sb_tag 
		from 
			@tempbranch a ,B2B_AngelHarmony a1 with(nolock)
		where 
			a.sb_tag=a1.sb_tag and
			a.sb_tag like '%' + @Sub_Broker +'%' and
			a1.emp_no like '%' + @Dealer     +'%'
		order by a.sb_tag	
	end
	else if(@key='SBDEALER')
	begin
		print 'hhh'
		select item=a2.emp_no + 
			   case when landline_no=0 then '--No Contact information' 
			    	when status='T' then '--Dealer is Terminited'
			    	else (select '--Mapped Clients: ' + cast(count(party_code) as varchar) from b2b_commonpartyservices ps with(nolock) where ps.emp_no= a2.emp_no and valid='Y' )
			    	end
		from(
		select 
			distinct 
			emp_no, 
			landline_no=len(isnull(landline_no,'')),
			status  
		from 
			@tempbranch a ,B2B_AngelHarmony a1 with(nolock)
		where 
			a.sb_tag=a1.sb_tag and
			a.sb_tag like '%' + @Sub_Broker +'%' and
			a1.emp_no like '%' + @Dealer     +'%' and
			a1.emp_no<>@dealer1 and
			a1.isdealer=1
		)a2
		
	end	
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_clientQuickList
-- --------------------------------------------------
                      
                          
CREATE Procedure [dbo].[B2B_CRMS_clientQuickList]                                          
(          
  @Emp_No varchar(20),                                                        
  @StatusId varchar(20),                                          
  @StatusName varchar(20),                                         
  --@UserLevel varchar(15),                                                        
                       
  @strPartyCode varchar(20)
)                                          
                                          
As                                          
/*                          
 Exec B2B_CRMS_clientQuickList 'BROKER', 'BROKER', 'E06130','A32069'
 Exec B2B_CRMS_clientQuickList  'Broker', 'broker', 'p00045','a10026'    
 B2B_CRMS_clientQuickList @Emp_No='p00045',@StatusId='SB',@StatusName='ca',@strPartyCode='a10026'
 B2B_CRMS_clientQuickList @Emp_No='p00045',@StatusId='SB',@StatusName='ca',@strPartyCode='A10926'
 B2B_CRMS_clientQuickList @Emp_No='p00045',@StatusId='SBEMP',@StatusName='caa001',@strPartyCode='A10926'
 B2B_CRMS_clientQuickList @Emp_No='p00045',@StatusId='SBEMP',@StatusName='caa001',@strPartyCode='A13135'
 B2B_CRMS_clientQuickList @Emp_No='Ca001',@StatusId='SUBBROEKR',@StatusName='ca',@strPartyCode='A32069'
 B2B_CRMS_clientQuickList @Emp_No='Ca001',@StatusId='SUBBROEKR',@StatusName='ca',@strPartyCode='2121'
select upper('Invalid Client Code')
select party_code from angelclient1 with(nolock) where party_code='A32069' 

*/                          
begin                          
if exists(select party_code from angelclient1 with(nolock) where Party_Code=@strPartyCode)                          
begin
	                                        
	Declare @@RmDealer varchar(20)                                          
	set @@RmDealer = '%'                                                     

	if ltrim(rtrim(@StatusId)) = 'SBDEALER'                                            
	begin                                            
		set @@RmDealer = @StatusName                                             
	end                                            
	                               
	                          
	if len(ltrim(rtrim(isnull(@strPartyCode, '')))) = 0 begin                          
	 set @strPartyCode = '%'                          
	end                          
	      
	    
	                                 
	if @StatusId = 'SBDEALER'     
	begin                                       
			 --print @StatusId  
	select top 1 
		P.Party_code , 
		Short_Name = A.Long_Name
	From 
		B2B_CommonPartyServices P with(nolock),angelclient1 A with(nolock)       
	Where         
		P.Party_code = A.Party_code and        
		P.Party_Code=@strPartyCode   and 
		emp_no=@@RmDealer          and 
		cl_type <>'sub'  and 
		b2c='n'        

	end               
	else   
		begin     
		--print 'angelclient1'     
		
		declare @tempbranch  table                                                                
		(                                                                
		Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
		)
		
		
		Insert into @tempbranch
		select * from b2b_crms_mimansa_status(@Emp_No) 
		                       
		 select Distinct 
			A.Party_code , 
			[Short_Name] = A.Long_Name                                         
		 From 
			angelclient1 A with(nolock) 
			--risk.dbo.client_Details a with(nolock)
		 where                                            
			A.party_code like  ltrim(rtrim(@strPartyCode)) and                                           
			--A.RMDealer like '%' and 
			a.cl_type <>'sub'     and
			a.sub_broker in (select  Branch_cd from @tempbranch)
			--@StatusName
		 order by
			A.Party_code 
		end
	end	
	else
	begin
		select remark='Invalid Client Code'
	end			  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.b2b_crms_dealer_auto_complete
-- --------------------------------------------------
CREATE procedure [dbo].[b2b_crms_dealer_auto_complete]
(
	@dealer_text varchar(20),
	@sub_broker varchar(10)
)
as
begin
--exec b2b_crms_dealer_auto_complete @dealer_text='ca', @sub_broker='ca'
--exec b2b_crms_dealer_auto_complete @dealer_text='et', @sub_broker='eta'
--exec b2b_crms_dealer_auto_complete 'e','et'
--exec b2b_crms_dealer_auto_complete 'e','eta'



	declare @parenttag varchar(10)
	declare @count int
	declare @sb_tag varchar(10)
	
	select @sb_tag=sb_tag from B2B_AngelHarmony with(nolock) where emp_no=@sub_broker

	DECLARE  @temp_sb_list table
	(
		sb_list varchar(10)
	)

		select 
			@parenttag=parenttag 
		from 
			MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		where 
			sbtag=upper(@sb_tag)
		
		if @parenttag is not null
		begin
			--select output=@sub_broker
			insert into @temp_sb_list select @sb_tag
		end
		else
		begin
			select 
				@count=count(sbtag) 
			from 
				MIS.sb_comp.dbo.sb_broker WITH (nolock)
			where
				parenttag=upper(@sb_tag)
				
			if(@count>0)
			begin
				insert into @temp_sb_list select sbtag from
				(
				select 
					sbtag 
				from 
					MIS.sb_comp.dbo.sb_broker with(nolock)
				where 
					parenttag=upper(@sb_tag) 
				
				union
				
				select sbtag=upper(@sb_tag)
				)a
			end
			else
			begin
				--select output=@sub_broker
				insert into @temp_sb_list select @sb_tag
			end
			
		end
	
	--select * from @temp_sb_list
	

select emp_no from B2B_AngelHarmony with(nolock) , @temp_sb_list 
where 
	emp_no like @dealer_text + '%' and
	sb_tag=sb_list and
	isdealer=1


end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.b2b_crms_dealer_client_status
-- --------------------------------------------------
CREATE procedure [dbo].[b2b_crms_dealer_client_status]
(
	@Dealer varchar(10)
)
as 
begin
	--exec b2b_crms_dealer_client_status 'eta001'
	--exec b2b_crms_dealer_client_status 'eta002'
	--exec b2b_crms_dealer_client_status 'p00045'
	
	declare @count as int
	
	if exists (select emp_no  from  B2B_AngelHarmony with(nolock) where emp_no=@Dealer and isDealer=1)
	begin
		select @count=count(distinct party_code) from B2B_CommonPartyServices with(nolock) where emp_no=@Dealer and valid='Y' 
		if @count > 0 
		begin
			select status=1
			insert into log_dealer_status  (Dealer,count,response,updatingdatetime) (select @Dealer,isnull(@count,0),1,getdate())
		end
		else
		begin
			select status=0
			insert into log_dealer_status (Dealer,count,response,updatingdatetime) (select @Dealer,isnull(@count,0),1,getdate())
		end	
	end	
	else
	begin
		select status=0
		insert into log_dealer_status (Dealer,count,response,updatingdatetime) (select @Dealer,isnull(@count,0),1,getdate())
	end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping
-- --------------------------------------------------
CREATE proc [dbo].[B2B_CRMS_DealerMapping]                                                                    
(                                                                    
	@Emp_No varchar(20), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(20),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(20),                                                                    
	@ToDealer varchar(20),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100),                                
	@smsFlag varchar(10),
	@Segment_Type Varchar(20),
	@ProcessId Varchar(50)                                                                     
)   
WITH RECOMPILE                                                                 
AS      
BEGIN    
/*
	Exec B2B_CRMS_DealerMapping_ADTest 
	@Emp_No='CBHO001',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='AIL',
	@FromDealer='',@ToDealer='CBHO001',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId=''
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 

*/
SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
			@@StatusName varchar(20),                                                                                                                                                                                               
			@@Emp_No varchar(20),                                                                    
			@@PartyCode varchar(10),                                                                       
			@@Branch_cd varchar(10),                                                                   
			@@FromDealer varchar(20),                                                                    
			@@ToDealer varchar(20),                                                                 
			@@ReportFlag varchar(100),                                                           
			@@smsFlag varchar(10),
			@@FromParty varchar(10) ,
			@@ToParty   varchar(10),
			@@Segment_Type varchar(20),
			@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	SET @@smsFlag=@smsFlag
	SET @@Segment_Type = @Segment_Type
	SET @@ProcessId = @ProcessId 
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end
	
	if @@ReportFlag='LIST'
	BEGIN
		
		Print 'List:--> Start:-->'+ convert(varchar,getdate(),109)
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		--Checking if Dealer Data available in mini harmony.
		--print len(@@FromDealer)
		--print @@FromDealer
		--if((upper(@@FromDealer)<>'UNDEFINED') or (len(@@FromDealer)<>0))
		--begin
		--	if not exists
		--	(select empcode from B2B_Harmony with(nolock) where empcode=@@FromDealer)
 	--		Begin
 	--			Select  msg = 'Existing Dealer Not Available in harmony sdfsdfsdf.'                                                                    
		--		return  
		--	end
		--end	
		
		--Commented by prasanna after change in BRS on Jun 23 2012
		
		if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		if(len(@@FromDealer)<>0)
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@FromDealer)
 			Begin
 				Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    
				return  
			end
		end
		Print 'List:--> Step 1:-->'+ convert(varchar,getdate(),109)
	--	--Mappging to employee other than dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	----------
	--	--Checking if Dealer Data available in mini harmony.
		--if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		--begin
		--	if not exists
		--	(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 	--		Begin
 	--			Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
		--		return  
		--	end
		--end
	----------
	--    --Resigned Dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	----------
		
		
	--------
		--collecting parent and child delear list  	
		--declare  @temp_sbtag table
		--(sbtag varchar(10))
		
		--insert into @temp_sbtag
		--select sbtag from
		--(
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--	Union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=@Branch_cd
		--	union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where sbtag=@Branch_cd
		--	union
		--	select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--)a	
		
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 
		
		--select * from @temp_sbtag	
		--Checking the to dealer belongs to sub broker family
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		Print 'List:--> Step 2:-->'+ convert(varchar,getdate(),109)
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the existing dealer.'                                                                    
			return  
		end 
		
		Print 'List:--> Step 3:-->'+ convert(varchar,getdate(),109)
	---------
		--Checking client sub broker relationship	
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) ,@temp_sbtag
			where sub_broker=sbtag and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		
		
		Declare @mytable table                                    
		(          
			Client_code varchar(10) ,                                                                              
			Client_name varchar(100) ,                                                           
			Sub_Broker varchar(10) ,                               
			Trading_Mode varchar(20),
			Dealer_code_Existing varchar(20),
			Dealer_code_New  varchar(20),
			ColorCode varchar(50)                                                             
		) 
		----
		--print @@FromDealer
		--print @@ToDealer
		--print @@FromParty
		--print @@ToParty
		
		--select * from @temp_sbtag
		
		Insert into @mytable
		(
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode 
		)
		Select 
			Client_code=AC1.Party_code,
			Client_name = AC1.Long_Name,
			AC1.Sub_Broker, 
			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
			Dealer_code_Existing=CPS.Emp_No,
			Dealer_code_New=@@ToDealer,
			ColorCode = ''
		From 
			B2B_CommonPartyServices CPS with (noLock), [MIMANSA].angelcs.dbo.angelClient1 AC1 with (noLock),@temp_sbtag
		Where 
			CPS.Party_Code = AC1.Party_Code                                                                
			And AC1.Sub_Broker = sbtag                                                                    
			And B2C='N'                                                                   
			And Cl_type<>'SUB'                                                                    
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                 
			And CPS.Valid = 'Y'                                                                    
			And CPS.Emp_No like @@FromDealer + '%'                                                                 
			And CPS.Emp_No <> @@ToDealer                                                                  
			And CPS.Party_Code >= @@FromParty 
			And CPS.Party_Code <= @@ToParty                                                                                                                          
			

		IF(@@FromDealer = '' OR @@FromDealer like '%001')
		Begin

			Insert into @mytable
			(
				Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
				ColorCode 
			)
			Select 
				Client_code=AC1.Party_code,
				Client_name = AC1.Long_Name,
				AC1.Sub_Broker, 
				Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
				Dealer_code_Existing=AC1.Sub_Broker + '001',
				Dealer_code_New=@@ToDealer,
				ColorCode = ''
			From @temp_sbtag T,
			[MIMANSA].angelcs.dbo.angelClient1 AC1 with (noLock) LEFT OUTER JOIN B2B_CommonPartyServices CPS with (noLock)
			ON (AC1.party_code = CPS.Party_Code and CPS.valid = 'Y')			
			Where AC1.Sub_Broker = T.sbtag                                                                                                                                       
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                                                                                                                                             
			And AC1.Party_Code >= @@FromParty 
			And AC1.Party_Code <= @@ToParty   
			and AC1.B2C = 'N' And AC1.Cl_type<>'SUB'
			and CPS.party_code is null  
			and AC1.party_code not in (Select Client_code from @mytable)

		End
	---------------------------------------------------------------------                                    

	--Select * from @temp_sbtag

		update 
			@mytable
		set 
			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)
		from
			B2B_CommonPartyServices_Offline P with (nolock), @mytable T
		where
			T.Client_code = P.party_code
			and to_be_processed = 'Y'
			
		
---------------------------------------------------------------
		select  
			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode
		from 
			@mytable order by Client_code
		end
		
		---------CHeck Contact Details of @@ToDealer ----------------------------------------------- 
		--if exists (select top 1 Client_code from @mytable)
		--begin                               
		--		if @@ToDealer='' or upper(@@ToDealer)='UNDEFINED'                                    
		--		begin                                    
		--		 select '' as dealer , '' as contact                                    
		--		end                                    
		--		else if exists(select top 1 emp_no from B2B_AngelHarmony e with(nolock)                                    
		--		 where emp_no=ltrim(rtrim(@@ToDealer))                                    
					                               
		--		) 
		--		begin                                    
		--		-----                        
		--		select 'DEALER' as dealer,                                    
		--		--isnull((select top 1 rtrim(ltrim(STDCode))+'-'+rtrim(ltrim(Phone1)) from crm..CRMBranchContactDetails where ContactPerson=e.emp_no),'') as contact                                    
		--		isnull(landline_no,'') as contact                                    
		--		from B2B_AngelHarmony e with(nolock) 
		--		where emp_no=ltrim(rtrim(@@ToDealer))  
		--		and isDealer='1'                                  
				
				
		--		---                                    
		--		end                                    
		--		else                                     
		--		begin                                     
		--		select '' as dealer , '' as contact                                    
				                                                                        
		--		end  
		--		Print 'List:--> End :-->'+ convert(varchar,getdate(),109)	   
		--end		 
		
----------******************88----------------****************------------------******************8	
	ELSE if (@@ReportFlag='BULK') 
	BEGIN
		/********* RAM Table to maintain the error messages to display in a grid on UI */
		Declare @BulkErrorTable Table
		(
			ProcessId varchar(50),
			Party_Code varchar(10),
			CurrencyDealer Varchar(20),
			ErrorMessages varchar(100)
		)
		
		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */
		Declare @BulkBranch Table
		(
			Party_Code varchar(10),
			Party_Region varchar(10),
			CurrencyDealer varchar(10),
			Dealer_Region varchar(10)
		)	
		
		/************************************************ Validations starts here ****************************************************/
		/* 1. Validation -> Client is a B2C client	*/
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is not a B2B client.'
		from B2B_Bulk_DealerMapping C with (nolock),
			angelclient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'Y'
		and Segment_Type = @@Segment_Type
		/* *****************************************************************/
		
		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++
		/*******Commendted by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients*******/
		/*
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is inactive.'
		from B2B_Bulk_DealerMapping C with (nolock),
			AngelClient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'N'
		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))
		and Segment_Type = @@Segment_Type
		*/
		/*******End Commendted by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients*******/
		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++
		
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee is terminated.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		and A.status='T'
		--and A.TerminationFrom <= GETDATE()
		--and A.InactiveFrom <=getdate()
		
		--and Status <> 'A'
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee does not Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		--and upper(category) not in ('DEALER')
		--and C.Dealer1 <> 'UNDEFINED'
		and isDealer<>1
		and Segment_Type = @@Segment_Type
		/* **************************************************************** */
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++
		/* 5. Validation -> Client code and New dealer are from same Parent tag. */
		create table  #parent_info 
		(
			Party_Code varchar(10),
			Sub_Broker varchar(10),
			client_parent varchar(10), 
			Dealer1 varchar(20),
			SBTag varchar(10),
			sb_parent varchar(10)
		)

		insert into #parent_info
		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.SB_Tag,sb_parent=''   
		from 
			B2B_Bulk_DealerMapping a1 with(nolock),angelclient1 b1 with(nolock),B2B_AngelHarmony c1  with(nolock)
		where ProcessId=@@ProcessID
		and a1.Party_Code=b1.Party_Code
		and c1.Emp_no =a1.Dealer1 
		and c1.isDealer=1
		and Segment_Type = @@Segment_Type


		update #parent_info

		set client_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.Sub_Broker 

		update #parent_info

		set sb_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.SBTag 
		
		Insert into @BulkErrorTable
		select	@@ProcessID,
				Party_Code,
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '
		from #parent_info where sb_parent<>client_parent
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++
		/* 6. Validation -> If client code or  dealer is blank */
		
		Insert into @BulkErrorTable
		select	ProcessId,
		isnull(C.Party_Code, ''),
		CurrencyDealer = isnull(Dealer1, ''),
		ErrorMessages = 'Incomplete data.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where ProcessId = @@ProcessID
		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++
		
		/* 7. Validation -> If Client is already mapped to the same  dealer */
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Dealer already mapped to the client.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_CommonPartyServices P with (nolock)
		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')
		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'
		and C.Segment_Type = P.Segment_Type
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++
		/* 8. Validation -> If client is available more than once in the file, 
				first entry of the client sequentially should be uploaded and remainder should be discarded */
		                
		select party_code, cnt = count(*) into #RemoveDuplicate               
		from B2B_Bulk_DealerMapping with(nolock) where ProcessId = @@ProcessId                 
		group by party_code                 
        HAVING count(*) > 1              
		
		if exists(select Party_Code from #RemoveDuplicate)          
		begin          
			--CURSOR TO UPDATE  			
			Declare @strPartyCode varchar(10)      
			Declare @totalcountForCursor int       
			Declare RemoveDuplicateCursor cursor for   
			--          
			select Party_Code, cnt from #RemoveDuplicate          
			--          
			Open RemoveDuplicateCursor           
			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          

			While @@FETCH_STATUS = 0                                                                                                                      
			Begin           
				set @totalcountForCursor=@totalcountForCursor-1          
				set rowcount @totalcountForCursor          
				--          
				Insert into @BulkErrorTable
				select distinct	C.ProcessId,
						isnull(C.Party_Code, ''),
						CurrencyDealer = isnull(Dealer1, ''),
						ErrorMessages = 'Duplicate entry.'
				from B2B_Bulk_DealerMapping C with (nolock)
				where C.ProcessId = @@ProcessId
				and isnull(C.Party_Code, '') = @strPartyCode
				and C.Segment_Type = @@Segment_Type  
				
				Delete from B2B_Bulk_DealerMapping  
				where ProcessId = @@ProcessId
				and isnull(Party_Code, '') = @strPartyCode
				and Segment_Type = @@Segment_Type 

				fetch next from RemoveDuplicateCursor                                                                   
				into @strPartyCode,@totalcountForCursor          
			END          
			close RemoveDuplicateCursor                                                                                                    
			deallocate RemoveDuplicateCursor          
			------------------------------------          
			drop table #RemoveDuplicate          
			set rowcount 0          
		end    
		
		
	
	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++
		/* 9. Validation -> If client code is invalid */
		
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID 
		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)
		and isnull(C.Party_Code, '') <> ''
		and C.Segment_Type = @@Segment_Type
		
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 not in (select Emp_No from B2B_AngelHarmony A with (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Dealer1 = A.Emp_No and ProcessId = @@ProcessID)
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Invalid row'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 is null
		and Party_Code is null
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++
		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Update contact details of Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_AngelHarmony E with (nolock)
		where E.Emp_no = isnull(C.Dealer1, '') 		
		and C.ProcessId = @@ProcessID
		and len(isnull(E.Landline_no,''))=0
		and e.isDealer=1
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		Delete B2B_Bulk_DealerMapping
		from @BulkErrorTable B
		where isnull(B2B_Bulk_DealerMapping.Party_Code, '') = isnull(B.Party_Code, '') 
		and B2B_Bulk_DealerMapping.Segment_Type = @@Segment_Type 
		and isnull(B2B_Bulk_DealerMapping.Dealer1, '') = isnull(B.CurrencyDealer, '') 
		and B2B_Bulk_DealerMapping.ProcessId = B.ProcessId
		and B2B_Bulk_DealerMapping.ProcessId = @@ProcessID
		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation
		/* ************* Selecting the records from error table *************** */
		
		select	Client_Code = ltrim(rtrim(Party_Code)), 
				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),
				ErrorMessages = ErrorMessages   
		from @BulkErrorTable
		where ProcessId = @@ProcessID
		
		select cnt = COUNT(*) from B2B_Bulk_DealerMapping with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type
		
		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID
		
	END
	ELSE if (@@ReportFlag='SAVE') 
	BEGIN
		print 'SAVE'
		

		Select M.party_code 
		into #InvalidClientCodes
		from B2B_Bulk_DealerMapping M with (nolock) LEFT OUTER JOIN angelclient1 a1 with(nolock)
		ON (M.party_code = a1.party_code)
		where M.ProcessId = @@ProcessId
		and M.Segment_Type = @@Segment_Type
		and a1.party_code is null

		Declare @Invalid_Party_code varchar(max)

		SELECT @Invalid_Party_code = STUFF
		(
			(
				SELECT ',' + s.party_code 
				FROM #InvalidClientCodes s
				ORDER BY s.party_code FOR XML PATH('')
			),
			 1, 1, ''
		)

		IF EXISTS (Select top 1 party_code from #InvalidClientCodes)
		BEGIN
			select msg = 'Error: Unable to upload file. Uploaded file contains invalid client codes (Invalid List: ' + @Invalid_Party_code + ')'
			RETURN;
		END

		declare  @temp_sbtag1 table
		(sbtag varchar(10))
		
		insert into @temp_sbtag1
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 

		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
	--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag1 b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		
		if Len(@@FromDealer)=0 
		Begin
 			Select  msg = 'Please Enter From Dealer'                                                                    
			return  
		end 
			
		If Exists(Select O.Party_code 
					from B2B_CommonPartyServices_Offline O with (nolock), B2B_Bulk_DealerMapping M with (nolock) 
					where O.Party_Code = M.Party_Code and
					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)
		Begin
			update B2B_CommonPartyServices_Offline
			set To_Be_Processed = 'N',
			process_time_stamp = getdate(),                                        
			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     
			from B2B_Bulk_DealerMapping M with (nolock), B2B_CommonPartyServices_Offline C with (nolock)                                  
			where C.Party_Code = M.Party_Code
			and To_Be_Processed = 'Y'
			and C.Segment_Type = M.Segment_Type
			and C.Segment_Type = @@Segment_Type
			and ProcessId = @@ProcessId
		End

		if(@@Branch_cd <> '')
		begin
			insert into B2B_CommonPartyServices_Offline 
			(
				Party_Code,
				Branch_Cd,
				Source_Dealer_Code,
				Target_Dealer_Code,
				From_Date,
				To_Date,
				Entry_Time_Stamp,
				To_Be_Processed,
				Process_Time_Stamp,
				Reason_For_Non_Process,
				Other_Remarks,
				Status_Id,
				Status_Name,
				Emp_No,
				Segment_Type,
				CommRank
			)
			Select 
				Party_code, 
				--@@Branch_cd=select , 
				--Branch_cd=(select sb_tag from B2B_AngelHarmony with(nolock) where emp_no=dealer1) , 
				Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B2B_Bulk_DealerMapping.Party_Code) , 
				@@FromDealer, 
				--Dealer1,
				@ToDealer,
				left(getdate(), 11) + ' 00:00:00',
				'Dec 31 2049 23:59:00',
				getdate(), 
				'Y', 
				'Jan  1 1900 00:00:00', 
				'', 
				'',
				@@StatusId, 
				@@StatusName, 
				@@Emp_No, 
				@@Segment_Type, 
				1
			from B2B_Bulk_DealerMapping with (nolock)
			where ProcessId = @@ProcessId
			and Segment_Type = @@Segment_Type
		end
		else
		begin
			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			B.Party_code,
			--Branch_cd, 
			Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B.Party_Code) , 
			/*CurrencyDealer --- need to be added later*/EMP_No, 
			Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 
			'Y', 
			'Jan  1 1900 00:00:00', 
			'', 
			'',
			@@StatusId, 
			@@StatusName, 
			@@Emp_No, 
			@@Segment_Type,
			1
			from B2B_Bulk_DealerMapping B with (nolock), B2B_CommonPartyServices A with (nolock)
			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code
			and b.Segment_Type = @@Segment_Type
			and valid='Y'
		end
		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'
		
		-- Set the Flag true for the valid entry of Client mapping	 
              
				-- Code to send the SMS for valid client mapping                                                             
				If (@@smsFlag = 'YES') 
				begin
					insert into TBL_B2B_CRMS_SMS_DEALER_MAPPING
					(
						party_code,
						party_mobile,
						sub_broker,
						sub_broker_name,
						DealerCode,
						DealerName,
						DealerContact
					) 
					Select 
						B.Party_code,
						mobileNo=(case when len(rtrim(ltrim(mobile_pager)))=10 then rtrim(ltrim(mobile_pager)) else 'NA' end) ,
						A.Sub_broker,
						Sub_Broker_Name=(select tradename from MIS.sb_comp.dbo.sb_broker with(nolock) where sbtag=a.sub_broker),
						B.Dealer1,
						--dealerName=(select emp_name from B2B_AngelHarmony e with(nolock) where e.emp_no=B.Dealer1 and isdealer='1'),
						dealerName=emp_name,
						contactNo=landline_no
					 from 
						B2B_Bulk_DealerMapping B with (nolock), angelclient1 A with (nolock),B2B_AngelHarmony  with(nolock)
					 where 
						ProcessId = @@ProcessId and 
						A.Party_Code = B.Party_Code
						and Segment_Type = @@Segment_Type
						and rtrim(ltrim(AngelClRating))<>'NEW'
						and emp_no=B.Dealer1
						and isdealer='1'
						--and isadmin<>'1'
    			end
	end				           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_ADTest
-- --------------------------------------------------


--exec Mimansa.dbo.B2B_CRMS_DealerMapping_ADTest 
--@Segment_Type='ALL',@PartyCode='A98603',@ProcessId='SSIENXT201905231036262219693',
--@FromDealer='ssie004',@ReportFlag='SAVE',@Emp_No='SSIE001',@StatusId='Subbroker',
--@Branch_cd='SSIE',@StatusName='SSIE',@smsFlag='No',@ToDealer='ssie001'



CREATE proc [dbo].[B2B_CRMS_DealerMapping_ADTest]                                                                    
(                                                                    
	@Emp_No varchar(20), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(20),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(20),                                                                    
	@ToDealer varchar(20),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100),                                
	@smsFlag varchar(10),
	@Segment_Type Varchar(20),
	@ProcessId Varchar(50)                                                                     
)   
WITH RECOMPILE                                                                 
AS      
BEGIN    
/*
	Exec B2B_CRMS_DealerMapping_ADTest 
	@Emp_No='CBHO001',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='AIL',
	@FromDealer='',@ToDealer='CBHO001',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId=''
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 

*/
SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
			@@StatusName varchar(20),                                                                                                                                                                                               
			@@Emp_No varchar(20),                                                                    
			@@PartyCode varchar(10),                                                                       
			@@Branch_cd varchar(10),                                                                   
			@@FromDealer varchar(20),                                                                    
			@@ToDealer varchar(20),                                                                 
			@@ReportFlag varchar(100),                                                           
			@@smsFlag varchar(10),
			@@FromParty varchar(10) ,
			@@ToParty   varchar(10),
			@@Segment_Type varchar(20),
			@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	SET @@smsFlag=@smsFlag
	SET @@Segment_Type = @Segment_Type
	SET @@ProcessId = @ProcessId 
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end
	
	if @@ReportFlag='LIST'
	BEGIN
		
		Print 'List:--> Start:-->'+ convert(varchar,getdate(),109)
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		--Checking if Dealer Data available in mini harmony.
		--print len(@@FromDealer)
		--print @@FromDealer
		--if((upper(@@FromDealer)<>'UNDEFINED') or (len(@@FromDealer)<>0))
		--begin
		--	if not exists
		--	(select empcode from B2B_Harmony with(nolock) where empcode=@@FromDealer)
 	--		Begin
 	--			Select  msg = 'Existing Dealer Not Available in harmony sdfsdfsdf.'                                                                    
		--		return  
		--	end
		--end	
		
		--Commented by prasanna after change in BRS on Jun 23 2012
		
		if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		if(len(@@FromDealer)<>0)
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@FromDealer)
 			Begin
 				Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    
				return  
			end
		end
		Print 'List:--> Step 1:-->'+ convert(varchar,getdate(),109)
	--	--Mappging to employee other than dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	----------
	--	--Checking if Dealer Data available in mini harmony.
		--if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		--begin
		--	if not exists
		--	(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 	--		Begin
 	--			Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
		--		return  
		--	end
		--end
	----------
	--    --Resigned Dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	----------
		
		
	--------
		--collecting parent and child delear list  	
		--declare  @temp_sbtag table
		--(sbtag varchar(10))
		
		--insert into @temp_sbtag
		--select sbtag from
		--(
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--	Union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=@Branch_cd
		--	union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where sbtag=@Branch_cd
		--	union
		--	select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--)a	
		
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 
		
		--select * from @temp_sbtag	
		--Checking the to dealer belongs to sub broker family
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		Print 'List:--> Step 2:-->'+ convert(varchar,getdate(),109)
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the existing dealer.'                                                                    
			return  
		end 
		
		Print 'List:--> Step 3:-->'+ convert(varchar,getdate(),109)
	---------
		--Checking client sub broker relationship	
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) ,@temp_sbtag
			where sub_broker=sbtag and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		
		
		Declare @mytable table                                    
		(          
			Client_code varchar(10) ,                                                                              
			Client_name varchar(100) ,                                                           
			Sub_Broker varchar(10) ,                               
			Trading_Mode varchar(20),
			Dealer_code_Existing varchar(20),
			Dealer_code_New  varchar(20),
			ColorCode varchar(50)                                                             
		) 
		----
		--print @@FromDealer
		--print @@ToDealer
		--print @@FromParty
		--print @@ToParty
		
		--select * from @temp_sbtag
		
		Insert into @mytable
		(
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode 
		)
		Select 
			Client_code=AC1.Party_code,
			Client_name = AC1.Long_Name,
			AC1.Sub_Broker, 
			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
			Dealer_code_Existing=CPS.Emp_No,
			Dealer_code_New=@@ToDealer,
			ColorCode = ''
		From 
			B2B_CommonPartyServices CPS with (noLock), MIMANSA.angelcs.dbo.angelClient1 AC1 with (noLock),@temp_sbtag
		Where 
			CPS.Party_Code = AC1.Party_Code                                                                
			And AC1.Sub_Broker = sbtag                                                                    
			And B2C='N'                                                                   
			And Cl_type<>'SUB'                                                                    
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                 
			And CPS.Valid = 'Y'                                                                    
			And CPS.Emp_No like @@FromDealer + '%'                                                                 
			And CPS.Emp_No <> @@ToDealer                                                                  
			And CPS.Party_Code >= @@FromParty 
			And CPS.Party_Code <= @@ToParty                                                                                                                          
			

		IF(@@FromDealer = '' OR @@FromDealer like '%001')
		Begin

			Insert into @mytable
			(
				Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
				ColorCode 
			)
			Select 
				Client_code=AC1.Party_code,
				Client_name = AC1.Long_Name,
				AC1.Sub_Broker, 
				Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
				Dealer_code_Existing=AC1.Sub_Broker + '001',
				Dealer_code_New=@@ToDealer,
				ColorCode = ''
			From @temp_sbtag T,
			MIMANSA.angelcs.dbo.angelClient1 AC1 with (noLock) LEFT OUTER JOIN B2B_CommonPartyServices CPS with (noLock)
			ON (AC1.party_code = CPS.Party_Code and CPS.valid = 'Y')			
			Where AC1.Sub_Broker = T.sbtag                                                                                                                                       
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                                                                                                                                             
			And AC1.Party_Code >= @@FromParty 
			And AC1.Party_Code <= @@ToParty   
			and AC1.B2C = 'N' And AC1.Cl_type<>'SUB'
			and CPS.party_code is null  
			and AC1.party_code not in (Select Client_code from @mytable)

		End
	---------------------------------------------------------------------                                    

	--Select * from @temp_sbtag

		update 
			@mytable
		set 
			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)
		from
			B2B_CommonPartyServices_Offline P with (nolock), @mytable T
		where
			T.Client_code = P.party_code
			and to_be_processed = 'Y'
			
		
---------------------------------------------------------------
		select  
			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode
		from 
			@mytable order by Client_code
		end
		
		---------CHeck Contact Details of @@ToDealer ----------------------------------------------- 
		if exists (select top 1 Client_code from @mytable)
		begin                               
				if @@ToDealer='' or upper(@@ToDealer)='UNDEFINED'                                    
				begin                                    
				 select '' as dealer , '' as contact                                    
				end                                    
				else if exists(select top 1 emp_no from B2B_AngelHarmony e with(nolock)                                    
				 where emp_no=ltrim(rtrim(@@ToDealer))                                    
					                               
				) 
				begin                                    
				-----                        
				select 'DEALER' as dealer,                                    
				--isnull((select top 1 rtrim(ltrim(STDCode))+'-'+rtrim(ltrim(Phone1)) from crm..CRMBranchContactDetails where ContactPerson=e.emp_no),'') as contact                                    
				isnull(landline_no,'') as contact                                    
				from B2B_AngelHarmony e with(nolock) 
				where emp_no=ltrim(rtrim(@@ToDealer))  
				and isDealer='1'                                  
				
				
				---                                    
				end                                    
				else                                     
				begin                                     
				select '' as dealer , '' as contact                                    
				                                                                        
				end  
				Print 'List:--> End :-->'+ convert(varchar,getdate(),109)	   
		end		 
		
----------******************88----------------****************------------------******************8	
	ELSE if (@@ReportFlag='BULK') 
	BEGIN
		/********* RAM Table to maintain the error messages to display in a grid on UI */
		Declare @BulkErrorTable Table
		(
			ProcessId varchar(50),
			Party_Code varchar(10),
			CurrencyDealer Varchar(20),
			ErrorMessages varchar(100)
		)
		
		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */
		Declare @BulkBranch Table
		(
			Party_Code varchar(10),
			Party_Region varchar(10),
			CurrencyDealer varchar(10),
			Dealer_Region varchar(10)
		)	
		
		/************************************************ Validations starts here ****************************************************/
		/* 1. Validation -> Client is a B2C client	*/
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is not a B2B client.'
		from B2B_Bulk_DealerMapping C with (nolock),
			angelclient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'Y'
		and Segment_Type = @@Segment_Type
		/* *****************************************************************/
		
		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is inactive.'
		from B2B_Bulk_DealerMapping C with (nolock),
			AngelClient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'N'
		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))
		and Segment_Type = @@Segment_Type
		
		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++
		
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee is terminated.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		and A.status='T'
		--and A.TerminationFrom <= GETDATE()
		--and A.InactiveFrom <=getdate()
		
		--and Status <> 'A'
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee does not Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		--and upper(category) not in ('DEALER')
		--and C.Dealer1 <> 'UNDEFINED'
		and isDealer<>1
		and Segment_Type = @@Segment_Type
		/* **************************************************************** */
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++
		/* 5. Validation -> Client code and New dealer are from same Parent tag. */
		create table  #parent_info 
		(
			Party_Code varchar(10),
			Sub_Broker varchar(10),
			client_parent varchar(10), 
			Dealer1 varchar(20),
			SBTag varchar(10),
			sb_parent varchar(10)
		)

		insert into #parent_info
		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.SB_Tag,sb_parent=''   
		from 
			B2B_Bulk_DealerMapping a1 with(nolock),angelclient1 b1 with(nolock),B2B_AngelHarmony c1  with(nolock)
		where ProcessId=@@ProcessID
		and a1.Party_Code=b1.Party_Code
		and c1.Emp_no =a1.Dealer1 
		and c1.isDealer=1
		and Segment_Type = @@Segment_Type


		update #parent_info

		set client_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.Sub_Broker 

		update #parent_info

		set sb_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.SBTag 
		
		Insert into @BulkErrorTable
		select	@@ProcessID,
				Party_Code,
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '
		from #parent_info where sb_parent<>client_parent
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++
		/* 6. Validation -> If client code or  dealer is blank */
		
		Insert into @BulkErrorTable
		select	ProcessId,
		isnull(C.Party_Code, ''),
		CurrencyDealer = isnull(Dealer1, ''),
		ErrorMessages = 'Incomplete data.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where ProcessId = @@ProcessID
		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++
		
		/* 7. Validation -> If Client is already mapped to the same  dealer */
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Dealer already mapped to the client.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_CommonPartyServices P with (nolock)
		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')
		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'
		and C.Segment_Type = P.Segment_Type
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++
		/* 8. Validation -> If client is available more than once in the file, 
				first entry of the client sequentially should be uploaded and remainder should be discarded */
		                
		select party_code, cnt = count(*) into #RemoveDuplicate               
		from B2B_Bulk_DealerMapping with(nolock) where ProcessId = @@ProcessId                 
		group by party_code                 
        HAVING count(*) > 1              
		
		if exists(select Party_Code from #RemoveDuplicate)          
		begin          
			--CURSOR TO UPDATE  			
			Declare @strPartyCode varchar(10)      
			Declare @totalcountForCursor int       
			Declare RemoveDuplicateCursor cursor for   
			--          
			select Party_Code, cnt from #RemoveDuplicate          
			--          
			Open RemoveDuplicateCursor           
			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          

			While @@FETCH_STATUS = 0                                                                                                                      
			Begin           
				set @totalcountForCursor=@totalcountForCursor-1          
				set rowcount @totalcountForCursor          
				--          
				Insert into @BulkErrorTable
				select distinct	C.ProcessId,
						isnull(C.Party_Code, ''),
						CurrencyDealer = isnull(Dealer1, ''),
						ErrorMessages = 'Duplicate entry.'
				from B2B_Bulk_DealerMapping C with (nolock)
				where C.ProcessId = @@ProcessId
				and isnull(C.Party_Code, '') = @strPartyCode
				and C.Segment_Type = @@Segment_Type  
				
				Delete from B2B_Bulk_DealerMapping  
				where ProcessId = @@ProcessId
				and isnull(Party_Code, '') = @strPartyCode
				and Segment_Type = @@Segment_Type 

				fetch next from RemoveDuplicateCursor                                                                   
				into @strPartyCode,@totalcountForCursor          
			END          
			close RemoveDuplicateCursor                                                                                                    
			deallocate RemoveDuplicateCursor          
			------------------------------------          
			drop table #RemoveDuplicate          
			set rowcount 0          
		end    
		
		
	
	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++
		/* 9. Validation -> If client code is invalid */
		
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID 
		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)
		and isnull(C.Party_Code, '') <> ''
		and C.Segment_Type = @@Segment_Type
		
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 not in (select Emp_No from B2B_AngelHarmony A with (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Dealer1 = A.Emp_No and ProcessId = @@ProcessID)
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Invalid row'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 is null
		and Party_Code is null
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++
		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Update contact details of Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_AngelHarmony E with (nolock)
		where E.Emp_no = isnull(C.Dealer1, '') 		
		and C.ProcessId = @@ProcessID
		and len(isnull(E.Landline_no,''))=0
		and e.isDealer=1
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		Delete B2B_Bulk_DealerMapping
		from @BulkErrorTable B
		where isnull(B2B_Bulk_DealerMapping.Party_Code, '') = isnull(B.Party_Code, '') 
		and B2B_Bulk_DealerMapping.Segment_Type = @@Segment_Type 
		and isnull(B2B_Bulk_DealerMapping.Dealer1, '') = isnull(B.CurrencyDealer, '') 
		and B2B_Bulk_DealerMapping.ProcessId = B.ProcessId
		and B2B_Bulk_DealerMapping.ProcessId = @@ProcessID
		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation
		/* ************* Selecting the records from error table *************** */
		
		select	Client_Code = ltrim(rtrim(Party_Code)), 
				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),
				ErrorMessages = ErrorMessages   
		from @BulkErrorTable
		where ProcessId = @@ProcessID
		
		select cnt = COUNT(*) from B2B_Bulk_DealerMapping with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type
		
		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID
		
	END
	ELSE if (@@ReportFlag='SAVE') 
	BEGIN
		print 'SAVE'
		
		Select M.party_code 
		into #InvalidClientCodes
		from B2B_Bulk_DealerMapping M with (nolock) LEFT OUTER JOIN angelclient1 a1 with(nolock)
		ON (M.party_code = a1.party_code)
		where M.ProcessId = @@ProcessId
		and M.Segment_Type = @@Segment_Type
		and a1.party_code is null

		Declare @Invalid_Party_code varchar(max)

		SELECT @Invalid_Party_code = STUFF
		(
			(
				SELECT ',' + s.party_code 
				FROM #InvalidClientCodes s
				ORDER BY s.party_code FOR XML PATH('')
			),
			 1, 1, ''
		)


		
		IF EXISTS (Select top 1 party_code from #InvalidClientCodes)
		BEGIN
			select msg = 'Error: Unable to upload file. Uploaded file contains invalid client codes (Invalid List: ' + @Invalid_Party_code + ')'
			RETURN;
		END

		declare  @temp_sbtag1 table
		(sbtag varchar(10))
		
		insert into @temp_sbtag1
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 

		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
	--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag1 b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		
		if Len(@@FromDealer)=0 
		Begin
 			Select  msg = 'Please Enter From Dealer'                                                                    
			return  
		end 
			
		If Exists(Select O.Party_code 
					from B2B_CommonPartyServices_Offline O with (nolock), B2B_Bulk_DealerMapping M with (nolock) 
					where O.Party_Code = M.Party_Code and
					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)
		Begin
			update B2B_CommonPartyServices_Offline
			set To_Be_Processed = 'N',
			process_time_stamp = getdate(),                                        
			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     
			from B2B_Bulk_DealerMapping M with (nolock), B2B_CommonPartyServices_Offline C with (nolock)                                  
			where C.Party_Code = M.Party_Code
			and To_Be_Processed = 'Y'
			and C.Segment_Type = M.Segment_Type
			and C.Segment_Type = @@Segment_Type
			and ProcessId = @@ProcessId
		End


		Print @@Branch_cd
		if(@@Branch_cd <> '')
		begin

		PRINT 1
			insert into B2B_CommonPartyServices_Offline 
			(
				Party_Code,
				Branch_Cd,
				Source_Dealer_Code,
				Target_Dealer_Code,
				From_Date,
				To_Date,
				Entry_Time_Stamp,
				To_Be_Processed,
				Process_Time_Stamp,
				Reason_For_Non_Process,
				Other_Remarks,
				Status_Id,
				Status_Name,
				Emp_No,
				Segment_Type,
				CommRank
			)
			Select 
				Party_code, 
				--@@Branch_cd=select , 
				--Branch_cd=(select sb_tag from B2B_AngelHarmony with(nolock) where emp_no=dealer1) , 
				Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B2B_Bulk_DealerMapping.Party_Code) , 
				@@FromDealer, 
				--Dealer1,
				@ToDealer,
				left(getdate(), 11) + ' 00:00:00',
				'Dec 31 2049 23:59:00',
				getdate(), 
				'Y', 
				'Jan  1 1900 00:00:00', 
				'', 
				'',
				@@StatusId, 
				@@StatusName, 
				@@Emp_No, 
				@@Segment_Type, 
				1
			from B2B_Bulk_DealerMapping with (nolock)
			where ProcessId = @@ProcessId
			and Segment_Type = @@Segment_Type
		end
		else
		begin
		PRINT 2

			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			B.Party_code,
			--Branch_cd, 
			Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B.Party_Code) , 
			/*CurrencyDealer --- need to be added later*/EMP_No, 
			Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 
			'Y', 
			'Jan  1 1900 00:00:00', 
			'', 
			'',
			@@StatusId, 
			@@StatusName, 
			@@Emp_No, 
			@@Segment_Type,
			1
			from B2B_Bulk_DealerMapping B with (nolock), B2B_CommonPartyServices A with (nolock)
			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code
			and b.Segment_Type = @@Segment_Type
			and valid='Y'
		end
		
		PRINT 3
		
		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'
		
		-- Set the Flag true for the valid entry of Client mapping	 
              
				-- Code to send the SMS for valid client mapping                                                             
				If (@@smsFlag = 'YES') 
				begin
					insert into TBL_B2B_CRMS_SMS_DEALER_MAPPING
					(
						party_code,
						party_mobile,
						sub_broker,
						sub_broker_name,
						DealerCode,
						DealerName,
						DealerContact
					) 
					Select 
						B.Party_code,
						mobileNo=(case when len(rtrim(ltrim(mobile_pager)))=10 then rtrim(ltrim(mobile_pager)) else 'NA' end) ,
						A.Sub_broker,
						Sub_Broker_Name=(select tradename from MIS.sb_comp.dbo.sb_broker with(nolock) where sbtag=a.sub_broker),
						B.Dealer1,
						--dealerName=(select emp_name from B2B_AngelHarmony e with(nolock) where e.emp_no=B.Dealer1 and isdealer='1'),
						dealerName=emp_name,
						contactNo=landline_no
					 from 
						B2B_Bulk_DealerMapping B with (nolock), angelclient1 A with (nolock),B2B_AngelHarmony  with(nolock)
					 where 
						ProcessId = @@ProcessId and 
						A.Party_Code = B.Party_Code
						and Segment_Type = @@Segment_Type
						and rtrim(ltrim(AngelClRating))<>'NEW'
						and emp_no=B.Dealer1
						and isdealer='1'
						--and isadmin<>'1'
    			end
	end				           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_bkp17Jan2020
-- --------------------------------------------------
CREATE proc [dbo].[B2B_CRMS_DealerMapping_bkp17Jan2020]                                                                    
(                                                                    
	@Emp_No varchar(20), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(20),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(20),                                                                    
	@ToDealer varchar(20),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100),                                
	@smsFlag varchar(10),
	@Segment_Type Varchar(20),
	@ProcessId Varchar(50)                                                                     
)   
WITH RECOMPILE                                                                 
AS      
BEGIN    
/*
	Exec B2B_CRMS_DealerMapping_ADTest 
	@Emp_No='CBHO001',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='AIL',
	@FromDealer='',@ToDealer='CBHO001',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId=''
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 

*/
SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
			@@StatusName varchar(20),                                                                                                                                                                                               
			@@Emp_No varchar(20),                                                                    
			@@PartyCode varchar(10),                                                                       
			@@Branch_cd varchar(10),                                                                   
			@@FromDealer varchar(20),                                                                    
			@@ToDealer varchar(20),                                                                 
			@@ReportFlag varchar(100),                                                           
			@@smsFlag varchar(10),
			@@FromParty varchar(10) ,
			@@ToParty   varchar(10),
			@@Segment_Type varchar(20),
			@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	SET @@smsFlag=@smsFlag
	SET @@Segment_Type = @Segment_Type
	SET @@ProcessId = @ProcessId 
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end
	
	if @@ReportFlag='LIST'
	BEGIN
		
		Print 'List:--> Start:-->'+ convert(varchar,getdate(),109)
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		--Checking if Dealer Data available in mini harmony.
		--print len(@@FromDealer)
		--print @@FromDealer
		--if((upper(@@FromDealer)<>'UNDEFINED') or (len(@@FromDealer)<>0))
		--begin
		--	if not exists
		--	(select empcode from B2B_Harmony with(nolock) where empcode=@@FromDealer)
 	--		Begin
 	--			Select  msg = 'Existing Dealer Not Available in harmony sdfsdfsdf.'                                                                    
		--		return  
		--	end
		--end	
		
		--Commented by prasanna after change in BRS on Jun 23 2012
		
		if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		if(len(@@FromDealer)<>0)
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@FromDealer)
 			Begin
 				Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    
				return  
			end
		end
		Print 'List:--> Step 1:-->'+ convert(varchar,getdate(),109)
	--	--Mappging to employee other than dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	----------
	--	--Checking if Dealer Data available in mini harmony.
		--if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		--begin
		--	if not exists
		--	(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 	--		Begin
 	--			Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
		--		return  
		--	end
		--end
	----------
	--    --Resigned Dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	----------
		
		
	--------
		--collecting parent and child delear list  	
		--declare  @temp_sbtag table
		--(sbtag varchar(10))
		
		--insert into @temp_sbtag
		--select sbtag from
		--(
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--	Union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=@Branch_cd
		--	union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where sbtag=@Branch_cd
		--	union
		--	select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--)a	
		
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 
		
		--select * from @temp_sbtag	
		--Checking the to dealer belongs to sub broker family
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		Print 'List:--> Step 2:-->'+ convert(varchar,getdate(),109)
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the existing dealer.'                                                                    
			return  
		end 
		
		Print 'List:--> Step 3:-->'+ convert(varchar,getdate(),109)
	---------
		--Checking client sub broker relationship	
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) ,@temp_sbtag
			where sub_broker=sbtag and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		
		
		Declare @mytable table                                    
		(          
			Client_code varchar(10) ,                                                                              
			Client_name varchar(100) ,                                                           
			Sub_Broker varchar(10) ,                               
			Trading_Mode varchar(20),
			Dealer_code_Existing varchar(20),
			Dealer_code_New  varchar(20),
			ColorCode varchar(50)                                                             
		) 
		----
		--print @@FromDealer
		--print @@ToDealer
		--print @@FromParty
		--print @@ToParty
		
		--select * from @temp_sbtag
		
		Insert into @mytable
		(
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode 
		)
		Select 
			Client_code=AC1.Party_code,
			Client_name = AC1.Long_Name,
			AC1.Sub_Broker, 
			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
			Dealer_code_Existing=CPS.Emp_No,
			Dealer_code_New=@@ToDealer,
			ColorCode = ''
		From 
			B2B_CommonPartyServices CPS with (noLock), [196.1.115.207].angelcs.dbo.angelClient1 AC1 with (noLock),@temp_sbtag
		Where 
			CPS.Party_Code = AC1.Party_Code                                                                
			And AC1.Sub_Broker = sbtag                                                                    
			And B2C='N'                                                                   
			And Cl_type<>'SUB'                                                                    
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                 
			And CPS.Valid = 'Y'                                                                    
			And CPS.Emp_No like @@FromDealer + '%'                                                                 
			And CPS.Emp_No <> @@ToDealer                                                                  
			And CPS.Party_Code >= @@FromParty 
			And CPS.Party_Code <= @@ToParty                                                                                                                          
			

		IF(@@FromDealer = '' OR @@FromDealer like '%001')
		Begin

			Insert into @mytable
			(
				Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
				ColorCode 
			)
			Select 
				Client_code=AC1.Party_code,
				Client_name = AC1.Long_Name,
				AC1.Sub_Broker, 
				Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
				Dealer_code_Existing=AC1.Sub_Broker + '001',
				Dealer_code_New=@@ToDealer,
				ColorCode = ''
			From @temp_sbtag T,
			[196.1.115.207].angelcs.dbo.angelClient1 AC1 with (noLock) LEFT OUTER JOIN B2B_CommonPartyServices CPS with (noLock)
			ON (AC1.party_code = CPS.Party_Code and CPS.valid = 'Y')			
			Where AC1.Sub_Broker = T.sbtag                                                                                                                                       
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                                                                                                                                             
			And AC1.Party_Code >= @@FromParty 
			And AC1.Party_Code <= @@ToParty   
			and AC1.B2C = 'N' And AC1.Cl_type<>'SUB'
			and CPS.party_code is null  
			and AC1.party_code not in (Select Client_code from @mytable)

		End
	---------------------------------------------------------------------                                    

	--Select * from @temp_sbtag

		update 
			@mytable
		set 
			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)
		from
			B2B_CommonPartyServices_Offline P with (nolock), @mytable T
		where
			T.Client_code = P.party_code
			and to_be_processed = 'Y'
			
		
---------------------------------------------------------------
		select  
			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode
		from 
			@mytable order by Client_code
		end
		
		---------CHeck Contact Details of @@ToDealer ----------------------------------------------- 
		if exists (select top 1 Client_code from @mytable)
		begin                               
				if @@ToDealer='' or upper(@@ToDealer)='UNDEFINED'                                    
				begin                                    
				 select '' as dealer , '' as contact                                    
				end                                    
				else if exists(select top 1 emp_no from B2B_AngelHarmony e with(nolock)                                    
				 where emp_no=ltrim(rtrim(@@ToDealer))                                    
					                               
				) 
				begin                                    
				-----                        
				select 'DEALER' as dealer,                                    
				--isnull((select top 1 rtrim(ltrim(STDCode))+'-'+rtrim(ltrim(Phone1)) from crm..CRMBranchContactDetails where ContactPerson=e.emp_no),'') as contact                                    
				isnull(landline_no,'') as contact                                    
				from B2B_AngelHarmony e with(nolock) 
				where emp_no=ltrim(rtrim(@@ToDealer))  
				and isDealer='1'                                  
				
				
				---                                    
				end                                    
				else                                     
				begin                                     
				select '' as dealer , '' as contact                                    
				                                                                        
				end  
				Print 'List:--> End :-->'+ convert(varchar,getdate(),109)	   
		end		 
		
----------******************88----------------****************------------------******************8	
	ELSE if (@@ReportFlag='BULK') 
	BEGIN
		/********* RAM Table to maintain the error messages to display in a grid on UI */
		Declare @BulkErrorTable Table
		(
			ProcessId varchar(50),
			Party_Code varchar(10),
			CurrencyDealer Varchar(20),
			ErrorMessages varchar(100)
		)
		
		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */
		Declare @BulkBranch Table
		(
			Party_Code varchar(10),
			Party_Region varchar(10),
			CurrencyDealer varchar(10),
			Dealer_Region varchar(10)
		)	
		
		/************************************************ Validations starts here ****************************************************/
		/* 1. Validation -> Client is a B2C client	*/
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is not a B2B client.'
		from B2B_Bulk_DealerMapping C with (nolock),
			angelclient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'Y'
		and Segment_Type = @@Segment_Type
		/* *****************************************************************/
		
		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++
		/*******Commendted by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients*******/
		/*
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is inactive.'
		from B2B_Bulk_DealerMapping C with (nolock),
			AngelClient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'N'
		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))
		and Segment_Type = @@Segment_Type
		*/
		/*******End Commendted by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients*******/
		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++
		
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee is terminated.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		and A.status='T'
		--and A.TerminationFrom <= GETDATE()
		--and A.InactiveFrom <=getdate()
		
		--and Status <> 'A'
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee does not Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		--and upper(category) not in ('DEALER')
		--and C.Dealer1 <> 'UNDEFINED'
		and isDealer<>1
		and Segment_Type = @@Segment_Type
		/* **************************************************************** */
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++
		/* 5. Validation -> Client code and New dealer are from same Parent tag. */
		create table  #parent_info 
		(
			Party_Code varchar(10),
			Sub_Broker varchar(10),
			client_parent varchar(10), 
			Dealer1 varchar(20),
			SBTag varchar(10),
			sb_parent varchar(10)
		)

		insert into #parent_info
		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.SB_Tag,sb_parent=''   
		from 
			B2B_Bulk_DealerMapping a1 with(nolock),angelclient1 b1 with(nolock),B2B_AngelHarmony c1  with(nolock)
		where ProcessId=@@ProcessID
		and a1.Party_Code=b1.Party_Code
		and c1.Emp_no =a1.Dealer1 
		and c1.isDealer=1
		and Segment_Type = @@Segment_Type


		update #parent_info

		set client_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.Sub_Broker 

		update #parent_info

		set sb_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.SBTag 
		
		Insert into @BulkErrorTable
		select	@@ProcessID,
				Party_Code,
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '
		from #parent_info where sb_parent<>client_parent
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++
		/* 6. Validation -> If client code or  dealer is blank */
		
		Insert into @BulkErrorTable
		select	ProcessId,
		isnull(C.Party_Code, ''),
		CurrencyDealer = isnull(Dealer1, ''),
		ErrorMessages = 'Incomplete data.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where ProcessId = @@ProcessID
		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++
		
		/* 7. Validation -> If Client is already mapped to the same  dealer */
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Dealer already mapped to the client.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_CommonPartyServices P with (nolock)
		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')
		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'
		and C.Segment_Type = P.Segment_Type
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++
		/* 8. Validation -> If client is available more than once in the file, 
				first entry of the client sequentially should be uploaded and remainder should be discarded */
		                
		select party_code, cnt = count(*) into #RemoveDuplicate               
		from B2B_Bulk_DealerMapping with(nolock) where ProcessId = @@ProcessId                 
		group by party_code                 
        HAVING count(*) > 1              
		
		if exists(select Party_Code from #RemoveDuplicate)          
		begin          
			--CURSOR TO UPDATE  			
			Declare @strPartyCode varchar(10)      
			Declare @totalcountForCursor int       
			Declare RemoveDuplicateCursor cursor for   
			--          
			select Party_Code, cnt from #RemoveDuplicate          
			--          
			Open RemoveDuplicateCursor           
			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          

			While @@FETCH_STATUS = 0                                                                                                                      
			Begin           
				set @totalcountForCursor=@totalcountForCursor-1          
				set rowcount @totalcountForCursor          
				--          
				Insert into @BulkErrorTable
				select distinct	C.ProcessId,
						isnull(C.Party_Code, ''),
						CurrencyDealer = isnull(Dealer1, ''),
						ErrorMessages = 'Duplicate entry.'
				from B2B_Bulk_DealerMapping C with (nolock)
				where C.ProcessId = @@ProcessId
				and isnull(C.Party_Code, '') = @strPartyCode
				and C.Segment_Type = @@Segment_Type  
				
				Delete from B2B_Bulk_DealerMapping  
				where ProcessId = @@ProcessId
				and isnull(Party_Code, '') = @strPartyCode
				and Segment_Type = @@Segment_Type 

				fetch next from RemoveDuplicateCursor                                                                   
				into @strPartyCode,@totalcountForCursor          
			END          
			close RemoveDuplicateCursor                                                                                                    
			deallocate RemoveDuplicateCursor          
			------------------------------------          
			drop table #RemoveDuplicate          
			set rowcount 0          
		end    
		
		
	
	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++
		/* 9. Validation -> If client code is invalid */
		
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID 
		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)
		and isnull(C.Party_Code, '') <> ''
		and C.Segment_Type = @@Segment_Type
		
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 not in (select Emp_No from B2B_AngelHarmony A with (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Dealer1 = A.Emp_No and ProcessId = @@ProcessID)
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Invalid row'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 is null
		and Party_Code is null
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++
		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Update contact details of Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_AngelHarmony E with (nolock)
		where E.Emp_no = isnull(C.Dealer1, '') 		
		and C.ProcessId = @@ProcessID
		and len(isnull(E.Landline_no,''))=0
		and e.isDealer=1
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		Delete B2B_Bulk_DealerMapping
		from @BulkErrorTable B
		where isnull(B2B_Bulk_DealerMapping.Party_Code, '') = isnull(B.Party_Code, '') 
		and B2B_Bulk_DealerMapping.Segment_Type = @@Segment_Type 
		and isnull(B2B_Bulk_DealerMapping.Dealer1, '') = isnull(B.CurrencyDealer, '') 
		and B2B_Bulk_DealerMapping.ProcessId = B.ProcessId
		and B2B_Bulk_DealerMapping.ProcessId = @@ProcessID
		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation
		/* ************* Selecting the records from error table *************** */
		
		select	Client_Code = ltrim(rtrim(Party_Code)), 
				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),
				ErrorMessages = ErrorMessages   
		from @BulkErrorTable
		where ProcessId = @@ProcessID
		
		select cnt = COUNT(*) from B2B_Bulk_DealerMapping with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type
		
		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID
		
	END
	ELSE if (@@ReportFlag='SAVE') 
	BEGIN
		print 'SAVE'
		

		Select M.party_code 
		into #InvalidClientCodes
		from B2B_Bulk_DealerMapping M with (nolock) LEFT OUTER JOIN angelclient1 a1 with(nolock)
		ON (M.party_code = a1.party_code)
		where M.ProcessId = @@ProcessId
		and M.Segment_Type = @@Segment_Type
		and a1.party_code is null

		Declare @Invalid_Party_code varchar(max)

		SELECT @Invalid_Party_code = STUFF
		(
			(
				SELECT ',' + s.party_code 
				FROM #InvalidClientCodes s
				ORDER BY s.party_code FOR XML PATH('')
			),
			 1, 1, ''
		)

		IF EXISTS (Select top 1 party_code from #InvalidClientCodes)
		BEGIN
			select msg = 'Error: Unable to upload file. Uploaded file contains invalid client codes (Invalid List: ' + @Invalid_Party_code + ')'
			RETURN;
		END

		declare  @temp_sbtag1 table
		(sbtag varchar(10))
		
		insert into @temp_sbtag1
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 

		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
	--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag1 b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		
		if Len(@@FromDealer)=0 
		Begin
 			Select  msg = 'Please Enter From Dealer'                                                                    
			return  
		end 
			
		If Exists(Select O.Party_code 
					from B2B_CommonPartyServices_Offline O with (nolock), B2B_Bulk_DealerMapping M with (nolock) 
					where O.Party_Code = M.Party_Code and
					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)
		Begin
			update B2B_CommonPartyServices_Offline
			set To_Be_Processed = 'N',
			process_time_stamp = getdate(),                                        
			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     
			from B2B_Bulk_DealerMapping M with (nolock), B2B_CommonPartyServices_Offline C with (nolock)                                  
			where C.Party_Code = M.Party_Code
			and To_Be_Processed = 'Y'
			and C.Segment_Type = M.Segment_Type
			and C.Segment_Type = @@Segment_Type
			and ProcessId = @@ProcessId
		End

		if(@@Branch_cd <> '')
		begin
			insert into B2B_CommonPartyServices_Offline 
			(
				Party_Code,
				Branch_Cd,
				Source_Dealer_Code,
				Target_Dealer_Code,
				From_Date,
				To_Date,
				Entry_Time_Stamp,
				To_Be_Processed,
				Process_Time_Stamp,
				Reason_For_Non_Process,
				Other_Remarks,
				Status_Id,
				Status_Name,
				Emp_No,
				Segment_Type,
				CommRank
			)
			Select 
				Party_code, 
				--@@Branch_cd=select , 
				--Branch_cd=(select sb_tag from B2B_AngelHarmony with(nolock) where emp_no=dealer1) , 
				Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B2B_Bulk_DealerMapping.Party_Code) , 
				@@FromDealer, 
				--Dealer1,
				@ToDealer,
				left(getdate(), 11) + ' 00:00:00',
				'Dec 31 2049 23:59:00',
				getdate(), 
				'Y', 
				'Jan  1 1900 00:00:00', 
				'', 
				'',
				@@StatusId, 
				@@StatusName, 
				@@Emp_No, 
				@@Segment_Type, 
				1
			from B2B_Bulk_DealerMapping with (nolock)
			where ProcessId = @@ProcessId
			and Segment_Type = @@Segment_Type
		end
		else
		begin
			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			B.Party_code,
			--Branch_cd, 
			Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B.Party_Code) , 
			/*CurrencyDealer --- need to be added later*/EMP_No, 
			Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 
			'Y', 
			'Jan  1 1900 00:00:00', 
			'', 
			'',
			@@StatusId, 
			@@StatusName, 
			@@Emp_No, 
			@@Segment_Type,
			1
			from B2B_Bulk_DealerMapping B with (nolock), B2B_CommonPartyServices A with (nolock)
			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code
			and b.Segment_Type = @@Segment_Type
			and valid='Y'
		end
		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'
		
		-- Set the Flag true for the valid entry of Client mapping	 
              
				-- Code to send the SMS for valid client mapping                                                             
				If (@@smsFlag = 'YES') 
				begin
					insert into TBL_B2B_CRMS_SMS_DEALER_MAPPING
					(
						party_code,
						party_mobile,
						sub_broker,
						sub_broker_name,
						DealerCode,
						DealerName,
						DealerContact
					) 
					Select 
						B.Party_code,
						mobileNo=(case when len(rtrim(ltrim(mobile_pager)))=10 then rtrim(ltrim(mobile_pager)) else 'NA' end) ,
						A.Sub_broker,
						Sub_Broker_Name=(select tradename from MIS.sb_comp.dbo.sb_broker with(nolock) where sbtag=a.sub_broker),
						B.Dealer1,
						--dealerName=(select emp_name from B2B_AngelHarmony e with(nolock) where e.emp_no=B.Dealer1 and isdealer='1'),
						dealerName=emp_name,
						contactNo=landline_no
					 from 
						B2B_Bulk_DealerMapping B with (nolock), angelclient1 A with (nolock),B2B_AngelHarmony  with(nolock)
					 where 
						ProcessId = @@ProcessId and 
						A.Party_Code = B.Party_Code
						and Segment_Type = @@Segment_Type
						and rtrim(ltrim(AngelClRating))<>'NEW'
						and emp_no=B.Dealer1
						and isdealer='1'
						--and isadmin<>'1'
    			end
	end				           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_bkp22Apr2019
-- --------------------------------------------------
CREATE proc [dbo].[B2B_CRMS_DealerMapping_bkp22Apr2019]                                                                    
(                                                                    
	@Emp_No varchar(20), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(20),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(20),                                                                    
	@ToDealer varchar(20),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100),                                
	@smsFlag varchar(10),
	@Segment_Type Varchar(20),
	@ProcessId Varchar(50)                                                                     
)   
WITH RECOMPILE                                                                 
AS      
BEGIN    
/*
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='AIL',
	@FromDealer='UNDEFINED',@ToDealer='AILA001',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId=''
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 

*/
SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
			@@StatusName varchar(20),                                                                                                                                                                                               
			@@Emp_No varchar(20),                                                                    
			@@PartyCode varchar(10),                                                                       
			@@Branch_cd varchar(10),                                                                   
			@@FromDealer varchar(20),                                                                    
			@@ToDealer varchar(20),                                                                 
			@@ReportFlag varchar(100),                                                           
			@@smsFlag varchar(10),
			@@FromParty varchar(10) ,
			@@ToParty   varchar(10),
			@@Segment_Type varchar(20),
			@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	SET @@smsFlag=@smsFlag
	SET @@Segment_Type = @Segment_Type
	SET @@ProcessId = @ProcessId 
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end
	
	if @@ReportFlag='LIST'
	BEGIN
		
		Print 'List:--> Start:-->'+ convert(varchar,getdate(),109)
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		--Checking if Dealer Data available in mini harmony.
		--print len(@@FromDealer)
		--print @@FromDealer
		--if((upper(@@FromDealer)<>'UNDEFINED') or (len(@@FromDealer)<>0))
		--begin
		--	if not exists
		--	(select empcode from B2B_Harmony with(nolock) where empcode=@@FromDealer)
 	--		Begin
 	--			Select  msg = 'Existing Dealer Not Available in harmony sdfsdfsdf.'                                                                    
		--		return  
		--	end
		--end	
		
		--Commented by prasanna after change in BRS on Jun 23 2012
		
		if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		if(len(@@FromDealer)<>0)
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@FromDealer)
 			Begin
 				Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    
				return  
			end
		end
		Print 'List:--> Step 1:-->'+ convert(varchar,getdate(),109)
	--	--Mappging to employee other than dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	----------
	--	--Checking if Dealer Data available in mini harmony.
		if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	----------
	--    --Resigned Dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	----------
		
		
	--------
		--collecting parent and child delear list  	
		--declare  @temp_sbtag table
		--(sbtag varchar(10))
		
		--insert into @temp_sbtag
		--select sbtag from
		--(
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--	Union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=@Branch_cd
		--	union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where sbtag=@Branch_cd
		--	union
		--	select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--)a	
		
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 
		
		--select * from @temp_sbtag	
		--Checking the to dealer belongs to sub broker family
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		Print 'List:--> Step 2:-->'+ convert(varchar,getdate(),109)
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the existing dealer.'                                                                    
			return  
		end 
		
		Print 'List:--> Step 3:-->'+ convert(varchar,getdate(),109)
	---------
		--Checking client sub broker relationship	
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) ,@temp_sbtag
			where sub_broker=sbtag and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		
		
		Declare @mytable table                                    
		(          
			Client_code varchar(10) ,                                                                              
			Client_name varchar(100) ,                                                           
			Sub_Broker varchar(10) ,                               
			Trading_Mode varchar(20),
			Dealer_code_Existing varchar(20),
			Dealer_code_New  varchar(20),
			ColorCode varchar(50)                                                             
		) 
		----
		--print @@FromDealer
		--print @@ToDealer
		--print @@FromParty
		--print @@ToParty
		
		--select * from @temp_sbtag
		
		Insert into @mytable
		(
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode 
		)
		Select 
			Client_code=AC1.Party_code,
			Client_name = AC1.Long_Name,
			AC1.Sub_Broker, 
			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
			Dealer_code_Existing=CPS.Emp_No,
			Dealer_code_New=@@ToDealer,
			ColorCode = ''
		From 
			B2B_CommonPartyServices CPS with (noLock), AngelClient1 AC1 with (noLock),@temp_sbtag
		Where 
			CPS.Party_Code = AC1.Party_Code                                                                
			And CPS.Dealerbranch = sbtag                                                                    
			And B2C='N'                                                                   
			And Cl_type<>'SUB'                                                                    
			And AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59'                                                                    
			And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'                                    
			And CPS.Valid = 'Y'                                                                    
			And CPS.Emp_No like @@FromDealer + '%'                                                                 
			And CPS.Emp_No <> @@ToDealer                                                                  
			And CPS.Party_Code >= @@FromParty 
			And CPS.Party_Code <= @@ToParty                                                                                                                          
			
	---------------------------------------------------------------------                                    

		update 
			@mytable
		set 
			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)
		from
			B2B_CommonPartyServices_Offline P with (nolock), @mytable T
		where
			T.Client_code = P.party_code
			and to_be_processed = 'Y'
			
		
---------------------------------------------------------------
		select  
			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode
		from 
			@mytable order by Client_code
		end
		
		---------CHeck Contact Details of @@ToDealer ----------------------------------------------- 
		if exists (select top 1 Client_code from @mytable)
		begin                               
				if @@ToDealer='' or upper(@@ToDealer)='UNDEFINED'                                    
				begin                                    
				 select '' as dealer , '' as contact                                    
				end                                    
				else if exists(select top 1 emp_no from B2B_AngelHarmony e with(nolock)                                    
				 where emp_no=ltrim(rtrim(@@ToDealer))                                    
					                               
				) 
				begin                                    
				-----                        
				select 'DEALER' as dealer,                                    
				--isnull((select top 1 rtrim(ltrim(STDCode))+'-'+rtrim(ltrim(Phone1)) from crm..CRMBranchContactDetails where ContactPerson=e.emp_no),'') as contact                                    
				isnull(landline_no,'') as contact                                    
				from B2B_AngelHarmony e with(nolock) 
				where emp_no=ltrim(rtrim(@@ToDealer))  
				and isDealer='1'                                  
				
				
				---                                    
				end                                    
				else                                     
				begin                                     
				select '' as dealer , '' as contact                                    
				                                                                        
				end  
				Print 'List:--> End :-->'+ convert(varchar,getdate(),109)	   
		end		 
		
----------******************88----------------****************------------------******************8	
	ELSE if (@@ReportFlag='BULK') 
	BEGIN
		/********* RAM Table to maintain the error messages to display in a grid on UI */
		Declare @BulkErrorTable Table
		(
			ProcessId varchar(50),
			Party_Code varchar(10),
			CurrencyDealer Varchar(20),
			ErrorMessages varchar(100)
		)
		
		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */
		Declare @BulkBranch Table
		(
			Party_Code varchar(10),
			Party_Region varchar(10),
			CurrencyDealer varchar(10),
			Dealer_Region varchar(10)
		)	
		
		/************************************************ Validations starts here ****************************************************/
		/* 1. Validation -> Client is a B2C client	*/
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is not a B2B client.'
		from B2B_Bulk_DealerMapping C with (nolock),
			angelclient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'Y'
		and Segment_Type = @@Segment_Type
		/* *****************************************************************/
		
		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is inactive.'
		from B2B_Bulk_DealerMapping C with (nolock),
			AngelClient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'N'
		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))
		and Segment_Type = @@Segment_Type
		
		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++
		
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee is terminated.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		and A.status='T'
		--and A.TerminationFrom <= GETDATE()
		--and A.InactiveFrom <=getdate()
		
		--and Status <> 'A'
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee does not Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		--and upper(category) not in ('DEALER')
		--and C.Dealer1 <> 'UNDEFINED'
		and isDealer<>1
		and Segment_Type = @@Segment_Type
		/* **************************************************************** */
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++
		/* 5. Validation -> Client code and New dealer are from same Parent tag. */
		create table  #parent_info 
		(
			Party_Code varchar(10),
			Sub_Broker varchar(10),
			client_parent varchar(10), 
			Dealer1 varchar(20),
			SBTag varchar(10),
			sb_parent varchar(10)
		)

		insert into #parent_info
		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.SB_Tag,sb_parent=''   
		from 
			B2B_Bulk_DealerMapping a1 with(nolock),angelclient1 b1 with(nolock),B2B_AngelHarmony c1  with(nolock)
		where ProcessId=@@ProcessID
		and a1.Party_Code=b1.Party_Code
		and c1.Emp_no =a1.Dealer1 
		and c1.isDealer=1
		and Segment_Type = @@Segment_Type


		update #parent_info

		set client_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.Sub_Broker 

		update #parent_info

		set sb_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.SBTag 
		
		Insert into @BulkErrorTable
		select	@@ProcessID,
				Party_Code,
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '
		from #parent_info where sb_parent<>client_parent
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++
		/* 6. Validation -> If client code or  dealer is blank */
		
		Insert into @BulkErrorTable
		select	ProcessId,
		isnull(C.Party_Code, ''),
		CurrencyDealer = isnull(Dealer1, ''),
		ErrorMessages = 'Incomplete data.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where ProcessId = @@ProcessID
		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++
		
		/* 7. Validation -> If Client is already mapped to the same  dealer */
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Dealer already mapped to the client.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_CommonPartyServices P with (nolock)
		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')
		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'
		and C.Segment_Type = P.Segment_Type
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++
		/* 8. Validation -> If client is available more than once in the file, 
				first entry of the client sequentially should be uploaded and remainder should be discarded */
		                
		select party_code, cnt = count(*) into #RemoveDuplicate               
		from B2B_Bulk_DealerMapping with(nolock) where ProcessId = @@ProcessId                 
		group by party_code                 
        HAVING count(*) > 1              
		
		if exists(select Party_Code from #RemoveDuplicate)          
		begin          
			--CURSOR TO UPDATE  			
			Declare @strPartyCode varchar(10)      
			Declare @totalcountForCursor int       
			Declare RemoveDuplicateCursor cursor for   
			--          
			select Party_Code, cnt from #RemoveDuplicate          
			--          
			Open RemoveDuplicateCursor           
			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          

			While @@FETCH_STATUS = 0                                                                                                                      
			Begin           
				set @totalcountForCursor=@totalcountForCursor-1          
				set rowcount @totalcountForCursor          
				--          
				Insert into @BulkErrorTable
				select distinct	C.ProcessId,
						isnull(C.Party_Code, ''),
						CurrencyDealer = isnull(Dealer1, ''),
						ErrorMessages = 'Duplicate entry.'
				from B2B_Bulk_DealerMapping C with (nolock)
				where C.ProcessId = @@ProcessId
				and isnull(C.Party_Code, '') = @strPartyCode
				and C.Segment_Type = @@Segment_Type  
				
				Delete from B2B_Bulk_DealerMapping  
				where ProcessId = @@ProcessId
				and isnull(Party_Code, '') = @strPartyCode
				and Segment_Type = @@Segment_Type 

				fetch next from RemoveDuplicateCursor                                                                   
				into @strPartyCode,@totalcountForCursor          
			END          
			close RemoveDuplicateCursor                                                                                                    
			deallocate RemoveDuplicateCursor          
			------------------------------------          
			drop table #RemoveDuplicate          
			set rowcount 0          
		end    
		
		
	
	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++
		/* 9. Validation -> If client code is invalid */
		
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID 
		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)
		and isnull(C.Party_Code, '') <> ''
		and C.Segment_Type = @@Segment_Type
		
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 not in (select Emp_No from B2B_AngelHarmony A with (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Dealer1 = A.Emp_No and ProcessId = @@ProcessID)
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Invalid row'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 is null
		and Party_Code is null
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++
		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Update contact details of Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_AngelHarmony E with (nolock)
		where E.Emp_no = isnull(C.Dealer1, '') 		
		and C.ProcessId = @@ProcessID
		and len(isnull(E.Landline_no,''))=0
		and e.isDealer=1
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		Delete B2B_Bulk_DealerMapping
		from @BulkErrorTable B
		where isnull(B2B_Bulk_DealerMapping.Party_Code, '') = isnull(B.Party_Code, '') 
		and B2B_Bulk_DealerMapping.Segment_Type = @@Segment_Type 
		and isnull(B2B_Bulk_DealerMapping.Dealer1, '') = isnull(B.CurrencyDealer, '') 
		and B2B_Bulk_DealerMapping.ProcessId = B.ProcessId
		and B2B_Bulk_DealerMapping.ProcessId = @@ProcessID
		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation
		/* ************* Selecting the records from error table *************** */
		
		select	Client_Code = ltrim(rtrim(Party_Code)), 
				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),
				ErrorMessages = ErrorMessages   
		from @BulkErrorTable
		where ProcessId = @@ProcessID
		
		select cnt = COUNT(*) from B2B_Bulk_DealerMapping with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type
		
		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID
		
	END
	ELSE if (@@ReportFlag='SAVE') 
	BEGIN
		print 'SAVE'
		
		declare  @temp_sbtag1 table
		(sbtag varchar(10))
		
		insert into @temp_sbtag1
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 

		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
	--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag1 b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		
		if Len(@@FromDealer)=0 
		Begin
 			Select  msg = 'Please Enter From Dealer'                                                                    
			return  
		end 
			
		If Exists(Select O.Party_code 
					from B2B_CommonPartyServices_Offline O with (nolock), B2B_Bulk_DealerMapping M with (nolock) 
					where O.Party_Code = M.Party_Code and
					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)
		Begin
			update B2B_CommonPartyServices_Offline
			set To_Be_Processed = 'N',
			process_time_stamp = getdate(),                                        
			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     
			from B2B_Bulk_DealerMapping M with (nolock), B2B_CommonPartyServices_Offline C with (nolock)                                  
			where C.Party_Code = M.Party_Code
			and To_Be_Processed = 'Y'
			and C.Segment_Type = M.Segment_Type
			and C.Segment_Type = @@Segment_Type
			and ProcessId = @@ProcessId
		End

		if(@@Branch_cd <> '')
		begin
			insert into B2B_CommonPartyServices_Offline 
			(
				Party_Code,
				Branch_Cd,
				Source_Dealer_Code,
				Target_Dealer_Code,
				From_Date,
				To_Date,
				Entry_Time_Stamp,
				To_Be_Processed,
				Process_Time_Stamp,
				Reason_For_Non_Process,
				Other_Remarks,
				Status_Id,
				Status_Name,
				Emp_No,
				Segment_Type,
				CommRank
			)
			Select 
				Party_code, 
				--@@Branch_cd=select , 
				--Branch_cd=(select sb_tag from B2B_AngelHarmony with(nolock) where emp_no=dealer1) , 
				Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B2B_Bulk_DealerMapping.Party_Code) , 
				@@FromDealer, 
				--Dealer1,
				@ToDealer,
				left(getdate(), 11) + ' 00:00:00',
				'Dec 31 2049 23:59:00',
				getdate(), 
				'Y', 
				'Jan  1 1900 00:00:00', 
				'', 
				'',
				@@StatusId, 
				@@StatusName, 
				@@Emp_No, 
				@@Segment_Type, 
				1
			from B2B_Bulk_DealerMapping with (nolock)
			where ProcessId = @@ProcessId
			and Segment_Type = @@Segment_Type
		end
		else
		begin
			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			B.Party_code,
			--Branch_cd, 
			Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B.Party_Code) , 
			/*CurrencyDealer --- need to be added later*/EMP_No, 
			Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 
			'Y', 
			'Jan  1 1900 00:00:00', 
			'', 
			'',
			@@StatusId, 
			@@StatusName, 
			@@Emp_No, 
			@@Segment_Type,
			1
			from B2B_Bulk_DealerMapping B with (nolock), B2B_CommonPartyServices A with (nolock)
			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code
			and b.Segment_Type = @@Segment_Type
			and valid='Y'
		end
		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'
		
		-- Set the Flag true for the valid entry of Client mapping	 
              
				-- Code to send the SMS for valid client mapping                                                             
				If (@@smsFlag = 'YES') 
				begin
					insert into TBL_B2B_CRMS_SMS_DEALER_MAPPING
					(
						party_code,
						party_mobile,
						sub_broker,
						sub_broker_name,
						DealerCode,
						DealerName,
						DealerContact
					) 
					Select 
						B.Party_code,
						mobileNo=(case when len(rtrim(ltrim(mobile_pager)))=10 then rtrim(ltrim(mobile_pager)) else 'NA' end) ,
						A.Sub_broker,
						Sub_Broker_Name=(select tradename from MIS.sb_comp.dbo.sb_broker with(nolock) where sbtag=a.sub_broker),
						B.Dealer1,
						--dealerName=(select emp_name from B2B_AngelHarmony e with(nolock) where e.emp_no=B.Dealer1 and isdealer='1'),
						dealerName=emp_name,
						contactNo=landline_no
					 from 
						B2B_Bulk_DealerMapping B with (nolock), angelclient1 A with (nolock),B2B_AngelHarmony  with(nolock)
					 where 
						ProcessId = @@ProcessId and 
						A.Party_Code = B.Party_Code
						and Segment_Type = @@Segment_Type
						and rtrim(ltrim(AngelClRating))<>'NEW'
						and emp_no=B.Dealer1
						and isdealer='1'
						--and isadmin<>'1'
    			end
	end				           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_bkp24May2019
-- --------------------------------------------------
CREATE proc [dbo].[B2B_CRMS_DealerMapping_bkp24May2019]                                                                    
(                                                                    
	@Emp_No varchar(20), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(20),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(20),                                                                    
	@ToDealer varchar(20),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100),                                
	@smsFlag varchar(10),
	@Segment_Type Varchar(20),
	@ProcessId Varchar(50)                                                                     
)   
WITH RECOMPILE                                                                 
AS      
BEGIN    
/*
	Exec B2B_CRMS_DealerMapping_ADTest 
	@Emp_No='CBHO001',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='AIL',
	@FromDealer='',@ToDealer='CBHO001',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId=''
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 

*/
SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
			@@StatusName varchar(20),                                                                                                                                                                                               
			@@Emp_No varchar(20),                                                                    
			@@PartyCode varchar(10),                                                                       
			@@Branch_cd varchar(10),                                                                   
			@@FromDealer varchar(20),                                                                    
			@@ToDealer varchar(20),                                                                 
			@@ReportFlag varchar(100),                                                           
			@@smsFlag varchar(10),
			@@FromParty varchar(10) ,
			@@ToParty   varchar(10),
			@@Segment_Type varchar(20),
			@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	SET @@smsFlag=@smsFlag
	SET @@Segment_Type = @Segment_Type
	SET @@ProcessId = @ProcessId 
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end
	
	if @@ReportFlag='LIST'
	BEGIN
		
		Print 'List:--> Start:-->'+ convert(varchar,getdate(),109)
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		--Checking if Dealer Data available in mini harmony.
		--print len(@@FromDealer)
		--print @@FromDealer
		--if((upper(@@FromDealer)<>'UNDEFINED') or (len(@@FromDealer)<>0))
		--begin
		--	if not exists
		--	(select empcode from B2B_Harmony with(nolock) where empcode=@@FromDealer)
 	--		Begin
 	--			Select  msg = 'Existing Dealer Not Available in harmony sdfsdfsdf.'                                                                    
		--		return  
		--	end
		--end	
		
		--Commented by prasanna after change in BRS on Jun 23 2012
		
		if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		if(len(@@FromDealer)<>0)
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@FromDealer)
 			Begin
 				Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    
				return  
			end
		end
		Print 'List:--> Step 1:-->'+ convert(varchar,getdate(),109)
	--	--Mappging to employee other than dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	----------
	--	--Checking if Dealer Data available in mini harmony.
		--if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		--begin
		--	if not exists
		--	(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 	--		Begin
 	--			Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
		--		return  
		--	end
		--end
	----------
	--    --Resigned Dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	----------
		
		
	--------
		--collecting parent and child delear list  	
		--declare  @temp_sbtag table
		--(sbtag varchar(10))
		
		--insert into @temp_sbtag
		--select sbtag from
		--(
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--	Union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=@Branch_cd
		--	union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where sbtag=@Branch_cd
		--	union
		--	select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--)a	
		
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 
		
		--select * from @temp_sbtag	
		--Checking the to dealer belongs to sub broker family
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		Print 'List:--> Step 2:-->'+ convert(varchar,getdate(),109)
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the existing dealer.'                                                                    
			return  
		end 
		
		Print 'List:--> Step 3:-->'+ convert(varchar,getdate(),109)
	---------
		--Checking client sub broker relationship	
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) ,@temp_sbtag
			where sub_broker=sbtag and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		
		
		Declare @mytable table                                    
		(          
			Client_code varchar(10) ,                                                                              
			Client_name varchar(100) ,                                                           
			Sub_Broker varchar(10) ,                               
			Trading_Mode varchar(20),
			Dealer_code_Existing varchar(20),
			Dealer_code_New  varchar(20),
			ColorCode varchar(50)                                                             
		) 
		----
		--print @@FromDealer
		--print @@ToDealer
		--print @@FromParty
		--print @@ToParty
		
		--select * from @temp_sbtag
		
		Insert into @mytable
		(
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode 
		)
		Select 
			Client_code=AC1.Party_code,
			Client_name = AC1.Long_Name,
			AC1.Sub_Broker, 
			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
			Dealer_code_Existing=CPS.Emp_No,
			Dealer_code_New=@@ToDealer,
			ColorCode = ''
		From 
			B2B_CommonPartyServices CPS with (noLock), [196.1.115.207].angelcs.dbo.angelClient1 AC1 with (noLock),@temp_sbtag
		Where 
			CPS.Party_Code = AC1.Party_Code                                                                
			And AC1.Sub_Broker = sbtag                                                                    
			And B2C='N'                                                                   
			And Cl_type<>'SUB'                                                                    
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                 
			And CPS.Valid = 'Y'                                                                    
			And CPS.Emp_No like @@FromDealer + '%'                                                                 
			And CPS.Emp_No <> @@ToDealer                                                                  
			And CPS.Party_Code >= @@FromParty 
			And CPS.Party_Code <= @@ToParty                                                                                                                          
			

		IF(@@FromDealer = '' OR @@FromDealer like '%001')
		Begin

			Insert into @mytable
			(
				Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
				ColorCode 
			)
			Select 
				Client_code=AC1.Party_code,
				Client_name = AC1.Long_Name,
				AC1.Sub_Broker, 
				Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
				Dealer_code_Existing=AC1.Sub_Broker + '001',
				Dealer_code_New=@@ToDealer,
				ColorCode = ''
			From @temp_sbtag T,
			[196.1.115.207].angelcs.dbo.angelClient1 AC1 with (noLock) LEFT OUTER JOIN B2B_CommonPartyServices CPS with (noLock)
			ON (AC1.party_code = CPS.Party_Code and CPS.valid = 'Y')			
			Where AC1.Sub_Broker = T.sbtag                                                                                                                                       
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                                                                                                                                             
			And AC1.Party_Code >= @@FromParty 
			And AC1.Party_Code <= @@ToParty   
			and AC1.B2C = 'N' And AC1.Cl_type<>'SUB'
			and CPS.party_code is null  
			and AC1.party_code not in (Select Client_code from @mytable)

		End
	---------------------------------------------------------------------                                    

	--Select * from @temp_sbtag

		update 
			@mytable
		set 
			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)
		from
			B2B_CommonPartyServices_Offline P with (nolock), @mytable T
		where
			T.Client_code = P.party_code
			and to_be_processed = 'Y'
			
		
---------------------------------------------------------------
		select  
			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode
		from 
			@mytable order by Client_code
		end
		
		---------CHeck Contact Details of @@ToDealer ----------------------------------------------- 
		if exists (select top 1 Client_code from @mytable)
		begin                               
				if @@ToDealer='' or upper(@@ToDealer)='UNDEFINED'                                    
				begin                                    
				 select '' as dealer , '' as contact                                    
				end                                    
				else if exists(select top 1 emp_no from B2B_AngelHarmony e with(nolock)                                    
				 where emp_no=ltrim(rtrim(@@ToDealer))                                    
					                               
				) 
				begin                                    
				-----                        
				select 'DEALER' as dealer,                                    
				--isnull((select top 1 rtrim(ltrim(STDCode))+'-'+rtrim(ltrim(Phone1)) from crm..CRMBranchContactDetails where ContactPerson=e.emp_no),'') as contact                                    
				isnull(landline_no,'') as contact                                    
				from B2B_AngelHarmony e with(nolock) 
				where emp_no=ltrim(rtrim(@@ToDealer))  
				and isDealer='1'                                  
				
				
				---                                    
				end                                    
				else                                     
				begin                                     
				select '' as dealer , '' as contact                                    
				                                                                        
				end  
				Print 'List:--> End :-->'+ convert(varchar,getdate(),109)	   
		end		 
		
----------******************88----------------****************------------------******************8	
	ELSE if (@@ReportFlag='BULK') 
	BEGIN
		/********* RAM Table to maintain the error messages to display in a grid on UI */
		Declare @BulkErrorTable Table
		(
			ProcessId varchar(50),
			Party_Code varchar(10),
			CurrencyDealer Varchar(20),
			ErrorMessages varchar(100)
		)
		
		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */
		Declare @BulkBranch Table
		(
			Party_Code varchar(10),
			Party_Region varchar(10),
			CurrencyDealer varchar(10),
			Dealer_Region varchar(10)
		)	
		
		/************************************************ Validations starts here ****************************************************/
		/* 1. Validation -> Client is a B2C client	*/
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is not a B2B client.'
		from B2B_Bulk_DealerMapping C with (nolock),
			angelclient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'Y'
		and Segment_Type = @@Segment_Type
		/* *****************************************************************/
		
		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is inactive.'
		from B2B_Bulk_DealerMapping C with (nolock),
			AngelClient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'N'
		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))
		and Segment_Type = @@Segment_Type
		
		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++
		
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee is terminated.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		and A.status='T'
		--and A.TerminationFrom <= GETDATE()
		--and A.InactiveFrom <=getdate()
		
		--and Status <> 'A'
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee does not Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		--and upper(category) not in ('DEALER')
		--and C.Dealer1 <> 'UNDEFINED'
		and isDealer<>1
		and Segment_Type = @@Segment_Type
		/* **************************************************************** */
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++
		/* 5. Validation -> Client code and New dealer are from same Parent tag. */
		create table  #parent_info 
		(
			Party_Code varchar(10),
			Sub_Broker varchar(10),
			client_parent varchar(10), 
			Dealer1 varchar(20),
			SBTag varchar(10),
			sb_parent varchar(10)
		)

		insert into #parent_info
		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.SB_Tag,sb_parent=''   
		from 
			B2B_Bulk_DealerMapping a1 with(nolock),angelclient1 b1 with(nolock),B2B_AngelHarmony c1  with(nolock)
		where ProcessId=@@ProcessID
		and a1.Party_Code=b1.Party_Code
		and c1.Emp_no =a1.Dealer1 
		and c1.isDealer=1
		and Segment_Type = @@Segment_Type


		update #parent_info

		set client_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.Sub_Broker 

		update #parent_info

		set sb_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.SBTag 
		
		Insert into @BulkErrorTable
		select	@@ProcessID,
				Party_Code,
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '
		from #parent_info where sb_parent<>client_parent
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++
		/* 6. Validation -> If client code or  dealer is blank */
		
		Insert into @BulkErrorTable
		select	ProcessId,
		isnull(C.Party_Code, ''),
		CurrencyDealer = isnull(Dealer1, ''),
		ErrorMessages = 'Incomplete data.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where ProcessId = @@ProcessID
		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++
		
		/* 7. Validation -> If Client is already mapped to the same  dealer */
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Dealer already mapped to the client.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_CommonPartyServices P with (nolock)
		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')
		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'
		and C.Segment_Type = P.Segment_Type
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++
		/* 8. Validation -> If client is available more than once in the file, 
				first entry of the client sequentially should be uploaded and remainder should be discarded */
		                
		select party_code, cnt = count(*) into #RemoveDuplicate               
		from B2B_Bulk_DealerMapping with(nolock) where ProcessId = @@ProcessId                 
		group by party_code                 
        HAVING count(*) > 1              
		
		if exists(select Party_Code from #RemoveDuplicate)          
		begin          
			--CURSOR TO UPDATE  			
			Declare @strPartyCode varchar(10)      
			Declare @totalcountForCursor int       
			Declare RemoveDuplicateCursor cursor for   
			--          
			select Party_Code, cnt from #RemoveDuplicate          
			--          
			Open RemoveDuplicateCursor           
			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          

			While @@FETCH_STATUS = 0                                                                                                                      
			Begin           
				set @totalcountForCursor=@totalcountForCursor-1          
				set rowcount @totalcountForCursor          
				--          
				Insert into @BulkErrorTable
				select distinct	C.ProcessId,
						isnull(C.Party_Code, ''),
						CurrencyDealer = isnull(Dealer1, ''),
						ErrorMessages = 'Duplicate entry.'
				from B2B_Bulk_DealerMapping C with (nolock)
				where C.ProcessId = @@ProcessId
				and isnull(C.Party_Code, '') = @strPartyCode
				and C.Segment_Type = @@Segment_Type  
				
				Delete from B2B_Bulk_DealerMapping  
				where ProcessId = @@ProcessId
				and isnull(Party_Code, '') = @strPartyCode
				and Segment_Type = @@Segment_Type 

				fetch next from RemoveDuplicateCursor                                                                   
				into @strPartyCode,@totalcountForCursor          
			END          
			close RemoveDuplicateCursor                                                                                                    
			deallocate RemoveDuplicateCursor          
			------------------------------------          
			drop table #RemoveDuplicate          
			set rowcount 0          
		end    
		
		
	
	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++
		/* 9. Validation -> If client code is invalid */
		
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID 
		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)
		and isnull(C.Party_Code, '') <> ''
		and C.Segment_Type = @@Segment_Type
		
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 not in (select Emp_No from B2B_AngelHarmony A with (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Dealer1 = A.Emp_No and ProcessId = @@ProcessID)
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Invalid row'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 is null
		and Party_Code is null
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++
		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Update contact details of Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_AngelHarmony E with (nolock)
		where E.Emp_no = isnull(C.Dealer1, '') 		
		and C.ProcessId = @@ProcessID
		and len(isnull(E.Landline_no,''))=0
		and e.isDealer=1
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		Delete B2B_Bulk_DealerMapping
		from @BulkErrorTable B
		where isnull(B2B_Bulk_DealerMapping.Party_Code, '') = isnull(B.Party_Code, '') 
		and B2B_Bulk_DealerMapping.Segment_Type = @@Segment_Type 
		and isnull(B2B_Bulk_DealerMapping.Dealer1, '') = isnull(B.CurrencyDealer, '') 
		and B2B_Bulk_DealerMapping.ProcessId = B.ProcessId
		and B2B_Bulk_DealerMapping.ProcessId = @@ProcessID
		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation
		/* ************* Selecting the records from error table *************** */
		
		select	Client_Code = ltrim(rtrim(Party_Code)), 
				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),
				ErrorMessages = ErrorMessages   
		from @BulkErrorTable
		where ProcessId = @@ProcessID
		
		select cnt = COUNT(*) from B2B_Bulk_DealerMapping with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type
		
		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID
		
	END
	ELSE if (@@ReportFlag='SAVE') 
	BEGIN
		print 'SAVE'
		
		declare  @temp_sbtag1 table
		(sbtag varchar(10))
		
		insert into @temp_sbtag1
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 

		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
	--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag1 b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		
		if Len(@@FromDealer)=0 
		Begin
 			Select  msg = 'Please Enter From Dealer'                                                                    
			return  
		end 
			
		If Exists(Select O.Party_code 
					from B2B_CommonPartyServices_Offline O with (nolock), B2B_Bulk_DealerMapping M with (nolock) 
					where O.Party_Code = M.Party_Code and
					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)
		Begin
			update B2B_CommonPartyServices_Offline
			set To_Be_Processed = 'N',
			process_time_stamp = getdate(),                                        
			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     
			from B2B_Bulk_DealerMapping M with (nolock), B2B_CommonPartyServices_Offline C with (nolock)                                  
			where C.Party_Code = M.Party_Code
			and To_Be_Processed = 'Y'
			and C.Segment_Type = M.Segment_Type
			and C.Segment_Type = @@Segment_Type
			and ProcessId = @@ProcessId
		End

		if(@@Branch_cd <> '')
		begin
			insert into B2B_CommonPartyServices_Offline 
			(
				Party_Code,
				Branch_Cd,
				Source_Dealer_Code,
				Target_Dealer_Code,
				From_Date,
				To_Date,
				Entry_Time_Stamp,
				To_Be_Processed,
				Process_Time_Stamp,
				Reason_For_Non_Process,
				Other_Remarks,
				Status_Id,
				Status_Name,
				Emp_No,
				Segment_Type,
				CommRank
			)
			Select 
				Party_code, 
				--@@Branch_cd=select , 
				--Branch_cd=(select sb_tag from B2B_AngelHarmony with(nolock) where emp_no=dealer1) , 
				Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B2B_Bulk_DealerMapping.Party_Code) , 
				@@FromDealer, 
				--Dealer1,
				@ToDealer,
				left(getdate(), 11) + ' 00:00:00',
				'Dec 31 2049 23:59:00',
				getdate(), 
				'Y', 
				'Jan  1 1900 00:00:00', 
				'', 
				'',
				@@StatusId, 
				@@StatusName, 
				@@Emp_No, 
				@@Segment_Type, 
				1
			from B2B_Bulk_DealerMapping with (nolock)
			where ProcessId = @@ProcessId
			and Segment_Type = @@Segment_Type
		end
		else
		begin
			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			B.Party_code,
			--Branch_cd, 
			Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B.Party_Code) , 
			/*CurrencyDealer --- need to be added later*/EMP_No, 
			Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 
			'Y', 
			'Jan  1 1900 00:00:00', 
			'', 
			'',
			@@StatusId, 
			@@StatusName, 
			@@Emp_No, 
			@@Segment_Type,
			1
			from B2B_Bulk_DealerMapping B with (nolock), B2B_CommonPartyServices A with (nolock)
			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code
			and b.Segment_Type = @@Segment_Type
			and valid='Y'
		end
		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'
		
		-- Set the Flag true for the valid entry of Client mapping	 
              
				-- Code to send the SMS for valid client mapping                                                             
				If (@@smsFlag = 'YES') 
				begin
					insert into TBL_B2B_CRMS_SMS_DEALER_MAPPING
					(
						party_code,
						party_mobile,
						sub_broker,
						sub_broker_name,
						DealerCode,
						DealerName,
						DealerContact
					) 
					Select 
						B.Party_code,
						mobileNo=(case when len(rtrim(ltrim(mobile_pager)))=10 then rtrim(ltrim(mobile_pager)) else 'NA' end) ,
						A.Sub_broker,
						Sub_Broker_Name=(select tradename from MIS.sb_comp.dbo.sb_broker with(nolock) where sbtag=a.sub_broker),
						B.Dealer1,
						--dealerName=(select emp_name from B2B_AngelHarmony e with(nolock) where e.emp_no=B.Dealer1 and isdealer='1'),
						dealerName=emp_name,
						contactNo=landline_no
					 from 
						B2B_Bulk_DealerMapping B with (nolock), angelclient1 A with (nolock),B2B_AngelHarmony  with(nolock)
					 where 
						ProcessId = @@ProcessId and 
						A.Party_Code = B.Party_Code
						and Segment_Type = @@Segment_Type
						and rtrim(ltrim(AngelClRating))<>'NEW'
						and emp_no=B.Dealer1
						and isdealer='1'
						--and isadmin<>'1'
    			end
	end				           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_demo
-- --------------------------------------------------


CREATE proc [dbo].[B2B_CRMS_DealerMapping_demo]                                                                    

(                                                                    

	@Emp_No varchar(20), 

	@StatusId varchar(10),                                                                                                                              

	@StatusName varchar(20),                                                                                                                                                                                                  

	@Branch_cd varchar(10),                                                                   

	@FromDealer varchar(20),                                                                    

	@ToDealer varchar(20),                                                                 

	@PartyCode varchar(10),

	@ReportFlag varchar(100),                                

	@smsFlag varchar(10),

	@Segment_Type Varchar(20),

	@ProcessId Varchar(50)                                                                     

)   

WITH RECOMPILE                                                                 

AS      

BEGIN    

/*

	Exec [B2B_CRMS_DealerMapping_demo] 

	@Emp_No='MIRJ001',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='',

	@FromDealer='MIRJ001',@ToDealer='MIRJ002',@PartyCode='J299909',@ReportFlag='LIST',@smsFlag='',

	@Segment_Type='Currency',@ProcessId=''

	

	Exec B2B_CRMS_DealerMapping 

	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',

	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',

	@Segment_Type='Currency',@ProcessId='' 

	

	Exec B2B_CRMS_DealerMapping 

	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',

	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',

	@Segment_Type='Currency',@ProcessId='' 



*/

SET NOCOUNT ON

	Declare @@StatusId varchar(10),                                                                                                                              

			@@StatusName varchar(20),                                                                                                                                                                                               

			@@Emp_No varchar(20),                                                                    

			@@PartyCode varchar(10),                                                                       

			@@Branch_cd varchar(10),                                                                   

			@@FromDealer varchar(20),                                                                    

			@@ToDealer varchar(20),                                                                 

			@@ReportFlag varchar(100),                                                           

			@@smsFlag varchar(10),

			@@FromParty varchar(10) ,

			@@ToParty   varchar(10),

			@@Segment_Type varchar(20),

			@@ProcessId Varchar(50)       

			                                                    

	/* Initialized local parameters  */

	SET @@StatusId = @StatusId                  

	SET @@StatusName = @StatusName                                  

	SET @@Emp_No = @Emp_No                                  

	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  

	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    

	SET @@FromDealer = ltrim(rtrim(@FromDealer))

	SET @@ToDealer = ltrim(rtrim(@ToDealer))

	SET @@ReportFlag = @ReportFlag                                                           

	SET @@smsFlag=@smsFlag

	SET @@Segment_Type = @Segment_Type

	SET @@ProcessId = @ProcessId 

	

	if @@PartyCode=''

	begin

		set @@FromParty='A'

		set @@ToParty='ZZZZZZZZZZZZ'

	end

	else

	begin

		set @@FromParty=@@PartyCode

		set @@ToParty=@@PartyCode

	end

	

	if @@ReportFlag='LIST'

	BEGIN

		

		Print 'List:--> Start:-->'+ convert(varchar,getdate(),109)

		if  (@@FromDealer=@@ToDealer) 

		begin

			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    

			return  

		end	

	--------

		--Checking if Dealer Data available in mini harmony.

		--print len(@@FromDealer)

		--print @@FromDealer

		--if((upper(@@FromDealer)<>'UNDEFINED') or (len(@@FromDealer)<>0))

		--begin

		--	if not exists

		--	(select empcode from B2B_Harmony with(nolock) where empcode=@@FromDealer)

 	--		Begin

 	--			Select  msg = 'Existing Dealer Not Available in harmony sdfsdfsdf.'                                                                    

		--		return  

		--	end

		--end	

		

		--Commented by prasanna after change in BRS on Jun 23 2012

		

		if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')

		begin

			if not exists

			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)

 			Begin

 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    

				return  

			end

		end	

		

		if(len(@@FromDealer)<>0)

		begin

			if not exists

			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@FromDealer)

 			Begin

 				Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    

				return  

			end

		end

		Print 'List:--> Step 1:-->'+ convert(varchar,getdate(),109)

	--	--Mappging to employee other than dealer	

		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists

	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')

 		Begin

 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    

			return  

		end

		

	----------

	--	--Checking if Dealer Data available in mini harmony.

		--if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')

		--begin

		--	if not exists

		--	(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)

 	--		Begin

 	--			Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    

		--		return  

		--	end

		--end

	----------

	--    --Resigned Dealer	

		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and exists

		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')

		begin

			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    

			return  

		end

	----------

		

		

	--------

		--collecting parent and child delear list  	

		--declare  @temp_sbtag table

		--(sbtag varchar(10))

		

		--insert into @temp_sbtag

		--select sbtag from

		--(

		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)

		--	Union 

		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

		--	where parenttag=@Branch_cd

		--	union 

		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

		--	where sbtag=@Branch_cd

		--	union

		--	select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)

		--)a	

		

		declare  @temp_sbtag table

		(sbtag varchar(10))

		

		insert into @temp_sbtag

		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 

		

		--select * from @temp_sbtag	

		--Checking the to dealer belongs to sub broker family

		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists

		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)

		Begin

 			Select  msg = 'You do not have access to map the new dealer.'                                                                    

			return  

		end 

		Print 'List:--> Step 2:-->'+ convert(varchar,getdate(),109)

		

		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 

		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@FromDealer)

		Begin

 			Select  msg = 'You do not have access to map the existing dealer.'                                                                    

			return  

		end 

		

		Print 'List:--> Step 3:-->'+ convert(varchar,getdate(),109)

	---------

		--Checking client sub broker relationship	

		if @PartyCode <>'' and  not exists

		(select party_code from angelclient1 b1 with(nolock) ,@temp_sbtag

			where sub_broker=sbtag and party_code = @PartyCode)

		Begin

 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    

			return  

		end 

		

		

		Declare @mytable table                                    

		(          

			Client_code varchar(10) ,                                                                              

			Client_name varchar(100) ,                                                           

			Sub_Broker varchar(10) ,                               

			Trading_Mode varchar(20),

			Dealer_code_Existing varchar(20),

			Dealer_code_New  varchar(20),

			ColorCode varchar(50)                                                             

		) 

		----

		--print @@FromDealer

		--print @@ToDealer

		--print @@FromParty

		--print @@ToParty

		

		--select * from @temp_sbtag

		

		Insert into @mytable

		(

			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,

			ColorCode 

		)

		Select 

			Client_code=AC1.Party_code,

			Client_name = AC1.Long_Name,

			AC1.Sub_Broker, 

			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),

			Dealer_code_Existing=CPS.Emp_No,

			Dealer_code_New=@@ToDealer,

			ColorCode = ''

		From 

			B2B_CommonPartyServices CPS with (noLock), [MIMANSA].angelcs.dbo.angelClient1 AC1 with (noLock),@temp_sbtag

		Where 

			CPS.Party_Code = AC1.Party_Code                                                                

			And AC1.Sub_Broker = sbtag                                                                    

			And B2C='N'                                                                   

			And Cl_type<>'SUB'                                                                    

			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 

						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')

				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 

						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                 

			And CPS.Valid = 'Y'                                                                    

			And CPS.Emp_No like @@FromDealer + '%'                                                                 

			And CPS.Emp_No <> @@ToDealer                                                                  

			And CPS.Party_Code >= @@FromParty 

			And CPS.Party_Code <= @@ToParty                                                                                                                          

			



		IF(@@FromDealer = '' OR @@FromDealer like '%001')

		Begin



			Insert into @mytable

			(

				Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,

				ColorCode 

			)

			Select 

				Client_code=AC1.Party_code,

				Client_name = AC1.Long_Name,

				AC1.Sub_Broker, 

				Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),

				Dealer_code_Existing=AC1.Sub_Broker + '001',

				Dealer_code_New=@@ToDealer,

				ColorCode = ''

			From @temp_sbtag T,

			[MIMANSA].angelcs.dbo.angelClient1 AC1 with (noLock) LEFT OUTER JOIN B2B_CommonPartyServices CPS with (noLock)

			ON (AC1.party_code = CPS.Party_Code and CPS.valid = 'Y')			

			Where AC1.Sub_Broker = T.sbtag                                                                                                                                       

			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 

						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')

				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 

						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                                                                                                                                             

			And AC1.Party_Code >= @@FromParty 

			And AC1.Party_Code <= @@ToParty   

			and AC1.B2C = 'N' And AC1.Cl_type<>'SUB'

			and CPS.party_code is null  

			and AC1.party_code not in (Select Client_code from @mytable)



		End

	---------------------------------------------------------------------                                    



	--Select * from @temp_sbtag



		update 

			@mytable

		set 

			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)

		from

			B2B_CommonPartyServices_Offline P with (nolock), @mytable T

		where

			T.Client_code = P.party_code

			and to_be_processed = 'Y'

			

		

---------------------------------------------------------------

		select  

			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',

			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,

			ColorCode

		from 

			@mytable order by Client_code

		end

		

		---------CHeck Contact Details of @@ToDealer ----------------------------------------------- 

		--if exists (select top 1 Client_code from @mytable)

		--begin                               

		--		if @@ToDealer='' or upper(@@ToDealer)='UNDEFINED'                                    

		--		begin                                    

		--		 select '' as dealer , '' as contact                                    

		--		end                                    

		--		else if exists(select top 1 emp_no from B2B_AngelHarmony e with(nolock)                                    

		--		 where emp_no=ltrim(rtrim(@@ToDealer))                                    

					                               

		--		) 

		--		begin                                    

		--		-----                        

		--		select 'DEALER' as dealer,                                    

		--		--isnull((select top 1 rtrim(ltrim(STDCode))+'-'+rtrim(ltrim(Phone1)) from crm..CRMBranchContactDetails where ContactPerson=e.emp_no),'') as contact                                    

		--		isnull(landline_no,'') as contact                                    

		--		from B2B_AngelHarmony e with(nolock) 

		--		where emp_no=ltrim(rtrim(@@ToDealer))  

		--		and isDealer='1'                                  

				

				

		--		---                                    

		--		end                                    

		--		else                                     

		--		begin                                     

		--		select '' as dealer , '' as contact                                    

				                                                                        

		--		end  

		--		Print 'List:--> End :-->'+ convert(varchar,getdate(),109)	   

		--end		 

		

----------******************88----------------****************------------------******************8	

	ELSE if (@@ReportFlag='BULK') 

	BEGIN

		/********* RAM Table to maintain the error messages to display in a grid on UI */

		Declare @BulkErrorTable Table

		(

			ProcessId varchar(50),

			Party_Code varchar(10),

			CurrencyDealer Varchar(20),

			ErrorMessages varchar(100)

		)

		

		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */

		Declare @BulkBranch Table

		(

			Party_Code varchar(10),

			Party_Region varchar(10),

			CurrencyDealer varchar(10),

			Dealer_Region varchar(10)

		)	

		

		/************************************************ Validations starts here ****************************************************/

		/* 1. Validation -> Client is a B2C client	*/

		Insert into @BulkErrorTable

		select	ProcessId,

				isnull(C.Party_Code, ''),

				CurrencyDealer = isnull(Dealer1, ''),

				ErrorMessages = 'Client is not a B2B client.'

		from B2B_Bulk_DealerMapping C with (nolock),

			angelclient1 A with (nolock)

		where ProcessId = @@ProcessID

		and A.Party_Code = isnull(C.Party_Code, '')

		and B2C = 'Y'

		and Segment_Type = @@Segment_Type

		/* *****************************************************************/

		

		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++

		/*******Commendted by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients*******/

		/*

		Insert into @BulkErrorTable

		select	ProcessId,

				isnull(C.Party_Code, ''),

				CurrencyDealer = isnull(Dealer1, ''),

				ErrorMessages = 'Client is inactive.'

		from B2B_Bulk_DealerMapping C with (nolock),

			AngelClient1 A with (nolock)

		where ProcessId = @@ProcessID

		and A.Party_Code = isnull(C.Party_Code, '')

		and B2C = 'N'

		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))

		and Segment_Type = @@Segment_Type

		*/

		/*******End Commendted by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients*******/



		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++

		

		Insert into @BulkErrorTable

		select	ProcessId,

				isnull(C.Party_Code, ''),

				CurrencyDealer = isnull(Dealer1, ''),

				ErrorMessages = 'Employee is terminated.'

		from B2B_Bulk_DealerMapping C with (nolock),

			B2B_AngelHarmony A with (nolock)

		where ProcessId = @@ProcessID

		and A.Emp_no = isnull(C.Dealer1, '')

		and A.status='T'

		--and A.TerminationFrom <= GETDATE()

		--and A.InactiveFrom <=getdate()

		

		--and Status <> 'A'

		and Segment_Type = @@Segment_Type

		

		/* *****************************************************************/

		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++

		Insert into @BulkErrorTable

		select	ProcessId,

				isnull(C.Party_Code, ''),

				CurrencyDealer = isnull(Dealer1, ''),

				ErrorMessages = 'Employee does not Dealer.'

		from B2B_Bulk_DealerMapping C with (nolock),

			B2B_AngelHarmony A with (nolock)

		where ProcessId = @@ProcessID

		and A.Emp_no = isnull(C.Dealer1, '')

		--and upper(category) not in ('DEALER')

		--and C.Dealer1 <> 'UNDEFINED'

		and isDealer<>1

		and Segment_Type = @@Segment_Type

		/* **************************************************************** */

		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++

		/* 5. Validation -> Client code and New dealer are from same Parent tag. */

		create table  #parent_info 

		(

			Party_Code varchar(10),

			Sub_Broker varchar(10),

			client_parent varchar(10), 

			Dealer1 varchar(20),

			SBTag varchar(10),

			sb_parent varchar(10)

		)



		insert into #parent_info

		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.SB_Tag,sb_parent=''   

		from 

			B2B_Bulk_DealerMapping a1 with(nolock),angelclient1 b1 with(nolock),B2B_AngelHarmony c1  with(nolock)

		where ProcessId=@@ProcessID

		and a1.Party_Code=b1.Party_Code

		and c1.Emp_no =a1.Dealer1 

		and c1.isDealer=1

		and Segment_Type = @@Segment_Type





		update #parent_info



		set client_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a



		where b1.sbtag=a.Sub_Broker 



		update #parent_info



		set sb_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a



		where b1.sbtag=a.SBTag 

		

		Insert into @BulkErrorTable

		select	@@ProcessID,

				Party_Code,

				CurrencyDealer = isnull(Dealer1, ''),

				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '

		from #parent_info where sb_parent<>client_parent

		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++

		/* 6. Validation -> If client code or  dealer is blank */

		

		Insert into @BulkErrorTable

		select	ProcessId,

		isnull(C.Party_Code, ''),

		CurrencyDealer = isnull(Dealer1, ''),

		ErrorMessages = 'Incomplete data.'

		from B2B_Bulk_DealerMapping C with (nolock)

		where ProcessId = @@ProcessID

		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))

		and Segment_Type = @@Segment_Type

		

		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++

		

		/* 7. Validation -> If Client is already mapped to the same  dealer */

		Insert into @BulkErrorTable

		select	ProcessId,

				isnull(C.Party_Code, ''),

				CurrencyDealer = isnull(Dealer1, ''),

				ErrorMessages = 'Dealer already mapped to the client.'

		from B2B_Bulk_DealerMapping C with (nolock), B2B_CommonPartyServices P with (nolock)

		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')

		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'

		and C.Segment_Type = P.Segment_Type

		and C.Segment_Type = @@Segment_Type

		

		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++

		/* 8. Validation -> If client is available more than once in the file, 

				first entry of the client sequentially should be uploaded and remainder should be discarded */

		                

		select party_code, cnt = count(*) into #RemoveDuplicate               

		from B2B_Bulk_DealerMapping with(nolock) where ProcessId = @@ProcessId                 

		group by party_code                 

        HAVING count(*) > 1              

		

		if exists(select Party_Code from #RemoveDuplicate)          

		begin          

			--CURSOR TO UPDATE  			

			Declare @strPartyCode varchar(10)      

			Declare @totalcountForCursor int       

			Declare RemoveDuplicateCursor cursor for   

			--          

			select Party_Code, cnt from #RemoveDuplicate          

			--          

			Open RemoveDuplicateCursor           

			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          



			While @@FETCH_STATUS = 0                                                                                                                      

			Begin           

				set @totalcountForCursor=@totalcountForCursor-1          

				set rowcount @totalcountForCursor          

				--          

				Insert into @BulkErrorTable

				select distinct	C.ProcessId,

						isnull(C.Party_Code, ''),

						CurrencyDealer = isnull(Dealer1, ''),

						ErrorMessages = 'Duplicate entry.'

				from B2B_Bulk_DealerMapping C with (nolock)

				where C.ProcessId = @@ProcessId

				and isnull(C.Party_Code, '') = @strPartyCode

				and C.Segment_Type = @@Segment_Type  

				

				Delete from B2B_Bulk_DealerMapping  

				where ProcessId = @@ProcessId

				and isnull(Party_Code, '') = @strPartyCode

				and Segment_Type = @@Segment_Type 



				fetch next from RemoveDuplicateCursor                                                                   

				into @strPartyCode,@totalcountForCursor          

			END          

			close RemoveDuplicateCursor                                                                                                    

			deallocate RemoveDuplicateCursor          

			------------------------------------          

			drop table #RemoveDuplicate          

			set rowcount 0          

		end    

		

		

	

	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++

		/* 9. Validation -> If client code is invalid */

		

		Insert into @BulkErrorTable

		select	C.ProcessId,

				isnull(C.Party_Code, ''),

				CurrencyDealer = isnull(Dealer1, ''),

				ErrorMessages = 'Client code is invalid.'

		from B2B_Bulk_DealerMapping C with (nolock)

		where C.ProcessId = @@ProcessID 

		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping D with (nolock)

									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)

		and isnull(C.Party_Code, '') <> ''

		and C.Segment_Type = @@Segment_Type

		

		

		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++

		/* 10. Validation -> If  dealer code is invalid */

		Insert into @BulkErrorTable

		select	C.ProcessId,

				isnull(C.Party_Code, ''),

				CurrencyDealer = isnull(Dealer1, ''),

				ErrorMessages = 'Employee code is invalid.'

		from B2B_Bulk_DealerMapping C with (nolock)

		where C.ProcessId = @@ProcessID

		and C.Dealer1 not in (select Emp_No from B2B_AngelHarmony A with (nolock), B2B_Bulk_DealerMapping D with (nolock)

									where D.Dealer1 = A.Emp_No and ProcessId = @@ProcessID)

		and C.Dealer1 <> 'UNDEFINED'

		and C.Segment_Type = @@Segment_Type

		

		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++

		/* 10. Validation -> If  dealer code is invalid */

		Insert into @BulkErrorTable

		select	C.ProcessId,

				isnull(C.Party_Code, ''),

				CurrencyDealer = isnull(Dealer1, ''),

				ErrorMessages = 'Invalid row'

		from B2B_Bulk_DealerMapping C with (nolock)

		where C.ProcessId = @@ProcessID

		and C.Dealer1 is null

		and Party_Code is null

		and C.Segment_Type = @@Segment_Type

		

		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++

		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */

		Insert into @BulkErrorTable

		select	C.ProcessId,

				isnull(C.Party_Code, ''),

				CurrencyDealer = isnull(Dealer1, ''),

				ErrorMessages = 'Update contact details of Dealer.'

		from B2B_Bulk_DealerMapping C with (nolock), B2B_AngelHarmony E with (nolock)

		where E.Emp_no = isnull(C.Dealer1, '') 		

		and C.ProcessId = @@ProcessID

		and len(isnull(E.Landline_no,''))=0

		and e.isDealer=1

		and C.Segment_Type = @@Segment_Type

		

		/* *****************************************************************/

		Delete B2B_Bulk_DealerMapping

		from @BulkErrorTable B

		where isnull(B2B_Bulk_DealerMapping.Party_Code, '') = isnull(B.Party_Code, '') 

		and B2B_Bulk_DealerMapping.Segment_Type = @@Segment_Type 

		and isnull(B2B_Bulk_DealerMapping.Dealer1, '') = isnull(B.CurrencyDealer, '') 

		and B2B_Bulk_DealerMapping.ProcessId = B.ProcessId

		and B2B_Bulk_DealerMapping.ProcessId = @@ProcessID

		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation

		/* ************* Selecting the records from error table *************** */

		

		select	Client_Code = ltrim(rtrim(Party_Code)), 

				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),

				ErrorMessages = ErrorMessages   

		from @BulkErrorTable

		where ProcessId = @@ProcessID

		

		select cnt = COUNT(*) from B2B_Bulk_DealerMapping with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type

		

		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID

		

	END

	ELSE if (@@ReportFlag='SAVE') 

	BEGIN

		print 'SAVE'



		Select M.party_code 

		into #InvalidClientCodes

		from B2B_Bulk_DealerMapping M with (nolock) LEFT OUTER JOIN angelclient1 a1 with(nolock)

		ON (M.party_code = a1.party_code)

		where M.ProcessId = @@ProcessId

		and M.Segment_Type = @@Segment_Type

		and a1.party_code is null



		Declare @Invalid_Party_code varchar(max)



		SELECT @Invalid_Party_code = STUFF

		(

			(

				SELECT ',' + s.party_code 

				FROM #InvalidClientCodes s

				ORDER BY s.party_code FOR XML PATH('')

			),

			 1, 1, ''

		)





		

		IF EXISTS (Select top 1 party_code from #InvalidClientCodes)

		BEGIN

			select msg = 'Error: Unable to upload file. Uploaded file contains invalid client codes (Invalid List: ' + @Invalid_Party_code + ')'

			RETURN;

		END

		

		declare  @temp_sbtag1 table

		(sbtag varchar(10))

		

		insert into @temp_sbtag1

		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 



		if(upper(@@ToDealer)<>'UNDEFINED')

		begin

			if not exists

			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)

 			Begin

 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    

				return  

			end

		end	

		

		--Mappging to employee other than dealer	

		if upper(@@ToDealer)<>'UNDEFINED' and not exists

	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')

 		Begin

 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    

			return  

		end

		

	--------

		--Checking if Dealer Data available in mini harmony.

		if(upper(@@ToDealer)<>'UNDEFINED')

		begin

			if not exists

			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)

 			Begin

 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    

				return  

			end

		end

	--------

	    --Resigned Dealer	

		if upper(@@ToDealer)<>'UNDEFINED' and exists

		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')

		begin

			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    

			return  

		end

	--------

	--Checking the to dealer belongs to sub broker family

		if upper(@@ToDealer)<>'UNDEFINED' and not exists

		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag1 b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)

		Begin

 			Select  msg = 'You do not have access to map the new dealer.'                                                                    

			return  

		end 

		

		if Len(@@FromDealer)=0 

		Begin

 			Select  msg = 'Please Enter From Dealer'                                                                    

			return  

		end 

			

		If Exists(Select O.Party_code 

					from B2B_CommonPartyServices_Offline O with (nolock), B2B_Bulk_DealerMapping M with (nolock) 

					where O.Party_Code = M.Party_Code and

					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)

		Begin

			update B2B_CommonPartyServices_Offline

			set To_Be_Processed = 'N',

			process_time_stamp = getdate(),                                        

			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     

			from B2B_Bulk_DealerMapping M with (nolock), B2B_CommonPartyServices_Offline C with (nolock)                                  

			where C.Party_Code = M.Party_Code

			and To_Be_Processed = 'Y'

			and C.Segment_Type = M.Segment_Type

			and C.Segment_Type = @@Segment_Type

			and ProcessId = @@ProcessId

		End



		if(@@Branch_cd <> '')

		begin

			insert into B2B_CommonPartyServices_Offline 

			(

				Party_Code,

				Branch_Cd,

				Source_Dealer_Code,

				Target_Dealer_Code,

				From_Date,

				To_Date,

				Entry_Time_Stamp,

				To_Be_Processed,

				Process_Time_Stamp,

				Reason_For_Non_Process,

				Other_Remarks,

				Status_Id,

				Status_Name,

				Emp_No,

				Segment_Type,

				CommRank

			)

			Select 

				Party_code, 

				--@@Branch_cd=select , 

				--Branch_cd=(select sb_tag from B2B_AngelHarmony with(nolock) where emp_no=dealer1) , 

				Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B2B_Bulk_DealerMapping.Party_Code) , 

				@@FromDealer, 

				--Dealer1,

				@ToDealer,

				left(getdate(), 11) + ' 00:00:00',

				'Dec 31 2049 23:59:00',

				getdate(), 

				'Y', 

				'Jan  1 1900 00:00:00', 

				'', 

				'',

				@@StatusId, 

				@@StatusName, 

				@@Emp_No, 

				@@Segment_Type, 

				1

			from B2B_Bulk_DealerMapping with (nolock)

			where ProcessId = @@ProcessId

			and Segment_Type = @@Segment_Type

		end

		else

		begin

			insert into B2B_CommonPartyServices_Offline 

			(Party_Code,

			Branch_Cd,

			Source_Dealer_Code,

			Target_Dealer_Code,

			From_Date,

			To_Date,

			Entry_Time_Stamp,

			To_Be_Processed,

			Process_Time_Stamp,

			Reason_For_Non_Process,

			Other_Remarks,

			Status_Id,

			Status_Name,

			Emp_No,

			Segment_Type,

			CommRank)

			Select 

			B.Party_code,

			--Branch_cd, 

			Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B.Party_Code) , 

			/*CurrencyDealer --- need to be added later*/EMP_No, 

			Dealer1,

			left(getdate(), 11) + ' 00:00:00',

			'Dec 31 2049 23:59:00',

			getdate(), 

			'Y', 

			'Jan  1 1900 00:00:00', 

			'', 

			'',

			@@StatusId, 

			@@StatusName, 

			@@Emp_No, 

			@@Segment_Type,

			1

			from B2B_Bulk_DealerMapping B with (nolock), B2B_CommonPartyServices A with (nolock)

			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code

			and b.Segment_Type = @@Segment_Type

			and valid='Y'

		end

		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'

		

		-- Set the Flag true for the valid entry of Client mapping	 

              

				-- Code to send the SMS for valid client mapping                                                             

				If (@@smsFlag = 'YES') 

				begin

					insert into TBL_B2B_CRMS_SMS_DEALER_MAPPING

					(

						party_code,

						party_mobile,

						sub_broker,

						sub_broker_name,

						DealerCode,

						DealerName,

						DealerContact

					) 

					Select 

						B.Party_code,

						mobileNo=(case when len(rtrim(ltrim(mobile_pager)))=10 then rtrim(ltrim(mobile_pager)) else 'NA' end) ,

						A.Sub_broker,

						Sub_Broker_Name=(select tradename from MIS.sb_comp.dbo.sb_broker with(nolock) where sbtag=a.sub_broker),

						B.Dealer1,

						--dealerName=(select emp_name from B2B_AngelHarmony e with(nolock) where e.emp_no=B.Dealer1 and isdealer='1'),

						dealerName=emp_name,

						contactNo=landline_no

					 from 

						B2B_Bulk_DealerMapping B with (nolock), angelclient1 A with (nolock),B2B_AngelHarmony  with(nolock)

					 where 

						ProcessId = @@ProcessId and 

						A.Party_Code = B.Party_Code

						and Segment_Type = @@Segment_Type

						and rtrim(ltrim(AngelClRating))<>'NEW'

						and emp_no=B.Dealer1

						and isdealer='1'

						--and isadmin<>'1'

    			end

	end				           

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_demo_bkp17Jan2020
-- --------------------------------------------------
CREATE proc [dbo].[B2B_CRMS_DealerMapping_demo_bkp17Jan2020]                                                                    
(                                                                    
	@Emp_No varchar(20), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(20),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(20),                                                                    
	@ToDealer varchar(20),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100),                                
	@smsFlag varchar(10),
	@Segment_Type Varchar(20),
	@ProcessId Varchar(50)                                                                     
)   
WITH RECOMPILE                                                                 
AS      
BEGIN    
/*
	Exec B2B_CRMS_DealerMapping_ADTest 
	@Emp_No='CBHO001',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='AIL',
	@FromDealer='',@ToDealer='CBHO001',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId=''
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 

*/
SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
			@@StatusName varchar(20),                                                                                                                                                                                               
			@@Emp_No varchar(20),                                                                    
			@@PartyCode varchar(10),                                                                       
			@@Branch_cd varchar(10),                                                                   
			@@FromDealer varchar(20),                                                                    
			@@ToDealer varchar(20),                                                                 
			@@ReportFlag varchar(100),                                                           
			@@smsFlag varchar(10),
			@@FromParty varchar(10) ,
			@@ToParty   varchar(10),
			@@Segment_Type varchar(20),
			@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	SET @@smsFlag=@smsFlag
	SET @@Segment_Type = @Segment_Type
	SET @@ProcessId = @ProcessId 
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end
	
	if @@ReportFlag='LIST'
	BEGIN
		
		Print 'List:--> Start:-->'+ convert(varchar,getdate(),109)
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		--Checking if Dealer Data available in mini harmony.
		--print len(@@FromDealer)
		--print @@FromDealer
		--if((upper(@@FromDealer)<>'UNDEFINED') or (len(@@FromDealer)<>0))
		--begin
		--	if not exists
		--	(select empcode from B2B_Harmony with(nolock) where empcode=@@FromDealer)
 	--		Begin
 	--			Select  msg = 'Existing Dealer Not Available in harmony sdfsdfsdf.'                                                                    
		--		return  
		--	end
		--end	
		
		--Commented by prasanna after change in BRS on Jun 23 2012
		
		if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		if(len(@@FromDealer)<>0)
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@FromDealer)
 			Begin
 				Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    
				return  
			end
		end
		Print 'List:--> Step 1:-->'+ convert(varchar,getdate(),109)
	--	--Mappging to employee other than dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	----------
	--	--Checking if Dealer Data available in mini harmony.
		--if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		--begin
		--	if not exists
		--	(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 	--		Begin
 	--			Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
		--		return  
		--	end
		--end
	----------
	--    --Resigned Dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	----------
		
		
	--------
		--collecting parent and child delear list  	
		--declare  @temp_sbtag table
		--(sbtag varchar(10))
		
		--insert into @temp_sbtag
		--select sbtag from
		--(
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--	Union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=@Branch_cd
		--	union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where sbtag=@Branch_cd
		--	union
		--	select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--)a	
		
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 
		
		--select * from @temp_sbtag	
		--Checking the to dealer belongs to sub broker family
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		Print 'List:--> Step 2:-->'+ convert(varchar,getdate(),109)
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the existing dealer.'                                                                    
			return  
		end 
		
		Print 'List:--> Step 3:-->'+ convert(varchar,getdate(),109)
	---------
		--Checking client sub broker relationship	
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) ,@temp_sbtag
			where sub_broker=sbtag and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		
		
		Declare @mytable table                                    
		(          
			Client_code varchar(10) ,                                                                              
			Client_name varchar(100) ,                                                           
			Sub_Broker varchar(10) ,                               
			Trading_Mode varchar(20),
			Dealer_code_Existing varchar(20),
			Dealer_code_New  varchar(20),
			ColorCode varchar(50)                                                             
		) 
		----
		--print @@FromDealer
		--print @@ToDealer
		--print @@FromParty
		--print @@ToParty
		
		--select * from @temp_sbtag
		
		Insert into @mytable
		(
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode 
		)
		Select 
			Client_code=AC1.Party_code,
			Client_name = AC1.Long_Name,
			AC1.Sub_Broker, 
			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
			Dealer_code_Existing=CPS.Emp_No,
			Dealer_code_New=@@ToDealer,
			ColorCode = ''
		From 
			B2B_CommonPartyServices CPS with (noLock), [196.1.115.207].angelcs.dbo.angelClient1 AC1 with (noLock),@temp_sbtag
		Where 
			CPS.Party_Code = AC1.Party_Code                                                                
			And AC1.Sub_Broker = sbtag                                                                    
			And B2C='N'                                                                   
			And Cl_type<>'SUB'                                                                    
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                 
			And CPS.Valid = 'Y'                                                                    
			And CPS.Emp_No like @@FromDealer + '%'                                                                 
			And CPS.Emp_No <> @@ToDealer                                                                  
			And CPS.Party_Code >= @@FromParty 
			And CPS.Party_Code <= @@ToParty                                                                                                                          
			

		IF(@@FromDealer = '' OR @@FromDealer like '%001')
		Begin

			Insert into @mytable
			(
				Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
				ColorCode 
			)
			Select 
				Client_code=AC1.Party_code,
				Client_name = AC1.Long_Name,
				AC1.Sub_Broker, 
				Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
				Dealer_code_Existing=AC1.Sub_Broker + '001',
				Dealer_code_New=@@ToDealer,
				ColorCode = ''
			From @temp_sbtag T,
			[196.1.115.207].angelcs.dbo.angelClient1 AC1 with (noLock) LEFT OUTER JOIN B2B_CommonPartyServices CPS with (noLock)
			ON (AC1.party_code = CPS.Party_Code and CPS.valid = 'Y')			
			Where AC1.Sub_Broker = T.sbtag                                                                                                                                       
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                                                                                                                                             
			And AC1.Party_Code >= @@FromParty 
			And AC1.Party_Code <= @@ToParty   
			and AC1.B2C = 'N' And AC1.Cl_type<>'SUB'
			and CPS.party_code is null  
			and AC1.party_code not in (Select Client_code from @mytable)

		End
	---------------------------------------------------------------------                                    

	--Select * from @temp_sbtag

		update 
			@mytable
		set 
			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)
		from
			B2B_CommonPartyServices_Offline P with (nolock), @mytable T
		where
			T.Client_code = P.party_code
			and to_be_processed = 'Y'
			
		
---------------------------------------------------------------
		select  
			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode
		from 
			@mytable order by Client_code
		end
		
		---------CHeck Contact Details of @@ToDealer ----------------------------------------------- 
		if exists (select top 1 Client_code from @mytable)
		begin                               
				if @@ToDealer='' or upper(@@ToDealer)='UNDEFINED'                                    
				begin                                    
				 select '' as dealer , '' as contact                                    
				end                                    
				else if exists(select top 1 emp_no from B2B_AngelHarmony e with(nolock)                                    
				 where emp_no=ltrim(rtrim(@@ToDealer))                                    
					                               
				) 
				begin                                    
				-----                        
				select 'DEALER' as dealer,                                    
				--isnull((select top 1 rtrim(ltrim(STDCode))+'-'+rtrim(ltrim(Phone1)) from crm..CRMBranchContactDetails where ContactPerson=e.emp_no),'') as contact                                    
				isnull(landline_no,'') as contact                                    
				from B2B_AngelHarmony e with(nolock) 
				where emp_no=ltrim(rtrim(@@ToDealer))  
				and isDealer='1'                                  
				
				
				---                                    
				end                                    
				else                                     
				begin                                     
				select '' as dealer , '' as contact                                    
				                                                                        
				end  
				Print 'List:--> End :-->'+ convert(varchar,getdate(),109)	   
		end		 
		
----------******************88----------------****************------------------******************8	
	ELSE if (@@ReportFlag='BULK') 
	BEGIN
		/********* RAM Table to maintain the error messages to display in a grid on UI */
		Declare @BulkErrorTable Table
		(
			ProcessId varchar(50),
			Party_Code varchar(10),
			CurrencyDealer Varchar(20),
			ErrorMessages varchar(100)
		)
		
		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */
		Declare @BulkBranch Table
		(
			Party_Code varchar(10),
			Party_Region varchar(10),
			CurrencyDealer varchar(10),
			Dealer_Region varchar(10)
		)	
		
		/************************************************ Validations starts here ****************************************************/
		/* 1. Validation -> Client is a B2C client	*/
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is not a B2B client.'
		from B2B_Bulk_DealerMapping C with (nolock),
			angelclient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'Y'
		and Segment_Type = @@Segment_Type
		/* *****************************************************************/
		
		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++
		/*******Commendted by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients*******/
		/*
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is inactive.'
		from B2B_Bulk_DealerMapping C with (nolock),
			AngelClient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'N'
		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))
		and Segment_Type = @@Segment_Type
		*/
		/*******End Commendted by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients*******/

		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++
		
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee is terminated.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		and A.status='T'
		--and A.TerminationFrom <= GETDATE()
		--and A.InactiveFrom <=getdate()
		
		--and Status <> 'A'
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee does not Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		--and upper(category) not in ('DEALER')
		--and C.Dealer1 <> 'UNDEFINED'
		and isDealer<>1
		and Segment_Type = @@Segment_Type
		/* **************************************************************** */
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++
		/* 5. Validation -> Client code and New dealer are from same Parent tag. */
		create table  #parent_info 
		(
			Party_Code varchar(10),
			Sub_Broker varchar(10),
			client_parent varchar(10), 
			Dealer1 varchar(20),
			SBTag varchar(10),
			sb_parent varchar(10)
		)

		insert into #parent_info
		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.SB_Tag,sb_parent=''   
		from 
			B2B_Bulk_DealerMapping a1 with(nolock),angelclient1 b1 with(nolock),B2B_AngelHarmony c1  with(nolock)
		where ProcessId=@@ProcessID
		and a1.Party_Code=b1.Party_Code
		and c1.Emp_no =a1.Dealer1 
		and c1.isDealer=1
		and Segment_Type = @@Segment_Type


		update #parent_info

		set client_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.Sub_Broker 

		update #parent_info

		set sb_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.SBTag 
		
		Insert into @BulkErrorTable
		select	@@ProcessID,
				Party_Code,
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '
		from #parent_info where sb_parent<>client_parent
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++
		/* 6. Validation -> If client code or  dealer is blank */
		
		Insert into @BulkErrorTable
		select	ProcessId,
		isnull(C.Party_Code, ''),
		CurrencyDealer = isnull(Dealer1, ''),
		ErrorMessages = 'Incomplete data.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where ProcessId = @@ProcessID
		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++
		
		/* 7. Validation -> If Client is already mapped to the same  dealer */
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Dealer already mapped to the client.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_CommonPartyServices P with (nolock)
		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')
		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'
		and C.Segment_Type = P.Segment_Type
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++
		/* 8. Validation -> If client is available more than once in the file, 
				first entry of the client sequentially should be uploaded and remainder should be discarded */
		                
		select party_code, cnt = count(*) into #RemoveDuplicate               
		from B2B_Bulk_DealerMapping with(nolock) where ProcessId = @@ProcessId                 
		group by party_code                 
        HAVING count(*) > 1              
		
		if exists(select Party_Code from #RemoveDuplicate)          
		begin          
			--CURSOR TO UPDATE  			
			Declare @strPartyCode varchar(10)      
			Declare @totalcountForCursor int       
			Declare RemoveDuplicateCursor cursor for   
			--          
			select Party_Code, cnt from #RemoveDuplicate          
			--          
			Open RemoveDuplicateCursor           
			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          

			While @@FETCH_STATUS = 0                                                                                                                      
			Begin           
				set @totalcountForCursor=@totalcountForCursor-1          
				set rowcount @totalcountForCursor          
				--          
				Insert into @BulkErrorTable
				select distinct	C.ProcessId,
						isnull(C.Party_Code, ''),
						CurrencyDealer = isnull(Dealer1, ''),
						ErrorMessages = 'Duplicate entry.'
				from B2B_Bulk_DealerMapping C with (nolock)
				where C.ProcessId = @@ProcessId
				and isnull(C.Party_Code, '') = @strPartyCode
				and C.Segment_Type = @@Segment_Type  
				
				Delete from B2B_Bulk_DealerMapping  
				where ProcessId = @@ProcessId
				and isnull(Party_Code, '') = @strPartyCode
				and Segment_Type = @@Segment_Type 

				fetch next from RemoveDuplicateCursor                                                                   
				into @strPartyCode,@totalcountForCursor          
			END          
			close RemoveDuplicateCursor                                                                                                    
			deallocate RemoveDuplicateCursor          
			------------------------------------          
			drop table #RemoveDuplicate          
			set rowcount 0          
		end    
		
		
	
	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++
		/* 9. Validation -> If client code is invalid */
		
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID 
		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)
		and isnull(C.Party_Code, '') <> ''
		and C.Segment_Type = @@Segment_Type
		
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 not in (select Emp_No from B2B_AngelHarmony A with (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Dealer1 = A.Emp_No and ProcessId = @@ProcessID)
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Invalid row'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 is null
		and Party_Code is null
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++
		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Update contact details of Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_AngelHarmony E with (nolock)
		where E.Emp_no = isnull(C.Dealer1, '') 		
		and C.ProcessId = @@ProcessID
		and len(isnull(E.Landline_no,''))=0
		and e.isDealer=1
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		Delete B2B_Bulk_DealerMapping
		from @BulkErrorTable B
		where isnull(B2B_Bulk_DealerMapping.Party_Code, '') = isnull(B.Party_Code, '') 
		and B2B_Bulk_DealerMapping.Segment_Type = @@Segment_Type 
		and isnull(B2B_Bulk_DealerMapping.Dealer1, '') = isnull(B.CurrencyDealer, '') 
		and B2B_Bulk_DealerMapping.ProcessId = B.ProcessId
		and B2B_Bulk_DealerMapping.ProcessId = @@ProcessID
		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation
		/* ************* Selecting the records from error table *************** */
		
		select	Client_Code = ltrim(rtrim(Party_Code)), 
				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),
				ErrorMessages = ErrorMessages   
		from @BulkErrorTable
		where ProcessId = @@ProcessID
		
		select cnt = COUNT(*) from B2B_Bulk_DealerMapping with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type
		
		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID
		
	END
	ELSE if (@@ReportFlag='SAVE') 
	BEGIN
		print 'SAVE'

		Select M.party_code 
		into #InvalidClientCodes
		from B2B_Bulk_DealerMapping M with (nolock) LEFT OUTER JOIN angelclient1 a1 with(nolock)
		ON (M.party_code = a1.party_code)
		where M.ProcessId = @@ProcessId
		and M.Segment_Type = @@Segment_Type
		and a1.party_code is null

		Declare @Invalid_Party_code varchar(max)

		SELECT @Invalid_Party_code = STUFF
		(
			(
				SELECT ',' + s.party_code 
				FROM #InvalidClientCodes s
				ORDER BY s.party_code FOR XML PATH('')
			),
			 1, 1, ''
		)


		
		IF EXISTS (Select top 1 party_code from #InvalidClientCodes)
		BEGIN
			select msg = 'Error: Unable to upload file. Uploaded file contains invalid client codes (Invalid List: ' + @Invalid_Party_code + ')'
			RETURN;
		END
		
		declare  @temp_sbtag1 table
		(sbtag varchar(10))
		
		insert into @temp_sbtag1
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 

		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
	--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag1 b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		
		if Len(@@FromDealer)=0 
		Begin
 			Select  msg = 'Please Enter From Dealer'                                                                    
			return  
		end 
			
		If Exists(Select O.Party_code 
					from B2B_CommonPartyServices_Offline O with (nolock), B2B_Bulk_DealerMapping M with (nolock) 
					where O.Party_Code = M.Party_Code and
					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)
		Begin
			update B2B_CommonPartyServices_Offline
			set To_Be_Processed = 'N',
			process_time_stamp = getdate(),                                        
			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     
			from B2B_Bulk_DealerMapping M with (nolock), B2B_CommonPartyServices_Offline C with (nolock)                                  
			where C.Party_Code = M.Party_Code
			and To_Be_Processed = 'Y'
			and C.Segment_Type = M.Segment_Type
			and C.Segment_Type = @@Segment_Type
			and ProcessId = @@ProcessId
		End

		if(@@Branch_cd <> '')
		begin
			insert into B2B_CommonPartyServices_Offline 
			(
				Party_Code,
				Branch_Cd,
				Source_Dealer_Code,
				Target_Dealer_Code,
				From_Date,
				To_Date,
				Entry_Time_Stamp,
				To_Be_Processed,
				Process_Time_Stamp,
				Reason_For_Non_Process,
				Other_Remarks,
				Status_Id,
				Status_Name,
				Emp_No,
				Segment_Type,
				CommRank
			)
			Select 
				Party_code, 
				--@@Branch_cd=select , 
				--Branch_cd=(select sb_tag from B2B_AngelHarmony with(nolock) where emp_no=dealer1) , 
				Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B2B_Bulk_DealerMapping.Party_Code) , 
				@@FromDealer, 
				--Dealer1,
				@ToDealer,
				left(getdate(), 11) + ' 00:00:00',
				'Dec 31 2049 23:59:00',
				getdate(), 
				'Y', 
				'Jan  1 1900 00:00:00', 
				'', 
				'',
				@@StatusId, 
				@@StatusName, 
				@@Emp_No, 
				@@Segment_Type, 
				1
			from B2B_Bulk_DealerMapping with (nolock)
			where ProcessId = @@ProcessId
			and Segment_Type = @@Segment_Type
		end
		else
		begin
			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			B.Party_code,
			--Branch_cd, 
			Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B.Party_Code) , 
			/*CurrencyDealer --- need to be added later*/EMP_No, 
			Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 
			'Y', 
			'Jan  1 1900 00:00:00', 
			'', 
			'',
			@@StatusId, 
			@@StatusName, 
			@@Emp_No, 
			@@Segment_Type,
			1
			from B2B_Bulk_DealerMapping B with (nolock), B2B_CommonPartyServices A with (nolock)
			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code
			and b.Segment_Type = @@Segment_Type
			and valid='Y'
		end
		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'
		
		-- Set the Flag true for the valid entry of Client mapping	 
              
				-- Code to send the SMS for valid client mapping                                                             
				If (@@smsFlag = 'YES') 
				begin
					insert into TBL_B2B_CRMS_SMS_DEALER_MAPPING
					(
						party_code,
						party_mobile,
						sub_broker,
						sub_broker_name,
						DealerCode,
						DealerName,
						DealerContact
					) 
					Select 
						B.Party_code,
						mobileNo=(case when len(rtrim(ltrim(mobile_pager)))=10 then rtrim(ltrim(mobile_pager)) else 'NA' end) ,
						A.Sub_broker,
						Sub_Broker_Name=(select tradename from MIS.sb_comp.dbo.sb_broker with(nolock) where sbtag=a.sub_broker),
						B.Dealer1,
						--dealerName=(select emp_name from B2B_AngelHarmony e with(nolock) where e.emp_no=B.Dealer1 and isdealer='1'),
						dealerName=emp_name,
						contactNo=landline_no
					 from 
						B2B_Bulk_DealerMapping B with (nolock), angelclient1 A with (nolock),B2B_AngelHarmony  with(nolock)
					 where 
						ProcessId = @@ProcessId and 
						A.Party_Code = B.Party_Code
						and Segment_Type = @@Segment_Type
						and rtrim(ltrim(AngelClRating))<>'NEW'
						and emp_no=B.Dealer1
						and isdealer='1'
						--and isadmin<>'1'
    			end
	end				           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_demo_Test
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE proc [dbo].[B2B_CRMS_DealerMapping_demo_Test]                                                                    
(                                                                    
	@Emp_No varchar(20), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(20),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(20),                                                                    
	@ToDealer varchar(20),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100),                                
	@smsFlag varchar(10),
	@Segment_Type Varchar(20),
	@ProcessId Varchar(50)                                                                     
)   
WITH RECOMPILE                                                                 
AS      
BEGIN    
/*
	Exec B2B_CRMS_DealerMapping_ADTest 
	@Emp_No='CBHO001',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='AIL',
	@FromDealer='',@ToDealer='CBHO001',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId=''
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 

*/
SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
			@@StatusName varchar(20),                                                                                                                                                                                               
			@@Emp_No varchar(20),                                                                    
			@@PartyCode varchar(10),                                                                       
			@@Branch_cd varchar(10),                                                                   
			@@FromDealer varchar(20),                                                                    
			@@ToDealer varchar(20),                                                                 
			@@ReportFlag varchar(100),                                                           
			@@smsFlag varchar(10),
			@@FromParty varchar(10) ,
			@@ToParty   varchar(10),
			@@Segment_Type varchar(20),
			@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	SET @@smsFlag=@smsFlag
	SET @@Segment_Type = @Segment_Type
	SET @@ProcessId = @ProcessId 
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end
	
	if @@ReportFlag='LIST'
	BEGIN
		
		Print 'List:--> Start:-->'+ convert(varchar,getdate(),109)
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		--Checking if Dealer Data available in mini harmony.
		--print len(@@FromDealer)
		--print @@FromDealer
		--if((upper(@@FromDealer)<>'UNDEFINED') or (len(@@FromDealer)<>0))
		--begin
		--	if not exists
		--	(select empcode from B2B_Harmony with(nolock) where empcode=@@FromDealer)
 	--		Begin
 	--			Select  msg = 'Existing Dealer Not Available in harmony sdfsdfsdf.'                                                                    
		--		return  
		--	end
		--end	
		
		--Commented by prasanna after change in BRS on Jun 23 2012
		
		if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		if(len(@@FromDealer)<>0)
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@FromDealer)
 			Begin
 				Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    
				return  
			end
		end
		Print 'List:--> Step 1:-->'+ convert(varchar,getdate(),109)
	--	--Mappging to employee other than dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	----------
	--	--Checking if Dealer Data available in mini harmony.
		--if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		--begin
		--	if not exists
		--	(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 	--		Begin
 	--			Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
		--		return  
		--	end
		--end
	----------
	--    --Resigned Dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	----------
		
		
	--------
		--collecting parent and child delear list  	
		--declare  @temp_sbtag table
		--(sbtag varchar(10))
		
		--insert into @temp_sbtag
		--select sbtag from
		--(
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--	Union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=@Branch_cd
		--	union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where sbtag=@Branch_cd
		--	union
		--	select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--)a	
		
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 
		
		--select * from @temp_sbtag	
		--Checking the to dealer belongs to sub broker family
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		Print 'List:--> Step 2:-->'+ convert(varchar,getdate(),109)
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the existing dealer.'                                                                    
			return  
		end 
		
		Print 'List:--> Step 3:-->'+ convert(varchar,getdate(),109)
	---------
		--Checking client sub broker relationship	
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) ,@temp_sbtag
			where sub_broker=sbtag and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		
		
		Declare @mytable table                                    
		(          
			Client_code varchar(10) ,                                                                              
			Client_name varchar(100) ,                                                           
			Sub_Broker varchar(10) ,                               
			Trading_Mode varchar(20),
			Dealer_code_Existing varchar(20),
			Dealer_code_New  varchar(20),
			ColorCode varchar(50)                                                             
		) 
		----
		--print @@FromDealer
		--print @@ToDealer
		--print @@FromParty
		--print @@ToParty
		
		--select * from @temp_sbtag
		
		Insert into @mytable
		(
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode 
		)
		Select 
			Client_code=AC1.Party_code,
			Client_name = AC1.Long_Name,
			AC1.Sub_Broker, 
			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
			Dealer_code_Existing=CPS.Emp_No,
			Dealer_code_New=@@ToDealer,
			ColorCode = ''
		From 
			B2B_CommonPartyServices CPS with (noLock), MIMANSA.angelcs.dbo.angelClient1 AC1 with (noLock),@temp_sbtag
		Where 
			CPS.Party_Code = AC1.Party_Code                                                                
			And AC1.Sub_Broker = sbtag                                                                    
			And B2C='N'                                                                   
			And Cl_type<>'SUB'                                                                    
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                 
			And CPS.Valid = 'Y'                                                                    
			And CPS.Emp_No like @@FromDealer + '%'                                                                 
			And CPS.Emp_No <> @@ToDealer                                                                  
			And CPS.Party_Code >= @@FromParty 
			And CPS.Party_Code <= @@ToParty                                                                                                                          
			

		IF(@@FromDealer = '' OR @@FromDealer like '%001')
		Begin

			Insert into @mytable
			(
				Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
				ColorCode 
			)
			Select 
				Client_code=AC1.Party_code,
				Client_name = AC1.Long_Name,
				AC1.Sub_Broker, 
				Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
				Dealer_code_Existing=AC1.Sub_Broker + '001',
				Dealer_code_New=@@ToDealer,
				ColorCode = ''
			From @temp_sbtag T,
			MIMANSA.angelcs.dbo.angelClient1 AC1 with (noLock) LEFT OUTER JOIN B2B_CommonPartyServices CPS with (noLock)
			ON (AC1.party_code = CPS.Party_Code and CPS.valid = 'Y')			
			Where AC1.Sub_Broker = T.sbtag                                                                                                                                       
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                                                                                                                                             
			And AC1.Party_Code >= @@FromParty 
			And AC1.Party_Code <= @@ToParty   
			and AC1.B2C = 'N' And AC1.Cl_type<>'SUB'
			and CPS.party_code is null  
			and AC1.party_code not in (Select Client_code from @mytable)

		End
	---------------------------------------------------------------------                                    

	--Select * from @temp_sbtag

		update 
			@mytable
		set 
			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)
		from
			B2B_CommonPartyServices_Offline P with (nolock), @mytable T
		where
			T.Client_code = P.party_code
			and to_be_processed = 'Y'
			
		
---------------------------------------------------------------
		select  
			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode
		from 
			@mytable order by Client_code
		end
		
		---------CHeck Contact Details of @@ToDealer ----------------------------------------------- 
		if exists (select top 1 Client_code from @mytable)
		begin                               
				if @@ToDealer='' or upper(@@ToDealer)='UNDEFINED'                                    
				begin                                    
				 select '' as dealer , '' as contact                                    
				end                                    
				else if exists(select top 1 emp_no from B2B_AngelHarmony e with(nolock)                                    
				 where emp_no=ltrim(rtrim(@@ToDealer))                                    
					                               
				) 
				begin                                    
				-----                        
				select 'DEALER' as dealer,                                    
				--isnull((select top 1 rtrim(ltrim(STDCode))+'-'+rtrim(ltrim(Phone1)) from crm..CRMBranchContactDetails where ContactPerson=e.emp_no),'') as contact                                    
				isnull(landline_no,'') as contact                                    
				from B2B_AngelHarmony e with(nolock) 
				where emp_no=ltrim(rtrim(@@ToDealer))  
				and isDealer='1'                                  
				
				
				---                                    
				end                                    
				else                                     
				begin                                     
				select '' as dealer , '' as contact                                    
				                                                                        
				end  
				Print 'List:--> End :-->'+ convert(varchar,getdate(),109)	   
		end		 
		
----------******************88----------------****************------------------******************8	
	ELSE if (@@ReportFlag='BULK') 
	BEGIN
		/********* RAM Table to maintain the error messages to display in a grid on UI */
		Declare @BulkErrorTable Table
		(
			ProcessId varchar(50),
			Party_Code varchar(10),
			CurrencyDealer Varchar(20),
			ErrorMessages varchar(100)
		)
		
		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */
		Declare @BulkBranch Table
		(
			Party_Code varchar(10),
			Party_Region varchar(10),
			CurrencyDealer varchar(10),
			Dealer_Region varchar(10)
		)	
		
		/************************************************ Validations starts here ****************************************************/
		/* 1. Validation -> Client is a B2C client	*/
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is not a B2B client.'
		from B2B_Bulk_DealerMapping C with (nolock),
			angelclient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'Y'
		and Segment_Type = @@Segment_Type
		/* *****************************************************************/
		
		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is inactive.'
		from B2B_Bulk_DealerMapping C with (nolock),
			AngelClient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'N'
		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))
		and Segment_Type = @@Segment_Type
		
		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++
		
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee is terminated.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		and A.status='T'
		--and A.TerminationFrom <= GETDATE()
		--and A.InactiveFrom <=getdate()
		
		--and Status <> 'A'
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee does not Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		--and upper(category) not in ('DEALER')
		--and C.Dealer1 <> 'UNDEFINED'
		and isDealer<>1
		and Segment_Type = @@Segment_Type
		/* **************************************************************** */
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++
		/* 5. Validation -> Client code and New dealer are from same Parent tag. */
		create table  #parent_info 
		(
			Party_Code varchar(10),
			Sub_Broker varchar(10),
			client_parent varchar(10), 
			Dealer1 varchar(20),
			SBTag varchar(10),
			sb_parent varchar(10)
		)

		insert into #parent_info
		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.SB_Tag,sb_parent=''   
		from 
			B2B_Bulk_DealerMapping a1 with(nolock),angelclient1 b1 with(nolock),B2B_AngelHarmony c1  with(nolock)
		where ProcessId=@@ProcessID
		and a1.Party_Code=b1.Party_Code
		and c1.Emp_no =a1.Dealer1 
		and c1.isDealer=1
		and Segment_Type = @@Segment_Type


		update #parent_info

		set client_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.Sub_Broker 

		update #parent_info

		set sb_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.SBTag 
		
		Insert into @BulkErrorTable
		select	@@ProcessID,
				Party_Code,
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '
		from #parent_info where sb_parent<>client_parent
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++
		/* 6. Validation -> If client code or  dealer is blank */
		
		Insert into @BulkErrorTable
		select	ProcessId,
		isnull(C.Party_Code, ''),
		CurrencyDealer = isnull(Dealer1, ''),
		ErrorMessages = 'Incomplete data.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where ProcessId = @@ProcessID
		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++
		
		/* 7. Validation -> If Client is already mapped to the same  dealer */
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Dealer already mapped to the client.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_CommonPartyServices P with (nolock)
		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')
		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'
		and C.Segment_Type = P.Segment_Type
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++
		/* 8. Validation -> If client is available more than once in the file, 
				first entry of the client sequentially should be uploaded and remainder should be discarded */
		                
		select party_code, cnt = count(*) into #RemoveDuplicate               
		from B2B_Bulk_DealerMapping with(nolock) where ProcessId = @@ProcessId                 
		group by party_code                 
        HAVING count(*) > 1              
		
		if exists(select Party_Code from #RemoveDuplicate)          
		begin          
			--CURSOR TO UPDATE  			
			Declare @strPartyCode varchar(10)      
			Declare @totalcountForCursor int       
			Declare RemoveDuplicateCursor cursor for   
			--          
			select Party_Code, cnt from #RemoveDuplicate          
			--          
			Open RemoveDuplicateCursor           
			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          

			While @@FETCH_STATUS = 0                                                                                                                      
			Begin           
				set @totalcountForCursor=@totalcountForCursor-1          
				set rowcount @totalcountForCursor          
				--          
				Insert into @BulkErrorTable
				select distinct	C.ProcessId,
						isnull(C.Party_Code, ''),
						CurrencyDealer = isnull(Dealer1, ''),
						ErrorMessages = 'Duplicate entry.'
				from B2B_Bulk_DealerMapping C with (nolock)
				where C.ProcessId = @@ProcessId
				and isnull(C.Party_Code, '') = @strPartyCode
				and C.Segment_Type = @@Segment_Type  
				
				Delete from B2B_Bulk_DealerMapping  
				where ProcessId = @@ProcessId
				and isnull(Party_Code, '') = @strPartyCode
				and Segment_Type = @@Segment_Type 

				fetch next from RemoveDuplicateCursor                                                                   
				into @strPartyCode,@totalcountForCursor          
			END          
			close RemoveDuplicateCursor    
			deallocate RemoveDuplicateCursor          
			------------------------------------          
			drop table #RemoveDuplicate          
			set rowcount 0          
		end    
		
		
	
	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++
		/* 9. Validation -> If client code is invalid */
		
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID 
		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)
		and isnull(C.Party_Code, '') <> ''
		and C.Segment_Type = @@Segment_Type
		
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 not in (select Emp_No from B2B_AngelHarmony A with (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Dealer1 = A.Emp_No and ProcessId = @@ProcessID)
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Invalid row'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 is null
		and Party_Code is null
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++
		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Update contact details of Dealer.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_AngelHarmony E with (nolock)
		where E.Emp_no = isnull(C.Dealer1, '') 		
		and C.ProcessId = @@ProcessID
		and len(isnull(E.Landline_no,''))=0
		and e.isDealer=1
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		Delete B2B_Bulk_DealerMapping
		from @BulkErrorTable B
		where isnull(B2B_Bulk_DealerMapping.Party_Code, '') = isnull(B.Party_Code, '') 
		and B2B_Bulk_DealerMapping.Segment_Type = @@Segment_Type 
		and isnull(B2B_Bulk_DealerMapping.Dealer1, '') = isnull(B.CurrencyDealer, '') 
		and B2B_Bulk_DealerMapping.ProcessId = B.ProcessId
		and B2B_Bulk_DealerMapping.ProcessId = @@ProcessID
		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation
		/* ************* Selecting the records from error table *************** */
		
		select	Client_Code = ltrim(rtrim(Party_Code)), 
				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),
				ErrorMessages = ErrorMessages   
		from @BulkErrorTable
		where ProcessId = @@ProcessID
		
		select cnt = COUNT(*) from B2B_Bulk_DealerMapping with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type
		
		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID
		
	END
	ELSE if (@@ReportFlag='SAVE') 
	BEGIN
		print 'SAVE'

		Select M.party_code 
		into #InvalidClientCodes
		from B2B_Bulk_DealerMapping M with (nolock) LEFT OUTER JOIN angelclient1 a1 with(nolock)
		ON (M.party_code = a1.party_code)
		where M.ProcessId = @@ProcessId
		and M.Segment_Type = @@Segment_Type
		and a1.party_code is null

		Declare @Invalid_Party_code varchar(max)

		SELECT @Invalid_Party_code = STUFF
		(
			(
				SELECT ',' + s.party_code 
				FROM #InvalidClientCodes s
				ORDER BY s.party_code FOR XML PATH('')
			),
			 1, 1, ''
		)


		
		IF EXISTS (Select top 1 party_code from #InvalidClientCodes)
		BEGIN
			select msg = 'Error: Unable to upload file. Uploaded file contains invalid client codes (Invalid List: ' + @Invalid_Party_code + ')'
			RETURN;
		END
		
		declare  @temp_sbtag1 table
		(sbtag varchar(10))
		
		insert into @temp_sbtag1
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 

		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
	--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag1 b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		
		if Len(@@FromDealer)=0 
		Begin
 			Select  msg = 'Please Enter From Dealer'                                                                    
			return  
		end 
			
		If Exists(Select O.Party_code 
					from B2B_CommonPartyServices_Offline O with (nolock), B2B_Bulk_DealerMapping M with (nolock) 
					where O.Party_Code = M.Party_Code and
					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)
		Begin
			update B2B_CommonPartyServices_Offline
			set To_Be_Processed = 'N',
			process_time_stamp = getdate(),                                        
			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     
			from B2B_Bulk_DealerMapping M with (nolock), B2B_CommonPartyServices_Offline C with (nolock)                                  
			where C.Party_Code = M.Party_Code
			and To_Be_Processed = 'Y'
			and C.Segment_Type = M.Segment_Type
			and C.Segment_Type = @@Segment_Type
			and ProcessId = @@ProcessId
		End

		if(@@Branch_cd <> '')
		begin
			insert into B2B_CommonPartyServices_Offline 
			(
				Party_Code,
				Branch_Cd,
				Source_Dealer_Code,
				Target_Dealer_Code,
				From_Date,
				To_Date,
				Entry_Time_Stamp,
				To_Be_Processed,
				Process_Time_Stamp,
				Reason_For_Non_Process,
				Other_Remarks,
				Status_Id,
				Status_Name,
				Emp_No,
				Segment_Type,
				CommRank
			)
			Select 
				Party_code, 
				--@@Branch_cd=select , 
				--Branch_cd=(select sb_tag from B2B_AngelHarmony with(nolock) where emp_no=dealer1) , 
				Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B2B_Bulk_DealerMapping.Party_Code) , 
				@@FromDealer, 
				--Dealer1,
				@ToDealer,
				left(getdate(), 11) + ' 00:00:00',
				'Dec 31 2049 23:59:00',
				getdate(), 
				'Y', 
				'Jan  1 1900 00:00:00', 
				'', 
				'',
				@@StatusId, 
				@@StatusName, 
				@@Emp_No, 
				@@Segment_Type, 
				1
			from B2B_Bulk_DealerMapping with (nolock)
			where ProcessId = @@ProcessId
			and Segment_Type = @@Segment_Type
		end
		else
		begin
			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			B.Party_code,
			--Branch_cd, 
			Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B.Party_Code) , 
			/*CurrencyDealer --- need to be added later*/EMP_No, 
			Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 
			'Y', 
			'Jan  1 1900 00:00:00', 
			'', 
			'',
			@@StatusId, 
			@@StatusName, 
			@@Emp_No, 
			@@Segment_Type,
			1
			from B2B_Bulk_DealerMapping B with (nolock), B2B_CommonPartyServices A with (nolock)
			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code
			and b.Segment_Type = @@Segment_Type
			and valid='Y'
		end
		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'
		
		-- Set the Flag true for the valid entry of Client mapping	 
              
				-- Code to send the SMS for valid client mapping                                                             
				If (@@smsFlag = 'YES') 
				begin
					insert into TBL_B2B_CRMS_SMS_DEALER_MAPPING
					(
						party_code,
						party_mobile,
						sub_broker,
						sub_broker_name,
						DealerCode,
						DealerName,
						DealerContact
					) 
					Select 
						B.Party_code,
						mobileNo=(case when len(rtrim(ltrim(mobile_pager)))=10 then rtrim(ltrim(mobile_pager)) else 'NA' end) ,
						A.Sub_broker,
						Sub_Broker_Name=(select tradename from MIS.sb_comp.dbo.sb_broker with(nolock) where sbtag=a.sub_broker),
						B.Dealer1,
						--dealerName=(select emp_name from B2B_AngelHarmony e with(nolock) where e.emp_no=B.Dealer1 and isdealer='1'),
						dealerName=emp_name,
						contactNo=landline_no
					 from 
						B2B_Bulk_DealerMapping B with (nolock), angelclient1 A with (nolock),B2B_AngelHarmony  with(nolock)
					 where 
						ProcessId = @@ProcessId and 
						A.Party_Code = B.Party_Code
						and Segment_Type = @@Segment_Type
						and rtrim(ltrim(AngelClRating))<>'NEW'
						and emp_no=B.Dealer1
						and isdealer='1'
						--and isadmin<>'1'
    			end
	end				           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_New
-- --------------------------------------------------
CREATE proc [dbo].[B2B_CRMS_DealerMapping_New]                                                                    
(                                                                    
	@Emp_No varchar(15), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(10),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(15),                                                                    
	@ToDealer varchar(15),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100),                                
	@smsFlag varchar(10),
	@Segment_Type Varchar(20),
	@ProcessId Varchar(50)                                                                     
)   
WITH RECOMPILE                                                                 
AS      
BEGIN    
/*
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='AIL',
	@FromDealer='UNDEFINED',@ToDealer='AILA001',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId=''
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 

*/
SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
			@@StatusName varchar(10),                                                                                                                                                                                               
			@@Emp_No varchar(15),                                                                    
			@@PartyCode varchar(10),                                                                       
			@@Branch_cd varchar(10),                                                                   
			@@FromDealer varchar(15),                                                                    
			@@ToDealer varchar(15),                                                                 
			@@ReportFlag varchar(100),                                                           
			@@smsFlag varchar(10),
			@@FromParty varchar(10) ,
			@@ToParty   varchar(10),
			@@Segment_Type varchar(20),
			@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	SET @@smsFlag=@smsFlag
	SET @@Segment_Type = @Segment_Type
	SET @@ProcessId = @ProcessId 
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end
	
	if @@ReportFlag='LIST'
	BEGIN
		
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@FromDealer)<>'UNDEFINED')
		begin
			if not exists
			(select Emp_No from B2B_AngelHarmony with(nolock) where Emp_No=@@FromDealer)
 			Begin
 				Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select Emp_No from B2B_AngelHarmony with(nolock) where Emp_No=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select Emp_No from B2B_AngelHarmony with(nolock) where Emp_No=@@ToDealer and mobile <> '' and email <>'')
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select empcode from B2B_Harmony with(nolock) where empcode=@@ToDealer and status='A' and
				TerminationFrom>GETDATE() and inActiveFrom >getdate())
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
		--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select Emp_No from B2B_AngelHarmony with(nolock) where Emp_No=@@ToDealer and isDealer=1)
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') does not belong to required department.'                                                                    
			return  
		end
		
	--------
		--collecting parent and child delear list  	
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		select sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@Branch_cd
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@Branch_cd
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		)a	
		
		--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select Emp_No from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.Sb_Tag=b2.sbtag where Emp_No=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the selected dealer.'                                                                    
			return  
		end 
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select Emp_No from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.Sb_Tag=b2.SbTag where Emp_No=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the selected dealer.'                                                                    
			return  
		end 
		
	---------
		--Checking client sub broker relationship	
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) where sub_broker=@Branch_cd and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		
		
		Declare @mytable table                                    
		(          
			Client_code varchar(10) ,                                                                              
			Client_name varchar(100) ,                                                           
			Sub_Broker varchar(10) ,                               
			Trading_Mode varchar(20),
			Dealer_code_Existing varchar(20),
			Dealer_code_New  varchar(20),
			ColorCode varchar(50)                                                             
		) 
		----
		print @@FromDealer
		print @@ToDealer
		print @@FromParty
		print @@ToParty
		
		Insert into @mytable
		(
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode 
		)
		Select 
			Client_code=AC1.Party_code,
			Client_name = AC1.Long_Name,
			AC1.Sub_Broker, 
			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
			Dealer_code_Existing=CPS.Emp_No,
			Dealer_code_New=@@ToDealer,
			ColorCode = ''
		From 
			B2B_CommonPartyServices CPS with (noLock), AngelClient1 AC1 with (noLock)
		Where 
			CPS.Party_Code = AC1.Party_Code                                                                
			And CPS.Dealerbranch = @@Branch_cd                                                                    
			And B2C='N'                                                                   
			And Cl_type<>'SUB'                                                                    
			And AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59'                                                                    
			And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'                                    
			And CPS.Valid = 'Y'                                                                    
			And CPS.Emp_No like @@FromDealer + '%'                                                                 
			And CPS.Emp_No <> @@ToDealer                                                                  
			And CPS.Party_Code >= @@FromParty 
			And CPS.Party_Code <= @@ToParty                                                                                                                          

	---------------------------------------------------------------------                                    

		update 
			@mytable
		set 
			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)
		from
			B2B_CommonPartyServices_Offline P with (nolock), @mytable T
		where
			T.Client_code = P.party_code
			and to_be_processed = 'Y'
---------------------------------------------------------------
		select  
			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode
		from 
			@mytable order by Client_code
		end
		
----------******************88----------------****************------------------******************8	
	ELSE if (@@ReportFlag='BULK') 
	BEGIN
		/********* RAM Table to maintain the error messages to display in a grid on UI */
		Declare @BulkErrorTable Table
		(
			ProcessId varchar(50),
			Party_Code varchar(10),
			CurrencyDealer Varchar(10),
			ErrorMessages varchar(100)
		)
		
		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */
		Declare @BulkBranch Table
		(
			Party_Code varchar(10),
			Party_Region varchar(10),
			CurrencyDealer varchar(10),
			Dealer_Region varchar(10)
		)	
		
		/************************************************ Validations starts here ****************************************************/
		/* 1. Validation -> Client is a B2C client	*/
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is not a B2B client.'
		from B2B_Bulk_DealerMapping C with (nolock),
			angelclient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'Y'
		and Segment_Type = @@Segment_Type
		/* *****************************************************************/
		
		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is inactive.'
		from B2B_Bulk_DealerMapping C with (nolock),
			AngelClient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'N'
		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))
		and Segment_Type = @@Segment_Type
		
		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++
		
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee is terminated.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_Harmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.EmpCode = isnull(C.Dealer1, '')
		and A.status='N'
		and A.TerminationFrom <= GETDATE()
		and A.InactiveFrom <=getdate()
		
		--and Status <> 'A'
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee does not belong to required department.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_No = isnull(C.Dealer1, '')
		--and upper(category) not in ('DEALER')
		and isDealer=0
		and C.Dealer1 <> 'UNDEFINED'
		and Segment_Type = @@Segment_Type
		/* **************************************************************** */
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++
		/* 5. Validation -> Client code and New dealer are from same Parent tag. */
		create table  #parent_info 
		(
			Party_Code varchar(10),
			Sub_Broker varchar(10),
			client_parent varchar(10), 
			Dealer1 varchar(10),
			SBTag varchar(10),
			sb_parent varchar(10)
		)

		insert into #parent_info
		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.Sb_Tag,sb_parent=''   
		 from B2B_Bulk_DealerMapping a1 with(nolock),angelclient1 b1 with(nolock),B2B_AngelHarmony c1  with(nolock)
		where ProcessId=@@ProcessID
		and a1.Party_Code=b1.Party_Code
		and c1.Emp_No =a1.Dealer1 
		and a1.Dealer1 <> 'UNDEFINED'
		and Segment_Type = @@Segment_Type


		update #parent_info

		set client_parent=isnull(b1.parenttag,b1.sbtag) from [196.1.115.239].Inhouse.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.Sub_Broker 

		update #parent_info

		set sb_parent=isnull(b1.parenttag,b1.sbtag) from [196.1.115.239].Inhouse.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.SBTag 
		
		Insert into @BulkErrorTable
		select	@@ProcessID,
				Party_Code,
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '
		from #parent_info where sb_parent<>client_parent
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++
		/* 6. Validation -> If client code or  dealer is blank */
		
		Insert into @BulkErrorTable
		select	ProcessId,
		isnull(C.Party_Code, ''),
		CurrencyDealer = isnull(Dealer1, ''),
		ErrorMessages = 'Incomplete data.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where ProcessId = @@ProcessID
		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++
		
		/* 7. Validation -> If Client is already mapped to the same  dealer */
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Dealer already mapped to the client.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_CommonPartyServices P with (nolock)
		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')
		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'
		and C.Segment_Type = P.Segment_Type
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++
		/* 8. Validation -> If client is available more than once in the file, 
				first entry of the client sequentially should be uploaded and remainder should be discarded */
		                
		select party_code, cnt = count(*) into #RemoveDuplicate               
		from B2B_Bulk_DealerMapping with(nolock) where ProcessId = @@ProcessId                 
		group by party_code                 
        HAVING count(*) > 1              
		
		if exists(select Party_Code from #RemoveDuplicate)          
		begin          
			--CURSOR TO UPDATE  			
			Declare @strPartyCode varchar(10)      
			Declare @totalcountForCursor int       
			Declare RemoveDuplicateCursor cursor for   
			--          
			select Party_Code, cnt from #RemoveDuplicate          
			--          
			Open RemoveDuplicateCursor           
			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          

			While @@FETCH_STATUS = 0                                                                                                                      
			Begin           
				set @totalcountForCursor=@totalcountForCursor-1          
				set rowcount @totalcountForCursor          
				--          
				Insert into @BulkErrorTable
				select distinct	C.ProcessId,
						isnull(C.Party_Code, ''),
						CurrencyDealer = isnull(Dealer1, ''),
						ErrorMessages = 'Duplicate entry.'
				from B2B_Bulk_DealerMapping C with (nolock)
				where C.ProcessId = @@ProcessId
				and isnull(C.Party_Code, '') = @strPartyCode
				and C.Segment_Type = @@Segment_Type  
				
				Delete from B2B_Bulk_DealerMapping  
				where ProcessId = @@ProcessId
				and isnull(Party_Code, '') = @strPartyCode
				and Segment_Type = @@Segment_Type 

				fetch next from RemoveDuplicateCursor                                                                   
				into @strPartyCode,@totalcountForCursor          
			END          
			close RemoveDuplicateCursor                                                                                                    
			deallocate RemoveDuplicateCursor          
			------------------------------------          
			drop table #RemoveDuplicate          
			set rowcount 0          
		end    
		
		
	
	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++
		/* 9. Validation -> If client code is invalid */
		
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID 
		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)
		and isnull(C.Party_Code, '') <> ''
		and C.Segment_Type = @@Segment_Type
		
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 not in (select Emp_No from B2B_AngelHarmony A with (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Dealer1 = A.Emp_No and ProcessId = @@ProcessID)
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Invalid row'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 is null
		and Party_Code is null
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++
		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Update contact details of New executive.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_Harmony E with (nolock)
		where E.EmpCode = isnull(C.Dealer1, '') and TerminationFrom > GETDATE() 
		and C.ProcessId = @@ProcessID
		and E.Mobile='' 
		
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		Delete B2B_Bulk_DealerMapping
		from @BulkErrorTable B
		where isnull(B2B_Bulk_DealerMapping.Party_Code, '') = isnull(B.Party_Code, '') 
		and B2B_Bulk_DealerMapping.Segment_Type = @@Segment_Type 
		and isnull(B2B_Bulk_DealerMapping.Dealer1, '') = isnull(B.CurrencyDealer, '') 
		and B2B_Bulk_DealerMapping.ProcessId = B.ProcessId
		and B2B_Bulk_DealerMapping.ProcessId = @@ProcessID
		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation
		/* ************* Selecting the records from error table *************** */
		
		select	Client_Code = ltrim(rtrim(Party_Code)), 
				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),
				ErrorMessages = ErrorMessages   
		from @BulkErrorTable
		where ProcessId = @@ProcessID
		
		select cnt = COUNT(*) from B2B_Bulk_DealerMapping with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type
		
		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID
		
	END
	ELSE if (@@ReportFlag='SAVE') 
	BEGIN
		print 'SAVE'

		If Exists(Select O.Party_code 
					from B2B_CommonPartyServices_Offline O with (nolock), B2B_Bulk_DealerMapping M with (nolock) 
					where O.Party_Code = M.Party_Code and
					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)
		Begin
			update B2B_CommonPartyServices_Offline
			set To_Be_Processed = 'N',
			process_time_stamp = getdate(),                                        
			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     
			from B2B_Bulk_DealerMapping M with (nolock), B2B_CommonPartyServices_Offline C with (nolock)                                  
			where C.Party_Code = M.Party_Code
			and To_Be_Processed = 'Y'
			and C.Segment_Type = M.Segment_Type
			and C.Segment_Type = @@Segment_Type
			and ProcessId = @@ProcessId
		End

		if(@@Branch_cd <> '')
		begin
			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			Party_code, @@Branch_cd, @@FromDealer, Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 'Y', 'Jan  1 1900 00:00:00', '', '',
			@@StatusId, @@StatusName, @@Emp_No, @@Segment_Type, 1
			from B2B_Bulk_DealerMapping with (nolock)
			where ProcessId = @@ProcessId
			and Segment_Type = @@Segment_Type
		end
		else
		begin
			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			B.Party_code,
			Branch_cd, 
			/*CurrencyDealer --- need to be added later*/EMP_No, 
			Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 
			'Y', 
			'Jan  1 1900 00:00:00', 
			'', 
			'',
			@@StatusId, 
			@@StatusName, 
			@@Emp_No, 
			@@Segment_Type,
			1
			from B2B_Bulk_DealerMapping B with (nolock), B2B_CommonPartyServices A with (nolock)
			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code
			and b.Segment_Type = @@Segment_Type
			and valid='Y'
		end
		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'
	end				           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_New31March12
-- --------------------------------------------------
Create proc [dbo].[B2B_CRMS_DealerMapping_New31March12]                                                                    
(                                                                    
	@Emp_No varchar(15), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(10),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(15),                                                                    
	@ToDealer varchar(15),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100),                                
	@smsFlag varchar(10),
	@Segment_Type Varchar(20),
	@ProcessId Varchar(50)                                                                     
)   
WITH RECOMPILE                                                                 
AS      
BEGIN    
/*
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='AIL',
	@FromDealer='UNDEFINED',@ToDealer='AILA001',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId=''
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 

*/
	SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
	@@StatusName varchar(10),                                                                                                                                                                                               
	@@Emp_No varchar(15),                                                                    
	@@PartyCode varchar(10),                                                                       
	@@Branch_cd varchar(10),                                                                   
	@@FromDealer varchar(15),                                                                    
	@@ToDealer varchar(15),                                                                 
	@@ReportFlag varchar(100),                                                           
	@@smsFlag varchar(10),
	@@FromParty varchar(10) ,
	@@ToParty   varchar(10),
	@@Segment_Type varchar(20),
	@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	SET @@smsFlag=@smsFlag
	SET @@Segment_Type = @Segment_Type
	SET @@ProcessId = @ProcessId 
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end
	
	if @@ReportFlag='LIST'
	BEGIN
		
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		--Checking if Dealer Data available in mini harmony.
		--print len(@@FromDealer)
		--print @@FromDealer
		--if((upper(@@FromDealer)<>'UNDEFINED') or (len(@@FromDealer)<>0))
		--begin
		--	if not exists
		--	(select empcode from B2B_Harmony with(nolock) where empcode=@@FromDealer)
 	--		Begin
 	--			Select  msg = 'Existing Dealer Not Available in harmony sdfsdfsdf.'                                                                    
		--		return  
		--	end
		--end	
		
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select empcode from B2B_Harmony with(nolock) where empcode=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select empcode from B2B_Harmony with(nolock) where empcode=@@ToDealer and mobile <> '' and email <>'')
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select empcode from B2B_Harmony with(nolock) where empcode=@@ToDealer and status='A' and
				TerminationFrom>GETDATE() and inActiveFrom >getdate())
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
		--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select empcode from B2B_Harmony with(nolock) where empcode=@@ToDealer and Category='DEALER')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') does not belong to required department.'                                                                    
			return  
		end
		
	--------
		--collecting parent and child delear list  	
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		select sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@Branch_cd
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@Branch_cd
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		)a	
		
		--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select empcode from B2B_Harmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sbtag=b2.sbtag where empcode=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the selected dealer.'                                                                    
			return  
		end 
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select empcode from B2B_Harmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sbtag=b2.sbtag where empcode=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the selected dealer.'                                                                    
			return  
		end 
		
	---------
		--Checking client sub broker relationship	
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) where sub_broker=@Branch_cd and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		
		
		Declare @mytable table                                    
		(          
			Client_code varchar(10) ,                                                                              
			Client_name varchar(100) ,                                                           
			Sub_Broker varchar(10) ,                               
			Trading_Mode varchar(20),
			Dealer_code_Existing varchar(20),
			Dealer_code_New  varchar(20),
			ColorCode varchar(50)                                                             
		) 
		----
		print @@FromDealer
		print @@ToDealer
		print @@FromParty
		print @@ToParty
		
		Insert into @mytable
		(
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode 
		)
		Select 
			Client_code=AC1.Party_code,
			Client_name = AC1.Long_Name,
			AC1.Sub_Broker, 
			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
			Dealer_code_Existing=CPS.Emp_No,
			Dealer_code_New=@@ToDealer,
			ColorCode = ''
		From 
			B2B_CommonPartyServices CPS with (noLock), AngelClient1 AC1 with (noLock)
		Where 
			CPS.Party_Code = AC1.Party_Code                                                                
			And CPS.Dealerbranch = @@Branch_cd                                                                    
			And B2C='N'                                                                   
			And Cl_type<>'SUB'                                                                    
			And AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59'                                                                    
			And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'                                    
			And CPS.Valid = 'Y'                                                                    
			And CPS.Emp_No like @@FromDealer + '%'                                                                 
			And CPS.Emp_No <> @@ToDealer                                                                  
			And CPS.Party_Code >= @@FromParty 
			And CPS.Party_Code <= @@ToParty                                                                                                                          

	---------------------------------------------------------------------                                    

		update 
			@mytable
		set 
			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)
		from
			B2B_CommonPartyServices_Offline P with (nolock), @mytable T
		where
			T.Client_code = P.party_code
			and to_be_processed = 'Y'
---------------------------------------------------------------
		select  
			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode
		from 
			@mytable order by Client_code
		end
		
		---------CHeck Contact Details of @@ToDealer ----------------------------------------------- 
		if exists (select top 1 Client_code from @mytable)
		begin                               
				if @@ToDealer='' or upper(@@ToDealer)='UNDEFINED'                                    
				begin                                    
				 select '' as dealer , '' as contact                                    
				end                                    
				else if exists(select top 1 emp_no from angelharmonyemployee e with(nolock)                                    
				 where emp_no=ltrim(rtrim(@@ToDealer))                                    
					                               
				) 
				begin                                    
				-----                        
				select 'DEALER' as dealer,                                    
				--isnull((select top 1 rtrim(ltrim(STDCode))+'-'+rtrim(ltrim(Phone1)) from crm..CRMBranchContactDetails where ContactPerson=e.emp_no),'') as contact                                    
				isnull(11111111,'') as contact                                    
				from angelharmonyemployee e with(nolock) 
				where emp_no=ltrim(rtrim(@@ToDealer))                                    
				
				
				---                                    
				end                                    
				else                                     
				begin                                     
				select '' as dealer , '' as contact                                    
				                                                                        
				end     
		end		 
		
----------******************88----------------****************------------------******************8	
	ELSE if (@@ReportFlag='BULK') 
	BEGIN
		/********* RAM Table to maintain the error messages to display in a grid on UI */
		Declare @BulkErrorTable Table
		(
			ProcessId varchar(50),
			Party_Code varchar(10),
			CurrencyDealer Varchar(10),
			ErrorMessages varchar(100)
		)
		
		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */
		Declare @BulkBranch Table
		(
			Party_Code varchar(10),
			Party_Region varchar(10),
			CurrencyDealer varchar(10),
			Dealer_Region varchar(10)
		)	
		
		/************************************************ Validations starts here ****************************************************/
		/* 1. Validation -> Client is a B2C client	*/
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is not a B2B client.'
		from B2B_Bulk_DealerMapping C with (nolock),
			angelclient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'Y'
		and Segment_Type = @@Segment_Type
		/* *****************************************************************/
		
		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is inactive.'
		from B2B_Bulk_DealerMapping C with (nolock),
			AngelClient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'N'
		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))
		and Segment_Type = @@Segment_Type
		
		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++
		
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee is terminated.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_Harmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.EmpCode = isnull(C.Dealer1, '')
		and A.status='N'
		and A.TerminationFrom <= GETDATE()
		and A.InactiveFrom <=getdate()
		
		--and Status <> 'A'
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee does not belong to required department.'
		from B2B_Bulk_DealerMapping C with (nolock),
			B2B_Harmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.EmpCode = isnull(C.Dealer1, '')
		and upper(category) not in ('DEALER')
		and C.Dealer1 <> 'UNDEFINED'
		and Segment_Type = @@Segment_Type
		/* **************************************************************** */
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++
		/* 5. Validation -> Client code and New dealer are from same Parent tag. */
		create table  #parent_info 
		(
			Party_Code varchar(10),
			Sub_Broker varchar(10),
			client_parent varchar(10), 
			Dealer1 varchar(10),
			SBTag varchar(10),
			sb_parent varchar(10)
		)

		insert into #parent_info
		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.SBTag,sb_parent=''   
		 from B2B_Bulk_DealerMapping a1 with(nolock),angelclient1 b1 with(nolock),B2B_Harmony c1  with(nolock)
		where ProcessId=@@ProcessID
		and a1.Party_Code=b1.Party_Code
		and c1.EmpCode =a1.Dealer1 
		and a1.Dealer1 <> 'UNDEFINED'
		and Segment_Type = @@Segment_Type


		update #parent_info

		set client_parent=isnull(b1.parenttag,b1.sbtag) from [196.1.115.239].Inhouse.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.Sub_Broker 

		update #parent_info

		set sb_parent=isnull(b1.parenttag,b1.sbtag) from [196.1.115.239].Inhouse.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.SBTag 
		
		Insert into @BulkErrorTable
		select	@@ProcessID,
				Party_Code,
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '
		from #parent_info where sb_parent<>client_parent
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++
		/* 6. Validation -> If client code or  dealer is blank */
		
		Insert into @BulkErrorTable
		select	ProcessId,
		isnull(C.Party_Code, ''),
		CurrencyDealer = isnull(Dealer1, ''),
		ErrorMessages = 'Incomplete data.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where ProcessId = @@ProcessID
		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++
		
		/* 7. Validation -> If Client is already mapped to the same  dealer */
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Dealer already mapped to the client.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_CommonPartyServices P with (nolock)
		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')
		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'
		and C.Segment_Type = P.Segment_Type
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++
		/* 8. Validation -> If client is available more than once in the file, 
				first entry of the client sequentially should be uploaded and remainder should be discarded */
		                
		select party_code, cnt = count(*) into #RemoveDuplicate               
		from B2B_Bulk_DealerMapping with(nolock) where ProcessId = @@ProcessId                 
		group by party_code                 
        HAVING count(*) > 1              
		
		if exists(select Party_Code from #RemoveDuplicate)          
		begin          
			--CURSOR TO UPDATE  			
			Declare @strPartyCode varchar(10)      
			Declare @totalcountForCursor int       
			Declare RemoveDuplicateCursor cursor for   
			--          
			select Party_Code, cnt from #RemoveDuplicate          
			--          
			Open RemoveDuplicateCursor           
			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          

			While @@FETCH_STATUS = 0                                                                                                                      
			Begin           
				set @totalcountForCursor=@totalcountForCursor-1          
				set rowcount @totalcountForCursor          
				--          
				Insert into @BulkErrorTable
				select distinct	C.ProcessId,
						isnull(C.Party_Code, ''),
						CurrencyDealer = isnull(Dealer1, ''),
						ErrorMessages = 'Duplicate entry.'
				from B2B_Bulk_DealerMapping C with (nolock)
				where C.ProcessId = @@ProcessId
				and isnull(C.Party_Code, '') = @strPartyCode
				and C.Segment_Type = @@Segment_Type  
				
				Delete from B2B_Bulk_DealerMapping  
				where ProcessId = @@ProcessId
				and isnull(Party_Code, '') = @strPartyCode
				and Segment_Type = @@Segment_Type 

				fetch next from RemoveDuplicateCursor                                                                   
				into @strPartyCode,@totalcountForCursor          
			END          
			close RemoveDuplicateCursor                                                                                                    
			deallocate RemoveDuplicateCursor          
			------------------------------------          
			drop table #RemoveDuplicate          
			set rowcount 0          
		end    
		
		
	
	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++
		/* 9. Validation -> If client code is invalid */
		
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID 
		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)
		and isnull(C.Party_Code, '') <> ''
		and C.Segment_Type = @@Segment_Type
		
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee code is invalid.'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 not in (select EmpCode from B2B_Harmony A with (nolock), B2B_Bulk_DealerMapping D with (nolock)
									where D.Dealer1 = A.EmpCode and ProcessId = @@ProcessID)
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Invalid row'
		from B2B_Bulk_DealerMapping C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 is null
		and Party_Code is null
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++
		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Update contact details of New executive.'
		from B2B_Bulk_DealerMapping C with (nolock), B2B_Harmony E with (nolock)
		where E.EmpCode = isnull(C.Dealer1, '') and 
		TerminationFrom > GETDATE() 
		and C.ProcessId = @@ProcessID
		and E.Mobile='' 
		and E.email <>''
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		Delete B2B_Bulk_DealerMapping
		from @BulkErrorTable B
		where isnull(B2B_Bulk_DealerMapping.Party_Code, '') = isnull(B.Party_Code, '') 
		and B2B_Bulk_DealerMapping.Segment_Type = @@Segment_Type 
		and isnull(B2B_Bulk_DealerMapping.Dealer1, '') = isnull(B.CurrencyDealer, '') 
		and B2B_Bulk_DealerMapping.ProcessId = B.ProcessId
		and B2B_Bulk_DealerMapping.ProcessId = @@ProcessID
		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation
		/* ************* Selecting the records from error table *************** */
		
		select	Client_Code = ltrim(rtrim(Party_Code)), 
				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),
				ErrorMessages = ErrorMessages   
		from @BulkErrorTable
		where ProcessId = @@ProcessID
		
		select cnt = COUNT(*) from B2B_Bulk_DealerMapping with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type
		
		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID
		
	END
	ELSE if (@@ReportFlag='SAVE') 
	BEGIN
		print 'SAVE'

		If Exists(Select O.Party_code 
					from B2B_CommonPartyServices_Offline O with (nolock), B2B_Bulk_DealerMapping M with (nolock) 
					where O.Party_Code = M.Party_Code and
					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)
		Begin
			update B2B_CommonPartyServices_Offline
			set To_Be_Processed = 'N',
			process_time_stamp = getdate(),                                        
			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     
			from B2B_Bulk_DealerMapping M with (nolock), B2B_CommonPartyServices_Offline C with (nolock)                                  
			where C.Party_Code = M.Party_Code
			and To_Be_Processed = 'Y'
			and C.Segment_Type = M.Segment_Type
			and C.Segment_Type = @@Segment_Type
			and ProcessId = @@ProcessId
		End

		if(@@Branch_cd <> '')
		begin
			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			Party_code, @@Branch_cd, @@FromDealer, Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 'Y', 'Jan  1 1900 00:00:00', '', '',
			@@StatusId, @@StatusName, @@Emp_No, @@Segment_Type, 1
			from B2B_Bulk_DealerMapping with (nolock)
			where ProcessId = @@ProcessId
			and Segment_Type = @@Segment_Type
		end
		else
		begin
			insert into B2B_CommonPartyServices_Offline 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			B.Party_code,
			Branch_cd, 
			/*CurrencyDealer --- need to be added later*/EMP_No, 
			Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 
			'Y', 
			'Jan  1 1900 00:00:00', 
			'', 
			'',
			@@StatusId, 
			@@StatusName, 
			@@Emp_No, 
			@@Segment_Type,
			1
			from B2B_Bulk_DealerMapping B with (nolock), B2B_CommonPartyServices A with (nolock)
			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code
			and b.Segment_Type = @@Segment_Type
			and valid='Y'
		end
		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'
		
		-- Set the Flag true for the valid entry of Client mapping	 
              
				-- Code to send the SMS for valid client mapping                                                             
				If (@@smsFlag = 'YES') 
				begin
					insert into TBL_B2B_CRMS_SMS_DEALER_MAPPING
					(
						party_code,
						party_mobile,
						sub_broker,
						sub_broker_name,
						DealerCode,
						DealerName,
						DealerContact
					) 
					Select 
						B.Party_code,
						mobileNo=(case when len(rtrim(ltrim(mobile_pager)))=10 then rtrim(ltrim(mobile_pager)) else 'NA' end) ,
						A.Sub_broker,
						Sub_Broker_Name=(select tradename from MIS.sb_comp.dbo.sb_broker with(nolock) where sbtag=a.sub_broker),
						B.Dealer1,
						dealerName=(select emp_name from angelharmonyemployee e with(nolock) where e.emp_no=B.Dealer1),
						contactNo='111111111' 
					 from 
						B2B_Bulk_DealerMapping B with (nolock), angelclient1 A with (nolock)
					 where 
						ProcessId = @@ProcessId and 
						A.Party_Code = B.Party_Code
						and Segment_Type = @@Segment_Type
						and rtrim(ltrim(AngelClRating))<>'NEW'
						and Dealer1<>'UNDEFINED'
    			end
	end				           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_Validations
-- --------------------------------------------------
CREATE proc [dbo].[B2B_CRMS_DealerMapping_Validations]                                                                    
(                                                                    
	@Emp_No varchar(20), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(20),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(20),                                                                    
	@ToDealer varchar(20),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100)
	                              
)   
WITH RECOMPILE                                                                 
AS      
BEGIN 

/*
	Exec B2B_CRMS_DealerMapping_Validations 
	@Emp_No='Et001',@StatusId='SUBBROKER',@StatusName='ET',@Branch_cd='ET',
	@FromDealer='Et001',@ToDealer='ET002',@PartyCode='',@ReportFlag='EXISTING'
	
	Exec B2B_CRMS_DealerMapping_Validations 
	@Emp_No='Et001',@StatusId='SUBBROKER',@StatusName='ET',@Branch_cd='ET',
	@FromDealer='Et001',@ToDealer='ET002',@PartyCode='',@ReportFlag='NEW'
	
	Exec B2B_CRMS_DealerMapping_Validations 
	@Emp_No='Et001',@StatusId='SUBBROKER',@StatusName='ET',@Branch_cd='ET',
	@FromDealer='Et001',@ToDealer='ETA002',@PartyCode='',@ReportFlag='NEW'
	
	Exec B2B_CRMS_DealerMapping_Validations 
	@Emp_No='Et001',@StatusId='SUBBROKER',@StatusName='ET',@Branch_cd='ET',
	@FromDealer='Et001',@ToDealer='ETA002',@PartyCode='a10026',@ReportFlag='CLIENT'

*/

SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
			@@StatusName varchar(20),                                                                                                                                                                                               
			@@Emp_No varchar(20),                                                                    
			@@PartyCode varchar(10),                                                                       
			@@Branch_cd varchar(10),                                                                   
			@@FromDealer varchar(20),                                                                    
			@@ToDealer varchar(20),                                                                 
			@@ReportFlag varchar(100),                                                           
			@@smsFlag varchar(10),
			@@FromParty varchar(10) ,
			@@ToParty   varchar(10),
			@@Segment_Type varchar(20),
			@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	--SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	--SET @@smsFlag=@smsFlag
	--SET @@Segment_Type = @Segment_Type
	--SET @@ProcessId = @ProcessId 
	
	if(len(@@FromDealer)=0 and len(@@ToDealer)=0)
	begin
		return 0
	end	
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end 
	
	if @@ReportFlag='EXISTING'
	begin
		if(len(@@FromDealer)<>0)
			begin
				if not exists
				(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@FromDealer)
 				Begin
 					Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    
					return  
				end
			end
			
			select output='CORRECT'
	end
	
	else if @@ReportFlag='NEW'
	begin	
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
	--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
		
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 
		
		--select * from @temp_sbtag	
		--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the existing dealer.'                                                                    
			return  
		end
		
		select output='CORRECT'	 
		end		
	---------
		else if(@@ReportFlag='CLIENT')
		begin
		--Checking client sub broker relationship	
		declare  @temp_sbtag1 table
		(sbtag varchar(10))
		
		insert into @temp_sbtag1
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) ,@temp_sbtag1
			where sub_broker=sbtag and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		select output='CORRECT'
		end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2B_CRMS_DealerMapping_YPTest
-- --------------------------------------------------

CREATE proc [dbo].[B2B_CRMS_DealerMapping_YPTest]                                                                    
(                                                                    
	@Emp_No varchar(20), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(20),                                                                                                                                                                                                  
	@Branch_cd varchar(10),                                                                   
	@FromDealer varchar(20),                                                                    
	@ToDealer varchar(20),                                                                 
	@PartyCode varchar(10),
	@ReportFlag varchar(100),                                
	@smsFlag varchar(10),
	@Segment_Type Varchar(20),
	@ProcessId Varchar(50)                                                                     
)   
WITH RECOMPILE                                                                 
AS      
BEGIN    
/*
	Exec B2B_CRMS_DealerMapping_ADTest 
	@Emp_No='CBHO001',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='AIL',
	@FromDealer='',@ToDealer='CBHO001',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId=''
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='UNDEFINED',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 
	
	Exec B2B_CRMS_DealerMapping 
	@Emp_No='P00045',@StatusId='BROKER',@StatusName='BROKER',@Branch_cd='CA',
	@FromDealer='caa001',@ToDealer='CAA002',@PartyCode='',@ReportFlag='LIST',@smsFlag='',
	@Segment_Type='Currency',@ProcessId='' 

*/
SET NOCOUNT ON
	Declare @@StatusId varchar(10),                                                                                                                              
			@@StatusName varchar(20),                                                                                                                                                                                               
			@@Emp_No varchar(20),                                                                    
			@@PartyCode varchar(10),                                                                       
			@@Branch_cd varchar(10),                                                                   
			@@FromDealer varchar(20),                                                                    
			@@ToDealer varchar(20),                                                                 
			@@ReportFlag varchar(100),                                                           
			@@smsFlag varchar(10),
			@@FromParty varchar(10) ,
			@@ToParty   varchar(10),
			@@Segment_Type varchar(20),
			@@ProcessId Varchar(50)       
			                                                    
	/* Initialized local parameters  */
	SET @@StatusId = @StatusId                  
	SET @@StatusName = @StatusName                                  
	SET @@Emp_No = @Emp_No                                  
	SET @@PartyCode = ltrim(rtrim(@PartyCode))                                  
	SET @@Branch_cd = ltrim(rtrim(@Branch_cd))                    
	SET @@FromDealer = ltrim(rtrim(@FromDealer))
	SET @@ToDealer = ltrim(rtrim(@ToDealer))
	SET @@ReportFlag = @ReportFlag                                                           
	SET @@smsFlag=@smsFlag
	SET @@Segment_Type = @Segment_Type
	SET @@ProcessId = @ProcessId 
	
	if @@PartyCode=''
	begin
		set @@FromParty='A'
		set @@ToParty='ZZZZZZZZZZZZ'
	end
	else
	begin
		set @@FromParty=@@PartyCode
		set @@ToParty=@@PartyCode
	end
	
	if @@ReportFlag='LIST'
	BEGIN
		
		Print 'List:--> Start:-->'+ convert(varchar,getdate(),109)
		if  (@@FromDealer=@@ToDealer) 
		begin
			Select  msg = 'Existing executive and new executive cannot be same.'                                                                    
			return  
		end	
	--------
		--Checking if Dealer Data available in mini harmony.
		--print len(@@FromDealer)
		--print @@FromDealer
		--if((upper(@@FromDealer)<>'UNDEFINED') or (len(@@FromDealer)<>0))
		--begin
		--	if not exists
		--	(select empcode from B2B_Harmony with(nolock) where empcode=@@FromDealer)
 	--		Begin
 	--			Select  msg = 'Existing Dealer Not Available in harmony sdfsdfsdf.'                                                                    
		--		return  
		--	end
		--end	
		
		--Commented by prasanna after change in BRS on Jun 23 2012
		
		if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		if(len(@@FromDealer)<>0)
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@FromDealer)
 			Begin
 				Select  msg = 'Existing Dealer Not Available in harmony.'                                                                    
				return  
			end
		end
		Print 'List:--> Step 1:-->'+ convert(varchar,getdate(),109)
	--	--Mappging to employee other than dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	----------
	--	--Checking if Dealer Data available in mini harmony.
		--if(len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED')
		--begin
		--	if not exists
		--	(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 	--		Begin
 	--			Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
		--		return  
		--	end
		--end
	----------
	--    --Resigned Dealer	
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	----------
		
		
	--------
		--collecting parent and child delear list  	
		--declare  @temp_sbtag table
		--(sbtag varchar(10))
		
		--insert into @temp_sbtag
		--select sbtag from
		--(
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--	Union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=@Branch_cd
		--	union 
		--	select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where sbtag=@Branch_cd
		--	union
		--	select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
		--	where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@Branch_cd)
		--)a	
		
		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 
		
		--select * from @temp_sbtag	
		--Checking the to dealer belongs to sub broker family
		if len(@@ToDealer)>0 and upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		Print 'List:--> Step 2:-->'+ convert(varchar,getdate(),109)
		
		if (upper(@@FromDealer)<>'UNDEFINED' and  @@FromDealer <> '') and not exists 
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag b2 on b1.sb_tag=b2.sbtag where emp_no=@@FromDealer)
		Begin
 			Select  msg = 'You do not have access to map the existing dealer.'                                                                    
			return  
		end 
		
		Print 'List:--> Step 3:-->'+ convert(varchar,getdate(),109)
	---------
		--Checking client sub broker relationship	
		if @PartyCode <>'' and  not exists
		(select party_code from angelclient1 b1 with(nolock) ,@temp_sbtag
			where sub_broker=sbtag and party_code = @PartyCode)
		Begin
 			Select  msg = 'Entered Client Is From Differant Sub Broker.'                                                                    
			return  
		end 
		
		
		Declare @mytable table                                    
		(          
			Client_code varchar(10) ,                                                                              
			Client_name varchar(100) ,                                                           
			Sub_Broker varchar(10) ,                               
			Trading_Mode varchar(20),
			Dealer_code_Existing varchar(20),
			Dealer_code_New  varchar(20),
			ColorCode varchar(50)                                                             
		) 
		----
		--print @@FromDealer
		--print @@ToDealer
		--print @@FromParty
		--print @@ToParty
		
		--select * from @temp_sbtag
		
		Insert into @mytable
		(
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode 
		)
		Select 
			Client_code=AC1.Party_code,
			Client_name = AC1.Long_Name,
			AC1.Sub_Broker, 
			Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
			Dealer_code_Existing=CPS.Emp_No,
			Dealer_code_New=@@ToDealer,
			ColorCode = ''
		From 
			B2B_CommonPartyServices CPS with (noLock), MIMANSA.angelcs.dbo.angelClient1 AC1 with (noLock),@temp_sbtag
		Where 
			CPS.Party_Code = AC1.Party_Code                                                                
			And AC1.Sub_Broker = sbtag                                                                    
			And B2C='N'                                                                   
			And Cl_type<>'SUB'                                                                    
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                 
			And CPS.Valid = 'Y'                                                                    
			And CPS.Emp_No like @@FromDealer + '%'                                                                 
			And CPS.Emp_No <> @@ToDealer                                                                  
			And CPS.Party_Code >= @@FromParty 
			And CPS.Party_Code <= @@ToParty                                                                                                                          
			

		IF(@@FromDealer = '' OR @@FromDealer like '%001')
		Begin

			Insert into @mytable
			(
				Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
				ColorCode 
			)
			Select 
				Client_code=AC1.Party_code,
				Client_name = AC1.Long_Name,
				AC1.Sub_Broker, 
				Trading_Mode=(case when AC1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),
				Dealer_code_Existing=AC1.Sub_Broker + '001',
				Dealer_code_New=@@ToDealer,
				ColorCode = ''
			From @temp_sbtag T,
			MIMANSA.angelcs.dbo.angelClient1 AC1 with (noLock) LEFT OUTER JOIN B2B_CommonPartyServices CPS with (noLock)
			ON (AC1.party_code = CPS.Party_Code and CPS.valid = 'Y')			
			Where AC1.Sub_Broker = T.sbtag                                                                                                                                       
			And ((AC1.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')
				OR (AC1.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 
						And AC1.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))                                                                                                                                                             
			And AC1.Party_Code >= @@FromParty 
			And AC1.Party_Code <= @@ToParty   
			and AC1.B2C = 'N' And AC1.Cl_type<>'SUB'
			and CPS.party_code is null  
			and AC1.party_code not in (Select Client_code from @mytable)

		End
	---------------------------------------------------------------------                                    

	--Select * from @temp_sbtag

		update 
			@mytable
		set 
			ColorCode = (case when to_be_processed = 'Y' then '#FF0000;' else '' end)
		from
			B2B_CommonPartyServices_Offline_YPTest P with (nolock), @mytable T
		where
			T.Client_code = P.party_code
			and to_be_processed = 'Y'
			
		
---------------------------------------------------------------
		select  
			ROW_NUMBER() OVER(ORDER BY Client_code) AS 'SrNo',
			Client_code,Client_name,Sub_Broker,Trading_Mode,Dealer_code_Existing,Dealer_code_New,
			ColorCode
		from 
			@mytable order by Client_code
		end
		
		---------CHeck Contact Details of @@ToDealer ----------------------------------------------- 
		--if exists (select top 1 Client_code from @mytable)
		--begin                               
		--		if @@ToDealer='' or upper(@@ToDealer)='UNDEFINED'                                    
		--		begin                                    
		--		 select '' as dealer , '' as contact                                    
		--		end                                    
		--		else if exists(select top 1 emp_no from B2B_AngelHarmony e with(nolock)                                    
		--		 where emp_no=ltrim(rtrim(@@ToDealer))                                    
					                               
		--		) 
		--		begin                                    
		--		-----                        
		--		select 'DEALER' as dealer,                                    
		--		--isnull((select top 1 rtrim(ltrim(STDCode))+'-'+rtrim(ltrim(Phone1)) from crm..CRMBranchContactDetails where ContactPerson=e.emp_no),'') as contact                                    
		--		isnull(landline_no,'') as contact                                    
		--		from B2B_AngelHarmony e with(nolock) 
		--		where emp_no=ltrim(rtrim(@@ToDealer))  
		--		and isDealer='1'                                  
				
				
		--		---                                    
		--		end                                    
		--		else                                     
		--		begin                                     
		--		select '' as dealer , '' as contact                                    
				                                                                        
		--		end  
		--		Print 'List:--> End :-->'+ convert(varchar,getdate(),109)	   
		--end		 
		
----------******************88----------------****************------------------******************8	
	ELSE if (@@ReportFlag='BULK') 
	BEGIN
		/********* RAM Table to maintain the error messages to display in a grid on UI */
		Declare @BulkErrorTable Table
		(
			ProcessId varchar(50),
			Party_Code varchar(10),
			CurrencyDealer Varchar(20),
			ErrorMessages varchar(100)
		)
		
		/********* RAM Table to maintain the Regional mapping and MUMBAI zone validation */
		Declare @BulkBranch Table
		(
			Party_Code varchar(10),
			Party_Region varchar(10),
			CurrencyDealer varchar(10),
			Dealer_Region varchar(10)
		)	
		
		/************************************************ Validations starts here ****************************************************/
		/* 1. Validation -> Client is a B2C client	*/
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is not a B2B client.'
		from B2B_Bulk_DealerMapping_YPTest C with (nolock),
			angelclient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'Y'
		and Segment_Type = @@Segment_Type
		/* *****************************************************************/
		
		/* 2. Validation -> Client is inactive */--+++++++++++++++++++++++++++++++++++++++validation 2+++++++++++++++++++++++++++++++
		/*******Commendted by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients*******/
		/*
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client is inactive.'
		from B2B_Bulk_DealerMapping_YPTest C with (nolock),
			AngelClient1 A with (nolock)
		where ProcessId = @@ProcessID
		and A.Party_Code = isnull(C.Party_Code, '')
		and B2C = 'N'
		and ((ActiveFrom > GETDATE()) or (ActiveFrom <= GETDATE() and InActiveFrom <= GETDATE()))
		and Segment_Type = @@Segment_Type
		*/
		/*******End Commendted by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients*******/
		/* 3. Validation -> Currency dealer has resigned from the system */--++++++++++++++++++++++++++validation 3++++++++++++++++++++++++++++++++++++++++++++
		
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee is terminated.'
		from B2B_Bulk_DealerMapping_YPTest C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		and A.status='T'
		--and A.TerminationFrom <= GETDATE()
		--and A.InactiveFrom <=getdate()
		
		--and Status <> 'A'
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		/* 4. Validation ->  dealer is not in 'Manager', 'KYC', 'Sales', 'Support'department */--++++++++++++++++++++++++validation 4++++++++++++++++++++++++++++++++++++++++++++++
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee does not Dealer.'
		from B2B_Bulk_DealerMapping_YPTest C with (nolock),
			B2B_AngelHarmony A with (nolock)
		where ProcessId = @@ProcessID
		and A.Emp_no = isnull(C.Dealer1, '')
		--and upper(category) not in ('DEALER')
		--and C.Dealer1 <> 'UNDEFINED'
		and isDealer<>1
		and Segment_Type = @@Segment_Type
		/* **************************************************************** */
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 5++++++++++++++++++++++++++++++++++++
		/* 5. Validation -> Client code and New dealer are from same Parent tag. */
		create table  #parent_info 
		(
			Party_Code varchar(10),
			Sub_Broker varchar(10),
			client_parent varchar(10), 
			Dealer1 varchar(20),
			SBTag varchar(10),
			sb_parent varchar(10)
		)

		insert into #parent_info
		select a1.Party_Code,Sub_Broker=b1.Sub_Broker,client_parent='',a1.Dealer1,c1.SB_Tag,sb_parent=''   
		from 
			B2B_Bulk_DealerMapping_YPTest a1 with(nolock),angelclient1 b1 with(nolock),B2B_AngelHarmony c1  with(nolock)
		where ProcessId=@@ProcessID
		and a1.Party_Code=b1.Party_Code
		and c1.Emp_no =a1.Dealer1 
		and c1.isDealer=1
		and Segment_Type = @@Segment_Type


		update #parent_info

		set client_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.Sub_Broker 

		update #parent_info

		set sb_parent=isnull(b1.parenttag,b1.sbtag) from MIS.sb_comp.dbo.sb_broker b1 with(nolock) ,#parent_info a

		where b1.sbtag=a.SBTag 
		
		----Select * from #parent_info  -----------------

		Insert into @BulkErrorTable
		select	@@ProcessID,
				Party_Code,
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client and Dealer do not belong to same Parent SB '
		from #parent_info where sb_parent<>client_parent
		/* **************************************************************** */--++++++++++++++++++++++++++++++++++validation 6++++++++++++++++++++++++++++++++++++
		/* 6. Validation -> If client code or  dealer is blank */
		
		Insert into @BulkErrorTable
		select	ProcessId,
		isnull(C.Party_Code, ''),
		CurrencyDealer = isnull(Dealer1, ''),
		ErrorMessages = 'Incomplete data.'
		from B2B_Bulk_DealerMapping_YPTest C with (nolock)
		where ProcessId = @@ProcessID
		and ((Dealer1 = '') or (Party_Code = '') or (Dealer1 is null) or (Party_Code is null))
		and Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 7++++++++++++++++++++++++++++++++++
		
		/* 7. Validation -> If Client is already mapped to the same  dealer */
		Insert into @BulkErrorTable
		select	ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Dealer already mapped to the client.'
		from B2B_Bulk_DealerMapping_YPTest C with (nolock), B2B_CommonPartyServices P with (nolock)
		where ProcessId = @@ProcessID and P.Party_Code = isnull(C.Party_Code, '')
		and P.Emp_No = isnull(C.Dealer1 , '') and Valid = 'Y'
		and C.Segment_Type = P.Segment_Type
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/ --++++++++++++++++++++++++++++++++++++validation 8++++++++++++++++++++++++++++++++++
		/* 8. Validation -> If client is available more than once in the file, 
				first entry of the client sequentially should be uploaded and remainder should be discarded */
		                
		select party_code, cnt = count(*) into #RemoveDuplicate               
		from B2B_Bulk_DealerMapping_YPTest with(nolock) where ProcessId = @@ProcessId                 
		group by party_code                 
        HAVING count(*) > 1              
		
		if exists(select Party_Code from #RemoveDuplicate)          
		begin          
			--CURSOR TO UPDATE  			
			Declare @strPartyCode varchar(10)      
			Declare @totalcountForCursor int       
			Declare RemoveDuplicateCursor cursor for   
			--          
			select Party_Code, cnt from #RemoveDuplicate          
			--          
			Open RemoveDuplicateCursor           
			fetch next from RemoveDuplicateCursor into @strPartyCode,@totalcountForCursor          

			While @@FETCH_STATUS = 0                                                                                                                      
			Begin           
				set @totalcountForCursor=@totalcountForCursor-1          
				set rowcount @totalcountForCursor          
				--          
				Insert into @BulkErrorTable
				select distinct	C.ProcessId,
						isnull(C.Party_Code, ''),
						CurrencyDealer = isnull(Dealer1, ''),
						ErrorMessages = 'Duplicate entry.'
				from B2B_Bulk_DealerMapping_YPTest C with (nolock)
				where C.ProcessId = @@ProcessId
				and isnull(C.Party_Code, '') = @strPartyCode
				and C.Segment_Type = @@Segment_Type  
				
				Delete from B2B_Bulk_DealerMapping_YPTest  
				where ProcessId = @@ProcessId
				and isnull(Party_Code, '') = @strPartyCode
				and Segment_Type = @@Segment_Type 

				fetch next from RemoveDuplicateCursor                                                                   
				into @strPartyCode,@totalcountForCursor          
			END          
			close RemoveDuplicateCursor                                                                                                    
			deallocate RemoveDuplicateCursor          
			------------------------------------          
			drop table #RemoveDuplicate          
			set rowcount 0          
		end    
		
		
	
	/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 9++++++++++++++++++++++++++++++++++
		/* 9. Validation -> If client code is invalid */
		
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Client code is invalid.'
		from B2B_Bulk_DealerMapping_YPTest C with (nolock)
		where C.ProcessId = @@ProcessID 
		and isnull(C.Party_Code, '') not in (select A.Party_Code from angelclient1 A With (nolock), B2B_Bulk_DealerMapping_YPTest D with (nolock)
									where D.Party_Code = A.Party_Code and ProcessId = @@ProcessID)
		and isnull(C.Party_Code, '') <> ''
		and C.Segment_Type = @@Segment_Type
		
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Employee code is invalid.'
		from B2B_Bulk_DealerMapping_YPTest C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 not in (select Emp_No from B2B_AngelHarmony A with (nolock), B2B_Bulk_DealerMapping_YPTest D with (nolock)
									where D.Dealer1 = A.Emp_No and ProcessId = @@ProcessID)
		and C.Dealer1 <> 'UNDEFINED'
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 10++++++++++++++++++++++++++++++++++
		/* 10. Validation -> If  dealer code is invalid */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Invalid row'
		from B2B_Bulk_DealerMapping_YPTest C with (nolock)
		where C.ProcessId = @@ProcessID
		and C.Dealer1 is null
		and Party_Code is null
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/--++++++++++++++++++++++++++++++++++++validation 14++++++++++++++++++++++++++++++++++
		/* 14. Validation -> If the Contact details of the New executive other than UNDEFINED is not available in the Branch Contact details */
		Insert into @BulkErrorTable
		select	C.ProcessId,
				isnull(C.Party_Code, ''),
				CurrencyDealer = isnull(Dealer1, ''),
				ErrorMessages = 'Update contact details of Dealer.'
		from B2B_Bulk_DealerMapping_YPTest C with (nolock), B2B_AngelHarmony E with (nolock)
		where E.Emp_no = isnull(C.Dealer1, '') 		
		and C.ProcessId = @@ProcessID
		and len(isnull(E.Landline_no,''))=0
		and e.isDealer=1
		and C.Segment_Type = @@Segment_Type
		
		/* *****************************************************************/
		Delete B2B_Bulk_DealerMapping_YPTest
		from @BulkErrorTable B
		where isnull(B2B_Bulk_DealerMapping_YPTest.Party_Code, '') = isnull(B.Party_Code, '') 
		and B2B_Bulk_DealerMapping_YPTest.Segment_Type = @@Segment_Type 
		and isnull(B2B_Bulk_DealerMapping_YPTest.Dealer1, '') = isnull(B.CurrencyDealer, '') 
		and B2B_Bulk_DealerMapping_YPTest.ProcessId = B.ProcessId
		and B2B_Bulk_DealerMapping_YPTest.ProcessId = @@ProcessID
		and ErrorMessages <> 'Duplicate entry.' -- Duplicate entry already removed in 8. Validation
		/* ************* Selecting the records from error table *************** */
		
		select	Client_Code = ltrim(rtrim(Party_Code)), 
				CurrencyDealer = ltrim(rtrim(CurrencyDealer)),
				ErrorMessages = ErrorMessages   
		from @BulkErrorTable
		where ProcessId = @@ProcessID
		
		select cnt = COUNT(*) from B2B_Bulk_DealerMapping_YPTest with (nolock) where ProcessId = @@ProcessID and Segment_Type = @@Segment_Type
		
		select c1 = COUNT(*) from @BulkErrorTable where ProcessId = @@ProcessID
		
	END
	ELSE if (@@ReportFlag='SAVE') 
	BEGIN
		print 'SAVE'
		

		Select M.party_code 
		into #InvalidClientCodes
		from B2B_Bulk_DealerMapping_YPTest M with (nolock) LEFT OUTER JOIN angelclient1 a1 with(nolock)
		ON (M.party_code = a1.party_code)
		where M.ProcessId = @@ProcessId
		and M.Segment_Type = @@Segment_Type
		and a1.party_code is null

		Declare @Invalid_Party_code varchar(max)

		SELECT @Invalid_Party_code = STUFF
		(
			(
				SELECT ',' + s.party_code 
				FROM #InvalidClientCodes s
				ORDER BY s.party_code FOR XML PATH('')
			),
			 1, 1, ''
		)

		IF EXISTS (Select top 1 party_code from #InvalidClientCodes)
		BEGIN
			select msg = 'Error: Unable to upload file. Uploaded file contains invalid client codes (Invalid List: ' + @Invalid_Party_code + ')'
			RETURN;
		END

		declare  @temp_sbtag1 table
		(sbtag varchar(10))
		
		insert into @temp_sbtag1
		SELECT sb_tag  FROM dbo.b2b_crms_mimansa_status(@Emp_No); 

		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer)
 			Begin
 				Select  msg = 'New Dealer Not Available in harmony.'                                                                    
				return  
			end
		end	
		
		--Mappging to employee other than dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
	    (select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and isDealer='1')
 		Begin
 			Select  msg = 'Selected employee ('+@@ToDealer+') is not dealer'--does not belong to required department.                                                                    
			return  
		end
		
	--------
		--Checking if Dealer Data available in mini harmony.
		if(upper(@@ToDealer)<>'UNDEFINED')
		begin
			if not exists
			(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and len(isnull(landline_no,'')) <> 0 and isdealer=1)
 			Begin
 				Select  msg = 'Update the contact details of the New executive in Dealer Master'                                                                    
				return  
			end
		end
	--------
	    --Resigned Dealer	
		if upper(@@ToDealer)<>'UNDEFINED' and exists
		(select emp_no from B2B_AngelHarmony with(nolock) where emp_no=@@ToDealer and status='T')
		begin
			Select  msg = 'Selected dealer ('+@@ToDealer+') is terminated.'                                                                    
			return  
		end
	--------
	--Checking the to dealer belongs to sub broker family
		if upper(@@ToDealer)<>'UNDEFINED' and not exists
		(select emp_no from B2B_AngelHarmony b1 with(nolock) inner join @temp_sbtag1 b2 on b1.sb_tag=b2.sbtag where emp_no=@@ToDealer)
		Begin
 			Select  msg = 'You do not have access to map the new dealer.'                                                                    
			return  
		end 
		
		if Len(@@FromDealer)=0 
		Begin
 			Select  msg = 'Please Enter From Dealer'                                                                    
			return  
		end 
			
		If Exists(Select O.Party_code 
					from B2B_CommonPartyServices_Offline_YPTest O with (nolock), B2B_Bulk_DealerMapping_YPTest M with (nolock) 
					where O.Party_Code = M.Party_Code and
					To_Be_Processed = 'Y' and O.Segment_Type = M.Segment_Type and ProcessId = @@ProcessId)
		Begin
			update B2B_CommonPartyServices_Offline_YPTest
			set To_Be_Processed = 'N',
			process_time_stamp = getdate(),                                        
			reason_for_non_process = 'RECORD SUPERSEDED DUE TO MAPPING IS FOR THE SAME PARTY ON THE SAME DAY.'     
			from B2B_Bulk_DealerMapping_YPTest M with (nolock), B2B_CommonPartyServices_Offline_YPTest C with (nolock)                                  
			where C.Party_Code = M.Party_Code
			and To_Be_Processed = 'Y'
			and C.Segment_Type = M.Segment_Type
			and C.Segment_Type = @@Segment_Type
			and ProcessId = @@ProcessId
		End

		if(@@Branch_cd <> '')
		begin
			insert into B2B_CommonPartyServices_Offline_YPTest 
			(
				Party_Code,
				Branch_Cd,
				Source_Dealer_Code,
				Target_Dealer_Code,
				From_Date,
				To_Date,
				Entry_Time_Stamp,
				To_Be_Processed,
				Process_Time_Stamp,
				Reason_For_Non_Process,
				Other_Remarks,
				Status_Id,
				Status_Name,
				Emp_No,
				Segment_Type,
				CommRank
			)
			Select 
				Party_code, 
				--@@Branch_cd=select , 
				--Branch_cd=(select sb_tag from B2B_AngelHarmony with(nolock) where emp_no=dealer1) , 
				Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B2B_Bulk_DealerMapping_YPTest.Party_Code) , 
				@@FromDealer, 
				--Dealer1,
				@ToDealer,
				left(getdate(), 11) + ' 00:00:00',
				'Dec 31 2049 23:59:00',
				getdate(), 
				'Y', 
				'Jan  1 1900 00:00:00', 
				'', 
				'',
				@@StatusId, 
				@@StatusName, 
				@@Emp_No, 
				@@Segment_Type, 
				1
			from B2B_Bulk_DealerMapping_YPTest with (nolock)
			where ProcessId = @@ProcessId
			and Segment_Type = @@Segment_Type
		end
		else
		begin
			insert into B2B_CommonPartyServices_Offline_YPTest 
			(Party_Code,
			Branch_Cd,
			Source_Dealer_Code,
			Target_Dealer_Code,
			From_Date,
			To_Date,
			Entry_Time_Stamp,
			To_Be_Processed,
			Process_Time_Stamp,
			Reason_For_Non_Process,
			Other_Remarks,
			Status_Id,
			Status_Name,
			Emp_No,
			Segment_Type,
			CommRank)
			Select 
			B.Party_code,
			--Branch_cd, 
			Branch_cd=(select sub_broker from angelclient1 a1 with(nolock) where a1.party_code=B.Party_Code) , 
			/*CurrencyDealer --- need to be added later*/EMP_No, 
			Dealer1,
			left(getdate(), 11) + ' 00:00:00',
			'Dec 31 2049 23:59:00',
			getdate(), 
			'Y', 
			'Jan  1 1900 00:00:00', 
			'', 
			'',
			@@StatusId, 
			@@StatusName, 
			@@Emp_No, 
			@@Segment_Type,
			1
			from B2B_Bulk_DealerMapping_YPTest B with (nolock), B2B_CommonPartyServices A with (nolock)
			where ProcessId = @@ProcessId and A.Party_Code = B.Party_Code
			and b.Segment_Type = @@Segment_Type
			and valid='Y'
		end
		select msg = 'Client - dealer mapping successful. Changes would be reflected from next day.'
		
		-- Set the Flag true for the valid entry of Client mapping	 
              
				-- Code to send the SMS for valid client mapping                                                             
				If (@@smsFlag = 'YES') 
				begin
					insert into TBL_B2B_CRMS_SMS_DEALER_MAPPING_YPTest
					(
						party_code,
						party_mobile,
						sub_broker,
						sub_broker_name,
						DealerCode,
						DealerName,
						DealerContact
					) 
					Select 
						B.Party_code,
						mobileNo=(case when len(rtrim(ltrim(mobile_pager)))=10 then rtrim(ltrim(mobile_pager)) else 'NA' end) ,
						A.Sub_broker,
						Sub_Broker_Name=(select tradename from MIS.sb_comp.dbo.sb_broker with(nolock) where sbtag=a.sub_broker),
						B.Dealer1,
						--dealerName=(select emp_name from B2B_AngelHarmony e with(nolock) where e.emp_no=B.Dealer1 and isdealer='1'),
						dealerName=emp_name,
						contactNo=landline_no
					 from 
						B2B_Bulk_DealerMapping_YPTest B with (nolock), angelclient1 A with (nolock),B2B_AngelHarmony  with(nolock)
					 where 
						ProcessId = @@ProcessId and 
						A.Party_Code = B.Party_Code
						and Segment_Type = @@Segment_Type
						and rtrim(ltrim(AngelClRating))<>'NEW'
						and emp_no=B.Dealer1
						and isdealer='1'
						--and isadmin<>'1'
    			end
	end				           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.b2b_crms_sb_location_auto_complete
-- --------------------------------------------------
CREATE procedure [dbo].[b2b_crms_sb_location_auto_complete]
(
	@UserEmp_No varchar(20),
	@StatusId varchar(10),--SUBBROKER/SBDEALER
	@search_location varchar(10), --This is Sub Broker
	@request_type varchar(5)
)
as
begin
	--exec b2b_crms_sb_location_auto_complete @sb_location='et001', @search_location='', @request_type='MAIN'
	--exec b2b_crms_sb_location_auto_complete @sb_location='et001', @search_location='et', @request_type='EXT'
	
	--exec b2b_crms_sb_location_auto_complete @UserEmp_No='eta001',@StatusId='SUBBROKER', @search_location='', @request_type='MAIN'
	--exec b2b_crms_sb_location_auto_complete @UserEmp_No='eta001',@StatusId='SUBBROKER', @search_location='et', @request_type='EXT'
	--exec b2b_crms_sb_location_auto_complete @UserEmp_No='et001',@StatusId='SUBBROKER', @search_location='et', @request_type='MAIN'
	--exec b2b_crms_sb_location_auto_complete @UserEmp_No='eta001',@StatusId='SUBBROKER', @search_location='', @request_type='MAIN'	
	--exec b2b_crms_sb_location_auto_complete @UserEmp_No='CA001',@StatusId='SUBBROKER', @search_location='ca', @request_type='MAIN'

	declare @@parenttag varchar(20)
	declare @@count int
	declare @@sb_tag varchar(20)
	
	
	select @@sb_tag=sb_tag from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No
	
	select 
			@@parenttag=parenttag 
		from 
			MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		where 
			sbtag=upper(@@sb_tag)
			
	--select @parenttag
	if @request_type = 'MAIN'
	begin
		if @@parenttag is not null
		begin
			select output=upper(@@sb_tag)
		end
		else
		begin
			select 
				@@count=count(sbtag) 
			from 
				MIS.sb_comp.dbo.sb_broker WITH (nolock)
			where
				parenttag=upper(@@sb_tag)
				
			if(@@count>0 and @StatusId='SUBBROKER')
			begin
				select output='EXTENDER'
			end
			else
			begin
				select output=upper(@@sb_tag)
			end
			
		end
	end
	
	if @request_type = 'EXT'
	begin
	
		declare @tempbranch  table                                                                
		(                                                                
			Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
		)
	
		if @@parenttag is null
		begin
			insert into @tempbranch 
			select distinct Branch_cd=sb_tag FROM dbo.b2b_crms_mimansa_status(@UserEmp_No); 
		end
		else
		begin
			insert into @tempbranch select @@sb_tag
		end	
		
		
		
			
		select sb_tag=Branch_cd from @tempbranch a
		where Branch_cd like '%'+ @search_location +'%'
			
			
			
	end
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2b_Crms_Segmentwise_to
-- --------------------------------------------------
CREATE procedure [dbo].[B2b_Crms_Segmentwise_to]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(10),--SUBBROKER/SBDEALER
	@Sub_Broker varchar(10),
	@Dealer varchar(20),
	@Report_Type varchar(10),
	@Main_Drill varchar(10),
	@Turn_Brok varchar(10),
	@ClientGrade varchar(3),
	@TradingMode varchar(10),
	@From_Date datetime,
	@To_Date datetime
)
as
begin
	
/*
exec B2b_Crms_Segmentwise_to_bak @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@Report_Type='SUBBROKER',
@Main_Drill='MAIN', @Turn_Brok='',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Nov  1 2012',@To_Date='Nov 30 2012'

exec B2b_Crms_Segmentwise_to @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@Report_Type='SUB_BROKER',
@Main_Drill='DRIL', @Turn_Brok='BROK',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Aug  1 2012',@To_Date='Aug 30 2012'

Execute B2b_Crms_Segmentwise_to'ET001','SUBBROKER','ET','','SUBBROKER','DRIL','BROK','ALL','ALL','Oct  1 2012','Oct  8 2012'
*/

declare @@date datetime

select @@date=GETDATE()
declare @@Report_Type varchar(10)

declare @@Sub_Broker varchar(10)
declare @@Dealer varchar(20)
Declare @@ClientGrade char(3)                                                                        
Declare @@TradingMode char(20)  
Declare @@From_Date datetime
Declare @@To_Date datetime 

set @@Sub_Broker=@Sub_Broker
set @@Dealer=@Dealer
set @@Report_Type=@Report_Type
SET @@ClientGrade = ltrim(rtrim(@ClientGrade))   
SET @@TradingMode = (Select Case When ltrim(rtrim(@TradingMode)) = 'ONLINE' THEN 'Y' When  ltrim(rtrim(@TradingMode)) = 'OFFLINE' THEN 'N'  ELSE   @TradingMode END)                                                                
set @@From_Date = @From_Date + ' 00:00:00'
set @@To_Date=@To_Date + ' 23:59:59'



Declare @@From_Sub_Broker varchar(10)
Declare @@To_Sub_Broker varchar(10) 
Declare @@From_Dealer varchar(20)
Declare @@To_Dealer varchar(20)

if(LEN(@@Sub_Broker)=0)
begin
	select @@From_Sub_Broker='00000',
		   @@To_Sub_Broker='ZZZZZZZ'
end		   
else
begin
	select @@From_Sub_Broker=@@Sub_Broker,
		   @@To_Sub_Broker=@@Sub_Broker 
end	  	

if(LEN(@@Dealer)=0)
begin
	select @@From_Dealer='00000',
		   @@To_Dealer='ZZZZZZZ'
end		   
else
begin
	select @@From_Dealer=@@Dealer,
		   @@To_Dealer=@@Dealer
end	 



If ltrim(rtrim(@@TradingMode)) = '' or ltrim(rtrim(@@TradingMode)) = 'All' set @@TradingMode  = '%'                                                                        
If ltrim(rtrim(@@ClientGrade))  = '' or ltrim(rtrim(@@ClientGrade))  = 'ALL' set @@ClientGrade  = '%' 

declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)

if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin  
		Declare @sb_tag varchar(10)
		--Declare @fr_sb varchar(10)
		--Declare @to_sb varchar(10)
		select @sb_tag=sb_tag from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No
		select @@From_Sub_Broker=isnull(sb_tag,'0000') ,@@TO_Sub_Broker=isnull(sb_tag,'ZZZZ')  
		from B2B_AngelHarmony with(nolock) where emp_no=@@Sub_Broker
		
		  
		--insert into @tempbranch 
		--select distinct Branch_cd=sbtag from
		--(
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock)  where sbtag=@sb_tag)
		--	Union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=@sb_tag
		--	union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where sbtag=@sb_tag
		--	union
		--	select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) where sbtag=@sb_tag)
		--)a	
		--where  sbtag >=@@From_Sub_Broker and  sbtag <=@@TO_Sub_Broker    
			
		insert into @tempbranch 
		select distinct Branch_cd=sb_tag FROM dbo.b2b_crms_mimansa_status(@UserEmp_No)    
		where sb_tag >=@@From_Sub_Broker and  sb_tag <=@@TO_Sub_Broker    
end



create table #PartyDetails
(
Party_Code varchar(10),
Branch_cd varchar(20),
Emp_No varchar(20),
FromDate smalldatetime,
ToDate smalldatetime,
EbrokingClient char(1),
AngelClRating varchar(10)
)

print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where 
		ps.Branch_cd=aub.Branch_cd 
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date
		and ps.Emp_No>=@@From_Dealer
		and ps.Emp_No<=@@To_Dealer
end


--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
	print 'TradingMode or ClientGrade'
	if @TradingMode='ALL' 
		set @TradingMode='%' 
	else 
		set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
		
	if @ClientGrade='ALL' set @ClientGrade='%'
		--
			update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
			From angelclient1 ac1 with(nolock), #PartyDetails ps
			where 
			ac1.Party_Code=ps.Party_Code and 
			ac1.EbrokingClient like @TradingMode and 
			ac1.AngelClRating like @ClientGrade
		--

		delete #PartyDetails where isnull(EbrokingClient,'')=''	
	--
	end
	


select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	--dealer_Name,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	--Curr_option_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_Del_Opt) else 0 end,
	--Curr_option_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Del_opt) else 0 end
	
	into 
		#temp_client_data	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
	--on a1.sub_broker=a2.Sub_Broker  
	on a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
	
	where 
	--a1.sub_broker=a2.Branch_cd and --Comment by san
	--@@To_Sub_Broker<=a2.Branch_cd and
	--@@From_Dealer<=a2.emp_no and 
   -- @@To_Dealer>=a2.emp_no and
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 	

	--a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
--select * from #PartyDetails where party_code='R14579'
--select * from #temp_client_data where party_code='R14579'
	print @@From_Date
	print @@To_Date

------------------------------------------------------------------------------------------------------
/* The Code is written for inserter 98 party code Turn over and Brokerage to table #temp_client_data*/
------------------------------------------------------------------------------------------------------

insert into  
		#temp_client_data	
select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
		on a1.party_code COLLATE DATABASE_DEFAULT ='98'+a2.Party_Code
	where 
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 
	
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
	
--select distinct party_code from #temp_client_data order by party_code
--select * from #PartyDetails 
--RETURN

	if @Main_Drill='MAIN' 
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer='',
				turnover=convert(decimal(20,0),sum(turnover)/1000),
				brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage)/1000  
			from 
				#temp_client_data
			group by sub_broker	
			--order by b2b_dealer
			
			select
				sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
				sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
		end
		if @@Report_Type= 'DEALER'
		begin
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer,
				dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
				turnover=convert(decimal(20,0),sum(turnover)/1000),
				brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
			group by b2b_dealer,sub_broker	
			
			select
				sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
				sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
				
			
		end
	end
	if @Main_Drill= 'DRIL'
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
					--segment,
						--Sub_broker,
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						turnover=convert(decimal(20,0),sum(turnover)/1000),
						intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						
						Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
										
						Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data
					--group by Sub_broker,party_code	
					group by party_code	
					order by party_code
					
					select
						sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
						sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				
						sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				
						sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
				end
				if(@Turn_Brok='BROK')
				begin
					select
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code) ,
						brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
					from 
						#temp_client_data
					group by party_code	
					order by party_code
					
					select
						sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
								
						sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
				end	
		end
		if @@Report_Type= 'DEALER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						turnover=convert(decimal(20,0),sum(turnover)/1000),
						intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						
						Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
						
						Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
						sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
						sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					
				end	
				if(@Turn_Brok='BROK')
				begin
					print @Turn_Brok
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					
					
				end
		end
	end	
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2b_Crms_Segmentwise_to_ADTest
-- --------------------------------------------------

CREATE procedure [dbo].[B2b_Crms_Segmentwise_to_ADTest]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(10),--SUBBROKER/SBDEALER
	@Sub_Broker varchar(10),
	@Dealer varchar(20),
	@Report_Type varchar(10),
	@Main_Drill varchar(10),
	@Turn_Brok varchar(10),
	@ClientGrade varchar(3),
	@TradingMode varchar(10),
	@From_Date datetime,
	@To_Date datetime
)
as
begin
	
/*
exec B2b_Crms_Segmentwise_to_bak @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@Report_Type='SUBBROKER',
@Main_Drill='MAIN', @Turn_Brok='',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Nov  1 2012',@To_Date='Nov 30 2012'

exec B2b_Crms_Segmentwise_to @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@Report_Type='SUB_BROKER',
@Main_Drill='DRIL', @Turn_Brok='BROK',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Aug  1 2012',@To_Date='Aug 30 2012'

Execute B2b_Crms_Segmentwise_to'ET001','SUBBROKER','ET','','SUBBROKER','DRIL','BROK','ALL','ALL','Oct  1 2012','Oct  8 2012'
*/

declare @@date datetime

select @@date=GETDATE()
declare @@Report_Type varchar(10)

declare @@Sub_Broker varchar(10)
declare @@Dealer varchar(20)
Declare @@ClientGrade char(3)                                                                        
Declare @@TradingMode char(20)  
Declare @@From_Date datetime
Declare @@To_Date datetime 

set @@Sub_Broker=@Sub_Broker
set @@Dealer=@Dealer
set @@Report_Type=@Report_Type
SET @@ClientGrade = ltrim(rtrim(@ClientGrade))   
SET @@TradingMode = (Select Case When ltrim(rtrim(@TradingMode)) = 'ONLINE' THEN 'Y' When  ltrim(rtrim(@TradingMode)) = 'OFFLINE' THEN 'N'  ELSE   @TradingMode END)                                                                
set @@From_Date = @From_Date + ' 00:00:00'
set @@To_Date=@To_Date + ' 23:59:59'



Declare @@From_Sub_Broker varchar(10)
Declare @@To_Sub_Broker varchar(10) 
Declare @@From_Dealer varchar(20)
Declare @@To_Dealer varchar(20)

if(LEN(@@Sub_Broker)=0)
begin
	select @@From_Sub_Broker='00000',
		   @@To_Sub_Broker='ZZZZZZZ'
end		   
else
begin
	select @@From_Sub_Broker=@@Sub_Broker,
		   @@To_Sub_Broker=@@Sub_Broker 
end	  	

if(LEN(@@Dealer)=0)
begin
	select @@From_Dealer='00000',
		   @@To_Dealer='ZZZZZZZ'
end		   
else
begin
	select @@From_Dealer=@@Dealer,
		   @@To_Dealer=@@Dealer
end	 



If ltrim(rtrim(@@TradingMode)) = '' or ltrim(rtrim(@@TradingMode)) = 'All' set @@TradingMode  = '%'                                                                        
If ltrim(rtrim(@@ClientGrade))  = '' or ltrim(rtrim(@@ClientGrade))  = 'ALL' set @@ClientGrade  = '%' 

declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)

if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin  
		Declare @sb_tag varchar(10)
		--Declare @fr_sb varchar(10)
		--Declare @to_sb varchar(10)
		select @sb_tag=sb_tag from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No
		select @@From_Sub_Broker=isnull(sb_tag,'0000') ,@@TO_Sub_Broker=isnull(sb_tag,'ZZZZ')  
		from B2B_AngelHarmony with(nolock) where emp_no=@@Sub_Broker
		
		--Select @sb_tag
		--Select @@From_Sub_Broker
		--Select @@TO_Sub_Broker

		  
		--insert into @tempbranch 
		--select distinct Branch_cd=sbtag from
		--(
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock)  where sbtag=@sb_tag)
		--	Union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=@sb_tag
		--	union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where sbtag=@sb_tag
		--	union
		--	select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) where sbtag=@sb_tag)
		--)a	
		--where  sbtag >=@@From_Sub_Broker and  sbtag <=@@TO_Sub_Broker    
			
		insert into @tempbranch 
		select distinct Branch_cd=sb_tag FROM dbo.b2b_crms_mimansa_status(@UserEmp_No)    
		where sb_tag >=@@From_Sub_Broker and  sb_tag <=@@TO_Sub_Broker    
end

--Select * from @tempbranch


create table #PartyDetails
(
Party_Code varchar(10),
Branch_cd varchar(20),
Emp_No varchar(20),
FromDate smalldatetime,
ToDate smalldatetime,
EbrokingClient char(1),
AngelClRating varchar(10)
)

print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where 
		ps.Branch_cd=aub.Branch_cd 
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date
		and ps.Emp_No>=@@From_Dealer
		and ps.Emp_No<=@@To_Dealer
end

--Select * from #PartyDetails

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
	print 'TradingMode or ClientGrade'
	if @TradingMode='ALL' 
		set @TradingMode='%' 
	else 
		set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
		
	if @ClientGrade='ALL' set @ClientGrade='%'
		--
			update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
			From angelclient1 ac1 with(nolock), #PartyDetails ps
			where 
			ac1.Party_Code=ps.Party_Code and 
			ac1.EbrokingClient like @TradingMode and 
			ac1.AngelClRating like @ClientGrade
		--

		delete #PartyDetails where isnull(EbrokingClient,'')=''	
	--
	end
	


select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	--dealer_Name,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	--Curr_option_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_Del_Opt) else 0 end,
	--Curr_option_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Del_opt) else 0 end
	
	into 
		#temp_client_data	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
	--on a1.sub_broker=a2.Sub_Broker  
	on a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
	
	where 
	--a1.sub_broker=a2.Branch_cd and --Comment by san
	--@@To_Sub_Broker<=a2.Branch_cd and
	--@@From_Dealer<=a2.emp_no and 
   -- @@To_Dealer>=a2.emp_no and
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 	

	--a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
--select * from #PartyDetails where party_code='R14579'
--select * from #temp_client_data where party_code='R14579'
	print @@From_Date
	print @@To_Date

------------------------------------------------------------------------------------------------------
/* The Code is written for inserter 98 party code Turn over and Brokerage to table #temp_client_data*/
------------------------------------------------------------------------------------------------------

--Select * from #temp_client_data

insert into  
		#temp_client_data	
select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
		on a1.party_code COLLATE DATABASE_DEFAULT ='98'+a2.Party_Code
	where 
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 
	
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
	
--select distinct party_code from #temp_client_data order by party_code
--select * from #PartyDetails 
--RETURN

PRINT @Main_Drill
PRINT @@Report_Type

	if @Main_Drill='MAIN' 
	begin
		if @@Report_Type= 'SUBBROKER'
		begin

			PRINT 'HERE AAAA'
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer='',
				turnover=convert(decimal(20,0),sum(turnover)/1000),
				brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage)/1000  
			from 
				#temp_client_data
			group by sub_broker	
			--order by b2b_dealer
			
			select
				sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
				sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
		end
		if @@Report_Type= 'DEALER'
		begin
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer,
				dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
				turnover=convert(decimal(20,0),sum(turnover)/1000),
				brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
			group by b2b_dealer,sub_broker	
			
			select
				sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
				sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
				
			
		end
	end
	if @Main_Drill= 'DRIL'
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
					--segment,
						--Sub_broker,
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						turnover=convert(decimal(20,0),sum(turnover)/1000),
						intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						
						Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
										
						Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data
					--group by Sub_broker,party_code	
					group by party_code	
					order by party_code
					
					select
						sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
						sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				
						sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				
						sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
				end
				if(@Turn_Brok='BROK')
				begin
					select
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code) ,
						brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
					from 
						#temp_client_data
					group by party_code	
					order by party_code
					
					select
						sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
								
						sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
				end	
		end
		if @@Report_Type= 'DEALER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						turnover=convert(decimal(20,0),sum(turnover)/1000),
						intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						
						Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
						
						Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
						sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
						sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					
				end	
				if(@Turn_Brok='BROK')
				begin
					print @Turn_Brok
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					
					
				end
		end
	end	
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2b_Crms_Segmentwise_to_bak
-- --------------------------------------------------
CREATE procedure [dbo].[B2b_Crms_Segmentwise_to_bak]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(10),--SUBBROKER/SBDEALER
	@Sub_Broker varchar(10),
	@Dealer varchar(20),
	@Report_Type varchar(10),
	@Main_Drill varchar(10),
	@Turn_Brok varchar(10),
	@ClientGrade varchar(3),
	@TradingMode varchar(10),
	@From_Date datetime,
	@To_Date datetime
)
as
begin
	
/*
exec B2b_Crms_Segmentwise_to @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@Report_Type='SUB_BROKER',
@Main_Drill='MAIN', @Turn_Brok='',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Aug  1 2012',@To_Date='Aug 30 2012'

exec B2b_Crms_Segmentwise_to @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@Report_Type='SUB_BROKER',
@Main_Drill='DRIL', @Turn_Brok='BROK',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Aug  1 2012',@To_Date='Aug 30 2012'

Execute B2b_Crms_Segmentwise_to'ET001','SUBBROKER','ET','','SUBBROKER','DRIL','BROK','ALL','ALL','Oct  1 2012','Oct  8 2012'
*/

declare @@date datetime

select @@date=GETDATE()
declare @@Report_Type varchar(10)

declare @@Sub_Broker varchar(10)
declare @@Dealer varchar(20)
Declare @@ClientGrade char(3)                                                                        
Declare @@TradingMode char(20)  
Declare @@From_Date datetime
Declare @@To_Date datetime 

set @@Sub_Broker=@Sub_Broker
set @@Dealer=@Dealer
set @@Report_Type=@Report_Type
SET @@ClientGrade = ltrim(rtrim(@ClientGrade))   
SET @@TradingMode = (Select Case When ltrim(rtrim(@TradingMode)) = 'ONLINE' THEN 'Y' When  ltrim(rtrim(@TradingMode)) = 'OFFLINE' THEN 'N'  ELSE   @TradingMode END)                                                                
set @@From_Date = @From_Date + ' 00:00:00'
set @@To_Date=@To_Date + ' 23:59:59'



Declare @@From_Sub_Broker varchar(10)
Declare @@To_Sub_Broker varchar(10) 
Declare @@From_Dealer varchar(20)
Declare @@To_Dealer varchar(20)

if(LEN(@@Sub_Broker)=0)
begin
	select @@From_Sub_Broker='00000',
		   @@To_Sub_Broker='ZZZZZZZ'
end		   
else
begin
	select @@From_Sub_Broker=@@Sub_Broker,
		   @@To_Sub_Broker=@@Sub_Broker 
end	  	

if(LEN(@@Dealer)=0)
begin
	select @@From_Dealer='00000',
		   @@To_Dealer='ZZZZZZZ'
end		   
else
begin
	select @@From_Dealer=@@Dealer,
		   @@To_Dealer=@@Dealer
end	 



If ltrim(rtrim(@@TradingMode)) = '' or ltrim(rtrim(@@TradingMode)) = 'All' set @@TradingMode  = '%'                                                                        
If ltrim(rtrim(@@ClientGrade))  = '' or ltrim(rtrim(@@ClientGrade))  = 'ALL' set @@ClientGrade  = '%' 

declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)

if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin  
		Declare @sb_tag varchar(10)
		--Declare @fr_sb varchar(10)
		--Declare @to_sb varchar(10)
		select @sb_tag=sb_tag from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No
		select @@From_Sub_Broker=isnull(sb_tag,'0000') ,@@TO_Sub_Broker=isnull(sb_tag,'ZZZZ')  from B2B_AngelHarmony with(nolock) where emp_no=@@Sub_Broker
		
		  
		--insert into @tempbranch 
		--select distinct Branch_cd=sbtag from
		--(
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock)  where sbtag=@sb_tag)
		--	Union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=@sb_tag
		--	union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where sbtag=@sb_tag
		--	union
		--	select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) where sbtag=@sb_tag)
		--)a	
		--where  sbtag >=@@From_Sub_Broker and  sbtag <=@@TO_Sub_Broker    
			
		insert into @tempbranch 
		select distinct Branch_cd=sb_tag FROM dbo.b2b_crms_mimansa_status(@UserEmp_No)    
		where sb_tag >=@@From_Sub_Broker and  sb_tag <=@@TO_Sub_Broker    
end



create table #PartyDetails
(
Party_Code varchar(10),
Branch_cd varchar(20),
Emp_No varchar(10),
FromDate smalldatetime,
ToDate smalldatetime,
EbrokingClient char(1),
AngelClRating varchar(10)
)

print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where 
		ps.Branch_cd=aub.Branch_cd 
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date
		and ps.Emp_No>=@@From_Dealer
		and ps.Emp_No<=@@To_Dealer
end


--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
	print 'TradingMode or ClientGrade'
	if @TradingMode='ALL' 
		set @TradingMode='%' 
	else 
		set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
		
	if @ClientGrade='ALL' set @ClientGrade='%'
		--
			update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
			From angelclient1 ac1 with(nolock), #PartyDetails ps
			where 
			ac1.Party_Code=ps.Party_Code and 
			ac1.EbrokingClient like @TradingMode and 
			ac1.AngelClRating like @ClientGrade
		--

		delete #PartyDetails where isnull(EbrokingClient,'')=''	
	--
	end
	


select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	--dealer_Name,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	--Curr_option_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_Del_Opt) else 0 end,
	--Curr_option_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Del_opt) else 0 end
	
	into 
		#temp_client_data	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
	--on a1.sub_broker=a2.Sub_Broker  
	on a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
	
	where 
	--a1.sub_broker=a2.Branch_cd and --Comment by san
	--@@To_Sub_Broker<=a2.Branch_cd and
	--@@From_Dealer<=a2.emp_no and 
   -- @@To_Dealer>=a2.emp_no and
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 	

	--a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
--select * from #PartyDetails where party_code='R14579'
--select * from #temp_client_data where party_code='R14579'
	print @@From_Date
	print @@To_Date

------------------------------------------------------------------------------------------------------
/* The Code is written for inserter 98 party code Turn over and Brokerage to table #temp_client_data*/
------------------------------------------------------------------------------------------------------

insert into  
		#temp_client_data	
select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
		on a1.party_code COLLATE DATABASE_DEFAULT ='98'+a2.Party_Code
	where 
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 
	
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
	
--select distinct party_code from #temp_client_data order by party_code
--select * from #PartyDetails 
--RETURN

	if @Main_Drill='MAIN' 
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer='',
				turnover=sum(turnover),--/1000,
				brokerage=sum(brokerage),--/1000,
				intra_turnover=sum(intra_turnover),--/1000,
				intra_brokerage=sum(intra_brokerage),--/1000,
				delevary_turnover=sum(delevary_turnover),--/1000,
				delevary_brokerage=sum(delevary_brokerage),--/1000, 
				Future_turnover=sum(Future_turnover),--/1000,
				Future_brokerage=sum(Future_brokerage),--/1000,
				option_turnover=sum(option_turnover),--/1000,
				option_brokerage=sum(option_brokerage),--/1000,
				
				Commodity_turnover=sum(Commodity_turnover),--/1000,
				Commodity_brokerage=sum(Commodity_brokerage),--/1000,
				
				Curr_Future_turnover=sum(Curr_Future_turnover),--/1000,
				Curr_Future_brokerage=sum(Curr_Future_brokerage)--/1000--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage)/1000  
			from 
				#temp_client_data
			group by sub_broker	
			--order by b2b_dealer
			
			select
				sum_turnover=sum(turnover),--/1000),
				sum_brokerage=sum(brokerage),--/1000,
				sum_intra_turnover=sum(intra_turnover),--/1000,
				sum_intra_brokerage=sum(intra_brokerage),--/1000,
				sum_delevary_turnover=sum(delevary_turnover),--/1000,
				sum_delevary_brokerage=sum(delevary_brokerage),--/1000, 
				sum_Future_turnover=sum(Future_turnover),--/1000,
				sum_Future_brokerage=sum(Future_brokerage),--/1000,
				sum_option_turnover=sum(option_turnover),--/1000,
				sum_option_brokerage=sum(option_brokerage),--/1000,
				
				sum_Commodity_turnover=sum(Commodity_turnover),--/1000,
				sum_Commodity_brokerage=sum(Commodity_brokerage),--/1000,
				
				sum_Curr_Future_turnover=sum(Curr_Future_turnover),--/1000,
				sum_Curr_Future_brokerage=sum(Curr_Future_brokerage)--/1000--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
		end
		if @@Report_Type= 'DEALER'
		begin
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer,
				dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
				turnover=sum(turnover),--/1000,
				brokerage=sum(brokerage),--/1000,
				intra_turnover=sum(intra_turnover),--/1000,
				intra_brokerage=sum(intra_brokerage),--/1000,
				delevary_turnover=sum(delevary_turnover),--/1000,
				delevary_brokerage=sum(delevary_brokerage),--/1000, 
				Future_turnover=sum(Future_turnover),--/1000,
				Future_brokerage=sum(Future_brokerage),--/1000,
				option_turnover=sum(option_turnover),--/1000,
				option_brokerage=sum(option_brokerage),--/1000,
				
				Commodity_turnover=sum(Commodity_turnover),--/1000,
				Commodity_brokerage=sum(Commodity_brokerage),--/1000,
				
				Curr_Future_turnover=sum(Curr_Future_turnover),--/1000,
				Curr_Future_brokerage=sum(Curr_Future_brokerage)--/1000--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
			group by b2b_dealer,sub_broker	
			
			select
				sum_turnover=sum(turnover),--/1000),
				sum_brokerage=sum(brokerage),--/1000,
				sum_intra_turnover=sum(intra_turnover),--/1000,
				sum_intra_brokerage=sum(intra_brokerage),--/1000,
				sum_delevary_turnover=sum(delevary_turnover),--/1000,
				sum_delevary_brokerage=sum(delevary_brokerage),--/1000, 
				sum_Future_turnover=sum(Future_turnover),--/1000,
				sum_Future_brokerage=sum(Future_brokerage),--/1000,
				sum_option_turnover=sum(option_turnover),--/1000,
				sum_option_brokerage=sum(option_brokerage),--/1000,
				
				sum_Commodity_turnover=sum(Commodity_turnover),--/1000,
				sum_Commodity_brokerage=sum(Commodity_brokerage),--/1000,
				
				sum_Curr_Future_turnover=sum(Curr_Future_turnover),--/1000,
				sum_Curr_Future_brokerage=sum(Curr_Future_brokerage)--/1000--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
				
			
		end
	end
	if @Main_Drill= 'DRIL'
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
					--segment,
						--Sub_broker,
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						turnover=sum(turnover),--/1000,
						intra_turnover=sum(intra_turnover),--/1000,
						delevary_turnover=sum(delevary_turnover),--/1000,
						Future_turnover=sum(Future_turnover),--/1000,
						option_turnover=sum(option_turnover),--/1000,
						
						Commodity_turnover=sum(Commodity_turnover),--/1000,
										
						Curr_Future_turnover=sum(Curr_Future_turnover)--/1000--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data
					--group by Sub_broker,party_code	
					group by party_code	
					order by party_code
					
					select
						sum_turnover=sum(turnover),--/1000,
						sum_intra_turnover=sum(intra_turnover),--/1000,
						sum_delevary_turnover=sum(delevary_turnover),--/1000,
						sum_Future_turnover=sum(Future_turnover),--/1000,
						sum_option_turnover=sum(option_turnover),--/1000,
				
						sum_Commodity_turnover=sum(Commodity_turnover),--/1000,
				
						sum_Curr_Future_turnover=sum(Curr_Future_turnover)--/1000--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
				end
				if(@Turn_Brok='BROK')
				begin
					print 'test1'
					select
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code) ,
						brokerage=sum(brokerage),--/1000,
						intra_brokerage=sum(intra_brokerage),--/1000,
						delevary_brokerage=sum(delevary_brokerage),--/1000, 
						Future_brokerage=sum(Future_brokerage),--/1000,
						option_brokerage=sum(option_brokerage),--/1000,
						
						Commodity_brokerage=sum(Commodity_brokerage),--/1000,
						
						Curr_Future_brokerage=sum(Curr_Future_brokerage)--/1000--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
					from 
						#temp_client_data
					group by party_code	
					order by party_code
					
					select
						sum_brokerage=sum(brokerage),--/1000,
						sum_intra_brokerage=sum(intra_brokerage),--/1000,
						sum_delevary_brokerage=sum(delevary_brokerage),--/1000, 
						sum_Future_brokerage=sum(Future_brokerage),--/1000,
						sum_option_brokerage=sum(option_brokerage),--/1000,
								
						sum_Commodity_brokerage=sum(Commodity_brokerage),--/1000,
						
						sum_Curr_Future_brokerage=sum(Curr_Future_brokerage)--/1000--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
				end	
		end
		if @@Report_Type= 'DEALER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						turnover=sum(turnover),--/1000,
						intra_turnover=sum(intra_turnover),--/1000,
						delevary_turnover=sum(delevary_turnover),--/1000,
						Future_turnover=sum(Future_turnover),--/1000,
						option_turnover=sum(option_turnover),--/1000,
						
						Commodity_turnover=sum(Commodity_turnover),--/1000,
						
						Curr_Future_turnover=sum(Curr_Future_turnover)--/1000--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_turnover=sum(turnover),--/1000,
						sum_intra_turnover=sum(intra_turnover),--/1000,
						sum_delevary_turnover=sum(delevary_turnover),--/1000,
						sum_Future_turnover=sum(Future_turnover),--/1000,
						sum_option_turnover=sum(option_turnover),--/1000,
						sum_Commodity_turnover=sum(Commodity_turnover),--/1000,
						sum_Curr_Future_turnover=sum(Curr_Future_turnover)--/1000--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					
				end	
				if(@Turn_Brok='BROK')
				begin
					print @Turn_Brok
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						brokerage=sum(brokerage),--/1000,
						intra_brokerage=sum(intra_brokerage),--/1000,
						delevary_brokerage=sum(delevary_brokerage),--/1000, 
						Future_brokerage=sum(Future_brokerage),--/1000,
						option_brokerage=sum(option_brokerage),--/1000,
						
						Commodity_brokerage=sum(Commodity_brokerage),--/1000,
						
						Curr_Future_brokerage=sum(Curr_Future_brokerage)--/1000--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_brokerage=sum(brokerage),--/1000,
						sum_intra_brokerage=sum(intra_brokerage),--/1000,
						sum_delevary_brokerage=sum(delevary_brokerage),--/1000, 
						sum_Future_brokerage=sum(Future_brokerage),--/1000,
						sum_option_brokerage=sum(option_brokerage),--/1000,
						
						sum_Commodity_brokerage=sum(Commodity_brokerage),--/1000,
						
						sum_Curr_Future_brokerage=sum(Curr_Future_brokerage)--/1000--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					
					
				end
		end
	end	
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2b_Crms_Segmentwise_to_RTest1July2015
-- --------------------------------------------------
CREATE procedure [dbo].[B2b_Crms_Segmentwise_to_RTest1July2015]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(10),--SUBBROKER/SBDEALER
	@Sub_Broker varchar(10),
	@Dealer varchar(20),
	@Report_Type varchar(10),
	@Main_Drill varchar(10),
	@Turn_Brok varchar(10),
	@ClientGrade varchar(3),
	@TradingMode varchar(10),
	@From_Date datetime,
	@To_Date datetime
)
as
begin
	
/*
   exec B2b_Crms_Segmentwise_to_RTest1July2015 'ET001','SUBBROKER','ET','','SUBBROKER','DRIL','BROK','ALL','ALL','Jul 1 2015','Jul 31 2015'

exec B2b_Crms_Segmentwise_to_bak @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@Report_Type='SUBBROKER',
@Main_Drill='MAIN', @Turn_Brok='',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Nov  1 2012',@To_Date='Nov 30 2012'

exec B2b_Crms_Segmentwise_to @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@Report_Type='SUB_BROKER',
@Main_Drill='DRIL', @Turn_Brok='BROK',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Aug  1 2012',@To_Date='Aug 30 2012'

Execute B2b_Crms_Segmentwise_to'ET001','SUBBROKER','ET','','SUBBROKER','DRIL','BROK','ALL','ALL','Jun  1 2015','Jun  26 2015'
*/

declare @@date datetime

select @@date=GETDATE()
declare @@Report_Type varchar(10)

declare @@Sub_Broker varchar(10)
declare @@Dealer varchar(20)
Declare @@ClientGrade char(3)                                                                        
Declare @@TradingMode char(20)  
Declare @@From_Date datetime
Declare @@To_Date datetime 

set @@Sub_Broker=@Sub_Broker
set @@Dealer=@Dealer
set @@Report_Type=@Report_Type
SET @@ClientGrade = ltrim(rtrim(@ClientGrade))   
SET @@TradingMode = (Select Case When ltrim(rtrim(@TradingMode)) = 'ONLINE' THEN 'Y' When  ltrim(rtrim(@TradingMode)) = 'OFFLINE' THEN 'N'  ELSE   @TradingMode END)                                                                
set @@From_Date = @From_Date + ' 00:00:00'
set @@To_Date=@To_Date + ' 23:59:59'



Declare @@From_Sub_Broker varchar(10)
Declare @@To_Sub_Broker varchar(10) 
Declare @@From_Dealer varchar(20)
Declare @@To_Dealer varchar(20)

if(LEN(@@Sub_Broker)=0)
begin
	select @@From_Sub_Broker='00000',
		   @@To_Sub_Broker='ZZZZZZZ'
end		   
else
begin
	select @@From_Sub_Broker=@@Sub_Broker,
		   @@To_Sub_Broker=@@Sub_Broker 
end	  	

if(LEN(@@Dealer)=0)
begin
	select @@From_Dealer='00000',
		   @@To_Dealer='ZZZZZZZ'
end		   
else
begin
	select @@From_Dealer=@@Dealer,
		   @@To_Dealer=@@Dealer
end	 



If ltrim(rtrim(@@TradingMode)) = '' or ltrim(rtrim(@@TradingMode)) = 'All' set @@TradingMode  = '%'                                                                        
If ltrim(rtrim(@@ClientGrade))  = '' or ltrim(rtrim(@@ClientGrade))  = 'ALL' set @@ClientGrade  = '%' 

declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)

if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin  
		Declare @sb_tag varchar(10)
		--Declare @fr_sb varchar(10)
		--Declare @to_sb varchar(10)
		select @sb_tag=sb_tag from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No
		select @@From_Sub_Broker=isnull(sb_tag,'0000') ,@@TO_Sub_Broker=isnull(sb_tag,'ZZZZ')  
		from B2B_AngelHarmony with(nolock) where emp_no=@@Sub_Broker
		
		  
		--insert into @tempbranch 
		--select distinct Branch_cd=sbtag from
		--(
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock)  where sbtag=@sb_tag)
		--	Union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=@sb_tag
		--	union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where sbtag=@sb_tag
		--	union
		--	select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) where sbtag=@sb_tag)
		--)a	
		--where  sbtag >=@@From_Sub_Broker and  sbtag <=@@TO_Sub_Broker    
			
		insert into @tempbranch 
		select distinct Branch_cd=sb_tag FROM dbo.b2b_crms_mimansa_status(@UserEmp_No)    
		where sb_tag >=@@From_Sub_Broker and  sb_tag <=@@TO_Sub_Broker    
end



create table #PartyDetails
(
Party_Code varchar(10),
Branch_cd varchar(20),
Emp_No varchar(20),
FromDate smalldatetime,
ToDate smalldatetime,
EbrokingClient char(1),
AngelClRating varchar(10)
)

print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin

/*
select To_Date=@@To_Date,From_Date=@@From_Date,* from B2B_CommonPartyServices where party_code ='S52968'

select To_Date=@@To_Date,From_Date=@@From_Date,* from B2B_CommonPartyServices a,@tempbranch b
		where 
		a.Branch_cd=b.Branch_cd and 
		a.party_code='S52968'
and a.FromDate<=@@To_Date
and a.ToDate>=@@From_Date
*/
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where 
		ps.Branch_cd=aub.Branch_cd 
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date

	
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date
		and ps.Emp_No>=@@From_Dealer
		and ps.Emp_No<=@@To_Dealer
end


--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
	print 'TradingMode or ClientGrade'
	if @TradingMode='ALL' 
		set @TradingMode='%' 
	else 
		set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
		
	if @ClientGrade='ALL' set @ClientGrade='%'
		--
			update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
			From angelclient1 ac1 with(nolock), #PartyDetails ps
			where 
			ac1.Party_Code=ps.Party_Code and 
			ac1.EbrokingClient like @TradingMode and 
			ac1.AngelClRating like @ClientGrade
		--
		
		delete #PartyDetails where isnull(EbrokingClient,'')=''	
	--
	end
	


select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	--dealer_Name,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	--Curr_option_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_Del_Opt) else 0 end,
	--Curr_option_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Del_opt) else 0 end
	
	into 
		#temp_client_data	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
	--on a1.sub_broker=a2.Sub_Broker  
	on a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
	
	where 
	--a1.sub_broker=a2.Branch_cd and --Comment by san
	--@@To_Sub_Broker<=a2.Branch_cd and
	--@@From_Dealer<=a2.emp_no and 
   -- @@To_Dealer>=a2.emp_no and
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 	

	--a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
--select * from #PartyDetails where party_code='R14579'
--select * from #temp_client_data where party_code='R14579'
	print @@From_Date
	print @@To_Date



	--/* testing ....

select 'testing',* from #PartyDetails where Party_Code like 'S52968'

select brokerage=sum(brokerage)
from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
	--on a1.sub_broker=a2.Sub_Broker  
	on a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
	
	where 
	--a1.sub_broker=a2.Branch_cd and --Comment by san
	--@@To_Sub_Broker<=a2.Branch_cd and
	--@@From_Dealer<=a2.emp_no and 
   -- @@To_Dealer>=a2.emp_no and
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate
	and a1.party_code like 'S52968'
	Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no

select brokerage=sum(brokerage)
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
		on a1.party_code COLLATE DATABASE_DEFAULT ='98'+a2.Party_Code
	where 
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 
	and  a1.party_code like 'S52968'
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no


select brokerage=sum(brokerage) from bsedb_ab.dbo.mis_to a1 with(nolock) where party_code='S52968'
and
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date 
	--*/


------------------------------------------------------------------------------------------------------
/* The Code is written for inserter 98 party code Turn over and Brokerage to table #temp_client_data*/
------------------------------------------------------------------------------------------------------



insert into  
		#temp_client_data	
select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
		on a1.party_code COLLATE DATABASE_DEFAULT ='98'+a2.Party_Code
	where 
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 
	
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
	
	/*Testing query below=> start*/
--select * from #temp_client_data where party_code='N47882'  order by sauda_date desc,brokerage

--select * from #PartyDetails 
--RETURN
/*end*/

	if @Main_Drill='MAIN' 
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
		print 'ravi=9'
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer='',
				turnover=convert(decimal(20,0),sum(turnover)/1000),
				brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage)/1000  
			from 
				#temp_client_data
			group by sub_broker	
			--order by b2b_dealer
			
			select
				sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
				sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
		end
		if @@Report_Type= 'DEALER'
		begin
		print 'ravi78'
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer,
				dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
				turnover=convert(decimal(20,0),sum(turnover)/1000),
				brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
			group by b2b_dealer,sub_broker	
			
			select
				sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
				sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
				
			
		end
	end
	if @Main_Drill= 'DRIL'
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
					--segment,
						--Sub_broker,
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						turnover=convert(decimal(20,0),sum(turnover)/1000),
						intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						
						Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
										
						Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data
					--group by Sub_broker,party_code	
					group by party_code	
					order by party_code
					
					select
						sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
						sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				
						sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				
						sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
				end
				if(@Turn_Brok='BROK')
				begin
				


				print 'ravi'

--				select * from #PartyDetails  a2 where Party_Code='B722'
--select * from  
--		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
--		on a1.party_code COLLATE DATABASE_DEFAULT ='98'+a2.Party_Code
--	where 
--	sauda_Date>=@@From_Date and
--	sauda_Date<=@@To_Date and
--	sauda_Date>=FromDate and
--	sauda_Date<=ToDate 
--	and a2.Party_Code='N47882'

					select
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code) ,
						brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
					from 
						#temp_client_data
					group by party_code	
					order by party_code
					
					select
						sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
								
						sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
				end	
		end
		if @@Report_Type= 'DEALER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						turnover=convert(decimal(20,0),sum(turnover)/1000),
						intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						
						Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
						
						Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
						sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
						sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					
				end	
				if(@Turn_Brok='BROK')
				begin
				print 'ravi=5'
					print @Turn_Brok
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					
					
				end
		end
	end	
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2b_Crms_Segmentwise_to_test
-- --------------------------------------------------
CREATE procedure [dbo].[B2b_Crms_Segmentwise_to_test]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(10),--SUBBROKER/SBDEALER
	@Sub_Broker varchar(10),
	@Dealer varchar(20),
	@Report_Type varchar(10),
	@Main_Drill varchar(10),
	@Turn_Brok varchar(10),
	@ClientGrade varchar(3),
	@TradingMode varchar(10),
	@From_Date datetime,
	@To_Date datetime
)
as
begin
	
/*
exec B2b_Crms_Segmentwise_to_bak @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@Report_Type='SUBBROKER',
@Main_Drill='MAIN', @Turn_Brok='',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Nov  1 2012',@To_Date='Nov 30 2012'

exec B2b_Crms_Segmentwise_to @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@Report_Type='SUB_BROKER',
@Main_Drill='DRIL', @Turn_Brok='BROK',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Aug  1 2012',@To_Date='Aug 30 2012'

Execute B2b_Crms_Segmentwise_to'ET001','SUBBROKER','ET','','SUBBROKER','DRIL','BROK','ALL','ALL','Oct  1 2012','Oct  8 2012'
*/

declare @@date datetime

select @@date=GETDATE()
declare @@Report_Type varchar(10)

declare @@Sub_Broker varchar(10)
declare @@Dealer varchar(20)
Declare @@ClientGrade char(3)                                                                        
Declare @@TradingMode char(20)  
Declare @@From_Date datetime
Declare @@To_Date datetime 

set @@Sub_Broker=@Sub_Broker
set @@Dealer=@Dealer
set @@Report_Type=@Report_Type
SET @@ClientGrade = ltrim(rtrim(@ClientGrade))   
SET @@TradingMode = (Select Case When ltrim(rtrim(@TradingMode)) = 'ONLINE' THEN 'Y' When  ltrim(rtrim(@TradingMode)) = 'OFFLINE' THEN 'N'  ELSE   @TradingMode END)                                                                
set @@From_Date = @From_Date + ' 00:00:00'
set @@To_Date=@To_Date + ' 23:59:59'



Declare @@From_Sub_Broker varchar(10)
Declare @@To_Sub_Broker varchar(10) 
Declare @@From_Dealer varchar(20)
Declare @@To_Dealer varchar(20)

if(LEN(@@Sub_Broker)=0)
begin
	select @@From_Sub_Broker='00000',
		   @@To_Sub_Broker='ZZZZZZZ'
end		   
else
begin
	select @@From_Sub_Broker=@@Sub_Broker,
		   @@To_Sub_Broker=@@Sub_Broker 
end	  	

if(LEN(@@Dealer)=0)
begin
	select @@From_Dealer='00000',
		   @@To_Dealer='ZZZZZZZ'
end		   
else
begin
	select @@From_Dealer=@@Dealer,
		   @@To_Dealer=@@Dealer
end	 



If ltrim(rtrim(@@TradingMode)) = '' or ltrim(rtrim(@@TradingMode)) = 'All' set @@TradingMode  = '%'                                                                        
If ltrim(rtrim(@@ClientGrade))  = '' or ltrim(rtrim(@@ClientGrade))  = 'ALL' set @@ClientGrade  = '%' 

declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)

if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin  
		Declare @sb_tag varchar(10)
		--Declare @fr_sb varchar(10)
		--Declare @to_sb varchar(10)
		select @sb_tag=sb_tag from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No
		select @@From_Sub_Broker=isnull(sb_tag,'0000') ,@@TO_Sub_Broker=isnull(sb_tag,'ZZZZ')  
		from B2B_AngelHarmony with(nolock) where emp_no=@@Sub_Broker
		
		  
		--insert into @tempbranch 
		--select distinct Branch_cd=sbtag from
		--(
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock)  where sbtag=@sb_tag)
		--	Union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=@sb_tag
		--	union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where sbtag=@sb_tag
		--	union
		--	select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) where sbtag=@sb_tag)
		--)a	
		--where  sbtag >=@@From_Sub_Broker and  sbtag <=@@TO_Sub_Broker    
			
		insert into @tempbranch 
		select distinct Branch_cd=sb_tag FROM dbo.b2b_crms_mimansa_status(@UserEmp_No)    
		where sb_tag >=@@From_Sub_Broker and  sb_tag <=@@TO_Sub_Broker    

		select * from @tempbranch
end



create table #PartyDetails
(
Party_Code varchar(10),
Branch_cd varchar(20),
Emp_No varchar(20),
FromDate smalldatetime,
ToDate smalldatetime,
EbrokingClient char(1),
AngelClRating varchar(10)
)

print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where 
		ps.Branch_cd=aub.Branch_cd 
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date

		
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date
		and ps.Emp_No>=@@From_Dealer
		and ps.Emp_No<=@@To_Dealer
end



--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
	print 'TradingMode or ClientGrade'
	if @TradingMode='ALL' 
		set @TradingMode='%' 
	else 
		set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
		
	if @ClientGrade='ALL' set @ClientGrade='%'
		--
			update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
			From angelclient1 ac1 with(nolock), #PartyDetails ps
			where 
			ac1.Party_Code=ps.Party_Code and 
			ac1.EbrokingClient like @TradingMode and 
			ac1.AngelClRating like @ClientGrade
		--

		delete #PartyDetails where isnull(EbrokingClient,'')=''	
	--
	end
	
select * from #PartyDetails where Party_code in('RL71100','N50625')


select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	--dealer_Name,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	--Curr_option_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_Del_Opt) else 0 end,
	--Curr_option_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Del_opt) else 0 end
	
	into 
		#temp_client_data	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
	--on a1.sub_broker=a2.Sub_Broker  
	on a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
	
	where 
	--a1.sub_broker=a2.Branch_cd and --Comment by san
	--@@To_Sub_Broker<=a2.Branch_cd and
	--@@From_Dealer<=a2.emp_no and 
   -- @@To_Dealer>=a2.emp_no and
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 	

	--a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
--select * from #PartyDetails where party_code='R14579'
--select * from #temp_client_data where party_code='R14579'
	print @@From_Date
	print @@To_Date


------------------------------------------------------------------------------------------------------
/* The Code is written for inserter 98 party code Turn over and Brokerage to table #temp_client_data*/
------------------------------------------------------------------------------------------------------

insert into  
		#temp_client_data	
select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
		on a1.party_code COLLATE DATABASE_DEFAULT ='98'+a2.Party_Code
	where 
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 
	
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
	
	select * from #temp_client_data where Party_code in('RL71100','N50625')


--select distinct party_code from #temp_client_data order by party_code
--select * from #PartyDetails 
--RETURN

	if @Main_Drill='MAIN' 
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer='',
				turnover=convert(decimal(20,0),sum(turnover)/1000),
				brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage)/1000  
			from 
				#temp_client_data
			group by sub_broker	
			--order by b2b_dealer
			
			select
				sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
				sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data where Party_code in('RL71100','N50625')
						print 'rr2'
						return
		end
		if @@Report_Type= 'DEALER'
		begin
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer,
				dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
				turnover=convert(decimal(20,0),sum(turnover)/1000),
				brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
			group by b2b_dealer,sub_broker	
			
			select
				sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
				sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
				
			
		end
	end
	if @Main_Drill= 'DRIL'
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
					--segment,
						--Sub_broker,
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						turnover=convert(decimal(20,0),sum(turnover)/1000),
						intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						
						Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
										
						Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data --where Party_code in('RL71100','N50625')
						
					--group by Sub_broker,party_code	
					group by party_code	
					order by party_code
					print 'rr3'
					
					
					select
						sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
						sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				
						sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				
						sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 

						#temp_client_data where Party_code in('RL71100','N50625')
						print 'rr'
						return
				end
				if(@Turn_Brok='BROK')
				begin
					select
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code) ,
						brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
					from 
						#temp_client_data
					group by party_code	
					order by party_code
					
					select
						sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
								
						sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
				end	
		end
		if @@Report_Type= 'DEALER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						turnover=convert(decimal(20,0),sum(turnover)/1000),
						intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						
						Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
						
						Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
						sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
						sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					
				end	
				if(@Turn_Brok='BROK')
				begin
					print @Turn_Brok
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					
					
				end
		end
	end	
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2b_Crms_Segmentwise_to_uat
-- --------------------------------------------------
CREATE procedure [dbo].[B2b_Crms_Segmentwise_to_uat]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(10),--SUBBROKER/SBDEALER
	@Sub_Broker varchar(10),
	@Dealer varchar(20),
	@Report_Type varchar(10),
	@Main_Drill varchar(10),
	@Turn_Brok varchar(10),
	@ClientGrade varchar(3),
	@TradingMode varchar(10),
	@From_Date datetime,
	@To_Date datetime
)
as
begin
	
/*
exec B2b_Crms_Segmentwise_to_bak @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@Report_Type='SUBBROKER',
@Main_Drill='MAIN', @Turn_Brok='',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Nov  1 2012',@To_Date='Nov 30 2012'

exec B2b_Crms_Segmentwise_to @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@Report_Type='SUB_BROKER',
@Main_Drill='DRIL', @Turn_Brok='BROK',@ClientGrade='ALL',@TradingMode='ALL',@From_Date='Aug  1 2012',@To_Date='Aug 30 2012'

Execute B2b_Crms_Segmentwise_to'ET001','SUBBROKER','ET','','SUBBROKER','DRIL','BROK','ALL','ALL','Oct  1 2012','Oct  8 2012'
*/

declare @@date datetime

select @@date=GETDATE()
declare @@Report_Type varchar(10)

declare @@Sub_Broker varchar(10)
declare @@Dealer varchar(20)
Declare @@ClientGrade char(3)                                                                        
Declare @@TradingMode char(20)  
Declare @@From_Date datetime
Declare @@To_Date datetime 

set @@Sub_Broker=@Sub_Broker
set @@Dealer=@Dealer
set @@Report_Type=@Report_Type
SET @@ClientGrade = ltrim(rtrim(@ClientGrade))   
SET @@TradingMode = (Select Case When ltrim(rtrim(@TradingMode)) = 'ONLINE' THEN 'Y' When  ltrim(rtrim(@TradingMode)) = 'OFFLINE' THEN 'N'  ELSE   @TradingMode END)                                                                
set @@From_Date = @From_Date + ' 00:00:00'
set @@To_Date=@To_Date + ' 23:59:59'



Declare @@From_Sub_Broker varchar(10)
Declare @@To_Sub_Broker varchar(10) 
Declare @@From_Dealer varchar(20)
Declare @@To_Dealer varchar(20)

if(LEN(@@Sub_Broker)=0)
begin
	select @@From_Sub_Broker='00000',
		   @@To_Sub_Broker='ZZZZZZZ'
end		   
else
begin
	select @@From_Sub_Broker=@@Sub_Broker,
		   @@To_Sub_Broker=@@Sub_Broker 
end	  	

if(LEN(@@Dealer)=0)
begin
	select @@From_Dealer='00000',
		   @@To_Dealer='ZZZZZZZ'
end		   
else
begin
	select @@From_Dealer=@@Dealer,
		   @@To_Dealer=@@Dealer
end	 



If ltrim(rtrim(@@TradingMode)) = '' or ltrim(rtrim(@@TradingMode)) = 'All' set @@TradingMode  = '%'                                                                        
If ltrim(rtrim(@@ClientGrade))  = '' or ltrim(rtrim(@@ClientGrade))  = 'ALL' set @@ClientGrade  = '%' 

declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)

if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin  
		Declare @sb_tag varchar(10)
		--Declare @fr_sb varchar(10)
		--Declare @to_sb varchar(10)
		select @sb_tag=sb_tag from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No
		select @@From_Sub_Broker=isnull(sb_tag,'0000') ,@@TO_Sub_Broker=isnull(sb_tag,'ZZZZ')  
		from B2B_AngelHarmony with(nolock) where emp_no=@@Sub_Broker
		
		  
		--insert into @tempbranch 
		--select distinct Branch_cd=sbtag from
		--(
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock)  where sbtag=@sb_tag)
		--	Union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=@sb_tag
		--	union 
		--	select sbtag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where sbtag=@sb_tag
		--	union
		--	select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) 
		--	where parenttag=(Select parenttag from MIS.sb_comp.dbo.sb_broker WITH (nolock) where sbtag=@sb_tag)
		--)a	
		--where  sbtag >=@@From_Sub_Broker and  sbtag <=@@TO_Sub_Broker    
			
		insert into @tempbranch 
		select distinct Branch_cd=sb_tag FROM dbo.b2b_crms_mimansa_status(@UserEmp_No)    
		where sb_tag >=@@From_Sub_Broker and  sb_tag <=@@TO_Sub_Broker    
end



create table #PartyDetails
(
Party_Code varchar(10),
Branch_cd varchar(20),
Emp_No varchar(10),
FromDate smalldatetime,
ToDate smalldatetime,
EbrokingClient char(1),
AngelClRating varchar(10)
)

print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where 
		ps.Branch_cd=aub.Branch_cd 
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		and ps.FromDate<=@@To_Date
		and ps.ToDate>=@@From_Date
		and ps.Emp_No>=@@From_Dealer
		and ps.Emp_No<=@@To_Dealer
end


--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
	print 'TradingMode or ClientGrade'
	if @TradingMode='ALL' 
		set @TradingMode='%' 
	else 
		set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
		
	if @ClientGrade='ALL' set @ClientGrade='%'
		--
			update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
			From angelclient1 ac1 with(nolock), #PartyDetails ps
			where 
			ac1.Party_Code=ps.Party_Code and 
			ac1.EbrokingClient like @TradingMode and 
			ac1.AngelClRating like @ClientGrade
		--

		delete #PartyDetails where isnull(EbrokingClient,'')=''	
	--
	end
	


select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	--dealer_Name,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	--Curr_option_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_Del_Opt) else 0 end,
	--Curr_option_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Del_opt) else 0 end
	
	into 
		#temp_client_data	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
	--on a1.sub_broker=a2.Sub_Broker  
	on a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
	
	where 
	--a1.sub_broker=a2.Branch_cd and --Comment by san
	--@@To_Sub_Broker<=a2.Branch_cd and
	--@@From_Dealer<=a2.emp_no and 
   -- @@To_Dealer>=a2.emp_no and
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 	

	--a1.party_code COLLATE DATABASE_DEFAULT =a2.Party_Code COLLATE DATABASE_DEFAULT
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
--select * from #PartyDetails where party_code='R14579'
--select * from #temp_client_data where party_code='R14579'
	print @@From_Date
	print @@To_Date

------------------------------------------------------------------------------------------------------
/* The Code is written for inserter 98 party code Turn over and Brokerage to table #temp_client_data*/
------------------------------------------------------------------------------------------------------

insert into  
		#temp_client_data	
select 
	 segment = 
		  (Case 
				When Company = 'ACDLFO'   Then 'NSEFO' 
				When Company  /*'ACPLNCDX'*/in ('ACPLNCDX','ACPLNCDEX') Then 'NCX' 
				When Company = 'ACPLMCX'  Then 'MCX' 
				When Company = 'ABLCM'    Then 'BSECM' 
				When Company = 'ACDLCM'   Then 'NSECM'
				When Company = 'ACDLNSX'  Then 'NSX'
				When Company = 'ACPLMCD'  Then 'MCD'
		        Else '---' 
		   End),
	Sub_broker=a2.branch_cd,
	b2b_dealer=a2.Emp_no,
	Sauda_date,
	party_code=a2.party_code,
	turnover=sum(turnover),
	brokerage=sum(brokerage),
	intra_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM' then sum(To_trd_Fut) else 0 end,
	intra_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Trd_Fut) else 0 end,
	delevary_turnover=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(To_Del_Opt) else 0 end,
	delevary_brokerage=CASE When Company = 'ABLCM' or Company = 'ACDLCM'  then sum(Bk_Del_opt) else 0 end, 
	
	Future_turnover=CASE When Company = 'ACDLFO'  then sum(To_trd_Fut) else 0 end,
	Future_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Trd_Fut) else 0 end,
	option_turnover=CASE When Company = 'ACDLFO'  then sum(To_Del_Opt) else 0 end,
	option_brokerage=CASE When Company = 'ACDLFO' then sum(Bk_Del_opt) else 0  end,
	
	Commodity_turnover=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(To_trd_Fut) else 0 end,
	Commodity_brokerage=CASE When Company = 'ACPLNCDX' or Company = 'ACPLMCX' or Company = 'ACPLNCDEX' then sum(Bk_Trd_Fut) else 0 end,
	
	Curr_Future_turnover=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(To_trd_Fut) else 0 end,
	Curr_Future_brokerage=CASE When Company = 'ACDLNSX' or Company = 'ACPLMCD' then sum(Bk_Trd_Fut) else 0 end
	
	from 
		bsedb_ab.dbo.mis_to a1 with(nolock) inner join #PartyDetails  a2 
		on a1.party_code COLLATE DATABASE_DEFAULT ='98'+a2.Party_Code
	where 
	sauda_Date>=@@From_Date and
	sauda_Date<=@@To_Date and
	sauda_Date>=FromDate and
	sauda_Date<=ToDate 
	
Group By Company,a2.Party_code,a2.branch_cd,Sauda_date,a2.emp_no--,dealer_Name 	
	
--select distinct party_code from #temp_client_data order by party_code
--select * from #PartyDetails 
--RETURN

	if @Main_Drill='MAIN' 
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer='',
				turnover=convert(decimal(20,0),sum(turnover)/1000),
				brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage)/1000  
			from 
				#temp_client_data
			group by sub_broker	
			--order by b2b_dealer
			
			select
				sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
				sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
		end
		if @@Report_Type= 'DEALER'
		begin
			select
				--segment,
				--party_code,
				Sub_broker,
				b2b_dealer,
				dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
				turnover=convert(decimal(20,0),sum(turnover)/1000),
				brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
			group by b2b_dealer,sub_broker	
			
			select
				sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
				sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
				sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
				sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
				sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
				sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
				sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
				sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
				sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
				
				sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
				
				sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000),
				sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
				--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000,
				--sum_Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
			from 
				#temp_client_data 
				
			
		end
	end
	if @Main_Drill= 'DRIL'
	begin
		if @@Report_Type= 'SUBBROKER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
					--segment,
						--Sub_broker,
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						turnover=convert(decimal(20,0),sum(turnover)/1000),
						intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						
						Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
										
						Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data
					--group by Sub_broker,party_code	
					group by party_code	
					order by party_code
					
					select
						sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
						sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
				
						sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
				
						sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
				end
				if(@Turn_Brok='BROK')
				begin
					select
						party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code) ,
						brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000 
					from 
						#temp_client_data
					group by party_code	
					order by party_code
					
					select
						sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
								
						sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
				end	
		end
		if @@Report_Type= 'DEALER'
		begin
				if(@Turn_Brok='TURN')
				begin
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						turnover=convert(decimal(20,0),sum(turnover)/1000),
						intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						
						Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
						
						Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_turnover=convert(decimal(20,0),sum(turnover)/1000),
						sum_intra_turnover=convert(decimal(20,0),sum(intra_turnover)/1000),
						sum_delevary_turnover=convert(decimal(20,0),sum(delevary_turnover)/1000),
						sum_Future_turnover=convert(decimal(20,0),sum(Future_turnover)/1000),
						sum_option_turnover=convert(decimal(20,0),sum(option_turnover)/1000),
						sum_Commodity_turnover=convert(decimal(20,0),sum(Commodity_turnover)/1000),
						sum_Curr_Future_turnover=convert(decimal(20,0),sum(Curr_Future_turnover)/1000)--,
						--sum_Curr_option_turnover=sum(Curr_option_turnover)/1000
					from 
						#temp_client_data 
					
				end	
				if(@Turn_Brok='BROK')
				begin
					print @Turn_Brok
					select
						Party_code,
						Party_name=(select short_name from angelclient1 with(nolock) where angelclient1.party_code=#temp_client_data.party_code),
						b2b_dealer,
						dealer_Name=(select emp_name from B2B_AngelHarmony with(nolock) where Emp_No=b2b_dealer),
						brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					group by Party_code,b2b_dealer		
					order by party_code
					
					select
						sum_brokerage=convert(decimal(20,0),sum(brokerage)),--/1000),
						sum_intra_brokerage=convert(decimal(20,0),sum(intra_brokerage)),--/1000),
						sum_delevary_brokerage=convert(decimal(20,0),sum(delevary_brokerage)),--/1000), 
						sum_Future_brokerage=convert(decimal(20,0),sum(Future_brokerage)),--/1000),
						sum_option_brokerage=convert(decimal(20,0),sum(option_brokerage)),--/1000),
						
						sum_Commodity_brokerage=convert(decimal(20,0),sum(Commodity_brokerage)),--/1000),
						
						sum_Curr_Future_brokerage=convert(decimal(20,0),sum(Curr_Future_brokerage))--/1000)--,
						--tot_Curr_option_brokerage=sum(Curr_option_brokerage) /1000
					from 
						#temp_client_data 
					
					
				end
		end
	end	
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_Common_Dashboard
-- --------------------------------------------------
CREATE procedure [dbo].[B2bCrms_Common_Dashboard]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(20),--SUBBROKER/SBDEALER
	@Statusname varchar(20),
	@Sub_Broker varchar(10),
	@Dealer varchar(20)
)
as
begin
	--exec B2bCrms_Common_Dashboard 'Et001','SUBBROKER','ET','ET',''
	--exec B2bCrms_Common_Dashboard 'EtA001','SUBBROKER','ETA','ETA',''
	--exec B2bCrms_Common_Dashboard 'Et001','SUBROKER','ET','ETT','' with recompile
	--exec B2bCrms_Common_Dashboard 'ETA002','SBDEALER','ETA','','ETA002'

	print 'Start:' + convert(varchar,getdate(),109)
	print '---------------------------------------------------------------'
	
	declare @@date varchar(11)
	set @@date=left(DATEADD(dd, -DAY(getdate()) + 1, getdate()),11)
	
	--select @@date
	
	print 'Start of Emp Status:' + convert(varchar,getdate(),109)
	print '---------------------------------------------------------------'
	
	exec getEmpStatus @EMP_No= @UserEmp_No
	
	print 'End of Emp Status:' + convert(varchar,getdate(),109)
	print '---------------------------------------------------------------'

	print 'Start of TaVsAC_Timer:' + convert(varchar,getdate(),109)
	print '---------------------------------------------------------------'
	
	--exec B2bCrms_DashBoard_TaVsAC_Timer @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer
	
	exec B2bCrms_DashBoard_TaVsAC_Timer_vol1 @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer
	print 'End of TaVsAC_Timer:' + convert(varchar,getdate(),109)
	print '---------------------------------------------------------------'
	
	print 'Start of Productivity:' + convert(varchar,getdate(),109)
	print '---------------------------------------------------------------'
			
	exec B2bCrms_DashBoard_productivity @UserEmp_No=@UserEmp_No,@UserStatusId=@UserStatusId,@Sub_Broker=@Sub_Broker,@Dealer=@Dealer,
	@TradingMode='ALL',@ClientGrade='ALL', @SegmentType='ALL',@FromDate=@@date,@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''
	
	print 'End of Productivity:' + convert(varchar,getdate(),109)
	print '---------------------------------------------------------------'
	
	print 'Start of client_Statistics:' + convert(varchar,getdate(),109)
	print '---------------------------------------------------------------'
	
	exec b2bcrms_dashboard_client_Statistics_vol1 @UserEmp_No=@UserEmp_No,@UserStatusId=@UserStatusId,@Sub_Broker=@Sub_Broker,@Dealer=@Dealer,
	@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',@FromDate=@@date,@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''
	
	print 'End of client_Statistics:' + convert(varchar,getdate(),109)
	print '---------------------------------------------------------------'

	--exec B2bCrms_DashBoard_TargetTurnover @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer
	if(@UserStatusId='SUBBROKER')
	begin
	exec B2bDashBoard_CallMadeToClients @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker
	end
	
	print 'End:' + convert(varchar,getdate(),109)
	print '---------------------------------------------------------------'
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_Common_Dashboard_bak1
-- --------------------------------------------------

CREATE procedure [dbo].[B2bCrms_Common_Dashboard_bak1]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(20),--SUBBROKER/SBDEALER
	@Statusname varchar(20),
	@Sub_Broker varchar(10),
	@Dealer varchar(20)
)
as
begin

	--exec [B2bCrms_Common_Dashboard_bak1] 'Et001','SUBBROKER','ET','ET',''
	--exec B2bCrms_Common_Dashboard 'EtA001','SUBBROKER','ETA','ETA',''
	--exec B2bCrms_Common_Dashboard 'Et001','SUBROKER','ET','ETT','' with recompile
	--exec B2bCrms_Common_Dashboard_bak1 'ETA002','SBDEALER','ETA','','ETA002'

	
	declare @@date varchar(11)
	set @@date=left(DATEADD(dd, -DAY(getdate()) + 1, getdate()),11)
	
	--select @@date
	
	insert into B2bcrms_tracetimeoutissue
		(UserEmp_No,UserStatusId,Statusname,Sub_Broker,Dealer,dateinput,REMARK) 
	select @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer,@@date,'getEmpStatus' 
	
	exec getEmpStatus @EMP_No= @UserEmp_No
	
	
	insert into B2bcrms_tracetimeoutissue
		(UserEmp_No,UserStatusId,Statusname,Sub_Broker,Dealer,dateinput,REMARK)
	select @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer,@@date,'B2bCrms_DashBoard_productivity' 
			
	exec B2bCrms_DashBoard_productivity @UserEmp_No=@UserEmp_No,@UserStatusId=@UserStatusId,@Sub_Broker=@Sub_Broker,@Dealer=@Dealer,
	@TradingMode='ALL',@ClientGrade='ALL', @SegmentType='ALL',@FromDate=@@date,@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''
	
	insert into B2bcrms_tracetimeoutissue
		(UserEmp_No,UserStatusId,Statusname,Sub_Broker,Dealer,dateinput,REMARK)
	select @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer,@@date,'b2bcrms_dashboard_client_Statistics_vol1' 

	exec b2bcrms_dashboard_client_Statistics_vol1 @UserEmp_No=@UserEmp_No,@UserStatusId=@UserStatusId,@Sub_Broker=@Sub_Broker,@Dealer=@Dealer,
	@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',@FromDate=@@date,@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''
	
	
	

	if(@UserStatusId='SUBBROKER')
	begin
	insert into B2bcrms_tracetimeoutissue
		(UserEmp_No,UserStatusId,Statusname,Sub_Broker,Dealer,dateinput,REMARK)
	select @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer,@@date,'B2bDashBoard_CallMadeToClients' 
		/*Added on 2 Apr 2014*/
		BEGIN TRY  
			exec B2bDashBoard_CallMadeToClients @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker
		END TRY
		BEGIN CATCH     
				select emp_no='',Emp_First_Name='',	Emp_Name='',No_of_Clients_Alert_Generated_for='',No_of_Clients_Marked_Success=''
				where 1=0
				insert into B2bcrms_tracetimeoutissue(UserEmp_No,UserStatusId,Statusname,Sub_Broker,Dealer,dateinput,REMARK)
				select @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer,@@date,'B2bDashBoard_CallMadeToClients_ERROR'
		END CATCH
		/*****************************/
	end
	else
	begin
		select 'DUMY for .net codeing'
	end
	
	--exec B2bCrms_DashBoard_TaVsAC_Timer @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer
	insert into B2bcrms_tracetimeoutissue
		(UserEmp_No,UserStatusId,Statusname,Sub_Broker,Dealer,dateinput,REMARK)
	select @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer,@@date,'B2bCrms_DashBoard_TaVsAC_Timer_vol1' 

	exec B2bCrms_DashBoard_TaVsAC_Timer_vol1 @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer
	

	insert into B2bcrms_tracetimeoutissue
		(UserEmp_No,UserStatusId,Statusname,Sub_Broker,Dealer,dateinput,REMARK)
	select @UserEmp_No,@UserStatusId,@Statusname,@Sub_Broker,@Dealer,@@date,'END' 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard
-- --------------------------------------------------


CREATE procedure [dbo].[B2bCrms_DashBoard]

(

	@UserEmp_No varchar(20),

	@UserStatusId varchar(20),--SUBBROKER/SBDEALER

	@Statusname varchar(20),

	@Sub_Broker varchar(10),

	@Dealer varchar(20),

	@Report_Type varchar(20)

)

as

begin

	/*

		exec B2bCrms_DashBoard 'et001','SUBBROKER','','ET','','Graph1'

		exec B2bCrms_DashBoard 'etA001','SUBBROKER','','ETA','','Graph1'

		exec B2bCrms_DashBoard 'ett001','SUBBROKER','','ETT','','Graph1'

		exec B2bCrms_DashBoard 'Ca001','SUBBROKER','','CA','','Graph1'

		exec B2bCrms_DashBoard 'etA001','SUBBROKER','','ETA','','Graph1'

		exec B2bCrms_DashBoard 'et001','SUBBROKER','','ET','','Graph2'

		exec B2bCrms_DashBoard 'eta008','SBDEALER','','','ETA008','Graph2'

		exec B2bCrms_DashBoard 'eta008','SBDEALER','','','ETA008','Graph1'

		exec B2bCrms_DashBoard 'eta007','SBDEALER','','','ETA007','Graph1'

		exec B2bCrms_DashBoard 'ETA007','SBDEALER','','','ETA007','GRAPH1'

	*/

	--WAITFOR DELAY '00:01:05'

	print 'Start:'+convert(varchar,getdate(),109)

	

	

	Declare @ToDate smalldatetime

	Declare @FromDate smalldatetime

	

	Declare @FromSub_Broker varchar(10)

	Declare @ToSub_Broker varchar(10)

	Declare @FromDealer varchar(10)

	Declare @ToDealer varchar(10)

	Declare @FromEffSaudaDate datetime

	Declare @ToEffSaudaDate datetime

	Declare @SegmentTypeFrom varchar(10)

	Declare @SegmentTypeTo varchar(10)

	Declare @TradingMode varchar(20)

    Declare @ClientGrade varchar(20)

    Declare @TradeDays int

    DECLARE @@Errorcount int                                                                                 

	

	SET @@Errorcount = 0 

 

	set @SegmentTypeFrom ='0000'

	set @SegmentTypeTo ='ZZZZZ'

	

	set @TradingMode='%'

	set @ClientGrade='%'

	

	

	set @FromDate=left(CONVERT(smalldatetime,DATEADD(dd,-(DAY(GETDATE())-1),getdate())),11)+' 00:00'

	set @ToDate=left(CONVERT(smalldatetime,GETDATE()),11)+' 00:00'



	--print @FromDate

	--print @ToDate

	

	select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=GETDATE() 

	from (select top 15 Sauda_date=Sauda_date from TABLE_DATE where CMTradingDay='y'  and date<getdate()  order by date desc)a

	 

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromEffSaudaDate and sauda_date <= @ToEffSaudaDate and CurrTradingDay = 'Y'

	 

	/**subbroker*/

	if @Sub_Broker='' or @Sub_Broker='ALL' 

	Begin

		set @FromSub_Broker='A'

		set @ToSub_Broker='ZZZZZZZ'

	End

	else

	Begin

		Set @FromSub_Broker=@Sub_Broker

		Set @ToSub_Broker=@Sub_Broker

	End

	

	if @Dealer='' or @Dealer='ALL' 

	begin

		set @FromDealer='A'

		set @ToDealer='ZZZZZZZ'

	end

	else

	begin

		set @FromDealer=@Dealer

		set @ToDealer=@Dealer

	end

	

	create table #PartyDetails 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime

	,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

	--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

	)

	

	declare @BrokTurnOver table

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),

	TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

	NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

	Sauda_date smalldatetime

	)

	

	

	--------------------------User Access---------------------------------------------------



	/*fill subbrokers and dealers*/

	declare @tempbranch  table                                                                

	(                                                                

	Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

	)

	

	Insert into @tempbranch

	select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

	

--select * from @BrokTurnOver where Emp_No='et001' and party_code='A10095' order by Party_Code



	



	if(upper(@Report_Type)='GRAPH1')

	begin

	Print 'GRAPH1'

	print '1.1.START.GRAPH1:'+convert(varchar,getdate(),109)

		

		Declare  @MIStable table                                                          

		 (                                                          

		 Branch_cd varchar(20),

		 Emp_No varchar(20),  

		 Emp_Name varchar(100),

		 TotalClientsStartOfmonth int,

		 TotalClientsAsonDate int, Tradedclients int, 

		 OnlineTurnover money, OfflineTurnover money,

		 OnlineBrok money, OfflineBrok money,

		 OnlineNetRevnue money, OfflineNetRevnue money,

		 NetBrokeToSb money,

		 Productivity varchar(10),

		 DailyTradedClients_AR int,

		 ActivationRatio varchar(10),

		 AvgRevPerClient money,

		 ClientNotTradedForMonth int, 

		 ClientNotTradedAsOnDate int 

		 )      

		

		if(	@UserStatusId='SBDEALER')

		begin

			print @UserStatusId

			 declare @sb_tag varchar(20)

			 declare @sb_admin varchar(20)

			 

			 declare @productivity money

			 declare @DealerAverage money

			 

			 select @sb_tag=sb_tag from B2B_AngelHarmony where emp_no=@Dealer

			 select @sb_admin=emp_no from B2B_AngelHarmony where sb_tag=@sb_tag and isAdmin='1'

			 

			 --select @sb_tag

			 --select @sb_admin

			 

			 delete from @MIStable

			 

			 insert into @MIStable

			 exec [SBB2B_MIS] @UserEmp_No=@sb_admin,@UserStatusId='SUBBROKER',@Sub_Broker=@sb_tag,@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

			 @SegmentType='ALL',@FromDate=@FromDate,@Wise='DEALER',@ReportType='MAIN',@DrillFlag='',@TotalFlag='Y'

			 

			 insert into @MIStable

			 exec [SBB2B_MIS] @UserEmp_No=@UserEmp_No,@UserStatusId='SBDEALER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

			 @SegmentType='ALL',@FromDate=@FromDate,@Wise='DEALER',@ReportType='MAIN',@DrillFlag='',@TotalFlag='Y'

			 

			 select @productivity=productivity from @MIStable where Emp_No=@Dealer

			 

			 select 

				@DealerAverage=convert(decimal(10,2),sum(NetBrokeToSb)/SUM(emp.ctc))

			 from 

				B2B_AngelHarmony emp ,@MIStable mis

			 where

				emp.Emp_No = mis.emp_no

				and mis.emp_no <> @Dealer

				--and emp.Status='A'

				and Emp.isadmin<>'1'

			 group by emp.sb_tag	

			 

			 select emp_no=@Dealer,productivity=@productivity

			 union all

			 select 'DealerAverage',productivity=isnull(@DealerAverage,0)

		end				

		if(	@UserStatusId='SUBBROKER')

		begin

			 

			 --print @UserStatusId

			 --print @FromDate

			 --print @UserEmp_No

			 --print @UserStatusId

			 --print @Sub_Broker

			 --print @Dealer

			 --print 'prasanna'

			

			 print '1.2.START.SUBBROKER:'+convert(varchar,getdate(),109)

			

			 insert into @MIStable

			 exec [SBB2B_MIS_bak] @UserEmp_No=@UserEmp_No,@UserStatusId=@UserStatusId,@Sub_Broker=@Sub_Broker,@Dealer=@Dealer,@TradingMode='ALL',@ClientGrade='ALL',

			 @SegmentType='ALL',@FromDate=@FromDate,@Wise='DEALER',@ReportType='MAIN',@DrillFlag='',@TotalFlag='Y',@GraphData='SBGRAPH1'		

						

			-- select 

			--	sb_tag=Branch_cd,

			--	emp_no=Emp_No,

			--	NetRevenue=NetBrokeToSb/100000,

			--	Productivity= case when Productivity ='NA' then 0.00 else Productivity end 

			--from 

			--	@MIStable

				

			select 

				sb_tag=Branch_cd,

				emp_no=Emp_No,

				NetRevenue=Convert(Decimal(10,2),NetBrokeToSb/100000),

				Productivity= convert(decimal(10,2),case when Productivity ='NA' then 0.00 else cast(Productivity as money) end ) 

			from 

				@MIStable	

		end

		

	 

	end	

	

	if(upper(@Report_Type)='GRAPH2')

	begin

	

	Print 'GRAPH2'

	

	

	print '2.1. Party Details Process Start:'+convert(varchar,getdate(),109)

	

	insert into 

		#PartyDetails 

		(Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

	select

		ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

	from 

		B2B_CommonPartyServices ps with(nolock),@tempbranch aub

	where 

		ps.Branch_cd=aub.Branch_cd 

		and ps.FromDate<=@ToEffSaudaDate

		and ps.ToDate>=@FromEffSaudaDate

	

	update 

		#PartyDetails 

	set 

		EbrokingClient=ac1.EbrokingClient,

		AngelClRating=ac1.AngelClRating

	From 

		angelclient1 ac1 with(nolock),#PartyDetails ps

	where 

		ac1.Party_Code=ps.Party_Code and 

		ac1.EbrokingClient like @TradingMode

		and ac1.AngelClRating like @ClientGrade

	

	delete #PartyDetails where isnull(EbrokingClient,'')=''

	

	print '2.1. Party Details Process Ends:'+convert(varchar,getdate(),109)

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

	

	select 

		ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

	into 

		#ActivarionRatio	

	from 

		#PartyDetails ps

	where 

		ps.FromDate<=@ToEffSaudaDate

		and ps.ToDate>=@ToEffSaudaDate		

	group by 

		ps.Branch_cd,ps.Emp_No

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)	

	



	

	insert into @BrokTurnOver

	(

		Party_Code,

		Branch_cd,

		Emp_No, 

		TotalTurnover,

		NetRevenue,

		Sauda_date 

		)

		select 

		ps.Party_Code,

		ps.Branch_cd,

		ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		--Online_TurnOver=L.ebrok_TurnOver,

		--Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		--GrossRevenue=L.Overall_brok_earned,

		--GrossRevenue_Online=L.ebrok_brok_earned,

		--GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		--NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,		

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock)--, TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		AND EM.FromDate <= @FromEffSaudaDate 

		AND EM.ToDate >= @ToEffSaudaDate 

		and ps.FromDate<=L.sauda_date 

		and ps.ToDate>=L.sauda_date

		and L.Sauda_date>= @FromEffSaudaDate 

		and L.Sauda_date<= @ToEffSaudaDate 

	

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)

	--select * from @BrokTurnOver

	--return

	

	print '2.4. RTO in process check Starts:'+convert(varchar,getdate(),109)		

	

	declare @@MSG varchar(200)                  

	set @@MSG='Report is in process. Please wait for few minutes.'                    

	if (select Processon from [MIMANSA].crm.dbo.Tbl_tradingdataupprocess with(nolock)) = 'Y'                    

	begin                    

		select msg=@@MSG                  

		return                    

	end 

	

	print '2.4. RTO in process check End:'+convert(varchar,getdate(),109)	

	

	if(@UserStatusId='SUBBROKER')

	begin

	

			print '2.5. RTO Data Fetch Start:'+convert(varchar,getdate(),109)		

			print '-------------------------------------------------------------------------------'

			

			declare @rto_Data table(

			Zone varchar(20),Region varchar(20),branch_cd varchar(20),B2BRM varchar(20),B2BRM_Name varchar(100),emp_no varchar(20),emp_name varchar(100),                                    

							ActiveCLEq money,ActiveCLComm money, ActiveCLCurr money,                                

							TOToTimeCash money,

							TOToTimeFUT money ,

							TOToTimeOPT money  ,

							TOToTimeComm money ,

							TOToTimeCurr money ,                                  

							CLToTimeCash money,

							CLToTimeFUT money,

							CLToTimeOPT money,

							CLToTimeComm money,

							CLToTimeCURR money,                    

							TotalTO money,

							TotalCL money,

							Optnooflots bigint

			)	

			

			insert into @rto_Data

			---exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch=@Sub_Broker,

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='MAIN',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID=@UserStatusId,

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'

			

			set @@Errorcount = @@error                                                                  

			If @@Errorcount <> 0 Goto LabelEnd        



			print '-------------------------------------------------------------------------------'

			print '2.5. RTO Data Fetch End:'+convert(varchar,getdate(),109)		

			

			print '2.6. Output Data Start:'+convert(varchar,getdate(),109)	

			



			

			declare @tempDashboardData table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money

			)

			

			insert into @tempDashboardData

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0

				

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			---------------------------------------------------

			--select * from @tempDashboardData

			

			--update @tempDashboardData set ctc=c.CTC

			--from @tempDashboardData emp ,vw_tbl_EmployeeView c 

			--where emp.Emp_No = c.emp_no

			

			update @tempDashboardData set ctc=c.CTC

			from @tempDashboardData emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

			--select 

			--	emp_no=emp.emp_no,

			--	emp.ctc,

			--	sauda_date,

			--	brokerage=cast(sum(NetRevenue) as decimal(20,10)),

			--	turnover=sum(TotalTurnover)

			

			--from 

			--	@tempDashboardData emp inner join @BrokTurnOver b  on emp.Emp_No=b.Emp_No

			--group by emp.emp_no	,sauda_date, emp.ctc

			

			

						

			update @tempDashboardData set TargetTurnover= a.TargetTurnover

			from @tempDashboardData emp1,(

			select 

				emp_no=emp.emp_no,

				--TargetTurnover =cast((12*emp.ctc) as money)/(sum(NetRevenue)/sum(TotalTurnover))

				TargetTurnover =cast((12*emp.ctc) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))

			

			from 

				@tempDashboardData emp inner join @BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no	,  emp.ctc

			)a

			where emp1.emp_no =a.emp_no

			

			

							

			update @tempDashboardData set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData set ClientBase=isnull((TotalClientsAsonDate),0)

			from @tempDashboardData emp ,#ActivarionRatio d 

			where emp.Emp_No = d.emp_no

			

			

			

			select 

			sb_tag,

				emp_no,

				TargetTurnover=Case when TargetTurnover>0 then CONVERT(decimal(10,0),TargetTurnover/100000) else 0 end,

				ActualAchivedTO=CONVERT(decimal(10,0),ActualAchivedTO/100000),

				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

				ClientBase = CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,2),(ActualAchivedTO/TargetTurnover)*100) else 0 end

			from @tempDashboardData order by emp_no 

			

			print '2.7. Output Data End:'+convert(varchar,getdate(),109)	

			

	print '1.5.END.:'+convert(varchar,getdate(),109)

			 

	end

	else

	begin

		print 'DEALER'

		declare @sb_tag1 varchar(20)

		declare @sb_admin1 varchar(20)

		

		select @sb_tag1=sb_tag from B2B_AngelHarmony where emp_no=@Dealer

		select @sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@sb_tag1 and isAdmin='1'

		

		insert into @rto_Data

		--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

		exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

		@Emp_no=@sb_admin1,

		@Zone='',

		@Region='',

		@Branch=@sb_tag1,

		@Exec='',

		@FromTime='09:00 AM',

		@ToTime='11:59 PM',

		@MainDrill='MAIN',

		@WiseReport='SBDEALER',

		@seg='ALL',

		@B2CStatus='B2B',

		@MimStatusID='SUBBROKER',

		@SB='',

		@RoundValue='1',

		@DownloadCSVFlag='Y'	

		

		set @@Errorcount = @@error                                                                  

		If @@Errorcount <> 0 Goto LabelEnd        

	

	declare @tempDashboardData1 table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money,

				status varchar(10)

			)

			

			insert into @tempDashboardData1

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc,

				status

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0,

				status=0

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			

			update @tempDashboardData1 set ctc=c.CTC,status=isAdmin

			from @tempDashboardData1 emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData1 set TargetTurnover= a.TargetTurnover

			from @tempDashboardData1 emp1,(

			select 

				emp_no=emp.emp_no,

				TargetTurnover =cast((12*emp.ctc) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))

			

			from 

				@tempDashboardData1 emp inner join @BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no,emp.ctc	  

			)a

			where emp1.emp_no =a.emp_no

			

			update @tempDashboardData1 set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData1 emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData1 set ClientBase=isnull((TotalClientsAsonDate),0)

			from @tempDashboardData1 emp ,#ActivarionRatio d 

			where emp.Emp_No = d.emp_no

			

			select 

			sb_tag,

				emp_no,

				TargetTurnover=CONVERT(decimal(10,0),TargetTurnover/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),ActualAchivedTO/100000),

				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

				ClientBase = CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,2),(ActualAchivedTO/TargetTurnover)*100) else 0 end

			from @tempDashboardData1 

			where emp_no=@dealer

			union all

			

			select 

				sb_tag,

				emp_no='DealerAverage',

				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),

				Activation_Ratio=sum(Activation_Ratio),

				ClientsTraded=sum(ClientsTraded ),

				ClientBase=sum(ClientBase) ,

				PercentageTurnoverAchievedTillTime=SUM(PercentageTurnoverAchievedTillTime)

				from  (

						select 

							sb_tag,

							emp_no,

							TargetTurnover,

							ActualAchivedTO,

							Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

							ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

							ClientBase = CONVERT(decimal(10,0),ClientBase),

							PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,2),(ActualAchivedTO/TargetTurnover)*100) else 0 end

						from @tempDashboardData1 

						where emp_no<>@dealer

				)a

				group by a.sb_tag

		

	

	--select 

	--sb_tag,

	--	emp_no,

	--	TargetTurnover,

	--	ActualAchivedTO,

	--	Activation_Ratio,

	--	ClientsTraded ,

	--	ClientBase ,

	--	PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,2),(ActualAchivedTO/TargetTurnover)*100) else 0 end 

	--from(

	--select 

	--	sb_tag=emp.sb_tag,

	--	emp_no=emp.emp_no,

	--	TargetTurnover=isnull(convert(decimal(30,2),((12*emp.ctc)/(sum(NetRevenue)/sum(TotalTurnover)))),0),

	--	ActualAchivedTO=isnull(sum(TotalTO),0),

	--	Activation_Ratio=(sum(TotalCL)/sum(TotalClientsAsonDate))*100,

	--	ClientsTraded =convert(decimal(10,0),sum(TotalCL)),

	--	ClientBase =sum(TotalClientsAsonDate)

		

	--from 

		

	--	vw_tbl_EmployeeView emp left outer join @BrokTurnOver b  on emp.Emp_No=b.Emp_No  , @rto_Data c ,#ActivarionRatio d

	--where

		

	--	emp.Emp_No = c.emp_no

	--	and emp.Emp_no=d.Emp_No

	--	and emp.Emp_No=@dealer

	--	and emp.Status='A'

	-- group by emp.sb_tag,emp.Emp_No,emp.CTC	

	-- )a

	--union all 

	--select 

	--sb_tag,

	--	emp_no='DealerAverage',

	--	TargetTurnover=sum(TargetTurnover),

	--	ActualAchivedTO=sum(ActualAchivedTO),

	--	Activation_Ratio=sum(Activation_Ratio),

	--	ClientsTraded=sum(ClientsTraded ),

	--	ClientBase=sum(ClientBase) ,

	--	PercentageTurnoverAchievedTillTime=case when sum(TargetTurnover)>0 and sum(ActualAchivedTO)>0 then convert(decimal(10,2),(sum(ActualAchivedTO)/sum(TargetTurnover))*100) else 0 end 

	--from(

	--select 

	--	sb_tag=emp.sb_tag,

	--	emp_no=emp.emp_no,

	--	TargetTurnover=isnull(convert(decimal(30,2),((12*emp.ctc)/(sum(NetRevenue)/sum(TotalTurnover)))),0),

	--	ActualAchivedTO=isnull(sum(TotalTO),0),

	--	Activation_Ratio=(sum(TotalCL)/sum(TotalClientsAsonDate))*100,

	--	ClientsTraded =convert(decimal(10,0),sum(TotalCL)),

	--	ClientBase =sum(TotalClientsAsonDate)

		

	--from 

		

	--	vw_tbl_EmployeeView emp left outer join @BrokTurnOver b  on emp.Emp_No=b.Emp_No  , @rto_Data c ,#ActivarionRatio d

	--where

		

	--	  emp.Emp_No = c.emp_no

	--	and emp.Emp_no=d.Emp_No

	--	and emp.Emp_No <> @dealer

	--	and emp.Status='A'

	-- group by emp.sb_tag,emp.Emp_No,emp.CTC	

	-- )a

	-- group by a.sb_tag--,a.Emp_No

	 	 

	end

		LabelEnd:                                                      

		If @@Errorcount <> 0

		begin

			set @@MSG='Report is in process. Please wait for few minutes.'                    

			select msg=@@MSG   

		end	

	end			

		

   

 			

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_bak
-- --------------------------------------------------
CREATE procedure [dbo].[B2bCrms_DashBoard_bak]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(20),--SUBBROKER/SBDEALER
	@Statusname varchar(20),
	@Sub_Broker varchar(10),
	@Dealer varchar(20),
	@Report_Type varchar(20)
)
as
begin
	/*
		exec B2bCrms_DashBoard_bak 'et001','SUBBROKER','','ET','','Graph1'
		exec B2bCrms_DashBoard 'et001','SUBBROKER','','ET','','Graph1'
		exec B2bCrms_DashBoard_bak 'et001','SUBBROKER','','ET','','Graph2'
		exec B2bCrms_DashBoard 'eta008','SBDEALER','','','ETA008','Graph2'
		exec B2bCrms_DashBoard 'eta008','SBDEALER','','','ETA008','Graph1'
		exec B2bCrms_DashBoard_bak 'eta008','SBDEALER','','','ETA008','Graph1'
		exec B2bCrms_DashBoard 'ETA007','SBDEALER','','','ETA007','GRAPH1'
	*/
	
	Declare @ToDate smalldatetime
	Declare @FromDate smalldatetime
	
	Declare @FromSub_Broker varchar(10)
	Declare @ToSub_Broker varchar(10)
	Declare @FromDealer varchar(10)
	Declare @ToDealer varchar(10)
	Declare @FromEffSaudaDate datetime
	Declare @ToEffSaudaDate datetime
	Declare @SegmentTypeFrom varchar(10)
	Declare @SegmentTypeTo varchar(10)
	Declare @TradingMode varchar(20)
    Declare @ClientGrade varchar(20)
    Declare @TradeDays money
 
	set @SegmentTypeFrom ='0000'
	set @SegmentTypeTo ='ZZZZZ'
	
	set @TradingMode='%'
	set @ClientGrade='%'
	
	
	set @FromDate=left(CONVERT(smalldatetime,DATEADD(dd,-(DAY(GETDATE())-1),getdate())),11)+' 00:00'
	set @ToDate=left(CONVERT(smalldatetime,GETDATE()),11)+' 00:00'
	

	
	select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=GETDATE() 
	from (select top 15 Sauda_date=Sauda_date from TABLE_DATE with(nolock) where CMTradingDay='y'  and date<getdate()  order by date desc)a
	 
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromEffSaudaDate and sauda_date <= @ToEffSaudaDate and CurrTradingDay = 'Y'
	
	
	
	
	/**subbroker*/
	if @Sub_Broker='' or @Sub_Broker='ALL' 
	Begin
		set @FromSub_Broker='A'
		set @ToSub_Broker='ZZZZZZZ'
	End
	else
	Begin
		Set @FromSub_Broker=@Sub_Broker
		Set @ToSub_Broker=@Sub_Broker
	End
	
	if @Dealer='' or @Dealer='ALL' 
	begin
		set @FromDealer='A'
		set @ToDealer='ZZZZZZZ'
	end
	else
	begin
		set @FromDealer=@Dealer
		set @ToDealer=@Dealer
	end
	
	create table #PartyDetails 
	(
		Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime
		,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
	)
	
	declare @BrokTurnOver table
	(
	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),
	TotalTurnOver money,
	--Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
	NetRevenue money,
	--NetRevenue_Online money,NetRevenue_Offline money,
	Sauda_date smalldatetime
	)
	
	
	--------------------------User Access---------------------------------------------------

	/*fill subbrokers and dealers*/
	declare @tempbranch  table                                                                
	(                                                                
		Branch_cd varchar(20)                                                                                                             
	)
	
	Insert into @tempbranch
	select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

	if(upper(@Report_Type)='GRAPH1')
	begin
	Print 'GRAPH1'
	
		
		Declare  @MIStable table                                                          
		 (                                                          
		 Branch_cd varchar(20),
		 Emp_No varchar(20),  
		 Emp_Name varchar(100),
		 TotalClientsStartOfmonth int,
		 TotalClientsAsonDate int, Tradedclients int, 
		 OnlineTurnover money, OfflineTurnover money,
		 OnlineBrok money, OfflineBrok money,
		 OnlineNetRevnue money, OfflineNetRevnue money,
		 NetBrokeToSb money,
		 Productivity varchar(10),
		 DailyTradedClients_AR int,
		 ActivationRatio varchar(10),
		 AvgRevPerClient money,
		 ClientNotTradedForMonth int, 
		 ClientNotTradedAsOnDate int 
		 )      
		
		if(	@UserStatusId='SBDEALER')
		begin
			print @UserStatusId
			 declare @sb_tag varchar(20)
			 declare @sb_admin varchar(20)
			 
			 declare @productivity money
			 declare @DealerAverage money
			 
			 select @sb_tag=sb_tag from B2B_AngelHarmony where emp_no=@Dealer
			 select @sb_admin=emp_no from B2B_AngelHarmony where sb_tag=@sb_tag and isAdmin='1'
			 			 			 
			 --insert into @MIStable
			 exec [SBB2B_MIS] @UserEmp_No=@sb_admin,@UserStatusId='SUBBROKER',@Sub_Broker=@sb_tag,@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
			 @SegmentType='ALL',@FromDate=@FromDate,@Wise='DEALER',@ReportType='MAIN',@DrillFlag='',@TotalFlag='Y'
			 
			
			
			 insert into @MIStable
			 exec [SBB2B_MIS] @UserEmp_No=@UserEmp_No,@UserStatusId='SBDEALER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
			 @SegmentType='ALL',@FromDate=@FromDate,@Wise='DEALER',@ReportType='MAIN',@DrillFlag='',@TotalFlag='Y'
			 
			 select @productivity=isnull(productivity,0) from @MIStable where Emp_No=@Dealer
			 
			 select 
				@DealerAverage=convert(decimal(10,2),sum(NetBrokeToSb)/SUM(emp.ctc))
			 from 
				B2B_AngelHarmony emp ,@MIStable mis
			 where
				emp.Emp_No = mis.emp_no
				and mis.emp_no <> @Dealer
				--and emp.Status='A'
				and Emp.isadmin<>'1'
			 group by emp.sb_tag	
			 
			 select emp_no=@Dealer,productivity=@productivity
			 union all
			 select 'DealerAverage',productivity=isnull(@DealerAverage,0)
		end				
		if(	@UserStatusId='SUBBROKER')
		begin
			 
			print '1.1. Party Details Process Start:'+convert(varchar,getdate(),109)
			
			set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
			set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'

			 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
			from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
			
				 
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
			
			insert into 
				#PartyDetails 
				(Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
			select
				ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
			from 
				B2B_CommonPartyServices ps with(nolock),@tempbranch aub
			where 
				ps.Branch_cd=aub.Branch_cd 
				and ps.FromDate<=@ToEffSaudaDate
				and ps.ToDate>=@FromEffSaudaDate
			
			update 
				#PartyDetails 
			set 
				EbrokingClient=ac1.EbrokingClient,
				AngelClRating=ac1.AngelClRating
			From 
				angelclient1 ac1 with(nolock),#PartyDetails ps
			where 
				ac1.Party_Code=ps.Party_Code and 
				ac1.EbrokingClient like @TradingMode
				and ac1.AngelClRating like @ClientGrade
			
			delete #PartyDetails where isnull(EbrokingClient,'')=''
			
			--select * from #PartyDetails
			
			print '1.1. Party Details Process Ends:'+convert(varchar,getdate(),109)
			print '1.2. GrossRevenue Process starts:'+convert(varchar,getdate(),109)
			
			
			--insert into @BrokTurnOver	
			select 
				ps.Party_Code,
				ps.Branch_cd,
				ps.Emp_No, 
				GrossRevenue=L.Overall_brok_earned,
				NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
				NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
				L.Sauda_date  
			into #BrokTurnOver		
			from 
				#PartyDetails ps ,
				Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
				B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
			where 
				EM.Segment_Type>=@SegmentTypeFrom and 	
				EM.Segment_Type<=@SegmentTypeTo and
				EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
				When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
				When L.Segment = 'ABLCM' Then 'BSECM'   
				When L.Segment = 'ACDLCM' Then 'NSECM'   
				When L.Segment = 'ACDLFO' Then 'NSEFO'   
				When L.Segment = 'ACPLMCD' Then 'MCD'  
				When L.Segment = 'ACDLNSX' Then 'NSX' End) and
				ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS
				and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date 
				and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		
				AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate 
				and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate 
				and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
			
		
			insert into @MIStable
			(
				Branch_cd, 
				Emp_No, 
				NetBrokeToSb, 
				Productivity,
				Brokerage 
			)
			select 
				Branch_cd,
				Emp_No,
				NetBrokeToSb=0,
				Productivity=0,
				Brokerage=0			
			from #PartyDetails		
			group by Branch_cd,Emp_No
			
			update 
				@MIStable
			set
				NetBrokeToSb =b1.NetBrokeToSb
			from
			(	
		 		select 
					Branch_cd,
					Emp_No,
					NetBrokeToSb=(sum(NetRevenue_Online)+sum(NetRevenue_Offline))
				from  
					#BrokTurnOver 
				group by 
					Branch_cd,Emp_No
			)b1, @MIStable A
			where 
				A.emp_no=b1.Emp_no
				and A.Branch_cd=b1.Branch_cd
			
				
			update @MIStable set Brokerage=A.GrossBrok
			from 
			(
			select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue)   
				from #BrokTurnOver b
			group by b.Branch_cd,b.Emp_No	
			)A,	@MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
				
			Declare @Act_Days int,@H_days int
			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))  
	 			                          
			set @H_days = ( select  count(distinct holidaydate)  from MIMANSA.crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= @FromDate and holidaydate <= @ToDate )   
			print @TradeDays
			print @Act_Days
			print @H_days
						
				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',
				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))
				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)
				where 
				 ah.Status='A' and EMP_NO in (select EMP_NO from @MIStable)				
				
		
				--Update productivity for Employee
				print 'productivity'
				print @TradeDays 
				print (@Act_Days-@H_days)
				
				update @MIStable set 
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 
								else '0.00' end)
				from @MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				
				select sb_tag=Branch_cd,
					emp_no=Emp_No,
					NetRevenue=NetBrokeToSb/100000,
					Productivity=  Productivity   
				from @MIStable
				order by emp_no
			print '1.2. GrossRevenue Process ends:'+convert(varchar,getdate(),109)
		end
	end	
	
	if(upper(@Report_Type)='GRAPH2')
	begin
	
	Print 'GRAPH2'
	
	print '2.1. Party Details Process Start:'+convert(varchar,getdate(),109)
	
	insert into 
		#PartyDetails 
		(Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
	select
		ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
	from 
		B2B_CommonPartyServices ps with(nolock),@tempbranch aub
	where 
		ps.Branch_cd=aub.Branch_cd 
		and ps.FromDate<=@ToEffSaudaDate
		and ps.ToDate>=@FromEffSaudaDate
	
	update 
		#PartyDetails 
	set 
		EbrokingClient=ac1.EbrokingClient,
		AngelClRating=ac1.AngelClRating
	From 
		angelclient1 ac1 with(nolock),#PartyDetails ps
	where 
		ac1.Party_Code=ps.Party_Code and 
		ac1.EbrokingClient like @TradingMode
		and ac1.AngelClRating like @ClientGrade
	
	delete #PartyDetails where isnull(EbrokingClient,'')=''
	
	print '2.1. Party Details Process Ends:'+convert(varchar,getdate(),109)
	
	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)
	
	select 
		ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
	into 
		#ActivarionRatio	
	from 
		#PartyDetails ps
	where 
		ps.FromDate<=@ToEffSaudaDate
		and ps.ToDate>=@ToEffSaudaDate		
	group by 
		ps.Branch_cd,ps.Emp_No
	
	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)
		
	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)		
	
	insert into @BrokTurnOver
		select 
			ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
			TotalTurnover = L.Overall_turnover,
			NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
			L.Sauda_date  
		from 
			#PartyDetails ps ,		
			Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock)
		where 
			ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end collate SQL_Latin1_General_CP1_CI_AS	
			and ps.FromDate<=L.sauda_date 
			and ps.ToDate>=L.sauda_date
			and L.Sauda_date>= @FromEffSaudaDate 
			and L.Sauda_date<= @ToEffSaudaDate 
		
	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)
	--select * from @BrokTurnOver
	--return
	
	print '2.4. RTO in process check Starts:'+convert(varchar,getdate(),109)		
	
	declare @@MSG varchar(200)                  
	set @@MSG='Report is in process. Please wait for few minutes.'                    
	if (select Processon from MIMANSA.crm.dbo.Tbl_tradingdataupprocess with(nolock)) = 'Y'                    
	begin                    
		select msg=@@MSG                  
		return                    
	end 
	
	print '2.4. RTO in process check End:'+convert(varchar,getdate(),109)		
	
	
	if(@UserStatusId='SUBBROKER')
	begin
			declare @rto_Data table(
			Zone varchar(20),Region varchar(20),branch_cd varchar(20),B2BRM varchar(20),B2BRM_Name varchar(100),emp_no varchar(20),emp_name varchar(100),                                    
							ActiveCLEq money,ActiveCLComm money, ActiveCLCurr money,                                
							TOToTimeCash money,
							TOToTimeFUT money ,
							TOToTimeOPT money  ,
							TOToTimeComm money ,
							TOToTimeCurr money ,                                  
							CLToTimeCash money,
							CLToTimeFUT money,
							CLToTimeOPT money,
							CLToTimeComm money,
							CLToTimeCURR money,                    
							TotalTO money,
							TotalCL money,
							Optnooflots bigint
			)	
			
			print '2.5. RTO Data Fetch Start:'+convert(varchar,getdate(),109)		
			print '-------------------------------------------------------------------------------'
			
			insert into @rto_Data
			---exec MIMANSA.CRM.dbo.[GetTurnoverfortime_newfo] 
			exec MIMANSA.CRM.dbo.[GetTurnoverfortime_new] 
			@Emp_no=@UserEmp_No,
			@Zone='',
			@Region='',
			@Branch=@Sub_Broker,
			@Exec=@Dealer,
			@FromTime='09:00 AM',
			@ToTime='11:59 PM',
			@MainDrill='MAIN',
			@WiseReport='SBDEALER',
			@seg='ALL',
			@B2CStatus='B2B',
			@MimStatusID=@UserStatusId,
			@SB='',
			@RoundValue='1',
			@DownloadCSVFlag='Y'
			
			print '-------------------------------------------------------------------------------'
			print '2.5. RTO Data Fetch End:'+convert(varchar,getdate(),109)		
			
			print '2.6. Output Data Start:'+convert(varchar,getdate(),109)	
			
			declare @tempDashboardData table
			(
				sb_tag varchar(20),
				emp_no varchar(20),
				TargetTurnover money,
				ActualAchivedTO money,
				ClientsTraded money,
				ClientBase money,
				ctc money
			)
			
			insert into @tempDashboardData
			(	sb_tag,
				emp_no,
				TargetTurnover,
				ActualAchivedTO,
				ClientsTraded ,
				ClientBase ,
				ctc
			)
			select 
				sb_tag=emp.Branch_cd,
				emp_no=emp.emp_no,
				TargetTurnover =0,
				Activation_Ratio=0,
				ClientsTraded =0,
				ClientBase =0,
				CTC=0
			from
				#PartyDetails emp
			group by emp.Branch_cd,emp.emp_no	
			
			update @tempDashboardData set ctc=c.CTC
			from @tempDashboardData emp ,B2B_AngelHarmony c 
			where emp.Emp_No = c.emp_no
												
			update @tempDashboardData set TargetTurnover= a.TargetTurnover
			from @tempDashboardData emp1,
			(
			select 
				emp_no=emp.emp_no,
				TargetTurnover =cast((12*emp.ctc) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))
			from 
				@tempDashboardData emp inner join @BrokTurnOver b  on emp.Emp_No=b.Emp_No
			group by emp.emp_no	,  emp.ctc
			)a
			where emp1.emp_no =a.emp_no
		
			update @tempDashboardData set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL
			from @tempDashboardData emp ,@rto_Data c 
			where emp.Emp_No = c.emp_no
			
			update @tempDashboardData set ClientBase=isnull((TotalClientsAsonDate),0)
			from @tempDashboardData emp ,#ActivarionRatio d 
			where emp.Emp_No = d.emp_no
			
			print '2.6. Output Data End:'+convert(varchar,getdate(),109)	
			
			select 
			sb_tag,
				emp_no,
				TargetTurnover=TargetTurnover/100000,
				ActualAchivedTO=ActualAchivedTO/100000,
				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,
				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,
				ClientBase = CONVERT(decimal(10,0),ClientBase),
				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,2),(ActualAchivedTO/TargetTurnover)*100) else 0 end
			from @tempDashboardData order by emp_no 
	
	print '1.5.END.:'+convert(varchar,getdate(),109)
	end
	else
	begin
		print 'DEALER'
		declare @sb_tag1 varchar(20)
		declare @sb_admin1 varchar(20)
		
		select @sb_tag1=sb_tag from B2B_AngelHarmony where emp_no=@Dealer
		select @sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@sb_tag1 and isAdmin='1'
		
		insert into @rto_Data
		--exec MIMANSA.CRM.dbo.[GetTurnoverfortime_newfo] 
		exec MIMANSA.CRM.dbo.[GetTurnoverfortime_new] 
		@Emp_no=@sb_admin1,
		@Zone='',
		@Region='',
		@Branch=@sb_tag1,
		@Exec='',
		@FromTime='09:00 AM',
		@ToTime='11:59 PM',
		@MainDrill='MAIN',
		@WiseReport='SBDEALER',
		@seg='ALL',
		@B2CStatus='B2B',
		@MimStatusID='SUBBROKER',
		@SB='',
		@RoundValue='1',
		@DownloadCSVFlag='Y'	
	
	
	
	declare @tempDashboardData1 table
			(
				sb_tag varchar(20),
				emp_no varchar(20),
				TargetTurnover money,
				ActualAchivedTO money,
				ClientsTraded money,
				ClientBase money,
				ctc money,
				status varchar(10)
			)
			
			insert into @tempDashboardData1
			(	sb_tag,
				emp_no,
				TargetTurnover,
				ActualAchivedTO,
				--Activation_Ratio,
				ClientsTraded ,
				ClientBase ,
				--PercentageTurnoverAchievedTillTime 
				ctc,
				status
			)
			select 
				sb_tag=emp.Branch_cd,
				emp_no=emp.emp_no,
				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),
				Activation_Ratio=0,
				ClientsTraded =0,
				ClientBase =0,
				CTC=0,
				status=0
			from
				#PartyDetails emp
			group by emp.Branch_cd,emp.emp_no	
			
			update @tempDashboardData1 set ctc=c.CTC,status=isAdmin
			from @tempDashboardData1 emp ,B2B_AngelHarmony c 
			where emp.Emp_No = c.emp_no
			
			update @tempDashboardData1 set TargetTurnover= a.TargetTurnover
			from @tempDashboardData1 emp1,(
			select 
				emp_no=emp.emp_no,
				TargetTurnover =cast((12*emp.ctc) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))
			
			from 
				@tempDashboardData1 emp inner join @BrokTurnOver b  on emp.Emp_No=b.Emp_No
			group by emp.emp_no,emp.ctc	  
			)a
			where emp1.emp_no =a.emp_no
			
			update @tempDashboardData1 set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL
			from @tempDashboardData1 emp ,@rto_Data c 
			where emp.Emp_No = c.emp_no
			
			update @tempDashboardData1 set ClientBase=isnull((TotalClientsAsonDate),0)
			from @tempDashboardData1 emp ,#ActivarionRatio d 
			where emp.Emp_No = d.emp_no
			
			select 
			sb_tag,
				emp_no,
				TargetTurnover=TargetTurnover/100000,
				ActualAchivedTO=ActualAchivedTO/100000,
				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,
				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,
				ClientBase = CONVERT(decimal(10,0),ClientBase),
				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,2),(ActualAchivedTO/TargetTurnover)*100) else 0 end
			from @tempDashboardData1 
			where emp_no=@dealer
			union all
			
			select 
				sb_tag,
				emp_no='DealerAverage',
				TargetTurnover=sum(TargetTurnover)/100000,
				ActualAchivedTO=sum(ActualAchivedTO)/100000,
				Activation_Ratio=sum(Activation_Ratio),
				ClientsTraded=sum(ClientsTraded ),
				ClientBase=sum(ClientBase) ,
				PercentageTurnoverAchievedTillTime=SUM(PercentageTurnoverAchievedTillTime)
				from  (
						select 
							sb_tag,
							emp_no,
							TargetTurnover,
							ActualAchivedTO,
							Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,
							ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,
							ClientBase = CONVERT(decimal(10,0),ClientBase),
							PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,2),(ActualAchivedTO/TargetTurnover)*100) else 0 end
						from @tempDashboardData1 
						where emp_no<>@dealer
				)a
				group by a.sb_tag
		

	 	 
	end
	
	end			
			
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_bak_jul-05_2012
-- --------------------------------------------------
create procedure [dbo].[B2bCrms_DashBoard_bak_jul-05_2012]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(10),--SUBBROKER/SBDEALER
	@Sub_Broker varchar(10),
	@Dealer varchar(20),
	@Report_Type varchar(20)
)
as
begin
	/*
		exec B2bCrms_DashBoard 'et001','SUBBERKER','ET','','Graph1'
		exec B2bCrms_DashBoard 'et001','SUBBERKER','ET','','Graph2'
	*/
	
	print 'Start:'+convert(varchar,getdate(),109)
	
	
	Declare @ToDate smalldatetime
	Declare @FromDate smalldatetime
	
	Declare @FromSub_Broker varchar(10)
	Declare @ToSub_Broker varchar(10)
	Declare @FromDealer varchar(10)
	Declare @ToDealer varchar(10)
	Declare @FromEffSaudaDate datetime
	Declare @ToEffSaudaDate datetime
	Declare @SegmentTypeFrom varchar(10)
	Declare @SegmentTypeTo varchar(10)
	Declare @TradingMode varchar(20)
    Declare @ClientGrade varchar(20)
    Declare @TradeDays int
 
	set @SegmentTypeFrom ='0000'
	set @SegmentTypeTo ='ZZZZZ'
	
	set @TradingMode='%'
	set @ClientGrade='%'
	
	
	set @FromDate=left(CONVERT(smalldatetime,DATEADD(dd,-(DAY(GETDATE())-1),getdate())),11)+' 00:00'
	set @ToDate=left(CONVERT(smalldatetime,GETDATE()),11)+' 00:00'

	--print @FromDate
	--print @ToDate
	
	select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=GETDATE() 
	from (select top 15 Sauda_date=Sauda_date from TABLE_DATE where CMTradingDay='y'  and date<getdate()  order by date desc)a
	 
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromEffSaudaDate and sauda_date <= @ToEffSaudaDate and CurrTradingDay = 'Y'
	 
	/**subbroker*/
	if @Sub_Broker='' or @Sub_Broker='ALL' 
	Begin
		set @FromSub_Broker='A'
		set @ToSub_Broker='ZZZZZZZ'
	End
	else
	Begin
		Set @FromSub_Broker=@Sub_Broker
		Set @ToSub_Broker=@Sub_Broker
	End
	
	if @Dealer='' or @Dealer='ALL' 
	begin
		set @FromDealer='A'
		set @ToDealer='ZZZZZZZ'
	end
	else
	begin
		set @FromDealer=@Dealer
		set @ToDealer=@Dealer
	end
	
	create table #PartyDetails 
	(
	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime
	,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
	--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
	)
	
	declare @BrokTurnOver table
	(
	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),
	TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
	NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
	Sauda_date smalldatetime
	)
	
	
	--------------------------User Access---------------------------------------------------

	/*fill subbrokers and dealers*/
	declare @tempbranch  table                                                                
	(                                                                
	Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
	)
	
	Insert into @tempbranch
	select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker
	
	
	
	

	
--select * from @BrokTurnOver where Emp_No='et001' and party_code='A10095' order by Party_Code

	if(upper(@Report_Type)='GRAPH1')
	begin
	Print 'GRAPH1'
		
		Declare  @MIStable table                                                          
		 (                                                          
		 Branch_cd varchar(20),
		 Emp_No varchar(20),  
		 Emp_Name varchar(100),
		 TotalClientsStartOfmonth int,
		 TotalClientsAsonDate int, Tradedclients int, 
		 OnlineTurnover money, OfflineTurnover money,
		 OnlineBrok money, OfflineBrok money,
		 OnlineNetRevnue money, OfflineNetRevnue money,
		 NetBrokeToSb money,
		 DailyTradedClients_AR int,
		 ActivationRatio varchar(10),
		 AvgRevPerClient money,
		 Productivity varchar(10),
		 ClientNotTradedForMonth int, 
		 ClientNotTradedAsOnDate int 
		 )      
		
		if(	@UserStatusId='SBDEALER')
		begin
			print @UserStatusId
			 declare @sb_tag varchar(20)
			 declare @sb_admin varchar(20)
			 
			 declare @productivity money
			 declare @DealerAverage money
			 
			 select @sb_tag=sb_tag from vw_tbl_EmployeeView where emp_no=@Dealer
			 select @sb_admin=emp_no from vw_tbl_EmployeeView where sb_tag=@sb_tag and isAdmin='1'
			 
			 --select @sb_tag
			 --select @sb_admin
			 
			 delete from @MIStable
			 
			 insert into @MIStable
			 exec [SBB2B_MIS] @UserEmp_No=@sb_admin,@UserStatusId='SUBBROKER',@Sub_Broker=@sb_tag,@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
			 @SegmentType='ALL',@FromDate=@FromDate,@Wise='DEALER',@ReportType='MAIN',@DrillFlag='',@TotalFlag='Y'
			
			 select @productivity=productivity from @MIStable where Emp_No=@Dealer
			 
			 select 
				@DealerAverage=convert(decimal(10,2),sum(NetBrokeToSb)/SUM(emp.ctc))
			 from 
				vw_tbl_EmployeeView emp ,@MIStable mis
			 where
				emp.Emp_No = mis.emp_no
				and mis.emp_no <> @Dealer
				--and emp.Status='A'
				and Emp.isadmin<>'1'
			 group by emp.sb_tag	
			 
			 select emp_no=@Dealer,productivity=@productivity
			 union all
			 select 'DealerAverage',productivity=@DealerAverage
		end				
		if(	@UserStatusId='SUBBROKER')
		begin
			 
			 print @UserStatusId
			 
			 insert into @MIStable
			 exec [SBB2B_MIS] @UserEmp_No=@UserEmp_No,@UserStatusId=@UserStatusId,@Sub_Broker=@Sub_Broker,@Dealer=@Dealer,@TradingMode='ALL',@ClientGrade='ALL',
			 @SegmentType='ALL',@FromDate=@FromDate,@Wise='DEALER',@ReportType='MAIN',@DrillFlag='',@TotalFlag='Y'
						
			 select 
				sb_tag=Branch_cd,
				emp_no=Emp_No,
				NetRevenue=NetBrokeToSb,
				Productivity= case when Productivity ='NA' then 0.00 else Productivity end 
			from 
				@MIStable
		end
		
	 
	end	
	
	if(upper(@Report_Type)='GRAPH2')
	begin
	
	print 'Access:'+convert(varchar,getdate(),109)
	if @Dealer='' or @Dealer='ALL' 
	begin
			--		
			print 'ACT1'
			insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
			select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
			from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
			where ps.Branch_cd=aub.Branch_cd 
			--and ps.emp_no=aub.dealers
			and ps.FromDate<=@ToEffSaudaDate
			and ps.ToDate>=@FromEffSaudaDate
			--and ps.Segment_Type=@SegmentType
			
	end 
	else
	begin
			print 'ACT2'
			insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
			select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
			from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
			where ps.Branch_cd=aub.Branch_cd
			--and ps.emp_no=aub.dealers
			and ps.FromDate<=@ToEffSaudaDate
			and ps.ToDate>=@FromEffSaudaDate
			and ps.Emp_No>=@FromDealer
			and ps.Emp_No<=@ToDealer
			--and ps.Segment_Type=@SegmentType
	end
	
	
	update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
	From angelclient1 ac1 with(nolock),#PartyDetails ps
	where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
	and ac1.AngelClRating like @ClientGrade
	--
	delete #PartyDetails where isnull(EbrokingClient,'')=''
	

	
	insert into @BrokTurnOver
		select 
		ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		Online_TurnOver=L.ebrok_TurnOver,
		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=L.ebrok_brok_earned,
		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,		
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock)--, TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		AND EM.FromDate <= @FromEffSaudaDate AND EM.ToDate >= @ToEffSaudaDate -- Check Exchange Mapping table
		and ps.FromDate<=L.sauda_date and ps.ToDate>=L.sauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		
	print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)
	
	print 'SP Start:'+convert(varchar,getdate(),109)
	declare @@MSG varchar(200)                  
	set @@MSG='Report is in process. Please wait for few minutes.'                    
	if (select Processon from [196.1.115.207].crm.dbo.Tbl_tradingdataupprocess with(nolock)) = 'Y'                    
	begin                    
		select msg=@@MSG                  
		return                    
	end 
	
	declare @rto_Data table(
	Zone varchar(20),Region varchar(20),branch_cd varchar(20),B2BRM varchar(20),B2BRM_Name varchar(100),emp_no varchar(20),emp_name varchar(100),                                    
					ActiveCLEq money,ActiveCLComm money, ActiveCLCurr money,                                
					TOToTimeCash money,
					TOToTimeFUT money ,
					TOToTimeOPT money  ,
					TOToTimeComm money ,
					TOToTimeCurr money ,                                  
					CLToTimeCash money,
					CLToTimeFUT money,
					CLToTimeOPT money,
					CLToTimeComm money,
					CLToTimeCURR money,                    
					TotalTO money,
					TotalCL money
	)	
	
	insert into @rto_Data
	exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_newfo] 
	@Emp_no=@UserEmp_No,
	@Zone='',
	@Region='',
	@Branch=@Sub_Broker,
	@Exec=@Dealer,
	@FromTime='09:00 AM',
	@ToTime='11:59 AM',
	@MainDrill='MAIN',
	@WiseReport='SBDEALER',
	@seg='ALL',
	@B2CStatus='B2B',
	@MimStatusID=@UserStatusId,
	@SB='',
	@RoundValue='1',
	@DownloadCSVFlag='Y'
	
	
	
	
	select 
		ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
	into #ActivarionRatio	
	from #PartyDetails ps
	where ps.FromDate<=@ToEffSaudaDate
	and ps.ToDate>=@ToEffSaudaDate		
	group by ps.Branch_cd,ps.Emp_No
	
	select 
	sb_tag,
		emp_no,
		TargetTurnover,
		ActualAchivedTO,
		Activation_Ratio,
		ClientsTraded ,
		ClientBase ,
		PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,2),(ActualAchivedTO/TargetTurnover)*100) else 0 end 
	from(
	select 
		sb_tag=emp.sb_tag,
		emp_no=emp.emp_no,
		TargetTurnover=isnull(convert(decimal(30,2),((12*emp.ctc)/(sum(NetRevenue)/sum(TotalTurnover)))),0),
		ActualAchivedTO=isnull(sum(TotalTO),0),
		Activation_Ratio=(sum(TotalCL)/sum(TotalClientsAsonDate))*100,
		ClientsTraded =convert(decimal(10,0),sum(TotalCL)),
		ClientBase =sum(TotalClientsAsonDate)
		
	from 
		
		vw_tbl_EmployeeView emp left outer join @BrokTurnOver b  on emp.Emp_No=b.Emp_No  , @rto_Data c ,#ActivarionRatio d
	where
		
		  emp.Emp_No = c.emp_no
		and emp.Emp_no=d.Emp_No
		--and emp.Status='A'
	 group by emp.sb_tag,emp.Emp_No,emp.CTC	
	 )a
	end			
			
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2BCRMS_Dashboard_client_Statistics
-- --------------------------------------------------




CREATE procedure [dbo].[B2BCRMS_Dashboard_client_Statistics]

 @UserEmp_No varchar(20),

 @UserStatusId varchar(10),--SUBBROKER/SBDEALER

 @Sub_Broker varchar(10),

 @Dealer varchar(20),

 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE

 @ClientGrade varchar(15),--ALL,A+,A,B,C,D

 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency

 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012

 @Wise varchar(20),       --SUBBROKER/DEALER

 @ReportType varchar(20), --MAIN/DRILL

 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI

 @TotalFlag varchar(2) = null

 as

 BEGIN

/*

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='Dec  1 2012',@Wise='SUBBROKER',@ReportType='MAIN',@DrillFlag=''



exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''



exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'



exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'



exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

*/

--

print 'Start:'+convert(varchar,getdate(),109)

 Declare @ToDate smalldatetime

 Declare @FromDealer varchar(10)

 Declare @ToDealer varchar(10)

 Declare @FromEffSaudaDate datetime

 Declare @ToEffSaudaDate datetime

 Declare @TradeDays money

 Declare @SegmentTypeFrom varchar(10)

 Declare @SegmentTypeTo varchar(10)

 Declare @FromSub_Broker varchar(10)

 Declare @ToSub_Broker varchar(10)

 

 --------------------------------Set From and TO date---------------------------------------

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'

set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'

print @FromDate

print @ToDate

set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))

set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))

set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))

set @Dealer=upper(ltrim(rtrim(@Dealer)))

set @TradingMode=upper(ltrim(rtrim(@TradingMode)))

set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))

set @SegmentType=upper(ltrim(rtrim(@SegmentType)))

set @Wise=upper(ltrim(rtrim(@Wise)))

set @ReportType=upper(ltrim(rtrim(@ReportType)))

set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))

 ---------------------------------------Get count of Trade Days---------------------------------------------

 /* Added table date for the Currency Segment */

if(@SegmentType = 'CURRENCY')

begin

   set @SegmentTypeFrom  ='CURRENCY'

   set @SegmentTypeTo='CURRENCY'

   

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'

end

else

begin

			if(@SegmentType = 'CASH')

			begin

			set @SegmentTypeFrom  ='CASH'

			set @SegmentTypeTo='CASH'

			End



			if(@SegmentType = 'DERIVATIVE')

			begin

			set @SegmentTypeFrom  ='DERIVATIVE'

			set @SegmentTypeTo='DERIVATIVE'

			End

			

			if(@SegmentType = 'COMMODITY')

			begin

			set @SegmentTypeFrom  ='COMMODITY'

			set @SegmentTypeTo='COMMODITY'

			End



			if(@SegmentType = 'All')

			begin

			set @SegmentTypeFrom  ='a'

			set @SegmentTypeTo='zzzzzz'

			End

			

			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'

	end

 



 

print @TradeDays

 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------

 

 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 

 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

 

 

----------------------------------------Redefine Report Wise option as per input fields-----------------------



set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)



print @Wise

-------------------------------------------------------------------------

/**subbroker*/

if @Sub_Broker='' or @Sub_Broker='ALL' 

Begin

	set @FromSub_Broker='A'

	set @ToSub_Broker='ZZZZZZZ'

End

else

Begin

	Set @FromSub_Broker=@Sub_Broker

	Set @ToSub_Broker=@Sub_Broker

End



--if @Dealer='' or @Dealer='ALL' set @Dealer='%'

--

/**subbrokerdealer*/

if @Dealer='' or @Dealer='ALL' 

begin

	set @FromDealer='A'

	set @ToDealer='ZZZZZZZ'

end

else

begin

	set @FromDealer=@Dealer

	set @ToDealer=@Dealer

end

--

--------------------------User Access---------------------------------------------------



/*fill subbrokers and dealers*/

declare @tempbranch  table                                                                

(                                                                

Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

)

-----------------------------------------------------







Insert into @tempbranch

select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

 



----------------------------Declare MIS and PartyDetails Table--------------------------



create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime

,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

)

--



create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime)

--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)

--

 create table #MIStable                                                           

 (                                                          

 Branch_cd varchar(20),Emp_No varchar(20),   Tradedclients money, ClientNotTradedForMonth money, ClientNotTradedAsOnDate money,

 Emp_Name varchar(100), Emp_First_Name varchar(100),Total money

 )                                                        

--

print 'Access:'+convert(varchar,getdate(),109)

if @Dealer='' or @Dealer='ALL' 

begin

		--		

		print 'ACT1'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd 

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		--and ps.Segment_Type=@SegmentType

		

end 

else

begin

		print 'ACT2'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		and ps.Emp_No>=@FromDealer

		and ps.Emp_No<=@ToDealer

		--and ps.Segment_Type=@SegmentType

end



--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------

if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')

begin

print 'TradingMode or ClientGrade'

if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)

if @ClientGrade='ALL' set @ClientGrade='%'

--

update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating

From angelclient1 ac1,#PartyDetails ps

where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode

and ac1.AngelClRating like @ClientGrade

--

delete #PartyDetails where isnull(EbrokingClient,'')=''

--

end

-----------------------Update #PartyDetails as per report Wise option -------------------------------------

--print '1.1:'+convert(varchar,getdate(),109)

if @Wise='SUBBROKER'

begin

	update #PartyDetails set Emp_No=''

end 



-----------------------Update FirstTrade date -------------------------------------

if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))

begin



	if(@SegmentType in('COMMODITY'))

	begin

		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end

	else if(@SegmentType in('CURRENCY'))

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end		

	else --if(@SegmentType in('CASH','DERIVATIVE') and other

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTrade 

		from angelclient1 ac1 with(nolock),#PartyDetails ps 

		where ac1.Party_Code=ps.Party_Code

	end

end

--------------------------Fetch Brokerage in case when required-------------------------



if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))

begin

print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)

/*print 'Segment'

print @SegmentTypeFrom

print @SegmentTypeTo

print 'Eff Date'

print @FromEffSaudaDate

print @ToEffSaudaDate

print 'Date'

print @FromDate

print @ToDate*/

/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 

from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */

--



insert into #BrokTurnOver

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		Online_TurnOver=L.ebrok_TurnOver,

		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		GrossRevenue=L.Overall_brok_earned,

		GrossRevenue_Online=L.ebrok_brok_earned,

		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),

		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 

		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 

		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 

		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table

		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date

		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		--and L.ExceptClient='Y'

print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)



end







--select top 10 * From tbl_Exchangemapping

 

---------------------MAIN PAGE---------------------------------

if @ReportType='MAIN'

begin



-----------------------------Fill MIS Table--------------------------------------------------------------------

		insert into #MIStable(Branch_cd ,Emp_No,

		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,Total)

		select Branch_cd,Emp_No,

		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,Total=0

		from #PartyDetails		

		group by Branch_cd,Emp_No	

		order by Branch_cd,Emp_No		

print '1.2:'+convert(varchar,getdate(),109)

----------------------------------------Update Start Of Month Total Clients----------------------------------



--

print '3.1 '+convert(varchar,getdate(),109)

--

update #MIStable set Tradedclients=A.Tradedclients

from 

		(

		select b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)

       

  

		from #BrokTurnOver b

		group by b.Branch_cd,b.Emp_No

		)A,	#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 



----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------

print '4:'+convert(varchar,getdate(),109)

--

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded

		from #PartyDetails ps

		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

		and ps.FirstTrade<=@ToDate

		--Delete traded clients

		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)

--	

print '4.1:'+convert(varchar,getdate(),109)

		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth

		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)

		from #nottraded ps

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

drop table #nottraded

--

print '5:'+convert(varchar,getdate(),109)

		

			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate

			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)

			from #PartyDetails ps

			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	

			and ps.FirstTrade>@ToDate

			group by ps.Branch_cd,ps.Emp_No

			)A,#MIStable B

				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	

--

print '6:'+convert(varchar,getdate(),109)

---------------------------------Update Client Visit Pending-------------------------







------------------------------DROP #PartyDetails---

drop table #PartyDetails

------------------------------DISPLAY------------------------------------------------

print 'Wise: '

print @Wise

if @Wise='DEALER'

begin

		print 'DEALER'

		update #MIStable set Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4)

					from #MIStable mis,B2B_AngelHarmony ah with(nolock)

					where mis.Emp_No=ah.EMP_NO

		

		update #MIStable set Total=Tradedclients+ClientNotTradedForMonth+ClientNotTradedAsOnDate

			

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,mis.Emp_First_name,

			Tradedclients=case when Tradedclients >0 then (convert(decimal(10,0),(Tradedclients/Total)*100)) else 0 end, 

			TradedclientsToolTip=convert(decimal(10,0),Tradedclients),

			ClientNotTradedForMonth=case when ClientNotTradedForMonth>0 then (convert(decimal(10,0),(ClientNotTradedForMonth/Total)*100)) else 0 end,

			ClientNotTradedForMonthToolTip=convert(decimal(10,0),ClientNotTradedForMonth),

			ClientNotTradedAsOnDate=case when ClientNotTradedAsOnDate>0 then (convert(decimal(10,0),(ClientNotTradedAsOnDate/Total)*100)) else 0 end,

			ClientNotTradedAsOnDateToolTip=convert(decimal(10,0),ClientNotTradedAsOnDate)

			--Total

		from #MIStable mis

		--order by 1,2,3

		union all 

		select SB,Emp_No,Emp_Name,Emp_First_name,

		Tradedclients=convert(decimal(10,0),(Tradedclients/Total)*100),

		TradedclientsTollTip=convert(decimal(10,0),(Tradedclients/Total)*100),

		ClientNotTradedForMonth=convert(decimal(10,0),(ClientNotTradedForMonth/Total)*100),

		ClientNotTradedForMonthToolTip=convert(decimal(10,0),(ClientNotTradedForMonth/Total)*100),

		ClientNotTradedAsOnDate=convert(decimal(10,0),(ClientNotTradedAsOnDate/Total)*100),

		ClientNotTradedAsOnDateToolTip=convert(decimal(10,0),(ClientNotTradedAsOnDate/Total)*100)

		from

		(

			select SB=Branch_cd,Emp_No='Average' ,Emp_Name='Average',Emp_First_name='Average',

				Tradedclients=sum(Tradedclients)/count(Emp_No), 

				ClientNotTradedForMonth=sum(ClientNotTradedForMonth)/count(Emp_No),

				ClientNotTradedAsOnDate=sum(ClientNotTradedAsOnDate)/count(Emp_No),

				Total=(sum(Tradedclients)/count(Emp_No))+(sum(ClientNotTradedForMonth)/count(Emp_No))+(sum(ClientNotTradedAsOnDate)/count(Emp_No))

			from #MIStable mis

			group by Branch_cd

		)a	

end

else

begin

		print 'SUBBROKER'

		select SB=Branch_cd,Emp_No ,Tradedclients,

		ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2

end

--TOTAL

--if @TotalFlag <> 'Y' 





END

---------------------MAIN PAGE END---------------------------------------------------

---------------------DRILL PAGE START---------------------------------------------------

else if @ReportType='DRILL'

begin

---------------------Declare drill page-------------------------------------------------

create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),

ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),

DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,

LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))



--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)

--

if @DrillFlag='TotalAsOn'

begin

print 'Drill 1:'+convert(varchar,getdate(),109)



	   

		--select * from @rto_Data

			

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate				



print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)

		

		if(@UserStatusId='SBDEALER')

		begin

			declare @rto_Data table

			(

			Zone varchar(20),

			Region varchar(20),

			branch_cd varchar(20),

			sub_broker varchar(20),

			Sub_brokerName varchar(200),

			party_code varchar(20),

			Short_name varchar(100),

			TotalTO money



			)	

			

			insert into @rto_Data

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch='',

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='DRILL',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID='SBDEALER',

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			

			update #drillPartyDetails set TotalTo=rto.TotalTo

			from #drillPartyDetails drill, @rto_Data rto

			where drill.Party_Code=rto.party_code	

		end

		

			

		--

end

else if @DrillFlag='TotalStartOfMonth'

begin

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate	

end

else if @DrillFlag='NotTradedAsOn'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

				and ps.FirstTrade>@ToDate	

end

else if @DrillFlag='NotTradedForMonth'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				

				and ps.FirstTrade<=@ToDate		

		--

		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	

		--

end

else if @DrillFlag='Traded'

begin

		--Insert Traded Clients

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code

		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		

		

end

else if @DrillFlag='BROK'

begin		

		Declare @emp_name varchar(100)		

		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')

		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,

		br.Party_Code,ac1.Long_Name,

		--Turnover =sum(TotalTurnover),

        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 

		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        --NetRevnue =sum(NetRevenue),

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Sauda_date)  

		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code

		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	

		

		--Total		

		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver

		return

end

else if @DrillFlag='ACTIVECLI'

begin		

	

	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),

	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100

	into #FinalActiveCli

	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join

	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)

	 from #BrokTurnOver b

	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	order by 1,2,3

	--Display

	select * from #FinalActiveCli

	--Total Row

	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),

	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100

	 from #FinalActiveCli

	

return

end

---------------------Common Script for DRILL PAGE ---------------------------------------------------

	

print 'Drill 3:'+convert(varchar,getdate(),109)		

		-- Update Portfolio i.e. Holding value

		update #drillPartyDetails                                                             

		set PortfolioInfo=isnull(H.TotalHold,0)            

		from #drillPartyDetails ps inner join   [MIMANSA].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   

		on ps.party_code = H.party_code 

print 'Drill 4:'+convert(varchar,getdate(),109)		

		--Update Ledger Value

		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger

		from #drillPartyDetails ps left outer join  [MIMANSA].Angelcs.dbo.View_LedgerInfo L with(nolock)

		on ps.party_code = L.party_code 

		--

		update #drillPartyDetails                                                             

		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)

		from #drillPartyDetails ps left outer join #totalLedger L

		on ps.party_code = L.party_code 

		--

		drop table #totalLedger		

print 'Drill 5:'+convert(varchar,getdate(),109)			

		--Update Current Dealer

		update #drillPartyDetails set DealerCode=cps.Emp_No			

		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )

		where --cps.Segment_Type=@SegmentType and 

		/*EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and*/

		ps.Party_Code =cps.Party_Code and

		cps.Valid='Y' and cps.CommRank='1'

		--Set Row color as per BRS point 4.3.4 & 4.3.5

print 'Drill 6:'+convert(varchar,getdate(),109)	

		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	

		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)

		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'

		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)

		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)

		--		

print 'Drill End:'+convert(varchar,getdate(),109)		

		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',

		SB=Branch_cd,Party_Code,Client_Name,Emp_No,

		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),

		ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)

		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),

		PureRisk=convert(decimal(15,2),PureRisk),

		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),LastTradeDate,RowColor,LedgerColor,

		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)

		

		 from #drillPartyDetails s

		 order by SrNo

		 --Total

		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),

		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))

		  from #drillPartyDetails

-------------------

end

---------------------DRILL PAGE END---------------------------------------------------

END

---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2BCRMS_Dashboard_client_Statistics_vol1
-- --------------------------------------------------

CREATE procedure [dbo].[B2BCRMS_Dashboard_client_Statistics_vol1]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20),       --SUBBROKER/DEALER
 @ReportType varchar(20), --MAIN/DRILL
 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 @TotalFlag varchar(2) = null
 as
 BEGIN
/*
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='Dec  1 2012',@Wise='SUBBROKER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'
*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	--select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	--where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			--select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			--where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------



Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker
 

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 create table #MIStable                                                           
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),   Tradedclients money, ClientNotTradedForMonth money, ClientNotTradedAsOnDate money,
 Emp_Name varchar(100), Emp_First_Name varchar(100),Total money
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		and ps.Emp_No>=@FromDealer
		and ps.Emp_No<=@ToDealer
		--and ps.Segment_Type=@SegmentType
end

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 


--------------------------Fetch Brokerage in case when required-------------------------

if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

update #PartyDetails set FirstTrade= ac1.FirstTrade 
	from angelclient1 ac1 with(nolock),#PartyDetails ps 
	where ac1.Party_Code=ps.Party_Code

insert into #BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = 0,--L.Overall_turnover,
		Online_TurnOver=0,--L.ebrok_TurnOver,
		Offline_TurnOver=0,--(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=0,--L.Overall_brok_earned,
		GrossRevenue_Online=0,--L.ebrok_brok_earned,
		GrossRevenue_Offline=0,--(L.Overall_brok_earned-L.ebrok_brok_earned),
		NetRevenue=0,--(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue_Online=0,--(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=0,--(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),
		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		--and L.ExceptClient='Y'
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end

 
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin

-----------------------------Fill MIS Table--------------------------------------------------------------------
		insert into #MIStable(Branch_cd ,Emp_No,
		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,Total)
		select Branch_cd,Emp_No,
		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,Total=0
		from #PartyDetails		
		group by Branch_cd,Emp_No	
		order by Branch_cd,Emp_No		
print '1.2:'+convert(varchar,getdate(),109)
----------------------------------------Update Start Of Month Total Clients----------------------------------

--
print '3.1 '+convert(varchar,getdate(),109)
--

update #MIStable set Tradedclients=A.Tradedclients
from 
		(
		select b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)
       
  
		from #BrokTurnOver b
		group by b.Branch_cd,b.Emp_No
		)A,	#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------
print '4:'+convert(varchar,getdate(),109)
--


		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded
		from #PartyDetails ps
		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
		and ps.FirstTrade<=@ToDate
		
	
		--Delete traded clients
		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)
--	

print '4.1:'+convert(varchar,getdate(),109)
		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth
		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)
		from #nottraded ps
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
drop table #nottraded
--
print '5:'+convert(varchar,getdate(),109)
		
			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate
			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)
			from #PartyDetails ps
			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	
			and ps.FirstTrade>@ToDate
			group by ps.Branch_cd,ps.Emp_No
			)A,#MIStable B
				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	
--
print '6:'+convert(varchar,getdate(),109)
---------------------------------Update Client Visit Pending-------------------------



------------------------------DROP #PartyDetails---
drop table #PartyDetails
------------------------------DISPLAY------------------------------------------------
print 'Wise: '
print @Wise
if @Wise='DEALER'
begin
		if(@UserStatusId='SUBBROKER')
		begin
		print 'DEALER'
		update #MIStable set Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4)
					from #MIStable mis,B2B_AngelHarmony ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		
		update #MIStable set Total=Tradedclients+ClientNotTradedForMonth+ClientNotTradedAsOnDate
			
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,mis.Emp_First_name,
			Tradedclients=case when Tradedclients >0 then (convert(decimal(10,0),(Tradedclients/Total)*100)) else 0 end, 
			TradedclientsToolTip=convert(decimal(10,0),Tradedclients),
			ClientNotTradedForMonth=case when ClientNotTradedForMonth>0 then (convert(decimal(10,0),(ClientNotTradedForMonth/Total)*100)) else 0 end,
			ClientNotTradedForMonthToolTip=convert(decimal(10,0),ClientNotTradedForMonth),
			ClientNotTradedAsOnDate=case when ClientNotTradedAsOnDate>0 then (convert(decimal(10,0),(ClientNotTradedAsOnDate/Total)*100)) else 0 end,
			ClientNotTradedAsOnDateToolTip=convert(decimal(10,0),ClientNotTradedAsOnDate)
			--Total
		from #MIStable mis
		
		--order by 1,2,3
		union all 
		select SB,Emp_No,Emp_Name,Emp_First_name,
		Tradedclients=convert(decimal(10,0),(Tradedclients/Total)*100),
		TradedclientsTollTip=convert(decimal(10,0),(Tradedclients/Total)*100),
		ClientNotTradedForMonth=convert(decimal(10,0),(ClientNotTradedForMonth/Total)*100),
		ClientNotTradedForMonthToolTip=convert(decimal(10,0),(ClientNotTradedForMonth/Total)*100),
		ClientNotTradedAsOnDate=convert(decimal(10,0),(ClientNotTradedAsOnDate/Total)*100),
		ClientNotTradedAsOnDateToolTip=convert(decimal(10,0),(ClientNotTradedAsOnDate/Total)*100)
		from
		(
			select SB=Branch_cd,Emp_No='Average' ,Emp_Name='Average',Emp_First_name='Average',
				Tradedclients=sum(Tradedclients)/count(Emp_No), 
				ClientNotTradedForMonth=sum(ClientNotTradedForMonth)/count(Emp_No),
				ClientNotTradedAsOnDate=sum(ClientNotTradedAsOnDate)/count(Emp_No),
				Total=(sum(Tradedclients)/count(Emp_No))+(sum(ClientNotTradedForMonth)/count(Emp_No))+(sum(ClientNotTradedAsOnDate)/count(Emp_No))
			from #MIStable mis
			group by Branch_cd
		)a	
		end
		if(@UserStatusId='SBDEALER')
		begin
			update #MIStable set Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4)
					from #MIStable mis,B2B_AngelHarmony ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		
		update #MIStable set Total=Tradedclients+ClientNotTradedForMonth+ClientNotTradedAsOnDate
			
		select SB='',Emp_No ,mis.Emp_Name,mis.Emp_First_name,
			Tradedclients=case when sum(Tradedclients) >0 then (convert(decimal(10,0),(sum(Tradedclients)/sum(Total))*100)) else 0 end, 
			TradedclientsToolTip=convert(decimal(10,0),sum(Tradedclients)),
			ClientNotTradedForMonth=case when sum(ClientNotTradedForMonth)>0 then (convert(decimal(10,0),(sum(ClientNotTradedForMonth)/sum(Total))*100)) else 0 end,
			ClientNotTradedForMonthToolTip=convert(decimal(10,0),sum(ClientNotTradedForMonth)),
			ClientNotTradedAsOnDate=case when sum(ClientNotTradedAsOnDate)>0 then (convert(decimal(10,0),(sum(ClientNotTradedAsOnDate)/sum(Total))*100)) else 0 end,
			ClientNotTradedAsOnDateToolTip=convert(decimal(10,0),sum(ClientNotTradedAsOnDate))
			--Total
		from #MIStable mis
		group by Emp_No,Emp_Name,Emp_First_name
		union all 
		select SB,Emp_No,Emp_Name,Emp_First_name,
		Tradedclients=convert(decimal(10,0),(Tradedclients/Total)*100),
		TradedclientsTollTip=convert(decimal(10,0),(Tradedclients/Total)*100),
		ClientNotTradedForMonth=convert(decimal(10,0),(ClientNotTradedForMonth/Total)*100),
		ClientNotTradedForMonthToolTip=convert(decimal(10,0),(ClientNotTradedForMonth/Total)*100),
		ClientNotTradedAsOnDate=convert(decimal(10,0),(ClientNotTradedAsOnDate/Total)*100),
		ClientNotTradedAsOnDateToolTip=convert(decimal(10,0),(ClientNotTradedAsOnDate/Total)*100)
		from
		(
			select SB=Branch_cd,Emp_No='Average' ,Emp_Name='Average',Emp_First_name='Average',
				Tradedclients=sum(Tradedclients)/count(Emp_No), 
				ClientNotTradedForMonth=sum(ClientNotTradedForMonth)/count(Emp_No),
				ClientNotTradedAsOnDate=sum(ClientNotTradedAsOnDate)/count(Emp_No),
				Total=(sum(Tradedclients)/count(Emp_No))+(sum(ClientNotTradedForMonth)/count(Emp_No))+(sum(ClientNotTradedAsOnDate)/count(Emp_No))
			from #MIStable mis
			group by Branch_cd
		)a	
		end
end
else
begin
		print 'SUBBROKER'
		select SB=Branch_cd,Emp_No ,Tradedclients,
		ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2
end

END

END
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_productivity
-- --------------------------------------------------




CREATE procedure [dbo].[B2bCrms_DashBoard_productivity]

 @UserEmp_No varchar(20),

 @UserStatusId varchar(10),--SUBBROKER/SBDEALER

 @Sub_Broker varchar(10),

 @Dealer varchar(20),

 @TradingMode varchar(15)='ALL',--ALL,ONLINE,OFFLINE

 @ClientGrade varchar(15) ='ALL',--ALL,A+,A,B,C,D

 @SegmentType varchar(20)='ALL',--ALL,Equity,Derivative,Commodity and Currency

 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012

 @Wise varchar(20) ='DEALER',       --SUBBROKER/DEALER

 @ReportType varchar(20)='MAIN', --MAIN/DRILL

 @DrillFlag varchar(20) =null,  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI

 @TotalFlag varchar(2) = null

 as

 BEGIN

/*

exec [B2bCrms_DashBoard_productivity] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='Jan  1 2013',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''





*/

--

print 'Start:'+convert(varchar,getdate(),109)

 Declare @ToDate smalldatetime

 Declare @FromDealer varchar(10)

 Declare @ToDealer varchar(10)

 Declare @FromEffSaudaDate datetime

 Declare @ToEffSaudaDate datetime

 Declare @TradeDays money

 Declare @SegmentTypeFrom varchar(10)

 Declare @SegmentTypeTo varchar(10)

 Declare @FromSub_Broker varchar(10)

 Declare @ToSub_Broker varchar(10)

 

 --------------------------------Set From and TO date---------------------------------------

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'

set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'



set  @FromDate=DATEADD(MM,-3,@FromDate)

 

print @FromDate

print @ToDate

set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))

set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))

set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))

set @Dealer=upper(ltrim(rtrim(@Dealer)))

set @TradingMode=upper(ltrim(rtrim(@TradingMode)))

set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))

set @SegmentType=upper(ltrim(rtrim(@SegmentType)))

set @Wise=upper(ltrim(rtrim(@Wise)))

set @ReportType=upper(ltrim(rtrim(@ReportType)))

set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))

 ---------------------------------------Get count of Trade Days---------------------------------------------

 /* Added table date for the Currency Segment */

if(@SegmentType = 'CURRENCY')

begin

   set @SegmentTypeFrom  ='CURRENCY'

   set @SegmentTypeTo='CURRENCY'

   

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'

end

else

begin

			if(@SegmentType = 'CASH')

			begin

			set @SegmentTypeFrom  ='CASH'

			set @SegmentTypeTo='CASH'

			End



			if(@SegmentType = 'DERIVATIVE')

			begin

			set @SegmentTypeFrom  ='DERIVATIVE'

			set @SegmentTypeTo='DERIVATIVE'

			End

			

			if(@SegmentType = 'COMMODITY')

			begin

			set @SegmentTypeFrom  ='COMMODITY'

			set @SegmentTypeTo='COMMODITY'

			End



			if(@SegmentType = 'All')

			begin

			set @SegmentTypeFrom  ='a'

			set @SegmentTypeTo='zzzzzz'

			End

			

			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'

	end

 



 

print @TradeDays

 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------

 

 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 

 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

 

 

----------------------------------------Redefine Report Wise option as per input fields-----------------------



set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)



print @Wise

-------------------------------------------------------------------------

/**subbroker*/

if @Sub_Broker='' or @Sub_Broker='ALL' 

Begin

	set @FromSub_Broker='A'

	set @ToSub_Broker='ZZZZZZZ'

End

else

Begin

	Set @FromSub_Broker=@Sub_Broker

	Set @ToSub_Broker=@Sub_Broker

End



--if @Dealer='' or @Dealer='ALL' set @Dealer='%'

--

/**subbrokerdealer*/

if @Dealer='' or @Dealer='ALL' 

begin

	set @FromDealer='A'

	set @ToDealer='ZZZZZZZ'

end

else

begin

	set @FromDealer=@Dealer

	set @ToDealer=@Dealer

end

--

--------------------------User Access---------------------------------------------------



/*fill subbrokers and dealers*/

declare @tempbranch  table                                                                

(                                                                

Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

)

-----------------------------------------------------



Insert into @tempbranch

select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker



----------------------------Declare MIS and PartyDetails Table--------------------------



create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

)

--



create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime,trade_month varchar(20), MonthFirstDate datetime, MonthLastDate datetime,

intTrademonth int, intTradeYear int)

--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)

--

 --Declare  @MIStable table      

 create table #MIStable                                                     

 (                                                          

 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,

 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,

 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,

 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),

 OnlineTurnover money, OfflineTurnover money, Turnover money,

 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int

 )                                                        

--

print 'Access:'+convert(varchar,getdate(),109)

--if @Dealer='' or @Dealer='ALL' 

--begin

		--		

		print 'ACT1'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd 

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		--and ps.Segment_Type=@SegmentType

		

--end 

--else

--begin

--		print 'ACT2'

--		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

--		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

--		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

--		where ps.Branch_cd=aub.Branch_cd

--		--and ps.emp_no=aub.dealers

--		and ps.FromDate<=@ToDate

--		and ps.ToDate>=@FromDate

--		and ps.Emp_No>=@FromDealer

--		and ps.Emp_No<=@ToDealer

--		--and ps.Segment_Type=@SegmentType

--end





--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------

if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')

begin

print 'TradingMode or ClientGrade'

if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)

if @ClientGrade='ALL' set @ClientGrade='%'

--

update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating

From angelclient1 ac1,#PartyDetails ps

where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode

and ac1.AngelClRating like @ClientGrade

--

delete #PartyDetails where isnull(EbrokingClient,'')=''

--

end

-----------------------Update #PartyDetails as per report Wise option -------------------------------------

--print '1.1:'+convert(varchar,getdate(),109)

if @Wise='SUBBROKER'

begin

	update #PartyDetails set Emp_No=''

end 

-----------------------Update FirstTrade date -------------------------------------

if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))

begin

	

	if(@SegmentType in('COMMODITY'))

	begin

		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end

	else if(@SegmentType in('CURRENCY'))

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end		

	else --if(@SegmentType in('CASH','DERIVATIVE') and other

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTrade 

		from angelclient1 ac1 with(nolock),#PartyDetails ps 

		where ac1.Party_Code=ps.Party_Code

	end

end



--------------------------Fetch Brokerage in case when required-------------------------





if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))

begin

print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)

/*print 'Segment'

print @SegmentTypeFrom

print @SegmentTypeTo

print 'Eff Date'

print @FromEffSaudaDate

print @ToEffSaudaDate

print 'Date'

print @FromDate

print @ToDate*/

/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 

from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */

--



insert into #BrokTurnOver

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 

		TotalTurnover = 0,--L.Overall_turnover,

		Online_TurnOver=0,--L.ebrok_TurnOver,

		Offline_TurnOver=0,--(L.Overall_turnover-L.ebrok_TurnOver),

		GrossRevenue=L.Overall_brok_earned,

		GrossRevenue_Online=0,--L.ebrok_brok_earned,

		GrossRevenue_Offline=0,--(L.Overall_brok_earned-L.ebrok_brok_earned),

		NetRevenue=0,--(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue_Online=0,--(L.ebrok_brok_earned-L.ebrok_Angel_share),

		NetRevenue_Offline=0,--(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date,

		trade_month='',--datename(month,L.sauda_date),

		intTrademonth=0, intTradeYear=0,



		MonthFirstDate= '',--DATEADD(dd, -DAY(L.sauda_date) + 1, L.sauda_date),

		--MonthLastDate=case when datename(month,getdate())=datename(month,L.sauda_date) then datename(month,getdate())  else DATEADD(dd, -DAY(DATEADD(mm, 1, L.sauda_date)), DATEADD(mm, 1, L.sauda_date)) end

		MonthLastDate= ''--left(DATEADD(dd, -DAY(DATEADD(mm, 1, L.sauda_date)), DATEADD(mm, 1, L.sauda_date)),11) + ' 23:59' 



  

		from #PartyDetails ps ,

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 

		and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 

		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table

		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date

		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		

		

		update #BrokTurnOver

		set trade_month=datename(month,sauda_date),

		MonthFirstDate= DATEADD(dd, -DAY(sauda_date) + 1, sauda_date),

		intTrademonth =datepart(month,sauda_date),

		intTradeYear =datename(year,sauda_date),



		--MonthLastDate=case when datename(month,getdate())=datename(month,L.sauda_date) then datename(month,getdate())  else DATEADD(dd, -DAY(DATEADD(mm, 1, L.sauda_date)), DATEADD(mm, 1, L.sauda_date)) end

		MonthLastDate= left(DATEADD(dd, -DAY(DATEADD(mm, 1, sauda_date)), DATEADD(mm, 1, sauda_date)),11) + ' 23:59' 



		

	

print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)



end

---------------------MAIN PAGE---------------------------------

if @ReportType='MAIN'

begin







	

select 

	distinct Branch_cd,Emp_No,trade_month,Brokerage = sum(GrossRevenue),MonthFirstDate,MonthLastDate,

	Act_Days=dbo.GetWorkingDays(MonthFirstDate,MonthLastDate) ,

	H_days=(select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

						where holidaydate >= MonthFirstDate and holidaydate <= MonthLastDate),

	TradeDays=(select Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= MonthFirstDate and sauda_date <= MonthLastDate and CMTradingDay = 'Y'),

	intTrademonth,		intTradeYear,

	DailyTradedClients_AR=CAST(0 as money),

	RegClients=cast(0 as money)

					

into #temp_dealerData 					

from 

	#BrokTurnOver

group by Branch_cd,Emp_No,trade_month,MonthFirstDate,MonthLastDate,intTrademonth,		intTradeYear

order by Branch_cd,emp_no,MonthFirstDate

OPTION (recompile);







if(@UserStatusId='SBDEALER')

begin

	select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money),trade_month=datename(month,A.sauda_date)--,TradeDays=cast(count(distinct sauda_date) as money) 

		into #RegActiveClients

		from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)

		from #PartyDetails ps,Table_Date TD with(nolock) 

		where TD.sauda_date>=@FromDate 

		and TD.sauda_date<=@ToDate

		and FromDate<=TD.sauda_date

		and ToDate>TD.sauda_date

		and TD.CmTradingDay = 'Y'        

		group by Sauda_date,Branch_cd,Emp_no)A 

		group by Branch_cd,Emp_no,datename(month,A.sauda_date)	

			



	update #temp_dealerData set 

	DailyTradedClients_AR=A.DailyTradedClients

	from 

	(select b.Branch_cd,b.Emp_No,trade_month,

	 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)

	 

 		from #BrokTurnOver b,TABLE_DATE TD with(nolock)

			where TD.CMTradingDay='Y'

			and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)

		group by b.Branch_cd,b.Emp_No,trade_month

		)A,	#temp_dealerData B

	where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No and A.trade_month=B.trade_month



	update #temp_dealerData set RegClients=A.RegClients

	from #RegActiveClients A,	#temp_dealerData B

	where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No and A.trade_month=B.trade_month

end



			

---------------------------------------------------------Update AS ON CLIENTS----------------------------------

print '3.2:'+convert(varchar,getdate(),109)

		

		--------------------------------Calculate Productivity--------------------------------------------------------------

		if @Wise='DEALER'

		begin

			select 

				distinct 

					EMP_NO, 

					First_Name=ISNULL(First_Name,LEFT(Emp_name,4)),

					Emp_name,

					Brokerage = cast(0 as money), 

					ah.CTC, HOD='',

					RMFlag=cast((case when ah.isDealer='1' then 'DEALER' else '' end )as varchar(10)),

					First_Name_for_dd=ISNULL(First_Name,LEFT(Emp_name,4))

				into 

					#ProdForCurr 

				from 

					B2B_AngelHarmony ah with(nolock)

				where 

					ah.Status='A' and 

					EMP_NO in (select EMP_NO from #PartyDetails)		

				

				

						

			if(@UserStatusId='SUBBROKER')

			begin

				--Part 1

				

				select 

					distinct ah.emp_no,First_Name,Emp_name,First_Name_for_dd from #ProdForCurr ah ,#temp_dealerData mis 

				where 

					mis.Emp_No=ah.EMP_NO and 

					ah.RMFlag='DEALER'

				union 

				select  emp_no='Dealers Average',First_Name='Del Avg',Emp_name='Dealers Average',First_Name_for_dd='Dealers Average' from #temp_dealerData mis ,#ProdForCurr ah

				

				

				--select

				--	Branch_cd,mis.Emp_No,trade_month,ctc.LastSalary,mis.Brokerage,

				--	Productivity=(case when (Act_Days-H_days)>0 and (ctc.LastSalary)*TradeDays>0  

				--				then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 

				--				else '0.00' end),mis.MonthFirstDate

				--from 

				--	#temp_dealerData mis left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No --, --#ProdForCurr ah,

				--where 

					

				--	--ah.RMFlag='DEALER' and

				--	mis.intTradeYear=ctc.Year and

				--	mis.intTrademonth=ctc.Month

				--order by Emp_No	

				

				--return

				--Part 2

				select

					Branch_cd,ah.Emp_No,trade_month=LEFT(trade_month,3)+' ' +cast(mis.intTradeYear as varchar),ctc=isnull(ctc.LastSalary,0),mis.Brokerage,First_Name,Emp_name,

					Productivity=(case when (Act_Days-H_days)>0 and (ctc.LastSalary)*TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 

								else '0.00' end),mis.MonthFirstDate

				from 

					#temp_dealerData mis  left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No and mis.intTradeYear=ctc.Year and

					mis.intTrademonth=ctc.Month,#ProdForCurr ah

				where 

					mis.Emp_No=ah.EMP_NO and 

					ah.RMFlag='DEALER'

					

				--group by Branch_cd,ah.Emp_No,mis.MonthFirstDate,trade_month,Act_Days,H_days,TradeDays	,First_Name,Emp_name,ctc.LastSalary

					

				union all

				 

				select

					Branch_cd,Emp_No='Dealers Average',trade_month=LEFT(trade_month,3)+' ' +cast(mis.intTradeYear as varchar),ctc=sum(isnull(ctc.LastSalary,0)),Brokerage=sum(mis.Brokerage),First_Name='Dealers Average',Emp_name='Dealers Average',

					Productivity=(case when (Act_Days-H_days)>0 and sum(ctc.LastSalary)*TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(sum(mis.Brokerage) / (sum(ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 

								else '0.00' end),mis.MonthFirstDate

				from 

					#temp_dealerData mis  left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No and mis.intTradeYear=ctc.Year and mis.intTrademonth=ctc.Month ,#ProdForCurr ah

				where 

					mis.Emp_No=ah.EMP_NO and 

					ah.RMFlag='DEALER' 	

					group by Branch_cd,mis.MonthFirstDate,trade_month,Act_Days,H_days,TradeDays,mis.intTradeYear

			end

			

			if(@UserStatusId='SBDEALER')

			begin

				select distinct mis.emp_no,First_Name,Emp_name from #temp_dealerData mis ,#ProdForCurr ah

				where 

					mis.Emp_No=ah.EMP_NO and 

					ah.RMFlag='DEALER'

					and mis.Emp_No=@UserEmp_No

				union

				select  emp_no='Dealers Average',First_Name='Del Avg',Emp_name='Dealers Average' from #temp_dealerData mis ,#ProdForCurr ah

				

				select

					Branch_cd='',ah.Emp_No,trade_month=LEFT(trade_month,3)+' ' +cast(mis.intTradeYear as varchar),CTC=(ctc.LastSalary),Brokerage=sum(mis.Brokerage),First_Name,Emp_name,

					Productivity=(case when (Act_Days-H_days)>0 and (ctc.LastSalary)*TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(sum(mis.Brokerage) / ((ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 

								else '0.00' end),mis.MonthFirstDate,

					ActivationRatio=case when sum(RegClients)>0 and sum(DailyTradedClients_AR)>0 then convert(decimal(10,2),(sum(DailyTradedClients_AR)/sum(RegClients))*100) else 0 end			

				from 

					#temp_dealerData mis left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No ,#ProdForCurr ah

				where 

					mis.Emp_No=ah.EMP_NO and 

					ah.RMFlag='DEALER'

					and mis.Emp_No=@UserEmp_No and

					mis.intTradeYear=ctc.Year and

					mis.intTrademonth=ctc.Month

				group by ah.Emp_No,mis.MonthFirstDate,trade_month,Act_Days,H_days,TradeDays,mis.intTradeYear,First_Name,Emp_name,ctc.LastSalary

				union all

				 

				select

					Branch_cd,Emp_No='Dealers Average',trade_month=LEFT(trade_month,3)+' ' +cast(mis.intTradeYear as varchar),CTC=sum(isnull(ctc.LastSalary,0)),Brokerage=sum(mis.Brokerage),First_Name='Del Avg',Emp_name='Dealers Average',

					Productivity=(case when (Act_Days-H_days)>0 and sum(ctc.LastSalary)*TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(sum(mis.Brokerage) / (sum(ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 

								else '0.00' end),mis.MonthFirstDate,

					ActivationRatio=case when sum(RegClients)>0 and sum(DailyTradedClients_AR)>0 then convert(decimal(10,2),(sum(DailyTradedClients_AR)/sum(RegClients))*100) else 0 end						

				from 

					#temp_dealerData mis left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No and mis.intTradeYear=ctc.Year and mis.intTrademonth=ctc.Month ,#ProdForCurr ah

				where 

					mis.Emp_No=ah.EMP_NO and 

					ah.RMFlag='DEALER' 	

					and mis.Emp_No<>@UserEmp_No

					and mis.Branch_cd=(select sb_tag  from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No)

					

					group by Branch_cd,mis.MonthFirstDate,trade_month,Act_Days,H_days,TradeDays,mis.intTradeYear--,ctc.LastSalary 

					

				

			end	

				

		end

end



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_productivity_bak
-- --------------------------------------------------

create procedure [dbo].[B2bCrms_DashBoard_productivity_bak]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15)='ALL',--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15) ='ALL',--ALL,A+,A,B,C,D
 @SegmentType varchar(20)='ALL',--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20) ='DEALER',       --SUBBROKER/DEALER
 @ReportType varchar(20)='MAIN', --MAIN/DRILL
 @DrillFlag varchar(20) =null,  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 @TotalFlag varchar(2) = null
 as
 BEGIN
/*
exec [B2bCrms_DashBoard_productivity] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='Jan  1 2013',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''


*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'

set  @FromDate=DATEADD(MM,-3,@FromDate)
 
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------

Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime,trade_month varchar(20), MonthFirstDate datetime, MonthLastDate datetime,
intTrademonth int, intTradeYear int)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 --Declare  @MIStable table      
 create table #MIStable                                                     
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
--if @Dealer='' or @Dealer='ALL' 
--begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
--end 
--else
--begin
--		print 'ACT2'
--		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
--		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
--		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
--		where ps.Branch_cd=aub.Branch_cd
--		--and ps.emp_no=aub.dealers
--		and ps.FromDate<=@ToDate
--		and ps.ToDate>=@FromDate
--		and ps.Emp_No>=@FromDealer
--		and ps.Emp_No<=@ToDealer
--		--and ps.Segment_Type=@SegmentType
--end


--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin
	
	if(@SegmentType in('COMMODITY'))
	begin
		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end
	else if(@SegmentType in('CURRENCY'))
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end		
	else --if(@SegmentType in('CASH','DERIVATIVE') and other
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTrade 
		from angelclient1 ac1 with(nolock),#PartyDetails ps 
		where ac1.Party_Code=ps.Party_Code
	end
end
--------------------------Fetch Brokerage in case when required-------------------------


if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

insert into #BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = 0,--L.Overall_turnover,
		Online_TurnOver=0,--L.ebrok_TurnOver,
		Offline_TurnOver=0,--(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=0,--L.ebrok_brok_earned,
		GrossRevenue_Offline=0,--(L.Overall_brok_earned-L.ebrok_brok_earned),
		NetRevenue=0,--(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue_Online=0,--(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=0,--(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date,
		trade_month='',--datename(month,L.sauda_date),
		intTrademonth=0, intTradeYear=0,

		MonthFirstDate= '',--DATEADD(dd, -DAY(L.sauda_date) + 1, L.sauda_date),
		--MonthLastDate=case when datename(month,getdate())=datename(month,L.sauda_date) then datename(month,getdate())  else DATEADD(dd, -DAY(DATEADD(mm, 1, L.sauda_date)), DATEADD(mm, 1, L.sauda_date)) end
		MonthLastDate= ''--left(DATEADD(dd, -DAY(DATEADD(mm, 1, L.sauda_date)), DATEADD(mm, 1, L.sauda_date)),11) + ' 23:59' 

  
		from #PartyDetails ps ,
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		
		
		update #BrokTurnOver
		set trade_month=datename(month,sauda_date),
		MonthFirstDate= DATEADD(dd, -DAY(sauda_date) + 1, sauda_date),
		intTrademonth =datepart(month,sauda_date),
		intTradeYear =datename(year,sauda_date),

		--MonthLastDate=case when datename(month,getdate())=datename(month,L.sauda_date) then datename(month,getdate())  else DATEADD(dd, -DAY(DATEADD(mm, 1, L.sauda_date)), DATEADD(mm, 1, L.sauda_date)) end
		MonthLastDate= left(DATEADD(dd, -DAY(DATEADD(mm, 1, sauda_date)), DATEADD(mm, 1, sauda_date)),11) + ' 23:59' 

		
	
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin
	
select 
	distinct Branch_cd,Emp_No,trade_month,Brokerage = sum(GrossRevenue),MonthFirstDate,MonthLastDate,
	Act_Days=dbo.GetWorkingDays(MonthFirstDate,MonthLastDate) ,
	H_days=(select  count(distinct holidaydate)  from [196.1.115.207].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= MonthFirstDate and holidaydate <= MonthLastDate),
	TradeDays=(select Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= MonthFirstDate and sauda_date <= MonthLastDate and CMTradingDay = 'Y'),
	intTrademonth,		intTradeYear,
	DailyTradedClients_AR=CAST(0 as money),
	RegClients=cast(0 as money)
					
into #temp_dealerData 					
from 
	#BrokTurnOver
group by Branch_cd,Emp_No,trade_month,MonthFirstDate,MonthLastDate,intTrademonth,		intTradeYear
order by Branch_cd,emp_no,MonthFirstDate
OPTION (recompile);

if(@UserStatusId='SBDEALER')
begin
	select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money),trade_month=datename(month,A.sauda_date)--,TradeDays=cast(count(distinct sauda_date) as money) 
		into #RegActiveClients
		from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
		from #PartyDetails ps,Table_Date TD with(nolock) 
		where TD.sauda_date>=@FromDate 
		and TD.sauda_date<=@ToDate
		and FromDate<=TD.sauda_date
		and ToDate>TD.sauda_date
		and TD.CmTradingDay = 'Y'        
		group by Sauda_date,Branch_cd,Emp_no)A 
		group by Branch_cd,Emp_no,datename(month,A.sauda_date)	
			

	update #temp_dealerData set 
	DailyTradedClients_AR=A.DailyTradedClients
	from 
	(select b.Branch_cd,b.Emp_No,trade_month,
	 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
	 
 		from #BrokTurnOver b,TABLE_DATE TD with(nolock)
			where TD.CMTradingDay='Y'
			and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
		group by b.Branch_cd,b.Emp_No,trade_month
		)A,	#temp_dealerData B
	where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No and A.trade_month=B.trade_month

	update #temp_dealerData set RegClients=A.RegClients
	from #RegActiveClients A,	#temp_dealerData B
	where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No and A.trade_month=B.trade_month
end

			
---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
		
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			select 
				distinct 
					EMP_NO, 
					First_Name=ISNULL(First_Name,LEFT(Emp_name,4)),
					Emp_name,
					Brokerage = cast(0 as money), 
					ah.CTC, HOD='',
					RMFlag=cast((case when ah.isDealer='1' then 'DEALER' else '' end )as varchar(10))
				into 
					#ProdForCurr 
				from 
					B2B_AngelHarmony ah with(nolock)
				where 
					ah.Status='A' and 
					EMP_NO in (select EMP_NO from #PartyDetails)		
			
	
						
			if(@UserStatusId='SUBBROKER')
			begin
				--Part 1
				
				select 
					distinct ah.emp_no,First_Name,Emp_name from #ProdForCurr ah left outer join #temp_dealerData mis on mis.Emp_No=ah.EMP_NO
				where 
					--mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER'
				union 
				select  emp_no='Dealers Average',First_Name='Dealers Average',Emp_name='Dealers Average' from #temp_dealerData mis ,#ProdForCurr ah
				
				
				--select
				--	Branch_cd,mis.Emp_No,trade_month,ctc.LastSalary,mis.Brokerage,
				--	Productivity=(case when (Act_Days-H_days)>0 and (ctc.LastSalary)*TradeDays>0  
				--				then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 
				--				else '0.00' end),mis.MonthFirstDate
				--from 
				--	#temp_dealerData mis left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No --, --#ProdForCurr ah,
				--where 
					
				--	--ah.RMFlag='DEALER' and
				--	mis.intTradeYear=ctc.Year and
				--	mis.intTrademonth=ctc.Month
				--order by Emp_No	
				
				--return
				--Part 2
				select
					Branch_cd,ah.Emp_No,trade_month,ah.CTC,mis.Brokerage,First_Name,Emp_name,
					Productivity=(case when (Act_Days-H_days)>0 and (ah.CTC)*TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*TradeDays/(Act_Days-H_days))))) 
								else '0.00' end),mis.MonthFirstDate
				from 
					#temp_dealerData mis,#ProdForCurr ah
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER'
					
				union all
				 
				select
					Branch_cd,Emp_No='Dealers Average',trade_month,ctc=sum(ah.CTC),Brokerage=sum(mis.Brokerage),First_Name='Dealers Average',Emp_name='Dealers Average',
					Productivity=(case when (Act_Days-H_days)>0 and sum(ah.CTC)*TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(sum(mis.Brokerage) / (sum(ah.CTC)*TradeDays/(Act_Days-H_days))))) 
								else '0.00' end),mis.MonthFirstDate
				from 
					#temp_dealerData mis,#ProdForCurr ah
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER' 	
					group by Branch_cd,mis.MonthFirstDate,trade_month,Act_Days,H_days,TradeDays
			end
			
			if(@UserStatusId='SBDEALER')
			begin
				select distinct mis.emp_no,First_Name,Emp_name from #temp_dealerData mis ,#ProdForCurr ah
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER'
					and mis.Emp_No=@UserEmp_No
				union
				select  emp_no='Dealers Average',First_Name='Dealers Average',Emp_name='Dealers Average' from #temp_dealerData mis ,#ProdForCurr ah
				
				select
					Branch_cd='',ah.Emp_No,trade_month,ah.CTC,mis.Brokerage,First_Name,Emp_name,
					Productivity=(case when (Act_Days-H_days)>0 and (ah.CTC)*TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*TradeDays/(Act_Days-H_days))))) 
								else '0.00' end),mis.MonthFirstDate,
					ActivationRatio=case when RegClients>0 and DailyTradedClients_AR>0 then (DailyTradedClients_AR/RegClients)*100 else 0 end			
				from 
					#temp_dealerData mis,#ProdForCurr ah
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER'
					and mis.Emp_No=@UserEmp_No
					
				union all
				 
				select
					Branch_cd,Emp_No='Dealers Average',trade_month,ctc=sum(ah.CTC),Brokerage=sum(mis.Brokerage),First_Name='Dealers Average',Emp_name='Dealers Average',
					Productivity=(case when (Act_Days-H_days)>0 and sum(ah.CTC)*TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(sum(mis.Brokerage) / (sum(ah.CTC)*TradeDays/(Act_Days-H_days))))) 
								else '0.00' end),mis.MonthFirstDate,
					ActivationRatio=case when sum(RegClients)>0 and sum(DailyTradedClients_AR)>0 then (sum(DailyTradedClients_AR)/sum(RegClients))*100 else 0 end						
				from 
					#temp_dealerData mis,#ProdForCurr ah
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER' 	
					and mis.Emp_No<>@UserEmp_No
					and mis.Branch_cd=(select sb_tag  from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No)
					group by Branch_cd,mis.MonthFirstDate,trade_month,Act_Days,H_days,TradeDays 
			end	
				
		end
end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_productivity_bak2
-- --------------------------------------------------

create procedure [dbo].[B2bCrms_DashBoard_productivity_bak2]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15)='ALL',--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15) ='ALL',--ALL,A+,A,B,C,D
 @SegmentType varchar(20)='ALL',--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20) ='DEALER',       --SUBBROKER/DEALER
 @ReportType varchar(20)='MAIN', --MAIN/DRILL
 @DrillFlag varchar(20) =null,  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 @TotalFlag varchar(2) = null
 as
 BEGIN
/*
exec [B2bCrms_DashBoard_productivity] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='Jan  1 2013',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''


*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'

set  @FromDate=DATEADD(MM,-3,@FromDate)
 
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------

Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime,trade_month varchar(20), MonthFirstDate datetime, MonthLastDate datetime,
intTrademonth int, intTradeYear int)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 --Declare  @MIStable table      
 create table #MIStable                                                     
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
--if @Dealer='' or @Dealer='ALL' 
--begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
--end 
--else
--begin
--		print 'ACT2'
--		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
--		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
--		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
--		where ps.Branch_cd=aub.Branch_cd
--		--and ps.emp_no=aub.dealers
--		and ps.FromDate<=@ToDate
--		and ps.ToDate>=@FromDate
--		and ps.Emp_No>=@FromDealer
--		and ps.Emp_No<=@ToDealer
--		--and ps.Segment_Type=@SegmentType
--end


--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin
	
	if(@SegmentType in('COMMODITY'))
	begin
		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end
	else if(@SegmentType in('CURRENCY'))
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end		
	else --if(@SegmentType in('CASH','DERIVATIVE') and other
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTrade 
		from angelclient1 ac1 with(nolock),#PartyDetails ps 
		where ac1.Party_Code=ps.Party_Code
	end
end

--------------------------Fetch Brokerage in case when required-------------------------


if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

insert into #BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = 0,--L.Overall_turnover,
		Online_TurnOver=0,--L.ebrok_TurnOver,
		Offline_TurnOver=0,--(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=0,--L.ebrok_brok_earned,
		GrossRevenue_Offline=0,--(L.Overall_brok_earned-L.ebrok_brok_earned),
		NetRevenue=0,--(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue_Online=0,--(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=0,--(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date,
		trade_month='',--datename(month,L.sauda_date),
		intTrademonth=0, intTradeYear=0,

		MonthFirstDate= '',--DATEADD(dd, -DAY(L.sauda_date) + 1, L.sauda_date),
		--MonthLastDate=case when datename(month,getdate())=datename(month,L.sauda_date) then datename(month,getdate())  else DATEADD(dd, -DAY(DATEADD(mm, 1, L.sauda_date)), DATEADD(mm, 1, L.sauda_date)) end
		MonthLastDate= ''--left(DATEADD(dd, -DAY(DATEADD(mm, 1, L.sauda_date)), DATEADD(mm, 1, L.sauda_date)),11) + ' 23:59' 

  
		from #PartyDetails ps ,
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		
		
		update #BrokTurnOver
		set trade_month=datename(month,sauda_date),
		MonthFirstDate= DATEADD(dd, -DAY(sauda_date) + 1, sauda_date),
		intTrademonth =datepart(month,sauda_date),
		intTradeYear =datename(year,sauda_date),

		--MonthLastDate=case when datename(month,getdate())=datename(month,L.sauda_date) then datename(month,getdate())  else DATEADD(dd, -DAY(DATEADD(mm, 1, L.sauda_date)), DATEADD(mm, 1, L.sauda_date)) end
		MonthLastDate= left(DATEADD(dd, -DAY(DATEADD(mm, 1, sauda_date)), DATEADD(mm, 1, sauda_date)),11) + ' 23:59' 

		
	
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin



	
select 
	distinct Branch_cd,Emp_No,trade_month,Brokerage = sum(GrossRevenue),MonthFirstDate,MonthLastDate,
	Act_Days=dbo.GetWorkingDays(MonthFirstDate,MonthLastDate) ,
	H_days=(select  count(distinct holidaydate)  from [196.1.115.207].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= MonthFirstDate and holidaydate <= MonthLastDate),
	TradeDays=(select Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= MonthFirstDate and sauda_date <= MonthLastDate and CMTradingDay = 'Y'),
	intTrademonth,		intTradeYear,
	DailyTradedClients_AR=CAST(0 as money),
	RegClients=cast(0 as money)
					
into #temp_dealerData 					
from 
	#BrokTurnOver
group by Branch_cd,Emp_No,trade_month,MonthFirstDate,MonthLastDate,intTrademonth,		intTradeYear
order by Branch_cd,emp_no,MonthFirstDate
OPTION (recompile);



if(@UserStatusId='SBDEALER')
begin
	select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money),trade_month=datename(month,A.sauda_date)--,TradeDays=cast(count(distinct sauda_date) as money) 
		into #RegActiveClients
		from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
		from #PartyDetails ps,Table_Date TD with(nolock) 
		where TD.sauda_date>=@FromDate 
		and TD.sauda_date<=@ToDate
		and FromDate<=TD.sauda_date
		and ToDate>TD.sauda_date
		and TD.CmTradingDay = 'Y'        
		group by Sauda_date,Branch_cd,Emp_no)A 
		group by Branch_cd,Emp_no,datename(month,A.sauda_date)	
			

	update #temp_dealerData set 
	DailyTradedClients_AR=A.DailyTradedClients
	from 
	(select b.Branch_cd,b.Emp_No,trade_month,
	 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
	 
 		from #BrokTurnOver b,TABLE_DATE TD with(nolock)
			where TD.CMTradingDay='Y'
			and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
		group by b.Branch_cd,b.Emp_No,trade_month
		)A,	#temp_dealerData B
	where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No and A.trade_month=B.trade_month

	update #temp_dealerData set RegClients=A.RegClients
	from #RegActiveClients A,	#temp_dealerData B
	where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No and A.trade_month=B.trade_month
end

			
---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
		
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			select 
				distinct 
					EMP_NO, 
					First_Name=ISNULL(First_Name,LEFT(Emp_name,4)),
					Emp_name,
					Brokerage = cast(0 as money), 
					ah.CTC, HOD='',
					RMFlag=cast((case when ah.isDealer='1' then 'DEALER' else '' end )as varchar(10)),
					First_Name_for_dd=ISNULL(First_Name,LEFT(Emp_name,4))
				into 
					#ProdForCurr 
				from 
					B2B_AngelHarmony ah with(nolock)
				where 
					ah.Status='A' and 
					EMP_NO in (select EMP_NO from #PartyDetails)		
				
				
						
			if(@UserStatusId='SUBBROKER')
			begin
				--Part 1
				
				select 
					distinct ah.emp_no,First_Name,Emp_name,First_Name_for_dd from #ProdForCurr ah ,#temp_dealerData mis 
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER'
				union 
				select  emp_no='Dealers Average',First_Name='Del Avg',Emp_name='Dealers Average',First_Name_for_dd='Dealers Average' from #temp_dealerData mis ,#ProdForCurr ah
				
				
				--select
				--	Branch_cd,mis.Emp_No,trade_month,ctc.LastSalary,mis.Brokerage,
				--	Productivity=(case when (Act_Days-H_days)>0 and (ctc.LastSalary)*TradeDays>0  
				--				then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 
				--				else '0.00' end),mis.MonthFirstDate
				--from 
				--	#temp_dealerData mis left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No --, --#ProdForCurr ah,
				--where 
					
				--	--ah.RMFlag='DEALER' and
				--	mis.intTradeYear=ctc.Year and
				--	mis.intTrademonth=ctc.Month
				--order by Emp_No	
				
				--return
				--Part 2
				select
					Branch_cd,ah.Emp_No,trade_month=LEFT(trade_month,3)+' ' +cast(mis.intTradeYear as varchar),ctc=isnull(ctc.LastSalary,0),mis.Brokerage,First_Name,Emp_name,
					Productivity=(case when (Act_Days-H_days)>0 and (ctc.LastSalary)*TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 
								else '0.00' end),mis.MonthFirstDate
				from 
					#temp_dealerData mis  left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No and mis.intTradeYear=ctc.Year and
					mis.intTrademonth=ctc.Month,#ProdForCurr ah
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER'
					
				--group by Branch_cd,ah.Emp_No,mis.MonthFirstDate,trade_month,Act_Days,H_days,TradeDays	,First_Name,Emp_name,ctc.LastSalary
					
				union all
				 
				select
					Branch_cd,Emp_No='Dealers Average',trade_month=LEFT(trade_month,3)+' ' +cast(mis.intTradeYear as varchar),ctc=sum(isnull(ctc.LastSalary,0)),Brokerage=sum(mis.Brokerage),First_Name='Dealers Average',Emp_name='Dealers Average',
					Productivity=(case when (Act_Days-H_days)>0 and sum(ctc.LastSalary)*TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(sum(mis.Brokerage) / (sum(ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 
								else '0.00' end),mis.MonthFirstDate
				from 
					#temp_dealerData mis  left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No and mis.intTradeYear=ctc.Year and mis.intTrademonth=ctc.Month ,#ProdForCurr ah
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER' 	
					group by Branch_cd,mis.MonthFirstDate,trade_month,Act_Days,H_days,TradeDays,mis.intTradeYear
			end
			
			if(@UserStatusId='SBDEALER')
			begin
				select distinct mis.emp_no,First_Name,Emp_name from #temp_dealerData mis ,#ProdForCurr ah
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER'
					and mis.Emp_No=@UserEmp_No
				union
				select  emp_no='Dealers Average',First_Name='Del Avg',Emp_name='Dealers Average' from #temp_dealerData mis ,#ProdForCurr ah
				
				select
					Branch_cd='',ah.Emp_No,trade_month=LEFT(trade_month,3)+' ' +cast(mis.intTradeYear as varchar),CTC=(ctc.LastSalary),Brokerage=sum(mis.Brokerage),First_Name,Emp_name,
					Productivity=(case when (Act_Days-H_days)>0 and (ctc.LastSalary)*TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(sum(mis.Brokerage) / ((ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 
								else '0.00' end),mis.MonthFirstDate,
					ActivationRatio=case when sum(RegClients)>0 and sum(DailyTradedClients_AR)>0 then convert(decimal(10,2),(sum(DailyTradedClients_AR)/sum(RegClients))*100) else 0 end			
				from 
					#temp_dealerData mis left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No ,#ProdForCurr ah
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER'
					and mis.Emp_No=@UserEmp_No and
					mis.intTradeYear=ctc.Year and
					mis.intTrademonth=ctc.Month
				group by ah.Emp_No,mis.MonthFirstDate,trade_month,Act_Days,H_days,TradeDays,mis.intTradeYear,First_Name,Emp_name,ctc.LastSalary
				union all
				 
				select
					Branch_cd,Emp_No='Dealers Average',trade_month=LEFT(trade_month,3)+' ' +cast(mis.intTradeYear as varchar),CTC=sum(isnull(ctc.LastSalary,0)),Brokerage=sum(mis.Brokerage),First_Name='Del Avg',Emp_name='Dealers Average',
					Productivity=(case when (Act_Days-H_days)>0 and sum(ctc.LastSalary)*TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(sum(mis.Brokerage) / (sum(ctc.LastSalary)*TradeDays/(Act_Days-H_days))))) 
								else '0.00' end),mis.MonthFirstDate,
					ActivationRatio=case when sum(RegClients)>0 and sum(DailyTradedClients_AR)>0 then convert(decimal(10,2),(sum(DailyTradedClients_AR)/sum(RegClients))*100) else 0 end						
				from 
					#temp_dealerData mis left outer join  tbl_Emp_Salary_Increment_Dashboard ctc on mis.emp_no=ctc.Emp_No and mis.intTradeYear=ctc.Year and mis.intTrademonth=ctc.Month ,#ProdForCurr ah
				where 
					mis.Emp_No=ah.EMP_NO and 
					ah.RMFlag='DEALER' 	
					and mis.Emp_No<>@UserEmp_No
					and mis.Branch_cd=(select sb_tag  from B2B_AngelHarmony with(nolock) where emp_no=@UserEmp_No)
					
					group by Branch_cd,mis.MonthFirstDate,trade_month,Act_Days,H_days,TradeDays,mis.intTradeYear--,ctc.LastSalary 
					
				
			end	
				
		end
end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_TargetTurnover
-- --------------------------------------------------


CREATE procedure [dbo].[B2bCrms_DashBoard_TargetTurnover]

(

	@UserEmp_No varchar(20),

	@UserStatusId varchar(20),--SUBBROKER/SBDEALER

	@Statusname varchar(20),

	@Sub_Broker varchar(10),

	@Dealer varchar(20)

	

)

as

begin

	/*

		exec B2bCrms_DashBoard 'et001','SUBBROKER','','ET','','Graph1'

		exec B2bCrms_DashBoard 'etA001','SUBBROKER','','ETA','','Graph1'

		exec B2bCrms_DashBoard 'ett001','SUBBROKER','','ETT','','Graph1'

		exec B2bCrms_DashBoard 'Ca001','SUBBROKER','','CA','','Graph1'

		exec B2bCrms_DashBoard 'etA001','SUBBROKER','','ETA','','Graph1'

		exec B2bCrms_DashBoard_TargetTurnover 'et001','SUBBROKER','','ET','','Graph2'

		exec B2bCrms_DashBoard 'eta008','SBDEALER','','','ETA008','Graph2'

		exec B2bCrms_DashBoard 'eta008','SBDEALER','','','ETA008','Graph1'

		exec B2bCrms_DashBoard 'eta007','SBDEALER','','','ETA007','Graph1'

		exec B2bCrms_DashBoard 'ETA007','SBDEALER','','','ETA007','GRAPH1'

	*/

	--WAITFOR DELAY '00:01:05'

	print 'Start:'+convert(varchar,getdate(),109)

	

	

	Declare @ToDate smalldatetime

	Declare @FromDate smalldatetime

	

	Declare @FromSub_Broker varchar(10)

	Declare @ToSub_Broker varchar(10)

	Declare @FromDealer varchar(10)

	Declare @ToDealer varchar(10)

	Declare @FromEffSaudaDate datetime

	Declare @ToEffSaudaDate datetime

	Declare @SegmentTypeFrom varchar(10)

	Declare @SegmentTypeTo varchar(10)

	Declare @TradingMode varchar(20)

    Declare @ClientGrade varchar(20)

    Declare @TradeDays int

    DECLARE @@Errorcount int                                                                                 

	

	SET @@Errorcount = 0 

 

	set @SegmentTypeFrom ='0000'

	set @SegmentTypeTo ='ZZZZZ'

	

	set @TradingMode='%'

	set @ClientGrade='%'

	

	

	set @FromDate=left(CONVERT(smalldatetime,DATEADD(dd,-(DAY(GETDATE())-1),getdate())),11)+' 00:00'

	set @ToDate=left(CONVERT(smalldatetime,GETDATE()),11)+' 00:00'



	--print @FromDate

	--print @ToDate

	

	select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=GETDATE() 

	from (select top 15 Sauda_date=Sauda_date from TABLE_DATE where CMTradingDay='y'  and date<getdate()  order by date desc)a

	 

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromEffSaudaDate and sauda_date <= @ToEffSaudaDate and CurrTradingDay = 'Y'

	 

	/**subbroker*/

	if @Sub_Broker='' or @Sub_Broker='ALL' 

	Begin

		set @FromSub_Broker='A'

		set @ToSub_Broker='ZZZZZZZ'

	End

	else

	Begin

		Set @FromSub_Broker=@Sub_Broker

		Set @ToSub_Broker=@Sub_Broker

	End

	

	if @Dealer='' or @Dealer='ALL' 

	begin

		set @FromDealer='A'

		set @ToDealer='ZZZZZZZ'

	end

	else

	begin

		set @FromDealer=@Dealer

		set @ToDealer=@Dealer

	end

	

	create table #PartyDetails 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime

	,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

	--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

	)

	

	create table #BrokTurnOver 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),

	TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

	NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

	Sauda_date smalldatetime

	)

	

	

	--------------------------User Access---------------------------------------------------



	/*fill subbrokers and dealers*/

	declare @tempbranch  table                                                                

	(                                                                

	Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

	)

	

	Insert into @tempbranch

	select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

	



	

	

	

	

	print '2.1. Party Details Process Start:'+convert(varchar,getdate(),109)

	

	insert into 

		#PartyDetails 

		(Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

	select

		ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

	from 

		B2B_CommonPartyServices ps with(nolock),@tempbranch aub

	where 

		ps.Branch_cd=aub.Branch_cd 

		and ps.FromDate<=@ToEffSaudaDate

		and ps.ToDate>=@FromEffSaudaDate

	

	update 

		#PartyDetails 

	set 

		EbrokingClient=ac1.EbrokingClient,

		AngelClRating=ac1.AngelClRating

	From 

		angelclient1 ac1 with(nolock),#PartyDetails ps

	where 

		ac1.Party_Code=ps.Party_Code and 

		ac1.EbrokingClient like @TradingMode

		and ac1.AngelClRating like @ClientGrade

	

	delete #PartyDetails where isnull(EbrokingClient,'')=''

	

	print '2.1. Party Details Process Ends:'+convert(varchar,getdate(),109)

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

	

	--select 

	--	ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

	--into 

	--	#ActivarionRatio	

	--from 

	--	#PartyDetails ps

	--where 

	--	ps.FromDate<=@ToEffSaudaDate

	--	and ps.ToDate>=@ToEffSaudaDate		

	--group by 

	--	ps.Branch_cd,ps.Emp_No

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)	

	



	

	insert into #BrokTurnOver

	(

		Party_Code,

		Branch_cd,

		Emp_No, 

		TotalTurnover,

		NetRevenue,

		Sauda_date 

		)

		select 

		ps.Party_Code,

		ps.Branch_cd,

		ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		--Online_TurnOver=L.ebrok_TurnOver,

		--Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		--GrossRevenue=L.Overall_brok_earned,

		--GrossRevenue_Online=L.ebrok_brok_earned,

		--GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		--NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,		

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock)--, TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		AND EM.FromDate <= @FromEffSaudaDate 

		AND EM.ToDate >= @ToEffSaudaDate 

		and ps.FromDate<=L.sauda_date 

		and ps.ToDate>=L.sauda_date

		and L.Sauda_date>= @FromEffSaudaDate 

		and L.Sauda_date<= @ToEffSaudaDate 

	

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)

	--select * from @BrokTurnOver

	--return

	

	print '2.4. RTO in process check Starts:'+convert(varchar,getdate(),109)		

	

	declare @@MSG varchar(200)                  

	set @@MSG='Report is in process. Please wait for few minutes.'                    

	if (select Processon from [MIMANSA].crm.dbo.Tbl_tradingdataupprocess with(nolock)) = 'Y'                    

	begin                    

		select msg=@@MSG                  

		return                    

	end 

	

	print '2.4. RTO in process check End:'+convert(varchar,getdate(),109)	

	

	if(@UserStatusId='SUBBROKER')

	begin

	

			print '2.5. RTO Data Fetch Start:'+convert(varchar,getdate(),109)		

			print '-------------------------------------------------------------------------------'

			

			declare @rto_Data table(

			Zone varchar(20),Region varchar(20),branch_cd varchar(20),B2BRM varchar(20),B2BRM_Name varchar(100),emp_no varchar(20),emp_name varchar(100),                                    

							ActiveCLEq money,ActiveCLComm money, ActiveCLCurr money,                                

							TOToTimeCash money,

							TOToTimeFUT money ,

							TOToTimeOPT money  ,

							TOToTimeComm money ,

							TOToTimeCurr money ,                                  

							CLToTimeCash money,

							CLToTimeFUT money,

							CLToTimeOPT money,

							CLToTimeComm money,

							CLToTimeCURR money,                    

							TotalTO money,

							TotalCL money,

							Optnooflots bigint

			)	

			

			insert into @rto_Data

			---exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch=@Sub_Broker,

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='MAIN',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID=@UserStatusId,

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'

			

			set @@Errorcount = @@error                                                                  

			If @@Errorcount <> 0 Goto LabelEnd        



			print '-------------------------------------------------------------------------------'

			print '2.5. RTO Data Fetch End:'+convert(varchar,getdate(),109)		

			

			print '2.6. Output Data Start:'+convert(varchar,getdate(),109)	

			



			

			declare @tempDashboardData table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money

			)

			

			insert into @tempDashboardData

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0

				

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			---------------------------------------------------

			

			

			update @tempDashboardData set ctc=c.CTC

			from @tempDashboardData emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			



			

						

			update @tempDashboardData set TargetTurnover= a.TargetTurnover

			from @tempDashboardData emp1,(

			select 

				emp_no=emp.emp_no,

				--TargetTurnover =cast((12*emp.ctc) as money)/(sum(NetRevenue)/sum(TotalTurnover))

				TargetTurnover =cast((12*emp.ctc) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))

			

			from 

				@tempDashboardData emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no	,  emp.ctc

			)a

			where emp1.emp_no =a.emp_no

			

			

							

			update @tempDashboardData set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			

			--update @tempDashboardData set ClientBase=isnull((TotalClientsAsonDate),0)

			--from @tempDashboardData emp ,#ActivarionRatio d 

			--where emp.Emp_No = d.emp_no

			

			

			

			select 

			sb_tag=t1.sb_tag,

			emp_no=t1.emp_no,

				TargetTurnover=Case when TargetTurnover>0 then CONVERT(decimal(10,0),TargetTurnover/100000) else 0 end,

				ActualAchivedTO=CONVERT(decimal(10,0),ActualAchivedTO/100000),

				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

				ClientBase = CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end,

				Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),7)

			from @tempDashboardData t1, B2B_AngelHarmony ah with(nolock)

					where t1.Emp_No=ah.EMP_NO

			order by t1.emp_no 

			

			print '2.7. Output Data End:'+convert(varchar,getdate(),109)	

			

	print '1.5.END.:'+convert(varchar,getdate(),109)

			 

	end

	else

	begin

		print 'DEALER'

		declare @sb_tag1 varchar(20)

		declare @sb_admin1 varchar(20)

		

		select @sb_tag1=sb_tag from B2B_AngelHarmony where emp_no=@Dealer

		select @sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@sb_tag1 and isAdmin='1'

		

		insert into @rto_Data

		--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

		exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

		@Emp_no=@sb_admin1,

		@Zone='',

		@Region='',

		@Branch=@sb_tag1,

		@Exec='',

		@FromTime='09:00 AM',

		@ToTime='11:59 PM',

		@MainDrill='MAIN',

		@WiseReport='SBDEALER',

		@seg='ALL',

		@B2CStatus='B2B',

		@MimStatusID='SUBBROKER',

		@SB='',

		@RoundValue='1',

		@DownloadCSVFlag='Y'	

		

		set @@Errorcount = @@error                                                                  

		If @@Errorcount <> 0 Goto LabelEnd        

	

	declare @tempDashboardData1 table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money,

				status varchar(10)

			)

			

			insert into @tempDashboardData1

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc,

				status

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0,

				status=0

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			

			update @tempDashboardData1 set ctc=c.CTC,status=isAdmin

			from @tempDashboardData1 emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

			

			

			update @tempDashboardData1 set TargetTurnover= case when a.TargetTurnover >0 then a.TargetTurnover else 0 end

			from @tempDashboardData1 emp1,(

			select 

				emp_no=emp.emp_no,

				TargetTurnover =cast((12*emp.ctc) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))

			

			from 

				@tempDashboardData1 emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no,emp.ctc	  

			)a

			where emp1.emp_no =a.emp_no

			

			update @tempDashboardData1 set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData1 emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			

			

			

			select 

			sb_tag=t1.sb_tag,

			emp_no=t1.emp_no,

				TargetTurnover=CONVERT(decimal(10,0),TargetTurnover/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),ActualAchivedTO/100000),

				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

				ClientBase = CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end

			,Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),7)

			from @tempDashboardData1 t1, B2B_AngelHarmony ah with(nolock)

			where t1.Emp_No=ah.EMP_NO

			and t1.emp_no=@dealer

			union all

			

			select 

				sb_tag,

				emp_no='DealerAverage',

				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),

				Activation_Ratio=sum(Activation_Ratio),

				ClientsTraded=sum(ClientsTraded ),

				ClientBase=sum(ClientBase) ,

				PercentageTurnoverAchievedTillTime=SUM(PercentageTurnoverAchievedTillTime),

				Emp_Name='Average',Emp_First_Name='Average'

				from  (

						select 

							sb_tag,

							emp_no,

							TargetTurnover,

							ActualAchivedTO,

							Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

							ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

							ClientBase = CONVERT(decimal(10,0),ClientBase),

							PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end

						from @tempDashboardData1 

						where emp_no<>@dealer

				)a

				group by a.sb_tag

		

	

	

	 	 

	end

		LabelEnd:                                                      

		If @@Errorcount <> 0

		begin

			set @@MSG='Report is in process. Please wait for few minutes.'                    

			select msg=@@MSG   

		end	

	

   

 			

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_TaVsAC_Timer
-- --------------------------------------------------


CREATE procedure [dbo].[B2bCrms_DashBoard_TaVsAC_Timer]

(

	@UserEmp_No varchar(20),

	@UserStatusId varchar(20),--SUBBROKER/SBDEALER

	@Statusname varchar(20),

	@Sub_Broker varchar(10),

	@Dealer varchar(20)

	

)

as

begin

	/*

		

		exec B2bCrms_DashBoard_TaVsAC_Timer 'et001','SUBBROKER','','ET','','Graph2'

		

	*/

	--WAITFOR DELAY '00:01:05'

	print 'Start:'+convert(varchar,getdate(),109)

	

	

	declare @@UserEmp_No varchar(20)

	declare @@UserStatusId varchar(20)

	declare @@Statusname varchar(20)

	declare @@Sub_Broker varchar(10)

	declare @@Dealer varchar(20)

	declare @@Report_Type varchar(20)

	

	set @@UserEmp_No =@UserEmp_No

	set @@UserStatusId=@UserStatusId 

	set @@Statusname =@Statusname

	set @@Sub_Broker =@Sub_Broker

	set @@Dealer =@Dealer

	

	

	

	Declare @@ToDate smalldatetime

	Declare @@FromDate smalldatetime

	

	Declare @@FromSub_Broker varchar(10)

	Declare @@ToSub_Broker varchar(10)

	Declare @@FromDealer varchar(10)

	Declare @@ToDealer varchar(10)

	Declare @@FromEffSaudaDate datetime

	Declare @@ToEffSaudaDate datetime

	Declare @@SegmentTypeFrom varchar(10)

	Declare @@SegmentTypeTo varchar(10)

	Declare @@TradingMode varchar(20)

    Declare @@ClientGrade varchar(20)

    Declare @@TradeDays int

    DECLARE @@Errorcount int                                                                                 

	

	SET @@Errorcount = 0 

 

	set @@SegmentTypeFrom ='0000'

	set @@SegmentTypeTo ='ZZZZZ'

	

	set @@TradingMode='%'

	set @@ClientGrade='%'

	

	

	set @@FromDate=left(CONVERT(smalldatetime,DATEADD(dd,-(DAY(GETDATE())-1),getdate())),11)+' 00:00'

	set @@ToDate=left(CONVERT(smalldatetime,GETDATE()),11)+' 00:00'



	--print @FromDate

	--print @ToDate

	

	select @@FromEffSaudaDate=left(MIN(Sauda_date),11),@@ToEffSaudaDate=GETDATE() 

	from (select top 15 Sauda_date=Sauda_date from TABLE_DATE WITH(NOLOCK) where CMTradingDay='y'  and date<getdate()  order by date desc)a

	 

	select @@TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @@FromEffSaudaDate and sauda_date <= @@ToEffSaudaDate and CurrTradingDay = 'Y'

	 

	/**subbroker*/

	if @@Sub_Broker='' or @@Sub_Broker='ALL' 

	Begin

		set @@FromSub_Broker='A'

		set @@ToSub_Broker='ZZZZZZZ'

	End

	else

	Begin

		Set @@FromSub_Broker=@@Sub_Broker

		Set @@ToSub_Broker=@@Sub_Broker

	End

	

	if @@Dealer='' or @@Dealer='ALL' 

	begin

		set @@FromDealer='A'

		set @@ToDealer='ZZZZZZZ'

	end

	else

	begin

		set @@FromDealer=@@Dealer

		set @@ToDealer=@@Dealer

	end

	

	create table #PartyDetails 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime

	,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

	--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

	)

	

	--declare #BrokTurnOver table

	create table #BrokTurnOver 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),

	TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

	NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

	Sauda_date smalldatetime

	)

	

	

	

	/*fill subbrokers and dealers*/

	declare @tempbranch  table                                                                

	(                                                                

	Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

	)

	

	Insert into @tempbranch

	select * from b2b_crms_mimansa_status(@@UserEmp_No) where sb_tag >=@@FromSub_Broker and  sb_tag <=@@ToSub_Broker

	

--select * from #BrokTurnOver where Emp_No='et001' and party_code='A10095' order by Party_Code



	



	

	

	print '2.1. Party Details Process Start:'+convert(varchar,getdate(),109)

	

	insert into 

		#PartyDetails 

		(Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

	select

		ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

	from 

		B2B_CommonPartyServices ps with(nolock) , @tempbranch aub  --OPTION (recompile)

	where 

		 ps.Branch_cd=aub.Branch_cd 

		and ps.FromDate<=@@ToEffSaudaDate

		and ps.ToDate>=@@FromEffSaudaDate

	OPTION (recompile);

			

	update 

		#PartyDetails 

	set 

		EbrokingClient=ac1.EbrokingClient,

		AngelClRating=ac1.AngelClRating

	From 

		angelclient1 ac1 with(nolock),#PartyDetails ps

	where 

		ac1.Party_Code=ps.Party_Code and 

		ac1.EbrokingClient like @@TradingMode

		and ac1.AngelClRating like @@ClientGrade

	

	delete #PartyDetails where isnull(EbrokingClient,'')=''

	

	

	print '2.1. Party Details Process Ends:'+convert(varchar,getdate(),109)

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

	

	select 

		ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

	into 

		#ActivarionRatio	

	from 

		#PartyDetails ps

	where 

		ps.FromDate<=@@ToEffSaudaDate

		and ps.ToDate>=@@ToEffSaudaDate		

	group by 

		ps.Branch_cd,ps.Emp_No

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)	

	



	

	insert into #BrokTurnOver

	(

		Party_Code,

		Branch_cd,

		Emp_No, 

		TotalTurnover,

		NetRevenue,

		Sauda_date 

		)

		select 

		ps.Party_Code,

		ps.Branch_cd,

		ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		--Online_TurnOver=L.ebrok_TurnOver,

		--Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		--GrossRevenue=L.Overall_brok_earned,

		--GrossRevenue_Online=L.ebrok_brok_earned,

		--GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		--NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,		

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock)--, TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@@SegmentTypeFrom and 	

		EM.Segment_Type<=@@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		AND EM.FromDate <= @@FromEffSaudaDate 

		AND EM.ToDate >= @@ToEffSaudaDate 

		and ps.FromDate<=L.sauda_date 

		and ps.ToDate>=L.sauda_date

		and L.Sauda_date>= @@FromEffSaudaDate 

		and L.Sauda_date<= @@ToEffSaudaDate 

	

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)

	--select * from #BrokTurnOver

	--return

	

	print '2.4. RTO in process check Starts:'+convert(varchar,getdate(),109)		

	

	declare @@MSG varchar(200)                  

	set @@MSG='Report is in process. Please wait for few minutes.'      

	Declare  @Processon varchar(1)   

	Declare @lastTrade datetime

	declare @lt109 datetime

	

	select @Processon=Processon,@lastTrade=dbo.roundtime(LastProcessDate,15),@lt109=LastProcessDate from [MIMANSA].crm.dbo.Tbl_tradingdataupprocess with(nolock)

	

	--select @lastTrade = (SELECT convert(varchar,@lastTrade,106) + ' ' +  convert(varchar(5),@lastTrade,108) AS HourMinute)

	

		          

	if (@Processon= 'Y')

	begin                    

		select msg=@@MSG 

			

		if(@@UserStatusId='SUBBROKER')

		begin

			select 1                 

		end

		return                    

	end 

	

	print '2.4. RTO in process check End:'+convert(varchar,getdate(),109)	

	

		

	if(@@UserStatusId='SUBBROKER')

	begin

	

			print '2.5. RTO Data Fetch Start:'+convert(varchar,getdate(),109)		

			print '-------------------------------------------------------------------------------'

			

			declare @rto_Data table(

			Zone varchar(20),Region varchar(20),branch_cd varchar(20),B2BRM varchar(20),B2BRM_Name varchar(100),emp_no varchar(20),emp_name varchar(100),                                    

							ActiveCLEq money,ActiveCLComm money, ActiveCLCurr money,                                

							TOToTimeCash money,

							TOToTimeFUT money ,

							TOToTimeOPT money  ,

							TOToTimeComm money ,

							TOToTimeCurr money ,                                  

							CLToTimeCash money,

							CLToTimeFUT money,

							CLToTimeOPT money,

							CLToTimeComm money,

							CLToTimeCURR money,                    

							TotalTO money,

							TotalCL money,

							Optnooflots bigint

			)	

			

			insert into @rto_Data

			---exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch=@@Sub_Broker,

			@Exec=@@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='MAIN',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID=@@UserStatusId,

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'

			

			set @@Errorcount = @@error                                                                  

			If @@Errorcount <> 0 Goto LabelEnd        



			print '-------------------------------------------------------------------------------'

			print '2.5. RTO Data Fetch End:'+convert(varchar,getdate(),109)		

			

			print '2.6. Output Data Start:'+convert(varchar,getdate(),109)	

			



			

			declare @tempDashboardData table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money,

				lastTrade Datetime

			)

			

			insert into @tempDashboardData

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc,

				Lasttrade

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0,

				@lastTrade

				

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			

			

			update @tempDashboardData set ctc=c.CTC

			from @tempDashboardData emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

								

			update @tempDashboardData set TargetTurnover= case when a.TargetTurnover>0 then  a.TargetTurnover else 0 end

			from @tempDashboardData emp1,(

			select 

				emp_no=emp.emp_no,

				--TargetTurnover =cast((12*emp.ctc) as money)/(sum(NetRevenue)/sum(TotalTurnover))

				TargetTurnover =cast((12*emp.ctc) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))

			

			from 

				@tempDashboardData emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no	,  emp.ctc

			)a

			where emp1.emp_no =a.emp_no

			

			

							

			update @tempDashboardData set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData set ClientBase=isnull((TotalClientsAsonDate),0)

			from @tempDashboardData emp ,#ActivarionRatio d 

			where emp.Emp_No = d.emp_no

			

			

			

			select 

			sb_tag=t1.sb_tag,

			emp_no=t1.emp_no,

				TargetTurnover=Case when TargetTurnover>0 then CONVERT(decimal(10,0),TargetTurnover/100000) else 0 end,

				ActualAchivedTO=CONVERT(decimal(10,0),ActualAchivedTO/100000),

				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

				ClientBase = CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end,

			Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4),

			lastTrade=convert(varchar,lastTrade,106) + ' ' +  convert(varchar(5),lastTrade,108) + right(@lt109,2)--AS HourMinute

			from @tempDashboardData t1, B2B_AngelHarmony ah with(nolock)

					where t1.Emp_No=ah.EMP_NO

			order by t1.emp_no 

			

			select

				TargetTurnover= CONVERT(decimal(10,0),sum(TargetTurnover)/100000) ,

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000)				

			from @tempDashboardData 

			

			print '2.7. Output Data End:'+convert(varchar,getdate(),109)	

			

	print '1.5.END.:'+convert(varchar,getdate(),109)

			 

	end

	else

	begin

		print 'DEALER'

		declare @@sb_tag1 varchar(20)

		declare @@sb_admin1 varchar(20)

		declare @@parentsb varchar(20)

		declare @@sb varchar(20)

		

		select @@sb=sb_tag from B2B_AngelHarmony where emp_no=@@Dealer

		select top 1 @@parentsb=parentsb from B2B_CommonPartyServices with(nolock) where emp_no=@@Dealer

		if @@parentsb not in (null,'N.A','N.A') 

		begin

			select @@sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@@parentsb and isAdmin='1'

			select @@sb_tag1=''

		end

		else

		begin

		select @@sb_tag1=sb_tag from B2B_AngelHarmony where emp_no=@@Dealer

		select @@sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@@sb_tag1 and isAdmin='1'

		end

		

		insert into @rto_Data

		--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

		exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

		@Emp_no=@@sb_admin1,

		@Zone='',

		@Region='',

		@Branch=@@sb_tag1,

		@Exec='',

		@FromTime='09:00 AM',

		@ToTime='11:59 PM',

		@MainDrill='MAIN',

		@WiseReport='SBDEALER',

		@seg='ALL',

		@B2CStatus='B2B',

		@MimStatusID='SUBBROKER',

		@SB='',

		@RoundValue='1',

		@DownloadCSVFlag='Y'	

		

		set @@Errorcount = @@error                                                                  

		If @@Errorcount <> 0 Goto LabelEnd        

	

	declare @tempDashboardData1 table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money,

				status varchar(10),

				lastTrade Datetime

			)

			

			insert into @tempDashboardData1

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc,

				status,

				lastTrade				

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0,

				status=0,

				@lastTrade

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			

					

			

			update @tempDashboardData1 set ctc=c.CTC,status=isAdmin

			from @tempDashboardData1 emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData1 set TargetTurnover= case when a.TargetTurnover > 0 then a.TargetTurnover else 0 end

			from @tempDashboardData1 emp1,(

			select 

				emp_no=emp.emp_no,

				TargetTurnover =cast((12*emp.ctc) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))

			

			from 

				@tempDashboardData1 emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no,emp.ctc	  

			)a

			where emp1.emp_no =a.emp_no

			

			update @tempDashboardData1 set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData1 emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			and emp.sb_tag=c.branch_cd

			

			--update @tempDashboardData1 set ClientBase=isnull((TotalClientsAsonDate),0)

			--from @tempDashboardData1 emp ,#ActivarionRatio d 

			--where emp.Emp_No = d.emp_no

			--and emp.sb_tag=@Statusname

			

			

			

			select 

				sb_tag='',--t1.sb_tag,

				emp_no=t1.emp_no,

				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),

				Activation_Ratio=0,--case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),sum(ClientsTraded)) ,

				ClientBase =0,-- CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when sum(TargetTurnover)>0 and sum(ActualAchivedTO)>0 then convert(decimal(10,0),(sum(ActualAchivedTO)/sum(TargetTurnover))*100) else 0 end,

			Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4),

			lastTrade=convert(varchar,lastTrade,106) + ' ' +  convert(varchar(5),lastTrade,108) + right(@lt109,2)--AS HourMinute

			from @tempDashboardData1 t1, B2B_AngelHarmony ah with(nolock)

					where t1.Emp_No=ah.EMP_NO

			and t1.emp_no=@@Dealer

			group by t1.emp_no,ah.EMP_NAME,ah.First_Name,ah.Emp_Name,lastTrade

			

			

			union all

			

			select 

				sb_tag,

				emp_no='DealerAverage',

				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),

				Activation_Ratio=sum(Activation_Ratio),

				ClientsTraded=sum(ClientsTraded ),

				ClientBase=sum(ClientBase) ,

				PercentageTurnoverAchievedTillTime=SUM(PercentageTurnoverAchievedTillTime),

				Emp_Name='DealerAverage',Emp_First_Name='Del Avg',

				lastTrade=''

				from  (

						select 

							sb_tag,

							emp_no,

							TargetTurnover,

							ActualAchivedTO,

							Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

							ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

							ClientBase = CONVERT(decimal(10,0),ClientBase),

							PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end

						from @tempDashboardData1 

						where emp_no<>@@Dealer

						and sb_tag=@@sb

				)a

				group by a.sb_tag

		

	

	

	 	 

	end

		LabelEnd:                                                      

		If @@Errorcount <> 0

		begin

			set @@MSG='Report is in process. Please wait for few minutes.'                    

			select msg=@@MSG   

			

			select 1

		end	

		

		

   

 			

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_TaVsAC_Timer_test_vol1
-- --------------------------------------------------


CREATE procedure [dbo].[B2bCrms_DashBoard_TaVsAC_Timer_test_vol1]

(

	@UserEmp_No varchar(20),

	@UserStatusId varchar(20),--SUBBROKER/SBDEALER

	@Statusname varchar(20),

	@Sub_Broker varchar(10),

	@Dealer varchar(20)

	

)

as

begin

	/*

		

		exec B2bCrms_DashBoard_TaVsAC_Timer_vol1 'et001','SUBBROKER','','ET',''

		exec B2bCrms_DashBoard_TaVsAC_Timer_vol1 'et002','subbroker','et','et','et002'

	*/

	--WAITFOR DELAY '00:01:05'

	print 'Start:'+convert(varchar,getdate(),109)

	

	

	declare @@UserEmp_No varchar(20)

	declare @@UserStatusId varchar(20)

	declare @@Statusname varchar(20)

	declare @@Sub_Broker varchar(10)

	declare @@Dealer varchar(20)

	declare @@Report_Type varchar(20)

	

	set @@UserEmp_No =@UserEmp_No

	set @@UserStatusId=@UserStatusId 

	set @@Statusname =@Statusname

	set @@Sub_Broker =@Sub_Broker

	set @@Dealer =@Dealer

	

	

	

	Declare @@ToDate smalldatetime

	Declare @@FromDate smalldatetime

	

	Declare @@FromSub_Broker varchar(10)

	Declare @@ToSub_Broker varchar(10)

	Declare @@FromDealer varchar(10)

	Declare @@ToDealer varchar(10)

	Declare @@FromEffSaudaDate datetime

	Declare @@ToEffSaudaDate datetime

	Declare @@SegmentTypeFrom varchar(10)

	Declare @@SegmentTypeTo varchar(10)

	Declare @@TradingMode varchar(20)

    Declare @@ClientGrade varchar(20)

    Declare @@TradeDays int

    DECLARE @@Errorcount int                                                                                 

	

	SET @@Errorcount = 0 

 

	set @@SegmentTypeFrom ='0000'

	set @@SegmentTypeTo ='ZZZZZ'

	

	set @@TradingMode='%'

	set @@ClientGrade='%'

	

	

	set @@FromDate=left(CONVERT(smalldatetime,DATEADD(dd,-(DAY(GETDATE())-1),getdate())),11)+' 00:00'

	set @@ToDate=left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@@FromDate)+1,0)),109),11) + ' 23:59'--left(CONVERT(smalldatetime,GETDATE()),11)+' 00:00'



	--print @FromDate

	--print @ToDate

	

	select @@FromEffSaudaDate=left(MIN(Sauda_date),11),@@ToEffSaudaDate=GETDATE() 

	from (select top 15 Sauda_date=Sauda_date from TABLE_DATE WITH(NOLOCK) where CMTradingDay='y'  and date<getdate()  order by date desc)a

	 



	 

	/**subbroker*/

	if @@Sub_Broker='' or @@Sub_Broker='ALL' 

	Begin

		set @@FromSub_Broker='A'

		set @@ToSub_Broker='ZZZZZZZ'

	End

	else

	Begin

		Set @@FromSub_Broker=@@Sub_Broker

		Set @@ToSub_Broker=@@Sub_Broker

	End

	

	if @@Dealer='' or @@Dealer='ALL' 

	begin

		set @@FromDealer='A'

		set @@ToDealer='ZZZZZZZ'

	end

	else

	begin

		set @@FromDealer=@@Dealer

		set @@ToDealer=@@Dealer

	end

	

	create table #PartyDetails 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

	,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

	--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

	)

	

	--declare #BrokTurnOver table

	create table #BrokTurnOver 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

	TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

	NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

	Sauda_date smalldatetime

	)

	

	

	

	/*fill subbrokers and dealers*/

	declare @tempbranch  table                                                                

	(                                                                

	Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

	)

	

	Insert into @tempbranch

	select * from b2b_crms_mimansa_status(@@UserEmp_No) where sb_tag >=@@FromSub_Broker and  sb_tag <=@@ToSub_Broker

	

--select * from #BrokTurnOver where Emp_No='et001' and party_code='A10095' order by Party_Code



	

	print @@FromEffSaudaDate

	print @@ToEffSaudaDate

	

	print '2.0. Party Details Process Start:'+convert(varchar,getdate(),109)

	

	insert into 

		#PartyDetails 

		(Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

	select

		ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

	from 

		B2B_CommonPartyServices ps with(nolock) , @tempbranch aub  --OPTION (recompile)

	where 

		 ps.Branch_cd=aub.Branch_cd 

		and ps.FromDate<=@@ToEffSaudaDate

		and ps.ToDate>=@@FromEffSaudaDate

	OPTION (recompile);

			

	update 

		#PartyDetails 

	set 

		EbrokingClient=ac1.EbrokingClient,

		AngelClRating=ac1.AngelClRating

	From 

		angelclient1 ac1 with(nolock),#PartyDetails ps

	where 

		ac1.Party_Code=ps.Party_Code and 

		ac1.EbrokingClient like @@TradingMode

		and ac1.AngelClRating like @@ClientGrade

	

	delete #PartyDetails where isnull(EbrokingClient,'')=''

	

	

	print '2.1. Party Details Process Ends:'+convert(varchar,getdate(),109)

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

	

	select 

		ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

	into 

		#ActivarionRatio	

	from 

		#PartyDetails ps

	where 

		ps.FromDate<=@@ToEffSaudaDate

		and ps.ToDate>=@@ToEffSaudaDate		

	group by 

		ps.Branch_cd,ps.Emp_No

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)	

	



	

	insert into #BrokTurnOver

	(

		Party_Code,

		Branch_cd,

		Emp_No, 

		TotalTurnover,

		NetRevenue,

		Sauda_date 

		)

		select 

		ps.Party_Code,

		ps.Branch_cd,

		ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		--Online_TurnOver=L.ebrok_TurnOver,

		--Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		--GrossRevenue=L.Overall_brok_earned,

		--GrossRevenue_Online=L.ebrok_brok_earned,

		--GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue=(L.Overall_brok_earned),

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		--NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,		

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock)--, TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@@SegmentTypeFrom and 	

		EM.Segment_Type<=@@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		AND EM.FromDate <= @@FromEffSaudaDate 

		AND EM.ToDate >= @@ToEffSaudaDate 

		and ps.FromDate<=L.sauda_date 

		and ps.ToDate>=L.sauda_date

		and L.Sauda_date>= @@FromEffSaudaDate 

		and L.Sauda_date<= @@ToEffSaudaDate 

	

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)

	--select * from #BrokTurnOver 

	--where Emp_No='hyd1002'

	--return

	

	print '2.4. RTO in process check Starts:'+convert(varchar,getdate(),109)		

	

	declare @@MSG varchar(200)                  

	set @@MSG='Report is in process. Please wait for few minutes.'      

	Declare  @Processon varchar(1)   

	Declare @lastTrade datetime

	declare @lt109 datetime

	

	select @Processon=Processon,@lastTrade=dbo.roundtime(LastProcessDate,15),@lt109=LastProcessDate from [MIMANSA].crm.dbo.Tbl_tradingdataupprocess with(nolock)

		--select @lastTrade = (SELECT convert(varchar,@lastTrade,106) + ' ' +  convert(varchar(5),@lastTrade,108) AS HourMinute)

	

	--set @Processon= 'Y'	          

	if (@Processon= 'Y')

	begin                    

		select msg=@@MSG   

		select '1'               

		return                    

	end 

	

	print '2.4. RTO in process check End:'+convert(varchar,getdate(),109)	

	

	select @@TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @@FromDate and sauda_date <= @@ToDate and CurrTradingDay = 'Y'

	

	

	Declare @@Act_Days int,@@H_days int,@@Total_Days int

	set @@Act_Days = (dbo.GetWorkingDays(@@FromDate,@@ToDate))                              

	set @@H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

				where holidaydate >= @@FromDate and holidaydate <= @@ToDate ) 

				  

	select 	@@Total_Days=@@Act_Days-@@H_days

	

		

	if(@@UserStatusId='SUBBROKER')

	begin

	

			print '2.5. RTO Data Fetch Start:'+convert(varchar,getdate(),109)		

			print '-------------------------------------------------------------------------------'

			

			BEGIN TRY



			declare @rto_Data table(

			Zone varchar(20),Region varchar(20),branch_cd varchar(20),B2BRM varchar(20),B2BRM_Name varchar(100),emp_no varchar(20),emp_name varchar(100),                                    

							ActiveCLEq money,ActiveCLComm money, ActiveCLCurr money,                                

							TOToTimeCash money,

							TOToTimeFUT money ,

							TOToTimeOPT money  ,

							TOToTimeComm money ,

							TOToTimeCurr money ,                                  

							CLToTimeCash money,

							CLToTimeFUT money,

							CLToTimeOPT money,

							CLToTimeComm money,

							CLToTimeCURR money,                    

							TotalTO money,

							TotalCL money,

							Optnooflots bigint,

							ToTargetTurnover money,

							ToTargetClient int,

							ToNoOfLots int,

							NoOfLotsGold bigint,

							NoOfLotsSilver bigint,

							NoOfLotsCopper bigint  ,

							NoOfLotsCrude bigint,

							NoOfLotsComm bigint,

							TargetNoOfLotsGold bigint,

							TargetNoOfLotsSilver bigint,

							TargetNoOfLotsCopper bigint,

							TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			(

			Zone ,Region, branch_cd ,B2BRM ,B2BRM_Name ,emp_no ,emp_name ,                                    

							ActiveCLEq ,ActiveCLComm , ActiveCLCurr ,                                

							TOToTimeCash ,

							TOToTimeFUT  ,

							TOToTimeOPT   ,

							TOToTimeComm  ,

							TOToTimeCurr  ,                                  

							CLToTimeCash ,

							CLToTimeFUT ,

							CLToTimeOPT ,

							CLToTimeComm ,

							CLToTimeCURR ,                    

							TotalTO ,

							TotalCL ,

							Optnooflots ,

							ToTargetTurnover ,

							ToTargetClient ,

							ToNoOfLots ,

							NoOfLotsGold ,

							NoOfLotsSilver ,

							NoOfLotsCopper   ,

							NoOfLotsCrude ,

							NoOfLotsComm ,

							TargetNoOfLotsGold ,

							TargetNoOfLotsSilver ,

							TargetNoOfLotsCopper ,

							TargetNoOfLotsCrude 

			)

			--exec test_rto_op

			---exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			--exec [MIMANSA].CRM.dbo.GetTurnoverfortime_new_Target

			@Emp_no=@@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch=@@Sub_Broker,

			@Exec=@@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='MAIN',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID=@@UserStatusId,

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			



			END TRY



			BEGIN CATCH

				

			set @@Errorcount = @@error                                                                  

			If @@Errorcount <> 0 Goto LabelEnd    



			END CATCH;

			  



			print '-------------------------------------------------------------------------------'

			print '2.5. RTO Data Fetch End:'+convert(varchar,getdate(),109)		

			

			print '2.6. Output Data Start:'+convert(varchar,getdate(),109)	

			



			

			declare @tempDashboardData table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money,

				lastTrade Datetime

			)

			

			insert into @tempDashboardData

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc,

				Lasttrade

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0,

				@lastTrade

				

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			

			

			

			

						

			update @tempDashboardData set ctc=c.CTC

			from @tempDashboardData emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

			

			print '2.6.1 Output Data prepair:'+convert(varchar,getdate(),109)	

								

			update @tempDashboardData set TargetTurnover= case when a.TargetTurnover>0 then  a.TargetTurnover else 0 end

			from @tempDashboardData emp1,(

			select 

				emp_no=emp.emp_no,

				--TargetTurnover =cast((12*emp.ctc) as money)/(sum(NetRevenue)/sum(TotalTurnover))

				TargetTurnover =case when (sum(TotalTurnover) > 0 and cast(sum(NetRevenue) as decimal(20,10))> 0) then  cast((12*emp.ctc/@@Total_Days) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover)) else 0 end

			

			from 

				@tempDashboardData emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no	,  emp.ctc

			)a

			where emp1.emp_no =a.emp_no

			

			print '2.6.2 Output Data prepair:'+convert(varchar,getdate(),109)	

							

			update @tempDashboardData set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData set ClientBase=isnull((TotalClientsAsonDate),0)

			from @tempDashboardData emp ,#ActivarionRatio d 

			where emp.Emp_No = d.emp_no

			

			

			

			select 

			sb_tag=t1.sb_tag,

			emp_no=t1.emp_no,

				TargetTurnover=Case when TargetTurnover>0 then CONVERT(decimal(10,0),TargetTurnover/100000) else 0 end,

				ActualAchivedTO=CONVERT(decimal(10,0),ActualAchivedTO/100000),

				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

				ClientBase = CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end,

			Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4),

			lastTrade=convert(varchar,lastTrade,106) + ' ' +  convert(varchar(5),lastTrade,108) + right(@lt109,2)--AS HourMinute

			from @tempDashboardData t1, B2B_AngelHarmony ah with(nolock)

					where t1.Emp_No=ah.EMP_NO

			order by t1.emp_no 

			

			select

				TargetTurnover= CONVERT(decimal(10,0),sum(TargetTurnover)/100000) ,

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000)				

			from @tempDashboardData 

			

			print '2.7. Output Data End:'+convert(varchar,getdate(),109)	

			

	print '1.5.END.:'+convert(varchar,getdate(),109)

			 

	end

	else

	begin

		print 'DEALER'



		declare @@sb_tag1 varchar(20)

		declare @@sb_admin1 varchar(20)

		declare @@parentsb varchar(20)

		declare @@sb varchar(20)

		

		select @@sb=sb_tag from B2B_AngelHarmony where emp_no=@@Dealer

		select top 1 @@parentsb=parentsb from B2B_CommonPartyServices with(nolock) where emp_no=@@Dealer

		if @@parentsb not in (null,'N.A','N.A') 

		begin

			select @@sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@@parentsb and isAdmin='1'

			select @@sb_tag1=''

		end

		else

		begin

		select @@sb_tag1=sb_tag from B2B_AngelHarmony where emp_no=@@Dealer

		select @@sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@@sb_tag1 and isAdmin='1'

		end

		

		BEGIN TRY

		insert into @rto_Data

		--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

		exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

		@Emp_no=@@sb_admin1,

		@Zone='',

		@Region='',

		@Branch=@@sb_tag1,

		@Exec='',

		@FromTime='09:00 AM',

		@ToTime='11:59 PM',

		@MainDrill='MAIN',

		@WiseReport='SBDEALER',

		@seg='ALL',

		@B2CStatus='B2B',

		@MimStatusID='SUBBROKER',

		@SB='',

		@RoundValue='1',

		@DownloadCSVFlag='Y'	

		

		END TRY



			BEGIN CATCH

				

			set @@Errorcount = @@error                                                                  

			If @@Errorcount <> 0 Goto LabelEnd    



			END CATCH;

	

	declare @tempDashboardData1 table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money,

				status varchar(10),

				lastTrade Datetime

			)

			

			insert into @tempDashboardData1

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc,

				status,

				lastTrade				

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0,

				status=0,

				@lastTrade

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			

					

			

			update @tempDashboardData1 set ctc=c.CTC,status=isAdmin

			from @tempDashboardData1 emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData1 set TargetTurnover= case when a.TargetTurnover > 0 then a.TargetTurnover else 0 end

			from @tempDashboardData1 emp1,(

			select 

				emp_no=emp.emp_no,

				NetRevenue

			

			from 

				@tempDashboardData1 emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no,emp.ctc	  

			)a

			where emp1.emp_no =a.emp_no

			

			update @tempDashboardData1 set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData1 emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			and emp.sb_tag=c.branch_cd

			

			--update @tempDashboardData1 set ClientBase=isnull((TotalClientsAsonDate),0)

			--from @tempDashboardData1 emp ,#ActivarionRatio d 

			--where emp.Emp_No = d.emp_no

			--and emp.sb_tag=@Statusname

			

			

			

			select 

				sb_tag='',--t1.sb_tag,

				emp_no=t1.emp_no,

				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),

				Activation_Ratio=0,--case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),sum(ClientsTraded)) ,

				ClientBase =0,-- CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when sum(TargetTurnover)>0 and sum(ActualAchivedTO)>0 then convert(decimal(10,0),(sum(ActualAchivedTO)/sum(TargetTurnover))*100) else 0 end,

			Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4),

			lastTrade=convert(varchar,lastTrade,106) + ' ' +  convert(varchar(5),lastTrade,108) + right(@lt109,2)--AS HourMinute

			from @tempDashboardData1 t1, B2B_AngelHarmony ah with(nolock)

					where t1.Emp_No=ah.EMP_NO

			and t1.emp_no=@@Dealer

			group by t1.emp_no,ah.EMP_NAME,ah.First_Name,ah.Emp_Name,lastTrade

			

			

			union all

			

			select 

				sb_tag,

				emp_no='DealerAverage',

				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),

				Activation_Ratio=sum(Activation_Ratio),

				ClientsTraded=sum(ClientsTraded ),

				ClientBase=sum(ClientBase) ,

				PercentageTurnoverAchievedTillTime=SUM(PercentageTurnoverAchievedTillTime),

				Emp_Name='DealerAverage',Emp_First_Name='Del Avg',

				lastTrade=''

				from  (

						select 

							sb_tag,

							emp_no,

							TargetTurnover,

							ActualAchivedTO,

							Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

							ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

							ClientBase = CONVERT(decimal(10,0),ClientBase),

							PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end

						from @tempDashboardData1 

						where emp_no<>@@Dealer

						and sb_tag=@@sb

				)a

				group by a.sb_tag

		

	

	

	 	 

	end

		LabelEnd:                                                      

		If @@Errorcount <> 0

		begin

			set @@MSG='Report is in process. Please wait for few minutes.'          

			select msg=@@MSG   

			

			select '1'

		end	

		

		

   

 			

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_TaVsAC_Timer_vol1
-- --------------------------------------------------



CREATE procedure [dbo].[B2bCrms_DashBoard_TaVsAC_Timer_vol1]

(

	@UserEmp_No varchar(20),

	@UserStatusId varchar(20),--SUBBROKER/SBDEALER

	@Statusname varchar(20),

	@Sub_Broker varchar(10),

	@Dealer varchar(20)

	

)

as

begin

	/*

		

		exec B2bCrms_DashBoard_TaVsAC_Timer_vol1 'et001','SUBBROKER','','ET',''

		exec B2bCrms_DashBoard_TaVsAC_Timer_vol1 'et002','subbroker','et','et','et002'

	*/

	--WAITFOR DELAY '00:01:05'

	print 'Start:'+convert(varchar,getdate(),109)

	

	

	declare @@UserEmp_No varchar(20)

	declare @@UserStatusId varchar(20)

	declare @@Statusname varchar(20)

	declare @@Sub_Broker varchar(10)

	declare @@Dealer varchar(20)

	declare @@Report_Type varchar(20)

	

	set @@UserEmp_No =@UserEmp_No

	set @@UserStatusId=@UserStatusId 

	set @@Statusname =@Statusname

	set @@Sub_Broker =@Sub_Broker

	set @@Dealer =@Dealer

	

	

	

	Declare @@ToDate smalldatetime

	Declare @@FromDate smalldatetime

	

	Declare @@FromSub_Broker varchar(10)

	Declare @@ToSub_Broker varchar(10)

	Declare @@FromDealer varchar(10)

	Declare @@ToDealer varchar(10)

	Declare @@FromEffSaudaDate datetime

	Declare @@ToEffSaudaDate datetime

	Declare @@SegmentTypeFrom varchar(10)

	Declare @@SegmentTypeTo varchar(10)

	Declare @@TradingMode varchar(20)

    Declare @@ClientGrade varchar(20)

    Declare @@TradeDays int

    DECLARE @@Errorcount int                                                                                 

	

	SET @@Errorcount = 0 

 

	set @@SegmentTypeFrom ='0000'

	set @@SegmentTypeTo ='ZZZZZ'

	

	set @@TradingMode='%'

	set @@ClientGrade='%'

	

	

	set @@FromDate=left(CONVERT(smalldatetime,DATEADD(dd,-(DAY(GETDATE())-1),getdate())),11)+' 00:00'

	set @@ToDate=left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@@FromDate)+1,0)),109),11) + ' 23:59'--left(CONVERT(smalldatetime,GETDATE()),11)+' 00:00'



	--print @FromDate

	--print @ToDate

	

	select @@FromEffSaudaDate=left(MIN(Sauda_date),11),@@ToEffSaudaDate=GETDATE() 

	from (select top 15 Sauda_date=Sauda_date from TABLE_DATE WITH(NOLOCK) where CMTradingDay='y'  and date<getdate()  order by date desc)a

	 



	 

	/**subbroker*/

	if @@Sub_Broker='' or @@Sub_Broker='ALL' 

	Begin

		set @@FromSub_Broker='A'

		set @@ToSub_Broker='ZZZZZZZ'

	End

	else

	Begin

		Set @@FromSub_Broker=@@Sub_Broker

		Set @@ToSub_Broker=@@Sub_Broker

	End

	

	if @@Dealer='' or @@Dealer='ALL' 

	begin

		set @@FromDealer='A'

		set @@ToDealer='ZZZZZZZ'

	end

	else

	begin

		set @@FromDealer=@@Dealer

		set @@ToDealer=@@Dealer

	end

	

	create table #PartyDetails 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

	,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

	--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

	)

	

	--declare #BrokTurnOver table

	create table #BrokTurnOver 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

	TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

	NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

	Sauda_date smalldatetime

	)

	

	

	

	/*fill subbrokers and dealers*/

	declare @tempbranch  table                                                                

	(                                                                

	Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

	)

	

	Insert into @tempbranch

	select * from b2b_crms_mimansa_status(@@UserEmp_No) where sb_tag >=@@FromSub_Broker and  sb_tag <=@@ToSub_Broker

	

--select * from #BrokTurnOver where Emp_No='et001' and party_code='A10095' order by Party_Code



	

	print @@FromEffSaudaDate

	print @@ToEffSaudaDate

	

	print '2.0. Party Details Process Start:'+convert(varchar,getdate(),109)

	

	insert into 

		#PartyDetails 

		(Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

	select

		ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

	from 

		B2B_CommonPartyServices ps with(nolock) , @tempbranch aub  --OPTION (recompile)

	where 

		 ps.Branch_cd=aub.Branch_cd 

		and ps.FromDate<=@@ToEffSaudaDate

		and ps.ToDate>=@@FromEffSaudaDate

	OPTION (recompile);

			

	update 

		#PartyDetails 

	set 

		EbrokingClient=ac1.EbrokingClient,

		AngelClRating=ac1.AngelClRating

	From 

		angelclient1 ac1 with(nolock),#PartyDetails ps

	where 

		ac1.Party_Code=ps.Party_Code and 

		ac1.EbrokingClient like @@TradingMode

		and ac1.AngelClRating like @@ClientGrade

	

	delete #PartyDetails where isnull(EbrokingClient,'')=''

	

	

	print '2.1. Party Details Process Ends:'+convert(varchar,getdate(),109)

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

	

	select 

		ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

	into 

		#ActivarionRatio	

	from 

		#PartyDetails ps

	where 

		ps.FromDate<=@@ToEffSaudaDate

		and ps.ToDate>=@@ToEffSaudaDate		

	group by 

		ps.Branch_cd,ps.Emp_No

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)	

	



	

	insert into #BrokTurnOver

	(

		Party_Code,

		Branch_cd,

		Emp_No, 

		TotalTurnover,

		NetRevenue,

		Sauda_date 

		)

		select 

		ps.Party_Code,

		ps.Branch_cd,

		ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		--Online_TurnOver=L.ebrok_TurnOver,

		--Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		--GrossRevenue=L.Overall_brok_earned,

		--GrossRevenue_Online=L.ebrok_brok_earned,

		--GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		--NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,		

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock)--, TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@@SegmentTypeFrom and 	

		EM.Segment_Type<=@@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		AND EM.FromDate <= @@FromEffSaudaDate 

		AND EM.ToDate >= @@ToEffSaudaDate 

		and ps.FromDate<=L.sauda_date 

		and ps.ToDate>=L.sauda_date

		and L.Sauda_date>= @@FromEffSaudaDate 

		and L.Sauda_date<= @@ToEffSaudaDate 

	

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)

	--select * from #BrokTurnOver

	--return

	

	print '2.4. RTO in process check Starts:'+convert(varchar,getdate(),109)		

	

	declare @@MSG varchar(200)                  

	set @@MSG='Report is in process. Please wait for few minutes.'      

	Declare  @Processon varchar(1)   

	Declare @lastTrade datetime

	declare @lt109 datetime

	

	select @Processon=Processon,@lastTrade=dbo.roundtime(LastProcessDate,15),@lt109=dbo.roundtime(LastProcessDate,15)/*LastProcessDate*/ from [MIMANSA].crm.dbo.Tbl_tradingdataupprocess with(nolock)

		--select @lastTrade = (SELECT convert(varchar,@lastTrade,106) + ' ' +  convert(varchar(5),@lastTrade,108) AS HourMinute)

	

	--set @Processon= 'Y'	          

	if (@Processon= 'Y')

	begin                    

		select msg=@@MSG   

		select '1'               

		return                    

	end 

	

	print '2.4. RTO in process check End:'+convert(varchar,getdate(),109)	

	

	select @@TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @@FromDate and sauda_date <= @@ToDate and CurrTradingDay = 'Y'

	

	

	Declare @@Act_Days int,@@H_days int,@@Total_Days int

	set @@Act_Days = (dbo.GetWorkingDays(@@FromDate,@@ToDate))                              

	set @@H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

				where holidaydate >= @@FromDate and holidaydate <= @@ToDate ) 

				  

	select 	@@Total_Days=@@Act_Days-@@H_days

	

		

	if(@@UserStatusId='SUBBROKER')

	begin

	

			print '2.5. RTO Data Fetch Start:'+convert(varchar,getdate(),109)		

			print '-------------------------------------------------------------------------------'

			

			BEGIN TRY



			declare @rto_Data table(

			Zone varchar(20),Region varchar(20),branch_cd varchar(20),B2BRM varchar(20),B2BRM_Name varchar(100),emp_no varchar(20),emp_name varchar(100),                                    

							ActiveCLEq money,ActiveCLComm money, ActiveCLCurr money,                                

							TOToTimeCash money,

							TOToTimeFUT money ,

							TOToTimeOPT money  ,

							TOToTimeComm money ,

							TOToTimeCurr money ,                                  

							CLToTimeCash money,

							CLToTimeFUT money,

							CLToTimeOPT money,

							CLToTimeComm money,

							CLToTimeCURR money,                    

							TotalTO money,

							TotalCL money,

							Optnooflots bigint,

							ToTargetTurnover money,

							ToTargetClient int,

							ToNoOfLots int,

							NoOfLotsGold bigint,

							NoOfLotsSilver bigint,

							NoOfLotsCopper bigint  ,

							NoOfLotsCrude bigint,

							NoOfLotsComm bigint,

							TargetNoOfLotsGold bigint,

							TargetNoOfLotsSilver bigint,

							TargetNoOfLotsCopper bigint,

							TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			(

			Zone ,Region, branch_cd ,B2BRM ,B2BRM_Name ,emp_no ,emp_name ,                                    

							ActiveCLEq ,ActiveCLComm , ActiveCLCurr ,                                

							TOToTimeCash ,

							TOToTimeFUT  ,

							TOToTimeOPT   ,

							TOToTimeComm  ,

							TOToTimeCurr  ,                                  

							CLToTimeCash ,

							CLToTimeFUT ,

							CLToTimeOPT ,

							CLToTimeComm ,

							CLToTimeCURR ,                    

							TotalTO ,

							TotalCL ,

							Optnooflots ,

							ToTargetTurnover ,

							ToTargetClient ,

							ToNoOfLots ,

							NoOfLotsGold ,

							NoOfLotsSilver ,

							NoOfLotsCopper   ,

							NoOfLotsCrude ,

							NoOfLotsComm ,

							TargetNoOfLotsGold ,

							TargetNoOfLotsSilver ,

							TargetNoOfLotsCopper ,

							TargetNoOfLotsCrude 

			)

			--exec test_rto_op

			---exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			--exec [MIMANSA].CRM.dbo.GetTurnoverfortime_new_Target

			@Emp_no=@@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch=@@Sub_Broker,

			@Exec=@@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='MAIN',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID=@@UserStatusId,

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			



			END TRY



			BEGIN CATCH

				

			--set @@Errorcount = @@error                                                                  

			--If @@Errorcount <> 0 Goto LabelEnd 

			

			set @@MSG='Report is in process. Please wait for few minutes.'          

			select msg=@@MSG   

			

			select '1'   

			return

			

			END CATCH;

			    



			print '-------------------------------------------------------------------------------'

			print '2.5. RTO Data Fetch End:'+convert(varchar,getdate(),109)		

			

			print '2.6. Output Data Start:'+convert(varchar,getdate(),109)	

			



			

			declare @tempDashboardData table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money,

				lastTrade Datetime

			)

			

			insert into @tempDashboardData

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc,

				Lasttrade

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0,

				@lastTrade

				

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			

			

			update @tempDashboardData set ctc=c.CTC

			from @tempDashboardData emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

			

			print '2.6.1 Output Data prepair:'+convert(varchar,getdate(),109)	

								

			update @tempDashboardData set TargetTurnover= case when a.TargetTurnover>0 then  a.TargetTurnover else 0 end

			from @tempDashboardData emp1,(

			select 

				emp_no=emp.emp_no,

				--TargetTurnover =cast((12*emp.ctc) as money)/(sum(NetRevenue)/sum(TotalTurnover))

				TargetTurnover =case when (sum(TotalTurnover) > 0 and cast(sum(NetRevenue) as decimal(20,10))> 0) then  cast((12*emp.ctc/@@Total_Days) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover)) else 0 end

			

			from 

				@tempDashboardData emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no	,  emp.ctc

			)a

			where emp1.emp_no =a.emp_no

			

			print '2.6.2 Output Data prepair:'+convert(varchar,getdate(),109)	

							

			update @tempDashboardData set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData set ClientBase=isnull((TotalClientsAsonDate),0)

			from @tempDashboardData emp ,#ActivarionRatio d 

			where emp.Emp_No = d.emp_no

			

			

			

			select 

			sb_tag=t1.sb_tag,

			emp_no=t1.emp_no,

				TargetTurnover=Case when TargetTurnover>0 then CONVERT(decimal(10,0),TargetTurnover/100000) else 0 end,

				ActualAchivedTO=CONVERT(decimal(10,0),ActualAchivedTO/100000),

				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

				ClientBase = CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end,

			Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4),

			lastTrade=convert(varchar,lastTrade,106) + ' ' +  convert(varchar(5),lastTrade,108) + right(@lt109,2)--AS HourMinute

			from @tempDashboardData t1, B2B_AngelHarmony ah with(nolock)

					where t1.Emp_No=ah.EMP_NO

			order by t1.emp_no 

			

			select

				TargetTurnover= CONVERT(decimal(10,0),sum(TargetTurnover)/100000) ,

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000)				

			from @tempDashboardData 

			

			print '2.7. Output Data End:'+convert(varchar,getdate(),109)	

			

	print '1.5.END.:'+convert(varchar,getdate(),109)

			 

	end

	else

	begin

		print 'DEALER'

		declare @@sb_tag1 varchar(20)

		declare @@sb_admin1 varchar(20)

		declare @@parentsb varchar(20)

		declare @@sb varchar(20)

		

		select @@sb=sb_tag from B2B_AngelHarmony where emp_no=@@Dealer

		select top 1 @@parentsb=parentsb from B2B_CommonPartyServices with(nolock) where emp_no=@@Dealer

		if @@parentsb not in (null,'N.A','N.A') 

		begin

			select @@sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@@parentsb and isAdmin='1'

			select @@sb_tag1=''

		end

		else

		begin

		select @@sb_tag1=sb_tag from B2B_AngelHarmony where emp_no=@@Dealer

		select @@sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@@sb_tag1 and isAdmin='1'

		end

		

		BEGIN TRY

		insert into @rto_Data

		--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

		exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

		@Emp_no=@@sb_admin1,

		@Zone='',

		@Region='',

		@Branch=@@sb_tag1,

		@Exec='',

		@FromTime='09:00 AM',

		@ToTime='11:59 PM',

		@MainDrill='MAIN',

		@WiseReport='SBDEALER',

		@seg='ALL',

		@B2CStatus='B2B',

		@MimStatusID='SUBBROKER',

		@SB='',

		@RoundValue='1',

		@DownloadCSVFlag='Y'	

		

		END TRY



			BEGIN CATCH

				

			--set @@Errorcount = @@error                                                                  

			--If @@Errorcount <> 0 Goto LabelEnd    

			set @@MSG='Report is in process. Please wait for few minutes.'          

			select msg=@@MSG   

			

			select '1'   

			return

			

			END CATCH;

	

	declare @tempDashboardData1 table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money,

				status varchar(10),

				lastTrade Datetime

			)

			

			insert into @tempDashboardData1

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc,

				status,

				lastTrade				

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0,

				status=0,

				@lastTrade

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			

					

			

			update @tempDashboardData1 set ctc=c.CTC,status=isAdmin

			from @tempDashboardData1 emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData1 set TargetTurnover= case when a.TargetTurnover > 0 then a.TargetTurnover else 0 end

			from @tempDashboardData1 emp1,(

			select 

				emp_no=emp.emp_no,

				TargetTurnover =cast((12*emp.ctc/@@Total_Days) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))

			

			from 

				@tempDashboardData1 emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no,emp.ctc	  

			)a

			where emp1.emp_no =a.emp_no

			

			update @tempDashboardData1 set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData1 emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			and emp.sb_tag=c.branch_cd

			

			--update @tempDashboardData1 set ClientBase=isnull((TotalClientsAsonDate),0)

			--from @tempDashboardData1 emp ,#ActivarionRatio d 

			--where emp.Emp_No = d.emp_no

			--and emp.sb_tag=@Statusname

			

	

			

			select 

				sb_tag='',--t1.sb_tag,

				emp_no=t1.emp_no,

				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),

				Activation_Ratio=0,--case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),sum(ClientsTraded)) ,

				ClientBase =0,-- CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when sum(TargetTurnover)>0 and sum(ActualAchivedTO)>0 then convert(decimal(10,0),(sum(ActualAchivedTO)/sum(TargetTurnover))*100) else 0 end,

			Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4),

			lastTrade=convert(varchar,lastTrade,106) + ' ' +  convert(varchar(5),lastTrade,108) + right(@lt109,2)--AS HourMinute

			from @tempDashboardData1 t1, B2B_AngelHarmony ah with(nolock)

					where t1.Emp_No=ah.EMP_NO

			and t1.emp_no=@@Dealer

			group by t1.emp_no,ah.EMP_NAME,ah.First_Name,ah.Emp_Name,lastTrade

			

			

			union all

			

			select 

				sb_tag,

				emp_no='DealerAverage',

				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),

				Activation_Ratio=sum(Activation_Ratio),

				ClientsTraded=sum(ClientsTraded ),

				ClientBase=sum(ClientBase) ,

				PercentageTurnoverAchievedTillTime=SUM(PercentageTurnoverAchievedTillTime),

				Emp_Name='DealerAverage',Emp_First_Name='Del Avg',

				lastTrade=''

				from  (

						select 

							sb_tag,

							emp_no,

							TargetTurnover,

							ActualAchivedTO,

							Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

							ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

							ClientBase = CONVERT(decimal(10,0),ClientBase),

							PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end

						from @tempDashboardData1 

						where emp_no<>@@Dealer

						and sb_tag=@@sb

				)a

				group by a.sb_tag

		

	

	

	 	 

	end

		LabelEnd:                                                      

		If @@Errorcount <> 0

		begin

			set @@MSG='Report is in process. Please wait for few minutes.'          

			select msg=@@MSG   

			

			select '1'

		end	

		

		

   

 			

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_TaVsAC_Timer_vol1_bak1
-- --------------------------------------------------
CREATE procedure [dbo].[B2bCrms_DashBoard_TaVsAC_Timer_vol1_bak1]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(20),--SUBBROKER/SBDEALER
	@Statusname varchar(20),
	@Sub_Broker varchar(10),
	@Dealer varchar(20)
	
)
as
begin
	/*
		
		exec B2bCrms_DashBoard_TaVsAC_Timer_vol1 'et001','SUBBROKER','','ET',''
		exec B2bCrms_DashBoard_TaVsAC_Timer_vol1 'et002','subbroker','et','et','et002'
	*/
	--WAITFOR DELAY '00:01:05'
	print 'Start:'+convert(varchar,getdate(),109)
	
	
	declare @@UserEmp_No varchar(20)
	declare @@UserStatusId varchar(20)
	declare @@Statusname varchar(20)
	declare @@Sub_Broker varchar(10)
	declare @@Dealer varchar(20)
	declare @@Report_Type varchar(20)
	
	set @@UserEmp_No =@UserEmp_No
	set @@UserStatusId=@UserStatusId 
	set @@Statusname =@Statusname
	set @@Sub_Broker =@Sub_Broker
	set @@Dealer =@Dealer
	
	
	
	Declare @@ToDate smalldatetime
	Declare @@FromDate smalldatetime
	
	Declare @@FromSub_Broker varchar(10)
	Declare @@ToSub_Broker varchar(10)
	Declare @@FromDealer varchar(10)
	Declare @@ToDealer varchar(10)
	Declare @@FromEffSaudaDate datetime
	Declare @@ToEffSaudaDate datetime
	Declare @@SegmentTypeFrom varchar(10)
	Declare @@SegmentTypeTo varchar(10)
	Declare @@TradingMode varchar(20)
    Declare @@ClientGrade varchar(20)
    Declare @@TradeDays int
    DECLARE @@Errorcount int                                                                                 
	
	SET @@Errorcount = 0 
 
	set @@SegmentTypeFrom ='0000'
	set @@SegmentTypeTo ='ZZZZZ'
	
	set @@TradingMode='%'
	set @@ClientGrade='%'
	
	
	set @@FromDate=left(CONVERT(smalldatetime,DATEADD(dd,-(DAY(GETDATE())-1),getdate())),11)+' 00:00'
	set @@ToDate=left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@@FromDate)+1,0)),109),11) + ' 23:59'--left(CONVERT(smalldatetime,GETDATE()),11)+' 00:00'

	--print @FromDate
	--print @ToDate
	
	select @@FromEffSaudaDate=left(MIN(Sauda_date),11),@@ToEffSaudaDate=GETDATE() 
	from (select top 15 Sauda_date=Sauda_date from TABLE_DATE WITH(NOLOCK) where CMTradingDay='y'  and date<getdate()  order by date desc)a
	 

	 
	/**subbroker*/
	if @@Sub_Broker='' or @@Sub_Broker='ALL' 
	Begin
		set @@FromSub_Broker='A'
		set @@ToSub_Broker='ZZZZZZZ'
	End
	else
	Begin
		Set @@FromSub_Broker=@@Sub_Broker
		Set @@ToSub_Broker=@@Sub_Broker
	End
	
	if @@Dealer='' or @@Dealer='ALL' 
	begin
		set @@FromDealer='A'
		set @@ToDealer='ZZZZZZZ'
	end
	else
	begin
		set @@FromDealer=@@Dealer
		set @@ToDealer=@@Dealer
	end
	
	create table #PartyDetails 
	(
	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime
	,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
	--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
	)
	
	--declare #BrokTurnOver table
	create table #BrokTurnOver 
	(
	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),
	TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
	NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
	Sauda_date smalldatetime
	)
	
	
	
	/*fill subbrokers and dealers*/
	declare @tempbranch  table                                                                
	(                                                                
	Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
	)
	
	Insert into @tempbranch
	select * from b2b_crms_mimansa_status(@@UserEmp_No) where sb_tag >=@@FromSub_Broker and  sb_tag <=@@ToSub_Broker
	
--select * from #BrokTurnOver where Emp_No='et001' and party_code='A10095' order by Party_Code

	

	
	
	print '2.1. Party Details Process Start:'+convert(varchar,getdate(),109)
	
	insert into 
		#PartyDetails 
		(Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
	select
		ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
	from 
		B2B_CommonPartyServices ps with(nolock) , @tempbranch aub  --OPTION (recompile)
	where 
		 ps.Branch_cd=aub.Branch_cd 
		and ps.FromDate<=@@ToEffSaudaDate
		and ps.ToDate>=@@FromEffSaudaDate
	OPTION (recompile);
			
	update 
		#PartyDetails 
	set 
		EbrokingClient=ac1.EbrokingClient,
		AngelClRating=ac1.AngelClRating
	From 
		angelclient1 ac1 with(nolock),#PartyDetails ps
	where 
		ac1.Party_Code=ps.Party_Code and 
		ac1.EbrokingClient like @@TradingMode
		and ac1.AngelClRating like @@ClientGrade
	
	delete #PartyDetails where isnull(EbrokingClient,'')=''
	
	
	print '2.1. Party Details Process Ends:'+convert(varchar,getdate(),109)
	
	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)
	
	select 
		ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
	into 
		#ActivarionRatio	
	from 
		#PartyDetails ps
	where 
		ps.FromDate<=@@ToEffSaudaDate
		and ps.ToDate>=@@ToEffSaudaDate		
	group by 
		ps.Branch_cd,ps.Emp_No
	
	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)
		
	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)	
	

	
	insert into #BrokTurnOver
	(
		Party_Code,
		Branch_cd,
		Emp_No, 
		TotalTurnover,
		NetRevenue,
		Sauda_date 
		)
		select 
		ps.Party_Code,
		ps.Branch_cd,
		ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		--Online_TurnOver=L.ebrok_TurnOver,
		--Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		--GrossRevenue=L.Overall_brok_earned,
		--GrossRevenue_Online=L.ebrok_brok_earned,
		--GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		--NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,		
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock)--, TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@@SegmentTypeFrom and 	
		EM.Segment_Type<=@@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		AND EM.FromDate <= @@FromEffSaudaDate 
		AND EM.ToDate >= @@ToEffSaudaDate 
		and ps.FromDate<=L.sauda_date 
		and ps.ToDate>=L.sauda_date
		and L.Sauda_date>= @@FromEffSaudaDate 
		and L.Sauda_date<= @@ToEffSaudaDate 
	
		
	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)
	--select * from #BrokTurnOver
	--return
	
	print '2.4. RTO in process check Starts:'+convert(varchar,getdate(),109)		
	
	declare @@MSG varchar(200)                  
	set @@MSG='Report is in process. Please wait for few minutes.'      
	Declare  @Processon varchar(1)   
	Declare @lastTrade datetime
	declare @lt109 datetime
	
	select @Processon=Processon,@lastTrade=dbo.roundtime(LastProcessDate,15),@lt109=LastProcessDate from [196.1.115.207].crm.dbo.Tbl_tradingdataupprocess with(nolock)
		--select @lastTrade = (SELECT convert(varchar,@lastTrade,106) + ' ' +  convert(varchar(5),@lastTrade,108) AS HourMinute)
	
	--set @Processon= 'Y'	          
	if (@Processon= 'Y')
	begin                    
		select msg=@@MSG   
		select '1'               
		return                    
	end 
	
	print '2.4. RTO in process check End:'+convert(varchar,getdate(),109)	
	
	select @@TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @@FromDate and sauda_date <= @@ToDate and CurrTradingDay = 'Y'
	
	
	Declare @@Act_Days int,@@H_days int,@@Total_Days int
	set @@Act_Days = (dbo.GetWorkingDays(@@FromDate,@@ToDate))                              
	set @@H_days = ( select  count(distinct holidaydate)  from [196.1.115.207].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
				where holidaydate >= @@FromDate and holidaydate <= @@ToDate ) 
				  
	select 	@@Total_Days=@@Act_Days-@@H_days
	
		
	if(@@UserStatusId='SUBBROKER')
	begin
	
			print '2.5. RTO Data Fetch Start:'+convert(varchar,getdate(),109)		
			print '-------------------------------------------------------------------------------'
			
			BEGIN TRY

			declare @rto_Data table(
			Zone varchar(20),Region varchar(20),branch_cd varchar(20),B2BRM varchar(20),B2BRM_Name varchar(100),emp_no varchar(20),emp_name varchar(100),                                    
							ActiveCLEq money,ActiveCLComm money, ActiveCLCurr money,                                
							TOToTimeCash money,
							TOToTimeFUT money ,
							TOToTimeOPT money  ,
							TOToTimeComm money ,
							TOToTimeCurr money ,                                  
							CLToTimeCash money,
							CLToTimeFUT money,
							CLToTimeOPT money,
							CLToTimeComm money,
							CLToTimeCURR money,                    
							TotalTO money,
							TotalCL money,
							Optnooflots bigint,
							ToTargetTurnover money,
							ToTargetClient int,
							ToNoOfLots int,
							NoOfLotsGold bigint,
							NoOfLotsSilver bigint,
							NoOfLotsCopper bigint  ,
							NoOfLotsCrude bigint,
							NoOfLotsComm bigint,
							TargetNoOfLotsGold bigint,
							TargetNoOfLotsSilver bigint,
							TargetNoOfLotsCopper bigint,
							TargetNoOfLotsCrude bigint

			)	
			
			insert into @rto_Data
			(
			Zone ,Region, branch_cd ,B2BRM ,B2BRM_Name ,emp_no ,emp_name ,                                    
							ActiveCLEq ,ActiveCLComm , ActiveCLCurr ,                                
							TOToTimeCash ,
							TOToTimeFUT  ,
							TOToTimeOPT   ,
							TOToTimeComm  ,
							TOToTimeCurr  ,                                  
							CLToTimeCash ,
							CLToTimeFUT ,
							CLToTimeOPT ,
							CLToTimeComm ,
							CLToTimeCURR ,                    
							TotalTO ,
							TotalCL ,
							Optnooflots ,
							ToTargetTurnover ,
							ToTargetClient ,
							ToNoOfLots ,
							NoOfLotsGold ,
							NoOfLotsSilver ,
							NoOfLotsCopper   ,
							NoOfLotsCrude ,
							NoOfLotsComm ,
							TargetNoOfLotsGold ,
							TargetNoOfLotsSilver ,
							TargetNoOfLotsCopper ,
							TargetNoOfLotsCrude 
			)
			--exec test_rto_op
			---exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_newfo] 
			exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_new] 
			--exec [196.1.115.207].CRM.dbo.GetTurnoverfortime_new_Target
			@Emp_no=@@UserEmp_No,
			@Zone='',
			@Region='',
			@Branch=@@Sub_Broker,
			@Exec=@@Dealer,
			@FromTime='09:00 AM',
			@ToTime='11:59 PM',
			@MainDrill='MAIN',
			@WiseReport='SBDEALER',
			@seg='ALL',
			@B2CStatus='B2B',
			@MimStatusID=@@UserStatusId,
			@SB='',
			@RoundValue='1',
			@DownloadCSVFlag='Y'

			

			END TRY

			BEGIN CATCH
				
			set @@Errorcount = @@error                                                                  
			If @@Errorcount <> 0 Goto LabelEnd    

			END CATCH;
			    

			print '-------------------------------------------------------------------------------'
			print '2.5. RTO Data Fetch End:'+convert(varchar,getdate(),109)		
			
			print '2.6. Output Data Start:'+convert(varchar,getdate(),109)	
			

			
			declare @tempDashboardData table
			(
				sb_tag varchar(20),
				emp_no varchar(20),
				TargetTurnover money,
				ActualAchivedTO money,
				ClientsTraded money,
				ClientBase money,
				ctc money,
				lastTrade Datetime
			)
			
			insert into @tempDashboardData
			(	sb_tag,
				emp_no,
				TargetTurnover,
				ActualAchivedTO,
				--Activation_Ratio,
				ClientsTraded ,
				ClientBase ,
				--PercentageTurnoverAchievedTillTime 
				ctc,
				Lasttrade
			)
			select 
				sb_tag=emp.Branch_cd,
				emp_no=emp.emp_no,
				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),
				Activation_Ratio=0,
				ClientsTraded =0,
				ClientBase =0,
				CTC=0,
				@lastTrade
				
			from
				#PartyDetails emp
			group by emp.Branch_cd,emp.emp_no	
			
			
			update @tempDashboardData set ctc=c.CTC
			from @tempDashboardData emp ,B2B_AngelHarmony c 
			where emp.Emp_No = c.emp_no
			
			
			
								
			update @tempDashboardData set TargetTurnover= case when a.TargetTurnover>0 then  a.TargetTurnover else 0 end
			from @tempDashboardData emp1,(
			select 
				emp_no=emp.emp_no,
				--TargetTurnover =cast((12*emp.ctc) as money)/(sum(NetRevenue)/sum(TotalTurnover))
				TargetTurnover =cast((12*emp.ctc/@@Total_Days) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))
			
			from 
				@tempDashboardData emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No
			group by emp.emp_no	,  emp.ctc
			)a
			where emp1.emp_no =a.emp_no
			
			
							
			update @tempDashboardData set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL
			from @tempDashboardData emp ,@rto_Data c 
			where emp.Emp_No = c.emp_no
			
			update @tempDashboardData set ClientBase=isnull((TotalClientsAsonDate),0)
			from @tempDashboardData emp ,#ActivarionRatio d 
			where emp.Emp_No = d.emp_no
			
			
			
			select 
			sb_tag=t1.sb_tag,
			emp_no=t1.emp_no,
				TargetTurnover=Case when TargetTurnover>0 then CONVERT(decimal(10,0),TargetTurnover/100000) else 0 end,
				ActualAchivedTO=CONVERT(decimal(10,0),ActualAchivedTO/100000),
				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,
				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,
				ClientBase = CONVERT(decimal(10,0),ClientBase),
				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end,
			Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4),
			lastTrade=convert(varchar,lastTrade,106) + ' ' +  convert(varchar(5),lastTrade,108) + right(@lt109,2)--AS HourMinute
			from @tempDashboardData t1, B2B_AngelHarmony ah with(nolock)
					where t1.Emp_No=ah.EMP_NO
			order by t1.emp_no 
			
			select
				TargetTurnover= CONVERT(decimal(10,0),sum(TargetTurnover)/100000) ,
				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000)				
			from @tempDashboardData 
			
			print '2.7. Output Data End:'+convert(varchar,getdate(),109)	
			
	print '1.5.END.:'+convert(varchar,getdate(),109)
			 
	end
	else
	begin
		print 'DEALER'
		declare @@sb_tag1 varchar(20)
		declare @@sb_admin1 varchar(20)
		declare @@parentsb varchar(20)
		declare @@sb varchar(20)
		
		select @@sb=sb_tag from B2B_AngelHarmony where emp_no=@@Dealer
		select top 1 @@parentsb=parentsb from B2B_CommonPartyServices with(nolock) where emp_no=@@Dealer
		if @@parentsb not in (null,'N.A','N.A') 
		begin
			select @@sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@@parentsb and isAdmin='1'
			select @@sb_tag1=''
		end
		else
		begin
		select @@sb_tag1=sb_tag from B2B_AngelHarmony where emp_no=@@Dealer
		select @@sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@@sb_tag1 and isAdmin='1'
		end
		
		BEGIN TRY
		insert into @rto_Data
		--exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_newfo] 
		exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_new] 
		@Emp_no=@@sb_admin1,
		@Zone='',
		@Region='',
		@Branch=@@sb_tag1,
		@Exec='',
		@FromTime='09:00 AM',
		@ToTime='11:59 PM',
		@MainDrill='MAIN',
		@WiseReport='SBDEALER',
		@seg='ALL',
		@B2CStatus='B2B',
		@MimStatusID='SUBBROKER',
		@SB='',
		@RoundValue='1',
		@DownloadCSVFlag='Y'	
		
		END TRY

			BEGIN CATCH
				
			set @@Errorcount = @@error                                                                  
			If @@Errorcount <> 0 Goto LabelEnd    

			END CATCH;
	
	declare @tempDashboardData1 table
			(
				sb_tag varchar(20),
				emp_no varchar(20),
				TargetTurnover money,
				ActualAchivedTO money,
				ClientsTraded money,
				ClientBase money,
				ctc money,
				status varchar(10),
				lastTrade Datetime
			)
			
			insert into @tempDashboardData1
			(	sb_tag,
				emp_no,
				TargetTurnover,
				ActualAchivedTO,
				--Activation_Ratio,
				ClientsTraded ,
				ClientBase ,
				--PercentageTurnoverAchievedTillTime 
				ctc,
				status,
				lastTrade				
			)
			select 
				sb_tag=emp.Branch_cd,
				emp_no=emp.emp_no,
				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),
				Activation_Ratio=0,
				ClientsTraded =0,
				ClientBase =0,
				CTC=0,
				status=0,
				@lastTrade
			from
				#PartyDetails emp
			group by emp.Branch_cd,emp.emp_no	
			
					
			
			update @tempDashboardData1 set ctc=c.CTC,status=isAdmin
			from @tempDashboardData1 emp ,B2B_AngelHarmony c 
			where emp.Emp_No = c.emp_no
			
			update @tempDashboardData1 set TargetTurnover= case when a.TargetTurnover > 0 then a.TargetTurnover else 0 end
			from @tempDashboardData1 emp1,(
			select 
				emp_no=emp.emp_no,
				TargetTurnover =cast((12*emp.ctc/@@Total_Days) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))
			
			from 
				@tempDashboardData1 emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No
			group by emp.emp_no,emp.ctc	  
			)a
			where emp1.emp_no =a.emp_no
			
			update @tempDashboardData1 set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL
			from @tempDashboardData1 emp ,@rto_Data c 
			where emp.Emp_No = c.emp_no
			and emp.sb_tag=c.branch_cd
			
			--update @tempDashboardData1 set ClientBase=isnull((TotalClientsAsonDate),0)
			--from @tempDashboardData1 emp ,#ActivarionRatio d 
			--where emp.Emp_No = d.emp_no
			--and emp.sb_tag=@Statusname
			
			select * from @tempDashboardData1 
			return
			
			select 
				sb_tag='',--t1.sb_tag,
				emp_no=t1.emp_no,
				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),
				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),
				Activation_Ratio=0,--case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,
				ClientsTraded=CONVERT(decimal(10,0),sum(ClientsTraded)) ,
				ClientBase =0,-- CONVERT(decimal(10,0),ClientBase),
				PercentageTurnoverAchievedTillTime=case when sum(TargetTurnover)>0 and sum(ActualAchivedTO)>0 then convert(decimal(10,0),(sum(ActualAchivedTO)/sum(TargetTurnover))*100) else 0 end,
			Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4),
			lastTrade=convert(varchar,lastTrade,106) + ' ' +  convert(varchar(5),lastTrade,108) + right(@lt109,2)--AS HourMinute
			from @tempDashboardData1 t1, B2B_AngelHarmony ah with(nolock)
					where t1.Emp_No=ah.EMP_NO
			and t1.emp_no=@@Dealer
			group by t1.emp_no,ah.EMP_NAME,ah.First_Name,ah.Emp_Name,lastTrade
			
			
			union all
			
			select 
				sb_tag,
				emp_no='DealerAverage',
				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),
				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),
				Activation_Ratio=sum(Activation_Ratio),
				ClientsTraded=sum(ClientsTraded ),
				ClientBase=sum(ClientBase) ,
				PercentageTurnoverAchievedTillTime=SUM(PercentageTurnoverAchievedTillTime),
				Emp_Name='DealerAverage',Emp_First_Name='Del Avg',
				lastTrade=''
				from  (
						select 
							sb_tag,
							emp_no,
							TargetTurnover,
							ActualAchivedTO,
							Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,
							ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,
							ClientBase = CONVERT(decimal(10,0),ClientBase),
							PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end
						from @tempDashboardData1 
						where emp_no<>@@Dealer
						and sb_tag=@@sb
				)a
				group by a.sb_tag
		
	
	
	 	 
	end
		LabelEnd:                                                      
		If @@Errorcount <> 0
		begin
			set @@MSG='Report is in process. Please wait for few minutes.'          
			select msg=@@MSG   
			
			select '1'
		end	
		
		
   
 			
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_DashBoard_TaVsAC_Timer_vol1_SAN
-- --------------------------------------------------


CREATE procedure [dbo].[B2bCrms_DashBoard_TaVsAC_Timer_vol1_SAN]

(

	@UserEmp_No varchar(20),

	@UserStatusId varchar(20),--SUBBROKER/SBDEALER

	@Statusname varchar(20),

	@Sub_Broker varchar(10),

	@Dealer varchar(20)

	

)

as

begin

	/*

		

		exec B2bCrms_DashBoard_TaVsAC_Timer_vol1 'et001','SUBBROKER','','ET',''

		exec B2bCrms_DashBoard_TaVsAC_Timer_vol1 'et002','subbroker','et','et','et002'

	*/

	--WAITFOR DELAY '00:01:05'

	print 'Start:'+convert(varchar,getdate(),109)

	

	

	declare @@UserEmp_No varchar(20)

	declare @@UserStatusId varchar(20)

	declare @@Statusname varchar(20)

	declare @@Sub_Broker varchar(10)

	declare @@Dealer varchar(20)

	declare @@Report_Type varchar(20)

	

	set @@UserEmp_No =@UserEmp_No

	set @@UserStatusId=@UserStatusId 

	set @@Statusname =@Statusname

	set @@Sub_Broker =@Sub_Broker

	set @@Dealer =@Dealer

	

	

	

	Declare @@ToDate smalldatetime

	Declare @@FromDate smalldatetime

	

	Declare @@FromSub_Broker varchar(10)

	Declare @@ToSub_Broker varchar(10)

	Declare @@FromDealer varchar(10)

	Declare @@ToDealer varchar(10)

	Declare @@FromEffSaudaDate datetime

	Declare @@ToEffSaudaDate datetime

	Declare @@SegmentTypeFrom varchar(10)

	Declare @@SegmentTypeTo varchar(10)

	Declare @@TradingMode varchar(20)

    Declare @@ClientGrade varchar(20)

    Declare @@TradeDays int

    DECLARE @@Errorcount int                                                                                 

	

	SET @@Errorcount = 0 

 

	set @@SegmentTypeFrom ='0000'

	set @@SegmentTypeTo ='ZZZZZ'

	

	set @@TradingMode='%'

	set @@ClientGrade='%'

	

	

	set @@FromDate=left(CONVERT(smalldatetime,DATEADD(dd,-(DAY(GETDATE())-1),getdate())),11)+' 00:00'

	set @@ToDate=left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@@FromDate)+1,0)),109),11) + ' 23:59'--left(CONVERT(smalldatetime,GETDATE()),11)+' 00:00'



	--print @FromDate

	--print @ToDate

	

	select @@FromEffSaudaDate=left(MIN(Sauda_date),11),@@ToEffSaudaDate=GETDATE() 

	from (select top 15 Sauda_date=Sauda_date from TABLE_DATE WITH(NOLOCK) where CMTradingDay='y'  and date<getdate()  order by date desc)a

	 



	 

	/**subbroker*/

	if @@Sub_Broker='' or @@Sub_Broker='ALL' 

	Begin

		set @@FromSub_Broker='A'

		set @@ToSub_Broker='ZZZZZZZ'

	End

	else

	Begin

		Set @@FromSub_Broker=@@Sub_Broker

		Set @@ToSub_Broker=@@Sub_Broker

	End

	

	if @@Dealer='' or @@Dealer='ALL' 

	begin

		set @@FromDealer='A'

		set @@ToDealer='ZZZZZZZ'

	end

	else

	begin

		set @@FromDealer=@@Dealer

		set @@ToDealer=@@Dealer

	end

	

	create table #PartyDetails 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

	,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

	--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

	)

	

	--declare #BrokTurnOver table

	create table #BrokTurnOver 

	(

	Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

	TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

	NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

	Sauda_date smalldatetime

	)

	

	

	

	/*fill subbrokers and dealers*/

	declare @tempbranch  table                                                                

	(                                                                

	Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

	)

	

	Insert into @tempbranch

	select * from b2b_crms_mimansa_status(@@UserEmp_No) where sb_tag >=@@FromSub_Broker and  sb_tag <=@@ToSub_Broker

	

--select * from #BrokTurnOver where Emp_No='et001' and party_code='A10095' order by Party_Code



	

	print @@FromEffSaudaDate

	print @@ToEffSaudaDate

	

	print '2.0. Party Details Process Start:'+convert(varchar,getdate(),109)

	
	insert into 

		#PartyDetails 

		(Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

	select

		ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

	from 

		B2B_CommonPartyServices ps with(nolock) , @tempbranch aub  --OPTION (recompile)

	where 

		 ps.Branch_cd=aub.Branch_cd 

		and ps.FromDate<=@@ToEffSaudaDate

		and ps.ToDate>=@@FromEffSaudaDate

	OPTION (recompile);

			

	update 

		#PartyDetails 

	set 

		EbrokingClient=ac1.EbrokingClient,

		AngelClRating=ac1.AngelClRating

	From 

		angelclient1 ac1 with(nolock),#PartyDetails ps

	where 

		ac1.Party_Code=ps.Party_Code and 

		ac1.EbrokingClient like @@TradingMode

		and ac1.AngelClRating like @@ClientGrade

	

	delete #PartyDetails where isnull(EbrokingClient,'')=''

	

	

	print '2.1. Party Details Process Ends:'+convert(varchar,getdate(),109)

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

	

	select 

		ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

	into 

		#ActivarionRatio	

	from 

		#PartyDetails ps

	where 

		ps.FromDate<=@@ToEffSaudaDate

		and ps.ToDate>=@@ToEffSaudaDate		

	group by 

		ps.Branch_cd,ps.Emp_No

	

	print '2.2. Activation Ratio Process Starts:'+convert(varchar,getdate(),109)

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)	

	



	

	insert into #BrokTurnOver

	(

		Party_Code,

		Branch_cd,

		Emp_No, 

		TotalTurnover,

		NetRevenue,

		Sauda_date 

		)

		select 

		ps.Party_Code,

		ps.Branch_cd,

		ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		--Online_TurnOver=L.ebrok_TurnOver,

		--Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		--GrossRevenue=L.Overall_brok_earned,

		--GrossRevenue_Online=L.ebrok_brok_earned,

		--GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		--NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,		

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock)--, TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@@SegmentTypeFrom and 	

		EM.Segment_Type<=@@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		AND EM.FromDate <= @@FromEffSaudaDate 

		AND EM.ToDate >= @@ToEffSaudaDate 

		and ps.FromDate<=L.sauda_date 

		and ps.ToDate>=L.sauda_date

		and L.Sauda_date>= @@FromEffSaudaDate 

		and L.Sauda_date<= @@ToEffSaudaDate 

	

		

	print '2.3. Brokerage And Turnover Data Starts:'+convert(varchar,getdate(),109)

	--select * from #BrokTurnOver

	--return

	

	print '2.4. RTO in process check Starts:'+convert(varchar,getdate(),109)		

	

	declare @@MSG varchar(200)                  

	set @@MSG='Report is in process. Please wait for few minutes.'      

	Declare  @Processon varchar(1)   

	Declare @lastTrade datetime

	declare @lt109 datetime

	

	select @Processon=Processon,@lastTrade=dbo.roundtime(LastProcessDate,15),@lt109=LastProcessDate from [MIMANSA].crm.dbo.Tbl_tradingdataupprocess with(nolock)

		--select @lastTrade = (SELECT convert(varchar,@lastTrade,106) + ' ' +  convert(varchar(5),@lastTrade,108) AS HourMinute)

	

	--set @Processon= 'Y'	          

	if (@Processon= 'Y')

	begin                    

		select msg=@@MSG   

		select '1'               

		return                    

	end 

	

	print '2.4. RTO in process check End:'+convert(varchar,getdate(),109)	

	

	select @@TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @@FromDate and sauda_date <= @@ToDate and CurrTradingDay = 'Y'

	

	

	Declare @@Act_Days int,@@H_days int,@@Total_Days int

	set @@Act_Days = (dbo.GetWorkingDays(@@FromDate,@@ToDate))                              

	set @@H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

				where holidaydate >= @@FromDate and holidaydate <= @@ToDate ) 

				  

	select 	@@Total_Days=@@Act_Days-@@H_days

	

		

	if(@@UserStatusId='SUBBROKER')

	begin

	

			print '2.5. RTO Data Fetch Start:'+convert(varchar,getdate(),109)		

			print '-------------------------------------------------------------------------------'

			

			BEGIN TRY



			declare @rto_Data table(

			Zone varchar(20),Region varchar(20),branch_cd varchar(20),B2BRM varchar(20),B2BRM_Name varchar(100),emp_no varchar(20),emp_name varchar(100),                                    

							ActiveCLEq money,ActiveCLComm money, ActiveCLCurr money,                                

							TOToTimeCash money,

							TOToTimeFUT money ,

							TOToTimeOPT money  ,

							TOToTimeComm money ,

							TOToTimeCurr money ,                                  

							CLToTimeCash money,

							CLToTimeFUT money,

							CLToTimeOPT money,

							CLToTimeComm money,

							CLToTimeCURR money,                    

							TotalTO money,

							TotalCL money,

							Optnooflots bigint,

							ToTargetTurnover money,

							ToTargetClient int,

							ToNoOfLots int,

							NoOfLotsGold bigint,

							NoOfLotsSilver bigint,

							NoOfLotsCopper bigint  ,

							NoOfLotsCrude bigint,

							NoOfLotsComm bigint,

							TargetNoOfLotsGold bigint,

							TargetNoOfLotsSilver bigint,

							TargetNoOfLotsCopper bigint,

							TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			(

			Zone ,Region, branch_cd ,B2BRM ,B2BRM_Name ,emp_no ,emp_name ,                                    

							ActiveCLEq ,ActiveCLComm , ActiveCLCurr ,                                

							TOToTimeCash ,

							TOToTimeFUT  ,

							TOToTimeOPT   ,

							TOToTimeComm  ,

							TOToTimeCurr  ,                                  

							CLToTimeCash ,

							CLToTimeFUT ,

							CLToTimeOPT ,

							CLToTimeComm ,

							CLToTimeCURR ,                    

							TotalTO ,

							TotalCL ,

							Optnooflots ,

							ToTargetTurnover ,

							ToTargetClient ,

							ToNoOfLots ,

							NoOfLotsGold ,

							NoOfLotsSilver ,

							NoOfLotsCopper   ,

							NoOfLotsCrude ,

							NoOfLotsComm ,

							TargetNoOfLotsGold ,

							TargetNoOfLotsSilver ,

							TargetNoOfLotsCopper ,

							TargetNoOfLotsCrude 

			)

			--exec test_rto_op

			---exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			--exec [MIMANSA].CRM.dbo.GetTurnoverfortime_new_Target

			@Emp_no=@@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch=@@Sub_Broker,

			@Exec=@@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='MAIN',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID=@@UserStatusId,

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			



			END TRY



			BEGIN CATCH

				

			set @@Errorcount = @@error                                                                  

			If @@Errorcount <> 0 Goto LabelEnd    



			END CATCH;

			    


			print '-------------------------------------------------------------------------------'

			print '2.5. RTO Data Fetch End:'+convert(varchar,getdate(),109)		

			

			print '2.6. Output Data Start:'+convert(varchar,getdate(),109)	

			



			

			declare @tempDashboardData table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money,

				lastTrade Datetime

			)

			

			insert into @tempDashboardData

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc,

				Lasttrade

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0,

				@lastTrade

				

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			

			

			update @tempDashboardData set ctc=c.CTC

			from @tempDashboardData emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

			

			print '2.6.1 Output Data prepair:'+convert(varchar,getdate(),109)	

								

			update @tempDashboardData set TargetTurnover= case when a.TargetTurnover>0 then  a.TargetTurnover else 0 end

			from @tempDashboardData emp1,(

			select 

				emp_no=emp.emp_no,

				--TargetTurnover =cast((12*emp.ctc) as money)/(sum(NetRevenue)/sum(TotalTurnover))

				TargetTurnover =case when (sum(TotalTurnover) > 0 and cast(sum(NetRevenue) as decimal(20,10))> 0) then  cast((12*emp.ctc/@@Total_Days) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover)) else 0 end

			

			from 

				@tempDashboardData emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no	,  emp.ctc

			)a

			where emp1.emp_no =a.emp_no

			

			print '2.6.2 Output Data prepair:'+convert(varchar,getdate(),109)	

							

			update @tempDashboardData set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData set ClientBase=isnull((TotalClientsAsonDate),0)

			from @tempDashboardData emp ,#ActivarionRatio d 

			where emp.Emp_No = d.emp_no

			

			

			

			select 

			sb_tag=t1.sb_tag,

			emp_no=t1.emp_no,

				TargetTurnover=Case when TargetTurnover>0 then CONVERT(decimal(10,0),TargetTurnover/100000) else 0 end,

				ActualAchivedTO=CONVERT(decimal(10,0),ActualAchivedTO/100000),

				Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

				ClientBase = CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end,

			Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4),

			lastTrade=convert(varchar,lastTrade,106) + ' ' +  convert(varchar(5),lastTrade,108) + right(@lt109,2)--AS HourMinute

			from @tempDashboardData t1, B2B_AngelHarmony ah with(nolock)

					where t1.Emp_No=ah.EMP_NO

			order by t1.emp_no 

			

			select

				TargetTurnover= CONVERT(decimal(10,0),sum(TargetTurnover)/100000) ,

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000)				

			from @tempDashboardData 

			

			print '2.7. Output Data End:'+convert(varchar,getdate(),109)	

			

	print '1.5.END.:'+convert(varchar,getdate(),109)

			 

	end

	else

	begin

		print 'DEALER'

		declare @@sb_tag1 varchar(20)

		declare @@sb_admin1 varchar(20)

		declare @@parentsb varchar(20)

		declare @@sb varchar(20)

		

		select @@sb=sb_tag from B2B_AngelHarmony where emp_no=@@Dealer

		select top 1 @@parentsb=parentsb from B2B_CommonPartyServices with(nolock) where emp_no=@@Dealer

		if @@parentsb not in (null,'N.A','N.A') 

		begin

			select @@sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@@parentsb and isAdmin='1'

			select @@sb_tag1=''

		end

		else

		begin

		select @@sb_tag1=sb_tag from B2B_AngelHarmony where emp_no=@@Dealer

		select @@sb_admin1=emp_no from B2B_AngelHarmony where sb_tag=@@sb_tag1 and isAdmin='1'

		end

		

		BEGIN TRY

		insert into @rto_Data

		--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

		exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

		@Emp_no=@@sb_admin1,

		@Zone='',

		@Region='',

		@Branch=@@sb_tag1,

		@Exec='',

		@FromTime='09:00 AM',

		@ToTime='11:59 PM',

		@MainDrill='MAIN',

		@WiseReport='SBDEALER',

		@seg='ALL',

		@B2CStatus='B2B',

		@MimStatusID='SUBBROKER',

		@SB='',

		@RoundValue='1',

		@DownloadCSVFlag='Y'	

		

		END TRY



			BEGIN CATCH

				

			set @@Errorcount = @@error                                                                  

			If @@Errorcount <> 0 Goto LabelEnd    



			END CATCH;

	

	declare @tempDashboardData1 table

			(

				sb_tag varchar(20),

				emp_no varchar(20),

				TargetTurnover money,

				ActualAchivedTO money,

				ClientsTraded money,

				ClientBase money,

				ctc money,

				status varchar(10),

				lastTrade Datetime

			)

			

			insert into @tempDashboardData1

			(	sb_tag,

				emp_no,

				TargetTurnover,

				ActualAchivedTO,

				--Activation_Ratio,

				ClientsTraded ,

				ClientBase ,

				--PercentageTurnoverAchievedTillTime 

				ctc,

				status,

				lastTrade				

			)

			select 

				sb_tag=emp.Branch_cd,

				emp_no=emp.emp_no,

				TargetTurnover =0,--=isnull(convert(decimal(30,2),((12*sum(emp.ctc))/(sum(NetRevenue)/sum(TotalTurnover)))),0),

				Activation_Ratio=0,

				ClientsTraded =0,

				ClientBase =0,

				CTC=0,

				status=0,

				@lastTrade

			from

				#PartyDetails emp

			group by emp.Branch_cd,emp.emp_no	

			

					

			

			update @tempDashboardData1 set ctc=c.CTC,status=isAdmin

			from @tempDashboardData1 emp ,B2B_AngelHarmony c 

			where emp.Emp_No = c.emp_no

			

			update @tempDashboardData1 set TargetTurnover= case when a.TargetTurnover > 0 then a.TargetTurnover else 0 end

			from @tempDashboardData1 emp1,(

			select 

				emp_no=emp.emp_no,

				TargetTurnover =cast((12*emp.ctc/@@Total_Days) as money)/(cast(sum(NetRevenue) as decimal(20,10))/sum(TotalTurnover))

			

			from 

				@tempDashboardData1 emp inner join #BrokTurnOver b  on emp.Emp_No=b.Emp_No

			group by emp.emp_no,emp.ctc	  

			)a

			where emp1.emp_no =a.emp_no

			

			update @tempDashboardData1 set ActualAchivedTO=isnull((TotalTO),0),ClientsTraded=TotalCL

			from @tempDashboardData1 emp ,@rto_Data c 

			where emp.Emp_No = c.emp_no

			and emp.sb_tag=c.branch_cd

			

			--update @tempDashboardData1 set ClientBase=isnull((TotalClientsAsonDate),0)

			--from @tempDashboardData1 emp ,#ActivarionRatio d 

			--where emp.Emp_No = d.emp_no

			--and emp.sb_tag=@Statusname

			

	

			

			select 

				sb_tag='',--t1.sb_tag,

				emp_no=t1.emp_no,

				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),

				Activation_Ratio=0,--case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

				ClientsTraded=CONVERT(decimal(10,0),sum(ClientsTraded)) ,

				ClientBase =0,-- CONVERT(decimal(10,0),ClientBase),

				PercentageTurnoverAchievedTillTime=case when sum(TargetTurnover)>0 and sum(ActualAchivedTO)>0 then convert(decimal(10,0),(sum(ActualAchivedTO)/sum(TargetTurnover))*100) else 0 end,

			Emp_Name=ltrim(rtrim(ah.EMP_NAME)),Emp_First_Name=left(isnull(ah.First_Name,ah.Emp_Name),4),

			lastTrade=convert(varchar,lastTrade,106) + ' ' +  convert(varchar(5),lastTrade,108) + right(@lt109,2)--AS HourMinute

			from @tempDashboardData1 t1, B2B_AngelHarmony ah with(nolock)

					where t1.Emp_No=ah.EMP_NO

			and t1.emp_no=@@Dealer

			group by t1.emp_no,ah.EMP_NAME,ah.First_Name,ah.Emp_Name,lastTrade

			

			

			union all

			

			select 

				sb_tag,

				emp_no='DealerAverage',

				TargetTurnover=CONVERT(decimal(10,0),sum(TargetTurnover)/100000),

				ActualAchivedTO=CONVERT(decimal(10,0),sum(ActualAchivedTO)/100000),

				Activation_Ratio=sum(Activation_Ratio),

				ClientsTraded=sum(ClientsTraded ),

				ClientBase=sum(ClientBase) ,

				PercentageTurnoverAchievedTillTime=SUM(PercentageTurnoverAchievedTillTime),

				Emp_Name='DealerAverage',Emp_First_Name='Del Avg',

				lastTrade=''

				from  (

						select 

							sb_tag,

							emp_no,

							TargetTurnover,

							ActualAchivedTO,

							Activation_Ratio=case when (ClientsTraded>0 and ClientBase> 0 ) then (ClientsTraded/ClientBase)*100 else 0 end,

							ClientsTraded=CONVERT(decimal(10,0),ClientsTraded) ,

							ClientBase = CONVERT(decimal(10,0),ClientBase),

							PercentageTurnoverAchievedTillTime=case when TargetTurnover>0 and ActualAchivedTO>0 then convert(decimal(10,0),(ActualAchivedTO/TargetTurnover)*100) else 0 end

						from @tempDashboardData1 

						where emp_no<>@@Dealer

						and sb_tag=@@sb

				)a

				group by a.sb_tag

		

	

	

	 	 

	end

		LabelEnd:                                                      

		If @@Errorcount <> 0

		begin

			set @@MSG='Report is in process. Please wait for few minutes.'          

			select msg=@@MSG   

			

			select '1'

		end	

		

		

   

 			

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bCrms_NotifyBlankSttatusID
-- --------------------------------------------------

CREATE procedure [dbo].[B2bCrms_NotifyBlankSttatusID]
as 
begin

	select 
		HarmonyEmployeeCode 
	into 
		#temp_emp_code
	from 
		angelusers a with(nolock), B2B_AngelHarmony b  
	where 
		MimansaStatusid is null
		and a.HarmonyEmployeeCode=b.emp_no
		and	b.Status='A'

	Declare @@count int

	select @@count=count(1) from #temp_emp_code

	Declare @@tableHTML varchar(max)
	set @@tableHTML=''

	set @@tableHTML= 'Dear Team, <br/> Please check the client who dont have status assigened in todays Up_users process.<br/> Date : '+convert(varchar,getdate(),103)+'.<br/>' 
	set @@tableHTML=@@tableHTML+'<table><tr><td style="border-bottom:1px solid Black;border-left: 1px solid Black;border-top:1px solid Black; border-right:1px solid Black;background-color:#C5CED5">Client Code</td></tr>'
	if(@@count>0)
	begin
		select @@tableHTML=@@tableHTML+'<tr><TD style="border-bottom:1px solid Black;border-left: 1px solid Black;border-top:1px solid Black; border-right:1px solid Black;background-color:#C5CED5">'+HarmonyEmployeeCode+'</TD></tr>' from #temp_emp_code
	end
	else
	begin
		set @@tableHTML=@@tableHTML+'<tr><td>No record Found</td></tr>'
	end
	set @@tableHTML=@@tableHTML+'</table><br/>'
	set @@tableHTML=@@tableHTML+'Regards,<br/>Mimansa Team'

		
	exec msdb.dbo.sp_send_dbmail   
	@recipients='prasannav.joshi@angeltrade.com;sandip.girnar@angelbroking.com;aniket.latne@angelbroking.com', 
	@importance ='High',   
	@body_format='HTML',  
	--@copy_recipients ='',  
	@subject ='Todayas Client with No Status id in B2b Crms',  
	@profile_name ='MimansaSoft',  
	@body=@@tableHTML
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.b2bCrmsDailyLog_removed
-- --------------------------------------------------
CREATE procedure b2bCrmsDailyLog
as
begin

	truncate table b2bCrmslogMailerTable
	
	insert into b2bCrmslogMailerTable
		(
		usercode, loginid, emprole,	logdatetime, logtype,description
		)
	select 
		usercode,
		loginid=emp_no,
		emprole,
		logdatetime,
		logtype=case when logtype='Jamppon Call' then 'advisory Call' else logtype end ,
		description 
	from 
		tbl_AppLog with(nolock) 
	where 
		LogType<> 'Error_Log' and 
		Description<>'error_page.aspx' and
		Description<>'Failed Login' and
		logdatetime>=LEFT(getdate()-1,11) + ' 00:00' and
		logdatetime<LEFT(getdate()-1,11) + ' 11:59' 
	order by logdatetime,usercode
	declare @FileName varchar(50)
	--set @FileName='CRMS_Log_For_'+getdate()+'.csv'
	
	Declare @outputstring varchar(8000)
	DECLARE @bcpCommand varchar(2000)
	SET @FileName = REPLACE('\\196.1.115.132\d$\B2bCrmsDailyLog\data.CSV','/','-')        
	SELECT @outputstring = 'bcp "select   ''User Code'',''Login ID'',''Emp Role'',''Date and Time'',''Login Type'',''Description'' union all select   usercode,loginid,emprole,logdatetime,logtype,description  from  '+' mimansa.dbo.b2bCrmslogMailerTable with(nolock) ' + '" queryout ' + @FileName+'  -c -t, -T -S mimansa'
	exec master..xp_cmdshell @outputstring
	
	declare @tableHTML nvarchar(max)

	set @tableHTML =  '<p>Dear Team<br /><br />Please see the attached file to track the daily login activity in B2B CRMS Portal for the date '+left(getdate()-1,11)+'<br /><br />'
	set @tableHTML=@tableHTML+'Regards, <br />Mimansa CSO,<br/>020-30904032<br /><br />'	
	set @tableHTML=@tableHTML+'------------------------------------------------------------------------------------<br />'
	set @tableHTML=@tableHTML+'This is a system generated mail, please do not reply to this mail.<br /></p>'
	
	declare @subject varchar(500)
	set @subject='Daily login Report of B2B CRMS Application : '+left(getdate()-1,11)
	
	exec msdb.dbo.sp_send_dbmail   
	@recipients=N'prasannav.joshi@angeltrade.com', 
	--@recipients=N'sudhanshu.sharma@angelbroking.com, poonam.chaudhary@angelbroking.com', 
	@importance ='High',   
	@body_format='HTML',  
	--@copy_recipients ='Mimansa.CRMSSB@angelbroking.com',
	@subject =@subject,  
	@profile_name ='MimansaSoft',  
	@body=@tableHTML,
	@file_attachments=@FileName
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.B2bDashBoard_CallMadeToClients
-- --------------------------------------------------

--select emp_no,First_Name,Emp_Name from B2B_AngelHarmony where sb_tag='Et' order by emp_no

CREATE procedure [dbo].[B2bDashBoard_CallMadeToClients]
(
	@UserEmp_No varchar(20),
	@UserStatusId varchar(10),
	@UserStatusName varchar(20),
	@Sub_Broker varchar(10)
)
as
begin
	/*
		exec B2bDashBoard_CallMadeToClients 'ET001','SUBBROKER','ET','ET'
	*/
select 
	emp_no,
	Emp_First_Name=LEFT(isnull(First_Name,Emp_Name),4),
	Emp_Name,
	No_of_Clients_Alert_Generated_for=sum(No_of_Clients_Alert_Generated_for),
	No_of_Clients_Marked_Success=sum(No_of_Clients_Marked_Success) 
from 
	[172.31.16.13].isense.dbo.Vw_Blink_Advisory_Summary ,B2B_AngelHarmony with(nolock)
where 
	sb_tag=@Sub_Broker
	and dealer=emp_no
group by emp_no,	First_Name,	Emp_Name
order by emp_no


--select 
--	COUNT(dealer),dealer
--from 
--	[172.31.16.13].isense.dbo.Vw_Blink_Advisory_Summary 
-- group by dealer
--having COUNT(dealer)>1	 

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_login
-- --------------------------------------------------
CREATE procedure check_login
(
	@emp_code varchar(10)
)
as
begin 
	--check_login 'ca'
	--check_login 'caa001'
	
	if EXISTS (select * from b2b_harmony with(nolock) where empcode= @emp_code) 
	begin
		select 'SBEMP'
		return 
	end
	else
	begin
		select 'SUBBROKER'
	end		
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.client_info
-- --------------------------------------------------
CREATE procedure [dbo].[client_info]
(
	@UserEmp_No varchar(20),
	@StatusId varchar(10),		--SUBBROKER/SBDEALER
	@StatusName varchar(10)		--SUBBROKER/SBDEALER
	
)
AS
Begin
	
	--exec client_info @UserEmp_No='ca001',@StatusId='SUBBROKER',@StatusName='ca'
	--exec client_info @UserEmp_No='et001',@StatusId='SUBBROKER',@StatusName='et'
	--exec client_info @UserEmp_No='eta002',@StatusId='SBDEALER',@StatusName='eta002'
	--exec client_info @UserEmp_No='BAREILLY001',@StatusId='SUBBROKER',@StatusName='BAREILLY'
	
	
	
	declare  @temp_sbtag table
	(
	sbtag varchar(10)
	)
		
	insert into @temp_sbtag
	SELECT sb_tag  
	FROM dbo.b2b_crms_mimansa_status(@UserEmp_No);
	
	if @StatusId = 'SBDEALER'     
	begin 
		
		select 
			   ROW_NUMBER() OVER (ORDER BY b1.party_code) AS 'SrNo',	
			   party_code=b1.party_code ,
			   short_name=a1.short_name,
			   sub_broker,
			   mobile_pager=isnull(mobile_pager,'N.A.'),
			   --activefrom=left(activefrom,11),
			   --lastTrade= left(lastTrade,11)
			   activefrom= convert(varchar,convert(datetime,left(activefrom,11), 101), 101),
			   lastTrade= convert(varchar,convert(datetime,left(lastTrade,11), 101), 101)
		from B2B_CommonPartyServices b1 with(nolock),@temp_sbtag, angelclient1 a1 with(nolock)
		where b1.branch_cd=sbtag and
		valid='Y' and
		emp_no =@UserEmp_No and
		b1.party_code=a1.party_code 
		and left(b1.party_code,2)<>'98'
		and b2c=case when @UserEmp_No like 'HYD1%' then 'Y' else 'N' end   
		order by sub_broker,party_code
		
	end
	else
	begin
		select 
			ROW_NUMBER() OVER (ORDER BY party_code) AS 'SrNo',
			party_code,
			short_name,
			sub_broker,
			mobile_pager=isnull(mobile_pager,'N.A.'),
			--activefrom=left(activefrom,11),
			--lastTrade= left(lastTrade,11)
			activefrom=convert(varchar,convert(datetime,left(activefrom,11), 101), 101),
			lastTrade= convert(varchar,convert(datetime,left(lastTrade,11), 101), 101)
		from 
			angelclient1 with(nolock) ,@temp_sbtag
		where
			sub_broker= sbtag
			and left(party_code,2)<>'98' 
			--and b2c='N'
			and b2c=case when @UserEmp_No like 'HYD1%' then 'Y' else 'N' end   
		order by sub_broker,party_code	
	end 

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.client_info_Backup(14May2015)
-- --------------------------------------------------
Create procedure [dbo].[client_info_Backup(14May2015)]
(
	@UserEmp_No varchar(20),
	@StatusId varchar(10),		--SUBBROKER/SBDEALER
	@StatusName varchar(10)		--SUBBROKER/SBDEALER
	
)
AS
Begin
	
	--exec client_info @UserEmp_No='ca001',@StatusId='SUBBROKER',@StatusName='ca'
	--exec client_info @UserEmp_No='et001',@StatusId='SUBBROKER',@StatusName='et'
	--exec client_info @UserEmp_No='eta002',@StatusId='SBDEALER',@StatusName='eta002'
	--exec client_info @UserEmp_No='BAREILLY001',@StatusId='SUBBROKER',@StatusName='BAREILLY'
	
	
	
	declare  @temp_sbtag table
	(
	sbtag varchar(10)
	)
		
	insert into @temp_sbtag
	SELECT sb_tag  
	FROM dbo.b2b_crms_mimansa_status(@UserEmp_No);
	
	if @StatusId = 'SBDEALER'     
	begin 
		
		select 
			   ROW_NUMBER() OVER (ORDER BY b1.party_code) AS 'SrNo',	
			   party_code=b1.party_code ,
			   short_name=a1.short_name,
			   sub_broker,
			   mobile_pager=isnull(mobile_pager,'N.A.'),
			   activefrom=left(activefrom,11),
			   lastTrade= left(lastTrade,11)
		from B2B_CommonPartyServices b1 with(nolock),@temp_sbtag, angelclient1 a1 with(nolock)
		where b1.branch_cd=sbtag and
		valid='Y' and
		emp_no =@UserEmp_No and
		b1.party_code=a1.party_code 
		and left(b1.party_code,2)<>'98'
		and b2c=case when @UserEmp_No like 'HYD1%' then 'Y' else 'N' end   
		order by sub_broker,party_code
		
	end
	else
	begin
		select 
			ROW_NUMBER() OVER (ORDER BY party_code) AS 'SrNo',
			party_code,
			short_name,
			sub_broker,
			mobile_pager=isnull(mobile_pager,'N.A.'),
			activefrom=left(activefrom,11),
			lastTrade= left(lastTrade,11)
		from 
			angelclient1 with(nolock) ,@temp_sbtag
		where
			sub_broker= sbtag
			and left(party_code,2)<>'98' 
			--and b2c='N'
			and b2c=case when @UserEmp_No like 'HYD1%' then 'Y' else 'N' end   
		order by sub_broker,party_code	
	end 

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.client_info_test
-- --------------------------------------------------
CREATE procedure [dbo].[client_info_test]
(
	@UserEmp_No varchar(20),
	@StatusId varchar(10),		--SUBBROKER/SBDEALER
	@StatusName varchar(10)		--SUBBROKER/SBDEALER
	
)
AS
Begin
	
	--exec client_info @UserEmp_No='ca001',@StatusId='SUBBROKER',@StatusName='ca'
	--exec client_info @UserEmp_No='et001',@StatusId='SUBBROKER',@StatusName='et'
	--exec client_info @UserEmp_No='eta002',@StatusId='SBDEALER',@StatusName='eta002'
	--exec client_info @UserEmp_No='BAREILLY001',@StatusId='SUBBROKER',@StatusName='BAREILLY'
	
	
	
	declare  @temp_sbtag table
	(
	sbtag varchar(10)
	)
		
	insert into @temp_sbtag
	SELECT sb_tag  
	FROM dbo.b2b_crms_mimansa_status(@UserEmp_No);
	
	if @StatusId = 'SBDEALER'     
	begin 
		
		select 
			   ROW_NUMBER() OVER (ORDER BY b1.party_code) AS 'SrNo',	
			   party_code=b1.party_code ,
			   short_name=a1.short_name,
			   sub_broker,
			   mobile_pager=isnull(mobile_pager,'N.A.'),
			   activefrom,--=left(activefrom,11),
			   lastTrade--= left(lastTrade,11)
		from B2B_CommonPartyServices b1 with(nolock),@temp_sbtag, angelclient1 a1 with(nolock)
		where b1.branch_cd=sbtag and
		valid='Y' and
		emp_no =@UserEmp_No and
		b1.party_code=a1.party_code 
		and left(b1.party_code,2)<>'98'
		and b2c=case when @UserEmp_No like 'HYD1%' then 'Y' else 'N' end   
		order by sub_broker,party_code
		
	end
	else
	begin
		select 
			ROW_NUMBER() OVER (ORDER BY party_code) AS 'SrNo',
			party_code,
			short_name,
			sub_broker,
			mobile_pager=isnull(mobile_pager,'N.A.'),
			activefrom,--=left(activefrom,11),
			lastTrade--= left(lastTrade,11)
		from 
			angelclient1 with(nolock) ,@temp_sbtag
		where
			sub_broker= sbtag
			and left(party_code,2)<>'98' 
			--and b2c='N'
			and b2c=case when @UserEmp_No like 'HYD1%' then 'Y' else 'N' end   
		order by sub_broker,party_code	
	end 

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.createNVIRequest
-- --------------------------------------------------
CREATE procedure [dbo].[createNVIRequest]  
(  
@ReqID nvarchar(15),  
@ItemID varchar(20),  
@CatID varchar(20),  
@ItemName varchar(100),  
@CategoryName varchar(100),  
@UserNote varchar(100),  
@ReqDate datetime,--varchar(50),  
@CompleteByDate varchar(25),  
@Emp_no varchar(10),  
@Hod_no varchar(10), 
@Pi_no varchar(10), 
@Qty int,  
@ModID varchar(25),  
@stat varchar(4),
@rqgid varchar(20),
@orderid varchar(50)  
)  
as  
Declare @Pi as Varchar(10)  
set @Pi = (select Pi_No from hod_mapping where hod_no=@hod_no)  
  
insert into UserRequest values (@ReqID,@ItemID,@CatID,@ItemName,@CategoryName,@UserNote,'',@stat,@ReqDate,@CompleteByDate,'','no',@Emp_no,@Hod_no,@Pi,@qty,@orderid,@rqgid)  
insert into ModifiedRequest values (@ModID,@ReqID,@ItemID,@ItemName,@qty,@UserNote,@Emp_no,@ReqDate,@CompleteByDate,@stat,0)  
insert into userreqgroup values(@reqid,@rqgid)  
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.disp_req
-- --------------------------------------------------

CREATE procedure [dbo].[disp_req]    
(    
@uno as varchar(25),    
@reqCode as varchar(5),  
@opt as varchar(50)    
)    
as    
  if @opt = 'HOD'    
begin  
select a.ReqID, a.ItemName, a.CategoryName, b.ReqStatusName,c.Emp_Name,c.Emp_no,a.CompleteByDate, a.reqStatusCode from UserRequest a,    
ReqStatus b,risk.dbo.emp_info c where a.Hod_no =@uno and a.hod_no=c.senior AND a.ReqStatusCode = b.ReqStatusCode AND a.ReqStatusCode=@reqCode order by a.ReqStatusCode     
  end  
else  
select a.ReqID, a.ItemName, a.CategoryName, b.ReqStatusName,c.Emp_Name,c.Emp_no,a.CompleteByDate, a.reqStatusCode from UserRequest a,    
ReqStatus b,risk.dbo.emp_info c where a.hod_no=(select hod_no from hod_mapping where pi_no =@uno)and a.emp_no=c.emp_no AND a.ReqStatusCode = b.ReqStatusCode AND a.ReqStatusCode=@reqCode order by a.ReqStatusCode     
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.find_text_in_sp
-- --------------------------------------------------

--find_text_in_sp 'B2B CRMS Error Report'

Create PROCEDURE [dbo].[find_text_in_sp]   
  @text varchar(250),   
  @dbname varchar(64) = null  
AS BEGIN  
SET NOCOUNT ON;   
  
if @dbname is null  
  begin  
    --enumerate all databases.   
  DECLARE #db CURSOR FOR Select Name from master..sysdatabases   
  declare @c_dbname varchar(64)   
  
  OPEN #db FETCH #db INTO @c_dbname   
  while @@FETCH_STATUS <> -1 --and @MyCount < 500   
   begin  
     execute find_text_in_sp @text, @c_dbname   
     FETCH #db INTO @c_dbname   
   end     
  CLOSE #db DEALLOCATE #db   
 end --if @dbname is null   
else  
 begin --@dbname is not null   
  declare @sql varchar(250)   
  --create the find like command   
  select @sql = 'select ''' + @dbname + ''' as db, o.name,m.definition '  
  select @sql = @sql + ' from '+@dbname+'.sys.sql_modules m '  
  select @sql = @sql + ' inner join '+@dbname+'..sysobjects o on m.object_id=o.id'  
  select @sql = @sql + ' where [definition] like ''%'+@text+'%'''  
  execute (@sql)   
 end --@dbname is not null   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.gen_report
-- --------------------------------------------------

create proc [dbo].[gen_report]

@emp_no  varchar(15)

as
select itemid,sum(qty) as sum  into #tempabc from userrequest  where emp_no=@emp_no group by itemid


select b.itemid,a.sum,b.itemname from #tempabc a,inventoryitem b where b.itemid in(select itemid from #tempabc)
and a.itemid=b.itemid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.gen_report1
-- --------------------------------------------------
CREATE proc [dbo].[gen_report1]                
(              
@emp_no  varchar(50),              
@option varchar(50),            
@frmdate varchar(20),            
@todate varchar(20)               
)                
as              
            
--Declare @option as varchar(50),@emp_no as varchar(50) ,@frmdate as varchar(50) ,@todate as varchar(50)      
      
--set @option = 'department'      
--set @emp_no='Software Development'      
--set @frmdate='2007-09-01'      
--set @todate='2007-09-30'      
            
if @option = 'EMP'              
BEGIN                
             
select itemid,sum(qty) as sum  into #tempabc from userrequest where emp_no=@emp_no          
and (reqstatuscode='0' or reqstatuscode='1' or reqstatuscode='2')              
and (reqdate>=@frmdate+' 00:00:00' and reqdate<=@todate+' 23:59:59')             
group by itemid              
          
--drop table #tempabc            
--select * from userrequest where emp_no='e05204' and (reqstatuscode='0' or reqstatuscode='1' or reqstatuscode='2')          
            
select b.itemid,a.sum,b.itemname from #tempabc a,inventoryitem b               
where b.itemid in(select itemid from #tempabc) and a.itemid=b.itemid order by a.itemid             
END              
      
        
if @option = 'department'   
  
if @emp_no='ALL'  
   
begin  
select itemid,sum(qty) as sum into #tempabc5 from userrequest       
where        
 (reqstatuscode='0' or reqstatuscode='1' or reqstatuscode='2')              
and (reqdate>=@frmdate+' 00:00:00' and reqdate<=@todate+' 23:59:59')         
 group by itemid        
        
select b.itemid,a.sum,b.itemname from #tempabc5 a,inventoryitem b               
where b.itemid in(select itemid from #tempabc5) and a.itemid=b.itemid order by a.itemid           
       
end  
  
else  
begin        
select a.itemid,sum(a.qty) as sum into #tempabc1 from userrequest a,hod_mapping b         
where a.hod_no=b.hod_no and b.department =@emp_no         
and (reqstatuscode='0' or reqstatuscode='1' or reqstatuscode='2')              
and (reqdate>=@frmdate+' 00:00:00' and reqdate<=@todate+' 23:59:59')         
 group by itemid        
        
select b.itemid,a.sum,b.itemname from #tempabc1 a,inventoryitem b               
where b.itemid in(select itemid from #tempabc1) and a.itemid=b.itemid order by a.itemid           
end        
    
if @option='item'    
if @emp_no='ALL'    
    
begin    
select itemid,sum(qty) as sum into #tempabc3 from userrequest     
where     
 (reqstatuscode='0' or reqstatuscode='1' or reqstatuscode='2')          
and (reqdate>=@frmdate+' 00:00:00' and reqdate<=@todate+' 23:59:59')     
 group by itemid    
--drop table #tempabc3    
--select * from #tempabc3    
--select * from userrequest    
select b.itemid,a.sum,b.itemname from #tempabc3 a,inventoryitem b               
where b.itemid in(select itemid from #tempabc3) and a.itemid=b.itemid order by a.itemid        
end    
ELSE    
    
BEGIN    
select itemid,sum(qty) as sum into #tempabc2 from userrequest     
where itemname=@emp_no    
and (reqstatuscode='0' or reqstatuscode='1' or reqstatuscode='2')          
and (reqdate>=@frmdate+' 00:00:00' and reqdate<=@todate+' 23:59:59')     
 group by itemid    
    
select b.itemid,a.sum,b.itemname from #tempabc2 a,inventoryitem b               
where b.itemid in(select itemid from #tempabc2) and a.itemid=b.itemid         
end    
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.generate_po
-- --------------------------------------------------

create proc [dbo].[generate_po]
@poID as varchar(50)
as
truncate table temptbl1
insert into temptbl1 
select sum(TotalQty), itemid from order_queue where orderid in (select orderid from purchase_order_queue where purchase_id=@poID) group by itemid
---select * from temptbl1

select * from  temptbl1 a
left outer join 
(select itemname,rate,vat,itemid from inventoryItem where itemid in (select itemid from temptbl1)) b
on a.itemid = b.itemid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.get_hodReqList
-- --------------------------------------------------

CREATE procedure [dbo].[get_hodReqList](@hod_no as varchar(25),@code as varchar(10), @code1 as varchar(10), @opt as varchar(10))          
as    
set transaction isolation level read uncommitted          
set nocount on          
  
--Declare   
--@hod_no as varchar(25),  
--@code as varchar(10),  
--@code1 as varchar(10)  
--set @hod_no ='E01089'  
--set @code = '2'  
--set @code1=''  
  
if @opt = 'HOD'  
begin  
select a.itemID,a.ItemNAme,a.CategoryName,a.Qty,b.ReqStatusName into #allReq     
from UserRequest a,ReqStatus b where hod_no = @hod_no and (a.ReqStatusCOde =@code or a.ReqStatusCOde =@code1)    
and a.ReqStatusCode = b.ReqStatusCode    
order by a.Itemname    
select distinct ItemID, Itemname,CategoryName,ReqStatusName into #DistWOQty from #allReq order by itemname    
    
--select * from #DistWOQty     
select itemName,sum(Qty) as 'Qty' into #DistWQty from #allReq group by itemName order by itemname   
--select * from #DistWQty    
    
select a.ItemID,a.Itemname,a.CategoryName,a.ReqStatusName,b.Qty from #DistWOQty a left outer join  #DistWQty  b     
on a.Itemname = b.ItemName    
    
end  
else  
begin  
select a.itemID,a.ItemNAme,a.CategoryName,a.Qty,b.ReqStatusName into #allReq1     
from UserRequest a,ReqStatus b where a.hod_no=(select hod_no from hod_mapping where pi_no =@hod_no) and (a.ReqStatusCOde =@code or a.ReqStatusCOde =@code1)    
and a.ReqStatusCode = b.ReqStatusCode    
order by a.Itemname    
select distinct ItemID, Itemname,CategoryName,ReqStatusName into #DistWOQty1 from #allReq1 order by itemname    
    
--select * from #DistWOQty     
select itemName,sum(Qty) as 'Qty' into #DistWQty1 from #allReq1 group by itemName order by itemname   
--select * from #DistWQty    
    
select a.ItemID,a.Itemname,a.CategoryName,a.ReqStatusName,b.Qty from #DistWOQty1 a left outer join  #DistWQty1  b     
on a.Itemname = b.ItemName    
    
end  
    
    
  
--drop table #allreq    
--drop table #DistWOQty    
--drop table #DistWQty    
--select * from #allReq    
    
set nocount off      
  return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getEmpStatus
-- --------------------------------------------------
CREATE procedure [dbo].[getEmpStatus]      
(      
 @EMP_No varchar(20)      
)      
as       
begin      
 --exec getEmpStatus 'CNTADHRE001'      
 --exec [getEmpStatus] 'et001'      
 --exec getEmpStatus 'ETA002'      
 --exec getEmpStatus 'ca'      
 --declare @isAdmin varchar(10)      
 --declare @isDealer varchar(10)      
     
 declare @@EMP_No varchar(20)    
 set @@EMP_No=@EMP_No    
     
 declare @@last_login datetime    
     
 set @@last_login=(select max(logDatetime)  from tbl_AppLog with(nolock) where usercode=@@EMP_No)    
      
 select       
 UserCode=HarmonyEmployeeCode,      
 StatsId=MimansaStatusid,      
 status_name=MimansaStatusName,      
 isTurnover,      
 IsBrokerage,     
 BOUserName,    
 last_login=isnull(convert(varchar,@@last_login,106)+ ' ' +  left(convert(varchar,@@last_login,108),5),'Welcome To B2B Crms')    
 --isAdmin,       
 --isDealer      
 from     
 angelusers a with(nolock) inner join b2b_angelharmony b with(nolock) on a.HarmonyEmployeeCode=b.Emp_No     
 where HarmonyEmployeeCode= @@EMP_No      
       
 if exists(select sb_tag from b2b_crms_mimansa_status(@@EMP_No))
 begin
 select sb_tag from b2b_crms_mimansa_status(@@EMP_No)
 end
 else
 begin
 select sb_tag from b2b_angelharmony where emp_no=@EMP_No
 end
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getEmpStatus_BKP14Oct2014
-- --------------------------------------------------
CREATE procedure [dbo].[getEmpStatus_BKP14Oct2014]      
(      
 @EMP_No varchar(20)      
)      
as       
begin      
 --exec getEmpStatus 'CNTADHRE001'      
 --exec [getEmpStatus] 'et001'      
 --exec getEmpStatus 'ETA002'      
 --exec getEmpStatus 'ca'      
 --declare @isAdmin varchar(10)      
 --declare @isDealer varchar(10)      
     
 declare @@EMP_No varchar(20)    
 set @@EMP_No=@EMP_No    
     
 declare @@last_login datetime    
     
 set @@last_login=(select max(logDatetime)  from tbl_AppLog with(nolock) where usercode=@@EMP_No)    
      
 select       
 UserCode=HarmonyEmployeeCode,      
 StatsId=MimansaStatusid,      
 status_name=MimansaStatusName,      
 isTurnover,      
 IsBrokerage,     
 BOUserName,    
 last_login=isnull(convert(varchar,@@last_login,106)+ ' ' +  left(convert(varchar,@@last_login,108),5),'Welocome To B2B Crms')    
 --isAdmin,       
 --isDealer      
 from     
 angelusers a with(nolock) inner join b2b_angelharmony b with(nolock) on a.HarmonyEmployeeCode=b.Emp_No     
 where HarmonyEmployeeCode= @@EMP_No      
       
 if exists(select sb_tag from b2b_crms_mimansa_status(@@EMP_No))
 begin
 select sb_tag from b2b_crms_mimansa_status(@@EMP_No)
 end
 else
 begin
 select sb_tag from b2b_angelharmony where emp_no=@EMP_No
 end
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.HodmodifyNVIRequest
-- --------------------------------------------------

CREATE procedure [dbo].[HodmodifyNVIRequest]  
(  
@ModID nvarchar(15),  
@Pi_No nvarchar(15),  
@ReqID nvarchar(15),  
@ItemID varchar(20),  
@ItemName varchar(100),  
@UserNote varchar(100),  
@HodNote varchar(100),  
@ModBy varchar(10),  
@ModDate datetime,--varchar(50),  
@Note varchar(100),  
@CompleteByDate varchar(25),  
@qty int,  
@stat varchar(4),  
@modtype int,  
@ordID varchar(50)  
)  
as  
  
update UserRequest set ItemID = @ItemID, ItemName = @ItemName, UserNote = @UserNote, HodNote=@HodNote,Qty=@qty,CompleteByDate = @CompleteByDate, Pi_No = @Pi_No,ReqStatusCode = @stat,orderID=@ordID where ReqID = @ReqID  
  
insert into ModifiedRequest values (@ModID,@ReqID,@ItemID,@ItemName,@qty,@Note,@ModBy,@ModDate,@CompleteByDate,@stat,@modtype)  
  
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mimansa_Transfer_table
-- --------------------------------------------------




CREATE procedure mimansa_Transfer_table  

as  

begin  



/**************TABLE_DATE******************/

	truncate table TABLE_DATE  

	--  

	insert into TABLE_DATE 

	select * from [MIMANSA].crm.dbo.TABLE_DATE with(nolock)  

	--

  

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.modifyOrderQueue
-- --------------------------------------------------

create procedure [dbo].[modifyOrderQueue]
(
@ordid varchar(50),
@hodid varchar(25),
@itemid varchar(50),
@initQty float,
@newQty float
)
as

Declare @totalQty float, @stock float

select @totalQty = TotalQty from Order_queue where hod_no = @hodid and itemid = @itemid

--set @totalQty = select TotalQty from Order_queue where hod_no = @hodid and itemid = @itemid
select @stock = StockQty from Order_Queue where hod_no = @hodid and itemid = @itemid

set @totalQty = (@totalQty - @initQty) + @newQty 

if(@totalQty<0)
begin
 set @stock = @stock + @totalQty
 set @totalqty = 0
end 

update Order_Queue set TotalQty = @totalQty, StockQty = @stock where hod_no = @hodid and itemid = @itemid
--update Order_Queue set TotalQty = (TotalQty - @initQty) + @newQty where hod_no = @hodid and itemid = @itemid
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.po_status_update
-- --------------------------------------------------

create proc [dbo].[po_status_update]  
(  
@poID varchar(10),  
@status varchar(10),
@REQID VARCHAR(20),
@option varchar(20)
)  
as 
if @option  ='POGEN'
BEGIN
update purchase_order_queue set status=@status where purchase_id=@poID  

update order_queue set status=@status where orderID   
in (select orderID from purchase_order_queue where purchase_id =@poID)  
  
update userrequest set reqstatuscode=@status where orderID   
in (select orderID from purchase_order_queue where purchase_id =@poID)  
END

IF @OPTION ='USRDELI'
BEGIN
update userrequest set reqstatuscode=@STATUS where ReqID=@REQID

update purchase_order_queue  set status=@STATUS where orderID in 
(select orderID from userrequest where reqid=@REQID)

update order_queue set status=@STATUS where orderID in
(select orderID from userrequest where reqid=@REQID)

END
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_AssignDefault_RoleCapability
-- --------------------------------------------------
/*    
 Created By : Vikram Ukani    
 Creted On :  14 Mar 2012    
 Desc : To Assign Default Rols-capabilities when New employee is registrer in System
 Exec   prc_AssignDefault_RoleCapability  'Test1','Default','196.1.115.237'
     
*/    


CREATE proc [dbo].[prc_AssignDefault_RoleCapability]
@EmpCode varchar(10),@userId varchar(25),@ip varchar(20)
as
declare @CurrentRwid int,@MinRwid int,@MaxRwid int
declare @roleId int,@CapabilityId int
begin
	
	/*********Role**********/
			select row_number() over(order by pid_tbl_Role_mst) rwid,pid_tbl_Role_mst Pid_Role into #temp_Role 
			from tbl_Role_master where isDefaultSelected=1
			
			select @minRwid=min(rwid),@maxRwid=max(rwid) from #temp_Role
			set @CurrentRwId=@minRwid
			
			delete from tbl_Emp_role where emp_no=@EmpCode
			
			while(@currentRwid<=@maxRwId)
			begin
				select @RoleId=Pid_Role from #temp_Role where rwid=@CurrentRwId
				print @RoleId
				exec spx_AssignRoleToEmployee @RoleId,@EmpCode,@UserId,@Ip
				set @CurrentRwId=@CurrentRwId+1	  
			end

	
	/*********Capability**********/
			select row_number() over(order by pid_tbl_Capability_mst) rwid,pid_tbl_Capability_mst Pid_Capability into #temp_Capability
			from tbl_Capability_master where isDefaultSelected=1
			
			select @minRwid=min(rwid),@maxRwid=max(rwid) from #temp_Capability
			set @CurrentRwId=@minRwid
			
			delete from tbl_Emp_capability where emp_no=@EmpCode
			
			while(@currentRwid<=@maxRwId)
			begin
				select @CapabilityId =Pid_Capability from #temp_Capability where rwid=@CurrentRwId
				print @CapabilityId 
				exec spx_AssignCapabilityToEmployee @CapabilityId ,@EmpCode,@UserId,@Ip
				set @CurrentRwId=@CurrentRwId+1	  
			end

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_AssignRemove_Default_RoleCapability_AllEmp
-- --------------------------------------------------
/*

	created By : Vikram Ukani
	Created On : 16 March 2012
	Desc : When new role_capability is created with default flag or any 
	change in delat Role_capability is made then update in table
	Exec prc_AssignNew_Default_RoleCapability_AllEmp 5,6,'SqlUser','196.1.115.141'


*/

CREATE proc [dbo].[prc_AssignRemove_Default_RoleCapability_AllEmp]
@RoleId int =null,@CapabilityId int =null,
@userId varchar(20),@ip varchar(20),
@RemoveDefault bit

as
declare @CurrentRwid int,@MinRwid int,@MaxRwid int
declare @EmpNo Varchar(20)

begin
	set nocount on
		
	select row_number() over(order by Sb_tag,Emp_No) rwid,Emp_no into #temp_Emp 
	from tbl_Emp_master (nolock)
	
	select @minRwid=min(rwid),@maxRwid=max(rwid) from #temp_Emp
	set @CurrentRwId=@minRwid

	if(isnull(@RoleId,0)!=0)
	begin
		delete from tbl_Emp_Role  where	fkid_tbl_Role_mst =@RoleId
		
		if(isnull(@removeDefault,0)=0)
		begin 
			insert into tbl_Emp_Role (Emp_No,Fkid_tbl_role_mst,User_Id,IP,Created_date)
			select emp_no,@roleId,@userId,@ip,getdate() from tbl_emp_master (nolock)
		end
	end
	
	if(isnull(@CapabilityId,0)!=0)
	begin
		delete from tbl_Emp_Capability  where fkid_tbl_Capability_mst =@CapabilityId
		if(isnull(@removeDefault,0)=0)
		begin
	
			insert into tbl_Emp_Capability (Emp_No,Fkid_tbl_Capability_mst,User_Id,IP,Created_date)
			select emp_no,@capabilityId,@userId,@ip,getdate()  from tbl_emp_master (nolock)
		end
	end
		
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_BindEmpList
-- --------------------------------------------------
CREATE proc [dbo].[prc_BindEmpList]      
@SubBrokerTag varchar(10)      
      
as      
      
begin      
      
 select Emp_No+':'+Emp_Name as TextField,Emp_No as ValueField  from vw_ActiveNonAdmin_employee_master mst1 where sb_tag=@SubBrokerTag    
  or exists (select sb_tag from  vw_ParentChildTagMapping v1 (nolock) where v1.parentTag =@SubBrokerTag and mst1.sb_tag=v1.sb_tag )      
       
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_BindIncrementMis
-- --------------------------------------------------
/*      
 Created By : Vikram Ukani      
 Creted On :  13 Mar 2012      
 Desc : To Bind Increment MIS      
 Exec prc_BindIncrementMis 'ET'      
       
*/      
    
    
CREATE proc [dbo].[prc_BindIncrementMis]    
@SubBrokerTag varchar(20)    
as    
begin    
    
 create table #temp_OutPut(id Int identity,Emp_no varchar(20),Emp_Name varchar(200),Old_Salary decimal(18,2)    
         ,New_Salary decimal(18,2),Dt_Effective varchar(11),Dt_Updation varchar(11))    
     
     
 insert into #temp_OutPut    
 select t1.Emp_no,Emp_Name, Old_Salary ,New_Salary,convert(varchar(11),Dt_Effective,106) Dt_Effective    
 , convert(varchar(11),t1.Dt_Updation,106) Dt_Updation     
 from tbl_Emp_Salary_Increment t1 (nolock)      
 inner join tbl_emp_master mst1  on mst1.emp_no=t1.emp_no    
 where sb_tag=@SubBrokerTag  
 or exists (select sb_tag from  vw_ParentChildTagMapping v1 (nolock) where v1.parentTag =@SubBrokerTag and mst1.sb_tag=v1.sb_tag )         
     
     
     
 /*from log table - history records*/    
 insert into #temp_OutPut    
 select t1.Emp_no,Emp_Name, Old_Salary ,New_Salary,convert(varchar(11),Dt_Effective,106) Dt_Effective    
 , convert(varchar(11),t1.Dt_Updation,106) Dt_Updation     
 from log_Emp_Salary_Increment t1 (nolock)      
 inner join tbl_emp_master mst1  on mst1.emp_no=t1.emp_no    
 where sb_tag=@SubBrokerTag  
 or exists (select sb_tag from  vw_ParentChildTagMapping v1 (nolock) where v1.parentTag =@SubBrokerTag and mst1.sb_tag=v1.sb_tag )         
     
   select id [Sr_No], Emp_no ,Emp_Name ,Old_Salary ,New_Salary ,Dt_Effective ,Dt_Updation     
   from #temp_OutPut order by id,dt_updation desc,emp_no   
     
 --select Row_number() over (order by dt_updation desc ) [Sr_No], Emp_no ,Emp_Name ,Old_Salary ,New_Salary ,Dt_Effective ,Dt_Updation     
 --  from #temp_OutPut order by dt_updation desc,emp_no     
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_BindMenu_MiniHarmony
-- --------------------------------------------------
/*
	Created By : Vikram Ukani
	Created On : 05 Mar 2012
	Desc : To Bind Menu's 
	Exec prc_BindMenu_MiniHarmony @isadmin=0
*/
  
  
  
CREATE PROCEDURE [dbo].[prc_BindMenu_MiniHarmony]    
@parentId int = NULL,  
@isadmin varchar(10)  
AS    
BEGIN    
 SET NOCOUNT on     
     
 IF @parentId IS NULL    
 BEGIN    
  SELECT tm.MenuID, tm.Text, tm.ParentID, tm.Description, tm.URL, tm.M_order,  
         isnull(tm.URL_Internet,'')URL_Internet, isnull(tm.URL_Intranet,'')URL_Intranet,   
         tm.IsAdmin, tm.IsChild  
  FROM tbl_menu_master tm    
  WHERE tm.ParentID IS null    
  AND isnull(tm.Is_delete,0)=0  
  AND (isnull(tm.IsAdmin,0)=0 OR isnull(tm.IsAdmin,0)=CONVERT(bit,@isadmin))  
  ORDER BY isnull(tm.M_order,100)  
 END    
 ELSE      
 BEGIN    
  SELECT * FROM tbl_menu_master tm    
  WHERE tm.ParentID=@parentId  
  AND isnull(tm.Is_delete,0)=0  
  AND (isnull(tm.IsAdmin,0)=0 OR isnull(tm.IsAdmin,0)=CONVERT(bit,@isadmin))  
  ORDER BY isnull(tm.M_order,100)  
 END    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_BindRole_CapabilityMaster
-- --------------------------------------------------
/*  
 Created By : Vikram Ukani  
 Creted On :  03 Mar 2012  
 Desc : To Bind Records from Role or Capability master Table  
 Exec : exec prc_BindRole_CapabilityMaster 0  
   
*/    
  
CREATE proc [dbo].[prc_BindRole_CapabilityMaster]  
@isRole_Capability int   
as  
begin  
  
 if(isnull(@isRole_Capability,0)=1)  
	  select pid_tbl_Role_mst pid,Role_Name,Role_Desc,isnull(isDefaultSelected,0) selected 
	  from tbl_Role_Master order by pid_tbl_Role_mst  
	  
 else if(isnull(@isRole_Capability,0)=2)  
	  select pid_tbl_Capability_mst pid,Capability_Name,Capability_Desc ,isnull(isDefaultSelected,0) selected 
	  from tbl_Capability_Master order by pid_tbl_Capability_mst  
	    
else  
begin  
  select pid_tbl_Role_mst pid,Role_Name,Role_Desc,isnull(isDefaultSelected,0) selected 
  from tbl_Role_Master order by pid_tbl_Role_mst    
  select pid_tbl_Capability_mst pid,Capability_Name,Capability_Desc,isnull(isDefaultSelected,0) selected 
  from tbl_Capability_Master order by pid_tbl_Capability_mst  
end  
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_CaptureUserLoginDetails
-- --------------------------------------------------

/*
	Created by : Vikram Ukani
	Created on : 27 Apr 2012 
	Last Updated : 27 Apr 2012
	Desc : To capture login details of all the employees/users.
	Exec prc_CaptureUserLoginDetails 'ETA001','196.1.115.137'
*/

CREATE proc prc_CaptureUserLoginDetails
	@Emp_No varchar(10),@ipAdd varchar(20) 
as

begin
	
	insert into tbl_UserLoginDetails (emp_no,ipAdd,LoginDatetime) select @Emp_No ,@ipAdd,getdate()
	 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_ChangePassword
-- --------------------------------------------------
  
/*    
 Created By : Vikram Ukani    
 Created On : 17Apr 2012    
 Last Updated On : 17Apr 2012    
 Desc : To change password. first it will match oldpassword and if it is verified than it will change password    
 Exec prc_ChangePassword 'PAP002','PAP00','ChangePasswordTest'    
*/    
    
    
CREATE proc [dbo].[prc_ChangePassword]      
@UseriD as varchar(25),@OldPassword as varchar(50),@NewPassword as varchar(50)      
as      
declare @flag_OldPassword as bit      
declare @msg varchar(1000)    
begin      
      
 select @flag_OldPassword=case when [password]=@OldPassword then 1 else 0 end from tbl_emp_master where emp_no=@UseriD    
     
 if(isnull(@flag_OldPassword,0)=1)    
 begin    
      
  insert into log_emp_master (Emp_No,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,  
         Address2,City,State,Pincode,Mobile,Email,Dt_ActiveFrom,isSuspended,isTerminated,  
         Salary,User_ID,Password,Dt_Updation,IP,Created_date,Log_UpdationDate,LandLine  
         )   
  select Emp_No,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,  
         Address2,City,State,Pincode,Mobile,Email,Dt_ActiveFrom,isSuspended,isTerminated,  
      Salary,User_ID,Password,Dt_Updation,IP,Created_date,getdate(),LandLine   
  from tbl_emp_master where Emp_no=@UseriD      
      
  update tbl_emp_master set password=@NewPassword,dt_updation=getdate() where Emp_no=@UseriD      
  set @msg='Your password has been changed sucessfully...'    
 end    
     
 else    
     
 begin    
  set @msg='Old password is invalid...'    
 end     
       
   select @msg    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_CheckRole_Capability_AlreadyExists
-- --------------------------------------------------
/*        
 Created By : Vikram Ukani        
 Creted On :  16 Mar 2012        
 Updated By : Vikram Ukani   
 Last Ukdated On : 16 march 2012      
  
 Desc : To Check wether name aleredy exist in maSTER table      
 Exec prc_CheckRole_Capability_AlreadyExists 'Turnover',2,0  
         
*/     
  
  
CREATE proc [dbo].[prc_CheckRole_Capability_AlreadyExists]  
@Role_Capability_Name VARCHAR(200),@flgType int,@pid int  
as  
  
declare @cnt INT   
begin  
  
  
 if(@flgType=1)  
 begin  
  select @cnt=count(*) from tbl_role_master where role_name=@Role_Capability_Name and pid_tbl_role_mst!=@pid  
 end  
    
  else  
  begin  
  select @cnt=count(*) from tbl_capability_master where capability_name=@Role_Capability_Name and pid_tbl_capability_mst!=@pid  
     end  
       
     select isnull(@cnt,0)  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_CreateUpdate_SbAdminEmployee_DailyProcess
-- --------------------------------------------------
  
  
/*          
  
 Created By : Vikram Ukani          
  
 Creted On :  14 Mar 2012          
  
 Desc : To Create Admin Employees (by default) of new genetared sub brokers and update details of existing sub brokers     
  
  if there is any change in respective details           
  
 Exec prc_CreateUpdate_SbAdminEmployee_DailyProcess        
  
           
  
*/     
  
    
  
CREATE proc [dbo].[prc_CreateUpdate_SbAdminEmployee_DailyProcess]    
  
as    
  
begin    
  
    
  
 /*****************Take all details of all sub brokers from middelware**************/    
  
     
  
 select distinct row_number() over (order by sub_broker) pid, ltrim(rtrim(Sub_Broker)) sub_broker,  
  
 ltrim(rtrim(Sub_Broker))+'001' Emp_No,Name,Address1,Address2,City,State,Zip,    
  
 Sub_BrokerMobileno,Email,TagGenDate,0 isSuspended,0 isTerminated,0 Salary,  
  
 ltrim(rtrim(Sub_Broker))+'001' User_ID,ltrim(rtrim(Sub_Broker))+'001' Password,1 isAdmin,   
  
 '196.1.115.141' IP,getdate() Created_date,phone1 as LandLine     
  
 --into #temp_SbMaster  from [196.1.115.239].[AngelBI_Staging].[dbo].[ANGELSUBBROKERS]  with(nolock)  
  
 into #temp_SbMaster  from [MIMANSA].[angelcs].[dbo].[ANGELSUBBROKERS]  with(nolock)  
  
 where isnull(Sub_Broker,'')!='' and isnull(Sub_Broker,'') not like ' %'     
  
  
  
 -- select distinct row_number() over (order by SBTAG) pid, ltrim(rtrim(SBTAG)) sub_broker    
  
 -- ,ltrim(rtrim(SBTAG))+'001' Emp_No,CONTACTPERSON as Name,TerAddline1 as Address1,TerAddline2 as Address2,TerCity as city,TerState as State  
  
 -- ,TerPinCode as Zip,    
  
 -- TerMobNo as Sub_BrokerMobileno,TerEmailId as Email,TAGGeneratedDate as TagGenDate,0 isSuspended,0 isTerminated,0 Salary    
  
 -- ,ltrim(rtrim(SBTAG))+'001' User_ID,ltrim(rtrim(SBTAG))+'001' Password,1 isAdmin, '196.1.115.141' IP,getdate() Created_date,TerTelephone as LandLine   
  
 --into #temp_SbMaster    
  
 --  from [196.1.115.239].Mimansa.[dbo].[SB_Adddata]  
  
 -- where isnull(SBTAG,'')!='' and isnull(SBTAG,'') not like ' %'        
  
     
  
 /*****************delete duplicate records if exists**************/    
  
     
  
 select Emp_No,min(pid) pid into #temp_Duplicaterecord   
  
 from #temp_SbMaster group by Emp_No having count(Emp_No)>1       
  
  
  
 -------------select * from #temp_SbMaster   where Emp_No in (select Emp_No from #temp_Duplicaterecord)    
  
    
  
 delete from  #temp_SbMaster    
  
 where pid in (select pid from #temp_Duplicaterecord)    
  
     
  
 /*****************find new sub brokers and create Admin employees for them**************/      
  
     
  
 select * into #temp_NewSb from #temp_SbMaster t1     
  
 where not exists (select sb_tag from tbl_emp_master mst1 (nolock)   
  
      where mst1.sb_tag=t1.sub_broker and mst1.isadmin=1 )       
  
     
  
 insert into tbl_emp_master (Sb_Tag,Emp_No,Emp_Name,Address1,Address2,City,State,Pincode,Mobile    
  
 ,Email,Dt_ActiveFrom,isSuspended,isTerminated,Salary,User_ID,Password    
  
 ,isAdmin,IP,Created_date)    
  
 select Sub_Broker,Emp_No,Name,'-'Address1,'-'Address2,City,State,Zip,'-'Sub_BrokerMobileno,'-'Email,    
  
 TagGenDate,isSuspended,isTerminated,Salary,User_ID,Password,isAdmin,IP,Created_date    
  
 from #temp_NewSb --where pid between @pids and @pide    
  
  
  
 /*Assign default all roles to new created SB Admin employees.*/   
  
 insert into tbl_emp_role  
  
 select emp_no,pid_tbl_Role_mst,'SqlAdmin',null,'196.1.115.132',getdate(),null from #temp_NewSb,tbl_role_master  
  
  
  
 /*Assign default all capabilities to new created SB Admin employees.*/   
  
  
  
 insert into tbl_emp_capability  
  
 select emp_no,pid_tbl_Capability_mst,'SqlAdmin',null,'196.1.115.132',getdate()   
  
 from #temp_NewSb,tbl_capability_master     
  
      
  
 -------------select * from #temp_NewSb    
  
     
  
 /*****************Update existing details of  sub brokers if there is any change in it**************/      
  
      
  
 update tbl_emp_master set  Emp_Name=Name,City=t1.City,State=t1.state    
  
 ,Pincode=t1.Zip,dt_updation=getdate()   
  
 from tbl_emp_master mst1,#temp_SbMaster t1    
  
 where mst1.emp_no =(mst1.sb_tag+'001') and mst1.isadmin=1 and mst1.sb_tag=t1.sub_broker    
  
 and (Emp_Name!=t1.Name   or Mst1.Address1!=t1.Address1   or Mst1.Address2!=t1.Address2    
  
 or Mst1.City!=t1.City  or Mst1.State!=t1.State or Mst1.Pincode!=t1.Zip     
  
 or Mst1.Mobile!=t1.Sub_BrokerMobileno or Mst1.Email!=t1.Email or Mst1.LandLine!=t1.LandLine)    
  
      
  
 select * into #tempContactInfo from(  
  
 select sbtag,ltrim(rtrim(TerTelephone))landline from MIDDLEWARE.Mimansa.[dbo].[SB_Adddata]   
  
 where TerTelephone<>'' and sbtag<>'')a  
  
      
  
 update e set Landline_no=landline from tbl_SbContact_Detail e,#tempContactInfo s where e.Sb_Tag=s.SbTag  
  
  
  
end  
/*-https://angelbrokingpl.atlassian.net/browse/SRE-42152*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_CreateUpdate_SbAdminEmployee_DailyProcess_26Nov2025
-- --------------------------------------------------
  
  
/*          
  
 Created By : Vikram Ukani          
  
 Creted On :  14 Mar 2012          
  
 Desc : To Create Admin Employees (by default) of new genetared sub brokers and update details of existing sub brokers     
  
  if there is any change in respective details           
  
 Exec prc_CreateUpdate_SbAdminEmployee_DailyProcess        
  
           
  
*/     
  
    
  
CREATE proc [dbo].[prc_CreateUpdate_SbAdminEmployee_DailyProcess_26Nov2025]    
  
as    
  
begin    
  
    
  
 /*****************Take all details of all sub brokers from middelware**************/    
  
     
  
 select distinct row_number() over (order by sub_broker) pid, ltrim(rtrim(Sub_Broker)) sub_broker,  
  
 ltrim(rtrim(Sub_Broker))+'001' Emp_No,Name,Address1,Address2,City,State,Zip,    
  
 Sub_BrokerMobileno,Email,TagGenDate,0 isSuspended,0 isTerminated,0 Salary,  
  
 ltrim(rtrim(Sub_Broker))+'001' User_ID,ltrim(rtrim(Sub_Broker))+'001' Password,1 isAdmin,   
  
 '196.1.115.141' IP,getdate() Created_date,phone1 as LandLine     
  
 --into #temp_SbMaster  from [196.1.115.239].[AngelBI_Staging].[dbo].[ANGELSUBBROKERS]  with(nolock)  
  
 into #temp_SbMaster  from [MIMANSA].[angelcs].[dbo].[ANGELSUBBROKERS]  with(nolock)  
  
 where isnull(Sub_Broker,'')!='' and isnull(Sub_Broker,'') not like ' %'     
  
  
  
 -- select distinct row_number() over (order by SBTAG) pid, ltrim(rtrim(SBTAG)) sub_broker    
  
 -- ,ltrim(rtrim(SBTAG))+'001' Emp_No,CONTACTPERSON as Name,TerAddline1 as Address1,TerAddline2 as Address2,TerCity as city,TerState as State  
  
 -- ,TerPinCode as Zip,    
  
 -- TerMobNo as Sub_BrokerMobileno,TerEmailId as Email,TAGGeneratedDate as TagGenDate,0 isSuspended,0 isTerminated,0 Salary    
  
 -- ,ltrim(rtrim(SBTAG))+'001' User_ID,ltrim(rtrim(SBTAG))+'001' Password,1 isAdmin, '196.1.115.141' IP,getdate() Created_date,TerTelephone as LandLine   
  
 --into #temp_SbMaster    
  
 --  from [196.1.115.239].Mimansa.[dbo].[SB_Adddata]  
  
 -- where isnull(SBTAG,'')!='' and isnull(SBTAG,'') not like ' %'        
  
     
  
 /*****************delete duplicate records if exists**************/    
  
     
  
 select Emp_No,min(pid) pid into #temp_Duplicaterecord   
  
 from #temp_SbMaster group by Emp_No having count(Emp_No)>1       
  
  
  
 -------------select * from #temp_SbMaster   where Emp_No in (select Emp_No from #temp_Duplicaterecord)    
  
    
  
 delete from  #temp_SbMaster    
  
 where pid in (select pid from #temp_Duplicaterecord)    
  
     
  
 /*****************find new sub brokers and create Admin employees for them**************/      
  
     
  
 select * into #temp_NewSb from #temp_SbMaster t1     
  
 where not exists (select sb_tag from tbl_emp_master mst1 (nolock)   
  
      where mst1.sb_tag=t1.sub_broker and mst1.isadmin=1 )       
  
     
  
 insert into tbl_emp_master (Sb_Tag,Emp_No,Emp_Name,Address1,Address2,City,State,Pincode,Mobile    
  
 ,Email,Dt_ActiveFrom,isSuspended,isTerminated,Salary,User_ID,Password    
  
 ,isAdmin,IP,Created_date)    
  
 select Sub_Broker,Emp_No,Name,Address1,Address2,City,State,Zip,Sub_BrokerMobileno,Email,    
  
 TagGenDate,isSuspended,isTerminated,Salary,User_ID,Password,isAdmin,IP,Created_date    
  
 from #temp_NewSb --where pid between @pids and @pide    
  
  
  
 /*Assign default all roles to new created SB Admin employees.*/   
  
 insert into tbl_emp_role  
  
 select emp_no,pid_tbl_Role_mst,'SqlAdmin',null,'196.1.115.132',getdate(),null from #temp_NewSb,tbl_role_master  
  
  
  
 /*Assign default all capabilities to new created SB Admin employees.*/   
  
  
  
 insert into tbl_emp_capability  
  
 select emp_no,pid_tbl_Capability_mst,'SqlAdmin',null,'196.1.115.132',getdate()   
  
 from #temp_NewSb,tbl_capability_master     
  
      
  
 -------------select * from #temp_NewSb    
  
     
  
 /*****************Update existing details of  sub brokers if there is any change in it**************/      
  
      
  
 update tbl_emp_master set  Emp_Name=Name,Address1=t1.Address1,Address2=t1.Address2,City=t1.City,State=t1.state    
  
 ,Pincode=t1.Zip,Mobile=t1.Sub_BrokerMobileno,Email=t1.Email,dt_updation=getdate()   
  
 from tbl_emp_master mst1,#temp_SbMaster t1    
  
 where mst1.emp_no =(mst1.sb_tag+'001') and mst1.isadmin=1 and mst1.sb_tag=t1.sub_broker    
  
 and (Emp_Name!=t1.Name   or Mst1.Address1!=t1.Address1   or Mst1.Address2!=t1.Address2    
  
 or Mst1.City!=t1.City  or Mst1.State!=t1.State or Mst1.Pincode!=t1.Zip     
  
 or Mst1.Mobile!=t1.Sub_BrokerMobileno or Mst1.Email!=t1.Email or Mst1.LandLine!=t1.LandLine)    
  
      
  
 select * into #tempContactInfo from(  
  
 select sbtag,ltrim(rtrim(TerTelephone))landline from MIDDLEWARE.Mimansa.[dbo].[SB_Adddata]   
  
 where TerTelephone<>'' and sbtag<>'')a  
  
      
  
 update e set Landline_no=landline from tbl_SbContact_Detail e,#tempContactInfo s where e.Sb_Tag=s.SbTag  
  
  
  
end  
/*-https://angelbrokingpl.atlassian.net/browse/SRE-42152*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_CreateUpdate_SbAdminEmployee_DailyProcess_bkp15May2018
-- --------------------------------------------------
/*        
 Created By : Vikram Ukani        
 Creted On :  14 Mar 2012        
 Desc : To Create Admin Employees (by default) of new genetared sub brokers and update details of existing sub brokers   
  if there is any change in respective details         
 Exec prc_CreateUpdate_SbAdminEmployee_DailyProcess      
         
*/   
  
CREATE proc [dbo].[prc_CreateUpdate_SbAdminEmployee_DailyProcess_bkp15May2018]  
as  
begin  
  
 /*****************Take all details of all sub brokers from middelware**************/  
   
	select distinct row_number() over (order by sub_broker) pid, ltrim(rtrim(Sub_Broker)) sub_broker,
	ltrim(rtrim(Sub_Broker))+'001' Emp_No,Name,Address1,Address2,City,State,Zip,  
	Sub_BrokerMobileno,Email,TagGenDate,0 isSuspended,0 isTerminated,0 Salary,
	ltrim(rtrim(Sub_Broker))+'001' User_ID,ltrim(rtrim(Sub_Broker))+'001' Password,1 isAdmin, 
	'196.1.115.141' IP,getdate() Created_date,phone1 as LandLine   
	into #temp_SbMaster  from [196.1.115.239].[AngelBI_Staging].[dbo].[ANGELSUBBROKERS]  with(nolock)
	where isnull(Sub_Broker,'')!='' and isnull(Sub_Broker,'') not like ' %'   

-- select distinct row_number() over (order by SBTAG) pid, ltrim(rtrim(SBTAG)) sub_broker  
-- ,ltrim(rtrim(SBTAG))+'001' Emp_No,CONTACTPERSON as Name,TerAddline1 as Address1,TerAddline2 as Address2,TerCity as city,TerState as State
-- ,TerPinCode as Zip,  
-- TerMobNo as Sub_BrokerMobileno,TerEmailId as Email,TAGGeneratedDate as TagGenDate,0 isSuspended,0 isTerminated,0 Salary  
-- ,ltrim(rtrim(SBTAG))+'001' User_ID,ltrim(rtrim(SBTAG))+'001' Password,1 isAdmin, '196.1.115.141' IP,getdate() Created_date,TerTelephone as LandLine 
--into #temp_SbMaster  
--  from [196.1.115.239].Mimansa.[dbo].[SB_Adddata]
-- where isnull(SBTAG,'')!='' and isnull(SBTAG,'') not like ' %'      
   
 /*****************delete duplicate records if exists**************/  
   
 select Emp_No,min(pid) pid into #temp_Duplicaterecord from #temp_SbMaster group by Emp_No having count(Emp_No)>1     
 -------------select * from #temp_SbMaster   where Emp_No in (select Emp_No from #temp_Duplicaterecord)  
  
 delete from  #temp_SbMaster  where pid in (select pid from #temp_Duplicaterecord)  
   
 /*****************find new sub brokers and create Admin employees for them**************/    
   
 select * into #temp_NewSb from #temp_SbMaster t1   
 where not exists (select sb_tag from tbl_emp_master mst1 (nolock) where mst1.sb_tag=t1.sub_broker and mst1.isadmin=1 )     
   
 insert into tbl_emp_master (Sb_Tag,Emp_No,Emp_Name,Address1,Address2,City,State,Pincode,Mobile  
        ,Email,Dt_ActiveFrom,isSuspended,isTerminated,Salary,User_ID,Password  
        ,isAdmin,IP,Created_date)  
 select Sub_Broker,Emp_No,Name,Address1,Address2,City,State,Zip,Sub_BrokerMobileno,Email,  
   TagGenDate,isSuspended,isTerminated,Salary,User_ID,Password,isAdmin,IP,Created_date  
 from #temp_NewSb --where pid between @pids and @pide  

/*Assign default all roles to new created SB Admin employees.*/ 
insert into tbl_emp_role
select emp_no,pid_tbl_Role_mst,'SqlAdmin',null,'196.1.115.132',getdate(),null from #temp_NewSb,tbl_role_master

/*Assign default all capabilities to new created SB Admin employees.*/ 

insert into tbl_emp_capability
select emp_no,pid_tbl_Capability_mst,'SqlAdmin',null,'196.1.115.132',getdate() from #temp_NewSb,tbl_capability_master   
   
   
 -------------select * from #temp_NewSb  
   
 /*****************Update existing details of  sub brokers if there is any change in it**************/    
    
 update tbl_emp_master set  Emp_Name=Name,Address1=t1.Address1,Address2=t1.Address2,City=t1.City,State=t1.state  
         ,Pincode=t1.Zip,Mobile=t1.Sub_BrokerMobileno,Email=t1.Email,dt_updation=getdate() 
 from tbl_emp_master mst1,#temp_SbMaster t1  
 where mst1.emp_no =(mst1.sb_tag+'001') and mst1.isadmin=1 and mst1.sb_tag=t1.sub_broker  
 and (Emp_Name!=t1.Name   or Mst1.Address1!=t1.Address1   or Mst1.Address2!=t1.Address2  
      or Mst1.City!=t1.City  or Mst1.State!=t1.State or Mst1.Pincode!=t1.Zip   
   or Mst1.Mobile!=t1.Sub_BrokerMobileno or Mst1.Email!=t1.Email or Mst1.LandLine!=t1.LandLine)  
    
    select * into #tempContactInfo from(
    select sbtag,ltrim(rtrim(TerTelephone))landline from [196.1.115.239].Mimansa.[dbo].[SB_Adddata] where TerTelephone<>'' and sbtag<>'')a
    
    update e set Landline_no=landline from tbl_SbContact_Detail e,#tempContactInfo s where e.Sb_Tag=s.SbTag
    
    

    

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_CreateUpdate_SbAdminEmployee_DailyProcess_Test
-- --------------------------------------------------
/*        
 Created By : Vikram Ukani        
 Creted On :  14 Mar 2012        
 Desc : To Create Admin Employees (by default) of new genetared sub brokers and update details of existing sub brokers   
  if there is any change in respective details         
 Exec prc_CreateUpdate_SbAdminEmployee_DailyProcess      
         
*/   
  
CREATE Proc [dbo].[prc_CreateUpdate_SbAdminEmployee_DailyProcess_Test]  
as  
begin  
  
 /*****************Take all details of all sub brokers from middelware**************/  
   
 --select distinct row_number() over (order by sub_broker) pid, ltrim(rtrim(Sub_Broker)) sub_broker  
 --,ltrim(rtrim(Sub_Broker))+'001' Emp_No,Name,Address1,Address2,City,State,Zip,  
 --Sub_BrokerMobileno,Email,TagGenDate,0 isSuspended,0 isTerminated,0 Salary  
 --,ltrim(rtrim(Sub_Broker))+'001' User_ID,ltrim(rtrim(Sub_Broker))+'001' Password,1 isAdmin, '196.1.115.141' IP,getdate() Created_date  
 -- into #temp_SbMaster  from [196.1.115.239].[AngelBI_Staging].[dbo].[ANGELSUBBROKERS]  
 --where isnull(Sub_Broker,'')!='' and isnull(Sub_Broker,'') not like ' %'   

 select distinct row_number() over (order by SBTAG) pid, ltrim(rtrim(SBTAG)) sub_broker  
 ,ltrim(rtrim(SBTAG))+'001' Emp_No,CONTACTPERSON as Name,TerAddline1 as Address1,TerAddline2 as Address2,TerCity as city,TerState as State
 ,TerPinCode as Zip,  
 TerMobNo as Sub_BrokerMobileno,TerEmailId as Email,TAGGeneratedDate as TagGenDate,0 isSuspended,0 isTerminated,0 Salary  
 ,ltrim(rtrim(SBTAG))+'001' User_ID,ltrim(rtrim(SBTAG))+'001' Password,1 isAdmin, '196.1.115.141' IP,getdate() Created_date,TerTelephone as LandLine 
into #temp_SbMaster  
  from MIDDLEWARE.Mimansa.[dbo].[SB_Adddata]
 where isnull(SBTAG,'')!='' and isnull(SBTAG,'') not like ' %'      
   
 /*****************delete duplicate records if exists**************/  
   
 select Emp_No,min(pid) pid into #temp_Duplicaterecord from #temp_SbMaster group by Emp_No having count(Emp_No)>1     
 -------------select * from #temp_SbMaster   where Emp_No in (select Emp_No from #temp_Duplicaterecord)  
  
 delete from  #temp_SbMaster  where pid in (select pid from #temp_Duplicaterecord)  
   
 /*****************find new sub brokers and create Admin employees for them**************/    
   
 select * into #temp_NewSb from #temp_SbMaster t1   
 where not exists (select sb_tag from tbl_emp_master mst1 (nolock) where mst1.sb_tag=t1.sub_broker and mst1.isadmin=1 )     
   
 insert into tbl_emp_master (Sb_Tag,Emp_No,Emp_Name,Address1,Address2,City,State,Pincode,Mobile  
        ,Email,Dt_ActiveFrom,isSuspended,isTerminated,Salary,User_ID,Password  
        ,isAdmin,IP,Created_date,LandLine)  
 select Sub_Broker,Emp_No,Name,Address1,Address2,City,State,Zip,Sub_BrokerMobileno,Email,  
   TagGenDate,isSuspended,isTerminated,Salary,User_ID,Password,isAdmin,IP,Created_date,LandLine  
 from #temp_NewSb --where pid between @pids and @pide  

/*Assign default all roles to new created SB Admin employees.*/ 
insert into tbl_emp_role
select emp_no,pid_tbl_Role_mst,'SqlAdmin',null,'196.1.115.132',getdate(),null from #temp_NewSb,tbl_role_master

/*Assign default all capabilities to new created SB Admin employees.*/ 

insert into tbl_emp_capability
select emp_no,pid_tbl_Capability_mst,'SqlAdmin',null,'196.1.115.132',getdate() from #temp_NewSb,tbl_capability_master   
   
   
 -------------select * from #temp_NewSb  
   
 /*****************Update existing details of  sub brokers if there is any change in it**************/    
    
 update tbl_emp_master set  Emp_Name=Name,Address1=t1.Address1,Address2=t1.Address2,City=t1.City,State=t1.state  
         ,Pincode=t1.Zip,Mobile=t1.Sub_BrokerMobileno,Email=t1.Email,dt_updation=getdate(),LandLine=t1.LandLine  
 from tbl_emp_master mst1,#temp_SbMaster t1  
 where mst1.emp_no =(mst1.sb_tag+'001') and mst1.isadmin=1 and mst1.sb_tag=t1.sub_broker  
 and (Emp_Name!=t1.Name   or Mst1.Address1!=t1.Address1   or Mst1.Address2!=t1.Address2  
      or Mst1.City!=t1.City  or Mst1.State!=t1.State or Mst1.Pincode!=t1.Zip   
   or Mst1.Mobile!=t1.Sub_BrokerMobileno or Mst1.Email!=t1.Email or Mst1.LandLine!=t1.LandLine)  
     
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_DeleteCapability
-- --------------------------------------------------
/*      
 Created By : Vikram Ukani      
 Creted On :  16 Mar 2012      
 Updated By : Vikram Ukani 
 Last Ukdated On : 16 march 2012    

 Desc : To Delete Records in Capability master Table      
 Exec : Prc_DeleteCapability 2, 'Admin','0.0.0.0'      
       
*/        
CREATE PROCEDURE [dbo].[Prc_DeleteCapability]        

 @pid int=0,      
 @User_id varchar(20),        
 @ip varchar(20)    
as     
begin

	insert into log_Capability_master (pid_tbl_Capability_mst,Capability_Desc,User_Id,Dt_Updation,IP,Created_date,Capability_Name,Log_UpdationDate
							     ,isDefaultselected)
	select pid_tbl_Capability_mst,Capability_Desc,@User_id,Dt_Updation,@ip,Created_date,Capability_Name,getdate() ,isDefaultselected
	from tbl_capability_master where pid_tbl_Capability_mst=@pid
	
	delete from tbl_Capability_master where pid_tbl_Capability_mst=@pid
	delete from tbl_emp_Capability where Fkid_tbl_Capability_mst=@pid

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_DeleteRole
-- --------------------------------------------------
/*      
 Created By : Vikram Ukani      
 Creted On :  16 Mar 2012      
 Updated By : Vikram Ukani 
 Last Ukdated On : 16 march 2012    

 Desc : To Delete Records in Capability master Table      
 Exec : Prc_DeleteRole 2,'Admin','0.0.0.0'      
       
*/        

CREATE PROCEDURE [dbo].[Prc_DeleteRole]        

 @pid int=0,      
 @User_id varchar(20),        
 @ip varchar(20)    
as     
begin

	insert into log_role_master (pid_tbl_Role_mst,Role_Desc,User_Id,Dt_Updation,IP,Created_date,Role_Name,Log_UpdationDate
							     ,isDefaultselected,ApplyRule_ClientMaping_Suspension)
	select pid_tbl_Role_mst,Role_Desc,@User_id,Dt_Updation,@ip,Created_date,Role_Name,getdate() ,isDefaultselected,ApplyRule_ClientMaping_Suspension
	from tbl_role_master where pid_tbl_Role_mst=@pid
	
	delete from tbl_role_master where pid_tbl_Role_mst=@pid
	delete from tbl_emp_role where Fkid_tbl_Role_mst=@pid

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_Dump_tbl_EmployeeView_DailyProcess
-- --------------------------------------------------
/*
	Created By : Vikram Ukani
	Created On : 19th Mar 2012
	Desc : To use dump data for employee with specifying employee is dealer or not 
	and does he have capabilities of  turnover and brokerage
	
	Exec prc_Dump_tbl_EmployeeView_DailyProcess

*/

CREATE proc [dbo].[prc_Dump_tbl_EmployeeView_DailyProcess]
as
declare @DealerPid int,@TurnOverPid int,@BrokeragePid int 
begin

	truncate table tbl_EmployeeView
	insert into tbl_EmployeeView (sb_tag,emp_no) select sb_tag,emp_no from tbl_emp_master (nolock)
	
	
	select @DealerPid=pid_tbl_role_mst from tbl_role_master where role_name ='Dealer'
	
	select @TurnOverPid=pid_tbl_capability_mst from tbl_capability_master where capability_name ='Turnover'
	
	select @BrokeragePid=pid_tbl_capability_mst from  tbl_capability_master where Capability_name ='Brokerage'
	
	
	update 	tbl_EmployeeView set isDealer=1 from tbl_EmployeeView t1,tbl_emp_role t2
	where t1.emp_no=t2.emp_no and t2.fkid_tbl_role_mst =@DealerPId
	
	update 	tbl_EmployeeView set isTurnOver=1 from tbl_EmployeeView t1,tbl_emp_capability t2
	where t1.emp_no=t2.emp_no and t2.fkid_tbl_capability_mst =@TurnOverPid
	
	update 	tbl_EmployeeView set isBrokerage=1 from tbl_EmployeeView t1,tbl_emp_capability t2
	where t1.emp_no=t2.emp_no and t2.fkid_tbl_capability_mst =@BrokeragePid


end

--select * from tbl_EmployeeView

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_GenerateSystemPassword
-- --------------------------------------------------
/*
	Created By : Vikram Uknai
	Created On : 20th Mar 2012
	Desc: To generated system password(random password)
	

*/


create proc [dbo].[prc_GenerateSystemPassword]
@alpha_numeric VARCHAR(8) out
as
begin

	SET @alpha_numeric=''

	SELECT @alpha_numeric=@alpha_numeric+CHAR(n) FROM(            
	SELECT TOP 8 number AS n FROM master..spt_values            
	WHERE TYPE='p' and (number between 48 and 57 or number between 65 and 90)            
	ORDER BY NEWID()) AS t   

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_GetCurrentSalary
-- --------------------------------------------------
/*  
 Created By : Vikram Ukani  
 Creted On :  03 Mar 2012  
 Desc : To Bind Dropdown of EmpList  
 Exec prc_GetCurrentSalary 'Test001'  
   
*/  
  
CREATE proc [dbo].[prc_GetCurrentSalary]  
@EmpNo varchar(10)  
  
as  
  
begin  
  
 select salary  as OldSal from tbl_emp_Master where emp_no=@Empno  
   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_GetLatIncrementDetails
-- --------------------------------------------------
/*  
 Created By : Vikram Ukani  
 Creted On :  03 Mar 2012  
 Desc : To Bind Dropdown of EmpList  
 Exec prc_GetLatIncrementDetails 'Test001'  
   
*/  
  
CREATE proc [dbo].[prc_GetLatIncrementDetails] 
@EmpNo varchar(10)  
  
as  
  
begin  
  
	select salary as CurrentSal, Old_Salary as OldSal,New_Salary LastIncrementedSal ,Dt_Effective LastEffectiveDate ,t1.Dt_Updation LastUpdatedOn
    from tbl_emp_Master mst1 left outer join  tbl_Emp_Salary_Increment t1
    on mst1.emp_no=t1.emp_no
    where mst1.emp_no=@Empno  
   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_getSubBrokerWithChildTags
-- --------------------------------------------------
/*      
 Created By : Vikram Ukani      
 Creted On :  13 Mar 2012      
 Desc : To Bind Increment MIS      
 Exec prc_getSubBrokerWithChildTags 'AFPr'      
       
*/      
    
CREATE proc [dbo].[prc_getSubBrokerWithChildTags]    
@ParentTag varchar(20)    
as    
    
begin    
 select sb_tag TextField,sb_tag ValueField from vw_ParentChildTagMapping (nolock) where 
 parenttag=@ParentTag or sb_tag=@ParentTag order by sb_tag    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_InsDealerMapping
-- --------------------------------------------------

--Prc_InsDealerMapping 'NAZI1036,NAZI1034','NAZI001','NAZI002','07Jul2018181921',''
CREATE Procedure [dbo].[Prc_InsDealerMapping]
(
@party_code varchar(max),
@Dealer1 varchar(50),
@Dealer2 varchar(50),
@ProcessID varchar(500)


)
As
Begin


Declare @ClientidTemp Table    
(    
 Clientid Varchar(2000)    
)    
    
    
 INSERT INTO @ClientidTemp    
 SELECT distinct StringValue AS CoCode FROM dbo.fn_Split(@party_code, ',')    
   
   


insert into [B2B_Bulk_DealerMapping] 
(Party_Code,Dealer1,Dealer2,ProcessId,Segment_Type,UserCode)
select Clientid,@Dealer2,@Dealer1,@ProcessID,'ALL',@Dealer1 from @ClientidTemp


select 'Success' as Msg


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_InsDealerMapping_NXT
-- --------------------------------------------------


--Prc_InsDealerMapping 'NAZI1036,NAZI1034','NAZI001','NAZI002','07Jul2018181921',''
CREATE  Procedure [dbo].[Prc_InsDealerMapping_NXT]
(
@party_code varchar(50),
@Dealer1 varchar(50),
@Dealer2 varchar(50),
@ProcessID varchar(500)


)
As
Begin


Declare @ClientidTemp Table    
(    
 Clientid Varchar(2000)    
)    
    
    
 INSERT INTO @ClientidTemp    
 SELECT distinct StringValue AS CoCode FROM dbo.fn_Split(@party_code, ',')    
   
 
insert into [B2B_Bulk_DealerMapping] 
(Party_Code,Dealer1,Dealer2,ProcessId,Segment_Type,UserCode)
select Clientid,@Dealer1,@Dealer2,@ProcessID,'ALL',@Dealer1 from @ClientidTemp


--INSERT INTO [172.31.16.95].NXT.dbo.B2B_Bulk_DealerMapping(Party_Code,Dealer1)
--select party_code,Dealer2 from DBO.[B2B_Bulk_DealerMapping] where Dealer2=@Dealer2



select 'Success' as Msg


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_InsDealerMapping_NXT_Bkp27Jan2020
-- --------------------------------------------------

--Prc_InsDealerMapping 'NAZI1036,NAZI1034','NAZI001','NAZI002','07Jul2018181921',''  
CREATE Procedure [dbo].[Prc_InsDealerMapping_NXT_Bkp27Jan2020]  
(  
@party_code varchar(50),  
@Dealer1 varchar(50),  
@Dealer2 varchar(50),  
@ProcessID varchar(500)  
  
  
)  
As  
Begin  
  
  
Declare @ClientidTemp Table      
(      
 Clientid Varchar(2000)      
)      
      
      
 INSERT INTO @ClientidTemp      
 SELECT distinct StringValue AS CoCode FROM dbo.fn_Split(@party_code, ',')      
     
   
insert into [B2B_Bulk_DealerMapping]   
(Party_Code,Dealer1,Dealer2,ProcessId,Segment_Type,UserCode)  
select Clientid,@Dealer2,@Dealer1,@ProcessID,'ALL',@Dealer1 from @ClientidTemp  
  
  
--INSERT INTO [172.31.16.95].NXT.dbo.B2B_Bulk_DealerMapping(Party_Code,Dealer1)  
--select party_code,Dealer2 from DBO.[B2B_Bulk_DealerMapping] where Dealer2=@Dealer2  
  
  
  
select 'Success' as Msg  
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_isClientMappedUnderEmployee
-- --------------------------------------------------
    
/*              
 Created By : Vikram Ukani              
 Creted On :  16 Mar 2012              
 Updated By : Vikram Ukani          
 Last Updated On : 26 April 2012            
        
 Desc : To Check clients are mapped under the employee    
 declare @isClientMapped bit     
 Exec prc_isClientMappedUnderEmployee 'ETA001' ,@isClientMapped out    
 declare @isClientMapped bit     
 Exec prc_isClientMappedUnderEmployee 'ETA002',@isClientMapped  out        
               
*/         
        
CREATE proc prc_isClientMappedUnderEmployee        
@empno varchar(20),@isClientMapped bit out      
as        
begin        
        
DECLARE @reccount numeric(18,0)                  
    
 create table #temp_ClientMapping (IsClientMapped bit)     
 insert into #temp_ClientMapping (IsClientMapped) exec b2b_crms_dealer_client_status  @empno    
    
 select @isClientMapped=isClientMapped from #temp_ClientMapping    
    
 --select isnull(@isClientMapped,0) isClientMapped        
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_isClientMappedUnderEmployee_old
-- --------------------------------------------------
/*        
 Created By : Vikram Ukani        
 Creted On :  16 Mar 2012        
 Updated By : Vikram Ukani   
 Last Ukdated On : 16 march 2012      
  
 Desc : To Check clients are mapped under the employee      
 Exec prc_isClientMappedUnderEmployee 'afpi001', '6,1'  
         
*/   
  
CREATE proc [dbo].[prc_isClientMappedUnderEmployee_old]  
@empno varchar(20),@RoleId varchar(500)  
as  
declare @isClientMapped bit,@cnt as int  
begin  
  
DECLARE @reccount numeric(18,0)                                          
                                      
 CREATE TABLE #TempB(Id int PRIMARY KEY IDENTITY(1,1),Sno bigint)                                          
 SELECT @reccount = charindex(',',@RoleId)                                          
 while (charindex(',',@RoleId) > 0 )                                           
 BEGIN                                          
                                        
  SET @reccount=CONVERT(bigint,substring(@RoleId,1,charindex(',',@RoleId)-1))                                          
  SET @RoleId = substring(@RoleId,charindex(',',@RoleId)+1,len(@RoleId))                                     
  INSERT INTO #TempB(Sno) VALUES (@reccount)                                          
 END                                          
 SET @reccount=CONVERT(bigint,@RoleId)                                          
 INSERT INTO #TempB(Sno) VALUES (@reccount)  
   
    
 select pid_tbl_Role_mst RoleIds into #temp_RoleIds--@cnt=count(*)  
 from tbl_role_master mst1   
 where not exists(select sno from  #tempb t1 where  mst1.pid_tbl_Role_mst=t1.sno  )  
 and isnull(ApplyRule_ClientMaping_Suspension,0)=1  
   
 select @cnt=count(*) from #temp_RoleIds  
          
    if(isnull(@cnt,0)>0)  
    begin  
  select @isClientMapped=isClientMaped from tbl_employee_clientmaping where emp_no=@empno   
 end  
 select isnull(@isClientMapped,0) isClientMapped  
   
 select RoleIds from #temp_RoleIds   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_ReActiveEmployee
-- --------------------------------------------------
/*    
 Created By : Vikram Ukani    
 Creted On :  14 Mar 2012    
 Desc : To ReActive suspended Employees when any Client is maped to him   
 Exec   prc_ReActiveClient  
     
*/    
  
  
CREATE proc [dbo].[prc_ReActiveEmployee]  
as  
begin  
   
 update tbl_emp_master set isSuspended=0 from tbl_emp_master mst1,vw_isClientMapped_B2BCrms t1    
 where mst1.emp_no=t1.emp_no and  t1.isclientmapped =1 and IsSuspended=1 and isnull(IsTerminated,0)=0    
   
 update tbl_Emp_Suspension_Termination  set suspension_date=null,isSuspended=0,suspendedBy=null,suspensionEntry_Date=null   
 from tbl_Emp_Suspension_Termination t2,vw_isClientMapped_B2BCrms t1    
 where t2.emp_no=t1.emp_no and t1.isclientmapped =1  and isnull(IsTerminated,0)=0 and IsSuspended=1   
   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_RecordList_ListControls
-- --------------------------------------------------
/*
	Created By : Vikram Ukani
	Creted On :  07 Mar 2012
	Desc : To Bind Records to Dropdownlist or checkbox list or radiobuttonlist
	Exec prc_RecordList_ListControls 'tbl_Emp_master','Emp_Name','Emp_No', 'sb_Tag=''Test''','Emp_N0'
	
*/

CREATE proc [dbo].[prc_RecordList_ListControls]      
 @TableName as varchar(100),@TextColumn as varchar(1000),@ValueColumn as varchar(1000)=null,
 @WhereClause  as varchar(1000)=null,@OrderByColumn varchar(1000)=null     
 as        
         
 Declare @str varchar(max)        

set @str='select distinct '+ @TextColumn +' as TextField '+ isnull(','+@valueColumn+' as ValueField','') +'  from ' + 
		@TableName +' where isnull('+@TextColumn+','+ ' '''')!='''''
        
 begin         
   if(@whereclause is null)      
   begin      
  set @str='select distinct '+ @TextColumn +' as TextField '+ isnull(','+@valueColumn+' as ValueField','') +'  from ' + @TableName +' where '+@TextColumn+' is not null and '    
     + @TextColumn +'!= '''' order by  ' +@TextColumn    
   end      
   else      
   begin      
   set @str=@str+' and '+@whereclause  +' order by '  +isnull(@OrderByColumn,@TextColumn)  
   end      
  print @str      
 exec(@str)        
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_SendAutoMail
-- --------------------------------------------------
/*            
 Created By : Vikram Ukani            
 Creted On :  13 Mar 2012            
 Desc : To send Autogenerated mail from system        
 Exec prc_SendAutoMail 1 ,''          
 select * from tbl_MailMessage_Master            
*/         
        
CREATE proc [dbo].[prc_SendAutoMail]        
@MailId int=null,@TempTableName varchar(200)        
as        
declare @Subject varchar(200),@Recipients varchar(5000),@CC varchar(5000),@BCC varchar(5000),@SbTag varchar(10),          
  @MailTemplate varchar(max),@MailBody varchar(max),@Data varchar(max),@Emp_no varchar(50),@stMailId varchar(100)      
  Declare @EmpStr varchar(120)      
  declare @MinRwId int,@MaxRwId int,@CurRwId int          
declare @SubBrokerTag varchar(20),  @EmpName varchar(200),@EmpNo varchar(7),@HodNo varchar(7)          
declare @CurrentDateStamp varchar(20)        
begin        
 set @CurrentDateStamp =convert(varchar(11),getdate(),106)         
         
 set @MailTemplate='<html><head></head><body> #MailTemplate# </body></html>'        
      
 select @subject=MailSubject,@MailTemplate=replace(@MailTemplate,'#MailTemplate#',MailTemplate)         
    from tbl_MailMessage_Master mst (nolock) where mm_Id=@MailId          
         
 set @subject=replace(@subject,'#CurrentDate#',@CurrentDateStamp)        
      
      
         
 select @CurRwId=Min(Id),@MaxRwId=MAx(Id) from #temp_Suspension          
         
  while(@CurRwId<=@MaxRwId)          
  begin          
   select @SbTag=sb_tag,@Emp_no=Emp_no from #temp_Suspension where Id=@CurRwId      
   select @stMailId=Email from tbl_Emp_Master E inner join tbl_EmpLoyee_ClientMaping M on E.sb_tag=M.sb_tag   where E.sb_tag=@SbTag and M.isClientMaped=1      
   set @MailBody=replace(@MailTemplate,'#SbTag#',@SbTag)       
         
            
   SELECT @EmpStr=ISNULL(STUFF( (         
     SELECT '<strong>'+ convert(varchar(10),@CurRwId)+')</strong>#spc##spc##spc#'+convert(varchar(150),(Emp_No+' : '+Emp_Name))        
     +'<br /><br />#spc#'    --clmnname +' as '+clmnDisplayName              
            from tbl_Emp_Master    where emp_no=@Emp_no order by emp_no           
            
    FOR XML PATH('')            
    ), 1, 0, ''            
    ),'')            
         
   set @EmpStr=replace(@EmpStr,'strong','b')         
         
   set @EmpStr=replace(@EmpStr,'#spc#','&nbsp;')      
         
   set @MailBody=replace(@MailBody,'#EmployeeData#',@EmpStr)      
   set @MailBody=replace(@MailBody,'&lt;','<')      
   set @MailBody=replace(@MailBody,'&gt;','>')      
            
         
    set @MailBody= @MailBody+' <br/><br/><br/>Please do not reply to this mail as it is a computer generated mail'          
                         
                     
   if(isnull(@stMailId,'')<>'')
   begin          
	   EXEC msdb.dbo.sp_send_dbmail                                       
	   @profile_name = 'B2BCRMS-Helpdesk',                                      
	   @recipients=@stMailId,              --@stTo,                        
	   --@copy_recipients ='Rakesh.Sharma@angelbroking.com;',                                      
	   --@blind_copy_recipients='vikram.ukani@angelbroking.com;',    
	   @subject =@subject, -- 'Invoice for Approval ',                                      
	   @body = @MailBody,                        
	   @body_format = 'HTML'
   end       
   set @MailBody=''       
   set @SbTag=''        
   set @Emp_no=''         
   set @EmpStr=''      
   set @CurRwId=@CurRwId+1          
 end           
        
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_SendAutoMail_Termination
-- --------------------------------------------------
/*        
 Created By : Vikram Ukani        
 Creted On :  13 Mar 2012        
 Desc : To send Autogenerated mail from system    
 Exec prc_SendAutoMail 1 ,''      
 select * from tbl_MailMessage_Master        
*/     
    
CREATE proc [dbo].[prc_SendAutoMail_Termination]    
@MailId int=null,@TempTableName varchar(200)    
as    
declare @Subject varchar(200),@Recipients varchar(5000),@CC varchar(5000),@BCC varchar(5000),@SbTag varchar(10),      
  @MailTemplate varchar(max),@MailBody varchar(max),@Data varchar(max),@Emp_no varchar(50),@stMailId varchar(100)  
  Declare @EmpStr varchar(120)  
  declare @MinRwId int,@MaxRwId int,@CurRwId int      
declare @SubBrokerTag varchar(20),  @EmpName varchar(200),@EmpNo varchar(7),@HodNo varchar(7)      
declare @CurrentDateStamp varchar(20)    
begin    
 set @CurrentDateStamp =convert(varchar(11),getdate(),106)     
     
 set @MailTemplate='<html><head></head><body> #MailTemplate# </body></html>'    
  
 select @subject=MailSubject,@MailTemplate=replace(@MailTemplate,'#MailTemplate#',MailTemplate)     
    from tbl_MailMessage_Master mst (nolock) where mm_Id=@MailId      
     
 set @subject=replace(@subject,'#CurrentDate#',@CurrentDateStamp)    
  
  
     
 select @CurRwId=Min(Id),@MaxRwId=MAx(Id) from #temp_Termination      
     
  while(@CurRwId<=@MaxRwId)      
  begin      
   select @SbTag=sb_tag,@Emp_no=Emp_no from #temp_Termination where Id=@CurRwId  
   select @stMailId=Email from tbl_Emp_Master E inner join tbl_EmpLoyee_ClientMaping M on E.sb_tag=M.sb_tag   where E.sb_tag=@SbTag and M.isClientMaped=1  
   set @MailBody=replace(@MailTemplate,'#SbTag#',@SbTag)   
     
        
   SELECT @EmpStr=ISNULL(STUFF( (     
     SELECT '<strong>'+ convert(varchar(10),@CurRwId)+')</strong>#spc##spc##spc#'+convert(varchar(150),(Emp_No+' : '+Emp_Name))    
     +'<br /><br />#spc#'    --clmnname +' as '+clmnDisplayName          
            from tbl_Emp_Master    where emp_no=@Emp_no order by emp_no       
        
    FOR XML PATH('')        
    ), 1, 0, ''        
    ),'')        
     
   set @EmpStr=replace(@EmpStr,'strong','b')     
     
   set @EmpStr=replace(@EmpStr,'#spc#','&nbsp;')  
     
   set @MailBody=replace(@MailBody,'#EmployeeData#',@EmpStr)  
   set @MailBody=replace(@MailBody,'&lt;','<')  
   set @MailBody=replace(@MailBody,'&gt;','>')  
        
     
    set @MailBody= @MailBody+' <br/><br/><br/>Please do not reply to this mail as it is a computer generated mail'      
                     
	                 
   if(isnull(@recipients,'')<>'')
   begin      
	   EXEC msdb.dbo.sp_send_dbmail                                   
	   @profile_name = 'B2BCRMS-Helpdesk',                                  
	   @recipients=@stMailId,              --@stTo,                    
	   --@copy_recipients ='Rakesh.Sharma@angelbroking.com;',                                  
	   @blind_copy_recipients='vikram.ukani@angelbroking.com;', 
	   @subject =@subject, -- 'Invoice for Approval ',                                  
	   @body = @MailBody,                    
	   @body_format = 'HTML'
   end   
	   set @MailBody=''   
	   set @SbTag=''    
	   set @Emp_no=''     
	   set @EmpStr=''  
	   set @CurRwId=@CurRwId+1
         
 end       
   
      
    
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_SendMail
-- --------------------------------------------------
CREATE proc [dbo].[prc_SendMail]            
           
@To varchar(max)=null,  
@CC varchar(max)=null ,  
@bcc as varchar(max)=null,  
@MailContent as varchar(max),  
@Mailsubject varchar(1000),  
@file_attachment varchar(1000)=null    
       
as            
            
begin            
exec msdb.dbo.sp_send_dbmail      
@recipients  = @To,             
@copy_recipients=@cc,    
@blind_copy_recipients=@bcc,    
@profile_name = 'B2BCRMS-Helpdesk',                                          
@subject = @Mailsubject,                                           
@body_format = 'html',                                                 
@body =@MailContent,       
@file_attachments=@file_attachment                 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_SendMail_Password
-- --------------------------------------------------
/*
	Created By : Vikram Uknai
	Created On : 20th Mar 2012
	Desc : This procedure is created for sending system generated password when new employee is created 
	Exec prc_SendMail_Password 'VVHP002','JANAK S KASTA','4MAUHLB3','RAIVAT@REDIFFMAIL.COM','','rakesh.sharma@angelbroking.com;kamlesh.salgaonkar@angelbroking.com' 
select * from tbl_Emp_Master where emp_no='vvhp002'


*/

CREATE proc [dbo].[prc_SendMail_Password]      
@Emp_no varchar (70),@Emp_Name varchar(300),@password varchar(20),
@To varchar(max),@cc varchar(max)=null,@BCC varchar(max)=null      
as      
DECLARE @alpha_numeric VARCHAR(8)
declare @MailBody varchar(max),@MailTemplate varchar(max),@subject varchar(1000)
begin      
	        
	set @MailBody='<html><head></head><body>#MailTemplate#</body></html>'
	select @MailTemplate=MailTemplate,@subject=MailSubject from tbl_MailMessage_Master where MM_Id=2 
	set @MailBody=replace(@MailBody,'#MailTemplate#',@MailTemplate)
    
    set  @MailBody=REPLACE(@MailBody,'#EmpCode#',@Emp_no)
    set  @MailBody=REPLACE(@MailBody,'#EmpName#',@Emp_name)
	set  @MailBody=REPLACE(@MailBody,'#UserId#',@Emp_no)
	set  @MailBody=REPLACE(@MailBody,'#Password#',@Password)
	      
	print @MailBody      
	exec prc_SendMail @To=@To,@MailContent=@MailBody,@Mailsubject=@subject    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_SendMail_Password_Auto
-- --------------------------------------------------
/*        
 Created By : Vikram Uknai        
 Created On : 20th Mar 2012        
 Desc : This procedure is created for sending system generated password when new employee is created         
 Exec prc_SendMail_Password 'VVHP002','JANAK S KASTA','4MAUHLB3','RAIVAT@REDIFFMAIL.COM','','rakesh.sharma@angelbroking.com;kamlesh.salgaonkar@angelbroking.com'         
    select * from tbl_MailMessage_Master where emp_no='vvhp002'        
        
        
*/        
        
CREATE proc [dbo].[prc_SendMail_Password_Auto]              
@Emp_no varchar (70),@Emp_Name varchar(300),@password varchar(20),        
@To varchar(max),@cc varchar(max)=null,@BCC varchar(max)=null              
as              
DECLARE @alpha_numeric VARCHAR(8)        
declare @MailBody varchar(max),@MailTemplate varchar(max),@subject varchar(1000)        
begin              
                 
 set @MailBody='<html><head></head><body>#MailTemplate#</body></html>'        
 select @MailTemplate=MailTemplate,@subject=MailSubject from tbl_MailMessage_Master where MM_Id=5         
 set @MailBody=replace(@MailBody,'#MailTemplate#',@MailTemplate)        
            
    set  @MailBody=REPLACE(@MailBody,'#EmpCode#',@Emp_no)        
    set  @MailBody=REPLACE(@MailBody,'#EmpName#',@Emp_name)        
 set  @MailBody=REPLACE(@MailBody,'#UserId#',@Emp_no)        
 set  @MailBody=REPLACE(@MailBody,'#Password#',@Password)        
               
 print @MailBody              
 --exec prc_SendMail @To=@To,@MailContent=@MailBody,@Mailsubject=@subject           
       
 --declare @To varchar(max)=null,@CC varchar(max)=null ,@bcc as varchar(max)=null          
 --declare @MailContent as varchar(max),@Mailsubject varchar(1000),@file_attachment varchar(1000)=null            
               
                   
                    
                    
exec msdb.dbo.sp_send_dbmail              
@recipients  = @To,                     
--@copy_recipients='kamlesh.salgaonkar@angelbroking.com',            
@blind_copy_recipients='kamlesh.salgaonkar@angelbroking.com',            
@profile_name = 'B2BCRMS-Helpdesk',                                                  
@subject = @subject,                                                   
@body_format = 'html',                                                         
@body =@MailBody             
--@file_attachments=@file_attachment                         
        
        
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_SuspendEmployee
-- --------------------------------------------------
/*            
 Created By : Vikram Ukani            
 Creted On :  14 Mar 2012            
 Desc : To Suspend Employees with today's suspension date            
 Exec   prc_SuspendEmployee          
             
*/            
          
          
CREATE proc [dbo].[prc_SuspendEmployee]          
as          
begin          
          
 create table #temp_Suspension(Id int,sb_tag varchar(25),emp_no varchar(25),suspension_Date datetime,isClientMaped bit )           
--comment on  14/10/2013 by rakesh         
 --insert into #temp_Suspension (sb_tag,emp_no,suspension_Date,isClientMaped)          
 -- select distinct t1.sb_tag,t1.emp_no,isnull(suspension_Date,getdate()),isnull(t2.isclientmapped,0)          
 -- from tbl_Emp_Suspension_Termination t1 left outer join vw_isClientMapped_B2BCrms t2          
 -- on t1.emp_no=t2.emp_no          
 -- where isnull(issuspended,0)=0 and          
 -- (convert(varchar(11),suspension_Date,106)=convert(varchar(11),getdate()-1,106) or t2.isclientmapped=0)           
         
 --update #temp_Suspension set id=a.id from #temp_Suspension t1,        
 -- (select sb_tag,emp_no,row_number() over (partition by sb_tag order by emp_no) id  from  #temp_Suspension t2 ) a        
 -- where t1.sb_tag=a.sb_tag and t1.emp_no=a.emp_no        
             
           
 --update tbl_emp_master set isSuspended=1 from tbl_emp_master mst1,#temp_Suspension t1            
 --where mst1.emp_no=t1.emp_no and t1.isclientmaped =0            
           
 --update tbl_Emp_Suspension_Termination  set suspension_date=t1.suspension_date,isSuspended=1       
 --from tbl_Emp_Suspension_Termination t2,#temp_Suspension t1            
 --where t2.emp_no=t1.emp_no and t1.isclientmaped =0            
           
         
 -- Exec prc_SendAutoMail 1 ,'#temp_Suspension'          
        
          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_TerminateEmployee
-- --------------------------------------------------
/*    
 Created By : Vikram Ukani    
 Creted On :  14 Mar 2012    
 Desc : To prc_TerminateEmployee Employees with today's prc_TerminateEmployee date  or who are suspended before 180 days  
 Exec   prc_TerminateEmployee  
     
*/    
  
  
CREATE proc [dbo].[prc_TerminateEmployee]  
as  
begin  
  
 create table #temp_Termination(Id int,sb_tag varchar(25),emp_no varchar(25),Termination_Date datetime,isClientMaped bit )   
  --comment on  14/10/2013 by rakesh   
-- insert into #temp_Termination (sb_tag,emp_no,Termination_Date,isClientMaped)  
--  select distinct t1.sb_tag,t1.emp_no,isnull(Termination_Date,getdate()),t2.isClientMapped  
--  from tbl_Emp_Suspension_Termination t1 inner join vw_isClientMapped_B2BCrms t2  
--  on t1.emp_no=t2.emp_no  
--  where convert(varchar(11),Termination_Date,106)=convert(varchar(11),getdate()-1,106)  
--  --or (issuspended=1 and convert(varchar(11),Suspension_Date,106)>convert(varchar(11),getdate()-180,106))  
--  or (issuspended=1 and datediff(day,Suspension_Date,getdate())>=180)   
     
   
-- update tbl_emp_master set isTerminated=1 from tbl_emp_master mst1,#temp_Termination t1    
-- where mst1.emp_no=t1.emp_no and t1.isclientmaped =0    
   
-- update tbl_Emp_Suspension_Termination  set isTerminated=1,termination_date=t1.termination_date   
-- from tbl_Emp_Suspension_Termination t2,#temp_Termination t1    
-- where t2.emp_no=t1.emp_no and t1.isclientmaped =0    
   
--  update #temp_Termination set id=a.id from #temp_Termination t1,      
--    (select sb_tag,emp_no,row_number() over (partition by sb_tag order by emp_no) id  from  #temp_Termination t2 ) a      
--    where t1.sb_tag=a.sb_tag and t1.emp_no=a.emp_no     
   
---- select * from #temp_Termination order by emp_no  
   
-- Exec prc_SendAutoMail_Termination 3 ,'#temp_Termination'        
  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_UpdateCapability_tbl_EmployeeView
-- --------------------------------------------------
/*  
 Created By : Vikram Ukani  
 Created On : 02 May 2012  
 Desc : To update Capabilities (Turnover,Brokerage)  in table tbl_EmployeeView while updating/selecting   
     capabilities from emp_mapping.aspx(Role Capability Mapping) page.  
       
 Exec  prc_UpdateCapability_tbl_EmployeeView 'ETT002'  
 select * from vw_tbl_Employeeview where emp_no='ETT002'  
*/  
  
  
CREATE proc prc_UpdateCapability_tbl_EmployeeView  
 @emp_No varchar(10)  
as  
 declare @TurnoverPid int,@BrokeragePid int,@cnt int
 declare @isTurnover bit,@isBrokerage bit  
begin  
   
   
  select @TurnoverPid=pid_tbl_capability_mst from tbl_capability_master (nolock) where capability_name ='Turnover'  
  select @BrokeragePid=pid_tbl_capability_mst from tbl_capability_master (nolock) where capability_name ='Brokerage'  
      
  select @cnt=count(distinct emp_no) from tbl_EmployeeView (nolock) where emp_no=@emp_no
  
  select @isBrokerage=1  from  tbl_emp_capability (nolock) t2 where emp_no=@emp_no and Fkid_tbl_capability_mst=@BrokeragePid   
  select @isTurnover=1  from  tbl_emp_capability (nolock) t2 where emp_no=@emp_no and Fkid_tbl_capability_mst=@TurnoverPid
   
  if(isnull(@cnt,0)>0)  
  begin  
	update  tbl_EmployeeView set isBrokerage=isnull(@isBrokerage,0),isTurnover=isnull(@isTurnover,0) where emp_no=@emp_no     
  end  
      
  else  
  begin  
		insert into tbl_EmployeeView (sb_tag,emp_no,IsDealer,isTurnOver,isBrokerage,UpdationDate)  
		select null,@emp_no,0,isnull(@isTurnover,0),isnull(@isBrokerage,0),getdate()  
        
  end  
   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_UpdateDegfault_RoleCapability_AllEmp
-- --------------------------------------------------
/*
Exec prc_UpdateDegfault_RoleCapability_AllEmp

Desc : Add default tables to Maping tables for all employees,
Only use when default role for all employees to be enter 

*/

CREATE proc [dbo].[prc_UpdateDegfault_RoleCapability_AllEmp]
as
declare @CurrentRwid int,@MinRwid int,@MaxRwid int
declare @EmpNo Varchar(20)
declare @UserId Varchar(20),@Ip Varchar(20)

begin
	set nocount on
	set @Userid='SqlUser'
	set @ip='196.1.115.141' 
	
	select row_number() over(order by Sb_tag,Emp_No) rwid,Emp_no into #temp_Emp 
	from tbl_Emp_master (nolock)
	
	select @minRwid=min(rwid),@maxRwid=max(rwid) from #temp_Emp
	set @CurrentRwId=@minRwid

delete from tbl_Emp_Role  where 
fkid_tbl_Role_mst in (select pid_tbl_Role_mst from tbl_role_master t2 
		 where isdefaultselected=1 )

delete from tbl_Emp_Capability  where 
fkid_tbl_Capability_mst in (select pid_tbl_Capability_mst from tbl_capability_master t2 where isdefaultselected=1 
		)

	while(@currentRwid<=@maxRwId)
	begin
		select @Empno=Emp_no from #temp_Emp where rwid=@CurrentRwId
		exec prc_AssignDefault_RoleCapability @EmpNo,@UserId,@Ip
	set @CurrentRwId=@CurrentRwId+1	  
	end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_UpdateNewSalry
-- --------------------------------------------------
/*  
 Created By : Vikram Ukani  
 Creted On :  03 Mar 2012  
 Desc : To Bind Dropdown of EmpList  
 Exec prc_UpdateNewSalry 'SB002' ,100000,120000,'23-03-2012','User1','196.1.115.237'  
   
*/  
  
CREATE proc [dbo].[prc_UpdateNewSalry]  
@EmpNo varchar(10),@OldSalary decimal(18,2),@NewSalary decimal(18,2),  
@EffectiveDate nvarchar(50),@UserId varchar(20),@IP varchar(20)  
as  
  
begin  
  
 insert into log_Emp_Salary_Increment (emp_no,old_salary,new_salary,dt_effective,[user_id],dt_updation,ip,log_UpdationDate)  
 select emp_no,old_salary,new_salary,dt_effective,[user_id],dt_updation,ip,getdate()   
   from  tbl_Emp_Salary_Increment  where emp_no=@empNo  
   
 delete from tbl_Emp_Salary_Increment where emp_no=@empNo   
   
 insert into tbl_Emp_Salary_Increment (emp_no,old_salary,new_salary,dt_effective,[user_id],dt_updation,ip)   
 select @EmpNo,@OldSalary,@NewSalary,convert(datetime,@EffectiveDate,103),@UserId,getdate(),@IP   
   
 --update tbl_Emp_master set salary=@newsalary where emp_no=@empNo   
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_UpdateRole_tbl_EmployeeView
-- --------------------------------------------------
/*  
 Created By : Vikram Ukani  
 Created On : 02 May 2012  
 Desc : To update dealer role in table tbl_EmployeeView while updating/selecting   
     dealer role from emp_mapping.aspx(Role Capability Mapping) page.  
       
 Exec  prc_UpdateRole_tbl_EmployeeView 'ETT002'  
 select * from vw_tbl_Employeeview where emp_no='ETT002'  
*/  
  
  
CREATE proc prc_UpdateRole_tbl_EmployeeView  
 @emp_No varchar(10),@RoleID int=null  
as  
 declare @DealerPid int,@isDealer bit,@cnt int  
begin  
   
   
  select @DealerPid=pid_tbl_role_mst from tbl_role_master (nolock) where role_name ='Dealer'  
    
  select @cnt=count(distinct emp_no) from tbl_EmployeeView (nolock) where emp_no=@emp_no
    
  select @isDealer=1  from  tbl_emp_role (nolock) t2 where emp_no=@emp_no and Fkid_tbl_Role_mst=@DealerPid  
  
  if(isnull(@cnt,0)>0)  
  begin  
	update  tbl_EmployeeView set isDealer=isnull(@isDealer,0)  where emp_no=@emp_no     
  end  
   
   
  else  
  begin  
    insert into tbl_EmployeeView (sb_tag,emp_no,IsDealer,isTurnOver,isBrokerage,UpdationDate)  
     select null,@emp_no,isnull(@isDealer,0),0,0,getdate()   
        
  end  
   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.prc_UpdateSalary_DailyProcess
-- --------------------------------------------------
 
 /*      
 Created By : Vikram Ukani      
 Creted On :  13 Mar 2012      
 Desc : To Bind Increment MIS      
 Exec prc_UpdateSalary_DailyProcess      
       
*/      
CREATE proc prc_UpdateSalary_DailyProcess  
as  
  
begin  
   
 select emp_no,new_Salary into #temp_Increment  
 from dbo.tbl_Emp_Salary_Increment   
 where convert(varchar(11),Dt_Effective,106) >=convert(varchar(11),dateadd(dd,-5,getdate()),106)
 
 and   isnull(isNewSalaryEffected,0)=0
   
 update tbl_emp_master set salary=new_salary from tbl_emp_master mst1,#temp_Increment t1  
 where mst1.emp_no=t1.emp_no     
 
 update tbl_Emp_Salary_Increment set isNewSalaryEffected=1,Dt_NewSalaryEffect=getdate()
 from tbl_emp_master mst1,#temp_Increment t1  
 where mst1.emp_no=t1.emp_no     
    
 --select *from  #temp_Increment  
   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.proc_notice
-- --------------------------------------------------
create procedure [dbo].[proc_notice]
(
@nID varchar(50)
)
as

select distinct a.Emp_name, a.Sr_name, b.ReqID, b.ItemName, b.NoteDate, c.ReqStatusName, b.note 
from Emp_info a, Notifications b, ReqStatus c, InventoryItem d, Category e  

where a.Emp_no = b.Emp_No AND b.NoteID =@nID 
AND ( b.CatName = e.CatName AND e.CatID = d.CatID) 
and b.ReqStatusCode=c.ReqStatusCode	

return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS
-- --------------------------------------------------




CREATE procedure [dbo].[SBB2B_MIS]

 @UserEmp_No varchar(20),

 @UserStatusId varchar(10),--SUBBROKER/SBDEALER

 @Sub_Broker varchar(10),

 @Dealer varchar(20),

 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE

 @ClientGrade varchar(15),--ALL,A+,A,B,C,D

 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency

 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012

 @Wise varchar(20),       --SUBBROKER/DEALER

 @ReportType varchar(20), --MAIN/DRILL

 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI

 @TotalFlag varchar(2) = null

 as

 BEGIN

/*

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='jan  1 2013',@Wise='Dealer',@ReportType='MAIN',@DrillFlag=''



exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''



exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'



exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'



exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

*/

--

print 'Start:'+convert(varchar,getdate(),109)

 Declare @ToDate smalldatetime

 Declare @FromDealer varchar(10)

 Declare @ToDealer varchar(10)

 Declare @FromEffSaudaDate datetime

 Declare @ToEffSaudaDate datetime

 Declare @TradeDays money

 Declare @SegmentTypeFrom varchar(10)

 Declare @SegmentTypeTo varchar(10)

 Declare @FromSub_Broker varchar(10)

 Declare @ToSub_Broker varchar(10)

 

 --------------------------------Set From and TO date---------------------------------------

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'

set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'

print @FromDate

print @ToDate

set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))

set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))

set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))

set @Dealer=upper(ltrim(rtrim(@Dealer)))

set @TradingMode=upper(ltrim(rtrim(@TradingMode)))

set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))

set @SegmentType=upper(ltrim(rtrim(@SegmentType)))

set @Wise=upper(ltrim(rtrim(@Wise)))

set @ReportType=upper(ltrim(rtrim(@ReportType)))

set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))

 ---------------------------------------Get count of Trade Days---------------------------------------------

 /* Added table date for the Currency Segment */

if(@SegmentType = 'CURRENCY')

begin

   set @SegmentTypeFrom  ='CURRENCY'

   set @SegmentTypeTo='CURRENCY'

   

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'

end

else

begin

			if(@SegmentType = 'CASH')

			begin

			set @SegmentTypeFrom  ='CASH'

			set @SegmentTypeTo='CASH'

			End



			if(@SegmentType = 'DERIVATIVE')

			begin

			set @SegmentTypeFrom  ='DERIVATIVE'

			set @SegmentTypeTo='DERIVATIVE'

			End

			

			if(@SegmentType = 'COMMODITY')

			begin

			set @SegmentTypeFrom  ='COMMODITY'

			set @SegmentTypeTo='COMMODITY'

			End



			if(@SegmentType = 'All')

			begin

			set @SegmentTypeFrom  ='a'

			set @SegmentTypeTo='zzzzzz'

			End

			

			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'

	end

 



 

print @TradeDays

 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------

 

 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 

 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

 

 

----------------------------------------Redefine Report Wise option as per input fields-----------------------



set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)



print @Wise

-------------------------------------------------------------------------

/**subbroker*/

if @Sub_Broker='' or @Sub_Broker='ALL' 

Begin

	set @FromSub_Broker='A'

	set @ToSub_Broker='ZZZZZZZ'

End

else

Begin

	Set @FromSub_Broker=@Sub_Broker

	Set @ToSub_Broker=@Sub_Broker

End



--if @Dealer='' or @Dealer='ALL' set @Dealer='%'

--

/**subbrokerdealer*/

if @Dealer='' or @Dealer='ALL' 

begin

	set @FromDealer='A'

	set @ToDealer='ZZZZZZZ'

end

else

begin

	set @FromDealer=@Dealer

	set @ToDealer=@Dealer

end

--

--------------------------User Access---------------------------------------------------



/*fill subbrokers and dealers*/

declare @tempbranch  table                                                                

(                                                                

Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

)

-----------------------------------------------------

/*if @UserStatusId='SBDEALER'                            

begin                  

	 insert into @tempbranch       

	 select distinct Branch_cd--,Emp_No 

	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No

	 

	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 

	 where Emp_No=@UserEmp_No                       */

	 --Select distinct  P.branch_cd,A.zone,A.region                                  

	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        

	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No

end                            

if @UserStatusId='SUBBROKER'                           

begin    

        /*declare  @temp_sbtag table

		(sbtag varchar(10))

		

		insert into @temp_sbtag*/

		insert into @tempbranch 

		select distinct Branch_cd=sbtag from

		(

			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)

			Union 

			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

			where parenttag=@UserEmp_No

			union 

			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

			where sbtag=@UserEmp_No

			union

			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)

		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    

	/*insert into @tempbranch                                                                 

	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   

	 AngelHarmonyEmployee b--B2B_Harmony b 

	 on a.sbtag=b.hod*/

end



/*if @UserStatusId='SBCHILD'                           

begin

	insert into @tempbranch                                                                 

	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    

	where   HOD=@UserEmp_No	

	select * from @tempbranch	

end

*/

*/





Insert into @tempbranch

select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

 



----------------------------Declare MIS and PartyDetails Table--------------------------



create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

)

--



create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime)

--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)

--

 --Declare  @MIStable table  

 create table #MIStable                                                         

 (                                                          

 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,

 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,

 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,

 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),

 OnlineTurnover money, OfflineTurnover money, Turnover money,

 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int

 )                                                        

--

print 'Access:'+convert(varchar,getdate(),109)

if @Dealer='' or @Dealer='ALL' 

begin

		--		

		print 'ACT1'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd 

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		--and ps.Segment_Type=@SegmentType

		

end 

else

begin

		print 'ACT2'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		and ps.Emp_No>=@FromDealer

		and ps.Emp_No<=@ToDealer

		--and ps.Segment_Type=@SegmentType

end



--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------

if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')

begin

print 'TradingMode or ClientGrade'

if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)

if @ClientGrade='ALL' set @ClientGrade='%'

--

update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating

From angelclient1 ac1,#PartyDetails ps

where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode

and ac1.AngelClRating like @ClientGrade

--

delete #PartyDetails where isnull(EbrokingClient,'')=''

--

end

-----------------------Update #PartyDetails as per report Wise option -------------------------------------

--print '1.1:'+convert(varchar,getdate(),109)

if @Wise='SUBBROKER'

begin

	update #PartyDetails set Emp_No=''

end 

--else if @Wise='ZONE'

--begin

--update #PartyDetails set Region='',Branch_cd='',Emp_No=''

--end

--else if @Wise='REGION'

--begin

--update #PartyDetails set Branch_cd='',Emp_No=''

--end

--else if @Wise='BRANCH'

--begin

--update #PartyDetails set Emp_No=''

--end

-----------------------Update FirstTrade date -------------------------------------

if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))

begin

	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 

		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code*/	

	

	if(@SegmentType in('COMMODITY'))

	begin

		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end

	else if(@SegmentType in('CURRENCY'))

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end		

	else --if(@SegmentType in('CASH','DERIVATIVE') and other

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTrade 

		from angelclient1 ac1 with(nolock),#PartyDetails ps 

		where ac1.Party_Code=ps.Party_Code

	end

end

--------------------------Fetch Brokerage in case when required-------------------------



/*



Select top 10 * from bsecm_cli



*/



if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))

begin

print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)

/*print 'Segment'

print @SegmentTypeFrom

print @SegmentTypeTo

print 'Eff Date'

print @FromEffSaudaDate

print @ToEffSaudaDate

print 'Date'

print @FromDate

print @ToDate*/

/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 

from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */

--



insert into #BrokTurnOver

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		Online_TurnOver=L.ebrok_TurnOver,

		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		GrossRevenue=L.Overall_brok_earned,

		GrossRevenue_Online=L.ebrok_brok_earned,

		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,

		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),

		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 

		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 

		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 

		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table

		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date

		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		--and L.ExceptClient='Y'

print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)



end







--select top 10 * From tbl_Exchangemapping

 

---------------------MAIN PAGE---------------------------------

if @ReportType='MAIN'

begin



-----------------------------Fill MIS Table--------------------------------------------------------------------

		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,

		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,

		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,

		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)

		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,

		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,

		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',

		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,

		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0

		from #PartyDetails		

		group by Branch_cd,Emp_No		

print '1.2:'+convert(varchar,getdate(),109)

----------------------------------------Update Start Of Month Total Clients----------------------------------

		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth

		from

		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	

		from #PartyDetails ps 

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

print '2:'+convert(varchar,getdate(),109)

-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------

		

--

print '3.1 '+convert(varchar,getdate(),109)

--





update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,

DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,

AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),

AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),

AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),

--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),

--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),

 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,

 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue

--CONVERT(decimal(15,2),

		from 

		(

		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   

        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),

        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),

        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),

 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)

  

		from #BrokTurnOver b

		group by b.Branch_cd,b.Emp_No

		)A,	#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

----------------------Update NA-----------------------------

--update #MIStable

----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)



--Comment by sandip

--update #MIStable set ActivationRatio='NA'		

--where TotalClientsStartOfmonth<Tradedclients

update #MIStable set AvgDailyActRatio='NA'		

where TotalClientsStartOfmonth<AvgTradedclients

-----------------------------------------------Activation Ratio---------------------

select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 

	into #RegActiveClients

	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by Sauda_date,Branch_cd,Emp_no)A 

	group by Branch_cd,Emp_no

	--order by 1

	--select * from #RegActiveClients

--Activation main page



--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays

--else 0.00 end)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--



update #MIStable set 

DailyTradedClients_AR=A.DailyTradedClients

from 

(select b.Branch_cd,b.Emp_No,

 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)

 

 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)

		where TD.CMTradingDay='Y'

		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)

	group by b.Branch_cd,b.Emp_No

)A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		





--select @DailyTradedClients_AR		

update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays

else 0.00 end)

from #RegActiveClients A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--



--select DailyTradedClients_AR,DailyTradeDays from #MIStable



update #MIStable

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)





---------------------------------------------------------Update AS ON CLIENTS----------------------------------

print '3.2:'+convert(varchar,getdate(),109)

if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)

begin

		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate

		from 

		(

		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

		from #PartyDetails ps

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

		--------------------------------Calculate Productivity--------------------------------------------------------------

		if @Wise='DEALER'

		begin

			Declare @Act_Days int,@H_days int

			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              

			set @H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

						where holidaydate >= @FromDate and holidaydate <= @ToDate )   

			print @TradeDays

			print @Act_Days

			print @H_days

			--if(@SegmentType='Currency')

			--begin

				--Fetch Emploee with CTC			

				

				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',

				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))

				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)

				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and

				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				

				

		

				--Update productivity for Employee

				print 'productivity'

				print @TradeDays

				print (@Act_Days-@H_days)

				update #MIStable set 

				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 

								else '0.00' end)

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'

				

				

				/*--Print for testing

				select * from #ProdForCurr

				--Print RM

				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,

				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'

				*/

			--End		

			

		end

		--------------------------------End Calculate Productivity--------------------------------------------------------------

end

----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------

print '4:'+convert(varchar,getdate(),109)

--

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded

		from #PartyDetails ps

		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

		and ps.FirstTrade<=@ToDate

		--Delete traded clients

		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)

--	

print '4.1:'+convert(varchar,getdate(),109)

		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth

		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)

		from #nottraded ps

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

drop table #nottraded

--

print '5:'+convert(varchar,getdate(),109)

		

			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate

			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)

			from #PartyDetails ps

			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	

			and ps.FirstTrade>@ToDate

			group by ps.Branch_cd,ps.Emp_No

			)A,#MIStable B

				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	

--

print '6:'+convert(varchar,getdate(),109)

---------------------------------Update Client Visit Pending-------------------------

/*update #MIStable set ClientVisitPending=A.CVPcount

from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp

where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No

)A,#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region

print '7:'+convert(varchar,getdate(),109)*/

------------------------------DROP #PartyDetails---

drop table #PartyDetails

------------------------------DISPLAY------------------------------------------------

print 'Wise: '

print @Wise

if @Wise='DEALER'

begin

		print 'DEALER'

		update #MIStable set Emp_Name=ah.EMP_NAME

					from #MIStable mis,B2B_AngelHarmony ah with(nolock)

					where mis.Emp_No=ah.EMP_NO

		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2,3

end

else

begin

		print 'SUBBROKER'

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2

end

--TOTAL

--if @TotalFlag <> 'Y' 

if(isnull(@TotalFlag,'') in ('','N'))

begin



--select  

--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

--Tradedclients=isnull(sum(Tradedclients),0),

--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

--		else 0.00 end)),

--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



select  

TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

Tradedclients=isnull(sum(Tradedclients),0),

		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

		else 0.00 end)),

		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end

from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



--group by DailyTradeDays

print 'End:'+convert(varchar,getdate(),109)

end 



END

---------------------MAIN PAGE END---------------------------------------------------

---------------------DRILL PAGE START---------------------------------------------------

else if @ReportType='DRILL'

begin

---------------------Declare drill page-------------------------------------------------

create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),

ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),

DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,

LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))



--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)

--

if @DrillFlag='TotalAsOn'

begin

print 'Drill 1:'+convert(varchar,getdate(),109)



	   

		--select * from @rto_Data

			

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate				



print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)

		

		if(@UserStatusId='SBDEALER')

		begin

			declare @rto_Data table

			(

			Zone varchar(20),

			Region varchar(20),

			branch_cd varchar(20),

			sub_broker varchar(20),

			Sub_brokerName varchar(200),

			party_code varchar(20),

			Short_name varchar(100),

			TotalTO money,

			OPTNoOfLots money,

			NoOfLotsGold bigint,

			NoOfLotsSilver bigint,

			NoOfLotsCopper bigint  ,

			NoOfLotsCrude bigint,

			NoOfLotsComm bigint,

			TargetNoOfLotsGold bigint,

			TargetNoOfLotsSilver bigint,

			TargetNoOfLotsCopper bigint,

			TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch='',

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='DRILL',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID='SBDEALER',

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			

			update #drillPartyDetails set TotalTo=rto.TotalTo

			from #drillPartyDetails drill, @rto_Data rto

			where drill.Party_Code=rto.party_code	

		end

		

			

		--

end

else if @DrillFlag='TotalStartOfMonth'

begin

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate	

end

else if @DrillFlag='NotTradedAsOn'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

				and ps.FirstTrade>@ToDate	

end

else if @DrillFlag='NotTradedForMonth'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				

				and ps.FirstTrade<=@ToDate		

		--

		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	

		--

end

else if @DrillFlag='Traded'

begin

		--Insert Traded Clients

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code

		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		

		

end

else if @DrillFlag='BROK'

begin		

		Declare @emp_name varchar(100)		

		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')

		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,

		br.Party_Code,ac1.Long_Name,

		--Turnover =sum(TotalTurnover),

        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 

		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        --NetRevnue =sum(NetRevenue),

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Sauda_date)  

		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code

		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	

		

		--Total		

		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver

		return

end

else if @DrillFlag='ACTIVECLI'

begin		

	

	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),

	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100

	into #FinalActiveCli

	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join

	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)

	 from #BrokTurnOver b

	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	order by 1,2,3

	--Display

	--select * from #FinalActiveCli

	select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli

	--Total Row

	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),

	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100

	 from #FinalActiveCli

	

return

end

---------------------Common Script for DRILL PAGE ---------------------------------------------------

	

print 'Drill 3:'+convert(varchar,getdate(),109)		

		-- Update Portfolio i.e. Holding value

		update #drillPartyDetails                                                             

		set PortfolioInfo=isnull(H.TotalHold,0)            

		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [MIMANSA].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   

		on ps.party_code = H.party_code 

print 'Drill 4:'+convert(varchar,getdate(),109)		

		--Update Ledger Value

		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger

		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [MIMANSA].Angelcs.dbo.View_LedgerInfo L with(nolock)

		on ps.party_code = L.party_code 

		--

		update #drillPartyDetails                                                             

		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)

		from #drillPartyDetails ps left outer join #totalLedger L

		on ps.party_code = L.party_code 

		--

		drop table #totalLedger		

print 'Drill 5:'+convert(varchar,getdate(),109)			

		--Update Current Dealer

		update #drillPartyDetails set DealerCode=cps.Emp_No			

		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )

		where --cps.Segment_Type=@SegmentType and 

		/*EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and*/

		ps.Party_Code =cps.Party_Code and

		cps.Valid='Y' and cps.CommRank='1'

		--Set Row color as per BRS point 4.3.4 & 4.3.5

print 'Drill 6:'+convert(varchar,getdate(),109)	

		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	

		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)

		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'

		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)

		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)

		--		

print 'Drill End:'+convert(varchar,getdate(),109)		

		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',

		SB=Branch_cd,Party_Code,Client_Name,Emp_No,

		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),

		ClientGrade,[Profile],Sub_Profile,

		--ActiveFrom,

		ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),

		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)

		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),

		PureRisk=convert(decimal(15,2),PureRisk),

		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),

		--LastTradeDate,

		LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,

		RowColor,LedgerColor,

		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)

		

		 from #drillPartyDetails s

		 order by SrNo

		 --Total

		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),

		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))

		  from #drillPartyDetails

-------------------

end

---------------------DRILL PAGE END---------------------------------------------------

END

---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_29may2022
-- --------------------------------------------------
  
CREATE procedure [dbo].[SBB2B_MIS_29may2022]  
 @UserEmp_No varchar(20),  
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER  
 @Sub_Broker varchar(10),  
 @Dealer varchar(20),  
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE  
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D  
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency  
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012  
 @Wise varchar(20),       --SUBBROKER/DEALER  
 @ReportType varchar(20), --MAIN/DRILL  
 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI  
 @TotalFlag varchar(2) = null  
 as  
 BEGIN  
/*  
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',  
@SegmentType='ALL',@FromDate='jan  1 2013',@Wise='Dealer',@ReportType='MAIN',@DrillFlag=''  
  
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',  
@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''  
  
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',  
@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'  
  
exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',  
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'  
  
exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',  
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'  
*/  
--  
print 'Start:'+convert(varchar,getdate(),109)  
 Declare @ToDate smalldatetime  
 Declare @FromDealer varchar(10)  
 Declare @ToDealer varchar(10)  
 Declare @FromEffSaudaDate datetime  
 Declare @ToEffSaudaDate datetime  
 Declare @TradeDays money  
 Declare @SegmentTypeFrom varchar(10)  
 Declare @SegmentTypeTo varchar(10)  
 Declare @FromSub_Broker varchar(10)  
 Declare @ToSub_Broker varchar(10)  
   
 --------------------------------Set From and TO date---------------------------------------  
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'  
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'  
print @FromDate  
print @ToDate  
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))  
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))  
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))  
set @Dealer=upper(ltrim(rtrim(@Dealer)))  
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))  
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))  
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))  
set @Wise=upper(ltrim(rtrim(@Wise)))  
set @ReportType=upper(ltrim(rtrim(@ReportType)))  
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))  
 ---------------------------------------Get count of Trade Days---------------------------------------------  
 /* Added table date for the Currency Segment */  
if(@SegmentType = 'CURRENCY')  
begin  
   set @SegmentTypeFrom  ='CURRENCY'  
   set @SegmentTypeTo='CURRENCY'  
     
 select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                        
 where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'  
end  
else  
begin  
   if(@SegmentType = 'CASH')  
   begin  
   set @SegmentTypeFrom  ='CASH'  
   set @SegmentTypeTo='CASH'  
   End  
  
   if(@SegmentType = 'DERIVATIVE')  
   begin  
   set @SegmentTypeFrom  ='DERIVATIVE'  
   set @SegmentTypeTo='DERIVATIVE'  
   End  
     
   if(@SegmentType = 'COMMODITY')  
   begin  
   set @SegmentTypeFrom  ='COMMODITY'  
   set @SegmentTypeTo='COMMODITY'  
   End  
  
   if(@SegmentType = 'All')  
   begin  
   set @SegmentTypeFrom  ='a'  
   set @SegmentTypeTo='zzzzzz'  
   End  
     
   select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                        
   where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'  
 end  
   
  
   
print @TradeDays  
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------  
   
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date)   
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate  
   
   
----------------------------------------Redefine Report Wise option as per input fields-----------------------  
  
set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)  
  
print @Wise  
-------------------------------------------------------------------------  
/**subbroker*/  
if @Sub_Broker='' or @Sub_Broker='ALL'   
Begin  
 set @FromSub_Broker='A'  
 set @ToSub_Broker='ZZZZZZZ'  
End  
else  
Begin  
 Set @FromSub_Broker=@Sub_Broker  
 Set @ToSub_Broker=@Sub_Broker  
End  
  
--if @Dealer='' or @Dealer='ALL' set @Dealer='%'  
--  
/**subbrokerdealer*/  
if @Dealer='' or @Dealer='ALL'   
begin  
 set @FromDealer='A'  
 set @ToDealer='ZZZZZZZ'  
end  
else  
begin  
 set @FromDealer=@Dealer  
 set @ToDealer=@Dealer  
end  
--  
--------------------------User Access---------------------------------------------------  
  
/*fill subbrokers and dealers*/  
declare @tempbranch  table                                                                  
(                                                                  
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                            
)  
-----------------------------------------------------  
/*if @UserStatusId='SBDEALER'                              
begin                    
  insert into @tempbranch         
  select distinct Branch_cd--,Emp_No   
  from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No  
    
  /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony   
  where Emp_No=@UserEmp_No                       */  
  --Select distinct  P.branch_cd,A.zone,A.region                                    
  --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                          
  --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No  
end                              
if @UserStatusId='SUBBROKER'                             
begin      
        /*declare  @temp_sbtag table  
  (sbtag varchar(10))  
    
  insert into @temp_sbtag*/  
  insert into @tempbranch   
  select distinct Branch_cd=sbtag from  
  (  
   select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)  
   where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)  
   Union   
   select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)  
   where parenttag=@UserEmp_No  
   union   
   select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)  
   where sbtag=@UserEmp_No  
   union  
   select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)  
   where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)  
  )a     where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker      
 /*insert into @tempbranch                                                                   
  select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join     
  AngelHarmonyEmployee b--B2B_Harmony b   
  on a.sbtag=b.hod*/  
end  
  
/*if @UserStatusId='SBCHILD'                             
begin  
 insert into @tempbranch                                                                   
 select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony      
 where   HOD=@UserEmp_No   
 select * from @tempbranch   
end  
*/  
*/  
  
  
Insert into @tempbranch  
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker  
   
  
----------------------------Declare MIS and PartyDetails Table--------------------------  
  
create table #PartyDetails (  
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime  
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime  
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime  
)  
--  
  
create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),  
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,  
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,  
Sauda_date smalldatetime)  
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)  
--  
 --Declare  @MIStable table    
 create table #MIStable                                                           
 (                                                            
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,  
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,  
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,  
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),  
 OnlineTurnover money, OfflineTurnover money, Turnover money,  
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int  
 )                                                          
--  
print 'Access:'+convert(varchar,getdate(),109)  
if @Dealer='' or @Dealer='ALL'   
begin  
  --    
  print 'ACT1'  
  insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)  
  select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate  
  from B2B_CommonPartyServices ps with(nolock),@tempbranch aub  
  where ps.Branch_cd=aub.Branch_cd   
  --and ps.emp_no=aub.dealers  
  and ps.FromDate<=@ToDate  
  and ps.ToDate>=@FromDate  
  --and ps.Segment_Type=@SegmentType  
    
end   
else  
begin  
  print 'ACT2'  
  insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)  
  select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate  
  from B2B_CommonPartyServices ps with(nolock),@tempbranch aub  
  where ps.Branch_cd=aub.Branch_cd  
  --and ps.emp_no=aub.dealers  
  and ps.FromDate<=@ToDate  
  and ps.ToDate>=@FromDate  
  and ps.Emp_No>=@FromDealer  
  and ps.Emp_No<=@ToDealer  
  --and ps.Segment_Type=@SegmentType  
end  
  
--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------  
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')  
begin  
print 'TradingMode or ClientGrade'  
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)  
if @ClientGrade='ALL' set @ClientGrade='%'  
--  
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating  
From angelclient1 ac1,#PartyDetails ps  
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode  
and ac1.AngelClRating like @ClientGrade  
--  
delete #PartyDetails where isnull(EbrokingClient,'')=''  
--  
end  
-----------------------Update #PartyDetails as per report Wise option -------------------------------------  
--print '1.1:'+convert(varchar,getdate(),109)  
if @Wise='SUBBROKER'  
begin  
 update #PartyDetails set Emp_No=''  
end   
--else if @Wise='ZONE'  
--begin  
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''  
--end  
--else if @Wise='REGION'  
--begin  
--update #PartyDetails set Branch_cd='',Emp_No=''  
--end  
--else if @Wise='BRANCH'  
--begin  
--update #PartyDetails set Emp_No=''  
--end  
-----------------------Update FirstTrade date -------------------------------------  
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))  
begin  
 /*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then   
  ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)  
  from angelclient1 ac1 with(nolock),#PartyDetails ps  
  where ps.Party_Code=ac1.Party_Code*/   
   
 if(@SegmentType in('COMMODITY'))  
 begin  
  update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx   
  from angelclient1 ac1 with(nolock),#PartyDetails ps  
  where ps.Party_Code=ac1.Party_Code  
 end  
 else if(@SegmentType in('CURRENCY'))  
 begin  
  update #PartyDetails set FirstTrade= ac1.FirstTradeCurr   
  from angelclient1 ac1 with(nolock),#PartyDetails ps  
  where ps.Party_Code=ac1.Party_Code  
 end    
 else --if(@SegmentType in('CASH','DERIVATIVE') and other  
 begin  
  update #PartyDetails set FirstTrade= ac1.FirstTrade   
  from angelclient1 ac1 with(nolock),#PartyDetails ps   
  where ac1.Party_Code=ps.Party_Code  
 end  
end  
--------------------------Fetch Brokerage in case when required-------------------------  
  
/*  
  
Select top 10 * from bsecm_cli  
  
*/  
  
if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))  
begin  
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)  
/*print 'Segment'  
print @SegmentTypeFrom  
print @SegmentTypeTo  
print 'Eff Date'  
print @FromEffSaudaDate  
print @ToEffSaudaDate  
print 'Date'  
print @FromDate  
print @ToDate*/  
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE   
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */  
--  
  
insert into #BrokTurnOver  
  select ps.Party_Code,ps.Branch_cd,ps.Emp_No,   
  TotalTurnover = L.Overall_turnover,  
  Online_TurnOver=L.ebrok_TurnOver,  
  Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),  
  GrossRevenue=L.Overall_brok_earned,  
  GrossRevenue_Online=L.ebrok_brok_earned,  
  GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),  
  --NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),  
  NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,  
  NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,  
  --NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),  
  NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),  
  L.Sauda_date    
  from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),  
  --mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),  
  Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),  
  B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock)   
  where   
  EM.Segment_Type>=@SegmentTypeFrom and    
  EM.Segment_Type<=@SegmentTypeTo and  
  --EM.Segment_Type='ALL' and   
  --and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments  
  EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'    
  When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'     
  When L.Segment = 'ABLCM' Then 'BSECM'     
  When L.Segment = 'ACDLCM' Then 'NSECM'     
  When L.Segment = 'ACDLFO' Then 'NSEFO'     
  When L.Segment = 'ACPLMCD' Then 'MCD'    
  When L.Segment = 'ACDLNSX' Then 'NSX' End) and  
   --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise    
   ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise    
   and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date   
   and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date     -- Check for Sauda Date   
  --and TD.Sauda_date = L.Sauda_date     -- Check for Sauda Date   
  AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table  
  and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date  
  and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate   
  --and L.ExceptClient='Y'  
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)  
  
end  
  
  
  
--select top 10 * From tbl_Exchangemapping  
   
---------------------MAIN PAGE---------------------------------  
if @ReportType='MAIN'  
begin  
  
-----------------------------Fill MIS Table--------------------------------------------------------------------  
  insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,  
  Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,  
  DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,  
  OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)  
  select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,  
  Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,  
  DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',  
  OnlineTurnover=0,OfflineTurnover=0,Turnover=0,  
  OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0  
  from #PartyDetails    
  group by Branch_cd,Emp_No    
print '1.2:'+convert(varchar,getdate(),109)  
----------------------------------------Update Start Of Month Total Clients----------------------------------  
  update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth  
  from  
  (select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)   
  from #PartyDetails ps   
  where ps.FromDate<=@FromDate  
  and ps.ToDate>=@FromDate    
  group by ps.Branch_cd,ps.Emp_No  
  )A,#MIStable B  
  where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No   
--  
print '2:'+convert(varchar,getdate(),109)  
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------  
    
--  
print '3.1 '+convert(varchar,getdate(),109)  
--  
  
  
update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,  
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,  
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),  
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),  
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),  
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),  
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),  
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,  
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue  
--CONVERT(decimal(15,2),  
  from   
  (  
  select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),     
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),  
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),  
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),  
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)  
    
  from #BrokTurnOver b  
  group by b.Branch_cd,b.Emp_No  
  )A, #MIStable B  
  where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No   
----------------------Update NA-----------------------------  
--update #MIStable  
----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)  
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)  
  
--Comment by sandip  
--update #MIStable set ActivationRatio='NA'    
--where TotalClientsStartOfmonth<Tradedclients  
update #MIStable set AvgDailyActRatio='NA'    
where TotalClientsStartOfmonth<AvgTradedclients  
-----------------------------------------------Activation Ratio---------------------  
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money)   
 into #RegActiveClients  
 from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)  
 from #PartyDetails ps,Table_Date TD with(nolock)   
 where TD.sauda_date>=@FromDate   
 and TD.sauda_date<=@ToDate  
 and FromDate<=TD.sauda_date  
 and ToDate>TD.sauda_date  
 and TD.CmTradingDay = 'Y'          
 group by Sauda_date,Branch_cd,Emp_no)A   
 group by Branch_cd,Emp_no  
 --order by 1  
 --select * from #RegActiveClients  
--Activation main page  
  
--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays  
--else 0.00 end)  
--from #RegActiveClients A, #MIStable B  
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--  
--  
  
update #MIStable set   
DailyTradedClients_AR=A.DailyTradedClients  
from   
(select b.Branch_cd,b.Emp_No,  
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)  
   
  from #BrokTurnOver b,TABLE_DATE TD with(nolock)  
  where TD.CMTradingDay='Y'  
  and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)  
 group by b.Branch_cd,b.Emp_No  
)A, #MIStable B  
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No    
  
  
--select @DailyTradedClients_AR    
update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays  
else 0.00 end)  
from #RegActiveClients A, #MIStable B  
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--  
  
--select DailyTradedClients_AR,DailyTradeDays from #MIStable  
  
update #MIStable  
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)  
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)  
set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)  
  
  
---------------------------------------------------------Update AS ON CLIENTS----------------------------------  
print '3.2:'+convert(varchar,getdate(),109)  
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)  
begin  
  update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate  
  from   
  (  
  select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)  
  from #PartyDetails ps  
  where ps.FromDate<=@ToDate  
  and ps.ToDate>=@ToDate    
  group by ps.Branch_cd,ps.Emp_No  
  )A,#MIStable B  
  where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No   
  --------------------------------Calculate Productivity--------------------------------------------------------------  
  if @Wise='DEALER'  
  begin  
   Declare @Act_Days int,@H_days int  
   set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                                
   set @H_days = ( select  count(distinct holidaydate)  from [196.1.115.207].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                         
      where holidaydate >= @FromDate and holidaydate <= @ToDate )     
   print @TradeDays  
   print @Act_Days  
   print @H_days  
   --if(@SegmentType='Currency')  
   --begin  
    --Fetch Emploee with CTC     
      
    select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',  
    RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))  
    into #ProdForCurr from B2B_AngelHarmony ah with(nolock)  
    where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and  
     ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)      
      
    
    --Update productivity for Employee  
    print 'productivity'  
    print @TradeDays  
    print (@Act_Days-@H_days)  
    update #MIStable set   
    Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0    
        then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days)))))   
        else '0.00' end)  
    from #MIStable mis,#ProdForCurr ah  
    where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'  
      
      
    /*--Print for testing  
    select * from #ProdForCurr  
    --Print RM  
    select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,  
    Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage  
    from #MIStable mis,#ProdForCurr ah  
    where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'  
    */  
   --End    
     
  end  
  --------------------------------End Calculate Productivity--------------------------------------------------------------  
end  
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------  
print '4:'+convert(varchar,getdate(),109)  
--  
  select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded  
  from #PartyDetails ps  
  where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate     
  and ps.FirstTrade<=@ToDate  
  --Delete traded clients  
  delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)  
--   
print '4.1:'+convert(varchar,getdate(),109)  
  update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth  
  from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)  
  from #nottraded ps  
  group by ps.Branch_cd,ps.Emp_No  
  )A,#MIStable B  
   where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No   
--  
drop table #nottraded  
--  
print '5:'+convert(varchar,getdate(),109)  
    
   update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate  
   from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)  
   from #PartyDetails ps  
   where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate   
   and ps.FirstTrade>@ToDate  
   group by ps.Branch_cd,ps.Emp_No  
   )A,#MIStable B  
    where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No   
--  
print '6:'+convert(varchar,getdate(),109)  
---------------------------------Update Client Visit Pending-------------------------  
/*update #MIStable set ClientVisitPending=A.CVPcount  
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp  
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No  
)A,#MIStable B  
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No and A.zone=B.Zone and A.Region=B.Region  
print '7:'+convert(varchar,getdate(),109)*/  
------------------------------DROP #PartyDetails---  
drop table #PartyDetails  
------------------------------DISPLAY------------------------------------------------  
print 'Wise: '  
print @Wise  
if @Wise='DEALER'  
begin  
  print 'DEALER'  
  update #MIStable set Emp_Name=ah.EMP_NAME  
     from #MIStable mis,B2B_AngelHarmony ah with(nolock)  
     where mis.Emp_No=ah.EMP_NO  
  update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'     
  select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,  
  OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),  
  OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),  
  OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),  
  NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),  
  Productivity,  
  --DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),  
  DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,  
  ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),  
  AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate  
  from #MIStable mis  
  order by 1,2,3  
end  
else  
begin  
  print 'SUBBROKER'  
  select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,  
  OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),  
  OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),  
  OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),  
  NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),  
  Productivity,  
  --DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),  
  DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,  
  ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),  
  AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate  
  from #MIStable mis  
  order by 1,2  
end  
--TOTAL  
--if @TotalFlag <> 'Y'   
if(isnull(@TotalFlag,'') in ('','N'))  
begin  
  
--select    
--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),  
--Tradedclients=isnull(sum(Tradedclients),0),  
--  ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0   
--  --then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays   
--  then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays   
--  else 0.00 end)),  
--  OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),  
--  OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),  
--  OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),  
--  NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),  
--  ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),  
--  --DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))  
--  DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)  
--from #RegActiveClients A, #MIStable B  
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No  
  
select    
TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),  
Tradedclients=isnull(sum(Tradedclients),0),  
  ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0   
  --then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays   
  then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays   
  else 0.00 end)),  
  OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),  
  OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),  
  OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),  
  NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),  
  ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),  
  --DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))  
  DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end  
from #MIStable B left outer join  #RegActiveClients A  on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No  
  
--group by DailyTradeDays  
print 'End:'+convert(varchar,getdate(),109)  
end   
  
END  
---------------------MAIN PAGE END---------------------------------------------------  
---------------------DRILL PAGE START---------------------------------------------------  
else if @ReportType='DRILL'  
begin  
---------------------Declare drill page-------------------------------------------------  
create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),  
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),  
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,  
LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))  
  
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)  
--  
if @DrillFlag='TotalAsOn'  
begin  
print 'Drill 1:'+convert(varchar,getdate(),109)  
  
      
  --select * from @rto_Data  
     
  insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,  
  DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)  
  select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,  
  [Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',  
  TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,  
  LastTradeDate=left(ac1.LastTrade,11)  
  from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code  
  left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code  
  where ps.FromDate<=@ToDate  
  and ps.ToDate>=@ToDate      
  
print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)  
    
  if(@UserStatusId='SBDEALER')  
  begin  
   declare @rto_Data table  
   (  
   Zone varchar(20),  
   Region varchar(20),  
   branch_cd varchar(20),  
   sub_broker varchar(20),  
   Sub_brokerName varchar(200),  
   party_code varchar(20),  
   Short_name varchar(100),  
   TotalTO money,  
   OPTNoOfLots money,  
   NoOfLotsGold bigint,  
   NoOfLotsSilver bigint,  
   NoOfLotsCopper bigint  ,  
   NoOfLotsCrude bigint,  
   NoOfLotsComm bigint,  
   TargetNoOfLotsGold bigint,  
   TargetNoOfLotsSilver bigint,  
   TargetNoOfLotsCopper bigint,  
   TargetNoOfLotsCrude bigint  
  
   )   
     
   insert into @rto_Data  
   --exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_newfo]   
   exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_new]   
   @Emp_no=@UserEmp_No,  
   @Zone='',  
   @Region='',  
   @Branch='',  
   @Exec=@Dealer,  
   @FromTime='09:00 AM',  
   @ToTime='11:59 PM',  
   @MainDrill='DRILL',  
   @WiseReport='SBDEALER',  
   @seg='ALL',  
   @B2CStatus='B2B',  
   @MimStatusID='SBDEALER',  
   @SB='',  
   @RoundValue='1',  
   @DownloadCSVFlag='Y'  
  
     
   update #drillPartyDetails set TotalTo=rto.TotalTo  
   from #drillPartyDetails drill, @rto_Data rto  
   where drill.Party_Code=rto.party_code   
  end  
    
     
  --  
end  
else if @DrillFlag='TotalStartOfMonth'  
begin  
  insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,  
  DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)  
  select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,  
  [Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',  
  TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,  
  LastTradeDate=left(ac1.LastTrade,11)  
  from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code  
  left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code  
  where ps.FromDate<=@FromDate  
  and ps.ToDate>=@FromDate   
end  
else if @DrillFlag='NotTradedAsOn'  
begin  
    insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,  
    DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)  
    select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,  
    [Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',  
    TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,  
    LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')  
      
    from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code  
    left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code  
    where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate     
    and ps.FirstTrade>@ToDate   
end  
else if @DrillFlag='NotTradedForMonth'  
begin  
    insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,  
    DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)  
    select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,  
    [Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',  
    TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,  
    LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')  
    from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code  
    left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code  
    where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate      
    and ps.FirstTrade<=@ToDate    
  --  
  delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)   
  --  
end  
else if @DrillFlag='Traded'  
begin  
  --Insert Traded Clients  
  insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,  
  DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)  
  select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,  
  [Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',  
  TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,  
  LastTradeDate=left(ac1.LastTrade,11)  
  from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code  
   inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code  
  left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code  
    
    
end  
else if @DrillFlag='BROK'  
begin    
  Declare @emp_name varchar(100)    
  set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')  
  select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,  
  br.Party_Code,ac1.Long_Name,  
  --Turnover =sum(TotalTurnover),  
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)),   
  --GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),     
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),          
        --NetRevnue =sum(NetRevenue),  
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),  
        TotalTradedDays=count(distinct Sauda_date)    
  from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code  
  group by br.Branch_cd,br.Party_Code,ac1.Long_Name   
    
  --Total    
  select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)),       
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),          
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),  
        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver  
  return  
end  
else if @DrillFlag='ACTIVECLI'  
begin    
   
 select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),  
 [Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100  
 into #FinalActiveCli  
 from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)  
 from #PartyDetails ps,Table_Date TD with(nolock)   
 where TD.sauda_date>=@FromDate   
 and TD.sauda_date<=@ToDate  
 and FromDate<=TD.sauda_date  
 and ToDate>TD.sauda_date  
 and TD.CmTradingDay = 'Y'          
 group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join  
 (  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)  
  from #BrokTurnOver b  
 group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and  A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no  
 --where --A.Sauda_date=B.Sauda_date and  A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no  
 order by 1,2,3  
 --Display  
 --select * from #FinalActiveCli  
 select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli  
 --Total Row  
 select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),  
 [Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100  
  from #FinalActiveCli  
   
return  
end  
---------------------Common Script for DRILL PAGE ---------------------------------------------------  
   
print 'Drill 3:'+convert(varchar,getdate(),109)    
  -- Update Portfolio i.e. Holding value  
  update #drillPartyDetails                                                               
  set PortfolioInfo=isnull(H.TotalHold,0)              
  from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [196.1.115.207].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                     
  on ps.party_code = H.party_code   
print 'Drill 4:'+convert(varchar,getdate(),109)    
  --Update Ledger Value  
  select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger  
  from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [196.1.115.207].Angelcs.dbo.View_LedgerInfo L with(nolock)  
  on ps.party_code = L.party_code   
  --  
  update #drillPartyDetails                                                               
  set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)  
  from #drillPartyDetails ps left outer join #totalLedger L  
  on ps.party_code = L.party_code   
  --  
  drop table #totalLedger    
print 'Drill 5:'+convert(varchar,getdate(),109)     
  --Update Current Dealer  
  update #drillPartyDetails set DealerCode=cps.Emp_No     
  from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )  
  where --cps.Segment_Type=@SegmentType and   
  /*EM.Segment_Type>=@SegmentTypeFrom and    
  EM.Segment_Type<=@SegmentTypeTo and*/  
  ps.Party_Code =cps.Party_Code and  
  cps.Valid='Y' and cps.CommRank='1'  
  --Set Row color as per BRS point 4.3.4 & 4.3.5  
print 'Drill 6:'+convert(varchar,getdate(),109)   
  update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)   
  ,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)  
  --,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'  
  --when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)  
  ,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)  
  --    
print 'Drill End:'+convert(varchar,getdate(),109)    
  select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',  
  SB=Branch_cd,Party_Code,Client_Name,Emp_No,  
  Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),  
  ClientGrade,[Profile],Sub_Profile,  
  --ActiveFrom,  
  ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),  
  DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)  
  ,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),  
  PureRisk=convert(decimal(15,2),PureRisk),  
  ProjectedRisk=convert(decimal(15,2),ProjectedRisk),  
  --LastTradeDate,  
  LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,  
  RowColor,LedgerColor,  
  TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)  
    
   from #drillPartyDetails s  
   order by SrNo  
   --Total  
   select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),  
   TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))  
    from #drillPartyDetails  
-------------------  
end  
---------------------DRILL PAGE END---------------------------------------------------  
END  
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_ADTest
-- --------------------------------------------------

CREATE procedure [dbo].[SBB2B_MIS_ADTest]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20),       --SUBBROKER/DEALER
 @ReportType varchar(20), --MAIN/DRILL
 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 @TotalFlag varchar(2) = null
 as
 BEGIN
/*
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='jan  1 2013',@Wise='Dealer',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'
*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------
/*if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
	 
	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 
	 where Emp_No=@UserEmp_No                       */
	 --Select distinct  P.branch_cd,A.zone,A.region                                  
	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        
	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin    
        /*declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag*/
		insert into @tempbranch 
		select distinct Branch_cd=sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@UserEmp_No
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@UserEmp_No
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    
	/*insert into @tempbranch                                                                 
	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   
	 AngelHarmonyEmployee b--B2B_Harmony b 
	 on a.sbtag=b.hod*/
end

/*if @UserStatusId='SBCHILD'                           
begin
	insert into @tempbranch                                                                 
	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    
	where   HOD=@UserEmp_No	
	select * from @tempbranch	
end
*/
*/


Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker
 

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 --Declare  @MIStable table  
 create table #MIStable                                                         
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		and ps.Emp_No>=@FromDealer
		and ps.Emp_No<=@ToDealer
		--and ps.Segment_Type=@SegmentType
end

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
--else if @Wise='ZONE'
--begin
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''
--end
--else if @Wise='REGION'
--begin
--update #PartyDetails set Branch_cd='',Emp_No=''
--end
--else if @Wise='BRANCH'
--begin
--update #PartyDetails set Emp_No=''
--end
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin
	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 
		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code*/	
	
	if(@SegmentType in('COMMODITY'))
	begin
		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end
	else if(@SegmentType in('CURRENCY'))
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end		
	else --if(@SegmentType in('CASH','DERIVATIVE') and other
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTrade 
		from angelclient1 ac1 with(nolock),#PartyDetails ps 
		where ac1.Party_Code=ps.Party_Code
	end
end
--------------------------Fetch Brokerage in case when required-------------------------

/*

Select top 10 * from bsecm_cli

*/

if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

insert into #BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		Online_TurnOver=L.ebrok_TurnOver,
		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=L.ebrok_brok_earned,
		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,
		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,
		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),
		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		--and L.ExceptClient='Y'
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end



--select top 10 * From tbl_Exchangemapping
 
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin

-----------------------------Fill MIS Table--------------------------------------------------------------------
		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,
		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,
		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,
		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)
		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,
		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,
		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',
		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,
		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0
		from #PartyDetails		
		group by Branch_cd,Emp_No		
print '1.2:'+convert(varchar,getdate(),109)
----------------------------------------Update Start Of Month Total Clients----------------------------------
		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth
		from
		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	
		from #PartyDetails ps 
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
print '2:'+convert(varchar,getdate(),109)
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------
		
--
print '3.1 '+convert(varchar,getdate(),109)
--


update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue
--CONVERT(decimal(15,2),
		from 
		(
		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)
  
		from #BrokTurnOver b
		group by b.Branch_cd,b.Emp_No
		)A,	#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
----------------------Update NA-----------------------------
--update #MIStable
----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

--Comment by sandip
--update #MIStable set ActivationRatio='NA'		
--where TotalClientsStartOfmonth<Tradedclients
update #MIStable set AvgDailyActRatio='NA'		
where TotalClientsStartOfmonth<AvgTradedclients
-----------------------------------------------Activation Ratio---------------------
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 
	into #RegActiveClients
	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by Sauda_date,Branch_cd,Emp_no)A 
	group by Branch_cd,Emp_no
	--order by 1
	--select * from #RegActiveClients
--Activation main page

--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays
--else 0.00 end)
--from #RegActiveClients A,	#MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--
--

update #MIStable set 
DailyTradedClients_AR=A.DailyTradedClients
from 
(select b.Branch_cd,b.Emp_No,
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
 
 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)
		where TD.CMTradingDay='Y'
		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
	group by b.Branch_cd,b.Emp_No
)A,	#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		


--select @DailyTradedClients_AR		
update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays
else 0.00 end)
from #RegActiveClients A,	#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--select DailyTradedClients_AR,DailyTradeDays from #MIStable

update #MIStable
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)
set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)


---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)
begin
		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate
		from 
		(
		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
		from #PartyDetails ps
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			Declare @Act_Days int,@H_days int
			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              
			set @H_days = ( select  count(distinct holidaydate)  from MIMANSA.crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= @FromDate and holidaydate <= @ToDate )   
			print @TradeDays
			print @Act_Days
			print @H_days
			--if(@SegmentType='Currency')
			--begin
				--Fetch Emploee with CTC			
				
				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',
				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))
				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)
				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and
				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				
				
		
				--Update productivity for Employee
				print 'productivity'
				print @TradeDays
				print (@Act_Days-@H_days)
				update #MIStable set 
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 
								else '0.00' end)
				from #MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				
				
				/*--Print for testing
				select * from #ProdForCurr
				--Print RM
				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,
				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage
				from #MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'
				*/
			--End		
			
		end
		--------------------------------End Calculate Productivity--------------------------------------------------------------
end
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------
print '4:'+convert(varchar,getdate(),109)
--
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded
		from #PartyDetails ps
		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
		and ps.FirstTrade<=@ToDate
		--Delete traded clients
		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)
--	
print '4.1:'+convert(varchar,getdate(),109)
		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth
		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)
		from #nottraded ps
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
drop table #nottraded
--
print '5:'+convert(varchar,getdate(),109)
		
			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate
			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)
			from #PartyDetails ps
			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	
			and ps.FirstTrade>@ToDate
			group by ps.Branch_cd,ps.Emp_No
			)A,#MIStable B
				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	
--
print '6:'+convert(varchar,getdate(),109)
---------------------------------Update Client Visit Pending-------------------------
/*update #MIStable set ClientVisitPending=A.CVPcount
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No
)A,#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region
print '7:'+convert(varchar,getdate(),109)*/
------------------------------DROP #PartyDetails---
drop table #PartyDetails
------------------------------DISPLAY------------------------------------------------
print 'Wise: '
print @Wise
if @Wise='DEALER'
begin
		print 'DEALER'
		update #MIStable set Emp_Name=ah.EMP_NAME
					from #MIStable mis,B2B_AngelHarmony ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2,3
end
else
begin
		print 'SUBBROKER'
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2
end
--TOTAL
--if @TotalFlag <> 'Y' 
if(isnull(@TotalFlag,'') in ('','N'))
begin

--select  
--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
--Tradedclients=isnull(sum(Tradedclients),0),
--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
--		else 0.00 end)),
--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)
--from #RegActiveClients A,	#MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

select  
TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
Tradedclients=isnull(sum(Tradedclients),0),
		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
		else 0.00 end)),
		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end
from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

--group by DailyTradeDays
print 'End:'+convert(varchar,getdate(),109)
end 

END
---------------------MAIN PAGE END---------------------------------------------------
---------------------DRILL PAGE START---------------------------------------------------
else if @ReportType='DRILL'
begin
---------------------Declare drill page-------------------------------------------------
create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,
LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)
--
if @DrillFlag='TotalAsOn'
begin
print 'Drill 1:'+convert(varchar,getdate(),109)

	   
		--select * from @rto_Data
			
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate				

print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)
		
		if(@UserStatusId='SBDEALER')
		begin
			declare @rto_Data table
			(
			Zone varchar(20),
			Region varchar(20),
			branch_cd varchar(20),
			sub_broker varchar(20),
			Sub_brokerName varchar(200),
			party_code varchar(20),
			Short_name varchar(100),
			TotalTO money,
			OPTNoOfLots money,
			NoOfLotsGold bigint,
			NoOfLotsSilver bigint,
			NoOfLotsCopper bigint  ,
			NoOfLotsCrude bigint,
			NoOfLotsComm bigint,
			TargetNoOfLotsGold bigint,
			TargetNoOfLotsSilver bigint,
			TargetNoOfLotsCopper bigint,
			TargetNoOfLotsCrude bigint

			)	
			
			insert into @rto_Data
			--exec MIMANSA.CRM.dbo.[GetTurnoverfortime_newfo] 
			exec MIMANSA.CRM.dbo.[GetTurnoverfortime_new] 
			@Emp_no=@UserEmp_No,
			@Zone='',
			@Region='',
			@Branch='',
			@Exec=@Dealer,
			@FromTime='09:00 AM',
			@ToTime='11:59 PM',
			@MainDrill='DRILL',
			@WiseReport='SBDEALER',
			@seg='ALL',
			@B2CStatus='B2B',
			@MimStatusID='SBDEALER',
			@SB='',
			@RoundValue='1',
			@DownloadCSVFlag='Y'

			
			update #drillPartyDetails set TotalTo=rto.TotalTo
			from #drillPartyDetails drill, @rto_Data rto
			where drill.Party_Code=rto.party_code	
		end
		
			
		--
end
else if @DrillFlag='TotalStartOfMonth'
begin
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate	
end
else if @DrillFlag='NotTradedAsOn'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
				and ps.FirstTrade>@ToDate	
end
else if @DrillFlag='NotTradedForMonth'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				
				and ps.FirstTrade<=@ToDate		
		--
		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	
		--
end
else if @DrillFlag='Traded'
begin
		--Insert Traded Clients
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code
		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		
		
end
else if @DrillFlag='BROK'
begin		
		Declare @emp_name varchar(100)		
		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')
		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,
		br.Party_Code,ac1.Long_Name,
		--Turnover =sum(TotalTurnover),
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 
		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        --NetRevnue =sum(NetRevenue),
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Sauda_date)  
		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code
		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	
		
		--Total		
		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver
		return
end
else if @DrillFlag='ACTIVECLI'
begin		
	
	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),
	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100
	into #FinalActiveCli
	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join
	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)
	 from #BrokTurnOver b
	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	order by 1,2,3
	--Display
	--select * from #FinalActiveCli
	select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli
	--Total Row
	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),
	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100
	 from #FinalActiveCli
	
return
end
---------------------Common Script for DRILL PAGE ---------------------------------------------------
	
print 'Drill 3:'+convert(varchar,getdate(),109)		
		-- Update Portfolio i.e. Holding value
		update #drillPartyDetails                                                             
		set PortfolioInfo=isnull(H.TotalHold,0)            
		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  MIMANSA.Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   
		on ps.party_code = H.party_code 
print 'Drill 4:'+convert(varchar,getdate(),109)		
		--Update Ledger Value
		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger
		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- MIMANSA.Angelcs.dbo.View_LedgerInfo L with(nolock)
		on ps.party_code = L.party_code 
		--
		update #drillPartyDetails                                                             
		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)
		from #drillPartyDetails ps left outer join #totalLedger L
		on ps.party_code = L.party_code 
		--
		drop table #totalLedger		
print 'Drill 5:'+convert(varchar,getdate(),109)			
		--Update Current Dealer
		update #drillPartyDetails set DealerCode=cps.Emp_No			
		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )
		where --cps.Segment_Type=@SegmentType and 
		/*EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and*/
		ps.Party_Code =cps.Party_Code and
		cps.Valid='Y' and cps.CommRank='1'
		--Set Row color as per BRS point 4.3.4 & 4.3.5
print 'Drill 6:'+convert(varchar,getdate(),109)	
		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	
		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)
		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'
		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)
		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)
		--		
print 'Drill End:'+convert(varchar,getdate(),109)		
		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',
		SB=Branch_cd,Party_Code,Client_Name,Emp_No,
		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),
		ClientGrade,[Profile],Sub_Profile,
		--ActiveFrom,
		ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),
		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)
		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),
		PureRisk=convert(decimal(15,2),PureRisk),
		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),
		--LastTradeDate,
		LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,
		RowColor,LedgerColor,
		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)
		
		 from #drillPartyDetails s
		 order by SrNo
		 --Total
		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),
		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))
		  from #drillPartyDetails
-------------------
end
---------------------DRILL PAGE END---------------------------------------------------
END
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_Backup(14May2015)
-- --------------------------------------------------

CREATE procedure [dbo].[SBB2B_MIS_Backup(14May2015)]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20),       --SUBBROKER/DEALER
 @ReportType varchar(20), --MAIN/DRILL
 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 @TotalFlag varchar(2) = null
 as
 BEGIN
/*
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='jan  1 2013',@Wise='Dealer',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'
*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------
/*if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
	 
	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 
	 where Emp_No=@UserEmp_No                       */
	 --Select distinct  P.branch_cd,A.zone,A.region                                  
	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        
	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin    
        /*declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag*/
		insert into @tempbranch 
		select distinct Branch_cd=sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@UserEmp_No
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@UserEmp_No
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    
	/*insert into @tempbranch                                                                 
	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   
	 AngelHarmonyEmployee b--B2B_Harmony b 
	 on a.sbtag=b.hod*/
end

/*if @UserStatusId='SBCHILD'                           
begin
	insert into @tempbranch                                                                 
	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    
	where   HOD=@UserEmp_No	
	select * from @tempbranch	
end
*/
*/


Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker
 

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 --Declare  @MIStable table  
 create table #MIStable                                                         
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		and ps.Emp_No>=@FromDealer
		and ps.Emp_No<=@ToDealer
		--and ps.Segment_Type=@SegmentType
end

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
--else if @Wise='ZONE'
--begin
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''
--end
--else if @Wise='REGION'
--begin
--update #PartyDetails set Branch_cd='',Emp_No=''
--end
--else if @Wise='BRANCH'
--begin
--update #PartyDetails set Emp_No=''
--end
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin
	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 
		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code*/	
	
	if(@SegmentType in('COMMODITY'))
	begin
		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end
	else if(@SegmentType in('CURRENCY'))
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end		
	else --if(@SegmentType in('CASH','DERIVATIVE') and other
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTrade 
		from angelclient1 ac1 with(nolock),#PartyDetails ps 
		where ac1.Party_Code=ps.Party_Code
	end
end
--------------------------Fetch Brokerage in case when required-------------------------

/*

Select top 10 * from bsecm_cli

*/

if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

insert into #BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		Online_TurnOver=L.ebrok_TurnOver,
		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=L.ebrok_brok_earned,
		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,
		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,
		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),
		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		--and L.ExceptClient='Y'
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end



--select top 10 * From tbl_Exchangemapping
 
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin

-----------------------------Fill MIS Table--------------------------------------------------------------------
		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,
		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,
		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,
		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)
		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,
		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,
		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',
		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,
		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0
		from #PartyDetails		
		group by Branch_cd,Emp_No		
print '1.2:'+convert(varchar,getdate(),109)
----------------------------------------Update Start Of Month Total Clients----------------------------------
		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth
		from
		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	
		from #PartyDetails ps 
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
print '2:'+convert(varchar,getdate(),109)
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------
		
--
print '3.1 '+convert(varchar,getdate(),109)
--
update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue
--CONVERT(decimal(15,2),
		from 
		(
		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)
  
		from #BrokTurnOver b
		group by b.Branch_cd,b.Emp_No
		)A,	#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
----------------------Update NA-----------------------------
--update #MIStable
----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

--Comment by sandip
--update #MIStable set ActivationRatio='NA'		
--where TotalClientsStartOfmonth<Tradedclients
update #MIStable set AvgDailyActRatio='NA'		
where TotalClientsStartOfmonth<AvgTradedclients
-----------------------------------------------Activation Ratio---------------------
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 
	into #RegActiveClients
	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by Sauda_date,Branch_cd,Emp_no)A 
	group by Branch_cd,Emp_no
	--order by 1
	--select * from #RegActiveClients
--Activation main page

--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays
--else 0.00 end)
--from #RegActiveClients A,	#MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--
--

update #MIStable set 
DailyTradedClients_AR=A.DailyTradedClients
from 
(select b.Branch_cd,b.Emp_No,
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
 
 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)
		where TD.CMTradingDay='Y'
		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
	group by b.Branch_cd,b.Emp_No
)A,	#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		


--select @DailyTradedClients_AR		
update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays
else 0.00 end)
from #RegActiveClients A,	#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--select DailyTradedClients_AR,DailyTradeDays from #MIStable

update #MIStable
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)
set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)


---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)
begin
		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate
		from 
		(
		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
		from #PartyDetails ps
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			Declare @Act_Days int,@H_days int
			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              
			set @H_days = ( select  count(distinct holidaydate)  from [196.1.115.207].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= @FromDate and holidaydate <= @ToDate )   
			print @TradeDays
			print @Act_Days
			print @H_days
			--if(@SegmentType='Currency')
			--begin
				--Fetch Emploee with CTC			
				
				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',
				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))
				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)
				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and
				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				
				
		
				--Update productivity for Employee
				print 'productivity'
				print @TradeDays
				print (@Act_Days-@H_days)
				update #MIStable set 
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 
								else '0.00' end)
				from #MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				
				
				/*--Print for testing
				select * from #ProdForCurr
				--Print RM
				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,
				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage
				from #MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'
				*/
			--End		
			
		end
		--------------------------------End Calculate Productivity--------------------------------------------------------------
end
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------
print '4:'+convert(varchar,getdate(),109)
--
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded
		from #PartyDetails ps
		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
		and ps.FirstTrade<=@ToDate
		--Delete traded clients
		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)
--	
print '4.1:'+convert(varchar,getdate(),109)
		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth
		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)
		from #nottraded ps
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
drop table #nottraded
--
print '5:'+convert(varchar,getdate(),109)
		
			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate
			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)
			from #PartyDetails ps
			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	
			and ps.FirstTrade>@ToDate
			group by ps.Branch_cd,ps.Emp_No
			)A,#MIStable B
				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	
--
print '6:'+convert(varchar,getdate(),109)
---------------------------------Update Client Visit Pending-------------------------
/*update #MIStable set ClientVisitPending=A.CVPcount
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No
)A,#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region
print '7:'+convert(varchar,getdate(),109)*/
------------------------------DROP #PartyDetails---
drop table #PartyDetails
------------------------------DISPLAY------------------------------------------------
print 'Wise: '
print @Wise
if @Wise='DEALER'
begin
		print 'DEALER'
		update #MIStable set Emp_Name=ah.EMP_NAME
					from #MIStable mis,B2B_AngelHarmony ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2,3
end
else
begin
		print 'SUBBROKER'
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2
end
--TOTAL
--if @TotalFlag <> 'Y' 
if(isnull(@TotalFlag,'') in ('','N'))
begin

--select  
--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
--Tradedclients=isnull(sum(Tradedclients),0),
--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
--		else 0.00 end)),
--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)
--from #RegActiveClients A,	#MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

select  
TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
Tradedclients=isnull(sum(Tradedclients),0),
		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
		else 0.00 end)),
		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end
from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

--group by DailyTradeDays
print 'End:'+convert(varchar,getdate(),109)
end 

END
---------------------MAIN PAGE END---------------------------------------------------
---------------------DRILL PAGE START---------------------------------------------------
else if @ReportType='DRILL'
begin
---------------------Declare drill page-------------------------------------------------
create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,
LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)
--
if @DrillFlag='TotalAsOn'
begin
print 'Drill 1:'+convert(varchar,getdate(),109)

	   
		--select * from @rto_Data
			
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate				

print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)
		
		if(@UserStatusId='SBDEALER')
		begin
			declare @rto_Data table
			(
			Zone varchar(20),
			Region varchar(20),
			branch_cd varchar(20),
			sub_broker varchar(20),
			Sub_brokerName varchar(200),
			party_code varchar(20),
			Short_name varchar(100),
			TotalTO money,
			OPTNoOfLots money,
			NoOfLotsGold bigint,
			NoOfLotsSilver bigint,
			NoOfLotsCopper bigint  ,
			NoOfLotsCrude bigint,
			NoOfLotsComm bigint,
			TargetNoOfLotsGold bigint,
			TargetNoOfLotsSilver bigint,
			TargetNoOfLotsCopper bigint,
			TargetNoOfLotsCrude bigint

			)	
			
			insert into @rto_Data
			--exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_newfo] 
			exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_new] 
			@Emp_no=@UserEmp_No,
			@Zone='',
			@Region='',
			@Branch='',
			@Exec=@Dealer,
			@FromTime='09:00 AM',
			@ToTime='11:59 PM',
			@MainDrill='DRILL',
			@WiseReport='SBDEALER',
			@seg='ALL',
			@B2CStatus='B2B',
			@MimStatusID='SBDEALER',
			@SB='',
			@RoundValue='1',
			@DownloadCSVFlag='Y'

			
			update #drillPartyDetails set TotalTo=rto.TotalTo
			from #drillPartyDetails drill, @rto_Data rto
			where drill.Party_Code=rto.party_code	
		end
		
			
		--
end
else if @DrillFlag='TotalStartOfMonth'
begin
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate	
end
else if @DrillFlag='NotTradedAsOn'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
				and ps.FirstTrade>@ToDate	
end
else if @DrillFlag='NotTradedForMonth'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				
				and ps.FirstTrade<=@ToDate		
		--
		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	
		--
end
else if @DrillFlag='Traded'
begin
		--Insert Traded Clients
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code
		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		
		
end
else if @DrillFlag='BROK'
begin		
		Declare @emp_name varchar(100)		
		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')
		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,
		br.Party_Code,ac1.Long_Name,
		--Turnover =sum(TotalTurnover),
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 
		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        --NetRevnue =sum(NetRevenue),
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Sauda_date)  
		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code
		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	
		
		--Total		
		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver
		return
end
else if @DrillFlag='ACTIVECLI'
begin		
	
	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),
	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100
	into #FinalActiveCli
	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join
	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)
	 from #BrokTurnOver b
	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	order by 1,2,3
	--Display
	select * from #FinalActiveCli
	--Total Row
	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),
	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100
	 from #FinalActiveCli
	
return
end
---------------------Common Script for DRILL PAGE ---------------------------------------------------
	
print 'Drill 3:'+convert(varchar,getdate(),109)		
		-- Update Portfolio i.e. Holding value
		update #drillPartyDetails                                                             
		set PortfolioInfo=isnull(H.TotalHold,0)            
		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [196.1.115.207].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   
		on ps.party_code = H.party_code 
print 'Drill 4:'+convert(varchar,getdate(),109)		
		--Update Ledger Value
		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger
		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [196.1.115.207].Angelcs.dbo.View_LedgerInfo L with(nolock)
		on ps.party_code = L.party_code 
		--
		update #drillPartyDetails                                                             
		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)
		from #drillPartyDetails ps left outer join #totalLedger L
		on ps.party_code = L.party_code 
		--
		drop table #totalLedger		
print 'Drill 5:'+convert(varchar,getdate(),109)			
		--Update Current Dealer
		update #drillPartyDetails set DealerCode=cps.Emp_No			
		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )
		where --cps.Segment_Type=@SegmentType and 
		/*EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and*/
		ps.Party_Code =cps.Party_Code and
		cps.Valid='Y' and cps.CommRank='1'
		--Set Row color as per BRS point 4.3.4 & 4.3.5
print 'Drill 6:'+convert(varchar,getdate(),109)	
		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	
		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)
		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'
		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)
		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)
		--		
print 'Drill End:'+convert(varchar,getdate(),109)		
		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',
		SB=Branch_cd,Party_Code,Client_Name,Emp_No,
		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),
		ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)
		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),
		PureRisk=convert(decimal(15,2),PureRisk),
		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),LastTradeDate,RowColor,LedgerColor,
		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)
		
		 from #drillPartyDetails s
		 order by SrNo
		 --Total
		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),
		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))
		  from #drillPartyDetails
-------------------
end
---------------------DRILL PAGE END---------------------------------------------------
END
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_bak
-- --------------------------------------------------

CREATE procedure [dbo].[SBB2B_MIS_bak]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20),       --SUBBROKER/DEALER
 @ReportType varchar(20), --MAIN/DRILL
 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 @TotalFlag varchar(2) = null
 as
 BEGIN
/*
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='jan  1 2013',@Wise='Dealer',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'
*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------
/*if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
	 
	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 
	 where Emp_No=@UserEmp_No                       */
	 --Select distinct  P.branch_cd,A.zone,A.region                                  
	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        
	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin    
        /*declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag*/
		insert into @tempbranch 
		select distinct Branch_cd=sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@UserEmp_No
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@UserEmp_No
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    
	/*insert into @tempbranch                                                                 
	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   
	 AngelHarmonyEmployee b--B2B_Harmony b 
	 on a.sbtag=b.hod*/
end

/*if @UserStatusId='SBCHILD'                           
begin
	insert into @tempbranch                                                                 
	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    
	where   HOD=@UserEmp_No	
	select * from @tempbranch	
end
*/
*/


Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker
 

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 Declare  @MIStable table                                                          
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		and ps.Emp_No>=@FromDealer
		and ps.Emp_No<=@ToDealer
		--and ps.Segment_Type=@SegmentType
end

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
--else if @Wise='ZONE'
--begin
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''
--end
--else if @Wise='REGION'
--begin
--update #PartyDetails set Branch_cd='',Emp_No=''
--end
--else if @Wise='BRANCH'
--begin
--update #PartyDetails set Emp_No=''
--end
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin
	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 
		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code*/	
	
	if(@SegmentType in('COMMODITY'))
	begin
		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end
	else if(@SegmentType in('CURRENCY'))
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end		
	else --if(@SegmentType in('CASH','DERIVATIVE') and other
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTrade 
		from angelclient1 ac1 with(nolock),#PartyDetails ps 
		where ac1.Party_Code=ps.Party_Code
	end
end
--------------------------Fetch Brokerage in case when required-------------------------

/*

Select top 10 * from bsecm_cli

*/

if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

insert into #BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		Online_TurnOver=L.ebrok_TurnOver,
		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=L.ebrok_brok_earned,
		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),
		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		--and L.ExceptClient='Y'
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end



--select top 10 * From tbl_Exchangemapping
 
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin

-----------------------------Fill MIS Table--------------------------------------------------------------------
		insert into @MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,
		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,
		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,
		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)
		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,
		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,
		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',
		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,
		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0
		from #PartyDetails		
		group by Branch_cd,Emp_No		
print '1.2:'+convert(varchar,getdate(),109)
----------------------------------------Update Start Of Month Total Clients----------------------------------
		update @MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth
		from
		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	
		from #PartyDetails ps 
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
print '2:'+convert(varchar,getdate(),109)
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------
		
--
print '3.1 '+convert(varchar,getdate(),109)
--
update @MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue
--CONVERT(decimal(15,2),
		from 
		(
		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)
  
		from #BrokTurnOver b
		group by b.Branch_cd,b.Emp_No
		)A,	@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
----------------------Update NA-----------------------------
--update @MIStable
----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

--Comment by sandip
--update @MIStable set ActivationRatio='NA'		
--where TotalClientsStartOfmonth<Tradedclients
update @MIStable set AvgDailyActRatio='NA'		
where TotalClientsStartOfmonth<AvgTradedclients
-----------------------------------------------Activation Ratio---------------------
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 
	into #RegActiveClients
	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by Sauda_date,Branch_cd,Emp_no)A 
	group by Branch_cd,Emp_no
	--order by 1
	--select * from #RegActiveClients
--Activation main page

--update @MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays
--else 0.00 end)
--from #RegActiveClients A,	@MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--
--

update @MIStable set 
DailyTradedClients_AR=A.DailyTradedClients
from 
(select b.Branch_cd,b.Emp_No,
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
 
 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)
		where TD.CMTradingDay='Y'
		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
	group by b.Branch_cd,b.Emp_No
)A,	@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		


--select @DailyTradedClients_AR		
update @MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays
else 0.00 end)
from #RegActiveClients A,	@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--select DailyTradedClients_AR,DailyTradeDays from @MIStable

update @MIStable
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)
set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)


---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)
begin
		update @MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate
		from 
		(
		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
		from #PartyDetails ps
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			Declare @Act_Days int,@H_days int
			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              
			set @H_days = ( select  count(distinct holidaydate)  from [196.1.115.207].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= @FromDate and holidaydate <= @ToDate )   
			print @TradeDays
			print @Act_Days
			print @H_days
			--if(@SegmentType='Currency')
			--begin
				--Fetch Emploee with CTC			
				
				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',
				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))
				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)
				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and
				 ah.Status='A' and EMP_NO in (select EMP_NO from @MIStable)				
				
		
				--Update productivity for Employee
				print 'productivity'
				print @TradeDays
				print (@Act_Days-@H_days)
				update @MIStable set 
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 
								else '0.00' end)
				from @MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				
				select mis.Emp_No,
				mis.Brokerage,ah.CTC,TradeDays=@TradeDays,Act_Days=@Act_Days,H_days=@H_days ,Dino=((ah.CTC)*@TradeDays/(@Act_Days-@H_days)),
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 
								else '0.00' end)
				from @MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				order by mis.Emp_No
				return
				
				/*--Print for testing
				select * from #ProdForCurr
				--Print RM
				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,
				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage
				from @MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'
				*/
			--End		
			
		end
		--------------------------------End Calculate Productivity--------------------------------------------------------------
end
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------
print '4:'+convert(varchar,getdate(),109)
--
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded
		from #PartyDetails ps
		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
		and ps.FirstTrade<=@ToDate
		--Delete traded clients
		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)
--	
print '4.1:'+convert(varchar,getdate(),109)
		update @MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth
		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)
		from #nottraded ps
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
drop table #nottraded
--
print '5:'+convert(varchar,getdate(),109)
		
			update @MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate
			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)
			from #PartyDetails ps
			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	
			and ps.FirstTrade>@ToDate
			group by ps.Branch_cd,ps.Emp_No
			)A,@MIStable B
				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	
--
print '6:'+convert(varchar,getdate(),109)
---------------------------------Update Client Visit Pending-------------------------
/*update @MIStable set ClientVisitPending=A.CVPcount
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No
)A,@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region
print '7:'+convert(varchar,getdate(),109)*/
------------------------------DROP #PartyDetails---
drop table #PartyDetails
------------------------------DISPLAY------------------------------------------------
print 'Wise: '
print @Wise
if @Wise='DEALER'
begin
		print 'DEALER'
		update @MIStable set Emp_Name=ah.EMP_NAME
					from @MIStable mis,B2B_AngelHarmony ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		update @MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from @MIStable mis
		order by 1,2,3
end
else
begin
		print 'SUBBROKER'
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from @MIStable mis
		order by 1,2
end
--TOTAL
--if @TotalFlag <> 'Y' 
if(isnull(@TotalFlag,'') in ('','N'))
begin

--select  
--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
--Tradedclients=isnull(sum(Tradedclients),0),
--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
--		else 0.00 end)),
--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)
--from #RegActiveClients A,	@MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

select  
TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
Tradedclients=isnull(sum(Tradedclients),0),
		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
		else 0.00 end)),
		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end
from @MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

--group by DailyTradeDays
print 'End:'+convert(varchar,getdate(),109)
end 

END
---------------------MAIN PAGE END---------------------------------------------------
---------------------DRILL PAGE START---------------------------------------------------
else if @ReportType='DRILL'
begin
---------------------Declare drill page-------------------------------------------------
create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,
LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)
--
if @DrillFlag='TotalAsOn'
begin
print 'Drill 1:'+convert(varchar,getdate(),109)

	   
		--select * from @rto_Data
			
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate				

print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)
		
		if(@UserStatusId='SBDEALER')
		begin
			declare @rto_Data table
			(
			Zone varchar(20),
			Region varchar(20),
			branch_cd varchar(20),
			sub_broker varchar(20),
			Sub_brokerName varchar(200),
			party_code varchar(20),
			Short_name varchar(100),
			TotalTO money

			)	
			
			insert into @rto_Data
			exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_newfo] 
			@Emp_no=@UserEmp_No,
			@Zone='',
			@Region='',
			@Branch='',
			@Exec=@Dealer,
			@FromTime='09:00 AM',
			@ToTime='11:59 PM',
			@MainDrill='DRILL',
			@WiseReport='SBDEALER',
			@seg='ALL',
			@B2CStatus='B2B',
			@MimStatusID='SBDEALER',
			@SB='',
			@RoundValue='1',
			@DownloadCSVFlag='Y'

			
			update #drillPartyDetails set TotalTo=rto.TotalTo
			from #drillPartyDetails drill, @rto_Data rto
			where drill.Party_Code=rto.party_code	
		end
		
			
		--
end
else if @DrillFlag='TotalStartOfMonth'
begin
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate	
end
else if @DrillFlag='NotTradedAsOn'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
				and ps.FirstTrade>@ToDate	
end
else if @DrillFlag='NotTradedForMonth'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				
				and ps.FirstTrade<=@ToDate		
		--
		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	
		--
end
else if @DrillFlag='Traded'
begin
		--Insert Traded Clients
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code
		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		
		
end
else if @DrillFlag='BROK'
begin		
		Declare @emp_name varchar(100)		
		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')
		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,
		br.Party_Code,ac1.Long_Name,
		--Turnover =sum(TotalTurnover),
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 
		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        --NetRevnue =sum(NetRevenue),
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Sauda_date)  
		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code
		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	
		
		--Total		
		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver
		return
end
else if @DrillFlag='ACTIVECLI'
begin		
	
	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),
	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100
	into #FinalActiveCli
	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join
	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)
	 from #BrokTurnOver b
	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	order by 1,2,3
	--Display
	select * from #FinalActiveCli
	--Total Row
	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),
	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100
	 from #FinalActiveCli
	
return
end
---------------------Common Script for DRILL PAGE ---------------------------------------------------
	
print 'Drill 3:'+convert(varchar,getdate(),109)		
		-- Update Portfolio i.e. Holding value
		update #drillPartyDetails                                                             
		set PortfolioInfo=isnull(H.TotalHold,0)            
		from #drillPartyDetails ps inner join   [196.1.115.207].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   
		on ps.party_code = H.party_code 
print 'Drill 4:'+convert(varchar,getdate(),109)		
		--Update Ledger Value
		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger
		from #drillPartyDetails ps left outer join  [196.1.115.207].Angelcs.dbo.View_LedgerInfo L with(nolock)
		on ps.party_code = L.party_code 
		--
		update #drillPartyDetails                                                             
		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)
		from #drillPartyDetails ps left outer join #totalLedger L
		on ps.party_code = L.party_code 
		--
		drop table #totalLedger		
print 'Drill 5:'+convert(varchar,getdate(),109)			
		--Update Current Dealer
		update #drillPartyDetails set DealerCode=cps.Emp_No			
		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )
		where --cps.Segment_Type=@SegmentType and 
		/*EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and*/
		ps.Party_Code =cps.Party_Code and
		cps.Valid='Y' and cps.CommRank='1'
		--Set Row color as per BRS point 4.3.4 & 4.3.5
print 'Drill 6:'+convert(varchar,getdate(),109)	
		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	
		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)
		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'
		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)
		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)
		--		
print 'Drill End:'+convert(varchar,getdate(),109)		
		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',
		SB=Branch_cd,Party_Code,Client_Name,Emp_No,
		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),
		ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)
		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),
		PureRisk=convert(decimal(15,2),PureRisk),
		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),LastTradeDate,RowColor,LedgerColor,
		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)
		
		 from #drillPartyDetails s
		 order by SrNo
		 --Total
		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),
		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))
		  from #drillPartyDetails
-------------------
end
---------------------DRILL PAGE END---------------------------------------------------
END
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_bak29May2012
-- --------------------------------------------------

create procedure [dbo].[SBB2B_MIS_bak29May2012]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20),       --SUBBROKER/DEALER
 @ReportType varchar(20), --MAIN/DRILL
 @DrillFlag varchar(20)  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 as
 BEGIN
/*
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='SUBBROKER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Apr 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'
*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------
/*if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
	 
	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 
	 where Emp_No=@UserEmp_No                       */
	 --Select distinct  P.branch_cd,A.zone,A.region                                  
	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        
	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin    
        /*declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag*/
		insert into @tempbranch 
		select distinct Branch_cd=sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@UserEmp_No
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@UserEmp_No
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    
	/*insert into @tempbranch                                                                 
	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   
	 AngelHarmonyEmployee b--B2B_Harmony b 
	 on a.sbtag=b.hod*/
end

/*if @UserStatusId='SBCHILD'                           
begin
	insert into @tempbranch                                                                 
	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    
	where   HOD=@UserEmp_No	
	select * from @tempbranch	
end
*/
*/


Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker
 

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

declare @BrokTurnOver table(Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 Declare  @MIStable table                                                          
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		and ps.Emp_No>=@FromDealer
		and ps.Emp_No<=@ToDealer
		--and ps.Segment_Type=@SegmentType
end

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
--else if @Wise='ZONE'
--begin
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''
--end
--else if @Wise='REGION'
--begin
--update #PartyDetails set Branch_cd='',Emp_No=''
--end
--else if @Wise='BRANCH'
--begin
--update #PartyDetails set Emp_No=''
--end
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin
	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 
		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code*/	
	
	if(@SegmentType in('COMMODITY'))
	begin
		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end
	else if(@SegmentType in('CURRENCY'))
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end		
	else --if(@SegmentType in('CASH','DERIVATIVE') and other
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTrade 
		from angelclient1 ac1 with(nolock),#PartyDetails ps 
		where ac1.Party_Code=ps.Party_Code
	end
end
--------------------------Fetch Brokerage in case when required-------------------------

/*

Select top 10 * from bsecm_cli

*/

if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

insert into @BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		Online_TurnOver=L.ebrok_TurnOver,
		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=L.ebrok_brok_earned,
		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),
		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		--and L.ExceptClient='Y'
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end



--select top 10 * From tbl_Exchangemapping
 
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin

-----------------------------Fill MIS Table--------------------------------------------------------------------
		insert into @MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,
		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,
		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,
		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays)
		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,
		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,
		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',
		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,
		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0
		from #PartyDetails		
		group by Branch_cd,Emp_No		
print '1.2:'+convert(varchar,getdate(),109)
----------------------------------------Update Start Of Month Total Clients----------------------------------
		update @MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth
		from
		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	
		from #PartyDetails ps 
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
print '2:'+convert(varchar,getdate(),109)
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------
		
--
print '3.1 '+convert(varchar,getdate(),109)
--
update @MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue
--CONVERT(decimal(15,2),
		from 
		(
		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)
  
		from @BrokTurnOver b
		group by b.Branch_cd,b.Emp_No
		)A,	@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
----------------------Update NA-----------------------------
update @MIStable
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

--Comment by sandip
--update @MIStable set ActivationRatio='NA'		
--where TotalClientsStartOfmonth<Tradedclients
update @MIStable set AvgDailyActRatio='NA'		
where TotalClientsStartOfmonth<AvgTradedclients
-----------------------------------------------Activation Ratio---------------------
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 
	into #RegActiveClients
	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by Sauda_date,Branch_cd,Emp_no)A 
	group by Branch_cd,Emp_no
	--order by 1
	--select * from #RegActiveClients
--Activation main page

update @MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays
else 0.00 end)
from #RegActiveClients A,	@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--
--


---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)
begin
		update @MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate
		from 
		(
		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
		from #PartyDetails ps
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			Declare @Act_Days int,@H_days int
			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              
			set @H_days = ( select  count(distinct holidaydate)  from [196.1.115.207].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= @FromDate and holidaydate <= @ToDate )   
			print @TradeDays
			print @Act_Days
			print @H_days
			--if(@SegmentType='Currency')
			--begin
				--Fetch Emploee with CTC			
				
				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',
				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))
				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)
				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and
				 ah.Status='A' and EMP_NO in (select EMP_NO from @MIStable)				
				
		
				--Update productivity for Employee
				print 'productivity'
				print @TradeDays
				print (@Act_Days-@H_days)
				update @MIStable set 
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 
								else '0.00' end)
				from @MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				
				
				/*--Print for testing
				select * from #ProdForCurr
				--Print RM
				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,
				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage
				from @MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'
				*/
			--End		
			
		end
		--------------------------------End Calculate Productivity--------------------------------------------------------------
end
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------
print '4:'+convert(varchar,getdate(),109)
--
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded
		from #PartyDetails ps
		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
		and ps.FirstTrade<=@ToDate
		--Delete traded clients
		delete from #nottraded where Party_Code in(select Party_Code from @BrokTurnOver)
--	
print '4.1:'+convert(varchar,getdate(),109)
		update @MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth
		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)
		from #nottraded ps
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
drop table #nottraded
--
print '5:'+convert(varchar,getdate(),109)
		
			update @MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate
			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)
			from #PartyDetails ps
			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	
			and ps.FirstTrade>@ToDate
			group by ps.Branch_cd,ps.Emp_No
			)A,@MIStable B
				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	
--
print '6:'+convert(varchar,getdate(),109)
---------------------------------Update Client Visit Pending-------------------------
/*update @MIStable set ClientVisitPending=A.CVPcount
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No
)A,@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region
print '7:'+convert(varchar,getdate(),109)*/
------------------------------DROP #PartyDetails---
drop table #PartyDetails
------------------------------DISPLAY------------------------------------------------
print 'Wise: '
print @Wise
if @Wise='DEALER'
begin
		print 'DEALER'
		update @MIStable set Emp_Name=ah.EMP_NAME
					from @MIStable mis,B2B_AngelHarmony ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		update @MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),Productivity,ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from @MIStable mis
		order by 1,2,3
end
else
begin
		print 'SUBBROKER'
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),Productivity,ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from @MIStable mis
		order by 1,2
end
--TOTAL
select  
TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
Tradedclients=isnull(sum(Tradedclients),0),
		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
		then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
		else 0.00 end)),
		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0)
from #RegActiveClients A,	@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No
--group by DailyTradeDays
print 'End:'+convert(varchar,getdate(),109)

END
---------------------MAIN PAGE END---------------------------------------------------
---------------------DRILL PAGE START---------------------------------------------------
else if @ReportType='DRILL'
begin
---------------------Declare drill page-------------------------------------------------
Declare @drillPartyDetails table(Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,
LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10))

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)
--
if @DrillFlag='TotalAsOn'
begin
print 'Drill 1:'+convert(varchar,getdate(),109)
		insert into @drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate						
		--
end
else if @DrillFlag='TotalStartOfMonth'
begin
		insert into @drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate	
end
else if @DrillFlag='NotTradedAsOn'
begin
				insert into @drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11)
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
				and ps.FirstTrade>@ToDate	
end
else if @DrillFlag='NotTradedForMonth'
begin
				insert into @drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11)
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				
				and ps.FirstTrade<=@ToDate		
		--
		delete from @drillPartyDetails where Party_Code in(select Party_Code from @BrokTurnOver)	
		--
end
else if @DrillFlag='Traded'
begin
		--Insert Traded Clients
		insert into @drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		 inner join @BrokTurnOver br on ps.Party_Code=br.Party_Code
		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		
		
end
else if @DrillFlag='BROK'
begin		
		Declare @emp_name varchar(100)		
		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')
		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,
		br.Party_Code,ac1.Long_Name,
		--Turnover =sum(TotalTurnover),
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 
		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        --NetRevnue =sum(NetRevenue),
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Sauda_date)  
		from @BrokTurnover br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code
		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	
		
		--Total		
		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from @BrokTurnover
		return
end
else if @DrillFlag='ACTIVECLI'
begin		
	
	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),
	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100
	into #FinalActiveCli
	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join
	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)
	 from @BrokTurnOver b
	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	order by 1,2,3
	--Display
	select * from #FinalActiveCli
	--Total Row
	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),
	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100
	 from #FinalActiveCli
	
return
end
---------------------Common Script for DRILL PAGE ---------------------------------------------------
	
print 'Drill 3:'+convert(varchar,getdate(),109)		
		-- Update Portfolio i.e. Holding value
		update @drillPartyDetails                                                             
		set PortfolioInfo=isnull(H.TotalHold,0)            
		from @drillPartyDetails ps inner join   [196.1.115.207].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   
		on ps.party_code = H.party_code 
print 'Drill 4:'+convert(varchar,getdate(),109)		
		--Update Ledger Value
		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger
		from @drillPartyDetails ps left outer join  [196.1.115.207].Angelcs.dbo.View_LedgerInfo L with(nolock)
		on ps.party_code = L.party_code 
		--
		update @drillPartyDetails                                                             
		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)
		from @drillPartyDetails ps left outer join #totalLedger L
		on ps.party_code = L.party_code 
		--
		drop table #totalLedger		
print 'Drill 5:'+convert(varchar,getdate(),109)			
		--Update Current Dealer
		update @drillPartyDetails set DealerCode=cps.Emp_No			
		from B2B_CommonPartyServices cps with(nolock),@drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )
		where --cps.Segment_Type=@SegmentType and 
		/*EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and*/
		ps.Party_Code =cps.Party_Code and
		cps.Valid='Y' and cps.CommRank='1'
		--Set Row color as per BRS point 4.3.4 & 4.3.5
print 'Drill 6:'+convert(varchar,getdate(),109)	
		update @drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	
		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)
		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'
		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)
		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)
		--		
print 'Drill End:'+convert(varchar,getdate(),109)		
		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',
		SB=Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)
		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),
		PureRisk=convert(decimal(15,2),PureRisk),
		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),LastTradeDate,RowColor,LedgerColor
		 from @drillPartyDetails s
		 --Total
		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0)))
		  from @drillPartyDetails
-------------------
end
---------------------DRILL PAGE END---------------------------------------------------
END
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_bak31Mar12
-- --------------------------------------------------

Create procedure [dbo].[SBB2B_MIS_bak31Mar12]
 @UserEmp_No varchar(10),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20),       --SUBBROKER/DEALER
 @ReportType varchar(20), --MAIN/DRILL
 @DrillFlag varchar(20)  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 as
 BEGIN
 
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------
/*if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
	 
	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 
	 where Emp_No=@UserEmp_No                       */
	 --Select distinct  P.branch_cd,A.zone,A.region                                  
	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        
	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin    
        /*declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag*/
		insert into @tempbranch 
		select distinct Branch_cd=sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@UserEmp_No
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@UserEmp_No
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    
	/*insert into @tempbranch                                                                 
	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   
	 AngelHarmonyEmployee b--B2B_Harmony b 
	 on a.sbtag=b.hod*/
end

/*if @UserStatusId='SBCHILD'                           
begin
	insert into @tempbranch                                                                 
	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    
	where   HOD=@UserEmp_No	
	select * from @tempbranch	
end
*/
*/

Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No)


----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

declare @BrokTurnOver table(Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 Declare  @MIStable table                                                          
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		and ps.Emp_No>=@FromDealer
		and ps.Emp_No<=@ToDealer
		--and ps.Segment_Type=@SegmentType
end

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
--else if @Wise='ZONE'
--begin
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''
--end
--else if @Wise='REGION'
--begin
--update #PartyDetails set Branch_cd='',Emp_No=''
--end
--else if @Wise='BRANCH'
--begin
--update #PartyDetails set Emp_No=''
--end
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin

	update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 
	ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.FirstTradeComm  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr end)
	from angelclient1 ac1,#PartyDetails ps
	where ps.Party_Code=ac1.Party_Code
		
end
--------------------------Fetch Brokerage in case when required-------------------------

/*

Select top 10 * from bsecm_cli

*/

if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--
insert into @BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		Online_TurnOver=L.ebrok_TurnOver,
		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=L.ebrok_brok_earned,
		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		 ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		--and L.ExceptClient='Y'
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end



--select top 10 * From tbl_Exchangemapping
 
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin

-----------------------------Fill MIS Table--------------------------------------------------------------------
		insert into @MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,
		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,
		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,
		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays)
		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,
		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,
		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',
		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,
		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0
		from #PartyDetails		
		group by Branch_cd,Emp_No		
print '1.2:'+convert(varchar,getdate(),109)
----------------------------------------Update Start Of Month Total Clients----------------------------------
		update @MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth
		from
		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	
		from #PartyDetails ps 
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
print '2:'+convert(varchar,getdate(),109)
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------
		
--
print '3.1 '+convert(varchar,getdate(),109)
--
update @MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue
--CONVERT(decimal(15,2),
		from 
		(
		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)
  
		from @BrokTurnOver b
		group by b.Branch_cd,b.Emp_No
		)A,	@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
----------------------Update NA-----------------------------
update @MIStable
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / DailyTradedClients) else 0.00 end)

--Comment by sandip
--update @MIStable set ActivationRatio='NA'		
--where TotalClientsStartOfmonth<Tradedclients
update @MIStable set AvgDailyActRatio='NA'		
where TotalClientsStartOfmonth<AvgTradedclients
-----------------------------------------------Activation Ratio---------------------
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 
	into #RegActiveClients
	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by Sauda_date,Branch_cd,Emp_no)A 
	group by Branch_cd,Emp_no
	--order by 1
	--select * from #RegActiveClients
--Activation main page

update @MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays
else 0.00 end)
from #RegActiveClients A,	@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--
--


---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)
begin
		update @MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate
		from 
		(
		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
		from #PartyDetails ps
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			Declare @Act_Days int,@H_days int
			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              
			set @H_days = ( select  count(distinct holidaydate)  from [196.1.115.207].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= @FromDate and holidaydate <= @ToDate )   
			print @TradeDays
			print @Act_Days
			print @H_days
			--if(@SegmentType='Currency')
			--begin
				--Fetch Emploee with CTC			
				
				select distinct EMP_NO, Brokerage = cast(0 as money), CTC, HOD,
				RMFlag=cast((case when ah.Category in('DEALER') then 'DEALER' else '' end )as varchar(10))
				into #ProdForCurr from AngelHarmonyEmployee ah with(nolock)
				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and
				 ah.Status='A' and EMP_NO in (select EMP_NO from @MIStable)				
				
		
				--Update productivity for Employee
				print 'productivity'
				print @TradeDays
				print (@Act_Days-@H_days)
				update @MIStable set 
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days)))) 
								else '0.00' end)
				from @MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				
				
				/*--Print for testing
				select * from #ProdForCurr
				--Print RM
				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,
				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage
				from @MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'
				*/
			--End		
			
		end
		--------------------------------End Calculate Productivity--------------------------------------------------------------
end
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------
print '4:'+convert(varchar,getdate(),109)
--
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded
		from #PartyDetails ps
		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
		and ps.FirstTrade<=@ToDate
		--Delete traded clients
		delete from #nottraded where Party_Code in(select Party_Code from @BrokTurnOver)
--	
print '4.1:'+convert(varchar,getdate(),109)
		update @MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth
		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)
		from #nottraded ps
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
drop table #nottraded
--
print '5:'+convert(varchar,getdate(),109)
		
			update @MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate
			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)
			from #PartyDetails ps
			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	
			and ps.FirstTrade>@ToDate
			group by ps.Branch_cd,ps.Emp_No
			)A,@MIStable B
				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	
--
print '6:'+convert(varchar,getdate(),109)
---------------------------------Update Client Visit Pending-------------------------
/*update @MIStable set ClientVisitPending=A.CVPcount
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No
)A,@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region
print '7:'+convert(varchar,getdate(),109)*/
------------------------------DROP #PartyDetails---
drop table #PartyDetails
------------------------------DISPLAY------------------------------------------------
print 'Wise: '
print @Wise
if @Wise='DEALER'
begin
		print 'DEALER'
		update @MIStable set Emp_Name=ah.EMP_NAME
					from @MIStable mis,AngelHarmonyEmployee ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		update @MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),Productivity,ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from @MIStable mis
		order by 1,2,3
end
else
begin
		print 'SUBBROKER'
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),Productivity,ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from @MIStable mis
		order by 1,2
end
--TOTAL
select  
TotalClientsStartOfmonth=sum(TotalClientsStartOfmonth),TotalClientsAsonDate=sum(TotalClientsAsonDate),
Tradedclients=sum(Tradedclients),
		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
		then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
		else 0.00 end)),
		OnlineTurnover=CONVERT(decimal(15,2),sum(OnlineTurnover)),OfflineTurnover=CONVERT(decimal(15,2),sum(OfflineTurnover)),
		OnlineBrok=CONVERT(decimal(15,2),sum(OnlineBrok)),OfflineBrok=CONVERT(decimal(15,2),sum(OfflineBrok)),
		OnlineNetRevnue=CONVERT(decimal(15,2),sum(OnlineNetRevnue)),OfflineNetRevnue=CONVERT(decimal(15,2),sum(OfflineNetRevnue)),
		ClientNotTradedForMonth=sum(ClientNotTradedForMonth),ClientNotTradedAsOnDate=sum(ClientNotTradedAsOnDate)
from #RegActiveClients A,	@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No
--group by DailyTradeDays
print 'End:'+convert(varchar,getdate(),109)

END
---------------------MAIN PAGE END---------------------------------------------------
---------------------DRILL PAGE START---------------------------------------------------
else if @ReportType='DRILL'
begin
---------------------Declare drill page-------------------------------------------------
Declare @drillPartyDetails table(Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,
LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10))

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)
--
if @DrillFlag='TotalAsOn'
begin
print 'Drill 1:'+convert(varchar,getdate(),109)
		insert into @drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join [196.1.115.207].crm.dbo.tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate						
		--
end
else if @DrillFlag='TotalStartOfMonth'
begin
		insert into @drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join [196.1.115.207].crm.dbo.tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate	
end
else if @DrillFlag='NotTradedAsOn'
begin
				insert into @drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11)
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join [196.1.115.207].crm.dbo.tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
				and ps.FirstTrade>@ToDate	
end
else if @DrillFlag='NotTradedForMonth'
begin
				insert into @drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11)
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join [196.1.115.207].crm.dbo.tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				
				and ps.FirstTrade<=@ToDate		
		--
		delete from @drillPartyDetails where Party_Code in(select Party_Code from @BrokTurnOver)	
		--
end
else if @DrillFlag='Traded'
begin
		--Insert Traded Clients
		insert into @drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		 inner join @BrokTurnOver br on ps.Party_Code=br.Party_Code
		left outer join  [196.1.115.207].crm.dbo.tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		
		
end
else if @DrillFlag='BROK'
begin		
		Declare @emp_name varchar(100)		
		set @emp_name=isnull((select emp_name from AngelHarmonyEmployee with(nolock) where EMP_NO=@Dealer),'')
		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,
		br.Party_Code,ac1.Long_Name,
		--Turnover =sum(TotalTurnover),
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 
		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        --NetRevnue =sum(NetRevenue),
        OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline),
        TotalTradedDays=count(distinct Sauda_date)  
		from @BrokTurnover br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code
		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	
		return
end
else if @DrillFlag='ACTIVECLI'
begin		
	
	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),
	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100
	into #FinalActiveCli
	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join
	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)
	 from @BrokTurnOver b
	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	order by 1,2,3
	--Display
	select * from #FinalActiveCli
	--Total Row
	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),
	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100
	 from #FinalActiveCli
	
return
end
---------------------Common Script for DRILL PAGE ---------------------------------------------------
	
print 'Drill 3:'+convert(varchar,getdate(),109)		
		-- Update Portfolio i.e. Holding value
		update @drillPartyDetails                                                             
		set PortfolioInfo=isnull(H.TotalHold,0)            
		from @drillPartyDetails ps left outer join   [196.1.115.207].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   
		on ps.party_code = H.party_code 
print 'Drill 4:'+convert(varchar,getdate(),109)		
		--Update Ledger Value
		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger
		from @drillPartyDetails ps left outer join  [196.1.115.207].Angelcs.dbo.View_LedgerInfo L with(nolock)
		on ps.party_code = L.party_code 
		--
		update @drillPartyDetails                                                             
		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)
		from @drillPartyDetails ps left outer join #totalLedger L
		on ps.party_code = L.party_code 
		--
		drop table #totalLedger		
print 'Drill 5:'+convert(varchar,getdate(),109)			
		--Update Current Dealer
		update @drillPartyDetails set DealerCode=cps.Emp_No			
		from @drillPartyDetails ps left outer join B2B_CommonPartyServices cps with(nolock) on  (ps.Party_Code =cps.Party_Code )
		where --cps.Segment_Type=@SegmentType and 
		/*EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and*/
		cps.Valid='Y' and cps.CommRank='1'
		--Set Row color as per BRS point 4.3.4 & 4.3.5
print 'Drill 6:'+convert(varchar,getdate(),109)	
		update @drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	
		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)
		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'
		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)
		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)
		--		
print 'Drill End:'+convert(varchar,getdate(),109)		
		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',
		SB=Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerName=(select Emp_Name from AngelHarmonyEmployee with(nolock) where emp_no=s.DealerCode)
		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),PortfolioInfo),
		PureRisk=convert(decimal(15,2),PureRisk),
		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),LastTradeDate,RowColor,LedgerColor
		 from @drillPartyDetails s
-------------------
end
---------------------DRILL PAGE END---------------------------------------------------
END
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_NXT
-- --------------------------------------------------


CREATE procedure [dbo].[SBB2B_MIS_NXT]

		 @UserEmp_No varchar(20),

		 @UserStatusId varchar(10),--SUBBROKER/SBDEALER

		 @Sub_Broker varchar(10),

		 @Dealer varchar(20),

		 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE

		 @ClientGrade varchar(15),--ALL,A+,A,B,C,D

		 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency

		 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012

		 @Wise varchar(20),       --SUBBROKER/DEALER

		 @ReportType varchar(20), --MAIN/DRILL

		 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI

		 @TotalFlag varchar(2) = null,

		 @party_code varchar(max)

 as

 BEGIN

Set nocount on

/*

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='jan  1 2013',@Wise='Dealer',@ReportType='MAIN',@DrillFlag=''



exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''



exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'



exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'



exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

*/

--

--print 'Start:'+convert(varchar,getdate(),109)

 Declare @ToDate smalldatetime

 Declare @FromDealer varchar(10)

 Declare @ToDealer varchar(10)

 Declare @FromEffSaudaDate datetime

 Declare @ToEffSaudaDate datetime

 Declare @TradeDays money

 Declare @SegmentTypeFrom varchar(10)

 Declare @SegmentTypeTo varchar(10)

 Declare @FromSub_Broker varchar(10)

 Declare @ToSub_Broker varchar(10)

 



 Create table #party_code

 (

    party_code varchar(100)

 )



 insert into #party_code

 select * from [fn_Split] (@party_code,',')





 --------------------------------Set From and TO date---------------------------------------

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'

set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'

--print @FromDate

--print @ToDate

set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))

set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))

set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))

set @Dealer=upper(ltrim(rtrim(@Dealer)))

set @TradingMode=upper(ltrim(rtrim(@TradingMode)))

set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))

set @SegmentType=upper(ltrim(rtrim(@SegmentType)))

set @Wise=upper(ltrim(rtrim(@Wise)))

set @ReportType=upper(ltrim(rtrim(@ReportType)))

set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))

 ---------------------------------------Get count of Trade Days---------------------------------------------

 /* Added table date for the Currency Segment */

if(@SegmentType = 'CURRENCY')

begin

   set @SegmentTypeFrom  ='CURRENCY'

   set @SegmentTypeTo='CURRENCY'

   

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'

end

else

begin

			if(@SegmentType = 'CASH')

			begin

			set @SegmentTypeFrom  ='CASH'

			set @SegmentTypeTo='CASH'

			End



			if(@SegmentType = 'DERIVATIVE')

			begin

			set @SegmentTypeFrom  ='DERIVATIVE'

			set @SegmentTypeTo='DERIVATIVE'

			End

			

			if(@SegmentType = 'COMMODITY')

			begin

			set @SegmentTypeFrom  ='COMMODITY'

			set @SegmentTypeTo='COMMODITY'

			End



			if(@SegmentType = 'All')

			begin

			set @SegmentTypeFrom  ='a'

			set @SegmentTypeTo='zzzzzz'

			End

			

			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'

	end

 



 

--print @TradeDays

 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------

 

 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 

 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

 

 

----------------------------------------Redefine Report Wise option as per input fields-----------------------



set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)



--print @Wise

-------------------------------------------------------------------------

/**subbroker*/

if @Sub_Broker='' or @Sub_Broker='ALL' 

Begin

	set @FromSub_Broker='A'

	set @ToSub_Broker='ZZZZZZZ'

End

else

Begin

	Set @FromSub_Broker=@Sub_Broker

	Set @ToSub_Broker=@Sub_Broker

End



--if @Dealer='' or @Dealer='ALL' set @Dealer='%'

--

/**subbrokerdealer*/

if @Dealer='' or @Dealer='ALL' 

begin

	set @FromDealer='A'

	set @ToDealer='ZZZZZZZ'

end

else

begin

	set @FromDealer=@Dealer

	set @ToDealer=@Dealer

end

--

--------------------------User Access---------------------------------------------------



/*fill subbrokers and dealers*/

declare @tempbranch  table                                                                

(                                                                

Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

)



Insert into @tempbranch

select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

 



----------------------------Declare MIS and PartyDetails Table--------------------------



create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

)

--



create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime)

--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)

--

 --Declare  @MIStable table  

 create table #MIStable                                                         

 (                                                          

 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,

 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,

 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,

 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),

 OnlineTurnover money, OfflineTurnover money, Turnover money,

 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int

 )                                                        

--

--print 'Access:'+convert(varchar,getdate(),109)

if @Dealer='' or @Dealer='ALL' 

begin

		--		

		--print 'ACT1'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd 

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		--and ps.Segment_Type=@SegmentType

		

end 

else

begin

		--print 'ACT2'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		and ps.Emp_No>=@FromDealer

		and ps.Emp_No<=@ToDealer

		--and ps.Segment_Type=@SegmentType

end



--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------

if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')

begin

--print 'TradingMode or ClientGrade'

if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)

if @ClientGrade='ALL' set @ClientGrade='%'

--

update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating

From angelclient1 ac1,#PartyDetails ps

where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode

and ac1.AngelClRating like @ClientGrade

--

delete #PartyDetails where isnull(EbrokingClient,'')=''

--

end

-----------------------Update #PartyDetails as per report Wise option -------------------------------------

--print '1.1:'+convert(varchar,getdate(),109)

if @Wise='SUBBROKER'

begin

	update #PartyDetails set Emp_No=''

end 

--else if @Wise='ZONE'

--begin

--update #PartyDetails set Region='',Branch_cd='',Emp_No=''

--end

--else if @Wise='REGION'

--begin

--update #PartyDetails set Branch_cd='',Emp_No=''

--end

--else if @Wise='BRANCH'

--begin

--update #PartyDetails set Emp_No=''

--end

-----------------------Update FirstTrade date -------------------------------------

if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))

begin

	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 

		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code*/	

	

	if(@SegmentType in('COMMODITY'))

	begin

		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end

	else if(@SegmentType in('CURRENCY'))

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end		

	else --if(@SegmentType in('CASH','DERIVATIVE') and other

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTrade 

		from angelclient1 ac1 with(nolock),#PartyDetails ps 

		where ac1.Party_Code=ps.Party_Code

	end

end

--------------------------Fetch Brokerage in case when required-------------------------



/*



Select top 10 * from bsecm_cli



*/



if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))

begin

--print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)

/*print 'Segment'

print @SegmentTypeFrom

print @SegmentTypeTo

print 'Eff Date'

print @FromEffSaudaDate

print @ToEffSaudaDate

print 'Date'

print @FromDate

print @ToDate*/

/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 

from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */

--



insert into #BrokTurnOver

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		Online_TurnOver=L.ebrok_TurnOver,

		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		GrossRevenue=L.Overall_brok_earned,

		GrossRevenue_Online=L.ebrok_brok_earned,

		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,

		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),

		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 

		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 

		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 

		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table

		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date

		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		--and L.ExceptClient='Y'

--print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)



end







--select top 10 * From tbl_Exchangemapping

 

---------------------MAIN PAGE---------------------------------

if @ReportType='MAIN'

begin



-----------------------------Fill MIS Table--------------------------------------------------------------------

		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,

		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,

		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,

		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)

		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,

		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,

		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',

		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,

		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0

		from #PartyDetails		

		group by Branch_cd,Emp_No		

--print '1.2:'+convert(varchar,getdate(),109)

----------------------------------------Update Start Of Month Total Clients----------------------------------

		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth

		from

		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	

		from #PartyDetails ps 

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

--print '2:'+convert(varchar,getdate(),109)

-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------

		

--

--print '3.1 '+convert(varchar,getdate(),109)

--





update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,

DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,

AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),

AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),

AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),

--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),

--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),

 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,

 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue

--CONVERT(decimal(15,2),

		from 

		(

		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   

        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),

        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),

        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),

 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)

  

		from #BrokTurnOver b

		group by b.Branch_cd,b.Emp_No

		)A,	#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

----------------------Update NA-----------------------------

--update #MIStable

----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)



--Comment by sandip

--update #MIStable set ActivationRatio='NA'		

--where TotalClientsStartOfmonth<Tradedclients

update #MIStable set AvgDailyActRatio='NA'		

where TotalClientsStartOfmonth<AvgTradedclients

-----------------------------------------------Activation Ratio---------------------

select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 

	into #RegActiveClients

	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by Sauda_date,Branch_cd,Emp_no)A 

	group by Branch_cd,Emp_no

	--order by 1

	--select * from #RegActiveClients

--Activation main page



--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays

--else 0.00 end)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--



update #MIStable set 

DailyTradedClients_AR=A.DailyTradedClients

from 

(select b.Branch_cd,b.Emp_No,

 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)

 

 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)

		where TD.CMTradingDay='Y'

		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)

	group by b.Branch_cd,b.Emp_No

)A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		





--select @DailyTradedClients_AR		

update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays

else 0.00 end)

from #RegActiveClients A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--



--select DailyTradedClients_AR,DailyTradeDays from #MIStable



update #MIStable

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)





---------------------------------------------------------Update AS ON CLIENTS----------------------------------

--print '3.2:'+convert(varchar,getdate(),109)

if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)

begin

		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate

		from 

		(

		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

		from #PartyDetails ps

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

		--------------------------------Calculate Productivity--------------------------------------------------------------

		if @Wise='DEALER'

		begin

			Declare @Act_Days int,@H_days int

			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              

			set @H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

						where holidaydate >= @FromDate and holidaydate <= @ToDate )   

			--print @TradeDays

			--print @Act_Days

			--print @H_days

			--if(@SegmentType='Currency')

			--begin

				--Fetch Emploee with CTC			

				

				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',

				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))

				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)

				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and

				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				

				

		

				--Update productivity for Employee

				--print 'productivity'

				--print @TradeDays

				--print (@Act_Days-@H_days)

				update #MIStable set 

				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 

								else '0.00' end)

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'

				

				

				/*--Print for testing

				select * from #ProdForCurr

				--Print RM

				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,

				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'

				*/

			--End		

			

		end

		--------------------------------End Calculate Productivity--------------------------------------------------------------

end

----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------

--print '4:'+convert(varchar,getdate(),109)

--

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded

		from #PartyDetails ps

		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

		and ps.FirstTrade<=@ToDate

		--Delete traded clients

		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)

--	

--print '4.1:'+convert(varchar,getdate(),109)

		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth

		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)

		from #nottraded ps

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

drop table #nottraded

--

--print '5:'+convert(varchar,getdate(),109)

		

			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate

			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)

			from #PartyDetails ps

			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	

			and ps.FirstTrade>@ToDate

			group by ps.Branch_cd,ps.Emp_No

			)A,#MIStable B

				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	

--

--print '6:'+convert(varchar,getdate(),109)

---------------------------------Update Client Visit Pending-------------------------

/*update #MIStable set ClientVisitPending=A.CVPcount

from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp

where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No

)A,#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region

print '7:'+convert(varchar,getdate(),109)*/

------------------------------DROP #PartyDetails---

drop table #PartyDetails

------------------------------DISPLAY------------------------------------------------

--print 'Wise: '

--print @Wise

if @Wise='DEALER'

begin

		--print 'DEALER'

		update #MIStable set Emp_Name=ah.EMP_NAME

					from #MIStable mis,B2B_AngelHarmony ah with(nolock)

					where mis.Emp_No=ah.EMP_NO

		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2,3

end

else

begin

		--print 'SUBBROKER'

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2

end

--TOTAL

--if @TotalFlag <> 'Y' 

if(isnull(@TotalFlag,'') in ('','N'))

begin



--select  

--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

--Tradedclients=isnull(sum(Tradedclients),0),

--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

--		else 0.00 end)),

--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



select  

TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

Tradedclients=isnull(sum(Tradedclients),0),

		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

		else 0.00 end)),

		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end

from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



--group by DailyTradeDays

--print 'End:'+convert(varchar,getdate(),109)

end 



END

---------------------MAIN PAGE END---------------------------------------------------

---------------------DRILL PAGE START---------------------------------------------------

else if @ReportType='DRILL'

begin

---------------------Declare drill page-------------------------------------------------

create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),

ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),

DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,

LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))



--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)

--

if @DrillFlag='TotalAsOn'

begin

--print 'Drill 1:'+convert(varchar,getdate(),109)



	   

		--select * from @rto_Data

			

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate				



--print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)

		

		if(@UserStatusId='SBDEALER')

		begin

			declare @rto_Data table

			(

			Zone varchar(20),

			Region varchar(20),

			branch_cd varchar(20),

			sub_broker varchar(20),

			Sub_brokerName varchar(200),

			party_code varchar(20),

			Short_name varchar(100),

			TotalTO money,

			OPTNoOfLots money,

			NoOfLotsGold bigint,

			NoOfLotsSilver bigint,

			NoOfLotsCopper bigint  ,

			NoOfLotsCrude bigint,

			NoOfLotsComm bigint,

			TargetNoOfLotsGold bigint,

			TargetNoOfLotsSilver bigint,

			TargetNoOfLotsCopper bigint,

			TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch='',

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='DRILL',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID='SBDEALER',

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			

			update #drillPartyDetails set TotalTo=rto.TotalTo

			from #drillPartyDetails drill, @rto_Data rto

			where drill.Party_Code=rto.party_code	

		end

		

			

		--

end

else if @DrillFlag='TotalStartOfMonth'

begin

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate	

end

else if @DrillFlag='NotTradedAsOn'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

				and ps.FirstTrade>@ToDate	

end

else if @DrillFlag='NotTradedForMonth'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				

				and ps.FirstTrade<=@ToDate		

		--

		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	

		--

end

else if @DrillFlag='Traded'

begin

		--Insert Traded Clients

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code

		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		

		

end

else if @DrillFlag='BROK'

begin		

		Declare @emp_name varchar(100)		

		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')



--Select * from #party_code



		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,

		br.Party_Code,ac1.Long_Name,

		--Turnover =sum(TotalTurnover),

        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 

		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        --NetRevnue =sum(NetRevenue),

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Sauda_date)  

		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code

		inner join #party_code p on p.party_code=br.Party_Code

		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	

		

		--Total		

		--select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  

  --      OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

  --      OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

  --      TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver

		return

end

else if @DrillFlag='ACTIVECLI'

begin		

	

	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),

	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100

	into #FinalActiveCli

	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join

	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)

	 from #BrokTurnOver b

	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	order by 1,2,3

	--Display

	--select * from #FinalActiveCli

	select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli

	--Total Row

	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),

	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100

	 from #FinalActiveCli

	

return

end

---------------------Common Script for DRILL PAGE ---------------------------------------------------

	

--print 'Drill 3:'+convert(varchar,getdate(),109)		

		-- Update Portfolio i.e. Holding value

		update #drillPartyDetails                                                             

		set PortfolioInfo=isnull(H.TotalHold,0)            

		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [MIMANSA].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   

		on ps.party_code = H.party_code 

--print 'Drill 4:'+convert(varchar,getdate(),109)		

		--Update Ledger Value

		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger

		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [MIMANSA].Angelcs.dbo.View_LedgerInfo L with(nolock)

		on ps.party_code = L.party_code 

		--

		update #drillPartyDetails                                                             

		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)

		from #drillPartyDetails ps left outer join #totalLedger L

		on ps.party_code = L.party_code 

		--

		drop table #totalLedger		

--print 'Drill 5:'+convert(varchar,getdate(),109)			

		--Update Current Dealer

		update #drillPartyDetails set DealerCode=cps.Emp_No			

		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )

		where --cps.Segment_Type=@SegmentType and 

		/*EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and*/

		ps.Party_Code =cps.Party_Code and

		cps.Valid='Y' and cps.CommRank='1'

		--Set Row color as per BRS point 4.3.4 & 4.3.5

--print 'Drill 6:'+convert(varchar,getdate(),109)	

		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	

		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)

		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'

		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)

		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)

		--		

--print 'Drill End:'+convert(varchar,getdate(),109)		

		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',

		SB=Branch_cd,Party_Code,Client_Name,Emp_No,

		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),

		ClientGrade,[Profile],Sub_Profile,

		--ActiveFrom,

		ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),

		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)

		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),

		PureRisk=convert(decimal(15,2),PureRisk),

		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),

		--LastTradeDate,

		LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,

		RowColor,LedgerColor,

		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)

		

		 from #drillPartyDetails s

		 order by SrNo

		 --Total

		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),

		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))

		  from #drillPartyDetails



Drop table #party_code

-------------------

end

---------------------DRILL PAGE END---------------------------------------------------

END

---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_NXT_V1
-- --------------------------------------------------

--Changed done by Anand Dhumal on 11 Jul 2024 for SP optimisation. Below is the CR for that. Backup SP- "SBB2B_MIS_NXT_V1_bkp11Jul2024"
--https://angelbrokingpl.atlassian.net/browse/SRE-27875

CREATE procedure [dbo].[SBB2B_MIS_NXT_V1]

		 @UserEmp_No varchar(20),

		 @UserStatusId varchar(10),--SUBBROKER/SBDEALER

		 @Sub_Broker varchar(10),

		 @Dealer varchar(20),

		 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE

		 @ClientGrade varchar(15),--ALL,A+,A,B,C,D

		 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency

		 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012

		 @ToDate smalldatetime,

		 @Wise varchar(20),       --SUBBROKER/DEALER

		 @ReportType varchar(20), --MAIN/DRILL

		 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI

		 @TotalFlag varchar(2) = null

		 --,		 @party_code varchar(max)

 as

 BEGIN

Set nocount on

/*

exec [SBB2B_MIS_NXT_V1] 
@UserEmp_No='VIBU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIBU',@Dealer='',
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',
@FromDate='06 Nov 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',
@ToDate='11 Apr 2024'

exec [SBB2B_MIS] 

@UserEmp_No='VIVU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIVU',@Dealer='',
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',
@FromDate='06 Nov 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',
@ToDate='11 Apr 2024'

*/

--

--print 'Start:'+convert(varchar,getdate(),109)

 --Declare @ToDate smalldatetime

 Declare @FromDealer varchar(10)

 Declare @ToDealer varchar(10)

 Declare @FromEffSaudaDate datetime

 Declare @ToEffSaudaDate datetime

 Declare @TradeDays money

 Declare @SegmentTypeFrom varchar(10)

 Declare @SegmentTypeTo varchar(10)

 Declare @FromSub_Broker varchar(10)

 Declare @ToSub_Broker varchar(10)

 



 --Create table #party_code

 --(

 --   party_code varchar(100)

 --)



 --insert into #party_code

 --select * from [fn_Split] (@party_code,',')





 --------------------------------Set From and TO date---------------------------------------

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'

--set @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+' 00:00'



set  @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+ ' 23:59'



--set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'





--print @FromDate

--print @ToDate

set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))

set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))

set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))

set @Dealer=upper(ltrim(rtrim(@Dealer)))

set @TradingMode=upper(ltrim(rtrim(@TradingMode)))

set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))

set @SegmentType=upper(ltrim(rtrim(@SegmentType)))

set @Wise=upper(ltrim(rtrim(@Wise)))

set @ReportType=upper(ltrim(rtrim(@ReportType)))

set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))

 ---------------------------------------Get count of Trade Days---------------------------------------------

 /* Added table date for the Currency Segment */

if(@SegmentType = 'CURRENCY')

begin

   set @SegmentTypeFrom  ='CURRENCY'

   set @SegmentTypeTo='CURRENCY'

   

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'

end

else

begin

			if(@SegmentType = 'CASH')

			begin

			set @SegmentTypeFrom  ='CASH'

			set @SegmentTypeTo='CASH'

			End



			if(@SegmentType = 'DERIVATIVE')

			begin

			set @SegmentTypeFrom  ='DERIVATIVE'

			set @SegmentTypeTo='DERIVATIVE'

			End

			

			if(@SegmentType = 'COMMODITY')

			begin

			set @SegmentTypeFrom  ='COMMODITY'

			set @SegmentTypeTo='COMMODITY'

			End



			if(@SegmentType = 'All')

			begin

			set @SegmentTypeFrom  ='a'

			set @SegmentTypeTo='zzzzzz'

			End

			

			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'

	end

 



 

--print @TradeDays

 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------

 

 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 

 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

 

 

----------------------------------------Redefine Report Wise option as per input fields-----------------------



set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)



--print @Wise

-------------------------------------------------------------------------

/**subbroker*/

if @Sub_Broker='' or @Sub_Broker='ALL' 

Begin

	set @FromSub_Broker='A'

	set @ToSub_Broker='ZZZZZZZ'

End

else

Begin

	Set @FromSub_Broker=@Sub_Broker

	Set @ToSub_Broker=@Sub_Broker

End



--if @Dealer='' or @Dealer='ALL' set @Dealer='%'

--

/**subbrokerdealer*/

if @Dealer='' or @Dealer='ALL' 

begin

	set @FromDealer='A'

	set @ToDealer='ZZZZZZZ'

end

else

begin

	set @FromDealer=@Dealer

	set @ToDealer=@Dealer

end

--

--------------------------User Access---------------------------------------------------



/*fill subbrokers and dealers*/

declare @tempbranch  table                                                                

(                                                                

Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

)



Insert into @tempbranch

select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

 



----------------------------Declare MIS and PartyDetails Table--------------------------



create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

)

--



create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime)

--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)

--

 --Declare  @MIStable table  

 create table #MIStable                                                         

 (                                                          

 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,

 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,

 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,

 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),

 OnlineTurnover money, OfflineTurnover money, Turnover money,

 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int

 )                                                        

--

--print 'Access:'+convert(varchar,getdate(),109)

if @Dealer='' or @Dealer='ALL' 

begin

		--		

		--print 'ACT1'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd 

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		--and ps.Segment_Type=@SegmentType

		

end 

else

begin

		--print 'ACT2'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		and ps.Emp_No>=@FromDealer

		and ps.Emp_No<=@ToDealer

		--and ps.Segment_Type=@SegmentType

end



--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------

if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')

begin

--print 'TradingMode or ClientGrade'

if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)

if @ClientGrade='ALL' set @ClientGrade='%'

--

update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating

From angelclient1 ac1 with(nolock),#PartyDetails ps

where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode

and ac1.AngelClRating like @ClientGrade

--

delete #PartyDetails where isnull(EbrokingClient,'')=''

--

end

-----------------------Update #PartyDetails as per report Wise option -------------------------------------

--print '1.1:'+convert(varchar,getdate(),109)

if @Wise='SUBBROKER'

begin

	update #PartyDetails set Emp_No=''

end 

--else if @Wise='ZONE'

--begin

--update #PartyDetails set Region='',Branch_cd='',Emp_No=''

--end

--else if @Wise='REGION'

--begin

--update #PartyDetails set Branch_cd='',Emp_No=''

--end

--else if @Wise='BRANCH'

--begin

--update #PartyDetails set Emp_No=''

--end

-----------------------Update FirstTrade date -------------------------------------

if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))

begin

	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 

		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code*/	

	

	if(@SegmentType in('COMMODITY'))

	begin

		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end

	else if(@SegmentType in('CURRENCY'))

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end		

	else --if(@SegmentType in('CASH','DERIVATIVE') and other

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTrade 

		from angelclient1 ac1 with(nolock),#PartyDetails ps 

		where ac1.Party_Code=ps.Party_Code

	end

end

--------------------------Fetch Brokerage in case when required-------------------------



/*



Select top 10 * from bsecm_cli



*/



if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))

begin

print '0.0'+convert(varchar,getdate(),109)

select distinct Party_code into #TTTT from #PartyDetails

CREATE NONCLUSTERED INDEX IX_Temp_Opt  
    ON #PartyDetails (Party_Code,FromDate,ToDate);   
CREATE NONCLUSTERED INDEX IX_Temp_Opt1  
    ON #TTTT (Party_Code);  
print '0.1'+convert(varchar,getdate(),109)

Select distinct L.* into #Ebrok_Details from Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),#TTTT PS
		where 
		L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		and ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

print '0.2'+convert(varchar,getdate(),109)

CREATE NONCLUSTERED INDEX IX_Temp_Opt_1  
    ON #Ebrok_Details (Party_Code);   

print '1.0'+convert(varchar,getdate(),109)

insert into #BrokTurnOver

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		Online_TurnOver=L.ebrok_TurnOver,

		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		GrossRevenue=L.Overall_brok_earned,

		GrossRevenue_Online=L.ebrok_brok_earned,

		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,

		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),

		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),

		--Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		#Ebrok_Details L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 

		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 

		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 

		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table

		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date

		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		--and L.ExceptClient='Y'

--print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

print '1.1'+convert(varchar,getdate(),109)

end







--select top 10 * From tbl_Exchangemapping

 

---------------------MAIN PAGE---------------------------------

if @ReportType='MAIN'

begin



-----------------------------Fill MIS Table--------------------------------------------------------------------

		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,

		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,

		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,

		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)

		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,

		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,

		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',

		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,

		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0

		from #PartyDetails		

		group by Branch_cd,Emp_No		

--print '1.2:'+convert(varchar,getdate(),109)

----------------------------------------Update Start Of Month Total Clients----------------------------------

		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth

		from

		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	

		from #PartyDetails ps 

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

--print '2:'+convert(varchar,getdate(),109)

-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------

		

--

--print '3.1 '+convert(varchar,getdate(),109)

--





update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,

DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,

AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),

AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),

AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),

--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),

--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),

 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,

 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue

--CONVERT(decimal(15,2),

		from 

		(

		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   

        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),

        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),

        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),

 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)

  

		from #BrokTurnOver b

		group by b.Branch_cd,b.Emp_No

		)A,	#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

----------------------Update NA-----------------------------

--update #MIStable

----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)



--Comment by sandip

--update #MIStable set ActivationRatio='NA'		

--where TotalClientsStartOfmonth<Tradedclients

update #MIStable set AvgDailyActRatio='NA'		

where TotalClientsStartOfmonth<AvgTradedclients

-----------------------------------------------Activation Ratio---------------------

select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 

	into #RegActiveClients

	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by Sauda_date,Branch_cd,Emp_no)A 

	group by Branch_cd,Emp_no

	--order by 1

	--select * from #RegActiveClients

--Activation main page



--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays

--else 0.00 end)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--



update #MIStable set 

DailyTradedClients_AR=A.DailyTradedClients

from 

(select b.Branch_cd,b.Emp_No,

 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)

 

 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)

		where TD.CMTradingDay='Y'

		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)

	group by b.Branch_cd,b.Emp_No

)A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		





--select @DailyTradedClients_AR		

update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays

else 0.00 end)

from #RegActiveClients A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--



--select DailyTradedClients_AR,DailyTradeDays from #MIStable



update #MIStable

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)





---------------------------------------------------------Update AS ON CLIENTS----------------------------------

--print '3.2:'+convert(varchar,getdate(),109)

if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)

begin

		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate

		from 

		(

		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

		from #PartyDetails ps

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

		--------------------------------Calculate Productivity--------------------------------------------------------------

		if @Wise='DEALER'

		begin

			Declare @Act_Days int,@H_days int

			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              

			set @H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

						where holidaydate >= @FromDate and holidaydate <= @ToDate )   

			--print @TradeDays

			--print @Act_Days

			--print @H_days

			--if(@SegmentType='Currency')

			--begin

				--Fetch Emploee with CTC			

				

				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',

				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))

				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)

				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and

				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				

				

		

				--Update productivity for Employee

				--print 'productivity'

				--print @TradeDays

				--print (@Act_Days-@H_days)

				update #MIStable set 

				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 

								else '0.00' end)

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'

				

				

				/*--Print for testing

				select * from #ProdForCurr

				--Print RM

				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,

				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'

				*/

			--End		

			

		end

		--------------------------------End Calculate Productivity--------------------------------------------------------------

end

----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------

--print '4:'+convert(varchar,getdate(),109)

--

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded

		from #PartyDetails ps

		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

		and ps.FirstTrade<=@ToDate

		--Delete traded clients

		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)

--	

--print '4.1:'+convert(varchar,getdate(),109)

		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth

		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)

		from #nottraded ps

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

drop table #nottraded

--

--print '5:'+convert(varchar,getdate(),109)

		

			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate

			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)

			from #PartyDetails ps

			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	

			and ps.FirstTrade>@ToDate

			group by ps.Branch_cd,ps.Emp_No

			)A,#MIStable B

				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	

--

--print '6:'+convert(varchar,getdate(),109)

---------------------------------Update Client Visit Pending-------------------------

/*update #MIStable set ClientVisitPending=A.CVPcount

from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp

where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No

)A,#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region

print '7:'+convert(varchar,getdate(),109)*/

------------------------------DROP #PartyDetails---

drop table #PartyDetails

------------------------------DISPLAY------------------------------------------------

--print 'Wise: '

--print @Wise

if @Wise='DEALER'

begin

		--print 'DEALER'

		update #MIStable set Emp_Name=ah.EMP_NAME

					from #MIStable mis,B2B_AngelHarmony ah with(nolock)

					where mis.Emp_No=ah.EMP_NO

		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2,3

end

else

begin

		--print 'SUBBROKER'

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2

end

--TOTAL

--if @TotalFlag <> 'Y' 

if(isnull(@TotalFlag,'') in ('','N'))

begin



--select  

--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

--Tradedclients=isnull(sum(Tradedclients),0),

--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

--		else 0.00 end)),

--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



select  

TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

Tradedclients=isnull(sum(Tradedclients),0),

		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

		else 0.00 end)),

		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end

from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



--group by DailyTradeDays

--print 'End:'+convert(varchar,getdate(),109)

end 



END

---------------------MAIN PAGE END---------------------------------------------------

---------------------DRILL PAGE START---------------------------------------------------

else if @ReportType='DRILL'

begin

---------------------Declare drill page-------------------------------------------------

create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),

ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),

DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,

LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))



--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)

--

if @DrillFlag='TotalAsOn'

begin

--print 'Drill 1:'+convert(varchar,getdate(),109)



	   

		--select * from @rto_Data

			

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate				



--print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)

		

		if(@UserStatusId='SBDEALER')

		begin

			declare @rto_Data table

			(

			Zone varchar(20),

			Region varchar(20),

			branch_cd varchar(20),

			sub_broker varchar(20),

			Sub_brokerName varchar(200),

			party_code varchar(20),

			Short_name varchar(100),

			TotalTO money,

			OPTNoOfLots money,

			NoOfLotsGold bigint,

			NoOfLotsSilver bigint,

			NoOfLotsCopper bigint  ,

			NoOfLotsCrude bigint,

			NoOfLotsComm bigint,

			TargetNoOfLotsGold bigint,

			TargetNoOfLotsSilver bigint,

			TargetNoOfLotsCopper bigint,

			TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch='',

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='DRILL',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID='SBDEALER',

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			

			update #drillPartyDetails set TotalTo=rto.TotalTo

			from #drillPartyDetails drill, @rto_Data rto

			where drill.Party_Code=rto.party_code	

		end

		

			

		--

end

else if @DrillFlag='TotalStartOfMonth'

begin

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate	

end

else if @DrillFlag='NotTradedAsOn'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

				and ps.FirstTrade>@ToDate	

end

else if @DrillFlag='NotTradedForMonth'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				

				and ps.FirstTrade<=@ToDate		

		--

		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	

		--

end

else if @DrillFlag='Traded'

begin

		--Insert Traded Clients

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code

		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		

		

end

else if @DrillFlag='BROK'

begin		

		Declare @emp_name varchar(100)		

		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')



--Select * from #party_code



		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,

		br.Party_Code,ac1.Long_Name,

		--Turnover =sum(TotalTurnover),

        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 

		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        --NetRevnue =sum(NetRevenue),

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Sauda_date)  

		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code

		--inner join #party_code p on p.party_code=br.Party_Code

		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	

		

		--Total		

		--select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  

  --      OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

  --      OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

  --      TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver

		return

end

else if @DrillFlag='ACTIVECLI'

begin		

	

	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),

	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100

	into #FinalActiveCli

	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join

	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)

	 from #BrokTurnOver b

	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	order by 1,2,3

	--Display

	--select * from #FinalActiveCli

	select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli

	--Total Row

	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),

	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100

	 from #FinalActiveCli

	

return

end

---------------------Common Script for DRILL PAGE ---------------------------------------------------

	

--print 'Drill 3:'+convert(varchar,getdate(),109)		

		-- Update Portfolio i.e. Holding value

		update #drillPartyDetails                                                             

		set PortfolioInfo=isnull(H.TotalHold,0)            

		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [MIMANSA].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   

		on ps.party_code = H.party_code 

--print 'Drill 4:'+convert(varchar,getdate(),109)		

		--Update Ledger Value

		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger

		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [MIMANSA].Angelcs.dbo.View_LedgerInfo L with(nolock)

		on ps.party_code = L.party_code 

		--

		update #drillPartyDetails                                                             

		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)

		from #drillPartyDetails ps left outer join #totalLedger L

		on ps.party_code = L.party_code 

		--

		drop table #totalLedger		

--print 'Drill 5:'+convert(varchar,getdate(),109)			

		--Update Current Dealer

		update #drillPartyDetails set DealerCode=cps.Emp_No			

		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )

		where --cps.Segment_Type=@SegmentType and 

		/*EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and*/

		ps.Party_Code =cps.Party_Code and

		cps.Valid='Y' and cps.CommRank='1'

		--Set Row color as per BRS point 4.3.4 & 4.3.5

--print 'Drill 6:'+convert(varchar,getdate(),109)	

		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	

		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)

		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'

		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)

		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)

		--		

--print 'Drill End:'+convert(varchar,getdate(),109)		

		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',

		SB=Branch_cd,Party_Code,Client_Name,Emp_No,

		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),

		ClientGrade,[Profile],Sub_Profile,

		--ActiveFrom,

		ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),

		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)

		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),

		PureRisk=convert(decimal(15,2),PureRisk),

		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),

		--LastTradeDate,

		LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,

		RowColor,LedgerColor,

		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)

		

		 from #drillPartyDetails s

		 order by SrNo

		 --Total

		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),

		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))

		  from #drillPartyDetails



--Drop table #party_code

-------------------

end

---------------------DRILL PAGE END---------------------------------------------------

END

---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_NXT_V1_bkp11Jul2024
-- --------------------------------------------------
CREATE procedure [dbo].[SBB2B_MIS_NXT_V1_bkp11Jul2024]

		 @UserEmp_No varchar(20),

		 @UserStatusId varchar(10),--SUBBROKER/SBDEALER

		 @Sub_Broker varchar(10),

		 @Dealer varchar(20),

		 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE

		 @ClientGrade varchar(15),--ALL,A+,A,B,C,D

		 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency

		 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012

		 @ToDate smalldatetime,

		 @Wise varchar(20),       --SUBBROKER/DEALER

		 @ReportType varchar(20), --MAIN/DRILL

		 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI

		 @TotalFlag varchar(2) = null

		 --,		 @party_code varchar(max)

 as

 BEGIN

Set nocount on

/*

exec [SBB2B_MIS_NXT_V1] 
@UserEmp_No='VIBU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIBU',@Dealer='',
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',
@FromDate='06 Nov 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',
@ToDate='11 Apr 2024'

exec [SBB2B_MIS] 

@UserEmp_No='VIVU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIVU',@Dealer='',
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',
@FromDate='06 Nov 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',
@ToDate='11 Apr 2024'

*/

--

--print 'Start:'+convert(varchar,getdate(),109)

 --Declare @ToDate smalldatetime

 Declare @FromDealer varchar(10)

 Declare @ToDealer varchar(10)

 Declare @FromEffSaudaDate datetime

 Declare @ToEffSaudaDate datetime

 Declare @TradeDays money

 Declare @SegmentTypeFrom varchar(10)

 Declare @SegmentTypeTo varchar(10)

 Declare @FromSub_Broker varchar(10)

 Declare @ToSub_Broker varchar(10)

 



 --Create table #party_code

 --(

 --   party_code varchar(100)

 --)



 --insert into #party_code

 --select * from [fn_Split] (@party_code,',')





 --------------------------------Set From and TO date---------------------------------------

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'

--set @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+' 00:00'



set  @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+ ' 23:59'



--set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'





--print @FromDate

--print @ToDate

set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))

set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))

set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))

set @Dealer=upper(ltrim(rtrim(@Dealer)))

set @TradingMode=upper(ltrim(rtrim(@TradingMode)))

set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))

set @SegmentType=upper(ltrim(rtrim(@SegmentType)))

set @Wise=upper(ltrim(rtrim(@Wise)))

set @ReportType=upper(ltrim(rtrim(@ReportType)))

set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))

 ---------------------------------------Get count of Trade Days---------------------------------------------

 /* Added table date for the Currency Segment */

if(@SegmentType = 'CURRENCY')

begin

   set @SegmentTypeFrom  ='CURRENCY'

   set @SegmentTypeTo='CURRENCY'

   

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'

end

else

begin

			if(@SegmentType = 'CASH')

			begin

			set @SegmentTypeFrom  ='CASH'

			set @SegmentTypeTo='CASH'

			End



			if(@SegmentType = 'DERIVATIVE')

			begin

			set @SegmentTypeFrom  ='DERIVATIVE'

			set @SegmentTypeTo='DERIVATIVE'

			End

			

			if(@SegmentType = 'COMMODITY')

			begin

			set @SegmentTypeFrom  ='COMMODITY'

			set @SegmentTypeTo='COMMODITY'

			End



			if(@SegmentType = 'All')

			begin

			set @SegmentTypeFrom  ='a'

			set @SegmentTypeTo='zzzzzz'

			End

			

			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'

	end

 



 

--print @TradeDays

 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------

 

 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 

 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

 

 

----------------------------------------Redefine Report Wise option as per input fields-----------------------



set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)



--print @Wise

-------------------------------------------------------------------------

/**subbroker*/

if @Sub_Broker='' or @Sub_Broker='ALL' 

Begin

	set @FromSub_Broker='A'

	set @ToSub_Broker='ZZZZZZZ'

End

else

Begin

	Set @FromSub_Broker=@Sub_Broker

	Set @ToSub_Broker=@Sub_Broker

End



--if @Dealer='' or @Dealer='ALL' set @Dealer='%'

--

/**subbrokerdealer*/

if @Dealer='' or @Dealer='ALL' 

begin

	set @FromDealer='A'

	set @ToDealer='ZZZZZZZ'

end

else

begin

	set @FromDealer=@Dealer

	set @ToDealer=@Dealer

end

--

--------------------------User Access---------------------------------------------------



/*fill subbrokers and dealers*/

declare @tempbranch  table                                                                

(                                                                

Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

)



Insert into @tempbranch

select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

 



----------------------------Declare MIS and PartyDetails Table--------------------------



create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

)

--



create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime)

--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)

--

 --Declare  @MIStable table  

 create table #MIStable                                                         

 (                                                          

 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,

 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,

 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,

 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),

 OnlineTurnover money, OfflineTurnover money, Turnover money,

 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int

 )                                                        

--

--print 'Access:'+convert(varchar,getdate(),109)

if @Dealer='' or @Dealer='ALL' 

begin

		--		

		--print 'ACT1'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd 

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		--and ps.Segment_Type=@SegmentType

		

end 

else

begin

		--print 'ACT2'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		and ps.Emp_No>=@FromDealer

		and ps.Emp_No<=@ToDealer

		--and ps.Segment_Type=@SegmentType

end



--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------

if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')

begin

--print 'TradingMode or ClientGrade'

if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)

if @ClientGrade='ALL' set @ClientGrade='%'

--

update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating

From angelclient1 ac1 with(nolock),#PartyDetails ps

where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode

and ac1.AngelClRating like @ClientGrade

--

delete #PartyDetails where isnull(EbrokingClient,'')=''

--

end

-----------------------Update #PartyDetails as per report Wise option -------------------------------------

--print '1.1:'+convert(varchar,getdate(),109)

if @Wise='SUBBROKER'

begin

	update #PartyDetails set Emp_No=''

end 

--else if @Wise='ZONE'

--begin

--update #PartyDetails set Region='',Branch_cd='',Emp_No=''

--end

--else if @Wise='REGION'

--begin

--update #PartyDetails set Branch_cd='',Emp_No=''

--end

--else if @Wise='BRANCH'

--begin

--update #PartyDetails set Emp_No=''

--end

-----------------------Update FirstTrade date -------------------------------------

if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))

begin

	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 

		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code*/	

	

	if(@SegmentType in('COMMODITY'))

	begin

		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end

	else if(@SegmentType in('CURRENCY'))

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end		

	else --if(@SegmentType in('CASH','DERIVATIVE') and other

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTrade 

		from angelclient1 ac1 with(nolock),#PartyDetails ps 

		where ac1.Party_Code=ps.Party_Code

	end

end

--------------------------Fetch Brokerage in case when required-------------------------



/*



Select top 10 * from bsecm_cli



*/



if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))

begin

--print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)

/*print 'Segment'

print @SegmentTypeFrom

print @SegmentTypeTo

print 'Eff Date'

print @FromEffSaudaDate

print @ToEffSaudaDate

print 'Date'

print @FromDate

print @ToDate*/

/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 

from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */

--



insert into #BrokTurnOver

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		Online_TurnOver=L.ebrok_TurnOver,

		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		GrossRevenue=L.Overall_brok_earned,

		GrossRevenue_Online=L.ebrok_brok_earned,

		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,

		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),

		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 

		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 

		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 

		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table

		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date

		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		--and L.ExceptClient='Y'

--print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)



end







--select top 10 * From tbl_Exchangemapping

 

---------------------MAIN PAGE---------------------------------

if @ReportType='MAIN'

begin



-----------------------------Fill MIS Table--------------------------------------------------------------------

		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,

		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,

		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,

		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)

		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,

		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,

		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',

		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,

		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0

		from #PartyDetails		

		group by Branch_cd,Emp_No		

--print '1.2:'+convert(varchar,getdate(),109)

----------------------------------------Update Start Of Month Total Clients----------------------------------

		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth

		from

		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	

		from #PartyDetails ps 

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

--print '2:'+convert(varchar,getdate(),109)

-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------

		

--

--print '3.1 '+convert(varchar,getdate(),109)

--





update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,

DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,

AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),

AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),

AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),

--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),

--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),

 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,

 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue

--CONVERT(decimal(15,2),

		from 

		(

		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   

        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),

        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),

        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),

 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)

  

		from #BrokTurnOver b

		group by b.Branch_cd,b.Emp_No

		)A,	#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

----------------------Update NA-----------------------------

--update #MIStable

----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)



--Comment by sandip

--update #MIStable set ActivationRatio='NA'		

--where TotalClientsStartOfmonth<Tradedclients

update #MIStable set AvgDailyActRatio='NA'		

where TotalClientsStartOfmonth<AvgTradedclients

-----------------------------------------------Activation Ratio---------------------

select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 

	into #RegActiveClients

	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by Sauda_date,Branch_cd,Emp_no)A 

	group by Branch_cd,Emp_no

	--order by 1

	--select * from #RegActiveClients

--Activation main page



--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays

--else 0.00 end)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--



update #MIStable set 

DailyTradedClients_AR=A.DailyTradedClients

from 

(select b.Branch_cd,b.Emp_No,

 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)

 

 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)

		where TD.CMTradingDay='Y'

		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)

	group by b.Branch_cd,b.Emp_No

)A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		





--select @DailyTradedClients_AR		

update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays

else 0.00 end)

from #RegActiveClients A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--



--select DailyTradedClients_AR,DailyTradeDays from #MIStable



update #MIStable

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)





---------------------------------------------------------Update AS ON CLIENTS----------------------------------

--print '3.2:'+convert(varchar,getdate(),109)

if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)

begin

		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate

		from 

		(

		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

		from #PartyDetails ps

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

		--------------------------------Calculate Productivity--------------------------------------------------------------

		if @Wise='DEALER'

		begin

			Declare @Act_Days int,@H_days int

			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              

			set @H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

						where holidaydate >= @FromDate and holidaydate <= @ToDate )   

			--print @TradeDays

			--print @Act_Days

			--print @H_days

			--if(@SegmentType='Currency')

			--begin

				--Fetch Emploee with CTC			

				

				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',

				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))

				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)

				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and

				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				

				

		

				--Update productivity for Employee

				--print 'productivity'

				--print @TradeDays

				--print (@Act_Days-@H_days)

				update #MIStable set 

				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 

								else '0.00' end)

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'

				

				

				/*--Print for testing

				select * from #ProdForCurr

				--Print RM

				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,

				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'

				*/

			--End		

			

		end

		--------------------------------End Calculate Productivity--------------------------------------------------------------

end

----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------

--print '4:'+convert(varchar,getdate(),109)

--

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded

		from #PartyDetails ps

		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

		and ps.FirstTrade<=@ToDate

		--Delete traded clients

		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)

--	

--print '4.1:'+convert(varchar,getdate(),109)

		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth

		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)

		from #nottraded ps

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

drop table #nottraded

--

--print '5:'+convert(varchar,getdate(),109)

		

			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate

			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)

			from #PartyDetails ps

			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	

			and ps.FirstTrade>@ToDate

			group by ps.Branch_cd,ps.Emp_No

			)A,#MIStable B

				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	

--

--print '6:'+convert(varchar,getdate(),109)

---------------------------------Update Client Visit Pending-------------------------

/*update #MIStable set ClientVisitPending=A.CVPcount

from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp

where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No

)A,#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region

print '7:'+convert(varchar,getdate(),109)*/

------------------------------DROP #PartyDetails---

drop table #PartyDetails

------------------------------DISPLAY------------------------------------------------

--print 'Wise: '

--print @Wise

if @Wise='DEALER'

begin

		--print 'DEALER'

		update #MIStable set Emp_Name=ah.EMP_NAME

					from #MIStable mis,B2B_AngelHarmony ah with(nolock)

					where mis.Emp_No=ah.EMP_NO

		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2,3

end

else

begin

		--print 'SUBBROKER'

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2

end

--TOTAL

--if @TotalFlag <> 'Y' 

if(isnull(@TotalFlag,'') in ('','N'))

begin



--select  

--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

--Tradedclients=isnull(sum(Tradedclients),0),

--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

--		else 0.00 end)),

--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



select  

TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

Tradedclients=isnull(sum(Tradedclients),0),

		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

		else 0.00 end)),

		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end

from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



--group by DailyTradeDays

--print 'End:'+convert(varchar,getdate(),109)

end 



END

---------------------MAIN PAGE END---------------------------------------------------

---------------------DRILL PAGE START---------------------------------------------------

else if @ReportType='DRILL'

begin

---------------------Declare drill page-------------------------------------------------

create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),

ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),

DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,

LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))



--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)

--

if @DrillFlag='TotalAsOn'

begin

--print 'Drill 1:'+convert(varchar,getdate(),109)



	   

		--select * from @rto_Data

			

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate				



--print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)

		

		if(@UserStatusId='SBDEALER')

		begin

			declare @rto_Data table

			(

			Zone varchar(20),

			Region varchar(20),

			branch_cd varchar(20),

			sub_broker varchar(20),

			Sub_brokerName varchar(200),

			party_code varchar(20),

			Short_name varchar(100),

			TotalTO money,

			OPTNoOfLots money,

			NoOfLotsGold bigint,

			NoOfLotsSilver bigint,

			NoOfLotsCopper bigint  ,

			NoOfLotsCrude bigint,

			NoOfLotsComm bigint,

			TargetNoOfLotsGold bigint,

			TargetNoOfLotsSilver bigint,

			TargetNoOfLotsCopper bigint,

			TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch='',

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='DRILL',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID='SBDEALER',

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			

			update #drillPartyDetails set TotalTo=rto.TotalTo

			from #drillPartyDetails drill, @rto_Data rto

			where drill.Party_Code=rto.party_code	

		end

		

			

		--

end

else if @DrillFlag='TotalStartOfMonth'

begin

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate	

end

else if @DrillFlag='NotTradedAsOn'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

				and ps.FirstTrade>@ToDate	

end

else if @DrillFlag='NotTradedForMonth'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				

				and ps.FirstTrade<=@ToDate		

		--

		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	

		--

end

else if @DrillFlag='Traded'

begin

		--Insert Traded Clients

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code

		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		

		

end

else if @DrillFlag='BROK'

begin		

		Declare @emp_name varchar(100)		

		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')



--Select * from #party_code



		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,

		br.Party_Code,ac1.Long_Name,

		--Turnover =sum(TotalTurnover),

        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 

		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        --NetRevnue =sum(NetRevenue),

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Sauda_date)  

		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code

		--inner join #party_code p on p.party_code=br.Party_Code

		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	

		

		--Total		

		--select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  

  --      OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

  --      OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

  --      TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver

		return

end

else if @DrillFlag='ACTIVECLI'

begin		

	

	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),

	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100

	into #FinalActiveCli

	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join

	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)

	 from #BrokTurnOver b

	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	order by 1,2,3

	--Display

	--select * from #FinalActiveCli

	select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli

	--Total Row

	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),

	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100

	 from #FinalActiveCli

	

return

end

---------------------Common Script for DRILL PAGE ---------------------------------------------------

	

--print 'Drill 3:'+convert(varchar,getdate(),109)		

		-- Update Portfolio i.e. Holding value

		update #drillPartyDetails                                                             

		set PortfolioInfo=isnull(H.TotalHold,0)            

		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [MIMANSA].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   

		on ps.party_code = H.party_code 

--print 'Drill 4:'+convert(varchar,getdate(),109)		

		--Update Ledger Value

		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger

		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [MIMANSA].Angelcs.dbo.View_LedgerInfo L with(nolock)

		on ps.party_code = L.party_code 

		--

		update #drillPartyDetails                                                             

		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)

		from #drillPartyDetails ps left outer join #totalLedger L

		on ps.party_code = L.party_code 

		--

		drop table #totalLedger		

--print 'Drill 5:'+convert(varchar,getdate(),109)			

		--Update Current Dealer

		update #drillPartyDetails set DealerCode=cps.Emp_No			

		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )

		where --cps.Segment_Type=@SegmentType and 

		/*EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and*/

		ps.Party_Code =cps.Party_Code and

		cps.Valid='Y' and cps.CommRank='1'

		--Set Row color as per BRS point 4.3.4 & 4.3.5

--print 'Drill 6:'+convert(varchar,getdate(),109)	

		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	

		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)

		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'

		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)

		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)

		--		

--print 'Drill End:'+convert(varchar,getdate(),109)		

		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',

		SB=Branch_cd,Party_Code,Client_Name,Emp_No,

		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),

		ClientGrade,[Profile],Sub_Profile,

		--ActiveFrom,

		ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),

		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)

		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),

		PureRisk=convert(decimal(15,2),PureRisk),

		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),

		--LastTradeDate,

		LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,

		RowColor,LedgerColor,

		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)

		

		 from #drillPartyDetails s

		 order by SrNo

		 --Total

		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),

		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))

		  from #drillPartyDetails



--Drop table #party_code

-------------------

end

---------------------DRILL PAGE END---------------------------------------------------

END

---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_NXT_V1_Opti
-- --------------------------------------------------
CREATE procedure [dbo].[SBB2B_MIS_NXT_V1_Opti]
(
		@UserEmp_No varchar(20),
		 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
		 @Sub_Broker varchar(10),
		 @Dealer varchar(20),
		 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
		 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
		 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
		 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
		 @ToDate smalldatetime,
		 @Wise varchar(20),       --SUBBROKER/DEALER
		 @ReportType varchar(20), --MAIN/DRILL
		 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
		 @TotalFlag varchar(2) = null
		 --,		 @party_code varchar(max)
 )
 with recompile
 as
 BEGIN

Set nocount on

--Select @UserEmp_No='VIBU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIBU',@Dealer='',
--@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',
--@FromDate='11 Apr 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',
--@ToDate='11 Apr 2024'


/*

exec [SBB2B_MIS_NXT_V1] 
@UserEmp_No='VIBU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIBU',@Dealer='',
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',
@FromDate='06 Nov 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',
@ToDate='11 Apr 2024'

exec [SBB2B_MIS] 

@UserEmp_No='VIVU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIVU',@Dealer='',
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',
@FromDate='06 Nov 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',
@ToDate='11 Apr 2024'

*/

--

--print 'Start:'+convert(varchar,getdate(),109)

 --Declare @ToDate smalldatetime

 Declare @FromDealer varchar(10)

 Declare @ToDealer varchar(10)

 Declare @FromEffSaudaDate datetime

 Declare @ToEffSaudaDate datetime

 Declare @TradeDays money

 Declare @SegmentTypeFrom varchar(10)

 Declare @SegmentTypeTo varchar(10)

 Declare @FromSub_Broker varchar(10)

 Declare @ToSub_Broker varchar(10)

 
select * into #angelclient1 from angelclient1 with (nolock) where sub_broker=@Sub_Broker


 --Create table #party_code

 --(

 --   party_code varchar(100)

 --)



 --insert into #party_code

 --select * from [fn_Split] (@party_code,',')





 --------------------------------Set From and TO date---------------------------------------

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'

--set @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+' 00:00'



set  @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+ ' 23:59'



--set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'





--print @FromDate

--print @ToDate

set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))

set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))

set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))

set @Dealer=upper(ltrim(rtrim(@Dealer)))

set @TradingMode=upper(ltrim(rtrim(@TradingMode)))

set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))

set @SegmentType=upper(ltrim(rtrim(@SegmentType)))

set @Wise=upper(ltrim(rtrim(@Wise)))

set @ReportType=upper(ltrim(rtrim(@ReportType)))

set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))

 ---------------------------------------Get count of Trade Days---------------------------------------------

 /* Added table date for the Currency Segment */

if(@SegmentType = 'CURRENCY')

begin

   set @SegmentTypeFrom  ='CURRENCY'

   set @SegmentTypeTo='CURRENCY'

   

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'

end

else

begin

			if(@SegmentType = 'CASH')

			begin

			set @SegmentTypeFrom  ='CASH'

			set @SegmentTypeTo='CASH'

			End



			if(@SegmentType = 'DERIVATIVE')

			begin

			set @SegmentTypeFrom  ='DERIVATIVE'

			set @SegmentTypeTo='DERIVATIVE'

			End

			

			if(@SegmentType = 'COMMODITY')

			begin

			set @SegmentTypeFrom  ='COMMODITY'

			set @SegmentTypeTo='COMMODITY'

			End



			if(@SegmentType = 'All')

			begin

			set @SegmentTypeFrom  ='a'

			set @SegmentTypeTo='zzzzzz'

			End

			

			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'

	end

 



 

--print @TradeDays

 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------

 

 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 

 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

 

 

----------------------------------------Redefine Report Wise option as per input fields-----------------------



set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)



--print @Wise

-------------------------------------------------------------------------

/**subbroker*/

if @Sub_Broker='' or @Sub_Broker='ALL' 

Begin

	set @FromSub_Broker='A'

	set @ToSub_Broker='ZZZZZZZ'

End

else

Begin

	Set @FromSub_Broker=@Sub_Broker

	Set @ToSub_Broker=@Sub_Broker

End



--if @Dealer='' or @Dealer='ALL' set @Dealer='%'

--

/**subbrokerdealer*/

if @Dealer='' or @Dealer='ALL' 

begin

	set @FromDealer='A'

	set @ToDealer='ZZZZZZZ'

end

else

begin

	set @FromDealer=@Dealer

	set @ToDealer=@Dealer

end

--

--------------------------User Access---------------------------------------------------



/*fill subbrokers and dealers*/

declare @tempbranch  table                                                                

(                                                                

Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

)



Insert into @tempbranch

select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

 



----------------------------Declare MIS and PartyDetails Table--------------------------



create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

)

--



create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime)

--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)

--

 --Declare  @MIStable table  

 create table #MIStable                                                         

 (                                                          

 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,

 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,

 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,

 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),

 OnlineTurnover money, OfflineTurnover money, Turnover money,

 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int

 )                                                        

--

--print 'Access:'+convert(varchar,getdate(),109)

if @Dealer='' or @Dealer='ALL' 

begin

		--		

		--print 'ACT1'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd 

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		--and ps.Segment_Type=@SegmentType

		

end 

else

begin

		--print 'ACT2'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		and ps.Emp_No>=@FromDealer

		and ps.Emp_No<=@ToDealer

		--and ps.Segment_Type=@SegmentType

end



--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------

if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')

begin

--print 'TradingMode or ClientGrade'

if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)

if @ClientGrade='ALL' set @ClientGrade='%'

--

update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating

From #angelclient1 ac1 with(nolock),#PartyDetails ps

where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode

and ac1.AngelClRating like @ClientGrade

--

delete #PartyDetails where isnull(EbrokingClient,'')=''

--

end

-----------------------Update #PartyDetails as per report Wise option -------------------------------------

--print '1.1:'+convert(varchar,getdate(),109)

if @Wise='SUBBROKER'

begin

	update #PartyDetails set Emp_No=''

end 

--else if @Wise='ZONE'

--begin

--update #PartyDetails set Region='',Branch_cd='',Emp_No=''

--end

--else if @Wise='REGION'

--begin

--update #PartyDetails set Branch_cd='',Emp_No=''

--end

--else if @Wise='BRANCH'

--begin

--update #PartyDetails set Emp_No=''

--end

-----------------------Update FirstTrade date -------------------------------------

if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))

begin

	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 

		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code*/	

	

	if(@SegmentType in('COMMODITY'))

	begin

		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end

	else if(@SegmentType in('CURRENCY'))

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end		

	else --if(@SegmentType in('CASH','DERIVATIVE') and other

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTrade 

		from angelclient1 ac1 with(nolock),#PartyDetails ps 

		where ac1.Party_Code=ps.Party_Code

	end

end

--------------------------Fetch Brokerage in case when required-------------------------



/*



Select top 10 * from bsecm_cli



*/



if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))

begin

--print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)

/*print 'Segment'

print @SegmentTypeFrom

print @SegmentTypeTo

print 'Eff Date'

print @FromEffSaudaDate

print @ToEffSaudaDate

print 'Date'

print @FromDate

print @ToDate*/

/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 

from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */

--



insert into #BrokTurnOver

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		Online_TurnOver=L.ebrok_TurnOver,

		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		GrossRevenue=L.Overall_brok_earned,

		GrossRevenue_Online=L.ebrok_brok_earned,

		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,

		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),

		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 

		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 

		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 

		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table

		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date

		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		--and L.ExceptClient='Y'

--print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)



end







--select top 10 * From tbl_Exchangemapping

 

---------------------MAIN PAGE---------------------------------

if @ReportType='MAIN'

begin



-----------------------------Fill MIS Table--------------------------------------------------------------------

		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,

		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,

		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,

		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)

		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,

		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,

		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',

		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,

		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0

		from #PartyDetails		

		group by Branch_cd,Emp_No		

--print '1.2:'+convert(varchar,getdate(),109)

----------------------------------------Update Start Of Month Total Clients----------------------------------

		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth

		from

		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	

		from #PartyDetails ps 

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

--print '2:'+convert(varchar,getdate(),109)

-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------

		

--

--print '3.1 '+convert(varchar,getdate(),109)

--





update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,

DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,

AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),

AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),

AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),

--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),

--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),

 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,

 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue

--CONVERT(decimal(15,2),

		from 

		(

		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   

        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),

        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),

        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),

 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)

  

		from #BrokTurnOver b

		group by b.Branch_cd,b.Emp_No

		)A,	#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

----------------------Update NA-----------------------------

--update #MIStable

----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)



--Comment by sandip

--update #MIStable set ActivationRatio='NA'		

--where TotalClientsStartOfmonth<Tradedclients

update #MIStable set AvgDailyActRatio='NA'		

where TotalClientsStartOfmonth<AvgTradedclients

-----------------------------------------------Activation Ratio---------------------

select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 

	into #RegActiveClients

	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by Sauda_date,Branch_cd,Emp_no)A 

	group by Branch_cd,Emp_no

	--order by 1

	--select * from #RegActiveClients

--Activation main page



--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays

--else 0.00 end)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--



update #MIStable set 

DailyTradedClients_AR=A.DailyTradedClients

from 

(select b.Branch_cd,b.Emp_No,

 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)

 

 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)

		where TD.CMTradingDay='Y'

		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)

	group by b.Branch_cd,b.Emp_No

)A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		





--select @DailyTradedClients_AR		

update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays

else 0.00 end)

from #RegActiveClients A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--



--select DailyTradedClients_AR,DailyTradeDays from #MIStable



update #MIStable

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)





---------------------------------------------------------Update AS ON CLIENTS----------------------------------

--print '3.2:'+convert(varchar,getdate(),109)

if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)

begin

		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate

		from 

		(

		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

		from #PartyDetails ps

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

		--------------------------------Calculate Productivity--------------------------------------------------------------

		if @Wise='DEALER'

		begin

			Declare @Act_Days int,@H_days int

			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              

			set @H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

						where holidaydate >= @FromDate and holidaydate <= @ToDate )   

			--print @TradeDays

			--print @Act_Days

			--print @H_days

			--if(@SegmentType='Currency')

			--begin

				--Fetch Emploee with CTC			

				

				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',

				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))

				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)

				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and

				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				

				

		

				--Update productivity for Employee

				--print 'productivity'

				--print @TradeDays

				--print (@Act_Days-@H_days)

				update #MIStable set 

				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 

								else '0.00' end)

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'

				

				

				/*--Print for testing

				select * from #ProdForCurr

				--Print RM

				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,

				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'

				*/

			--End		

			

		end

		--------------------------------End Calculate Productivity--------------------------------------------------------------

end

----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------

--print '4:'+convert(varchar,getdate(),109)

--

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded

		from #PartyDetails ps

		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

		and ps.FirstTrade<=@ToDate

		--Delete traded clients

		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)

--	

--print '4.1:'+convert(varchar,getdate(),109)

		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth

		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)

		from #nottraded ps

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

drop table #nottraded

--

--print '5:'+convert(varchar,getdate(),109)

		

			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate

			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)

			from #PartyDetails ps

			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	

			and ps.FirstTrade>@ToDate

			group by ps.Branch_cd,ps.Emp_No

			)A,#MIStable B

				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	

--

--print '6:'+convert(varchar,getdate(),109)

---------------------------------Update Client Visit Pending-------------------------

/*update #MIStable set ClientVisitPending=A.CVPcount

from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp

where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No

)A,#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region

print '7:'+convert(varchar,getdate(),109)*/

------------------------------DROP #PartyDetails---

drop table #PartyDetails

------------------------------DISPLAY------------------------------------------------

--print 'Wise: '

--print @Wise

if @Wise='DEALER'

begin

		--print 'DEALER'

		update #MIStable set Emp_Name=ah.EMP_NAME

					from #MIStable mis,B2B_AngelHarmony ah with(nolock)

					where mis.Emp_No=ah.EMP_NO

		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2,3

end

else

begin

		--print 'SUBBROKER'

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2

end

--TOTAL

--if @TotalFlag <> 'Y' 

if(isnull(@TotalFlag,'') in ('','N'))

begin



--select  

--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

--Tradedclients=isnull(sum(Tradedclients),0),

--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

--		else 0.00 end)),

--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



select  

TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

Tradedclients=isnull(sum(Tradedclients),0),

		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

		else 0.00 end)),

		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end

from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



--group by DailyTradeDays

--print 'End:'+convert(varchar,getdate(),109)

end 



END

---------------------MAIN PAGE END---------------------------------------------------

---------------------DRILL PAGE START---------------------------------------------------

else if @ReportType='DRILL'

begin

---------------------Declare drill page-------------------------------------------------

create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),

ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),

DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,

LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))



--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)

--

if @DrillFlag='TotalAsOn'

begin

--print 'Drill 1:'+convert(varchar,getdate(),109)



	   

		--select * from @rto_Data

			

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate				



--print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)

		

		if(@UserStatusId='SBDEALER')

		begin

			declare @rto_Data table

			(

			Zone varchar(20),

			Region varchar(20),

			branch_cd varchar(20),

			sub_broker varchar(20),

			Sub_brokerName varchar(200),

			party_code varchar(20),

			Short_name varchar(100),

			TotalTO money,

			OPTNoOfLots money,

			NoOfLotsGold bigint,

			NoOfLotsSilver bigint,

			NoOfLotsCopper bigint  ,

			NoOfLotsCrude bigint,

			NoOfLotsComm bigint,

			TargetNoOfLotsGold bigint,

			TargetNoOfLotsSilver bigint,

			TargetNoOfLotsCopper bigint,

			TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch='',

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='DRILL',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID='SBDEALER',

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			

			update #drillPartyDetails set TotalTo=rto.TotalTo

			from #drillPartyDetails drill, @rto_Data rto

			where drill.Party_Code=rto.party_code	

		end

		

			

		--

end

else if @DrillFlag='TotalStartOfMonth'

begin

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate	

end

else if @DrillFlag='NotTradedAsOn'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

				and ps.FirstTrade>@ToDate	

end

else if @DrillFlag='NotTradedForMonth'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				

				and ps.FirstTrade<=@ToDate		

		--

		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	

		--

end

else if @DrillFlag='Traded'

begin

		--Insert Traded Clients

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code

		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		

		

end

else if @DrillFlag='BROK'

begin		

		Declare @emp_name varchar(100)		

		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')



--Select * from #party_code



		select 'test1',ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,

		br.Party_Code,ac1.Long_Name,

		--Turnover =sum(TotalTurnover),

        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 

		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        --NetRevnue =sum(NetRevenue),

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Sauda_date)  

		from #BrokTurnOver br inner join #angelclient1 ac1 ON br.Party_Code=ac1.Party_Code

		--inner join #party_code p on p.party_code=br.Party_Code

		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	

		

		--Total		

		--select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  

  --      OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

  --      OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

  --      TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver

		return

end

else if @DrillFlag='ACTIVECLI'

begin		

	

	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),

	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100

	into #FinalActiveCli

	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join

	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)

	 from #BrokTurnOver b

	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	order by 1,2,3

	--Display

	--select * from #FinalActiveCli

	select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli

	--Total Row

	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),

	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100

	 from #FinalActiveCli

	

return

end

---------------------Common Script for DRILL PAGE ---------------------------------------------------

	

--print 'Drill 3:'+convert(varchar,getdate(),109)		

		-- Update Portfolio i.e. Holding value

		update #drillPartyDetails                                                             

		set PortfolioInfo=isnull(H.TotalHold,0)            

		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [MIMANSA].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   

		on ps.party_code = H.party_code 

--print 'Drill 4:'+convert(varchar,getdate(),109)		

		--Update Ledger Value

		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger

		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [MIMANSA].Angelcs.dbo.View_LedgerInfo L with(nolock)

		on ps.party_code = L.party_code 

		--

		update #drillPartyDetails                                                             

		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)

		from #drillPartyDetails ps left outer join #totalLedger L

		on ps.party_code = L.party_code 

		--

		drop table #totalLedger		

--print 'Drill 5:'+convert(varchar,getdate(),109)			

		--Update Current Dealer

		update #drillPartyDetails set DealerCode=cps.Emp_No			

		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )

		where --cps.Segment_Type=@SegmentType and 

		/*EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and*/

		ps.Party_Code =cps.Party_Code and

		cps.Valid='Y' and cps.CommRank='1'

		--Set Row color as per BRS point 4.3.4 & 4.3.5

--print 'Drill 6:'+convert(varchar,getdate(),109)	

		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	

		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)

		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'

		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)

		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)

		--		

--print 'Drill End:'+convert(varchar,getdate(),109)		

		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',

		SB=Branch_cd,Party_Code,Client_Name,Emp_No,

		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),

		ClientGrade,[Profile],Sub_Profile,

		--ActiveFrom,

		ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),

		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)

		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),

		PureRisk=convert(decimal(15,2),PureRisk),

		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),

		--LastTradeDate,

		LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,

		RowColor,LedgerColor,

		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)

		

		 from #drillPartyDetails s

		 order by SrNo

		 --Total

		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),

		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))

		  from #drillPartyDetails



Drop table #party_code

-------------------

end

---------------------DRILL PAGE END---------------------------------------------------

END

---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_NXT_V1_UAT_Optimized
-- --------------------------------------------------
CREATE procedure [dbo].[SBB2B_MIS_NXT_V1_UAT_Optimized]

		 @UserEmp_No varchar(20),

		 @UserStatusId varchar(10),--SUBBROKER/SBDEALER

		 @Sub_Broker varchar(10),

		 @Dealer varchar(20),

		 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE

		 @ClientGrade varchar(15),--ALL,A+,A,B,C,D

		 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency

		 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012

		 @ToDate smalldatetime,

		 @Wise varchar(20),       --SUBBROKER/DEALER

		 @ReportType varchar(20), --MAIN/DRILL

		 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI

		 @TotalFlag varchar(2) = null

		 --,		 @party_code varchar(max)

 as

 BEGIN

Set nocount on

/*

exec [SBB2B_MIS_NXT_V1] 
@UserEmp_No='VIBU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIBU',@Dealer='',
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',
@FromDate='06 Nov 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',
@ToDate='11 Apr 2024'

exec [SBB2B_MIS] 

@UserEmp_No='VIVU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIVU',@Dealer='',
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',
@FromDate='06 Nov 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',
@ToDate='11 Apr 2024'

*/

--

--print 'Start:'+convert(varchar,getdate(),109)

 --Declare @ToDate smalldatetime

 Declare @FromDealer varchar(10)

 Declare @ToDealer varchar(10)

 Declare @FromEffSaudaDate datetime

 Declare @ToEffSaudaDate datetime

 Declare @TradeDays money

 Declare @SegmentTypeFrom varchar(10)

 Declare @SegmentTypeTo varchar(10)

 Declare @FromSub_Broker varchar(10)

 Declare @ToSub_Broker varchar(10)

 



 --Create table #party_code

 --(

 --   party_code varchar(100)

 --)



 --insert into #party_code

 --select * from [fn_Split] (@party_code,',')





 --------------------------------Set From and TO date---------------------------------------

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'

--set @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+' 00:00'



set  @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+ ' 23:59'



--set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'





--print @FromDate

--print @ToDate

set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))

set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))

set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))

set @Dealer=upper(ltrim(rtrim(@Dealer)))

set @TradingMode=upper(ltrim(rtrim(@TradingMode)))

set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))

set @SegmentType=upper(ltrim(rtrim(@SegmentType)))

set @Wise=upper(ltrim(rtrim(@Wise)))

set @ReportType=upper(ltrim(rtrim(@ReportType)))

set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))

 ---------------------------------------Get count of Trade Days---------------------------------------------

 /* Added table date for the Currency Segment */

if(@SegmentType = 'CURRENCY')

begin

   set @SegmentTypeFrom  ='CURRENCY'

   set @SegmentTypeTo='CURRENCY'

   

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'

end

else

begin

			if(@SegmentType = 'CASH')

			begin

			set @SegmentTypeFrom  ='CASH'

			set @SegmentTypeTo='CASH'

			End



			if(@SegmentType = 'DERIVATIVE')

			begin

			set @SegmentTypeFrom  ='DERIVATIVE'

			set @SegmentTypeTo='DERIVATIVE'

			End

			

			if(@SegmentType = 'COMMODITY')

			begin

			set @SegmentTypeFrom  ='COMMODITY'

			set @SegmentTypeTo='COMMODITY'

			End



			if(@SegmentType = 'All')

			begin

			set @SegmentTypeFrom  ='a'

			set @SegmentTypeTo='zzzzzz'

			End

			

			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'

	end

 



 

--print @TradeDays

 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------

 

 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 

 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

 

 

----------------------------------------Redefine Report Wise option as per input fields-----------------------



set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)



--print @Wise

-------------------------------------------------------------------------

/**subbroker*/

if @Sub_Broker='' or @Sub_Broker='ALL' 

Begin

	set @FromSub_Broker='A'

	set @ToSub_Broker='ZZZZZZZ'

End

else

Begin

	Set @FromSub_Broker=@Sub_Broker

	Set @ToSub_Broker=@Sub_Broker

End



--if @Dealer='' or @Dealer='ALL' set @Dealer='%'

--

/**subbrokerdealer*/

if @Dealer='' or @Dealer='ALL' 

begin

	set @FromDealer='A'

	set @ToDealer='ZZZZZZZ'

end

else

begin

	set @FromDealer=@Dealer

	set @ToDealer=@Dealer

end

--

--------------------------User Access---------------------------------------------------



/*fill subbrokers and dealers*/

declare @tempbranch  table                                                                

(                                                                

Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

)



Insert into @tempbranch

select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

 



----------------------------Declare MIS and PartyDetails Table--------------------------



create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

)

--



create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime)

--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)

--

 --Declare  @MIStable table  

 create table #MIStable                                                         

 (                                                          

 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,

 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,

 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,

 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),

 OnlineTurnover money, OfflineTurnover money, Turnover money,

 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int

 )                                                        

--

--print 'Access:'+convert(varchar,getdate(),109)

if @Dealer='' or @Dealer='ALL' 

begin

		--		

		--print 'ACT1'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd 

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		--and ps.Segment_Type=@SegmentType

		

end 

else

begin

		--print 'ACT2'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		and ps.Emp_No>=@FromDealer

		and ps.Emp_No<=@ToDealer

		--and ps.Segment_Type=@SegmentType

end



--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------

if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')

begin

--print 'TradingMode or ClientGrade'

if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)

if @ClientGrade='ALL' set @ClientGrade='%'

--

update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating

From angelclient1 ac1 with(nolock),#PartyDetails ps

where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode

and ac1.AngelClRating like @ClientGrade

--

delete #PartyDetails where isnull(EbrokingClient,'')=''

--

end

-----------------------Update #PartyDetails as per report Wise option -------------------------------------

--print '1.1:'+convert(varchar,getdate(),109)

if @Wise='SUBBROKER'

begin

	update #PartyDetails set Emp_No=''

end 

--else if @Wise='ZONE'

--begin

--update #PartyDetails set Region='',Branch_cd='',Emp_No=''

--end

--else if @Wise='REGION'

--begin

--update #PartyDetails set Branch_cd='',Emp_No=''

--end

--else if @Wise='BRANCH'

--begin

--update #PartyDetails set Emp_No=''

--end

-----------------------Update FirstTrade date -------------------------------------

if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))

begin

	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 

		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code*/	

	

	if(@SegmentType in('COMMODITY'))

	begin

		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end

	else if(@SegmentType in('CURRENCY'))

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end		

	else --if(@SegmentType in('CASH','DERIVATIVE') and other

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTrade 

		from angelclient1 ac1 with(nolock),#PartyDetails ps 

		where ac1.Party_Code=ps.Party_Code

	end

end

--------------------------Fetch Brokerage in case when required-------------------------



/*



Select top 10 * from bsecm_cli



*/



if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))

begin

print '0.0'+convert(varchar,getdate(),109)

select distinct Party_code into #TTTT from #PartyDetails

CREATE NONCLUSTERED INDEX IX_Temp_Opt  
    ON #PartyDetails (Party_Code,FromDate,ToDate);   
CREATE NONCLUSTERED INDEX IX_Temp_Opt1  
    ON #TTTT (Party_Code);  
print '0.1'+convert(varchar,getdate(),109)

Select distinct L.* into #Ebrok_Details from Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),#TTTT PS
		where 
		L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		and ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

print '0.2'+convert(varchar,getdate(),109)

CREATE NONCLUSTERED INDEX IX_Temp_Opt_1  
    ON #Ebrok_Details (Party_Code);   

print '1.0'+convert(varchar,getdate(),109)

insert into #BrokTurnOver

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		Online_TurnOver=L.ebrok_TurnOver,

		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		GrossRevenue=L.Overall_brok_earned,

		GrossRevenue_Online=L.ebrok_brok_earned,

		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,

		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),

		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),

		--Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		#Ebrok_Details L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 

		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 

		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 

		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table

		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date

		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		--and L.ExceptClient='Y'

--print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

print '1.1'+convert(varchar,getdate(),109)

end







--select top 10 * From tbl_Exchangemapping

 

---------------------MAIN PAGE---------------------------------

if @ReportType='MAIN'

begin



-----------------------------Fill MIS Table--------------------------------------------------------------------

		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,

		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,

		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,

		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)

		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,

		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,

		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',

		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,

		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0

		from #PartyDetails		

		group by Branch_cd,Emp_No		

--print '1.2:'+convert(varchar,getdate(),109)

----------------------------------------Update Start Of Month Total Clients----------------------------------

		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth

		from

		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	

		from #PartyDetails ps 

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

--print '2:'+convert(varchar,getdate(),109)

-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------

		

--

--print '3.1 '+convert(varchar,getdate(),109)

--





update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,

DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,

AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),

AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),

AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),

--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),

--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),

 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,

 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue

--CONVERT(decimal(15,2),

		from 

		(

		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   

        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),

        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),

        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),

 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)

  

		from #BrokTurnOver b

		group by b.Branch_cd,b.Emp_No

		)A,	#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

----------------------Update NA-----------------------------

--update #MIStable

----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)



--Comment by sandip

--update #MIStable set ActivationRatio='NA'		

--where TotalClientsStartOfmonth<Tradedclients

update #MIStable set AvgDailyActRatio='NA'		

where TotalClientsStartOfmonth<AvgTradedclients

-----------------------------------------------Activation Ratio---------------------

select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 

	into #RegActiveClients

	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by Sauda_date,Branch_cd,Emp_no)A 

	group by Branch_cd,Emp_no

	--order by 1

	--select * from #RegActiveClients

--Activation main page



--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays

--else 0.00 end)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--



update #MIStable set 

DailyTradedClients_AR=A.DailyTradedClients

from 

(select b.Branch_cd,b.Emp_No,

 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)

 

 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)

		where TD.CMTradingDay='Y'

		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)

	group by b.Branch_cd,b.Emp_No

)A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		





--select @DailyTradedClients_AR		

update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays

else 0.00 end)

from #RegActiveClients A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--



--select DailyTradedClients_AR,DailyTradeDays from #MIStable



update #MIStable

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)





---------------------------------------------------------Update AS ON CLIENTS----------------------------------

--print '3.2:'+convert(varchar,getdate(),109)

if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)

begin

		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate

		from 

		(

		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

		from #PartyDetails ps

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

		--------------------------------Calculate Productivity--------------------------------------------------------------

		if @Wise='DEALER'

		begin

			Declare @Act_Days int,@H_days int

			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              

			set @H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

						where holidaydate >= @FromDate and holidaydate <= @ToDate )   

			--print @TradeDays

			--print @Act_Days

			--print @H_days

			--if(@SegmentType='Currency')

			--begin

				--Fetch Emploee with CTC			

				

				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',

				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))

				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)

				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and

				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				

				

		

				--Update productivity for Employee

				--print 'productivity'

				--print @TradeDays

				--print (@Act_Days-@H_days)

				update #MIStable set 

				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 

								else '0.00' end)

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'

				

				

				/*--Print for testing

				select * from #ProdForCurr

				--Print RM

				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,

				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'

				*/

			--End		

			

		end

		--------------------------------End Calculate Productivity--------------------------------------------------------------

end

----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------

--print '4:'+convert(varchar,getdate(),109)

--

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded

		from #PartyDetails ps

		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

		and ps.FirstTrade<=@ToDate

		--Delete traded clients

		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)

--	

--print '4.1:'+convert(varchar,getdate(),109)

		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth

		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)

		from #nottraded ps

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

drop table #nottraded

--

--print '5:'+convert(varchar,getdate(),109)

		

			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate

			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)

			from #PartyDetails ps

			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	

			and ps.FirstTrade>@ToDate

			group by ps.Branch_cd,ps.Emp_No

			)A,#MIStable B

				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	

--

--print '6:'+convert(varchar,getdate(),109)

---------------------------------Update Client Visit Pending-------------------------

/*update #MIStable set ClientVisitPending=A.CVPcount

from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp

where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No

)A,#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region

print '7:'+convert(varchar,getdate(),109)*/

------------------------------DROP #PartyDetails---

drop table #PartyDetails

------------------------------DISPLAY------------------------------------------------

--print 'Wise: '

--print @Wise

if @Wise='DEALER'

begin

		--print 'DEALER'

		update #MIStable set Emp_Name=ah.EMP_NAME

					from #MIStable mis,B2B_AngelHarmony ah with(nolock)

					where mis.Emp_No=ah.EMP_NO

		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2,3

end

else

begin

		--print 'SUBBROKER'

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2

end

--TOTAL

--if @TotalFlag <> 'Y' 

if(isnull(@TotalFlag,'') in ('','N'))

begin



--select  

--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

--Tradedclients=isnull(sum(Tradedclients),0),

--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

--		else 0.00 end)),

--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



select  

TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

Tradedclients=isnull(sum(Tradedclients),0),

		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

		else 0.00 end)),

		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end

from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



--group by DailyTradeDays

--print 'End:'+convert(varchar,getdate(),109)

end 



END

---------------------MAIN PAGE END---------------------------------------------------

---------------------DRILL PAGE START---------------------------------------------------

else if @ReportType='DRILL'

begin

---------------------Declare drill page-------------------------------------------------

create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),

ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),

DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,

LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))



--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)

--

if @DrillFlag='TotalAsOn'

begin

--print 'Drill 1:'+convert(varchar,getdate(),109)



	   

		--select * from @rto_Data

			

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate				



--print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)

		

		if(@UserStatusId='SBDEALER')

		begin

			declare @rto_Data table

			(

			Zone varchar(20),

			Region varchar(20),

			branch_cd varchar(20),

			sub_broker varchar(20),

			Sub_brokerName varchar(200),

			party_code varchar(20),

			Short_name varchar(100),

			TotalTO money,

			OPTNoOfLots money,

			NoOfLotsGold bigint,

			NoOfLotsSilver bigint,

			NoOfLotsCopper bigint  ,

			NoOfLotsCrude bigint,

			NoOfLotsComm bigint,

			TargetNoOfLotsGold bigint,

			TargetNoOfLotsSilver bigint,

			TargetNoOfLotsCopper bigint,

			TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch='',

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='DRILL',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID='SBDEALER',

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			

			update #drillPartyDetails set TotalTo=rto.TotalTo

			from #drillPartyDetails drill, @rto_Data rto

			where drill.Party_Code=rto.party_code	

		end

		

			

		--

end

else if @DrillFlag='TotalStartOfMonth'

begin

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate	

end

else if @DrillFlag='NotTradedAsOn'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

				and ps.FirstTrade>@ToDate	

end

else if @DrillFlag='NotTradedForMonth'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				

				and ps.FirstTrade<=@ToDate		

		--

		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	

		--

end

else if @DrillFlag='Traded'

begin

		--Insert Traded Clients

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code

		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		

		

end

else if @DrillFlag='BROK'

begin		

		Declare @emp_name varchar(100)		

		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')



--Select * from #party_code



		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,

		br.Party_Code,ac1.Long_Name,

		--Turnover =sum(TotalTurnover),

        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 

		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        --NetRevnue =sum(NetRevenue),

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Sauda_date)  

		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code

		--inner join #party_code p on p.party_code=br.Party_Code

		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	

		

		--Total		

		--select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  

  --      OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

  --      OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

  --      TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver

		return

end

else if @DrillFlag='ACTIVECLI'

begin		

	

	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),

	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100

	into #FinalActiveCli

	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join

	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)

	 from #BrokTurnOver b

	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	order by 1,2,3

	--Display

	--select * from #FinalActiveCli

	select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli

	--Total Row

	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),

	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100

	 from #FinalActiveCli

	

return

end

---------------------Common Script for DRILL PAGE ---------------------------------------------------

	

--print 'Drill 3:'+convert(varchar,getdate(),109)		

		-- Update Portfolio i.e. Holding value

		update #drillPartyDetails                                                             

		set PortfolioInfo=isnull(H.TotalHold,0)            

		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [MIMANSA].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   

		on ps.party_code = H.party_code 

--print 'Drill 4:'+convert(varchar,getdate(),109)		

		--Update Ledger Value

		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger

		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [MIMANSA].Angelcs.dbo.View_LedgerInfo L with(nolock)

		on ps.party_code = L.party_code 

		--

		update #drillPartyDetails                                                             

		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)

		from #drillPartyDetails ps left outer join #totalLedger L

		on ps.party_code = L.party_code 

		--

		drop table #totalLedger		

--print 'Drill 5:'+convert(varchar,getdate(),109)			

		--Update Current Dealer

		update #drillPartyDetails set DealerCode=cps.Emp_No			

		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )

		where --cps.Segment_Type=@SegmentType and 

		/*EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and*/

		ps.Party_Code =cps.Party_Code and

		cps.Valid='Y' and cps.CommRank='1'

		--Set Row color as per BRS point 4.3.4 & 4.3.5

--print 'Drill 6:'+convert(varchar,getdate(),109)	

		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	

		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)

		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'

		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)

		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)

		--		

--print 'Drill End:'+convert(varchar,getdate(),109)		

		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',

		SB=Branch_cd,Party_Code,Client_Name,Emp_No,

		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),

		ClientGrade,[Profile],Sub_Profile,

		--ActiveFrom,

		ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),

		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)

		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),

		PureRisk=convert(decimal(15,2),PureRisk),

		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),

		--LastTradeDate,

		LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,

		RowColor,LedgerColor,

		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)

		

		 from #drillPartyDetails s

		 order by SrNo

		 --Total

		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),

		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))

		  from #drillPartyDetails



--Drop table #party_code

-------------------

end

---------------------DRILL PAGE END---------------------------------------------------

END

---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_NXT_V1BBG
-- --------------------------------------------------
CREATE procedure [dbo].[SBB2B_MIS_NXT_V1BBG]    
    
   @UserEmp_No varchar(20),    
    
   @UserStatusId varchar(10),--SUBBROKER/SBDEALER    
    
   @Sub_Broker varchar(10),    
    
   @Dealer varchar(20),    
    
   @TradingMode varchar(15),--ALL,ONLINE,OFFLINE    
    
   @ClientGrade varchar(15),--ALL,A+,A,B,C,D    
    
   @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency    
    
   @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012    
    
   @ToDate smalldatetime,    
    
   @Wise varchar(20),       --SUBBROKER/DEALER    
    
   @ReportType varchar(20), --MAIN/DRILL    
    
   @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI    
    
   @TotalFlag varchar(2) = null    
    
   --,   @party_code varchar(max)    
    
 as    
    
 BEGIN    
    
Set nocount on    
    
/*    
    
exec [SBB2B_MIS_NXT_V1]     
@UserEmp_No='VIBU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIBU',@Dealer='',    
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',    
@FromDate='06 Nov 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',    
@ToDate='11 Apr 2024'    
    
exec [SBB2B_MIS]     
    
@UserEmp_No='VIVU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIVU',@Dealer='',    
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',    
@FromDate='06 Nov 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',    
@ToDate='11 Apr 2024'    
    
*/    
    
--    
    
--print 'Start:'+convert(varchar,getdate(),109)    
    
 --Declare @ToDate smalldatetime    
    
 Declare @FromDealer varchar(10)    
    
 Declare @ToDealer varchar(10)    
    
 Declare @FromEffSaudaDate datetime    
    
 Declare @ToEffSaudaDate datetime    
    
 Declare @TradeDays money    
    
 Declare @SegmentTypeFrom varchar(10)    
    
 Declare @SegmentTypeTo varchar(10)    
    
 Declare @FromSub_Broker varchar(10)    
    
 Declare @ToSub_Broker varchar(10)    
    
     
    
    
    
 --Create table #party_code    
    
 --(    
    
 --   party_code varchar(100)    
    
 --)    
    
    
    
 --insert into #party_code    
    
 --select * from [fn_Split] (@party_code,',')    
    
    
    
    
    
 --------------------------------Set From and TO date---------------------------------------    
    
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'    
    
--set @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+' 00:00'    
    
    
    
set  @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+ ' 23:59'    
    
    
    
--set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'    
    
    
    
    
    
--print @FromDate    
    
--print @ToDate    
    
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))    
    
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))    
    
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))    
    
set @Dealer=upper(ltrim(rtrim(@Dealer)))    
    
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))    
    
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))    
    
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))    
    
set @Wise=upper(ltrim(rtrim(@Wise)))    
    
set @ReportType=upper(ltrim(rtrim(@ReportType)))    
    
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))    
    
 ---------------------------------------Get count of Trade Days---------------------------------------------    
    
 /* Added table date for the Currency Segment */    
    
if(@SegmentType = 'CURRENCY')    
    
begin    
    
   set @SegmentTypeFrom  ='CURRENCY'    
    
   set @SegmentTypeTo='CURRENCY'    
    
       
    
 select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                          
    
 where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'    
    
end    
    
else    
    
begin    
    
   if(@SegmentType = 'CASH')    
    
   begin    
    
   set @SegmentTypeFrom  ='CASH'    
    
   set @SegmentTypeTo='CASH'    
    
   End    
    
    
    
   if(@SegmentType = 'DERIVATIVE')    
    
   begin    
    
   set @SegmentTypeFrom  ='DERIVATIVE'    
    
   set @SegmentTypeTo='DERIVATIVE'    
    
   End    
    
       
    
   if(@SegmentType = 'COMMODITY')    
    
   begin    
    
   set @SegmentTypeFrom  ='COMMODITY'    
    
   set @SegmentTypeTo='COMMODITY'    
    
   End    
    
    
    
   if(@SegmentType = 'All')    
    
   begin    
    
   set @SegmentTypeFrom  ='a'    
    
   set @SegmentTypeTo='zzzzzz'    
    
   End    
    
       
    
   select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                          
    
   where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'    
    
 end    
    
     
    
    
    
     
    
--print @TradeDays    
    
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------    
    
     
    
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date)     
    
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate    
    
     
    
     
    
----------------------------------------Redefine Report Wise option as per input fields-----------------------    
    
    
    
set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)    
    
    
    
--print @Wise    
    
-------------------------------------------------------------------------    
    
/**subbroker*/    
    
if @Sub_Broker='' or @Sub_Broker='ALL'     
    
Begin    
    
 set @FromSub_Broker='A'    
    
 set @ToSub_Broker='ZZZZZZZ'    
    
End    
    
else    
    
Begin    
    
 Set @FromSub_Broker=@Sub_Broker    
    
 Set @ToSub_Broker=@Sub_Broker    
    
End    
    
    
    
--if @Dealer='' or @Dealer='ALL' set @Dealer='%'    
    
--    
    
/**subbrokerdealer*/    
    
if @Dealer='' or @Dealer='ALL'     
    
begin    
    
 set @FromDealer='A'    
    
 set @ToDealer='ZZZZZZZ'    
    
end    
    
else    
    
begin    
    
 set @FromDealer=@Dealer    
    
 set @ToDealer=@Dealer    
    
end    
    
--    
    
--------------------------User Access---------------------------------------------------    
    
    
    
/*fill subbrokers and dealers*/    
    
declare @tempbranch  table                                                                    
    
(                                                                    
    
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                              
    
)    
    
    
    
Insert into @tempbranch    
    
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker    
    
     
    
    
    
----------------------------Declare MIS and PartyDetails Table--------------------------    
    
    
    
create table #PartyDetails (    
    
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime    
    
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime    
    
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime    
    
)    
    
--    
    
    
    
create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),    
    
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,    
    
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,    
    
Sauda_date smalldatetime)    
    
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)    
    
--    
    
 --Declare  @MIStable table      
    
 create table #MIStable                                                             
    
 (                                                              
    
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,    
    
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,    
    
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,    
    
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),    
    
 OnlineTurnover money, OfflineTurnover money, Turnover money,    
    
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int    
    
 )                                                            
    
--    
    
--print 'Access:'+convert(varchar,getdate(),109)    
    
if @Dealer='' or @Dealer='ALL'     
    
begin    
    
  --      
    
  --print 'ACT1'    
    
  insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)    
    
  select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate    
    
  from B2B_CommonPartyServices ps with(nolock),@tempbranch aub    
    
  where ps.Branch_cd=aub.Branch_cd     
    
  --and ps.emp_no=aub.dealers    
    
  and ps.FromDate<=@ToDate    
    
  and ps.ToDate>=@FromDate    
    
  --and ps.Segment_Type=@SegmentType    
    
      
    
end     
    
else    
    
begin    
    
  --print 'ACT2'    
    
  insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)    
    
  select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate    
    
  from B2B_CommonPartyServices ps with(nolock),@tempbranch aub    
    
  where ps.Branch_cd=aub.Branch_cd    
    
  --and ps.emp_no=aub.dealers    
    
  and ps.FromDate<=@ToDate    
    
  and ps.ToDate>=@FromDate    
    
  and ps.Emp_No>=@FromDealer    
    
  and ps.Emp_No<=@ToDealer    
    
  --and ps.Segment_Type=@SegmentType    
    
end    
    
    
    
--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------    
    
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')    
    
begin    
    
--print 'TradingMode or ClientGrade'    
    
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)    
    
if @ClientGrade='ALL' set @ClientGrade='%'    
    
--    
    
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating    
    
From angelclient1 ac1 with(nolock),#PartyDetails ps    
    
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode    
    
and ac1.AngelClRating like @ClientGrade    
    
--    
    
delete #PartyDetails where isnull(EbrokingClient,'')=''    
    
--    
    
end    
    
  
-----------------------Update #PartyDetails as per report Wise option -------------------------------------    
    
--print '1.1:'+convert(varchar,getdate(),109)    
    
if @Wise='SUBBROKER'    
    
begin    
    
 update #PartyDetails set Emp_No=''    
    
end     
    
--else if @Wise='ZONE'    
    
--begin    
    
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''    
    
--end    
    
--else if @Wise='REGION'    
    
--begin    
    
--update #PartyDetails set Branch_cd='',Emp_No=''    
    
--end    
    
--else if @Wise='BRANCH'    
    
--begin    
    
--update #PartyDetails set Emp_No=''    
    
--end    
    
-----------------------Update FirstTrade date -------------------------------------    
    
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))    
    
begin    
    
 /*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then     
    
  ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)    
    
  from angelclient1 ac1 with(nolock),#PartyDetails ps    
    
  where ps.Party_Code=ac1.Party_Code*/     
    
     
    
 if(@SegmentType in('COMMODITY'))    
    
 begin    
    
  update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx     
    
  from angelclient1 ac1 with(nolock),#PartyDetails ps    
    
  where ps.Party_Code=ac1.Party_Code    
    
 end        
 else if(@SegmentType in('CURRENCY'))    
    
 begin    
    
  update #PartyDetails set FirstTrade= ac1.FirstTradeCurr     
    
  from angelclient1 ac1 with(nolock),#PartyDetails ps    
    
  where ps.Party_Code=ac1.Party_Code    
    
 end      
    
 else --if(@SegmentType in('CASH','DERIVATIVE') and other    
    
 begin    
    
  update #PartyDetails set FirstTrade= ac1.FirstTrade     
    
  from angelclient1 ac1 with(nolock),#PartyDetails ps     
    
  where ac1.Party_Code=ps.Party_Code    
    
 end    
    
end    
    
--------------------------Fetch Brokerage in case when required-------------------------    
    
    
    
/*    
    
    
    
Select top 10 * from bsecm_cli    
    
    
    
*/    
    
    
    
if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))    
    
begin    
    
--print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)    
    
/*print 'Segment'    
    
print @SegmentTypeFrom    
    
print @SegmentTypeTo    
    
print 'Eff Date'    
    
print @FromEffSaudaDate    
    
print @ToEffSaudaDate    
    
print 'Date'    
    
print @FromDate    
    
print @ToDate*/    
    
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE     
  from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */    
    
--    
--select * into PartydetailsBBG from #PartyDetails 
--Return


/* NEW routine */
Select * into #FilteredPs from (  
Select Distinct Ps.Party_code,Ps.Branch_cd,Ps.Emp_no   
From   
#PartyDetails PS  , TABLE_DATE TD 
Where  
ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date
and
TD.EffSauda_date >= @FromDate AND TD.EffSauda_date <= @ToDate  

)A  

Select * into #Em from (Select * from   
B2B_tbl_ExchangeMapping EM  
Where  
  EM.Segment_Type>=@SegmentTypeFrom and      
    
  EM.Segment_Type<=@SegmentTypeTo   
  AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate  
  )A  
  
  
insert into #BrokTurnOver    
    
  select ps.Party_Code,ps.Branch_cd,ps.Emp_No,     
    
  TotalTurnover = L.Overall_turnover,    
    
  Online_TurnOver=L.ebrok_TurnOver,    
    
  Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),    
    
  GrossRevenue=L.Overall_brok_earned,    
    
  GrossRevenue_Online=L.ebrok_brok_earned,    
    
  GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),    
    
  --NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),    
    
  NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,    
    
  NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,    
    
  --NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),    
    
  NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),    
    
  L.Sauda_date      
    
  from #FilteredPs ps ,--tbl_ebrok_detail_cli L WITH (nolock),    
    
  --mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),    
    
  Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),  
    
  --B2B_tbl_ExchangeMapping EM WITH (nolock)  --, TABLE_DATE TD with (nolock)     
  #Em  
    
  where     
  /*  
  EM.Segment_Type>=@SegmentTypeFrom and      
    
  EM.Segment_Type<=@SegmentTypeTo and    
    
  EM.Segment_Type='ALL' and  */   
    
  --and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments    
    
  #EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'      
    
  When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'       
    
  When L.Segment = 'ABLCM' Then 'BSECM'       
    
  When L.Segment = 'ACDLCM' Then 'NSECM'       
    
  When L.Segment = 'ACDLFO' Then 'NSEFO'       
    
  When L.Segment = 'ACPLMCD' Then 'MCD'      
    
  When L.Segment = 'ACDLNSX' Then 'NSX' End) and    
    
   --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise      
    
   ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise      
    
   --AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table    
    
  --and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date    
    
  and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate     
    
  --and L.ExceptClient='Y'    
    
--print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)    
  
--Select * into BrokTurnOvermodified from  #BrokTurnOver
--Return

 
 /*
  --Original   
insert into #BrokTurnOver    
    
  select ps.Party_Code,ps.Branch_cd,ps.Emp_No,     
    
  TotalTurnover = L.Overall_turnover,    
    
  Online_TurnOver=L.ebrok_TurnOver,    
    
  Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),    
    
  GrossRevenue=L.Overall_brok_earned,    
    
  GrossRevenue_Online=L.ebrok_brok_earned,    
    
  GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),    
    
  --NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),    
    
  NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,    
    
  NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,    
    
  --NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),    
    
  NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),    
    
  L.Sauda_date      
    
  from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),    
    
  --mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),    
    
  Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),    
    
  B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock)     
    
  where     
    
  EM.Segment_Type>=@SegmentTypeFrom and      
    
  EM.Segment_Type<=@SegmentTypeTo and    
    
  --EM.Segment_Type='ALL' and     
    
  --and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments    
    
  EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'      
    
  When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'       
    
  When L.Segment = 'ABLCM' Then 'BSECM'       
    
  When L.Segment = 'ACDLCM' Then 'NSECM'       
    
  When L.Segment = 'ACDLFO' Then 'NSEFO'       
    
  When L.Segment = 'ACPLMCD' Then 'MCD'      
    
  When L.Segment = 'ACDLNSX' Then 'NSX' End) and    
    
   --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise      
    
   ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise      
    
   and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date     
    
   and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date     -- Check for Sauda Date     
    
  --and TD.Sauda_date = L.Sauda_date     -- Check for Sauda Date     
    
  AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table    
    
  and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date    
    
  and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate     
    
  --and L.ExceptClient='Y'    
    
--print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)    

--Select * into BrokTurnOveroriginal from  #BrokTurnOver
--Return
*/
    
end    
    
    
    
  
    
    
    
--select top 10 * From tbl_Exchangemapping    
    
     
    
---------------------MAIN PAGE---------------------------------    
    
if @ReportType='MAIN'    
    
begin    
    
    
    
-----------------------------Fill MIS Table--------------------------------------------------------------------    
    
  insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,    
    
  Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,    
    
  DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,    
    
  OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)    
    
  select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,    
    
  Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,    
    
  DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',    
    
  OnlineTurnover=0,OfflineTurnover=0,Turnover=0,    
    
  OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0    
    
  from #PartyDetails      
    
  group by Branch_cd,Emp_No      
    
--print '1.2:'+convert(varchar,getdate(),109)    
    
----------------------------------------Update Start Of Month Total Clients----------------------------------    
    
  update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth    
    
  from    
    
  (select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)     
    
  from #PartyDetails ps     
    
  where ps.FromDate<=@FromDate    
    
  and ps.ToDate>=@FromDate      
    
  group by ps.Branch_cd,ps.Emp_No    
    
  )A,#MIStable B    
    
  where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No     
    
--    
    
--print '2:'+convert(varchar,getdate(),109)    
    
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------    
    
      
    
--    
    
--print '3.1 '+convert(varchar,getdate(),109)    
    
--    
    
    
    
    
    
update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,    
    
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,    
    
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),    
    
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),    
    
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),    
    
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),    
    
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),    
    
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,    
    
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue    
    
--CONVERT(decimal(15,2),    
    
  from     
    
  (    
    
  select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),       
    
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),    
    
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),    
    
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),    
    
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)    
    
      
    
  from #BrokTurnOver b    
    
  group by b.Branch_cd,b.Emp_No    
    
  )A, #MIStable B    
    
  where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No     
    
----------------------Update NA-----------------------------    
    
--update #MIStable    
    
----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)    
    
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)    
    
    
    
--Comment by sandip    
    
--update #MIStable set ActivationRatio='NA'      
    
--where TotalClientsStartOfmonth<Tradedclients    
    
update #MIStable set AvgDailyActRatio='NA'      
    
where TotalClientsStartOfmonth<AvgTradedclients    
    
-----------------------------------------------Activation Ratio---------------------    
    
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money)     
    
 into #RegActiveClients    
    
 from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)    
    
 from #PartyDetails ps,Table_Date TD with(nolock)     
    
 where TD.sauda_date>=@FromDate     
    
 and TD.sauda_date<=@ToDate    
    
 and FromDate<=TD.sauda_date    
    
 and ToDate>TD.sauda_date    
    
 and TD.CmTradingDay = 'Y'            
    
 group by Sauda_date,Branch_cd,Emp_no)A     
    
 group by Branch_cd,Emp_no    
    
 --order by 1    
    
 --select * from #RegActiveClients    
    
--Activation main page    
    
    
    
--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays    
    
--else 0.00 end)    
    
--from #RegActiveClients A, #MIStable B    
    
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--    
    
--    
    
    
    
update #MIStable set     
    
DailyTradedClients_AR=A.DailyTradedClients    
    
from     
    
(select b.Branch_cd,b.Emp_No,    
    
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)    
    
     
    
  from #BrokTurnOver b,TABLE_DATE TD with(nolock)    
    
  where TD.CMTradingDay='Y'    
    
  and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)    
    
 group by b.Branch_cd,b.Emp_No    
    
)A, #MIStable B    
    
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No      
    
    
    
    
    
--select @DailyTradedClients_AR      
    
update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays    
    
else 0.00 end)    
    
from #RegActiveClients A, #MIStable B    
    
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--    
    
    
    
--select DailyTradedClients_AR,DailyTradeDays from #MIStable    
    
    
    
update #MIStable    
    
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)    
    
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)    
    
set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)    
    
    
    
    
    
---------------------------------------------------------Update AS ON CLIENTS----------------------------------    
    
--print '3.2:'+convert(varchar,getdate(),109)    
    
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)    
    
begin    
    
  update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate    
    
  from     
    
  (    
    
  select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)    
    
  from #PartyDetails ps    
    
  where ps.FromDate<=@ToDate    
    
  and ps.ToDate>=@ToDate      
    
  group by ps.Branch_cd,ps.Emp_No    
    
  )A,#MIStable B    
    
  where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No     
    
  --------------------------------Calculate Productivity--------------------------------------------------------------    
    
  if @Wise='DEALER'    
    
  begin    
    
   Declare @Act_Days int,@H_days int    
    
   set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                                  
    
   set @H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                           
    
      where holidaydate >= @FromDate and holidaydate <= @ToDate )       
    
   --print @TradeDays    
    
   --print @Act_Days    
    
   --print @H_days    
    
   --if(@SegmentType='Currency')    
    
   --begin    
    
    --Fetch Emploee with CTC       
  
        
    
    select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',    
    
    RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))    
    
    into #ProdForCurr from B2B_AngelHarmony ah with(nolock)    
    
    where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and    
    
     ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)        
    
        
    
      
    
    --Update productivity for Employee    
    
    --print 'productivity'    
    
    --print @TradeDays    
    
    --print (@Act_Days-@H_days)    
    
    update #MIStable set     
    
    Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0      
    
        then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days)))))     
    
        else '0.00' end)    
    
    from #MIStable mis,#ProdForCurr ah    
    
    where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'    
    
        
    
        
    
    /*--Print for testing    
    
    select * from #ProdForCurr    
    
    --Print RM    
    
    select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,    
    
    Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage    
    
    from #MIStable mis,#ProdForCurr ah    
    
    where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'    
    
    */    
    
   --End      
    
       
    
  end    
    
  --------------------------------End Calculate Productivity--------------------------------------------------------------    
    
end    
    
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------    
    
--print '4:'+convert(varchar,getdate(),109)    
    
--    
    
  select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded    
    
  from #PartyDetails ps    
    
  where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate       
    
  and ps.FirstTrade<=@ToDate    
    
  --Delete traded clients    
    
  delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)    
    
--     
    
--print '4.1:'+convert(varchar,getdate(),109)    
    
  update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth    
    
  from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)    
    
  from #nottraded ps    
    
  group by ps.Branch_cd,ps.Emp_No    
    
  )A,#MIStable B    
    
   where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No     
    
--    
    
drop table #nottraded    
    
--    
    
--print '5:'+convert(varchar,getdate(),109)    
    
      
    
   update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate    
    
   from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)    
    
   from #PartyDetails ps    
    
   where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate     
    
   and ps.FirstTrade>@ToDate    
    
   group by ps.Branch_cd,ps.Emp_No    
    
   )A,#MIStable B    
    
    where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No     
    
--    
    
--print '6:'+convert(varchar,getdate(),109)    
    
---------------------------------Update Client Visit Pending-------------------------    
    
/*update #MIStable set ClientVisitPending=A.CVPcount    
    
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp    
    
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No    
    
)A,#MIStable B    
    
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No and A.zone=B.Zone and A.Region=B.Region    
    
print '7:'+convert(varchar,getdate(),109)*/    
    
------------------------------DROP #PartyDetails---    
    
drop table #PartyDetails    
    
------------------------------DISPLAY------------------------------------------------    
    
--print 'Wise: '    
    
--print @Wise    
    
if @Wise='DEALER'    
    
begin    
    
  --print 'DEALER'    
    
  update #MIStable set Emp_Name=ah.EMP_NAME    
    
     from #MIStable mis,B2B_AngelHarmony ah with(nolock)    
    
     where mis.Emp_No=ah.EMP_NO    
    
  update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'       
    
  select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,    
    
  OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),    
    
  OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),    
    
  OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),    
    
  NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),    
    
  Productivity,    
    
  --DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),    
    
  DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,    
    
  ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),    
    
  AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate    
    
  from #MIStable mis    
    
  order by 1,2,3    
    
end    
    
else    
    
begin    
    
  --print 'SUBBROKER'    
    
  select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,    
    
  OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),    
    
  OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),    
    
  OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),    
    
  NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),    
    
  Productivity,    
    
  --DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),    
    
  DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,    
    
  ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),    
    
  AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate    
    
  from #MIStable mis    
    
  order by 1,2    
    
end    
    
--TOTAL    
    
--if @TotalFlag <> 'Y'     
    
if(isnull(@TotalFlag,'') in ('','N'))    
    
begin    
    
    
    
--select      
    
--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),    
    
--Tradedclients=isnull(sum(Tradedclients),0),    
    
--  ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0     
    
--  --then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays     
    
--  then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays     
    
--  else 0.00 end)),    
    
--  OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),    
    
--  OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),    
    
--  OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),    
    
--  NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),    
    
--  ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),    
    
--  --DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))    
    
--  DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)    
    
--from #RegActiveClients A, #MIStable B    
    
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No    
    
    
    
select      
    
TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),    
    
Tradedclients=isnull(sum(Tradedclients),0),    
    
  ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0     
    
  --then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays     
    
  then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays     
    
  else 0.00 end)),    
    
  OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),    
    
  OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),    
    
  OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),    
    
  NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),    
    
  ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),    
    
  --DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))    
    
  DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end    
    
from #MIStable B left outer join  #RegActiveClients A  on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No    
    
    
    
--group by DailyTradeDays    
    
--print 'End:'+convert(varchar,getdate(),109)    
    
end     
    
    
    
END    
    
---------------------MAIN PAGE END---------------------------------------------------    
    
---------------------DRILL PAGE START---------------------------------------------------    
    
else if @ReportType='DRILL'    
    
begin    
    
---------------------Declare drill page-------------------------------------------------    
    
create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),    
    
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),    
    
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,    
    
LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))    
    
    
    
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)    
    
--    
    
if @DrillFlag='TotalAsOn'    
    
begin    
    
--print 'Drill 1:'+convert(varchar,getdate(),109)    
    
    
    
        
    
  --select * from @rto_Data    
    
       
    
  insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,    
    
  DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)    
    
  select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,    
    
  [Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',    
    
  TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,    
    
  LastTradeDate=left(ac1.LastTrade,11)    
    
  from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code    
  left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code    
    
  where ps.FromDate<=@ToDate    
    
  and ps.ToDate>=@ToDate        
    
    
    
--print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)    
    
      
    
  if(@UserStatusId='SBDEALER')    
    
  begin    
    
   declare @rto_Data table    
    
   (    
    
   Zone varchar(20),    
    
   Region varchar(20),    
    
   branch_cd varchar(20),    
    
   sub_broker varchar(20),    
    
   Sub_brokerName varchar(200),    
    
   party_code varchar(20),    
    
   Short_name varchar(100),    
    
   TotalTO money,    
    
   OPTNoOfLots money,    
    
   NoOfLotsGold bigint,    
    
   NoOfLotsSilver bigint,    
    
   NoOfLotsCopper bigint  ,    
    
   NoOfLotsCrude bigint,    
    
   NoOfLotsComm bigint,    
    
   TargetNoOfLotsGold bigint,    
    
   TargetNoOfLotsSilver bigint,    
    
   TargetNoOfLotsCopper bigint,    
    
   TargetNoOfLotsCrude bigint    
    
    
    
   )     
    
       
    
   insert into @rto_Data    
    
   --exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo]     
    
   exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new]     
    
   @Emp_no=@UserEmp_No,    
    
   @Zone='',    
    
   @Region='',    
    
   @Branch='',    
    
   @Exec=@Dealer,    
    
   @FromTime='09:00 AM',    
    
   @ToTime='11:59 PM',    
    
   @MainDrill='DRILL',    
    
   @WiseReport='SBDEALER',    
    
   @seg='ALL',    
    
   @B2CStatus='B2B',    
    
   @MimStatusID='SBDEALER',    
    
   @SB='',    
    
   @RoundValue='1',    
    
   @DownloadCSVFlag='Y'    
    
    
    
       
    
   update #drillPartyDetails set TotalTo=rto.TotalTo    
    
   from #drillPartyDetails drill, @rto_Data rto    
    
   where drill.Party_Code=rto.party_code     
    
  end    
    
      
    
       
    
  --    
    
end    
    
else if @DrillFlag='TotalStartOfMonth'    
    
begin    
    
  insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,    
    
  DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)    
    
  select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,    
    
  [Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',    
    
  TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,    
    
  LastTradeDate=left(ac1.LastTrade,11)    
    
  from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code    
    
  left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code    
    
  where ps.FromDate<=@FromDate    
    
  and ps.ToDate>=@FromDate     
    
end    
    
else if @DrillFlag='NotTradedAsOn'    
    
begin    
    
    insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,    
    
    DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)    
    
    select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,    
    
    [Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',    
    
    TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,    
    
    LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')    
    
        
    
    from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code    
    
    left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code    
    
    where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate       
    
    and ps.FirstTrade>@ToDate     
    
end    
    
else if @DrillFlag='NotTradedForMonth'    
    
begin    
    
    insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,    
    
    DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)    
    
    select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,    
    
    [Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',    
    
    TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,    
    
    LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')    
    
    from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code    
    
    left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code    
    
    where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate        
    
    and ps.FirstTrade<=@ToDate      
    
  --    
    
  delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)     
    
  --    
    
end    
    
else if @DrillFlag='Traded'    
    
begin    
    
  --Insert Traded Clients    
    
  insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,    
    
  DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)    
    
  select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,    
    
  [Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',    
    
  TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,    
    
  LastTradeDate=left(ac1.LastTrade,11)    
    
  from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code    
    
   inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code    
    
  left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code    
    
      
    
      
    
end    
    
else if @DrillFlag='BROK'    
    
begin      
    
  Declare @emp_name varchar(100)      
    
  set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')    
    
    
    
--Select * from #party_code    
    
    
    
  select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,    
    
  br.Party_Code,ac1.Long_Name,    
    
  --Turnover =sum(TotalTurnover),    
    
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)),     
    
  --GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),       
    
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),            
    
        --NetRevnue =sum(NetRevenue),    
    
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),    
    
        TotalTradedDays=count(distinct Sauda_date)      
    
  from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code    
    
  --inner join #party_code p on p.party_code=br.Party_Code    
    
  group by br.Branch_cd,br.Party_Code,ac1.Long_Name     
    
      
    
  --Total      
    
  --select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)),         
    
  --      OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),            
    
  --      OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),    
    
  --      TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver    
    
  return    
    
end    
    
else if @DrillFlag='ACTIVECLI'    
    
begin      
    
     
    
 select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),    
    
 [Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100    
    
 into #FinalActiveCli    
    
 from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)    
    
 from #PartyDetails ps,Table_Date TD with(nolock)     
    
 where TD.sauda_date>=@FromDate     
    
 and TD.sauda_date<=@ToDate    
    
 and FromDate<=TD.sauda_date    
    
 and ToDate>TD.sauda_date    
    
 and TD.CmTradingDay = 'Y'            
    
 group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join    
    
 (  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)    
    
  from #BrokTurnOver b    
    
 group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and  A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no    
    
 --where --A.Sauda_date=B.Sauda_date and  A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no    
    
 order by 1,2,3    
    
 --Display    
    
 --select * from #FinalActiveCli    
    
 select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli    
    
 --Total Row    
    
 select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),    
    
 [Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100    
    
  from #FinalActiveCli    
    
     
    
return    
    
end    
    
---------------------Common Script for DRILL PAGE ---------------------------------------------------    
    
     
    
--print 'Drill 3:'+convert(varchar,getdate(),109)      
    
  -- Update Portfolio i.e. Holding value    
    
  update #drillPartyDetails                                                                 
    
  set PortfolioInfo=isnull(H.TotalHold,0)                
    
  from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [MIMANSA].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                       
    
  on ps.party_code = H.party_code     
    
--print 'Drill 4:'+convert(varchar,getdate(),109)      
    
  --Update Ledger Value    
    
  select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger    
    
  from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [MIMANSA].Angelcs.dbo.View_LedgerInfo L with(nolock)    
    
  on ps.party_code = L.party_code     
    
  --    
    
  update #drillPartyDetails                                                                 
    
  set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)    
    
  from #drillPartyDetails ps left outer join #totalLedger L    
    
  on ps.party_code = L.party_code     
    
  --    
    
  drop table #totalLedger      
    
--print 'Drill 5:'+convert(varchar,getdate(),109)       
    
  --Update Current Dealer    
    
  update #drillPartyDetails set DealerCode=cps.Emp_No       
    
  from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )    
    
  where --cps.Segment_Type=@SegmentType and     
    
  /*EM.Segment_Type>=@SegmentTypeFrom and      
    
  EM.Segment_Type<=@SegmentTypeTo and*/    
    
  ps.Party_Code =cps.Party_Code and    
    
  cps.Valid='Y' and cps.CommRank='1'    
    
  --Set Row color as per BRS point 4.3.4 & 4.3.5    
    
--print 'Drill 6:'+convert(varchar,getdate(),109)     
    
  update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)     
    
  ,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)    
    
  --,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'    
    
  --when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)    
    
  ,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)    
    
  --      
    
--print 'Drill End:'+convert(varchar,getdate(),109)      
    
  select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',    
    
  SB=Branch_cd,Party_Code,Client_Name,Emp_No,    
    
  Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),    
    
  ClientGrade,[Profile],Sub_Profile,    
    
  --ActiveFrom,    
    
  ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),    
    
  DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)    
    
  ,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),    
    
  PureRisk=convert(decimal(15,2),PureRisk),    
    
  ProjectedRisk=convert(decimal(15,2),ProjectedRisk),    
    
  --LastTradeDate,    
    
  LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,    
    
  RowColor,LedgerColor,    
    
  TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)    
    
      
    
   from #drillPartyDetails s    
    
   order by SrNo    
    
   --Total    
    
   select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),    
    
   TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))    
    
    from #drillPartyDetails    
    
    
    
--Drop table #party_code    
    
-------------------    
    
end    
    
---------------------DRILL PAGE END---------------------------------------------------    
    
END    
    
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_NXT_V2
-- --------------------------------------------------
CREATE Procedure SBB2B_MIS_NXT_V2
(
--Declare 		
@UserEmp_No varchar(20),
		 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
		 @Sub_Broker varchar(10),
		 @Dealer varchar(20),
		 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
		 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
		 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
		 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
		 @ToDate smalldatetime,
		 @Wise varchar(20),       --SUBBROKER/DEALER
		 @ReportType varchar(20), --MAIN/DRILL
		 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
		 @TotalFlag varchar(2) = null
)
as
begin

Declare @FromEffSaudaDate datetime,
		@ToEffSaudaDate datetime,
		@SegmentTypeFrom varchar(10),
		@SegmentTypeTo varchar(10)


 Select @UserEmp_No='VIBU001',@UserStatusId='SUBBROKER',@Sub_Broker='VIBU',@Dealer='',
@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',
@FromDate='11 Apr 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',
@ToDate='11 Apr 2024'


select 
 @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

set @SegmentTypeFrom  ='a'
set @SegmentTypeTo='zzzzzz'

declare @tempbranch  table                                                                
(                                                                
	Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)

Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@Sub_Broker 

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set  @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+ ' 23:59'
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))


create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select 
			ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate



select * into #angelclient1 from angelclient1 with (nolock) where sub_broker=@Sub_Broker

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime)



insert into #BrokTurnOver

		select 
			ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
			TotalTurnover = L.Overall_turnover,
			Online_TurnOver=L.ebrok_TurnOver,
			Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
			GrossRevenue=L.Overall_brok_earned,
			GrossRevenue_Online=L.ebrok_brok_earned,
			GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
			NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,
			NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,
			NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
			L.Sauda_date  
		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		
		Declare @emp_name varchar(100)		

		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')

		CREATE NONCLUSTERED INDEX ix_BrokTurnOver ON #BrokTurnOver ([Party_Code])
INCLUDE ([Branch_cd],[Online_TurnOver],[Offline_TurnOver],[GrossRevenue_Online],[GrossRevenue_Offline],[NetRevenue_Online],[NetRevenue_Offline],[Sauda_date])

--select * from #BrokTurnOver
--select count(*) from #angelclient1
--Select * from #party_code



		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,
		br.Party_Code,ac1.Long_Name,
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Sauda_date)  
		from #BrokTurnOver br inner join #angelclient1 ac1 ON br.Party_Code=ac1.Party_Code
		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	


drop table #PartyDetails
drop table #angelclient1 
drop table #BrokTurnOver 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_NXT_V5
-- --------------------------------------------------


CREATE procedure [dbo].[SBB2B_MIS_NXT_V5]

		 @UserEmp_No varchar(20),

		 @UserStatusId varchar(10),--SUBBROKER/SBDEALER

		 @Sub_Broker varchar(10),

		 @Dealer varchar(20),

		 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE

		 @ClientGrade varchar(15),--ALL,A+,A,B,C,D

		 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency

		 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012

		 @ToDate smalldatetime,

		 @Wise varchar(20),       --SUBBROKER/DEALER

		 @ReportType varchar(20), --MAIN/DRILL

		 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI

		 @TotalFlag varchar(2) = null

		 --,		 @party_code varchar(max)

 as

 BEGIN

Set nocount on

/*

exec [SBB2B_MIS_NXT_V1] 

@UserEmp_No='ET002',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',@SegmentType='ALL',@FromDate='1 Jul 2023',@Wise='',@ReportType='DRILL',@DrillFlag='BROK',@ToDate='5 Jul 2023'

*/

--

--print 'Start:'+convert(varchar,getdate(),109)

 --Declare @ToDate smalldatetime

 Declare @FromDealer varchar(10)

 Declare @ToDealer varchar(10)

 Declare @FromEffSaudaDate datetime

 Declare @ToEffSaudaDate datetime

 Declare @TradeDays money

 Declare @SegmentTypeFrom varchar(10)

 Declare @SegmentTypeTo varchar(10)

 Declare @FromSub_Broker varchar(10)

 Declare @ToSub_Broker varchar(10)

 



 --Create table #party_code

 --(

 --   party_code varchar(100)

 --)



 --insert into #party_code

 --select * from [fn_Split] (@party_code,',')





 --------------------------------Set From and TO date---------------------------------------

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'

--set @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+' 00:00'



set  @ToDate=left(CONVERT(smalldatetime,@ToDate),11)+ ' 23:59'



--set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'





--print @FromDate

--print @ToDate

set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))

set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))

set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))

set @Dealer=upper(ltrim(rtrim(@Dealer)))

set @TradingMode=upper(ltrim(rtrim(@TradingMode)))

set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))

set @SegmentType=upper(ltrim(rtrim(@SegmentType)))

set @Wise=upper(ltrim(rtrim(@Wise)))

set @ReportType=upper(ltrim(rtrim(@ReportType)))

set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))

 ---------------------------------------Get count of Trade Days---------------------------------------------

 /* Added table date for the Currency Segment */

if(@SegmentType = 'CURRENCY')

begin

   set @SegmentTypeFrom  ='CURRENCY'

   set @SegmentTypeTo='CURRENCY'

   

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'

end

else

begin

			if(@SegmentType = 'CASH')

			begin

			set @SegmentTypeFrom  ='CASH'

			set @SegmentTypeTo='CASH'

			End



			if(@SegmentType = 'DERIVATIVE')

			begin

			set @SegmentTypeFrom  ='DERIVATIVE'

			set @SegmentTypeTo='DERIVATIVE'

			End

			

			if(@SegmentType = 'COMMODITY')

			begin

			set @SegmentTypeFrom  ='COMMODITY'

			set @SegmentTypeTo='COMMODITY'

			End



			if(@SegmentType = 'All')

			begin

			set @SegmentTypeFrom  ='a'

			set @SegmentTypeTo='zzzzzz'

			End

			

			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'

	end

 



 

--print @TradeDays

 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------

 

 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 

 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

 

 

----------------------------------------Redefine Report Wise option as per input fields-----------------------



set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)



--print @Wise

-------------------------------------------------------------------------

/**subbroker*/

if @Sub_Broker='' or @Sub_Broker='ALL' 

Begin

	set @FromSub_Broker='A'

	set @ToSub_Broker='ZZZZZZZ'

End

else

Begin

	Set @FromSub_Broker=@Sub_Broker

	Set @ToSub_Broker=@Sub_Broker

End



--if @Dealer='' or @Dealer='ALL' set @Dealer='%'

--

/**subbrokerdealer*/

if @Dealer='' or @Dealer='ALL' 

begin

	set @FromDealer='A'

	set @ToDealer='ZZZZZZZ'

end

else

begin

	set @FromDealer=@Dealer

	set @ToDealer=@Dealer

end

--

--------------------------User Access---------------------------------------------------



/*fill subbrokers and dealers*/

declare @tempbranch  table                                                                

(                                                                

Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

)



Insert into @tempbranch

select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

 



----------------------------Declare MIS and PartyDetails Table--------------------------



create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime

,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

)

--



create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime)

--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)

--

 --Declare  @MIStable table  

 create table #MIStable                                                         

 (                                                          

 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,

 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,

 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,

 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),

 OnlineTurnover money, OfflineTurnover money, Turnover money,

 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int

 )                                                        

--

--print 'Access:'+convert(varchar,getdate(),109)

if @Dealer='' or @Dealer='ALL' 

begin

		--		

		--print 'ACT1'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd 

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		--and ps.Segment_Type=@SegmentType

		

end 

else

begin

		--print 'ACT2'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		and ps.Emp_No>=@FromDealer

		and ps.Emp_No<=@ToDealer

		--and ps.Segment_Type=@SegmentType

end



--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------

if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')

begin

--print 'TradingMode or ClientGrade'

if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)

if @ClientGrade='ALL' set @ClientGrade='%'

--

update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating

From angelclient1 ac1,#PartyDetails ps

where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode

and ac1.AngelClRating like @ClientGrade

--

delete #PartyDetails where isnull(EbrokingClient,'')=''

--

end

-----------------------Update #PartyDetails as per report Wise option -------------------------------------

--print '1.1:'+convert(varchar,getdate(),109)

if @Wise='SUBBROKER'

begin

	update #PartyDetails set Emp_No=''

end 

--else if @Wise='ZONE'

--begin

--update #PartyDetails set Region='',Branch_cd='',Emp_No=''

--end

--else if @Wise='REGION'

--begin

--update #PartyDetails set Branch_cd='',Emp_No=''

--end

--else if @Wise='BRANCH'

--begin

--update #PartyDetails set Emp_No=''

--end

-----------------------Update FirstTrade date -------------------------------------

if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))

begin

	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 

		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code*/	

	

	if(@SegmentType in('COMMODITY'))

	begin

		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end

	else if(@SegmentType in('CURRENCY'))

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end		

	else --if(@SegmentType in('CASH','DERIVATIVE') and other

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTrade 

		from angelclient1 ac1 with(nolock),#PartyDetails ps 

		where ac1.Party_Code=ps.Party_Code

	end

end

--------------------------Fetch Brokerage in case when required-------------------------



/*



Select top 10 * from bsecm_cli



*/



if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))

begin

--print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)

/*print 'Segment'

print @SegmentTypeFrom

print @SegmentTypeTo

print 'Eff Date'

print @FromEffSaudaDate

print @ToEffSaudaDate

print 'Date'

print @FromDate

print @ToDate*/

/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 

from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */

--



insert into #BrokTurnOver

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		Online_TurnOver=L.ebrok_TurnOver,

		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		GrossRevenue=L.Overall_brok_earned,

		GrossRevenue_Online=L.ebrok_brok_earned,

		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,

		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,

		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),

		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 

		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 

		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 

		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table

		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date

		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		--and L.ExceptClient='Y'

--print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)



end







--select top 10 * From tbl_Exchangemapping

 

---------------------MAIN PAGE---------------------------------

if @ReportType='MAIN'

begin



-----------------------------Fill MIS Table--------------------------------------------------------------------

		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,

		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,

		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,

		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)

		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,

		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,

		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',

		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,

		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0

		from #PartyDetails		

		group by Branch_cd,Emp_No		

--print '1.2:'+convert(varchar,getdate(),109)

----------------------------------------Update Start Of Month Total Clients----------------------------------

		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth

		from

		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	

		from #PartyDetails ps 

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

--print '2:'+convert(varchar,getdate(),109)

-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------

		

--

--print '3.1 '+convert(varchar,getdate(),109)

--





update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,

DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,

AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),

AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),

AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),

--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),

--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),

 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,

 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue

--CONVERT(decimal(15,2),

		from 

		(

		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   

        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),

        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),

        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),

 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)

  

		from #BrokTurnOver b

		group by b.Branch_cd,b.Emp_No

		)A,	#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

----------------------Update NA-----------------------------

--update #MIStable

----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)



--Comment by sandip

--update #MIStable set ActivationRatio='NA'		

--where TotalClientsStartOfmonth<Tradedclients

update #MIStable set AvgDailyActRatio='NA'		

where TotalClientsStartOfmonth<AvgTradedclients

-----------------------------------------------Activation Ratio---------------------

select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 

	into #RegActiveClients

	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by Sauda_date,Branch_cd,Emp_no)A 

	group by Branch_cd,Emp_no

	--order by 1

	--select * from #RegActiveClients

--Activation main page



--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays

--else 0.00 end)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--



update #MIStable set 

DailyTradedClients_AR=A.DailyTradedClients

from 

(select b.Branch_cd,b.Emp_No,

 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)

 

 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)

		where TD.CMTradingDay='Y'

		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)

	group by b.Branch_cd,b.Emp_No

)A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		





--select @DailyTradedClients_AR		

update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays

else 0.00 end)

from #RegActiveClients A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--



--select DailyTradedClients_AR,DailyTradeDays from #MIStable



update #MIStable

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)





---------------------------------------------------------Update AS ON CLIENTS----------------------------------

--print '3.2:'+convert(varchar,getdate(),109)

if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)

begin

		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate

		from 

		(

		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

		from #PartyDetails ps

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

		--------------------------------Calculate Productivity--------------------------------------------------------------

		if @Wise='DEALER'

		begin

			Declare @Act_Days int,@H_days int

			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              

			set @H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

						where holidaydate >= @FromDate and holidaydate <= @ToDate )   

			--print @TradeDays

			--print @Act_Days

			--print @H_days

			--if(@SegmentType='Currency')

			--begin

				--Fetch Emploee with CTC			

				

				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',

				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))

				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)

				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and

				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				

				

		

				--Update productivity for Employee

				--print 'productivity'

				--print @TradeDays

				--print (@Act_Days-@H_days)

				update #MIStable set 

				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 

								else '0.00' end)

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'

				

				

				/*--Print for testing

				select * from #ProdForCurr

				--Print RM

				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,

				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'

				*/

			--End		

			

		end

		--------------------------------End Calculate Productivity--------------------------------------------------------------

end

----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------

--print '4:'+convert(varchar,getdate(),109)

--

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded

		from #PartyDetails ps

		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

		and ps.FirstTrade<=@ToDate

		--Delete traded clients

		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)

--	

--print '4.1:'+convert(varchar,getdate(),109)

		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth

		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)

		from #nottraded ps

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

drop table #nottraded

--

--print '5:'+convert(varchar,getdate(),109)

		

			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate

			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)

			from #PartyDetails ps

			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	

			and ps.FirstTrade>@ToDate

			group by ps.Branch_cd,ps.Emp_No

			)A,#MIStable B

				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	

--

--print '6:'+convert(varchar,getdate(),109)

---------------------------------Update Client Visit Pending-------------------------

/*update #MIStable set ClientVisitPending=A.CVPcount

from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp

where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No

)A,#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region

print '7:'+convert(varchar,getdate(),109)*/

------------------------------DROP #PartyDetails---

drop table #PartyDetails

------------------------------DISPLAY------------------------------------------------

--print 'Wise: '

--print @Wise

if @Wise='DEALER'

begin

		--print 'DEALER'

		update #MIStable set Emp_Name=ah.EMP_NAME

					from #MIStable mis,B2B_AngelHarmony ah with(nolock)

					where mis.Emp_No=ah.EMP_NO

		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2,3

end

else

begin

		--print 'SUBBROKER'

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2

end

--TOTAL

--if @TotalFlag <> 'Y' 

if(isnull(@TotalFlag,'') in ('','N'))

begin



--select  

--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

--Tradedclients=isnull(sum(Tradedclients),0),

--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

--		else 0.00 end)),

--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



select  

TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

Tradedclients=isnull(sum(Tradedclients),0),

		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

		else 0.00 end)),

		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end

from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



--group by DailyTradeDays

--print 'End:'+convert(varchar,getdate(),109)

end 



END

---------------------MAIN PAGE END---------------------------------------------------

---------------------DRILL PAGE START---------------------------------------------------

else if @ReportType='DRILL'

begin

---------------------Declare drill page-------------------------------------------------

create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),

ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),

DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,

LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))



--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)

--

if @DrillFlag='TotalAsOn'

begin

--print 'Drill 1:'+convert(varchar,getdate(),109)



	   

		--select * from @rto_Data

			

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate				



--print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)

		

		if(@UserStatusId='SBDEALER')

		begin

			declare @rto_Data table

			(

			Zone varchar(20),

			Region varchar(20),

			branch_cd varchar(20),

			sub_broker varchar(20),

			Sub_brokerName varchar(200),

			party_code varchar(20),

			Short_name varchar(100),

			TotalTO money,

			OPTNoOfLots money,

			NoOfLotsGold bigint,

			NoOfLotsSilver bigint,

			NoOfLotsCopper bigint  ,

			NoOfLotsCrude bigint,

			NoOfLotsComm bigint,

			TargetNoOfLotsGold bigint,

			TargetNoOfLotsSilver bigint,

			TargetNoOfLotsCopper bigint,

			TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch='',

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='DRILL',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID='SBDEALER',

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			

			update #drillPartyDetails set TotalTo=rto.TotalTo

			from #drillPartyDetails drill, @rto_Data rto

			where drill.Party_Code=rto.party_code	

		end

		

			

		--

end

else if @DrillFlag='TotalStartOfMonth'

begin

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate	

end

else if @DrillFlag='NotTradedAsOn'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

				and ps.FirstTrade>@ToDate	

end

else if @DrillFlag='NotTradedForMonth'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				

				and ps.FirstTrade<=@ToDate		

		--

		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	

		--

end

else if @DrillFlag='Traded'

begin

		--Insert Traded Clients

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code

		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		

		

end

else if @DrillFlag='BROK'

begin		

		Declare @emp_name varchar(100)		

		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')



--Select * from #party_code



		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,

		br.Party_Code,ac1.Long_Name,

		--Turnover =sum(TotalTurnover),

        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 

		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        --NetRevnue =sum(NetRevenue),

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Sauda_date)  

		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code

		--inner join #party_code p on p.party_code=br.Party_Code

		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	

		

		--Total		

		--select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  

  --      OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

  --      OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

  --      TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver

		return

end

else if @DrillFlag='ACTIVECLI'

begin		

	

	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),

	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100

	into #FinalActiveCli

	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join

	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)

	 from #BrokTurnOver b

	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	order by 1,2,3

	--Display

	--select * from #FinalActiveCli

	select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli

	--Total Row

	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),

	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100

	 from #FinalActiveCli

	

return

end

---------------------Common Script for DRILL PAGE ---------------------------------------------------

	

--print 'Drill 3:'+convert(varchar,getdate(),109)		

		-- Update Portfolio i.e. Holding value

		update #drillPartyDetails                                                             

		set PortfolioInfo=isnull(H.TotalHold,0)            

		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [MIMANSA].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   

		on ps.party_code = H.party_code 

--print 'Drill 4:'+convert(varchar,getdate(),109)		

		--Update Ledger Value

		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger

		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [MIMANSA].Angelcs.dbo.View_LedgerInfo L with(nolock)

		on ps.party_code = L.party_code 

		--

		update #drillPartyDetails                                                             

		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)

		from #drillPartyDetails ps left outer join #totalLedger L

		on ps.party_code = L.party_code 

		--

		drop table #totalLedger		

--print 'Drill 5:'+convert(varchar,getdate(),109)			

		--Update Current Dealer

		update #drillPartyDetails set DealerCode=cps.Emp_No			

		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )

		where --cps.Segment_Type=@SegmentType and 

		/*EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and*/

		ps.Party_Code =cps.Party_Code and

		cps.Valid='Y' and cps.CommRank='1'

		--Set Row color as per BRS point 4.3.4 & 4.3.5

--print 'Drill 6:'+convert(varchar,getdate(),109)	

		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	

		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)

		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'

		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)

		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)

		--		

--print 'Drill End:'+convert(varchar,getdate(),109)		

		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',

		SB=Branch_cd,Party_Code,Client_Name,Emp_No,

		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),

		ClientGrade,[Profile],Sub_Profile,

		--ActiveFrom,

		ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),

		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)

		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),

		PureRisk=convert(decimal(15,2),PureRisk),

		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),

		--LastTradeDate,

		LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,

		RowColor,LedgerColor,

		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)

		

		 from #drillPartyDetails s

		 order by SrNo

		 --Total

		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),

		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))

		  from #drillPartyDetails



--Drop table #party_code

-------------------

end

---------------------DRILL PAGE END---------------------------------------------------

END

---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_Test
-- --------------------------------------------------

CREATE procedure [dbo].[SBB2B_MIS_Test]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20),       --SUBBROKER/DEALER
 @ReportType varchar(20), --MAIN/DRILL
 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 @TotalFlag varchar(2) = null
 as
 BEGIN
/*
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='jan  1 2013',@Wise='Dealer',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'
*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------
/*if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
	 
	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 
	 where Emp_No=@UserEmp_No                       */
	 --Select distinct  P.branch_cd,A.zone,A.region                                  
	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        
	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin    
        /*declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag*/
		insert into @tempbranch 
		select distinct Branch_cd=sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@UserEmp_No
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@UserEmp_No
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    
	/*insert into @tempbranch                                                                 
	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   
	 AngelHarmonyEmployee b--B2B_Harmony b 
	 on a.sbtag=b.hod*/
end

/*if @UserStatusId='SBCHILD'                           
begin
	insert into @tempbranch                                                                 
	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    
	where   HOD=@UserEmp_No	
	select * from @tempbranch	
end
*/
*/


Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker
 

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 --Declare  @MIStable table  
 create table #MIStable                                                         
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		and ps.Emp_No>=@FromDealer
		and ps.Emp_No<=@ToDealer
		--and ps.Segment_Type=@SegmentType
end

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
--else if @Wise='ZONE'
--begin
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''
--end
--else if @Wise='REGION'
--begin
--update #PartyDetails set Branch_cd='',Emp_No=''
--end
--else if @Wise='BRANCH'
--begin
--update #PartyDetails set Emp_No=''
--end
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin
	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 
		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code*/	
	
	if(@SegmentType in('COMMODITY'))
	begin
		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end
	else if(@SegmentType in('CURRENCY'))
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end		
	else --if(@SegmentType in('CASH','DERIVATIVE') and other
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTrade 
		from angelclient1 ac1 with(nolock),#PartyDetails ps 
		where ac1.Party_Code=ps.Party_Code
	end
end
--------------------------Fetch Brokerage in case when required-------------------------

/*

Select top 10 * from bsecm_cli

*/

if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

insert into #BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		Online_TurnOver=L.ebrok_TurnOver,
		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=L.ebrok_brok_earned,
		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,
		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,
		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),
		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		--and L.ExceptClient='Y'
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end



--select top 10 * From tbl_Exchangemapping
 
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin

-----------------------------Fill MIS Table--------------------------------------------------------------------
		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,
		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,
		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,
		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)
		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,
		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,
		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',
		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,
		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0
		from #PartyDetails		
		group by Branch_cd,Emp_No		
print '1.2:'+convert(varchar,getdate(),109)
----------------------------------------Update Start Of Month Total Clients----------------------------------
		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth
		from
		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	
		from #PartyDetails ps 
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
print '2:'+convert(varchar,getdate(),109)
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------
		
--
print '3.1 '+convert(varchar,getdate(),109)
--
update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue
--CONVERT(decimal(15,2),
		from 
		(
		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)
  
		from #BrokTurnOver b
		group by b.Branch_cd,b.Emp_No
		)A,	#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
----------------------Update NA-----------------------------
--update #MIStable
----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

--Comment by sandip
--update #MIStable set ActivationRatio='NA'		
--where TotalClientsStartOfmonth<Tradedclients
update #MIStable set AvgDailyActRatio='NA'		
where TotalClientsStartOfmonth<AvgTradedclients
-----------------------------------------------Activation Ratio---------------------
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 
	into #RegActiveClients
	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by Sauda_date,Branch_cd,Emp_no)A 
	group by Branch_cd,Emp_no
	--order by 1
	--select * from #RegActiveClients
--Activation main page

--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays
--else 0.00 end)
--from #RegActiveClients A,	#MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--
--

update #MIStable set 
DailyTradedClients_AR=A.DailyTradedClients
from 
(select b.Branch_cd,b.Emp_No,
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
 
 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)
		where TD.CMTradingDay='Y'
		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
	group by b.Branch_cd,b.Emp_No
)A,	#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		


--select @DailyTradedClients_AR		
update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays
else 0.00 end)
from #RegActiveClients A,	#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--select DailyTradedClients_AR,DailyTradeDays from #MIStable

update #MIStable
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)
set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)


---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)
begin
		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate
		from 
		(
		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
		from #PartyDetails ps
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			Declare @Act_Days int,@H_days int
			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              
			set @H_days = ( select  count(distinct holidaydate)  from MIMANSA.crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= @FromDate and holidaydate <= @ToDate )   
			print @TradeDays
			print @Act_Days
			print @H_days
			--if(@SegmentType='Currency')
			--begin
				--Fetch Emploee with CTC			
				
				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',
				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))
				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)
				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and
				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				
				
		
				--Update productivity for Employee
				print 'productivity'
				print @TradeDays
				print (@Act_Days-@H_days)
				update #MIStable set 
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 
								else '0.00' end)
				from #MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				
				
				/*--Print for testing
				select * from #ProdForCurr
				--Print RM
				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,
				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage
				from #MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'
				*/
			--End		
			
		end
		--------------------------------End Calculate Productivity--------------------------------------------------------------
end
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------
print '4:'+convert(varchar,getdate(),109)
--
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded
		from #PartyDetails ps
		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
		and ps.FirstTrade<=@ToDate
		--Delete traded clients
		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)
--	
print '4.1:'+convert(varchar,getdate(),109)
		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth
		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)
		from #nottraded ps
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
drop table #nottraded
--
print '5:'+convert(varchar,getdate(),109)
		
			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate
			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)
			from #PartyDetails ps
			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	
			and ps.FirstTrade>@ToDate
			group by ps.Branch_cd,ps.Emp_No
			)A,#MIStable B
				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	
--
print '6:'+convert(varchar,getdate(),109)
---------------------------------Update Client Visit Pending-------------------------
/*update #MIStable set ClientVisitPending=A.CVPcount
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No
)A,#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region
print '7:'+convert(varchar,getdate(),109)*/
------------------------------DROP #PartyDetails---
drop table #PartyDetails
------------------------------DISPLAY------------------------------------------------
print 'Wise: '
print @Wise
if @Wise='DEALER'
begin
		print 'DEALER'
		update #MIStable set Emp_Name=ah.EMP_NAME
					from #MIStable mis,B2B_AngelHarmony ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2,3
end
else
begin
		print 'SUBBROKER'
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2
end
--TOTAL
--if @TotalFlag <> 'Y' 
if(isnull(@TotalFlag,'') in ('','N'))
begin

--select  
--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
--Tradedclients=isnull(sum(Tradedclients),0),
--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
--		else 0.00 end)),
--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)
--from #RegActiveClients A,	#MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

select  
TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
Tradedclients=isnull(sum(Tradedclients),0),
		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
		else 0.00 end)),
		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end
from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

--group by DailyTradeDays
print 'End:'+convert(varchar,getdate(),109)
end 

END
---------------------MAIN PAGE END---------------------------------------------------
---------------------DRILL PAGE START---------------------------------------------------
else if @ReportType='DRILL'
begin
---------------------Declare drill page-------------------------------------------------
create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom datetime,
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,
LastTradeDate datetime,RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)
--
if @DrillFlag='TotalAsOn'
begin
print 'Drill 1:'+convert(varchar,getdate(),109)

	   
		--select * from @rto_Data
			
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=ac1.ActiveFrom,DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=ac1.LastTrade
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate				

print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)
		
		if(@UserStatusId='SBDEALER')
		begin
			declare @rto_Data table
			(
			Zone varchar(20),
			Region varchar(20),
			branch_cd varchar(20),
			sub_broker varchar(20),
			Sub_brokerName varchar(200),
			party_code varchar(20),
			Short_name varchar(100),
			TotalTO money,
			OPTNoOfLots money,
			NoOfLotsGold bigint,
			NoOfLotsSilver bigint,
			NoOfLotsCopper bigint  ,
			NoOfLotsCrude bigint,
			NoOfLotsComm bigint,
			TargetNoOfLotsGold bigint,
			TargetNoOfLotsSilver bigint,
			TargetNoOfLotsCopper bigint,
			TargetNoOfLotsCrude bigint

			)	
			
			insert into @rto_Data
			--exec MIMANSA.CRM.dbo.[GetTurnoverfortime_newfo] 
			exec MIMANSA.CRM.dbo.[GetTurnoverfortime_new] 
			@Emp_no=@UserEmp_No,
			@Zone='',
			@Region='',
			@Branch='',
			@Exec=@Dealer,
			@FromTime='09:00 AM',
			@ToTime='11:59 PM',
			@MainDrill='DRILL',
			@WiseReport='SBDEALER',
			@seg='ALL',
			@B2CStatus='B2B',
			@MimStatusID='SBDEALER',
			@SB='',
			@RoundValue='1',
			@DownloadCSVFlag='Y'

			
			update #drillPartyDetails set TotalTo=rto.TotalTo
			from #drillPartyDetails drill, @rto_Data rto
			where drill.Party_Code=rto.party_code	
		end
		
			
		--
end
else if @DrillFlag='TotalStartOfMonth'
begin
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=ac1.ActiveFrom,DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=ac1.LastTrade
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate	
end
else if @DrillFlag='NotTradedAsOn'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=ac1.ActiveFrom,DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=ac1.LastTrade, Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
				and ps.FirstTrade>@ToDate	
end
else if @DrillFlag='NotTradedForMonth'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=ac1.ActiveFrom,DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=ac1.LastTrade, Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				
				and ps.FirstTrade<=@ToDate		
		--
		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	
		--
end
else if @DrillFlag='Traded'
begin
		--Insert Traded Clients
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=ac1.ActiveFrom,DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=ac1.LastTrade
		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code
		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		
		
end
else if @DrillFlag='BROK'
begin		
		Declare @emp_name varchar(100)		
		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')
		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,
		br.Party_Code,ac1.Long_Name,
		--Turnover =sum(TotalTurnover),
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 
		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        --NetRevnue =sum(NetRevenue),
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Sauda_date)  
		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code
		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	
		
		--Total		
		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver
		return
end
else if @DrillFlag='ACTIVECLI'
begin		
	
	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),
	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100
	into #FinalActiveCli
	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join
	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)
	 from #BrokTurnOver b
	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	order by 1,2,3
	--Display
	select * from #FinalActiveCli
	--Total Row
	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),
	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100
	 from #FinalActiveCli
	
return
end
---------------------Common Script for DRILL PAGE ---------------------------------------------------
	
print 'Drill 3:'+convert(varchar,getdate(),109)		
		-- Update Portfolio i.e. Holding value
		update #drillPartyDetails                                                             
		set PortfolioInfo=isnull(H.TotalHold,0)            
		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  MIMANSA.Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   
		on ps.party_code = H.party_code 
print 'Drill 4:'+convert(varchar,getdate(),109)		
		--Update Ledger Value
		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger
		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- MIMANSA.Angelcs.dbo.View_LedgerInfo L with(nolock)
		on ps.party_code = L.party_code 
		--
		update #drillPartyDetails                                                             
		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)
		from #drillPartyDetails ps left outer join #totalLedger L
		on ps.party_code = L.party_code 
		--
		drop table #totalLedger		
print 'Drill 5:'+convert(varchar,getdate(),109)			
		--Update Current Dealer
		update #drillPartyDetails set DealerCode=cps.Emp_No			
		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )
		where --cps.Segment_Type=@SegmentType and 
		/*EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and*/
		ps.Party_Code =cps.Party_Code and
		cps.Valid='Y' and cps.CommRank='1'
		--Set Row color as per BRS point 4.3.4 & 4.3.5
print 'Drill 6:'+convert(varchar,getdate(),109)	
		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	
		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)
		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'
		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)
		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)
		--		
print 'Drill End:'+convert(varchar,getdate(),109)		
		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',
		SB=Branch_cd,Party_Code,Client_Name,Emp_No,
		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),
		ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)
		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),
		PureRisk=convert(decimal(15,2),PureRisk),
		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),LastTradeDate,RowColor,LedgerColor,
		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)
		
		 from #drillPartyDetails s
		 order by SrNo
		 --Total
		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),
		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))
		  from #drillPartyDetails
-------------------
end
---------------------DRILL PAGE END---------------------------------------------------
END
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_Test15May2015
-- --------------------------------------------------

CREATE procedure [dbo].[SBB2B_MIS_Test15May2015]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20),       --SUBBROKER/DEALER
 @ReportType varchar(20), --MAIN/DRILL
 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 @TotalFlag varchar(2) = null
 as
 BEGIN
/*
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='jan  1 2013',@Wise='Dealer',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'


exec [SBB2B_MIS_Test15May2015] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='May  1 2015',@Wise='Dealer',@ReportType='DRILL',@DrillFlag='NotTradedAsOn'

exec [SBB2B_MIS_Test15May2015] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='May  1 2015',@Wise='Dealer',@ReportType='DRILL',@DrillFlag='NotTradedForMonth'

exec [SBB2B_MIS_Test15May2015] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='May  1 2015',@Wise='Dealer',@ReportType='DRILL',@DrillFlag='ACTIVECLI'

*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------
/*if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
	 
	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 
	 where Emp_No=@UserEmp_No                       */
	 --Select distinct  P.branch_cd,A.zone,A.region                                  
	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        
	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin    
        /*declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag*/
		insert into @tempbranch 
		select distinct Branch_cd=sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@UserEmp_No
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@UserEmp_No
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    
	/*insert into @tempbranch                                                                 
	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   
	 AngelHarmonyEmployee b--B2B_Harmony b 
	 on a.sbtag=b.hod*/
end

/*if @UserStatusId='SBCHILD'                           
begin
	insert into @tempbranch                                                                 
	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    
	where   HOD=@UserEmp_No	
	select * from @tempbranch	
end
*/
*/


Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker
 

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 --Declare  @MIStable table  
 create table #MIStable                                                         
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		and ps.Emp_No>=@FromDealer
		and ps.Emp_No<=@ToDealer
		--and ps.Segment_Type=@SegmentType
end

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
--else if @Wise='ZONE'
--begin
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''
--end
--else if @Wise='REGION'
--begin
--update #PartyDetails set Branch_cd='',Emp_No=''
--end
--else if @Wise='BRANCH'
--begin
--update #PartyDetails set Emp_No=''
--end
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin
	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 
		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code*/	
	
	if(@SegmentType in('COMMODITY'))
	begin
		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end
	else if(@SegmentType in('CURRENCY'))
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end		
	else --if(@SegmentType in('CASH','DERIVATIVE') and other
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTrade 
		from angelclient1 ac1 with(nolock),#PartyDetails ps 
		where ac1.Party_Code=ps.Party_Code
	end
end
--------------------------Fetch Brokerage in case when required-------------------------

/*

Select top 10 * from bsecm_cli

*/

if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

insert into #BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		Online_TurnOver=L.ebrok_TurnOver,
		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=L.ebrok_brok_earned,
		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,
		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,
		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),
		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		--and L.ExceptClient='Y'
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end



--select top 10 * From tbl_Exchangemapping
 
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin

-----------------------------Fill MIS Table--------------------------------------------------------------------
		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,
		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,
		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,
		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)
		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,
		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,
		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',
		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,
		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0
		from #PartyDetails		
		group by Branch_cd,Emp_No		
print '1.2:'+convert(varchar,getdate(),109)
----------------------------------------Update Start Of Month Total Clients----------------------------------
		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth
		from
		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	
		from #PartyDetails ps 
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
print '2:'+convert(varchar,getdate(),109)
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------
		
--
print '3.1 '+convert(varchar,getdate(),109)
--
update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue
--CONVERT(decimal(15,2),
		from 
		(
		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)
  
		from #BrokTurnOver b
		group by b.Branch_cd,b.Emp_No
		)A,	#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
----------------------Update NA-----------------------------
--update #MIStable
----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

--Comment by sandip
--update #MIStable set ActivationRatio='NA'		
--where TotalClientsStartOfmonth<Tradedclients
update #MIStable set AvgDailyActRatio='NA'		
where TotalClientsStartOfmonth<AvgTradedclients
-----------------------------------------------Activation Ratio---------------------
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 
	into #RegActiveClients
	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by Sauda_date,Branch_cd,Emp_no)A 
	group by Branch_cd,Emp_no
	--order by 1
	--select * from #RegActiveClients
--Activation main page

--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays
--else 0.00 end)
--from #RegActiveClients A,	#MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--
--

update #MIStable set 
DailyTradedClients_AR=A.DailyTradedClients
from 
(select b.Branch_cd,b.Emp_No,
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
 
 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)
		where TD.CMTradingDay='Y'
		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
	group by b.Branch_cd,b.Emp_No
)A,	#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		


--select @DailyTradedClients_AR		
update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays
else 0.00 end)
from #RegActiveClients A,	#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--select DailyTradedClients_AR,DailyTradeDays from #MIStable

update #MIStable
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)
set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)


---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)
begin
		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate
		from 
		(
		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
		from #PartyDetails ps
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			Declare @Act_Days int,@H_days int
			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              
			set @H_days = ( select  count(distinct holidaydate)  from [196.1.115.207].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= @FromDate and holidaydate <= @ToDate )   
			print @TradeDays
			print @Act_Days
			print @H_days
			--if(@SegmentType='Currency')
			--begin
				--Fetch Emploee with CTC			
				
				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',
				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))
				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)
				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and
				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				
				
		
				--Update productivity for Employee
				print 'productivity'
				print @TradeDays
				print (@Act_Days-@H_days)
				update #MIStable set 
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 
								else '0.00' end)
				from #MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				
				
				/*--Print for testing
				select * from #ProdForCurr
				--Print RM
				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,
				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage
				from #MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'
				*/
			--End		
			
		end
		--------------------------------End Calculate Productivity--------------------------------------------------------------
end
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------
print '4:'+convert(varchar,getdate(),109)
--
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded
		from #PartyDetails ps
		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
		and ps.FirstTrade<=@ToDate
		--Delete traded clients
		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)
--	
print '4.1:'+convert(varchar,getdate(),109)
		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth
		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)
		from #nottraded ps
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
drop table #nottraded
--
print '5:'+convert(varchar,getdate(),109)
		
			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate
			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)
			from #PartyDetails ps
			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	
			and ps.FirstTrade>@ToDate
			group by ps.Branch_cd,ps.Emp_No
			)A,#MIStable B
				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	
--
print '6:'+convert(varchar,getdate(),109)
---------------------------------Update Client Visit Pending-------------------------
/*update #MIStable set ClientVisitPending=A.CVPcount
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No
)A,#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region
print '7:'+convert(varchar,getdate(),109)*/
------------------------------DROP #PartyDetails---
drop table #PartyDetails
------------------------------DISPLAY------------------------------------------------
print 'Wise: '
print @Wise
if @Wise='DEALER'
begin
		print 'DEALER'
		update #MIStable set Emp_Name=ah.EMP_NAME
					from #MIStable mis,B2B_AngelHarmony ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2,3
end
else
begin
		print 'SUBBROKER'
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2
end
--TOTAL
--if @TotalFlag <> 'Y' 
if(isnull(@TotalFlag,'') in ('','N'))
begin

--select  
--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
--Tradedclients=isnull(sum(Tradedclients),0),
--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
--		else 0.00 end)),
--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)
--from #RegActiveClients A,	#MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

select  
TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
Tradedclients=isnull(sum(Tradedclients),0),
		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
		else 0.00 end)),
		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end
from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

--group by DailyTradeDays
print 'End:'+convert(varchar,getdate(),109)
end 

END
---------------------MAIN PAGE END---------------------------------------------------
---------------------DRILL PAGE START---------------------------------------------------
else if @ReportType='DRILL'
begin
---------------------Declare drill page-------------------------------------------------
create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,
LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)
--
if @DrillFlag='TotalAsOn'
begin
print 'Drill 1:'+convert(varchar,getdate(),109)

	   
		--select * from @rto_Data
			
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate				

print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)
		
		if(@UserStatusId='SBDEALER')
		begin
			declare @rto_Data table
			(
			Zone varchar(20),
			Region varchar(20),
			branch_cd varchar(20),
			sub_broker varchar(20),
			Sub_brokerName varchar(200),
			party_code varchar(20),
			Short_name varchar(100),
			TotalTO money,
			OPTNoOfLots money,
			NoOfLotsGold bigint,
			NoOfLotsSilver bigint,
			NoOfLotsCopper bigint  ,
			NoOfLotsCrude bigint,
			NoOfLotsComm bigint,
			TargetNoOfLotsGold bigint,
			TargetNoOfLotsSilver bigint,
			TargetNoOfLotsCopper bigint,
			TargetNoOfLotsCrude bigint

			)	
			
			insert into @rto_Data
			--exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_newfo] 
			exec [196.1.115.207].CRM.dbo.[GetTurnoverfortime_new] 
			@Emp_no=@UserEmp_No,
			@Zone='',
			@Region='',
			@Branch='',
			@Exec=@Dealer,
			@FromTime='09:00 AM',
			@ToTime='11:59 PM',
			@MainDrill='DRILL',
			@WiseReport='SBDEALER',
			@seg='ALL',
			@B2CStatus='B2B',
			@MimStatusID='SBDEALER',
			@SB='',
			@RoundValue='1',
			@DownloadCSVFlag='Y'

			
			update #drillPartyDetails set TotalTo=rto.TotalTo
			from #drillPartyDetails drill, @rto_Data rto
			where drill.Party_Code=rto.party_code	
		end
		
			
		--
end
else if @DrillFlag='TotalStartOfMonth'
begin
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate	
end
else if @DrillFlag='NotTradedAsOn'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
				and ps.FirstTrade>@ToDate	
end
else if @DrillFlag='NotTradedForMonth'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				
				and ps.FirstTrade<=@ToDate		
		--
		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	
		--
end
else if @DrillFlag='Traded'
begin
		--Insert Traded Clients
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code
		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		
		
end
else if @DrillFlag='BROK'
begin		
		Declare @emp_name varchar(100)		
		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')
		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,
		br.Party_Code,ac1.Long_Name,
		--Turnover =sum(TotalTurnover),
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 
		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        --NetRevnue =sum(NetRevenue),
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Sauda_date)  
		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code
		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	
		
		--Total		
		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver
		return
end
else if @DrillFlag='ACTIVECLI'
begin		
	
	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),
	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100
	into #FinalActiveCli
	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join
	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)
	 from #BrokTurnOver b
	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	order by 1,2,3
	--Display
	select * from #FinalActiveCli
	select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli
	--Total Row
	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),
	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100
	 from #FinalActiveCli
	print 'helo'
return
end
---------------------Common Script for DRILL PAGE ---------------------------------------------------
	
print 'Drill 3:'+convert(varchar,getdate(),109)		
		-- Update Portfolio i.e. Holding value
		update #drillPartyDetails                                                             
		set PortfolioInfo=isnull(H.TotalHold,0)            
		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  [196.1.115.207].Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   
		on ps.party_code = H.party_code 
print 'Drill 4:'+convert(varchar,getdate(),109)		
		--Update Ledger Value
		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger
		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- [196.1.115.207].Angelcs.dbo.View_LedgerInfo L with(nolock)
		on ps.party_code = L.party_code 
		--
		update #drillPartyDetails                                                             
		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)
		from #drillPartyDetails ps left outer join #totalLedger L
		on ps.party_code = L.party_code 
		--
		drop table #totalLedger		
print 'Drill 5:'+convert(varchar,getdate(),109)			
		--Update Current Dealer
		update #drillPartyDetails set DealerCode=cps.Emp_No			
		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )
		where --cps.Segment_Type=@SegmentType and 
		/*EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and*/
		ps.Party_Code =cps.Party_Code and
		cps.Valid='Y' and cps.CommRank='1'
		--Set Row color as per BRS point 4.3.4 & 4.3.5
print 'Drill 6:'+convert(varchar,getdate(),109)	
		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	
		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)
		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'
		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)
		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)
		--		
print 'Drill End:'+convert(varchar,getdate(),109)	
	
		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',
		SB=Branch_cd,Party_Code,Client_Name,Emp_No,
		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),
		ClientGrade,[Profile],Sub_Profile,
		--ActiveFrom,
		ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),
		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)
		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),
		PureRisk=convert(decimal(15,2),PureRisk),
		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),
		--LastTradeDate,
		LastTradeDate=case when LastTradeDate='Not Traded' then 'NA' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,
		RowColor,LedgerColor,
		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)
		
		 from #drillPartyDetails s
		 order by SrNo
		 --Total
		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),
		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))
		  from #drillPartyDetails
-------------------
end
---------------------DRILL PAGE END---------------------------------------------------
END
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_TestDJ
-- --------------------------------------------------



CREATE procedure [dbo].[SBB2B_MIS_TestDJ]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20),       --SUBBROKER/DEALER
 @ReportType varchar(20), --MAIN/DRILL
 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 @TotalFlag varchar(2) = null
 as
 BEGIN
/*
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='jan  1 2013',@Wise='Dealer',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='HERA001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 AUg 2017',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='HERA001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Aug 2017',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

exec [SBB2B_MIS_TestDJ] @UserEmp_No='HERA001',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Aug 2017',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'
*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------
/*if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
	 
	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 
	 where Emp_No=@UserEmp_No                       */
	 --Select distinct  P.branch_cd,A.zone,A.region                                  
	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        
	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin    
        /*declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag*/
		insert into @tempbranch 
		select distinct Branch_cd=sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@UserEmp_No
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@UserEmp_No
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    
	/*insert into @tempbranch                                                                 
	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   
	 AngelHarmonyEmployee b--B2B_Harmony b 
	 on a.sbtag=b.hod*/
end

/*if @UserStatusId='SBCHILD'                           
begin
	insert into @tempbranch                                                                 
	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    
	where   HOD=@UserEmp_No	
	select * from @tempbranch	
end
*/
*/


Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker
 

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(20),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 --Declare  @MIStable table  
 create table #MIStable                                                         
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		and ps.Emp_No>=@FromDealer
		and ps.Emp_No<=@ToDealer
		--and ps.Segment_Type=@SegmentType
end

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
--else if @Wise='ZONE'
--begin
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''
--end
--else if @Wise='REGION'
--begin
--update #PartyDetails set Branch_cd='',Emp_No=''
--end
--else if @Wise='BRANCH'
--begin
--update #PartyDetails set Emp_No=''
--end
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin
	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 
		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code*/	
	
	if(@SegmentType in('COMMODITY'))
	begin
		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end
	else if(@SegmentType in('CURRENCY'))
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end		
	else --if(@SegmentType in('CASH','DERIVATIVE') and other
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTrade 
		from angelclient1 ac1 with(nolock),#PartyDetails ps 
		where ac1.Party_Code=ps.Party_Code
	end
end
--------------------------Fetch Brokerage in case when required-------------------------

/*

Select top 10 * from bsecm_cli

*/

if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

insert into #BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		Online_TurnOver=L.ebrok_TurnOver,
		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=L.ebrok_brok_earned,
		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		--NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue=case when L.sub_Broker='HYD1' then L.Overall_brok_earned else (L.Overall_brok_earned-L.Overall_Angel_share) end,
		NetRevenue_Online=case when L.sub_Broker='HYD1' then L.ebrok_brok_earned else (L.ebrok_brok_earned-L.ebrok_Angel_share) end,
		--NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),
		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		--and L.ExceptClient='Y'
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end



--select top 10 * From tbl_Exchangemapping
 
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin

-----------------------------Fill MIS Table--------------------------------------------------------------------
		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,
		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,
		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,
		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)
		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,
		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,
		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',
		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,
		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0
		from #PartyDetails		
		group by Branch_cd,Emp_No		
print '1.2:'+convert(varchar,getdate(),109)
----------------------------------------Update Start Of Month Total Clients----------------------------------
		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth
		from
		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	
		from #PartyDetails ps 
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
print '2:'+convert(varchar,getdate(),109)
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------
		
--
print '3.1 '+convert(varchar,getdate(),109)
--
update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue
--CONVERT(decimal(15,2),
		from 
		(
		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)
  
		from #BrokTurnOver b
		group by b.Branch_cd,b.Emp_No
		)A,	#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
----------------------Update NA-----------------------------
--update #MIStable
----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

--Comment by sandip
--update #MIStable set ActivationRatio='NA'		
--where TotalClientsStartOfmonth<Tradedclients
update #MIStable set AvgDailyActRatio='NA'		
where TotalClientsStartOfmonth<AvgTradedclients
-----------------------------------------------Activation Ratio---------------------
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 
	into #RegActiveClients
	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by Sauda_date,Branch_cd,Emp_no)A 
	group by Branch_cd,Emp_no
	--order by 1
	--select * from #RegActiveClients
--Activation main page

--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays
--else 0.00 end)
--from #RegActiveClients A,	#MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--
--

update #MIStable set 
DailyTradedClients_AR=A.DailyTradedClients
from 
(select b.Branch_cd,b.Emp_No,
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
 
 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)
		where TD.CMTradingDay='Y'
		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
	group by b.Branch_cd,b.Emp_No
)A,	#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		


--select @DailyTradedClients_AR		
update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays
else 0.00 end)
from #RegActiveClients A,	#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--select DailyTradedClients_AR,DailyTradeDays from #MIStable

update #MIStable
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)
set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)


---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)
begin
		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate
		from 
		(
		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
		from #PartyDetails ps
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			Declare @Act_Days int,@H_days int
			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              
			set @H_days = ( select  count(distinct holidaydate)  from MIMANSA.crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= @FromDate and holidaydate <= @ToDate )   
			print @TradeDays
			print @Act_Days
			print @H_days
			--if(@SegmentType='Currency')
			--begin
				--Fetch Emploee with CTC			
				
				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',
				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))
				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)
				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and
				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				
				
		
				--Update productivity for Employee
				print 'productivity'
				print @TradeDays
				print (@Act_Days-@H_days)
				update #MIStable set 
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 
								else '0.00' end)
				from #MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				
				
				/*--Print for testing
				select * from #ProdForCurr
				--Print RM
				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,
				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage
				from #MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'
				*/
			--End		
			
		end
		--------------------------------End Calculate Productivity--------------------------------------------------------------
end
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------
print '4:'+convert(varchar,getdate(),109)
--
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded
		from #PartyDetails ps
		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
		and ps.FirstTrade<=@ToDate
		--Delete traded clients
		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)
--	
print '4.1:'+convert(varchar,getdate(),109)
		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth
		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)
		from #nottraded ps
		group by ps.Branch_cd,ps.Emp_No
		)A,#MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
drop table #nottraded
--
print '5:'+convert(varchar,getdate(),109)
		
			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate
			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)
			from #PartyDetails ps
			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	
			and ps.FirstTrade>@ToDate
			group by ps.Branch_cd,ps.Emp_No
			)A,#MIStable B
				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	
--
print '6:'+convert(varchar,getdate(),109)
---------------------------------Update Client Visit Pending-------------------------
/*update #MIStable set ClientVisitPending=A.CVPcount
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No
)A,#MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region
print '7:'+convert(varchar,getdate(),109)*/
------------------------------DROP #PartyDetails---
drop table #PartyDetails
------------------------------DISPLAY------------------------------------------------
print 'Wise: '
print @Wise
if @Wise='DEALER'
begin
		print 'DEALER'
		update #MIStable set Emp_Name=ah.EMP_NAME
					from #MIStable mis,B2B_AngelHarmony ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2,3
end
else
begin
		print 'SUBBROKER'
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from #MIStable mis
		order by 1,2
end
--TOTAL
--if @TotalFlag <> 'Y' 
if(isnull(@TotalFlag,'') in ('','N'))
begin

--select  
--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
--Tradedclients=isnull(sum(Tradedclients),0),
--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
--		else 0.00 end)),
--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)
--from #RegActiveClients A,	#MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

select  
TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
Tradedclients=isnull(sum(Tradedclients),0),
		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
		else 0.00 end)),
		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end
from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

--group by DailyTradeDays
print 'End:'+convert(varchar,getdate(),109)
end 

END
---------------------MAIN PAGE END---------------------------------------------------
---------------------DRILL PAGE START---------------------------------------------------
else if @ReportType='DRILL'
begin
---------------------Declare drill page-------------------------------------------------
create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,
LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)
--
if @DrillFlag='TotalAsOn'
begin
print 'Drill 1:'+convert(varchar,getdate(),109)

	   
		--select * from @rto_Data
			
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate				

print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)
		
		if(@UserStatusId='SBDEALER')
		begin
			declare @rto_Data table
			(
			Zone varchar(20),
			Region varchar(20),
			branch_cd varchar(20),
			sub_broker varchar(20),
			Sub_brokerName varchar(200),
			party_code varchar(20),
			Short_name varchar(100),
			TotalTO money,
			OPTNoOfLots money,
			NoOfLotsGold bigint,
			NoOfLotsSilver bigint,
			NoOfLotsCopper bigint  ,
			NoOfLotsCrude bigint,
			NoOfLotsComm bigint,
			TargetNoOfLotsGold bigint,
			TargetNoOfLotsSilver bigint,
			TargetNoOfLotsCopper bigint,
			TargetNoOfLotsCrude bigint

			)	
			
			insert into @rto_Data
			--exec MIMANSA.CRM.dbo.[GetTurnoverfortime_newfo] 
			exec MIMANSA.CRM.dbo.[GetTurnoverfortime_new] 
			@Emp_no=@UserEmp_No,
			@Zone='',
			@Region='',
			@Branch='',
			@Exec=@Dealer,
			@FromTime='09:00 AM',
			@ToTime='11:59 PM',
			@MainDrill='DRILL',
			@WiseReport='SBDEALER',
			@seg='ALL',
			@B2CStatus='B2B',
			@MimStatusID='SBDEALER',
			@SB='',
			@RoundValue='1',
			@DownloadCSVFlag='Y'

			
			update #drillPartyDetails set TotalTo=rto.TotalTo
			from #drillPartyDetails drill, @rto_Data rto
			where drill.Party_Code=rto.party_code	
		end
		
			
		--
end
else if @DrillFlag='TotalStartOfMonth'
begin
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate	
end
else if @DrillFlag='NotTradedAsOn'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
				and ps.FirstTrade>@ToDate	
end
else if @DrillFlag='NotTradedForMonth'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				
				and ps.FirstTrade<=@ToDate		
		--
		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	
		--
end
else if @DrillFlag='Traded'
begin
		--Insert Traded Clients
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code
		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		
		
end
else if @DrillFlag='BROK'
begin		
		Declare @emp_name varchar(100)		
		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')
		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,
		br.Party_Code,ac1.Long_Name,
		--Turnover =sum(TotalTurnover),
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 
		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        --NetRevnue =sum(NetRevenue),
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Sauda_date)  
		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code
		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	
		
		--Total		
		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver
		return
end
else if @DrillFlag='ACTIVECLI'
begin		
	
	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),
	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100
	into #FinalActiveCli
	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join
	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)
	 from #BrokTurnOver b
	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	order by 1,2,3
	--Display
	--select * from #FinalActiveCli
	select  sauda_date=convert(varchar, convert(datetime, sauda_date, 101), 101),Branch_cd,Emp_no,TotalClient,Tradedclients,[Activation] from #FinalActiveCli
	--Total Row
	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),
	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100
	 from #FinalActiveCli
	
return
end
---------------------Common Script for DRILL PAGE ---------------------------------------------------
	
print 'Drill 3:'+convert(varchar,getdate(),109)		
		-- Update Portfolio i.e. Holding value
		update #drillPartyDetails                                                             
		set PortfolioInfo=isnull(H.TotalHold,0)            
		from #drillPartyDetails ps inner join holding_valuation H with(nolock) --  MIMANSA.Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   
		on ps.party_code = H.party_code 
print 'Drill 4:'+convert(varchar,getdate(),109)		
		--Update Ledger Value
		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger
		from #drillPartyDetails ps left outer join ledger_valuation L with(nolock)-- MIMANSA.Angelcs.dbo.View_LedgerInfo L with(nolock)
		on ps.party_code = L.party_code 
		--
		update #drillPartyDetails                                                             
		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)
		from #drillPartyDetails ps left outer join #totalLedger L
		on ps.party_code = L.party_code 
		--
		drop table #totalLedger		
print 'Drill 5:'+convert(varchar,getdate(),109)			
		--Update Current Dealer
		update #drillPartyDetails set DealerCode=cps.Emp_No			
		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )
		where --cps.Segment_Type=@SegmentType and 
		/*EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and*/
		ps.Party_Code =cps.Party_Code and
		cps.Valid='Y' and cps.CommRank='1'
		--Set Row color as per BRS point 4.3.4 & 4.3.5
print 'Drill 6:'+convert(varchar,getdate(),109)	
		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	
		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)
		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'
		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)
		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)
		--		
print 'Drill End:'+convert(varchar,getdate(),109)		
		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',
		SB=Branch_cd,Party_Code,Client_Name,Emp_No,
		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),
		ClientGrade,[Profile],Sub_Profile,
		--ActiveFrom,
		ActiveFrom=convert(varchar, convert(datetime, ActiveFrom, 101), 101),
		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)
		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),
		PureRisk=convert(decimal(15,2),PureRisk),
		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),
		--LastTradeDate,
		LastTradeDate=case when LastTradeDate='Not Traded' then 'Not Traded' else convert(varchar, convert(datetime, LastTradeDate, 101), 101) end,
		RowColor,LedgerColor,
		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)
		
		 from #drillPartyDetails s
		 order by SrNo
		 --Total
		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),
		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))
		  from #drillPartyDetails
-------------------
end
---------------------DRILL PAGE END---------------------------------------------------
END
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_uat
-- --------------------------------------------------

CREATE procedure [dbo].[SBB2B_MIS_uat]
 @UserEmp_No varchar(20),
 @UserStatusId varchar(10),--SUBBROKER/SBDEALER
 @Sub_Broker varchar(10),
 @Dealer varchar(20),
 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE
 @ClientGrade varchar(15),--ALL,A+,A,B,C,D
 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency
 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012
 @Wise varchar(20),       --SUBBROKER/DEALER
 @ReportType varchar(20), --MAIN/DRILL
 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI
 @TotalFlag varchar(2) = null
 as
 BEGIN
/*
exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='Dec  1 2012',@Wise='SUBBROKER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',
@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'
*/
--
print 'Start:'+convert(varchar,getdate(),109)
 Declare @ToDate smalldatetime
 Declare @FromDealer varchar(10)
 Declare @ToDealer varchar(10)
 Declare @FromEffSaudaDate datetime
 Declare @ToEffSaudaDate datetime
 Declare @TradeDays money
 Declare @SegmentTypeFrom varchar(10)
 Declare @SegmentTypeTo varchar(10)
 Declare @FromSub_Broker varchar(10)
 Declare @ToSub_Broker varchar(10)
 
 --------------------------------Set From and TO date---------------------------------------
set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'
set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'
print @FromDate
print @ToDate
set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))
set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))
set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))
set @Dealer=upper(ltrim(rtrim(@Dealer)))
set @TradingMode=upper(ltrim(rtrim(@TradingMode)))
set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))
set @SegmentType=upper(ltrim(rtrim(@SegmentType)))
set @Wise=upper(ltrim(rtrim(@Wise)))
set @ReportType=upper(ltrim(rtrim(@ReportType)))
set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))
 ---------------------------------------Get count of Trade Days---------------------------------------------
 /* Added table date for the Currency Segment */
if(@SegmentType = 'CURRENCY')
begin
   set @SegmentTypeFrom  ='CURRENCY'
   set @SegmentTypeTo='CURRENCY'
   
	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'
end
else
begin
			if(@SegmentType = 'CASH')
			begin
			set @SegmentTypeFrom  ='CASH'
			set @SegmentTypeTo='CASH'
			End

			if(@SegmentType = 'DERIVATIVE')
			begin
			set @SegmentTypeFrom  ='DERIVATIVE'
			set @SegmentTypeTo='DERIVATIVE'
			End
			
			if(@SegmentType = 'COMMODITY')
			begin
			set @SegmentTypeFrom  ='COMMODITY'
			set @SegmentTypeTo='COMMODITY'
			End

			if(@SegmentType = 'All')
			begin
			set @SegmentTypeFrom  ='a'
			set @SegmentTypeTo='zzzzzz'
			End
			
			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      
			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'
	end
 

 
print @TradeDays
 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------
 
 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 
 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate
 
 
----------------------------------------Redefine Report Wise option as per input fields-----------------------

set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)

print @Wise
-------------------------------------------------------------------------
/**subbroker*/
if @Sub_Broker='' or @Sub_Broker='ALL' 
Begin
	set @FromSub_Broker='A'
	set @ToSub_Broker='ZZZZZZZ'
End
else
Begin
	Set @FromSub_Broker=@Sub_Broker
	Set @ToSub_Broker=@Sub_Broker
End

--if @Dealer='' or @Dealer='ALL' set @Dealer='%'
--
/**subbrokerdealer*/
if @Dealer='' or @Dealer='ALL' 
begin
	set @FromDealer='A'
	set @ToDealer='ZZZZZZZ'
end
else
begin
	set @FromDealer=@Dealer
	set @ToDealer=@Dealer
end
--
--------------------------User Access---------------------------------------------------

/*fill subbrokers and dealers*/
declare @tempbranch  table                                                                
(                                                                
Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          
)
-----------------------------------------------------
/*if @UserStatusId='SBDEALER'                            
begin                  
	 insert into @tempbranch       
	 select distinct Branch_cd--,Emp_No 
	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No
	 
	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 
	 where Emp_No=@UserEmp_No                       */
	 --Select distinct  P.branch_cd,A.zone,A.region                                  
	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        
	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No
end                            
if @UserStatusId='SUBBROKER'                           
begin    
        /*declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag*/
		insert into @tempbranch 
		select distinct Branch_cd=sbtag from
		(
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
			Union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=@UserEmp_No
			union 
			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where sbtag=@UserEmp_No
			union
			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)
			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)
		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    
	/*insert into @tempbranch                                                                 
	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   
	 AngelHarmonyEmployee b--B2B_Harmony b 
	 on a.sbtag=b.hod*/
end

/*if @UserStatusId='SBCHILD'                           
begin
	insert into @tempbranch                                                                 
	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    
	where   HOD=@UserEmp_No	
	select * from @tempbranch	
end
*/
*/


Insert into @tempbranch
select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker
 

----------------------------Declare MIS and PartyDetails Table--------------------------

create table #PartyDetails (
Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime
,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime
--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime
)
--

create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),
TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,
NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,
Sauda_date smalldatetime)
--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)
--
 Declare  @MIStable table                                                          
 (                                                          
 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,
 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,
 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,
 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),
 OnlineTurnover money, OfflineTurnover money, Turnover money,
 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int
 )                                                        
--
print 'Access:'+convert(varchar,getdate(),109)
if @Dealer='' or @Dealer='ALL' 
begin
		--		
		print 'ACT1'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd 
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		--and ps.Segment_Type=@SegmentType
		
end 
else
begin
		print 'ACT2'
		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)
		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate
		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub
		where ps.Branch_cd=aub.Branch_cd
		--and ps.emp_no=aub.dealers
		and ps.FromDate<=@ToDate
		and ps.ToDate>=@FromDate
		and ps.Emp_No>=@FromDealer
		and ps.Emp_No<=@ToDealer
		--and ps.Segment_Type=@SegmentType
end

--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------
if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')
begin
print 'TradingMode or ClientGrade'
if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)
if @ClientGrade='ALL' set @ClientGrade='%'
--
update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating
From angelclient1 ac1,#PartyDetails ps
where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode
and ac1.AngelClRating like @ClientGrade
--
delete #PartyDetails where isnull(EbrokingClient,'')=''
--
end
-----------------------Update #PartyDetails as per report Wise option -------------------------------------
--print '1.1:'+convert(varchar,getdate(),109)
if @Wise='SUBBROKER'
begin
	update #PartyDetails set Emp_No=''
end 
--else if @Wise='ZONE'
--begin
--update #PartyDetails set Region='',Branch_cd='',Emp_No=''
--end
--else if @Wise='REGION'
--begin
--update #PartyDetails set Branch_cd='',Emp_No=''
--end
--else if @Wise='BRANCH'
--begin
--update #PartyDetails set Emp_No=''
--end
-----------------------Update FirstTrade date -------------------------------------
if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))
begin
	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 
		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code*/	
	
	if(@SegmentType in('COMMODITY'))
	begin
		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end
	else if(@SegmentType in('CURRENCY'))
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 
		from angelclient1 ac1 with(nolock),#PartyDetails ps
		where ps.Party_Code=ac1.Party_Code
	end		
	else --if(@SegmentType in('CASH','DERIVATIVE') and other
	begin
		update #PartyDetails set FirstTrade= ac1.FirstTrade 
		from angelclient1 ac1 with(nolock),#PartyDetails ps 
		where ac1.Party_Code=ps.Party_Code
	end
end
--------------------------Fetch Brokerage in case when required-------------------------

/*

Select top 10 * from bsecm_cli

*/

if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))
begin
print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)
/*print 'Segment'
print @SegmentTypeFrom
print @SegmentTypeTo
print 'Eff Date'
print @FromEffSaudaDate
print @ToEffSaudaDate
print 'Date'
print @FromDate
print @ToDate*/
/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 
from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */
--

insert into #BrokTurnOver
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 
		TotalTurnover = L.Overall_turnover,
		Online_TurnOver=L.ebrok_TurnOver,
		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),
		GrossRevenue=L.Overall_brok_earned,
		GrossRevenue_Online=L.ebrok_brok_earned,
		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),
		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),
		NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),
		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),
		L.Sauda_date  
		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),
		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),
		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),
		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 
		where 
		EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and
		--EM.Segment_Type='ALL' and 
		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments
		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  
		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   
		When L.Segment = 'ABLCM' Then 'BSECM'   
		When L.Segment = 'ACDLCM' Then 'NSECM'   
		When L.Segment = 'ACDLFO' Then 'NSEFO'   
		When L.Segment = 'ACPLMCD' Then 'MCD'  
		When L.Segment = 'ACDLNSX' Then 'NSX' End) and
		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		
		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 
		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 
		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 
		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table
		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date
		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 
		--and L.ExceptClient='Y'
print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)

end



--select top 10 * From tbl_Exchangemapping
 
---------------------MAIN PAGE---------------------------------
if @ReportType='MAIN'
begin

-----------------------------Fill MIS Table--------------------------------------------------------------------
		insert into @MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,
		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,
		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,
		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)
		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,
		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,
		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',
		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,
		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0
		from #PartyDetails		
		group by Branch_cd,Emp_No		
print '1.2:'+convert(varchar,getdate(),109)
----------------------------------------Update Start Of Month Total Clients----------------------------------
		update @MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth
		from
		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	
		from #PartyDetails ps 
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
print '2:'+convert(varchar,getdate(),109)
-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------
		
--
print '3.1 '+convert(varchar,getdate(),109)
--
update @MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,
DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,
AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),
AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),
AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),
--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),
--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),
 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,
 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue
--CONVERT(decimal(15,2),
		from 
		(
		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   
        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),
        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),
        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),
 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)
  
		from #BrokTurnOver b
		group by b.Branch_cd,b.Emp_No
		)A,	@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
----------------------Update NA-----------------------------
--update @MIStable
----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

--Comment by sandip
--update @MIStable set ActivationRatio='NA'		
--where TotalClientsStartOfmonth<Tradedclients
update @MIStable set AvgDailyActRatio='NA'		
where TotalClientsStartOfmonth<AvgTradedclients
-----------------------------------------------Activation Ratio---------------------
select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 
	into #RegActiveClients
	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by Sauda_date,Branch_cd,Emp_no)A 
	group by Branch_cd,Emp_no
	--order by 1
	--select * from #RegActiveClients
--Activation main page

--update @MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays
--else 0.00 end)
--from #RegActiveClients A,	@MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--
--

select * from #BrokTurnOver
select * from TABLE_DATE where CMTradingDay='Y' and LEFT(Sauda_date,11)=LEFT(GETDATE()-1,11)

select b.Branch_cd,b.Emp_No,
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
 
 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)
		where TD.CMTradingDay='Y'
		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
	group by b.Branch_cd,b.Emp_No

select
DailyTradedClients_AR=A.DailyTradedClients
from 
(select b.Branch_cd,b.Emp_No,
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
 
 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)
		where TD.CMTradingDay='Y'
		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
	group by b.Branch_cd,b.Emp_No
)A,	@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	

return 
update @MIStable set 
DailyTradedClients_AR=A.DailyTradedClients
from 
(select b.Branch_cd,b.Emp_No,
 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)
 
 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)
		where TD.CMTradingDay='Y'
		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)
	group by b.Branch_cd,b.Emp_No
)A,	@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		

--select @DailyTradedClients_AR		
update @MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (convert(decimal(10,4),DailyTradedClients_AR)/A.RegClients)*100--/DailyTradeDays
else 0.00 end)
from #RegActiveClients A,	@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--select DailyTradedClients_AR,DailyTradeDays from @MIStable

update @MIStable
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)
--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)
set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)


---------------------------------------------------------Update AS ON CLIENTS----------------------------------
print '3.2:'+convert(varchar,getdate(),109)
if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)
begin
		update @MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate
		from 
		(
		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)
		from #PartyDetails ps
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate		
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
		--------------------------------Calculate Productivity--------------------------------------------------------------
		if @Wise='DEALER'
		begin
			Declare @Act_Days int,@H_days int
			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              
			set @H_days = ( select  count(distinct holidaydate)  from MIMANSA.crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       
						where holidaydate >= @FromDate and holidaydate <= @ToDate )   
			print @TradeDays
			print @Act_Days
			print @H_days
			--if(@SegmentType='Currency')
			--begin
				--Fetch Emploee with CTC			
				
				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',
				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))
				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)
				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and
				 ah.Status='A' and EMP_NO in (select EMP_NO from @MIStable)				
				
		
				--Update productivity for Employee
				print 'productivity'
				print @TradeDays
				print (@Act_Days-@H_days)
				update @MIStable set 
				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  
								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 
								else '0.00' end)
				from @MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'
				
				
				/*--Print for testing
				select * from #ProdForCurr
				--Print RM
				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,
				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage
				from @MIStable mis,#ProdForCurr ah
				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'
				*/
			--End		
			
		end
		--------------------------------End Calculate Productivity--------------------------------------------------------------
end
----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------
print '4:'+convert(varchar,getdate(),109)
--
		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded
		from #PartyDetails ps
		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
		and ps.FirstTrade<=@ToDate
		--Delete traded clients
		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)
--	
print '4.1:'+convert(varchar,getdate(),109)
		update @MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth
		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)
		from #nottraded ps
		group by ps.Branch_cd,ps.Emp_No
		)A,@MIStable B
			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 
--
drop table #nottraded
--
print '5:'+convert(varchar,getdate(),109)
		
			update @MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate
			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)
			from #PartyDetails ps
			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	
			and ps.FirstTrade>@ToDate
			group by ps.Branch_cd,ps.Emp_No
			)A,@MIStable B
				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	
--
print '6:'+convert(varchar,getdate(),109)
---------------------------------Update Client Visit Pending-------------------------
/*update @MIStable set ClientVisitPending=A.CVPcount
from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp
where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No
)A,@MIStable B
where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region
print '7:'+convert(varchar,getdate(),109)*/
------------------------------DROP #PartyDetails---
drop table #PartyDetails
------------------------------DISPLAY------------------------------------------------
print 'Wise: '
print @Wise
if @Wise='DEALER'
begin
		print 'DEALER'
		update @MIStable set Emp_Name=ah.EMP_NAME
					from @MIStable mis,B2B_AngelHarmony ah with(nolock)
					where mis.Emp_No=ah.EMP_NO
		update @MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from @MIStable mis
		order by 1,2,3
end
else
begin
		print 'SUBBROKER'
		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,
		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),
		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),
		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),
		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),
		Productivity,
		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),
		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,
		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),
		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate
		from @MIStable mis
		order by 1,2
end
--TOTAL
--if @TotalFlag <> 'Y' 
if(isnull(@TotalFlag,'') in ('','N'))
begin

--select  
--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
--Tradedclients=isnull(sum(Tradedclients),0),
--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
--		else 0.00 end)),
--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)
--from #RegActiveClients A,	@MIStable B
--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

select  
TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),
Tradedclients=isnull(sum(Tradedclients),0),
		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 
		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 
		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 
		else 0.00 end)),
		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),
		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),
		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),
		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),
		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),
		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))
		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end
from @MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No

--group by DailyTradeDays
print 'End:'+convert(varchar,getdate(),109)
end 

END
---------------------MAIN PAGE END---------------------------------------------------
---------------------DRILL PAGE START---------------------------------------------------
else if @ReportType='DRILL'
begin
---------------------Declare drill page-------------------------------------------------
create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),
ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),
DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,
LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)
--
if @DrillFlag='TotalAsOn'
begin
print 'Drill 1:'+convert(varchar,getdate(),109)

	   
		--select * from @rto_Data
			
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@ToDate
		and ps.ToDate>=@ToDate				
		
		if(@UserStatusId='SBDEALER')
		begin
			declare @rto_Data table
			(
			Zone varchar(20),
			Region varchar(20),
			branch_cd varchar(20),
			sub_broker varchar(20),
			Sub_brokerName varchar(200),
			party_code varchar(20),
			Short_name varchar(100),
			TotalTO money

			)	

			insert into @rto_Data
			exec MIMANSA.CRM.dbo.[GetTurnoverfortime_newfo] 
			@Emp_no=@UserEmp_No,
			@Zone='',
			@Region='',
			@Branch='',
			@Exec=@Dealer,
			@FromTime='09:00 AM',
			@ToTime='11:59 PM',
			@MainDrill='DRILL',
			@WiseReport='SBDEALER',
			@seg='ALL',
			@B2CStatus='B2B',
			@MimStatusID='SBDEALER',
			@SB='',
			@RoundValue='1',
			@DownloadCSVFlag='Y'

			
			update #drillPartyDetails set TotalTo=rto.TotalTo
			from #drillPartyDetails drill, @rto_Data rto
			where drill.Party_Code=rto.party_code	
		end
		
			
		--
end
else if @DrillFlag='TotalStartOfMonth'
begin
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		where ps.FromDate<=@FromDate
		and ps.ToDate>=@FromDate	
end
else if @DrillFlag='NotTradedAsOn'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			
				and ps.FirstTrade>@ToDate	
end
else if @DrillFlag='NotTradedForMonth'
begin
				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)
				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,
				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')
				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				
				and ps.FirstTrade<=@ToDate		
		--
		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	
		--
end
else if @DrillFlag='Traded'
begin
		--Insert Traded Clients
		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)
		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,
		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',
		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,
		LastTradeDate=left(ac1.LastTrade,11)
		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code
		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code
		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code
		
		
end
else if @DrillFlag='BROK'
begin		
		Declare @emp_name varchar(100)		
		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')
		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,
		br.Party_Code,ac1.Long_Name,
		--Turnover =sum(TotalTurnover),
        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 
		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        --NetRevnue =sum(NetRevenue),
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Sauda_date)  
		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code
		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	
		
		--Total		
		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  
        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        
        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),
        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver
		return
end
else if @DrillFlag='ACTIVECLI'
begin		
	
	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),
	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100
	into #FinalActiveCli
	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)
	from #PartyDetails ps,Table_Date TD with(nolock) 
	where TD.sauda_date>=@FromDate 
	and TD.sauda_date<=@ToDate
	and FromDate<=TD.sauda_date
	and ToDate>TD.sauda_date
	and TD.CmTradingDay = 'Y'        
	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join
	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)
	 from #BrokTurnOver b
	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no
	order by 1,2,3
	--Display
	select * from #FinalActiveCli
	--Total Row
	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),
	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100
	 from #FinalActiveCli
	
return
end
---------------------Common Script for DRILL PAGE ---------------------------------------------------
	
print 'Drill 3:'+convert(varchar,getdate(),109)		
		-- Update Portfolio i.e. Holding value
		update #drillPartyDetails                                                             
		set PortfolioInfo=isnull(H.TotalHold,0)            
		from #drillPartyDetails ps inner join   MIMANSA.Angelcs.dbo.View_PartyWise_Holding H   with (nolock)                                                                   
		on ps.party_code = H.party_code 
print 'Drill 4:'+convert(varchar,getdate(),109)		
		--Update Ledger Value
		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger
		from #drillPartyDetails ps left outer join  MIMANSA.Angelcs.dbo.View_LedgerInfo L with(nolock)
		on ps.party_code = L.party_code 
		--
		update #drillPartyDetails                                                             
		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)
		from #drillPartyDetails ps left outer join #totalLedger L
		on ps.party_code = L.party_code 
		--
		drop table #totalLedger		
print 'Drill 5:'+convert(varchar,getdate(),109)			
		--Update Current Dealer
		update #drillPartyDetails set DealerCode=cps.Emp_No			
		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )
		where --cps.Segment_Type=@SegmentType and 
		/*EM.Segment_Type>=@SegmentTypeFrom and 	
		EM.Segment_Type<=@SegmentTypeTo and*/
		ps.Party_Code =cps.Party_Code and
		cps.Valid='Y' and cps.CommRank='1'
		--Set Row color as per BRS point 4.3.4 & 4.3.5
print 'Drill 6:'+convert(varchar,getdate(),109)	
		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	
		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)
		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'
		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)
		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)
		--		
print 'Drill End:'+convert(varchar,getdate(),109)		
		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',
		SB=Branch_cd,Party_Code,Client_Name,Emp_No,
		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),
		ClientGrade,[Profile],Sub_Profile,ActiveFrom,
		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)
		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),
		PureRisk=convert(decimal(15,2),PureRisk),
		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),LastTradeDate,RowColor,LedgerColor,
		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)
		
		 from #drillPartyDetails s
		 order by SrNo
		 --Total
		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),
		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))
		  from #drillPartyDetails
-------------------
end
---------------------DRILL PAGE END---------------------------------------------------
END
---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBB2B_MIS_vol1
-- --------------------------------------------------




CREATE procedure [dbo].[SBB2B_MIS_vol1]

 @UserEmp_No varchar(20),

 @UserStatusId varchar(10),--SUBBROKER/SBDEALER

 @Sub_Broker varchar(10),

 @Dealer varchar(20),

 @TradingMode varchar(15),--ALL,ONLINE,OFFLINE

 @ClientGrade varchar(15),--ALL,A+,A,B,C,D

 @SegmentType varchar(20),--ALL,Equity,Derivative,Commodity and Currency

 @FromDate smalldatetime,--MM/DD/YYYY OR like 1 Jan 2012

 @Wise varchar(20),       --SUBBROKER/DEALER

 @ReportType varchar(20), --MAIN/DRILL

 @DrillFlag varchar(20),  -- TotalAsOn/TotalStartOfMonth/NotTradedAsOn/NotTradedForMonth/Traded/BROK/ACTIVECLI

 @TotalFlag varchar(2) = null

 as

 BEGIN

/*

exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='jan  1 2013',@Wise='Dealer',@ReportType='MAIN',@DrillFlag=''



exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 Mar 2012',@Wise='DEALER',@ReportType='MAIN',@DrillFlag=''



exec [SBB2B_MIS] @UserEmp_No='ET001',@UserStatusId='SUBBROKER',@Sub_Broker='ET',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 Jul 2012',@Wise='',@ReportType='DRILL',@DrillFlag='BROK'



exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='ETA002',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'



exec [SBB2B_MIS] @UserEmp_No='ETA002',@UserStatusId='SBDELER',@Sub_Broker='',@Dealer='',@TradingMode='ALL',@ClientGrade='ALL',

@SegmentType='ALL',@FromDate='1 nov 2012',@Wise='',@ReportType='DRILL',@DrillFlag='TotalAsOn'

*/

--

print 'Start:'+convert(varchar,getdate(),109)

 Declare @ToDate smalldatetime

 Declare @FromDealer varchar(10)

 Declare @ToDealer varchar(10)

 Declare @FromEffSaudaDate datetime

 Declare @ToEffSaudaDate datetime

 Declare @TradeDays money

 Declare @SegmentTypeFrom varchar(10)

 Declare @SegmentTypeTo varchar(10)

 Declare @FromSub_Broker varchar(10)

 Declare @ToSub_Broker varchar(10)

 

 --------------------------------Set From and TO date---------------------------------------

set @FromDate=left(CONVERT(smalldatetime,@FromDate),11)+' 00:00'

set @ToDate=  left(Convert(varchar,DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@FromDate)+1,0)),109),11) + ' 23:59'

print @FromDate

print @ToDate

set @UserEmp_No=upper(ltrim(rtrim(@UserEmp_No)))

set @UserStatusId=upper(ltrim(rtrim(@UserStatusId)))

set @Sub_Broker=upper(ltrim(rtrim(@Sub_Broker)))

set @Dealer=upper(ltrim(rtrim(@Dealer)))

set @TradingMode=upper(ltrim(rtrim(@TradingMode)))

set @ClientGrade=upper(ltrim(rtrim(@ClientGrade)))

set @SegmentType=upper(ltrim(rtrim(@SegmentType)))

set @Wise=upper(ltrim(rtrim(@Wise)))

set @ReportType=upper(ltrim(rtrim(@ReportType)))

set @DrillFlag=upper(ltrim(rtrim(@DrillFlag)))

 ---------------------------------------Get count of Trade Days---------------------------------------------

 /* Added table date for the Currency Segment */

if(@SegmentType = 'CURRENCY')

begin

   set @SegmentTypeFrom  ='CURRENCY'

   set @SegmentTypeTo='CURRENCY'

   

	select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

	where sauda_date >= @FromDate and sauda_date <= @ToDate and CurrTradingDay = 'Y'

end

else

begin

			if(@SegmentType = 'CASH')

			begin

			set @SegmentTypeFrom  ='CASH'

			set @SegmentTypeTo='CASH'

			End



			if(@SegmentType = 'DERIVATIVE')

			begin

			set @SegmentTypeFrom  ='DERIVATIVE'

			set @SegmentTypeTo='DERIVATIVE'

			End

			

			if(@SegmentType = 'COMMODITY')

			begin

			set @SegmentTypeFrom  ='COMMODITY'

			set @SegmentTypeTo='COMMODITY'

			End



			if(@SegmentType = 'All')

			begin

			set @SegmentTypeFrom  ='a'

			set @SegmentTypeTo='zzzzzz'

			End

			

			select @TradeDays=Count(distinct sauda_date) from TABLE_DATE L with(noLock)                                                                      

			where sauda_date >= @FromDate and sauda_date <= @ToDate and CMTradingDay = 'Y'

	end

 



 

print @TradeDays

 -------------------------Get From Sauda Date and To Sauda Date to limit Level1MISPartyDayWise--------------

 

 select @FromEffSaudaDate=left(MIN(Sauda_date),11),@ToEffSaudaDate=MAX(Sauda_date) 

 from TABLE_DATE TD with (nolock) where EffSauda_date>=@FromDate and EffSauda_date<=@ToDate

 

 

----------------------------------------Redefine Report Wise option as per input fields-----------------------



set @Wise=(case when @Dealer<>'' and @Dealer<>'ALL' and @Wise IN('SUBBROKER') then 'DEALER' else upper(ltrim(rtrim(@Wise))) end)



print @Wise

-------------------------------------------------------------------------

/**subbroker*/

if @Sub_Broker='' or @Sub_Broker='ALL' 

Begin

	set @FromSub_Broker='A'

	set @ToSub_Broker='ZZZZZZZ'

End

else

Begin

	Set @FromSub_Broker=@Sub_Broker

	Set @ToSub_Broker=@Sub_Broker

End



--if @Dealer='' or @Dealer='ALL' set @Dealer='%'

--

/**subbrokerdealer*/

if @Dealer='' or @Dealer='ALL' 

begin

	set @FromDealer='A'

	set @ToDealer='ZZZZZZZ'

end

else

begin

	set @FromDealer=@Dealer

	set @ToDealer=@Dealer

end

--

--------------------------User Access---------------------------------------------------



/*fill subbrokers and dealers*/

declare @tempbranch  table                                                                

(                                                                

Branch_cd varchar(20)--,dealers varchar(30)                                                                                                                          

)

-----------------------------------------------------

/*if @UserStatusId='SBDEALER'                            

begin                  

	 insert into @tempbranch       

	 select distinct Branch_cd--,Emp_No 

	 from B2B_CommonPartyServices with(nolock) where Emp_No=@UserEmp_No

	 

	 /*select distinct HOD,Emp_No from  AngelHarmonyEmployee--  B2B_Harmony 

	 where Emp_No=@UserEmp_No                       */

	 --Select distinct  P.branch_cd,A.zone,A.region                                  

	 --from crm..CommonPartyServices P with(Nolock),angelcs..angelbranch A with(Nolock)                                        

	 --where  P.branch_cd = A.branch_cd and P.emp_no = @UserEmp_No

end                            

if @UserStatusId='SUBBROKER'                           

begin    

        /*declare  @temp_sbtag table

		(sbtag varchar(10))

		

		insert into @temp_sbtag*/

		insert into @tempbranch 

		select distinct Branch_cd=sbtag from

		(

			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)

			Union 

			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

			where parenttag=@UserEmp_No

			union 

			select sbtag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

			where sbtag=@UserEmp_No

			union

			select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock)

			where parenttag=(Select parenttag from [196.1.115.239].Inhouse.dbo.sb_broker with(nolock) where sbtag=@UserEmp_No)

		)a	    where  sbtag >=@FromSub_Broker and  sbtag <=@ToSub_Broker    

	/*insert into @tempbranch                                                                 

	 select distinct b.hod ,b.emp_no from  @temp_sbtag a    inner join   

	 AngelHarmonyEmployee b--B2B_Harmony b 

	 on a.sbtag=b.hod*/

end



/*if @UserStatusId='SBCHILD'                           

begin

	insert into @tempbranch                                                                 

	select distinct HOD,emp_no from AngelHarmonyEmployee--B2B_Harmony    

	where   HOD=@UserEmp_No	

	select * from @tempbranch	

end

*/

*/





Insert into @tempbranch

select * from b2b_crms_mimansa_status(@UserEmp_No) where sb_tag >=@FromSub_Broker and  sb_tag <=@ToSub_Broker

 



----------------------------Declare MIS and PartyDetails Table--------------------------



create table #PartyDetails (

Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),FromDate smalldatetime,ToDate smalldatetime

,EbrokingClient char(1),AngelClRating varchar(10),Margin money,FirstTrade smalldatetime

--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime

)

--



create table #BrokTurnOver (Party_Code varchar(10),Branch_cd varchar(20),Emp_No varchar(10),

TotalTurnOver money,Online_TurnOver money,Offline_TurnOver money,GrossRevenue money,GrossRevenue_Online money,GrossRevenue_Offline money,

NetRevenue money,NetRevenue_Online money,NetRevenue_Offline money,

Sauda_date smalldatetime)

--declare @TurnOver table(Party_Code varchar(10),Emp_No varchar(10),GrossTurnOver money,OnlineTurn money,OfflineTurn money,Sauda_date smalldatetime)

--

 --Declare  @MIStable table  

 create table #MIStable                                                         

 (                                                          

 Branch_cd varchar(20),Emp_No varchar(20),  TotalClientsStartOfmonth int,

 TotalClientsAsonDate int, Tradedclients int, ClientNotTradedForMonth int, ClientNotTradedAsOnDate int, AvgTradedclients money,

 OnlineBrok money, OfflineBrok money, Brokerage money,  DailyTradedClients int, AvgDailyActRatio varchar(10), AvgRevPerClient money,

 ActivationRatio varchar(10),Productivity varchar(10),emp_ctc money,Emp_Name varchar(100),

 OnlineTurnover money, OfflineTurnover money, Turnover money,

 OnlineNetRevnue money, OfflineNetRevnue money, NetRevnue money,DailyTradeDays int,DailyTradedClients_AR int

 )                                                        

--

print 'Access:'+convert(varchar,getdate(),109)

if @Dealer='' or @Dealer='ALL' 

begin

		--		

		print 'ACT1'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd 

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		--and ps.Segment_Type=@SegmentType

		

end 

else

begin

		print 'ACT2'

		insert into #PartyDetails (Party_Code,Branch_cd,Emp_No,FromDate,ToDate)

		select  ps.party_code,ps.Branch_cd,ps.Emp_No,FromDate,ToDate

		from B2B_CommonPartyServices ps with(nolock),@tempbranch aub

		where ps.Branch_cd=aub.Branch_cd

		--and ps.emp_no=aub.dealers

		and ps.FromDate<=@ToDate

		and ps.ToDate>=@FromDate

		and ps.Emp_No>=@FromDealer

		and ps.Emp_No<=@ToDealer

		--and ps.Segment_Type=@SegmentType

end



--------------------Filter the required data if TrdadingMode or ClientGrade is selected ------------------

if (@TradingMode<>'' and @TradingMode<>'ALL') or (@ClientGrade<>'' and @ClientGrade<>'ALL')

begin

print 'TradingMode or ClientGrade'

if @TradingMode='ALL' set @TradingMode='%' else set @TradingMode=(case when @TradingMode='ONLINE' then 'Y' else 'N' end)

if @ClientGrade='ALL' set @ClientGrade='%'

--

update #PartyDetails set EbrokingClient=ac1.EbrokingClient,AngelClRating=ac1.AngelClRating

From angelclient1 ac1,#PartyDetails ps

where ac1.Party_Code=ps.Party_Code and ac1.EbrokingClient like @TradingMode

and ac1.AngelClRating like @ClientGrade

--

delete #PartyDetails where isnull(EbrokingClient,'')=''

--

end

-----------------------Update #PartyDetails as per report Wise option -------------------------------------

--print '1.1:'+convert(varchar,getdate(),109)

if @Wise='SUBBROKER'

begin

	update #PartyDetails set Emp_No=''

end 

--else if @Wise='ZONE'

--begin

--update #PartyDetails set Region='',Branch_cd='',Emp_No=''

--end

--else if @Wise='REGION'

--begin

--update #PartyDetails set Branch_cd='',Emp_No=''

--end

--else if @Wise='BRANCH'

--begin

--update #PartyDetails set Emp_No=''

--end

-----------------------Update FirstTrade date -------------------------------------

if @ReportType='MAIN' or (@DrillFlag in('NotTradedAsOn','NotTradedForMonth'))

begin

	/*update #PartyDetails set FirstTrade=(case when @SegmentType='CASH' then ac1.FirstTrade when @SegmentType='DERIVATIVE' then 

		ac1.FirstTrade when @SegmentType='COMMODITY' then ac1.ActiveFromMcxNcx  when @SegmentType='CURRENCY' then ac1.FirstTradeCurr else ac1.FirstTrade  end)

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code*/	

	

	if(@SegmentType in('COMMODITY'))

	begin

		update #PartyDetails set FirstTrade= ac1.ActiveFromMcxNcx 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end

	else if(@SegmentType in('CURRENCY'))

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTradeCurr 

		from angelclient1 ac1 with(nolock),#PartyDetails ps

		where ps.Party_Code=ac1.Party_Code

	end		

	else --if(@SegmentType in('CASH','DERIVATIVE') and other

	begin

		update #PartyDetails set FirstTrade= ac1.FirstTrade 

		from angelclient1 ac1 with(nolock),#PartyDetails ps 

		where ac1.Party_Code=ps.Party_Code

	end

end

--------------------------Fetch Brokerage in case when required-------------------------



/*



Select top 10 * from bsecm_cli



*/



if @ReportType='MAIN' or (@DrillFlag in('BROK','Traded','NotTradedForMonth','ACTIVECLI'))

begin

print '1.1.BROKERAGE:'+convert(varchar,getdate(),109)

/*print 'Segment'

print @SegmentTypeFrom

print @SegmentTypeTo

print 'Eff Date'

print @FromEffSaudaDate

print @ToEffSaudaDate

print 'Date'

print @FromDate

print @ToDate*/

/*select Sauda_date=cast(left(Sauda_date,11) as datetime),EffSauda_date into #TABLE_DATE 

from TABLE_DATE with(nolock) where sauda_date >= @FromDate AND sauda_date <= @ToDate */

--



insert into #BrokTurnOver

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No, 

		TotalTurnover = L.Overall_turnover,

		Online_TurnOver=L.ebrok_TurnOver,

		Offline_TurnOver=(L.Overall_turnover-L.ebrok_TurnOver),

		GrossRevenue=L.Overall_brok_earned,

		GrossRevenue_Online=L.ebrok_brok_earned,

		GrossRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned),

		NetRevenue=(L.Overall_brok_earned-L.Overall_Angel_share),

		NetRevenue_Online=(L.ebrok_brok_earned-L.ebrok_Angel_share),

		NetRevenue_Offline=(L.Overall_brok_earned-L.ebrok_brok_earned)-(L.Overall_Angel_share-L.ebrok_Angel_share),

		L.Sauda_date  

		from #PartyDetails ps ,--tbl_ebrok_detail_cli L WITH (nolock),

		--mis.remisior.dbo.tbl_ebrok_detail_cli  L WITH (nolock),

		Ebroking.dbo.tbl_ebrok_detail_cli L WITH (nolock),

		B2B_tbl_ExchangeMapping EM WITH (nolock), TABLE_DATE TD with (nolock) 

		where 

		EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and

		--EM.Segment_Type='ALL' and 

		--and EM.ExchangeSegment = L.ExchangeSegment -- Check Level1MISPartyDayWise table for specified segments

		EM.ExchangeSegment = (Case When L.Segment = 'ACPLMCX' Then 'MCX'  

		When L.Segment in('ACPLNCDX','ACPLNCDEX') Then 'NCX'   

		When L.Segment = 'ABLCM' Then 'BSECM'   

		When L.Segment = 'ACDLCM' Then 'NSECM'   

		When L.Segment = 'ACDLFO' Then 'NSEFO'   

		When L.Segment = 'ACPLMCD' Then 'MCD'  

		When L.Segment = 'ACDLNSX' Then 'NSX' End) and

		 --ps.Party_Code=L.Party_code collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 ps.Party_Code=case when left(L.Party_code,2)='98' then substring(L.Party_code,3,len(L.Party_code)) else L.Party_code end   collate SQL_Latin1_General_CP1_CI_AS--Latin1_General_CI_AS -- Check filtered parties in Level1MISPartyDayWise		

		 and ps.FromDate <= TD.EffSauda_date AND ps.ToDate >= TD.EffSauda_date -- Check for Efective Sauda Date 

		 and cast(left(TD.Sauda_date,11) as datetime) = L.Sauda_date   		-- Check for Sauda Date 

		--and TD.Sauda_date = L.Sauda_date   		-- Check for Sauda Date 

		AND EM.FromDate <= @FromDate AND EM.ToDate >= @ToDate -- Check Exchange Mapping table

		and TD.EffSauda_date>= @FromDate AND TD.EffSauda_date <= @ToDate -- Limit EffSauda_date

		and L.Sauda_date>= @FromEffSaudaDate and L.Sauda_date<= @ToEffSaudaDate 

		--and L.ExceptClient='Y'

print '1.2.BROKERAGE:'+convert(varchar,getdate(),109)



end







--select top 10 * From tbl_Exchangemapping

 

---------------------MAIN PAGE---------------------------------

if @ReportType='MAIN'

begin



-----------------------------Fill MIS Table--------------------------------------------------------------------

		insert into #MIStable(Branch_cd ,Emp_No,TotalClientsStartOfmonth,TotalClientsAsonDate,

		Tradedclients,ClientNotTradedForMonth,ClientNotTradedAsOnDate,AvgTradedclients,OnlineBrok,OfflineBrok,Brokerage,

		DailyTradedClients,AvgDailyActRatio,AvgRevPerClient,ActivationRatio,Productivity, OnlineTurnover,OfflineTurnover,Turnover,

		OnlineNetRevnue,OfflineNetRevnue,NetRevnue,DailyTradeDays,DailyTradedClients_AR)

		select Branch_cd,Emp_No,TotalClientsStartOfmonth=0,TotalClientsAsonDate=0,

		Tradedclients=0,ClientNotTradedForMonth=0,ClientNotTradedAsOnDate=0,AvgTradedclients=0,OnlineBrok=0,OfflineBrok=0,Brokerage=0,

		DailyTradedClients=0,AvgDailyActRatio='0.00',AvgRevPerClient=0,ActivationRatio='0.00',Productivity='NA',

		OnlineTurnover=0,OfflineTurnover=0,Turnover=0,

		OnlineNetRevnue=0,OfflineNetRevnue=0,NetRevnue=0,DailyTradeDays=0,DailyTradedClients_AR=0

		from #PartyDetails		

		group by Branch_cd,Emp_No		

print '1.2:'+convert(varchar,getdate(),109)

----------------------------------------Update Start Of Month Total Clients----------------------------------

		update #MIStable set TotalClientsStartOfmonth=A.TotalClientsStartOfmonth

		from

		(select ps.Branch_cd,ps.Emp_No,TotalClientsStartOfmonth=COUNT(distinct ps.Party_Code)	

		from #PartyDetails ps 

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

print '2:'+convert(varchar,getdate(),109)

-------------------------------------------------------UPDATE BROKERAGE------------------------------------------------

		

--

print '3.1 '+convert(varchar,getdate(),109)

--

update #MIStable set OnlineBrok=A.OnlineBrok,OfflineBrok=A.OfflineBrok,Brokerage=A.GrossBrok,Tradedclients=A.Tradedclients,

DailyTradedClients=A.DailyTradedClients,DailyTradeDays=A.DailyTradeDays,

AvgTradedclients=(case when @TradeDays>0 then (A.DailyTradedClients/@TradeDays) else 0 end),

AvgDailyActRatio=(case when TotalClientsStartOfmonth>0 and @TradeDays>0 then CONVERT(decimal(15,2),((A.DailyTradedClients/@TradeDays)/TotalClientsStartOfmonth*100)) else 0 end),

AvgRevPerClient= (case when @TradeDays>0 then A.NetRevnue/@TradeDays else 0 end ),

--(case when A.DailyTradedClients>0 then ((A.GrossBrok/A.DailyTradedClients)) else 0 end),

--ActivationRatio=(case when TotalClientsStartOfmonth>0 then CONVERT(decimal(15,2),((A.Tradedclients/cast(TotalClientsStartOfmonth as money))*100)) else 0.00 end),

 OnlineTurnover =A.OnlineTurnover, OfflineTurnover =A.OfflineTurnover, Turnover =A.Turnover,

 OnlineNetRevnue =A.OnlineNetRevnue, OfflineNetRevnue =A.OfflineNetRevnue, NetRevnue =A.NetRevnue

--CONVERT(decimal(15,2),

		from 

		(

		select b.Branch_cd,b.Emp_No,GrossBrok = sum(GrossRevenue),   

        OnlineBrok = sum(GrossRevenue_Online), OfflineBrok = sum(GrossRevenue_Offline) ,Tradedclients=COUNT(distinct b.Party_Code),

        DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date),

        OnlineTurnover =sum(Online_TurnOver), OfflineTurnover =sum(Offline_TurnOver), Turnover =sum(TotalTurnover),

 OnlineNetRevnue =sum(NetRevenue_Online), OfflineNetRevnue =sum(NetRevenue_Offline), NetRevnue =sum(NetRevenue)

  

		from #BrokTurnOver b

		group by b.Branch_cd,b.Emp_No

		)A,	#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

----------------------Update NA-----------------------------

--update #MIStable

----set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)



--Comment by sandip

--update #MIStable set ActivationRatio='NA'		

--where TotalClientsStartOfmonth<Tradedclients

update #MIStable set AvgDailyActRatio='NA'		

where TotalClientsStartOfmonth<AvgTradedclients

-----------------------------------------------Activation Ratio---------------------

select Branch_cd,Emp_no,RegClients=cast(sum(RegClients) as money)--,TradeDays=cast(count(distinct sauda_date) as money) 

	into #RegActiveClients

	from (select sauda_date,Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by Sauda_date,Branch_cd,Emp_no)A 

	group by Branch_cd,Emp_no

	--order by 1

	--select * from #RegActiveClients

--Activation main page



--update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients/A.RegClients)*100--/DailyTradeDays

--else 0.00 end)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--

--



update #MIStable set 

DailyTradedClients_AR=A.DailyTradedClients

from 

(select b.Branch_cd,b.Emp_No,

 DailyTradedClients=COUNT(distinct convert(varchar,b.Sauda_date)+b.Party_Code),DailyTradeDays=COUNT(distinct b.Sauda_date)

 

 	from #BrokTurnOver b,TABLE_DATE TD with(nolock)

		where TD.CMTradingDay='Y'

		and LEFT(b.Sauda_date,11)=LEFT(TD.Sauda_date,11)

	group by b.Branch_cd,b.Emp_No

)A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No		





--select @DailyTradedClients_AR		

update #MIStable set ActivationRatio=(case when A.RegClients>0 and DailyTradeDays>0 then (DailyTradedClients_AR/A.RegClients)*100--/DailyTradeDays

else 0.00 end)

from #RegActiveClients A,	#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No--



--select DailyTradedClients_AR,DailyTradeDays from #MIStable



update #MIStable

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (Brokerage / (round(AvgTradedclients, 2,0) * @TradeDays)) else 0.00 end)

--set AvgRevPerClient = (case when DailyTradedClients > 0 then (NetRevnue / DailyTradedClients) else 0.00 end)

set AvgRevPerClient = (case when DailyTradedClients_AR > 0 then (NetRevnue / DailyTradedClients_AR) else 0.00 end)





---------------------------------------------------------Update AS ON CLIENTS----------------------------------

print '3.2:'+convert(varchar,getdate(),109)

if @FromDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11) and @ToDate>=left(DateAdd(Day, 1, GETDATE() - Day(GETDATE()) ),11)

begin

		update #MIStable set TotalClientsAsonDate=A.TotalClientsAsonDate

		from 

		(

		select ps.Branch_cd,ps.Emp_No,TotalClientsAsonDate=COUNT(distinct ps.Party_Code)

		from #PartyDetails ps

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate		

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

		where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

		--------------------------------Calculate Productivity--------------------------------------------------------------

		if @Wise='DEALER'

		begin

			Declare @Act_Days int,@H_days int

			set @Act_Days = (dbo.GetWorkingDays(@FromDate,@ToDate))                              

			set @H_days = ( select  count(distinct holidaydate)  from [MIMANSA].crm.dbo.Tbl_Exchange_Holidays with (nolock)                                                       

						where holidaydate >= @FromDate and holidaydate <= @ToDate )   

			print @TradeDays

			print @Act_Days

			print @H_days

			--if(@SegmentType='Currency')

			--begin

				--Fetch Emploee with CTC			

				

				select distinct EMP_NO, Brokerage = cast(0 as money), ah.CTC, HOD='',

				RMFlag=cast((case when ah.isDealer='1' and ah.isAdmin='0' then 'DEALER' else '' end )as varchar(10))

				into #ProdForCurr from B2B_AngelHarmony ah with(nolock)

				where --DepartMent='Currency' and Sub_department in('Offline Dealing','Relationship Management') and

				 ah.Status='A' and EMP_NO in (select EMP_NO from #MIStable)				

				

		

				--Update productivity for Employee

				print 'productivity'

				print @TradeDays

				print (@Act_Days-@H_days)

				update #MIStable set 

				Productivity=(case when (@Act_Days-@H_days)>0 and (ah.CTC)*@TradeDays>0  

								then convert(varchar,convert(decimal(10,2),(mis.Brokerage / ((ah.CTC)*@TradeDays/(@Act_Days-@H_days))))) 

								else '0.00' end)

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='DEALER'

				

				

				/*--Print for testing

				select * from #ProdForCurr

				--Print RM

				select ah.EMP_NO,CTC=isnull((select SUM(CTC) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.CTC,

				Brokerage=isnull((select SUM(Brokerage) from #ProdForCurr where HOD=ah.EMP_NO),0)+ah.Brokerage

				from #MIStable mis,#ProdForCurr ah

				where mis.Emp_No=ah.EMP_NO and ah.RMFlag='RM'

				*/

			--End		

			

		end

		--------------------------------End Calculate Productivity--------------------------------------------------------------

end

----------------------------UPDATE NOT TRADED CLIENTS------------------------------------------------

print '4:'+convert(varchar,getdate(),109)

--

		select ps.Party_Code,ps.Branch_cd,ps.Emp_No into #nottraded

		from #PartyDetails ps

		where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

		and ps.FirstTrade<=@ToDate

		--Delete traded clients

		delete from #nottraded where Party_Code in(select Party_Code from #BrokTurnOver)

--	

print '4.1:'+convert(varchar,getdate(),109)

		update #MIStable set ClientNotTradedForMonth=A.ClientNotTradedForMonth

		from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedForMonth=COUNT(distinct ps.Party_Code)

		from #nottraded ps

		group by ps.Branch_cd,ps.Emp_No

		)A,#MIStable B

			where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No 

--

drop table #nottraded

--

print '5:'+convert(varchar,getdate(),109)

		

			update #MIStable set ClientNotTradedAsOnDate=A.ClientNotTradedAsOnDate

			from ( select ps.Branch_cd,ps.Emp_No,ClientNotTradedAsOnDate=COUNT(distinct ps.Party_Code)

			from #PartyDetails ps

			where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate	

			and ps.FirstTrade>@ToDate

			group by ps.Branch_cd,ps.Emp_No

			)A,#MIStable B

				where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	

--

print '6:'+convert(varchar,getdate(),109)

---------------------------------Update Client Visit Pending-------------------------

/*update #MIStable set ClientVisitPending=A.CVPcount

from (select ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No,CVPcount=count(distinct ps.Party_Code) from  #PartyDetails ps ,@ClinetVisitPending cvp

where ps.Party_Code=cvp.Party_Code and cvp.Margin>=25000 group by ps.Zone,ps.Region,ps.Branch_cd,ps.Emp_No

)A,#MIStable B

where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No	and A.zone=B.Zone and A.Region=B.Region

print '7:'+convert(varchar,getdate(),109)*/

------------------------------DROP #PartyDetails---

drop table #PartyDetails

------------------------------DISPLAY------------------------------------------------

print 'Wise: '

print @Wise

if @Wise='DEALER'

begin

		print 'DEALER'

		update #MIStable set Emp_Name=ah.EMP_NAME

					from #MIStable mis,B2B_AngelHarmony ah with(nolock)

					where mis.Emp_No=ah.EMP_NO

		update #MIStable set Emp_Name='UNDEFINED' where Emp_No='UNDEFINED'			

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2,3

end

else

begin

		print 'SUBBROKER'

		select SB=Branch_cd,Emp_No ,mis.Emp_Name,TotalClientsStartOfmonth,TotalClientsAsonDate,Tradedclients,

		OnlineTurnover=CONVERT(decimal(15,2),OnlineTurnover),OfflineTurnover=CONVERT(decimal(15,2),OfflineTurnover),

		OnlineBrok=CONVERT(decimal(15,2),OnlineBrok),OfflineBrok=CONVERT(decimal(15,2),OfflineBrok),

		OnlineNetRevnue=CONVERT(decimal(15,2),OnlineNetRevnue),OfflineNetRevnue=CONVERT(decimal(15,2),OfflineNetRevnue),

		NetBrokeToSb=CONVERT(decimal(15,2),OnlineNetRevnue+OfflineNetRevnue),

		Productivity,

		--DailyTradedClients_AR=convert(decimal(10,2),DailyTradedClients_AR/@TradeDays),

		DailyTradedClients_AR=case when DailyTradedClients_AR > 0 then convert(decimal(10,0),ROUND(DailyTradedClients_AR/@TradeDays,0)) else 0 end,

		ActivationRatio=CONVERT(decimal(15,2),ActivationRatio),

		AvgRevPerClient=CONVERT(decimal(15,2),AvgRevPerClient),ClientNotTradedForMonth,ClientNotTradedAsOnDate

		from #MIStable mis

		order by 1,2

end

--TOTAL

--if @TotalFlag <> 'Y' 

if(isnull(@TotalFlag,'') in ('','N'))

begin



--select  

--TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

--Tradedclients=isnull(sum(Tradedclients),0),

--		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

--		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

--		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

--		else 0.00 end)),

--		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

--		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

--		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

--		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

--		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

--		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

--		DailyTradedClients_AR=isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0)

--from #RegActiveClients A,	#MIStable B

--where A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



select  

TotalClientsStartOfmonth=isnull(sum(TotalClientsStartOfmonth),0),TotalClientsAsonDate=isnull(sum(TotalClientsAsonDate),0),

Tradedclients=isnull(sum(Tradedclients),0),

		ActivationRatio=CONVERT(decimal(15,2),(case when sum(A.RegClients)>0 --and DailyTradeDays>0 

		--then (sum(DailyTradedClients)/sum(A.RegClients))*100--/DailyTradeDays 

		then (sum(DailyTradedClients_AR)/sum(A.RegClients))*100--/DailyTradeDays 

		else 0.00 end)),

		OnlineTurnover=CONVERT(decimal(15,2),isnull(sum(OnlineTurnover),0)),OfflineTurnover=CONVERT(decimal(15,2),isnull(sum(OfflineTurnover),0)),

		OnlineBrok=CONVERT(decimal(15,2),isnull(sum(OnlineBrok),0)),OfflineBrok=CONVERT(decimal(15,2),isnull(sum(OfflineBrok),0)),

		OnlineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0)),OfflineNetRevnue=CONVERT(decimal(15,2),isnull(sum(OfflineNetRevnue),0)),

		NetBrokeToSb=CONVERT(decimal(15,2),isnull(sum(OnlineNetRevnue),0) + isnull(sum(OfflineNetRevnue),0)),

		ClientNotTradedForMonth=isnull(sum(ClientNotTradedForMonth),0),ClientNotTradedAsOnDate=isnull(sum(ClientNotTradedAsOnDate),0),

		--DailyTradedClients_AR=convert(decimal(10,2),isnull(sum(DailyTradedClients_AR)/@TradeDays,0))

		DailyTradedClients_AR=case when(@TradeDays>0 ) then isnull(round(sum(DailyTradedClients_AR)/@TradeDays,0),0) else 0 end

from #MIStable B left outer join  #RegActiveClients A 	on  A.Branch_cd=B.Branch_cd and A.Emp_No=B.Emp_No



--group by DailyTradeDays

print 'End:'+convert(varchar,getdate(),109)

end 



END

---------------------MAIN PAGE END---------------------------------------------------

---------------------DRILL PAGE START---------------------------------------------------

else if @ReportType='DRILL'

begin

---------------------Declare drill page-------------------------------------------------

create table  #drillPartyDetails (Branch_cd varchar(10),Party_Code varchar(10),Client_Name varchar(100),Emp_No varchar(10),

ClientGrade varchar(10),[Profile] varchar(15),Sub_Profile varchar(30),ActiveFrom varchar(30),

DealerCode varchar(10),TradingMode varchar(20),LedgerInfo money,PortfolioInfo money,PureRisk money,ProjectedRisk money,

LastTradeDate varchar(30),RowColor varchar(10),LedgerColor varchar(10),TotalTo money, Mobile_Pager varchar(40))



--GrossBrok money,OnlineBrok money,OfflineBrok money,Sauda_date smalldatetime)

--

if @DrillFlag='TotalAsOn'

begin

print 'Drill 1:'+convert(varchar,getdate(),109)



	   

		--select * from @rto_Data

			

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@ToDate

		and ps.ToDate>=@ToDate				



print 'Drill 1.1: Complition'+convert(varchar,getdate(),109)

		

		if(@UserStatusId='SBDEALER')

		begin

			declare @rto_Data table

			(

			Zone varchar(20),

			Region varchar(20),

			branch_cd varchar(20),

			sub_broker varchar(20),

			Sub_brokerName varchar(200),

			party_code varchar(20),

			Short_name varchar(100),

			TotalTO money,

			OPTNoOfLots money,

			NoOfLotsGold bigint,

			NoOfLotsSilver bigint,

			NoOfLotsCopper bigint  ,

			NoOfLotsCrude bigint,

			NoOfLotsComm bigint,

			TargetNoOfLotsGold bigint,

			TargetNoOfLotsSilver bigint,

			TargetNoOfLotsCopper bigint,

			TargetNoOfLotsCrude bigint



			)	

			

			insert into @rto_Data

			--exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_newfo] 

			exec [MIMANSA].CRM.dbo.[GetTurnoverfortime_new] 

			@Emp_no=@UserEmp_No,

			@Zone='',

			@Region='',

			@Branch='',

			@Exec=@Dealer,

			@FromTime='09:00 AM',

			@ToTime='11:59 PM',

			@MainDrill='DRILL',

			@WiseReport='SBDEALER',

			@seg='ALL',

			@B2CStatus='B2B',

			@MimStatusID='SBDEALER',

			@SB='',

			@RoundValue='1',

			@DownloadCSVFlag='Y'



			

			update #drillPartyDetails set TotalTo=rto.TotalTo

			from #drillPartyDetails drill, @rto_Data rto

			where drill.Party_Code=rto.party_code	

		end

		

			

		--

end

else if @DrillFlag='TotalStartOfMonth'

begin

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps left outer join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		where ps.FromDate<=@FromDate

		and ps.ToDate>=@FromDate	

end

else if @DrillFlag='NotTradedAsOn'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate			

				and ps.FirstTrade>@ToDate	

end

else if @DrillFlag='NotTradedForMonth'

begin

				insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

				DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate,Mobile_Pager)

				select ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,ps.Emp_No,ac1.AngelClRating,

				[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

				TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

				LastTradeDate=left(ac1.LastTrade,11), Mobile_Pager=isnull(ac1.Mobile_Pager,'N.A.')

				from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

				left outer join tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

				where ps.FromDate<=@ToDate and ps.ToDate>=@ToDate				

				and ps.FirstTrade<=@ToDate		

		--

		delete from #drillPartyDetails where Party_Code in(select Party_Code from #BrokTurnOver)	

		--

end

else if @DrillFlag='Traded'

begin

		--Insert Traded Clients

		insert into #drillPartyDetails(Branch_cd,Party_Code,Client_Name,ps.Emp_No,ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerCode,TradingMode,PureRisk,ProjectedRisk,LastTradeDate)

		select distinct ps.Branch_cd,ps.Party_Code,Client_Name=ac1.Long_Name,Emp_No='',ac1.AngelClRating,

		[Profile]=isnull(pro.[Profile],'NA'),Sub_Profile=isnull(pro.Sub_Profile,'NA'),ActiveFrom=left(ac1.ActiveFrom,11),DealerCode='',

		TradingMode=(case when ac1.EbrokingClient='Y' then 'ONLINE' else 'OFFLINE' end),ac1.PureRisk,ac1.ProjectedRisk,

		LastTradeDate=left(ac1.LastTrade,11)

		from #PartyDetails ps inner join angelclient1 ac1 with(nolock) on ps.Party_Code=ac1.Party_Code

		 inner join #BrokTurnOver br on ps.Party_Code=br.Party_Code

		left outer join  tbl_client_profileSubProfile pro with(nolock) on ps.Party_Code=pro.Party_Code

		

		

end

else if @DrillFlag='BROK'

begin		

		Declare @emp_name varchar(100)		

		set @emp_name=isnull((select emp_name from B2B_AngelHarmony with(nolock) where EMP_NO=@Dealer),'')

		select ROW_NUMBER() OVER(ORDER BY br.Party_code) AS 'SrNo',SB=br.Branch_cd,Emp_No=@Dealer,Emp_Name=@emp_name,

		br.Party_Code,ac1.Long_Name,

		--Turnover =sum(TotalTurnover),

        OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 

		--GrossBrok = convert(decimal(20,2),sum(GrossRevenue)),   

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        --NetRevnue =sum(NetRevenue),

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Sauda_date)  

		from #BrokTurnOver br inner join angelclient1 ac1 ON br.Party_Code=ac1.Party_Code

		group by br.Branch_cd,br.Party_Code,ac1.Long_Name	

		

		--Total		

		select OnlineTurnover = convert(decimal(20,2),sum(Online_TurnOver)), OfflineTurnover =convert(decimal(20,2),sum(Offline_TurnOver)), 		  

        OnlineBrok = convert(decimal(20,2),sum(GrossRevenue_Online)), OfflineBrok = convert(decimal(20,2),sum(GrossRevenue_Offline)),        

        OnlineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Online)), OfflineNetRevnue =convert(decimal(20,2),sum(NetRevenue_Offline)),

        TotalTradedDays=count(distinct Party_Code+cast(Sauda_date as varchar)) from #BrokTurnOver

		return

end

else if @DrillFlag='ACTIVECLI'

begin		

	

	select A.sauda_date,A.Branch_cd,A.Emp_no,TotalClient=A.RegClients,Tradedclients=ISNULL(B.Tradedclients,0),

	[Activation]=(cast(ISNULL(B.Tradedclients,0) as money)/cast(A.RegClients as money))*100

	into #FinalActiveCli

	from (select sauda_date=left(sauda_date,11),Branch_cd,Emp_no ,RegClients=count(distinct party_code)

	from #PartyDetails ps,Table_Date TD with(nolock) 

	where TD.sauda_date>=@FromDate 

	and TD.sauda_date<=@ToDate

	and FromDate<=TD.sauda_date

	and ToDate>TD.sauda_date

	and TD.CmTradingDay = 'Y'        

	group by left(TD.Sauda_date,11),Branch_cd,Emp_no)A left outer join

	(  select Sauda_date=left(b.Sauda_date,11),b.Branch_cd,b.Emp_No,Tradedclients=COUNT(distinct b.Party_Code)

	 from #BrokTurnOver b

	group by left(b.Sauda_date,11),b.Branch_cd,b.Emp_No)B ON A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	--where --A.Sauda_date=B.Sauda_date and 	A.Branch_cd=B.Branch_cd and A.Emp_no=B.Emp_no

	order by 1,2,3

	--Display

	select * from #FinalActiveCli

	--Total Row

	select TotalClient=sum(TotalClient),Tradedclients=sum(Tradedclients),

	[Activation]=cast(sum(Tradedclients)as money)/cast(sum(TotalClient)as money)*100

	 from #FinalActiveCli

	

return

end

---------------------Common Script for DRILL PAGE ---------------------------------------------------

	

print 'Drill 3:'+convert(varchar,getdate(),109)		

		-- Update Portfolio i.e. Holding value

		update #drillPartyDetails                                                             

		set PortfolioInfo=isnull(H.TotalHold,0)            

		from #drillPartyDetails ps inner join   holding_valuation H with(nolock)                                                         

		on ps.party_code = H.party_code 

print 'Drill 4:'+convert(varchar,getdate(),109)		

		--Update Ledger Value

		select ps.party_code,TotalLedger=isnull(L.TotalLedger,0) into #totalLedger

		from #drillPartyDetails ps left outer join  ledger_valuation L with(nolock)

		on ps.party_code = L.party_code 

		--

		update #drillPartyDetails                                                             

		set LedgerInfo=convert(decimal(15,2),L.TotalLedger)--,LedgerColor=(case when isnull(L.TotalLedger,0)<0 then 'Red' else 'Black' end)

		from #drillPartyDetails ps left outer join #totalLedger L

		on ps.party_code = L.party_code 

		--

		drop table #totalLedger		

print 'Drill 5:'+convert(varchar,getdate(),109)			

		--Update Current Dealer

		update #drillPartyDetails set DealerCode=cps.Emp_No			

		from B2B_CommonPartyServices cps with(nolock),#drillPartyDetails ps   --on  (ps.Party_Code =cps.Party_Code )

		where --cps.Segment_Type=@SegmentType and 

		/*EM.Segment_Type>=@SegmentTypeFrom and 	

		EM.Segment_Type<=@SegmentTypeTo and*/

		ps.Party_Code =cps.Party_Code and

		cps.Valid='Y' and cps.CommRank='1'

		--Set Row color as per BRS point 4.3.4 & 4.3.5

print 'Drill 6:'+convert(varchar,getdate(),109)	

		update #drillPartyDetails set RowColor=(case when @Dealer<>'' and DealerCode<>@Dealer then 'Red' when isnull(DealerCode,'')='' then 'Black' else 'Black' end)	

		,LedgerColor=(case when isnull(LedgerInfo,0)>0 then 'Red' else 'Blue' end)

		--,LastCommDateColor=(case when datediff(dd,LastCommunicationDate ,GETDATE())>30 and datediff(dd,LastTradeDate ,GETDATE())>30 then 'Red'

		--when datediff(dd,LastCommunicationDate ,GETDATE())>14 and datediff(dd,LastTradeDate ,GETDATE())>14 then 'Orange' else 'Blue' end)

		,LastTradeDate=(case when LastTradeDate > getdate() or LastTradeDate = '1990-01-01 00:00:00' then 'Not Traded' else LastTradeDate end)

		--		

print 'Drill End:'+convert(varchar,getdate(),109)		

		select ROW_NUMBER() OVER(ORDER BY Party_code) AS 'SrNo',

		SB=Branch_cd,Party_Code,Client_Name,Emp_No,

		Mobile_Pager=ISNULL(Mobile_Pager,'N.A.'),

		ClientGrade,[Profile],Sub_Profile,ActiveFrom,

		DealerName=(select Emp_Name from B2B_AngelHarmony with(nolock) where emp_no=s.DealerCode)

		,TradingMode,LedgerInfo=convert(decimal(15,2),LedgerInfo),PortfolioInfo=convert(decimal(15,2),isnull(PortfolioInfo,0)),

		PureRisk=convert(decimal(15,2),PureRisk),

		ProjectedRisk=convert(decimal(15,2),ProjectedRisk),LastTradeDate,RowColor,LedgerColor,

		TotalTo=ISNULL(Cast(TotalTo as varchar),0.00)

		

		 from #drillPartyDetails s

		 order by SrNo

		 --Total

		 select LedgerInfo=convert(decimal(15,2),sum(LedgerInfo)),PortfolioInfo=convert(decimal(15,2),sum(isnull(PortfolioInfo,0))),

		 TotalTO=convert(decimal(15,2),sum(isnull(TotalTO,0)))

		  from #drillPartyDetails

-------------------

end

---------------------DRILL PAGE END---------------------------------------------------

END

---END SP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SMS_JOB_DEALER_MAPPING
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SMS_JOB_DEALER_MAPPING]          
(
@ForDate varchar(50)          
)
AS          
BEGIN     

--exec SMS_JOB_DEALER_MAPPING 'Mar 24 2012'
      
Declare @FromDate smalldatetime          
Declare @ToDate smalldatetime          
          
if @ForDate<>''           
begin           
 --          
 declare @dd datetime          
 set @dd=@ForDate          
 set @FromDate=left(convert(varchar, @dd,109),11)          
 set @ToDate=left(convert(varchar, @dd,109),11)+' 23:59'          
 --          
end          
else          
begin          
 set @FromDate=left(getdate()-1,11)          
 set @ToDate=left(getdate()-1,11)+' 23:59'          
end          
          
select 
	distinct *,smsText=convert(varchar(500),'') 
into 
	#tempSMS           
from 
	TBL_B2B_CRMS_SMS_DEALER_MAPPING with(nolock)
where 
	entry_date>=@FromDate and 
	entry_date<=@ToDate and 
	party_mobile<>'NA' and 
	smsFlag='0' 
order by 2 

       

--Keep Last mapping and Delete Duplicate mapping Rows 
select party_code,auto_id=Max(auto_id) into #delDuplicate
from #tempSMS 
group by party_code

--
delete from #tempSMS where auto_id not in(select auto_id from #delDuplicate)
--

--1--Prepare sms text for EQ clients          
update 
	#tempSMS           
set 
	smsText='Dear '+party_code+', your new dealer is '+DealerName+', contact detail is '+DealerContact+'. '+sub_broker_name+'.'          
where 
	party_code not in(select party_code from #tempSMS group by party_code having COUNT(party_code)>1)



          
          
  
/*        
INSERT INTO [GENERAL].[dbo].[Tbl_Log_SMSFeedback]                
      ([Party_code],[SenderId],[Mobile_no],[Message],[MessageType],[TransmissionTime],[Status],[Vendor],[FromDate] ,[ToDate],[BLOCKEDSMS]                
      ,[ServiceName],[RequestDate],[Region] ,[Area] ,[Branch],[rpt_status],[MessageID] ,[SMSFrom],[Zone])                
               
   select '','CRMS',party_mobile,smsText,'CRMS',getdate(),'Y','SMSGATEWAY',GETDATE(),GETDATE() ,'N'               
  ,'CRMS',GETDATE(),'','','','N',NEWID(),'MIMANSA',''              
from #finalSMS          
           
          
            
  INSERT INTO [GENERAL].[dbo].[tbl_smsTransactions_deadqueue]                  
       ([SentFrom],[ServiceName],[MobileNo],[Message],[DeliveryAckRequired],[TransmissionTime],[SMSSentStatus],[TokenID])              
                  
   select 'MIMANSA','CRMS',party_mobile,smsText,'N',getdate(),'N',NEWID()                 
from #finalSMS    3
*/      
          
--          
--return          
--          
          
update TBL_B2B_CRMS_SMS_DEALER_MAPPING 
set smsFlag='1'      ,
updatingdatetime =getdate()
    
from TBL_B2B_CRMS_SMS_DEALER_MAPPING 
where 
entry_date>=@FromDate and 
entry_date<=@ToDate and 
party_mobile<>'NA' and
smsFlag='0'          
--          
          
          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_auto_complete_extender_for_client
-- --------------------------------------------------
CREATE procedure [dbo].[sp_auto_complete_extender_for_client]
(
	@UserEmp_No varchar(20),
	@StatusId varchar(10),--SUBBROKER/SBDEALER
	@StatusName varchar(20),
	@sb_location varchar(10),
	@dealer varchar(20),
	@client varchar(10)
)
as
begin
--exec sp_auto_complete_extender_for_client @UserEmp_No='ET001',@StatusId='Et001',@StatusName='SUBBROKER',@sb_location='a1',@dealer='' 
--exec sp_auto_complete_extender_for_client @UserEmp_No='ET001',@StatusId='Eta001',@StatusName='SUBBROKER',@sb_location='Eta001',@dealer='et',@client='a12'

		declare  @temp_sbtag table
		(sbtag varchar(10))
		
		insert into @temp_sbtag
		SELECT sb_tag  
		FROM dbo.b2b_crms_mimansa_status(@UserEmp_No);  
		
		--select * from @temp_sbtag 
		
		if @StatusId = 'SBDEALER'     
		begin 
			select party_code from B2B_CommonPartyServices with(nolock),@temp_sbtag
			where branch_cd=sbtag and
			valid='Y' and
			emp_no like '%'+@UserEmp_No+'%' and
			party_code like '%'+ @client +'%'
		end
		else
		begin
			select party_code from B2B_CommonPartyServices with(nolock),@temp_sbtag
			where branch_cd=sbtag and
			valid='Y' and
			branch_cd like '%'+@sb_location+'%' and
			emp_no like '%'+@dealer+'%' and
			party_code like '%'+ @client +'%'
		end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_auto_complete_extender_for_client_details
-- --------------------------------------------------
CREATE procedure [dbo].[sp_auto_complete_extender_for_client_details]
(
	@UserEmp_No varchar(20),
	@StatusId varchar(10),--SUBBROKER/SBDEALER
	@StatusName varchar(20),--SUBBROKER/SBDEALER
	@sb_location varchar(10),
	@dealer varchar(20),
	@client varchar(10)
)
as
begin
/*
--exec sp_auto_complete_extender_for_client @UserEmp_No='ET001',@StatusId='Et001',@StatusName='SUBBROKER',@sb_location='',@dealer='',@client='AB' 
exec [sp_auto_complete_extender_for_client_details] 
@UserEmp_No='ca001',
@StatusId='ca001',
@StatusName='SUBBROKER',
@sb_location='',
@dealer='',
@client='a10'

*/

	declare @@UserEmp_No varchar(20)
	declare @@StatusId varchar(10)		
	declare @@StatusName varchar(20)
	declare @@sb_location varchar(10)
	declare @@dealer varchar(20)
	declare @@client varchar(10)
	
	set @@UserEmp_No=@UserEmp_No
	set @@StatusId=@StatusId
	set @@StatusName=@StatusName
	set @@sb_location=@sb_location
	set @@dealer=@dealer
	set	@@client=@client
	
	declare @@Form_sb_location varchar(10)
	declare @@To_sb_location varchar(10)
	declare @@Form_dealer varchar(20)
	declare @@TO_dealer varchar(20)
	declare @@Form_client varchar(10)
	declare @@To_client varchar(10)
	
	if(LEN(@@sb_location)=0)
	begin
		set @@Form_sb_location='AAAAA'
		set @@To_sb_location='ZZZZZZZZ'
	end
	else
	begin
		set @@Form_sb_location=@@sb_location
		set @@To_sb_location=@@sb_location--+'ZZZZZZZZ'
	end
	
	if(LEN(@@dealer)=0)
	begin
		set @@Form_dealer='AAAAA'
		set @@TO_dealer='ZZZZZZZZ'
	end
	else
	begin
		set @@Form_dealer=@@dealer
		set @@TO_dealer=@@dealer
	end
	
	if(LEN(@@client)=0)
	begin
		set @@Form_client='AAAAA'
		set @@To_client='ZZZZZZZZ'
	end
	else
	begin
		set @@Form_client=@@client
		set @@To_client=@@client+'ZZZZZZZZ'
	end
	
		declare  @temp_sbtag table
		(sbtag varchar(20))
		
		insert into @temp_sbtag
		SELECT sb_tag  
		FROM dbo.b2b_crms_mimansa_status(@@UserEmp_No);  
		
		--select * from @temp_sbtag 
		
		if @StatusId = 'SBDEALER'     
		begin 
			--select top 10 party_code=b1.party_code +'--'+ a1.short_name from B2B_CommonPartyServices b1 with(nolock),@temp_sbtag, angelclient1 a1 with(nolock)
			--where b1.branch_cd=sbtag and
			--valid='Y' and
			--emp_no like '%'+@UserEmp_No+'%' and
			----party_code like '%'+ @client +'%' and
			--b1.party_code=a1.party_code and
			--(b1.party_code like '%'+ @client +'%' or a1.short_name like '%'+ @client +'%' ) 
			
			select top 10 party_code=b1.party_code +'--'+ a1.short_name from B2B_CommonPartyServices b1 with(nolock),@temp_sbtag, angelclient1 a1 with(nolock)
			where b1.branch_cd=sbtag and
			valid='Y' and
			emp_no =@@UserEmp_No and
			--emp_no <=@@UserEmp_No and
			
			b1.party_code=a1.party_code and
			(
				b1.party_code >=@@Form_client and b1.party_code <=@@To_client
				or 
				a1.short_name >=@@Form_client and a1.short_name <=@@To_client
			)
			
			
		end
		else
		begin
					
			--select top 10 
			--	party_code=b1.party_code +'--'+ a1.short_name 
			--from B2B_CommonPartyServices b1 with(nolock),@temp_sbtag,angelclient1 a1 with(nolock)
			--where b1.branch_cd=sbtag and
			--b1.valid='Y' and
			--b1.branch_cd like '%'+@sb_location+'%' and
			--emp_no like '%'+@dealer+'%' and
			--b1.party_code=a1.party_code and
			--(b1.party_code like '%'+ @client +'%' or a1.short_name like '%'+ @client +'%' ) 
			
	
		
			select top 10 
				party_code=b1.party_code +'--'+ a1.short_name 
			from B2B_CommonPartyServices b1 with(nolock),@temp_sbtag,angelclient1 a1 with(nolock)
			where b1.branch_cd=sbtag and
			b1.valid='Y' and
			b1.branch_cd >=@@Form_sb_location and
			b1.branch_cd <=@@To_sb_location and
			emp_no >=@@Form_dealer and
			emp_no <=@@TO_dealer and
			b1.party_code=a1.party_code and
			(
				b1.party_code >=@@Form_client and b1.party_code <=@@To_client
				or 
				a1.short_name >=@@Form_client and a1.short_name <=@@To_client
			)
			
			
		end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_b2b_crms_mimansa_status
-- --------------------------------------------------
CREATE proc sp_b2b_crms_mimansa_status
@emp_no varchar(20)
As
begin
-- sp_b2b_crms_mimansa_status 'ET001'
SELECT *
FROM dbo.b2b_crms_mimansa_status(@emp_no);
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_B2B_Login
-- --------------------------------------------------
  
--Select * From tbl_AppLog where UserCode='ET001'  
  
CREATE Proc [dbo].[sp_B2B_Login]  
@EMPNO varchar(20),  
@Pwd varchar(50),  
@sessionid varchar(100)  
as  
Begin  
  

-- sp_B2B_Login  @EMPNO='GDS001', @Pwd='VIHAT999',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  
-- sp_B2B_Login  @EMPNO='GDS002', @Pwd='vihat999',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  
-- sp_B2B_Login  @EMPNO='PFE001', @Pwd='JINDALSTEL532286',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  

  
  
	Declare @Isvalid varchar(10),
			@RowCount1 int,
			@SelfCertification_DSC varchar(5) = 'No'

	set @RowCount1=0  
  
	select @RowCount1=Count(emp_no) from tbl_AppLog with(nolock)   
	where [Description] = 'Blocked Login'  
	and UserCode = @EMPNO  
	and logDateTime > DATEADD(MINUTE, -120, GETDATE())  
  
   
	if @RowCount1> 0  
	begin   

		select @Isvalid='BLOCKED'  
		Select @Isvalid  as Isvalid  
		Return  

	end   
  
	select @RowCount1=count(*) from tbl_AppLog with(nolock)   
	where [Description] = 'FAILED LOGIN'  
	and logDateTime > DATEADD(MINUTE, -10, GETDATE())  
	and sessionid = @sessionid  
   
	--if @RowCount1>= 3  
	--begin   
		-- select @Isvalid='NOTALLOWED'  
		-- Select @Isvalid  as Isvalid  
		-- Return  
	--end   
  
	If exists(select *  From b2b_angelharmony with(nolock) where Status in('A','S') and emp_no=@EMPNO and emp_pass=@Pwd)  
	begin  
  
		set  @Isvalid='VALID'  
		select @Isvalid as Isvalid 
		 
		exec getEmpStatus @EMP_No= @EMPNO  

		IF NOT EXISTS (select C.SBTag From b2b_angelharmony H with(nolock) ,Mimansa.dbo.tbl_B2B_CRMS_SelfCertification_DSC_List C with(nolock)
			where H.emp_no = @EMPNO and H.Sb_Tag = C.SBTag)
		BEGIN
			SET @SelfCertification_DSC = 'Yes'
		END
		ELSE IF EXISTS (select C.Sub_Broker From b2b_angelharmony H with(nolock) ,Mimansa.dbo.tbl_B2B_CRMS_SelfCertification_DSC C with(nolock)
					where H.emp_no = @EMPNO and H.Sb_Tag = C.Sub_Broker)
		BEGIN
			SET @SelfCertification_DSC = 'Yes'
		END

		Select SelfCertification_DSC = @SelfCertification_DSC

		return  

	end  
	else  
	Begin  
  
		set @Isvalid='NOTVALID'  
  
	End  
  
	Select @Isvalid  as Isvalid  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_B2B_Login_ADTest
-- --------------------------------------------------
  
--Select * From tbl_AppLog where UserCode='ET001'  
  
CREATE Proc [dbo].[sp_B2B_Login_ADTest]  
@EMPNO varchar(20),  
@Pwd varchar(50),  
@sessionid varchar(100)  
as  
Begin  
  

-- sp_B2B_Login  @EMPNO='GDS001', @Pwd='VIHAT999',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  
-- sp_B2B_Login  @EMPNO='GDS002', @Pwd='vihat999',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  
-- sp_B2B_Login  @EMPNO='PFE001', @Pwd='JINDALSTEL532286',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  

  
  
	Declare @Isvalid varchar(10),
			@RowCount1 int,
			@SelfCertification_DSC varchar(5) = 'No'

	set @RowCount1=0  
  
	select @RowCount1=Count(emp_no) from tbl_AppLog with(nolock)   
	where [Description] = 'Blocked Login'  
	and UserCode = @EMPNO  
	and logDateTime > DATEADD(MINUTE, -120, GETDATE())  
  
   
	if @RowCount1> 0  
	begin   

		select @Isvalid='BLOCKED'  
		Select @Isvalid  as Isvalid  
		Return  

	end   
  
	select @RowCount1=count(*) from tbl_AppLog with(nolock)   
	where [Description] = 'FAILED LOGIN'  
	and logDateTime > DATEADD(MINUTE, -10, GETDATE())  
	and sessionid = @sessionid  
   
	--if @RowCount1>= 3  
	--begin   
		-- select @Isvalid='NOTALLOWED'  
		-- Select @Isvalid  as Isvalid  
		-- Return  
	--end   
  
	If exists(select *  From b2b_angelharmony with(nolock) where Status in('A','S') and emp_no=@EMPNO and emp_pass=@Pwd)  
	begin  
  
		set  @Isvalid='VALID'  
		select @Isvalid as Isvalid 
		 
		exec getEmpStatus @EMP_No= @EMPNO  

		IF NOT EXISTS (select C.SBTag From b2b_angelharmony H with(nolock) ,Mimansa.dbo.tbl_B2B_CRMS_SelfCertification_DSC_List C with(nolock)
			where H.emp_no = @EMPNO and H.Sb_Tag = C.SBTag)
		BEGIN
			SET @SelfCertification_DSC = 'Yes'
		END
		ELSE IF EXISTS (select C.Sub_Broker From b2b_angelharmony H with(nolock) ,Mimansa.dbo.tbl_B2B_CRMS_SelfCertification_DSC C with(nolock)
					where H.emp_no = @EMPNO and H.Sb_Tag = C.Sub_Broker)
		BEGIN
			SET @SelfCertification_DSC = 'Yes'
		END

		Select SelfCertification_DSC = @SelfCertification_DSC

		return  

	end  
	else  
	Begin  
  
		set @Isvalid='NOTVALID'  
  
	End  
  
	Select @Isvalid  as Isvalid  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_B2B_Login_bak
-- --------------------------------------------------


--Select top 10 * From b2b_angelharmony where emp_no='ET001'


CREATE Proc [dbo].[sp_B2B_Login_bak]
@EMPNO varchar(20),
@Pwd varchar(20)
as
Begin

Declare @Isvalid varchar(10)

	

If exists(select *  From b2b_angelharmony with(nolock) where Status in('A','S') and ltrim(rtrim(emp_no))=ltrim(rtrim(@EMPNO)) and ltrim(rtrim(emp_pass))=ltrim(rtrim(@Pwd)))
		begin

		set  @Isvalid='VALID'

		end
	else
	Begin

	set	@Isvalid='NOTVALID'

	End

Select @Isvalid  as Isvalid

--print 'aaa'

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_B2B_Login_bkp11Sep2017
-- --------------------------------------------------
  
  
--Select * From tbl_AppLog where UserCode='ET001'  
  
  
CREATE Proc [dbo].[sp_B2B_Login]  
@EMPNO varchar(20),  
@Pwd varchar(50),  
@sessionid varchar(100)  
as  
Begin  
  
--sp_B2B_Login_bak  @EMPNO='CA001', @Pwd='ca001',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  
--sp_B2B_Login  @EMPNO='ET001', @Pwd='et000001',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  
--sp_B2B_Login  @EMPNO='ETA002', @Pwd='eta002',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  
  
  
Declare @Isvalid varchar(10)  
  
Declare @RowCount1 int  
set @RowCount1=0  
  
select @RowCount1=Count(emp_no) from tbl_AppLog with(nolock)   
where   
  Description='Blocked Login'  
  and UserCode=@EMPNO  
 and logDateTime> DATEADD(MINUTE, -120, GETDATE())  
  
   
if @RowCount1> 0  
 begin   
 select @Isvalid='BLOCKED'  
 Select @Isvalid  as Isvalid  
 Return  
end   
  
select @RowCount1=count(*) from tbl_AppLog with(nolock)   
where   
 Description='FAILED LOGIN'  
 and logDateTime> DATEADD(MINUTE, -10, GETDATE())  
 and sessionid=@sessionid  
   
-- if @RowCount1>= 3  
-- begin   
-- select @Isvalid='NOTALLOWED'  
-- Select @Isvalid  as Isvalid  
-- Return  
--end   
  
If exists(select *  From b2b_angelharmony with(nolock) where Status in('A','S') and emp_no=@EMPNO and emp_pass=@Pwd)  
  begin  
  
  set  @Isvalid='VALID'  
  select @Isvalid as Isvalid  
   exec getEmpStatus @EMP_No= @EMPNO  
  return  
  end  
 else  
 Begin  
  
 set @Isvalid='NOTVALID'  
  
 End  
  
Select @Isvalid  as Isvalid  
  
--print 'aaa'  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_B2B_Login_bkp14SEP2017
-- --------------------------------------------------
  
--Select * From tbl_AppLog where UserCode='ET001'  
  
CREATE Proc [dbo].[sp_B2B_Login_ADTest]  
@EMPNO varchar(20),  
@Pwd varchar(50),  
@sessionid varchar(100)  
as  
Begin  
  
--sp_B2B_Login_bak  @EMPNO='GDS001', @Pwd='VIHAT999',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  
-- sp_B2B_Login  @EMPNO='GDS001', @Pwd='VIHAT999',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  
--sp_B2B_Login  @EMPNO='ETA002', @Pwd='eta002',@sessionid='nc4uemca4zpfwfmygbxi3nvu'  
  
  
	Declare @Isvalid varchar(10),
			@RowCount1 int,
			@SelfCertification_DSC varchar(5) = 'No'

	set @RowCount1=0  
  
	select @RowCount1=Count(emp_no) from tbl_AppLog with(nolock)   
	where [Description] = 'Blocked Login'  
	and UserCode = @EMPNO  
	and logDateTime > DATEADD(MINUTE, -120, GETDATE())  
  
   
	if @RowCount1> 0  
	begin   

		select @Isvalid='BLOCKED'  
		Select @Isvalid  as Isvalid  
		Return  

	end   
  
	select @RowCount1=count(*) from tbl_AppLog with(nolock)   
	where [Description] = 'FAILED LOGIN'  
	and logDateTime > DATEADD(MINUTE, -10, GETDATE())  
	and sessionid = @sessionid  
   
	--if @RowCount1>= 3  
	--begin   
		-- select @Isvalid='NOTALLOWED'  
		-- Select @Isvalid  as Isvalid  
		-- Return  
	--end   
  
	If exists(select *  From b2b_angelharmony with(nolock) where Status in('A','S') and emp_no=@EMPNO and emp_pass=@Pwd)  
	begin  
  
		set  @Isvalid='VALID'  
		select @Isvalid as Isvalid 
		 
		exec getEmpStatus @EMP_No= @EMPNO  

		IF EXISTS (select C.Sub_Broker From b2b_angelharmony H with(nolock) ,Mimansa.dbo.tbl_B2B_CRMS_SelfCertification_DSC C with(nolock)
					where H.emp_no = @EMPNO and H.Sb_Tag = C.Sub_Broker)
		BEGIN
			SET @SelfCertification_DSC = 'Yes'
		END

		Select SelfCertification_DSC = @SelfCertification_DSC

		return  

	end  
	else  
	Begin  
  
		set @Isvalid='NOTVALID'  
  
	End  
  
	Select @Isvalid  as Isvalid  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_B2B_Login_vol1
-- --------------------------------------------------


--Select top 10 * From b2b_angelharmony where emp_no='ET001'


CREATE Proc [dbo].[sp_B2B_Login_vol1]
@EMPNO varchar(20),  --User Emp No
@Pwd varchar(20),
@sessionid varchar(100),
@LogType varchar(50), -- Authentication / Error / PageHit
@URL varchar(500) , -- Page URL
@IP varchar(50) , -- USER IP
@Emp_No varchar(20)=null,
@EmpSessionId varchar(60)=null ,
@EmpRole varchar(20)=null
 
as
Begin

--sp_B2B_Login_bak  @EMPNO='CA001', @Pwd='ca001',@sessionid='nc4uemca4zpfwfmygbxi3nvu'
--sp_B2B_Login  @EMPNO='ET001', @Pwd='et000001',@sessionid='nc4uemca4zpfwfmygbxi3nvu'
--sp_B2B_Login  @EMPNO='ETA002', @Pwd='eta002',@sessionid='nc4uemca4zpfwfmygbxi3nvu'
--sp_B2B_Login_vol1 @EMPNO='Et001', @Pwd='et000001',@sessionid='nc4uemca4zpfwfmygbxi3nvu',@LogType='Authentication',@URL='',@IP='196.1.115.212',@Emp_No =null,@EmpSessionId =null ,@EmpRole =null
--sp_B2B_Login_vol1 @EMPNO='ETA002', @Pwd='ETA002',@sessionid='nc4uemca4zpfwfmygbxi3nvu',@LogType='Authentication',@URL='',@IP='196.1.115.212',@Emp_No =null,@EmpSessionId =null ,@EmpRole =null


Declare @@EMPNO varchar(20)
Declare @@Pwd varchar(20)
Declare @@sessionid varchar(100)
Declare @@LogType varchar(50)
Declare @@URL varchar(500) 
Declare @@IP varchar(50) 
Declare @@Emp_No varchar(20)
Declare @@EmpSessionId varchar(60)
Declare @@EmpRole varchar(20)
Declare @@Description varchar(8000) 

set @@EMPNO =@EMPNO
set @@Pwd=@Pwd
set @@sessionid =@sessionid
set @@LogType =@LogType 
set @@URL =@URL 
set @@IP =@IP 
set @@Emp_No =@Emp_No 
set @@EmpSessionId =@EmpSessionId
set @@EmpRole=@EmpRole 
--set @@Description =@Description 

Declare @Isvalid varchar(10)

Declare @RowCount1 int
set @RowCount1=0

select @RowCount1=Count(emp_no) from tbl_AppLog with(nolock) 
where 
	 Description='Blocked Login'
	 and UserCode=@EMPNO
	and logDateTime> DATEADD(MINUTE, -120, GETDATE())

	
if @RowCount1> 0
 begin	
	select @Isvalid='BLOCKED'
	Select @Isvalid  as Isvalid
	Return
end	

select @RowCount1=count(*) from tbl_AppLog with(nolock) 
where 
	Description='FAILED LOGIN'
	and logDateTime> DATEADD(MINUTE, -10, GETDATE())
	and sessionid=@sessionid
 
 if @RowCount1>= 3
 begin	
	select @Isvalid='NOTALLOWED'
	exec sp_Insert_B2BCRMS_Log @UserCode=@@EMPNO,@LogType=@LogType, @URL=@@URL,@SessionId=@@sessionid, @IP=@@IP,@Emp_No='N.A.',@EmpSessionId='N.A.',@EmpRole='N.A.',@Description='Blocked Login'
	Select @Isvalid  as Isvalid
	Return
end	

If exists(select *  From b2b_angelharmony with(nolock) where Status in('A','S') and emp_no=@EMPNO and emp_pass=@Pwd)
		begin

		set  @Isvalid='VALID'
		select @Isvalid as Isvalid
		 exec sp_Insert_B2BCRMS_Log @UserCode=@@EMPNO,@LogType=@LogType, @URL=@@URL,@SessionId=@@sessionid, @IP=@@IP,@Emp_No='N.A.',@EmpSessionId='N.A.',@EmpRole='N.A.',@Description='Success Login'
		 exec getEmpStatus @EMP_No= @@EMPNO
		 declare @@StatusId varchar(20)
		 select @@StatusId=MimansaStatusid from angelusers with(nolock) where HarmonyEmployeeCode=@@EMPNO
		 exec b2b_crms_sb_location_auto_complete @UserEmp_No=@@EMPNO,@StatusId=@@StatusId, @search_location='', @request_type='MAIN'
		return
		end
	else
	Begin

	set	@Isvalid='NOTVALID'
		exec sp_Insert_B2BCRMS_Log @UserCode=@@EMPNO,@LogType=@LogType, @URL=@@URL,@SessionId=@@sessionid, @IP=@@IP,@Emp_No='N.A.',@EmpSessionId='N.A.',@EmpRole='N.A.',@Description='Failed Login'
	End

Select @Isvalid  as Isvalid

--print 'aaa'

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Client_Details
-- --------------------------------------------------
CREATE procedure [dbo].[SP_Client_Details]
(	
	@UserEmp_No varchar(20), 
	@StatusId varchar(10),                                                                                                                              
	@StatusName varchar(20),   
	@party_code varchar(10),
	@flag varchar(10)
)
as
begin
	
	--exec [SP_Client_Details] 'a10926',''
	
	declare @cl_row int
	declare @Dealer varchar(20)
	declare @DealerName varchar(50)
	
	select @Dealer=emp_no from B2B_CommonPartyServices with(nolock) where party_code=@party_code and valid='y'
	select @DealerName= emp_name from B2B_AngelHarmony with(nolock) where emp_no=@Dealer and isdealer=1
	
	
	
	select  party_code=Party_code,                                                      
		Short_Name = Long_Name,              
		Dealer=isnull(@DealerName,'N.A'),
		Service,                                            
		l_zip,                 
		Bank_Name,                                                   
		Branch_Cd,                                        
		AC_Type,                                                                             
		AC_Num ,                                                                       
		Address1 = L_Address1,                                                      
		Address2 = L_Address2,                                                      
		Address3 = L_Address3,                                                      
		City = L_City,                             
		State = L_State,                                                      
		Nation = L_Nation,                                                      
		Mobile = Mobile_Pager,                                
		Fax = Fax,                                                      
		Email = Email,                                                      
		phone1= Res_Phone1,                                                      
		phone2 =Res_Phone2,                                                      
		preferredPhone = '',--preferredPhone,                          
		Office1 = Off_Phone1,                                                      
		Office2 = Off_Phone2,                                                      
		preferredTime = '',                                                      
		zip = L_Zip,                                                    
		ECN = (case when ltrim(rtrim(ECN)) ='ECN' then ltrim(rtrim(ECN)) else 'Not-Subscribed' end),                                                  
		B2C = (case when B2C ='N' then 'NO' else 'YES' end),                        
		ActiveFromEq= (case when(convert( datetime, left( convert( varchar, ActiveFromEq, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),ActiveFromEq,109) end),      
		InactiveFromEq=(case when (convert( datetime, left( convert( varchar, InactiveFromEq, 109 ), 11 ) + ' 23:59:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') or (convert( datetime, left( convert( varchar, ActiveFromEq
		, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),InactiveFromEq,109) end),               
		ActiveFromComm=(case when(convert( datetime, left( convert( varchar, ActiveFromMcxNcx, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),ActiveFromMcxNcx,109) end), 
		InactiveFromComm=(case when (convert( datetime, left( convert( varchar, InactiveFromComm, 109 ), 11 ) + ' 23:59:00') >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00'))         
		or (convert( datetime, left( convert( varchar, activeFromComm, 109 ), 11 ) + ' 00:00:00') >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00')) then '_' else convert(varchar(11),InactiveFromComm,109) end),           
		B2CColor = (case when B2C='N' then 'red' else 'black' end),                                                                                       
		InactiveFromColor = (case when InactiveFromEq <= convert( datetime, left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00') or Inactivefrom is null then 'red' else 'black' end),                                            
		executive = ''                                   
		,ExecutiveName = '', 
		sub_broker,
		EbrokingClient = (case when isnull(EbrokingClient, '') = 'Y' then 'ONLINE' else 'OFFLINE' end), 
		panNo=isnull(pan_gir_no,''),
		angelclrating,
		lastTrade= case when lastTrade >= getdate()then '_' else convert(varchar(11),lastTrade,109) end,
		ActiveFromCurr= (case when(convert( datetime, left( convert( varchar, ActiveFromCurr, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),ActiveFromCurr,109) end),      
		InactiveFromCurr=(case when (convert( datetime, left( convert( varchar, InactiveFromCurr, 109 ), 11 ) + ' 23:59:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') or (convert( datetime, left( convert( varchar, InactiveFromCurr
		, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),InactiveFromCurr,109) end)                          
		 from 
			angelclient1 with(nolock)                       
			--risk.dbo.client_Details with(nolock)
		where party_code=@party_code
		
		
		
		
		
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Client_Details_New
-- --------------------------------------------------
Create procedure [dbo].[SP_Client_Details_New]
(	
	@party_code varchar(10),
	@flag varchar(10)
)
as
begin
	
	--exec [SP_Client_Details] 'a10926',''
	
	declare @cl_row int
	declare @Dealer varchar(10)
	declare @DealerName varchar(50)
	
	select @Dealer=emp_no from B2B_CommonPartyServices with(nolock) where party_code=@party_code and valid='y'
	select @DealerName= FirstName + ' ' + LastName from b2b_harmony with(nolock) where empCode=@Dealer
	
	
	
	select  party_code=Party_code,                                                      
		Short_Name = Long_Name,              
		Dealer=isnull(@DealerName,'N.A'),
		Service,                                            
		l_zip,                 
		Bank_Name,                                                   
		Branch_Cd,                                        
		AC_Type,                                                                             
		AC_Num ,                                                                       
		Address1 = L_Address1,                                                      
		Address2 = L_Address2,                                                      
		Address3 = L_Address3,                                                      
		City = L_City,                             
		State = L_State,                                                      
		Nation = L_Nation,                                                      
		Mobile = Mobile_Pager,                                
		Fax = Fax,                                                      
		Email = Email,                                                      
		phone1= Res_Phone1,                                                      
		phone2 =Res_Phone2,                                                      
		preferredPhone = '',--preferredPhone,                          
		Office1 = Off_Phone1,                                                      
		Office2 = Off_Phone2,                                                      
		preferredTime = '',                                                      
		zip = L_Zip,                                                    
		ECN = (case when ltrim(rtrim(ECN)) ='ECN' then ltrim(rtrim(ECN)) else 'Not-Subscribed' end),                                                  
		B2C = (case when B2C ='N' then 'NO' else 'YES' end),                        
		ActiveFromEq= (case when(convert( datetime, left( convert( varchar, ActiveFromEq, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),ActiveFromEq,109) end),      
		InactiveFromEq=(case when (convert( datetime, left( convert( varchar, InactiveFromEq, 109 ), 11 ) + ' 23:59:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') or (convert( datetime, left( convert( varchar, ActiveFromEq
		, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),InactiveFromEq,109) end),               
		ActiveFromComm=(case when(convert( datetime, left( convert( varchar, ActiveFromComm, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),ActiveFromComm,109) end), 
		InactiveFromComm=(case when (convert( datetime, left( convert( varchar, InactiveFromComm, 109 ), 11 ) + ' 23:59:00') >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00'))         
		or (convert( datetime, left( convert( varchar, activeFromComm, 109 ), 11 ) + ' 00:00:00') >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00')) then '_' else convert(varchar(11),InactiveFromComm,109) end),           
		B2CColor = (case when B2C='N' then 'red' else 'black' end),                                                                                       
		InactiveFromColor = (case when InactiveFromEq <= convert( datetime, left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00') or Inactivefrom is null then 'red' else 'black' end),                                            
		executive = ''                                   
		,ExecutiveName = '', 
		sub_broker,
		EbrokingClient = (case when isnull(EbrokingClient, '') = 'Y' then 'ONLINE' else 'OFFLINE' end), 
		panNo=isnull(pan_gir_no,''),
		angelclrating                          
		 from 
			angelclient1 with(nolock)                       
			--risk.dbo.client_Details with(nolock)
		where party_code=@party_code
		
		
		
		
		
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Client_Details_New22Mar
-- --------------------------------------------------
CREATE procedure [dbo].[SP_Client_Details_New22Mar]
(	
	@party_code varchar(10),
	@flag varchar(10)
)
as
begin
	
	--exec [SP_Client_Details] 'a10926',''
	
	declare @cl_row int
	declare @Dealer varchar(10)
	declare @DealerName varchar(50)
	
	select @Dealer=emp_no from B2B_CommonPartyServices with(nolock) where party_code=@party_code and valid='y'
	select @DealerName= First_Name + ' ' + Last_Name from B2B_AngelHarmony with(nolock) where Emp_No=@Dealer
	
	
	
	select  party_code=Party_code,                                                      
		Short_Name = Long_Name,              
		Dealer=isnull(@DealerName,'N.A'),
		Service,                                            
		l_zip,                 
		Bank_Name,                                                   
		Branch_Cd,                                        
		AC_Type,                                                                             
		AC_Num ,                                                                       
		Address1 = L_Address1,                                                      
		Address2 = L_Address2,                                                      
		Address3 = L_Address3,                                                      
		City = L_City,                             
		State = L_State,                                                      
		Nation = L_Nation,                                                      
		Mobile = Mobile_Pager,                                
		Fax = Fax,                                                      
		Email = Email,                                                      
		phone1= Res_Phone1,                                                      
		phone2 =Res_Phone2,                                                      
		preferredPhone = '',--preferredPhone,                          
		Office1 = Off_Phone1,                                                      
		Office2 = Off_Phone2,                                                      
		preferredTime = '',                                                      
		zip = L_Zip,                                                    
		ECN = (case when ltrim(rtrim(ECN)) ='ECN' then ltrim(rtrim(ECN)) else 'Not-Subscribed' end),                                                  
		B2C = (case when B2C ='N' then 'NO' else 'YES' end),                        
		ActiveFromEq= (case when(convert( datetime, left( convert( varchar, ActiveFromEq, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),ActiveFromEq,109) end),      
		InactiveFromEq=(case when (convert( datetime, left( convert( varchar, InactiveFromEq, 109 ), 11 ) + ' 23:59:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') or (convert( datetime, left( convert( varchar, ActiveFromEq
		, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),InactiveFromEq,109) end),               
		ActiveFromComm=(case when(convert( datetime, left( convert( varchar, ActiveFromComm, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),ActiveFromComm,109) end), 
		InactiveFromComm=(case when (convert( datetime, left( convert( varchar, InactiveFromComm, 109 ), 11 ) + ' 23:59:00') >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00'))         
		or (convert( datetime, left( convert( varchar, activeFromComm, 109 ), 11 ) + ' 00:00:00') >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00')) then '_' else convert(varchar(11),InactiveFromComm,109) end),           
		B2CColor = (case when B2C='N' then 'red' else 'black' end),                                                                                       
		InactiveFromColor = (case when InactiveFromEq <= convert( datetime, left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00') or Inactivefrom is null then 'red' else 'black' end),                                            
		executive = ''                                   
		,ExecutiveName = '', 
		sub_broker,
		EbrokingClient = (case when isnull(EbrokingClient, '') = 'Y' then 'ONLINE' else 'OFFLINE' end), 
		panNo=isnull(pan_gir_no,''),
		angelclrating                          
		 from 
			angelclient1 with(nolock)                       
			--risk.dbo.client_Details with(nolock)
		where party_code=@party_code
		
		
		
		
		
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Client_Details_New31March
-- --------------------------------------------------
CREATE procedure [dbo].[SP_Client_Details_New31March]
(	
	@party_code varchar(10),
	@flag varchar(10)
)
as
begin
	
	--exec [SP_Client_Details] 'a10926',''
	
	declare @cl_row int
	declare @Dealer varchar(10)
	declare @DealerName varchar(50)
	
	select @Dealer=emp_no from B2B_CommonPartyServices with(nolock) where party_code=@party_code and valid='y'
	select @DealerName= First_Name + ' ' + Last_Name from B2B_AngelHarmony with(nolock) where Emp_No=@Dealer
	
	
	
	select  party_code=Party_code,                                                      
		Short_Name = Long_Name,              
		Dealer=isnull(@DealerName,'N.A'),
		Service,                                            
		l_zip,                 
		Bank_Name,                                                   
		Branch_Cd,                                        
		AC_Type,                                                                             
		AC_Num ,                                                                       
		Address1 = L_Address1,                                                      
		Address2 = L_Address2,                                                      
		Address3 = L_Address3,                                                      
		City = L_City,                             
		State = L_State,                                                      
		Nation = L_Nation,                                                      
		Mobile = Mobile_Pager,                                
		Fax = Fax,                                                      
		Email = Email,                                                      
		phone1= Res_Phone1,                                                      
		phone2 =Res_Phone2,                                                      
		preferredPhone = '',--preferredPhone,                          
		Office1 = Off_Phone1,                                                      
		Office2 = Off_Phone2,                                                      
		preferredTime = '',                                                      
		zip = L_Zip,                                                    
		ECN = (case when ltrim(rtrim(ECN)) ='ECN' then ltrim(rtrim(ECN)) else 'Not-Subscribed' end),                                                  
		B2C = (case when B2C ='N' then 'NO' else 'YES' end),                        
		ActiveFromEq= (case when(convert( datetime, left( convert( varchar, ActiveFromEq, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),ActiveFromEq,109) end),      
		InactiveFromEq=(case when (convert( datetime, left( convert( varchar, InactiveFromEq, 109 ), 11 ) + ' 23:59:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') or (convert( datetime, left( convert( varchar, ActiveFromEq
		, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),InactiveFromEq,109) end),               
		ActiveFromComm=(case when(convert( datetime, left( convert( varchar, ActiveFromComm, 109 ), 11 ) + ' 00:00:00')) >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00') then'_' else convert(varchar(11),ActiveFromComm,109) end), 
		InactiveFromComm=(case when (convert( datetime, left( convert( varchar, InactiveFromComm, 109 ), 11 ) + ' 23:59:00') >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00'))         
		or (convert( datetime, left( convert( varchar, activeFromComm, 109 ), 11 ) + ' 00:00:00') >= convert(datetime, left( convert( varchar, getdate(), 109 ),11 ) + ' 23:59:00')) then '_' else convert(varchar(11),InactiveFromComm,109) end),           
		B2CColor = (case when B2C='N' then 'red' else 'black' end),                                                                                       
		InactiveFromColor = (case when InactiveFromEq <= convert( datetime, left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00') or Inactivefrom is null then 'red' else 'black' end),                                            
		executive = ''                                   
		,ExecutiveName = '', 
		sub_broker,
		EbrokingClient = (case when isnull(EbrokingClient, '') = 'Y' then 'ONLINE' else 'OFFLINE' end), 
		panNo=isnull(pan_gir_no,''),
		angelclrating                          
		 from 
			angelclient1 with(nolock)                       
			--risk.dbo.client_Details with(nolock)
		where party_code=@party_code
		
		
		
		
		
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_GetReportMenu
-- --------------------------------------------------
CREATE proc [dbo].[SP_GetReportMenu]  
(  
@Emp_NO varchar(20)  
)  
AS  
BEGIN  
 -- exec SP_GetReportMenu 'ET001'  
/*  
 select ReportName, ReportPath,ReportGroupName,ReportMenuName,ReportMenuGroup  
 from AngelBOMenu with(nolock) where HarmonyEmployeeCode=@Emp_NO  
 ORDER BY ReportMenuGroup,ReportGroupName,ReportName  
  
*/  
  
with bimenu(MenuID,Text, NavigateUrl,ParentID,ApplicationID,isFavourite,AngelBOMenuID,MenuType, ParentMenuApplicationID)  
as  
(  
SELECT MenuID,Text,NavigateUrl,ParentID,ApplicationID,isFavourite = cast('0' as varchar),AngelBOMenuID = cast('0' as bigint),   
MenuType, ParentMenuApplicationID  
 FROM tbl_BIMenu ,AngelBOMenu with(nolock) where   
text = reportname and navigateurl=reportpath and HarmonyEmployeeCode = @Emp_NO  
union all  
select b1.MenuID,b1.TExt, b1.NavigateUrl,b1.ParentID,b1.ApplicationID,isFavourite = cast('0' as varchar),   
AngelBOMenuID = cast('0' as bigint), b1.MenuType, b1.ParentMenuApplicationID  
 from tbl_BIMenu b1 inner join bimenu b2 on b2.parentid=b1.menuid   
)  
select * into #Temp from (  
select distinct MenuID,Text , NavigateUrl=(case when len(NavigateUrl)>0 then right(NavigateUrl,len(NavigateUrl)-1) else '' end),--Replace(NavigateUrl,'/',''),
ParentID,ApplicationID,isFavourite ,AngelBOMenuID , MenuType, ParentMenuApplicationID  
from bimenu )a  
  
update #Temp set AngelBOMenuID = a.AngelBOMenuID from AngelBOMenu a with(nolock)  
where #Temp.NavigateURL = a.ReportPath and #Temp.TExt = a.ReportName  and HarmonyEmployeeCode = @Emp_NO  
  
  
  
CREATE TABLE [dbo].[#Temp1](  
 [MenuID] [bigint] NULL,  
 [Text] [varchar](100) NULL,  
 [NavigateUrl] [varchar](max) NULL,  
 [ParentID] [bigint] NULL,  
 [ApplicationID] [bigint] NULL,  
 [isFavourite] [varchar](30) NULL,  
 [AngelBOMenuID] [bigint] NULL,  
 [MenuType] [varchar](20) NULL,  
 [ParentMenuApplicationID] [bigint] NULL  
) ON [PRIMARY]  
  
insert into [#Temp1]  
select * from #Temp where menutype = 'mimansaapplications' order by ParentMenuApplicationID  
  
insert into [#Temp1]  
select * from #Temp where menutype <> 'mimansaapplications' order by Text  
  
select * from  [#Temp1]   
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_GetReportMenu_bak
-- --------------------------------------------------

CREATE proc [dbo].[SP_GetReportMenu_bak]  
(  
@Emp_NO varchar(20)  
)  
AS  
BEGIN  
 -- exec SP_GetReportMenu_bak 'ET001'  
/*  
 select ReportName, ReportPath,ReportGroupName,ReportMenuName,ReportMenuGroup  
 from AngelBOMenu with(nolock) where HarmonyEmployeeCode=@Emp_NO  
 ORDER BY ReportMenuGroup,ReportGroupName,ReportName  
  
*/  
  
with bimenu(MenuID,Text, NavigateUrl,ParentID,ApplicationID,isFavourite,AngelBOMenuID,MenuType, ParentMenuApplicationID)  
as  
(  
SELECT MenuID,Text,NavigateUrl,ParentID,ApplicationID,isFavourite = cast('0' as varchar),AngelBOMenuID = cast('0' as bigint),   
MenuType, ParentMenuApplicationID  
 FROM tbl_BIMenu_bak_jul_9_2012 ,AngelBOMenu with(nolock) where   
text = reportname and navigateurl=reportpath and HarmonyEmployeeCode = @Emp_NO  
union all  
select b1.MenuID,b1.TExt, b1.NavigateUrl,b1.ParentID,b1.ApplicationID,isFavourite = cast('0' as varchar),   
AngelBOMenuID = cast('0' as bigint), b1.MenuType, b1.ParentMenuApplicationID  
 from tbl_BIMenu_bak_jul_9_2012 b1 inner join bimenu b2 on b2.parentid=b1.menuid   
)  
select * into #Temp from (  
select distinct MenuID,Text , NavigateUrl=(case when len(NavigateUrl)>0 then right(NavigateUrl,len(NavigateUrl)-1) else '' end),--Replace(NavigateUrl,'/',''),
ParentID,ApplicationID,isFavourite ,AngelBOMenuID , MenuType, ParentMenuApplicationID  
from bimenu )a  
  
update #Temp set AngelBOMenuID = a.AngelBOMenuID from AngelBOMenu a with(nolock)  
where #Temp.NavigateURL = a.ReportPath and #Temp.TExt = a.ReportName  and HarmonyEmployeeCode = @Emp_NO  
  
  
  
CREATE TABLE [dbo].[#Temp1](  
 [MenuID] [bigint] NULL,  
 [Text] [varchar](100) NULL,  
 [NavigateUrl] [varchar](max) NULL,  
 [ParentID] [bigint] NULL,  
 [ApplicationID] [bigint] NULL,  
 [isFavourite] [varchar](30) NULL,  
 [AngelBOMenuID] [bigint] NULL,  
 [MenuType] [varchar](20) NULL,  
 [ParentMenuApplicationID] [bigint] NULL  
) ON [PRIMARY]  
  
insert into [#Temp1]  
select * from #Temp where menutype = 'mimansaapplications' order by ParentMenuApplicationID  
  
insert into [#Temp1]  
select * from #Temp where menutype <> 'mimansaapplications' order by Text  
  
select * from  [#Temp1]   
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Insert_B2BCRMS_Log
-- --------------------------------------------------

CREATE Proc [dbo].[sp_Insert_B2BCRMS_Log]
@UserCode varchar(50) , -- Emp Code
@LogType varchar(50), -- Authentication / Error / PageHit
@URL varchar(500) , -- Page URL
@SessionId varchar(60),
@IP varchar(50) , -- USER IP
@Emp_No varchar(20)=null,
@EmpSessionId varchar(60) =null,
@EmpRole varchar(20)=null,
@Description varchar(8000) 
As
Begin

--Print 'a'
--select top 10 * from tbl_AppLog
--exec sp_Insert_B2BCRMS_Log 'CA001','Error_Log','http://localhost/B2B_Crms/SegmentwiseReport.aspx','443iitq0vyi05qoikbffua5l','172.17.1.100','Exception of type &#39;System.Web.HttpUnhandledException&#39; was thrown.  at System.Web.UI.Page.HandleError(Exception e) at System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) at System.Web.UI.Page.ProcessRequest(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) at System.Web.UI.Page.ProcessRequest() at System.Web.UI.Page.ProcessRequestWithNoAssert(HttpContext context) at System.Web.UI.Page.ProcessRequest(HttpContext context) at ASP.segmentwisereport_aspx.ProcessRequest(HttpContext context) in c:\WINDOWS\Microsoft.NET\Framework\v4.0.30319\Temporary ASP.NET Files\b2b_crms\4e1b73b2\cf05adf9\App_Web_334m0rjk.0.cs:line 0 at System.Web.HttpApplication.CallHandlerExecutionStep.System.Web.HttpApplication.IExecutionStep.Execute() at System.Web.HttpApplication.ExecuteStep(IExecutionStep step, Boolean&amp; completedSynchronously)'

declare @Description_new varchar(8000) 
declare @Filenameandinputparameters varchar(8000) 

insert into tbl_AppLog (
UserCode,
LogType,
URL,
SessionId,
IP,
Description,
LogDateTime,
Emp_No,
EmpSessionId,
EmpRole)
values
(@UserCode,  
@LogType,  
@URL  ,
@SessionId  ,
@IP  ,
@Description,
Getdate(),
@Emp_No,
@EmpSessionId,
@EmpRole)  

if (upper(@logtype)='AUTHENTICATION' and upper(@Description)='SUCCESS LOGIN')
begin
	exec prc_CaptureUserLoginDetails @UserCode,@IP
end

DECLARE @tableHTML NVARCHAR(MAX)   
declare @logid as varchar(500)
declare @@CC_list varchar(500)
declare @@To_list varchar(500)

if @logtype='Error_Log' 
begin
	
	if(len(@UserCode)>0)
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where sessionid=@SessionId and logtype='Error_Log'	
	end
	else
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where IP=@IP and logtype='Error_Log'	order by LogDateTime desc
	end
	
	set @Description_new= (select substring(@Description,CHARINDEX('##',@Description)+2, CHARINDEX('<<>>',@Description)-CHARINDEX('##',@Description)-2))
	set @Filenameandinputparameters= (select substring(@Description,0, CHARINDEX('##',@Description)))


	set @tableHTML=	'<p style="font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';">
		  Dear Team, <br/><br/> User '+ @UserCode +' facing error on URL '+ @URL +', the error log id is '+ @logid +'.:<br/>
		  Details are --> <br/>  
			<TABLE  style="width:464.0pt;font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';" cellpadding="2" cellspacing="0" > 
			<tr>  
				<td style="padding-left:10;color:Red;">Error Message:'+ @Description_new +'<td>
			</tr><br/>
			 <tr>  
				<td style="padding-left:10;">'+ @Filenameandinputparameters  +'<td>
			</tr> <br/>
			<tr><td>Please check</td></tr><br/></table>
			<p align="Left">Regards,<br/>Mimansa Team.</p>' 
		
		
		Set @@CC_list='sharmagaurav@angelbroking.com;kamlesh.salgaonkar@angelbroking.com'
		set @@To_list='Mimansa.CRMSSB@angelbroking.com;arjun.singh@angelbroking.com'
					   	
		
		--if(charindex('Invalid viewstate.',@Description_new)>0) 
		--begin
		--	Set @@CC_list=''
		--set @@To_list='prasannav.joshi@angelbroking.com'
		--end
		
		exec msdb.dbo.sp_send_dbmail   
		@recipients=@@To_list,--'sharmagaurav@angelbroking.com;prasannav.joshi@angeltrade.com', 
		--@recipients=N'prasannav.joshi@angeltrade.com', 		
		@importance ='High',   
		@body_format='HTML',  
		@copy_recipients =@@CC_list,  
		@blind_copy_recipients ='anand.dhumal@angelbroking.com;Rajesh.Lohar@angelbroking.com;dayanand.jawalkar@angelbroking.com;',
		@subject ='B2B CRMS Error Report',  
		@profile_name ='MimansaSoft',  
		@body=@tableHTML	
end

if @logtype='Error_Log_DEV' 
begin
	
	if(len(@UserCode)>0)
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where sessionid=@SessionId and logtype='Error_Log'	
	end
	else
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where IP=@IP and logtype='Error_Log_DEV'	order by LogDateTime desc
	end
	
	set @Description_new=@Description-- (select substring(@Description,CHARINDEX('##',@Description)+2, CHARINDEX('<<>>',@Description)-CHARINDEX('##',@Description)-2))
	set @Filenameandinputparameters= (select substring(@Description,0, CHARINDEX('##',@Description)))


	set @tableHTML=	'<p style="font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';">
		  Dear Team, <br/><br/> User '+ @UserCode +' facing error on URL '+ @URL +', the error log id is '+ @logid +'.:<br/>
		  Details are --> <br/>  
			<TABLE  style="width:464.0pt;font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';" cellpadding="2" cellspacing="0" > 
			<tr>  
				<td style="padding-left:10;color:Red;">Error Message:'+ @Description_new +'<td>
			</tr><br/>
			 <tr>  
				<td style="padding-left:10;">'+ @Filenameandinputparameters  +'<td>
			</tr> <br/>
			<tr><td>Please check</td></tr><br/></table>
			<p align="Left">Regards,<br/>Mimansa Team.</p>' 
		
		
		Set @@CC_list='arjun.singh@angelbroking.com'
		--set @@To_list='ravindra.manohar@angelbroking.com;'
					   	
		
		--if(charindex('Invalid viewstate.',@Description_new)>0) 
		--begin
		--	Set @@CC_list=''
		--set @@To_list='prasannav.joshi@angelbroking.com'
		--end
				
		exec msdb.dbo.sp_send_dbmail   
		@recipients=@@To_list,--'sharmagaurav@angelbroking.com;prasannav.joshi@angeltrade.com', 
		--@recipients=N'prasannav.joshi@angeltrade.com', 		
		@importance ='High',   
		@body_format='HTML',  
		@copy_recipients =@@CC_list,  
		--@copy_recipients ='bghanekar@angelbroking.com;mukesh.singh@angelbroking.com',
		@blind_copy_recipients ='anand.dhumal@angelbroking.com;Rajesh.Lohar@angelbroking.com;dayanand.jawalkar@angelbroking.com;',
		@subject ='B2B CRMS Error Report (DEV)',  
		@profile_name ='MimansaSoft',  
		@body=@tableHTML	
end


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Insert_B2BCRMS_Log_BAckUp29April2017
-- --------------------------------------------------

create Proc [dbo].[sp_Insert_B2BCRMS_Log_BAckUp29April2017]
@UserCode varchar(50) , -- Emp Code
@LogType varchar(50), -- Authentication / Error / PageHit
@URL varchar(500) , -- Page URL
@SessionId varchar(60),
@IP varchar(50) , -- USER IP
@Emp_No varchar(20)=null,
@EmpSessionId varchar(60) =null,
@EmpRole varchar(20)=null,
@Description varchar(8000) 
As
Begin

--Print 'a'
--select top 10 * from tbl_AppLog
--exec sp_Insert_B2BCRMS_Log 'CA001','Error_Log','http://localhost/B2B_Crms/SegmentwiseReport.aspx','443iitq0vyi05qoikbffua5l','172.17.1.100','Exception of type &#39;System.Web.HttpUnhandledException&#39; was thrown.  at System.Web.UI.Page.HandleError(Exception e) at System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) at System.Web.UI.Page.ProcessRequest(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) at System.Web.UI.Page.ProcessRequest() at System.Web.UI.Page.ProcessRequestWithNoAssert(HttpContext context) at System.Web.UI.Page.ProcessRequest(HttpContext context) at ASP.segmentwisereport_aspx.ProcessRequest(HttpContext context) in c:\WINDOWS\Microsoft.NET\Framework\v4.0.30319\Temporary ASP.NET Files\b2b_crms\4e1b73b2\cf05adf9\App_Web_334m0rjk.0.cs:line 0 at System.Web.HttpApplication.CallHandlerExecutionStep.System.Web.HttpApplication.IExecutionStep.Execute() at System.Web.HttpApplication.ExecuteStep(IExecutionStep step, Boolean&amp; completedSynchronously)'

declare @Description_new varchar(8000) 
declare @Filenameandinputparameters varchar(8000) 

insert into tbl_AppLog (
UserCode,
LogType,
URL,
SessionId,
IP,
Description,
LogDateTime,
Emp_No,
EmpSessionId,
EmpRole)
values
(@UserCode,  
@LogType,  
@URL  ,
@SessionId  ,
@IP  ,
@Description,
Getdate(),
@Emp_No,
@EmpSessionId,
@EmpRole)  

if (upper(@logtype)='AUTHENTICATION' and upper(@Description)='SUCCESS LOGIN')
begin
	exec prc_CaptureUserLoginDetails @UserCode,@IP
end

DECLARE @tableHTML NVARCHAR(MAX)   
declare @logid as varchar(500)
declare @@CC_list varchar(500)
declare @@To_list varchar(500)

if @logtype='Error_Log' 
begin
	
	if(len(@UserCode)>0)
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where sessionid=@SessionId and logtype='Error_Log'	
	end
	else
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where IP=@IP and logtype='Error_Log'	order by LogDateTime desc
	end
	
	set @Description_new= (select substring(@Description,CHARINDEX('##',@Description)+2, CHARINDEX('<<>>',@Description)-CHARINDEX('##',@Description)-2))
	set @Filenameandinputparameters= (select substring(@Description,0, CHARINDEX('##',@Description)))


	set @tableHTML=	'<p style="font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';">
		  Dear Team, <br/><br/> User '+ @UserCode +' facing error on URL '+ @URL +', the error log id is '+ @logid +'.:<br/>
		  Details are --> <br/>  
			<TABLE  style="width:464.0pt;font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';" cellpadding="2" cellspacing="0" > 
			<tr>  
				<td style="padding-left:10;color:Red;">Error Message:'+ @Description_new +'<td>
			</tr><br/>
			 <tr>  
				<td style="padding-left:10;">'+ @Filenameandinputparameters  +'<td>
			</tr> <br/>
			<tr><td>Please check</td></tr><br/></table>
			<p align="Left">Regards,<br/>Mimansa Team.</p>' 
		
		
		Set @@CC_list='sharmagaurav@angelbroking.com;kamlesh.salgaonkar@angelbroking.com'
		set @@To_list='Mimansa.CRMSSB@angelbroking.com;arjun.singh@angelbroking.com'
					   	
		
		--if(charindex('Invalid viewstate.',@Description_new)>0) 
		--begin
		--	Set @@CC_list=''
		--set @@To_list='prasannav.joshi@angelbroking.com'
		--end
			
		exec msdb.dbo.sp_send_dbmail   
		@recipients=@@To_list,--'sharmagaurav@angelbroking.com;prasannav.joshi@angeltrade.com', 
		--@recipients=N'prasannav.joshi@angeltrade.com', 		
		@importance ='High',   
		@body_format='HTML',  
		@copy_recipients =@@CC_list,  
		--@copy_recipients ='bghanekar@angelbroking.com;mukesh.singh@angelbroking.com',  
		@subject ='B2B CRMS Error Report',  
		@profile_name ='MimansaSoft',  
		@body=@tableHTML	
end

if @logtype='Error_Log_DEV' 
begin
	
	if(len(@UserCode)>0)
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where sessionid=@SessionId and logtype='Error_Log'	
	end
	else
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where IP=@IP and logtype='Error_Log_DEV'	order by LogDateTime desc
	end
	
	set @Description_new=@Description-- (select substring(@Description,CHARINDEX('##',@Description)+2, CHARINDEX('<<>>',@Description)-CHARINDEX('##',@Description)-2))
	set @Filenameandinputparameters= (select substring(@Description,0, CHARINDEX('##',@Description)))


	set @tableHTML=	'<p style="font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';">
		  Dear Team, <br/><br/> User '+ @UserCode +' facing error on URL '+ @URL +', the error log id is '+ @logid +'.:<br/>
		  Details are --> <br/>  
			<TABLE  style="width:464.0pt;font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';" cellpadding="2" cellspacing="0" > 
			<tr>  
				<td style="padding-left:10;color:Red;">Error Message:'+ @Description_new +'<td>
			</tr><br/>
			 <tr>  
				<td style="padding-left:10;">'+ @Filenameandinputparameters  +'<td>
			</tr> <br/>
			<tr><td>Please check</td></tr><br/></table>
			<p align="Left">Regards,<br/>Mimansa Team.</p>' 
		
		
		Set @@CC_list='arjun.singh@angelbroking.com'
		set @@To_list='ravindra.manohar@angelbroking.com;'
					   	
		
		--if(charindex('Invalid viewstate.',@Description_new)>0) 
		--begin
		--	Set @@CC_list=''
		--set @@To_list='prasannav.joshi@angelbroking.com'
		--end
			
		exec msdb.dbo.sp_send_dbmail   
		@recipients=@@To_list,--'sharmagaurav@angelbroking.com;prasannav.joshi@angeltrade.com', 
		--@recipients=N'prasannav.joshi@angeltrade.com', 		
		@importance ='High',   
		@body_format='HTML',  
		@copy_recipients =@@CC_list,  
		--@copy_recipients ='bghanekar@angelbroking.com;mukesh.singh@angelbroking.com',  
		@subject ='B2B CRMS Error Report (DEV)',  
		@profile_name ='MimansaSoft',  
		@body=@tableHTML	
end


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Insert_B2BCRMS_Log_Bak_18Dec_2014
-- --------------------------------------------------

Create Proc [dbo].[sp_Insert_B2BCRMS_Log_Bak_18Dec_2014]
@UserCode varchar(50) , -- Emp Code
@LogType varchar(50), -- Authentication / Error / PageHit
@URL varchar(500) , -- Page URL
@SessionId varchar(60),
@IP varchar(50) , -- USER IP
@Emp_No varchar(20)=null,
@EmpSessionId varchar(60) =null,
@EmpRole varchar(20)=null,
@Description varchar(8000) 
As
Begin

--Print 'a'
--select top 10 * from tbl_AppLog
--exec sp_Insert_B2BCRMS_Log 'CA001','Error_Log','http://localhost/B2B_Crms/SegmentwiseReport.aspx','443iitq0vyi05qoikbffua5l','172.17.1.100','Exception of type &#39;System.Web.HttpUnhandledException&#39; was thrown.  at System.Web.UI.Page.HandleError(Exception e) at System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) at System.Web.UI.Page.ProcessRequest(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) at System.Web.UI.Page.ProcessRequest() at System.Web.UI.Page.ProcessRequestWithNoAssert(HttpContext context) at System.Web.UI.Page.ProcessRequest(HttpContext context) at ASP.segmentwisereport_aspx.ProcessRequest(HttpContext context) in c:\WINDOWS\Microsoft.NET\Framework\v4.0.30319\Temporary ASP.NET Files\b2b_crms\4e1b73b2\cf05adf9\App_Web_334m0rjk.0.cs:line 0 at System.Web.HttpApplication.CallHandlerExecutionStep.System.Web.HttpApplication.IExecutionStep.Execute() at System.Web.HttpApplication.ExecuteStep(IExecutionStep step, Boolean&amp; completedSynchronously)'

declare @Description_new varchar(8000) 
declare @Filenameandinputparameters varchar(8000) 

insert into tbl_AppLog (
UserCode,
LogType,
URL,
SessionId,
IP,
Description,
LogDateTime,
Emp_No,
EmpSessionId,
EmpRole)
values
(@UserCode,  
@LogType,  
@URL  ,
@SessionId  ,
@IP  ,
@Description,
Getdate(),
@Emp_No,
@EmpSessionId,
@EmpRole)  

if (upper(@logtype)='AUTHENTICATION' and upper(@Description)='SUCCESS LOGIN')
begin
	exec prc_CaptureUserLoginDetails @UserCode,@IP
end

DECLARE @tableHTML NVARCHAR(MAX)   
declare @logid as varchar(500)
declare @@CC_list varchar(500)
declare @@To_list varchar(500)

if @logtype='Error_Log' 
begin
	
	if(len(@UserCode)>0)
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where sessionid=@SessionId and logtype='Error_Log'	
	end
	else
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where IP=@IP and logtype='Error_Log'	order by LogDateTime desc
	end
	
	set @Description_new= (select substring(@Description,CHARINDEX('##',@Description)+2, CHARINDEX('<<>>',@Description)-CHARINDEX('##',@Description)-2))
	set @Filenameandinputparameters= (select substring(@Description,0, CHARINDEX('##',@Description)))


	set @tableHTML=	'<p style="font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';">
		  Dear Team, <br/><br/> User '+ @UserCode +' facing error on URL '+ @URL +', the error log id is '+ @logid +'.:<br/>
		  Details are --> <br/>  
			<TABLE  style="width:464.0pt;font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';" cellpadding="2" cellspacing="0" > 
			<tr>  
				<td style="padding-left:10;color:Red;">Error Message:'+ @Description_new +'<td>
			</tr><br/>
			 <tr>  
				<td style="padding-left:10;">'+ @Filenameandinputparameters  +'<td>
			</tr> <br/>
			<tr><td>Please check</td></tr><br/></table>
			<p align="Left">Regards,<br/>Mimansa Team.</p>' 
		
		
		Set @@CC_list='sharmagaurav@angelbroking.com;suman.nayak@angelbroking.com;kamlesh.salgaonkar@angelbroking.com'
		set @@To_list='Mimansa.CRMSSB@angelbroking.com;prasannav.joshi@angelbroking.com;sandip.girnar@angelbroking.com;aniket.latne@angelbroking.com'
					   	
		
		--if(charindex('Invalid viewstate.',@Description_new)>0) 
		--begin
		--	Set @@CC_list=''
		--set @@To_list='prasannav.joshi@angelbroking.com'
		--end
			
		exec msdb.dbo.sp_send_dbmail   
		@recipients=@@To_list,--'sharmagaurav@angelbroking.com;prasannav.joshi@angeltrade.com', 
		--@recipients=N'prasannav.joshi@angeltrade.com', 		
		@importance ='High',   
		@body_format='HTML',  
		@copy_recipients =@@CC_list,  
		--@copy_recipients ='bghanekar@angelbroking.com;mukesh.singh@angelbroking.com',  
		@subject ='B2B CRMS Error Report',  
		@profile_name ='MimansaSoft',  
		@body=@tableHTML	
end

if @logtype='Error_Log_DEV' 
begin
	
	if(len(@UserCode)>0)
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where sessionid=@SessionId and logtype='Error_Log'	
	end
	else
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where IP=@IP and logtype='Error_Log_DEV'	order by LogDateTime desc
	end
	
	set @Description_new=@Description-- (select substring(@Description,CHARINDEX('##',@Description)+2, CHARINDEX('<<>>',@Description)-CHARINDEX('##',@Description)-2))
	set @Filenameandinputparameters= (select substring(@Description,0, CHARINDEX('##',@Description)))


	set @tableHTML=	'<p style="font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';">
		  Dear Team, <br/><br/> User '+ @UserCode +' facing error on URL '+ @URL +', the error log id is '+ @logid +'.:<br/>
		  Details are --> <br/>  
			<TABLE  style="width:464.0pt;font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';" cellpadding="2" cellspacing="0" > 
			<tr>  
				<td style="padding-left:10;color:Red;">Error Message:'+ @Description_new +'<td>
			</tr><br/>
			 <tr>  
				<td style="padding-left:10;">'+ @Filenameandinputparameters  +'<td>
			</tr> <br/>
			<tr><td>Please check</td></tr><br/></table>
			<p align="Left">Regards,<br/>Mimansa Team.</p>' 
		
		
		Set @@CC_list=''
		set @@To_list='sandip.girnar@angelbroking.com;aniket.latne@angelbroking.com;'
					   	
		
		--if(charindex('Invalid viewstate.',@Description_new)>0) 
		--begin
		--	Set @@CC_list=''
		--set @@To_list='prasannav.joshi@angelbroking.com'
		--end
			
		exec msdb.dbo.sp_send_dbmail   
		@recipients=@@To_list,--'sharmagaurav@angelbroking.com;prasannav.joshi@angeltrade.com', 
		--@recipients=N'prasannav.joshi@angeltrade.com', 		
		@importance ='High',   
		@body_format='HTML',  
		@copy_recipients =@@CC_list,  
		--@copy_recipients ='bghanekar@angelbroking.com;mukesh.singh@angelbroking.com',  
		@subject ='B2B CRMS Error Report (DEV)',  
		@profile_name ='MimansaSoft',  
		@body=@tableHTML	
end


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Insert_B2BCRMS_Log_Bak_2Apr2014
-- --------------------------------------------------

create Proc [dbo].[sp_Insert_B2BCRMS_Log_Bak_2Apr2014]
@UserCode varchar(50) , -- Emp Code
@LogType varchar(50), -- Authentication / Error / PageHit
@URL varchar(500) , -- Page URL
@SessionId varchar(60),
@IP varchar(50) , -- USER IP
@Emp_No varchar(20)=null,
@EmpSessionId varchar(60) =null,
@EmpRole varchar(20)=null,
@Description varchar(8000) 
As
Begin

--Print 'a'
--select top 10 * from tbl_AppLog
--exec sp_Insert_B2BCRMS_Log 'CA001','Error_Log','http://localhost/B2B_Crms/SegmentwiseReport.aspx','443iitq0vyi05qoikbffua5l','172.17.1.100','Exception of type &#39;System.Web.HttpUnhandledException&#39; was thrown.  at System.Web.UI.Page.HandleError(Exception e) at System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) at System.Web.UI.Page.ProcessRequest(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) at System.Web.UI.Page.ProcessRequest() at System.Web.UI.Page.ProcessRequestWithNoAssert(HttpContext context) at System.Web.UI.Page.ProcessRequest(HttpContext context) at ASP.segmentwisereport_aspx.ProcessRequest(HttpContext context) in c:\WINDOWS\Microsoft.NET\Framework\v4.0.30319\Temporary ASP.NET Files\b2b_crms\4e1b73b2\cf05adf9\App_Web_334m0rjk.0.cs:line 0 at System.Web.HttpApplication.CallHandlerExecutionStep.System.Web.HttpApplication.IExecutionStep.Execute() at System.Web.HttpApplication.ExecuteStep(IExecutionStep step, Boolean&amp; completedSynchronously)'

declare @Description_new varchar(8000) 
declare @Filenameandinputparameters varchar(8000) 

insert into tbl_AppLog (
UserCode,
LogType,
URL,
SessionId,
IP,
Description,
LogDateTime,
Emp_No,
EmpSessionId,
EmpRole)
values
(@UserCode,  
@LogType,  
@URL  ,
@SessionId  ,
@IP  ,
@Description,
Getdate(),
@Emp_No,
@EmpSessionId,
@EmpRole)  

if (upper(@logtype)='AUTHENTICATION' and upper(@Description)='SUCCESS LOGIN')
begin
	exec prc_CaptureUserLoginDetails @UserCode,@IP
end

if @logtype='Error_Log' 
begin
	DECLARE @tableHTML NVARCHAR(MAX)   
	declare @logid as varchar(500)
	if(len(@UserCode)>0)
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where sessionid=@SessionId and logtype='Error_Log'	
	end
	else
	begin
		select top 1 @logid=cast (logid as varchar)  from tbl_AppLog whith(nolock) where IP=@IP and logtype='Error_Log'	order by LogDateTime desc
	end
	
	set @Description_new= (select substring(@Description,CHARINDEX('##',@Description)+2, CHARINDEX('<<>>',@Description)-CHARINDEX('##',@Description)-2))
	set @Filenameandinputparameters= (select substring(@Description,0, CHARINDEX('##',@Description)))


	set @tableHTML=	'<p style="font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';">
		  Dear Team, <br/><br/> User '+ @UserCode +' facing error on URL '+ @URL +', the error log id is '+ @logid +'.:<br/>
		  Details are --> <br/>  
			<TABLE  style="width:464.0pt;font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';" cellpadding="2" cellspacing="0" > 
			<tr>  
				<td style="padding-left:10;color:Red;">Error Message:'+ @Description_new +'<td>
			</tr><br/>
			 <tr>  
				<td style="padding-left:10;">'+ @Filenameandinputparameters  +'<td>
			</tr> <br/>
			<tr><td>Please check</td></tr><br/></table>
			<p align="Left">Regards,<br/>Mimansa Team.</p>' 
		
		declare @@CC_list varchar(500)
		declare @@To_list varchar(500)
		Set @@CC_list='sharmagaurav@angelbroking.com;suman.nayak@angelbroking.com;kamlesh.salgaonkar@angelbroking.com'
		set @@To_list='Mimansa.CRMSSB@angelbroking.com;prasannav.joshi@angelbroking.com;sandip.girnar@angelbroking.com;aniket.latne@angelbroking.com'
					   	
		
		--if(charindex('Invalid viewstate.',@Description_new)>0) 
		--begin
		--	Set @@CC_list=''
		--set @@To_list='prasannav.joshi@angelbroking.com'
		--end
			
		exec msdb.dbo.sp_send_dbmail   
		@recipients=@@To_list,--'sharmagaurav@angelbroking.com;prasannav.joshi@angeltrade.com', 
		--@recipients=N'prasannav.joshi@angeltrade.com', 		
		@importance ='High',   
		@body_format='HTML',  
		@copy_recipients =@@CC_list,  
		--@copy_recipients ='bghanekar@angelbroking.com;mukesh.singh@angelbroking.com',  
		@subject ='B2B CRMS Error Report',  
		@profile_name ='MimansaSoft',  
		@body=@tableHTML	
end


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_UpdateNewCommonLoginMenuTable
-- --------------------------------------------------

CREATE proc [dbo].[sp_UpdateNewCommonLoginMenuTable]

as
begin

	select * into #TempMimansaApplications from mimansaapplications 
    select * into #Tempmimansamodules from mimansamodules -- drop table #Tempmimansamodules
    select * into #Tempmimansareports from mimansareports 
    
    
	delete #TempMimansaApplications from tbl_BIMenu  m where #TempMimansaApplications.applicationid = m.applicationid and menutype = 'mimansaapplications'
	
	
	insert into tbl_BIMenu   
	select distinct Text = ApplicationName, Value = ApplicationName,NavigateUrl ='',ParentID = 0, 
	Tooltip = applicationdescription,RelationName = 'ddSubMenu' + REPLACE(ApplicationName,' ',''),
	MenuType = 'mimansaapplications',ApplicationID , ParentMenuApplicationID = 0 
	from #TempMimansaApplications 
	

	delete #Tempmimansamodules from tbl_BIMenu m where #Tempmimansamodules.moduleid = m.applicationid and menutype = 'mimansamodules'

	insert into tbl_BIMenu 
   select distinct Text = ModuleName, Value = ModuleName,NavigateUrl ='',
   ParentID = (select distinct menuid from tbl_BIMenu where applicationid = a.applicationid and  menutype = 'mimansaapplications'), 
	Tooltip = Moduledescription,RelationName = 'ddSubMenu' + REPLACE(a.ApplicationName,' ',''),
	MenuType = 'mimansamodules',ApplicationID = ModuleID ,
	ParentMenuApplicationID = (select distinct menuid from tbl_BIMenu where applicationid = a.applicationid and  menutype = 'mimansaapplications')
   from #Tempmimansamodules m left outer join mimansaapplications a
   on m.applicationid = a.applicationid 
  

	delete #Tempmimansareports from tbl_BIMenu m where #Tempmimansareports.reportid = m.applicationid and menutype = 'mimansareports'

  insert into tbl_BIMenu   
    select Text = ReportName, Value = ReportName,NavigateUrl =ReportPath,
    ParentID = (select menuid from tbl_BIMenu t where MenuType = 'mimansamodules' and t.applicationid = m.moduleid), 
	Tooltip = ReportDescription,RelationName = 'ddSubMenu' + REPLACE(m.modulename,' ',''),
	MenuType = 'mimansareports',ApplicationID = ReportID ,
	ParentMenuApplicationID = (select menuid from tbl_BIMenu t where MenuType = 'mimansaapplications' and t.applicationid = a.applicationid)
   from #Tempmimansareports r left outer join mimansamodules   m
   on r.moduleid = m.moduleid left outer join mimansaapplications a
   on r.applicationid = a.applicationid
   

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_AssignCapabilityToEmployee
-- --------------------------------------------------
    
    
      
--exec spx_AssignCapabilityToEmployee '1,2','SB001','E33995','127.1.1.1'        
CREATE Proc [dbo].[spx_AssignCapabilityToEmployee]        
@CapabilityId varchar(10),        
@EmpCode varchar(10),        
@UserId varchar(10),        
@Ip varchar(16)        
        
As        
        
Declare @msg varchar(100)        
        
        
DECLARE @reccount numeric(18,0)                                          
                                      
CREATE TABLE #TempB(Id int PRIMARY KEY IDENTITY(1,1),Sno bigint)                                          
SELECT @reccount = charindex(',',@CapabilityId)                                          
while (charindex(',',@CapabilityId) > 0 )                                           
BEGIN                                          
                                       
 SET @reccount=CONVERT(bigint,substring(@CapabilityId,1,charindex(',',@CapabilityId)-1))                                          
 SET @CapabilityId = substring(@CapabilityId,charindex(',',@CapabilityId)+1,len(@CapabilityId))                                     
 INSERT INTO #TempB(Sno) VALUES (@reccount)                                          
END                                          
SET @reccount=CONVERT(bigint,@CapabilityId)                                          
INSERT INTO #TempB(Sno) VALUES (@reccount)                            
         
        
        
 insert into log_Emp_Capability      
 (pid_tbl_Emp_Capability,Emp_No,Fkid_tbl_Capability_mst,User_Id,Dt_Updation,IP,Created_date)      
 select pid_tbl_Emp_Capability,Emp_No,Fkid_tbl_Capability_mst,User_Id,Dt_Updation,IP,Created_date from tbl_Emp_Capability where Fkid_tbl_Capability_mst in (select Sno from #TempB) and Emp_No=@EmpCode        
      
 delete from tbl_Emp_Capability where Fkid_tbl_capability_mst not  in   
   (select pid_tbl_capability_mst from tbl_capability_master where IsDefaultSelected=1) and Emp_No=@EmpCode   
        
insert into tbl_Emp_Capability(Emp_No, Fkid_tbl_Capability_mst, User_Id,  IP,  Created_date)        
select @EmpCode,Sno,@UserId,@Ip,GetDate() from #TempB        

Exec  prc_UpdateCapability_tbl_EmployeeView @EmpCode 
        
declare @Employee varchar(1000)    
select @Employee =@EmpCode+' : '+emp_name from tbl_emp_master where emp_no=@EmpCode     
set @msg='Capability updated successfully...\nEmployee: '+@Employee          
select @msg as Msg

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_AssignRoleToEmployee
-- --------------------------------------------------
--exec spx_AssignRoleToEmployee '2','ETt002','E33995',''          
CREATE Proc spx_AssignRoleToEmployee          
@RoleId varchar(10),          
@EmpCode varchar(10),          
@UserId varchar(10),          
@Ip varchar(16)          
          
As          
Declare @msg varchar(100)          
declare @isClientMapped bit,@cnt as int      
DECLARE @reccount numeric(18,0)                                            
  
create table #temp_MendatoryRoleIds_ClientMaping (RoleIds int)    
  
                                        
CREATE TABLE #TempB(Id int PRIMARY KEY IDENTITY(1,1),Sno bigint)                                            
SELECT @reccount = charindex(',',@RoleId)                                            
while (charindex(',',@RoleId) > 0 )                                             
BEGIN                                            
                                         
 SET @reccount=CONVERT(bigint,substring(@RoleId,1,charindex(',',@RoleId)-1))                                            
 SET @RoleId = substring(@RoleId,charindex(',',@RoleId)+1,len(@RoleId))                                       
 INSERT INTO #TempB(Sno) VALUES (@reccount)                                            
END                                            
SET @reccount=CONVERT(bigint,@RoleId)                                            
INSERT INTO #TempB(Sno) VALUES (@reccount)        
  
--declare @Employee varchar(1000)    
--select @Employee =@EmpCode+' - '+emp_name from tbl_emp_master where emp_no=@EmpCode                        
  
/*Check that if any role ids are missing which have ClientMaping rule  like (Dealer),  
  if so and it is not selected then it dumps the role ids in temp table to check is there any Client Mapped under him*/  
  insert into #temp_MendatoryRoleIds_ClientMaping    
  select pid_tbl_Role_mst RoleIds --@cnt=count(*)      
  from tbl_role_master mst1       
  where not exists(select sno from  #tempb t1 where  mst1.pid_tbl_Role_mst=t1.sno  )      
  and isnull(ApplyRule_ClientMaping_Suspension,0)=1      
    
 select @cnt=count(*) from #temp_MendatoryRoleIds_ClientMaping      
              
 if(isnull(@cnt,0)>0)      
 begin      
   Exec prc_isClientMappedUnderEmployee @EmpCode,@isClientMapped out       
 end      
/**************************************************************************************/            
 if(isnull(@isClientMapped,0)<>1)  
 begin          
   insert into log_Emp_Role        
   (pid_tbl_Emp_Role,Emp_No,Fkid_tbl_Role_mst,User_Id,Dt_Updation,IP,Created_date,Role_Name)        
    select pid_tbl_Emp_Role,Emp_No,Fkid_tbl_Role_mst,User_Id,Dt_Updation,IP,Created_date,Role_Name from tbl_Emp_Role           
    where Fkid_tbl_Role_mst in (select Sno from #TempB) and Emp_No=@EmpCode          
     
   
   delete from tbl_Emp_Role   where Fkid_tbl_Role_mst not  in   
   (select pid_tbl_role_mst from tbl_role_master where IsDefaultSelected=1) and Emp_No=@EmpCode          
          
   print 'here'        
   insert into tbl_Emp_Role(Emp_No, Fkid_tbl_Role_mst, User_Id,  IP,  Created_date)          
   select @EmpCode,Sno,@UserId,@Ip,GetDate() from #TempB          

		   
	Exec  prc_UpdateRole_tbl_EmployeeView @EmpCode           
 
      
 set @msg='Role updated successfully...\nEmployee : '+dbo.fn_GetEmpNameWithEcode(@EmpCode)         
 end  
 else  
 begin  
 set @msg='Dealer -  '+dbo.fn_GetEmpNameWithEcode(@EmpCode)+ ' cannot be removed from Role master as clients are mapped to him.\n Kindly, shift all the clients to some other dealer.'  
 end  
 select @msg as Msg  
 select RoleIds from #temp_MendatoryRoleIds_ClientMaping

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_Capability_insert_update
-- --------------------------------------------------
/*        
 Created By : Ramesh Shukla        
 Creted On :  03 Mar 2012        
 Updated By : Vikram Ukani   
 Last Ukdated On : 16 march 2012      
  
 Desc : To Insert  or Update Records in Capability master Table        
 Exec : Spx_Capability_insert_update 2, 'Turnover','Turnover','Admin','0.0.0.0',1        
         
*/          
CREATE PROCEDURE [dbo].[Spx_Capability_insert_update]          
(          
         
 @pid int=0,        
 @Name varchar(30),        
 @desc varchar(300),        
 @User_id varchar(20),          
 @ip varchar(20),      
 @defaultSelected bit      
         
           
 )          
          
AS         
 DECLARE @count int,@count_pid  int        
begin          
            
          
 SELECT @count=count(*) FROM tbl_Capability_Master WHERE pid_tbl_Capability_mst=@pid          
 SELECT @count_pid=max(pid_tbl_Capability_mst)+1 FROM tbl_Capability_Master          
 IF(@count=0)          
 BEGIN          
            
   INSERT INTO tbl_Capability_Master(pid_tbl_Capability_mst,Capability_Desc,isDefaultSelected,IP, Created_date,          
     Capability_Name,User_Id)  
       
     VALUES(@count_pid,@desc,@DefaultSelected,@ip,getdate(),@name,@User_id)          
       
     if(isnull(@DefaultSelected,0)!=0)  
   Exec prc_AssignRemove_Default_RoleCapability_AllEmp @capabilityid=@count_pid,@userid=@user_id,@ip=@ip,@removeDefault=0  
 END          
 ELSE          
 BEGIN          
        
  INSERT INTO log_Capability_Master (pid_tbl_Capability_mst,Capability_Desc,User_Id,Dt_Updation,IP,Created_date    
      ,Capability_Name,isDefaultselected,Log_UpdationDate)      
  SELECT pid_tbl_Capability_mst,Capability_Desc,User_Id,Dt_Updation,IP,Created_date,Capability_Name,IsDefaultSelected,getdate()      
  FROM tbl_Capability_Master WHERE pid_tbl_Capability_mst=@pid        
          
  UPDATE tbl_Capability_Master SET Capability_Desc = @desc,isDefaultSelected=@DefaultSelected,User_Id = @User_id      
   ,Dt_Updation =getdate(),IP = @ip,Capability_Name = @Name        
  WHERE pid_tbl_Capability_mst=@pid          
    
   if(isnull(@DefaultSelected,0)=0)  
   Exec prc_AssignRemove_Default_RoleCapability_AllEmp @capabilityid=@pid,@userid=@user_id,@ip=@ip,@removeDefault=1  
  else  
   Exec prc_AssignRemove_Default_RoleCapability_AllEmp @capabilityid=@pid,@userid=@user_id,@ip=@ip,@removeDefault=0  
  
 END         
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_EmpMaster_Role_View
-- --------------------------------------------------
Create Proc [dbo].[spx_EmpMaster_Role_View]
as
CREATE TABLE #Table1 (ColId INT,ColName VARCHAR(10))
insert into #Table1 select pid_tbl_Role_mst,Role_Name from tbl_Role_Master


select * from #Table1

CREATE TABLE #Table2 (tID varchar(100),ColID INT,txt varchar(10))
insert into #Table2 select Emp_No,fkid_tbl_role_mst,'Y' from tbl_Emp_Role
 
 
 DECLARE @cols NVARCHAR(2000)
SELECT  @cols = STUFF(( SELECT DISTINCT TOP 100 PERCENT
                                '],[' + t2.ColName
                        FROM    #Table1 AS t2
                        ORDER BY '],[' + t2.ColName
                        FOR XML PATH('')
                      ), 1, 2, '') + ']'


 DECLARE @query NVARCHAR(4000)
SET @query = N'SELECT tID, '+
@cols +'
FROM
(SELECT  t2.tID
      , t1.ColName
      , t2.Txt
FROM    #Table1 AS t1
        JOIN #Table2 AS t2 ON t1.ColId = t2.ColID) p
PIVOT
(
MAX([Txt])
FOR ColName IN
( '+
@cols +' )
) AS pvt
ORDER BY tID;'


EXECUTE(@query)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_ForgotPasswordMail
-- --------------------------------------------------
--select * from tbl_Emp_Master          
--spx_ForgotPasswordMail 'AAAP001','rakesh.sharma@angelbroking.com'          
CREATE Proc [dbo].[spx_ForgotPasswordMail]          
@Emp_no varchar(15),          
@Email varchar(50)          
as          
          
Declare @Password varchar(50),@UserId varchar(50)          
          
if exists(select * from tbl_Emp_Master where ltrim(rtrim(isnull(Email,'')))=ltrim(rtrim(@Email)))  
Begin          
          
select @Password=Password,@UserId=User_ID from tbl_Emp_Master where ltrim(rtrim(isnull(Email,'')))=ltrim(rtrim(@Email))          
  
  
          
DECLARE @alpha_numeric VARCHAR(8)          
declare @MailBody varchar(max),@MailTemplate varchar(max),@subject varchar(1000)          
begin                
 set @subject='Login Details For SB Portal'                 
 --set @MailBody='<html><head></head><body>#MailTemplate#</body></html>'          
 --select @MailTemplate=MailTemplate,@subject=MailSubject from tbl_MailMessage_Master where MM_Id=2           
 set @MailBody=' <table style="font-family: Verdana; font-size: 10pt; width: 279px;">        
            <tr>        
                <td colspan="2">        
                    <b><u>Login Details</u></b></td>        
            </tr>        
            <tr>        
                <td class="style3">        
                    <b>User Id  :</b></td>        
                <td>        
                    '+@UserId+'</td>        
            </tr>        
            <tr>        
                <td class="style3">        
                    <b>Password  :</b></td>        
                <td>        
                    '+@Password+'</td>        
            </tr>        
                    
        </table>'          
                 
           
 print @MailBody                
 exec prc_SendMail @To=@Email,@MailContent=@MailBody,@Mailsubject=@subject            
           
 select 'Login information has been sent to your given email address' as msg            
end   
End  
Else  
Begin

	select 'Please note that your Email id is not registered with Partners Desk. Kindly  get your Email ID Registered with Partner Desk to get Uninterrupted mail communication from System. <a href="mailto:Partners@angelbroking.com">Partners@angelbroking.com</a>' as msg   
    --exec prc_SendMail @To=@Email,@MailContent='Your Email Not Registerd',@Mailsubject='Login Details For SB Portal'            
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_ForgotPasswordMail_NEW
-- --------------------------------------------------



--select * from tbl_Emp_Master where user_id='HYD1014'     
--SUMAN.NAYAK@ANGELBROKING.COM      
--[spx_ForgotPasswordMail_NEW] 'AAAP001','rakesh.sharma@angelbroking.com'            
CREATE Proc [dbo].[spx_ForgotPasswordMail_NEW]            
@Emp_no varchar(15),            
@Email varchar(50)            
as            
            
Declare @Password varchar(50),@UserId varchar(50)            
 DECLARE @Random INT  
 DECLARE @Upper INT  
 DECLARE @Lower INT  
            
 SET @Lower = 1 ---- The lowest random number  
   SET @Upper = 48 ---- The highest random number  
                  
if exists(select * from tbl_Emp_Master where ltrim(rtrim(isnull(Email,'')))=ltrim(rtrim(@Email))AND [User_ID]=@Emp_no)    
Begin            
            
 select @Password=Password,@UserId=User_ID from tbl_Emp_Master where ltrim(rtrim(isnull(Email,'')))=ltrim(rtrim(@Email))AND [User_ID]=@Emp_no            
    
 SELECT @Random = ROUND(((@Upper - @Lower -1) * RAND() + @Lower), 0)  
  
 select @password=Pass from tbl_CRMSRandomPassword where ID=@Random        
 update tbl_Emp_Master set PassWord=@password where Emp_No=@Emp_no        

    
            
DECLARE @alpha_numeric VARCHAR(8)            
declare @MailBody varchar(max),@MailTemplate varchar(max),@subject varchar(1000)            
begin                  
 set @subject='Login Details For SB Portal'                   
 --set @MailBody='<html><head></head><body>#MailTemplate#</body></html>'            
 --select @MailTemplate=MailTemplate,@subject=MailSubject from tbl_MailMessage_Master where MM_Id=2             
 set @MailBody=' <table style="font-family: Verdana; font-size: 10pt; width: 279px;">          
            <tr>          
                <td colspan="2">          
                    <b><u>Login Details</u></b></td>          
            </tr>          
            <tr>          
                <td class="style3">          
                    <b>User Id  :</b></td>          
                <td>          
                    '+@UserId+'</td>          
            </tr>          
            <tr>          
                <td class="style3">          
                    <b>Password  :</b></td>          
                <td>          
                    '+@Password+'</td>          
            </tr>          
                      
        </table>'            
                   
             
 print @MailBody                  
 exec prc_SendMail @To=@Email,@MailContent=@MailBody,@Mailsubject=@subject              
             
 select 'Login information has been sent to your given email address' as msg              
end     
End    
Else    
Begin  
  
 select 'Please note that your Email id is not registered with Partners Desk. Kindly  get your Email ID Registered with Partner Desk to get Uninterrupted mail communication from System. <a href="mailto:Partners@angelbroking.com">Partners@angelbroking.com</a>' as msg     
    --exec prc_SendMail @To=@Email,@MailContent='Your Email Not Registerd',@Mailsubject='Login Details For SB Portal'              
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_get_records_sb
-- --------------------------------------------------
/*                  
 Created By : Ramesh Shukla                 
 Creted On :  3 Mar 2012                  
 Desc : To Bind Employee MIS for the SubBroker                
 Exec Spx_get_records_sb 'afp'                  
                   
*/                  
--Spx_get_records_sb 'HYD1'             
CREATE PROCEDURE [dbo].[Spx_get_records_sb]                    
@SubBrokerTag varchar(20)                
                    
AS                    
                    
SELECT DISTINCT vwmst.Emp_No,vwmst.Sb_Tag,vwmst.First_Name,vwmst.Middle_Name,vwmst.Last_Name,vwmst.Address1,vwmst.Emp_Name,vwmst.Address2,vwmst.City,                    
       vwmst.State, vwmst.Pincode, vwmst.Mobile, vwmst.Email, CONVERT(VARCHAR(12),vwmst.Dt_ActiveFrom,103) as  Dt_ActiveFrom,                  
       isnull(CONVERT(VARCHAR(12), t2.Suspension_date,103),'') as Dt_Suspension,          
       isnull(CONVERT(VARCHAR(12),t2.Termination_date,103),'') as Dt_Termination, vwmst.Salary,vwmst.LandLine Pid_landline,t3.Landline_No LandLine                    
  FROM tbl_emp_master vwmst (nolock) left outer join tbl_Emp_Suspension_Termination t2              
  on vwmst.emp_no=t2.emp_no              
  left outer join tbl_SbContact_Detail t3      
   on vwmst.LandLine=t3.pid      
  where exists (select sb_tag from  vw_ParentChildTagMapping v1 (nolock) where v1.parentTag =@SubBrokerTag and v1.sb_tag=vwmst.sb_tag)            
  or vwmst.sb_tag=@SubBrokerTag             
  order by sb_tag,emp_no    
  --vw_ActiveNonAdmin_Employee_Master

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_GetEmpCode_Role_Capability
-- --------------------------------------------------
/*    
 exec spx_GetEmpCode_Role_Capability 'GDS','GDS001','Role','GDS001'    
 select * from tbl_Emp_Role where emp_no='GDS004'
 select * from tbl_Role_Master
*/    
    
CREATE Proc [dbo].[spx_GetEmpCode_Role_Capability]        
@SbTag varchar(10),        
@EmpCode varchar(15),        
@flgEmpRoleCap varchar(10),--Role or capability        
@flgEmp varchar(10) -- All or Empcode        
        
As        
        
        
if(@flgEmpRoleCap='Role')        
Begin        
        
 If(@flgEmp='ALL')        
 Begin        
  select Emp_No,Emp_No+'-'+Emp_Name as Name from tbl_Emp_Master mst1 where Sb_Tag=@SbTag        
  or exists (select sb_tag from  vw_ParentChildTagMapping v1 (nolock) where v1.parentTag =@SbTag and mst1.sb_tag=v1.sb_tag )       
  order by sb_tag,emp_no      
  select pid_tbl_Role_mst,Upper(Role_Name) as Role_Name,isnull(isdefaultselected,0) as selected from tbl_Role_Master        
 End        
 Else        
 Begin        
   --select Emp_No,Emp_No+'-'+Emp_Name as Name from tbl_Emp_Master where Emp_No=@EmpCode        
   select Fkid_tbl_Role_mst from tbl_Emp_Role where Emp_No=@EmpCode  
   union
   select '5' as Fkid_tbl_Role_mst from tbl_Emp_Role where  @EmpCode not in (select Emp_no from tbl_Emp_Role)        
 End        
End         
Else        
Begin        
        
 If(@flgEmp='ALL')        
 Begin        
  select Emp_No,Emp_No+'-'+Emp_Name as Name from tbl_Emp_Master mst1 where Sb_Tag=@SbTag        
   or exists (select sb_tag from  vw_ParentChildTagMapping v1 (nolock) where v1.parentTag =@SbTag and mst1.sb_tag=v1.sb_tag)      
   order by sb_tag,emp_no       
  select pid_tbl_Capability_mst,Upper(Capability_Name) Capability_Name,isnull(isdefaultselected,0) as selected  
   from tbl_Capability_Master        
 End        
 Else        
 Begin        
   --select Emp_No,Emp_No+'-'+Emp_Name as Name from tbl_Emp_Master where Emp_No=@EmpCode        
   select Fkid_tbl_Capability_mst from tbl_Emp_Capability where Emp_No=@EmpCode
   union
   select '5' as Fkid_tbl_Role_mst from tbl_Emp_Role where  @EmpCode not in (select Emp_no from tbl_Emp_Role)        
 End        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_GetSbContact
-- --------------------------------------------------
CREATE Proc [dbo].[spx_GetSbContact]      
@SbTag varchar(10)      
     
As      
      
    
  select Pid,Landline_No from tbl_SbContact_Detail mst1 where Sb_Tag=@SbTag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_Import_FromExcel
-- --------------------------------------------------


--exec [spx_Import_FromExcel] 'Sheet1','\\196.1.115.140\d$\Ehrms\Online_test_new\Imported\Test_New.xlsx','Yes','upload_online_test','.xls'        

        

CREATE PROCEDURE [dbo].[spx_Import_FromExcel]                                  

    @SheetName varchar(20),                                        

    @FilePath varchar(300),                                        

    @HDR varchar(3),                                        

    @TableName varchar(200),                                        

 @Extension varchar(10)                                                

AS                                        

                                        

BEGIN                                        

 DECLARE @SQL nvarchar(1000)                                        

                   

            

  IF OBJECT_ID (@TableName,'U') IS NOT NULL                                        

  BEGIN                                        

  SET @SQL = 'DROP TABLE ' + @TableName --to delete from temp table                                        

  EXEC sp_executesql @SQL                                        

  END            

                

  exec [MIS\sqlexpress].xlsupload.dbo.spx_Import_FromExcel   @SheetName , @FilePath ,@HDR , @TableName , @Extension             

  set @SQL='select * into '+@TableName +' from  [MIS\sqlexpress].xlsupload.dbo.' +@TableName            

  exec(@SQL)                                    

                              

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_increment_master_insert_update
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Spx_increment_master_insert_update]
(
	@Emp_No varchar(20),
	@Old_Salary varchar(20),
	@New_Salary varchar(20),
	@Date_effective varchar(20),
	@User_id varchar(30),
	@Ip varchar(20)
	
)
AS 
DECLARE @count int,@count_pid  int

SELECT @count=count(*) FROM tbl_Emp_Salary_Increment WHERE Emp_No=@Emp_No
SELECT @count_pid=count(*) FROM tbl_Emp_Salary_Increment
IF(@count=0)
BEGIN
	INSERT INTO tbl_Emp_Salary_Increment(pid_tbl_Emp_Salary_Increment,Emp_No,Old_Salary, New_Salary,
	            Dt_Effective, User_Id, IP)VALUES(@count_pid+1,@Emp_No,@Old_Salary,@New_Salary,@Date_effective,@User_id,@ip)
END

ELSE
	
BEGIN
	INSERT INTO log_Emp_Salary_Increment SELECT * FROM tbl_Emp_Salary_Increment WHERE Emp_No=@Emp_No
	
		UPDATE tbl_Emp_Salary_Increment SET Old_Salary = @Old_Salary,New_Salary = @New_Salary,Dt_Effective = @Date_effective 
		,User_Id = @User_id,Dt_Updation = getdate(),IP = @ip WHERE Emp_No=@Emp_No
		
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_role_compabilty_insert_update
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Spx_role_compabilty_insert_update]
(
	@Type varchar(30),
	@desc varchar(300),
	@User_id varchar(20),
	@ip varchar(20),
	@Name varchar(30),
	@pid varchar(max)
	
	)

AS
DECLARE @count int,@count_pid  int
IF(@Type='Role')
BEGIN


SELECT @count=count(*) FROM tbl_Role_Master WHERE pid_tbl_Role_mst=@pid
SELECT @count_pid=count(*) FROM tbl_Role_Master
IF(@count=0)
BEGIN
	
	INSERT INTO tbl_Role_Master(pid_tbl_Role_mst,Role_Desc,IP, Created_date,
	            Role_Name,User_Id)VALUES(@count_pid+1,@desc,@ip,getdate(),@name,@User_id)
END
ELSE
	BEGIN
		UPDATE tbl_Role_Master SET Role_Desc = @desc,User_Id = @User_id,Dt_Updation =getdate(),IP = @ip,Role_Name = @Name WHERE pid_tbl_Role_mst=@pid
	END	
END
ELSE IF(@Type='Compabilty')
BEGIN
	


SELECT @count=count(*) FROM tbl_Capability_Master WHERE pid_tbl_Capability_mst=@pid
SELECT @count_pid=count(*) FROM tbl_Capability_Master
IF(@count=0)
BEGIN
	
	INSERT INTO tbl_Capability_Master(pid_tbl_Capability_mst,Capability_Desc,IP, Created_date,
	            Capability_Name,User_Id)VALUES(@count_pid+1,@desc,@ip,getdate(),@name,@User_id)
END
ELSE
	BEGIN
		UPDATE tbl_Capability_Master SET Capability_Desc = @desc,User_Id = @User_id,Dt_Updation =getdate(),IP = @ip,Capability_Name = @Name WHERE pid_tbl_Capability_mst=@pid
	END	
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_role_insert_update
-- --------------------------------------------------
/*      
 Created By : Ramesh Shukla      
 Creted On :  03 Mar 2012  
 Updated By : Vikram Ukani   
 Last Ukdated On : 16 march 2012      
 Desc : To Insert  or Update Records in Role master Table      
 Exec : Spx_role_insert_update 1, 'TestRole','TestRole','Admin','0.0.0.0' ,1    
       
*/        
CREATE PROCEDURE [dbo].[Spx_role_insert_update]        
(        
       
 @pid int=0,      
 @Name varchar(30),      
 @desc varchar(300),      
 @User_id varchar(20),        
 @ip varchar(20) ,     
 @defaultSelected bit    
         
 )        
        
AS       
  DECLARE @count int,@count_pid  int        
begin        
      
        
        
 SELECT @count=count(*) FROM tbl_Role_Master WHERE pid_tbl_Role_mst=@pid        
 SELECT @count_pid=max(pid_tbl_Role_mst)+1 FROM tbl_Role_Master        
 IF(@count=0)        
 BEGIN        
          
   INSERT INTO tbl_Role_Master(pid_tbl_Role_mst,Role_Desc,isDefaultSelected,IP, Created_date,        
     Role_Name,User_Id)VALUES(@count_pid,@desc,@defaultSelected,@ip,getdate(),@name,@User_id)        
       
     /*Assign Role To all employees in case of default role */  
    
  if(isnull(@DefaultSelected,0)!=0)  
   Exec prc_AssignRemove_Default_RoleCapability_AllEmp @roleid=@count_pid,@userid=@user_id,@ip=@ip,@removeDefault=0  
       
       
 END        
 ELSE        
 BEGIN        
      
   INSERT INTO log_Role_master (pid_tbl_Role_mst,Role_Desc,User_Id,Dt_Updation,IP,Created_date,Role_Name    
           ,ApplyRule_ClientMaping_Suspension,isDefaultselected,Log_UpdationDate)     
   SELECT pid_tbl_Role_mst,Role_Desc,User_Id,Dt_Updation,IP,Created_date,Role_Name,ApplyRule_ClientMaping_Suspension,IsDefaultSelected ,getdate()    
   FROM tbl_Role_Master  WHERE pid_tbl_Role_mst=@pid    
         
   UPDATE tbl_Role_Master SET Role_Desc = @desc,isDefaultSelected=@defaultSelected,    
        User_Id = @User_id,Dt_Updation =getdate(),IP = @ip,Role_Name = @Name       
   WHERE pid_tbl_Role_mst=@pid        
     
   if(isnull(@DefaultSelected,0)=0)  
   Exec prc_AssignRemove_Default_RoleCapability_AllEmp @roleid=@pid,@userid=@user_id,@ip=@ip,@removeDefault=1  
   else  
   Exec prc_AssignRemove_Default_RoleCapability_AllEmp @roleid=@pid,@userid=@user_id,@ip=@ip,@removeDefault=0  
   
     
 END         
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_Sb_harmony_insert_update
-- --------------------------------------------------
  
                                
CREATE PROCEDURE [dbo].[Spx_Sb_harmony_insert_update]                                
                                
                                
(                              
 @emp_no varchar(20),                                
 @sbtag varchar(30),                                
 @first_name varchar(40),                                
 @second_name varchar(40),                                
 @last_name varchar(40),                                
 @Emp_name varchar(50),                                
 @address1 varchar(300),                                
 @address2 varchar(300),                                
 @city varchar(50),                                
 @State varchar(30),                                
 @pincode varchar(20),                                
 @mobile varchar(20),                                
 @emil_id varchar(70),                                
 @activariondate varchar(20),                                
 @suspensiondate varchar(20),                                
 @terminationdate varchar(20),                                
 @salary varchar(20),                                
 @ip varchar(30)                              
 ,@Username varchar(20)                       
 ,@LandLine varchar(20)                      
                                 
                                 
)                                
AS                  
 declare @PassWord varchar(8)              
               
begin      
              
  set nocount on      
                
  Declare @Message varchar(500)   
                                   
  IF @activariondate<>''                                                                  
  BEGIN                                                                  
  set @activariondate=convert(varchar(10),convert(datetime,ltrim(rtrim(@activariondate)),103),6)                                                        
  END                                                                   
  ELSE                                                                  
  BEGIN                                                                  
 SET @activariondate=null                                                                  
    END                                
  IF @suspensiondate<>''                                                                  
  BEGIN                                                                  
    set @suspensiondate=convert(varchar(10),convert(datetime,ltrim(rtrim(@suspensiondate)),103),6)                                                        
  END                                                                   
  ELSE                                                                  
  BEGIN                                                                  
 SET @suspensiondate=null                                                                  
  END                                
  IF @terminationdate<>''                                                                  
  BEGIN                                                                  
    set @terminationdate=convert(varchar(10),convert(datetime,ltrim(rtrim(@terminationdate)),103),6)                                                        
  END                                                                   
  ELSE                                                                  
  BEGIN                                                                  
 SET @terminationdate=null                                                                  
  END                                            
    
  DECLARE @count AS int                              
                               
  SELECT @count=count(*) FROM tbl_Emp_Master WHERE Emp_No=isnull(@emp_no,'')                                
                   
  IF(@count=0)                                
  BEGIN                                
                       
  /*Generate Auto password*/                    
  Exec  prc_GenerateSystemPassword @Password out              
                 
  DECLARE @sbtagcount int                                
  --SELECT @sbtagcount=count(sb_tag)+1 FROM tbl_Emp_Master WHERE Sb_Tag=@sbtag     
  SELECT @sbtagcount=max(cast(RIGHT(emp_no,3) as int))+1 FROM tbl_Emp_Master WHERE Sb_Tag=@sbtag      
                                 
                                   
  DECLARE @emp_no_new AS varchar(20)                                
                                   
  SET @emp_no_new=@sbtag+right('000'+cast(@sbtagcount AS varchar(10)),3)                                
                                   
  INSERT INTO tbl_Emp_Master(emp_no,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,Address2,City,State,Pincode,                                
  Mobile,Email,Dt_ActiveFrom,Salary,User_ID,Password,IP,Created_date,LandLine)VALUES(@emp_no_new,@sbtag,@first_name,                                
  @second_name,@last_name,@Emp_name,'','',@city,@State,@pincode,'','',@activariondate                                
    ,@salary,@emp_no_new,@Password,@ip,getdate(),@LandLine)                              
                               
    --IF @suspensiondate<>''      
    --begin                             
  insert into tbl_Emp_Suspension_Termination                             
  (sb_tag,emp_no,suspension_Date ,SuspendedBy,SuspensionEntry_Date,Termination_Date,TerminatedBy,TerminationEntry_Date)                            
  VALUES(@sbtag, @emp_no_new                                
  ,@suspensiondate,@Username,getdate(),@terminationdate,@Username,Getdate())              
    --end                 
                               
    --select sb_tag,emp_no,dt_suspension ,'Admin',Getdate(),dt_Termination,'Admin',Getdate() from tbl_emp_master                            
                      
  set @Message='Employee has been created successfully..\nEmployee Code : '+@emp_no_new                    
  select @message                        
  /************Assign roles to New employee, which are allocated to all employees by default**************/                          
  exec prc_AssignDefault_RoleCapability @emp_no_new,'Default Role',@ip   
      
  exec spx_AssignRoleToEmployee '5',@emp_no_new,'',@ip                       
                  
                  
  /*Send mail of Password and UserId*/                  
  Exec  prc_SendMail_Password  @Emp_no=@Emp_no_new ,@Emp_Name=@Emp_name,@to=@emil_id,@password=@Password              
                          
  END                                
  ELSE                                
  BEGIN                
 declare @isClientMapped bit    
           
 IF (@terminationdate<>'' or @suspensiondate<>'')            
 begin            
  Exec prc_isClientMappedUnderEmployee @Emp_no,@isClientMapped out            
 end             
              
 if(isnull(@isClientMapped,0)<>1)            
 begin                           
  INSERT INTO log_Emp_Master (Emp_No,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,Address2,City,State                              
  ,Pincode,Mobile,Email,Dt_ActiveFrom,Salary,User_ID,Password,Dt_Updation,                              
  IP,Created_date,Log_UpdationDate,LandLine)                              
  SELECT Emp_No,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,Address2,City,State                              
  ,Pincode,Mobile,Email,Dt_ActiveFrom,Salary,User_ID,Password,Dt_Updation,IP,                              
  Created_date,getdate(),@LandLine FROM tbl_Emp_Master WHERE Emp_No=@emp_no                               
                                    
                                    
  INSERT INTO log_Emp_Suspension_Termination(sb_tag,emp_no,suspension_Date ,SuspendedBy,SuspensionEntry_Date,Termination_Date,TerminatedBy,TerminationEntry_Date,Log_Updation_date)                            
  SELECT sb_tag,emp_no,suspension_Date ,SuspendedBy,SuspensionEntry_Date,Termination_Date,TerminatedBy,TerminationEntry_Date,getdate() FROM tbl_Emp_Suspension_Termination  WHERE Emp_no=@emp_no                             
                                   
                                   
                                   
  UPDATE tbl_Emp_Master SET First_Name=@first_name,Middle_Name = @second_name,Last_Name = @last_name,Emp_Name=@Emp_name                                
  ,City = @city,State = @State,Pincode = @pincode                               
  ,Dt_ActiveFrom = @activariondate,LandLine=@LandLine                                
  ,Salary = @salary,Dt_Updation = getdate(),ip=@ip WHERE Emp_No=@emp_no                             
           
  --IF @suspensiondate<>''      
  --BEGIN                            
  UPDATE tbl_Emp_Suspension_Termination SET sb_tag=@sbtag,Emp_no = @emp_no,SuspendedBy = @Username,Suspension_Date = @suspensiondate,                            
  SuspensionEntry_Date = getdate(),Termination_Date = @terminationdate ,TerminationEntry_Date = getdate() WHERE Emp_no=@emp_no        
   
  /************Added by Dayanand On 24 May 2017 Suggested by bg sir*********************/  
   
  update angelusers set  BOUserFirstName=h.First_Name,BOUserLastName=h.Last_Name,BOUserName=h.Emp_Name  
  from  b2b_angelharmony h with(nolock),angelusers a with(nolock)  
  where a.HarmonyEmployeeCode=h.Emp_No  
  and h.Emp_No=@emp_no  
  
  /************************************************************************************/  
   
                       
  --END                            
  set @Message='Record has been updated successfully..\nEmployee Code : '+@emp_no                      
             
 end            
 else            
    set @Message='Suspension/Termination for this dealer - ('+@emp_no+') is not possible as clients are mapped to him. \nKindly, shift all the clients to some other dealer. '                      
             
                            
     select @message                               
  END                   
                    
end  

/*-https://angelbrokingpl.atlassian.net/browse/SRE-42152*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_Sb_harmony_insert_update_26Nov2025
-- --------------------------------------------------
  
                                
CREATE PROCEDURE [dbo].[Spx_Sb_harmony_insert_update_26Nov2025]                                
                                
                                
(                              
 @emp_no varchar(20),                                
 @sbtag varchar(30),                                
 @first_name varchar(40),                                
 @second_name varchar(40),                                
 @last_name varchar(40),                                
 @Emp_name varchar(50),                                
 @address1 varchar(300),                                
 @address2 varchar(300),                                
 @city varchar(50),                                
 @State varchar(30),                                
 @pincode varchar(20),                                
 @mobile varchar(20),                                
 @emil_id varchar(70),                                
 @activariondate varchar(20),                                
 @suspensiondate varchar(20),                                
 @terminationdate varchar(20),                                
 @salary varchar(20),                                
 @ip varchar(30)                              
 ,@Username varchar(20)                       
 ,@LandLine varchar(20)                      
                                 
                                 
)                                
AS                  
 declare @PassWord varchar(8)              
               
begin      
              
  set nocount on      
                
  Declare @Message varchar(500)   
                                   
  IF @activariondate<>''                                                                  
  BEGIN                                                                  
  set @activariondate=convert(varchar(10),convert(datetime,ltrim(rtrim(@activariondate)),103),6)                                                        
  END                                                                   
  ELSE                                                                  
  BEGIN                                                                  
 SET @activariondate=null                                                                  
    END                                
  IF @suspensiondate<>''                                                                  
  BEGIN                                                                  
    set @suspensiondate=convert(varchar(10),convert(datetime,ltrim(rtrim(@suspensiondate)),103),6)                                                        
  END                                                                   
  ELSE                                                                  
  BEGIN                                                                  
 SET @suspensiondate=null                                                                  
  END                                
  IF @terminationdate<>''                                                                  
  BEGIN                                                                  
    set @terminationdate=convert(varchar(10),convert(datetime,ltrim(rtrim(@terminationdate)),103),6)                                                        
  END                                                                   
  ELSE                                                                  
  BEGIN                                                                  
 SET @terminationdate=null                                                                  
  END                                            
    
  DECLARE @count AS int                              
                               
  SELECT @count=count(*) FROM tbl_Emp_Master WHERE Emp_No=isnull(@emp_no,'')                                
                   
  IF(@count=0)                                
  BEGIN                                
                       
  /*Generate Auto password*/                    
  Exec  prc_GenerateSystemPassword @Password out              
                 
  DECLARE @sbtagcount int                                
  --SELECT @sbtagcount=count(sb_tag)+1 FROM tbl_Emp_Master WHERE Sb_Tag=@sbtag     
  SELECT @sbtagcount=max(cast(RIGHT(emp_no,3) as int))+1 FROM tbl_Emp_Master WHERE Sb_Tag=@sbtag      
                                 
                                   
  DECLARE @emp_no_new AS varchar(20)                                
                                   
  SET @emp_no_new=@sbtag+right('000'+cast(@sbtagcount AS varchar(10)),3)                                
                                   
  INSERT INTO tbl_Emp_Master(emp_no,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,Address2,City,State,Pincode,                                
  Mobile,Email,Dt_ActiveFrom,Salary,User_ID,Password,IP,Created_date,LandLine)VALUES(@emp_no_new,@sbtag,@first_name,                                
  @second_name,@last_name,@Emp_name,@address1,@address2,@city,@State,@pincode,@mobile,@emil_id,@activariondate                                
    ,@salary,@emp_no_new,@Password,@ip,getdate(),@LandLine)                              
                               
    --IF @suspensiondate<>''      
    --begin                             
  insert into tbl_Emp_Suspension_Termination                             
  (sb_tag,emp_no,suspension_Date ,SuspendedBy,SuspensionEntry_Date,Termination_Date,TerminatedBy,TerminationEntry_Date)                            
  VALUES(@sbtag, @emp_no_new                                
  ,@suspensiondate,@Username,getdate(),@terminationdate,@Username,Getdate())              
    --end                 
                               
    --select sb_tag,emp_no,dt_suspension ,'Admin',Getdate(),dt_Termination,'Admin',Getdate() from tbl_emp_master                            
                      
  set @Message='Employee has been created successfully..\nEmployee Code : '+@emp_no_new                    
  select @message                        
  /************Assign roles to New employee, which are allocated to all employees by default**************/                          
  exec prc_AssignDefault_RoleCapability @emp_no_new,'Default Role',@ip   
      
  exec spx_AssignRoleToEmployee '5',@emp_no_new,'',@ip                       
                  
                  
  /*Send mail of Password and UserId*/                  
  Exec  prc_SendMail_Password  @Emp_no=@Emp_no_new ,@Emp_Name=@Emp_name,@to=@emil_id,@password=@Password              
                          
  END                                
  ELSE                                
  BEGIN                
 declare @isClientMapped bit    
           
 IF (@terminationdate<>'' or @suspensiondate<>'')            
 begin            
  Exec prc_isClientMappedUnderEmployee @Emp_no,@isClientMapped out            
 end             
              
 if(isnull(@isClientMapped,0)<>1)            
 begin                           
  INSERT INTO log_Emp_Master (Emp_No,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,Address2,City,State                              
  ,Pincode,Mobile,Email,Dt_ActiveFrom,Salary,User_ID,Password,Dt_Updation,                              
  IP,Created_date,Log_UpdationDate,LandLine)                              
  SELECT Emp_No,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,Address2,City,State                              
  ,Pincode,Mobile,Email,Dt_ActiveFrom,Salary,User_ID,Password,Dt_Updation,IP,                              
  Created_date,getdate(),@LandLine FROM tbl_Emp_Master WHERE Emp_No=@emp_no                               
                                    
                                    
  INSERT INTO log_Emp_Suspension_Termination(sb_tag,emp_no,suspension_Date ,SuspendedBy,SuspensionEntry_Date,Termination_Date,TerminatedBy,TerminationEntry_Date,Log_Updation_date)                            
  SELECT sb_tag,emp_no,suspension_Date ,SuspendedBy,SuspensionEntry_Date,Termination_Date,TerminatedBy,TerminationEntry_Date,getdate() FROM tbl_Emp_Suspension_Termination  WHERE Emp_no=@emp_no                             
                                   
                                   
                                   
  UPDATE tbl_Emp_Master SET First_Name=@first_name,Middle_Name = @second_name,Last_Name = @last_name,Emp_Name=@Emp_name                                
  ,Address1 = @address1,Address2 = @address2,City = @city,State = @State,Pincode = @pincode,Mobile = @mobile                                
  ,Email = @emil_id,Dt_ActiveFrom = @activariondate,LandLine=@LandLine                                
  ,Salary = @salary,Dt_Updation = getdate(),ip=@ip WHERE Emp_No=@emp_no                             
           
  --IF @suspensiondate<>''      
  --BEGIN                            
  UPDATE tbl_Emp_Suspension_Termination SET sb_tag=@sbtag,Emp_no = @emp_no,SuspendedBy = @Username,Suspension_Date = @suspensiondate,                            
  SuspensionEntry_Date = getdate(),Termination_Date = @terminationdate ,TerminationEntry_Date = getdate() WHERE Emp_no=@emp_no        
   
  /************Added by Dayanand On 24 May 2017 Suggested by bg sir*********************/  
   
  update angelusers set  BOUserFirstName=h.First_Name,BOUserLastName=h.Last_Name,BOUserName=h.Emp_Name  
  from  b2b_angelharmony h with(nolock),angelusers a with(nolock)  
  where a.HarmonyEmployeeCode=h.Emp_No  
  and h.Emp_No=@emp_no  
  
  /************************************************************************************/  
   
                       
  --END                            
  set @Message='Record has been updated successfully..\nEmployee Code : '+@emp_no                      
             
 end            
 else            
    set @Message='Suspension/Termination for this dealer - ('+@emp_no+') is not possible as clients are mapped to him. \nKindly, shift all the clients to some other dealer. '                      
             
                            
     select @message                               
  END                   
                    
end  

/*-https://angelbrokingpl.atlassian.net/browse/SRE-42152*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_Sb_harmony_insert_update_bkp24May2017
-- --------------------------------------------------

                              
CREATE PROCEDURE [dbo].[Spx_Sb_harmony_insert_update_bkp24May2017]                              
                              
                              
(                            
 @emp_no varchar(20),                              
 @sbtag varchar(30),                              
 @first_name varchar(40),                              
 @second_name varchar(40),                              
 @last_name varchar(40),                              
 @Emp_name varchar(50),                              
 @address1 varchar(300),                              
 @address2 varchar(300),                              
 @city varchar(50),                              
 @State varchar(30),                              
 @pincode varchar(20),                              
 @mobile varchar(20),                              
 @emil_id varchar(70),                              
 @activariondate varchar(20),                              
 @suspensiondate varchar(20),                              
 @terminationdate varchar(20),                              
 @salary varchar(20),                              
 @ip varchar(30)                            
 ,@Username varchar(20)                     
 ,@LandLine varchar(20)                    
                               
                               
)                              
AS                
 declare @PassWord varchar(8)            
             
begin                
  set nocount on                
  Declare @Message varchar(500)                                
  IF @activariondate<>''                                                                
   BEGIN                                                                
    set @activariondate=convert(varchar(10),convert(datetime,ltrim(rtrim(@activariondate)),103),6)                                                      
   END                                                                 
   ELSE                                                                
    BEGIN                                                                
  SET @activariondate=null                                                                
    END                              
    IF @suspensiondate<>''                                                                
   BEGIN                                                                
    set @suspensiondate=convert(varchar(10),convert(datetime,ltrim(rtrim(@suspensiondate)),103),6)                                                      
   END                                                                 
   ELSE                                                                
    BEGIN                                                                
  SET @suspensiondate=null                                                                
    END                              
    IF @terminationdate<>''                                                                
   BEGIN                                                                
    set @terminationdate=convert(varchar(10),convert(datetime,ltrim(rtrim(@terminationdate)),103),6)                                                      
   END                                                                 
   ELSE                                                                
    BEGIN                                                                
  SET @terminationdate=null                                                                
   END                                          
  DECLARE @count AS int                            
                             
  SELECT @count=count(*) FROM tbl_Emp_Master WHERE Emp_No=isnull(@emp_no,'')                              
                 
  IF(@count=0)                              
  BEGIN                              
                     
   /*Generate Auto password*/                  
  Exec  prc_GenerateSystemPassword @Password out            
               
   DECLARE @sbtagcount int                              
   --SELECT @sbtagcount=count(sb_tag)+1 FROM tbl_Emp_Master WHERE Sb_Tag=@sbtag   
   SELECT @sbtagcount=max(cast(RIGHT(emp_no,3) as int))+1 FROM tbl_Emp_Master WHERE Sb_Tag=@sbtag    
                               
                                 
   DECLARE @emp_no_new AS varchar(20)                              
                                 
   SET @emp_no_new=@sbtag+right('000'+cast(@sbtagcount AS varchar(10)),3)                              
                                 
   INSERT INTO tbl_Emp_Master(emp_no,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,Address2,City,State,Pincode,                              
   Mobile,Email,Dt_ActiveFrom,Salary,User_ID,Password,IP,Created_date,LandLine)VALUES(@emp_no_new,@sbtag,@first_name,                              
   @second_name,@last_name,@Emp_name,@address1,@address2,@city,@State,@pincode,@mobile,@emil_id,@activariondate                              
   ,@salary,@emp_no_new,@Password,@ip,getdate(),@LandLine)                            
                             
   --IF @suspensiondate<>''    
   --begin                           
    insert into tbl_Emp_Suspension_Termination                           
    (sb_tag,emp_no,suspension_Date ,SuspendedBy,SuspensionEntry_Date,Termination_Date,TerminatedBy,TerminationEntry_Date)                          
    VALUES(@sbtag, @emp_no_new                              
    ,@suspensiondate,@Username,getdate(),@terminationdate,@Username,Getdate())            
   --end               
                             
   --select sb_tag,emp_no,dt_suspension ,'Admin',Getdate(),dt_Termination,'Admin',Getdate() from tbl_emp_master                          
                    
    set @Message='Employee has been created successfully..\nEmployee Code : '+@emp_no_new                  
    select @message                      
    /************Assign roles to New employee, which are allocated to all employees by default**************/                        
    exec prc_AssignDefault_RoleCapability @emp_no_new,'Default Role',@ip 
    
    exec spx_AssignRoleToEmployee '5',@emp_no_new,'',@ip                     
                
                
    /*Send mail of Password and UserId*/                
    Exec  prc_SendMail_Password  @Emp_no=@Emp_no_new ,@Emp_Name=@Emp_name,@to=@emil_id,@password=@Password            
                        
  END                              
  ELSE                              
  BEGIN              
 declare @isClientMapped bit          
 IF (@terminationdate<>'' or @suspensiondate<>'')          
 begin          
  Exec prc_isClientMappedUnderEmployee @Emp_no,@isClientMapped out          
 end           
            
 if(isnull(@isClientMapped,0)<>1)          
 begin                         
    INSERT INTO log_Emp_Master (Emp_No,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,Address2,City,State                            
    ,Pincode,Mobile,Email,Dt_ActiveFrom,Salary,User_ID,Password,Dt_Updation,                            
    IP,Created_date,Log_UpdationDate,LandLine)                            
    SELECT Emp_No,Sb_Tag,First_Name,Middle_Name,Last_Name,Emp_Name,Address1,Address2,City,State                            
  ,Pincode,Mobile,Email,Dt_ActiveFrom,Salary,User_ID,Password,Dt_Updation,IP,                            
  Created_date,getdate(),@LandLine FROM tbl_Emp_Master WHERE Emp_No=@emp_no                             
                                  
                                  
    INSERT INTO log_Emp_Suspension_Termination(sb_tag,emp_no,suspension_Date ,SuspendedBy,SuspensionEntry_Date,Termination_Date,TerminatedBy,TerminationEntry_Date,Log_Updation_date)                          
    SELECT sb_tag,emp_no,suspension_Date ,SuspendedBy,SuspensionEntry_Date,Termination_Date,TerminatedBy,TerminationEntry_Date,getdate() FROM tbl_Emp_Suspension_Termination  WHERE Emp_no=@emp_no                           
                                 
                                 
                                 
    UPDATE tbl_Emp_Master SET First_Name=@first_name,Middle_Name = @second_name,Last_Name = @last_name,Emp_Name=@Emp_name                              
    ,Address1 = @address1,Address2 = @address2,City = @city,State = @State,Pincode = @pincode,Mobile = @mobile                              
    ,Email = @emil_id,Dt_ActiveFrom = @activariondate,LandLine=@LandLine                              
    ,Salary = @salary,Dt_Updation = getdate(),ip=@ip WHERE Emp_No=@emp_no                           
         
    --IF @suspensiondate<>''    
    --BEGIN                          
    UPDATE tbl_Emp_Suspension_Termination SET sb_tag=@sbtag,Emp_no = @emp_no,SuspendedBy = @Username,Suspension_Date = @suspensiondate,                          
    SuspensionEntry_Date = getdate(),Termination_Date = @terminationdate ,TerminationEntry_Date = getdate() WHERE Emp_no=@emp_no                          
    --END                          
    set @Message='Record has been updated successfully..\nEmployee Code : '+@emp_no                    
           
 end          
 else          
    set @Message='Suspension/Termination for this dealer - ('+@emp_no+') is not possible as clients are mapped to him. \nKindly, shift all the clients to some other dealer. '                    
           
                          
     select @message                             
  END                 
                  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spx_SbContact_Detail
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Spx_SbContact_Detail]
(
@SbTag varchar(20),
@LandlineNo varchar(20),
@MobileNo varchar(20),
@EmailId varchar(max)	

)
AS
 
 
 INSERT INTO tbl_SbContact_Detail(Sb_Tag, Landline_No, Mobile_No, Email_Add)
 VALUES(@SbTag,@LandlineNo,@MobileNo,@EmailId)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_SendAutoMail
-- --------------------------------------------------
--select * from tbl_Emp_Master
--select * from tbl_Temp_UserIdEmail

CREATE Proc spx_SendAutoMail
As

Declare @Emp_no varchar (70),@Emp_Name varchar(300),@password varchar(20)
Declare @To varchar(max),@cc varchar(max)=null,@BCC varchar(max)=null  
Declare @MinId int ,@MaxId int

set @MinId=0
set @MaxId=0

Create Table #tempAuto(id int primary key identity(1,1),UserId varchar(15),Email varchar(150))

insert into #tempAuto(UserId,Email)
select top 1 UserId,Email from tbl_Temp_UserIdEmail

Select @MinId=MIN(Id),@MaxId=MAX(Id) from #tempAuto

While(@MinId<=@MaxId)
Begin
	select @Emp_no=UserId,@To=Email from #tempAuto where id=@MinId
    select @Emp_Name=Emp_Name,@password=Password from  tbl_Emp_Master where Emp_No=@Emp_no
 
 	Exec [prc_SendMail_Password_Auto] @Emp_no,@Emp_Name,@password,'Rakesh.sharma@angelbroking.com','','kamlesh.salgaonkar@angelbroking.com' 


set @MinId=@MinId+1
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_SendAutoMail_Utility
-- --------------------------------------------------
--select * from tbl_Emp_Master  
--select * from tbl_Temp_UserIdEmail where UserId='  
  
CREATE Proc [dbo].[spx_SendAutoMail_Utility]  
As  
  
Declare @Emp_no varchar (70),@Emp_Name varchar(300),@password varchar(20)  
Declare @To varchar(max),@cc varchar(max)=null,@BCC varchar(max)=null    
Declare @MinId int ,@MaxId int  
  
set @MinId=0  
set @MaxId=0  
  
Create Table #tempAuto(id int primary key identity(1,1),UserId varchar(15),Email varchar(150),PassWord varchar(50))  
  
insert into #tempAuto(UserId,Email,PassWord)  
select UserId,EmailID,NewPassword from tbl_Temp_UserIdEmail --where UserId='HJK001'  
  
  
Select @MinId=MIN(Id),@MaxId=MAX(Id) from #tempAuto  
  
While(@MinId<=@MaxId)  
Begin  
  
  
 select @Emp_no=UserId,@To=Email,@password=Password from #tempAuto where id=@MinId  
  
    update tbl_Emp_Master set PassWord=@password where Emp_No=@Emp_no  
    select @Emp_Name=Emp_Name,@password=Password from  tbl_Emp_Master where Emp_No=@Emp_no  
   
  Exec [prc_SendMail_Password_Auto] @Emp_no,@Emp_Name,@password,@To,'',''   
  
  
set @MinId=@MinId+1  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_UpdateLastSalary
-- --------------------------------------------------
CREATE Proc [dbo].[spx_UpdateLastSalary]      
As      
      
      
--select * into #tempSal from(      
--select Emp_No,max(Dt_Updation)as maxDate,MAX(New_Salary) as lastSal  from log_Emp_Salary_Increment group by emp_No)a      
      
insert into tbl_Emp_Salary_Increment_Dashboard(Emp_No,maxDate,LastSalary,[Year],[Month])    
select Emp_No,Dt_Updation as maxDate,New_Salary as lastSal,    
YEAR(GETDATE()),    
MONTH(GETDATE())  
from tbl_Emp_Salary_Increment 

  


select Emp_No,GETDATE() as maxDate ,Salary,YEAR(GETDATE()) as [Year],MONTH(GETDATE()) as [Month] into #tempInc from tbl_Emp_MASTER 
where Emp_No not in (select emp_no from tbl_Emp_Salary_Increment where Emp_No not like '%001') and Emp_No not like '%001' and isSuspended='0' and isTerminated='0'

insert into tbl_Emp_Salary_Increment_Dashboard(Emp_No,maxDate,LastSalary,[Year],[Month])    
select Emp_No,maxDate,Salary,[Year],[Month] from #tempInc 
where Emp_no+convert(varchar(20),[Year])+convert(varchar(20),[Month]) not in (select Emp_no+[Year]+[Month] from tbl_Emp_Salary_Increment_Dashboard)



  
--group by emp_No    
  
  
--select Emp_No,max(Dt_Updation)as maxDate,max(New_Salary) as lastSal,    
--case when Month(Getdate())=1 then YEAR(GETDATE())-1 else YEAR(GETDATE())end,    
--Case when Month(Getdate())=1 then 12 else MONTH(GETDATE())-1 end      
--from log_Emp_Salary_Increment   
--group by emp_No    
      
    
    
----insert into tbl_Emp_Salary_Increment_Dashboard(Emp_No,[Year],[Month],LastSalary)      
----select Emp_No,case when Month(Getdate())=1 then YEAR(GETDATE())-1 else YEAR(GETDATE())end,    
----Case when Month(Getdate())=1 then 12 else MONTH(GETDATE())-1 end,lastSal     
----from #tempSal      
--select * from tbl_Emp_Salary_Increment_Dashboard  
      
--  truncate table tbl_Emp_Salary_Increment_Dashboard

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_UploadUidEmailCRMS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[spx_UploadUidEmailCRMS]           
(   @SheetName varchar(20) ,            
    @FilePath varchar(100),            
    @HDR varchar(3),            
    @TableName varchar(50),            
    @Extension varchar(10),          
    @userId varchar(10)            
)            
AS            
BEGIN       
     
 DECLARE @SQL nvarchar(1000)            
 DECLARE @COUNT_BEF AS INT            
 DECLARE @COUNT_AFT AS INT 
 DECLARE @Random INT
 DECLARE @Upper INT
 DECLARE @Lower INT
          
	SET @Lower = 1 ---- The lowest random number
   SET @Upper = 48 ---- The highest random number
           
            
 set @COUNT_BEF = 0            
 set @COUNT_AFT = 0            
 set @SheetName='Sheet1$'            
 set @HDR='YES'            
 set @TableName='tbl_Temp_UserIdEmail'            
            
insert into  tbl_Temp_UserIdEmail_log       
select *, GETDATE() as UploadDate  from tbl_Temp_UserIdEmail      
            
EXEC [spx_Import_FromExcel] @SheetName,@FilePath,'YES',@TableName, @extension           
          
      
      
      
Declare @Emp_no varchar (70),@Emp_Name varchar(300),@password varchar(20)      
Declare @To varchar(max),@cc varchar(max)=null,@BCC varchar(max)=null        
Declare @MinId int ,@MaxId int      
      
set @MinId=0      
set @MaxId=0      
      
Create Table #tempAuto(id int primary key identity(1,1),UserId varchar(15),Email varchar(150),PassWord varchar(20))      
      
insert into #tempAuto(UserId,Email)      
select UserId,EmailID from tbl_Temp_UserIdEmail --where UserId='HJK001'      
      
   
      
Select @MinId=MIN(Id),@MaxId=MAX(Id) from #tempAuto      
      
While(@MinId<=@MaxId)      
Begin      
      
      
	 select @Emp_no=UserId,@To=Email  from #tempAuto where id=@MinId      
	 SELECT @Random = ROUND(((@Upper - @Lower -1) * RAND() + @Lower), 0)

	 select @password=Pass from tbl_CRMSRandomPassword where ID=@Random      
 
 
	update tbl_Emp_Master set PassWord=@password where Emp_No=@Emp_no      
	select @Emp_Name=Emp_Name,@password=Password from  tbl_Emp_Master where Emp_No=@Emp_no      
       
	Exec [prc_SendMail_Password_Auto] @Emp_no,@Emp_Name,@password,@To,'',''       
	set @password=''
	set @Random=0     
	set @MinId=@MinId+1      
End      
           
           
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_UploadUidEmailCRMS_New
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[spx_UploadUidEmailCRMS_New]           
(   @SheetName varchar(20) ,            
    @FilePath varchar(100),            
    @HDR varchar(3),            
    @TableName varchar(50),            
    @Extension varchar(10),          
    @userId varchar(10)            
)            
AS            
BEGIN       
     
 DECLARE @SQL nvarchar(1000)            
 DECLARE @COUNT_BEF AS INT            
 DECLARE @COUNT_AFT AS INT 
 DECLARE @Random INT
 DECLARE @Upper INT
 DECLARE @Lower INT
          
	SET @Lower = 1 ---- The lowest random number
   SET @Upper = 48 ---- The highest random number
           
            
 set @COUNT_BEF = 0            
 set @COUNT_AFT = 0            
 set @SheetName='Sheet1$'            
 set @HDR='YES'            
 set @TableName='tbl_Temp_UserIdEmail'            
            
insert into  tbl_Temp_UserIdEmail_log       
select *, GETDATE() as UploadDate  from tbl_Temp_UserIdEmail      
            
EXEC [spx_Import_FromExcel] @SheetName,@FilePath,'YES',@TableName, @extension           
          
      
      
      
Declare @Emp_no varchar (70),@Emp_Name varchar(300),@password varchar(20)      
Declare @To varchar(max),@cc varchar(max)=null,@BCC varchar(max)=null        
Declare @MinId int ,@MaxId int      
      
set @MinId=0      
set @MaxId=0      
      
Create Table #tempAuto(id int primary key identity(1,1),UserId varchar(15),Email varchar(150),PassWord varchar(20))      
      
insert into #tempAuto(UserId,Email)      
select UserId,EmailID from tbl_Temp_UserIdEmail --where UserId='HJK001'      
      
   
      
Select @MinId=MIN(Id),@MaxId=MAX(Id) from #tempAuto      
      
While(@MinId<=@MaxId)      
Begin      
      
      
	 select @Emp_no=UserId,@To=Email  from #tempAuto where id=@MinId      
	 SELECT @Random = ROUND(((@Upper - @Lower -1) * RAND() + @Lower), 0)

	 select @password=Pass from tbl_CRMSRandomPassword where ID=@Random      
 
 
	update tbl_Emp_Master set PassWord=@password where Emp_No=@Emp_no      
	select @Emp_Name=Emp_Name,@password=Password from  tbl_Emp_Master where Emp_No=@Emp_no      
       
	Exec [prc_SendMail_Password_Auto] @Emp_no,@Emp_Name,@password,@To,'',''       
	set @password=''
	set @Random=0     
	set @MinId=@MinId+1      
End      
           
           
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.test_rto_op
-- --------------------------------------------------
CREATE procedure [dbo].[test_rto_op]
as
begin

select 'Report is in process. Please wait for few minutes.'      
return 
			---exec MIMANSA.CRM.dbo.[GetTurnoverfortime_newfo] 
			exec MIMANSA.CRM.dbo.[GetTurnoverfortime_new] 
			--exec MIMANSA.CRM.dbo.GetTurnoverfortime_new_Target
			@Emp_no='ET001',
			@Zone='',
			@Region='',
			@Branch='ET',
			@Exec='',
			@FromTime='09:00 AM',
			@ToTime='11:59 PM',
			@MainDrill='MAIN',
			@WiseReport='SBDEALER',
			@seg='ALL',
			@B2CStatus='B2B',
			@MimStatusID='SUBBROKER',
			@SB='',
			@RoundValue='1',
			@DownloadCSVFlag='Y'

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UP_CommonPartyServices
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[UP_CommonPartyServices]    
WITH RECOMPILE    
AS    
BEGIN    
/*    
Case 1: Entry for New Clients    
Case 2: Entry for Inactive Client    
Case 3: Entry for Reactivated Clients & B2B To B2C  Shifting    
Case 4: Entry for Resigned Executive    
Case 5: Clients who shifted to Calnt branch     
  Case a) CLIENTS WHO HAVE BEEN SHIFTED INTO CALNT    
  Case b) CLIENTS WHO HAVE BEEN SHIFTED OUT OF CALNT    
Case 6: B2CToB2B shifting    
Case 7: BI Branch Mapping on 1st of month or Party branch change    
Case 8: Employee Transferred    
case 9: Entry for Next Day Dealer Mapping    
*/    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 SET NOCOUNT ON;    
  
 /* Variable declaration for Error Handling routine */    
 DECLARE @@Errorcount int                                                                                 
 SET @@Errorcount = 0         
 /* *********************************************** */  
   
 -- Handle rollback if any error occurs so that there will be consistency in tables for data    
 BEGIN TRANSACTION        
                                        
 /************************************************* Case 1: Entry for New Clients   ***************************** */       
     
 -- RAM Table for New client process to make the process faster.    
/* Declare @NewParty table    
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20)    
 )  
 */
 --Using has table because the data is very huge (4 lk and over) and while using table variable it was taking huhe time to delete all those records. 
  create table  #NewParty     
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10),        
 )     
     
 -- preparing the base table where all new Equity clients taken from backoffice or AngelClient1 table as on today    
 --insert into @NewParty                                                                   
  insert into #NewParty
 select distinct                                                                                           
 party_code = ltrim(rtrim(A.party_code)),                                                                                          
 emp_no = b.emp_no,                                                                                          
 fromdate = convert(datetime, left(convert(varchar, A.ActiveFrom, 109), 11) + ' 00:00:00'),                                                                                          
 todate = 'Dec 31 2049 23:59:00',                                                                                          
 entrydate = GETDATE(),                                                                                          
 valid = 'Y',     
 CommRank = 1,                                                         
 Remarks = 'UPCommonPartyServices - INSERT - NEW CLIENT',                                                                                     
 Branch_cd= A.Sub_Broker,                                                                                      
 dealerbranch_cd= A.Sub_Broker,       
 --Segment_Type = 'Equity'                                                               
 Segment_Type = 'ALL',
 parentSb=ISNULL(parenttag,'N.A.')      
 from AngelClient1 A with (nolock)  inner join B2B_AngelHarmony b with (nolock)  on a.SUB_Broker=b.SB_Tag,
 MIS.sb_comp.dbo.sb_broker sbmain with (nolock)                                                      
 WHERE a.B2C = 'N'                                                                         
 and a.CL_type <> 'SUB' and
a.InActiveFrom >= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')                                                                          
 and a.ActiveFrom <= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')   and     
a.InactiveFrom > a.ActiveFrom  and b.isadmin=1
and A.Sub_Broker=sbmain.sbtag


 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd        
 

 -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty filled by Commodity')                             
 
     
 -- We are removing the clients which are already mapped    
 
                              
 /*Delete @NewParty     
 from crm.dbo.B2B_CommonPartyServices P with (nolock), @NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type    
 */
    
  Delete #NewParty     
 from B2B_CommonPartyServices P with (nolock), #NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type  

  

 --Error handling                                           
 
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd       

  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - removed duplicate')       

 -- We are removing the 98 clients from temp                                             
 Delete from #NewParty                                                            
 where Party_code like '98%'
                                                                                         
 --Error handling                                           
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd
  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - delete 98 clients')                                 
        
     
 -- removing the Currency clients which can be mapped from offline table on same day   
 /*delete #NewParty     
 from #NewParty T, B2B_CommonPartyServices_Offline C with (nolock)                                               
 where T.Party_code = C.Party_code                                                
 And to_be_processed = 'Y' and T.Segment_Type=C.Segment_Type                                                 
*/

 -- removing the Currency clients from the offline table which can be mapped on same day
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from #NewParty c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'  

 --Error handling                                                                                
 set @@Errorcount = @@error                                                                  
 If @@Errorcount <> 0 Goto LabelEnd        

 
 -- Temp Commented Ankur 
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'removed Currency clients who mapped today')       
 -- Inserting the validated New clients in Partyservices                                                  


 insert into B2B_CommonPartyServices     
 Select   party_code, emp_no, fromdate, todate, entrydate, valid, CommRank, Remarks, Branch_cd, dealerbranch_cd, Segment_Type ,parentSb   
 From #NewParty                                                                          

                                             
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                     
                                 
                                                       
 -- Temp Commented Ankur --insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','New Client Entry DONE')                                                                                        
         
 /************************************************ New Client Process End ***************************************  */    


/********************************************** Case 2: Entry for Inactive Client  **************************** */    
   
-- Temp Commented Ankur -- insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process for Closed Client START')     
     
 -- RAM Table to process the closed clients from AngelClient1 table.    

 /*********Commented by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients***********/
 /*
 Declare @CloseParty table    
 (    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)           
 )           

 -- preparing the base table to process the Closed Equity clients     
 insert into @CloseParty                                                                                      
 select distinct                                                                     
 party_code = ltrim(rtrim(c1.party_code)),                                                                       
 emp_no = b.Emp_No,--'UNDEFINED',                      
 fromdate = convert(datetime, left( convert( varchar, c1.inactivefrom, 109 ), 11 ) + ' 00:00:00'),                                                                                         
 todate = convert(datetime, left( convert( varchar, c1.inactivefrom, 109 ), 11 ) + ' 23:59:00'),                                                                                          
 entrydate = getdate(),                          
 valid = 'N',     
 CommRank=1,                                                                                        
 Remarks = 'UPCommonPartyServices - INSERT - CLOSED CLIENT',                                                                                        
 --branch_cd=c1.branch_cd,              
 branch_cd=c1.Sub_Broker,                                                                           
 dealerbranch=c1.Sub_Broker,    
-- Segment_Type = 'Equity'                                                                                           
Segment_Type = 'All',
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                            
 from AngelClient1 c1 with (nolock), B2B_CommonPartyServices p with (nolock)   ,B2B_AngelHarmony b with (nolock)
 --B2B_AngelHarmony b with (nolock)  on a.SUB_Broker=b.SB_Tag                                                                                   
 where ltrim(rtrim(p.party_code)) = ltrim(rtrim(c1.party_code))
 and    ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) 
 and b.IsAdmin=1                                                                             
 and c1.b2c = 'N'                                                                                        
 and c1.cl_type <> 'SUB'                                                    
 and p.valid = 'Y' and --P.Segment_Type = 'Equity'                                                            
 P.Segment_Type = 'ALL' 
 and p.todate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and activefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 00:00:00'                                                     
 and inactivefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and left(convert(varchar, activefrom, 109), 11) <> left(convert(varchar, inactivefrom, 109), 11)    

                                 
 --Error handling                                                                     
 set @@Errorcount = @@error                                                                          
 If @@Errorcount <> 0 Goto LabelEnd         
     
    
 -- updating the previous entry to close the mapping of Closed Clients                                                         
 update B2B_CommonPartyServices                                                                                 
 set todate = left(convert(varchar, dateadd(dd, -1, c.fromdate), 109), 11) + ' 23:59:00',                                                                                   
 valid = 'N',                                                                                
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLOSED CLIENT'                                                                                 
 from @CloseParty c, B2B_CommonPartyServices P with (nolock)                                                                                
 where c.Party_Code = P.Party_Code                                                                                
 and P.Valid = 'Y'     
 and P.Segment_Type = c.Segment_Type and P.CommRank = c.CommRank    
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                  
                  
                        
 -- Error handling                                                                    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                      
 

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','CommonPartyServices Updated For Closed Client')                         
                         
 -- to prevent the Closed client mapping  on the same day need to implement on UI level in Equity, commodity and currency                                              
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from @CloseParty c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'                           
                                 
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd       
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Update offline Currency entry for closed')                         
    
 -- insert the closed entry of undefined for equity, commodity and currency    
 insert into B2B_CommonPartyServices                                      
 Select Party_Code,                  
 Emp_No,                                        
 FromDate,                                        
 ToDate,                      
 EntryDate,                                        
 Valid,      
 CommRank,                                      
 Remarks,                                        
 branch_cd,                         
 Dealerbranch,    
 Segment_Type,
 parentSb                                                 
 from @CloseParty                                           
                             
--Error handling                                    
 set @@Errorcount = @@error                                                                                         
 If @@Errorcount <> 0 Goto LabelEnd     
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Closed client entry done.')                         
 */
 /*********EndCommented by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients***********/
    
 /**************************************** Inactive Client Process End ******************************************  */ 
 
  /* ***************************************** Case 3: Entry for Reactivated Clients & B2C To B2B  Shifting ************************** */    

insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process for Reactivation of Clients START')                                                                             
                           
                                              
 /* RAM Table to handle Reactivated Clients */    
 
 
 Declare @ReactivatedClients table    
 (    
  --ServiceID bigint,    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)          
 )    
    
 /* First inserts the Equity Reactivated Clients who are closed in Partyservices but active in AngelClient1 table */    

 /*
 -- Commented: SBAN
 insert into @ReactivatedClients                                                                         
 select distinct     
 party_code = c1.party_code,                                                                 
 emp_no =b.Emp_No,-- 'UNDEFINED',      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                   
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',       
 CommRank = 1,                                                                             
 Remarks = 'UPCommonPartyServices - INSERT - REACTIVATED CLIENT',                                                                                  
 branch_cd=c1.Sub_Broker,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type,
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                      
  from AngelClient1 c1  with (nolock), B2B_CommonPartyServices p  with(nolock)       ,B2B_AngelHarmony b with (nolock)                                                                          
 where c1.B2C = 'N' 
 and --Segment_Type = 'Equity' 
 Segment_Type = 'ALL' 
 and p.valid='N'                                                              
 and cl_type <> 'SUB' and c1.party_code = p.party_code    and ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) 
 and   b.IsAdmin=1                                                             
 and c1.InactiveFrom >  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 and c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') 
 --and c1.InactiveFromEq >=  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 --and c1.ActiveFromEq<= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                          
 --and p.Emp_no = 'UNDEFINED'                         
  --   and p.Emp_no =b.Emp_No       
 */
 
 -- NEW CODE FOR REPLACEMENT - START : SBAN

 insert into @ReactivatedClients
(party_code,  emp_no,  fromdate,  todate, entrydate,  valid ,  CommRank ,  Remarks , branch_cd ,  dealerbranch , Segment_Type )   -- REMOVED parentSB column from main insert

select distinct    
 party_code = c1.party_code,                                                                
 emp_no =b.Emp_No,-- 'UNDEFINED',      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                  
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',      
 CommRank = 1,                                                                            
 Remarks = 'UPCommonPartyServices - INSERT - REACTIVATED CLIENT',                                                                                  
 branch_cd=c1.Sub_Broker,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type
 --, parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)            -- removed from main insert                                                                            
  from AngelClient1 c1  with (nolock), B2B_CommonPartyServices p  with(nolock)       , B2B_AngelHarmony b with (nolock)                                                                          
 where c1.B2C = 'N'
 and --Segment_Type = 'Equity'
 Segment_Type = 'ALL'
 and p.valid='N'                                                              
 and cl_type <> 'SUB' and c1.party_code = p.party_code    and ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag))
 and   b.IsAdmin=1                                                            
 and c1.InactiveFrom >  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 and c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')
 --and c1.InactiveFromEq >=  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 --and c1.ActiveFromEq<= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                          
 --and p.Emp_no = 'UNDEFINED'                        
  --   and p.Emp_no =b.Emp_No  


-- BELOW UPDATE STATEMENT WILL UPDATE THE parentSB field
-- This statement is taken from function dbo.B2bCrms_ParentSb

UPDATE t SET parentSB = isnull(sb.parenttag,'N.A') FROM @ReactivatedClients t
inner join B2B_AngelHarmony ah with(nolock) on t.emp_no=ah.emp_no
inner join MIS.sb_comp.dbo.sb_broker sb WITH (nolock) on upper(ah.sb_tag) = sb.sbtag

-- NEW CODE FOR REPLACEMENT - END : SBAN


 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                               
                                                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','temp table filled with equity')            
  
  --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd        
     
 /* Delete the Current mapping if exists in partyservices for reactivated entry */    
 delete 
	@ReactivatedClients 
 from 
	@ReactivatedClients b, B2B_CommonPartyServices PS with(nolock)    
 where 
	PS.party_code=b.party_code 
	and PS.valid='Y'     
	and b.Segment_Type=PS.Segment_Type   
	
 -- removing the ReactivatedClients clients from the offline table which can be mapped on same day
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from @ReactivatedClients c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'  	              
                     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
   
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','deleted all unwanted entries')          
        
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients and Reactivated Clients    
-------------------------------------------------------     
 insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @ReactivatedClients    
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                                                                           

                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Reactivated Clients Entry DONE')                                                                                  
     
   /**************************************** Reactivated Client Process End ******************************************  */       
   
 
  /* *****************************************Case 4: Sub Broker Shift of Client ****************************************   */    
 Declare @SBShift table    
 (    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)        
 )    
    
 /* First inserts the Equity Reactivated Clients who are closed in Partyservices but active in AngelClient1 table */    
 insert into @SBShift                                                                         
 select distinct     
 party_code = c1.party_code,                                                                 
 emp_no =b.Emp_No,-- 'UNDEFINED' -- Assigns A Admin Dealer Of SubBroker,      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                   
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',       
 CommRank = 1,                                                                             
 Remarks = 'UPCommonPartyServices - INSERT - SUBBROKER SHIFTED CLIENT',                                                                                  
 branch_cd=c1.Sub_Broker,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type,
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                       
 from 
	AngelClient1 c1  with (nolock), 
	B2B_CommonPartyServices p  with(nolock),
	B2B_AngelHarmony b with (nolock)                                                                          
 where 
	c1.B2C = 'N' and 
	Segment_Type = 'ALL' and 
	p.valid='Y' and 
	cl_type <> 'SUB' and 
	c1.party_code = p.party_code and 
	ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) and   
	ltrim(rtrim(c1.SUB_Broker))<>p.Branch_cd and
	b.IsAdmin=1 and                                    
    c1.InactiveFrom >  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') and                                       
    c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') 
 
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                               
                                                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Temp Table FIlled with the Clients') 
 
  -- removing the SB Shifted clients from the offline table which can be mapped on same day
 Update 
	B2B_CommonPartyServices_Offline                                                
 Set 
	to_be_processed = 'N'                                                
 from 
	@SBShift c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where 
	c.Party_Code = t.Party_code and 
	to_be_processed = 'Y'  
	
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','deleted all unwanted entries')
 
  -- updating the previous entry to close the mapping of Closed Clients                                                         
 update B2B_CommonPartyServices                                                                                 
 set todate = left(convert(varchar, dateadd(dd, -1, c.fromdate), 109), 11) + ' 23:59:00',                                                                                   
 valid = 'N',                                                                                
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - SB SHIFT CLIENT'                                                                                 
 from @SBShift c, B2B_CommonPartyServices P with (nolock)                                                                                
 where c.Party_Code = P.Party_Code                                                                                
 and P.Valid = 'Y'     
 and P.Segment_Type = c.Segment_Type and P.CommRank = c.CommRank    
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                  
                  
                        
 -- Error handling                                                                    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                      
 

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','CommonPartyServices Updated For Closed Client')   
 
 -------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients and Reactivated Clients    
-------------------------------------------------------     
 insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @SBShift    
 
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                                                                           

                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','SB Shifting Clients Entry DONE')   		 
 
 --select * from @SBShift	
   
       
   /* *****************************************Case 4: Entry for Resigned Executive ****************************************   */    
   /* if any client mapped to dealer and that dealer has resigned, then after 30 days the client should moved to undefined */    
       /*
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process Start for Resigned Dealer')                                                      
                                    
 /* RAM Table to handle Reactivated Clients */    
 Declare @ResignedDealer table    
 (    
  party_code varchar(10),    
  emp_no varchar(10),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20)         
 )    
    
 /* inserts all the equity, commodity and currency clients who has resigned dealer mapped currently in one temp table */    
 insert into @ResignedDealer    
 select distinct party_code = ltrim(rtrim(c1.party_code)),                                                                      
 emp_no = 'UNDEFINED',                                                                      
 fromdate = LEFT(convert (varchar, dateadd(dd, +31, A.InActiveFrom), 109 ), 11 ) + ' 00:00:00',                                                  
 todate = 'Dec 31 2049 23:59:00',                                           
 entrydate = getdate(),                                                                      
 valid = 'Y',      
 CommRank,                                                                   
 Remarks = 'UPCommonPartyServices - INSERT - CLIENT WITH RESIGNED EMPLOYEE',                                                                    
 branch_cd=c1.branch_cd,                                                                  
 dealerbranch=c1.branch_cd,    
 Segment_Type                                                        
 from B2B_Harmony A with (noLock), B2B_CommonPartyServices c1 with(nolock)                                                                    
 where A.Status <> 'A'                                                             
 and A.EmpCode  = c1.Emp_No                                                            
 and A.InActiveFrom  <= left( convert( varchar, dateadd(dd, -30, getdate()), 109 ), 11 ) + ' 23:59:00'                                                          
 and Valid = 'Y'    
                             
 --Error handling                                                   
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                    
                             
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'table for Resigned Executive DONE')                               
    
 /* update or close the previous mapping */    
 update B2B_CommonPartyServices                                                             
 set todate =  left(convert(varchar, dateadd(dd, -1, R.FromDate), 109), 11) + ' 23:59:00',                                                           
 valid = 'N',                                                            
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLIENT WITH RESIGNED DEALER'                                                             
 from @ResignedDealer R, B2B_CommonPartyServices P with (nolock)                                                           
 where R.Party_Code = P.Party_Code                                                     
 and P.Valid = 'Y'                                                             
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'    
 and P.Segment_Type = R.Segment_Type    
 and P.CommRank = R.CommRank                                                             
       
       
       
       
       
       
       
 -- Error handling                                                            
 set @@Errorcount = @@error                                                             
 If @@Errorcount <> 0 Goto LabelEnd                                                             
                                    
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','PartyServices Update for Resigned Executive DONE')                                                                 
     
     
     
 -- we are preventing the resigned executives to be mapped to the Currency clients                                      
 Update B2B_CommonPartyServices_Offline                     
 Set to_be_processed = 'N'                                   
 from @ResignedDealer R, B2B_CommonPartyServices_Offline O with (nolock)                                                
 where R.Party_Code = O.Party_code                                                   
 and to_be_processed = 'Y'                                                       
                             
 --Error handling                   
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                  
                                 
 insert into B2B_CommonPartyServices     
 Select Party_Code,                                        
   Emp_No,                                        
   FromDate,                                        
   ToDate,                                     
   EntryDate,                                        
   Valid,    
   CommRank,                                        
   Remarks,                                        
   branch_cd,                                        
   dealerbranch,    
   Segment_Type    
 From @ResignedDealer                                                                
                                    
 -- Error handling                                                            
 set @@Errorcount = @@error                                                             
 If @@Errorcount <> 0 Goto LabelEnd                       
                                    
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Entry done for Resigned Dealer')                                                                    
          
          
          */
   /**************************************** Resigned Dealer Process End ******************************************  */        
  
  /************************************************** Case 6: B2BToB2C shifting**********************************   */
-------------------------------------------------------    
 --Craete RAM Table for B2CToB2B shifting    
 -------------------------------------------------------    
 Declare @B2BToB2CParty table      
 (      
  party_code varchar(10),      
  emp_no varchar(20),      
  fromdate smalldatetime,      
  todate smalldatetime,      
  entrydate smalldatetime,      
  valid char(1),      
  CommRank int,      
  Remarks varchar(5000),      
  branch_cd varchar(10),      
  dealerbranch varchar(10),      
  Segment_Type varchar(20),
  parentSB varchar(10)            
 )      
 
 
-------------------------------------------------------    
--Insert B2C to B2B shifted clients into RAM table    
-------------------------------------------------------     
insert into @B2BToB2CParty           
   select distinct party_code=ps.party_code,          
  emp_no = b.emp_no,--'UNDEFINED',          
  fromdate = left(getdate(),11 ) + ' 00:00',          
  todate = left(getdate(),11) + ' 23:59',          
  entrydate = getdate(),          
  valid = 'N',      
  CommRank=PS.CommRank ,       
  Remarks = 'UPCommonPartyServices - INSERT - B2BTOB2C SHIFTED CLIENT',          
  ---------------------Commnted by prasanna on Aug 27 2012 to map b2b sub broker after shifting b2b to b2c. 
  --branch_cd=a1.Sub_Broker,          
  --dealerbranch=a1.Sub_Broker,          
  --PS.Segment_Type,
  --parentSb=  dbo.B2bCrms_ParentSb (b.emp_no) 
  branch_cd=ps.branch_cd,          
  dealerbranch=ps.branch_cd,          
  PS.Segment_Type,
  parentSb=  dbo.B2bCrms_ParentSb (ps.emp_no)      
  from B2B_CommonPartyServices PS with(nolock) inner join AngelClient1 a1 with(nolock)
   on ps.party_code = a1.party_code      
   ,B2B_AngelHarmony b with (nolock)    
  where          
  PS.valid='Y'          
  and a1.b2c='Y'       
  and a1.SUB_Broker = b.SB_Tag  
  and b.IsAdmin=1  
  and b.SB_Tag<>'HYD1'-----------------------------Remove after Saturday
    and PS.Emp_No<>'HYD1001'-----------------------------Remove after Saturday
      
   -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','table filled for B2B to B2C shifting')                                                   
    
-------------------------------------------------------    
--Update for B2C to B2B shifted clients    
-------------------------------------------------------     
 update B2B_CommonPartyServices  set                                                                                 
  todate = left(dateadd(dd, -1, GETDATE()), 11) + ' 23:59',                                                                      
 valid = 'N',                                                                                  
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - B2BTOB2C SHIFTED CLIENT'                                                                                   
 from @B2BToB2CParty  c,B2B_CommonPartyServices P with (nolock)                                                                                  
 where c.Party_Code = P.Party_Code                                                                                  
 and P.Valid = 'Y'       
 and c.CommRank= P.CommRank    
 and P.Segment_Type = c.Segment_Type     
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'     
     
    -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','update for previous entry B2B to B2C shifting')                                                   
    
-----------------------------------------------------------    
--Update Offline table entry    
-----------------------------------------------------------    
  Update B2B_CommonPartyServices_Offline                                                  
 Set to_be_processed = 'N'                                                  
 from @B2BToB2CParty c, B2B_CommonPartyServices_Offline t with (nolock)                                                 
 where c.Party_Code = t.Party_code                                                     
 and to_be_processed = 'Y'  and c.Segment_Type=t.Segment_Type and c.commrank = t.commrank      
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients    
-------------------------------------------------------     
  insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @B2BToB2CParty      
     
    -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process end for B2C to B2B shifting')                                                   
    
-------------------------------------------------------    
--END B2C to B2B shifted clients    
-------------------------------------------------------          
 
     
 /******************************************** case 8: Entry for  Next Day Dealer Mapping ***********************  */
                                                                 
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Next Days Mapping Start')                                                           
    

 ---- Update the Common Partyservices entry from the Common Offline Table for current mapping of UI         
 update B2B_CommonPartyServices                                                                                         
 set valid = 'N',                                                                                      
 todate = left(convert(varchar, dateadd(dd, -1, o.from_date), 109), 11) + ' 23:59:00',                                                     
 Remarks = Remarks + ';' + 'OFFLINE - UPDATE'                                                                                    
 from B2B_CommonPartyServices_Offline o with (nolock), B2B_CommonPartyServices P with (nolock)                                       
 where ltrim(rtrim(P.party_code)) = ltrim(rtrim(o.party_code))                                                                                      
 and ltrim(rtrim(P.emp_no)) = ltrim(rtrim(o.source_dealer_code))                                                                         
 and P.valid = 'Y' and o.to_be_processed = 'Y' and P.Segment_Type = o.Segment_Type       
 and P.CommRank = o.CommRank  
 --Uncommnet while going live.....................................................                                                                                  
 --and o.entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'     
 
 
            
 -- Error handling                                                                            
 set @@Errorcount = @@error                                                              
 If @@Errorcount <> 0 Goto LabelEnd     
                          
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping updated')                                                                                

                                                                  
 insert into B2B_CommonPartyServices                                                                                     
 (                                                                                      
  party_code,                                                                                      
  emp_no,                                                         
  fromdate,                                                                         
  todate,                      
  entrydate,                                                                                      
  valid,     
  CommRank,                                                                                     
  Remarks,                                                                                      
  branch_cd,                                                                                    
  Dealerbranch,    
  Segment_Type,
  parentSb                                                  
 )                                                                          
 select distinct party_code = ltrim(rtrim(dm.party_code)),                                                                                      
 emp_no = ltrim(rtrim(dm.target_dealer_code)),                                                                                      
 fromdate = dm.from_date,                                     
 todate = dm.to_date,                                                                                      
 entrydate = getdate(),                                                                                      
 valid = 'Y',      
 CommRank,                                                                                    
 Remarks = 'UPCommonPartyServices - INSERT Offline Table Entry',                                                                             
 --branch_cd = (case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.SBTAg end),    --dm.branch_cd,                                                                        
 --Dealerbranch=(case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.SBTAg end),    
  branch_cd = dm.branch_cd,  --ah.Sb_Tag,                                                                       
 Dealerbranch=ah.Sb_Tag,    
 Segment_Type,
 parentSb=dbo.B2bCrms_ParentSb (ltrim(rtrim(dm.target_dealer_code)))                                                                                        
 from B2B_CommonPartyServices_Offline dm with(nolock),B2B_AngelHarmony ah with(nolock)                                               
 where to_be_processed = 'Y'   
 and LEN(source_dealer_code)>0 -- Added by prasanna to avoid duplicate record entry.                              
 and( dm.target_dealer_code=ah.Emp_No  or upper(dm.target_dealer_code)='UNDEFINED') --checking if client is getting mapped to undefined.
 --Uncommnet while going live..................................................... 
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'      
                                          
 -- Error handling                                                                                  
 set @@Errorcount = @@error                                                                                   
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                               
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping inserted')
 
                                                                           
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Update Start')                                                                                 
                                       
                                        
 --Below update is for prevention of multiple processing the processed entry of offline table  
 
 update B2B_CommonPartyServices_Offline                                                                                       
 set to_be_processed = 'N',                                                                                      
 process_time_stamp = getdate(), 
 Reason_For_Non_Process='Due To Unavailablity of Source Dealr Code',                                                              
 other_remarks =                                                                                      
 ltrim(rtrim(isnull(other_remarks, '')))                                                                                      
 +                                                                           
 case                                                                                      
 when                                                                                      
 len(ltrim(rtrim(isnull(other_remarks, '')))) > 0                                                                                      
 then                                                    
 ' - '                                                                                      
 else                                                                                      
 ''                                                                                      
 end                                                                        
 +                                                                                      
 'MAPPING UNSUCCESSFUL'                                                                                      
 where to_be_processed = 'Y'
  and LEN(source_dealer_code)=0 -- Added by prasanna to avoid duplicate record entry.                  
 
                                                       
 update B2B_CommonPartyServices_Offline                                                                                       
 set to_be_processed = 'N',                                                                                      
 process_time_stamp = getdate(),                                                               
 other_remarks =                                                                                      
 ltrim(rtrim(isnull(other_remarks, '')))                                                                                      
 +                                                                           
 case                                                                                      
 when                                                                                      
 len(ltrim(rtrim(isnull(other_remarks, '')))) > 0                                                                                      
 then                                                    
 ' - '                                                                                      
 else                                                                                      
 ''                                                                                      
 end                                                                        
 +                                                                                      
 'MAPPING SUCCESSFUL'                                                                                      
 where to_be_processed = 'Y'
 --Uncommnet while going live.....................................................                                  
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'                                                                                 
                                          
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                                  
 If @@Errorcount <> 0 Goto LabelEnd                                                        
                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Updated')                                                                    
                    
					
/*******Added by Anand on Dec 13 2021 ************************/

Declare @InactiveParty table    
 (    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)        
 )   

insert into @InactiveParty           
select distinct party_code = c1.party_code, emp_no =b.Emp_No, fromdate = left(GETDATE(), 11) + ' 00:00',                                                                                   
todate =  'Dec 31 2049 23:59:00', entrydate = getdate(), valid = 'Y', CommRank = 1,                                                                             
Remarks = 'UPCommonPartyServices - INSERT - InactiveClient',                                                                                  
branch_cd=c1.Sub_Broker, dealerbranch=c1.Sub_Broker, Segment_Type,
parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)   
from  AngelClient1 c1  with (nolock), B2B_CommonPartyServices p  with(nolock), B2B_AngelHarmony b with (nolock)                                                                          
where c1.B2C = 'N' and p.valid='Y' 
and c1.party_code = p.party_code 
and ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) 
and b.IsAdmin=1 
and c1.InactiveFrom < getdate()
and P.emp_no <> b.Emp_No

Update B2B_CommonPartyServices set valid = 'N', todate = convert(varchar(11), getdate()-1,109) + ' 23:59', 
Remarks = PS.Remarks + ';' + 'UPDATE - Inactive Party'   
from B2B_CommonPartyServices PS with(nolock), @InactiveParty T
where PS.Party_Code = T.party_code
and PS.valid='Y' 

insert into B2B_CommonPartyServices                                        
Select Party_Code, Emp_No, FromDate, ToDate, EntryDate,                                          
Valid, CommRank, Remarks, branch_cd, dealerbranch,  Segment_Type, parentSb                                                   
from @InactiveParty   

insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','UPDATE - Inactive Party')                                                                    
		
/*******End Added by Anand on Dec 13 2021 ************************/					
					
					
					              
                                                                
 --************************************************************** End of Dealer Mapping  **********************************        
 
    
                                                     
 LabelEnd:                                                      
 If @@Errorcount <> 0                                                                    
 begin                                                                  
  Rollback Transaction                                                                                
 end                                                                  
 Else           
 
                                                         
 begin                                                       
  Commit Transaction                                                     
 end          
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UP_CommonPartyServices_b2b
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[UP_CommonPartyServices_b2b]   
WITH RECOMPILE    
AS    
BEGIN    
/*    
Case 1: Entry for New Clients    
Case 2: Entry for Inactive Client    
Case 3: Entry for Reactivated Clients & B2B To B2C  Shifting    
Case 4: Entry for Resigned Executive    
Case 5: Clients who shifted to Calnt branch     
  Case a) CLIENTS WHO HAVE BEEN SHIFTED INTO CALNT    
  Case b) CLIENTS WHO HAVE BEEN SHIFTED OUT OF CALNT    
Case 6: B2CToB2B shifting    
Case 7: BI Branch Mapping on 1st of month or Party branch change    
Case 8: Employee Transferred    
case 9: Entry for Next Day Dealer Mapping    
*/    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 SET NOCOUNT ON;    
  
 /* Variable declaration for Error Handling routine */    
 DECLARE @@Errorcount int                                                                                 
 SET @@Errorcount = 0         
 /* *********************************************** */  
   
 -- Handle rollback if any error occurs so that there will be consistency in tables for data    
 BEGIN TRANSACTION        
                                        
 /************************************************* Case 1: Entry for New Clients   ***************************** */       
     
 -- RAM Table for New client process to make the process faster.    
/* Declare @NewParty table    
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20)    
 )  
 */
 --Using has table because the data is very huge (4 lk and over) and while using table variable it was taking huhe time to delete all those records. 
  create table  #NewParty     
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10),        
 )     
     
 -- preparing the base table where all new Equity clients taken from backoffice or AngelClient1 table as on today    
 --insert into @NewParty                                                                   
  insert into #NewParty
 select distinct                                                                                           
 party_code = ltrim(rtrim(A.party_code)),                                                                                          
 emp_no = b.emp_no,                                                                                          
 fromdate = convert(datetime, left(convert(varchar, A.ActiveFrom, 109), 11) + ' 00:00:00'),                                                                                          
 todate = 'Dec 31 2049 23:59:00',                                                                                          
 entrydate = GETDATE(),                                                                                          
 valid = 'Y',     
 CommRank = 1,                                                         
 Remarks = 'UPCommonPartyServices - INSERT - NEW CLIENT',                                                                                     
 Branch_cd= A.Sub_Broker,                                                                                      
 dealerbranch_cd= A.Sub_Broker,       
 --Segment_Type = 'Equity'                                                               
 Segment_Type = 'ALL',
 parentSb=ISNULL(parenttag,'N.A.')      
 from AngelClient1 A with (nolock)  inner join B2B_AngelHarmony b with (nolock)  on a.SUB_Broker=b.SB_Tag,
 MIS.sb_comp.dbo.sb_broker sbmain with (nolock)                                                      
 WHERE --a.B2C = 'N'                                                                         
  a.CL_type <> 'SUB' and
a.InActiveFrom >= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')                                                                          
 and a.ActiveFrom <= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')   and     
a.InactiveFrom > a.ActiveFrom  and b.isadmin=1
and A.Sub_Broker=sbmain.sbtag
and sub_broker='HYD1'


 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd        
 

 -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty filled by Commodity')                             
 
     
 -- We are removing the clients which are already mapped    
 
                              
 /*Delete @NewParty     
 from crm.dbo.B2B_CommonPartyServices P with (nolock), @NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type    
 */
    
  Delete #NewParty     
 from B2B_CommonPartyServices P with (nolock), #NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type  

  

 --Error handling                                           
 
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd       

  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - removed duplicate')       

 -- We are removing the 98 clients from temp                                             
 Delete from #NewParty                                                            
 where Party_code like '98%'
                                                                                         
 --Error handling                                           
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd
  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - delete 98 clients')                                 
        
     
 -- removing the Currency clients which can be mapped from offline table on same day   
 /*delete #NewParty     
 from #NewParty T, B2B_CommonPartyServices_Offline C with (nolock)                                               
 where T.Party_code = C.Party_code                                                
 And to_be_processed = 'Y' and T.Segment_Type=C.Segment_Type                                                 
*/

 -- removing the Currency clients from the offline table which can be mapped on same day
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from #NewParty c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'  

 --Error handling                                                                                
 set @@Errorcount = @@error                                                                  
 If @@Errorcount <> 0 Goto LabelEnd        

 
 -- Temp Commented Ankur 
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'removed Currency clients who mapped today')       
 -- Inserting the validated New clients in Partyservices                                                  


 insert into B2B_CommonPartyServices     
 Select   party_code, emp_no, fromdate, todate, entrydate, valid, CommRank, Remarks, Branch_cd, dealerbranch_cd, Segment_Type ,parentSb   
 From #NewParty                                                                          

                                             
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                     
                                 
                                                       
 -- Temp Commented Ankur --insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','New Client Entry DONE')                                                                                        
         
 /************************************************ New Client Process End ***************************************  */    


/********************************************** Case 2: Entry for Inactive Client  **************************** */    
   
-- Temp Commented Ankur -- insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process for Closed Client START')     
     
 -- RAM Table to process the closed clients from AngelClient1 table.    
 Declare @CloseParty table    
 (    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)           
 )           

 -- preparing the base table to process the Closed Equity clients     
 insert into @CloseParty                                                                                      
 select distinct                                                                     
 party_code = ltrim(rtrim(c1.party_code)),                                                                       
 emp_no = b.Emp_No,--'UNDEFINED',                      
 fromdate = convert(datetime, left( convert( varchar, c1.inactivefrom, 109 ), 11 ) + ' 00:00:00'),                                                                                         
 todate = convert(datetime, left( convert( varchar, c1.inactivefrom, 109 ), 11 ) + ' 23:59:00'),                                                                                          
 entrydate = getdate(),                          
 valid = 'N',     
 CommRank=1,                                                                                        
 Remarks = 'UPCommonPartyServices - INSERT - CLOSED CLIENT',                                                                                        
 --branch_cd=c1.branch_cd,              
 branch_cd=c1.Sub_Broker,                                                                           
 dealerbranch=c1.Sub_Broker,    
-- Segment_Type = 'Equity'                                                                                           
Segment_Type = 'All',
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                            
 from AngelClient1 c1 with (nolock), B2B_CommonPartyServices p with (nolock)   ,B2B_AngelHarmony b with (nolock)
 --B2B_AngelHarmony b with (nolock)  on a.SUB_Broker=b.SB_Tag                                                                                   
 where ltrim(rtrim(p.party_code)) = ltrim(rtrim(c1.party_code))
 and    ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) 
 and b.IsAdmin=1                                                                             
 --and c1.b2c = 'N'                                                                                        
 and c1.cl_type <> 'SUB'                                                    
 and p.valid = 'Y' and --P.Segment_Type = 'Equity'                                                            
 P.Segment_Type = 'ALL' 
 and p.todate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and activefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 00:00:00'                                                     
 and inactivefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and left(convert(varchar, activefrom, 109), 11) <> left(convert(varchar, inactivefrom, 109), 11) 
 and sub_broker='HYD1'   

                                 
 --Error handling                                                                     
 set @@Errorcount = @@error                                                                          
 If @@Errorcount <> 0 Goto LabelEnd         
     
    
 -- updating the previous entry to close the mapping of Closed Clients                                                         
 update B2B_CommonPartyServices                                                                                 
 set todate = left(convert(varchar, dateadd(dd, -1, c.fromdate), 109), 11) + ' 23:59:00',                                                                                   
 valid = 'N',                                                                                
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLOSED CLIENT'                                                                                 
 from @CloseParty c, B2B_CommonPartyServices P with (nolock)                                                                                
 where c.Party_Code = P.Party_Code                                                                                
 and P.Valid = 'Y'     
 and P.Segment_Type = c.Segment_Type and P.CommRank = c.CommRank    
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                  
                  
                        
 -- Error handling                                                                    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                      
 

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','CommonPartyServices Updated For Closed Client')                         
                         
 -- to prevent the Closed client mapping  on the same day need to implement on UI level in Equity, commodity and currency                                              
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from @CloseParty c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'                           
                                 
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd       
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Update offline Currency entry for closed')                         
    
 -- insert the closed entry of undefined for equity, commodity and currency    
 insert into B2B_CommonPartyServices                                      
 Select Party_Code,                  
 Emp_No,                                        
 FromDate,                                        
 ToDate,                      
 EntryDate,                                        
 Valid,      
 CommRank,                                      
 Remarks,                                        
 branch_cd,                         
 Dealerbranch,    
 Segment_Type,
 parentSb                                                 
 from @CloseParty                                           
                             
--Error handling                                    
 set @@Errorcount = @@error                                                                                         
 If @@Errorcount <> 0 Goto LabelEnd     
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Closed client entry done.')                         
     
 /**************************************** Inactive Client Process End ******************************************  */ 
 
  /* ***************************************** Case 3: Entry for Reactivated Clients & B2C To B2B  Shifting ************************** */    

insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process for Reactivation of Clients START')                                                                             
                           
                                              
 /* RAM Table to handle Reactivated Clients */    
 
 
 Declare @ReactivatedClients table    
 (    
  --ServiceID bigint,    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)          
 )    
    
 /* First inserts the Equity Reactivated Clients who are closed in Partyservices but active in AngelClient1 table */    
 insert into @ReactivatedClients                                                                         
 select distinct     
 party_code = c1.party_code,                                                                 
 emp_no =b.Emp_No,-- 'UNDEFINED',      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                   
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',       
 CommRank = 1,                                                                             
 Remarks = 'UPCommonPartyServices - INSERT - REACTIVATED CLIENT',                                                                                  
 branch_cd=c1.Sub_Broker,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type,
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                      
  from AngelClient1 c1  with (nolock), B2B_CommonPartyServices p  with(nolock)       ,B2B_AngelHarmony b with (nolock)                                                                          
 where --c1.B2C = 'N' 
  --Segment_Type = 'Equity' 
 Segment_Type = 'ALL' 
 and p.valid='N'                                                              
 and cl_type <> 'SUB' and c1.party_code = p.party_code    and ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) 
 and   b.IsAdmin=1                                                             
 and c1.InactiveFrom >  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 and c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') 
 and sub_broker='HYD1'
 --and c1.InactiveFromEq >=  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 --and c1.ActiveFromEq<= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                          
 --and p.Emp_no = 'UNDEFINED'                         
  --   and p.Emp_no =b.Emp_No       
     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                               
                                                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','temp table filled with equity')            
  
  --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd        
     
 /* Delete the Current mapping if exists in partyservices for reactivated entry */    
 delete 
	@ReactivatedClients 
 from 
	@ReactivatedClients b, B2B_CommonPartyServices PS with(nolock)    
 where 
	PS.party_code=b.party_code 
	and PS.valid='Y'     
	and b.Segment_Type=PS.Segment_Type   
	
 -- removing the ReactivatedClients clients from the offline table which can be mapped on same day
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from @ReactivatedClients c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'  	              
                     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
   
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','deleted all unwanted entries')          
        
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients and Reactivated Clients    
-------------------------------------------------------     
 insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @ReactivatedClients    
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                                                                           

                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Reactivated Clients Entry DONE')                                                                                  
     
   /**************************************** Reactivated Client Process End ******************************************  */       
   
 
  /* *****************************************Case 4: Sub Broker Shift of Client ****************************************   */    
 Declare @SBShift table    
 (    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)        
 )    
    
 /* First inserts the Equity Reactivated Clients who are closed in Partyservices but active in AngelClient1 table */    
 insert into @SBShift                                                                         
 select distinct     
 party_code = c1.party_code,                                                                 
 emp_no =b.Emp_No,-- 'UNDEFINED' -- Assigns A Admin Dealer Of SubBroker,      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                   
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',       
 CommRank = 1,                                                                             
 Remarks = 'UPCommonPartyServices - INSERT - SUBBROKER SHIFTED CLIENT',                                                                                  
 branch_cd=c1.Sub_Broker,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type,
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                       
 from 
	AngelClient1 c1  with (nolock), 
	B2B_CommonPartyServices p  with(nolock),
	B2B_AngelHarmony b with (nolock)                                                                          
 where 
	--c1.B2C = 'N' and 
	Segment_Type = 'ALL' and 
	p.valid='Y' and 
	cl_type <> 'SUB' and 
	c1.party_code = p.party_code and 
	ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) and   
	ltrim(rtrim(c1.SUB_Broker))<>p.Branch_cd and
	b.IsAdmin=1 and                                    
    c1.InactiveFrom >  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') and                                       
    c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') 
    and sub_broker='HYD1'
 
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                               
                                                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Temp Table FIlled with the Clients') 
 
  -- removing the SB Shifted clients from the offline table which can be mapped on same day
 Update 
	B2B_CommonPartyServices_Offline                                                
 Set 
	to_be_processed = 'N'                                                
 from 
	@SBShift c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where 
	c.Party_Code = t.Party_code and 
	to_be_processed = 'Y'  
	
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','deleted all unwanted entries')
 
  -- updating the previous entry to close the mapping of Closed Clients                                                         
 update B2B_CommonPartyServices                                                                                 
 set todate = left(convert(varchar, dateadd(dd, -1, c.fromdate), 109), 11) + ' 23:59:00',                                                                                   
 valid = 'N',                                                                                
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - SB SHIFT CLIENT'                                                                                 
 from @SBShift c, B2B_CommonPartyServices P with (nolock)                                                                                
 where c.Party_Code = P.Party_Code                                                                                
 and P.Valid = 'Y'     
 and P.Segment_Type = c.Segment_Type and P.CommRank = c.CommRank    
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                  
                  
                        
 -- Error handling                                                                    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                      
 

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','CommonPartyServices Updated For Closed Client')   
 
 -------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients and Reactivated Clients    
-------------------------------------------------------     
 insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @SBShift    
 
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                                                                           

                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','SB Shifting Clients Entry DONE')   		 
 
 
  
  
 
 
    
 
     
 /******************************************** case 8: Entry for  Next Day Dealer Mapping ***********************  */
                                                                 
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Next Days Mapping Start')                                                           
    

 ---- Update the Common Partyservices entry from the Common Offline Table for current mapping of UI         
 update B2B_CommonPartyServices                                                                                         
 set valid = 'N',                                                                                      
 todate = left(convert(varchar, dateadd(dd, -1, o.from_date), 109), 11) + ' 23:59:00',                                                     
 Remarks = Remarks + ';' + 'OFFLINE - UPDATE'                                                                                    
 from B2B_CommonPartyServices_Offline o with (nolock), B2B_CommonPartyServices P with (nolock)                                       
 where ltrim(rtrim(P.party_code)) = ltrim(rtrim(o.party_code))                                                                                      
 and ltrim(rtrim(P.emp_no)) = ltrim(rtrim(o.source_dealer_code))                                                                         
 and P.valid = 'Y' and o.to_be_processed = 'Y' and P.Segment_Type = o.Segment_Type       
 and P.CommRank = o.CommRank  
 --Uncommnet while going live.....................................................                                                                                  
 --and o.entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'     
 
 
            
 -- Error handling                                                                            
 set @@Errorcount = @@error                                                              
 If @@Errorcount <> 0 Goto LabelEnd     
                          
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping updated')                                                                                

                                                                  
 insert into B2B_CommonPartyServices                                                                                     
 (                                                                                      
  party_code,                                                                                      
  emp_no,                                                         
  fromdate,                                                                         
  todate,                      
  entrydate,                                                                                      
  valid,     
  CommRank,                                                                                     
  Remarks,                                                                                      
  branch_cd,                                                                                    
  Dealerbranch,    
  Segment_Type,
  parentSb                                                  
 )                                                                          
 select distinct party_code = ltrim(rtrim(dm.party_code)),                                                                                      
 emp_no = ltrim(rtrim(dm.target_dealer_code)),                                                                                      
 fromdate = dm.from_date,                                     
 todate = dm.to_date,                                                                                      
 entrydate = getdate(),                                                                                      
 valid = 'Y',      
 CommRank,                                                                                    
 Remarks = 'UPCommonPartyServices - INSERT Offline Table Entry',                                                                             
 --branch_cd = (case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.SBTAg end),    --dm.branch_cd,                                                                        
 --Dealerbranch=(case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.SBTAg end),    
  branch_cd = dm.branch_cd,  --ah.Sb_Tag,                                                                       
 Dealerbranch=ah.Sb_Tag,    
 Segment_Type,
 parentSb=dbo.B2bCrms_ParentSb (ltrim(rtrim(dm.target_dealer_code)))                                                                                        
 from B2B_CommonPartyServices_Offline dm with(nolock),B2B_AngelHarmony ah with(nolock)                                               
 where to_be_processed = 'Y'   
 and LEN(source_dealer_code)>0 -- Added by prasanna to avoid duplicate record entry.                              
 and( dm.target_dealer_code=ah.Emp_No  or upper(dm.target_dealer_code)='UNDEFINED') --checking if client is getting mapped to undefined.
 --Uncommnet while going live..................................................... 
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'      
                                          
 -- Error handling                                                                                  
 set @@Errorcount = @@error                                                                                   
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                               
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping inserted')
 
                                                                           
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Update Start')                                                                                 
                                       
                                        
 --Below update is for prevention of multiple processing the processed entry of offline table  
 
 update B2B_CommonPartyServices_Offline                                                                                       
 set to_be_processed = 'N',                                                                                      
 process_time_stamp = getdate(), 
 Reason_For_Non_Process='Due To Unavailablity of Source Dealr Code',                                                              
 other_remarks =                                                                                      
 ltrim(rtrim(isnull(other_remarks, '')))                                                                                      
 +                                                                           
 case                                                                                      
 when                                                                                      
 len(ltrim(rtrim(isnull(other_remarks, '')))) > 0                                                                                      
 then                                                    
 ' - '                                                                                      
 else                                                                                      
 ''                                                                                      
 end                                                                        
 +                                                                                      
 'MAPPING UNSUCCESSFUL'                                                                                      
 where to_be_processed = 'Y'
  and LEN(source_dealer_code)=0 -- Added by prasanna to avoid duplicate record entry.                  
 
                                                       
 update B2B_CommonPartyServices_Offline                                                                                       
 set to_be_processed = 'N',                                                                                      
 process_time_stamp = getdate(),                                                               
 other_remarks =                                                                                      
 ltrim(rtrim(isnull(other_remarks, '')))                                                                                      
 +                                                                           
 case                                                                                      
 when                                                                                      
 len(ltrim(rtrim(isnull(other_remarks, '')))) > 0                                                                                      
 then                                                    
 ' - '                                                                                      
 else                                                                                      
 ''                                                                                      
 end                                                                        
 +                                                                                      
 'MAPPING SUCCESSFUL'                                                                                      
 where to_be_processed = 'Y'
 --Uncommnet while going live.....................................................                                  
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'                                                                                 
                                          
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                                  
 If @@Errorcount <> 0 Goto LabelEnd                                                        
                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Updated')                                                                    
                                  
                                                                
 --************************************************************** End of Dealer Mapping  **********************************        
 
    
                                                     
 LabelEnd:                                                      
 If @@Errorcount <> 0                                                                    
 begin                                                                  
  Rollback Transaction                                                                                
 end                                                                  
 Else                                                                   
 begin                                                       
  Commit Transaction                                                     
 end          
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UP_CommonPartyServices_Bkp_15_Jan_2021
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[UP_CommonPartyServices_Bkp_15_Jan_2021]    
WITH RECOMPILE    
AS    
BEGIN    
/*    
Case 1: Entry for New Clients    
Case 2: Entry for Inactive Client    
Case 3: Entry for Reactivated Clients & B2B To B2C  Shifting    
Case 4: Entry for Resigned Executive    
Case 5: Clients who shifted to Calnt branch     
  Case a) CLIENTS WHO HAVE BEEN SHIFTED INTO CALNT    
  Case b) CLIENTS WHO HAVE BEEN SHIFTED OUT OF CALNT    
Case 6: B2CToB2B shifting    
Case 7: BI Branch Mapping on 1st of month or Party branch change    
Case 8: Employee Transferred    
case 9: Entry for Next Day Dealer Mapping    
*/    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 SET NOCOUNT ON;    
  
 /* Variable declaration for Error Handling routine */    
 DECLARE @@Errorcount int                                                                                 
 SET @@Errorcount = 0         
 /* *********************************************** */  
   
 -- Handle rollback if any error occurs so that there will be consistency in tables for data    
 BEGIN TRANSACTION        
                                        
 /************************************************* Case 1: Entry for New Clients   ***************************** */       
     
 -- RAM Table for New client process to make the process faster.    
/* Declare @NewParty table    
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20)    
 )  
 */
 --Using has table because the data is very huge (4 lk and over) and while using table variable it was taking huhe time to delete all those records. 
  create table  #NewParty     
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10),        
 )     
     
 -- preparing the base table where all new Equity clients taken from backoffice or AngelClient1 table as on today    
 --insert into @NewParty                                                                   
  insert into #NewParty
 select distinct                                                                                           
 party_code = ltrim(rtrim(A.party_code)),                                                                                          
 emp_no = b.emp_no,                                                                                          
 fromdate = convert(datetime, left(convert(varchar, A.ActiveFrom, 109), 11) + ' 00:00:00'),                                                                                          
 todate = 'Dec 31 2049 23:59:00',                                                                                          
 entrydate = GETDATE(),                                                                                          
 valid = 'Y',     
 CommRank = 1,                                                         
 Remarks = 'UPCommonPartyServices - INSERT - NEW CLIENT',                                                                                     
 Branch_cd= A.Sub_Broker,                                                                                      
 dealerbranch_cd= A.Sub_Broker,       
 --Segment_Type = 'Equity'                                                               
 Segment_Type = 'ALL',
 parentSb=ISNULL(parenttag,'N.A.')      
 from AngelClient1 A with (nolock)  inner join B2B_AngelHarmony b with (nolock)  on a.SUB_Broker=b.SB_Tag,
 MIS.sb_comp.dbo.sb_broker sbmain with (nolock)                                                      
 WHERE a.B2C = 'N'                                                                         
 and a.CL_type <> 'SUB' and
a.InActiveFrom >= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')                                                                          
 and a.ActiveFrom <= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')   and     
a.InactiveFrom > a.ActiveFrom  and b.isadmin=1
and A.Sub_Broker=sbmain.sbtag


 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd        
 

 -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty filled by Commodity')                             
 
     
 -- We are removing the clients which are already mapped    
 
                              
 /*Delete @NewParty     
 from crm.dbo.B2B_CommonPartyServices P with (nolock), @NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type    
 */
    
  Delete #NewParty     
 from B2B_CommonPartyServices P with (nolock), #NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type  

  

 --Error handling                                           
 
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd       

  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - removed duplicate')       

 -- We are removing the 98 clients from temp                                             
 Delete from #NewParty                                                            
 where Party_code like '98%'
                                                                                         
 --Error handling                                           
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd
  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - delete 98 clients')                                 
        
     
 -- removing the Currency clients which can be mapped from offline table on same day   
 /*delete #NewParty     
 from #NewParty T, B2B_CommonPartyServices_Offline C with (nolock)                                               
 where T.Party_code = C.Party_code                                                
 And to_be_processed = 'Y' and T.Segment_Type=C.Segment_Type                                                 
*/

 -- removing the Currency clients from the offline table which can be mapped on same day
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from #NewParty c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'  

 --Error handling                                                                                
 set @@Errorcount = @@error                                                                  
 If @@Errorcount <> 0 Goto LabelEnd        

 
 -- Temp Commented Ankur 
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'removed Currency clients who mapped today')       
 -- Inserting the validated New clients in Partyservices                                                  


 insert into B2B_CommonPartyServices     
 Select   party_code, emp_no, fromdate, todate, entrydate, valid, CommRank, Remarks, Branch_cd, dealerbranch_cd, Segment_Type ,parentSb   
 From #NewParty                                                                          

                                             
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                     
                                 
                                                       
 -- Temp Commented Ankur --insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','New Client Entry DONE')                                                                                        
         
 /************************************************ New Client Process End ***************************************  */    


/********************************************** Case 2: Entry for Inactive Client  **************************** */    
   
-- Temp Commented Ankur -- insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process for Closed Client START')     
     
 -- RAM Table to process the closed clients from AngelClient1 table.    

 /*********Commented by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients***********/
 /*
 Declare @CloseParty table    
 (    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)           
 )           

 -- preparing the base table to process the Closed Equity clients     
 insert into @CloseParty                                                                                      
 select distinct                                                                     
 party_code = ltrim(rtrim(c1.party_code)),                                                                       
 emp_no = b.Emp_No,--'UNDEFINED',                      
 fromdate = convert(datetime, left( convert( varchar, c1.inactivefrom, 109 ), 11 ) + ' 00:00:00'),                                                                                         
 todate = convert(datetime, left( convert( varchar, c1.inactivefrom, 109 ), 11 ) + ' 23:59:00'),                                                                                          
 entrydate = getdate(),                          
 valid = 'N',     
 CommRank=1,                                                                                        
 Remarks = 'UPCommonPartyServices - INSERT - CLOSED CLIENT',                                                                                        
 --branch_cd=c1.branch_cd,              
 branch_cd=c1.Sub_Broker,                                                                           
 dealerbranch=c1.Sub_Broker,    
-- Segment_Type = 'Equity'                                                                                           
Segment_Type = 'All',
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                            
 from AngelClient1 c1 with (nolock), B2B_CommonPartyServices p with (nolock)   ,B2B_AngelHarmony b with (nolock)
 --B2B_AngelHarmony b with (nolock)  on a.SUB_Broker=b.SB_Tag                                                                                   
 where ltrim(rtrim(p.party_code)) = ltrim(rtrim(c1.party_code))
 and    ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) 
 and b.IsAdmin=1                                                                             
 and c1.b2c = 'N'                                                                                        
 and c1.cl_type <> 'SUB'                                                    
 and p.valid = 'Y' and --P.Segment_Type = 'Equity'                                                            
 P.Segment_Type = 'ALL' 
 and p.todate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and activefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 00:00:00'                                                     
 and inactivefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and left(convert(varchar, activefrom, 109), 11) <> left(convert(varchar, inactivefrom, 109), 11)    

                                 
 --Error handling                                                                     
 set @@Errorcount = @@error                                                                          
 If @@Errorcount <> 0 Goto LabelEnd         
     
    
 -- updating the previous entry to close the mapping of Closed Clients                                                         
 update B2B_CommonPartyServices                                                                                 
 set todate = left(convert(varchar, dateadd(dd, -1, c.fromdate), 109), 11) + ' 23:59:00',                                                                                   
 valid = 'N',                                                                                
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLOSED CLIENT'                                                                                 
 from @CloseParty c, B2B_CommonPartyServices P with (nolock)                                                                                
 where c.Party_Code = P.Party_Code                                                                                
 and P.Valid = 'Y'     
 and P.Segment_Type = c.Segment_Type and P.CommRank = c.CommRank    
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                  
                  
                        
 -- Error handling                                                                    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                      
 

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','CommonPartyServices Updated For Closed Client')                         
                         
 -- to prevent the Closed client mapping  on the same day need to implement on UI level in Equity, commodity and currency                                              
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from @CloseParty c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'                           
                                 
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd       
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Update offline Currency entry for closed')                         
    
 -- insert the closed entry of undefined for equity, commodity and currency    
 insert into B2B_CommonPartyServices                                      
 Select Party_Code,                  
 Emp_No,                                        
 FromDate,                                        
 ToDate,                      
 EntryDate,                                        
 Valid,      
 CommRank,                                      
 Remarks,                                        
 branch_cd,                         
 Dealerbranch,    
 Segment_Type,
 parentSb                                                 
 from @CloseParty                                           
                             
--Error handling                                    
 set @@Errorcount = @@error                                                                                         
 If @@Errorcount <> 0 Goto LabelEnd     
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Closed client entry done.')                         
 */
 /*********EndCommented by Anand on Jan 09 2020 - Mail from Yogen Gandhi to allow mapping of inactive clients***********/
    
 /**************************************** Inactive Client Process End ******************************************  */ 
 
  /* ***************************************** Case 3: Entry for Reactivated Clients & B2C To B2B  Shifting ************************** */    

insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process for Reactivation of Clients START')                                                                             
                           
                                              
 /* RAM Table to handle Reactivated Clients */    
 
 
 Declare @ReactivatedClients table    
 (    
  --ServiceID bigint,    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)          
 )    
    
 /* First inserts the Equity Reactivated Clients who are closed in Partyservices but active in AngelClient1 table */    
 insert into @ReactivatedClients                                                                         
 select distinct     
 party_code = c1.party_code,                                                                 
 emp_no =b.Emp_No,-- 'UNDEFINED',      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                   
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',       
 CommRank = 1,                                                                             
 Remarks = 'UPCommonPartyServices - INSERT - REACTIVATED CLIENT',                                                                                  
 branch_cd=c1.Sub_Broker,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type,
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                      
  from AngelClient1 c1  with (nolock), B2B_CommonPartyServices p  with(nolock)       ,B2B_AngelHarmony b with (nolock)                                                                          
 where c1.B2C = 'N' 
 and --Segment_Type = 'Equity' 
 Segment_Type = 'ALL' 
 and p.valid='N'                                                              
 and cl_type <> 'SUB' and c1.party_code = p.party_code    and ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) 
 and   b.IsAdmin=1                                                             
 and c1.InactiveFrom >  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 and c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') 
 --and c1.InactiveFromEq >=  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 --and c1.ActiveFromEq<= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                          
 --and p.Emp_no = 'UNDEFINED'                         
  --   and p.Emp_no =b.Emp_No       
     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                               
                                                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','temp table filled with equity')            
  
  --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd        
     
 /* Delete the Current mapping if exists in partyservices for reactivated entry */    
 delete 
	@ReactivatedClients 
 from 
	@ReactivatedClients b, B2B_CommonPartyServices PS with(nolock)    
 where 
	PS.party_code=b.party_code 
	and PS.valid='Y'     
	and b.Segment_Type=PS.Segment_Type   
	
 -- removing the ReactivatedClients clients from the offline table which can be mapped on same day
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from @ReactivatedClients c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'  	              
                     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
   
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','deleted all unwanted entries')          
        
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients and Reactivated Clients    
-------------------------------------------------------     
 insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @ReactivatedClients    
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                                                                           

                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Reactivated Clients Entry DONE')                                                                                  
     
   /**************************************** Reactivated Client Process End ******************************************  */       
   
 
  /* *****************************************Case 4: Sub Broker Shift of Client ****************************************   */    
 Declare @SBShift table    
 (    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)        
 )    
    
 /* First inserts the Equity Reactivated Clients who are closed in Partyservices but active in AngelClient1 table */    
 insert into @SBShift                                                                         
 select distinct     
 party_code = c1.party_code,                                                                 
 emp_no =b.Emp_No,-- 'UNDEFINED' -- Assigns A Admin Dealer Of SubBroker,      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                   
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',       
 CommRank = 1,                                                                             
 Remarks = 'UPCommonPartyServices - INSERT - SUBBROKER SHIFTED CLIENT',                                                                                  
 branch_cd=c1.Sub_Broker,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type,
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                       
 from 
	AngelClient1 c1  with (nolock), 
	B2B_CommonPartyServices p  with(nolock),
	B2B_AngelHarmony b with (nolock)                                                                          
 where 
	c1.B2C = 'N' and 
	Segment_Type = 'ALL' and 
	p.valid='Y' and 
	cl_type <> 'SUB' and 
	c1.party_code = p.party_code and 
	ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) and   
	ltrim(rtrim(c1.SUB_Broker))<>p.Branch_cd and
	b.IsAdmin=1 and                                    
    c1.InactiveFrom >  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') and                                       
    c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') 
 
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                               
                                                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Temp Table FIlled with the Clients') 
 
  -- removing the SB Shifted clients from the offline table which can be mapped on same day
 Update 
	B2B_CommonPartyServices_Offline                                                
 Set 
	to_be_processed = 'N'                                                
 from 
	@SBShift c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where 
	c.Party_Code = t.Party_code and 
	to_be_processed = 'Y'  
	
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','deleted all unwanted entries')
 
  -- updating the previous entry to close the mapping of Closed Clients                                                         
 update B2B_CommonPartyServices                                                                                 
 set todate = left(convert(varchar, dateadd(dd, -1, c.fromdate), 109), 11) + ' 23:59:00',                                                                                   
 valid = 'N',                                                                                
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - SB SHIFT CLIENT'                                                                                 
 from @SBShift c, B2B_CommonPartyServices P with (nolock)                                                                                
 where c.Party_Code = P.Party_Code                                                                                
 and P.Valid = 'Y'     
 and P.Segment_Type = c.Segment_Type and P.CommRank = c.CommRank    
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                  
                  
                        
 -- Error handling                                                                    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                      
 

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','CommonPartyServices Updated For Closed Client')   
 
 -------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients and Reactivated Clients    
-------------------------------------------------------     
 insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @SBShift    
 
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                                                                           

                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','SB Shifting Clients Entry DONE')   		 
 
 --select * from @SBShift	
   
       
   /* *****************************************Case 4: Entry for Resigned Executive ****************************************   */    
   /* if any client mapped to dealer and that dealer has resigned, then after 30 days the client should moved to undefined */    
       /*
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process Start for Resigned Dealer')                                                      
                                    
 /* RAM Table to handle Reactivated Clients */    
 Declare @ResignedDealer table    
 (    
  party_code varchar(10),    
  emp_no varchar(10),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20)         
 )    
    
 /* inserts all the equity, commodity and currency clients who has resigned dealer mapped currently in one temp table */    
 insert into @ResignedDealer    
 select distinct party_code = ltrim(rtrim(c1.party_code)),                                                                      
 emp_no = 'UNDEFINED',                                                                      
 fromdate = LEFT(convert (varchar, dateadd(dd, +31, A.InActiveFrom), 109 ), 11 ) + ' 00:00:00',                                                  
 todate = 'Dec 31 2049 23:59:00',                                           
 entrydate = getdate(),                                                                      
 valid = 'Y',      
 CommRank,                                                                   
 Remarks = 'UPCommonPartyServices - INSERT - CLIENT WITH RESIGNED EMPLOYEE',                                                                    
 branch_cd=c1.branch_cd,                                                                  
 dealerbranch=c1.branch_cd,    
 Segment_Type                                                        
 from B2B_Harmony A with (noLock), B2B_CommonPartyServices c1 with(nolock)                                                                    
 where A.Status <> 'A'                                                             
 and A.EmpCode  = c1.Emp_No                                                            
 and A.InActiveFrom  <= left( convert( varchar, dateadd(dd, -30, getdate()), 109 ), 11 ) + ' 23:59:00'                                                          
 and Valid = 'Y'    
                             
 --Error handling                                                   
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                    
                             
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'table for Resigned Executive DONE')                               
    
 /* update or close the previous mapping */    
 update B2B_CommonPartyServices                                                             
 set todate =  left(convert(varchar, dateadd(dd, -1, R.FromDate), 109), 11) + ' 23:59:00',                                                           
 valid = 'N',                                                            
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLIENT WITH RESIGNED DEALER'                                                             
 from @ResignedDealer R, B2B_CommonPartyServices P with (nolock)                                                           
 where R.Party_Code = P.Party_Code                                                     
 and P.Valid = 'Y'                                                             
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'    
 and P.Segment_Type = R.Segment_Type    
 and P.CommRank = R.CommRank                                                             
       
       
       
       
       
       
       
 -- Error handling                                                            
 set @@Errorcount = @@error                                                             
 If @@Errorcount <> 0 Goto LabelEnd                                                             
                                    
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','PartyServices Update for Resigned Executive DONE')                                                                 
     
     
     
 -- we are preventing the resigned executives to be mapped to the Currency clients                                      
 Update B2B_CommonPartyServices_Offline                     
 Set to_be_processed = 'N'                                   
 from @ResignedDealer R, B2B_CommonPartyServices_Offline O with (nolock)                                                
 where R.Party_Code = O.Party_code                                                   
 and to_be_processed = 'Y'                                                       
                             
 --Error handling                   
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                  
                                 
 insert into B2B_CommonPartyServices     
 Select Party_Code,                                        
   Emp_No,                                        
   FromDate,                                        
   ToDate,                                     
   EntryDate,                                        
   Valid,    
   CommRank,                                        
   Remarks,                                        
   branch_cd,                                        
   dealerbranch,    
   Segment_Type    
 From @ResignedDealer                                                                
                                    
 -- Error handling                                                            
 set @@Errorcount = @@error                                                             
 If @@Errorcount <> 0 Goto LabelEnd                       
                                    
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Entry done for Resigned Dealer')                                                                    
          
          
          */
   /**************************************** Resigned Dealer Process End ******************************************  */        
  
  /************************************************** Case 6: B2BToB2C shifting**********************************   */
-------------------------------------------------------    
 --Craete RAM Table for B2CToB2B shifting    
 -------------------------------------------------------    
 Declare @B2BToB2CParty table      
 (      
  party_code varchar(10),      
  emp_no varchar(20),      
  fromdate smalldatetime,      
  todate smalldatetime,      
  entrydate smalldatetime,      
  valid char(1),      
  CommRank int,      
  Remarks varchar(5000),      
  branch_cd varchar(10),      
  dealerbranch varchar(10),      
  Segment_Type varchar(20),
  parentSB varchar(10)            
 )      
 
 
-------------------------------------------------------    
--Insert B2C to B2B shifted clients into RAM table    
-------------------------------------------------------     
insert into @B2BToB2CParty           
   select distinct party_code=ps.party_code,          
  emp_no = b.emp_no,--'UNDEFINED',          
  fromdate = left(getdate(),11 ) + ' 00:00',          
  todate = left(getdate(),11) + ' 23:59',          
  entrydate = getdate(),          
  valid = 'N',      
  CommRank=PS.CommRank ,       
  Remarks = 'UPCommonPartyServices - INSERT - B2BTOB2C SHIFTED CLIENT',          
  ---------------------Commnted by prasanna on Aug 27 2012 to map b2b sub broker after shifting b2b to b2c. 
  --branch_cd=a1.Sub_Broker,          
  --dealerbranch=a1.Sub_Broker,          
  --PS.Segment_Type,
  --parentSb=  dbo.B2bCrms_ParentSb (b.emp_no) 
  branch_cd=ps.branch_cd,          
  dealerbranch=ps.branch_cd,          
  PS.Segment_Type,
  parentSb=  dbo.B2bCrms_ParentSb (ps.emp_no)      
  from B2B_CommonPartyServices PS with(nolock) inner join AngelClient1 a1 with(nolock)
   on ps.party_code = a1.party_code      
   ,B2B_AngelHarmony b with (nolock)    
  where          
  PS.valid='Y'          
  and a1.b2c='Y'       
  and a1.SUB_Broker = b.SB_Tag  
  and b.IsAdmin=1  
  and b.SB_Tag<>'HYD1'-----------------------------Remove after Saturday
    and PS.Emp_No<>'HYD1001'-----------------------------Remove after Saturday
      
   -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','table filled for B2B to B2C shifting')                                                   
    
-------------------------------------------------------    
--Update for B2C to B2B shifted clients    
-------------------------------------------------------     
 update B2B_CommonPartyServices  set                                                                                 
  todate = left(dateadd(dd, -1, GETDATE()), 11) + ' 23:59',                                                                      
 valid = 'N',                                                                                  
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - B2BTOB2C SHIFTED CLIENT'                                                                                   
 from @B2BToB2CParty  c,B2B_CommonPartyServices P with (nolock)                                                                                  
 where c.Party_Code = P.Party_Code                                                                                  
 and P.Valid = 'Y'       
 and c.CommRank= P.CommRank    
 and P.Segment_Type = c.Segment_Type     
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'     
     
    -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','update for previous entry B2B to B2C shifting')                                                   
    
-----------------------------------------------------------    
--Update Offline table entry    
-----------------------------------------------------------    
  Update B2B_CommonPartyServices_Offline                                                  
 Set to_be_processed = 'N'                                                  
 from @B2BToB2CParty c, B2B_CommonPartyServices_Offline t with (nolock)                                                 
 where c.Party_Code = t.Party_code                                                     
 and to_be_processed = 'Y'  and c.Segment_Type=t.Segment_Type and c.commrank = t.commrank      
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients    
-------------------------------------------------------     
  insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @B2BToB2CParty      
     
    -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process end for B2C to B2B shifting')                                                   
    
-------------------------------------------------------    
--END B2C to B2B shifted clients    
-------------------------------------------------------          
 
     
 /******************************************** case 8: Entry for  Next Day Dealer Mapping ***********************  */
                                                                 
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Next Days Mapping Start')                                                           
    

 ---- Update the Common Partyservices entry from the Common Offline Table for current mapping of UI         
 update B2B_CommonPartyServices                                                                                         
 set valid = 'N',                                                                                      
 todate = left(convert(varchar, dateadd(dd, -1, o.from_date), 109), 11) + ' 23:59:00',                                                     
 Remarks = Remarks + ';' + 'OFFLINE - UPDATE'                                                                                    
 from B2B_CommonPartyServices_Offline o with (nolock), B2B_CommonPartyServices P with (nolock)                                       
 where ltrim(rtrim(P.party_code)) = ltrim(rtrim(o.party_code))                                                                                      
 and ltrim(rtrim(P.emp_no)) = ltrim(rtrim(o.source_dealer_code))                                                                         
 and P.valid = 'Y' and o.to_be_processed = 'Y' and P.Segment_Type = o.Segment_Type       
 and P.CommRank = o.CommRank  
 --Uncommnet while going live.....................................................                                                                                  
 --and o.entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'     
 
 
            
 -- Error handling                                                                            
 set @@Errorcount = @@error                                                              
 If @@Errorcount <> 0 Goto LabelEnd     
                          
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping updated')                                                                                

                                                                  
 insert into B2B_CommonPartyServices                                                                                     
 (                                                                                      
  party_code,                                                                                      
  emp_no,                                                         
  fromdate,                                                                         
  todate,                      
  entrydate,                                                                                      
  valid,     
  CommRank,                                                                                     
  Remarks,                                                                                      
  branch_cd,                                                                                    
  Dealerbranch,    
  Segment_Type,
  parentSb                                                  
 )                                                                          
 select distinct party_code = ltrim(rtrim(dm.party_code)),                                                                                      
 emp_no = ltrim(rtrim(dm.target_dealer_code)),                                                                                      
 fromdate = dm.from_date,                                     
 todate = dm.to_date,                                                                                      
 entrydate = getdate(),                                                                                      
 valid = 'Y',      
 CommRank,                                                                                    
 Remarks = 'UPCommonPartyServices - INSERT Offline Table Entry',                                                                             
 --branch_cd = (case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.SBTAg end),    --dm.branch_cd,                                                                        
 --Dealerbranch=(case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.SBTAg end),    
  branch_cd = dm.branch_cd,  --ah.Sb_Tag,                                                                       
 Dealerbranch=ah.Sb_Tag,    
 Segment_Type,
 parentSb=dbo.B2bCrms_ParentSb (ltrim(rtrim(dm.target_dealer_code)))                                                                                        
 from B2B_CommonPartyServices_Offline dm with(nolock),B2B_AngelHarmony ah with(nolock)                                               
 where to_be_processed = 'Y'   
 and LEN(source_dealer_code)>0 -- Added by prasanna to avoid duplicate record entry.                              
 and( dm.target_dealer_code=ah.Emp_No  or upper(dm.target_dealer_code)='UNDEFINED') --checking if client is getting mapped to undefined.
 --Uncommnet while going live..................................................... 
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'      
                                          
 -- Error handling                                                                                  
 set @@Errorcount = @@error                                                                                   
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                               
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping inserted')
 
                                                                           
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Update Start')                                                                                 
                                       
                                        
 --Below update is for prevention of multiple processing the processed entry of offline table  
 
 update B2B_CommonPartyServices_Offline                                                                                       
 set to_be_processed = 'N',                                                                                      
 process_time_stamp = getdate(), 
 Reason_For_Non_Process='Due To Unavailablity of Source Dealr Code',                                                              
 other_remarks =                                                                                      
 ltrim(rtrim(isnull(other_remarks, '')))                                                                                      
 +                                                                           
 case                                                                                      
 when                                                                                      
 len(ltrim(rtrim(isnull(other_remarks, '')))) > 0                                                                                      
 then                                                    
 ' - '                                                                                      
 else                                                                                      
 ''                                                                                      
 end                                                                        
 +                                                                                      
 'MAPPING UNSUCCESSFUL'                                                                                      
 where to_be_processed = 'Y'
  and LEN(source_dealer_code)=0 -- Added by prasanna to avoid duplicate record entry.                  
 
                                                       
 update B2B_CommonPartyServices_Offline                                                                                       
 set to_be_processed = 'N',                                                                                      
 process_time_stamp = getdate(),                                                               
 other_remarks =                                                                                      
 ltrim(rtrim(isnull(other_remarks, '')))                                                                                      
 +                                                                           
 case                                                                                      
 when                                                                                      
 len(ltrim(rtrim(isnull(other_remarks, '')))) > 0                                                                                      
 then                                                    
 ' - '                                                                                      
 else                                                                                      
 ''                                                                                      
 end                                                                        
 +                                                                                      
 'MAPPING SUCCESSFUL'                                                                                      
 where to_be_processed = 'Y'
 --Uncommnet while going live.....................................................                                  
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'                                                                                 
                                          
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                                  
 If @@Errorcount <> 0 Goto LabelEnd                                                        
                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Updated')                                                                    
                                  
                                                                
 --************************************************************** End of Dealer Mapping  **********************************        
 
    
                                                     
 LabelEnd:                                                      
 If @@Errorcount <> 0                                                                    
 begin                                                                  
  Rollback Transaction                                                                                
 end                                                                  
 Else                                                                   
 begin                                                       
  Commit Transaction                                                     
 end          
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UP_CommonPartyServices_bkp09Jan2020
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[UP_CommonPartyServices_bkp09Jan2020]    
WITH RECOMPILE    
AS    
BEGIN    
/*    
Case 1: Entry for New Clients    
Case 2: Entry for Inactive Client    
Case 3: Entry for Reactivated Clients & B2B To B2C  Shifting    
Case 4: Entry for Resigned Executive    
Case 5: Clients who shifted to Calnt branch     
  Case a) CLIENTS WHO HAVE BEEN SHIFTED INTO CALNT    
  Case b) CLIENTS WHO HAVE BEEN SHIFTED OUT OF CALNT    
Case 6: B2CToB2B shifting    
Case 7: BI Branch Mapping on 1st of month or Party branch change    
Case 8: Employee Transferred    
case 9: Entry for Next Day Dealer Mapping    
*/    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 SET NOCOUNT ON;    
  
 /* Variable declaration for Error Handling routine */    
 DECLARE @@Errorcount int                                                                                 
 SET @@Errorcount = 0         
 /* *********************************************** */  
   
 -- Handle rollback if any error occurs so that there will be consistency in tables for data    
 BEGIN TRANSACTION        
                                        
 /************************************************* Case 1: Entry for New Clients   ***************************** */       
     
 -- RAM Table for New client process to make the process faster.    
/* Declare @NewParty table    
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20)    
 )  
 */
 --Using has table because the data is very huge (4 lk and over) and while using table variable it was taking huhe time to delete all those records. 
  create table  #NewParty     
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10),        
 )     
     
 -- preparing the base table where all new Equity clients taken from backoffice or AngelClient1 table as on today    
 --insert into @NewParty                                                                   
  insert into #NewParty
 select distinct                                                                                           
 party_code = ltrim(rtrim(A.party_code)),                                                                                          
 emp_no = b.emp_no,                                                                                          
 fromdate = convert(datetime, left(convert(varchar, A.ActiveFrom, 109), 11) + ' 00:00:00'),                                                                                          
 todate = 'Dec 31 2049 23:59:00',                                                                                          
 entrydate = GETDATE(),                                                                                          
 valid = 'Y',     
 CommRank = 1,                                                         
 Remarks = 'UPCommonPartyServices - INSERT - NEW CLIENT',                                                                                     
 Branch_cd= A.Sub_Broker,                                                                                      
 dealerbranch_cd= A.Sub_Broker,       
 --Segment_Type = 'Equity'                                                               
 Segment_Type = 'ALL',
 parentSb=ISNULL(parenttag,'N.A.')      
 from AngelClient1 A with (nolock)  inner join B2B_AngelHarmony b with (nolock)  on a.SUB_Broker=b.SB_Tag,
 MIS.sb_comp.dbo.sb_broker sbmain with (nolock)                                                      
 WHERE a.B2C = 'N'                                                                         
 and a.CL_type <> 'SUB' and
a.InActiveFrom >= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')                                                                          
 and a.ActiveFrom <= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')   and     
a.InactiveFrom > a.ActiveFrom  and b.isadmin=1
and A.Sub_Broker=sbmain.sbtag


 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd        
 

 -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty filled by Commodity')                             
 
     
 -- We are removing the clients which are already mapped    
 
                              
 /*Delete @NewParty     
 from crm.dbo.B2B_CommonPartyServices P with (nolock), @NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type    
 */
    
  Delete #NewParty     
 from B2B_CommonPartyServices P with (nolock), #NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type  

  

 --Error handling                                           
 
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd       

  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - removed duplicate')       

 -- We are removing the 98 clients from temp                                             
 Delete from #NewParty                                                            
 where Party_code like '98%'
                                                                                         
 --Error handling                                           
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd
  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - delete 98 clients')                                 
        
     
 -- removing the Currency clients which can be mapped from offline table on same day   
 /*delete #NewParty     
 from #NewParty T, B2B_CommonPartyServices_Offline C with (nolock)                                               
 where T.Party_code = C.Party_code                                                
 And to_be_processed = 'Y' and T.Segment_Type=C.Segment_Type                                                 
*/

 -- removing the Currency clients from the offline table which can be mapped on same day
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from #NewParty c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'  

 --Error handling                                                                                
 set @@Errorcount = @@error                                                                  
 If @@Errorcount <> 0 Goto LabelEnd        

 
 -- Temp Commented Ankur 
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'removed Currency clients who mapped today')       
 -- Inserting the validated New clients in Partyservices                                                  


 insert into B2B_CommonPartyServices     
 Select   party_code, emp_no, fromdate, todate, entrydate, valid, CommRank, Remarks, Branch_cd, dealerbranch_cd, Segment_Type ,parentSb   
 From #NewParty                                                                          

                                             
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                     
                                 
                                                       
 -- Temp Commented Ankur --insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','New Client Entry DONE')                                                                                        
         
 /************************************************ New Client Process End ***************************************  */    


/********************************************** Case 2: Entry for Inactive Client  **************************** */    
   
-- Temp Commented Ankur -- insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process for Closed Client START')     
     
 -- RAM Table to process the closed clients from AngelClient1 table.    
 Declare @CloseParty table    
 (    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)           
 )           

 -- preparing the base table to process the Closed Equity clients     
 insert into @CloseParty                                                                                      
 select distinct                                                                     
 party_code = ltrim(rtrim(c1.party_code)),                                                                       
 emp_no = b.Emp_No,--'UNDEFINED',                      
 fromdate = convert(datetime, left( convert( varchar, c1.inactivefrom, 109 ), 11 ) + ' 00:00:00'),                                                                                         
 todate = convert(datetime, left( convert( varchar, c1.inactivefrom, 109 ), 11 ) + ' 23:59:00'),                                                                                          
 entrydate = getdate(),                          
 valid = 'N',     
 CommRank=1,                                                                                        
 Remarks = 'UPCommonPartyServices - INSERT - CLOSED CLIENT',                                                                                        
 --branch_cd=c1.branch_cd,              
 branch_cd=c1.Sub_Broker,                                                                           
 dealerbranch=c1.Sub_Broker,    
-- Segment_Type = 'Equity'                                                                                           
Segment_Type = 'All',
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                            
 from AngelClient1 c1 with (nolock), B2B_CommonPartyServices p with (nolock)   ,B2B_AngelHarmony b with (nolock)
 --B2B_AngelHarmony b with (nolock)  on a.SUB_Broker=b.SB_Tag                                                                                   
 where ltrim(rtrim(p.party_code)) = ltrim(rtrim(c1.party_code))
 and    ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) 
 and b.IsAdmin=1                                                                             
 and c1.b2c = 'N'                                                                                        
 and c1.cl_type <> 'SUB'                                                    
 and p.valid = 'Y' and --P.Segment_Type = 'Equity'                                                            
 P.Segment_Type = 'ALL' 
 and p.todate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and activefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 00:00:00'                                                     
 and inactivefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and left(convert(varchar, activefrom, 109), 11) <> left(convert(varchar, inactivefrom, 109), 11)    

                                 
 --Error handling                                                                     
 set @@Errorcount = @@error                                                                          
 If @@Errorcount <> 0 Goto LabelEnd         
     
    
 -- updating the previous entry to close the mapping of Closed Clients                                                         
 update B2B_CommonPartyServices                                                                                 
 set todate = left(convert(varchar, dateadd(dd, -1, c.fromdate), 109), 11) + ' 23:59:00',                                                                                   
 valid = 'N',                                                                                
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLOSED CLIENT'                                                                                 
 from @CloseParty c, B2B_CommonPartyServices P with (nolock)                                                                                
 where c.Party_Code = P.Party_Code                                                                                
 and P.Valid = 'Y'     
 and P.Segment_Type = c.Segment_Type and P.CommRank = c.CommRank    
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                  
                  
                        
 -- Error handling                                                                    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                      
 

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','CommonPartyServices Updated For Closed Client')                         
                         
 -- to prevent the Closed client mapping  on the same day need to implement on UI level in Equity, commodity and currency                                              
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from @CloseParty c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'                           
                                 
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd       
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Update offline Currency entry for closed')                         
    
 -- insert the closed entry of undefined for equity, commodity and currency    
 insert into B2B_CommonPartyServices                                      
 Select Party_Code,                  
 Emp_No,                                        
 FromDate,                                        
 ToDate,                      
 EntryDate,                                        
 Valid,      
 CommRank,                                      
 Remarks,                                        
 branch_cd,                         
 Dealerbranch,    
 Segment_Type,
 parentSb                                                 
 from @CloseParty                                           
                             
--Error handling                                    
 set @@Errorcount = @@error                                                                                         
 If @@Errorcount <> 0 Goto LabelEnd     
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Closed client entry done.')                         
     
 /**************************************** Inactive Client Process End ******************************************  */ 
 
  /* ***************************************** Case 3: Entry for Reactivated Clients & B2C To B2B  Shifting ************************** */    

insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process for Reactivation of Clients START')                                                                             
                           
                                              
 /* RAM Table to handle Reactivated Clients */    
 
 
 Declare @ReactivatedClients table    
 (    
  --ServiceID bigint,    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)          
 )    
    
 /* First inserts the Equity Reactivated Clients who are closed in Partyservices but active in AngelClient1 table */    
 insert into @ReactivatedClients                                                                         
 select distinct     
 party_code = c1.party_code,                                                                 
 emp_no =b.Emp_No,-- 'UNDEFINED',      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                   
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',       
 CommRank = 1,                                                                             
 Remarks = 'UPCommonPartyServices - INSERT - REACTIVATED CLIENT',                                                                                  
 branch_cd=c1.Sub_Broker,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type,
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                      
  from AngelClient1 c1  with (nolock), B2B_CommonPartyServices p  with(nolock)       ,B2B_AngelHarmony b with (nolock)                                                                          
 where c1.B2C = 'N' 
 and --Segment_Type = 'Equity' 
 Segment_Type = 'ALL' 
 and p.valid='N'                                                              
 and cl_type <> 'SUB' and c1.party_code = p.party_code    and ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) 
 and   b.IsAdmin=1                                                             
 and c1.InactiveFrom >  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 and c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') 
 --and c1.InactiveFromEq >=  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 --and c1.ActiveFromEq<= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                          
 --and p.Emp_no = 'UNDEFINED'                         
  --   and p.Emp_no =b.Emp_No       
     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                               
                                                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','temp table filled with equity')            
  
  --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd        
     
 /* Delete the Current mapping if exists in partyservices for reactivated entry */    
 delete 
	@ReactivatedClients 
 from 
	@ReactivatedClients b, B2B_CommonPartyServices PS with(nolock)    
 where 
	PS.party_code=b.party_code 
	and PS.valid='Y'     
	and b.Segment_Type=PS.Segment_Type   
	
 -- removing the ReactivatedClients clients from the offline table which can be mapped on same day
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from @ReactivatedClients c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'  	              
                     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
   
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','deleted all unwanted entries')          
        
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients and Reactivated Clients    
-------------------------------------------------------     
 insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @ReactivatedClients    
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                                                                           

                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Reactivated Clients Entry DONE')                                                                                  
     
   /**************************************** Reactivated Client Process End ******************************************  */       
   
 
  /* *****************************************Case 4: Sub Broker Shift of Client ****************************************   */    
 Declare @SBShift table    
 (    
  party_code varchar(10),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20),
  parentSB varchar(10)        
 )    
    
 /* First inserts the Equity Reactivated Clients who are closed in Partyservices but active in AngelClient1 table */    
 insert into @SBShift                                                                         
 select distinct     
 party_code = c1.party_code,                                                                 
 emp_no =b.Emp_No,-- 'UNDEFINED' -- Assigns A Admin Dealer Of SubBroker,      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                   
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',       
 CommRank = 1,                                                                             
 Remarks = 'UPCommonPartyServices - INSERT - SUBBROKER SHIFTED CLIENT',                                                                                  
 branch_cd=c1.Sub_Broker,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type,
 parentSb=  dbo.B2bCrms_ParentSb (b.emp_no)                                                                                       
 from 
	AngelClient1 c1  with (nolock), 
	B2B_CommonPartyServices p  with(nolock),
	B2B_AngelHarmony b with (nolock)                                                                          
 where 
	c1.B2C = 'N' and 
	Segment_Type = 'ALL' and 
	p.valid='Y' and 
	cl_type <> 'SUB' and 
	c1.party_code = p.party_code and 
	ltrim(rtrim(c1.SUB_Broker)) = ltrim(rtrim(b.SB_Tag)) and   
	ltrim(rtrim(c1.SUB_Broker))<>p.Branch_cd and
	b.IsAdmin=1 and                                    
    c1.InactiveFrom >  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') and                                       
    c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') 
 
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                               
                                                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Temp Table FIlled with the Clients') 
 
  -- removing the SB Shifted clients from the offline table which can be mapped on same day
 Update 
	B2B_CommonPartyServices_Offline                                                
 Set 
	to_be_processed = 'N'                                                
 from 
	@SBShift c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where 
	c.Party_Code = t.Party_code and 
	to_be_processed = 'Y'  
	
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','deleted all unwanted entries')
 
  -- updating the previous entry to close the mapping of Closed Clients                                                         
 update B2B_CommonPartyServices                                                                                 
 set todate = left(convert(varchar, dateadd(dd, -1, c.fromdate), 109), 11) + ' 23:59:00',                                                                                   
 valid = 'N',                                                                                
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - SB SHIFT CLIENT'                                                                                 
 from @SBShift c, B2B_CommonPartyServices P with (nolock)                                                                                
 where c.Party_Code = P.Party_Code                                                                                
 and P.Valid = 'Y'     
 and P.Segment_Type = c.Segment_Type and P.CommRank = c.CommRank    
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                  
                  
                        
 -- Error handling                                                                    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                      
 

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','CommonPartyServices Updated For Closed Client')   
 
 -------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients and Reactivated Clients    
-------------------------------------------------------     
 insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @SBShift    
 
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                                                                           

                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','SB Shifting Clients Entry DONE')   		 
 
 --select * from @SBShift	
   
       
   /* *****************************************Case 4: Entry for Resigned Executive ****************************************   */    
   /* if any client mapped to dealer and that dealer has resigned, then after 30 days the client should moved to undefined */    
       /*
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process Start for Resigned Dealer')                                                      
                                    
 /* RAM Table to handle Reactivated Clients */    
 Declare @ResignedDealer table    
 (    
  party_code varchar(10),    
  emp_no varchar(10),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20)         
 )    
    
 /* inserts all the equity, commodity and currency clients who has resigned dealer mapped currently in one temp table */    
 insert into @ResignedDealer    
 select distinct party_code = ltrim(rtrim(c1.party_code)),                                                                      
 emp_no = 'UNDEFINED',                                                                      
 fromdate = LEFT(convert (varchar, dateadd(dd, +31, A.InActiveFrom), 109 ), 11 ) + ' 00:00:00',                                                  
 todate = 'Dec 31 2049 23:59:00',                                           
 entrydate = getdate(),                                                                      
 valid = 'Y',      
 CommRank,                                                                   
 Remarks = 'UPCommonPartyServices - INSERT - CLIENT WITH RESIGNED EMPLOYEE',                                                                    
 branch_cd=c1.branch_cd,                                                                  
 dealerbranch=c1.branch_cd,    
 Segment_Type                                                        
 from B2B_Harmony A with (noLock), B2B_CommonPartyServices c1 with(nolock)                                                                    
 where A.Status <> 'A'                                                             
 and A.EmpCode  = c1.Emp_No                                                            
 and A.InActiveFrom  <= left( convert( varchar, dateadd(dd, -30, getdate()), 109 ), 11 ) + ' 23:59:00'                                                          
 and Valid = 'Y'    
                             
 --Error handling                                                   
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                    
                             
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'table for Resigned Executive DONE')                               
    
 /* update or close the previous mapping */    
 update B2B_CommonPartyServices                                                             
 set todate =  left(convert(varchar, dateadd(dd, -1, R.FromDate), 109), 11) + ' 23:59:00',                                                           
 valid = 'N',                                                            
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLIENT WITH RESIGNED DEALER'                                                             
 from @ResignedDealer R, B2B_CommonPartyServices P with (nolock)                                                           
 where R.Party_Code = P.Party_Code                                                     
 and P.Valid = 'Y'                                                             
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'    
 and P.Segment_Type = R.Segment_Type    
 and P.CommRank = R.CommRank                                                             
       
       
       
       
       
       
       
 -- Error handling                                                            
 set @@Errorcount = @@error                                                             
 If @@Errorcount <> 0 Goto LabelEnd                                                             
                                    
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','PartyServices Update for Resigned Executive DONE')                                                                 
     
     
     
 -- we are preventing the resigned executives to be mapped to the Currency clients                                      
 Update B2B_CommonPartyServices_Offline                     
 Set to_be_processed = 'N'                                   
 from @ResignedDealer R, B2B_CommonPartyServices_Offline O with (nolock)                                                
 where R.Party_Code = O.Party_code                                                   
 and to_be_processed = 'Y'                                                       
                             
 --Error handling                   
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                  
                                 
 insert into B2B_CommonPartyServices     
 Select Party_Code,                                        
   Emp_No,                                        
   FromDate,                                        
   ToDate,                                     
   EntryDate,                                        
   Valid,    
   CommRank,                                        
   Remarks,                                        
   branch_cd,                                        
   dealerbranch,    
   Segment_Type    
 From @ResignedDealer                                                                
                                    
 -- Error handling                                                            
 set @@Errorcount = @@error                                                             
 If @@Errorcount <> 0 Goto LabelEnd                       
                                    
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Entry done for Resigned Dealer')                                                                    
          
          
          */
   /**************************************** Resigned Dealer Process End ******************************************  */        
  
  /************************************************** Case 6: B2BToB2C shifting**********************************   */
-------------------------------------------------------    
 --Craete RAM Table for B2CToB2B shifting    
 -------------------------------------------------------    
 Declare @B2BToB2CParty table      
 (      
  party_code varchar(10),      
  emp_no varchar(20),      
  fromdate smalldatetime,      
  todate smalldatetime,      
  entrydate smalldatetime,      
  valid char(1),      
  CommRank int,      
  Remarks varchar(5000),      
  branch_cd varchar(10),      
  dealerbranch varchar(10),      
  Segment_Type varchar(20),
  parentSB varchar(10)            
 )      
 
 
-------------------------------------------------------    
--Insert B2C to B2B shifted clients into RAM table    
-------------------------------------------------------     
insert into @B2BToB2CParty           
   select distinct party_code=ps.party_code,          
  emp_no = b.emp_no,--'UNDEFINED',          
  fromdate = left(getdate(),11 ) + ' 00:00',          
  todate = left(getdate(),11) + ' 23:59',          
  entrydate = getdate(),          
  valid = 'N',      
  CommRank=PS.CommRank ,       
  Remarks = 'UPCommonPartyServices - INSERT - B2BTOB2C SHIFTED CLIENT',          
  ---------------------Commnted by prasanna on Aug 27 2012 to map b2b sub broker after shifting b2b to b2c. 
  --branch_cd=a1.Sub_Broker,          
  --dealerbranch=a1.Sub_Broker,          
  --PS.Segment_Type,
  --parentSb=  dbo.B2bCrms_ParentSb (b.emp_no) 
  branch_cd=ps.branch_cd,          
  dealerbranch=ps.branch_cd,          
  PS.Segment_Type,
  parentSb=  dbo.B2bCrms_ParentSb (ps.emp_no)      
  from B2B_CommonPartyServices PS with(nolock) inner join AngelClient1 a1 with(nolock)
   on ps.party_code = a1.party_code      
   ,B2B_AngelHarmony b with (nolock)    
  where          
  PS.valid='Y'          
  and a1.b2c='Y'       
  and a1.SUB_Broker = b.SB_Tag  
  and b.IsAdmin=1  
  and b.SB_Tag<>'HYD1'-----------------------------Remove after Saturday
    and PS.Emp_No<>'HYD1001'-----------------------------Remove after Saturday
      
   -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','table filled for B2B to B2C shifting')                                                   
    
-------------------------------------------------------    
--Update for B2C to B2B shifted clients    
-------------------------------------------------------     
 update B2B_CommonPartyServices  set                                                                                 
  todate = left(dateadd(dd, -1, GETDATE()), 11) + ' 23:59',                                                                      
 valid = 'N',                                                                                  
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - B2BTOB2C SHIFTED CLIENT'                                                                                   
 from @B2BToB2CParty  c,B2B_CommonPartyServices P with (nolock)                                                                                  
 where c.Party_Code = P.Party_Code                                                                                  
 and P.Valid = 'Y'       
 and c.CommRank= P.CommRank    
 and P.Segment_Type = c.Segment_Type     
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'     
     
    -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','update for previous entry B2B to B2C shifting')                                                   
    
-----------------------------------------------------------    
--Update Offline table entry    
-----------------------------------------------------------    
  Update B2B_CommonPartyServices_Offline                                                  
 Set to_be_processed = 'N'                                                  
 from @B2BToB2CParty c, B2B_CommonPartyServices_Offline t with (nolock)                                                 
 where c.Party_Code = t.Party_code                                                     
 and to_be_processed = 'Y'  and c.Segment_Type=t.Segment_Type and c.commrank = t.commrank      
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients    
-------------------------------------------------------     
  insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type,
 parentSb                                                   
 from @B2BToB2CParty      
     
    -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process end for B2C to B2B shifting')                                                   
    
-------------------------------------------------------    
--END B2C to B2B shifted clients    
-------------------------------------------------------          
 
     
 /******************************************** case 8: Entry for  Next Day Dealer Mapping ***********************  */
                                                                 
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Next Days Mapping Start')                                                           
    

 ---- Update the Common Partyservices entry from the Common Offline Table for current mapping of UI         
 update B2B_CommonPartyServices                                                                                         
 set valid = 'N',                                                                                      
 todate = left(convert(varchar, dateadd(dd, -1, o.from_date), 109), 11) + ' 23:59:00',                                                     
 Remarks = Remarks + ';' + 'OFFLINE - UPDATE'                                                                                    
 from B2B_CommonPartyServices_Offline o with (nolock), B2B_CommonPartyServices P with (nolock)                                       
 where ltrim(rtrim(P.party_code)) = ltrim(rtrim(o.party_code))                                                                                      
 and ltrim(rtrim(P.emp_no)) = ltrim(rtrim(o.source_dealer_code))                                                                         
 and P.valid = 'Y' and o.to_be_processed = 'Y' and P.Segment_Type = o.Segment_Type       
 and P.CommRank = o.CommRank  
 --Uncommnet while going live.....................................................                                                                                  
 --and o.entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'     
 
 
            
 -- Error handling                                                                            
 set @@Errorcount = @@error                                                              
 If @@Errorcount <> 0 Goto LabelEnd     
                          
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping updated')                                                                                

                                                                  
 insert into B2B_CommonPartyServices                                                                                     
 (                                                                                      
  party_code,                                                                                      
  emp_no,                                                         
  fromdate,                                                                         
  todate,                      
  entrydate,                                                                                      
  valid,     
  CommRank,                                                                                     
  Remarks,                                                                                      
  branch_cd,                                                                                    
  Dealerbranch,    
  Segment_Type,
  parentSb                                                  
 )                                                                          
 select distinct party_code = ltrim(rtrim(dm.party_code)),                                                                                      
 emp_no = ltrim(rtrim(dm.target_dealer_code)),                                                                                      
 fromdate = dm.from_date,                                     
 todate = dm.to_date,                                                                                      
 entrydate = getdate(),                                                                                      
 valid = 'Y',      
 CommRank,                                                                                    
 Remarks = 'UPCommonPartyServices - INSERT Offline Table Entry',                                                                             
 --branch_cd = (case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.SBTAg end),    --dm.branch_cd,                                                                        
 --Dealerbranch=(case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.SBTAg end),    
  branch_cd = dm.branch_cd,  --ah.Sb_Tag,                                                                       
 Dealerbranch=ah.Sb_Tag,    
 Segment_Type,
 parentSb=dbo.B2bCrms_ParentSb (ltrim(rtrim(dm.target_dealer_code)))                                                                                        
 from B2B_CommonPartyServices_Offline dm with(nolock),B2B_AngelHarmony ah with(nolock)                                               
 where to_be_processed = 'Y'   
 and LEN(source_dealer_code)>0 -- Added by prasanna to avoid duplicate record entry.                              
 and( dm.target_dealer_code=ah.Emp_No  or upper(dm.target_dealer_code)='UNDEFINED') --checking if client is getting mapped to undefined.
 --Uncommnet while going live..................................................... 
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'      
                                          
 -- Error handling                                                                                  
 set @@Errorcount = @@error                                                                                   
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                               
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping inserted')
 
                                                                           
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Update Start')                                                                                 
                                       
                                        
 --Below update is for prevention of multiple processing the processed entry of offline table  
 
 update B2B_CommonPartyServices_Offline                                                                                       
 set to_be_processed = 'N',                                                                                      
 process_time_stamp = getdate(), 
 Reason_For_Non_Process='Due To Unavailablity of Source Dealr Code',                                                              
 other_remarks =                                                                                      
 ltrim(rtrim(isnull(other_remarks, '')))                                                                                      
 +                                                                           
 case                                                                                      
 when                                                                                      
 len(ltrim(rtrim(isnull(other_remarks, '')))) > 0                                                                                      
 then                                                    
 ' - '                                                                                      
 else                                                                                      
 ''                                                                                      
 end                                                                        
 +                                                                                      
 'MAPPING UNSUCCESSFUL'                                                                                      
 where to_be_processed = 'Y'
  and LEN(source_dealer_code)=0 -- Added by prasanna to avoid duplicate record entry.                  
 
                                                       
 update B2B_CommonPartyServices_Offline                                                                                       
 set to_be_processed = 'N',                                                                                      
 process_time_stamp = getdate(),                                                               
 other_remarks =                                                                                      
 ltrim(rtrim(isnull(other_remarks, '')))                                                                                      
 +                                                                           
 case                                                                                      
 when                                                                                      
 len(ltrim(rtrim(isnull(other_remarks, '')))) > 0                                                                                      
 then                                                    
 ' - '                                                                                      
 else                                                                                      
 ''                                                                                      
 end                                                                        
 +                                                                                      
 'MAPPING SUCCESSFUL'                                                                                      
 where to_be_processed = 'Y'
 --Uncommnet while going live.....................................................                                  
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'                                                                                 
                                          
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                                  
 If @@Errorcount <> 0 Goto LabelEnd                                                        
                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Updated')                                                                    
                                  
                                                                
 --************************************************************** End of Dealer Mapping  **********************************        
 
    
                                                     
 LabelEnd:                                                      
 If @@Errorcount <> 0                                                                    
 begin                                                                  
  Rollback Transaction                                                                                
 end                                                                  
 Else                                                                   
 begin                                                       
  Commit Transaction                                                     
 end          
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UP_CommonPartyServices_PVJ_bak
-- --------------------------------------------------
  

  
  CREATE PROCEDURE [dbo].[UP_CommonPartyServices_PVJ]    
WITH RECOMPILE    
AS    
BEGIN    
/*    
Case 1: Entry for New Clients    
Case 2: Entry for Inactive Client    
Case 3: Entry for Reactivated Clients & B2B To B2C  Shifting    
Case 4: Entry for Resigned Executive    
Case 5: Clients who shifted to Calnt branch     
  Case a) CLIENTS WHO HAVE BEEN SHIFTED INTO CALNT    
  Case b) CLIENTS WHO HAVE BEEN SHIFTED OUT OF CALNT    
Case 6: B2CToB2B shifting    
Case 7: BI Branch Mapping on 1st of month or Party branch change    
Case 8: Employee Transferred    
case 9: Entry for Next Day Dealer Mapping    
*/    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 SET NOCOUNT ON;    
  
 /* Variable declaration for Error Handling routine */    
 DECLARE @@Errorcount int                                                                                 
 SET @@Errorcount = 0         
 /* *********************************************** */    
     
 -- Handle rollback if any error occurs so that there will be consistency in tables for data    
 BEGIN TRANSACTION        
                                        
 /************************************************* Case 1: Entry for New Clients   ***************************** */       
     
 -- RAM Table for New client process to make the process faster.    
/* Declare @NewParty table    
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20)    
 )  
 */
 --Using has table because the data is very huge (4 lk and over) and while using table variable it was taking huhe time to delete all those records. 
  create table  #NewParty     
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20)    
 )     
     
 -- preparing the base table where all new Equity clients taken from backoffice or AngelClient1 table as on today    
 --insert into @NewParty                                                                   
 insert into #NewParty
 select distinct                                                                                           
 party_code = ltrim(rtrim(A.party_code)),                                                                                          
 emp_no = 'UNDEFINED',                                                                                          
 fromdate = convert(datetime, left(convert(varchar, A.ActiveFromEq, 109), 11) + ' 00:00:00'),                                                                                          
 todate = 'Dec 31 2049 23:59:00',                                                                                          
 entrydate = GETDATE(),                                                                                          
 valid = 'Y',     
 CommRank = 1,                                                         
 Remarks = 'UPCommonPartyServices - INSERT - NEW CLIENT',                                                                                     
 Branch_cd= A.Sub_Broker,                                                                                      
 dealerbranch_cd= A.Sub_Broker,       
 --Segment_Type = 'Equity'                                                               
 Segment_Type = 'ALL'   
 from AngelClient1 A  with (nolock)                                                       
 WHERE B2C = 'N'                                                                         
 and CL_type <> 'SUB' and
InActiveFrom >= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')                                                                          
 and ActiveFrom <= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')   and     
InactiveFrom > ActiveFrom              

                                      
    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd        
 

 -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty filled by Commodity')                             
 
     
 -- We are removing the clients which are already mapped    
 
                              
 /*Delete @NewParty     
 from crm.dbo.B2B_CommonPartyServices P with (nolock), @NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type    
 */
    
  Delete #NewParty     
 from B2B_CommonPartyServices P with (nolock), #NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type  

  

 --Error handling                                           
 
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd       

  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - removed duplicate')       

 -- We are removing the 98 clients from temp                                             
 Delete from #NewParty                                                            
 where Party_code like '98%'
                                                                                         
 --Error handling                                           
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd
  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - delete 98 clients')                                 
        
     
 -- removing the Currency clients which can be mapped from offline table on same day   
 delete #NewParty     
 from #NewParty T, B2B_CommonPartyServices_Offline C with (nolock)                                               
 where T.Party_code = C.Party_code                                                
 And to_be_processed = 'Y' and T.Segment_Type=C.Segment_Type                                                 


 --Error handling                                                                                
 set @@Errorcount = @@error                                                                  
 If @@Errorcount <> 0 Goto LabelEnd        

 
 -- Temp Commented Ankur 
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'removed Currency clients who mapped today')       
 -- Inserting the validated New clients in Partyservices                                                  


 
 
 insert into B2B_CommonPartyServices     
 Select   party_code, emp_no, fromdate, todate, entrydate, valid, CommRank, Remarks, Branch_cd, dealerbranch_cd, Segment_Type    
 From #NewParty                                                                          

                                             
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                     
                                 

   
                                                       
 -- Temp Commented Ankur --insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','New Client Entry DONE')                                                                                        
         
 /************************************************ New Client Process End ***************************************  */    


/********************************************** Case 2: Entry for Inactive Client  **************************** */    
   
-- Temp Commented Ankur -- insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process for Closed Client START')     
     
 -- RAM Table to process the closed clients from AngelClient1 table.    
 Declare @CloseParty table    
 (    
  party_code varchar(10),    
  emp_no varchar(10),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20)           
 )           

 -- preparing the base table to process the Closed Equity clients     
 insert into @CloseParty                                                                                      
 select distinct                                                                     
 party_code = ltrim(rtrim(c1.party_code)),                                                                       
 emp_no = 'UNDEFINED',                      
 fromdate = convert(datetime, left( convert( varchar, c1.inactivefromEQ, 109 ), 11 ) + ' 00:00:00'),                                                                                         
 todate = convert(datetime, left( convert( varchar, c1.inactivefromEQ, 109 ), 11 ) + ' 23:59:00'),                                                                                          
 entrydate = getdate(),                          
 valid = 'N',     
 CommRank=1,                                                                                        
 Remarks = 'UPCommonPartyServices - INSERT - CLOSED CLIENT',                                                                                        
 branch_cd=c1.branch_cd,                                                                                      
 dealerbranch=c1.Sub_Broker,    
-- Segment_Type = 'Equity'                                                                                           
Segment_Type = 'All'                                                                                           
 from AngelClient1 c1 with (nolock), B2B_CommonPartyServices p with (nolock)                                                                                  
 where ltrim(rtrim(p.party_code)) = ltrim(rtrim(c1.party_code))                                                                                 
 and c1.b2c = 'N'                                                                                        
 and c1.cl_type <> 'SUB'                                                    
 and p.valid = 'Y' and --P.Segment_Type = 'Equity'                                                            
 P.Segment_Type = 'ALL' 
 and p.todate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and activefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 00:00:00'                                                     
 and inactivefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and left(convert(varchar, activefrom, 109), 11) <> left(convert(varchar, inactivefrom, 109), 11)    

                                 
 --Error handling                                                                     
 set @@Errorcount = @@error                                                                          
 If @@Errorcount <> 0 Goto LabelEnd         
     
    
 -- updating the previous entry to close the mapping of Closed Clients                                                         
 update B2B_CommonPartyServices                                                                                 
 set todate = left(convert(varchar, dateadd(dd, -1, c.fromdate), 109), 11) + ' 23:59:00',                                                                                   
 valid = 'N',                                                                                
 Remarks = ltrim(rtrim(isnull(c.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLOSED CLIENT'                                                                                 
 from @CloseParty c, B2B_CommonPartyServices P with (nolock)                                                                                
 where c.Party_Code = P.Party_Code                                                                                
 and P.Valid = 'Y'     
 and P.Segment_Type = c.Segment_Type and P.CommRank = c.CommRank    
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                  
                  
                        
 -- Error handling                                                                    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                      
 

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','CommonPartyServices Updated For Closed Client')                         
                         
 -- to prevent the Closed client mapping  on the same day need to implement on UI level in Equity, commodity and currency                                              
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from @CloseParty c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'                           
                                 
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd       
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Update offline Currency entry for closed')                         
    
 -- insert the closed entry of undefined for equity, commodity and currency    
 insert into B2B_CommonPartyServices                                      
 Select Party_Code,                  
 Emp_No,                                        
 FromDate,                                        
 ToDate,                      
 EntryDate,                                        
 Valid,      
 CommRank,                                      
 Remarks,                                        
 branch_cd,                         
 Dealerbranch,    
 Segment_Type                                               
 from @CloseParty                                           
                             
--Error handling                                    
 set @@Errorcount = @@error                                                                                         
 If @@Errorcount <> 0 Goto LabelEnd     
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Closed client entry done.')                         
     
 /**************************************** Inactive Client Process End ******************************************  */ 
 
  /* ***************************************** Case 3: Entry for Reactivated Clients & B2C To B2B  Shifting ************************** */    

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process for Reactivation of Clients START')                                                                             
                           
                                              
 /* RAM Table to handle Reactivated Clients */    
 
 
 Declare @ReactivatedClients table    
 (    
  --ServiceID bigint,    
  party_code varchar(10),    
  emp_no varchar(10),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20)          
 )    
    
 /* First inserts the Equity Reactivated Clients who are closed in Partyservices but active in AngelClient1 table */    
 insert into @ReactivatedClients                                                                         
 select distinct     
 party_code = c1.party_code,                                                                 
 emp_no = 'UNDEFINED',      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                   
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',       
 CommRank = 1,                                                                             
 Remarks = 'UPCommonPartyServices - INSERT - REACTIVATED CLIENT',                                                                                  
 branch_cd=c1.branch_cd,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type                                                                                     
 from AngelClient1 c1  with (nolock), B2B_CommonPartyServices p  with(nolock)                                                                                  
 where c1.B2C = 'N' 
 and --Segment_Type = 'Equity' 
 Segment_Type = 'ALL' 
 and p.valid='N'                                                              
 and cl_type <> 'SUB' and c1.party_code = p.party_code                                                                 
 and c1.InactiveFrom >=  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 and c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') 
 --and c1.InactiveFromEq >=  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 --and c1.ActiveFromEq<= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                          
 and p.Emp_no = 'UNDEFINED'                         
     
     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                               
                                                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','temp table filled with equity')            
  
  --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd        
     
 /* Delete the Current mapping if exists in partyservices for reactivated entry */    
 delete 
	@ReactivatedClients 
 from 
	@ReactivatedClients b, B2B_CommonPartyServices PS with(nolock)    
 where 
	PS.party_code=b.party_code 
	and PS.valid='Y'     
	and b.Segment_Type=PS.Segment_Type                 
                     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
   
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','deleted all unwanted entries')          
        
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients and Reactivated Clients    
-------------------------------------------------------     
 insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type                                                 
 from @ReactivatedClients    
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                                                                           

                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Reactivated Clients Entry DONE')                                                                                  
     
   /**************************************** Reactivated Client Process End ******************************************  */       
       
   /* *****************************************Case 4: Entry for Resigned Executive ****************************************   */    
   /* if any client mapped to dealer and that dealer has resigned, then after 30 days the client should moved to undefined */    
       
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process Start for Resigned Dealer')                                                      
                                    
 /* RAM Table to handle Reactivated Clients */    
 Declare @ResignedDealer table    
 (    
  party_code varchar(10),    
  emp_no varchar(10),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20)         
 )    
    
 /* inserts all the equity, commodity and currency clients who has resigned dealer mapped currently in one temp table */    
 insert into @ResignedDealer    
 select distinct party_code = ltrim(rtrim(c1.party_code)),                                                                      
 emp_no = 'UNDEFINED',                                                                      
 fromdate = LEFT(convert (varchar, dateadd(dd, +31, A.InActiveFrom), 109 ), 11 ) + ' 00:00:00',                                                  
 todate = 'Dec 31 2049 23:59:00',                                           
 entrydate = getdate(),                                                                      
 valid = 'Y',      
 CommRank,                                                                   
 Remarks = 'UPCommonPartyServices - INSERT - CLIENT WITH RESIGNED EMPLOYEE',                                                                    
 branch_cd=c1.branch_cd,                                                                  
 dealerbranch=c1.branch_cd,    
 Segment_Type                                                        
 from B2B_Harmony A with (noLock), B2B_CommonPartyServices c1 with(nolock)                                                                    
 where A.Status <> 'A'                                                             
 and A.EmpCode  = c1.Emp_No                                                            
 and A.InActiveFrom  <= left( convert( varchar, dateadd(dd, -30, getdate()), 109 ), 11 ) + ' 23:59:00'                                                          
 and Valid = 'Y'    
                             
 --Error handling                                                   
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                    
                             
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'table for Resigned Executive DONE')                               
    
 /* update or close the previous mapping */    
 update B2B_CommonPartyServices                                                             
 set todate =  left(convert(varchar, dateadd(dd, -1, R.FromDate), 109), 11) + ' 23:59:00',                                                           
 valid = 'N',                                                            
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLIENT WITH RESIGNED DEALER'                                                             
 from @ResignedDealer R, B2B_CommonPartyServices P with (nolock)                                                           
 where R.Party_Code = P.Party_Code                                                     
 and P.Valid = 'Y'                                                             
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'    
 and P.Segment_Type = R.Segment_Type    
 and P.CommRank = R.CommRank                                                             
       
 -- Error handling                                                            
 set @@Errorcount = @@error                                                             
 If @@Errorcount <> 0 Goto LabelEnd                                                             
                                    
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','PartyServices Update for Resigned Executive DONE')                                                                 
     
 -- we are preventing the resigned executives to be mapped to the Currency clients                                      
 Update B2B_CommonPartyServices_Offline                     
 Set to_be_processed = 'N'                                   
 from @ResignedDealer R, B2B_CommonPartyServices_Offline O with (nolock)                                                
 where R.Party_Code = O.Party_code                                                   
 and to_be_processed = 'Y'                                                       
                             
 --Error handling                   
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                  
                                 
 insert into B2B_CommonPartyServices     
 Select Party_Code,                                        
   Emp_No,                                        
   FromDate,                                        
   ToDate,                                     
   EntryDate,                                        
   Valid,    
   CommRank,                                        
   Remarks,                                        
   branch_cd,                                        
   dealerbranch,    
   Segment_Type    
 From @ResignedDealer                                                                
                                    
 -- Error handling                                                            
 set @@Errorcount = @@error                                                             
 If @@Errorcount <> 0 Goto LabelEnd                       
                                    
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Entry done for Resigned Dealer')                                                                    
          
   /**************************************** Resigned Dealer Process End ******************************************  */        
  
  /************************************************** Case 6: B2BToB2C shifting**********************************   
-------------------------------------------------------    
 --Craete RAM Table for B2CToB2B shifting    
 -------------------------------------------------------    
 Declare @B2BToB2CParty table      
 (      
  party_code varchar(10),      
  emp_no varchar(10),      
  fromdate smalldatetime,      
  todate smalldatetime,      
  entrydate smalldatetime,      
  valid char(1),      
  CommRank int,      
  Remarks varchar(5000),      
  branch_cd varchar(10),      
  dealerbranch varchar(10),      
  Segment_Type varchar(20)           
 )      
-------------------------------------------------------    
--Insert B2C to B2B shifted clients into RAM table    
-------------------------------------------------------     
insert into @B2BToB2CParty           
   select distinct party_code=ps.party_code,          
  emp_no = 'UNDEFINED',          
  fromdate = left(getdate(),11 ) + ' 00:00',          
  todate = left(getdate(),11) + ' 23:59',          
  entrydate = getdate(),          
  valid = 'N',      
  CommRank=PS.CommRank ,       
  Remarks = 'UPCommonPartyServices - INSERT - B2CTOB2B SHIFTED CLIENT',          
  branch_cd=a1.branch_cd,          
  dealerbranch=a1.Sub_Broker,          
  PS.Segment_Type    
  from crm.dbo.B2B_CommonPartyServices PS with(nolock), angelcs..AngelClient1 a1 with(nolock)          
  where  ltrim(rtrim(ps.party_code)) = ltrim(rtrim(a1.party_code))           
  and PS.valid='Y'          
  and a1.b2c<> 'Y'       
      
   -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','table filled for B2C to B2B shifting')                                                   
    
-------------------------------------------------------    
--Update for B2C to B2B shifted clients    
-------------------------------------------------------     
 update crm.dbo.B2B_CommonPartyServices  set                                                                                 
  todate = left(dateadd(dd, -1, GETDATE()), 11) + ' 23:59',                                                                      
 valid = 'N',                                                                                  
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - B2CTOB2B SHIFTED CLIENT'                                                                                   
 from @B2BToB2CParty  c, crm.dbo.B2B_CommonPartyServices P with (nolock)                                                                                  
 where c.Party_Code = P.Party_Code                                                                                  
 and P.Valid = 'Y'       
 and c.CommRank= P.CommRank    
 and P.Segment_Type = c.Segment_Type     
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'     
     
    -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','update for previous entry B2C to B2B shifting')                                                   
    
-----------------------------------------------------------    
--Update Offline table entry    
-----------------------------------------------------------    
  Update crm.dbo.B2B_CommonPartyServices_Offline                                                  
 Set to_be_processed = 'N'                                                  
 from @B2BToB2CParty c, crm.dbo.B2B_CommonPartyServices_Offline t with (nolock)                                                 
 where c.Party_Code = t.Party_code                                                     
 and to_be_processed = 'Y'  and c.Segment_Type=t.Segment_Type and c.commrank = t.commrank      
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients    
-------------------------------------------------------     
  insert into crm.dbo.B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type                                                 
 from @B2BToB2CParty      
     
    -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process end for B2C to B2B shifting')                                                   
    
-------------------------------------------------------    
--END B2C to B2B shifted clients    
-------------------------------------------------------          
 */ 
     
 /******************************************** case 8: Entry for  Next Day Dealer Mapping ***********************  */
                                                                 
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Next Days Mapping Start')                                                           
    

 ---- Update the Common Partyservices entry from the Common Offline Table for current mapping of UI         
 update B2B_CommonPartyServices                                                                                         
 set valid = 'N',                                                                                      
 todate = left(convert(varchar, dateadd(dd, -1, o.from_date), 109), 11) + ' 23:59:00',                                                     
 Remarks = Remarks + ';' + 'OFFLINE - UPDATE'                                                                                    
 from B2B_CommonPartyServices_Offline o with (nolock), B2B_CommonPartyServices P with (nolock)                                       
 where ltrim(rtrim(P.party_code)) = ltrim(rtrim(o.party_code))                                                                                      
 and ltrim(rtrim(P.emp_no)) = ltrim(rtrim(o.source_dealer_code))                                                                         
 and P.valid = 'Y' and o.to_be_processed = 'Y' and P.Segment_Type = o.Segment_Type       
 and P.CommRank = o.CommRank  
 --Uncommnet while going live.....................................................                                                                                  
 --and o.entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'     
 
 
            
 -- Error handling                                                                            
 set @@Errorcount = @@error                                                              
 If @@Errorcount <> 0 Goto LabelEnd     
                          
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping updated')                                                                                

                                                                  
 insert into B2B_CommonPartyServices                                                                                     
 (                                                                                      
  party_code,                                                                                      
  emp_no,                                                         
  fromdate,                                                                         
  todate,                      
  entrydate,                                                                                      
  valid,     
  CommRank,                                                                                     
  Remarks,                                                                                      
  branch_cd,                                                                                    
  Dealerbranch,    
  Segment_Type                                                
 )                                                                          
 select distinct party_code = ltrim(rtrim(dm.party_code)),                                                                                      
 emp_no = ltrim(rtrim(dm.target_dealer_code)),                                                                                      
 fromdate = dm.from_date,                                     
 todate = dm.to_date,                                                                                      
 entrydate = getdate(),                                                                                      
 valid = 'Y',      
 CommRank,                                                                                    
 Remarks = 'UPCommonPartyServices - INSERT Offline Table Entry',                                                                             
 branch_cd = (case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.SBTAg end),    --dm.branch_cd,                                                                        
 Dealerbranch=(case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.SBTAg end),    
 Segment_Type                                                                                    
 from B2B_CommonPartyServices_Offline dm with(nolock),B2B_Harmony ah with(nolock)                                               
 where to_be_processed = 'Y'                                 
 and( dm.target_dealer_code=ah.empcode  or upper(dm.target_dealer_code)='UNDEFINED') --checking if client is getting mapped to undefined.
 --Uncommnet while going live..................................................... 
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'      
                                          
 -- Error handling                                                                                  
 set @@Errorcount = @@error                                                                                   
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                               
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping inserted')
 
                                                                           
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Update Start')                                                                                 
                                       
                                        
 --Below update is for prevention of multiple processing the processed entry of offline table  
                                                       
 update B2B_CommonPartyServices_Offline                                                                                       
 set to_be_processed = 'N',                                                                                      
 process_time_stamp = getdate(),                                                               
 other_remarks =                                                                                      
 ltrim(rtrim(isnull(other_remarks, '')))                                                                                      
 +                                                                           
 case                                                                                      
 when                                                                                      
 len(ltrim(rtrim(isnull(other_remarks, '')))) > 0                                                                                      
 then                                                    
 ' - '                                                                                      
 else                                                                                      
 ''                                                                                      
 end                                                                        
 +                                                                                      
 'MAPPING SUCCESSFUL'                                                                                      
 where to_be_processed = 'Y'
 --Uncommnet while going live.....................................................                                  
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'                                                                                 
                                          
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                                  
 If @@Errorcount <> 0 Goto LabelEnd                                                        
                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Updated')                                                                    
                                  
                                                                
 --************************************************************** End of Dealer Mapping  **********************************        
 
    
                                                     
 LabelEnd:                                                      
 If @@Errorcount <> 0                                                                    
 begin                                                                  
  Rollback Transaction                                                                                
 end                                                                  
 Else                                                                   
 begin                                                       
  Commit Transaction                                                     
 end          
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UP_CommonPartyServices_PVJ_New_bak
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[UP_CommonPartyServices_PVJ_New]    
WITH RECOMPILE    
AS    
BEGIN    
/*    
Case 1: Entry for New Clients    
Case 2: Entry for Inactive Client    
Case 3: Entry for Reactivated Clients & B2B To B2C  Shifting    
Case 4: Entry for Resigned Executive    
Case 5: Clients who shifted to Calnt branch     
  Case a) CLIENTS WHO HAVE BEEN SHIFTED INTO CALNT    
  Case b) CLIENTS WHO HAVE BEEN SHIFTED OUT OF CALNT    
Case 6: B2CToB2B shifting    
Case 7: BI Branch Mapping on 1st of month or Party branch change    
Case 8: Employee Transferred    
case 9: Entry for Next Day Dealer Mapping    
*/    
-- B2B_AngelHarmony
 -- SET NOCOUNT ON added to prevent extra result sets from    
 SET NOCOUNT ON;    
  
 /* Variable declaration for Error Handling routine */    
 DECLARE @@Errorcount int                                                                                 
 SET @@Errorcount = 0         
 /* *********************************************** */    
     
 -- Handle rollback if any error occurs so that there will be consistency in tables for data    
 BEGIN TRANSACTION        
                                        
 /************************************************* Case 1: Entry for New Clients   ***************************** */       
     
 -- RAM Table for New client process to make the process faster.    
/* Declare @NewParty table    
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20)    
 )  
 */
 --Using has table because the data is very huge (4 lk and over) and while using table variable it was taking huhe time to delete all those records. 
  create table  #NewParty     
 (    
  party_code Varchar(20),    
  emp_no varchar(20),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  Branch_cd varchar(10),    
  dealerbranch_cd varchar(10),    
  Segment_Type varchar(20)    
 )     
     
 -- preparing the base table where all new Equity clients taken from backoffice or AngelClient1 table as on today    
 --insert into @NewParty                                                                   
 insert into #NewParty
 select distinct                                                                                           
 party_code = ltrim(rtrim(A.party_code)),                                                                                          
 emp_no = 'UNDEFINED',                                                                                          
 fromdate = convert(datetime, left(convert(varchar, A.ActiveFromEq, 109), 11) + ' 00:00:00'),                                                                                          
 todate = 'Dec 31 2049 23:59:00',                                                                                          
 entrydate = GETDATE(),                                                                                          
 valid = 'Y',     
 CommRank = 1,                                                         
 Remarks = 'UPCommonPartyServices - INSERT - NEW CLIENT',                                                                                     
 Branch_cd= A.Sub_Broker,                                                                                      
 dealerbranch_cd= A.Sub_Broker,       
 --Segment_Type = 'Equity'                                                               
 Segment_Type = 'ALL'   
 from AngelClient1 A  with (nolock)                                                       
 WHERE B2C = 'N'                                                                         
 and CL_type <> 'SUB' and
InActiveFrom >= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')                                                                          
 and ActiveFrom <= convert(datetime, left( convert( varchar, Getdate(), 109 ), 11 ) + ' 23:59:00')   and     
InactiveFrom > ActiveFrom              

                                      
    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd        
 

 -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty filled by Commodity')                             
 
     
 -- We are removing the clients which are already mapped    
 
                              
 /*Delete @NewParty     
 from crm.dbo.B2B_CommonPartyServices P with (nolock), @NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type    
 */
    
  Delete #NewParty     
 from B2B_CommonPartyServices P with (nolock), #NewParty T                                      
 where T.Party_code = P.Party_code     
 and T.Segment_Type = P.Segment_Type  

  

 --Error handling                                           
 
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd       

  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - removed duplicate')       

 -- We are removing the 98 clients from temp                                             
 Delete from #NewParty                                                            
 where Party_code like '98%'
                                                                                         
 --Error handling                                           
 set @@Errorcount = @@error                                  
 If @@Errorcount <> 0 Goto LabelEnd
  -- Temp Commented Ankur 
  insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty - delete 98 clients')                                 
        
     
 -- removing the Currency clients which can be mapped from offline table on same day   
 delete #NewParty     
 from #NewParty T, B2B_CommonPartyServices_Offline C with (nolock)                                               
 where T.Party_code = C.Party_code                                                
 And to_be_processed = 'Y' and T.Segment_Type=C.Segment_Type                                                 


 --Error handling                                                                                
 set @@Errorcount = @@error                                                                  
 If @@Errorcount <> 0 Goto LabelEnd        

 
 -- Temp Commented Ankur 
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'removed Currency clients who mapped today')       
 -- Inserting the validated New clients in Partyservices                                                  


 
 
 insert into B2B_CommonPartyServices     
 Select   party_code, emp_no, fromdate, todate, entrydate, valid, CommRank, Remarks, Branch_cd, dealerbranch_cd, Segment_Type    
 From #NewParty                                                                          

                                             
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                     
                                 

   
                                                       
 -- Temp Commented Ankur --insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','New Client Entry DONE')                                                                                        
         
 /************************************************ New Client Process End ***************************************  */    


/********************************************** Case 2: Entry for Inactive Client  **************************** */    
   
-- Temp Commented Ankur -- insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process for Closed Client START')     
     
 -- RAM Table to process the closed clients from AngelClient1 table.    
 Declare @CloseParty table    
 (    
  party_code varchar(10),    
  emp_no varchar(10),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20)           
 )           

 -- preparing the base table to process the Closed Equity clients     
 insert into @CloseParty                                                                                      
 select distinct                                                                     
 party_code = ltrim(rtrim(c1.party_code)),                                                                       
 emp_no = 'UNDEFINED',                      
 fromdate = convert(datetime, left( convert( varchar, c1.inactivefromEQ, 109 ), 11 ) + ' 00:00:00'),                                                                                         
 todate = convert(datetime, left( convert( varchar, c1.inactivefromEQ, 109 ), 11 ) + ' 23:59:00'),                                                                                          
 entrydate = getdate(),                          
 valid = 'N',     
 CommRank=1,                                                                                        
 Remarks = 'UPCommonPartyServices - INSERT - CLOSED CLIENT',                                                                                        
 branch_cd=c1.branch_cd,                                                                                      
 dealerbranch=c1.Sub_Broker,    
-- Segment_Type = 'Equity'                                                                                           
Segment_Type = 'All'                                                                                           
 from AngelClient1 c1 with (nolock), B2B_CommonPartyServices p with (nolock)                                                                                  
 where ltrim(rtrim(p.party_code)) = ltrim(rtrim(c1.party_code))                                                                                 
 and c1.b2c = 'N'                                                                                        
 and c1.cl_type <> 'SUB'                                                    
 and p.valid = 'Y' and --P.Segment_Type = 'Equity'                                                            
 P.Segment_Type = 'ALL' 
 and p.todate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and activefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 00:00:00'                                                     
 and inactivefrom <= left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                        
 and left(convert(varchar, activefrom, 109), 11) <> left(convert(varchar, inactivefrom, 109), 11)    

                                 
 --Error handling                                                                     
 set @@Errorcount = @@error                                                                          
 If @@Errorcount <> 0 Goto LabelEnd         
     
    
 -- updating the previous entry to close the mapping of Closed Clients                                                         
 update B2B_CommonPartyServices                                                                                 
 set todate = left(convert(varchar, dateadd(dd, -1, c.fromdate), 109), 11) + ' 23:59:00',                                                                                   
 valid = 'N',                                                                                
 Remarks = ltrim(rtrim(isnull(c.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLOSED CLIENT'                                                                                 
 from @CloseParty c, B2B_CommonPartyServices P with (nolock)                                                                                
 where c.Party_Code = P.Party_Code                                                                                
 and P.Valid = 'Y'     
 and P.Segment_Type = c.Segment_Type and P.CommRank = c.CommRank    
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'                                                                                  
                  
                        
 -- Error handling                                                                    
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                      
 

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','CommonPartyServices Updated For Closed Client')                         
                         
 -- to prevent the Closed client mapping  on the same day need to implement on UI level in Equity, commodity and currency                                              
 Update B2B_CommonPartyServices_Offline                                                
 Set to_be_processed = 'N'                                                
 from @CloseParty c, B2B_CommonPartyServices_Offline t with (nolock)                                               
 where c.Party_Code = t.Party_code                                                   
 and to_be_processed = 'Y'                           
                                 
 --Error handling                                                                                
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd       
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Update offline Currency entry for closed')                         
    
 -- insert the closed entry of undefined for equity, commodity and currency    
 insert into B2B_CommonPartyServices                                      
 Select Party_Code,                  
 Emp_No,                                        
 FromDate,                                        
 ToDate,                      
 EntryDate,                                        
 Valid,      
 CommRank,                                      
 Remarks,                                        
 branch_cd,                         
 Dealerbranch,    
 Segment_Type                                               
 from @CloseParty                                           
                             
--Error handling                                    
 set @@Errorcount = @@error                                                                                         
 If @@Errorcount <> 0 Goto LabelEnd     
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Closed client entry done.')                         
     
 /**************************************** Inactive Client Process End ******************************************  */ 
 
  /* ***************************************** Case 3: Entry for Reactivated Clients & B2C To B2B  Shifting ************************** */    

 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process for Reactivation of Clients START')                                                                             
                           
                                              
 /* RAM Table to handle Reactivated Clients */    
 
 
 Declare @ReactivatedClients table    
 (    
  --ServiceID bigint,    
  party_code varchar(10),    
  emp_no varchar(10),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20)          
 )    
    
 /* First inserts the Equity Reactivated Clients who are closed in Partyservices but active in AngelClient1 table */    
 insert into @ReactivatedClients                                                                         
 select distinct     
 party_code = c1.party_code,                                                                 
 emp_no = 'UNDEFINED',      
 fromdate = left(  GETDATE(), 11 ) + ' 00:00',                                                                                   
 todate =  'Dec 31 2049 23:59:00',                                                                                    
 entrydate = getdate(),                                                                              
 valid = 'Y',       
 CommRank = 1,                                                                             
 Remarks = 'UPCommonPartyServices - INSERT - REACTIVATED CLIENT',                                                                                  
 branch_cd=c1.branch_cd,                                                                                
 dealerbranch=c1.Sub_Broker,      
 Segment_Type                                                                                     
 from AngelClient1 c1  with (nolock), B2B_CommonPartyServices p  with(nolock)                                                                                  
 where c1.B2C = 'N' 
 and --Segment_Type = 'Equity' 
 Segment_Type = 'ALL' 
 and p.valid='N'                                                              
 and cl_type <> 'SUB' and c1.party_code = p.party_code                                                                 
 and c1.InactiveFrom >=  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 and c1.ActiveFrom <= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00') 
 --and c1.InactiveFromEq >=  convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                                        
 --and c1.ActiveFromEq<= convert(datetime, left(  Getdate(), 11 ) + ' 23:59:00')                          
 and p.Emp_no = 'UNDEFINED'                         
     
     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                               
                                                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','temp table filled with equity')            
  
  --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd        
     
 /* Delete the Current mapping if exists in partyservices for reactivated entry */    
 delete 
	@ReactivatedClients 
 from 
	@ReactivatedClients b, B2B_CommonPartyServices PS with(nolock)    
 where 
	PS.party_code=b.party_code 
	and PS.valid='Y'     
	and b.Segment_Type=PS.Segment_Type                 
                     
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
   
 --Error handling                                                               
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd      
     
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','deleted all unwanted entries')          
        
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients and Reactivated Clients    
-------------------------------------------------------     
 insert into B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type                                                 
 from @ReactivatedClients    
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                           
 If @@Errorcount <> 0 Goto LabelEnd                                                                           

                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Reactivated Clients Entry DONE')                                                                                  
     
   /**************************************** Reactivated Client Process End ******************************************  */       
       
   /* *****************************************Case 4: Entry for Resigned Executive ****************************************   */    
   /* if any client mapped to dealer and that dealer has resigned, then after 30 days the client should moved to undefined */    
       
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Process Start for Resigned Dealer')                                                      
                                    
 /* RAM Table to handle Reactivated Clients */    
 Declare @ResignedDealer table    
 (    
  party_code varchar(10),    
  emp_no varchar(10),    
  fromdate smalldatetime,    
  todate smalldatetime,    
  entrydate smalldatetime,    
  valid char(1),    
  CommRank int,    
  Remarks varchar(5000),    
  branch_cd varchar(10),    
  dealerbranch varchar(10),    
  Segment_Type varchar(20)         
 )    
    
 /* inserts all the equity, commodity and currency clients who has resigned dealer mapped currently in one temp table */  
 /*Commented as InactiveFrom is not present in New Harmony Table

 insert into @ResignedDealer    
 select distinct party_code = ltrim(rtrim(c1.party_code)),                                                                      
 emp_no = 'UNDEFINED',                                                                      
 fromdate = LEFT(convert (varchar, dateadd(dd, +31, A.InActiveFrom), 109 ), 11 ) + ' 00:00:00',                                                  
 todate = 'Dec 31 2049 23:59:00',                                           
 entrydate = getdate(),                                                                      
 valid = 'Y',      
 CommRank,                                                                   
 Remarks = 'UPCommonPartyServices - INSERT - CLIENT WITH RESIGNED EMPLOYEE',                                                                    
 branch_cd=c1.branch_cd,                                                                  
 dealerbranch=c1.branch_cd,    
 Segment_Type                                                        
 from B2B_AngelHarmony A with (noLock), B2B_CommonPartyServices c1 with(nolock)                                                                    
 where 
 A.isSuspended =0,                                                             
 A.isTerminated =0,
 and A.Emp_No  = c1.Emp_No                                                            
  and A.InActiveFrom  <= left( convert( varchar, dateadd(dd, -30, getdate()), 109 ), 11 ) + ' 23:59:00'                                                          
 and Valid = 'Y'    
                             
 --Error handling                                                   
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                    
           
 */                     
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'table for Resigned Executive DONE')                               
    
 /* update or close the previous mapping */    
 update B2B_CommonPartyServices                                                             
 set todate =  left(convert(varchar, dateadd(dd, -1, R.FromDate), 109), 11) + ' 23:59:00',                                                           
 valid = 'N',                                                            
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - CLIENT WITH RESIGNED DEALER'                                                             
 from @ResignedDealer R, B2B_CommonPartyServices P with (nolock)                                                           
 where R.Party_Code = P.Party_Code                                                     
 and P.Valid = 'Y'                                                             
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'    
 and P.Segment_Type = R.Segment_Type    
 and P.CommRank = R.CommRank                                                             
       
 -- Error handling                                                            
 set @@Errorcount = @@error                                                             
 If @@Errorcount <> 0 Goto LabelEnd                                                             
                                    
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','PartyServices Update for Resigned Executive DONE')                                                                 
     
 -- we are preventing the resigned executives to be mapped to the Currency clients                                      
 Update B2B_CommonPartyServices_Offline                     
 Set to_be_processed = 'N'                                   
 from @ResignedDealer R, B2B_CommonPartyServices_Offline O with (nolock)                                                
 where R.Party_Code = O.Party_code                                                   
 and to_be_processed = 'Y'                                                       
                             
 --Error handling                   
 set @@Errorcount = @@error                                                                                 
 If @@Errorcount <> 0 Goto LabelEnd                                                  
                                 
 insert into B2B_CommonPartyServices     
 Select Party_Code,                                        
   Emp_No,                                        
   FromDate,                                        
   ToDate,                                     
   EntryDate,                                        
   Valid,    
   CommRank,                                        
   Remarks,                                        
   branch_cd,                                        
   dealerbranch,    
   Segment_Type    
 From @ResignedDealer                                                                
                                    
 -- Error handling                                                            
 set @@Errorcount = @@error                                                             
 If @@Errorcount <> 0 Goto LabelEnd                       
                                    
 insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', 'Entry done for Resigned Dealer')                                                                    
          
   /**************************************** Resigned Dealer Process End ******************************************  */        
  
  /************************************************** Case 6: B2BToB2C shifting**********************************   
-------------------------------------------------------    
 --Craete RAM Table for B2CToB2B shifting    
 -------------------------------------------------------    
 Declare @B2BToB2CParty table      
 (      
  party_code varchar(10),      
  emp_no varchar(10),      
  fromdate smalldatetime,      
  todate smalldatetime,      
  entrydate smalldatetime,      
  valid char(1),      
  CommRank int,      
  Remarks varchar(5000),      
  branch_cd varchar(10),      
  dealerbranch varchar(10),      
  Segment_Type varchar(20)           
 )      
-------------------------------------------------------    
--Insert B2C to B2B shifted clients into RAM table    
-------------------------------------------------------     
insert into @B2BToB2CParty           
   select distinct party_code=ps.party_code,          
  emp_no = 'UNDEFINED',          
  fromdate = left(getdate(),11 ) + ' 00:00',          
  todate = left(getdate(),11) + ' 23:59',          
  entrydate = getdate(),          
  valid = 'N',      
  CommRank=PS.CommRank ,       
  Remarks = 'UPCommonPartyServices - INSERT - B2CTOB2B SHIFTED CLIENT',          
  branch_cd=a1.branch_cd,          
  dealerbranch=a1.Sub_Broker,          
  PS.Segment_Type    
  from crm.dbo.B2B_CommonPartyServices PS with(nolock), angelcs..AngelClient1 a1 with(nolock)          
  where  ltrim(rtrim(ps.party_code)) = ltrim(rtrim(a1.party_code))           
  and PS.valid='Y'          
  and a1.b2c<> 'Y'       
      
   -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','table filled for B2C to B2B shifting')                                                   
    
-------------------------------------------------------    
--Update for B2C to B2B shifted clients    
-------------------------------------------------------     
 update crm.dbo.B2B_CommonPartyServices  set                                                                                 
  todate = left(dateadd(dd, -1, GETDATE()), 11) + ' 23:59',                                                                      
 valid = 'N',                                                                                  
 Remarks = ltrim(rtrim(isnull(P.Remarks, ''))) + ';' + 'UPCommonPartyServices - UPDATE - B2CTOB2B SHIFTED CLIENT'                                                                                   
 from @B2BToB2CParty  c, crm.dbo.B2B_CommonPartyServices P with (nolock)                                                                                  
 where c.Party_Code = P.Party_Code                                                                                  
 and P.Valid = 'Y'       
 and c.CommRank= P.CommRank    
 and P.Segment_Type = c.Segment_Type     
 and P.ToDate > left( convert( varchar, getdate(), 109 ), 11 ) + ' 23:59:00'     
     
    -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','update for previous entry B2C to B2B shifting')                                                   
    
-----------------------------------------------------------    
--Update Offline table entry    
-----------------------------------------------------------    
  Update crm.dbo.B2B_CommonPartyServices_Offline                                                  
 Set to_be_processed = 'N'                                                  
 from @B2BToB2CParty c, crm.dbo.B2B_CommonPartyServices_Offline t with (nolock)                                                 
 where c.Party_Code = t.Party_code                                                     
 and to_be_processed = 'Y'  and c.Segment_Type=t.Segment_Type and c.commrank = t.commrank      
-------------------------------------------------------    
--Insert UNDEFINED entries for B2C to B2B shifted clients    
-------------------------------------------------------     
  insert into crm.dbo.B2B_CommonPartyServices                                        
 Select Party_Code,                    
 Emp_No,                                          
 FromDate,                                          
 ToDate,                                          
 EntryDate,                                          
 Valid,        
 CommRank,                                        
 Remarks,                                          
 branch_cd,                           
 dealerbranch,      
 Segment_Type                                                 
 from @B2BToB2CParty      
     
    -- Error handling                                                            
 set @@Errorcount = @@error                                                        
 If @@Errorcount <> 0 Goto LabelEnd                                                              
                                        
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Process end for B2C to B2B shifting')                                                   
    
-------------------------------------------------------    
--END B2C to B2B shifted clients    
-------------------------------------------------------          
 */ 
     
 /******************************************** case 8: Entry for  Next Day Dealer Mapping ***********************  */
                                                                 
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Next Days Mapping Start')                                                           
    

 ---- Update the Common Partyservices entry from the Common Offline Table for current mapping of UI         
 update B2B_CommonPartyServices                                                                                         
 set valid = 'N',                                                                                      
 todate = left(convert(varchar, dateadd(dd, -1, o.from_date), 109), 11) + ' 23:59:00',                                                     
 Remarks = Remarks + ';' + 'OFFLINE - UPDATE'                                                                                    
 from B2B_CommonPartyServices_Offline o with (nolock), B2B_CommonPartyServices P with (nolock)                                       
 where ltrim(rtrim(P.party_code)) = ltrim(rtrim(o.party_code))                                                                                      
 and ltrim(rtrim(P.emp_no)) = ltrim(rtrim(o.source_dealer_code))                                                                         
 and P.valid = 'Y' and o.to_be_processed = 'Y' and P.Segment_Type = o.Segment_Type       
 and P.CommRank = o.CommRank  
 --Uncommnet while going live.....................................................                                                                                  
 --and o.entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'     
 
 
            
 -- Error handling                                                                            
 set @@Errorcount = @@error                                                              
 If @@Errorcount <> 0 Goto LabelEnd     
                          
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping updated')                                                                                

                                                                  
 insert into B2B_CommonPartyServices                                                                                     
 (                                                                                      
  party_code,                                                                                      
  emp_no,                                                         
  fromdate,                                                                         
  todate,                      
  entrydate,                                                                                      
  valid,     
  CommRank,                                                                                     
  Remarks,                                                                                      
  branch_cd,                                                                                    
  Dealerbranch,    
  Segment_Type                                                
 )                                                                          
 select distinct party_code = ltrim(rtrim(dm.party_code)),                                                                                      
 emp_no = ltrim(rtrim(dm.target_dealer_code)),                                                                                      
 fromdate = dm.from_date,                                     
 todate = dm.to_date,                                                                                      
 entrydate = getdate(),                                                                                      
 valid = 'Y',      
 CommRank,                                                                                    
 Remarks = 'UPCommonPartyServices - INSERT Offline Table Entry',                                                                             
 branch_cd = (case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.Sb_Tag end),    --dm.branch_cd,                                                                        
 Dealerbranch=(case when dm.target_dealer_code = 'UNDEFINED' then dm.branch_cd else ah.Sb_Tag end),    
 Segment_Type                                                                                    
 from B2B_CommonPartyServices_Offline dm with(nolock),B2B_AngelHarmony ah with(nolock)                                               
 where to_be_processed = 'Y'                                 
 and( dm.target_dealer_code=ah.Emp_No  or upper(dm.target_dealer_code)='UNDEFINED') --checking if client is getting mapped to undefined.
 --Uncommnet while going live..................................................... 
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'      
                                          
 -- Error handling                                                                                  
 set @@Errorcount = @@error                                                                                   
 If @@Errorcount <> 0 Goto LabelEnd                                                                                 
                                                               
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','partyservices Mapping inserted')
 
                                                                           
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Update Start')                                                                                 
                                       
                                        
 --Below update is for prevention of multiple processing the processed entry of offline table  
                                                       
 update B2B_CommonPartyServices_Offline                                                                                       
 set to_be_processed = 'N',                                                                                      
 process_time_stamp = getdate(),                                                               
 other_remarks =                                                                                      
 ltrim(rtrim(isnull(other_remarks, '')))                                                                                      
 +                                                                           
 case                                                                                      
 when                                                                                      
 len(ltrim(rtrim(isnull(other_remarks, '')))) > 0                                                                                      
 then                                                    
 ' - '                                                                                      
 else                                                                                      
 ''                                                                                      
 end                                                                        
 +                                                                                      
 'MAPPING SUCCESSFUL'                                                                                      
 where to_be_processed = 'Y'
 --Uncommnet while going live.....................................................                                  
 --and entry_time_stamp <= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'                                                                                 
                                          
 -- Error handling                                                                          
 set @@Errorcount = @@error                                                                                  
 If @@Errorcount <> 0 Goto LabelEnd                                                        
                                
 insert into processlogtemp values('UPCommonPartyServices',getdate(),'YES','CommonPartyServices','Offline Table Updated')                                                                    
                                  
                                                                
 --************************************************************** End of Dealer Mapping  **********************************        
 
    
                                                     
 LabelEnd:                                                      
 If @@Errorcount <> 0                                                                    
 begin                                                                  
  Rollback Transaction                                                                                
 end                                                                  
 Else                                                                   
 begin                                                       
  Commit Transaction                                                     
 end          
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Up_USERS
-- --------------------------------------------------
 CREATE proc [dbo].[Up_USERS]  
AS  
BEGIN  
  
/******--Insert new users in [AngelUsers]****/  
    insert into processlogtemp values('Up_USERS', getdate(), 'YES', 'angelusers', 'START')           
    
    
insert into [AngelUsers] (BOUserFirstName,BOUserLastName,BOUserName,HarmonyEmployeeCode,BOUserPassword,BOStatusId,BOStatusName,FldUserId,  
Branch_Cd,UserLevel,UserLevel1,Region,Area,BOCategory,Software,MimansaStatusid,MimansaStatusName,User_Code,UserStatusID,UserStatusName,  
UserCreationDate)  
  
select BOUserFirstName=First_Name,BOUserLastName=Last_Name,BOUserName=Emp_Name,HarmonyEmployeeCode=Emp_No,BOUserPassword=Emp_pass,  
BOStatusId=(case when isAdmin='1' then 'SUBBROKER' when isDealer='1' then 'SBDEALER' end),  
BOStatusName=(case when isAdmin='1' then Sb_Tag when isDealer='1' then Emp_No end ),  
FldUserId='',Branch_Cd=Sb_Tag,  
UserLevel='',UserLevel1='',Region='',Area='',BOCategory='',  
Software='MIMANSA',  
MimansaStatusid=(case when isAdmin='1' then 'SUBBROKER' when isDealer='1' then 'SBDEALER' end),  
MimansaStatusName=(case when isAdmin='1' then Sb_Tag when isDealer='1' then Emp_No end ),  
User_Code='',UserStatusID='',UserStatusName='',  
UserCreationDate=getdate()   
from B2B_AngelHarmony ah with(nolock)  
where  Emp_No not in (select HarmonyEmployeeCode from [AngelUsers] with(nolock))  
  
  
  
     insert into processlogtemp values('Up_USERS', getdate(), 'YES', 'angelusers', 'END')       
     
        insert into processlogtemp values('Up_USERS', getdate(), 'YES', 'AngelBOMenu', 'START')       
/*******INSERT MENU*****/  
--For Admin  
insert into AngelBOMenu(AngelUserID,BOUserName,HarmonyEmployeeCode,ReportName,ReportPath,ReportGroupName,ReportMenuName,  
ReportMenuGroup,Software,Entry_date)  
select * from (  
select AngelUserID='',BOUserName='',HarmonyEmployeeCode=Emp_no,MR.ReportName,MR.ReportPath,ReportGroupName=MM.ModuleName,  
ReportMenuName=MA.ApplicationName,ReportMenuGroup=MR.ApplicationId,  
Software='MIMANSA',Entry_date=getdate()  
from B2B_AngelHarmony a1 with(nolock) ,MimansaReports MR with (nolock) ,[MimansaModules] MM with (nolock),[MimansaApplications] MA with(nolock)  
where MR.ApplicationId = 1   and   
 MR.ModuleId=MM.ModuleId and  
 MR.ApplicationId=MM.ApplicationId and  
 MR.ApplicationId=MA.ApplicationId and  
   MR.reportid in   
  (1,--Client Details  
  2,--Segmentwise Turnover Report  
  3,--MIS Report  
  4,--RealTime TO Report  
  5,--,--Dealer Mapping  
  --6--Bulk Mapping  
  8,--Employee Details
	9,--Role and Capability
	10,--Payroll
	11--Change Password
  )    
  and a1.isAdmin='1'    
) A  
where HarmonyEmployeeCode not in   
(select HarmonyEmployeeCode from AngelBOMenu with(nolock) )  
    
--For Dealer  
insert into AngelBOMenu(AngelUserID,BOUserName,HarmonyEmployeeCode,ReportName,ReportPath,ReportGroupName,ReportMenuName,  
ReportMenuGroup,Software,Entry_date)  
select * from (  
select AngelUserID='',BOUserName='',HarmonyEmployeeCode=Emp_no,MR.ReportName,MR.ReportPath,ReportGroupName=MM.ModuleName,  
ReportMenuName=MA.ApplicationName,ReportMenuGroup=MR.ApplicationId,  
Software='MIMANSA',Entry_date=getdate()  
from B2B_AngelHarmony a1 with(nolock) ,MimansaReports MR with (nolock) ,[MimansaModules] MM with (nolock),[MimansaApplications] MA with(nolock)  
where MR.ApplicationId = 1   and   
 MR.ModuleId=MM.ModuleId and  
 MR.ApplicationId=MM.ApplicationId and  
 MR.ApplicationId=MA.ApplicationId and  
   MR.reportid in   
  (1,--Client Details   
  2,--Segmentwise Turnover Report  
  4,--RealTime TO Report   
  11--Change Password
  )    
  and a1.isAdmin='0' and  a1.isDealer='1'  
) A  
where HarmonyEmployeeCode not in   
(select HarmonyEmployeeCode from AngelBOMenu with(nolock) )  

  
  /*
	Added by prasanna on Mar 21 2013.
	This noification sends the information about new clients those who has Mimansa Status ID blank in angelusers via email. 
  */
  exec B2bCrms_NotifyBlankSttatusID

   insert into processlogtemp values('Up_USERS', getdate(), 'YES', 'ANgelBOMENU', 'END')       
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPAngelClient
-- --------------------------------------------------
  
  
CREATE Procedure [dbo].[UPAngelClient]    
  
As    
  
Begin    
  
    
  
DECLARE @intErrorCode INT    
  
    
  
BEGIN TRAN    
  
  
  
 insert into processlogtemp values('UPAngelClient', getdate(), 'YES', 'angelclient1', 'START')           
  
          
  
  Truncate table angelclient1    
  
   SELECT @intErrorCode = @@ERROR    
  
   IF (@intErrorCode <> 0) GOTO Error    
  
    
  
  Insert into angelclient1    
  
select Party_Code,  
  
Short_Name,  
  
Long_Name,  
  
''L_Address1,  
  
''L_Address2,  
  
''L_city,  
  
L_State,  
  
L_Nation,  
  
''L_Zip,  
  
''Fax,  
  
''Res_Phone1,  
  
''Res_Phone2,  
  
''Off_Phone1,  
  
''Off_Phone2,  
  
''Email,  
  
Branch_cd,  
  
Credit_Limit,  
  
Cl_type,  
  
Cl_Status,  
  
Gl_Code,  
  
Bank_Name,  
  
Ac_Type,  
  
Ac_Num,  
  
PrintF,  
  
Fd_Code,  
  
Family,  
  
Penalty,  
  
Sub_Broker,  
  
Confirm_fax,  
  
PhoneOld,  
  
''L_Address3,  
  
null Mobile_Pager,  
  
Mobilevalidatedby,  
  
MobilevalidatedOn,  
  
''pan_gir_no,  
  
trader,  
  
Ward_No,  
  
Region,  
  
Area,  
  
PerDay,  
  
TradeDays,  
  
ActiveFrom,  
  
InActiveFrom,  
  
ActiveFromEq,  
  
InactiveFromEq,  
  
ActiveFromComm,  
  
InactiveFromComm,  
  
CTActiveFrom,  
  
CTInactiveFrom,  
  
FirstTrade,  
  
LastTrade,  
  
FirstTradeComm,  
  
LastTradeComm,  
  
Clrating,  
  
AngelClRating,  
  
YearBrok,  
  
Trend,  
  
RmDealer,  
  
CommDealer1,  
  
Commdealer2,  
  
Service,  
  
LastCommunication,  
  
ECN,  
  
B2C,  
  
FirstLedger,  
  
FirstLedgerDate,  
  
EbrokingClient,  
  
NbFcClient,  
  
NbFcActivefrom,  
  
NbFcInactiveFrom,  
  
EbrokingTerminal,  
  
PastClient,  
  
ClientFlag,  
  
BlockSms,  
  
PureRisk,  
  
ProjectedRisk,  
  
PanInactiveFrom,  
  
BOBranch,  
  
null Birthdate,  
  
Gender,  
  
TradingPlatform,  
  
ActiveFromCurr,  
  
InactiveFromCurr,  
  
FirstTradeCurr,  
  
LastTradeCurr,  
  
CurrencyDealer,  
  
ActiveFromMcxNcx,  
  
InActiveFromMcxNcx,  
  
FirstTradeMcxNcx,  
  
LastTradeMcxNcx,  
  
DPIDs,   
  
DPIDWithPOA   ,  
  
DPIDForPayout ,  
  
IsActiveForEbrokingProduct from [MIMANSA].angelcs.dbo.angelclient1    
  
    
  
   SELECT @intErrorCode = @@ERROR    
  
   IF (@intErrorCode <> 0) GOTO Error    
  
          
  
  COMMIT TRAN    
  
    
  
      insert into processlogtemp values('UPAngelClient', getdate(), 'YES', 'angelclient1', 'END')          
  
    
  
  Error:    
  
  IF (@intErrorCode <> 0) BEGIN    
  
  PRINT 'Unexpected error occurred!'    
  
   ROLLBACK TRAN    
  
  END    
  
    
  
    
  
End

/*-https://angelbrokingpl.atlassian.net/browse/SRE-42152*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPAngelClient_26nov2025
-- --------------------------------------------------
  
  
CREATE Procedure [dbo].[UPAngelClient_26nov2025]    
  
As    
  
Begin    
  
    
  
DECLARE @intErrorCode INT    
  
    
  
BEGIN TRAN    
  
  
  
 insert into processlogtemp values('UPAngelClient', getdate(), 'YES', 'angelclient1', 'START')           
  
          
  
  Truncate table angelclient1    
  
   SELECT @intErrorCode = @@ERROR    
  
   IF (@intErrorCode <> 0) GOTO Error    
  
    
  
  Insert into angelclient1    
  
select Party_Code,  
  
Short_Name,  
  
Long_Name,  
  
L_Address1,  
  
L_Address2,  
  
L_city,  
  
L_State,  
  
L_Nation,  
  
L_Zip,  
  
Fax,  
  
Res_Phone1,  
  
Res_Phone2,  
  
Off_Phone1,  
  
Off_Phone2,  
  
Email,  
  
Branch_cd,  
  
Credit_Limit,  
  
Cl_type,  
  
Cl_Status,  
  
Gl_Code,  
  
Bank_Name,  
  
Ac_Type,  
  
Ac_Num,  
  
PrintF,  
  
Fd_Code,  
  
Family,  
  
Penalty,  
  
Sub_Broker,  
  
Confirm_fax,  
  
PhoneOld,  
  
L_Address3,  
  
Mobile_Pager,  
  
Mobilevalidatedby,  
  
MobilevalidatedOn,  
  
pan_gir_no,  
  
trader,  
  
Ward_No,  
  
Region,  
  
Area,  
  
PerDay,  
  
TradeDays,  
  
ActiveFrom,  
  
InActiveFrom,  
  
ActiveFromEq,  
  
InactiveFromEq,  
  
ActiveFromComm,  
  
InactiveFromComm,  
  
CTActiveFrom,  
  
CTInactiveFrom,  
  
FirstTrade,  
  
LastTrade,  
  
FirstTradeComm,  
  
LastTradeComm,  
  
Clrating,  
  
AngelClRating,  
  
YearBrok,  
  
Trend,  
  
RmDealer,  
  
CommDealer1,  
  
Commdealer2,  
  
Service,  
  
LastCommunication,  
  
ECN,  
  
B2C,  
  
FirstLedger,  
  
FirstLedgerDate,  
  
EbrokingClient,  
  
NbFcClient,  
  
NbFcActivefrom,  
  
NbFcInactiveFrom,  
  
EbrokingTerminal,  
  
PastClient,  
  
ClientFlag,  
  
BlockSms,  
  
PureRisk,  
  
ProjectedRisk,  
  
PanInactiveFrom,  
  
BOBranch,  
  
Birthdate,  
  
Gender,  
  
TradingPlatform,  
  
ActiveFromCurr,  
  
InactiveFromCurr,  
  
FirstTradeCurr,  
  
LastTradeCurr,  
  
CurrencyDealer,  
  
ActiveFromMcxNcx,  
  
InActiveFromMcxNcx,  
  
FirstTradeMcxNcx,  
  
LastTradeMcxNcx,  
  
DPIDs,   
  
DPIDWithPOA   ,  
  
DPIDForPayout ,  
  
IsActiveForEbrokingProduct from [MIMANSA].angelcs.dbo.angelclient1    
  
    
  
   SELECT @intErrorCode = @@ERROR    
  
   IF (@intErrorCode <> 0) GOTO Error    
  
          
  
  COMMIT TRAN    
  
    
  
      insert into processlogtemp values('UPAngelClient', getdate(), 'YES', 'angelclient1', 'END')          
  
    
  
  Error:    
  
  IF (@intErrorCode <> 0) BEGIN    
  
  PRINT 'Unexpected error occurred!'    
  
   ROLLBACK TRAN    
  
  END    
  
    
  
    
  
End

/*-https://angelbrokingpl.atlassian.net/browse/SRE-42152*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPB2BHarmony
-- --------------------------------------------------
   
   
CREATE Procedure [dbo].[UPB2BHarmony]  
As  
Begin  
  
  
   
  
--select top 10 * from [196.1.115.141].SbHarmony.dbo.vw_tbl_EmployeeView  
   
DECLARE @intErrorCode INT  
  
BEGIN TRAN  
      
  
insert into processlogtemp values('UPB2BHarmony', getdate(), 'YES', 'B2B_AngelHarmony', 'START')  

Select * into #OldB2b_Harmony from B2B_AngelHarmony_bak with(nolock)      
        
Truncate table B2B_AngelHarmony_bak  
SELECT @intErrorCode = @@ERROR  
IF (@intErrorCode <> 0) GOTO Error  
  
Insert into B2B_AngelHarmony_bak  
select 
Emp_No,
Sb_Tag,
First_Name,
Middle_Name,
Last_Name,
Emp_Name,
Address1,
Address2,
City,
State,
Pincode,
MobileNumber,
EmailAdd,
JoiningDate,
Status,
CTC,
Emp_pass,
Dt_Updation,
IP,
Created_date,
Landline_no,--Chenged the coumn name on sep 22 2012 after harmony team changed column name in view 
--Landline,
isAdmin,
isDealer,
isTurnover,
isBrokerage from --[196.1.115.141].SbHarmony.dbo.vw_tbl_EmployeeView  with (nolock)
--vw_tbl_EmployeeView  with (nolock)
B2B_AngelHarmony

union 

select 
Emp_No='CSOAdmin',
Sb_Tag='',
First_Name='',
Middle_Name='',
Last_Name='',
Emp_Name='CSO Admin',
Address1='',
Address2='',
City='',
State='',
Pincode='',
MobileNumber='',
EmailAdd='',
JoiningDate='',
Status='A',
CTC='0',
Emp_pass='CSO@123',
Dt_Updation='',
IP='',
Created_date='',
Landline_no='',
isAdmin='1',
isDealer='0',
isTurnover='0',
isBrokerage ='0'

Select * Into #HLog from B2B_AngelHarmony_bak with(nolock)
Delete #HLog where Emp_No = 'CSO'
Delete #OldB2b_Harmony where Emp_No = 'CSO'
  
  Delete #HLog from #OldB2b_Harmony where
  #HLog.emp_no=#OldB2b_Harmony.emp_no and
  #HLog.sb_tag=#OldB2b_Harmony.sb_tag and
  #HLog.status=#OldB2b_Harmony.status and
  #HLog.isdealer=#OldB2b_Harmony.isdealer and
  #HLog.isadmin=#OldB2b_Harmony.isadmin and
  #HLog.isTurnover=#OldB2b_Harmony.isTurnover and
  #HLog.isBrokerage=#OldB2b_Harmony.IsBrokerage 
  
 insert into B2B_AngelHarmonyLog select *,getdate(),'Change In Status'from #HLog 

Delete #OldB2b_Harmony from B2B_AngelHarmony_bak with(nolock) where
  #OldB2b_Harmony.emp_no=B2B_AngelHarmony_bak.emp_no 
 
 insert into B2B_AngelHarmonyLog select *,getdate(),'Emp Not Present'from #OldB2b_Harmony 
  
  
  
   SELECT @intErrorCode = @@ERROR  
   IF (@intErrorCode <> 0) GOTO Error  
        
  COMMIT TRAN  
  
  
  
   insert into processlogtemp values('UPB2BHarmony', getdate(), 'YES', 'B2B_AngelHarmony', 'END')        
  
  Error:  
  IF (@intErrorCode <> 0) BEGIN  
  PRINT 'Unexpected error occurred!'  
   ROLLBACK TRAN  
  END  
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UpdateTotalHoldingAndLedgerfrom207
-- --------------------------------------------------
CREATE procedure [dbo].[UpdateTotalHoldingAndLedgerfrom207]
as
begin

	insert into processlogtemp values('UpdateTotalHoldingAndLedgerfrom207', getdate(), 'YES', 'UpdateTotalHoldingAndLedgerfrom207', 'START')
	
	truncate table holding_valuation
	
	insert into 
		holding_valuation
	--select party_code, totalhold from MIMANSA.Angelcs.dbo.View_PartyWise_Holding 
	select party_code, totalhold=sum(TotalHoldValue + dpholdvalue + NBFCHoldValue) from MIMANSA.Angelcs.dbo.View_PartyWise_Holding_NBFC
	group by party_code

	truncate table ledger_valuation
	
	insert into 
		ledger_valuation
	--select party_code, totalledger from MIMANSA.Angelcs.dbo.View_LedgerInfo
	select party_code, ledgertotal from MIMANSA.Angelcs.dbo.VW_ClientLedger
	
	insert into processlogtemp values('UpdateTotalHoldingAndLedgerfrom207', getdate(), 'YES', 'UpdateTotalHoldingAndLedgerfrom207', 'END')
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ups_MutualFund_CheckPOA_Mimansa
-- --------------------------------------------------

-- =============================================

-- Author:		Anand Dhuaml

-- Create date: Nov 03 2015

-- Description:	<Description,,>

-- =============================================

CREATE PROCEDURE [dbo].[ups_MutualFund_CheckPOA_Mimansa]

	-- Add the parameters for the stored procedure here

	@party_code varchar(20)

AS

BEGIN

	-- SET NOCOUNT ON added to prevent extra result sets from

	-- interfering with SELECT statements.

	SET NOCOUNT ON;



    If NOT EXISTS(Select * from [AngelDP4].Inhouse.dbo.vw_mfPOAINCRData with(nolock) where nise_party_code=@party_code)

	BEGIN

			Select MSG='Client has not signed the revised Power of Attorney.'

			Return

	END

	IF NOT EXISTS(Select * from [AngelFO].[BSEMFSS].[dbo].[MFSS_CLIENT] with(nolock) where party_code=@party_code and INACTIVE_FROM>getdate())

	BEGIN

			Select MSG='The Client is not active in Mutual Fund segment.'

	END

	ELSE

	BEGIN

			Select 'True'

	END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPTableDate
-- --------------------------------------------------


CREATE Procedure [dbo].[UPTableDate]  

As  

Begin  



--select * from processlogtemp  

--insert into processlogtemp values('UPCommonPartyServices', getdate(), 'YES', 'CommonPartyServices', '@NewParty filled by Commodity')                               

  

DECLARE @intErrorCode INT  

  

BEGIN TRAN  

  

      insert into processlogtemp values('UPTableDate', getdate(), 'YES', 'table_date', 'START')                               

  

  

  Truncate table table_date  

   SELECT @intErrorCode = @@ERROR  

   IF (@intErrorCode <> 0) GOTO Error  

  

  Insert into table_date  

  select DATE_ID,

DATE,

NEXT_DAY_DATE,

YEAR,

YEAR_QUARTER,

YEAR_MONTH,

YEAR_DAY_OF_YEAR,

QUARTER,

MONTH,

DAY_OF_YEAR,

DAY_OF_MONTH,

DAY_OF_WEEK,

YEAR_NAME,

YEAR_QUARTER_NAME,

YEAR_MONTH_NAME,

YEAR_MONTH_NAME_LONG,

QUARTER_NAME,

MONTH_NAME,

MONTH_NAME_LONG,

WEEKDAY_NAME,

WEEKDAY_NAME_LONG,

START_OF_YEAR_DATE,

END_OF_YEAR_DATE,

START_OF_QUARTER_DATE,

END_OF_QUARTER_DATE,

START_OF_MONTH_DATE,

END_OF_MONTH_DATE,

START_OF_WEEK_STARTING_SUN_DATE,

END_OF_WEEK_STARTING_SUN_DATE,

START_OF_WEEK_STARTING_MON_DATE,

END_OF_WEEK_STARTING_MON_DATE,

START_OF_WEEK_STARTING_TUE_DATE,

END_OF_WEEK_STARTING_TUE_DATE,

START_OF_WEEK_STARTING_WED_DATE,

END_OF_WEEK_STARTING_WED_DATE,

START_OF_WEEK_STARTING_THU_DATE,

END_OF_WEEK_STARTING_THU_DATE,

START_OF_WEEK_STARTING_FRI_DATE,

END_OF_WEEK_STARTING_FRI_DATE,

START_OF_WEEK_STARTING_SAT_DATE,

END_OF_WEEK_STARTING_SAT_DATE,

QUARTER_SEQ_NO,

MONTH_SEQ_NO,

WEEK_STARTING_SUN_SEQ_NO,

WEEK_STARTING_MON_SEQ_NO,

WEEK_STARTING_TUE_SEQ_NO,

WEEK_STARTING_WED_SEQ_NO,

WEEK_STARTING_THU_SEQ_NO,

WEEK_STARTING_FRI_SEQ_NO,

WEEK_STARTING_SAT_SEQ_NO,

JULIAN_DATE,

MODIFIED_JULIAN_DATE,

ISO_DATE,

ISO_YEAR_WEEK_NO,

ISO_WEEK_NO,

ISO_DAY_OF_WEEK,

ISO_YEAR_WEEK_NAME,

ISO_YEAR_WEEK_DAY_OF_WEEK_NAME,

DATE_FORMAT_YYYY_MM_DD,

DATE_FORMAT_YYYY_M_D,

DATE_FORMAT_MM_DD_YYYY,

DATE_FORMAT_M_D_YYYY,

DATE_FORMAT_MMM_D_YYYY,

DATE_FORMAT_MMMMMMMMM_D_YYYY,

DATE_FORMAT_MM_DD_YY,

DATE_FORMAT_M_D_YY,

CMTradingDay,

CommTradingday,

EffSauda_date,

StartOfFinDate,

EndOfFinDate,

FinQuarter,

Sauda_date,

CurrTradingDay from [MIMANSA].angelcs.dbo.table_date  with (nolock)

/****************UP ProfileSubProfile*******************/

truncate table [Tbl_Client_ProfileSubProfile]

--

insert into [Tbl_Client_ProfileSubProfile]

select Party_Code,Profile,Sub_Profile,LastUpdate from [MIMANSA].crm.dbo.tbl_client_profileSubProfile with(nolock)

  

   SELECT @intErrorCode = @@ERROR  

   IF (@intErrorCode <> 0) GOTO Error  

        

  COMMIT TRAN  

    

  insert into processlogtemp values('UPTableDate', getdate(), 'YES', 'table_date', 'END')                               

  

  Error:  

  IF (@intErrorCode <> 0) BEGIN  

  PRINT 'Unexpected error occurred!'  

   ROLLBACK TRAN  

  END  

  

  

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_B2B_CRMS_SelfCertification_DSC
-- --------------------------------------------------
-- =============================================
-- Author:		Anand Dhumal	
-- Create date: Sp 11 2017
-- Description:	<Description,,>

--exec [Usp_B2B_CRMS_SelfCertification_DSC] 'GDS','GDS001',''

-- =============================================
CREATE PROCEDURE [dbo].[Usp_B2B_CRMS_SelfCertification_DSC]
	-- Add the parameters for the stored procedure here
	@Sub_Broker varchar(50),
	@ConfirmedBy varchar(50),
	@IP_Address varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	--IF(isnull(@IP_Address,'') = '')
	--BEGIN
	--	Select ERROR = 'YES', MSG = 'Invalid IP address. Please check your IP address.'
	--	RETURN
	--END
	--IF(@Sub_Broker = '' OR @ConfirmedBy = '')
	--BEGIN
	--	Select ERROR = 'YES', MSG = 'Error occurred, please try again.'
	--	RETURN 
	--END

    Insert into Mimansa.dbo.tbl_B2B_CRMS_SelfCertification_DSC
	Select @Sub_Broker, 'Y', getdate(), @ConfirmedBy, @IP_Address

	Select ERROR = 'SUCCESS', MSG = 'SUCCESS'
	RETURN 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_functions_findInUSP
-- --------------------------------------------------
create PROCEDURE usp_functions_findInUSP  
@str varchar(500)  
AS  
  
 set @str = '%' + @str + '%'  
   
 select O.name from sysComments  C  
 join sysObjects O on O.id = C.id  
 where O.xtype = 'P' and C.text like @str

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetClientsLimit
-- --------------------------------------------------


CREATE proc [dbo].[usp_GetClientsLimit]  

@Party_code varchar(10),  

@Deposit money out,  

@EbrokingClient varchar(10)  

as  

/*  

Declare @Deposit money  

exec usp_GetClientsLimit 'rp61', @Deposit  output,'N'  

select @Deposit  

  

*/  

begin  

  

-- This sp is used in ipulse to fetch limit of a clients. Created By Mukesh on Dec 19 2013  

print @Party_code  

if exists (select * from middleware.inhouse.dbo.ebrok_client with(nolock) where party_code=@Party_code) 

Begin

set @EbrokingClient='Y'

End

else

Begin

set @EbrokingClient='N'

End



if(@EbrokingClient='Y')  

begin  

 select  @Deposit = isnull(deposit,0) from mis.dbo.tbl_Ctcl_Diet_Alloted_new with(nolock)    

 where Party_code=@Party_code and updated_on =(select MAX(updated_on) from mis.dbo.tbl_Ctcl_Diet_Alloted_new with(nolock))    

end  

else  

begin  

 select @Deposit=  deposit from [INTRANET].mis.dbo.tbl_Ctcl_Limit_Alloted_new with(nolock)    

   where Party_code=@party_code and updated_on =(select MAX(updated_on) from [INTRANET].mis.dbo.tbl_Ctcl_Limit_Alloted_new with(nolock))  

end  

--select  @Deposit 

  

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MutualFund_Buy_Sell_Type_Mimansa
-- --------------------------------------------------


-- =============================================

-- Author:		Anand Dhumal

-- Create date: Nov 19 2015

-- Description:	<Description,,>

-- =============================================

CREATE PROCEDURE [dbo].[usp_MutualFund_Buy_Sell_Type_Mimansa]

	-- Add the parameters for the stored procedure here

	@ClientDPID varchar(50),

	@isin varchar(50)

AS

BEGIN

	-- SET NOCOUNT ON added to prevent extra result sets from

	-- interfering with SELECT statements.

	SET NOCOUNT ON;



	Declare @Buy_Sell_Type varchar(50)

	If Exists(select 1 from [AngelDP4].INHOUSE.DBO.HOLDING  H           

	 JOIN [AngelDP4].INHOUSE.DBO.CLIENT_MASTER CM ON H.HLD_AC_CODE = CM.CM_CD where H.HLD_AC_CODE=@ClientDPID and h.hld_isin_code=@isin          

	 and hld_ac_pos>0) 

	Begin

		Set @Buy_Sell_Type =  'ADDITIONAL'

	End

	else

	Begin

		Set @Buy_Sell_Type = 'FRESH'

	End

	Select @Buy_Sell_Type

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MutualFund_UnitHolding
-- --------------------------------------------------
-- =============================================  

-- Author:  Ravindra  

-- Create date: 19 OCT 2015  

-- Description: <Description,,>  

-- EXEC [usp_MutualFund_UnitHolding] 'BROKER', 'BROKER' ,'P00045', 'RG13','UTI Mutual Fund','UTI-MASTERSHARE UNIT SCHEME - DIVIDEND PLAN','Validate'  

-- EXEC [usp_MutualFund_UnitHolding] 'BROKER', 'BROKER' ,'P00045', 'A10145','Franklin Templeton Mutual Fund','FRANKLIN BUILD INDIA FUND-DIVIDEND REINVESTMENT','Validate'  

-- =============================================  

CREATE PROCEDURE [dbo].[usp_MutualFund_UnitHolding]  

 -- Add the parameters for the stored procedure here  

 @StatusId VARCHAR(20),                                                                                                                                        

 @StatusName VARCHAR(20),                                                                                                                                        

 --@UserLevel VARCHAR(12),                                                                                                   

 --@UserLevel1 VARCHAR(12),                                                                                                                                       

 @EmpNo VARCHAR(15),         

 @partyCode varchar(20),  

 @AMCName varchar(500),  

 @SchemeName varchar(500),  

 @Flag varchar(20)  

   

AS  

BEGIN  

 -- SET NOCOUNT ON added to prevent extra result sets from  

 -- interfering with SELECT statements.  

 SET NOCOUNT ON;  

  

 if @AMCName ='All'  

 begin  

 set @AMCName =''  

 end  

  

 if @SchemeName ='All'  

 begin  

 set @SchemeName =''  

 end  

   

 Declare @ViewTransaction char(2)  

  

   

  DECLARE @TempUserBranch TABLE                                                  

  (                                                  

   branch_cd VARCHAR(20),                                                  

   zone VARCHAR(20),                                                  

   region VARCHAR(20)                            

  )     

  

  Insert into @TempUserBranch  

   Select distinct branch_cd,zone,region from [MIMANSA].angelcs.dbo.angeluserbranch WITH(NOLOCK)       

   where Emp_no=@EmpNo  

   OPTION (RECOMPILE)   

  

  

  

 declare @Client Table  (party_code varchar(20),Cltdpid varchar(100))  

 if(@partycode<>'')  

 begin  

 insert into @Client  

 select distinct party_code,Cltdpid from AngelBSECM.bsedb_ab.dbo.client4 with(nolock) where party_code=@partycode and bankid='12033200' -- order by defdp desc    

 end   

   

 if Exists (select party_code from  [MIMANSA].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = @partycode )  

 begin  

 set @ViewTransaction='Y'  

 end  

  

  

  

 if @partycode<>'' and @SchemeName<>'' and @AMCName<>''  

 begin  

   

    select distinct  

     C.party_code  

    ,S.scheme_name  

    ,A.AMC_Name  

    ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   

    ,BeneficiaryID=h.HLD_AC_CODE  

    ,PurchaseCost=0  

    ,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100))   

    ,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))  

    ,NAVDate=convert(varchar(11),S.nav_date,109)  

    ,ViewTransaction=(case when Exists (select top 1 party_code from  [MIMANSA].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = C.party_code ) Then 'Y' else 'N' end)  

    ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   

    ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   

    ,S.scheme_code  

   from   

   @Client  C  ,[AngelDP4].DMAT.[dbo].[synergy_holding] h with(nolock), MIDDLEWARE.commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [INTRANET].risk.dbo.amccode A with(nolock)  

   where   

     

     C.party_code=@partycode  

    and h.HLD_AC_CODE=C.Cltdpid  

    and h.HLD_ISIN_CODE=S.isin  
    and S.scheme_name=@SchemeName  

    and S.AMC_Code=A.AMC_Code  

    and A.amc_active_flag=1   

    and A.AMC_Name=@AMCName  

 end  

 else if @partycode<>'' and @SchemeName='' and @AMCName=''  

 begin  

    select distinct  

     C.party_code  

    ,S.scheme_name  

    ,A.AMC_Name  

    ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   

    ,BeneficiaryID=h.HLD_AC_CODE  

    ,PurchaseCost=0  

    ,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100))   

    ,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))  

    ,NAVDate=convert(varchar(11),S.nav_date,109)  

    ,ViewTransaction=(case when Exists (select top 1 party_code from  [MIMANSA].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = C.party_code ) Then 'Y' else 'N' end)  

    ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   

    ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   

    ,S.scheme_code  

    from   

    @Client C  ,[AngelDP4].DMAT.[dbo].[synergy_holding] h with(nolock), MIDDLEWARE.commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [INTRANET].risk.dbo.amccode A with(nolock)  

    where   

     C.party_code=@partycode  

    and h.HLD_AC_CODE=C.Cltdpid  

    and h.HLD_ISIN_CODE=S.isin  

    --and S.scheme_name=@SchemeName  

    and S.AMC_Code=A.AMC_Code  

    and A.amc_active_flag=1   

    --and A.AMC_Name=@AMCName  

 end  

 else if @partycode<>'' and @SchemeName='' and @AMCName<>''  

 begin  

    select distinct  

     C.party_code  

    ,S.scheme_name  

    ,A.AMC_Name  

    ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   

    ,BeneficiaryID=h.HLD_AC_CODE  

    ,PurchaseCost=0  

    ,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100))   

    ,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))  

    ,NAVDate=convert(varchar(11),S.nav_date,109)  

    ,ViewTransaction=(case when Exists (select top 1 party_code from  [MIMANSA].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = C.party_code ) Then 'Y' else 'N' end)  

    ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   

    ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   

    ,S.scheme_code  

    from   

    @Client  C  ,[AngelDP4].DMAT.[dbo].[synergy_holding] h with(nolock), MIDDLEWARE.commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [INTRANET].risk.dbo.amccode A with(nolock)  

    where   

    C.party_code=@partycode  

    and h.HLD_AC_CODE=C.Cltdpid  

    and h.HLD_ISIN_CODE=S.isin  

    --and S.scheme_name=@SchemeName  

    and S.AMC_Code=A.AMC_Code  

    and A.amc_active_flag=1   

    and A.AMC_Name=@AMCName  

 end  

 else if @partycode='' and @SchemeName='' and @AMCName<>''  

 begin  

    select distinct  

     C.party_code  

    ,S.scheme_name  

    ,A.AMC_Name  

    ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   

    ,BeneficiaryID=h.HLD_AC_CODE  

    ,PurchaseCost=0  

    ,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100))   

    ,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))  

    ,NAVDate=convert(varchar(11),S.nav_date,109)  

    ,ViewTransaction=(case when Exists (select top 1 party_code from  [MIMANSA].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = C.party_code ) Then 'Y' else 'N' end)  

    ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   

    ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   

    ,S.scheme_code  

    from   

    [INTRANET].risk.dbo.amccode A with(nolock),MIDDLEWARE.commonmaster.dbo.vw_etl_mfschememaster S with(nolock),[AngelDP4].DMAT.[dbo].[synergy_holding] h with(nolock), AngelBSECM.bsedb_ab.dbo.client4 C with(nolock)  

    where   

         A.AMC_Name=@AMCName  

      and A.amc_active_flag=1  

      and A.AMC_Code=S.AMC_Code  

      and S.isin=h.HLD_ISIN_CODE  

      and h.HLD_AC_CODE=C.Cltdpid  

  

     

 end  

 else if @partycode='' and @SchemeName<>'' and @AMCName<>''  

 begin  

    select distinct  

     C.party_code  

    ,S.scheme_name  

    ,A.AMC_Name  

    ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   

    ,BeneficiaryID=h.HLD_AC_CODE  

    ,PurchaseCost=0  

    ,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100))   

    ,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))  

    ,NAVDate=convert(varchar(11),S.nav_date,109)  

    ,ViewTransaction=(case when Exists (select top 1 party_code from  [MIMANSA].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = C.party_code ) Then 'Y' else 'N' end)  

    ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   

    ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   

    ,S.scheme_code  

    from   

     [INTRANET].risk.dbo.amccode A with(nolock),MIDDLEWARE.commonmaster.dbo.vw_etl_mfschememaster S with(nolock),[AngelDP4].DMAT.[dbo].[synergy_holding] h with(nolock), AngelBSECM.bsedb_ab.dbo.client4 C with(nolock)  

    where   

         A.AMC_Name=@AMCName  

      and A.amc_active_flag=1  

      and A.AMC_Code=S.AMC_Code  

      and S.scheme_name=@SchemeName  

      and S.isin=h.HLD_ISIN_CODE  

      and h.HLD_AC_CODE=C.Cltdpid  

  

     

 end  

END  

  

--Select top 20 * from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster with(nolock) where amc_active_flag=1  

--select top 20 * from AngelBSECM.bsedb_ab.dbo.client4 with(nolock) where  bankid='12033200' order by defdp desc  

--select top 20 * from [INTRANET].risk.dbo.amccode A with(nolock)  

--Select top 2 * from [AngelDP4].INHOUSE.DBO.tbl_CLIENT_MASTER with(nolock)  

  

-- select top 2 *  from [AngelDP4].DMAT.[dbo].[synergy_holding] with(nolock) where hld_ac_code=@client_dpid AND HLD_ISIN_CODE=@Scheme_Code     

  

-- select S.scheme_name  

-- ,A.AMC_Name  

  

-- from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock) , [INTRANET].risk.dbo.amccode A with(nolock),[AngelDP4].DMAT.[dbo].[synergy_holding] h with(nolock), AngelBSECM.bsedb_ab.dbo.client4  C with(nolock)   

--   where A.AMC_Name=@AMCName      

--   and S.AMC_Code=A.AMC_Code  

--   and A.amc_active_flag=1   

--   and S.scheme_name=@SchemeName  

--   and s.isin=h.HLD_ISIN_CODE  

--   and h.HLD_AC_CODE=C.Cltdpid  

--   and  C.bankid='12033200'  

--   and C.party_code=@partycode  

  

-- select   

--     C.party_code  

--    ,S.scheme_name  

-- ,A.AMC_Name  

-- ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   

-- ,BeneficiaryID=h.HLD_AC_CODE  

-- ,PurchaseCost=0  

-- ,MarketValue=(isnull(h.hld_ac_pos,0) * S.nav_value)  

-- ,LatestNAV=S.nav_value  

-- ,NAVDate=convert(varchar(11),S.nav_date,109)  

-- ,ViewTransaction=''  

-- ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   

-- ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   

-- from   

--  AngelBSECM.bsedb_ab.dbo.client4  C with(nolock) ,[AngelDP4].DMAT.[dbo].[synergy_holding] h with(nolock), [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [INTRANET].risk.dbo.amccode A with(nolock)  

--  where   

--    C.bankid='12033200'  

-- and C.party_code=@partycode  

-- and h.HLD_AC_CODE=C.Cltdpid  

-- and h.HLD_ISIN_CODE=S.isin  

-- and S.scheme_name=@SchemeName  

-- and S.AMC_Code=A.AMC_Code  

-- and A.amc_active_flag=1   

-- and A.AMC_Name=@AMCName

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MutualFund_UnitHolding_23Dec2019
-- --------------------------------------------------
-- =============================================
-- Author:		Ravindra
-- Create date: 19 OCT 2015
-- Description:	<Description,,>
-- EXEC [usp_MutualFund_UnitHolding] 'BROKER', 'BROKER' ,'P00045', 'RG13','UTI Mutual Fund','UTI-MASTERSHARE UNIT SCHEME - DIVIDEND PLAN','Validate'
-- EXEC [usp_MutualFund_UnitHolding] 'BROKER', 'BROKER' ,'P00045', 'A10145','Franklin Templeton Mutual Fund','FRANKLIN BUILD INDIA FUND-DIVIDEND REINVESTMENT','Validate'
-- =============================================
CREATE PROCEDURE [dbo].[usp_MutualFund_UnitHolding_23Dec2019]
	-- Add the parameters for the stored procedure here
	@StatusId VARCHAR(20),                                                                                                                                      
	@StatusName VARCHAR(20),                                                                                                                                      
	--@UserLevel VARCHAR(12),                                                                                                 
	--@UserLevel1 VARCHAR(12),                                                                                                                                     
	@EmpNo VARCHAR(15),       
	@partyCode varchar(20),
	@AMCName varchar(500),
	@SchemeName varchar(500),
	@Flag varchar(20)
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	if @AMCName ='All'
	begin
	set @AMCName =''
	end

	if @SchemeName ='All'
	begin
	set @SchemeName =''
	end
	
	Declare @ViewTransaction char(2)

	
		DECLARE @TempUserBranch TABLE                                                
		(                                                
			branch_cd VARCHAR(20),                                                
			zone VARCHAR(20),                                                
			region VARCHAR(20)                          
		)   

		Insert into @TempUserBranch
			Select distinct branch_cd,zone,region from [196.1.115.207].angelcs.dbo.angeluserbranch WITH(NOLOCK)     
			where Emp_no=@EmpNo
			OPTION (RECOMPILE) 



	declare @Client Table  (party_code varchar(20),Cltdpid varchar(100))
	if(@partycode<>'')
	begin
	insert into @Client
	select distinct party_code,Cltdpid from anand.bsedb_ab.dbo.client4 with(nolock) where party_code=@partycode and bankid='12033200' -- order by defdp desc  
	end 
	
	if Exists (select party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock) 	where party_code = @partycode )
	begin
	set @ViewTransaction='Y'
	end



	if @partycode<>'' and @SchemeName<>'' and @AMCName<>''
	begin
	
				select distinct
				 C.party_code
				,S.scheme_name
				,A.AMC_Name
				,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100)) 
				,BeneficiaryID=h.HLD_AC_CODE
				,PurchaseCost=0
				,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100)) 
				,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))
				,NAVDate=convert(varchar(11),S.nav_date,109)
				,ViewTransaction=(case when Exists (select top 1 party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock) 	where party_code = C.party_code ) Then 'Y' else 'N' end)
				,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END 
				,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END 
				,S.scheme_code
			from 
			@Client  C  ,[196.1.115.199].Synergy.dbo.Holding h with(nolock), [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [196.1.115.132].risk.dbo.amccode A with(nolock)
			where 
   
				 C.party_code=@partycode
				and h.HLD_AC_CODE=C.Cltdpid
				and h.HLD_ISIN_CODE=S.isin
				and S.scheme_name=@SchemeName
				and S.AMC_Code=A.AMC_Code
				and A.amc_active_flag=1	
				and A.AMC_Name=@AMCName
	end
	else if @partycode<>'' and @SchemeName='' and @AMCName=''
	begin
				select distinct
				 C.party_code
				,S.scheme_name
				,A.AMC_Name
				,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100)) 
				,BeneficiaryID=h.HLD_AC_CODE
				,PurchaseCost=0
				,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100)) 
				,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))
				,NAVDate=convert(varchar(11),S.nav_date,109)
				,ViewTransaction=(case when Exists (select top 1 party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock) 	where party_code = C.party_code ) Then 'Y' else 'N' end)
				,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END 
				,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END 
				,S.scheme_code
			 from 
			 @Client C  ,[196.1.115.199].Synergy.dbo.Holding h with(nolock), [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [196.1.115.132].risk.dbo.amccode A with(nolock)
			 where 
				 C.party_code=@partycode
				and h.HLD_AC_CODE=C.Cltdpid
				and h.HLD_ISIN_CODE=S.isin
				--and S.scheme_name=@SchemeName
				and S.AMC_Code=A.AMC_Code
				and A.amc_active_flag=1	
				--and A.AMC_Name=@AMCName
	end
	else if @partycode<>'' and @SchemeName='' and @AMCName<>''
	begin
				select distinct
				 C.party_code
				,S.scheme_name
				,A.AMC_Name
				,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100)) 
				,BeneficiaryID=h.HLD_AC_CODE
				,PurchaseCost=0
				,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100)) 
				,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))
				,NAVDate=convert(varchar(11),S.nav_date,109)
				,ViewTransaction=(case when Exists (select top 1 party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock) 	where party_code = C.party_code ) Then 'Y' else 'N' end)
				,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END 
				,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END 
				,S.scheme_code
			 from 
			 @Client  C  ,[196.1.115.199].Synergy.dbo.Holding h with(nolock), [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [196.1.115.132].risk.dbo.amccode A with(nolock)
			 where 
				C.party_code=@partycode
				and h.HLD_AC_CODE=C.Cltdpid
				and h.HLD_ISIN_CODE=S.isin
				--and S.scheme_name=@SchemeName
				and S.AMC_Code=A.AMC_Code
				and A.amc_active_flag=1	
				and A.AMC_Name=@AMCName
	end
	else if @partycode='' and @SchemeName='' and @AMCName<>''
	begin
				select distinct
				 C.party_code
				,S.scheme_name
				,A.AMC_Name
				,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100)) 
				,BeneficiaryID=h.HLD_AC_CODE
				,PurchaseCost=0
				,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100)) 
				,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))
				,NAVDate=convert(varchar(11),S.nav_date,109)
				,ViewTransaction=(case when Exists (select top 1 party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock) 	where party_code = C.party_code ) Then 'Y' else 'N' end)
				,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END 
				,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END 
				,S.scheme_code
			 from 
			 [196.1.115.132].risk.dbo.amccode A with(nolock),[196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock),[196.1.115.199].Synergy.dbo.Holding h with(nolock), anand.bsedb_ab.dbo.client4 C with(nolock)
			 where 
			      A.AMC_Name=@AMCName
				  and A.amc_active_flag=1
				  and A.AMC_Code=S.AMC_Code
				  and S.isin=h.HLD_ISIN_CODE
				  and h.HLD_AC_CODE=C.Cltdpid

			
	end
	else if @partycode='' and @SchemeName<>'' and @AMCName<>''
	begin
				select distinct
				 C.party_code
				,S.scheme_name
				,A.AMC_Name
				,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100)) 
				,BeneficiaryID=h.HLD_AC_CODE
				,PurchaseCost=0
				,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100)) 
				,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))
				,NAVDate=convert(varchar(11),S.nav_date,109)
				,ViewTransaction=(case when Exists (select top 1 party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock) 	where party_code = C.party_code ) Then 'Y' else 'N' end)
				,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END 
				,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END 
				,S.scheme_code
			 from 
			  [196.1.115.132].risk.dbo.amccode A with(nolock),[196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock),[196.1.115.199].Synergy.dbo.Holding h with(nolock), anand.bsedb_ab.dbo.client4 C with(nolock)
			 where 
			      A.AMC_Name=@AMCName
				  and A.amc_active_flag=1
				  and A.AMC_Code=S.AMC_Code
				  and S.scheme_name=@SchemeName
				  and S.isin=h.HLD_ISIN_CODE
				  and h.HLD_AC_CODE=C.Cltdpid

			
	end
END

--Select top 20 * from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster with(nolock) where amc_active_flag=1
--select top 20 * from anand.bsedb_ab.dbo.client4 with(nolock) where  bankid='12033200' order by defdp desc
--select top 20 * from [196.1.115.132].risk.dbo.amccode A with(nolock)
--Select top 2 * from [172.31.16.94].INHOUSE.DBO.tbl_CLIENT_MASTER with(nolock)

-- select top 2 *  from [196.1.115.199].Synergy.dbo.Holding with(nolock) where hld_ac_code=@client_dpid AND HLD_ISIN_CODE=@Scheme_Code   

-- select S.scheme_name
--	,A.AMC_Name

-- from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock) , [196.1.115.132].risk.dbo.amccode A with(nolock),[196.1.115.199].Synergy.dbo.Holding h with(nolock), anand.bsedb_ab.dbo.client4  C with(nolock) 
--			where A.AMC_Name=@AMCName				
--			and S.AMC_Code=A.AMC_Code
--			and A.amc_active_flag=1	
--			and S.scheme_name=@SchemeName
--			and s.isin=h.HLD_ISIN_CODE
--			and h.HLD_AC_CODE=C.Cltdpid
--			and  C.bankid='12033200'
--			and C.party_code=@partycode

-- select 
--     C.party_code
--    ,S.scheme_name
--	,A.AMC_Name
--	,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100)) 
--	,BeneficiaryID=h.HLD_AC_CODE
--	,PurchaseCost=0
--	,MarketValue=(isnull(h.hld_ac_pos,0) * S.nav_value)
--	,LatestNAV=S.nav_value
--	,NAVDate=convert(varchar(11),S.nav_date,109)
--	,ViewTransaction=''
--	,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END 
--	,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END 
-- from 
--  anand.bsedb_ab.dbo.client4  C with(nolock) ,[196.1.115.199].Synergy.dbo.Holding h with(nolock), [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [196.1.115.132].risk.dbo.amccode A with(nolock)
--  where 
--    C.bankid='12033200'
--	and C.party_code=@partycode
--	and h.HLD_AC_CODE=C.Cltdpid
--	and h.HLD_ISIN_CODE=S.isin
--	and S.scheme_name=@SchemeName
--	and S.AMC_Code=A.AMC_Code
--	and A.amc_active_flag=1	
--	and A.AMC_Name=@AMCName

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MutualFund_UnitHolding_25jan2022
-- --------------------------------------------------
-- =============================================  
-- Author:  Ravindra  
-- Create date: 19 OCT 2015  
-- Description: <Description,,>  
-- EXEC [usp_MutualFund_UnitHolding] 'BROKER', 'BROKER' ,'P00045', 'RG13','UTI Mutual Fund','UTI-MASTERSHARE UNIT SCHEME - DIVIDEND PLAN','Validate'  
-- EXEC [usp_MutualFund_UnitHolding] 'BROKER', 'BROKER' ,'P00045', 'A10145','Franklin Templeton Mutual Fund','FRANKLIN BUILD INDIA FUND-DIVIDEND REINVESTMENT','Validate'  
-- =============================================  
CREATE PROCEDURE [dbo].[usp_MutualFund_UnitHolding_25jan2022]  
 -- Add the parameters for the stored procedure here  
 @StatusId VARCHAR(20),                                                                                                                                        
 @StatusName VARCHAR(20),                                                                                                                                        
 --@UserLevel VARCHAR(12),                                                                                                   
 --@UserLevel1 VARCHAR(12),                                                                                                                                       
 @EmpNo VARCHAR(15),         
 @partyCode varchar(20),  
 @AMCName varchar(500),  
 @SchemeName varchar(500),  
 @Flag varchar(20)  
   
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
  
 if @AMCName ='All'  
 begin  
 set @AMCName =''  
 end  
  
 if @SchemeName ='All'  
 begin  
 set @SchemeName =''  
 end  
   
 Declare @ViewTransaction char(2)  
  
   
  DECLARE @TempUserBranch TABLE                                                  
  (                                                  
   branch_cd VARCHAR(20),                                                  
   zone VARCHAR(20),                                                  
   region VARCHAR(20)                            
  )     
  
  Insert into @TempUserBranch  
   Select distinct branch_cd,zone,region from [196.1.115.207].angelcs.dbo.angeluserbranch WITH(NOLOCK)       
   where Emp_no=@EmpNo  
   OPTION (RECOMPILE)   
  
  
  
 declare @Client Table  (party_code varchar(20),Cltdpid varchar(100))  
 if(@partycode<>'')  
 begin  
 insert into @Client  
 select distinct party_code,Cltdpid from anand.bsedb_ab.dbo.client4 with(nolock) where party_code=@partycode and bankid='12033200' -- order by defdp desc    
 end   
   
 if Exists (select party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = @partycode )  
 begin  
 set @ViewTransaction='Y'  
 end  
  
  
  
 if @partycode<>'' and @SchemeName<>'' and @AMCName<>''  
 begin  
   
    select distinct  
     C.party_code  
    ,S.scheme_name  
    ,A.AMC_Name  
    ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   
    ,BeneficiaryID=h.HLD_AC_CODE  
    ,PurchaseCost=0  
    ,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100))   
    ,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))  
    ,NAVDate=convert(varchar(11),S.nav_date,109)  
    ,ViewTransaction=(case when Exists (select top 1 party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = C.party_code ) Then 'Y' else 'N' end)  
    ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   
    ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   
    ,S.scheme_code  
   from   
   @Client  C  ,[172.31.16.94].DMAT.[dbo].[synergy_holding] h with(nolock), [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [196.1.115.132].risk.dbo.amccode A with(nolock)  
   where   
     
     C.party_code=@partycode  
    and h.HLD_AC_CODE=C.Cltdpid  
    and h.HLD_ISIN_CODE=S.isin  
    and S.scheme_name=@SchemeName  
    and S.AMC_Code=A.AMC_Code  
    and A.amc_active_flag=1   
    and A.AMC_Name=@AMCName  
 end  
 else if @partycode<>'' and @SchemeName='' and @AMCName=''  
 begin  
    select distinct  
     C.party_code  
    ,S.scheme_name  
    ,A.AMC_Name  
    ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   
    ,BeneficiaryID=h.HLD_AC_CODE  
    ,PurchaseCost=0  
    ,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100))   
    ,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))  
    ,NAVDate=convert(varchar(11),S.nav_date,109)  
    ,ViewTransaction=(case when Exists (select top 1 party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = C.party_code ) Then 'Y' else 'N' end)  
    ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   
    ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   
    ,S.scheme_code  
    from   
    @Client C  ,[172.31.16.94].DMAT.[dbo].[synergy_holding] h with(nolock), [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [196.1.115.132].risk.dbo.amccode A with(nolock)  
    where   
     C.party_code=@partycode  
    and h.HLD_AC_CODE=C.Cltdpid  
    and h.HLD_ISIN_CODE=S.isin  
    --and S.scheme_name=@SchemeName  
    and S.AMC_Code=A.AMC_Code  
    and A.amc_active_flag=1   
    --and A.AMC_Name=@AMCName  
 end  
 else if @partycode<>'' and @SchemeName='' and @AMCName<>''  
 begin  
    select distinct  
     C.party_code  
    ,S.scheme_name  
    ,A.AMC_Name  
    ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   
    ,BeneficiaryID=h.HLD_AC_CODE  
    ,PurchaseCost=0  
    ,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100))   
    ,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))  
    ,NAVDate=convert(varchar(11),S.nav_date,109)  
    ,ViewTransaction=(case when Exists (select top 1 party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = C.party_code ) Then 'Y' else 'N' end)  
    ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   
    ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   
    ,S.scheme_code  
    from   
    @Client  C  ,[172.31.16.94].DMAT.[dbo].[synergy_holding] h with(nolock), [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [196.1.115.132].risk.dbo.amccode A with(nolock)  
    where   
    C.party_code=@partycode  
    and h.HLD_AC_CODE=C.Cltdpid  
    and h.HLD_ISIN_CODE=S.isin  
    --and S.scheme_name=@SchemeName  
    and S.AMC_Code=A.AMC_Code  
    and A.amc_active_flag=1   
    and A.AMC_Name=@AMCName  
 end  
 else if @partycode='' and @SchemeName='' and @AMCName<>''  
 begin  
    select distinct  
     C.party_code  
    ,S.scheme_name  
    ,A.AMC_Name  
    ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   
    ,BeneficiaryID=h.HLD_AC_CODE  
    ,PurchaseCost=0  
    ,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100))   
    ,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))  
    ,NAVDate=convert(varchar(11),S.nav_date,109)  
    ,ViewTransaction=(case when Exists (select top 1 party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = C.party_code ) Then 'Y' else 'N' end)  
    ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   
    ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   
    ,S.scheme_code  
    from   
    [196.1.115.132].risk.dbo.amccode A with(nolock),[196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock),[172.31.16.94].DMAT.[dbo].[synergy_holding] h with(nolock), anand.bsedb_ab.dbo.client4 C with(nolock)  
    where   
         A.AMC_Name=@AMCName  
      and A.amc_active_flag=1  
      and A.AMC_Code=S.AMC_Code  
      and S.isin=h.HLD_ISIN_CODE  
      and h.HLD_AC_CODE=C.Cltdpid  
  
     
 end  
 else if @partycode='' and @SchemeName<>'' and @AMCName<>''  
 begin  
    select distinct  
     C.party_code  
    ,S.scheme_name  
    ,A.AMC_Name  
    ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   
    ,BeneficiaryID=h.HLD_AC_CODE  
    ,PurchaseCost=0  
    ,MarketValue=CAST(CAST((isnull(h.hld_ac_pos,0) * S.nav_value) AS DECIMAL(38,2)) as VARCHAR(100))   
    ,LatestNAV=CAST(CAST(S.nav_value  AS DECIMAL(38,2)) as VARCHAR(100))  
    ,NAVDate=convert(varchar(11),S.nav_date,109)  
    ,ViewTransaction=(case when Exists (select top 1 party_code from  [196.1.115.207].crm.dbo.tbl_MutualFundOrders  with(nolock)  where party_code = C.party_code ) Then 'Y' else 'N' end)  
    ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   
    ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   
    ,S.scheme_code  
    from   
     [196.1.115.132].risk.dbo.amccode A with(nolock),[196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock),[172.31.16.94].DMAT.[dbo].[synergy_holding] h with(nolock), anand.bsedb_ab.dbo.client4 C with(nolock)  
    where   
         A.AMC_Name=@AMCName  
      and A.amc_active_flag=1  
      and A.AMC_Code=S.AMC_Code  
      and S.scheme_name=@SchemeName  
      and S.isin=h.HLD_ISIN_CODE  
      and h.HLD_AC_CODE=C.Cltdpid  
  
     
 end  
END  
  
--Select top 20 * from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster with(nolock) where amc_active_flag=1  
--select top 20 * from anand.bsedb_ab.dbo.client4 with(nolock) where  bankid='12033200' order by defdp desc  
--select top 20 * from [196.1.115.132].risk.dbo.amccode A with(nolock)  
--Select top 2 * from [172.31.16.94].INHOUSE.DBO.tbl_CLIENT_MASTER with(nolock)  
  
-- select top 2 *  from [172.31.16.94].DMAT.[dbo].[synergy_holding] with(nolock) where hld_ac_code=@client_dpid AND HLD_ISIN_CODE=@Scheme_Code     
  
-- select S.scheme_name  
-- ,A.AMC_Name  
  
-- from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock) , [196.1.115.132].risk.dbo.amccode A with(nolock),[172.31.16.94].DMAT.[dbo].[synergy_holding] h with(nolock), anand.bsedb_ab.dbo.client4  C with(nolock)   
--   where A.AMC_Name=@AMCName      
--   and S.AMC_Code=A.AMC_Code  
--   and A.amc_active_flag=1   
--   and S.scheme_name=@SchemeName  
--   and s.isin=h.HLD_ISIN_CODE  
--   and h.HLD_AC_CODE=C.Cltdpid  
--   and  C.bankid='12033200'  
--   and C.party_code=@partycode  
  
-- select   
--     C.party_code  
--    ,S.scheme_name  
-- ,A.AMC_Name  
-- ,UnitsHoldings=CAST(CAST(isnull(h.hld_ac_pos,0) AS DECIMAL(38,2)) as VARCHAR(100))   
-- ,BeneficiaryID=h.HLD_AC_CODE  
-- ,PurchaseCost=0  
-- ,MarketValue=(isnull(h.hld_ac_pos,0) * S.nav_value)  
-- ,LatestNAV=S.nav_value  
-- ,NAVDate=convert(varchar(11),S.nav_date,109)  
-- ,ViewTransaction=''  
-- ,BUY=case when S.purchase_allowed='Y' then 'YES' ELSE 'NO' END   
-- ,SELL=case when S.redemption_allowed='Y' then 'YES' ELSE 'NO' END   
-- from   
--  anand.bsedb_ab.dbo.client4  C with(nolock) ,[172.31.16.94].DMAT.[dbo].[synergy_holding] h with(nolock), [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock), [196.1.115.132].risk.dbo.amccode A with(nolock)  
--  where   
--    C.bankid='12033200'  
-- and C.party_code=@partycode  
-- and h.HLD_AC_CODE=C.Cltdpid  
-- and h.HLD_ISIN_CODE=S.isin  
-- and S.scheme_name=@SchemeName  
-- and S.AMC_Code=A.AMC_Code  
-- and A.amc_active_flag=1   
-- and A.AMC_Name=@AMCName

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MutualFund_UnitHolding_Mimansa
-- --------------------------------------------------


-- =============================================  

-- Author:  Anand Dhumal   

-- Create date: Nov 06 2015  

-- Description: Mutual fund unit holding SP  

  

-- EXEC [usp_MutualFund_UnitHolding_Mimansa] 'P00045','BROKER','','AXIS','','AMCName'  

-- EXEC [usp_MutualFund_UnitHolding_Mimansa] 'E60278','BROKER','','Axis Mutual Fund','','SchemeName'  

-- EXEC [usp_MutualFund_UnitHolding_Mimansa] 'E54333','BROKER','V45643','','','FetchData'  

  

  

-- =============================================  

CREATE PROCEDURE [dbo].[usp_MutualFund_UnitHolding_Mimansa]  

 @empNo varchar(20),  

 @StatusId varchar(20),  

 @clientcode varchar(20),  

 @AMCName varchar(100),  

 @SchemeName varchar(200),  

 @flag varchar(20)  

  

AS  

BEGIN  

   

 SET NOCOUNT ON;  

  

   

  

 DECLARE @strSql AS VARCHAR(5000)  

  

 DECLARE @TempUserBranch TABLE                                                  

 (                                                  

  branch_cd VARCHAR(20)                                                                   

 )  

   

 DECLARE @TempClients TABLE   

 (  

  ClentCode varchar(20)  

 )   

  

 if(@flag='AMCName')  

 Begin  

   Select '--Select--' as AMC_Name  

   Union All  

   Select distinct AMC_Name from risk.dbo.amccode with(nolock) where Amc_Active_Flag = 1   

   return  

 End    

 if(@flag='SchemeName')  

 Begin  

   Set @SchemeName = '%' + @SchemeName + '%'  

     

    select distinct ( select upper(T.N.value('.', 'char(1)'))+ lower(stuff(T.N.value('.', 'varchar(max)'), 1, 1, ''))+' '  

    from X.InsXML.nodes('/N') as T(N)  

    for xml path(''), type  

   ).value('.', 'varchar(max)') as scheme_name  

 from   

  (  

  Select cast(replace(InsXML,'&AXXXXXXAA', ' </N><N>') as XML) as InsXML from  

  (select cast('<N>'+  

      replace(  

      replace(  

      replace(  

      replace(S.scheme_name,  

      '&', '&amp;'),  

      '<', '&lt;'),  

      '  ','&AXXXXXXAA'),  

      ' ','</N><N>')  

      +'</N>' as varchar(500)) as InsXML  

   from MIDDLEWARE.commonmaster.dbo.vw_etl_mfschememaster S with(nolock) , risk.dbo.amccode A with(nolock)  

   where A.AMC_Name=@AMCName      

   and S.AMC_Code=A.AMC_Code  

   and A.amc_active_flag=1   

   and scheme_name like @SchemeName  

   and  (redemption_allowed='Y' or purchase_allowed='Y')  

   and scheme_name not like '%Direct%'  

   ) as A) as X  

   return  

 End    

   

 if(@flag='FetchData')  

 Begin  

  

  if(@clientcode<>'')  

  Begin  

    if NOT EXISTS(Select party_code from [MIMANSA].angelcs.dbo.angelclient1 with(nolock) where party_code=@clientcode)  

    BEGIN  

      Select Error='ERROR' , MSG = 'Please enter valid Client code.'  

      return  

    END  

  End  

  

  if(@AMCName<>'')  

  BEGIN  

  print 'aa'  

   if NOT EXISTS(Select AMC_Name from risk.dbo.amccode with(nolock) where  AMC_Name = @AMCName and Amc_Active_Flag = 1)  

   BEGIN  

     Select Error='ERROR' , MSG = 'Please enter valid AMC name.'  

     return  

   END  

  END  

  if(@SchemeName<>'')  

  BEGIN  

   if NOT EXISTS(Select scheme_name from MIDDLEWARE.commonmaster.dbo.vw_etl_mfschememaster S with(nolock) , risk.dbo.amccode A with(nolock)  

       where A.AMC_Name=@AMCName      

       and S.AMC_Code=A.AMC_Code  

       and A.amc_active_flag=1   

       and scheme_name = @SchemeName  

       and  (redemption_allowed='Y' or purchase_allowed='Y'))  

   BEGIN  

     Select Error='ERROR' , MSG = 'Please enter valid Scheme name.'  

     return  

   END  

  END  

  IF (UPPER(@StatusId) = 'EXECUTIVE')                       

  BEGIN  

    IF(@clientcode <> '')  

    BEGIN                                               

     IF NOT EXISTS(select Party_Code from [MIMANSA].angelcs.dbo.angelclient1 with(nolock) where  Party_Code=@clientcode   

            and (RmDealer=@Empno OR CommDealer1=@Empno OR Commdealer2=@Empno or CurrencyDealer=@Empno))  

     BEGIN  

       select ERROR='ERROR', MSG='The Client is not mapped under you.'  

       return  

     END   

    END   

    ELSE  

    BEGIN  

     Insert into @TempClients  

     Select distinct party_code from [MIMANSA].angelcs.dbo.angelclient1 with(nolock)        where (RmDealer=@Empno OR CommDealer1=@Empno OR Commdealer2=@Empno or CurrencyDealer=@Empno)  

    END  

  END   

  ELSE  

  BEGIN  

    Insert into @TempUserBranch  

    Select distinct branch_cd from [MIMANSA].angelcs.dbo.angeluserbranch WITH(NOLOCK)       

    where Emp_no=@EmpNo  

    --OPTION (RECOMPILE)   

  

    IF(@clientcode <> '')  

    BEGIN     

     IF NOT EXISTS (Select A.party_code from [MIMANSA].angelcs.dbo.angelClient1 A with(nolock),@TempUserBranch T   

                 where A.party_code=@clientcode and A.branch_cd=T.branch_cd)    

     BEGIN  

       select ERROR='ERROR', MSG='The Client is not mapped under you.'  

       return  

     END   

    END  

  END  

  

  SET @AMCName = @AMCName + '%'  

  SET @SchemeName = @SchemeName + '%'  

   

  IF(UPPER(@StatusId) = 'EXECUTIVE' AND @clientcode = '')  

  BEGIN    

    select hld_isin_code,hld_ac_code,hld_ac_pos,cm_blsavingcd=nise_party_code,cm_name=first_hold_name  

    into #Holding2   

    from [AngelDP4].inhouse.dbo.Holding hld_acnt with(nolock)    

    inner hash join [AngelDP4].inhouse.dbo.tbl_client_master client with(nolock) on hld_acnt.hld_ac_code=client.client_Code  

    inner remote join risk.dbo.client_details c with(nolock) on client.nise_party_code=c.party_code  

    where hld_isin_code like '%inf%' and left(hld_ac_code,8)='12033200'   

    and client.nise_party_code in (Select ClentCode from @TempClients)  

    and isnull(hld_ac_pos,0)>0   

    order by hld_hold_date desc;    

  

    select distinct scheme_name,nav_value,nav_Date,isin,amc_name  

    into #scheme2   

    from MIDDLEWARE.commonmaster.dbo.vw_etl_mfschememaster a with(nolock)  

    inner hash join  risk.dbo.amccode b with(nolock) on b.amc_code=a.amc_code  

    where isin in(select hld_isin_code from #Holding2) and  (redemption_allowed='Y' or purchase_allowed='Y')  

  

    select distinct [Client Code]=UPPER(cm_blsavingcd),        

    [Scheme Name]=scheme_name,     

    [AMC Name]=amc_name,       

    [Units Holdings]= CAST(SUM(isnull(hld_ac_pos,0)) AS DECIMAL(38,2)),   

    [Beneficiary ID]=HLD_ac_code,     

    [Purchase Cost]=0,    

    [Market Value]=CAST( SUM(ISNULL(hld_ac_pos,0)*ISNULL(nav_value,0))  AS DECIMAL(38,2)) ,        

    [Latest NAV]=CAST(isnull(c.nav_value,0) AS DECIMAL(38,2)),      

    [NAV Date]=CONVERT(char(16), c.nav_Date, 110),        

    [View Transaction]='',  

    [Action]=''  

    from #Holding a with (nolock)       

    inner hash join #scheme2 c with (nolock) on hld_isin_code = c.isin     

    and amc_name like @AMCName   

    and scheme_name like @SchemeName  

    group by hld_isin_code,a.cm_blsavingcd,HLD_ac_code,scheme_name,amc_name,nav_Date,nav_value,cm_name;  

  END  

  ELSE IF(@clientcode <> '')  

  BEGIN    

    select hld_isin_code,hld_ac_code,hld_ac_pos,cm_blsavingcd=nise_party_code,cm_name=first_hold_name  

    into #Holding   

    from [AngelDP4].inhouse.dbo.Holding hld_acnt with(nolock)    

    inner hash join [AngelDP4].inhouse.dbo.tbl_client_master client with(nolock) on hld_acnt.hld_ac_code=client.client_Code  

    inner remote join risk.dbo.client_details c with(nolock) on client.nise_party_code=c.party_code  

    where hld_isin_code like '%inf%' and left(hld_ac_code,8)='12033200'   

    and client.nise_party_code = @clientcode  

    and isnull(hld_ac_pos,0)>0   

    order by hld_hold_date desc;    

  

    select distinct scheme_name,nav_value,nav_Date,isin,amc_name  

    into #scheme   

    from MIDDLEWARE.commonmaster.dbo.vw_etl_mfschememaster a with(nolock)  

    inner hash join  risk.dbo.amccode b with(nolock) on b.amc_code=a.amc_code  

    where isin in(select hld_isin_code from #Holding) and  (redemption_allowed='Y' or purchase_allowed='Y')  

  

    select distinct [Client Code]=UPPER(cm_blsavingcd),        

    [Scheme Name]=scheme_name,     

    [AMC Name]=amc_name,       

    [Units Holdings]= CAST(SUM(isnull(hld_ac_pos,0)) AS DECIMAL(38,2)),   

    [Beneficiary ID]=HLD_ac_code,     

    [Purchase Cost]=0,    

    [Market Value]=CAST( SUM(ISNULL(hld_ac_pos,0)*ISNULL(nav_value,0))  AS DECIMAL(38,2)) ,        

    [Latest NAV]=CAST(isnull(c.nav_value,0) AS DECIMAL(38,2)),      

    [NAV Date]=CONVERT(char(16), c.nav_Date, 110),        

    [View Transaction]='',  

    [Action]=''  

    from #Holding a with (nolock)       

    inner hash join #scheme c with (nolock) on hld_isin_code = c.isin     

    and amc_name like @AMCName   

    and scheme_name like @SchemeName   

    group by hld_isin_code,a.cm_blsavingcd,HLD_ac_code,scheme_name,amc_name,nav_Date,nav_value,cm_name;  

  END  

  ELSE  

  BEGIN  

    select hld_isin_code,hld_ac_code,hld_ac_pos,cm_blsavingcd=nise_party_code,cm_name=first_hold_name  

    into #Holding1   

    from [AngelDP4].inhouse.dbo.Holding hld_acnt with(nolock)    

    inner hash join [AngelDP4].inhouse.dbo.tbl_client_master client with(nolock) on hld_acnt.hld_ac_code=client.client_Code  

    inner remote join risk.dbo.client_details c with(nolock) on client.nise_party_code=c.party_code  

    where hld_isin_code like '%inf%' and left(hld_ac_code,8)='12033200'   

    and C.branch_cd in (Select branch_cd from @TempUserBranch)  

    and client.nise_party_code<>'' and isnull(hld_ac_pos,0)>0   

    order by hld_hold_date desc;    

  

    select distinct scheme_name,nav_value,nav_Date,isin,amc_name  

    into #scheme1   

    from MIDDLEWARE.commonmaster.dbo.vw_etl_mfschememaster a with(nolock)  

    inner hash join  risk.dbo.amccode b with(nolock) on b.amc_code=a.amc_code  

    where isin in(select hld_isin_code from #Holding1) and  (redemption_allowed='Y' or purchase_allowed='Y');  

  

    select distinct [Client Code]=UPPER(cm_blsavingcd),        

    [Scheme Name]=scheme_name,     

    [AMC Name]=amc_name,       

    [Units Holdings]= CAST(SUM(isnull(hld_ac_pos,0)) AS DECIMAL(38,2)),   

    [Beneficiary ID]=HLD_ac_code,     

    [Purchase Cost]=0,    

    [Market Value]=CAST( SUM(ISNULL(hld_ac_pos,0)*ISNULL(nav_value,0))  AS DECIMAL(38,2)) ,        

    [Latest NAV]=CAST(isnull(c.nav_value,0) AS DECIMAL(38,2)),      

    [NAV Date]=CONVERT(char(16), c.nav_Date, 110),     

    [View Transaction]='',  

    [Action]=''  

    from #Holding1 a with (nolock)       

    inner hash join #scheme1 c with (nolock) on hld_isin_code = c.isin      

    and amc_name like @AMCName   

    and scheme_name like @SchemeName  

    group by hld_isin_code,a.cm_blsavingcd,HLD_ac_code,scheme_name,amc_name,nav_Date,nav_value,cm_name;    

    print 'AA'  

  END  

 END  

/*    

 if(@clientcode<>'')  

 Begin  

   select hld_isin_code,hld_ac_code,hld_ac_pos,cm_blsavingcd=nise_party_code,cm_name=first_hold_name  

   into #Holding   

   from [AngelDP4].inhouse.dbo.Holding hld_acnt with(nolock)    

   inner hash join [AngelDP4].inhouse.dbo.tbl_client_master client with(nolock) on hld_acnt.hld_ac_code=client.client_Code  

   inner remote join risk.dbo.client_details c with(nolock) on client.nise_party_code=c.party_code  

   where hld_isin_code like '%inf%' and left(hld_ac_code,8)='12033200' and client.nise_party_code=@clientcode and isnull(hld_ac_pos,0)>0   

   order by hld_hold_date desc;    

  

   select scheme_name,nav_value,nav_Date,isin,amc_name  

   into #scheme   

   from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster a with(nolock)  

   inner hash join  risk.dbo.amccode b with(nolock) on b.amc_code=a.amc_code  

   where isin in(select hld_isin_code from #Holding) and  (redemption_allowed='Y' or purchase_allowed='Y')  

  

   select [Client Code]=UPPER(cm_blsavingcd),        

   [Scheme Name]=scheme_name,     

   [AMC Name]=amc_name,       

   [Units Holdings]= CAST(SUM(isnull(hld_ac_pos,0)) AS DECIMAL(38,2)),   

   [Beneficiary ID]=HLD_ac_code,     

   [Purchase Cost]=0,    

   [Market Value]=CAST( SUM(ISNULL(hld_ac_pos,0)*ISNULL(nav_value,0))  AS DECIMAL(38,2)) ,        

   [Latest NAV]=CAST(isnull(c.nav_value,0) AS DECIMAL(38,2)),      

   [NAV Date]=CONVERT(char(16), c.nav_Date, 110),        

   [View Transaction]='',  

   [Action]=''  

   from #Holding a with (nolock)       

   inner hash join #scheme c with (nolock) on hld_isin_code = c.isin      

   group by hld_isin_code,a.cm_blsavingcd,HLD_ac_code,scheme_name,amc_name,nav_Date,nav_value,cm_name;  

    

 End  

 Else  

 Begin  

   select hld_isin_code,hld_ac_code,hld_ac_pos,cm_blsavingcd=nise_party_code,cm_name=first_hold_name  

   into #Holding1   

   from [AngelDP4].inhouse.dbo.Holding hld_acnt with(nolock)    

   inner hash join [AngelDP4].inhouse.dbo.tbl_client_master client with(nolock) on hld_acnt.hld_ac_code=client.client_Code  

   inner remote join risk.dbo.client_details c with(nolock) on client.nise_party_code=c.party_code  

   where hld_isin_code like '%inf%' and left(hld_ac_code,8)='12033200' and client.nise_party_code<>'' and isnull(hld_ac_pos,0)>0   

   order by hld_hold_date desc;    

  

   select scheme_name,nav_value,nav_Date,isin,amc_name  

   into #scheme1   

   from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster a with(nolock)  

   inner hash join  risk.dbo.amccode b with(nolock) on b.amc_code=a.amc_code  

   where isin in(select hld_isin_code from #Holding1) and  (redemption_allowed='Y' or purchase_allowed='Y');  

  

   select [Client Code]=UPPER(cm_blsavingcd),        

   [Scheme Name]=scheme_name,     

   [AMC Name]=amc_name,       

   [Units Holdings]= CAST(SUM(isnull(hld_ac_pos,0)) AS DECIMAL(38,2)),   

   [Beneficiary ID]=HLD_ac_code,     

   [Purchase Cost]=0,    

   [Market Value]=CAST( SUM(ISNULL(hld_ac_pos,0)*ISNULL(nav_value,0))  AS DECIMAL(38,2)) ,        

   [Latest NAV]=CAST(isnull(c.nav_value,0) AS DECIMAL(38,2)),      

   [NAV Date]=CONVERT(char(16), c.nav_Date, 110),     

   [View Transaction]='',  

   [Action]=''  

   from #Holding1 a with (nolock)       

   inner hash join #scheme1 c with (nolock) on hld_isin_code = c.isin      

   group by hld_isin_code,a.cm_blsavingcd,HLD_ac_code,scheme_name,amc_name,nav_Date,nav_value,cm_name;    

 End  

*/  

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MutualFund_UnitHolding_Mimansa_25jan2022
-- --------------------------------------------------
-- =============================================  
-- Author:  Anand Dhumal   
-- Create date: Nov 06 2015  
-- Description: Mutual fund unit holding SP  
  
-- EXEC [usp_MutualFund_UnitHolding_Mimansa] 'P00045','BROKER','','AXIS','','AMCName'  
-- EXEC [usp_MutualFund_UnitHolding_Mimansa] 'E60278','BROKER','','Axis Mutual Fund','','SchemeName'  
-- EXEC [usp_MutualFund_UnitHolding_Mimansa] 'E54333','BROKER','V45643','','','FetchData'  
  
  
-- =============================================  
CREATE PROCEDURE [dbo].[usp_MutualFund_UnitHolding_Mimansa_25jan2022]  
 @empNo varchar(20),  
 @StatusId varchar(20),  
 @clientcode varchar(20),  
 @AMCName varchar(100),  
 @SchemeName varchar(200),  
 @flag varchar(20)  
  
AS  
BEGIN  
   
 SET NOCOUNT ON;  
  
   
  
 DECLARE @strSql AS VARCHAR(5000)  
  
 DECLARE @TempUserBranch TABLE                                                  
 (                                                  
  branch_cd VARCHAR(20)                                                                   
 )  
   
 DECLARE @TempClients TABLE   
 (  
  ClentCode varchar(20)  
 )   
  
 if(@flag='AMCName')  
 Begin  
   Select '--Select--' as AMC_Name  
   Union All  
   Select distinct AMC_Name from risk.dbo.amccode with(nolock) where Amc_Active_Flag = 1   
   return  
 End    
 if(@flag='SchemeName')  
 Begin  
   Set @SchemeName = '%' + @SchemeName + '%'  
     
    select distinct ( select upper(T.N.value('.', 'char(1)'))+ lower(stuff(T.N.value('.', 'varchar(max)'), 1, 1, ''))+' '  
    from X.InsXML.nodes('/N') as T(N)  
    for xml path(''), type  
   ).value('.', 'varchar(max)') as scheme_name  
 from   
  (  
  Select cast(replace(InsXML,'&AXXXXXXAA', ' </N><N>') as XML) as InsXML from  
  (select cast('<N>'+  
      replace(  
      replace(  
      replace(  
      replace(S.scheme_name,  
      '&', '&amp;'),  
      '<', '&lt;'),  
      '  ','&AXXXXXXAA'),  
      ' ','</N><N>')  
      +'</N>' as varchar(500)) as InsXML  
   from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock) , risk.dbo.amccode A with(nolock)  
   where A.AMC_Name=@AMCName      
   and S.AMC_Code=A.AMC_Code  
   and A.amc_active_flag=1   
   and scheme_name like @SchemeName  
   and  (redemption_allowed='Y' or purchase_allowed='Y')  
   and scheme_name not like '%Direct%'  
   ) as A) as X  
   return  
 End    
   
 if(@flag='FetchData')  
 Begin  
  
  if(@clientcode<>'')  
  Begin  
    if NOT EXISTS(Select party_code from [196.1.115.207].angelcs.dbo.angelclient1 with(nolock) where party_code=@clientcode)  
    BEGIN  
      Select Error='ERROR' , MSG = 'Please enter valid Client code.'  
      return  
    END  
  End  
  
  if(@AMCName<>'')  
  BEGIN  
  print 'aa'  
   if NOT EXISTS(Select AMC_Name from risk.dbo.amccode with(nolock) where  AMC_Name = @AMCName and Amc_Active_Flag = 1)  
   BEGIN  
     Select Error='ERROR' , MSG = 'Please enter valid AMC name.'  
     return  
   END  
  END  
  if(@SchemeName<>'')  
  BEGIN  
   if NOT EXISTS(Select scheme_name from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster S with(nolock) , risk.dbo.amccode A with(nolock)  
       where A.AMC_Name=@AMCName      
       and S.AMC_Code=A.AMC_Code  
       and A.amc_active_flag=1   
       and scheme_name = @SchemeName  
       and  (redemption_allowed='Y' or purchase_allowed='Y'))  
   BEGIN  
     Select Error='ERROR' , MSG = 'Please enter valid Scheme name.'  
     return  
   END  
  END  
  IF (UPPER(@StatusId) = 'EXECUTIVE')                       
  BEGIN  
    IF(@clientcode <> '')  
    BEGIN                                               
     IF NOT EXISTS(select Party_Code from [196.1.115.207].angelcs.dbo.angelclient1 with(nolock) where  Party_Code=@clientcode   
            and (RmDealer=@Empno OR CommDealer1=@Empno OR Commdealer2=@Empno or CurrencyDealer=@Empno))  
     BEGIN  
       select ERROR='ERROR', MSG='The Client is not mapped under you.'  
       return  
     END   
    END   
    ELSE  
    BEGIN  
     Insert into @TempClients  
     Select distinct party_code from [196.1.115.207].angelcs.dbo.angelclient1 with(nolock)        where (RmDealer=@Empno OR CommDealer1=@Empno OR Commdealer2=@Empno or CurrencyDealer=@Empno)  
    END  
  END   
  ELSE  
  BEGIN  
    Insert into @TempUserBranch  
    Select distinct branch_cd from [196.1.115.207].angelcs.dbo.angeluserbranch WITH(NOLOCK)       
    where Emp_no=@EmpNo  
    --OPTION (RECOMPILE)   
  
    IF(@clientcode <> '')  
    BEGIN     
     IF NOT EXISTS (Select A.party_code from [196.1.115.207].angelcs.dbo.angelClient1 A with(nolock),@TempUserBranch T   
                 where A.party_code=@clientcode and A.branch_cd=T.branch_cd)    
     BEGIN  
       select ERROR='ERROR', MSG='The Client is not mapped under you.'  
       return  
     END   
    END  
  END  
  
  SET @AMCName = @AMCName + '%'  
  SET @SchemeName = @SchemeName + '%'  
   
  IF(UPPER(@StatusId) = 'EXECUTIVE' AND @clientcode = '')  
  BEGIN    
    select hld_isin_code,hld_ac_code,hld_ac_pos,cm_blsavingcd=nise_party_code,cm_name=first_hold_name  
    into #Holding2   
    from [172.31.16.94].inhouse.dbo.Holding hld_acnt with(nolock)    
    inner hash join [172.31.16.94].inhouse.dbo.tbl_client_master client with(nolock) on hld_acnt.hld_ac_code=client.client_Code  
    inner remote join risk.dbo.client_details c with(nolock) on client.nise_party_code=c.party_code  
    where hld_isin_code like '%inf%' and left(hld_ac_code,8)='12033200'   
    and client.nise_party_code in (Select ClentCode from @TempClients)  
    and isnull(hld_ac_pos,0)>0   
    order by hld_hold_date desc;    
  
    select distinct scheme_name,nav_value,nav_Date,isin,amc_name  
    into #scheme2   
    from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster a with(nolock)  
    inner hash join  risk.dbo.amccode b with(nolock) on b.amc_code=a.amc_code  
    where isin in(select hld_isin_code from #Holding2) and  (redemption_allowed='Y' or purchase_allowed='Y')  
  
    select distinct [Client Code]=UPPER(cm_blsavingcd),        
    [Scheme Name]=scheme_name,     
    [AMC Name]=amc_name,       
    [Units Holdings]= CAST(SUM(isnull(hld_ac_pos,0)) AS DECIMAL(38,2)),   
    [Beneficiary ID]=HLD_ac_code,     
    [Purchase Cost]=0,    
    [Market Value]=CAST( SUM(ISNULL(hld_ac_pos,0)*ISNULL(nav_value,0))  AS DECIMAL(38,2)) ,        
    [Latest NAV]=CAST(isnull(c.nav_value,0) AS DECIMAL(38,2)),      
    [NAV Date]=CONVERT(char(16), c.nav_Date, 110),        
    [View Transaction]='',  
    [Action]=''  
    from #Holding a with (nolock)       
    inner hash join #scheme2 c with (nolock) on hld_isin_code = c.isin     
    and amc_name like @AMCName   
    and scheme_name like @SchemeName  
    group by hld_isin_code,a.cm_blsavingcd,HLD_ac_code,scheme_name,amc_name,nav_Date,nav_value,cm_name;  
  END  
  ELSE IF(@clientcode <> '')  
  BEGIN    
    select hld_isin_code,hld_ac_code,hld_ac_pos,cm_blsavingcd=nise_party_code,cm_name=first_hold_name  
    into #Holding   
    from [172.31.16.94].inhouse.dbo.Holding hld_acnt with(nolock)    
    inner hash join [172.31.16.94].inhouse.dbo.tbl_client_master client with(nolock) on hld_acnt.hld_ac_code=client.client_Code  
    inner remote join risk.dbo.client_details c with(nolock) on client.nise_party_code=c.party_code  
    where hld_isin_code like '%inf%' and left(hld_ac_code,8)='12033200'   
    and client.nise_party_code = @clientcode  
    and isnull(hld_ac_pos,0)>0   
    order by hld_hold_date desc;    
  
    select distinct scheme_name,nav_value,nav_Date,isin,amc_name  
    into #scheme   
    from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster a with(nolock)  
    inner hash join  risk.dbo.amccode b with(nolock) on b.amc_code=a.amc_code  
    where isin in(select hld_isin_code from #Holding) and  (redemption_allowed='Y' or purchase_allowed='Y')  
  
    select distinct [Client Code]=UPPER(cm_blsavingcd),        
    [Scheme Name]=scheme_name,     
    [AMC Name]=amc_name,       
    [Units Holdings]= CAST(SUM(isnull(hld_ac_pos,0)) AS DECIMAL(38,2)),   
    [Beneficiary ID]=HLD_ac_code,     
    [Purchase Cost]=0,    
    [Market Value]=CAST( SUM(ISNULL(hld_ac_pos,0)*ISNULL(nav_value,0))  AS DECIMAL(38,2)) ,        
    [Latest NAV]=CAST(isnull(c.nav_value,0) AS DECIMAL(38,2)),      
    [NAV Date]=CONVERT(char(16), c.nav_Date, 110),        
    [View Transaction]='',  
    [Action]=''  
    from #Holding a with (nolock)       
    inner hash join #scheme c with (nolock) on hld_isin_code = c.isin     
    and amc_name like @AMCName   
    and scheme_name like @SchemeName   
    group by hld_isin_code,a.cm_blsavingcd,HLD_ac_code,scheme_name,amc_name,nav_Date,nav_value,cm_name;  
  END  
  ELSE  
  BEGIN  
    select hld_isin_code,hld_ac_code,hld_ac_pos,cm_blsavingcd=nise_party_code,cm_name=first_hold_name  
    into #Holding1   
    from [172.31.16.94].inhouse.dbo.Holding hld_acnt with(nolock)    
    inner hash join [172.31.16.94].inhouse.dbo.tbl_client_master client with(nolock) on hld_acnt.hld_ac_code=client.client_Code  
    inner remote join risk.dbo.client_details c with(nolock) on client.nise_party_code=c.party_code  
    where hld_isin_code like '%inf%' and left(hld_ac_code,8)='12033200'   
    and C.branch_cd in (Select branch_cd from @TempUserBranch)  
    and client.nise_party_code<>'' and isnull(hld_ac_pos,0)>0   
    order by hld_hold_date desc;    
  
    select distinct scheme_name,nav_value,nav_Date,isin,amc_name  
    into #scheme1   
    from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster a with(nolock)  
    inner hash join  risk.dbo.amccode b with(nolock) on b.amc_code=a.amc_code  
    where isin in(select hld_isin_code from #Holding1) and  (redemption_allowed='Y' or purchase_allowed='Y');  
  
    select distinct [Client Code]=UPPER(cm_blsavingcd),        
    [Scheme Name]=scheme_name,     
    [AMC Name]=amc_name,       
    [Units Holdings]= CAST(SUM(isnull(hld_ac_pos,0)) AS DECIMAL(38,2)),   
    [Beneficiary ID]=HLD_ac_code,     
    [Purchase Cost]=0,    
    [Market Value]=CAST( SUM(ISNULL(hld_ac_pos,0)*ISNULL(nav_value,0))  AS DECIMAL(38,2)) ,        
    [Latest NAV]=CAST(isnull(c.nav_value,0) AS DECIMAL(38,2)),      
    [NAV Date]=CONVERT(char(16), c.nav_Date, 110),     
    [View Transaction]='',  
    [Action]=''  
    from #Holding1 a with (nolock)       
    inner hash join #scheme1 c with (nolock) on hld_isin_code = c.isin      
    and amc_name like @AMCName   
    and scheme_name like @SchemeName  
    group by hld_isin_code,a.cm_blsavingcd,HLD_ac_code,scheme_name,amc_name,nav_Date,nav_value,cm_name;    
    print 'AA'  
  END  
 END  
/*    
 if(@clientcode<>'')  
 Begin  
   select hld_isin_code,hld_ac_code,hld_ac_pos,cm_blsavingcd=nise_party_code,cm_name=first_hold_name  
   into #Holding   
   from [172.31.16.94].inhouse.dbo.Holding hld_acnt with(nolock)    
   inner hash join [172.31.16.94].inhouse.dbo.tbl_client_master client with(nolock) on hld_acnt.hld_ac_code=client.client_Code  
   inner remote join risk.dbo.client_details c with(nolock) on client.nise_party_code=c.party_code  
   where hld_isin_code like '%inf%' and left(hld_ac_code,8)='12033200' and client.nise_party_code=@clientcode and isnull(hld_ac_pos,0)>0   
   order by hld_hold_date desc;    
  
   select scheme_name,nav_value,nav_Date,isin,amc_name  
   into #scheme   
   from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster a with(nolock)  
   inner hash join  risk.dbo.amccode b with(nolock) on b.amc_code=a.amc_code  
   where isin in(select hld_isin_code from #Holding) and  (redemption_allowed='Y' or purchase_allowed='Y')  
  
   select [Client Code]=UPPER(cm_blsavingcd),        
   [Scheme Name]=scheme_name,     
   [AMC Name]=amc_name,       
   [Units Holdings]= CAST(SUM(isnull(hld_ac_pos,0)) AS DECIMAL(38,2)),   
   [Beneficiary ID]=HLD_ac_code,     
   [Purchase Cost]=0,    
   [Market Value]=CAST( SUM(ISNULL(hld_ac_pos,0)*ISNULL(nav_value,0))  AS DECIMAL(38,2)) ,        
   [Latest NAV]=CAST(isnull(c.nav_value,0) AS DECIMAL(38,2)),      
   [NAV Date]=CONVERT(char(16), c.nav_Date, 110),        
   [View Transaction]='',  
   [Action]=''  
   from #Holding a with (nolock)       
   inner hash join #scheme c with (nolock) on hld_isin_code = c.isin      
   group by hld_isin_code,a.cm_blsavingcd,HLD_ac_code,scheme_name,amc_name,nav_Date,nav_value,cm_name;  
    
 End  
 Else  
 Begin  
   select hld_isin_code,hld_ac_code,hld_ac_pos,cm_blsavingcd=nise_party_code,cm_name=first_hold_name  
   into #Holding1   
   from [172.31.16.94].inhouse.dbo.Holding hld_acnt with(nolock)    
   inner hash join [172.31.16.94].inhouse.dbo.tbl_client_master client with(nolock) on hld_acnt.hld_ac_code=client.client_Code  
   inner remote join risk.dbo.client_details c with(nolock) on client.nise_party_code=c.party_code  
   where hld_isin_code like '%inf%' and left(hld_ac_code,8)='12033200' and client.nise_party_code<>'' and isnull(hld_ac_pos,0)>0   
   order by hld_hold_date desc;    
  
   select scheme_name,nav_value,nav_Date,isin,amc_name  
   into #scheme1   
   from [196.1.115.239].commonmaster.dbo.vw_etl_mfschememaster a with(nolock)  
   inner hash join  risk.dbo.amccode b with(nolock) on b.amc_code=a.amc_code  
   where isin in(select hld_isin_code from #Holding1) and  (redemption_allowed='Y' or purchase_allowed='Y');  
  
   select [Client Code]=UPPER(cm_blsavingcd),        
   [Scheme Name]=scheme_name,     
   [AMC Name]=amc_name,       
   [Units Holdings]= CAST(SUM(isnull(hld_ac_pos,0)) AS DECIMAL(38,2)),   
   [Beneficiary ID]=HLD_ac_code,     
   [Purchase Cost]=0,    
   [Market Value]=CAST( SUM(ISNULL(hld_ac_pos,0)*ISNULL(nav_value,0))  AS DECIMAL(38,2)) ,        
   [Latest NAV]=CAST(isnull(c.nav_value,0) AS DECIMAL(38,2)),      
   [NAV Date]=CONVERT(char(16), c.nav_Date, 110),     
   [View Transaction]='',  
   [Action]=''  
   from #Holding1 a with (nolock)       
   inner hash join #scheme1 c with (nolock) on hld_isin_code = c.isin      
   group by hld_isin_code,a.cm_blsavingcd,HLD_ac_code,scheme_name,amc_name,nav_Date,nav_value,cm_name;    
 End  
*/  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_MutualFundBuySellLimits
-- --------------------------------------------------


-- =============================================

-- Author:		Anand Dhuaml

-- Create date: <Create Date,,>

-- Description:	<Description,,>

-- =============================================

CREATE PROCEDURE [dbo].[usp_MutualFundBuySellLimits]

	-- Add the parameters for the stored procedure here

	@party_code varchar(20),

	@client_dpid varchar(20),

	@Scheme_isin varchar(250),

	@AmcName varchar(100),

	@Transaction varchar(20)





AS

BEGIN

	-- SET NOCOUNT ON added to prevent extra result sets from

	-- interfering with SELECT statements.

	SET NOCOUNT ON;



	Declare @AmcCode varchar(50)



	CREATE TABLE #Units

	(

	SchemeName varchar(50),

	isin Varchar(50),

	nav_date varchar(50),

	nav_value Varchar(50),

	Purchase_allowed varchar(50),

	redemption_allowed Varchar(50),

	purchase_amt_multiplier varchar(50),

	Purchase_Cutoff_Time Varchar(50),

	limits_mfss varchar(50),

	DPUnits Varchar(50),

	minimum_pur_amt varchar(50),

	DPUnits_nav_value Varchar(50),

	)



	Select @AmcCode = AMC_Code from [INTRANET].risk.dbo.amccode with(nolock) where AMC_Name = @AmcName and Amc_Active_Flag = 1



   IF(@Transaction='BUY')

   BEGIN

		Select ''

   END

   IF(@Transaction='SELL')

   BEGIN

			--Insert into #Units 

			Exec risk.dbo.[usp_MFSS_GetScehmeCodeDetails] @Scheme_isin,@AmcCode,@party_code,@client_dpid,'0'



			--Select * from #Units

		   

   END



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.weekly_mail_dealer_mapping
-- --------------------------------------------------

CREATE procedure weekly_mail_dealer_mapping
as
begin
--select top 100 * from MIS.sb_comp.dbo.sb_broker WITH (nolock)

select top  10
	 b1.party_code,
	 a1.short_name,
	 a1.activefrom,
	 a1.lasttrade,
	 b1.emp_no,
	 b2.emp_name,
	 b1.branch_cd 
into #temp_list
from
	B2B_CommonPartyServices  b1 with(nolock) ,B2B_AngelHarmony b2 with(nolock),angelclient1 a1 with(nolock) 
where 
	valid='Y'
and b1.party_code=a1.party_code	
and b1.emp_no=b2.emp_no	
and b1.branch_cd=b2.sb_tag
and isAdmin=1	
--and b1.branch_cd='ett'
order by b1.branch_cd,b1.party_code

DECLARE @tableHTML NVARCHAR(MAX)   
declare @sb_tag varchar(10)
declare @date varchar(50)

declare @client_code varchar(10)
declare @Client_name varchar(500)
declare @Active_date varchar(50)
declare @Last_trade_date varchar(50)
declare @dealer_name varchar(500)
declare @client_count int

select @date= (select left(getdate(),11))

--select client_code=party_code,Client_name=short_name,Active_date=left(activefrom,11),
--		Last_trade_date=left(lasttrade,11),dealer_name=emp_name 
--		from #temp_list where branch_cd='ett'


declare @temp_test table
(
	text nvarchar(max)
)
	
Declare distinct_sub_broker Cursor for
select distinct branch_cd  from #temp_list

Open distinct_sub_broker

	Fetch Next from distinct_sub_broker
	Into @sb_tag
	
	--set @tableHTML=''
	
	while @@fetch_status=0 
	begin
		set @client_count=0
		select @client_count=count(*) from  #temp_list where branch_cd=@sb_tag
		
		if @client_count>0
		begin
		set @tableHTML=	'<p style="font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';">
		  Dear Partner, <br/><br/> Based on mapping done till yesterday '+ cast(@client_count as varchar) +' clients are still not mapped to any of your active dealers.:<br/>
		  Details are --> <br/>  
			<TABLE  style="width:464.0pt;font-size: 11.0pt; font-family: ''Calibri'',''sans-serif'';" cellpadding="2" cellspacing="0" > 
			 <tr>  
				<th style="border-left: 1px solid Black;border-top:1px solid Black;background-color:#C5CED5 ">Client Code</th>  
				<th style="border-left: 1px solid Black;border-top:1px solid Black; border-left:1px solid Black;background-color:#C5CED5">Client Name</th>  
				<th style="border-left: 1px solid Black;border-top:1px solid Black; border-left:1px solid Black;background-color:#C5CED5">Active Date</th>
				<th style="border-left: 1px solid Black;border-top:1px solid Black; border-left:1px solid Black;background-color:#C5CED5">Last Trade Date</th>
				<th style="border-left: 1px solid Black;border-top:1px solid Black; border-right:1px solid Black;border-left:1px solid Black;background-color:#C5CED5">Last Mapped Dealer Name</th>   
			</tr>' 
		  
		
		Declare inner_curser Cursor for
		select client_code=party_code,Client_name=short_name,Active_date=left(activefrom,11),
		Last_trade_date=left(lasttrade,11),dealer_name=emp_name 
		from #temp_list where branch_cd=@sb_tag
		
		Open inner_curser

			
		Fetch Next from inner_curser
		Into @client_code,@Client_name,@Active_date,@Last_trade_date,@dealer_name
		
		while @@fetch_status=0 
		begin
			
			set @tableHTML= @tableHTML+' 
							<tr>  
								 <TD style="border-left: 1px solid Black;border-top:1px solid Black; " align="left">'+@client_code+'</TD>  
								 <TD style="border-left: 1px solid Black;border-top:1px solid Black; border-left:1px solid Black;" align="left">'+@Client_name+'</TD>  
								 <TD style="border-left: 1px solid Black;border-top:1px solid Black; border-left:1px solid Black;" align="left">'+@Active_date+'</TD>
								 <TD style="border-left: 1px solid Black;border-top:1px solid Black; border-left:1px solid Black;" align="left">'+@Last_trade_date+'</TD> 
								 <TD style="border-left: 1px solid Black;border-top:1px solid Black; border-right:1px solid Black;border-left:1px solid Black;" align="left">'+@dealer_name+'</TD>    
							</tr>'
		
			
			Fetch Next from inner_curser
			Into @client_code,@Client_name,@Active_date,@Last_trade_date,@dealer_name	
				
		end
		
		set @tableHTML= @tableHTML+' 
							<tr>  
								 <TD style="border-top:1px solid Black;" align="center">&nbsp;</TD>  
								 <TD style="border-top:1px solid Black;" align="center">&nbsp;</TD>  
								 <TD style="border-top:1px solid Black;" align="center">&nbsp;</TD> 
								  <TD style="border-top:1px solid Black;" align="center">&nbsp;</TD> 
								 <TD style="border-top:1px solid Black;" align="center">&nbsp;</TD>    
							</tr>'
		  
		 set @tableHTML=@tableHTML +'</TABLE> <br/>
		Please map them to get the most out of CRMS.<br/>  
		Regards,<br/>  
		B2B CRMS Helpdesk Team'
		Close inner_curser
		Deallocate inner_curser	
		
		--insert into @temp_test select @tableHTML
		exec msdb.dbo.sp_send_dbmail   
		@recipients=N'prasannav.joshi@angeltrade.com', 
		--@recipients=N'Operation.angelgold@angelbroking.com', 
		@importance ='High',   
		@body_format='HTML',  
		--@copy_recipients ='',  
		@subject ='Non Mapped Clients',  
		@profile_name ='MimansaSoft',  
		@body=@tableHTML
	end
		
	Fetch Next from distinct_sub_broker
	Into @sb_tag
	end
	
		Close distinct_sub_broker
		Deallocate distinct_sub_broker
	
end

GO

-- --------------------------------------------------
-- TABLE dbo.AngelBOMenu
-- --------------------------------------------------
CREATE TABLE [dbo].[AngelBOMenu]
(
    [AngelBOMenuID] BIGINT IDENTITY(1,1) NOT NULL,
    [AngelUserID] BIGINT NULL,
    [BOUserName] VARCHAR(50) NULL,
    [HarmonyEmployeeCode] VARCHAR(20) NULL,
    [ReportName] VARCHAR(100) NULL,
    [ReportPath] VARCHAR(200) NULL,
    [ReportGroupName] VARCHAR(50) NULL,
    [ReportMenuName] VARCHAR(50) NULL,
    [ReportMenuGroup] VARCHAR(3) NULL,
    [Software] VARCHAR(20) NULL,
    [Entry_date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angelclient1
-- --------------------------------------------------
CREATE TABLE [dbo].[angelclient1]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(100) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(50) NULL,
    [L_Address2] VARCHAR(50) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(50) NULL,
    [Email] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] NUMERIC(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Ac_Type] VARCHAR(10) NULL,
    [Ac_Num] VARCHAR(30) NULL,
    [PrintF] VARCHAR(2) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] NUMERIC(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] VARCHAR(50) NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [Mobilevalidatedby] VARCHAR(20) NULL,
    [MobilevalidatedOn] DATETIME NULL,
    [pan_gir_no] VARCHAR(25) NULL,
    [trader] VARCHAR(20) NOT NULL,
    [Ward_No] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Area] VARCHAR(10) NULL,
    [PerDay] MONEY NULL,
    [TradeDays] INT NULL,
    [ActiveFrom] DATETIME NULL,
    [InActiveFrom] DATETIME NULL,
    [ActiveFromEq] DATETIME NULL,
    [InactiveFromEq] DATETIME NULL,
    [ActiveFromComm] DATETIME NULL,
    [InactiveFromComm] DATETIME NULL,
    [CTActiveFrom] DATETIME NULL,
    [CTInactiveFrom] DATETIME NULL,
    [FirstTrade] DATETIME NULL,
    [LastTrade] DATETIME NULL,
    [FirstTradeComm] DATETIME NULL,
    [LastTradeComm] DATETIME NULL,
    [Clrating] VARCHAR(10) NULL,
    [AngelClRating] CHAR(10) NULL,
    [YearBrok] MONEY NULL,
    [Trend] CHAR(10) NULL,
    [RmDealer] VARCHAR(20) NULL,
    [CommDealer1] VARCHAR(20) NULL,
    [Commdealer2] VARCHAR(20) NULL,
    [Service] VARCHAR(10) NULL,
    [LastCommunication] DATETIME NULL,
    [ECN] VARCHAR(10) NULL,
    [B2C] CHAR(1) NULL,
    [FirstLedger] MONEY NULL,
    [FirstLedgerDate] DATETIME NULL,
    [EbrokingClient] CHAR(1) NULL,
    [NbFcClient] CHAR(1) NULL,
    [NbFcActivefrom] DATETIME NULL,
    [NbFcInactiveFrom] DATETIME NULL,
    [EbrokingTerminal] VARCHAR(20) NULL,
    [PastClient] VARCHAR(10) NULL,
    [ClientFlag] CHAR(1) NULL,
    [BlockSms] CHAR(1) NULL,
    [PureRisk] MONEY NOT NULL,
    [ProjectedRisk] MONEY NOT NULL,
    [PanInactiveFrom] DATETIME NULL,
    [BOBranch] VARCHAR(10) NULL,
    [Birthdate] DATETIME NULL,
    [Gender] VARCHAR(2) NULL,
    [TradingPlatform] VARCHAR(10) NULL,
    [ActiveFromCurr] DATETIME NULL,
    [InactiveFromCurr] DATETIME NULL,
    [FirstTradeCurr] DATETIME NULL,
    [LastTradeCurr] DATETIME NULL,
    [CurrencyDealer] VARCHAR(20) NULL,
    [ActiveFromMcxNcx] DATETIME NULL,
    [InActiveFromMcxNcx] DATETIME NULL,
    [FirstTradeMcxNcx] DATETIME NULL,
    [LastTradeMcxNcx] DATETIME NULL,
    [DPIDs] VARCHAR(200) NULL,
    [DPIDWithPOA] VARCHAR(100) NULL,
    [DPIDForPayout] VARCHAR(100) NULL,
    [IsActiveForEbrokingProduct] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AngelUsers
-- --------------------------------------------------
CREATE TABLE [dbo].[AngelUsers]
(
    [AngelUsersID] BIGINT IDENTITY(1,1) NOT NULL,
    [BOUserFirstName] VARCHAR(50) NULL,
    [BOUserLastName] VARCHAR(50) NULL,
    [BOUserName] VARCHAR(50) NULL,
    [HarmonyEmployeeCode] VARCHAR(30) NULL,
    [BOUserPassword] VARCHAR(50) NULL,
    [BOStatusId] VARCHAR(50) NULL,
    [BOStatusName] VARCHAR(50) NULL,
    [FldUserId] INT NULL,
    [Branch_Cd] VARCHAR(20) NULL,
    [UserLevel] VARCHAR(10) NULL,
    [UserLevel1] VARCHAR(15) NULL,
    [Region] VARCHAR(20) NULL,
    [Area] VARCHAR(20) NULL,
    [BOCategory] VARCHAR(20) NULL,
    [Software] VARCHAR(20) NULL,
    [MimansaStatusid] VARCHAR(20) NULL,
    [MimansaStatusName] VARCHAR(20) NULL,
    [User_Code] VARCHAR(10) NULL,
    [UserStatusID] VARCHAR(50) NULL,
    [UserStatusName] VARCHAR(50) NULL,
    [UserCreationDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_AngelHarmony_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_AngelHarmony_bak]
(
    [Emp_No] VARCHAR(20) NULL,
    [Sb_Tag] VARCHAR(15) NULL,
    [First_Name] VARCHAR(50) NULL,
    [Middle_Name] VARCHAR(50) NULL,
    [Last_Name] VARCHAR(50) NULL,
    [Emp_Name] VARCHAR(150) NULL,
    [Address1] VARCHAR(1000) NULL,
    [Address2] VARCHAR(1000) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Pincode] VARCHAR(20) NULL,
    [MobileNumber] VARCHAR(30) NULL,
    [EmailAdd] VARCHAR(50) NULL,
    [JoiningDate] DATETIME NULL,
    [Status] VARCHAR(1) NULL,
    [CTC] MONEY NULL,
    [Emp_pass] VARCHAR(25) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Landline_no] VARCHAR(30) NULL,
    [isAdmin] BIT NULL,
    [isDealer] BIT NULL,
    [isTurnover] BIT NULL,
    [isBrokerage] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_AngelHarmonyLog
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_AngelHarmonyLog]
(
    [Emp_No] VARCHAR(20) NULL,
    [Sb_Tag] VARCHAR(15) NULL,
    [First_Name] VARCHAR(50) NULL,
    [Middle_Name] VARCHAR(50) NULL,
    [Last_Name] VARCHAR(50) NULL,
    [Emp_Name] VARCHAR(150) NULL,
    [Address1] VARCHAR(1000) NULL,
    [Address2] VARCHAR(1000) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Pincode] VARCHAR(20) NULL,
    [MobileNumber] VARCHAR(30) NULL,
    [EmailAdd] VARCHAR(50) NULL,
    [JoiningDate] DATETIME NULL,
    [Status] VARCHAR(1) NULL,
    [CTC] MONEY NULL,
    [Emp_pass] VARCHAR(25) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Landline_no] VARCHAR(20) NULL,
    [isAdmin] BIT NULL,
    [isDealer] BIT NULL,
    [isTurnover] BIT NULL,
    [isBrokerage] BIT NULL,
    [updatingdatetime] DATETIME NOT NULL,
    [remark] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_Bulk_DealerMapping
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_Bulk_DealerMapping]
(
    [Party_Code] VARCHAR(20) NULL,
    [Dealer1] VARCHAR(20) NULL,
    [Dealer2] VARCHAR(20) NULL,
    [ProcessId] VARCHAR(50) NULL,
    [Segment_Type] VARCHAR(20) NULL,
    [UserCode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_Bulk_DealerMapping_YPTest
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_Bulk_DealerMapping_YPTest]
(
    [Party_Code] VARCHAR(20) NULL,
    [Dealer1] VARCHAR(20) NULL,
    [Dealer2] VARCHAR(20) NULL,
    [ProcessId] VARCHAR(50) NULL,
    [Segment_Type] VARCHAR(20) NULL,
    [UserCode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_CommonPartyServices
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_CommonPartyServices]
(
    [ServiceID] BIGINT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(20) NOT NULL,
    [Emp_No] VARCHAR(20) NOT NULL,
    [FromDate] SMALLDATETIME NOT NULL,
    [ToDate] SMALLDATETIME NOT NULL,
    [EntryDate] SMALLDATETIME NOT NULL,
    [Valid] CHAR(1) NOT NULL,
    [CommRank] INT NOT NULL,
    [Remarks] VARCHAR(5000) NOT NULL,
    [Branch_cd] VARCHAR(10) NOT NULL,
    [DealerBranch] VARCHAR(10) NOT NULL,
    [Segment_Type] VARCHAR(20) NULL,
    [parentSb] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_CommonPartyServices_bkp_23Sep2021
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_CommonPartyServices_bkp_23Sep2021]
(
    [ServiceID] BIGINT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(20) NOT NULL,
    [Emp_No] VARCHAR(20) NOT NULL,
    [FromDate] SMALLDATETIME NOT NULL,
    [ToDate] SMALLDATETIME NOT NULL,
    [EntryDate] SMALLDATETIME NOT NULL,
    [Valid] CHAR(1) NOT NULL,
    [CommRank] INT NOT NULL,
    [Remarks] VARCHAR(5000) NOT NULL,
    [Branch_cd] VARCHAR(10) NOT NULL,
    [DealerBranch] VARCHAR(10) NOT NULL,
    [Segment_Type] VARCHAR(20) NULL,
    [parentSb] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_CommonPartyServices_bkp10Nov2021
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_CommonPartyServices_bkp10Nov2021]
(
    [ServiceID] BIGINT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(20) NOT NULL,
    [Emp_No] VARCHAR(20) NOT NULL,
    [FromDate] SMALLDATETIME NOT NULL,
    [ToDate] SMALLDATETIME NOT NULL,
    [EntryDate] SMALLDATETIME NOT NULL,
    [Valid] CHAR(1) NOT NULL,
    [CommRank] INT NOT NULL,
    [Remarks] VARCHAR(5000) NOT NULL,
    [Branch_cd] VARCHAR(10) NOT NULL,
    [DealerBranch] VARCHAR(10) NOT NULL,
    [Segment_Type] VARCHAR(20) NULL,
    [parentSb] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_CommonPartyServices_Offline
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_CommonPartyServices_Offline]
(
    [Row_Id] BIGINT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(20) NOT NULL,
    [Branch_Cd] VARCHAR(10) NOT NULL,
    [Source_Dealer_Code] VARCHAR(20) NOT NULL,
    [Target_Dealer_Code] VARCHAR(20) NOT NULL,
    [From_Date] SMALLDATETIME NOT NULL,
    [To_Date] SMALLDATETIME NOT NULL,
    [Entry_Time_Stamp] SMALLDATETIME NOT NULL,
    [To_Be_Processed] CHAR(1) NOT NULL,
    [Process_Time_Stamp] SMALLDATETIME NOT NULL,
    [Reason_For_Non_Process] VARCHAR(500) NOT NULL,
    [Other_Remarks] VARCHAR(500) NOT NULL,
    [Status_Id] VARCHAR(20) NOT NULL,
    [Status_Name] VARCHAR(20) NOT NULL,
    [Emp_No] VARCHAR(20) NOT NULL,
    [Segment_Type] VARCHAR(20) NULL,
    [CommRank] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_CommonPartyServices_Offline_YPTest
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_CommonPartyServices_Offline_YPTest]
(
    [Row_Id] BIGINT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(20) NOT NULL,
    [Branch_Cd] VARCHAR(10) NOT NULL,
    [Source_Dealer_Code] VARCHAR(20) NOT NULL,
    [Target_Dealer_Code] VARCHAR(20) NOT NULL,
    [From_Date] SMALLDATETIME NOT NULL,
    [To_Date] SMALLDATETIME NOT NULL,
    [Entry_Time_Stamp] SMALLDATETIME NOT NULL,
    [To_Be_Processed] CHAR(1) NOT NULL,
    [Process_Time_Stamp] SMALLDATETIME NOT NULL,
    [Reason_For_Non_Process] VARCHAR(500) NOT NULL,
    [Other_Remarks] VARCHAR(500) NOT NULL,
    [Status_Id] VARCHAR(20) NOT NULL,
    [Status_Name] VARCHAR(20) NOT NULL,
    [Emp_No] VARCHAR(20) NOT NULL,
    [Segment_Type] VARCHAR(20) NULL,
    [CommRank] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_Harmony
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_Harmony]
(
    [SrNo] FLOAT NULL,
    [EmpCode] NVARCHAR(MAX) NULL,
    [FirstName] NVARCHAR(MAX) NULL,
    [MiddleName] NVARCHAR(MAX) NULL,
    [LastName] NVARCHAR(MAX) NULL,
    [Address1] NVARCHAR(MAX) NULL,
    [Address2] NVARCHAR(MAX) NULL,
    [City] NVARCHAR(MAX) NULL,
    [State] NVARCHAR(MAX) NULL,
    [PinCode] NVARCHAR(MAX) NULL,
    [DateofBirth] DATETIME NULL,
    [Mobile] NVARCHAR(MAX) NULL,
    [Email] NVARCHAR(MAX) NULL,
    [SBTag] NVARCHAR(MAX) NULL,
    [Category] NVARCHAR(MAX) NULL,
    [ActiveFrom] DATETIME NULL,
    [InActiveFrom] DATETIME NULL,
    [status] NVARCHAR(MAX) NULL,
    [SuspensionActiveFrom] DATETIME NULL,
    [TerminationFrom] DATETIME NULL,
    [Salary] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2B_tbl_ExchangeMapping
-- --------------------------------------------------
CREATE TABLE [dbo].[B2B_tbl_ExchangeMapping]
(
    [Segment_Type] VARCHAR(20) NOT NULL,
    [ExchangeSegment] VARCHAR(5) NOT NULL,
    [FromDate] SMALLDATETIME NOT NULL,
    [ToDate] SMALLDATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.B2bcrms_tracetimeoutissue
-- --------------------------------------------------
CREATE TABLE [dbo].[B2bcrms_tracetimeoutissue]
(
    [autoid] BIGINT IDENTITY(1,1) NOT NULL,
    [UserEmp_No] VARCHAR(20) NULL,
    [UserStatusId] VARCHAR(20) NULL,
    [Statusname] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Dealer] VARCHAR(20) NULL,
    [dateinput] VARCHAR(11) NULL,
    [remark] VARCHAR(100) NULL,
    [updatingdatetime] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.b2bCrmslogMailerTable
-- --------------------------------------------------
CREATE TABLE [dbo].[b2bCrmslogMailerTable]
(
    [usercode] VARCHAR(20) NULL,
    [loginid] VARCHAR(20) NULL,
    [emprole] VARCHAR(20) NULL,
    [logdatetime] DATETIME NULL,
    [logtype] VARCHAR(500) NULL,
    [description] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.backup_Emp_master
-- --------------------------------------------------
CREATE TABLE [dbo].[backup_Emp_master]
(
    [Emp_No] VARCHAR(15) NOT NULL,
    [Sb_Tag] VARCHAR(15) NULL,
    [First_Name] VARCHAR(50) NULL,
    [Middle_Name] VARCHAR(50) NULL,
    [Last_Name] VARCHAR(50) NULL,
    [Emp_Name] VARCHAR(150) NULL,
    [Address1] VARCHAR(1000) NULL,
    [Address2] VARCHAR(1000) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Pincode] VARCHAR(20) NULL,
    [Mobile] VARCHAR(20) NULL,
    [Email] VARCHAR(50) NULL,
    [Dt_ActiveFrom] DATETIME NULL,
    [isSuspended] BIT NULL,
    [isTerminated] BIT NULL,
    [Salary] DECIMAL(18, 0) NULL,
    [User_ID] VARCHAR(25) NULL,
    [Password] VARCHAR(25) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [LandLine] VARCHAR(15) NULL,
    [isAdmin] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BrokTurnOvermodified
-- --------------------------------------------------
CREATE TABLE [dbo].[BrokTurnOvermodified]
(
    [Party_Code] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(20) NULL,
    [Emp_No] VARCHAR(20) NULL,
    [TotalTurnOver] MONEY NULL,
    [Online_TurnOver] MONEY NULL,
    [Offline_TurnOver] MONEY NULL,
    [GrossRevenue] MONEY NULL,
    [GrossRevenue_Online] MONEY NULL,
    [GrossRevenue_Offline] MONEY NULL,
    [NetRevenue] MONEY NULL,
    [NetRevenue_Online] MONEY NULL,
    [NetRevenue_Offline] MONEY NULL,
    [Sauda_date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BrokTurnOveroriginal
-- --------------------------------------------------
CREATE TABLE [dbo].[BrokTurnOveroriginal]
(
    [Party_Code] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(20) NULL,
    [Emp_No] VARCHAR(20) NULL,
    [TotalTurnOver] MONEY NULL,
    [Online_TurnOver] MONEY NULL,
    [Offline_TurnOver] MONEY NULL,
    [GrossRevenue] MONEY NULL,
    [GrossRevenue_Online] MONEY NULL,
    [GrossRevenue_Offline] MONEY NULL,
    [NetRevenue] MONEY NULL,
    [NetRevenue_Online] MONEY NULL,
    [NetRevenue_Offline] MONEY NULL,
    [Sauda_date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Err_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Err_Log]
(
    [Err_url] VARCHAR(100) NULL,
    [Err_stkTrace] VARCHAR(8000) NULL,
    [Err_line] VARCHAR(20) NULL,
    [Err_date] VARCHAR(50) NULL,
    [Err_App] VARCHAR(50) NULL,
    [Dev_name] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.holding_valuation
-- --------------------------------------------------
CREATE TABLE [dbo].[holding_valuation]
(
    [party_code] VARCHAR(20) NOT NULL,
    [TotalHold] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_valuation
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_valuation]
(
    [party_code] VARCHAR(50) NULL,
    [TotalLedger] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.log_Capability_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[log_Capability_Master]
(
    [pid_tbl_Capability_mst] INT NOT NULL,
    [Capability_Desc] VARCHAR(50) NULL,
    [User_Id] VARCHAR(20) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Capability_Name] VARCHAR(50) NULL,
    [Log_UpdationDate] DATETIME NULL,
    [isDefaultselected] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.log_dealer_status
-- --------------------------------------------------
CREATE TABLE [dbo].[log_dealer_status]
(
    [sr_no] BIGINT IDENTITY(1,1) NOT NULL,
    [dealer] VARCHAR(20) NULL,
    [response] INT NULL,
    [updatingdatetime] DATETIME NULL,
    [count] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.log_Emp_Capability
-- --------------------------------------------------
CREATE TABLE [dbo].[log_Emp_Capability]
(
    [pid_tbl_Emp_Capability] INT NULL,
    [Emp_No] VARCHAR(15) NULL,
    [Fkid_tbl_Capability_mst] INT NULL,
    [User_Id] VARCHAR(15) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Log_UpdationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.log_Emp_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[log_Emp_Master]
(
    [Emp_No] VARCHAR(15) NOT NULL,
    [Sb_Tag] VARCHAR(15) NULL,
    [First_Name] VARCHAR(50) NULL,
    [Middle_Name] VARCHAR(50) NULL,
    [Last_Name] VARCHAR(50) NULL,
    [Emp_Name] VARCHAR(150) NULL,
    [Address1] VARCHAR(500) NULL,
    [Address2] VARCHAR(500) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Pincode] VARCHAR(20) NULL,
    [Mobile] VARCHAR(20) NULL,
    [Email] VARCHAR(50) NULL,
    [Dt_ActiveFrom] DATETIME NULL,
    [isSuspended] BIT NULL,
    [isTerminated] BIT NULL,
    [Salary] DECIMAL(18, 0) NULL,
    [User_ID] VARCHAR(25) NULL,
    [Password] VARCHAR(50) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Log_UpdationDate] DATETIME NULL,
    [LandLine] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.log_Emp_Role
-- --------------------------------------------------
CREATE TABLE [dbo].[log_Emp_Role]
(
    [pid_tbl_Emp_Role] INT NULL,
    [Emp_No] VARCHAR(15) NULL,
    [Fkid_tbl_Role_mst] INT NULL,
    [User_Id] VARCHAR(15) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Role_Name] VARCHAR(50) NULL,
    [Log_UpdationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.log_Emp_Salary_Increment
-- --------------------------------------------------
CREATE TABLE [dbo].[log_Emp_Salary_Increment]
(
    [pid_tbl_Emp_Salary_Increment] INT IDENTITY(1,1) NOT NULL,
    [Emp_No] VARCHAR(15) NULL,
    [Old_Salary] DECIMAL(18, 2) NULL,
    [New_Salary] DECIMAL(18, 2) NULL,
    [Dt_Effective] DATETIME NULL,
    [User_Id] VARCHAR(15) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] NVARCHAR(50) NULL,
    [Created_date] DATETIME NULL,
    [Log_UpdationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.log_Emp_Suspension_Termination
-- --------------------------------------------------
CREATE TABLE [dbo].[log_Emp_Suspension_Termination]
(
    [pid_tbl_Emp_Suspension_Termination] INT NULL,
    [sb_tag] VARCHAR(20) NULL,
    [Emp_no] VARCHAR(25) NULL,
    [isClientMaped] BIT NULL,
    [Suspension_Date] DATETIME NULL,
    [SuspendedBy] VARCHAR(25) NULL,
    [SuspensionEntry_Date] DATETIME NULL,
    [isSuspended] BIT NULL DEFAULT ((0)),
    [Termination_Date] DATETIME NULL,
    [TerminatedBy] VARCHAR(25) NULL,
    [TerminationEntry_Date] DATETIME NULL,
    [isTerminated] BIT NULL DEFAULT ((0)),
    [Log_Updation_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.log_Role_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[log_Role_Master]
(
    [pid_tbl_Role_mst] INT NOT NULL,
    [Role_Desc] VARCHAR(50) NULL,
    [User_Id] VARCHAR(20) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Role_Name] VARCHAR(50) NULL,
    [Log_UpdationDate] DATETIME NULL,
    [isDefaultselected] BIT NULL,
    [ApplyRule_ClientMaping_Suspension] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.m#MIStable
-- --------------------------------------------------
CREATE TABLE [dbo].[m#MIStable]
(
    [Branch_cd] VARCHAR(10) NOT NULL,
    [Emp_No] VARCHAR(20) NOT NULL,
    [TotalClientsStartOfmonth] INT NOT NULL,
    [TotalClientsAsonDate] INT NOT NULL,
    [Tradedclients] INT NOT NULL,
    [ClientNotTradedForMonth] INT NOT NULL,
    [ClientNotTradedAsOnDate] INT NOT NULL,
    [AvgTradedclients] INT NOT NULL,
    [OnlineBrok] INT NOT NULL,
    [OfflineBrok] INT NOT NULL,
    [Brokerage] INT NOT NULL,
    [DailyTradedClients] INT NOT NULL,
    [AvgDailyActRatio] VARCHAR(4) NOT NULL,
    [AvgRevPerClient] INT NOT NULL,
    [ActivationRatio] VARCHAR(4) NOT NULL,
    [Productivity] VARCHAR(2) NOT NULL,
    [OnlineTurnover] INT NOT NULL,
    [OfflineTurnover] INT NOT NULL,
    [Turnover] INT NOT NULL,
    [OnlineNetRevnue] INT NOT NULL,
    [OfflineNetRevnue] INT NOT NULL,
    [NetRevnue] INT NOT NULL,
    [DailyTradeDays] INT NOT NULL,
    [DailyTradedClients_AR] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MimansaApplications
-- --------------------------------------------------
CREATE TABLE [dbo].[MimansaApplications]
(
    [ApplicationId] BIGINT IDENTITY(1,1) NOT NULL,
    [ApplicationName] VARCHAR(50) NULL,
    [ApplicationDescription] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MimansaModules
-- --------------------------------------------------
CREATE TABLE [dbo].[MimansaModules]
(
    [ModuleId] BIGINT IDENTITY(1,1) NOT NULL,
    [ApplicationId] BIGINT NULL,
    [ModuleName] VARCHAR(50) NULL,
    [ModuleDescription] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MimansaReports
-- --------------------------------------------------
CREATE TABLE [dbo].[MimansaReports]
(
    [ReportId] BIGINT IDENTITY(1,1) NOT NULL,
    [ApplicationId] BIGINT NULL,
    [ModuleId] BIGINT NULL,
    [ReportName] VARCHAR(50) NULL,
    [ReportPath] VARCHAR(100) NULL,
    [ReportDescription] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OldNewPassword
-- --------------------------------------------------
CREATE TABLE [dbo].[OldNewPassword]
(
    [UserID] VARCHAR(50) NULL,
    [OldPassword] VARCHAR(50) NULL,
    [NewPassword] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PartydetailsBBG
-- --------------------------------------------------
CREATE TABLE [dbo].[PartydetailsBBG]
(
    [Party_Code] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(20) NULL,
    [Emp_No] VARCHAR(20) NULL,
    [FromDate] SMALLDATETIME NULL,
    [ToDate] SMALLDATETIME NULL,
    [EbrokingClient] CHAR(1) NULL,
    [AngelClRating] VARCHAR(10) NULL,
    [Margin] MONEY NULL,
    [FirstTrade] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.processlogtemp
-- --------------------------------------------------
CREATE TABLE [dbo].[processlogtemp]
(
    [Process] VARCHAR(50) NULL,
    [Lastup] DATETIME NULL,
    [CurrentOn] VARCHAR(50) NULL,
    [Dummy1] VARCHAR(50) NULL,
    [Dummy2] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sqlmapoutput
-- --------------------------------------------------
CREATE TABLE [dbo].[sqlmapoutput]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [data] NVARCHAR(4000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TABLE_DATE
-- --------------------------------------------------
CREATE TABLE [dbo].[TABLE_DATE]
(
    [DATE_ID] INT NOT NULL,
    [DATE] DATETIME NOT NULL,
    [NEXT_DAY_DATE] DATETIME NOT NULL,
    [YEAR] SMALLINT NOT NULL,
    [YEAR_QUARTER] INT NOT NULL,
    [YEAR_MONTH] INT NOT NULL,
    [YEAR_DAY_OF_YEAR] INT NOT NULL,
    [QUARTER] TINYINT NOT NULL,
    [MONTH] TINYINT NOT NULL,
    [DAY_OF_YEAR] SMALLINT NOT NULL,
    [DAY_OF_MONTH] SMALLINT NOT NULL,
    [DAY_OF_WEEK] TINYINT NOT NULL,
    [YEAR_NAME] VARCHAR(4) NOT NULL,
    [YEAR_QUARTER_NAME] VARCHAR(7) NOT NULL,
    [YEAR_MONTH_NAME] VARCHAR(8) NOT NULL,
    [YEAR_MONTH_NAME_LONG] VARCHAR(14) NOT NULL,
    [QUARTER_NAME] VARCHAR(2) NOT NULL,
    [MONTH_NAME] VARCHAR(3) NOT NULL,
    [MONTH_NAME_LONG] VARCHAR(9) NOT NULL,
    [WEEKDAY_NAME] VARCHAR(3) NOT NULL,
    [WEEKDAY_NAME_LONG] VARCHAR(9) NOT NULL,
    [START_OF_YEAR_DATE] DATETIME NOT NULL,
    [END_OF_YEAR_DATE] DATETIME NOT NULL,
    [START_OF_QUARTER_DATE] DATETIME NOT NULL,
    [END_OF_QUARTER_DATE] DATETIME NOT NULL,
    [START_OF_MONTH_DATE] DATETIME NOT NULL,
    [END_OF_MONTH_DATE] DATETIME NOT NULL,
    [START_OF_WEEK_STARTING_SUN_DATE] DATETIME NOT NULL,
    [END_OF_WEEK_STARTING_SUN_DATE] DATETIME NOT NULL,
    [START_OF_WEEK_STARTING_MON_DATE] DATETIME NOT NULL,
    [END_OF_WEEK_STARTING_MON_DATE] DATETIME NOT NULL,
    [START_OF_WEEK_STARTING_TUE_DATE] DATETIME NOT NULL,
    [END_OF_WEEK_STARTING_TUE_DATE] DATETIME NOT NULL,
    [START_OF_WEEK_STARTING_WED_DATE] DATETIME NOT NULL,
    [END_OF_WEEK_STARTING_WED_DATE] DATETIME NOT NULL,
    [START_OF_WEEK_STARTING_THU_DATE] DATETIME NOT NULL,
    [END_OF_WEEK_STARTING_THU_DATE] DATETIME NOT NULL,
    [START_OF_WEEK_STARTING_FRI_DATE] DATETIME NOT NULL,
    [END_OF_WEEK_STARTING_FRI_DATE] DATETIME NOT NULL,
    [START_OF_WEEK_STARTING_SAT_DATE] DATETIME NOT NULL,
    [END_OF_WEEK_STARTING_SAT_DATE] DATETIME NOT NULL,
    [QUARTER_SEQ_NO] INT NOT NULL,
    [MONTH_SEQ_NO] INT NOT NULL,
    [WEEK_STARTING_SUN_SEQ_NO] INT NOT NULL,
    [WEEK_STARTING_MON_SEQ_NO] INT NOT NULL,
    [WEEK_STARTING_TUE_SEQ_NO] INT NOT NULL,
    [WEEK_STARTING_WED_SEQ_NO] INT NOT NULL,
    [WEEK_STARTING_THU_SEQ_NO] INT NOT NULL,
    [WEEK_STARTING_FRI_SEQ_NO] INT NOT NULL,
    [WEEK_STARTING_SAT_SEQ_NO] INT NOT NULL,
    [JULIAN_DATE] INT NOT NULL,
    [MODIFIED_JULIAN_DATE] INT NOT NULL,
    [ISO_DATE] VARCHAR(10) NOT NULL,
    [ISO_YEAR_WEEK_NO] INT NOT NULL,
    [ISO_WEEK_NO] SMALLINT NOT NULL,
    [ISO_DAY_OF_WEEK] TINYINT NOT NULL,
    [ISO_YEAR_WEEK_NAME] VARCHAR(8) NOT NULL,
    [ISO_YEAR_WEEK_DAY_OF_WEEK_NAME] VARCHAR(10) NOT NULL,
    [DATE_FORMAT_YYYY_MM_DD] VARCHAR(10) NOT NULL,
    [DATE_FORMAT_YYYY_M_D] VARCHAR(10) NOT NULL,
    [DATE_FORMAT_MM_DD_YYYY] VARCHAR(10) NOT NULL,
    [DATE_FORMAT_M_D_YYYY] VARCHAR(10) NOT NULL,
    [DATE_FORMAT_MMM_D_YYYY] VARCHAR(12) NOT NULL,
    [DATE_FORMAT_MMMMMMMMM_D_YYYY] VARCHAR(18) NOT NULL,
    [DATE_FORMAT_MM_DD_YY] VARCHAR(8) NOT NULL,
    [DATE_FORMAT_M_D_YY] VARCHAR(8) NOT NULL,
    [CMTradingDay] CHAR(1) NULL,
    [CommTradingday] CHAR(1) NULL,
    [EffSauda_date] DATETIME NULL,
    [StartOfFinDate] DATETIME NULL,
    [EndOfFinDate] DATETIME NULL,
    [FinQuarter] DATETIME NULL,
    [Sauda_date] DATETIME NULL,
    [CurrTradingDay] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AppLog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AppLog]
(
    [Logid] BIGINT IDENTITY(1,1) NOT NULL,
    [UserCode] VARCHAR(50) NULL,
    [LogType] VARCHAR(50) NULL,
    [SessionId] VARCHAR(60) NULL,
    [URL] VARCHAR(500) NULL,
    [IP] VARCHAR(50) NULL,
    [Description] VARCHAR(8000) NULL,
    [LogDateTime] DATETIME NULL,
    [Emp_no] VARCHAR(20) NULL,
    [EmpSessionId] VARCHAR(60) NULL,
    [EmpRole] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_B2B_CRMS_SelfCertification_DSC
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_B2B_CRMS_SelfCertification_DSC]
(
    [Sub_Broker] VARCHAR(50) NULL,
    [IsConfirmed] CHAR(1) NULL,
    [ConfirmedOn] DATETIME NULL,
    [ConfirmedBy] VARCHAR(50) NULL,
    [IP_Address] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_B2B_CRMS_SelfCertification_DSC_List
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_B2B_CRMS_SelfCertification_DSC_List]
(
    [Client_Full_name] VARCHAR(500) NULL,
    [SBTag] VARCHAR(100) NULL,
    [AddedBy] VARCHAR(100) NULL,
    [AddedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_B2B_CRMS_SMS_DEALER_MAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_B2B_CRMS_SMS_DEALER_MAPPING]
(
    [auto_id] BIGINT IDENTITY(1,1) NOT NULL,
    [party_code] VARCHAR(30) NULL,
    [party_mobile] VARCHAR(20) NULL,
    [sub_broker] VARCHAR(20) NULL,
    [sub_broker_name] VARCHAR(100) NULL,
    [DealerCode] VARCHAR(30) NULL,
    [DealerName] VARCHAR(100) NULL,
    [DealerContact] VARCHAR(50) NULL,
    [entry_date] DATETIME NULL DEFAULT (getdate()),
    [smsflag] VARCHAR(50) NULL DEFAULT '0',
    [updatingdatetime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_B2B_CRMS_SMS_DEALER_MAPPING_YPTest
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_B2B_CRMS_SMS_DEALER_MAPPING_YPTest]
(
    [auto_id] BIGINT IDENTITY(1,1) NOT NULL,
    [party_code] VARCHAR(30) NULL,
    [party_mobile] VARCHAR(20) NULL,
    [sub_broker] VARCHAR(20) NULL,
    [sub_broker_name] VARCHAR(100) NULL,
    [DealerCode] VARCHAR(30) NULL,
    [DealerName] VARCHAR(100) NULL,
    [DealerContact] VARCHAR(50) NULL,
    [entry_date] DATETIME NULL,
    [smsflag] VARCHAR(50) NULL,
    [updatingdatetime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_BIMenu
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_BIMenu]
(
    [MenuID] BIGINT IDENTITY(1,1) NOT NULL,
    [Text] VARCHAR(100) NULL,
    [Value] VARCHAR(200) NULL,
    [NavigateUrl] VARCHAR(MAX) NULL,
    [ParentID] BIGINT NULL,
    [Tooltip] VARCHAR(200) NULL,
    [RelationName] VARCHAR(100) NULL,
    [MenuType] VARCHAR(20) NULL,
    [ApplicationID] BIGINT NULL,
    [ParentMenuApplicationID] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Capability_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Capability_Master]
(
    [pid_tbl_Capability_mst] INT NOT NULL,
    [Capability_Desc] VARCHAR(50) NULL,
    [User_Id] VARCHAR(20) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Capability_Name] VARCHAR(50) NULL,
    [IsDefaultSelected] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Client_ProfileSubProfile
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Client_ProfileSubProfile]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Profile] VARCHAR(15) NULL,
    [Sub_Profile] VARCHAR(30) NULL,
    [LastUpdate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CRMSRandomPassword
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CRMSRandomPassword]
(
    [Id] INT NULL,
    [Pass] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_Capability
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_Capability]
(
    [pid_tbl_Emp_Capability] INT IDENTITY(1,1) NOT NULL,
    [Emp_No] VARCHAR(15) NOT NULL,
    [Fkid_tbl_Capability_mst] INT NOT NULL,
    [User_Id] VARCHAR(15) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_Login
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_Login]
(
    [Emp_No] VARCHAR(15) NULL,
    [Dt_LoginTime] DATETIME NULL,
    [IP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_Master]
(
    [Emp_No] VARCHAR(15) NOT NULL,
    [Sb_Tag] VARCHAR(15) NULL,
    [First_Name] VARCHAR(50) NULL,
    [Middle_Name] VARCHAR(50) NULL,
    [Last_Name] VARCHAR(50) NULL,
    [Emp_Name] VARCHAR(150) NULL,
    [Address1] VARCHAR(1000) NULL,
    [Address2] VARCHAR(1000) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Pincode] VARCHAR(20) NULL,
    [Mobile] VARCHAR(50) NULL,
    [Email] VARCHAR(100) NULL,
    [Dt_ActiveFrom] DATETIME NULL,
    [isSuspended] BIT NULL DEFAULT ((0)),
    [isTerminated] BIT NULL DEFAULT ((0)),
    [Salary] DECIMAL(18, 0) NULL,
    [User_ID] VARCHAR(25) NULL,
    [Password] VARCHAR(50) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [LandLine] VARCHAR(50) NULL,
    [isAdmin] BIT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_Role
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_Role]
(
    [pid_tbl_Emp_Role] INT IDENTITY(1,1) NOT NULL,
    [Emp_No] VARCHAR(15) NOT NULL,
    [Fkid_tbl_Role_mst] INT NOT NULL,
    [User_Id] VARCHAR(15) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Role_Name] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_Salary_Increment
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_Salary_Increment]
(
    [pid_tbl_Emp_Salary_Increment] INT IDENTITY(1,1) NOT NULL,
    [Emp_No] VARCHAR(15) NULL,
    [Old_Salary] DECIMAL(18, 0) NULL,
    [New_Salary] DECIMAL(18, 0) NULL,
    [Dt_Effective] DATETIME NULL,
    [User_Id] VARCHAR(15) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] NVARCHAR(50) NULL,
    [Created_date] DATETIME NULL,
    [Dt_NewSalaryEffect] DATETIME NULL,
    [isNewSalaryEffected] BIT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_Salary_Increment_Dashboard
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_Salary_Increment_Dashboard]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [Emp_No] VARCHAR(50) NULL,
    [LastSalary] DECIMAL(18, 2) NULL,
    [Year] VARCHAR(10) NULL,
    [Month] VARCHAR(10) NULL,
    [Log_Updation_Date] DATETIME NULL DEFAULT (getdate()),
    [MaxDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_Suspension_Termination
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_Suspension_Termination]
(
    [pid_tbl_Emp_Suspension_Termination] INT IDENTITY(1,1) NOT NULL,
    [sb_tag] VARCHAR(20) NULL,
    [Emp_no] VARCHAR(25) NULL,
    [isClientMaped] BIT NULL,
    [Suspension_Date] DATETIME NULL,
    [SuspendedBy] VARCHAR(25) NULL,
    [SuspensionEntry_Date] DATETIME NULL,
    [isSuspended] BIT NULL,
    [Termination_Date] DATETIME NULL,
    [TerminatedBy] VARCHAR(25) NULL,
    [TerminationEntry_Date] DATETIME NULL,
    [isTerminated] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_Suspension_Termination_bkp23Sep2020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_Suspension_Termination_bkp23Sep2020]
(
    [pid_tbl_Emp_Suspension_Termination] INT IDENTITY(1,1) NOT NULL,
    [sb_tag] VARCHAR(20) NULL,
    [Emp_no] VARCHAR(25) NULL,
    [isClientMaped] BIT NULL,
    [Suspension_Date] DATETIME NULL,
    [SuspendedBy] VARCHAR(25) NULL,
    [SuspensionEntry_Date] DATETIME NULL,
    [isSuspended] BIT NULL,
    [Termination_Date] DATETIME NULL,
    [TerminatedBy] VARCHAR(25) NULL,
    [TerminationEntry_Date] DATETIME NULL,
    [isTerminated] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EmpLoyee_ClientMaping
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EmpLoyee_ClientMaping]
(
    [pid_tbl_EmpLoyee_ClientMaping] INT NOT NULL,
    [sb_tag] VARCHAR(20) NULL,
    [Emp_no] VARCHAR(25) NULL,
    [isClientMaped] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EmployeeView
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EmployeeView]
(
    [pid] INT IDENTITY(1,1) NOT NULL,
    [sb_tag] VARCHAR(20) NULL,
    [emp_no] VARCHAR(20) NULL,
    [IsDealer] BIT NULL DEFAULT ((0)),
    [isTurnOver] BIT NULL DEFAULT ((0)),
    [isBrokerage] BIT NULL DEFAULT ((0)),
    [UpdationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MailMessage_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MailMessage_Master]
(
    [pid] INT IDENTITY(1,1) NOT NULL,
    [MM_Id] INT NOT NULL,
    [MM_Name] VARCHAR(50) NULL,
    [MM_Desc] VARCHAR(500) NULL,
    [MessageContent] VARCHAR(5000) NULL,
    [MailSubject] VARCHAR(MAX) NULL,
    [MailTemplate] VARCHAR(MAX) NULL,
    [MailTo] VARCHAR(MAX) NULL,
    [MailCc] VARCHAR(MAX) NULL,
    [MailBcc] VARCHAR(MAX) NULL,
    [MailFrequency] VARCHAR(50) NULL,
    [isAutoMail] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_menu_master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_menu_master]
(
    [MenuID] INT NULL,
    [Text] VARCHAR(100) NULL,
    [ParentID] INT NULL,
    [Description] VARCHAR(5000) NULL,
    [URL] VARCHAR(MAX) NULL,
    [M_order] INT NULL,
    [URL_Internet] VARCHAR(MAX) NULL,
    [URL_Intranet] VARCHAR(MAX) NULL,
    [IsAdmin] INT NULL,
    [Create_Date] DATETIME NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [No_of_hits] INT NULL,
    [Search_tags] VARCHAR(MAX) NULL,
    [Image_URL] VARCHAR(1000) NULL,
    [flg_Capture_hits] INT NULL,
    [IsChild] INT NULL,
    [Is_delete] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Role_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Role_Master]
(
    [pid_tbl_Role_mst] INT NOT NULL,
    [Role_Desc] VARCHAR(50) NULL,
    [User_Id] VARCHAR(20) NULL,
    [Dt_Updation] DATETIME NULL,
    [IP] VARCHAR(20) NULL,
    [Created_date] DATETIME NULL,
    [Role_Name] VARCHAR(50) NULL,
    [ApplyRule_ClientMaping_Suspension] BIT NULL,
    [IsDefaultSelected] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SbContact_Detail
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SbContact_Detail]
(
    [pid] INT IDENTITY(1,1) NOT NULL,
    [Sb_Tag] VARCHAR(20) NULL,
    [Landline_No] VARCHAR(30) NULL,
    [Mobile_No] VARCHAR(20) NULL,
    [Email_Add] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Temp_UserIdEmail
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Temp_UserIdEmail]
(
    [SubBroker] NVARCHAR(255) NULL,
    [UserId] NVARCHAR(255) NULL,
    [EmailID] NVARCHAR(255) NULL,
    [id] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Temp_UserIdEmail_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Temp_UserIdEmail_log]
(
    [SubBroker] NVARCHAR(255) NULL,
    [UserId] NVARCHAR(255) NULL,
    [EmailID] NVARCHAR(255) NULL,
    [id] BIGINT NULL,
    [UploadDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UserLoginDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UserLoginDetails]
(
    [pid_tbl_UserLoginDetails] INT IDENTITY(1,1) NOT NULL,
    [emp_no] VARCHAR(10) NULL,
    [ipAdd] VARCHAR(20) NULL,
    [LoginDateTime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.B2B_AngelHarmony
-- --------------------------------------------------
  
/*            
This view is used to fetch all columns of employee_master table as well as stating employee is dealer or not and             
he has capabilities of viewing turnover , brokerage report          
          
select status --,isSuspended   ,isTerminated      
,* from B2B_AngelHarmony where isadmin=0               
*/            
        -- select  top  10 *   From  b2b_angelharmony with(nolock)   
        
CREATE view [dbo].[B2B_AngelHarmony]            
as            
            
select Mst1.Emp_No,Mst1.Sb_Tag,Mst1.First_Name,Mst1.Middle_Name,Mst1.Last_Name,Mst1.Emp_Name,Mst1.Address1          
,Mst1.Address2,Mst1.City,Mst1.State,Mst1.Pincode,cast(ltrim(rtrim(Mst1.Mobile)) as Varchar(30)) MobileNumber ,Mst1.Email EmailAdd,Mst1.Dt_ActiveFrom  JoiningDate      
--,isSuspended   ,isTerminated      
,case when isnull(Mst1.isSuspended,0)=0 and  isnull(Mst1.isTerminated,0)=0 then 'A'       
   when isnull(Mst1.isTerminated,0)=1 then 'T'       
   When isnull(Mst1.isSuspended,0)=1 then 'S'      
end [Status]         
,Mst1.Salary CTC,Mst1.Password Emp_pass,Mst1.Dt_Updation,Mst1.IP,Mst1.Created_date          
,sq1.landline_no,Mst1.isAdmin ,t1.isDealer,isTurnover,isBrokerage           
from tbl_emp_master mst1 (nolock)          
inner join tbl_EmployeeView t1 (nolock) on mst1.emp_no=t1.emp_no          
--left outer join tbl_sbcontact_detail sq1 (nolock) on           
inner join (select pid,landline_no from  tbl_sbcontact_detail t2 (nolock) union select 0,null) sq1 on           
isnull(Mst1.LandLine,0)= sq1.pid

GO

-- --------------------------------------------------
-- VIEW dbo.BO_Subbrokers
-- --------------------------------------------------




CREATE View BO_Subbrokers

as

/* Original Source Back-Office */

select segment,branch_code,sub_Broker,B2C,name,Contact_person,Address1,Address2,City,State,Nation,Zip,Phone1,Phone2,email

from [CSOKYC-6].general.dbo.BO_Subbrokers with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.bsecm_cli
-- --------------------------------------------------
Create View bsecm_cli 
as
select * from mis.remisior.dbo.bsecm_cli with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.client_Details
-- --------------------------------------------------
create view client_Details 
as
select top 5 region,branch_cd,
sub_Broker,
isnull(b2c,'N') as B2C,
Ori_sub_Broker, 
party_code, short_name as Party_name,
isnull(bsecm,'N') as bsecm,
isnull(nsecm,'N') as nsecm,
isnull(nsefo,'N') as nsefo,
isnull(mcdx,'N') as mcx,
isnull(ncdx,'N') as ncdex,
isnull(bsefo,'N') as bsefo,
isnull(mcd,'N') as mcd,
isnull(nsx,'N') as nsx,
isnull(nbfc_cli,'N') as nbfc, 
isnull(ebroking,'N') as ebroking
from intranet.risk.dbo.client_Details with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.client_inwardregister
-- --------------------------------------------------
CREATE View client_inwardregister    
as  
select * from ABVSKYCMIS.kyc.dbo.client_inwardregister with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.crms_online_offline
-- --------------------------------------------------
Create View crms_online_offline
as
select * from ctcl.dbo.crms_online_offline with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.Inhouse_user_IP
-- --------------------------------------------------



 CREATE view [dbo].[Inhouse_user_IP]      

  

as       

select a.*,getdate() date from [INTRANET].rolemgm.dbo.Inhouse_user_IP a

GO

-- --------------------------------------------------
-- VIEW dbo.mcd_cli
-- --------------------------------------------------
Create View mcd_cli 
as
select * from mis.remisior.dbo.mcd_cli with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.mcdx_cli
-- --------------------------------------------------
Create View mcdx_cli 
as
select * from mis.remisior.dbo.mcdx_cli with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.mis_to
-- --------------------------------------------------
Create View mis_to 
as
select * from bsedb_ab.dbo.mis_to_sb with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.ncdx_cli
-- --------------------------------------------------
Create View ncdx_cli 
as
select * from mis.remisior.dbo.ncdx_cli with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.nsecm_cli
-- --------------------------------------------------
Create View nsecm_cli 
as
select * from mis.remisior.dbo.nsecm_cli with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.nsefo_cli
-- --------------------------------------------------
Create View nsefo_cli 
as
select * from mis.remisior.dbo.nsefo_cli with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.nsx_cli
-- --------------------------------------------------
Create View nsx_cli 
as
select * from mis.remisior.dbo.nsx_cli with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.sb_broker
-- --------------------------------------------------
Create View sb_broker
as
select * from mis.sb_comp.dbo.sb_broker with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.tbl_ebrok_detail_cli
-- --------------------------------------------------
Create View tbl_ebrok_detail_cli 
as
select * from mis.remisior.dbo.tbl_ebrok_detail_cli with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.UCC_AllSebiBannedEntities
-- --------------------------------------------------
create view AllSebiBannedEntities
as
select * from testdb.dbo.AllSebiBannedEntities

GO

-- --------------------------------------------------
-- VIEW dbo.View_SBCRMS_GetSBDetails
-- --------------------------------------------------

CREATE VIEW [dbo].[View_SBCRMS_GetSBDetails]
AS
Select A.emp_no, A.sb_tag, A.Created_Date,S.MimansaStatusID as Status from dbo.b2b_angelharmony A with(nolock),
dbo.angelusers S where Status = 'A' and S.HarmonyemployeeCode=A.emp_no
order by emp_no
OFFSET 0 ROWS

GO

-- --------------------------------------------------
-- VIEW dbo.vw_ActiveNonAdmin_Employee_Master
-- --------------------------------------------------

/*
	This view is used to bypass admin employee and terminated employees
*/

CREATE view [dbo].[vw_ActiveNonAdmin_Employee_Master]
as
	select * from tbl_emp_master where isterminated=0 and isadmin=0

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_B2B_CurrentClientDealerMapping
-- --------------------------------------------------










CREATE VIEW [dbo].[Vw_B2B_CurrentClientDealerMapping]

AS



SELECT DISTINCT Party_Code, Emp_No

FROM            dbo.B2B_CommonPartyServices WITH (nolock)

WHERE			(Valid = 'Y') AND (ToDate > GETDATE())



UNION



SELECT DISTINCT AC.Party_Code, Emp_No = AC.Sub_Broker + '001'

FROM            [MIMANSA].angelcs.dbo.angelClient1 AC with(nolock) LEFT OUTER JOIN dbo.B2B_CommonPartyServices P WITH (nolock)

ON				(AC.party_code = P.Party_Code )

WHERE			P.party_code is null

and AC.B2C = 'N' And Cl_type<>'SUB'  

And ((AC.ActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 

			And AC.InActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00')

	OR (AC.BSEMFSSActiveFrom <= left(convert(varchar, getdate(), 109), 11) + ' 23:59:59' 

			And AC.BSEMFSSInActiveFrom >= left(convert(varchar, getdate(), 109), 11) + ' 00:00:00'))

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_B2B_CurrentClientDealerMapping_bkp22Apr2019
-- --------------------------------------------------

CREATE VIEW [dbo].[Vw_B2B_CurrentClientDealerMapping_bkp22Apr2019]
AS
SELECT DISTINCT Party_Code, Emp_No
FROM            dbo.B2B_CommonPartyServices WITH (nolock)
WHERE        (Valid = 'Y') AND (ToDate > GETDATE())

GO

-- --------------------------------------------------
-- VIEW dbo.vw_Employee_Master_CapabilityMapping
-- --------------------------------------------------
Create View [dbo].[vw_Employee_Master_CapabilityMapping]

as

select E.Emp_No, E.Sb_Tag,E.Emp_Name,E.Address1, E.Address2, E.City, E.State, E.Pincode, E.Mobile, E.Email,
R.Capability_Name from 
tbl_Emp_Master E 
left outer join 
tbl_Emp_Capability ER on  E.Emp_no=ER.Emp_No 
left outer join 
tbl_Capability_Master R on ER.fkid_tbl_Capability_mst=R.pid_tbl_Capability_mst

GO

-- --------------------------------------------------
-- VIEW dbo.vw_Employee_Master_RoleMapping
-- --------------------------------------------------
Create View [dbo].[vw_Employee_Master_RoleMapping]

as

select E.Emp_No, E.Sb_Tag,E.Emp_Name,E.Address1, E.Address2, E.City, E.State, E.Pincode, E.Mobile, E.Email,
R.Role_Name from 
tbl_Emp_Master E 
left outer join 
tbl_Emp_Role ER on  E.Emp_no=ER.Emp_No 
left outer join 
tbl_Role_Master R on ER.fkid_tbl_role_mst=R.pid_tbl_Role_mst

GO

-- --------------------------------------------------
-- VIEW dbo.vw_Employee_Master_Supspenseion_Termination
-- --------------------------------------------------
Create View [dbo].[vw_Employee_Master_Supspenseion_Termination]
as
select 
E.Emp_No, E.Sb_Tag,E.Emp_Name,E.Address1, E.Address2, E.City, E.State, E.Pincode, E.Mobile, E.Email,
E.Dt_ActiveFrom,Suspension_Date, SuspendedBy, SuspensionEntry_Date,Termination_Date, TerminatedBy, TerminationEntry_Date, E.Salary,E.LandLine
from tbl_Emp_Master E 
left outer join tbl_Emp_Suspension_Termination T
on E.Emp_No=T.Emp_No and E.Sb_Tag=T.Sb_Tag

GO

-- --------------------------------------------------
-- VIEW dbo.vw_isClientMapped_B2BCrms
-- --------------------------------------------------
/*
	Created by : Vikram Ukani
	Created On : 11th May 2012
	Desc : To get status of Client mapped or not  for NonAdmin Employees
	
	 select * from vw_isClientMapped_B2BCrms order by emp_no

*/


create view vw_isClientMapped_B2BCrms
as
select distinct t1.emp_no,isNull(isclientmapped,0) isclientmapped 
from tbl_emp_master t1 
left outer join 
(select emp_no,case when count(distinct party_code)>0 then 1 else 0 end isclientmapped from B2B_CommonPartyServices group by emp_no) t2
on ltrim(rtrim(t1.Emp_No))=ltrim(rtrim(t2.Emp_No)) 
where isadmin=0

GO

-- --------------------------------------------------
-- VIEW dbo.vw_ParentChildTagMapping
-- --------------------------------------------------



CREATE View [dbo].[vw_ParentChildTagMapping]  

as  

  

 select Case when isnull(parenttag,'') ='' then sbtag else parenttag  end ParentTag,sbtag sb_tag   

 from [MIS].SB_COMP.dbo.VW_SubBroker_Details with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.vw_tbl_EmployeeView
-- --------------------------------------------------
/*      
This view is used to fetch all columns of employee_master table as well as stating employee is dealer or not and       
he has capabilities of viewing turnover , brokerage report    
    
select status --,isSuspended   ,isTerminated
,* from vw_tbl_EmployeeView where isadmin=0         
*/      
      
CREATE view [dbo].[vw_tbl_EmployeeView]      
as      
      
select Mst1.Emp_No,Mst1.Sb_Tag,Mst1.First_Name,Mst1.Middle_Name,Mst1.Last_Name,Mst1.Emp_Name,Mst1.Address1    
,Mst1.Address2,Mst1.City,Mst1.State,Mst1.Pincode,Mst1.Mobile MobileNumber ,Mst1.Email EmailAdd,Mst1.Dt_ActiveFrom  JoiningDate
--,isSuspended   ,isTerminated
,case when isnull(Mst1.isSuspended,0)=0 and  isnull(Mst1.isTerminated,0)=0 then 'A' 
	  when isnull(Mst1.isTerminated,0)=1 then 'T' 
	  When isnull(Mst1.isSuspended,0)=1 then 'S'
end [Status]	  
,Mst1.Salary CTC,Mst1.Password Emp_pass,Mst1.Dt_Updation,Mst1.IP,Mst1.Created_date    
,sq1.Landline_no,Mst1.isAdmin ,t1.isDealer,isTurnover,isBrokerage     
from tbl_emp_master mst1 (nolock)    
inner join tbl_EmployeeView t1 (nolock) on mst1.emp_no=t1.emp_no    
--left outer join tbl_sbcontact_detail sq1 (nolock) on     
inner join (select pid,landline_no from  tbl_sbcontact_detail t2 (nolock) union select 0,null) sq1 on     
isnull(Mst1.LandLine,0)= sq1.pid

GO

-- --------------------------------------------------
-- VIEW dbo.VW_TECHVIEW_FUNDSPAYIN
-- --------------------------------------------------
CREATE VIEW VW_TECHVIEW_FUNDSPAYIN
AS
SELECT
sLoginId,nMarketSegmentId,sUserDefinedExchangeName,nAmount,nServiceCharge,sDateTime,nTxnRefNo,sGroupId,nProcessFlag,sBankId,sAgencyId,sBankRefNo,sFromAccNo,sToAccNo,product
FROM TESTDB.DBO.temp_mis_file1a WITH (NOLOCK)
WHERE sBankId in ('ATOMPG','TechView','TechView1')

GO

