-- DDL Export
-- Server: 10.253.33.89
-- Database: ITAssests
-- Exported: 2026-02-05T02:38:48.162511

USE ITAssests;
GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.UFunc_ToCamelCase
-- --------------------------------------------------
/************************************************* 
CREATED BY : Mahendra Bonde 23 March 2010
PURPOSE : TO CONVERT INPUT STRING IN CAMEL CASE
**************************************************/
Create FUNCTION [dbo].[UFunc_ToCamelCase]
(@Str varchar(8000))
RETURNS varchar(8000) AS
BEGIN
  DECLARE @Result varchar(2000)
  SET @Str = LOWER(@Str) + ' '
  SET @Result = ''
  WHILE 1=1
  BEGIN
    IF PATINDEX('% %',@Str) = 0 BREAK
    SET @Result = @Result + UPPER(Left(@Str,1))+
    SubString  (@Str,2,CharIndex(' ',@Str)-1)
    SET @Str = SubString(@Str,
      CharIndex(' ',@Str)+1,Len(@Str))
  END
  SET @Result = Left(@Result,Len(@Result))
  RETURN @Result
END
---------------------------------------------------
-- HOW TO USE --
-- SELECT dbo.UFunc_ToCamelCase('mAhenDra bOnDe')
-- Output: Mahendra Bonde
---------------------------------------------------

GO

-- --------------------------------------------------
-- INDEX dbo.mySampleTable
-- --------------------------------------------------
CREATE UNIQUE CLUSTERED INDEX [IX_mysamtable] ON [dbo].[mySampleTable] ([ID1])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_EmpTree_Arch
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Emp_id] ON [dbo].[tbl_EmpTree_Arch] ([Emp_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Emp
-- --------------------------------------------------
ALTER TABLE [dbo].[Emp] ADD CONSTRAINT [PK_tbl_EmpL] PRIMARY KEY ([Emp_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.emp_info
-- --------------------------------------------------
ALTER TABLE [dbo].[emp_info] ADD CONSTRAINT [PK_emp_info] PRIMARY KEY ([Emp_NO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.emp_info_Sep
-- --------------------------------------------------
ALTER TABLE [dbo].[emp_info_Sep] ADD CONSTRAINT [PK_emp_info_Sep] PRIMARY KEY ([Emp_NO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagrams__73BA3083] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_CapexMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_CapexMaster] ADD CONSTRAINT [PK_tbl_CapexMaster] PRIMARY KEY ([Capex_Code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_CapexProductMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_CapexProductMaster] ADD CONSTRAINT [PK_tbl_CapexProductMaster] PRIMARY KEY ([Product_Code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_EmpTree
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_EmpTree] ADD CONSTRAINT [PK_tbl_EmpList] PRIMARY KEY ([Emp_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_it_AngelGroupofCompaniesMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_it_AngelGroupofCompaniesMaster] ADD CONSTRAINT [PK_tbl_it_AngelGroupofCompaniesMaster] PRIMARY KEY ([CompId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_it_vendormaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_it_vendormaster] ADD CONSTRAINT [PK_tbl_it_vendormaster] PRIMARY KEY ([VendorCode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_ITAssestsRoleMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_ITAssestsRoleMaster] ADD CONSTRAINT [PK__tbl_ITAssestsRol__503BEA1C] PRIMARY KEY ([Role_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_ITUsers
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_ITUsers] ADD CONSTRAINT [PK__tbl_ITUs__262359AB6DBAA734] PRIMARY KEY ([Emp_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_JustificationMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_JustificationMaster] ADD CONSTRAINT [PK_tbl_JustificationMaster] PRIMARY KEY ([Justification_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_ProductModelMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_ProductModelMaster] ADD CONSTRAINT [PK__tbl_ProductModel__7F2BE32F] PRIMARY KEY ([Model_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_RecommanderMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_RecommanderMaster] ADD CONSTRAINT [PK__Tbl_Reco__3213E83F64984C18] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_ReviewerMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_ReviewerMaster] ADD CONSTRAINT [PK__Tbl_Revi__3213E83F0E8E85E4] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_ReviewRemarks
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_ReviewRemarks] ADD CONSTRAINT [PK__Tbl_Revi__3213E83F505C4941] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_StatusMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_StatusMaster] ADD CONSTRAINT [PK_tbl_StatusMaster] PRIMARY KEY ([Status_Code])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ConvertQueryInHTMP_PageComman
-- --------------------------------------------------
         
            
CREATE    proc [dbo].[ConvertQueryInHTMP_PageComman] (@objectname1 varchar(max),@HTMLBODY varchar(max) OUTPUT)                                    
as                                     
--Declare   @objectname1 varchar(max)            
--declare @HTMLBODY nvarchar(max)            
--set @objectname1 ='Select * from sysobjects'            
            
 set nocount on   
 
 
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
       
  IF EXISTS(SELECT 1 FROM sys.objects                                     
            
  WHERE OBJECT_ID = OBJECT_ID('DBA_TempHTML') AND type = ('U'))                                       
            
  DROP TABLE DBA_TempHTML                                    
       
  DECLARE @createtable nvarchar(max)                                    
            
  set @createtable ='select * into DBA_TempHTML  from  ( '+''+ @objectname1+')A '                              
            
  EXECUTE sp_executesql @createtable                  
      
  DECLARE @xmlquery2 nvarchar (max)                                    
            
  DECLARE @name varchar(max)                              
            
  DECLARE c1 CURSOR READ_ONLY                                    
            
  FOR  select  'Column_name'   = name  from sys.all_columns where object_id = ( select object_id  from sys.all_objects                                     
            
  where object_id = object_id('DBA_TempHTML') )                                     
            
  OPEN c1                                    
            
        DECLARE  @tempvar nvarchar(max)                                    
            
        DECLARE @NEWCOLUMN nvarchar(max)                                  
            
  SET @NEWCOLUMN=''                                
            
  set @tempvar=''                                     
            
                                    
            
   FETCH NEXT FROM c1                                    
            
   INTO @name                                    
            
                                    
            
   WHILE @@FETCH_STATUS = 0                                    
            
    BEGIN                                  
            
     SET @NEWCOLUMN =@NEWCOLUMN+'<th >'+@name +'</th>'                              
            
     set @tempvar = @tempvar+ 'cast('+@name +' as varchar(MAX) )'+'+' + '''</td><td>''' +'+'                              
            
        FETCH NEXT FROM c1                                    
            
     INTO @name                                    
            
    END                                    
            
  CLOSE c1                                    
            
  DEALLOCATE c1                                
            
  SET @tempvar=  LEFT (@tempvar, LEN(@tempvar)-13)                              
            
                                  
            
  declare @BODY nvarchar(max)                              
            
  SET @BODY=' select cast( (select td = '+@tempvar+ ' from (  SELECT top 100 percent * FROM DBA_TempHTML Order BY 1) as d '+' for xml path( ''tr'' ), type ) as varchar(max) )'                              
    
  print  @BODY                           
    
  create table #temp                              
            
  (returnstr nvarchar (max))                              
            
  insert into #temp  exec sp_executesql  @body                              
            
  declare @returnstr2 nvarchar(max)                              
            
  select @returnstr2=LTRIM(RTRIM(returnstr)) from #temp                              
      
  set @HTMLBODY = '<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >'                              
            
                + '<tr>'+''+@NEWCOLUMN+ ''+'</tr>'                  
            
             + replace( replace( @returnstr2, '&lt;', '<' ), '&gt;', '>'  )                           
            
                + '</table>'                              
            
                              
            
select  @HTMLBODY         
            
drop table #temp                              
            
drop table DBA_TempHTML

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_ConvertQueryInHTMP_Page
-- --------------------------------------------------


CREATE proc [dbo].[DBA_ConvertQueryInHTMP_Page] (@objectname1 varchar(max),@HTMLBODY varchar(max) OUTPUT) 
as  

 set nocount on 
 
 
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

  IF EXISTS(SELECT 1 FROM sys.objects WHERE OBJECT_ID = OBJECT_ID('DBA_TempHTML') AND type = ('U'))
  DROP TABLE DBA_TempHTML

  DECLARE @createtable nvarchar(max) 
  set @createtable ='select * into DBA_TempHTML  from  ( '+''+ @objectname1+')A order by 1 desc'  
  EXECUTE sp_executesql @createtable 

  DECLARE @xmlquery2 nvarchar (max) 
  DECLARE @name varchar(max)  

  DECLARE c1 CURSOR READ_ONLY 
  FOR  select 'Column_name' = name from sys.all_columns 
  where object_id = ( select object_id from sys.all_objects where object_id = object_id('DBA_TempHTML'))
  
  OPEN c1 

  DECLARE @tempvar nvarchar(max) 
  DECLARE @NEWCOLUMN nvarchar(max)   
  SET @NEWCOLUMN='' 
  set @tempvar=''  
  FETCH NEXT FROM c1 
  INTO @name 
  WHILE @@FETCH_STATUS = 0 

BEGIN   

 --SET @NEWCOLUMN =@NEWCOLUMN+'<th bgcolor="#538ED5">'+@name +'</th>'
 SET @NEWCOLUMN =@NEWCOLUMN+'<th bgcolor="#538ED5" 
 style="font-family:TREBUCHET MS;color:WHITE;font-size:14px;align=center"><b>
 '+@name +'</b></th>'
 set @tempvar = @tempvar+ 'cast('+@name +' as varchar(MAX) )'+'+' + '''</td><td>''' +'+'  
 FETCH NEXT FROM c1 
 INTO @name 

END 

  CLOSE c1 
  DEALLOCATE c1 
  
  SET @tempvar=  LEFT (@tempvar, LEN(@tempvar)-13)  
  
  declare @BODY nvarchar(max)  
  
  SET @BODY=' select cast( (select td = '+@tempvar+ ' from (  SELECT top 100 percent* FROM DBA_TempHTML order by 1 desc) as d '+' for xml path( ''tr'' ), type ) as varchar(max) )'  
  print  @BODY   

  create table #temp (returnstr nvarchar (max))  
  insert into #temp  
  exec sp_executesql  @body  
  declare @returnstr2 nvarchar(max)  
  select @returnstr2=LTRIM(RTRIM(returnstr)) from #temp  

  set @HTMLBODY = '<table cellpadding="1" cellspacing="1" border="1" style="font-family:TREBUCHET MS;font-size:14px;">'  
+ '<tr style="font-family:TREBUCHET MS;font-size:14px;align=center;">'+''+@NEWCOLUMN+ ''+'</tr>'  
+ replace( replace( @returnstr2, '&lt;', '<' ), '&gt;', '>'  )   
+ '</table>'  

select @HTMLBODY  
drop table #temp  
drop table DBA_TempHTML

GO

-- --------------------------------------------------
-- PROCEDURE dbo.find_in_sp
-- --------------------------------------------------


CREATE proc [dbo].[find_in_sp]
as

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

DECLARE @TableName Varchar(100) 
set @TableName=''
DECLARE @ColumnName Varchar(100) 
set @ColumnName=''
--SELECT DISTINCT CALLING_OBJECT
SELECT *
FROM (
select        OBJECT_NAME(d3.id) AS 'Calling_Object', type = substring(v2.name, 5, 66)
            , 'Affecting_Object' = (s6.name+ '.' + o1.name), updated = substring(u4.name, 1, 7)
            , selected = substring(w5.name, 1, 8), 'column' = col_name(d3.depid, d3.depnumber)
from  sys.objects o1
            INNER JOIN master.dbo.spt_values v2
                  ON o1.type = substring(v2.name,1,2) collate database_default and v2.type = 'O9T'
            INNER JOIN sysdepends d3
                  ON o1.object_id = d3.depid AND d3.deptype < 2
            INNER JOIN master.dbo.spt_values u4
                  ON u4.number = d3.resultobj AND u4.type = 'B'
            INNER JOIN master.dbo.spt_values w5
                  ON w5.number = d3.readobj|d3.selall AND w5.type = 'B'
            INNER JOIN sys.schemas s6
                  ON o1.schema_id = s6.schema_id
where o1.name = ISNULL(NULLIF(@TableName, ''), o1.name)
AND col_name(d3.depid, d3.depnumber) = ISNULL(NULLIF(@ColumnName, ''), col_name(d3.depid, d3.depnumber))
AND     u4.name = 'yes'
 
) a

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetPONumber
-- --------------------------------------------------
--Created BY Sandeep on 18 Mar 2016
--To Get the PO Number If Generated or Reset To Approved Level
--Prc_GetPONumber '14597',''
CREATE Procedure [dbo].[Prc_GetPONumber]
@RequestID varchar(20),
@PONumber varchar(50) out
As
Begin


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
declare @status varchar(10)
	if exists(select * from tbl_RequestMaster where Request_id=@RequestID and Status_code='PO')
	Begin
		if exists(select * from tbl_ItRequestPurchaseOrder with(nolock) where  Fld_RequestId like '%'+@RequestID+'%')
		Begin 
		set @PONumber=(select top 1 Fld_PurchaseOrderNo from tbl_ItRequestPurchaseOrder with(nolock) where  Fld_RequestId like '%'+@RequestID+'%' order by generated_date desc)		
		End 
		else
		Begin
		 
		update tbl_RequestMaster
		set Status_code='A',
		Model_Quantity_Assigned=0
		where Request_ID=@RequestID
		
		set @PONumber='Error Occur While Generating PO Kindly Re-Generate the PO'
		End		
	End
	else if exists(select * from tbl_RequestMaster where Request_id=@RequestID )
	Begin
	 
	set @status=(select status_code from tbl_RequestMaster where Request_id=@RequestID)
	set @PONumber='Request ID Status Code is '+@status+''
	End
	else
	Begin
		set @PONumber='RequestID  does not exists'
	End
	select @PONumber
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_ManualInsRecommender
-- --------------------------------------------------
CREATE procedure [dbo].[Prc_ManualInsRecommender]
@Requested_By varchar(50),
@Estimated_Total_Price int
As
Begin


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

--get current request_id                    
 Declare @Request_Id int           
 --getbranchcode of Requester                    
  Declare @RequesterBrCd nvarchar(255)                    
--onbasis of branchcode of Requester decide whether he belongs to Branch OR CSO Category                    
  Declare @Category char(20)                    
--get Designation of the Requester                    
  Declare @Designation varchar(255)                    
--get department of the requester                    
  Declare @Department nvarchar(200)                    
--get Sub_Department of the requester                    
  Declare @Sub_Department varchar(150)                    
                    
Set @Request_Id = (select max(Request_Id) As Request_Id from tbl_RequestMaster  where Requested_By = @Requested_By)                    
      
set @RequesterBrCd = (select Branch_Cd from Emp_Info where Emp_No = @Requested_By)                    
                    
 if(@RequesterBrCd not in(select branch_cd from tbl_CSO_Branch(nolock)) )                    
  Begin                    
   Set @Category = 'BRANCH'                    
  End         
                    
 else if (@RequesterBrCd in (select branch_cd from tbl_CSO_Branch(nolock)) )                    
  Begin                    
   Set @Category = 'CSO'                    
  End                    
                    
Set @Designation = (Select Designation from emp_info where Emp_No = @Requested_By)                    
                    
Set @Department = (Select Department from emp_info where Emp_No = @Requested_By)                    
                    
Set @Sub_Department = (Select Sub_Department from emp_info where Emp_No = @Requested_By)                    
                    
----                    
Declare @SrAVPIT varchar(20)                    
Declare @HeadIT varchar(20)                    
Declare @ADIT varchar(20)                   
Declare @ED varchar(20)                    
Declare @EDCFO varchar(20)                    
Declare @CSO varchar(20)                    
                    
Set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
Set @HeadIT = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
Set @ADIT = (Select ADIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
Set @ED = (Select ED from tbl_EmpTree Where Emp_Id = @Requested_By)                    
Set @EDCFO = (Select EDCFO from tbl_EmpTree Where Emp_Id = @Requested_By)                    
Set @CSO = (Select CSO from tbl_EmpTree Where Emp_Id = @Requested_By)                    
----                    
                    
                    
----------------get Recommenders------------------------                    
                  select U_Role,Category,Department into #Recommenders                    
                  from tbl_Recommendation_LimitMaster                    
                  where @Estimated_Total_Price between Rec_limitFrom and Rec_LimitTo                    
                 And Category=@Category                    
                    
                  -- Select * from #Recommenders                              
                                             
                    
        
    --Cursor                     
       Declare @CR_U_Role varchar(50)                    
    Declare @CR_Category varchar(50)                    
    Declare @CR_Department varchar(50)                    
    --Declare @Request_Id_Rec int                    
    --Declare @Recommender varchar(25)                    
    Declare Rec Cursor for                    
    Select * from #Recommenders                    
                    
                    
    OPEN Rec                    
    FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                    
    While(@@fetch_status=0)                    
      Begin                    
                    
       --Set @Request_Id_Rec = ''                    
       --Set @Recommender = ''                    
                          
       print 'Recommended'               
       print @CR_U_Role                    
       print @CR_Category                    
       print @CR_Department                    
                    
       if(@CR_Category = 'BRANCH')                    
        Begin                      
                          
         if(@CR_U_Role = 'Branch Head')                    
          Begin                           
           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By                          
                      
          End                    
--         else if(@CR_U_Role = 'Branch Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By                            
--          End                     
         else if(@CR_U_Role = 'Cluster Head')                    
          Begin                    
           Exec USP_GetRecApr 'R',@Category,'ClusterHead',@Request_Id,@Requested_By                    
          End                    
         else if(@CR_U_Role = 'Zonal Head')                    
          Begin                    
           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                            
        End                    
--         else if(@CR_U_Role = 'Zonal Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                                   
--          End                            
    else if(@CR_U_Role = 'Regional Head')                    
          Begin                    
           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By                    
          End                    
--         else if(@CR_U_Role = 'Regional Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By                           
--          End            
         else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')                    
          Begin                    
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                    
           -- Begin                    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
            Begin                    
             Insert into tbl_RequestRecApr                    
             Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
            End                    
           -- End                             
                              
          End                    
         else if(@CR_U_Role = 'Executive Director')                    
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')                    
            Begin                    
             Insert into tbl_RequestRecApr                    
             Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By                      
            End                    
           -- End                    
           End                    
         else if(@CR_U_Role = 'Executive Director-CFO')                    
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
            Begin                    
             Insert into tbl_RequestRecApr                    
             Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                     
            End                     
           -- End                          
          End                    
         else if(@CR_U_Role = 'Chief Strategy Officer')                    
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')                    
            Begin                    
             Insert into tbl_RequestRecApr                    
             Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
            End               
           -- End                    
         End                    
        End                    
                    
       else if (@CR_Category = 'CSO')                    
        Begin                    
                    
         if(@CR_U_Role = 'A.V.P.')                    
          Begin                    
           --if HOD should also see the request then add  HOD here.   
           print 'USP_GetRecApr'  
           Exec USP_GetRecApr 'R',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By                    
                    
          End                    
--         else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'ALL')                    
--          Begin                     
--           ---DoNothing                       
--          End                    
         else if(@CR_U_Role = 'Vice President')                    
          Begin                    
           --if HOD should also see the request then add  HOD here.                     
           Exec USP_GetRecApr 'R',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By                    
          End                    
--         else if(@CR_U_Role = 'Sr. Vice President')                    
--          Begin                    
--           --DoNothing                             
--          End                    
        else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@CR_U_Role = 'Associate Director')                    
     Begin                    
                               
           --select * from emp_info where emp_no ='P00104'                    
           --OR                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'R' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
          End                    
          End                    
        else if(@CR_U_Role = 'Executive Director')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@CR_U_Role = 'Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin          
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@CR_U_Role = 'Chief Strategy Officer')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
                    
                    
        End                           
                    
         FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                    
                    
                    
      End                    
                      
   Close Rec                    
   deallocate Rec                     
                                
                    
----------------------------------------------------------------------------------------------------------------                    
                    
---------------get Approver--------------------------------                    
                    
   Select U_Role,Category,Department into #Approver                    
   From tbl_Approval_LimitMaster                    
   Where @Estimated_Total_Price Between Apr_LimitFrom and Apr_LimitTo                    
   And Category = @Category                    
                    
                  -- Select * from #Approver                                     
    --Cursor                     
       Declare @CA_U_Role varchar(50)                    
    Declare @CA_Category varchar(50)                    
    Declare @CA_Department varchar(50)                    
    --Declare @Request_Id_Apr int                    
    --Declare @Approver varchar(25)                    
                    
    Declare Apr Cursor for                    
    Select * from #Approver                    
                    
                    
    OPEN Apr                    
    FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                    
    While(@@fetch_status=0)                    
      Begin                    
       --Set @Request_Id_Rec = ''                    
--       print @CA_U_Role                    
--       print @CA_Category                    
--       print @CA_Department                    
                    
       if(@CA_Category = 'BRANCH')                    
        Begin                    
                    
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
   Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                     
End                    
          End                    
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                    
          Begin                    
           --select * from emp_info where emp_no ='P00104'                    
           --OR                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                     
           End                    
                               
          End                    
         else if(@CA_U_Role ='Executive Director')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By                     
           End                    
                    
          End                    
       else if(@CA_U_Role ='Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
     Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                     
           End                    
          End                    
         else if(@CA_U_Role ='Chief Strategy Officer')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                     
          End                    
         else if(@CA_U_Role ='CMD')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                    
           Insert into tbl_RequestRecApr                    
           Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'                    
          End                    
                      
                    
        End                    
                    
      else if(@CA_Category = 'CSO')                    
        Begin                    
                    
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@CA_U_Role ='Executive Director')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@CA_U_Role ='Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                 
            Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@CA_U_Role ='Chief Strategy Officer')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@CA_U_Role ='CMD')                    
          Begin                    
 if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                    
           End                    
          End                    
                    
                
      End                    
                     
         FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                    
                    
      End                    
   Close Apr                    
   deallocate Apr                     
                                
                    
----------------get OTHERS Recommenders ------------------------                    
                  select U_Role,Category,Department into #OtherRecommenders                    
                  from tbl_Recommendation_LimitMaster                    
                  where @Estimated_Total_Price between B_ReclimitFrom and B_RecLimitTo                    
                 And Category=@Category                    
                    
 -- Select * from #OtherRecommenders                              
                                             
                    
                               
    --Cursor                     
       Declare @COR_U_Role varchar(50)                    
    Declare @COR_Category varchar(50)                    
    Declare @COR_Department varchar(50)                    
    --Declare @Request_Id_Rec int                    
    --Declare @Recommender varchar(25)                
    Declare ORec Cursor for                    
    Select * from #OtherRecommenders                    
                    
                    
    OPEN ORec                    
    FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                    
    While(@@fetch_status=0)                    
      Begin                    
                    
       --Set @Request_Id_Rec = ''                    
       --Set @Recommender = ''                    
    
--                    
       print @COR_U_Role                    
       print @COR_Category                    
       print @COR_Department                    
                    
       if(@COR_Category = 'BRANCH')                    
        Begin                      
                          
         if(@COR_U_Role = 'Branch Head')                    
          Begin                           
           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                          
                      
          End                    
--         else if(@COR_U_Role = 'Branch Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                                               
--          End                     
         else if(@COR_U_Role = 'Cluster Head')                    
          Begin                    
           Exec USP_GetRecApr 'OR',@Category,'ClusterHead',@Request_Id,@Requested_By                    
          End                    
         else if(@COR_U_Role = 'Zonal Head')                    
          Begin                    
           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                            
          End                    
--         else if(@COR_U_Role = 'Zonal Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                                   
--          End                    
         else if(@COR_U_Role = 'Regional Head')                    
          Begin                    
           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                    
          End                    
--         else if(@CR_U_Role = 'Regional Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                        
--          End                    
         else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                    
          Begin                    
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                    
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
           -- End                             
                              
          End                    
         else if(@COR_U_Role = 'Executive Director')            
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
           -- End                    
           End                    
         else if(@COR_U_Role = 'Executive Director-CFO')                    
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr              
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
           -- End               
          End                    
         else if(@COR_U_Role = 'Chief Strategy Officer')                    
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
           -- End                    
         End                    
        End                    
                    
       else if (@COR_Category = 'CSO')                    
        Begin                    
                    
         if(@COR_U_Role = 'A.V.P.')              
          Begin                    
           Exec USP_GetRecApr 'OR',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By                    
          End                    
--         else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'ALL')                    
--          Begin                     
--   DoNothing                            
--          End                    
         else if(@COR_U_Role = 'Vice President' OR @COR_U_Role = 'Sr. Vice President')                    
          Begin                    
           Exec USP_GetRecApr 'OR',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By                    
          End                    
--         else if(@COR_U_Role = 'Sr. Vice President')                    
--          Begin                    
--           DoNothing                             
--          End                    
        else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'OR' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
     End                    
          End                    
        else if(@COR_U_Role = 'Associate Director')                    
          Begin                    
                               
           --select * from emp_info where emp_no ='P00104'                    
           --OR                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OR' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
           End                    
          End                    
        else if(@COR_U_Role = 'Executive Director')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
    End                    
          End                    
        else if(@COR_U_Role = 'Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@COR_U_Role = 'Chief Strategy Officer')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
                    
                    
        End                           
                    
         FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                    
                    
                    
      End                    
                      
   Close ORec                    
   deallocate ORec                     
                                
                    
----------------------------------------------------------------------------------------------------------------                    
                    
---------------get OTHER Approver--------------------------------                    
                    
   Select U_Role,Category,Department into #OtherApprover                    
   From tbl_Approval_LimitMaster                
   Where @Estimated_Total_Price Between B_AprLimitFrom and B_AprLimitTo                    
   And Category = @Category                    
                    
                  -- Select * from #OtherApprover                                     
    --Cursor                     
       Declare @COA_U_Role varchar(50)                    
    Declare @COA_Category varchar(50)                    
    Declare @COA_Department varchar(50)                    
    --Declare @Request_Id_Apr int                    
    --Declare @Approver varchar(25)                    
                    
    Declare OApr Cursor for                    
    Select * from #OtherApprover                    
                    
                    
    OPEN OApr                    
    FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                    
    While(@@fetch_status=0)                    
      Begin                    
       --Set @Request_Id_Rec = ''                    
       print @COA_U_Role                    
       print @COA_Category                    
       print @COA_Department                    
                    
  if(@COA_Category = 'BRANCH')                    
        Begin                    
                    
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
          End                    
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                    
          Begin                    
           --select * from emp_info where emp_no ='P00104'                    
           --OR                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
                               
          End                    
         else if(@COA_U_Role ='Executive Director')                    
          Begin                    
          if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
          End                    
         else if(@COA_U_Role ='Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
          End                    
         else if(@COA_U_Role ='Chief Strategy Officer')                    
Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                    
End                    
          End                    
         else if(@COA_U_Role ='CMD')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'                    
           End                    
          End                    
                      
                    
        End                    
                    
      else if(@COA_Category = 'CSO')                    
        Begin                    
                    
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
     Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@COA_U_Role ='Executive Director')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@COA_U_Role ='Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                     
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@COA_U_Role ='Chief Strategy Officer')                    
          Begin                    
     if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@COA_U_Role ='CMD')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                    
           End                   
          End                    
                    
                    
        End                    
                     
         FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                    
                    
      End                    
   Close OApr                    
   deallocate OApr                     
                                
----------------------------------------------------------------------------------------------------------                    
                  
                    
Select @Request_Id As [Request_Id]                    
       
declare @Request_Id1 nvarchar(max)                    
Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster where Requested_By = @Requested_By)           
          
--EXECUTE Usp_Mailer_Options '1',@Request_Id1                        
                                                                  
                                                                 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_findstring
-- --------------------------------------------------
create procedure [dbo].[sp_findstring]    
@string varchar(max)    
as    
begin    
select distinct A.name  from sys.objects A    
inner join sys .syscomments B    
on A.object_id=B.id    
where CHARINDEX (@string,B.text)>0    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generate_inserts
-- --------------------------------------------------
create PROC [dbo].[sp_generate_inserts]  
(  
 @table_name varchar(776),    -- The table/view for which the INSERT statements will be generated using the existing data  
 @target_table varchar(776) = NULL,  -- Use this parameter to specify a different table name into which the data will be inserted  
 @include_column_list bit = 1,  -- Use this parameter to include/ommit column list in the generated INSERT statement  
 @from varchar(800) = NULL,   -- Use this parameter to filter the rows based on a filter condition (using WHERE)  
 @include_timestamp bit = 0,   -- Specify 1 for this parameter, if you want to include the TIMESTAMP/ROWVERSION column's data in the INSERT statement  
 @debug_mode bit = 0,   -- If @debug_mode is set to 1, the SQL statements constructed by this procedure will be printed for later examination  
 @owner varchar(64) = NULL,  -- Use this parameter if you are not the owner of the table  
 @ommit_images bit = 0,   -- Use this parameter to generate INSERT statements by omitting the 'image' columns  
 @ommit_identity bit = 0,  -- Use this parameter to ommit the identity columns  
 @top int = NULL,   -- Use this parameter to generate INSERT statements only for the TOP n rows  
 @cols_to_include varchar(8000) = NULL, -- List of columns to be included in the INSERT statement  
 @cols_to_exclude varchar(8000) = NULL, -- List of columns to be excluded from the INSERT statement  
 @disable_constraints bit = 0,  -- When 1, disables foreign key constraints and enables them after the INSERT statements  
 @ommit_computed_cols bit = 0  -- When 1, computed columns will not be included in the INSERT statement  
   
)  
AS  
BEGIN  
  
/***********************************************************************************************************  
Procedure: sp_generate_inserts  (Build 22)   
  (Copyright  2002 Narayana Vyas Kondreddi. All rights reserved.)  
                                            
Purpose: To generate INSERT statements from existing data.   
  These INSERTS can be executed to regenerate the data at some other location.  
  This procedure is also useful to create a database setup, where in you can   
  script your data along with your table definitions.  
  
Written by: Narayana Vyas Kondreddi  
         http://vyaskn.tripod.com  
  
Acknowledgements:  
  Divya Kalra -- For beta testing  
  Mark Charsley -- For reporting a problem with scripting uniqueidentifier columns with NULL values  
  Artur Zeygman -- For helping me simplify a bit of code for handling non-dbo owned tables  
  Joris Laperre   -- For reporting a regression bug in handling text/ntext columns  
  
Tested on:  SQL Server 7.0 and SQL Server 2000  
  
Date created: January 17th 2001 21:52 GMT  
  
Date modified: May 1st 2002 19:50 GMT  
  
Email:   vyaskn@hotmail.com  
  
NOTE:  This procedure may not work with tables with too many columns.  
  Results can be unpredictable with huge text columns or SQL Server 2000's sql_variant data types  
  Whenever possible, Use @include_column_list parameter to ommit column list in the INSERT statement, for better results  
  IMPORTANT: This procedure is not tested with internation data (Extended characters or Unicode). If needed  
  you might want to convert the datatypes of character variables in this procedure to their respective unicode counterparts  
  like nchar and nvarchar  
    
  
Example 1: To generate INSERT statements for table 'titles':  
    
  EXEC sp_generate_inserts 'titles'  
  
Example 2:  To ommit the column list in the INSERT statement: (Column list is included by default)  
  IMPORTANT: If you have too many columns, you are advised to ommit column list, as shown below,  
  to avoid erroneous results  
    
  EXEC sp_generate_inserts 'titles', @include_column_list = 0  
  
Example 3: To generate INSERT statements for 'titlesCopy' table from 'titles' table:  
  
  EXEC sp_generate_inserts 'titles', 'titlesCopy'  
  
Example 4: To generate INSERT statements for 'titles' table for only those titles   
  which contain the word 'Computer' in them:  
  NOTE: Do not complicate the FROM or WHERE clause here. It's assumed that you are good with T-SQL if you are using this parameter  
  
  EXEC sp_generate_inserts 'titles', @from = "from titles where title like '%Computer%'"  
  
Example 5:  To specify that you want to include TIMESTAMP column's data as well in the INSERT statement:  
  (By default TIMESTAMP column's data is not scripted)  
  
  EXEC sp_generate_inserts 'titles', @include_timestamp = 1  
  
Example 6: To print the debug information:  
    
  EXEC sp_generate_inserts 'titles', @debug_mode = 1  
  
Example 7:  If you are not the owner of the table, use @owner parameter to specify the owner name  
  To use this option, you must have SELECT permissions on that table  
  
  EXEC sp_generate_inserts Nickstable, @owner = 'Nick'  
  
Example 8:  To generate INSERT statements for the rest of the columns excluding images  
  When using this otion, DO NOT set @include_column_list parameter to 0.  
  
  EXEC sp_generate_inserts imgtable, @ommit_images = 1  
  
Example 9:  To generate INSERT statements excluding (ommiting) IDENTITY columns:  
  (By default IDENTITY columns are included in the INSERT statement)  
  
  EXEC sp_generate_inserts mytable, @ommit_identity = 1  
  
Example 10:  To generate INSERT statements for the TOP 10 rows in the table:  
    
  EXEC sp_generate_inserts mytable, @top = 10  
  
Example 11:  To generate INSERT statements with only those columns you want:  
    
  EXEC sp_generate_inserts titles, @cols_to_include = "'title','title_id','au_id'"  
  
Example 12:  To generate INSERT statements by omitting certain columns:  
    
  EXEC sp_generate_inserts titles, @cols_to_exclude = "'title','title_id','au_id'"  
  
Example 13: To avoid checking the foreign key constraints while loading data with INSERT statements:  
    
  EXEC sp_generate_inserts titles, @disable_constraints = 1  
  
Example 14:  To exclude computed columns from the INSERT statement:  
  EXEC sp_generate_inserts MyTable, @ommit_computed_cols = 1  
***********************************************************************************************************/  
  
SET NOCOUNT ON  
  
--Making sure user only uses either @cols_to_include or @cols_to_exclude  
IF ((@cols_to_include IS NOT NULL) AND (@cols_to_exclude IS NOT NULL))  
 BEGIN  
  RAISERROR('Use either @cols_to_include or @cols_to_exclude. Do not use both the parameters at once',16,1)  
  RETURN -1 --Failure. Reason: Both @cols_to_include and @cols_to_exclude parameters are specified  
 END  
  
--Making sure the @cols_to_include and @cols_to_exclude parameters are receiving values in proper format  
IF ((@cols_to_include IS NOT NULL) AND (PATINDEX('''%''',@cols_to_include) = 0))  
 BEGIN  
  RAISERROR('Invalid use of @cols_to_include property',16,1)  
  PRINT 'Specify column names surrounded by single quotes and separated by commas'  
  PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_include = "''title_id'',''title''"'  
  RETURN -1 --Failure. Reason: Invalid use of @cols_to_include property  
 END  
  
IF ((@cols_to_exclude IS NOT NULL) AND (PATINDEX('''%''',@cols_to_exclude) = 0))  
 BEGIN  
  RAISERROR('Invalid use of @cols_to_exclude property',16,1)  
  PRINT 'Specify column names surrounded by single quotes and separated by commas'  
  PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_exclude = "''title_id'',''title''"'  
  RETURN -1 --Failure. Reason: Invalid use of @cols_to_exclude property  
 END  
  
  
--Checking to see if the database name is specified along wih the table name  
--Your database context should be local to the table for which you want to generate INSERT statements  
--specifying the database name is not allowed  
IF (PARSENAME(@table_name,3)) IS NOT NULL  
 BEGIN  
  RAISERROR('Do not specify the database name. Be in the required database and just specify the table name.',16,1)  
  RETURN -1 --Failure. Reason: Database name is specified along with the table name, which is not allowed  
 END  
  
--Checking for the existence of 'user table' or 'view'  
--This procedure is not written to work on system tables  
--To script the data in system tables, just create a view on the system tables and script the view instead  
  
IF @owner IS NULL  
 BEGIN  
  IF ((OBJECT_ID(@table_name,'U') IS NULL) AND (OBJECT_ID(@table_name,'V') IS NULL))   
   BEGIN  
    RAISERROR('User table or view not found.',16,1)  
    PRINT 'You may see this error, if you are not the owner of this table or view. In that case use @owner parameter to specify the owner name.'  
    PRINT 'Make sure you have SELECT permission on that table or view.'  
    RETURN -1 --Failure. Reason: There is no user table or view with this name  
   END  
 END  
ELSE  
 BEGIN  
  IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = @table_name AND (TABLE_TYPE = 'BASE TABLE' OR TABLE_TYPE = 'VIEW') AND TABLE_SCHEMA = @owner)  
   BEGIN  
    RAISERROR('User table or view not found.',16,1)  
    PRINT 'You may see this error, if you are not the owner of this table. In that case use @owner parameter to specify the owner name.'  
    PRINT 'Make sure you have SELECT permission on that table or view.'  
    RETURN -1 --Failure. Reason: There is no user table or view with this name    
   END  
 END  
  
--Variable declarations  
DECLARE  @Column_ID int,     
  @Column_List varchar(8000),   
  @Column_Name varchar(128),   
  @Start_Insert varchar(786),   
  @Data_Type varchar(128),   
  @Actual_Values varchar(8000), --This is the string that will be finally executed to generate INSERT statements  
  @IDN varchar(128)  --Will contain the IDENTITY column's name in the table  
  
--Variable Initialization  
SET @IDN = ''  
SET @Column_ID = 0  
SET @Column_Name = ''  
SET @Column_List = ''  
SET @Actual_Values = ''  
  
IF @owner IS NULL   
 BEGIN  
  SET @Start_Insert = 'INSERT INTO ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']'   
 END  
ELSE  
 BEGIN  
  SET @Start_Insert = 'INSERT ' + '[' + LTRIM(RTRIM(@owner)) + '].' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']'     
 END  
  
  
--To get the first column's ID  
  
SELECT @Column_ID = MIN(ORDINAL_POSITION)    
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK)   
WHERE  TABLE_NAME = @table_name AND  
(@owner IS NULL OR TABLE_SCHEMA = @owner)  
  
  
  
--Loop through all the columns of the table, to get the column names and their data types  
WHILE @Column_ID IS NOT NULL  
 BEGIN  
  SELECT  @Column_Name = QUOTENAME(COLUMN_NAME),   
  @Data_Type = DATA_TYPE   
  FROM  INFORMATION_SCHEMA.COLUMNS (NOLOCK)   
  WHERE  ORDINAL_POSITION = @Column_ID AND   
  TABLE_NAME = @table_name AND  
  (@owner IS NULL OR TABLE_SCHEMA = @owner)  
  
  
  
  IF @cols_to_include IS NOT NULL --Selecting only user specified columns  
  BEGIN  
   IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_include) = 0   
   BEGIN  
    GOTO SKIP_LOOP  
   END  
  END  
  
  IF @cols_to_exclude IS NOT NULL --Selecting only user specified columns  
  BEGIN  
   IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_exclude) <> 0   
   BEGIN  
    GOTO SKIP_LOOP  
   END  
  END  
  
  --Making sure to output SET IDENTITY_INSERT ON/OFF in case the table has an IDENTITY column  
  IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsIdentity')) = 1   
  BEGIN  
   IF @ommit_identity = 0 --Determing whether to include or exclude the IDENTITY column  
    SET @IDN = @Column_Name  
   ELSE  
    GOTO SKIP_LOOP     
  END  
    
  --Making sure whether to output computed columns or not  
  IF @ommit_computed_cols = 1  
  BEGIN  
   IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsComputed')) = 1   
   BEGIN  
    GOTO SKIP_LOOP       
   END  
  END  
    
  --Tables with columns of IMAGE data type are not supported for obvious reasons  
  IF(@Data_Type in ('image'))  
   BEGIN  
    IF (@ommit_images = 0)  
     BEGIN  
      RAISERROR('Tables with image columns are not supported.',16,1)  
      PRINT 'Use @ommit_images = 1 parameter to generate INSERTs for the rest of the columns.'  
      PRINT 'DO NOT ommit Column List in the INSERT statements. If you ommit column list using @include_column_list=0, the generated INSERTs will fail.'  
      RETURN -1 --Failure. Reason: There is a column with image data type  
     END  
    ELSE  
     BEGIN  
     GOTO SKIP_LOOP  
     END  
   END  
  
  --Determining the data type of the column and depending on the data type, the VALUES part of  
  --the INSERT statement is generated. Care is taken to handle columns with NULL values. Also  
  --making sure, not to lose any data from flot, real, money, smallmomey, datetime columns  
  SET @Actual_Values = @Actual_Values  +  
  CASE   
   WHEN @Data_Type IN ('char','varchar','nchar','nvarchar')   
    THEN   
     'COALESCE('''''''' + REPLACE(RTRIM(' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')'  
   WHEN @Data_Type IN ('datetime','smalldatetime')   
    THEN   
     'COALESCE('''''''' + RTRIM(CONVERT(char,' + @Column_Name + ',109))+'''''''',''NULL'')'  
   WHEN @Data_Type IN ('uniqueidentifier')   
    THEN    
     'COALESCE('''''''' + REPLACE(CONVERT(char(255),RTRIM(' + @Column_Name + ')),'''''''','''''''''''')+'''''''',''NULL'')'  
   WHEN @Data_Type IN ('text','ntext')   
    THEN    
     'COALESCE('''''''' + REPLACE(CONVERT(char(8000),' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')'       
   WHEN @Data_Type IN ('binary','varbinary')   
    THEN    
     'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')'    
   WHEN @Data_Type IN ('timestamp','rowversion')   
    THEN    
     CASE   
      WHEN @include_timestamp = 0   
       THEN   
        '''DEFAULT'''   
       ELSE   
        'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')'    
     END  
   WHEN @Data_Type IN ('float','real','money','smallmoney')  
    THEN  
     'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' +  @Column_Name  + ',2)' + ')),''NULL'')'   
   ELSE   
    'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' +  @Column_Name  + ')' + ')),''NULL'')'   
  END   + '+' +  ''',''' + ' + '  
    
  --Generating the column list for the INSERT statement  
  SET @Column_List = @Column_List +  @Column_Name + ','   
  
  SKIP_LOOP: --The label used in GOTO  
  
  SELECT  @Column_ID = MIN(ORDINAL_POSITION)   
  FROM  INFORMATION_SCHEMA.COLUMNS (NOLOCK)   
  WHERE  TABLE_NAME = @table_name AND   
  ORDINAL_POSITION > @Column_ID AND  
  (@owner IS NULL OR TABLE_SCHEMA = @owner)  
  
  
 --Loop ends here!  
 END  
  
--To get rid of the extra characters that got concatenated during the last run through the loop  
SET @Column_List = LEFT(@Column_List,len(@Column_List) - 1)  
SET @Actual_Values = LEFT(@Actual_Values,len(@Actual_Values) - 6)  
  
IF LTRIM(@Column_List) = ''   
 BEGIN  
  RAISERROR('No columns to select. There should at least be one column to generate the output',16,1)  
  RETURN -1 --Failure. Reason: Looks like all the columns are ommitted using the @cols_to_exclude parameter  
 END  
  
--Forming the final string that will be executed, to output the INSERT statements  
IF (@include_column_list <> 0)  
 BEGIN  
  SET @Actual_Values =   
   'SELECT ' +    
   CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END +   
   '''' + RTRIM(@Start_Insert) +   
   ' ''+' + '''(' + RTRIM(@Column_List) +  '''+' + ''')''' +   
   ' +''VALUES(''+ ' +  @Actual_Values  + '+'')''' + ' ' +   
   COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)')  
 END  
ELSE IF (@include_column_list = 0)  
 BEGIN  
  SET @Actual_Values =   
   'SELECT ' +   
   CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END +   
   '''' + RTRIM(@Start_Insert) +   
   ' '' +''VALUES(''+ ' +  @Actual_Values + '+'')''' + ' ' +   
   COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)')  
 END   
  
--Determining whether to ouput any debug information  
IF @debug_mode =1  
 BEGIN  
  PRINT '/*****START OF DEBUG INFORMATION*****'  
  PRINT 'Beginning of the INSERT statement:'  
  PRINT @Start_Insert  
  PRINT ''  
  PRINT 'The column list:'  
  PRINT @Column_List  
  PRINT ''  
  PRINT 'The SELECT statement executed to generate the INSERTs'  
  PRINT @Actual_Values  
  PRINT ''  
  PRINT '*****END OF DEBUG INFORMATION*****/'  
  PRINT ''  
 END  
    
PRINT '--INSERTs generated by ''sp_generate_inserts'' stored procedure written by Vyas'  
PRINT '--Build number: 22'  
PRINT '--Problems/Suggestions? Contact Vyas @ vyaskn@hotmail.com'  
PRINT '--http://vyaskn.tripod.com'  
PRINT ''  
PRINT 'SET NOCOUNT ON'  
PRINT ''  
  
  
--Determining whether to print IDENTITY_INSERT or not  
IF (@IDN <> '')  
 BEGIN  
  PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' ON'  
  PRINT 'GO'  
  PRINT ''  
 END  
  
  
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL)  
 BEGIN  
  IF @owner IS NULL  
   BEGIN  
    SELECT  'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily'  
   END  
  ELSE  
   BEGIN  
    SELECT  'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily'  
   END  
  
  PRINT 'GO'  
 END  
  
PRINT ''  
PRINT 'PRINT ''Inserting values into ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' + ''''  
  
  
--All the hard work pays off here!!! You'll get your INSERT statements, when the next line executes!  
EXEC (@Actual_Values)  
  
PRINT 'PRINT ''Done'''  
PRINT ''  
  
  
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL)  
 BEGIN  
  IF @owner IS NULL  
   BEGIN  
    SELECT  'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL'  AS '--Code to enable the previously disabled constraints'  
   END  
  ELSE  
   BEGIN  
    SELECT  'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints'  
   END  
  
  PRINT 'GO'  
 END  
  
PRINT ''  
IF (@IDN <> '')  
 BEGIN  
  PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' OFF'  
  PRINT 'GO'  
 END  
  
PRINT 'SET NOCOUNT OFF'  
  
  
SET NOCOUNT OFF  
RETURN 0 --Success. We are done!  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.tes
-- --------------------------------------------------
create proc tes
as select top 10 request_id,user_remark from tbl_requestmaster

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AddToInvOnBill
-- --------------------------------------------------
--CREATED BY:    
--MODIFIED BY:ZEBA RAJE    
    
CREATE PROC [dbo].[USP_AddToInvOnBill] (@OPTION        CHAR(10),    
                                        @USER_ID       CHAR(10),    
                                        @VENDOR_CODE   INT,    
                                        @WARRANTY_TYPE CHAR(80),    
    
                                        --@MODEL_ID CHAR(20),      
                                        @REQUEST_ID    INT,    
                                        @PRODUCT_DESC  VARCHAR(500),    
                                        @PART_NO       CHAR(20),    
                                        @UNIT_PRICE    FLOAT)    
AS    
  BEGIN    
  
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
      DECLARE @PRODUCT_CODE CHAR(20)    
      DECLARE @MODEL_ID CHAR(20)    
      DECLARE @ADDED_BY CHAR(10)    
      DECLARE @ASSIGN_TYPE VARCHAR(100)    
      DECLARE @ASSIGN_TO CHAR(10)    
      DECLARE @ASSIGN_TODEPT CHAR(20)    
      DECLARE @ASSIGN_TOBRANCH VARCHAR(100)    
      DECLARE @ASSIGN_BY CHAR(20)    
      DECLARE @STATUS CHAR(1)    
    
      --      
      --      
      SET @PRODUCT_CODE=(SELECT ITEM_CODE    
                         FROM   TBL_REQUESTMASTER    
                         WHERE  REQUEST_ID = @REQUEST_ID)    
      SET @MODEL_ID = (SELECT MODEL_NO    
                       FROM   TBL_REQUESTMASTER    
                       WHERE  REQUEST_ID = @REQUEST_ID)    
      SET @ASSIGN_TYPE =( 'PO' )    
      SET @ASSIGN_TO = (SELECT REQUESTED_BY    
                        FROM   TBL_REQUESTMASTER    
                        WHERE  REQUEST_ID = @REQUEST_ID)    
      SET @ASSIGN_TODEPT = ( NULL )    
      SET @ASSIGN_TOBRANCH = ( NULL )    
      SET @ASSIGN_BY = ( @USER_ID )    
      SET @STATUS='0'    
    
      --INSERT COMPLETE DATA INTO INVENTORY INCLUDING ASSIGN DETAILS(ASSUMED THAT IF BILL GENTRATION THEN ITEM IS PURCHASED      
      --AS WELL AS ASSIGNED)      
      IF( @OPTION = 'FIRST' )    
        BEGIN    
            --IF EXISTS (SELECT *    
            --           FROM   TBL_STOCKINVENTORYDETAILS    
            --           WHERE  REQUEST_ID = @REQUEST_ID)--ZEBA      
            --  BEGIN    
            --      UPDATE TBL_STOCKINVENTORYDETAILS    
            --      SET    PRODUCT_CODE = @PRODUCT_CODE,    
            --             MODEL_ID = @MODEL_ID,    
            --             VENDOR_CODE = @VENDOR_CODE,    
            --             --ADDED_BY        
            --             ADDED_BY = @USER_ID,    
            --             --ADDED_ON        
            --             ADDED_ON = GETDATE(),    
            --             --MODIFIED_BY        
            --             MODIFIED_BY = @USER_ID,    
            --             --MODIFIED_DATE        
            --             MODIFIED_DATE = GETDATE(),    
            --             WARRANTY_TYPE = @WARRANTY_TYPE,    
            --             ASSIGN_TYPE = @ASSIGN_TYPE,    
            --             ASSIGN_TO = @ASSIGN_TO,    
            --             ASSIGN_TODEPT = @ASSIGN_TODEPT,    
            --             ASSIGN_TOBRANCH = @ASSIGN_TOBRANCH,    
            --             ASSIGN_DATE = GETDATE(),    
            --             ASSIGN_BY = @ASSIGN_BY,    
            --             REQUEST_ID = @REQUEST_ID,    
            --             STATUS = @STATUS,    
            --             PRODUCT_DESC = @PRODUCT_DESC,    
            --             PART_NO = @PART_NO,    
            --             UNIT_PRICE = @UNIT_PRICE,    
            --             BILL_ORDERBY = @USER_ID,    
            --             BILL_ORDERDATE = GETDATE()    
            --      WHERE  REQUEST_ID = @REQUEST_ID    
            --  END    
            --ELSE ---ZEBA    
              INSERT INTO TBL_STOCKINVENTORYDETAILS    
                          (PRODUCT_CODE,    
                           MODEL_ID,    
                           VENDOR_CODE,    
                           --ADDED_BY      
                           ADDED_BY,    
                           --ADDED_ON      
                           ADDED_ON,    
                --MODIFIED_BY      
                           MODIFIED_BY,    
                           --MODIFIED_DATE      
                           MODIFIED_DATE,    
                           WARRANTY_TYPE,    
                           ASSIGN_TYPE,    
                           ASSIGN_TO,    
                           ASSIGN_TODEPT,    
                           ASSIGN_TOBRANCH,    
                           ASSIGN_DATE,    
                           ASSIGN_BY,    
                           REQUEST_ID,    
                           STATUS,    
                           PRODUCT_DESC,    
                           PART_NO,    
                           UNIT_PRICE,    
                           BILL_ORDERBY,    
                           BILL_ORDERDATE)    
              VALUES      ( @PRODUCT_CODE,    
                            @MODEL_ID,    
                            @VENDOR_CODE,    
                            --ADDED_BY      
                            @USER_ID,    
                            --ADDED_ON      
                            GETDATE(),    
                            --MODIFIED_BY      
                            @USER_ID,    
                            --MODIDIED_DATE      
                            GETDATE(),    
                            @WARRANTY_TYPE,    
                            @ASSIGN_TYPE,    
                            @ASSIGN_TO,    
                            @ASSIGN_TODEPT,    
                            @ASSIGN_TOBRANCH,    
                            GETDATE(),    
                            @ASSIGN_BY,    
                            @REQUEST_ID,    
                            @STATUS,    
                            @PRODUCT_DESC,    
                            @PART_NO,    
                            @UNIT_PRICE,    
                            @USER_ID,    
                            GETDATE() )    
        END    
      --UPDATE REQUESTMASTER AND SET MODEL_QUANTITY_ASSIGNED AS MODEL_QUANTITY      
      --AND SET THE STATUS OF THE PARTICULAR REQUSETID AS CLOSED       
      --AFTER ALL ENTERIES ARE DONE IN SP USP_CLOSEINVENTORY      
      -------------------INSERT IN LOG I.E TBL_STOCKINVENTIRYDETAILS_LOG----------------      
      ELSE IF( @OPTION = 'SECOND' )    
        BEGIN    
            INSERT INTO TBL_STOCKINVENTORYDETAILS_LOG    
                        (INVENTORY_NO,    
                         PRODUCT_CODE,    
                         MODEL_ID,    
                         VENDOR_CODE,    
                         WARRANTY_TYPE,    
                         ASSIGN_TYPE,    
                         ASSIGN_TO,    
                         ASSIGN_TODEPT,    
                         ASSIGN_TOBRANCH,    
                         ASSIGN_DATE,    
                         ASSIGN_BY,    
                         REQUEST_ID,    
                         STATUS,    
                         PRODUCT_DESC,    
                         PART_NO,    
                         UNIT_PRICE,    
                         BILL_ORDERBY,    
                         BILL_ORDERDATE,    
                         --MODIFIED_BY      
                         MODIFIED_BY,    
                         --MODIFIED_DATE      
                         MODIFIED_DATE)    
            SELECT INVENTORY_NO,    
                   PRODUCT_CODE,    
                   MODEL_ID,    
                   VENDOR_CODE,    
                   WARRANTY_TYPE,    
                   ASSIGN_TYPE,    
                   ASSIGN_TO,    
                   ASSIGN_TODEPT,    
                   ASSIGN_TOBRANCH,    
                   ASSIGN_DATE,    
                   ASSIGN_BY,    
                   REQUEST_ID,    
                   STATUS,    
                   PRODUCT_DESC,    
                   PART_NO,    
                   UNIT_PRICE,    
                   BILL_ORDERBY,    
                   BILL_ORDERDATE,    
                   MODIFIED_BY,    
                   MODIFIED_DATE    
            FROM   TBL_STOCKINVENTORYDETAILS    
            WHERE  REQUEST_ID = @REQUEST_ID    
                   AND ASSIGN_TYPE = 'PO'    
        END    
  -------------------------------------------------------------      
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AllMailDetails
-- --------------------------------------------------
CREATE PROC [dbo].[USP_AllMailDetails]  
(  
@OPTION VARCHAR(50),  
@REQUEST_ID INT  
)   
AS  
BEGIN  


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
	DECLARE @FROM VARCHAR(4000), @TO VARCHAR(4000),@COPY VARCHAR(1000),@SUBJECT VARCHAR(500),@CCEmailID varchar(1000),@BODY VARCHAR(8000) 
	DECLARE @REQUESTED_BY_EMAILADD AS VARCHAR(100)
	DECLARE @HOD_EMAILADD AS VARCHAR(100)			
	DECLARE @REQUESTED_BY VARCHAR(50)
	DECLARE @REQUEST_DATE VARCHAR(15)
	DECLARE @ITEM_NAME VARCHAR(50)
	DECLARE @MODEL_NAME VARCHAR(50)
	DECLARE @QUANTITY VARCHAR(50)
	DECLARE @ESTIMATED_TOTAL_PRICE VARCHAR(50)
	DECLARE @JUSTIFICATION_REMARK VARCHAR(50)
	DECLARE @USER_REMARK VARCHAR(50)
	DECLARE @RECOMMENDED_BY VARCHAR(50)
	DECLARE @RECOMMENDED_ON VARCHAR(50)
	DECLARE @APPROVED_BY VARCHAR(50)
	DECLARE @APPROVED_ON VARCHAR(50)

	DECLARE @CATEGORY CHAR(10)      
	DECLARE @BRANCHCODE CHAR(20)      
	DECLARE @U_ROLE CHAR(100)      
	DECLARE @ESTIMATED_TOTAL_PRICE_1 FLOAT      
	DECLARE @RECOMMENDERLIST NVARCHAR(MAX)      
	DECLARE @APPROVERLIST NVARCHAR(MAX)  
	DECLARE @USER_ID CHAR(20)
	
	
	
	SELECT @HOD_EMAILADD =  EMAILADD FROM EMP_INFO WHERE EMP_NO = 
							(SELECT SENIOR FROM EMP_INFO WHERE EMP_NO = 
							(SELECT REQUESTED_BY FROM TBL_REQUESTMASTER
							WHERE REQUEST_ID = @REQUEST_ID)
							)
					
	SELECT @USER_ID =EI.EMP_NO ,@Requested_By = EI.EMP_NAME ,@Request_Date=CONVERT(VARCHAR(11),RM.REQUEST_DATE,113),
	@Item_Name =CPM.PRODUCT_NAME ,@Model_Name = PMM.MODEL_NAME ,  
	@Quantity = RM.MODEL_QUANTITY ,@Estimated_Total_Price =RM.ESTIMATED_TOTAL_PRICE ,  
	@Justification_Remark =JM.JUSTIFICATION_NAME ,@User_Remark =RM.USER_REMARK ,  
	@Recommended_By = EI2.EMP_NAME ,@Recommended_On = CONVERT(VARCHAR(11),RM.RECOMMENDED_DATETIME,113) ,  
	@Approved_By = EI3.EMP_NAME ,@Approved_On = CONVERT(VARCHAR(11),RM.APPROVED_DATETIME,113),				 
	@REQUESTED_BY_EMAILADD = EI.EMAILADD 
	FROM TBL_REQUESTMASTER RM  
	LEFT OUTER JOIN EMP_INFO EI ON RM.REQUESTED_BY = EI.EMP_NO  
	LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM ON RM.ITEM_CODE = CPM.PRODUCT_CODE  
	LEFT OUTER JOIN TBL_PRODUCTMODELMASTER PMM ON RM.MODEL_NO = PMM.MODEL_ID  
	LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RM.JUSTIFICATION_ID = JM.JUSTIFICATION_ID  
	LEFT OUTER JOIN EMP_INFO EI2 ON RM.RECOMMENDED_BY = EI2.EMP_NO  
	LEFT OUTER JOIN EMP_INFO EI3 ON RM.APPROVED_BY = EI3.EMP_NO  
	WHERE RM.REQUEST_ID = @REQUEST_ID 	
	
	SET @BRANCHCODE=(SELECT BRANCH_CD FROM EMP_INFO WHERE EMP_NO =@USER_ID)      
	IF(@BRANCHCODE IN (SELECT BRANCH_CD FROM TBL_CSO_BRANCH(NOLOCK)))      
	BEGIN      
	SET @CATEGORY='CSO'      
	END      
	ELSE      
	BEGIN      
	SET @CATEGORY='BRANCH'
	END
		
	SET @U_ROLE=(SELECT DESIGNATION FROM EMP_INFO WHERE EMP_NO=@USER_ID AND STATUS='A') 
	IF(@U_ROLE NOT IN ('REGIONAL HEAD','REGIONAL MANAGER','ZONAL HEAD','ZONAL MANAGER','ASSOCIATE DIRECTOR',' SR. ASSISTANT VICE PRESIDENT','HEAD'))      
	BEGIN      
	SET @U_ROLE='USER'      
	END 	
	
	SET @ESTIMATED_TOTAL_PRICE_1 = (SELECT ESTIMATED_TOTAL_PRICE FROM TBL_REQUESTMASTER WHERE REQUEST_ID = @REQUEST_ID)      
       
	SET @RECOMMENDERLIST = (SELECT SUBSTRING( ( SELECT ', ' + RTRIM(U_ROLE)       
		FROM TBL_RECOMMENDATION_LIMITMASTER       
		WHERE @ESTIMATED_TOTAL_PRICE_1 BETWEEN REC_LIMITFROM AND REC_LIMITTO AND CATEGORY = @CATEGORY       
		 FOR XML PATH(''), ELEMENTS),2,500))          
	SET @APPROVERLIST = (SELECT SUBSTRING( ( SELECT ', ' + RTRIM(U_ROLE)       
		FROM TBL_APPROVAL_LIMITMASTER      
		WHERE @ESTIMATED_TOTAL_PRICE_1 BETWEEN APR_LIMITFROM AND APR_LIMITTO AND CATEGORY = @CATEGORY       
		FOR XML PATH(''), ELEMENTS),2,500))    
	SET @APPROVERLIST = (SELECT REPLACE (@APPROVERLIST,'HEAD','HEAD-IT'))      
      


IF(@OPTION = 'NEW_REQUEST')  
	BEGIN    
		SELECT RM.REQUEST_ID AS [REQUEST_ID],EI.EMP_NAME AS [REQUESTED_BY], CONVERT(VARCHAR(11),RM.REQUEST_DATE,113) AS [REQUEST_DATE],  
		CPM.PRODUCT_NAME AS [ITEM_NAME],PMM.MODEL_NAME AS [MODEL_NAME],  
		RM.MODEL_QUANTITY AS [QUANTITY],RM.ESTIMATED_TOTAL_PRICE AS [ESTIMATED_TOTAL_PRICE],  
		JM.JUSTIFICATION_NAME AS [JUSTIFICATION_REMARK],RM.USER_REMARK AS [USER_REMARK],  
		EI2.EMAILADD AS [REQUESTED_BY_EMAILADD]  
		FROM TBL_REQUESTMASTER RM  
		LEFT OUTER JOIN EMP_INFO EI ON RM.REQUESTED_BY = EI.EMP_NO  
		LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM ON RM.ITEM_CODE = CPM.PRODUCT_CODE  
		LEFT OUTER JOIN TBL_PRODUCTMODELMASTER PMM ON RM.MODEL_NO = PMM.MODEL_ID  
		LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RM.JUSTIFICATION_ID = JM.JUSTIFICATION_ID  
		LEFT OUTER JOIN EMP_INFO EI2 ON RM.REQUESTED_BY = EI2.EMP_NO  
		WHERE RM.REQUEST_ID = @REQUEST_ID  

		SELECT EMP_NO,EMP_NAME,DEPARTMENT,DESIGNATION,EMAILADD AS [HOD_EMAILADD]  
		FROM EMP_INFO WHERE EMP_NO = (SELECT SENIOR   
		FROM EMP_INFO  
		WHERE EMP_NO = (SELECT REQUESTED_BY   
		FROM TBL_REQUESTMASTER  
		WHERE REQUEST_ID = @REQUEST_ID)  
		)  
	

		---- Send Mail---------
	
		SET @CCEMAILID	=   @HOD_EMAILADD + ',' + 'fatima.kazi@angelbroking.com' 
		SET @FROM = 'ITasset@angelbroking.com'
		SET @TO 	=	@REQUESTED_BY_EMAILADD 				
		SET @COPY	= @CCEMAILID
		SET @SUBJECT	= 'New ITAsset Request Confirmation Request ID :' + Convert(Varchar(20),@REQUEST_ID)
		SET @BODY ='<HTML><HEAD><TITLE>This is an acknowledge mail for your new IT Assets request</TITLE><STYLE TYPE=text/css>
		.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;}
		.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;}
		.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}
		</STYLE></HEAD><Body>		
		Dear  '+ Isnull(@REQUESTED_BY,'') +'
        <br>                    
        <p>Management has finalized an Authorization Policy for approval of various expenses based on the amount<br> and the purpose for which they are incurred.</p><br>
        <p>According the new policy every request should get first recommend from users departmental or business<br> head and then get approve by IT Management Team.</p><br><br>                   
        <center><table class=MyTable cellpadding=0 cellspacing=0 width=600><caption>IT Assets Request Details</caption>
        <tr width=100><td> Request ID :- </td>
        <td> ' + CONVERT(CHAR(20),@REQUEST_ID) + ' </td>
        <td> Requested By:- </td>
        <td> ' + isnull(@REQUESTED_BY,'') + ' </td>
        <td> Request Date:- </td>
        <td>' + isnull(@REQUEST_DATE,'') + '</td>
        </tr>
        <tr width=50><td> Item Name :-    </td>
        <td colspan=2>' + isnull(@ITEM_NAME,'') + ' </td>
        <td> Model Name :-      </td>
        <td colspan=2> ' + isnull(@MODEL_NAME,'') + ' </td></tr>
        <tr width=100><td> Quantity :-  </td>
        <td colspan=2> ' + CONVERT(CHAR(20),isnull(@QUANTITY,0)) + ' </td>
        <td> Estimated Price:-  </td>
        <td colspan=2> ' + CONVERT(VARCHAR(150),isnull(@ESTIMATED_TOTAL_PRICE,0)) + ' </td></tr>
        <tr width=150><td>Reason For Requirement:-  </td>
        <td colspan=5> ' + isnull(@JUSTIFICATION_REMARK,'') + ' </td></tr>
        <tr width=100><td>User Remark:- </td>
        <td colspan=5>' + isnull(@USER_REMARK,'') + ' </td></tr>
        <tr width=100><td>Current Status:-</td>
        <td colspan=5> Pending For Recommendation </td></tr>
        </table></center><br><br>                    
        <p>As per amount of your request following are details of approvals require</p><br>
        <center><table class=MyTable cellpadding=0 cellspacing=0 width=600><caption></caption>
        <tr width=100><td> Request Initiated By </td>
        <td> Requested Items Amount </td> 
        <td> Who Can Recommend </td>
        <td> Who Can Approve </td></tr>
        <tr>
        <td> '+ isnull(@U_Role,'') +' </td>
        <td> ' + CONVERT(VARCHAR(150),isnull(@ESTIMATED_TOTAL_PRICE_1,0)) + ' </td>
        <td>' + isnull(@RecommenderList,'') + '</td>
        <td>' + isnull(@ApproverList,'') + '</td>
        </tr>
        </table></center><br><br>
        </table></center> <br><br>
        <p> For further clarification on approval policy click me, and for any assistance call us at or write us at</p><br>
        <P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>
        Thanks & Regards,<br>IT Team </Body> </html>'

	--	EXEC SP_SEND_CDOSYSMAIL @FROM, @TO, @COPY, @SUBJECT, @BODY
	
	EXEC msdb.dbo.sp_send_dbmail 

		@profile_name='ITAssets', 

		@recipients = @TO,

		@copy_recipients= @COPY, 

		@subject = @SUBJECT, 

		@body_format = 'HTML', 

		@body =@BODY 


END  

	ELSE IF(@OPTION = 'AFTER_RECOMMENDATION')  
		BEGIN  
			SELECT RM.REQUEST_ID AS [REQUEST_ID],EI.EMP_NAME AS [REQUESTED_BY], CONVERT(VARCHAR(11),RM.REQUEST_DATE,113) AS [REQUEST_DATE],  
			CPM.PRODUCT_NAME AS [ITEM_NAME],PMM.MODEL_NAME AS [MODEL_NAME],  
			RM.MODEL_QUANTITY AS [QUANTITY],RM.ESTIMATED_TOTAL_PRICE AS [ESTIMATED_TOTAL_PRICE],  
			JM.JUSTIFICATION_NAME AS [JUSTIFICATION_REMARK],RM.USER_REMARK AS [USER_REMARK],  
			EI2.EMP_NAME AS [RECOMMENDED_BY],CONVERT(VARCHAR(11),RM.RECOMMENDED_DATETIME,113)AS [RECOMMENDED_ON],  
			EI2.EMAILADD AS [RECOMMENDED_BY_EMAILADD],  
			EI3.EMAILADD AS [REQUESTED_BY_EMAILADD]
			FROM TBL_REQUESTMASTER RM  
			LEFT OUTER JOIN EMP_INFO EI ON RM.REQUESTED_BY = EI.EMP_NO  
			LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM ON RM.ITEM_CODE = CPM.PRODUCT_CODE  
			LEFT OUTER JOIN TBL_PRODUCTMODELMASTER PMM ON RM.MODEL_NO = PMM.MODEL_ID  
			LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RM.JUSTIFICATION_ID = JM.JUSTIFICATION_ID  
			LEFT OUTER JOIN EMP_INFO EI2 ON RM.RECOMMENDED_BY = EI2.EMP_NO  
			LEFT OUTER JOIN EMP_INFO EI3 ON RM.REQUESTED_BY = EI3.EMP_NO 
			WHERE RM.REQUEST_ID = @REQUEST_ID  

			SELECT EMP_NO,EMP_NAME,DEPARTMENT,DESIGNATION,EMAILADD AS [HOD_EMAILADD]  
			FROM EMP_INFO WHERE EMP_NO = (SELECT SENIOR   
			FROM EMP_INFO  
			WHERE EMP_NO = (SELECT REQUESTED_BY   
			FROM TBL_REQUESTMASTER  
			WHERE REQUEST_ID = @REQUEST_ID)  
			)
		END
		ELSE IF (@OPTION = 'AFTER_APPROVAL')
		BEGIN  
			SELECT RM.REQUEST_ID AS [REQUEST_ID],EI.EMP_NAME AS [REQUESTED_BY], 
			CONVERT(VARCHAR(11),RM.REQUEST_DATE,113) AS [REQUEST_DATE],  
			CPM.PRODUCT_NAME AS [ITEM_NAME],PMM.MODEL_NAME AS [MODEL_NAME],  
			RM.MODEL_QUANTITY AS [QUANTITY],RM.ESTIMATED_TOTAL_PRICE AS [ESTIMATED_TOTAL_PRICE],  
			JM.JUSTIFICATION_NAME AS [JUSTIFICATION_REMARK],RM.USER_REMARK AS [USER_REMARK],  
			EI2.EMP_NAME AS [RECOMMENDED_BY],CONVERT(VARCHAR(11),RM.RECOMMENDED_DATETIME,113) AS [RECOMMENDED_ON],  
			EI3.EMP_NAME AS [APPROVED_BY],CONVERT(VARCHAR(11),RM.APPROVED_DATETIME,113) AS [APPROVED_ON],  
			EI3.EMAILADD AS [APPROVED_BY_EMAILADD],  
			EI.EMAILADD AS [REQUESTED_BY_EMAILADD]  
			FROM TBL_REQUESTMASTER RM  
			LEFT OUTER JOIN EMP_INFO EI ON RM.REQUESTED_BY = EI.EMP_NO  
			LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM ON RM.ITEM_CODE = CPM.PRODUCT_CODE  
			LEFT OUTER JOIN TBL_PRODUCTMODELMASTER PMM ON RM.MODEL_NO = PMM.MODEL_ID  
			LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RM.JUSTIFICATION_ID = JM.JUSTIFICATION_ID  
			LEFT OUTER JOIN EMP_INFO EI2 ON RM.RECOMMENDED_BY = EI2.EMP_NO  
			LEFT OUTER JOIN EMP_INFO EI3 ON RM.APPROVED_BY = EI3.EMP_NO  
			WHERE RM.REQUEST_ID = @REQUEST_ID  

			SELECT EMP_NO,EMP_NAME,DEPARTMENT,DESIGNATION,EMAILADD AS [HOD_EMAILADD]  
			FROM EMP_INFO 
			WHERE EMP_NO = (SELECT SENIOR   
			FROM EMP_INFO  
			WHERE EMP_NO = (SELECT REQUESTED_BY   
			FROM TBL_REQUESTMASTER  
			WHERE REQUEST_ID = @REQUEST_ID)
			)  							
			
			---- Send Mail---------
			
		SET @CCEMAILID	=  @REQUESTED_BY_EMAILADD + ',' + @HOD_EMAILADD 
		SET @TO 	= 'fatima.kazi@angelbroking.com'
		SET @COPY	= @CCEMAILID
		SET @FROM = 'ITasset@angelbroking.com'				
		SET @SUBJECT	= 'New ITAsset Request Request ID :' + CONVERT(CHAR(20),@REQUEST_ID) + ' has been Approved'
		SET @BODY ='<HTML><HEAD><TITLE>The following IT Asset Request has been Approved</TITLE><STYLE TYPE=text/css>
        .MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;}
        .MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;}
        .MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}
        </STYLE></HEAD><Body>Dear Fatima,
        <br>
        <p>Your following request has been approved </p><br>
        <center><table class=MyTable cellpadding=0 cellspacing=0 width=800>
        <caption>IT Assets Request Details</caption>
        <tr width=100><td> Request ID :- </td>
        <td> ' + CONVERT(CHAR(20),ISNULL(@REQUEST_ID,'')) + ' </td>
        <td> Requested By:- </td>
        <td>' + isnull(@REQUESTED_BY,'') +' </td> 
        <td> Request Date:- </td>
        <td>' + isnull(@REQUEST_DATE,'') + '</td></tr>
        <tr width=50><td> Item Name :-    </td>
        <td colspan=2>' + isnull(@ITEM_NAME,'') + ' </td>
        <td> Model Name :-      </td>
        <td colspan=2> ' + isnull(@MODEL_NAME,'') + ' </td></tr>
        <tr width=100><td> Quantity :-      </td>
        <td colspan=2> ' + CONVERT(CHAR(20),isnull(@QUANTITY,0)) + ' </td>
        <td> Estimated Price:-  </td>
        <td colspan=2> ' + CONVERT(VARCHAR(150),isnull(@ESTIMATED_TOTAL_PRICE,'')) + ' </td></tr>
        <tr width=150><td>Reason For Requirement:-  </td>
        <td colspan=5> ' + isnull(@JUSTIFICATION_REMARK,'') + '</td></tr>
        <tr width=100><td>User Remark:-  </td>
        <td colspan=5>' + isnull(@USER_REMARK,'') + ' </td></tr>
        <tr width=100><td> Recommended_By :-    </td>
        <td colspan=2>' + isnull(@RECOMMENDED_BY,'') + ' </td>
        <td> Recommended on :-      </td>
        <td colspan=2> ' + isnull(@RECOMMENDED_ON,'') + ' </td></tr>
        <tr width=100><td> Approved By :-    </td>
        <td colspan=2>' + isnull(@APPROVED_BY,'') + ' </td>
        <td> Approved on :-      </td>
        <td colspan=2> ' + isnull(@APPROVED_ON,'') + ' </td></tr>
        <tr width=100><td>Current Status:-  </td><td colspan=5> Approved </td></tr>
        </table></center><br><br>                
        <P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>
        Thanks & Regards,<br>IT Team </Body> </html>'	
        				
		--EXEC SP_SEND_CDOSYSMAIL @FROM, @TO, @COPY, @SUBJECT, @BODY
		
		print @BODY
						
		WAITFOR DELAY '00:00:05'

		EXEC msdb.dbo.sp_send_dbmail 

		@profile_name='ITAssets', 

		@recipients = @TO,

		@copy_recipients= @COPY, 

		@subject = @SUBJECT, 

		@body_format = 'HTML', 

		@body =@BODY 			
		
	END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AllMailDetails_bkp12Apr2013
-- --------------------------------------------------




  
CREATE Proc [dbo].[USP_AllMailDetails_bkp12Apr2013]  
(  
@Option varchar(50),  
@Request_Id int  
)   
  
As  
Begin  
 if(@Option = 'New_Request')  
  Begin  
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  
  
   select RM.Request_Id As [Request_Id],EI.Emp_Name As [Requested_By], Convert(varchar(11),RM.Request_Date,113) As [Request_Date],  
     CPM.Product_name As [Item_Name],PMM.Model_Name As [Model_Name],  
     RM.Model_Quantity As [Quantity],RM.Estimated_Total_Price As [Estimated_Total_Price],  
     JM.Justification_Name As [Justification_Remark],RM.User_remark As [User_Remark],  
     EI2.emailadd As [Requested_By_EmailAdd]  
    from tbl_RequestMaster RM  
    Left Outer Join Emp_Info EI on RM.Requested_By = EI.Emp_No  
    Left Outer Join tbl_CapexProductMaster CPM on RM.Item_Code = CPM.Product_Code  
    Left Outer Join tbl_ProductModelMaster PMM on RM.Model_No = PMM.Model_Id  
    Left Outer Join tbl_JustificationMaster JM on RM.Justification_Id = JM.Justification_Id  
    Left Outer Join Emp_Info EI2 on RM.Requested_By = EI2.Emp_no  
   Where RM.Request_Id = @Request_Id  
  
   Select Emp_No,Emp_Name,Department,Designation,EmailAdd As [HOD_EmailAdd]  
    from emp_info where emp_no = (Select Senior   
             from emp_info  
             Where emp_no = (Select Requested_by   
                 from tbl_RequestMaster  
                  Where Request_Id = @Request_Id)  
          )  
  
  
  End  
  
 Else if(@Option = 'After_Recommendation')  
  Begin  
  
   select RM.Request_Id As [Request_Id],EI.Emp_Name As [Requested_By], Convert(varchar(11),RM.Request_Date,113) As [Request_Date],  
     CPM.Product_name As [Item_Name],PMM.Model_Name As [Model_Name],  
     RM.Model_Quantity As [Quantity],RM.Estimated_Total_Price As [Estimated_Total_Price],  
     JM.Justification_Name As [Justification_Remark],RM.User_remark As [User_Remark],  
     EI2.Emp_Name As [Recommended_By],Convert(varchar(11),RM.Recommended_Datetime,113)As [Recommended_On],  
     EI2.emailadd As [Recommended_By_EmailAdd],  
     EI3.emailadd As [Requested_By_EmailAdd]  
       
    from tbl_RequestMaster RM  
    Left Outer Join Emp_Info EI on RM.Requested_By = EI.Emp_No  
    Left Outer Join tbl_CapexProductMaster CPM on RM.Item_Code = CPM.Product_Code  
    Left Outer Join tbl_ProductModelMaster PMM on RM.Model_No = PMM.Model_Id  
    Left Outer Join tbl_JustificationMaster JM on RM.Justification_Id = JM.Justification_Id  
    Left Outer Join Emp_Info EI2 on RM.Recommended_By = EI2.Emp_No  
    Left Outer Join Emp_Info EI3 on RM.Requested_By = EI3.Emp_No  
      
   Where RM.Request_Id = @Request_Id  
  
   Select Emp_No,Emp_Name,Department,Designation,EmailAdd As [HOD_EmailAdd]  
    from emp_info where emp_no = (Select Senior   
             from emp_info  
             Where emp_no = (Select Requested_by   
                 from tbl_RequestMaster  
                  Where Request_Id = @Request_Id)  
          )  
  
  
  
  End  
  
 Else if (@Option = 'After_Approval')  
  Begin  
  
   select RM.Request_Id As [Request_Id],EI.Emp_Name As [Requested_By], Convert(varchar(11),RM.Request_Date,113) As [Request_Date],  
     CPM.Product_name As [Item_Name],PMM.Model_Name As [Model_Name],  
     RM.Model_Quantity As [Quantity],RM.Estimated_Total_Price As [Estimated_Total_Price],  
     JM.Justification_Name As [Justification_Remark],RM.User_remark As [User_Remark],  
     EI2.Emp_Name As [Recommended_By],Convert(varchar(11),RM.Recommended_Datetime,113) As [Recommended_On],  
     EI3.Emp_Name As [Approved_By],Convert(varchar(11),RM.Approved_Datetime,113) As [Approved_On],  
     EI3.emailadd As [Approved_By_EmailAdd],  
     EI.emailadd As [Requested_By_EmailAdd]  
    from tbl_RequestMaster RM  
    Left Outer Join Emp_Info EI on RM.Requested_By = EI.Emp_No  
    Left Outer Join tbl_CapexProductMaster CPM on RM.Item_Code = CPM.Product_Code  
    Left Outer Join tbl_ProductModelMaster PMM on RM.Model_No = PMM.Model_Id  
    Left Outer Join tbl_JustificationMaster JM on RM.Justification_Id = JM.Justification_Id  
    Left Outer Join Emp_Info EI2 on RM.Recommended_By = EI2.Emp_No  
    Left Outer Join Emp_Info EI3 on RM.Approved_by = EI3.Emp_No  
   Where RM.Request_Id = @Request_Id  
  
   Select Emp_No,Emp_Name,Department,Designation,EmailAdd As [HOD_EmailAdd]  
    from emp_info where emp_no = (Select Senior   
             from emp_info  
             Where emp_no = (Select Requested_by   
                 from tbl_RequestMaster  
                  Where Request_Id = @Request_Id)  
          )  
  
  End  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AllMailDetails29Nov2018
-- --------------------------------------------------
CREATE PROC [dbo].[USP_AllMailDetails29Nov2018]  
(  
@OPTION VARCHAR(50),  
@REQUEST_ID INT  
)   
AS  
BEGIN  


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
	DECLARE @FROM VARCHAR(4000), @TO VARCHAR(4000),@COPY VARCHAR(1000),@SUBJECT VARCHAR(500),@CCEmailID varchar(1000),@BODY VARCHAR(8000) 
	DECLARE @REQUESTED_BY_EMAILADD AS VARCHAR(100)
	DECLARE @HOD_EMAILADD AS VARCHAR(100)			
	DECLARE @REQUESTED_BY VARCHAR(50)
	DECLARE @REQUEST_DATE VARCHAR(15)
	DECLARE @ITEM_NAME VARCHAR(50)
	DECLARE @MODEL_NAME VARCHAR(50)
	DECLARE @QUANTITY VARCHAR(50)
	DECLARE @ESTIMATED_TOTAL_PRICE VARCHAR(50)
	DECLARE @JUSTIFICATION_REMARK VARCHAR(50)
	DECLARE @USER_REMARK VARCHAR(50)
	DECLARE @RECOMMENDED_BY VARCHAR(50)
	DECLARE @RECOMMENDED_ON VARCHAR(50)
	DECLARE @APPROVED_BY VARCHAR(50)
	DECLARE @APPROVED_ON VARCHAR(50)

	DECLARE @CATEGORY CHAR(10)      
	DECLARE @BRANCHCODE CHAR(20)      
	DECLARE @U_ROLE CHAR(100)      
	DECLARE @ESTIMATED_TOTAL_PRICE_1 FLOAT      
	DECLARE @RECOMMENDERLIST NVARCHAR(MAX)      
	DECLARE @APPROVERLIST NVARCHAR(MAX)  
	DECLARE @USER_ID CHAR(20)
	
	
	
	SELECT @HOD_EMAILADD =  EMAILADD FROM EMP_INFO WHERE EMP_NO = 
							(SELECT SENIOR FROM EMP_INFO WHERE EMP_NO = 
							(SELECT REQUESTED_BY FROM TBL_REQUESTMASTER
							WHERE REQUEST_ID = @REQUEST_ID)
							)
					
	SELECT @USER_ID =EI.EMP_NO ,@Requested_By = EI.EMP_NAME ,@Request_Date=CONVERT(VARCHAR(11),RM.REQUEST_DATE,113),
	@Item_Name =CPM.PRODUCT_NAME ,@Model_Name = PMM.MODEL_NAME ,  
	@Quantity = RM.MODEL_QUANTITY ,@Estimated_Total_Price =RM.ESTIMATED_TOTAL_PRICE ,  
	@Justification_Remark =JM.JUSTIFICATION_NAME ,@User_Remark =RM.USER_REMARK ,  
	@Recommended_By = EI2.EMP_NAME ,@Recommended_On = CONVERT(VARCHAR(11),RM.RECOMMENDED_DATETIME,113) ,  
	@Approved_By = EI3.EMP_NAME ,@Approved_On = CONVERT(VARCHAR(11),RM.APPROVED_DATETIME,113),				 
	@REQUESTED_BY_EMAILADD = EI.EMAILADD 
	FROM TBL_REQUESTMASTER RM  
	LEFT OUTER JOIN EMP_INFO EI ON RM.REQUESTED_BY = EI.EMP_NO  
	LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM ON RM.ITEM_CODE = CPM.PRODUCT_CODE  
	LEFT OUTER JOIN TBL_PRODUCTMODELMASTER PMM ON RM.MODEL_NO = PMM.MODEL_ID  
	LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RM.JUSTIFICATION_ID = JM.JUSTIFICATION_ID  
	LEFT OUTER JOIN EMP_INFO EI2 ON RM.RECOMMENDED_BY = EI2.EMP_NO  
	LEFT OUTER JOIN EMP_INFO EI3 ON RM.APPROVED_BY = EI3.EMP_NO  
	WHERE RM.REQUEST_ID = @REQUEST_ID 	
	
	SET @BRANCHCODE=(SELECT BRANCH_CD FROM EMP_INFO WHERE EMP_NO =@USER_ID)      
	IF(@BRANCHCODE IN (SELECT BRANCH_CD FROM TBL_CSO_BRANCH(NOLOCK)))      
	BEGIN      
	SET @CATEGORY='CSO'      
	END      
	ELSE      
	BEGIN      
	SET @CATEGORY='BRANCH'
	END
		
	SET @U_ROLE=(SELECT DESIGNATION FROM EMP_INFO WHERE EMP_NO=@USER_ID AND STATUS='A') 
	IF(@U_ROLE NOT IN ('REGIONAL HEAD','REGIONAL MANAGER','ZONAL HEAD','ZONAL MANAGER','ASSOCIATE DIRECTOR',' SR. ASSISTANT VICE PRESIDENT','HEAD'))      
	BEGIN      
	SET @U_ROLE='USER'      
	END 	
	
	SET @ESTIMATED_TOTAL_PRICE_1 = (SELECT ESTIMATED_TOTAL_PRICE FROM TBL_REQUESTMASTER WHERE REQUEST_ID = @REQUEST_ID)      
       
	SET @RECOMMENDERLIST = (SELECT SUBSTRING( ( SELECT ', ' + RTRIM(U_ROLE)       
		FROM TBL_RECOMMENDATION_LIMITMASTER       
		WHERE @ESTIMATED_TOTAL_PRICE_1 BETWEEN REC_LIMITFROM AND REC_LIMITTO AND CATEGORY = @CATEGORY       
		 FOR XML PATH(''), ELEMENTS),2,500))          
	SET @APPROVERLIST = (SELECT SUBSTRING( ( SELECT ', ' + RTRIM(U_ROLE)       
		FROM TBL_APPROVAL_LIMITMASTER      
		WHERE @ESTIMATED_TOTAL_PRICE_1 BETWEEN APR_LIMITFROM AND APR_LIMITTO AND CATEGORY = @CATEGORY       
		FOR XML PATH(''), ELEMENTS),2,500))    
	SET @APPROVERLIST = (SELECT REPLACE (@APPROVERLIST,'HEAD','HEAD-IT'))      
      


IF(@OPTION = 'NEW_REQUEST')  
	BEGIN    
		SELECT RM.REQUEST_ID AS [REQUEST_ID],EI.EMP_NAME AS [REQUESTED_BY], CONVERT(VARCHAR(11),RM.REQUEST_DATE,113) AS [REQUEST_DATE],  
		CPM.PRODUCT_NAME AS [ITEM_NAME],PMM.MODEL_NAME AS [MODEL_NAME],  
		RM.MODEL_QUANTITY AS [QUANTITY],RM.ESTIMATED_TOTAL_PRICE AS [ESTIMATED_TOTAL_PRICE],  
		JM.JUSTIFICATION_NAME AS [JUSTIFICATION_REMARK],RM.USER_REMARK AS [USER_REMARK],  
		EI2.EMAILADD AS [REQUESTED_BY_EMAILADD]  
		FROM TBL_REQUESTMASTER RM  
		LEFT OUTER JOIN EMP_INFO EI ON RM.REQUESTED_BY = EI.EMP_NO  
		LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM ON RM.ITEM_CODE = CPM.PRODUCT_CODE  
		LEFT OUTER JOIN TBL_PRODUCTMODELMASTER PMM ON RM.MODEL_NO = PMM.MODEL_ID  
		LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RM.JUSTIFICATION_ID = JM.JUSTIFICATION_ID  
		LEFT OUTER JOIN EMP_INFO EI2 ON RM.REQUESTED_BY = EI2.EMP_NO  
		WHERE RM.REQUEST_ID = @REQUEST_ID  

		SELECT EMP_NO,EMP_NAME,DEPARTMENT,DESIGNATION,EMAILADD AS [HOD_EMAILADD]  
		FROM EMP_INFO WHERE EMP_NO = (SELECT SENIOR   
		FROM EMP_INFO  
		WHERE EMP_NO = (SELECT REQUESTED_BY   
		FROM TBL_REQUESTMASTER  
		WHERE REQUEST_ID = @REQUEST_ID)  
		)  
	

		---- Send Mail---------
	
		SET @CCEMAILID	=   @HOD_EMAILADD + ',' + 'fatima.kazi@angelbroking.com' 
		SET @FROM = 'ITasset@angelbroking.com'
		SET @TO 	=	@REQUESTED_BY_EMAILADD 				
		SET @COPY	= @CCEMAILID
		SET @SUBJECT	= 'New ITAsset Request Confirmation Request ID :' + Convert(Varchar(20),@REQUEST_ID)
		SET @BODY ='<HTML><HEAD><TITLE>This is an acknowledge mail for your new IT Assets request</TITLE><STYLE TYPE=text/css>
		.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;
 text-align: left; height: 18px;}
		.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;}
		.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}
		</STYLE></HEAD><Body>		
		Dear  '+ Isnull(@REQUESTED_BY,'') +'
        <br>                    
        <p>Management has finalized an Authorization Policy for approval of various expenses based on the amount<br> and the purpose for which they are incurred.</p><br>
        <p>According the new policy every request should get first recommend from users departmental or business<br> head and then get approve by IT Management Team.</p><br><br>                   
        <center><table class=MyTable cellpadding=0 cellspacing=0 width=600><caption>IT Assets Request Details</caption>
        <tr width=100><td> Request ID :- </td>
        <td> ' + CONVERT(CHAR(20),@REQUEST_ID) + ' </td>
        <td> Requested By:- </td>
        <td> ' + isnull(@REQUESTED_BY,'') + ' </td>
        <td> Request Date:- </td>
        <td>' + isnull(@REQUEST_DATE,'') + '</td>
        </tr>
        <tr width=50><td> Item Name :-    </td>
        <td colspan=2>' + isnull(@ITEM_NAME,'') + ' </td>
        <td> Model Name :-      </td>
        <td colspan=2> ' + isnull(@MODEL_NAME,'') + ' </td></tr>
        <tr width=100><td> Quantity :-  </td>
        <td colspan=2> ' + CONVERT(CHAR(20),isnull(@QUANTITY,0)) + ' </td>
        <td> Estimated Price:-  </td>
        <td colspan=2> ' + CONVERT(VARCHAR(150),isnull(@ESTIMATED_TOTAL_PRICE,0)) + ' </td></tr>
        <tr width=150><td>Reason For Requirement:-  </td>
        <td colspan=5> ' + isnull(@JUSTIFICATION_REMARK,'') + ' </td></tr>
        <tr width=100><td>User Remark:- </td>
        <td colspan=5>' + isnull(@USER_REMARK,'') + ' </td></tr>
        <tr width=100><td>Current Status:-</td>
        <td colspan=5> Pending For Recommendation </td></tr>
        </table></center><br><br>                    
        <p>As per amount of your request following are details of approvals require</p><br>
        <center><table class=MyTable cellpadding=0 cellspacing=0 width=600><caption></caption>
        <tr width=100><td> Request Initiated By </td>
        <td> Requested Items Amount </td> 
        <td> Who Can Recommend </td>
        <td> Who Can Approve </td></tr>
        <tr>
        <td> '+ isnull(@U_Role,'') +' </td>
        <td> ' + CONVERT(VARCHAR(150),isnull(@ESTIMATED_TOTAL_PRICE_1,0)) + ' </td>
        <td>' + isnull(@RecommenderList,'') + '</td>
        <td>' + isnull(@ApproverList,'') + '</td>
        </tr>
        </table></center><br><br>
        </table></center> <br><br>
        <p> For further clarification on approval policy click me, and for any assistance call us at or write us at</p><br>
        <P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>
        Thanks & Regards,<br>IT Team </Body> </html>'

	--	EXEC SP_SEND_CDOSYSMAIL @FROM, @TO, @COPY, @SUBJECT, @BODY
	
	EXEC msdb.dbo.sp_send_dbmail 

		@profile_name='ITAssets', 

		@recipients = @TO,

		@copy_recipients= @COPY, 

		@subject = @SUBJECT, 

		@body_format = 'HTML', 

		@body =@BODY 


END  

	ELSE IF(@OPTION = 'AFTER_RECOMMENDATION')  
		BEGIN  
			SELECT RM.REQUEST_ID AS [REQUEST_ID],EI.EMP_NAME AS [REQUESTED_BY], CONVERT(VARCHAR(11),RM.REQUEST_DATE,113) AS [REQUEST_DATE],  
			CPM.PRODUCT_NAME AS [ITEM_NAME],PMM.MODEL_NAME AS [MODEL_NAME],  
			RM.MODEL_QUANTITY AS [QUANTITY],RM.ESTIMATED_TOTAL_PRICE AS [ESTIMATED_TOTAL_PRICE],  
			JM.JUSTIFICATION_NAME AS [JUSTIFICATION_REMARK],RM.USER_REMARK AS [USER_REMARK],  
			EI2.EMP_NAME AS [RECOMMENDED_BY],CONVERT(VARCHAR(11),RM.RECOMMENDED_DATETIME,113)AS [RECOMMENDED_ON],  
			EI2.EMAILADD AS [RECOMMENDED_BY_EMAILADD],  
			EI3.EMAILADD AS [REQUESTED_BY_EMAILADD]
			FROM TBL_REQUESTMASTER RM  
			LEFT OUTER JOIN EMP_INFO EI ON RM.REQUESTED_BY = EI.EMP_NO  
			LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM ON RM.ITEM_CODE = CPM.PRODUCT_CODE  
			LEFT OUTER JOIN TBL_PRODUCTMODELMASTER PMM ON RM.MODEL_NO = PMM.MODEL_ID  
			LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RM.JUSTIFICATION_ID = JM.JUSTIFICATION_ID  
			LEFT OUTER JOIN EMP_INFO EI2 ON RM.RECOMMENDED_BY = EI2.EMP_NO  
			LEFT OUTER JOIN EMP_INFO EI3 ON RM.REQUESTED_BY = EI3.EMP_NO 
			WHERE RM.REQUEST_ID = @REQUEST_ID  

			SELECT EMP_NO,EMP_NAME,DEPARTMENT,DESIGNATION,EMAILADD AS [HOD_EMAILADD]  
			FROM EMP_INFO WHERE EMP_NO = (SELECT SENIOR   
			FROM EMP_INFO  
			WHERE EMP_NO = (SELECT REQUESTED_BY   
			FROM TBL_REQUESTMASTER  
			WHERE REQUEST_ID = @REQUEST_ID)  
			)
		END
		ELSE IF (@OPTION = 'AFTER_APPROVAL')
		BEGIN  
			SELECT RM.REQUEST_ID AS [REQUEST_ID],EI.EMP_NAME AS [REQUESTED_BY], 
			CONVERT(VARCHAR(11),RM.REQUEST_DATE,113) AS [REQUEST_DATE],  
			CPM.PRODUCT_NAME AS [ITEM_NAME],PMM.MODEL_NAME AS [MODEL_NAME],  
			RM.MODEL_QUANTITY AS [QUANTITY],RM.ESTIMATED_TOTAL_PRICE AS [ESTIMATED_TOTAL_PRICE],  
			JM.JUSTIFICATION_NAME AS [JUSTIFICATION_REMARK],RM.USER_REMARK AS [USER_REMARK],  
			EI2.EMP_NAME AS [RECOMMENDED_BY],CONVERT(VARCHAR(11),RM.RECOMMENDED_DATETIME,113) AS [RECOMMENDED_ON],  
			EI3.EMP_NAME AS [APPROVED_BY],CONVERT(VARCHAR(11),RM.APPROVED_DATETIME,113) AS [APPROVED_ON],  
			EI3.EMAILADD AS [APPROVED_BY_EMAILADD],  
			EI.EMAILADD AS [REQUESTED_BY_EMAILADD]  
			FROM TBL_REQUESTMASTER RM  
			LEFT OUTER JOIN EMP_INFO EI ON RM.REQUESTED_BY = EI.EMP_NO  
			LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM ON RM.ITEM_CODE = CPM.PRODUCT_CODE  
			LEFT OUTER JOIN TBL_PRODUCTMODELMASTER PMM ON RM.MODEL_NO = PMM.MODEL_ID  
			LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RM.JUSTIFICATION_ID = JM.JUSTIFICATION_ID  
			LEFT OUTER JOIN EMP_INFO EI2 ON RM.RECOMMENDED_BY = EI2.EMP_NO  
			LEFT OUTER JOIN EMP_INFO EI3 ON RM.APPROVED_BY = EI3.EMP_NO  
			WHERE RM.REQUEST_ID = @REQUEST_ID  

			SELECT EMP_NO,EMP_NAME,DEPARTMENT,DESIGNATION,EMAILADD AS [HOD_EMAILADD]  
			FROM EMP_INFO 
			WHERE EMP_NO = (SELECT SENIOR   
			FROM EMP_INFO  
			WHERE EMP_NO = (SELECT REQUESTED_BY   
			FROM TBL_REQUESTMASTER  
			WHERE REQUEST_ID = @REQUEST_ID)
			)  							
			
			---- Send Mail---------
			
		SET @CCEMAILID	=  @REQUESTED_BY_EMAILADD + ',' + @HOD_EMAILADD 
		SET @TO 	= 'fatima.kazi@angelbroking.com'
		SET @COPY	= @CCEMAILID
		SET @FROM = 'ITasset@angelbroking.com'				
		SET @SUBJECT	= 'New ITAsset Request Request ID :' + CONVERT(CHAR(20),@REQUEST_ID) + ' has been Approved'
		SET @BODY ='<HTML><HEAD><TITLE>The following IT Asset Request has been Approved</TITLE><STYLE TYPE=text/css>
        .MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #e
fefef; text-align: left; height: 18px;}
        .MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;}
        .MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}
        </STYLE></HEAD><Body>Dear Fatima,
        <br>
        <p>Your following request has been approved </p><br>
        <center><table class=MyTable cellpadding=0 cellspacing=0 width=800>
        <caption>IT Assets Request Details</caption>
        <tr width=100><td> Request ID :- </td>
        <td> ' + CONVERT(CHAR(20),ISNULL(@REQUEST_ID,'')) + ' </td>
        <td> Requested By:- </td>
        <td>' + isnull(@REQUESTED_BY,'') +' </td> 
        <td> Request Date:- </td>
        <td>' + isnull(@REQUEST_DATE,'') + '</td></tr>
        <tr width=50><td> Item Name :-    </td>
        <td colspan=2>' + isnull(@ITEM_NAME,'') + ' </td>
        <td> Model Name :-      </td>
        <td colspan=2> ' + isnull(@MODEL_NAME,'') + ' </td></tr>
        <tr width=100><td> Quantity :-      </td>
        <td colspan=2> ' + CONVERT(CHAR(20),isnull(@QUANTITY,0)) + ' </td>
        <td> Estimated Price:-  </td>
        <td colspan=2> ' + CONVERT(VARCHAR(150),isnull(@ESTIMATED_TOTAL_PRICE,'')) + ' </td></tr>
        <tr width=150><td>Reason For Requirement:-  </td>
        <td colspan=5> ' + isnull(@JUSTIFICATION_REMARK,'') + '</td></tr>
        <tr width=100><td>User Remark:-  </td>
        <td colspan=5>' + isnull(@USER_REMARK,'') + ' </td></tr>
        <tr width=100><td> Recommended_By :-    </td>
        <td colspan=2>' + isnull(@RECOMMENDED_BY,'') + ' </td>
        <td> Recommended on :-      </td>
        <td colspan=2> ' + isnull(@RECOMMENDED_ON,'') + ' </td></tr>
        <tr width=100><td> Approved By :-    </td>
        <td colspan=2>' + isnull(@APPROVED_BY,'') + ' </td>
        <td> Approved on :-      </td>
        <td colspan=2> ' + isnull(@APPROVED_ON,'') + ' </td></tr>
        <tr width=100><td>Current Status:-  </td><td colspan=5> Approved </td></tr>
        </table></center><br><br>                
        <P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>
        Thanks & Regards,<br>IT Team </Body> </html>'	
        				
		--EXEC SP_SEND_CDOSYSMAIL @FROM, @TO, @COPY, @SUBJECT, @BODY
		
		print @BODY
						
		WAITFOR DELAY '00:00:05'

		EXEC msdb.dbo.sp_send_dbmail 

		@profile_name='ITAssets', 

		@recipients = @TO,

		@copy_recipients= @COPY, 

		@subject = @SUBJECT, 

		@body_format = 'HTML', 

		@body =@BODY 			
		
	END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ApprovalOther
-- --------------------------------------------------
/*
USP_ApprovalOther 'BRANCH','A','E39377'

*/

CREATE Procedure [dbo].[USP_ApprovalOther]    
(@Accesscode char(25),@Type varchar(5),@UserID varchar(15))     
As    
    
Begin  


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  
Declare @Query as nvarchar(max)    
    
    
    
set @Query= 'select  Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],A.Estimated_Total_Price as[Estimated_Total_Price],D.Emp_Name As [Requested_By],D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],D.Department As[Department],D.Sr_Name As[HOD],A.User_Remark As [User_Remark],f.Remark as [Review Remark],f.ReviewDate as [Review Date] --,F.Status_Name As [Status_Name]    
                  from tbl_RequestMaster A    
                        Left Outer Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code     
                        Left Outer Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id     
                        inner join     
      (Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info     
       UNION ALL     
      Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D    
       on A.Requested_By = D.emp_no    
      Left Outer Join tbl_RequestRecApr E on A.Request_Id = E.Request_Id    
         inner join Tbl_ReviewRemarks F on A.Request_Id = F.Request_Id  
     where E.Emp_Code = '''+@UserID+''' And E.Role = ''OA''     
      and ISNULL(A.Approved_By,'''') <> '''+ @UserID +''' and      
      A.Status_Code in (''R'',''L1A'',''P'') and E.Emp_Code <> A.Requested_By ' 
    
if ( @Type='A')    
 begin     
  if(@Accesscode='Branch')    
    
   Begin    
    Set @Query = @Query + ' And D.Branch_Cd not in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'       
    Print(@Query)    
    Exec(@Query)      
    
   End    
    
    else if(@AccessCode='CSO')    
    Begin    
    Set @Query = @Query + ' And D.Branch_Cd  in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'       
    Print(@Query)    
    Exec(@Query)     
    End    
    
  End    
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ApprovalOther_bk_29Dec2017
-- --------------------------------------------------

create Procedure [dbo].[USP_ApprovalOther_bk_29Dec2017]    
(@Accesscode char(25),@Type varchar(5),@UserID varchar(15))     
As    
    
Begin  


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  
Declare @Query as nvarchar(max)    
    
    
    
set @Query= 'select  Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],A.Estimated_Total_Price as[Estimated_Total_Price],D.Emp_Name As [Requested_By],D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],D.Department As[Department],D.Sr_Name As[HOD],A.User_Remark As [User_Remark]--,F.Status_Name As [Status_Name]    
                  from tbl_RequestMaster A    
                        Left Outer Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code     
                        Left Outer Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id     
                        inner join     
      (Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info     
       UNION ALL     
      Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D    
       on A.Requested_By = D.emp_no    
      Left Outer Join tbl_RequestRecApr E on A.Request_Id = E.Request_Id    
     where E.Emp_Code = '''+@UserID+''' And E.Role = ''OA''     
      and ISNULL(A.Approved_By,'''') <> '''+ @UserID +''' and      
      A.Status_Code in (''R'',''L1A'',''P'') and E.Emp_Code <> A.Requested_By ' 
    
if ( @Type='A')    
 begin     
  if(@Accesscode='Branch')    
    
   Begin    
    Set @Query = @Query + ' And D.Branch_Cd not in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'       
    Print(@Query)    
    Exec(@Query)      
    
   End    
    
    else if(@AccessCode='CSO')    
    Begin    
    Set @Query = @Query + ' And D.Branch_Cd  in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'       
    Print(@Query)    
    Exec(@Query)     
    End    
    
  End    
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AssestMasterAdd_Edit_Delete
-- --------------------------------------------------













CREATE Proc [dbo].[USP_AssestMasterAdd_Edit_Delete]
(
@option char(20),
@ProductCode char(20),
@ProductName varchar(200),
@CapexCode varchar(200),
@Userid char(20)
)

As
Declare @CapexType varchar(200)
set @CapexType= (Select distinct (Capex_type) from tbl_CapexMaster where Capex_Code=@CapexCode)

Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
	if(@option = 'Add')
		Begin
			Insert into tbl_CapexProductMaster(Capex_Code,Product_Code,Product_Name,vendor_code,Flag,Added_By,Added_On,Modified_By,Modified_Date)
			values (@CapexCode,@ProductCode,@ProductName,'','1',@Userid,getdate(),@Userid,getdate())
			
			
			----------Make An entry in log----------
			INSERT INTO tbl_CapexProductMaster_Log(Capex_Code,Product_Code,Product_Name,vendor_code,Flag,
													Added_By,Added_On,Modified_By,Modified_Date)
			SELECT Capex_Code,Product_Code,Product_Name,vendor_code,Flag,Added_By,Added_On,
					Modified_By,Modified_Date
			FROM tbl_CapexProductMaster
			WHERE Product_Code = @ProductCode
			------------------------------------				
			
			
		End
	else if (@option = 'Edit')
		Begin
			update tbl_CapexProductMaster
				set Product_Name=@ProductName,	
					Capex_code=@CapexCode,
					Modified_By=@Userid,
					Modified_Date=getdate()
			Where Product_Code=@ProductCode
			
			
			----------Make An entry in log----------
			INSERT INTO tbl_CapexProductMaster_Log(Capex_Code,Product_Code,Product_Name,vendor_code,Flag,
													Added_By,Added_On,Modified_By,Modified_Date)
			SELECT Capex_Code,Product_Code,Product_Name,vendor_code,Flag,Added_By,Added_On,
					Modified_By,Modified_Date
			FROM tbl_CapexProductMaster
			WHERE Product_Code = @ProductCode
			------------------------------------				
			
			
						
		End
	else if (@option = 'Delete')
		Begin
			update tbl_CapexProductMaster
				set Flag='false',
					Modified_By=@Userid,
					Modified_Date=getdate()
			Where Product_Code=@ProductCode
			
			
			----------Make An entry in log----------
			INSERT INTO tbl_CapexProductMaster_Log(Capex_Code,Product_Code,Product_Name,vendor_code,Flag,
													Added_By,Added_On,Modified_By,Modified_Date)
			SELECT Capex_Code,Product_Code,Product_Name,vendor_code,Flag,Added_By,Added_On,
					Modified_By,Modified_Date
			FROM tbl_CapexProductMaster
			WHERE Product_Code = @ProductCode
			------------------------------------				
						
		End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AssestMasterDetails
-- --------------------------------------------------






CREATE Proc [dbo].[USP_AssestMasterDetails] 
(
@ProductCode char(20),
@CapexCode varchar(200)

)
As
Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

declare @Query nvarchar(max)

Set @Query = 'select CPM.Product_code As [Product Code],CPM.Product_Name As [Product Name],
			CPM.Capex_Code As [Capex Code],CM.Capex_Type As [Capex Type],VM.VendorName As [Vendor Name],
			EI.Emp_Name As [Added By],CPM.Added_On As [Added On], [Status] = CASE CPM.Flag
																				WHEN ''1'' THEN ''Active''
																				WHEN ''2'' THEN ''Disable''
																				END
										
			From tbl_CapexProductMaster	CPM
				Left Outer join tbl_CapexMaster CM on CPM.Capex_code=CM.Capex_Code
				Left outer join	tbl_it_vendormaster VM on CPM.Vendor_Code=VM.VendorCode
				Left Outer Join Emp_Info EI on CPM.Added_by = EI.Emp_No
			 where 1=1'
				


if(@ProductCode <>'')
set @Query = @Query+' And CPM.Product_code='''+@ProductCode+''' '

if(@CapexCode <>'')
set @Query = @Query+' And CPM.Capex_Code='''+@CapexCode+''' '

set @Query=@Query+' order by CPM.Product_code'

Exec (@Query)

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AssestMasterFilldetails
-- --------------------------------------------------





CREATE Proc [dbo].[USP_AssestMasterFilldetails]
(
@option char(20),
@ProductCode char(50)
)
As
Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

	if(@option='Item name')
		Begin

			select distinct Product_Name,Product_code
			from tbl_CapexProductMaster
			where Product_Name is not null and Product_Name <>'' and flag='1'
		End

	else if (@option = 'Capex Type')
		Begin

			select distinct Capex_Type,Capex_Code
			from tbl_CapexMaster
			where Capex_Type is not null and Capex_Type <> '' and flag='1'
		End
				 
	else if (@option = 'CapexTypeProductCode')
		Begin

			select Product_Code,Product_Name,Capex_Code
			from tbl_CapexProductMaster
			where Product_Code=@ProductCode and flag='1'


		end
		
	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_BillInfo
-- --------------------------------------------------






--[Usp_BillInfo] '''25'',''24'',''8''','E03446'
--
--[Usp_BillInfo]'''47''','E03446'

CREATE  Procedure [dbo].[Usp_BillInfo]
(
@Request_Id  nvarchar(max),
@UserName char(10)
)
as    
Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 



declare @total_price as float 
--Declare @Query nvarchar(max)
--Set @Query = '
select RPO.Fld_PurchaseOrderNo As [Purchase_Order_No],RPO.Fld_vendorId As [Vendor_Id],
					VM.VendorName As [Vendor_Name],VM.Address1,VM.Address2,VM.Address3,
					RPO.Fld_shipTo As [Ship_To],AGC.CompId AS [compId],AGC.compName As [compName],
					RPO.Fld_ShippingMethod As [Shipping_Method],RPO.Fld_OrderTerms As [Order_Terms],
					RPO.POBranch As [PO_Branch],
					RPO.PODeliveryTime As [PODelivery_time]
			from  tbl_itrequestpurchaseorder RPO
					Left Outer Join tbl_it_Vendormaster VM on RPO.Fld_vendorId = VM.VendorCode
					Left outer join tbl_it_AngelGroupOfCompaniesMaster AGC on AGC.compId = RPO.Fld_CompId
			where Fld_RequestId = @Request_Id 

--Print(@Query)
--Exec(@Query)
--where Fld_RequestId = '''25'',''24'',''8'''
--------------------old----------------------------
--select top 1 * into #temp From tbl_Stockinventorydetails Where Request_Id=@Request_Id and Assign_Type='PO'
--
--
--set @total_price= 0.0
--set @total_price=@total_price+((select Unit_Price from #temp)*(select  count (*)  from tbl_stockinventorydetails where request_id=@Request_Id and Assign_Type='PO'))
--
--select CPM.Product_Name As [Product_Name],TEMP.warranty_Type As [Warranty_Type],PMM.Model_Name As [Model],
--		TEMP.Product_desc As [Product_Description],TEMP.Part_No As [Part_No],
--	(select  count (*)  from tbl_stockinventorydetails where request_id=@Request_Id and Assign_Type='PO')As [Quantity],
--	 TEMP.Unit_Price  As [Unit_Price],@total_price As [Total_Price]
--from #temp TEMP
--Left Outer Join tbl_capexproductmaster CPM on  TEMP.Product_Code = CPM.Product_code
--Left outer join tbl_productmodelmaster PMM on TEMP.Model_Id = PMM.Model_Id


------------------------------old--------------------------

-----reference-------------------
--select request_id,product_code,product_desc,part_no,warranty_type,unit_price,sum(unit_price) as "Total Price",count(request_id)as 'Total Quantity',Assign_Type from tbl_Stockinventorydetails
--group by request_id,product_code,product_desc,part_no,warranty_type,unit_price,Assign_Type
--having request_id = '1010' and Assign_Type='PO'
-----------------------------------



--------------------New Way Without Top 1---------------------------
--select the necessary fields along with summantion of unit price as total price of EACH Request
Declare @Query2 nvarchar(max)
Set @Query2 = 'select SID.Request_Id As [Request_Id],CPM.Product_Name As [Product_Name],
					SID.warranty_Type As [Warranty_Type],PMM.Model_Name As [Model],
					SID.Product_desc As [Product_Description],SID.Part_No As [Part_No],
					count (SID.Request_Id)As [Quantity],SID.Unit_price,
					sum (SID.Unit_Price) As [Total_Price],SID.Assign_Type 
			from tbl_Stockinventorydetails SID
			Left Outer Join tbl_capexproductmaster CPM on  SID.Product_Code = CPM.Product_code
			Left outer join tbl_productmodelmaster PMM on SID.Model_Id = PMM.Model_Id
			group by SID.Request_Id,CPM.Product_Name,SID.warranty_Type,PMM.Model_Name,SID.Product_desc,SID.Part_No,
					SID.Assign_Type,SID.Unit_Price
			having SID.request_id in ('+@Request_Id+') and SID.Assign_Type=''PO'''

Print (@Query2)
Exec(@Query2)







----Then Add The Total Unit Price of EACH Individual request As The Complete SUB TOTAL

Declare @Query3 nvarchar(max)
Set @Query3 = 'select sum([Total_Unit_Price]) as [Sub_Total] 
				from 
					(select SID.Request_Id As [Request_Id],sum(SID.Unit_Price) As [Total_Unit_Price],
							SID.Assign_Type 
					from tbl_Stockinventorydetails SID
					group by SID.Request_Id,SID.Assign_Type
					having SID.request_id in('+@Request_Id+') and SID.Assign_Type=''PO'') a '
Print (@Query3)
Exec(@Query3)

-----Then The Same Above Query Is used for setting filed(Varible @total_price) which Is used forTAX calculation
set @total_price= 0.0 
--	set @total_price = @total_price + (select sum([Total_Unit_Price]) as [Sub_Total]from 
--							(select SID.Request_Id As [Request_Id],
--									sum(SID.Unit_Price)  As [Total_Unit_Price],SID.Assign_Type	
--									from tbl_Stockinventorydetails SID
--									group by SID.Request_Id,SID.Assign_Type
--									having SID.request_id in(REPLACE(@Request_Id, '''','' )) and SID.Assign_Type='PO') a)
				
									
							  

declare @Query4 nvarchar(max)
set @Query4 = 'create table temp
				(
					Sub_Total float
				)
			insert into temp (Sub_Total)
				(select sum([Total_Unit_Price]) as [Sub_Total]from 
							(select SID.Request_Id As [Request_Id],
									sum(SID.Unit_Price)  As [Total_Unit_Price],SID.Assign_Type	
									from tbl_Stockinventorydetails SID
									group by SID.Request_Id,SID.Assign_Type
									having SID.request_id in('+@Request_Id+') and SID.Assign_Type=''PO'') a)'


Print(@Query4)
Exec(@Query4)

set @total_price= @total_price + (Select Sub_Total From temp )

drop table temp

print ('Working')	
--set	@total_price =@total_price+@t						
print (@total_price)
print('Worked')					
---------------------New Way Without Top 1----------------------------




-----Terms and Conditions
select * from tbl_ITRequestCondition

--select * from tbl_it_taxes where Fld_RequestId = @Request_Id

--Tax Calculation---------

Declare @Fld_Excise float
Declare @Fld_Edn_cess float
Declare @Fld_Cst float
Declare @Fld_VAT float
Declare @Fld_service float
Declare @Fld_Frieght float
Declare @Fld_Octroi float
Declare @Fld_discount float
Declare @Fld_Status varchar(10)

set @Fld_Excise = (select Fld_Excise from tbl_it_taxes  where Fld_RequestId = @Request_Id )*@total_price/100
set @Fld_Edn_cess = (select Fld_Edn_cess  from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100
set @Fld_Cst = (select Fld_Cst from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100
set @Fld_VAT = (select Fld_VAT from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100
set @Fld_service = (select Fld_service from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100
set @Fld_Frieght = (select Fld_Frieght from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100
set @Fld_Octroi = (select Fld_Octroi from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100
set @fld_discount = (select fld_discount from tbl_it_taxes  where Fld_RequestId =@Request_Id)
set @Fld_Status = (select Fld_status from tbl_it_taxes  where Fld_RequestId =@Request_Id)

Declare @Rou_Total_Payable float

set @Rou_Total_Payable=@total_price+@Fld_Excise+@Fld_Edn_cess+@Fld_Cst+@Fld_VAT+@Fld_service+@Fld_Frieght+@Fld_Octroi-@fld_discount

create table #taxes 
(Fd_Excise float,
Fd_Edn_cess float,
Fd_Cst float,
Fd_VAT float,
Fd_service float,
Fd_Frieght float,
Fd_Octroi float,
Fd_discount float,
Fd_Status varchar(10),
Ro_Total_Payable float)

insert into #taxes values(@Fld_Excise,@Fld_Edn_cess,@Fld_Cst,@Fld_VAT,@Fld_service,@Fld_Frieght,
							@Fld_Octroi,@fld_discount,@Fld_Status,@Rou_Total_Payable)

--
--insert into #vishal values('1','2')
--select * from #vishal
select * from #taxes


---Autorized person -----
select Emp_name,emailadd From emp_Info where Emp_No=@UserName
End










--
--select * FROM dbo.tbl_stockInventoryDetails
--
--SELECT * FROM dbo.tbl_stockInventoryDetails_Log

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_BillInfoForModifyPO
-- --------------------------------------------------
    
    
    
    
  -----changed by Zeba  
-----select Fld_RequestId from tbl_it_taxes group by Fld_RequestId having count(Fld_RequestId)>=2   
    
--[Usp_BillInfoForModifyPO] '''25'',''24'',''8''','E03446'    
--    
--[Usp_BillInfoForModifyPO]'''47''','E03446'    
    
CREATE  Procedure [dbo].[Usp_BillInfoForModifyPO]    
(    
@Request_Id  nvarchar(max),    
@UserName char(10)    
)    
as        
Begin  



 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
    
declare @total_price as float     
--Declare @Query nvarchar(max)    
--Set @Query = '    
select RPO.Fld_PurchaseOrderNo As [Purchase_Order_No],RPO.Fld_vendorId As [Vendor_Id],    
     VM.VendorName As [Vendor_Name],VM.Address1,VM.Address2,VM.Address3,    
     RPO.Fld_shipTo As [Ship_To],AGC.CompId AS [compId],AGC.compName As [compName],    
     RPO.Fld_ShippingMethod As [Shipping_Method],RPO.Fld_OrderTerms As [Order_Terms],    
     RPO.POBranch As [PO_Branch],    
     RPO.PODeliveryTime As [PODelivery_time]    
   from  tbl_itrequestpurchaseorder RPO    
     Left Outer Join tbl_it_Vendormaster VM on RPO.Fld_vendorId = VM.VendorCode    
     Left outer join tbl_it_AngelGroupOfCompaniesMaster AGC on AGC.compId = RPO.Fld_CompId    
   where Fld_RequestId = @Request_Id     
    
--Print(@Query)    
--Exec(@Query)    
--where Fld_RequestId = '''25'',''24'',''8'''    
--------------------old----------------------------    
--select top 1 * into #temp From tbl_Stockinventorydetails Where Request_Id=@Request_Id and Assign_Type='PO'    
--    
--    
--set @total_price= 0.0    
--set @total_price=@total_price+((select Unit_Price from #temp)*(select  count (*)  from tbl_stockinventorydetails where request_id=@Request_Id and Assign_Type='PO'))    
--    
--select CPM.Product_Name As [Product_Name],TEMP.warranty_Type As [Warranty_Type],PMM.Model_Name As [Model],    
--  TEMP.Product_desc As [Product_Description],TEMP.Part_No As [Part_No],    
-- (select  count (*)  from tbl_stockinventorydetails where request_id=@Request_Id and Assign_Type='PO')As [Quantity],    
--  TEMP.Unit_Price  As [Unit_Price],@total_price As [Total_Price]    
--from #temp TEMP    
--Left Outer Join tbl_capexproductmaster CPM on  TEMP.Product_Code = CPM.Product_code    
--Left outer join tbl_productmodelmaster PMM on TEMP.Model_Id = PMM.Model_Id    
    
    
------------------------------old--------------------------    
    
-----reference-------------------    
--select request_id,product_code,product_desc,part_no,warranty_type,unit_price,sum(unit_price) as "Total Price",count(request_id)as 'Total Quantity',Assign_Type from tbl_Stockinventorydetails    
--group by request_id,product_code,product_desc,part_no,warranty_type,unit_price,Assign_Type    
--having request_id = '1010' and Assign_Type='PO'    
-----------------------------------    
    
    
    
--------------------New Way Without Top 1---------------------------    
--select the necessary fields along with summantion of unit price as total price of EACH Request    
Declare @Query2 nvarchar(max)    
Set @Query2 = 'select SID.Request_Id As [Request_Id],SID.Inventory_No As [Inventory_No],RM.User_Remark As [User_Remark],    
     CPM.Product_Name As [Product_Name],SID.warranty_Type As [Warranty_Type],    
     PMM.Model_Name As [Model],SID.Product_desc As [Product_Description],SID.Part_No As [Part_No],    
     ''1''As [Quantity],SID.Unit_price,SID.Unit_Price As [Total_Price]     
--     sum (SID.Unit_Price) As [Total_Price],SID.Assign_Type     
   from tbl_Stockinventorydetails SID    
   Left Outer Join tbl_RequestMaster RM on SID.Request_Id = RM.Request_Id    
   Left Outer Join tbl_capexproductmaster CPM on  SID.Product_Code = CPM.Product_code    
   Left outer join tbl_productmodelmaster PMM on SID.Model_Id = PMM.Model_Id    
--   group by SID.Request_Id,CPM.Product_Name,SID.warranty_Type,PMM.Model_Name,SID.Product_desc,SID.Part_No,    
--     SID.Assign_Type,SID.Unit_Price    
--   having SID.request_id in ('+@Request_Id+') and SID.Assign_Type=''PO''    
   Where SID.request_id in ('+@Request_Id+') and SID.Assign_Type=''PO'''    
    
Print (@Query2)    
Exec(@Query2)    
    
    
------------Uper Query is used to show each and every Request Inventory Model    
--And This Query is added for getting total price    
--Declare @Query5 nvarchar(max)    
--Set @Query5 = 'select SID.Request_Id As [Request_Id],CPM.Product_Name As [Product_Name],    
--     SID.warranty_Type As [Warranty_Type],PMM.Model_Name As [Model],    
--     SID.Product_desc As [Product_Description],SID.Part_No As [Part_No],    
--     count (SID.Request_Id)As [Quantity],SID.Unit_price,    
--     sum (SID.Unit_Price) As [Total_Price],SID.Assign_Type     
--   from tbl_Stockinventorydetails SID    
--   Left Outer Join tbl_capexproductmaster CPM on  SID.Product_Code = CPM.Product_code    
--   Left outer join tbl_productmodelmaster PMM on SID.Model_Id = PMM.Model_Id    
--   group by SID.Request_Id,CPM.Product_Name,SID.warranty_Type,PMM.Model_Name,SID.Product_desc,SID.Part_No,    
--     SID.Assign_Type,SID.Unit_Price    
--   having SID.request_id in ('+@Request_Id+') and SID.Assign_Type=''PO'''    
--    
--Print (@Query5)    
--Exec(@Query5)    
    
    
    
----------    
    
    
    
----Then Add The Total Unit Price of EACH Individual request As The Complete SUB TOTAL    
    
Declare @Query3 nvarchar(max)    
Set @Query3 = 'select sum([Total_Unit_Price]) as [Sub_Total]     
    from     
     (select SID.Request_Id As [Request_Id],sum(SID.Unit_Price) As [Total_Unit_Price],    
       SID.Assign_Type     
     from tbl_Stockinventorydetails SID    
     group by SID.Request_Id,SID.Assign_Type    
     having SID.request_id in('+@Request_Id+') and SID.Assign_Type=''PO'') a '    
Print (@Query3)    
Exec(@Query3)    
    
-----Then The Same Above Query Is used for setting filed(Varible @total_price) which Is used forTAX calculation    
set @total_price= 0.0     
-- set @total_price = @total_price + (select sum([Total_Unit_Price]) as [Sub_Total]from     
--       (select SID.Request_Id As [Request_Id],    
--         sum(SID.Unit_Price)  As [Total_Unit_Price],SID.Assign_Type     
--         from tbl_Stockinventorydetails SID    
--         group by SID.Request_Id,SID.Assign_Type    
--         having SID.request_id in(REPLACE(@Request_Id, '''','' )) and SID.Assign_Type='PO') a)    
        
             
             
    
declare @Query4 nvarchar(max)    
set @Query4 = 'create table temp    
    (    
     Sub_Total float    
    )    
   insert into temp (Sub_Total)    
    (select sum([Total_Unit_Price]) as [Sub_Total]from     
       (select SID.Request_Id As [Request_Id],    
         sum(SID.Unit_Price)  As [Total_Unit_Price],SID.Assign_Type     
         from tbl_Stockinventorydetails SID    
         group by SID.Request_Id,SID.Assign_Type    
         having SID.request_id in('+@Request_Id+') and SID.Assign_Type=''PO'') a)'    
    
    
Print(@Query4)    
Exec(@Query4)    
    
set @total_price= @total_price + (Select Sub_Total From temp )    
    
drop table temp    
    
print ('Working')     
--set @total_price =@total_price+@t          
print (@total_price)    
print('Worked')         
---------------------New Way Without Top 1----------------------------    
    
    
    
    
-----Terms and Conditions    
select * from tbl_ITRequestCondition    
    
--select * from tbl_it_taxes where Fld_RequestId = @Request_Id    
    
--Tax Calculation---------    
    
Declare @Fld_Excise float    
Declare @Fld_Edn_cess float    
Declare @Fld_Cst float    
Declare @Fld_VAT float    
Declare @Fld_service float    
Declare @Fld_Frieght float    
Declare @Fld_Octroi float    
Declare @Fld_discount float    
Declare @Fld_Status varchar(10)    
    
set @Fld_Excise = (select Fld_Excise from tbl_it_taxes  where Fld_RequestId = @Request_Id )*@total_price/100    
set @Fld_Edn_cess = (select Fld_Edn_cess  from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100    
set @Fld_Cst = (select Fld_Cst from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100    
set @Fld_VAT = (select Fld_VAT from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100    
set @Fld_service = (select Fld_service from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100    
set @Fld_Frieght = (select Fld_Frieght from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100    
set @Fld_Octroi = (select Fld_Octroi from tbl_it_taxes  where Fld_RequestId =@Request_Id)*@total_price/100    
set @fld_discount = (select fld_discount from tbl_it_taxes  where Fld_RequestId =@Request_Id)    
set @Fld_Status = (select Fld_status from tbl_it_taxes  where Fld_RequestId =@Request_Id)    
    
Declare @Rou_Total_Payable float    
    
set @Rou_Total_Payable=@total_price+@Fld_Excise+@Fld_Edn_cess+@Fld_Cst+@Fld_VAT+@Fld_service+@Fld_Frieght+@Fld_Octroi-@fld_discount    
    
create table #taxes     
(Fd_Excise float,    
Fd_Edn_cess float,    
Fd_Cst float,    
Fd_VAT float,    
Fd_service float,    
Fd_Frieght float,    
Fd_Octroi float,    
Fd_discount float,    
Fd_Status varchar(10),    
Ro_Total_Payable float)    
    
insert into #taxes values(@Fld_Excise,@Fld_Edn_cess,@Fld_Cst,@Fld_VAT,@Fld_service,@Fld_Frieght,    
       @Fld_Octroi,@fld_discount,@Fld_Status,@Rou_Total_Payable)    
    
--    
--insert into #vishal values('1','2')    
--select * from #vishal    
select * from #taxes    
    
    
---Autorized person -----    
select Emp_name,emailadd From emp_Info where Emp_No=@UserName    
End    
    
    
    
    
    
    
    
    
    
    
--    
--select * FROM dbo.tbl_stockInventoryDetails    
--    
--SELECT * FROM dbo.tbl_stockInventoryDetails_Log

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BranchCode
-- --------------------------------------------------
  
CREATE Proc [dbo].[USP_BranchCode]  
As  
Begin  


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  
--Select distinct (branch_cd)   
--from Emp_info order by Branch_Cd  
  
--As Kolgp brabch Was not found so we filled thee branch ddl in admin userrequest from region table  
--Select distinct(Code)   
--from region order by code   
  
--Select Distinct(biBranch) As [Code]   
--from VLMS_RolemasterEquity order by biBranch  
  
  
Select Distinct(BRANCH_CODE) As [Code]  
from risk.dbo.branches order by BRANCH_Code  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BranchCode_test
-- --------------------------------------------------
  
CREATE Proc [dbo].[USP_BranchCode_test]  
As  
Begin  


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

  
--Select distinct (branch_cd)   
--from Emp_info order by Branch_Cd  
  
--As Kolgp brabch Was not found so we filled thee branch ddl in admin userrequest from region table  
--Select distinct(Code)   
--from region order by code   
  
--Select Distinct(biBranch) As [Code]   
--from VLMS_RolemasterEquity order by biBranch  
  
  
Select Distinct(BRANCH_CODE) As [Code]  
from BOBranch order by BRANCH_Code  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BranchMasterAllInOne
-- --------------------------------------------------
CREATE Proc [dbo].[USP_BranchMasterAllInOne]
@Option Char(20),
@Branch_Code char(20),
@Branch_Name char(50),
@Branch_LName char(70),
@Address1 varchar(200),
@Address2 varchar(200),
@City char(20),
@State char(20),
@Nation char(20),
@Zip char(20),
@Phone1 char(20),
@Phone2 char(20),
@Fax char(20),
@Email char(100),
@Contact_Person char(200)

As

Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


If(@Option = 'FillDetails')
Begin
	Select Distinct Branch_Code
	From BOBranch

End

Else If (@Option = 'GetBranchDetails')
Begin
	Select Branch_Code As [Branch_Code],Branch As [Branch],Long_Name As [Long_Name],
			Address1 As [Address1],Address2 As [Address2],City As [City],State As [State],
			Nation As [Nation],Zip As [Zip],Phone1 As [Phone1],Phone2 As [Phone2],Fax As [Fax],
			Email As [Email],Contact_Person As [Contact_Person]
	From BOBranch 
	Where Branch_Code = @Branch_Code
	
End

Else if (@Option = 'FillGrid')
Begin
	Declare @Query varchar(MAX)
	Set @Query = 'Select Branch_Code As [Branch_Code],Branch As [Branch],Long_Name As [Long_Name],
						Address1 As [Address1],Address2 As [Address2],City As [City],State As [State],
						Nation As [Nation],Zip As [Zip],Phone1 As [Phone1],Phone2 As [Phone2],Fax As [Fax],
						Email As [Email],Contact_Person As [Contact_Person]
				  From BOBranch
				  Where 1=1'

	if(@Branch_Code <> '')
	Set @Query = @Query + ' And Branch_Code = '''+@Branch_Code+''''
	Print(@Query)
	Exec(@Query)

End

Else if (@Option = 'CheckExisting')
Begin
	Select Branch_Code
	From BOBranch
	Where Branch_Code = @Branch_Code
End

Else if (@Option = 'Add')
Begin
	Insert Into BOBranch (BRANCH_CODE,BRANCH,Long_Name,Address1,Address2,City,State,Nation,Zip,Phone1,Phone2,Fax,
							Email,Remote,Security_Net,Money_Net,Excise_Reg,Contact_Person,prefix)
	Values (@Branch_Code,@Branch_Name,@Branch_LName,@Address1,@Address2,@City,@State,@Nation,@Zip,
			@Phone1,@Phone2,@Fax,@Email,'0','0','0','',@Contact_Person,'')

End

Else if (@Option = 'Edit')
Begin
	Update BOBranch
	Set	Address1 = @Address1,
		Address2 = @Address2,
		City = @City,
		State = @State,
		Nation = @Nation,
		Zip = @Zip,
		Phone1 = @Phone1,
		Phone2 = @Phone2,
		Fax = @Fax,
		Email = @Email,
		Contact_Person = @Contact_Person
	Where Branch_Code = @Branch_Code
End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CapexMasterAllinOne
-- --------------------------------------------------





CREATE Proc [dbo].[USP_CapexMasterAllinOne] 
(
@Option char(20),
@CapexCode char(20),
@CapexType varchar(200),
@Userid char(20)

)
As
Begin


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 



if(@Option = 'FillDetails')
	Begin
		Select Capex_Type,Capex_code 
		From tbl_capexMaster 
		Where flag='1'

	End

else if (@Option = 'GetCapexType')
	Begin
		Select Capex_Type,Capex_Code 
		from tbl_capexMaster 
		Where Capex_Code=@CapexCode
	End



else if(@Option = 'GetDetails')
	Begin

	Declare @Query nvarchar(max)
	Set @Query = 'Select Capex_code As [Capex Code],Capex_type As [Capex Type],[Status]= CASE Flag 
																				WHEN ''1'' THEN ''Active''
																				WHEN ''0'' THEN ''Disable''
																				END
				from tbl_capexMaster
				Where 1=1'

	if(@CapexCode <> '')
	set @Query = @Query + 'And Capex_code ='''+ @CapexCode +''' '

	Exec(@Query)
	
	End

else if (@Option = 'CheckExistingAdd')
	Begin
		Select	Capex_Type
				from tbl_CapexMaster
				where Capex_Type = @CapexType
				
	End

else if (@Option = 'CheckExistingEdit')
	Begin
		Select	Capex_Type
				from tbl_CapexMaster
				where Capex_Type = @CapexType
				
	End

else if (@Option = 'CheckExistingDelete')
	Begin
		Select Capex_Code,Capex_Type
				from tbl_CapexMaster
				where Capex_Code = @CapexCode
				
	End

else if(@Option = 'Add')
	Begin
		Insert into tbl_capexMaster(Capex_Code,Capex_type,Flag,Added_By,Added_On,Modified_By,Modified_Date)
				Values(@CapexCode,@CapexType,'1',@Userid,getdate(),@Userid,getdate())
				
				
			----------Make An entry in log----------
			INSERT INTO tbl_CapexMaster_Log(Capex_Code,Capex_type,Flag,Added_By,Added_On,Modified_By,
											Modified_Date)
			SELECT Capex_Code,Capex_type,Flag,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_capexMaster
			WHERE Capex_Code = @CapexCode
			------------------------------------	
	
				
	End

else if (@Option = 'Edit')
	Begin
		Update tbl_capexMaster
			set Capex_Type = @CapexType,
				Modified_By= @Userid,
				Modified_Date = getdate()
			Where Capex_code = @CapexCode
			
			
			----------Make An entry in log----------
			INSERT INTO tbl_CapexMaster_Log(Capex_Code,Capex_type,Flag,Added_By,Added_On,Modified_By,
											Modified_Date)
			SELECT Capex_Code,Capex_type,Flag,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_capexMaster
			WHERE Capex_Code = @CapexCode
			------------------------------------				
			
	End

else if(@Option = 'Delete')
	Begin
		Update tbl_capexMaster
			set Flag = 'false',
				Modified_By = @Userid,
				Modified_Date = getdate()
			Where Capex_code = @CapexCode
			
			
			----------Make An entry in log----------
			INSERT INTO tbl_CapexMaster_Log(Capex_Code,Capex_type,Flag,Added_By,Added_On,Modified_By,
											Modified_Date)
			SELECT Capex_Code,Capex_type,Flag,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_capexMaster
			WHERE Capex_Code = @CapexCode
			------------------------------------				
			
	End





End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ChechExisiting
-- --------------------------------------------------



CREATE  Proc [dbo].[USP_ChechExisiting]
(
@Option char(20),
@ProductCode char(20),
@ProductName varchar(200) 
)
As
Begin


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

--if(@option = 'AssetsMaster')
--	Begin
--		select Product_code
--		from tbl_capexproductmaster
--		where Product_Code = @ProductCode
--- select * from tbl_capexproductmaster
--	End


if(@Option = 'Add')
	Begin
		Select Product_Name
		From tbl_capexproductmaster
		Where Product_Name = @ProductName
	End

else if (@Option = 'Edit')
	Begin
		Select Product_Name
		From tbl_CapexProductMaster
		Where Product_Name = @ProductName
	End

else if (@Option = 'Delete')
	Begin
		Select Product_Code,Product_Name 
		From tbl_CapexProductMaster
		Where Product_Code = @ProductCode
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CheckRequestStatusToUpdatePoStatus
-- --------------------------------------------------
CREATE  Proc [dbo].[USP_CheckRequestStatusToUpdatePoStatus]
@RequestIds nvarchar(Max)
As

Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
Declare @Query nvarchar(Max)
Set @Query = 'Select Request_Id,Status_Code from tbl_RequestMaster
where Request_Id in ('+@RequestIds+') and Status_Code = ''PO'''

Print(@Query)

Exec(@Query)

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CompanyMasterAllinOne
-- --------------------------------------------------






CREATE Proc [dbo].[USP_CompanyMasterAllinOne] 
(
@Option char(20),
@CompanyCode int,
@CompanyName varchar(200),
@Userid char(20)

)
As
Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 



--USP_CompanyMasterAllinOne 'GetDetails','0','','E30253' 

if(@Option = 'FillDetails')
	Begin
		Select CompName,CompId 
		From tbl_it_AngelGroupofCompaniesMaster 
		Where Status='A'

	End

else if (@Option = 'GetCompanyName')
	Begin
		Select CompName,CompId 
		From tbl_it_AngelGroupofCompaniesMaster  
		Where CompId=CONVERT(INT,@CompanyCode)
	End



else IF @Option = 'GetDetails'
	Begin

	Declare @Query nvarchar(max)
	Set @Query = 'Select CompId As [Company Code],CompName As [Company Name],[Status]= CASE status 
																				WHEN ''A'' THEN ''Active''
																				WHEN ''D'' THEN ''Disable''
																				END
				from tbl_it_AngelGroupofCompaniesMaster
				Where 1=1'
		

	IF @CompanyCode <> ''
	set @Query = @Query + '  And CompId ='+convert(varchar(20),@CompanyCode )  
	
--
--	 EXECUTE sp_executesql @Query
--	PRINT @CompanyCode
--	PRINT @Query	
EXEC (@Query)	
	End

else if (@Option = 'CheckExistingAdd')
	Begin
		Select	CompName
				from tbl_it_AngelGroupofCompaniesMaster
				where CompName = @CompanyName
				
	End

else if (@Option = 'CheckExistingEdit')
	Begin
		Select	CompName
				from tbl_it_AngelGroupofCompaniesMaster
				where CompName = @CompanyName
				
	End

else if (@Option = 'CheckExistingDelete')
	Begin
		Select CompId,CompName
				from tbl_it_AngelGroupofCompaniesMaster
				where CompId = @CompanyCode
				
	End

else if(@Option = 'Add')
	Begin
		Insert into tbl_it_AngelGroupofCompaniesMaster(CompId,CompName,status,Added_By,Added_On,Modified_By,Modified_Date)
				Values(@CompanyCode,@CompanyName,'A',@Userid,getdate(),@Userid,getdate())
				
				
			----------Make An entry in log----------
			INSERT INTO tbl_it_AngelGroupofCompaniesMaster_Log(CompId,CompName,status,Added_By,Added_On,Modified_By,
											Modified_Date)
			SELECT CompId,CompName,status,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_it_AngelGroupofCompaniesMaster
			WHERE CompId = @CompanyCode
			------------------------------------					
				
	End

else if (@Option = 'Edit')
	Begin
		Update tbl_it_AngelGroupofCompaniesMaster
			set CompName = @CompanyName,
				Modified_By= @Userid,
				Modified_Date = getdate()
			Where CompId = @CompanyCode
			
			
			----------Make An entry in log----------
			INSERT INTO tbl_it_AngelGroupofCompaniesMaster_Log(CompId,CompName,status,Added_By,Added_On,Modified_By,
											Modified_Date)
			SELECT CompId,CompName,status,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_it_AngelGroupofCompaniesMaster
			WHERE CompId = @CompanyCode
			------------------------------------				
			
	End

else if(@Option = 'Delete')
	Begin
		Update tbl_it_AngelGroupofCompaniesMaster
			set status = 'D',
				Modified_By = @Userid,
				Modified_Date = getdate()
			Where CompId = @CompanyCode
			
			
			
			----------Make An entry in log----------
			INSERT INTO tbl_it_AngelGroupofCompaniesMaster_Log(CompId,CompName,status,Added_By,Added_On,Modified_By,
											Modified_Date)
			SELECT CompId,CompName,status,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_it_AngelGroupofCompaniesMaster
			WHERE CompId = @CompanyCode
			------------------------------------				
			
			
	End





End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_EmpHierarchyTree
-- --------------------------------------------------
CREATE procedure [dbo].[USP_EmpHierarchyTree] 
@Emp_Id varchar(20)  
As  
--USP_EmpHierarchyTree 'E30253'  
Begin  


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

Declare @NO varchar(20)  
Declare @Desg varchar(50)  
Declare @Name varchar(100)  
  
Declare @PrevNO varchar(20)  
Declare @PrevDesg varchar(50)  
Declare @PrevName varchar(100)  
  
Set @NO = @Emp_Id  
Set @Name = (Select Emp_Name from tbl_EmpTree where emp_id = @NO)    
Set @Desg = (Select Desig from tbl_EmpTree where emp_id = @NO)  

print('Requester' + ' - ' +@NO + ' - ' + @Name + ' - ' +  @Desg)

Set @NO = (Select Senior from tbl_EmpTree where emp_id = @NO)  
Set @Name = (Select Emp_Name from tbl_EmpTree where emp_id = @NO)  
Set @Desg = (Select Desig from tbl_EmpTree where emp_id = @NO)  
  
WHILE (isnull(@Desg,'') <> '')
Begin 
  Print (@NO + ' - ' + @Name + ' - ' +  @Desg)  
 Set @NO = (Select Senior from tbl_EmpTree where emp_id = @NO) 
 Set @Name = (Select Emp_Name from tbl_EmpTree where emp_id = @NO)   
 Set @Desg = (Select Desig from tbl_EmpTree where emp_id = @NO)  

-- 
  
--print(@NO)  
--Print(@Desg)  
End  
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_EmpIdInfo
-- --------------------------------------------------
CREATE proc Usp_EmpIdInfo  
(  
@EmpId varchar(50)  
)  
as  
(  
select * from emp_info where emp_no =@EmpId 
  
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_EmpRecord
-- --------------------------------------------------
CREATE proc [dbo].[USP_EmpRecord]  
(  
@EmployeeID as varchar(150),  
@EmployeeName as varchar(500),  
@Department as varchar(250)  
)  
as  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


declare @Query as nvarchar(max)  
set @Query='  
	SELECT  Emp_No AS [EMP NO],EMP_NAME As [EMP NAME],Sr_name AS [HOD NAME],Zone AS [COMPANY ZONE],  
		   REGION,LOCATION,attendanceLoc as ATTENDANCELOCATION,department AS DEPARTMENT,  
		   Sub_Department AS [SUB DEPARTMENT],DESIGNATION,  
		   LOCATION,convert(varchar(11),JOINDATE,103) as JOINDATE,convert(varchar(11),separation_date,103) AS [SEPARATION DATE],  
		   emailadd AS [EMAIL ID],phone AS [PHONE NO],status AS STATUS,address AS ADDRESS,city AS CITY,state AS STATE,  
		   pincode AS PINCODE  
		   from Emp_Info 
			where 1=1'  



  
--declare @Department as varchar(50)  
--set @Department='software'  
if (@EmployeeID <> '')  
set @query= @query + 'and Emp_No = '''+@EmployeeID+''''  
  
if (@EmployeeName <> '')  
set @query= @query  + 'and EMP_NAME like ''%'+@EmployeeName+'%'''  
  
if (@Department <> '')  
set @query = @query + 'and department like ''%'+@Department+''''  
  
Exec (@Query)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_EmpTreeUpdate
-- --------------------------------------------------
CREATE proc [dbo].[Usp_EmpTreeUpdate]                            
as       
    
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
                            
--------NOTE----------------                            
-- The table tbl_EmpTree has Default value as '' for all varchar columns and (0) for all datetime colums                            
--and Emp_Id is set As Primary Key                            
--But When We import this table from 196.1.115.158.[ITAssests].dbo.tbl_EmpTree to 172.29.19.8.[ITAssets_NEW].dbo.tbl_EmpTree                            
--the default values are not set and also the primary key is not set                            
--so make sure to make these chages on the test server also wherever the table tbl_Emptree is imporated.                            
--If necessacry see what are the defalut values on 196.1.115.158.[ITAssests].dbo.tbl_EmpTree table                            
--and make the same changes on 172.29.19.8.[ITAssets_NEW].dbo.tbl_EmpTree after table is imporated.                            
--other releated table tbl_EmpTree_Prev,tbl_EmpTree_Log does not contain any defaultvalues nor the primary key                            
--so no problem for them.                            
---------------------------------------------------                            
truncate table tbl_EmpTree_Prev                            
Insert into tbl_EmpTree_Prev                            
select * from tbl_EmpTree                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_Prev',count(*),getdate() from tbl_EmpTree_Prev with (nolock)                            
  
  
  
Select Row_number() over(partition by Emp_no order by Emp_no) as RecID,Emp_NO,EMP_NAME,Designation,Senior=isnull(Senior,''),Sr_name=isnull(Sr_name,''),Branch_Cd,join_date,                            
  isnull(separation_date,'') as [Separation_Date],E.Region As [Emp_Region],E.Zone As [Emp_Zone],                            
  V.Region As [Emp_branch_Region],V.Zone As [Emp_branch_Zone],                            
  branchHead=isnull(branchHead,''),clusterHead=isnull(clusterHead,''),regionalHead=isnull(regionalHead,''),zonalHead=isnull(zonalHead,''),                            
  RegionalSalesManager=isnull(RegionalSalesManager,''),[Area Sales Manager]=isnull([Area Sales Manager],''),                            
  --'E22062',                        
  --'','P00226','P00104','E22230','P00068',getdate(),getdate()                    //commented by harshal at 5 apr 2013        
  SrAVPIT='',HeadIT='E63575',ADIT='P00104',EDCFO='E22230',CSO='P00068',UpdateDate=getdate(),SrUpdateDate=getdate()                            
into #t  
 from emp_info E, VLMS_RolemasterEquity V                            
where Branch_Cd = (case when isnull(Harmonycostcode,'') <> '' then Harmonycostcode else biBranch end)       
and  e.Region=v.Region  
  
  
Select Row_number() over(partition by Emp_no order by Emp_no) as RecID,Emp_NO,EMP_NAME,Designation,Senior=isnull(Senior,''),Sr_name=isnull(Sr_name,''),Branch_Cd,join_date,                            
  isnull(separation_date,'') as [Separation_Date],E.Region As [Emp_Region],E.Zone As [Emp_Zone],                            
  V.Region As [Emp_branch_Region],V.Zone As [Emp_branch_Zone],                            
  branchHead=isnull(branchHead,''),clusterHead=isnull(clusterHead,''),regionalHead=isnull(regionalHead,''),zonalHead=isnull(zonalHead,''),                            
  RegionalSalesManager=isnull(RegionalSalesManager,''),[Area Sales Manager]=isnull([Area Sales Manager],''),                            
  --'E22062',                        
  --'','P00226','P00104','E22230','P00068',getdate(),getdate()                    //commented by harshal at 5 apr 2013        
  SrAVPIT='',HeadIT='E63575',ADIT='P00104',EDCFO='E22230',CSO='P00068',UpdateDate=getdate(),SrUpdateDate=getdate()                            
into #t2  
 from emp_info E, VLMS_RolemasterEquity V                            
where Branch_Cd = biBranch        
and  e.Region=v.Region   
  
Select Row_number() over(partition by Emp_no order by Emp_no) as RecID,Emp_NO,EMP_NAME,Designation,Senior=isnull(Senior,''),Sr_name=isnull(Sr_name,''),Branch_Cd,join_date,                            
  isnull(separation_date,'') as [Separation_Date],E.Region As [Emp_Region],E.Zone As [Emp_Zone],                            
  V.Region As [Emp_branch_Region],V.Zone As [Emp_branch_Zone],                            
  branchHead=isnull(branchHead,''),clusterHead=isnull(clusterHead,''),regionalHead=isnull(regionalHead,''),zonalHead=isnull(zonalHead,''),                            
  RegionalSalesManager=isnull(RegionalSalesManager,''),[Area Sales Manager]=isnull([Area Sales Manager],''),                            
  --'E22062',                        
  --'','P00226','P00104','E22230','P00068',getdate(),getdate()                    //commented by harshal at 5 apr 2013        
  SrAVPIT='',HeadIT='E63575',ADIT='P00104',EDCFO='E22230',CSO='P00068',UpdateDate=getdate(),SrUpdateDate=getdate()                            
into #t5  
 from emp_info E, VLMS_RolemasterEquity V                            
where Branch_Cd = biBranch        
   
delete from #t5 where emp_no in (select emp_no from #t)  
delete from #t5 where emp_no in (select emp_no from #t2)  
  
delete from #t5 where  recid=2 and RegionalSalesManager=''  
delete from #t5 where  recid>2  
delete from #t5 where  recid=1 and emp_no in (select emp_no from #t5 where  recid=2 and RegionalSalesManager<>'')  
  
  
select * into #t6 from #t5 where recid=1  
union all  
select * from #t5 where recid=2  
  
  
delete from #t2 where emp_no in (select emp_no from #t)  
  
delete from #t2 where  recid=2 and RegionalSalesManager=''  
delete from #t2 where  recid>2  
delete from #t2 where  recid=1 and emp_no in (select emp_no from #t2 where  recid=2 and RegionalSalesManager<>'')  
  
select * into #t3 from #t2 where recid=1  
union  
select * from #t2 where recid=2  
  
delete from #t where  recid=2 and RegionalSalesManager=''  
delete from #t where  recid>2   
delete from #t where  recid=1 and emp_no in (select emp_no from #t where  recid=2 and RegionalSalesManager<>'')  
  
select * into #t1 from #t where recid=1  
union all  
select * from #t where recid=2  
  
select * into #tFinal from #t1  
union all  
select * from #t2   
union all  
select * from #t6  
--where emp_no='E00030'  
--drop table #tFinal   
  
--select emp_no,count(*) from #tFinal   
--group by emp_no  
--having count(*)>1  
  
truncate table tbl_EmpTree                            
Insert into tbl_EmpTree(Emp_Id,Emp_Name,Desig,Senior,Sr_Name,Branch_Code,Join_Date,Sep_Date,                            
      Emp_Region,Emp_Zone,Emp_Br_Region,Emp_Br_Zone,BH,CH,RH,ZH,RSM,ASM,                            
      SrAVPIT,HeadIT,ADIT,EDCFO,CSO,UpdateDate,SrUpdateDate)                            
select    
Emp_NO,EMP_NAME,Designation,Senior,Sr_name,Branch_Cd,join_date,Separation_Date,Emp_Region,Emp_Zone,Emp_branch_Region,Emp_branch_Zone,  
branchHead,clusterHead,regionalHead,zonalHead,RegionalSalesManager,[Area Sales Manager],SrAVPIT,HeadIT,ADIT,EDCFO,  
CSO,UpdateDate,SrUpdateDate from #tFinal                         
  
                         
/*----zeba                           
UPDATE tbl_emptree                           
SET AVP='E07260'                          
WHERE branch_code IN ('HO','ACM',                          
'AKSTR',                          
'BOK',                          
'CSO',                          
'CALNT',                          
'ELITE',                          
'PMOS',                          
'CSOHYD',                          
'DEPOSITORY',                          
'DMAT',                          
'INSUR')                          
AND AVP=''                          
AND Sep_Date ='1900-01-01 00:00:00.000'--IS NULL                          
-----zeba end  */                        
                      
----Zeba---for the recommender  process by HOD should not include in below designations..                      
    update tbl_emptree                      
       set avp='E07260'                      
       where emp_id in                      
      -- select emp_id,emp_name from                      
      (select emp_id  from tbl_emptree where senior in (select emp_id from tbl_emptree where desig in                      
      ('Chief Strategy Officer',                      
       'Executive Director-CFO' ,                      
       'Executive Director-CFO' ,                                                                                                  
       'Professional',                      
       'Associate Director'  ,                                                    
    'Executive Director'  ,                                     
       'Executive Director-CFO')))                       
                             
    -----Zeba-----                         
                             
                           
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree',count(*),getdate() from tbl_EmpTree with (nolock)                            
                            
                            
                            
--------Remove i.e Set BH,CH,RH,ZH as '' where They are only BH,CH,RH,ZH    OR                            
-------if they are decativated from harmony then they are not in our emp_info                            
-------so set  BH,CH,RH,ZH colums as '' for all employess where they are BH,CH,RH,ZH                              
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveBH',count(*),getdate() from tbl_EmpTree with (nolock)                       
where emp_id = BH or (BH <> '' and BH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
update tbl_EmpTree set BH=''                             
where emp_id = BH or (BH <> '' and BH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveCH',count(*),getdate() from tbl_EmpTree with (nolock)                             
where emp_id = CH or (CH <> '' and CH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
update tbl_EmpTree set CH=''                             
where emp_id = CH or (CH <> '' and CH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveRH',count(*),getdate() from tbl_EmpTree with (nolock)                             
where emp_id = RH or (RH <> '' and RH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
update tbl_EmpTree set RH=''                             
where emp_id = RH or (RH <> '' and RH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveZH',count(*),getdate() from tbl_EmpTree with (nolock)                             
where emp_id = ZH or (ZH <> '' and ZH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
update tbl_EmpTree set ZH=''                             
where emp_id = ZH or (ZH <> '' and ZH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
------------------ Remove Separated BH,CH,RH,ZH ------------------                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveBH',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = BH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
           
update tbl_EmpTree set BH = '' from emp_info where Emp_NO = BH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
             
                         
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveCH',count(*),getdate()                            
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = CH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set CH = '' from emp_info where Emp_NO = CH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                   
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveRH',count(*),getdate()                            
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = RH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set RH = '' from emp_info where Emp_NO = RH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveZH',count(*),getdate()                            
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = ZH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set ZH = '' from emp_info where Emp_NO = ZH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                    
                            
------15/2/2011------------------------------------------------------------------------------------                            

delete from tbl_EmpTree  where Emp_Id in ('E74225','E75212')
delete from tbl_EmpTree 
  where  exists(select isnull(m.Emp_Id,0) from (select a.Emp_Id from tbl_EmpTree a
				   left outer join tbl_EmpTree b on b.Emp_Id=a.Senior
				   where b.Senior=a.emp_id)m where isnull(tbl_EmpTree.emp_id,0) =isnull(m.Emp_Id,0))     


                            
Declare @Emp_Id varchar(50)                            
Declare Rec Cursor for                            
 Select emp_id from  tbl_EmpTree 
                             
OPEN Rec                            
                             
 FETCH Rec into @Emp_Id                            
  While(@@fetch_status=0)                            
  Begin                            
   Exec USP_GetEmpTree @Emp_Id                            
   FETCH Rec into @Emp_Id                            
  End                            
                            
Close Rec                            
deallocate Rec                             
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd_Cursor','tbl_EmpTree',count(*),getdate() from tbl_EmpTree with (nolock)                            
where AVP <> '' or SrAVP <> '' or VP <> '' or SrVP <> '' or ED <> ''                            
                            
------------------ Remove Separated AVP,SrAVP,VP,SrVP,ED ------------------                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveAVP',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = AVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set AVP = '' from emp_info where Emp_NO = AVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveSrAVP',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = SrAVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set SrAVP = '' from emp_info where Emp_NO = SrAVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveVP',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = VP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set VP = '' from emp_info where Emp_NO = VP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
insert into tbl_EmpTree_Log                         
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveSrVP',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = SrVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                          
update tbl_EmpTree set SrVP = '' from emp_info where Emp_NO = SrVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveED',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = ED and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set ED = '' from emp_info where Emp_NO = ED and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
-----------------------------------------------------------------------                            
                            
delete from tbl_EmpTree_Prev where Emp_Id in (                            
select E.Emp_Id                             
from tbl_EmpTree E with (nolock), tbl_EmpTree_Prev P with (nolock)                            
where E.Emp_Id = P.Emp_Id and E.Emp_Name = P.Emp_Name and E.Desig = P.Desig                            
and E.Senior = P.Senior and E.Sr_Name = P.Sr_Name and E.Branch_Code = P.Branch_Code                            
and E.Join_Date = P.Join_Date and E.Sep_Date = P.Sep_Date and E.Emp_Region = P.Emp_Region                            
and E.Emp_Zone = P.Emp_Zone and E.Emp_Br_Region = P.Emp_Br_Region and E.Emp_Br_Zone = P.Emp_Br_Zone                            
and E.BH = P.BH and E.CH = P.CH and E.RH = P.RH and E.ZH = P.ZH and E.RSM = P.RSM and E.ASM = P.ASM                            
and E.AVP = P.AVP and E.SrAVP = P.SrAVP and E.VP = P.VP and E.SrVP = P.SrVP                            
and E.SrAVPIT = P.SrAVPIT and E.HeadIT = P.HeadIT and E.ADIT = P.ADIT and E.ED = P.ED                            
and E.EDCFO = P.EDCFO and E.CSO = P.CSO                            
and E.UpdateDate > P.UpdateDate and E.SrUpdateDate > P.SrUpdateDate                            
)                            
                            
Insert into tbl_EmpTree_Arch                            
select *, getdate() from tbl_EmpTree_Prev                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd_Arch','tbl_EmpTree_Arch',count(*),getdate() from tbl_EmpTree_Arch with (nolock)                     
where convert(varchar(11),CreateDate,121) = convert(varchar(11),getdate(),121)                            
                            
truncate table tbl_EmpTree_Prev                            
----------------------------------                  
-----------------------------------                    
  -----------updated by ZEBA to PORVIDE THE APPROVAL AS PER THE DESIGNATIONWISE                  
                  
update tbl_EmpTree              
set BH='',CH=''              
where desig in ('Branch Head','Cluster Head','Regional head','Zonal Head')              
                            
            
--select * from tbl_emptree where bh='E35563'            
            
--zeba             
update tbl_EmpTree            
set bh='E46896'            
where bh='E35563'            
    
--zeba             
update tbl_EmpTree            
set cso='P01015'            
where emp_id='E49094'     
    
update tbl_EmpTree            
set RH='P00202'            
where emp_id='E48480'            
                    
             
-----                          
--------SEND MAIL--------------                            
 Declare @HTMLBODY varchar(500)                            
 Set @HTMLBODY = ''                            
 Declare @Sub varchar(200)                            
 Set @Sub = 'Tbl_Emptree Update Status on ' + (Select Convert(varchar(11),Getdate(),113))  + ''                            
                             
 If Exists(Select Top 1 * From Tbl_EmpTree)                            
 Begin                            
  Set @HTMLBODY =  'Tbl_EmpTree Data Updated With ' + Convert (Varchar(10),(Select Count(*) From Tbl_Emptree)) + ' Records.'                            
 End                            
 Else                            
 Begin                            
  Set @HTMLBODY =  'Tbl_EmpTree Data Is Empty.'                            
 End                    
                            
 If(@HTMLBODY IS NOT NULL and @HTMLBODY <> '')                            
 Begin                            
  EXEC msdb.dbo.sp_send_dbmail                                                     
   @profile_name = 'ITasset@angelbroking.com',                                                                           
   @recipients='prashant.patade@angelbroking.com' ,                                                     
   @subject = @Sub,                                                    
   @body = @HTMLBODY,                                                    
   @body_format = 'HTML'                                
                            
 End                             
-----------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_EmpTreeUpdate_20May2017
-- --------------------------------------------------
CREATE proc [dbo].[Usp_EmpTreeUpdate_20May2017]                          
as     
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
                          
--------NOTE----------------                          
-- The table tbl_EmpTree has Default value as '' for all varchar columns and (0) for all datetime colums                          
--and Emp_Id is set As Primary Key                          
--But When We import this table from 196.1.115.158.[ITAssests].dbo.tbl_EmpTree to 172.29.19.8.[ITAssets_NEW].dbo.tbl_EmpTree                          
--the default values are not set and also the primary key is not set                          
--so make sure to make these chages on the test server also wherever the table tbl_Emptree is imporated.                          
--If necessacry see what are the defalut values on 196.1.115.158.[ITAssests].dbo.tbl_EmpTree table                          
--and make the same changes on 172.29.19.8.[ITAssets_NEW].dbo.tbl_EmpTree after table is imporated.                          
--other releated table tbl_EmpTree_Prev,tbl_EmpTree_Log does not contain any defaultvalues nor the primary key                          
--so no problem for them.                          
---------------------------------------------------                          
truncate table tbl_EmpTree_Prev                          
Insert into tbl_EmpTree_Prev                          
select * from tbl_EmpTree                          
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_Prev',count(*),getdate() from tbl_EmpTree_Prev with (nolock)                          
                          
truncate table tbl_EmpTree                          
Insert into tbl_EmpTree(Emp_Id,Emp_Name,Desig,Senior,Sr_Name,Branch_Code,Join_Date,Sep_Date,                          
      Emp_Region,Emp_Zone,Emp_Br_Region,Emp_Br_Zone,BH,CH,RH,ZH,RSM,ASM,                          
      SrAVPIT,HeadIT,ADIT,EDCFO,CSO,UpdateDate,SrUpdateDate)                          
                          
Select distinct Emp_NO,EMP_NAME,Designation,isnull(Senior,''),isnull(Sr_name,''),Branch_Cd,join_date,                          
  isnull(separation_date,'') as [Separation_Date],E.Region As [Emp_Region],E.Zone As [Emp_Zone],                          
  V.Region As [Emp_branch_Region],V.Zone As [Emp_branch_Zone],                          
  isnull(branchHead,''),isnull(clusterHead,''),isnull(regionalHead,''),isnull(zonalHead,''),                          
  isnull(RegionalSalesManager,''),isnull([Area Sales Manager],''),                          
  --'E22062',                      
  --'','P00226','P00104','E22230','P00068',getdate(),getdate()                    //commented by harshal at 5 apr 2013      
  '','E63575','P00104','E22230','P00068',getdate(),getdate()                          
from emp_info E, VLMS_RolemasterEquity V                          
where Branch_Cd = (case when isnull(Harmonycostcode,'') <> '' then Harmonycostcode else biBranch end)                          
                       
/*----zeba                         
UPDATE tbl_emptree                         
SET AVP='E07260'                        
WHERE branch_code IN ('HO','ACM',                        
'AKSTR',                        
'BOK',                        
'CSO',                        
'CALNT',                        
'ELITE',                        
'PMOS',                        
'CSOHYD',                        
'DEPOSITORY',                        
'DMAT',                        
'INSUR')                        
AND AVP=''                        
AND Sep_Date ='1900-01-01 00:00:00.000'--IS NULL                        
-----zeba end  */                      
                    
----Zeba---for the recommender  process by HOD should not include in below designations..                    
    update tbl_emptree                    
       set avp='E07260'                    
       where emp_id in                    
      -- select emp_id,emp_name from                    
      (select emp_id  from tbl_emptree where senior in (select emp_id from tbl_emptree where desig in                    
      ('Chief Strategy Officer',                    
       'Executive Director-CFO' ,                    
       'Executive Director-CFO' ,                                                                                                
       'Professional',                    
       'Associate Director'  ,                                                  
    'Executive Director'  ,                                   
       'Executive Director-CFO')))                     
                           
    -----Zeba-----                       
                           
                         
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree',count(*),getdate() from tbl_EmpTree with (nolock)                          
                          
                          
                          
--------Remove i.e Set BH,CH,RH,ZH as '' where They are only BH,CH,RH,ZH    OR                          
-------if they are decativated from harmony then they are not in our emp_info                          
-------so set  BH,CH,RH,ZH colums as '' for all employess where they are BH,CH,RH,ZH                            
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveBH',count(*),getdate() from tbl_EmpTree with (nolock)                     
where emp_id = BH or (BH <> '' and BH not in (select distinct Emp_NO from emp_info with (nolock)))                          
                          
update tbl_EmpTree set BH=''                           
where emp_id = BH or (BH <> '' and BH not in (select distinct Emp_NO from emp_info with (nolock)))                          
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveCH',count(*),getdate() from tbl_EmpTree with (nolock)                           
where emp_id = CH or (CH <> '' and CH not in (select distinct Emp_NO from emp_info with (nolock)))                          
                          
update tbl_EmpTree set CH=''                           
where emp_id = CH or (CH <> '' and CH not in (select distinct Emp_NO from emp_info with (nolock)))                          
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveRH',count(*),getdate() from tbl_EmpTree with (nolock)                           
where emp_id = RH or (RH <> '' and RH not in (select distinct Emp_NO from emp_info with (nolock)))                          
                          
update tbl_EmpTree set RH=''                           
where emp_id = RH or (RH <> '' and RH not in (select distinct Emp_NO from emp_info with (nolock)))                          
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveZH',count(*),getdate() from tbl_EmpTree with (nolock)                           
where emp_id = ZH or (ZH <> '' and ZH not in (select distinct Emp_NO from emp_info with (nolock)))                          
                          
update tbl_EmpTree set ZH=''                           
where emp_id = ZH or (ZH <> '' and ZH not in (select distinct Emp_NO from emp_info with (nolock)))                          
                          
------------------ Remove Separated BH,CH,RH,ZH ------------------                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveBH',count(*),getdate()                           
from tbl_EmpTree with (nolock), emp_info with (nolock)                          
where Emp_NO = BH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
         
update tbl_EmpTree set BH = '' from emp_info where Emp_NO = BH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
           
                       
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveCH',count(*),getdate()                          
from tbl_EmpTree with (nolock), emp_info with (nolock)                          
where Emp_NO = CH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
update tbl_EmpTree set CH = '' from emp_info where Emp_NO = CH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                 
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveRH',count(*),getdate()                          
from tbl_EmpTree with (nolock), emp_info with (nolock)                          
where Emp_NO = RH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
update tbl_EmpTree set RH = '' from emp_info where Emp_NO = RH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveZH',count(*),getdate()                          
from tbl_EmpTree with (nolock), emp_info with (nolock)                          
where Emp_NO = ZH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
update tbl_EmpTree set ZH = '' from emp_info where Emp_NO = ZH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                  
                          
------15/2/2011------------------------------------------------------------------------------------                          
                  
                  
                          
Declare @Emp_Id varchar(50)                          
Declare Rec Cursor for                          
 Select emp_id from  tbl_EmpTree                          
                          
OPEN Rec                          
                           
 FETCH Rec into @Emp_Id                          
  While(@@fetch_status=0)                          
  Begin                          
   Exec USP_GetEmpTree @Emp_Id                          
   FETCH Rec into @Emp_Id                          
  End                          
                          
Close Rec                          
deallocate Rec                           
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd_Cursor','tbl_EmpTree',count(*),getdate() from tbl_EmpTree with (nolock)                          
where AVP <> '' or SrAVP <> '' or VP <> '' or SrVP <> '' or ED <> ''                          
                          
------------------ Remove Separated AVP,SrAVP,VP,SrVP,ED ------------------                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveAVP',count(*),getdate()                           
from tbl_EmpTree with (nolock), emp_info with (nolock)                          
where Emp_NO = AVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
update tbl_EmpTree set AVP = '' from emp_info where Emp_NO = AVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveSrAVP',count(*),getdate()                           
from tbl_EmpTree with (nolock), emp_info with (nolock)                          
where Emp_NO = SrAVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
update tbl_EmpTree set SrAVP = '' from emp_info where Emp_NO = SrAVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveVP',count(*),getdate()                           
from tbl_EmpTree with (nolock), emp_info with (nolock)                          
where Emp_NO = VP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
update tbl_EmpTree set VP = '' from emp_info where Emp_NO = VP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
insert into tbl_EmpTree_Log                       
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveSrVP',count(*),getdate()                           
from tbl_EmpTree with (nolock), emp_info with (nolock)                          
where Emp_NO = SrVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                        
update tbl_EmpTree set SrVP = '' from emp_info where Emp_NO = SrVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveED',count(*),getdate()                           
from tbl_EmpTree with (nolock), emp_info with (nolock)                          
where Emp_NO = ED and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
                          
update tbl_EmpTree set ED = '' from emp_info where Emp_NO = ED and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                          
-----------------------------------------------------------------------                          
                          
delete from tbl_EmpTree_Prev where Emp_Id in (                          
select E.Emp_Id                           
from tbl_EmpTree E with (nolock), tbl_EmpTree_Prev P with (nolock)                          
where E.Emp_Id = P.Emp_Id and E.Emp_Name = P.Emp_Name and E.Desig = P.Desig                          
and E.Senior = P.Senior and E.Sr_Name = P.Sr_Name and E.Branch_Code = P.Branch_Code                          
and E.Join_Date = P.Join_Date and E.Sep_Date = P.Sep_Date and E.Emp_Region = P.Emp_Region                          
and E.Emp_Zone = P.Emp_Zone and E.Emp_Br_Region = P.Emp_Br_Region and E.Emp_Br_Zone = P.Emp_Br_Zone                          
and E.BH = P.BH and E.CH = P.CH and E.RH = P.RH and E.ZH = P.ZH and E.RSM = P.RSM and E.ASM = P.ASM                          
and E.AVP = P.AVP and E.SrAVP = P.SrAVP and E.VP = P.VP and E.SrVP = P.SrVP                          
and E.SrAVPIT = P.SrAVPIT and E.HeadIT = P.HeadIT and E.ADIT = P.ADIT and E.ED = P.ED                          
and E.EDCFO = P.EDCFO and E.CSO = P.CSO                          
and E.UpdateDate > P.UpdateDate and E.SrUpdateDate > P.SrUpdateDate                          
)                          
                          
Insert into tbl_EmpTree_Arch                          
select *, getdate() from tbl_EmpTree_Prev                          
                          
insert into tbl_EmpTree_Log                          
select 'Usp_EmpTree_Upd_Arch','tbl_EmpTree_Arch',count(*),getdate() from tbl_EmpTree_Arch with (nolock)                   
where convert(varchar(11),CreateDate,121) = convert(varchar(11),getdate(),121)                          
                          
truncate table tbl_EmpTree_Prev                          
----------------------------------                
-----------------------------------                  
  -----------updated by ZEBA to PORVIDE THE APPROVAL AS PER THE DESIGNATIONWISE                
                
update tbl_EmpTree            
set BH='',CH=''            
where desig in ('Branch Head','Cluster Head','Regional head','Zonal Head')            
                          
          
--select * from tbl_emptree where bh='E35563'          
          
--zeba           
update tbl_EmpTree          
set bh='E46896'          
where bh='E35563'          
  
--zeba           
update tbl_EmpTree          
set cso='P01015'          
where emp_id='E49094'   
  
update tbl_EmpTree          
set RH='P00202'          
where emp_id='E48480'          
                  
           
-----                        
--------SEND MAIL--------------                          
 Declare @HTMLBODY varchar(500)                          
 Set @HTMLBODY = ''                          
 Declare @Sub varchar(200)                          
 Set @Sub = 'Tbl_Emptree Update Status on ' + (Select Convert(varchar(11),Getdate(),113))  + ''                          
                           
 If Exists(Select Top 1 * From Tbl_EmpTree)                          
 Begin                          
  Set @HTMLBODY =  'Tbl_EmpTree Data Updated With ' + Convert (Varchar(10),(Select Count(*) From Tbl_Emptree)) + ' Records.'                          
 End                          
 Else                          
 Begin                          
  Set @HTMLBODY =  'Tbl_EmpTree Data Is Empty.'                          
 End                  
                          
 If(@HTMLBODY IS NOT NULL and @HTMLBODY <> '')                          
 Begin                          
  EXEC msdb.dbo.sp_send_dbmail                                                   
   @profile_name = 'ITasset@angelbroking.com',                                                                         
   @recipients='sandeep.rai@angelbroking.com' ,                                                   
   @subject = @Sub,                                                  
   @body = @HTMLBODY,                                                  
   @body_format = 'HTML'                              
                          
 End                           
-----------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_EmpTreeUpdate_bkp_5Apr2013
-- --------------------------------------------------





                    
                    
                    
CREATE proc [dbo].[Usp_EmpTreeUpdate_bkp_5Apr2013]                    
as   

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
                 
                    
--------NOTE----------------                    
-- The table tbl_EmpTree has Default value as '' for all varchar columns and (0) for all datetime colums                    
--and Emp_Id is set As Primary Key                    
--But When We import this table from 196.1.115.158.[ITAssests].dbo.tbl_EmpTree to 172.29.19.8.[ITAssets_NEW].dbo.tbl_EmpTree                    
--the default values are not set and also the primary key is not set                    
--so make sure to make these chages on the test server also wherever the table tbl_Emptree is imporated.                    
--If necessacry see what are the defalut values on 196.1.115.158.[ITAssests].dbo.tbl_EmpTree table                    
--and make the same changes on 172.29.19.8.[ITAssets_NEW].dbo.tbl_EmpTree after table is imporated.                    
--other releated table tbl_EmpTree_Prev,tbl_EmpTree_Log does not contain any defaultvalues nor the primary key                    
--so no problem for them.                    
---------------------------------------------------                    
truncate table tbl_EmpTree_Prev                    
Insert into tbl_EmpTree_Prev                    
select * from tbl_EmpTree                    
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_Prev',count(*),getdate() from tbl_EmpTree_Prev with (nolock)                    
                    
truncate table tbl_EmpTree                    
Insert into tbl_EmpTree(Emp_Id,Emp_Name,Desig,Senior,Sr_Name,Branch_Code,Join_Date,Sep_Date,                    
      Emp_Region,Emp_Zone,Emp_Br_Region,Emp_Br_Zone,BH,CH,RH,ZH,RSM,ASM,                    
      SrAVPIT,HeadIT,ADIT,EDCFO,CSO,UpdateDate,SrUpdateDate)                    
                    
Select Emp_NO,EMP_NAME,Designation,isnull(Senior,''),isnull(Sr_name,''),Branch_Cd,join_date,                    
  isnull(separation_date,'') as [Separation_Date],E.Region As [Emp_Region],E.Zone As [Emp_Zone],                    
  V.Region As [Emp_branch_Region],V.Zone As [Emp_branch_Zone],                    
  isnull(branchHead,''),isnull(clusterHead,''),isnull(regionalHead,''),isnull(zonalHead,''),                    
  isnull(RegionalSalesManager,''),isnull([Area Sales Manager],''),                    
  --'E22062',                
  '','P00226','P00104','E22230','P00068',getdate(),getdate()                    
from emp_info E, VLMS_RolemasterEquity V                    
where Branch_Cd = (case when isnull(Harmonycostcode,'') <> '' then Harmonycostcode else biBranch end)                    
                 
/*----zeba                   
UPDATE tbl_emptree                   
SET AVP='E07260'                  
WHERE branch_code IN ('HO','ACM',                  
'AKSTR',                  
'BOK',                  
'CSO',                  
'CALNT',                  
'ELITE',                  
'PMOS',                  
'CSOHYD',                  
'DEPOSITORY',                  
'DMAT',                  
'INSUR')                  
AND AVP=''                  
AND Sep_Date ='1900-01-01 00:00:00.000'--IS NULL                  
-----zeba end  */                
              
----Zeba---for the recommender  process by HOD should not include in below designations..              
    update tbl_emptree              
       set avp='E07260'              
       where emp_id in              
      -- select emp_id,emp_name from              
      (select emp_id  from tbl_emptree where senior in (select emp_id from tbl_emptree where desig in              
      ('Chief Strategy Officer',              
       'Executive Director-CFO' ,              
       'Executive Director-CFO' ,                                                                                          
       'Professional',              
       'Associate Director'  ,                                            
    'Executive Director'  ,                             
       'Executive Director-CFO')))               
                     
    -----Zeba-----                 
                     
                   
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree',count(*),getdate() from tbl_EmpTree with (nolock)                    
                    
                    
                    
--------Remove i.e Set BH,CH,RH,ZH as '' where They are only BH,CH,RH,ZH    OR                    
-------if they are decativated from harmony then they are not in our emp_info                    
-------so set  BH,CH,RH,ZH colums as '' for all employess where they are BH,CH,RH,ZH                      
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveBH',count(*),getdate() from tbl_EmpTree with (nolock)               
where emp_id = BH or (BH <> '' and BH not in (select distinct Emp_NO from emp_info with (nolock)))                    
                    
update tbl_EmpTree set BH=''                     
where emp_id = BH or (BH <> '' and BH not in (select distinct Emp_NO from emp_info with (nolock)))                    
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveCH',count(*),getdate() from tbl_EmpTree with (nolock)                     
where emp_id = CH or (CH <> '' and CH not in (select distinct Emp_NO from emp_info with (nolock)))                    
                    
update tbl_EmpTree set CH=''                     
where emp_id = CH or (CH <> '' and CH not in (select distinct Emp_NO from emp_info with (nolock)))                    
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveRH',count(*),getdate() from tbl_EmpTree with (nolock)                     
where emp_id = RH or (RH <> '' and RH not in (select distinct Emp_NO from emp_info with (nolock)))                    
                    
update tbl_EmpTree set RH=''                     
where emp_id = RH or (RH <> '' and RH not in (select distinct Emp_NO from emp_info with (nolock)))                    
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveZH',count(*),getdate() from tbl_EmpTree with (nolock)                     
where emp_id = ZH or (ZH <> '' and ZH not in (select distinct Emp_NO from emp_info with (nolock)))                    
                    
update tbl_EmpTree set ZH=''                     
where emp_id = ZH or (ZH <> '' and ZH not in (select distinct Emp_NO from emp_info with (nolock)))                    
                    
------------------ Remove Separated BH,CH,RH,ZH ------------------                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveBH',count(*),getdate()                     
from tbl_EmpTree with (nolock), emp_info with (nolock)                    
where Emp_NO = BH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
                    
update tbl_EmpTree set BH = '' from emp_info where Emp_NO = BH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
     
                 
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveCH',count(*),getdate()                    
from tbl_EmpTree with (nolock), emp_info with (nolock)                    
where Emp_NO = CH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
update tbl_EmpTree set CH = '' from emp_info where Emp_NO = CH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
           
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveRH',count(*),getdate()                    
from tbl_EmpTree with (nolock), emp_info with (nolock)                    
where Emp_NO = RH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
update tbl_EmpTree set RH = '' from emp_info where Emp_NO = RH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveZH',count(*),getdate()                    
from tbl_EmpTree with (nolock), emp_info with (nolock)                    
where Emp_NO = ZH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
update tbl_EmpTree set ZH = '' from emp_info where Emp_NO = ZH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
            
                    
------15/2/2011------------------------------------------------------------------------------------                    
            
            
                    
Declare @Emp_Id varchar(50)                    
Declare Rec Cursor for                    
 Select emp_id from  tbl_EmpTree                    
                    
OPEN Rec                    
                     
 FETCH Rec into @Emp_Id                    
  While(@@fetch_status=0)                    
  Begin                    
   Exec USP_GetEmpTree @Emp_Id                    
   FETCH Rec into @Emp_Id                    
  End                    
                    
Close Rec                    
deallocate Rec                     
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd_Cursor','tbl_EmpTree',count(*),getdate() from tbl_EmpTree with (nolock)                    
where AVP <> '' or SrAVP <> '' or VP <> '' or SrVP <> '' or ED <> ''                    
                    
------------------ Remove Separated AVP,SrAVP,VP,SrVP,ED ------------------                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveAVP',count(*),getdate()                     
from tbl_EmpTree with (nolock), emp_info with (nolock)                    
where Emp_NO = AVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
update tbl_EmpTree set AVP = '' from emp_info where Emp_NO = AVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveSrAVP',count(*),getdate()                     
from tbl_EmpTree with (nolock), emp_info with (nolock)                    
where Emp_NO = SrAVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
update tbl_EmpTree set SrAVP = '' from emp_info where Emp_NO = SrAVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveVP',count(*),getdate()                     
from tbl_EmpTree with (nolock), emp_info with (nolock)                    
where Emp_NO = VP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
update tbl_EmpTree set VP = '' from emp_info where Emp_NO = VP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
insert into tbl_EmpTree_Log                 
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveSrVP',count(*),getdate()                     
from tbl_EmpTree with (nolock), emp_info with (nolock)                    
where Emp_NO = SrVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                  
update tbl_EmpTree set SrVP = '' from emp_info where Emp_NO = SrVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveED',count(*),getdate()                     
from tbl_EmpTree with (nolock), emp_info with (nolock)                    
where Emp_NO = ED and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
                    
update tbl_EmpTree set ED = '' from emp_info where Emp_NO = ED and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                    
-----------------------------------------------------------------------                    
                    
delete from tbl_EmpTree_Prev where Emp_Id in (                    
select E.Emp_Id                     
from tbl_EmpTree E with (nolock), tbl_EmpTree_Prev P with (nolock)                    
where E.Emp_Id = P.Emp_Id and E.Emp_Name = P.Emp_Name and E.Desig = P.Desig                    
and E.Senior = P.Senior and E.Sr_Name = P.Sr_Name and E.Branch_Code = P.Branch_Code                    
and E.Join_Date = P.Join_Date and E.Sep_Date = P.Sep_Date and E.Emp_Region = P.Emp_Region                    
and E.Emp_Zone = P.Emp_Zone and E.Emp_Br_Region = P.Emp_Br_Region and E.Emp_Br_Zone = P.Emp_Br_Zone                    
and E.BH = P.BH and E.CH = P.CH and E.RH = P.RH and E.ZH = P.ZH and E.RSM = P.RSM and E.ASM = P.ASM                    
and E.AVP = P.AVP and E.SrAVP = P.SrAVP and E.VP = P.VP and E.SrVP = P.SrVP                    
and E.SrAVPIT = P.SrAVPIT and E.HeadIT = P.HeadIT and E.ADIT = P.ADIT and E.ED = P.ED                    
and E.EDCFO = P.EDCFO and E.CSO = P.CSO                    
and E.UpdateDate > P.UpdateDate and E.SrUpdateDate > P.SrUpdateDate                    
)                    
                    
Insert into tbl_EmpTree_Arch                    
select *, getdate() from tbl_EmpTree_Prev                    
                    
insert into tbl_EmpTree_Log                    
select 'Usp_EmpTree_Upd_Arch','tbl_EmpTree_Arch',count(*),getdate() from tbl_EmpTree_Arch with (nolock)                    
where convert(varchar(11),CreateDate,121) = convert(varchar(11),getdate(),121)                    
                    
truncate table tbl_EmpTree_Prev                    
----------------------------------          
-----------------------------------            
  -----------updated by ZEBA to PORVIDE THE APPROVAL AS PER THE DESIGNATIONWISE          
          
update tbl_EmpTree      
set BH='',CH=''      
where desig in ('Branch Head','Cluster Head','Regional head','Zonal Head')      
                    
    
--select * from tbl_emptree where bh='E35563'    
    
--zeba     
update tbl_EmpTree    
set bh='E46896'    
where bh='E35563'    
     
-----                  
--------SEND MAIL--------------                    
 Declare @HTMLBODY varchar(500)                    
 Set @HTMLBODY = ''                    
 Declare @Sub varchar(200)                    
 Set @Sub = 'Tbl_Emptree Update Status on ' + (Select Convert(varchar(11),Getdate(),113))  + ''                    
                     
 If Exists(Select Top 1 * From Tbl_EmpTree)                    
 Begin                    
  Set @HTMLBODY =  'Tbl_EmpTree Data Updated With ' + Convert (Varchar(10),(Select Count(*) From Tbl_Emptree)) + ' Records.'                    
 End                    
 Else                    
 Begin                    
  Set @HTMLBODY =  'Tbl_EmpTree Data Is Empty.'                    
 End            
                    
 If(@HTMLBODY IS NOT NULL and @HTMLBODY <> '')                    
 Begin                    
  EXEC msdb.dbo.sp_send_dbmail                                             
   @profile_name = 'ITassets',                                                                   
   @recipients='ZEBA.RAJE@angelbroking.com' ,                                             
   @subject = @Sub,                                            
   @body = @HTMLBODY,                                            
   @body_format = 'HTML'                        
                    
 End                     
-----------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_EmpTreeUpdate29sep2018
-- --------------------------------------------------
CREATE proc [dbo].[Usp_EmpTreeUpdate29sep2018]                            
as       
    
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
                            
--------NOTE----------------                            
-- The table tbl_EmpTree has Default value as '' for all varchar columns and (0) for all datetime colums                            
--and Emp_Id is set As Primary Key                            
--But When We import this table from 196.1.115.158.[ITAssests].dbo.tbl_EmpTree to 172.29.19.8.[ITAssets_NEW].dbo.tbl_EmpTree                            
--the default values are not set and also the primary key is not set                            
--so make sure to make these chages on the test server also wherever the table tbl_Emptree is imporated.                            
--If necessacry see what are the defalut values on 196.1.115.158.[ITAssests].dbo.tbl_EmpTree table                            
--and make the same changes on 172.29.19.8.[ITAssets_NEW].dbo.tbl_EmpTree after table is imporated.                            
--other releated table tbl_EmpTree_Prev,tbl_EmpTree_Log does not contain any defaultvalues nor the primary key                            
--so no problem for them.                            
---------------------------------------------------                            
truncate table tbl_EmpTree_Prev                            
Insert into tbl_EmpTree_Prev                            
select * from tbl_EmpTree                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_Prev',count(*),getdate() from tbl_EmpTree_Prev with (nolock)                            
  
  
  
Select Row_number() over(partition by Emp_no order by Emp_no) as RecID,Emp_NO,EMP_NAME,Designation,Senior=isnull(Senior,''),Sr_name=isnull(Sr_name,''),Branch_Cd,join_date,                            
  isnull(separation_date,'') as [Separation_Date],E.Region As [Emp_Region],E.Zone As [Emp_Zone],                            
  V.Region As [Emp_branch_Region],V.Zone As [Emp_branch_Zone],                            
  branchHead=isnull(branchHead,''),clusterHead=isnull(clusterHead,''),regionalHead=isnull(regionalHead,''),zonalHead=isnull(zonalHead,''),                            
  RegionalSalesManager=isnull(RegionalSalesManager,''),[Area Sales Manager]=isnull([Area Sales Manager],''),                            
  --'E22062',                        
  --'','P00226','P00104','E22230','P00068',getdate(),getdate()                    //commented by harshal at 5 apr 2013        
  SrAVPIT='',HeadIT='E63575',ADIT='P00104',EDCFO='E22230',CSO='P00068',UpdateDate=getdate(),SrUpdateDate=getdate()                            
into #t  
 from emp_info E, VLMS_RolemasterEquity V                            
where Branch_Cd = (case when isnull(Harmonycostcode,'') <> '' then Harmonycostcode else biBranch end)       
and  e.Region=v.Region  
  
  
Select Row_number() over(partition by Emp_no order by Emp_no) as RecID,Emp_NO,EMP_NAME,Designation,Senior=isnull(Senior,''),Sr_name=isnull(Sr_name,''),Branch_Cd,join_date,                            
  isnull(separation_date,'') as [Separation_Date],E.Region As [Emp_Region],E.Zone As [Emp_Zone],                            
  V.Region As [Emp_branch_Region],V.Zone As [Emp_branch_Zone],                            
  branchHead=isnull(branchHead,''),clusterHead=isnull(clusterHead,''),regionalHead=isnull(regionalHead,''),zonalHead=isnull(zonalHead,''),                            
  RegionalSalesManager=isnull(RegionalSalesManager,''),[Area Sales Manager]=isnull([Area Sales Manager],''),                            
  --'E22062',                        
  --'','P00226','P00104','E22230','P00068',getdate(),getdate()                    //commented by harshal at 5 apr 2013        
  SrAVPIT='',HeadIT='E63575',ADIT='P00104',EDCFO='E22230',CSO='P00068',UpdateDate=getdate(),SrUpdateDate=getdate()                            
into #t2  
 from emp_info E, VLMS_RolemasterEquity V                            
where Branch_Cd = biBranch        
and  e.Region=v.Region   
  
Select Row_number() over(partition by Emp_no order by Emp_no) as RecID,Emp_NO,EMP_NAME,Designation,Senior=isnull(Senior,''),Sr_name=isnull(Sr_name,''),Branch_Cd,join_date,                            
  isnull(separation_date,'') as [Separation_Date],E.Region As [Emp_Region],E.Zone As [Emp_Zone],                            
  V.Region As [Emp_branch_Region],V.Zone As [Emp_branch_Zone],                            
  branchHead=isnull(branchHead,''),clusterHead=isnull(clusterHead,''),regionalHead=isnull(regionalHead,''),zonalHead=isnull(zonalHead,''),                            
  RegionalSalesManager=isnull(RegionalSalesManager,''),[Area Sales Manager]=isnull([Area Sales Manager],''),                            
  --'E22062',                        
  --'','P00226','P00104','E22230','P00068',getdate(),getdate()                    //commented by harshal at 5 apr 2013        
  SrAVPIT='',HeadIT='E63575',ADIT='P00104',EDCFO='E22230',CSO='P00068',UpdateDate=getdate(),SrUpdateDate=getdate()                            
into #t5  
 from emp_info E, VLMS_RolemasterEquity V                            
where Branch_Cd = biBranch        
   
delete from #t5 where emp_no in (select emp_no from #t)  
delete from #t5 where emp_no in (select emp_no from #t2)  
  
delete from #t5 where  recid=2 and RegionalSalesManager=''  
delete from #t5 where  recid>2  
delete from #t5 where  recid=1 and emp_no in (select emp_no from #t5 where  recid=2 and RegionalSalesManager<>'')  
  
  
select * into #t6 from #t5 where recid=1  
union all  
select * from #t5 where recid=2  
  
  
delete from #t2 where emp_no in (select emp_no from #t)  
  
delete from #t2 where  recid=2 and RegionalSalesManager=''  
delete from #t2 where  recid>2  
delete from #t2 where  recid=1 and emp_no in (select emp_no from #t2 where  recid=2 and RegionalSalesManager<>'')  
  
select * into #t3 from #t2 where recid=1  
union  
select * from #t2 where recid=2  
  
delete from #t where  recid=2 and RegionalSalesManager=''  
delete from #t where  recid>2   
delete from #t where  recid=1 and emp_no in (select emp_no from #t where  recid=2 and RegionalSalesManager<>'')  
  
select * into #t1 from #t where recid=1  
union all  
select * from #t where recid=2  
  
select * into #tFinal from #t1  
union all  
select * from #t2   
union all  
select * from #t6  
--where emp_no='E00030'  
--drop table #tFinal   
  
--select emp_no,count(*) from #tFinal   
--group by emp_no  
--having count(*)>1  
  
truncate table tbl_EmpTree                            
Insert into tbl_EmpTree(Emp_Id,Emp_Name,Desig,Senior,Sr_Name,Branch_Code,Join_Date,Sep_Date,                            
      Emp_Region,Emp_Zone,Emp_Br_Region,Emp_Br_Zone,BH,CH,RH,ZH,RSM,ASM,                            
      SrAVPIT,HeadIT,ADIT,EDCFO,CSO,UpdateDate,SrUpdateDate)                            
select   
Emp_NO,EMP_NAME,Designation,Senior,Sr_name,Branch_Cd,join_date,Separation_Date,Emp_Region,Emp_Zone,Emp_branch_Region,Emp_branch_Zone,  
branchHead,clusterHead,regionalHead,zonalHead,RegionalSalesManager,[Area Sales Manager],SrAVPIT,HeadIT,ADIT,EDCFO,  
CSO,UpdateDate,SrUpdateDate from #tFinal                            
  
                         
/*----zeba                           
UPDATE tbl_emptree                           
SET AVP='E07260'                          
WHERE branch_code IN ('HO','ACM',                          
'AKSTR',                          
'BOK',                          
'CSO',                          
'CALNT',                          
'ELITE',                          
'PMOS',                          
'CSOHYD',                          
'DEPOSITORY',                          
'DMAT',                          
'INSUR')                          
AND AVP=''                          
AND Sep_Date ='1900-01-01 00:00:00.000'--IS NULL                          
-----zeba end  */                        
                      
----Zeba---for the recommender  process by HOD should not include in below designations..                      
    update tbl_emptree                      
       set avp='E07260'                      
       where emp_id in                      
      -- select emp_id,emp_name from                      
      (select emp_id  from tbl_emptree where senior in (select emp_id from tbl_emptree where desig in                      
      ('Chief Strategy Officer',                      
       'Executive Director-CFO' ,                      
       'Executive Director-CFO' ,                                                                                                  
       'Professional',                      
       'Associate Director'  ,                                                    
    'Executive Director'  ,                                     
       'Executive Director-CFO')))                       
                             
    -----Zeba-----                         
                             
                           
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree',count(*),getdate() from tbl_EmpTree with (nolock)                            
                            
                            
                            
--------Remove i.e Set BH,CH,RH,ZH as '' where They are only BH,CH,RH,ZH    OR                            
-------if they are decativated from harmony then they are not in our emp_info                            
-------so set  BH,CH,RH,ZH colums as '' for all employess where they are BH,CH,RH,ZH                              
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveBH',count(*),getdate() from tbl_EmpTree with (nolock)                       
where emp_id = BH or (BH <> '' and BH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
update tbl_EmpTree set BH=''                             
where emp_id = BH or (BH <> '' and BH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveCH',count(*),getdate() from tbl_EmpTree with (nolock)                             
where emp_id = CH or (CH <> '' and CH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
update tbl_EmpTree set CH=''                             
where emp_id = CH or (CH <> '' and CH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveRH',count(*),getdate() from tbl_EmpTree with (nolock)                             
where emp_id = RH or (RH <> '' and RH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
update tbl_EmpTree set RH=''                             
where emp_id = RH or (RH <> '' and RH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveZH',count(*),getdate() from tbl_EmpTree with (nolock)                             
where emp_id = ZH or (ZH <> '' and ZH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
update tbl_EmpTree set ZH=''                             
where emp_id = ZH or (ZH <> '' and ZH not in (select distinct Emp_NO from emp_info with (nolock)))                            
                            
------------------ Remove Separated BH,CH,RH,ZH ------------------                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveBH',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = BH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
           
update tbl_EmpTree set BH = '' from emp_info where Emp_NO = BH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
             
                         
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveCH',count(*),getdate()                            
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = CH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set CH = '' from emp_info where Emp_NO = CH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                   
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveRH',count(*),getdate()                            
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = RH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set RH = '' from emp_info where Emp_NO = RH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveZH',count(*),getdate()                            
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = ZH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set ZH = '' from emp_info where Emp_NO = ZH and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                    
                            
------15/2/2011------------------------------------------------------------------------------------                            
                    
                    
                            
Declare @Emp_Id varchar(50)                            
Declare Rec Cursor for                            
 Select emp_id from  tbl_EmpTree                            
                            
OPEN Rec                            
                             
 FETCH Rec into @Emp_Id                            
  While(@@fetch_status=0)                            
  Begin                            
   Exec USP_GetEmpTree @Emp_Id                            
   FETCH Rec into @Emp_Id                            
  End                            
                            
Close Rec                            
deallocate Rec                             
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd_Cursor','tbl_EmpTree',count(*),getdate() from tbl_EmpTree with (nolock)                            
where AVP <> '' or SrAVP <> '' or VP <> '' or SrVP <> '' or ED <> ''                            
                            
------------------ Remove Separated AVP,SrAVP,VP,SrVP,ED ------------------                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveAVP',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = AVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set AVP = '' from emp_info where Emp_NO = AVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveSrAVP',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = SrAVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set SrAVP = '' from emp_info where Emp_NO = SrAVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveVP',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = VP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set VP = '' from emp_info where Emp_NO = VP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
insert into tbl_EmpTree_Log                         
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveSrVP',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = SrVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                          
update tbl_EmpTree set SrVP = '' from emp_info where Emp_NO = SrVP and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd','tbl_EmpTree_NoActiveED',count(*),getdate()                             
from tbl_EmpTree with (nolock), emp_info with (nolock)                            
where Emp_NO = ED and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
                            
update tbl_EmpTree set ED = '' from emp_info where Emp_NO = ED and separation_date is not null and  separation_date > '1900-01-01' and separation_date <= getdate()                            
-----------------------------------------------------------------------                            
                            
delete from tbl_EmpTree_Prev where Emp_Id in (                            
select E.Emp_Id                             
from tbl_EmpTree E with (nolock), tbl_EmpTree_Prev P with (nolock)                            
where E.Emp_Id = P.Emp_Id and E.Emp_Name = P.Emp_Name and E.Desig = P.Desig                            
and E.Senior = P.Senior and E.Sr_Name = P.Sr_Name and E.Branch_Code = P.Branch_Code                            
and E.Join_Date = P.Join_Date and E.Sep_Date = P.Sep_Date and E.Emp_Region = P.Emp_Region                            
and E.Emp_Zone = P.Emp_Zone and E.Emp_Br_Region = P.Emp_Br_Region and E.Emp_Br_Zone = P.Emp_Br_Zone                            
and E.BH = P.BH and E.CH = P.CH and E.RH = P.RH and E.ZH = P.ZH and E.RSM = P.RSM and E.ASM = P.ASM                            
and E.AVP = P.AVP and E.SrAVP = P.SrAVP and E.VP = P.VP and E.SrVP = P.SrVP                            
and E.SrAVPIT = P.SrAVPIT and E.HeadIT = P.HeadIT and E.ADIT = P.ADIT and E.ED = P.ED                            
and E.EDCFO = P.EDCFO and E.CSO = P.CSO                            
and E.UpdateDate > P.UpdateDate and E.SrUpdateDate > P.SrUpdateDate                            
)                            
                            
Insert into tbl_EmpTree_Arch                            
select *, getdate() from tbl_EmpTree_Prev                            
                            
insert into tbl_EmpTree_Log                            
select 'Usp_EmpTree_Upd_Arch','tbl_EmpTree_Arch',count(*),getdate() from tbl_EmpTree_Arch with (nolock)                     
where convert(varchar(11),CreateDate,121) = convert(varchar(11),getdate(),121)                            
                            
truncate table tbl_EmpTree_Prev                            
----------------------------------                  
-----------------------------------                    
  -----------updated by ZEBA to PORVIDE THE APPROVAL AS PER THE DESIGNATIONWISE                  
                  
update tbl_EmpTree              
set BH='',CH=''              
where desig in ('Branch Head','Cluster Head','Regional head','Zonal Head')              
                            
            
--select * from tbl_emptree where bh='E35563'            
            
--zeba             
update tbl_EmpTree            
set bh='E46896'            
where bh='E35563'            
    
--zeba             
update tbl_EmpTree            
set cso='P01015'            
where emp_id='E49094'     
    
update tbl_EmpTree            
set RH='P00202'            
where emp_id='E48480'            
                    
             
-----                          
--------SEND MAIL--------------                            
 Declare @HTMLBODY varchar(500)                            
 Set @HTMLBODY = ''                            
 Declare @Sub varchar(200)                            
 Set @Sub = 'Tbl_Emptree Update Status on ' + (Select Convert(varchar(11),Getdate(),113))  + ''                            
                             
 If Exists(Select Top 1 * From Tbl_EmpTree)                            
 Begin                            
  Set @HTMLBODY =  'Tbl_EmpTree Data Updated With ' + Convert (Varchar(10),(Select Count(*) From Tbl_Emptree)) + ' Records.'                            
 End                            
 Else                            
 Begin                            
  Set @HTMLBODY =  'Tbl_EmpTree Data Is Empty.'                            
 End                    
                            
 If(@HTMLBODY IS NOT NULL and @HTMLBODY <> '')                            
 Begin                            
  EXEC msdb.dbo.sp_send_dbmail                                                     
   @profile_name = 'ITasset@angelbroking.com',                                                                           
   @recipients='sandeep.rai@angelbroking.com' ,                                                     
   @subject = @Sub,                                                    
   @body = @HTMLBODY,                                                    
   @body_format = 'HTML'                                
                            
 End                             
-----------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FetchData
-- --------------------------------------------------



CREATE Procedure [dbo].[USP_FetchData]
(
@OPTION varchar(10),
@val1 varchar(50),
@val2 varchar(50)
)
as    
Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


if(@OPTION='1')
Begin
	Select Product_Code As [Product Code],
	Product_Name As [Product Name] From tbl_CapexProductMaster 
	where Flag='1' and Product_Code is not null and Product_Code <> ''
					and Product_Name is not null and Product_Name <> '' 
	Order By Product_Name
	
End
Else if(@OPTION='2')
Begin
		Select Model_Name As [Model Name],
		Model_Id As [Model Id] From tbl_ProductModelMaster
		Where Product_Code=@val1 and Flag='1' and Model_Name is not null and Model_Name <> ''
		Order By Model_Name
End
Else if(@OPTION='3')
Begin
		Select justification_Id As [ID],
		Justification_Name As [Justification] From tbl_JustificationMaster
		--Where Status=1
End
Else if(@OPTION='4')
Begin
		Select Unit_Price As [Price]
		from  tbl_ProductModelMaster
		where Model_Id=@val1		
End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FillPODetails
-- --------------------------------------------------
  
  
  
CREATE Procedure [dbo].[USP_FillPODetails]  
(@option char(50))  
As  
Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


  
  
if(@option = 'Vendor')  
Begin  
select VendorName,VendorCode from tbl_it_vendormaster(nolock) where Status = 'A' order by VendorName  
End  
  
Else If(@option = 'AngelGroupOfCompanies')  
Begin  
select CompName,CompId from tbl_it_angelGroupofcompaniesmaster(nolock) where status='A'  
End  
  
Else If(@option = 'ITReqCon')  
Begin  
select Fld_condition,Fld_Srno from tbl_ITRequestCondition(nolock)  
End  
  
Else If(@option = 'Branch')  
Begin  
--select code+' - '+Name as BranchName,code As BranchCode  from region union select 'BOK','BOK - BANK OF KARAD' order by code+' - '+Name  
  
  
--Select Distinct biBranch As BranchName,biBranch As BranchCode  
--from VLMS_RolemasterEquity  
--order by biBranch  
  
Select rtrim(BRANCH_CODE)+' - '+rtrim(BRANCH) as BranchName,BRANCH_CODE As BranchCode from risk.dbo.branches union select 'BOK','BOK - BANK OF KARAD' order by BranchName   
End  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FillPODetails_test
-- --------------------------------------------------
  
  
  
CREATE Procedure [dbo].[USP_FillPODetails_test]  
(@option char(50))  
As  
Begin  
  
if(@option = 'Vendor')  
Begin  
select VendorName,VendorCode from tbl_it_vendormaster(nolock) where Status = 'A' order by VendorName  
End  
  
Else If(@option = 'AngelGroupOfCompanies')  
Begin  
select CompName,CompId from tbl_it_angelGroupofcompaniesmaster(nolock) where status='A'  
End  
  
Else If(@option = 'ITReqCon')  
Begin  
select Fld_condition,Fld_Srno from tbl_ITRequestCondition(nolock)  
End  
  
Else If(@option = 'Branch')  
Begin  
--select code+' - '+Name as BranchName,code As BranchCode  from region union select 'BOK','BOK - BANK OF KARAD' order by code+' - '+Name  
  
  
--Select Distinct biBranch As BranchName,biBranch As BranchCode  
--from VLMS_RolemasterEquity  
--order by biBranch  
  
Select rtrim(BRANCH_CODE)+' - '+rtrim(BRANCH) as BranchName,BRANCH_CODE As BranchCode from BOBranch union select 'BOK','BOK - BANK OF KARAD' order by BranchName   
End  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_FillPONO
-- --------------------------------------------------



CREATE proc [dbo].[Usp_FillPONO]
@Detail1 as varchar(max),
@Detail2 as varchar(Max),
@Option as int
as


Begin
  If(@Option = 1)
      Begin
      
       SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
      
          select Fld_PurchaseOrderNo ,Fld_RequestId From dbo.tbl_ItRequestPurchaseOrder
           where PO_Status in ('MPO' , 'NPO')
       End

    Else  If(@Option = 2)
       Begin


           Select distinct(RM.Request_Id) As [Request Id],CPM.Product_Name As [Item Name],
			PMM.Model_Name As [Model Name],SID.Warranty_Type As [Warranty Type],
			EI.Emp_Name As [Requested by],SM.Status_Name As [Status of Request]
		from tbl_RequestMaster RM 
			Left Outer Join tbl_CapexProductMaster CPM on RM.Item_Code = CPM.Product_code
			Left Outer Join tbl_ProductModelMaster PMM on RM.Model_No = PMM.Model_Id
			Left Outer Join Emp_Info EI on RM.Requested_By = EI.Emp_No
			Left Outer Join tbl_StatusMaster SM on RM.status_code = SM.status_Code
			Left Outer Join tbl_stockinventorydetails SID on RM.request_Id= SID.Request_Id and RM.Status_Code = SID.Assign_Type
		Left Outer Join tbl_ITRequestPurchaseOrder PO on PO.Fld_RequestID like ( '%' + '''' + CAST(RM.Request_ID AS Varchar(20)) + '''' + '%') 
           Where RM.Status_Code='PO' and  PO.Fld_RequestID  =  @Detail1

        End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FillUpReqDetails
-- --------------------------------------------------
CREATE Proc [dbo].[USP_FillUpReqDetails]      
@User_ID varchar(20),    
@Request_Id int    
    
As    
    
Begin    


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


    
declare @Category char(10)    
declare @BranchCode char(20)    
declare @U_Role char(100)    
declare @Estimated_Total_Price float    
Declare @RecommenderList nvarchar(max)    
Declare @ApproverList nvarchar(max)    
    
set @BranchCode=(select branch_cd from emp_info where emp_no =@User_ID)    
if(@BranchCode in (select branch_cd from tbl_CSO_Branch(nolock)))    
Begin    
 Set @Category='CSO'    
End    
else    
Begin    
 Set @Category='Branch'    
End    
    
    
    
    
    
set @U_Role=(Select Designation From Emp_Info where Emp_No=@User_ID and Status='A')    
    
if(@U_Role not in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager','Associate Director',' Sr. Assistant Vice President','Head'))    
Begin    
 set @U_Role='User'    
End    
    
--Select @U_Role As [Request_Initiated_By]    
    
Set @Estimated_Total_Price = (Select Estimated_total_Price From tbl_RequestMaster Where Request_Id = @Request_Id)    
    
--Select @Estimated_Total_Price As [Requested_Item_Amount]    
    
    
Set @RecommenderList = (Select substring( ( SELECT ', ' + rtrim(U_Role)     
      FROM tbl_recommendation_LimitMaster     
      Where @Estimated_Total_Price between Rec_LimitFrom and Rec_LimitTo and Category = @Category     
      FOR XML path(''), elements),2,500))     
    
Set @ApproverList = (Select substring( ( SELECT ', ' + rtrim(U_Role)     
     FROM tbl_Approval_LimitMaster    
        Where @Estimated_Total_Price between Apr_LimitFrom and Apr_LimitTo and Category = @Category     
     FOR XML path(''), elements),2,500))     
Set @ApproverList = (Select Replace (@ApproverList,'Head','Head-IT'))    
    
    
    
Select @U_Role As [Request Initiated By],@Estimated_Total_Price As[Requested Item Amount],    
  @RecommenderList As [Who Can Recommend],@ApproverList As [Who Can Approve]    
    
    
Select Distinct(EI.Emp_no) As [Emp_No],EI.Emp_Name As [Emp_Name],EI.Department As [Department],    
  EI.Designation As [Designation],EI.Branch_Cd As [Branch Code],EI.EmailAdd As [EmailAdd],PHONE As [Contact Number]    
from tbl_requestRecApr RRA    
Inner  Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no      
Inner Join tbl_RequestMaster RM On RRA.Request_Id = RM.Request_Id    
where RRA.Request_Id = @Request_Id and RRA.[Role] = 'R' and RRA.Emp_Code <> RM.Requested_By    
    
Select Distinct(EI.Emp_no) As [Emp_No],EI.Emp_Name As [Emp_Name],EI.Department As [Department],    
  EI.Designation As [Designation],EI.Branch_Cd As [Branch Code],EI.EmailAdd As [EmailAdd],PHONE As [Contact Number]    
from tbl_requestRecApr RRA    
Inner  Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no      
Inner Join tbl_RequestMaster RM On RRA.Request_Id = RM.Request_Id    
where RRA.Request_Id = @Request_Id and RRA.[Role] = 'A' and RRA.Emp_Code <> RM.Requested_By    
    
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findinJobs
-- --------------------------------------------------
CREATE Procedure [dbo].[usp_findinJobs](@Str as varchar(500))  
as  

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


select b.name,  
Case when b.enabled=1 then 'Active' else 'Deactive' end as Status,  
date_created,date_modified,a.step_id,a.step_name,a.command  
from msdb.dbo.sysjobsteps a, msdb.dbo.sysjobs b  
where command like '%'+@Str+'%'  
and a.job_id=b.job_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FINDINUSP
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[USP_FINDINUSP]                  
 @DBNAME VARCHAR(500),                
 @SRCSTR VARCHAR(500)                  
AS   
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                  
 SET NOCOUNT ON                
 SET @SRCSTR  = '%' + @SRCSTR + '%'                  
                
 DECLARE @STR AS VARCHAR(1000)                
 SET @STR=''                
 IF @DBNAME <>''                
 BEGIN                
 SET @DBNAME=@DBNAME+'.DBO.'                
 END                
 ELSE                
 BEGIN                
 SET @DBNAME=DB_NAME()+'.DBO.'                
 END                
 ----PRINT @DBNAME                
                
 SET @STR='SELECT DISTINCT O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '                 
 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '                 
 SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''                  
 PRINT @STR                
  EXEC(@STR)                
        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Get_ReviewEntry
-- --------------------------------------------------

-- =============================================            
-- Author:  Suraj Patil            
-- Create date: 24/01/2017            
/*            
USP_Get_ReviewEntry 'E39377'         
USP_Get_ReviewEntry 'E62250'         
USP_Get_ReviewEntry 'E49843'         
         
*/            
-- Description: <Description,,>            
-- =============================================            
CREATE PROCEDURE [dbo].[USP_Get_ReviewEntry]            
 @Reviewer as varchar(30)            
AS            
BEGIN            
 declare @cnt as int = 0            
 select @cnt = COUNT(1) from Tbl_ReviewerMaster where isdelete = 0 and Reviewer = @Reviewer            
             
 if @cnt = 0            
 begin            
  select 'InvalidUser'            
 end            
 else            
 begin            
  declare @reviewType as varchar(20)            
  select @reviewType  = TypeOfReviewer from Tbl_ReviewerMaster where isdelete = 0 and Reviewer = @Reviewer            
              
  select RMN.Request_Id,PMM.Model_Name,CPM.Product_Name ,Model_Quantity,Request_Date,Requested_By,User_Remark,            
  Jm.Justification_Name,Estimated_Total_Price,SPACE(30) as access_code,TBL_EMP_INFO.designation,TBL_EMP_INFO.Emp_name,TBL_EMP_INFO.AttendanceLoc,TBL_EMP_INFO.Department,
   IT_Recommended_Name 
  into #temp             
  from tbl_RequestMaster RMN            
  left outer join TBL_PRODUCTMODELMASTER PMM on RMN.Item_Code=PMM.Product_Code and RMN.Model_No = PMM.Model_Id             
  LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM on RMN.ITEM_CODE = CPM.PRODUCT_CODE            
  LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RMN.JUSTIFICATION_ID = JM.JUSTIFICATION_ID     
  left outer join (select region as access_code,Emp_no as username,designation,Emp_name,AttendanceLoc,Department  from risk.dbo.emp_info where SeparationDate is null) TBL_EMP_INFO on RMN.Requested_By = TBL_EMP_INFO.username           
              
  where RMN.Status_Code='InReview'              
              
  update a            
  set a.access_code = b.access_code            
     from #temp a join (select region as access_code,Emp_no as username  from risk.dbo.emp_info where SeparationDate is null ) b       
  --select access_code,username from  risk.dbo.user_login) b         
  on a.Requested_By = b.username            
              
  --if @reviewType = 'CSO'            
  --begin            
  -- delete from #temp where access_code <> 'cso'            
  --end            
  --else            
  --begin            
  -- delete from #temp where access_code = 'cso'             
  --end            
  select * from #temp  order by Request_Id asc          
 end            
             
             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Get_ReviewEntry11Feb2019
-- --------------------------------------------------

-- =============================================            
-- Author:  Suraj Patil            
-- Create date: 24/01/2017            
/*            
USP_Get_ReviewEntry 'E39377'         
USP_Get_ReviewEntry 'E62250'         
USP_Get_ReviewEntry 'E49843'         
         
*/            
-- Description: <Description,,>            
-- =============================================            
CREATE PROCEDURE [dbo].[USP_Get_ReviewEntry11Feb2019]            
 @Reviewer as varchar(30)            
AS            
BEGIN            
 declare @cnt as int = 0            
 select @cnt = COUNT(1) from Tbl_ReviewerMaster where isdelete = 0 and Reviewer = @Reviewer            
             
 if @cnt = 0            
 begin            
  select 'InvalidUser'            
 end            
 else            
 begin            
  declare @reviewType as varchar(20)            
  select @reviewType  = TypeOfReviewer from Tbl_ReviewerMaster where isdelete = 0 and Reviewer = @Reviewer            
              
  select RMN.Request_Id,PMM.Model_Name,CPM.Product_Name ,Model_Quantity,Request_Date,Requested_By,User_Remark,            
  Jm.Justification_Name,Estimated_Total_Price,SPACE(30) as access_code,TBL_EMP_INFO.designation,TBL_EMP_INFO.Emp_name,TBL_EMP_INFO.AttendanceLoc,TBL_EMP_INFO.Department,
   IT_Recommended_Name 
  into #temp             
  from tbl_RequestMaster RMN            
  left outer join TBL_PRODUCTMODELMASTER PMM on RMN.Item_Code=PMM.Product_Code and RMN.Model_No = PMM.Model_Id             
  LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM on RMN.ITEM_CODE = CPM.PRODUCT_CODE            
  LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RMN.JUSTIFICATION_ID = JM.JUSTIFICATION_ID     
  left outer join (select region as access_code,Emp_no as username,designation,Emp_name,AttendanceLoc,Department  from risk.dbo.emp_info where SeparationDate is null) TBL_EMP_INFO on RMN.Requested_By = TBL_EMP_INFO.username           
              
  where RMN.Status_Code='InReview'              
              
  update a            
  set a.access_code = b.access_code            
     from #temp a join (select region as access_code,Emp_no as username  from risk.dbo.emp_info where SeparationDate is null ) b       
  --select access_code,username from  risk.dbo.user_login) b         
  on a.Requested_By = b.username            
              
  --if @reviewType = 'CSO'            
  --begin            
  -- delete from #temp where access_code <> 'cso'            
  --end            
  --else            
  --begin            
  -- delete from #temp where access_code = 'cso'             
  --end            
  select * from #temp  order by Request_Id asc          
 end            
             
             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Get_ReviewEntry27Nov2018
-- --------------------------------------------------
-- =============================================            
-- Author:  Suraj Patil            
-- Create date: 24/01/2017            
/*            
USP_Get_ReviewEntry 'E39377'         
USP_Get_ReviewEntry 'E62250'         
USP_Get_ReviewEntry 'E49843'         
         
*/            
-- Description: <Description,,>            
-- =============================================            
CREATE PROCEDURE [dbo].[USP_Get_ReviewEntry27Nov2018]            
 @Reviewer as varchar(30)            
AS            
BEGIN            
 declare @cnt as int = 0            
 select @cnt = COUNT(1) from Tbl_ReviewerMaster where isdelete = 0 and Reviewer = @Reviewer            
             
 if @cnt = 0            
 begin            
  select 'InvalidUser'            
 end            
 else            
 begin            
  declare @reviewType as varchar(20)            
  select @reviewType  = TypeOfReviewer from Tbl_ReviewerMaster where isdelete = 0 and Reviewer = @Reviewer            
              
  select RMN.Request_Id,PMM.Model_Name,CPM.Product_Name ,Model_Quantity,Request_Date,Requested_By,User_Remark,            
  Jm.Justification_Name,Estimated_Total_Price,SPACE(30) as access_code,TBL_EMP_INFO.designation,TBL_EMP_INFO.Emp_name,TBL_EMP_INFO.AttendanceLoc,TBL_EMP_INFO.Department  
  into #temp             
  from tbl_RequestMaster RMN            
  left outer join TBL_PRODUCTMODELMASTER PMM on RMN.Item_Code=PMM.Product_Code and RMN.Model_No = PMM.Model_Id             
  LEFT OUTER JOIN TBL_CAPEXPRODUCTMASTER CPM on RMN.ITEM_CODE = CPM.PRODUCT_CODE            
  LEFT OUTER JOIN TBL_JUSTIFICATIONMASTER JM ON RMN.JUSTIFICATION_ID = JM.JUSTIFICATION_ID     
  left outer join (select region as access_code,Emp_no as username,designation,Emp_name,AttendanceLoc,Department  from risk.dbo.emp_info where SeparationDate is null) TBL_EMP_INFO on RMN.Requested_By = TBL_EMP_INFO.username           
              
  where RMN.Status_Code='InReview'              
              
  update a            
  set a.access_code = b.access_code            
     from #temp a join (select region as access_code,Emp_no as username  from risk.dbo.emp_info where SeparationDate is null ) b       
  --select access_code,username from  risk.dbo.user_login) b         
  on a.Requested_By = b.username            
              
  --if @reviewType = 'CSO'            
  --begin            
  -- delete from #temp where access_code <> 'cso'            
  --end            
  --else            
  --begin            
  -- delete from #temp where access_code = 'cso'             
  --end            
  select * from #temp  order by Request_Id asc          
 end            
             
             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetApprover
-- --------------------------------------------------
  
    
  
  
CREATE Procedure [dbo].[USP_GetApprover]  
(  
@Option char(20),  
@Request_Id int  
)  
  
As  
Begin  

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

  
---Get the branch_cd (i.e costcode) of the Requester(i.eREquested_By)--  
Declare @branch_cd nvarchar(255)  
set @branch_cd =(select branch_cd from emp_info where emp_no = (select requested_by from tbl_requestmaster where request_id = @Request_Id))   
  
---Decide the Category of the Requester(i.eRequested_By)--  
Declare @Category char(20)  
if(@branch_cd in (select branch_cd from tbl_CSO_Branch(nolock)))  
      Begin  
            set @Category = 'CSO'  
      End  
Else  
      Begin  
            set @Category = 'BRANCH'  
   End  
  
---Get the Department of the Requester(i.eREquested_By)--NOTE THAT THIS IS NOT NEEDED IN THIS SP   
Declare @Department nvarchar(200)  
set @Department = (Select department from emp_info where emp_no = (select requested_by from tbl_requestmaster where request_id = @Request_Id))  
  
--Get the Estimated Total Price of the particular Request id--           
Declare @Estimasted_Total_price float  
set @Estimasted_Total_price =(Select Estimated_Total_Price from tbl_RequestMaster where Request_Id = @Request_Id)  
  
 if(@Option = 'Approver')  
  Begin  
     
   Select U_Role,Category,Department into #Approver  
   From tbl_Approval_LimitMaster  
   Where @Estimasted_Total_price Between Apr_LimitFrom and Apr_LimitTo  
   And Category = @Category  
  
                  -- Select * from #Approver            
                           
    --Declare a table used by Cusor  
   Create Table #Apr_Emp  
   (  
    Emp_NO varchar(6),EMP_NAME varchar(150),Senior varchar(6),Sr_name varchar(150),Company nvarchar(50),  
    SBU varchar(50),Lob int,Zone varchar(50),Region varchar(50),Location varchar(50),  
    AttendanceLoc varchar(100),Department nvarchar(200),Sub_Department varchar(150),  
    Designation varchar(255),Location_Address varchar(5000),LEVEL varchar(255),categorydesc varchar(50),  
    Branch_Cd nvarchar(255),Join_Date datetime,Separation_Date datetime,emailadd varchar(100),  
    sex varchar(1),BirthDate datetime,PHONE varchar(50),JOINDATE datetime,STATUS char(1),  
    Address nvarchar(100),City varchar(100),State nvarchar(25),Account_No varchar(20),  
    pincode varchar(20),Functional_Head varchar(500),flgCSOBranch nchar(6),  
    tpdlgcode nvarchar(50),LOBDESC varchar(100)  
   )  
             
    --Cursor   
       Declare @C_U_Role varchar(50)  
    Declare @C_Category varchar(50)  
    Declare @C_Department varchar(50)  
  
    Declare Apr Cursor for  
    Select * from #Approver  
  
  
    OPEN Apr  
    FETCH Apr into @C_U_Role,@C_Category,@C_Department  
    While(@@fetch_status=0)  
      Begin  
          
       print @C_U_Role  
       print @C_Category  
       print @C_Department  
  
       if(@C_Category = 'BRANCH')  
        Begin  
  
         if(@C_U_Role = 'Head' and @C_Department = 'IT')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Designation='Head' and Department = 'IT'   
            and branch_cd  in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'             
          End  
         else if(@C_U_Role ='Associate Director' and @C_Department = 'IT')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Emp_No = 'P00104'   
            --and branch_cd not in ('HO','ACM','BOK','CSO','CALNT')  
            and [Status] = 'A'  
          End  
         else if(@C_U_Role ='Executive Director')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Designation='Executive Director'   
            and branch_cd  in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'  
          End  
         else if(@C_U_Role ='Executive Director-CFO')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Designation='Executive Director-CFO'   
            and branch_cd  in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'  
          End  
         else if(@C_U_Role ='Chief Strategy Officer')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Designation='Chief Strategy Officer'   
            and branch_cd  in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'  
          End  
         else if(@C_U_Role ='CMD')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Designation='CMD'   
            and branch_cd  in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'  
          End  
    
  
        End  
  
      else if(@C_Category = 'CSO')  
        Begin  
  
         if(@C_U_Role = 'Head' and @C_Department = 'IT')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Designation='Head' and Department = 'IT'   
            and branch_cd  in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'             
          End  
         else if(@C_U_Role ='Associate Director' and @C_Department = 'IT')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Emp_No = 'P00104'   
            --and branch_cd  in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'  
          End  
         else if(@C_U_Role ='Executive Director')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Designation='Executive Director'   
            and branch_cd  in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'  
          End  
         else if(@C_U_Role ='Executive Director-CFO')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Designation='Executive Director-CFO'   
            and branch_cd  in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'  
          End  
         else if(@C_U_Role ='Chief Strategy Officer')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Designation='Chief Strategy Officer'   
            and branch_cd  in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'  
          End  
         else if(@C_U_Role ='CMD')  
          Begin  
           Insert into #Apr_Emp  
           Select * from Emp_info   
           where Designation='CMD'   
            and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))  
            and [Status] = 'A'  
          End  
  
  
        End  
   
         FETCH Apr into @C_U_Role,@C_Category,@C_Department  
  
      End  
   Close Apr  
   deallocate Apr   
              
   Select distinct(Emp_no),Emp_Name,Designation,Department,Branch_Cd,EmailAdd  
    from #Apr_Emp  
              
   End  
  
 -------------------------------------------------Recommender---------------------------------------------------  
      else if (@Option = 'Recommender')  
            Begin  
                              select U_Role  
                              from tbl_recommendation_LimitMaster  
                              where @Estimasted_Total_price between Rec_limitFrom and Rec_LimitTo  
                              And category=@Category  
-----------------------------  
----half left fro here  to work on it-----  
--                            select designation  
--                            from emp_info  
--                      where emp_no=(select Recommended_By from tbl_requestmaster where request_id=@Request_Id)  
   
   
   
--------------------  
   
            End  
   
   
  
  
    
--  create table #temp  
--  (  
--   emp_code char(10),  
--   emp_name varchar(255),  
--   branch_cd varchar(100),  
--   emailadd nvarchar(100)  
--  )  
--  insert into #temp(emp_code,emp_name,branch_cd,emailadd) values('E05207','Megha Ramesh Wangane','HO','megha.wangane@angelbroking.com')  
--  insert into #temp(emp_code,emp_name,branch_cd,emailadd)values('E33588','Anil Namdeo','HO','anil.namdeo@angelbroking.com')  
--  select Emp_Code,Emp_Name,branch_Cd,EmailAdd from #temp  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetEmpTree
-- --------------------------------------------------
--[USP_GetEmpTree] 'E63729'          
          
CREATE procedure [dbo].[USP_GetEmpTree]              
@Emp_Id varchar(20)              
As              
--USP_Tree 'E30253'              
Begin              
            
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
            
Declare @NO varchar(20)              
Declare @Desg varchar(50)              
Declare @Name varchar(100)              
              
Declare @PrevNO varchar(20)              
Declare @PrevDesg varchar(50)              
Declare @PrevName varchar(100)              
              
Set @NO = @Emp_Id              
--print('Requester' + ' - ' +@NO)              
              
Set @PrevNO = (Select Emp_Id from tbl_EmpTree with(nolock) where Emp_id = @NO)             
Set @PrevDesg = (Select Desig from tbl_EmpTree with(nolock) where emp_id = @PrevNO)              
Set @PrevName = (Select Emp_Name from tbl_EmpTree with(nolock) where emp_id = @PrevNO)              
              
Set @NO = (Select Senior from tbl_EmpTree with(nolock) where emp_id = @NO)              
Set @Desg = (Select Desig from tbl_EmpTree with(nolock) where emp_id = @NO)              
Set @Name = (Select Emp_Name from tbl_EmpTree with(nolock) where emp_id = @NO)              
              
print @NO          
print @Desg          
print @Name              
if(@NO not in (select e.emp_no    from risk.dbo.emp_info  e join emp_info e1 on e.emp_no=e1.Senior and e.Senior=e1.emp_no and e.SeparationDate is null))        
Begin        
WHILE (isnull(@Desg,'') <> '')            
Begin              
 if(@Desg = 'A.V.P.')              
 Begin              
  if(@PrevDesg <> 'A.V.P.')              
  Begin              
  --Print(@NO + ' - '+ @Desg +' - '+ @Name)              
   update tbl_EmpTree Set AVP = @NO, SrUpdateDate = getdate() Where Emp_Id = @Emp_Id              
  End              
              
 End              
 else if(@Desg = 'Sr. Assistant Vice President')              
 Begin              
  if(@PrevDesg <> 'Sr. Assistant Vice President')              
  Begin              
   --Print(@NO + ' - '+ @Desg +' - '+ @Name)              
   update tbl_EmpTree Set SrAVP = @NO, SrUpdateDate = getdate()  Where Emp_Id = @Emp_Id              
  End              
              
 End               
 else if(@Desg = 'Vice President')              
 Begin              
  if(@PrevDesg <> 'Vice President')              
  Begin              
   --Print(@NO + ' - '+ @Desg +' - '+ @Name)              
    update tbl_EmpTree Set VP = @NO, SrUpdateDate = getdate()  Where Emp_Id = @Emp_Id              
  End              
                 
 End               
 else if(@Desg = 'Sr. Vice President')              
 Begin              
  if(@PrevDesg <> 'Sr. Vice President')              
  Begin              
   --Print(@NO + ' - '+ @Desg +' - '+ @Name)              
    update tbl_EmpTree Set SrVP = @NO, SrUpdateDate = getdate()  Where Emp_Id = @Emp_Id              
  End              
 End               
 else if(@Desg = 'Executive Director')              
 Begin              
  if(@PrevDesg <> 'Executive Director')              
  Begin              
   --Print(@NO + ' - '+ @Desg +' - '+ @Name)              
   update tbl_EmpTree Set ED = @NO, SrUpdateDate = getdate()  Where Emp_Id = @Emp_Id              
  End              
 End               
               
 Set @PrevNO = (Select Senior from tbl_EmpTree with(nolock) where emp_id = @PrevNO)              
 Set @PrevDesg = (Select Desig from tbl_EmpTree with(nolock) where emp_id = @PrevNO)              
 Set @PrevName = (Select Emp_Name from tbl_EmpTree with(nolock) where emp_id = @PrevNO)              
              
 Set @NO = (Select Senior from tbl_EmpTree with(nolock) where emp_id = @NO)              
 Set @Desg = (Select Desig from tbl_EmpTree with(nolock) where emp_id = @NO)              
 Set @Name = (Select Emp_Name from tbl_EmpTree with(nolock) where emp_id = @NO)              
 Print (@PrevNO + @PrevDesg +  @PrevName + @NO + @Desg +@Name)              
              
--print(@NO)              
--Print(@Desg)              
End              
End              
              
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetEmpTree_New
-- --------------------------------------------------
CREATE procedure [dbo].[USP_GetEmpTree_New]    
@Emp_Id varchar(20)    
As    
--USP_Tree 'E30253'    
Begin    
  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
  
Declare @NO varchar(20)    
Declare @Desg varchar(50)    
Declare @Name varchar(100)    
    
Declare @PrevNO varchar(20)    
Declare @PrevDesg varchar(50)    
Declare @PrevName varchar(100)    
    
Set @NO = @Emp_Id    
--print('Requester' + ' - ' +@NO)    
    
Set @PrevNO = (Select Emp_Id from tbl_EmpTree with(nolock) where Emp_id = @NO)   
Set @PrevDesg = (Select Desig from tbl_EmpTree with(nolock) where emp_id = @PrevNO)    
Set @PrevName = (Select Emp_Name from tbl_EmpTree with(nolock) where emp_id = @PrevNO)    
    
Set @NO = (Select Senior from tbl_EmpTree with(nolock) where emp_id = @NO)    
Set @Desg = (Select Desig from tbl_EmpTree with(nolock) where emp_id = @NO)    
Set @Name = (Select Emp_Name from tbl_EmpTree with(nolock) where emp_id = @NO)    
    
print @NO
print @Desg
print @Name    
    
WHILE (isnull(@Desg,'') <> '')  
Begin    
 if(@Desg = 'A.V.P.')    
 Begin    
  if(@PrevDesg <> 'A.V.P.')    
  Begin    
  --Print(@NO + ' - '+ @Desg +' - '+ @Name)    
   update tbl_EmpTree Set AVP = @NO, SrUpdateDate = getdate() Where Emp_Id = @Emp_Id    
  End    
    
 End    
 else if(@Desg = 'Sr. Assistant Vice President')    
 Begin    
  if(@PrevDesg <> 'Sr. Assistant Vice President')    
  Begin    
   --Print(@NO + ' - '+ @Desg +' - '+ @Name)    
   update tbl_EmpTree Set SrAVP = @NO, SrUpdateDate = getdate()  Where Emp_Id = @Emp_Id    
  End    
    
 End     
 else if(@Desg = 'Vice President')    
 Begin    
  if(@PrevDesg <> 'Vice President')    
  Begin    
   --Print(@NO + ' - '+ @Desg +' - '+ @Name)    
    update tbl_EmpTree Set VP = @NO, SrUpdateDate = getdate()  Where Emp_Id = @Emp_Id    
  End    
       
 End     
 else if(@Desg = 'Sr. Vice President')    
 Begin    
  if(@PrevDesg <> 'Sr. Vice President')    
  Begin    
   --Print(@NO + ' - '+ @Desg +' - '+ @Name)    
    update tbl_EmpTree Set SrVP = @NO, SrUpdateDate = getdate()  Where Emp_Id = @Emp_Id    
  End    
 End     
 else if(@Desg = 'Executive Director')    
 Begin    
  if(@PrevDesg <> 'Executive Director')    
  Begin    
   --Print(@NO + ' - '+ @Desg +' - '+ @Name)    
   update tbl_EmpTree Set ED = @NO, SrUpdateDate = getdate()  Where Emp_Id = @Emp_Id    
  End    
 End     
     
 Set @PrevNO = (Select Senior from tbl_EmpTree with(nolock) where emp_id = @PrevNO)    
 Set @PrevDesg = (Select Desig from tbl_EmpTree with(nolock) where emp_id = @PrevNO)    
 Set @PrevName = (Select Emp_Name from tbl_EmpTree with(nolock) where emp_id = @PrevNO)    
    
 Set @NO = (Select Senior from tbl_EmpTree with(nolock) where emp_id = @NO)    
 Set @Desg = (Select Desig from tbl_EmpTree with(nolock) where emp_id = @NO)    
 Set @Name = (Select Emp_Name from tbl_EmpTree with(nolock) where emp_id = @NO)    
 Print (@PrevNO + @PrevDesg +  @PrevName + @NO + @Desg +@Name)    
    
--print(@NO)    
--Print(@Desg)    
End    
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getITLimit_A
-- --------------------------------------------------






CREATE proc [dbo].[usp_getITLimit_A]
@Emp_Id as varchar(15),
@Type as varchar(3),
@ReqFrom as varchar(20),
@LimitCheck varchar(20)
as

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 



declare @U_Role char(100)
declare @Dep char(150)
set @U_Role=(Select Designation From Emp_Info where Emp_No=@Emp_Id and Status='A')

set @Dep=(Select Department From Emp_Info where Emp_No=@Emp_Id and Status='A')
	if(@Dep <>'IT')
	Begin
		set @Dep='ALL' --If Department is not IT then assume any other Department i.e say ALL
	End 
	print @Dep
	
	if(@Type='R')
	begin 
		if(@LimitCheck='Limit')
			Begin
				if(@Emp_Id='P00104')
					Begin
						select Rec_LimitFrom,Rec_LimitTo 
						from tbl_Recommendation_LimitMaster 
						where category=@ReqFrom  and U_Role ='Associate Director' and Department='IT'
					End
				else
					Begin
						select Rec_LimitFrom,Rec_LimitTo 
						from tbl_Recommendation_LimitMaster 
						where category=@ReqFrom  and U_Role =@U_Role and Department=@Dep
					End
			End
		else if(@LimitCheck='B_Limit')
				Begin
					if(@Emp_Id='P00104')
					Begin
						select B_RecLimitFrom,B_RecLimitTo 
						from tbl_Recommendation_LimitMaster 
						where category=@ReqFrom  and U_Role ='Associate Director' and Department='IT'
					End
				
					else
						Begin
							select B_RecLimitFrom,B_RecLimitTo 
							from tbl_Recommendation_LimitMaster 
							where category=@ReqFrom  and U_Role =@U_Role and Department=@Dep
						End
				end
	End

	else if(@Type='A')
	begin
		if(@LimitCheck='Limit')
			Begin
				if(@Emp_Id='P00104')
					Begin
						select Apr_LimitFrom,Apr_LimitTo 
						from tbl_Approval_LimitMaster 
						where category=@ReqFrom  and U_Role ='Associate Director' and Department='IT'
					End
				else if(@Emp_Id='D00002')
					begin
						select Apr_LimitFrom,Apr_LimitTo 
						from tbl_Approval_LimitMaster 
						where category=@ReqFrom and U_Role = 'CMD' and Department=@Dep
					End
		
				else
					begin
						select Apr_LimitFrom,Apr_LimitTo
						 from tbl_Approval_LimitMaster 
						where category=@ReqFrom  and U_Role = @U_Role AND Department=@Dep
					end
			End
		else if(@LimitCheck='B_Limit')
			Begin
			if(@Emp_Id='P00104')
					Begin
						select B_AprLimitFrom,B_AprLimitTo 
						from tbl_Approval_LimitMaster 
						where category=@ReqFrom  and U_Role ='Associate Director' and Department='IT'
					End
			else if(@Emp_Id='D00002')
					begin
						select B_AprLimitFrom,B_AprLimitTo
						from tbl_Approval_LimitMaster 
						where  category=@ReqFrom and U_Role = 'CMD' and Department=@Dep
					End
			else
			Begin
				select B_AprLimitFrom,B_AprLimitTo
						 from tbl_Approval_LimitMaster 
						where category=@ReqFrom  and U_Role = @U_Role AND Department=@Dep
			End

		end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getITLimit_B
-- --------------------------------------------------








CREATE proc [dbo].[usp_getITLimit_B]
@Emp_Id as varchar(15),
@Type as varchar(3),
@ReqFrom as varchar(20)
as
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


declare @U_Role char(100)
declare @Dep char(150)
set @U_Role=(Select Designation From Emp_Info where Emp_No=@Emp_Id and Status='A')
--print @U_Role
set @Dep=(Select Department From Emp_Info where Emp_No=@Emp_Id and Status='A')
	if(@Dep <>'IT')
	Begin
		set @Dep='ALL' --If Department is not IT then assume any other Department i.e say ALL
	End 
	--print @Dep

	if(@U_Role='Branch Head' OR @U_Role='Cluster Head' OR @U_Role='Regional Head' OR @U_Role='Zonal Head')
	Begin
		Set @ReqFrom='BRANCH'
	End
	Else
	Begin
		Set @ReqFrom='CSO'
	End
	if(@Type='R')
	begin 
		select B_RecLimitFrom,B_RecLimitTo 
		from tbl_Recommendation_LimitMaster 
		where category=@ReqFrom  and U_Role =@U_Role and Department=@Dep
	end
	else if(@Type='A')
	begin
		if(@emp_id='P00002')
		begin
			select B_AprLimitFrom,B_AprLimitTo 
			from tbl_Approval_LimitMaster 
			where  U_Role = 'CMD'
		end
		else
		begin
			select Apr_LimitFrom,Apr_LimitTo
			 from tbl_Approval_LimitMaster 
			where category=@ReqFrom  and U_Role = @U_Role AND Department=@Dep
		end
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetModelQuantityAssigned
-- --------------------------------------------------


CREATE Procedure [dbo].[USP_GetModelQuantityAssigned]
(
@Request_Id  int
)
as    
Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

	Select Model_Quantity_Assigned 
	From tbl_RequestMaster
	Where Request_Id=@Request_Id 

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetPONOAccToVendor
-- --------------------------------------------------
--CREATED BY:
--MODIFIED BY : ZEBA RAJE     
CREATE PROCEDURE [dbo].[USP_GetPONOAccToVendor] (@VENDORID INT)
AS
  BEGIN
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  
  
  
      SELECT FLD_PURCHASEORDERNO,
             FLD_REQUESTID
      FROM   TBL_ITREQUESTPURCHASEORDER(NOLOCK)
      WHERE  FLD_VENDORID = @VENDORID
             AND PO_STATUS IN ( 'NPO', 'MPO' )
      ORDER  BY CONVERT(DATETIME, CONVERT(VARCHAR, Substring(FLD_PURCHASEORDERNO, 9, 10)), 103) DESC,--ZEBA
                FLD_PURCHASEORDERNO DESC
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetRecApr
-- --------------------------------------------------
--[USP_GetRecApr] 'R','CSO','A.V.P.Sr. Assistant Vice President All','11360','E59389'  
CREATE proc [dbo].[USP_GetRecApr]-- 'R'   ,'branch','BranchHead','7883','E37859'               
@Type char(20),                    
@Category char(20),                    
@Role varchar(100),                    
@Request_Id int,                    
@Requested_By varchar(20)                    
As                    
              
            
            
   --begin tran          
   --update tbl_emptree          
   --set avp=''          
   --where emp_id='E40510'          
            
            
 -- commit          
            
  ----    select * from tbl_emptree where emp_id='E40510'          
               
              
--    select * from tbl_RequestRecApr where request_id=1111              
               
               
--    select * from tbl_requestmaster order by  request_id desc              
                    
Begin 

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
                   
--print(@Request_Id)Print(@RequesterBrCd)Print(@Type) Print(@Category)print(@Designation)print(@Department)print(@Sub_Department)                    
                    
if(@Type = 'R')                    
 Begin                    
  if(@Category = 'BRANCH')                    
   Begin                    
    Declare @BranchHead varchar(20)                    
    Declare @ClusterHead varchar(20)                    
    Declare @RegionalHead varchar(20)                    
    Declare @ZonalHead Varchar(20)                    
    Declare @HeadITBranch Varchar(20)
    
    Declare @EmpSenior Varchar(20)                    
                    
    set @BranchHead = (Select BH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @ClusterHead = (Select CH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @RegionalHead = (Select RH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @ZonalHead = (Select ZH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @HeadITBranch = (Select HeadIT from tbl_EmpTree Where Emp_Id =@Requested_By)                    
    set @EmpSenior = (Select Senior from tbl_EmpTree Where Emp_Id =@Requested_By)                    
    if(@Role = 'BranchHead')                    
    Begin                   
    
     if(rtrim(@EmpSenior) <> '' AND @EmpSenior is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @EmpSenior and Role = 'R' and @EmpSenior IS NOT NULL and @EmpSenior <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SR')                    
      End                    
     End 
     else if(rtrim(@BranchHead) <> '' And @BranchHead is Not NULL AND @Requested_By <> 'E37859' and @Requested_By <> 'E52691')                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @BranchHead and Role = 'R' and @BranchHead IS NOT NULL and @BranchHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,BH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('BH')                    
      End                    
     End                    
     else if(rtrim(@ClusterHead) <> '' AND @ClusterHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ClusterHead and Role = 'R' and @ClusterHead IS NOT NULL and @ClusterHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,CH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('CH')                    
      End                    
     End                    
     else if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @RegionalHead and Role = 'R' and @RegionalHead IS NOT NULL and @RegionalHead <> '')                         
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('RH')                    
      End                    
     End                    
     else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('ZH')                    
      End                    
     End                    
--     else --goes to head It                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                     
--      End                    
--     End                    
                    
    End                    
                         
    Else if (@Role = 'ClusterHead')                    
    Begin                    
     if(rtrim(@ClusterHead) <> '' AND @ClusterHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ClusterHead and Role = 'R' and @ClusterHead IS NOT NULL and @ClusterHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,CH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('CH')                    
      End                    
     End                    
     else if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @RegionalHead and Role = 'R' and @RegionalHead IS NOT NULL and @RegionalHead <> '')                         
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('RH')                    
      End                    
     End                    
     else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('ZH')                    
      End                    
     End                    
--     else --goes to head It                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
-- Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                     
--      End                    
--     End                    
                    
    End                    
                       
    Else if (@Role = 'RegionalHead')                    
    Begin                 
     if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @RegionalHead and Role = 'R' and @RegionalHead IS NOT NULL and @RegionalHead <> '')                         
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('RH')                    
      End                    
     End                    
     else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('ZH')                    
      End                    
     End                
--     else --goes to head It                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                     
--      End                    
--     End                    
                    
    End                    
                        
    Else if (@Role = 'ZonalHead')                    
    Begin                    
     if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('ZH')                    
      End                    
     End                    
--     else --goes to head It                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                     
--      End                    
--     End                    
    End                    
                    
   End                    
                    
  else if(@Category = 'CSO')                    
   Begin                    
                    
    Declare @AVP varchar(20)                    
    Declare @HOD varchar(20)                    
    Declare @SrAVP varchar(20)                    
    Declare @VP varchar(20)                    
    Declare @SrVP Varchar(20)                    
    Declare @SrAVPIT Varchar(20)                    
    Declare @HeadITCSO Varchar(20)                    
                    
    set @AVP = (Select AVP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @HOD = (Select Senior from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @SrAVP = (Select SrAVP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @VP = (Select VP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @SrVP = (Select SrVP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @HeadITCSO = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
                    
                    
    if(@Role = 'A.V.P.Sr. Assistant Vice President All')                    
    Begin                    
     if(rtrim(@AVP) <> '' And @AVP is Not NULL)                    
     Begin 
     
      if(rtrim(@HOD) <> '' And @HOD is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HOD and Role ='R' and @HOD IS NOT NULL and @HOD <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('HOD')                    
      End                    
     End                      
      ELSE if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @AVP and Role = 'R' and @AVP IS NOT NULL and @AVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,AVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('AVP')                    
      End                    
     End               
                   
     /* Zeba    */              
                   
                       
                   
                   
                   
                   
                   
     /*  Zeba */              
              
                
     else if(rtrim(@HOD) <> '' And @HOD is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HOD and Role ='R' and @HOD IS NOT NULL and @HOD <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('HOD')                    
      End                    
     End                   
     else if(rtrim(@SrAVP) <> '' And @SrAVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrAVP and Role = 'R' and @SrAVP IS NOT NULL and @SrAVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrAVP')                    
      End                    
     End                    
     else if(rtrim(@VP) <> '' And @VP is Not NULL)                     
     Begin   
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HOD and Role ='R' and @HOD IS NOT NULL and @HOD <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('HOD')                    
      End                   
      else if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @VP and Role = 'R' and @VP IS NOT NULL and @VP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,VP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('VP')                    
      End                    
     End                    
     else if(rtrim(@SrVP) <> '' And @SrVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrVP  and Role = 'R' and @SrVP IS NOT NULL and @SrVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrVP')                    
      End                    
     End                    
     else if(rtrim(@SrAVPIT) <> '' And @SrAVPIT is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrAVPIT')                    
      End                    
     End                    
--     Else--goes to head IT                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITCSO and Role = 'R' and @HeadITCSO IS NOT NULL and @HeadITCSO <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
--      End                    
--     End                    
                    
    End                    
                    
    Else if(@Role = 'Vice PresidentSr. Assistant Vice President')                    
    Begin  
      if(rtrim(@HOD) <> '' And @HOD is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HOD and Role ='R' and @HOD IS NOT NULL and @HOD <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('HOD')                    
      End                    
     End              
     ELSE if(rtrim(@VP) <> '' And @VP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @VP and Role = 'R' and @VP IS NOT NULL and @VP <> '')                    
      Begin                    
   Insert into tbl_RequestRecApr                    
       Select @Request_Id,VP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('VP')                    
      End                    
     End                    
     else if(rtrim(@SrVP) <> '' And @SrVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrVP  and Role = 'R' and @SrVP IS NOT NULL and @SrVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrVP')                    
      End                    
     End                    
     else if(rtrim(@SrAVPIT) <> '' And @SrAVPIT is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
  print('SrAVPIT')                    
      End                    
     End                    
--     Else--goes to head IT       
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITCSO and Role = 'R' and @HeadITCSO IS NOT NULL and @HeadITCSO <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
--      End                    
--     End                    
                    
    End                    
                    
   End                    
             
 End                    
                    
                    
else if(@Type = 'OR')                    
 Begin                    
  if(@Category = 'BRANCH')                    
   Begin                    
    Declare @OBranchHead varchar(20)                    
    Declare @OClusterHead varchar(20)                    
    Declare @ORegionalHead varchar(20)                    
    Declare @OZonalHead Varchar(20)                    
    Declare @OHeadITBranch Varchar(20)                    
                    
    set @OBranchHead = (Select BH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OClusterHead = (Select CH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @ORegionalHead = (Select RH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OZonalHead = (Select ZH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OHeadITBranch = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
                    
                    
    if(@Role = 'BranchHead')                    
    Begin                    
     if(rtrim(@OBranchHead) <> '' And @OBranchHead is Not NULL )                    
   Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OBranchHead and Role = 'OR' and @OBranchHead IS NOT NULL and @OBranchHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,BH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('OBH')                    
      End                    
     End                    
     else if(rtrim(@OClusterHead) <> '' AND @OClusterHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OClusterHead and Role = 'OR' and @OClusterHead IS NOT NULL and @OClusterHead <> '')                    
       Begin                  
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,CH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('OCH')                    
       End                    
      End                    
     else if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ORegionalHead and Role = 'OR' and @ORegionalHead IS NOT NULL and @ORegionalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('ORH')                    
       End                  
      End                    
     else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)         
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('OZH')                    
       End                    
      End                    
--     else --goes to head It                    
--      Begin                    
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')                    
--       Begin                    
--        Insert into tbl_RequestRecApr                    
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
--       End                    
--      End                    
                    
    End                    
                         
    Else if (@Role = 'ClusterHead')                    
    Begin                    
     if(rtrim(@OClusterHead) <> '' AND @OClusterHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OClusterHead and Role = 'OR' and @OClusterHead IS NOT NULL and @OClusterHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,CH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('OCH')                    
       End                    
      End                    
     else if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ORegionalHead and Role = 'OR' and @ORegionalHead IS NOT NULL and @ORegionalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('ORH')                    
       End                    
      End                    
     else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))               
        print('OZH')                    
       End                    
      End                    
--     else --goes to head It                    
--      Begin                    
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')                    
--       Begin                    
--        Insert into tbl_RequestRecApr                    
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
--       End   
--      End                    
    End                    
                       
    Else if (@Role = 'RegionalHead')                    
    Begin                    
     if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ORegionalHead and Role = 'OR' and @ORegionalHead IS NOT NULL and @ORegionalHead <> '')                    
       Begin                   
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('ORH')                    
       End                    
      End                    
     else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('OZH')                    
       End                    
      End                    
--     else --goes to head It                    
--      Begin                    
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')                    
--       Begin                    
--        Insert into tbl_RequestRecApr                    
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
--       End                    
--      End                    
    End                    
                        
    Else if (@Role = 'ZonalHead')                    
    Begin                    
     if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('OZH')                    
       End                    
      End                    
--     else --goes to head It                    
--      Begin                    
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')                    
--       Begin                    
--        Insert into tbl_RequestRecApr                    
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
--       End                    
--      End                    
    End                    
                    
   End                    
                    
  else if(@Category = 'CSO')                    
   Begin                    
                    
    Declare @OAVP varchar(20)               
    Declare @OHOD varchar(20)                   
    Declare @OSrAVP varchar(20)                    
    Declare @OVP varchar(20)                    
    Declare @OSrVP Varchar(20)                    
    Declare @OSrAVPIT Varchar(20)                    
    Declare @OHeadITCSO Varchar(20)                    
                    
    set @OAVP = (Select AVP from tbl_EmpTree where Emp_Id = @Requested_By)               
    set @OHOD = (Select Senior from tbl_EmpTree where Emp_Id = @Requested_By)                   
    set @OSrAVP = (Select SrAVP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OVP = (Select VP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OSrVP = (Select SrVP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OSrAVPIT = (Select SrAVPIT from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OHeadITCSO = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
                    
                    
    if(@Role = 'A.V.P.Sr. Assistant Vice President All')                    
    Begin                    
     if(rtrim(@OAVP) <> '' And @OAVP is Not NULL)                    
     Begin                    
      if NOT EXISTS  (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OAVP and Role ='OR' and @OAVP IS NOT NULL and @OAVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,AVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('AVP')                    
      End                    
     End                 
                   
   /*Zeba */               
                  
      else if(rtrim(@OHOD) <> '' And @OHOD is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHOD and Role ='OR' and @OHOD IS NOT NULL and @OHOD <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('HOD')                    
      End                    
     End                   
                   
  /* zeba*/                
                 
     else if(rtrim(@OSrAVP) <> '' And @OSrAVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrAVP and Role ='OR' and @OSrAVP IS NOT NULL and @OSrAVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrAVP')                    
      End                    
     End                    
     else if(rtrim(@OVP) <> '' And @OVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OVP and Role ='OR' and @OVP IS NOT NULL and @OVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,VP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('VP')                    
      End                    
     End                    
     else if(rtrim(@OSrVP) <> '' And @OSrVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrVP and Role ='OR' and @OSrVP IS NOT NULL and @OSrVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrVP')                    
      End                    
     End                    
     else if(rtrim(@OSrAVPIT) <> '' And @OSrAVPIT is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrAVPIT and Role ='OR' and @OSrAVPIT IS NOT NULL and @OSrAVPIT <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrAVPIT')                    
      End                    
     End                    
--     Else--goes to head IT                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITCSO and Role ='OR' and @OHeadITCSO IS NOT NULL and @OHeadITCSO <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
--      End                    
--     End                    
                    
    End                    
                    
    Else if(@Role = 'Vice PresidentSr. Assistant Vice President')                    
    Begin                    
   if(rtrim(@OVP) <> '' And @OVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OVP and Role ='OR' and @OVP IS NOT NULL and @OVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,VP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('VP')                    
      End                    
     End                    
     else if(rtrim(@OSrVP) <> '' And @OSrVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrVP and Role ='OR' and @OSrVP IS NOT NULL and @OSrVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrVP')                    
      End                    
     End                    
     else if(rtrim(@OSrAVPIT) <> '' And @OSrAVPIT is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrAVPIT and Role ='OR' and @OSrAVPIT IS NOT NULL and @OSrAVPIT <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrAVPIT')                    
      End                    
     End                    
--     Else--goes to head IT                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITCSO and Role ='OR' and @OHeadITCSO IS NOT NULL and @OHeadITCSO <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
--      End                    
--     End                    
                    
    End                    
                    
   End                    
 End                    
                    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetRecApr_02May2016
-- --------------------------------------------------
--[USP_GetRecApr] 'R','CSO','A.V.P.Sr. Assistant Vice President All','11360','E59389'  
Create proc [dbo].[USP_GetRecApr_02May2016]-- 'R'   ,'branch','BranchHead','7883','E37859'               
@Type char(20),                    
@Category char(20),                    
@Role varchar(100),                    
@Request_Id int,                    
@Requested_By varchar(20)                    
As                    
              
            
            
   --begin tran          
   --update tbl_emptree          
   --set avp=''          
   --where emp_id='E40510'          
            
            
 -- commit          
            
  ----    select * from tbl_emptree where emp_id='E40510'          
               
              
--    select * from tbl_RequestRecApr where request_id=1111              
               
               
--    select * from tbl_requestmaster order by  request_id desc              
                    
Begin                    
--print(@Request_Id)Print(@RequesterBrCd)Print(@Type) Print(@Category)print(@Designation)print(@Department)print(@Sub_Department)                    
                    
if(@Type = 'R')                    
 Begin                    
  if(@Category = 'BRANCH')                    
   Begin                    
    Declare @BranchHead varchar(20)                    
    Declare @ClusterHead varchar(20)                    
    Declare @RegionalHead varchar(20)                    
    Declare @ZonalHead Varchar(20)                    
    Declare @HeadITBranch Varchar(20)                    
                    
    set @BranchHead = (Select BH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @ClusterHead = (Select CH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @RegionalHead = (Select RH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @ZonalHead = (Select ZH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @HeadITBranch = (Select HeadIT from tbl_EmpTree Where Emp_Id =@Requested_By)                    
    if(@Role = 'BranchHead')                    
    Begin                   
     if(rtrim(@BranchHead) <> '' And @BranchHead is Not NULL AND @Requested_By <> 'E37859' and @Requested_By <> 'E52691')                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @BranchHead and Role = 'R' and @BranchHead IS NOT NULL and @BranchHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,BH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('BH')                    
      End                    
     End                    
     else if(rtrim(@ClusterHead) <> '' AND @ClusterHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ClusterHead and Role = 'R' and @ClusterHead IS NOT NULL and @ClusterHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,CH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('CH')                    
      End                    
     End                    
     else if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @RegionalHead and Role = 'R' and @RegionalHead IS NOT NULL and @RegionalHead <> '')                         
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('RH')                    
      End                    
     End                    
     else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('ZH')                    
      End                    
     End                    
--     else --goes to head It                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                     
--      End                    
--     End                    
                    
    End                    
                         
    Else if (@Role = 'ClusterHead')                    
    Begin                    
     if(rtrim(@ClusterHead) <> '' AND @ClusterHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ClusterHead and Role = 'R' and @ClusterHead IS NOT NULL and @ClusterHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,CH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('CH')                    
      End                    
     End                    
     else if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @RegionalHead and Role = 'R' and @RegionalHead IS NOT NULL and @RegionalHead <> '')                         
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('RH')                    
      End                    
     End                    
     else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('ZH')                    
      End                    
     End                    
--     else --goes to head It                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
-- Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                     
--      End                    
--     End                    
                    
    End                    
                       
    Else if (@Role = 'RegionalHead')                    
    Begin                 
     if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @RegionalHead and Role = 'R' and @RegionalHead IS NOT NULL and @RegionalHead <> '')                         
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('RH')                    
      End                    
     End                    
     else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('ZH')                    
      End                    
     End                
--     else --goes to head It                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                     
--      End                    
--     End                    
                    
    End                    
                        
    Else if (@Role = 'ZonalHead')                    
    Begin                    
     if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)                    
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('ZH')                    
      End                    
     End                    
--     else --goes to head It                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                     
--      End                    
--     End                    
    End                    
                    
   End                    
                    
  else if(@Category = 'CSO')                    
   Begin                    
                    
    Declare @AVP varchar(20)                    
    Declare @HOD varchar(20)                    
    Declare @SrAVP varchar(20)                    
    Declare @VP varchar(20)                    
    Declare @SrVP Varchar(20)                    
    Declare @SrAVPIT Varchar(20)                    
    Declare @HeadITCSO Varchar(20)                    
                    
    set @AVP = (Select AVP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @HOD = (Select Senior from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @SrAVP = (Select SrAVP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @VP = (Select VP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @SrVP = (Select SrVP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @HeadITCSO = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
                    
                    
    if(@Role = 'A.V.P.Sr. Assistant Vice President All')                    
    Begin                    
     if(rtrim(@AVP) <> '' And @AVP is Not NULL)                    
     Begin 
     
      if(rtrim(@HOD) <> '' And @HOD is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HOD and Role ='R' and @HOD IS NOT NULL and @HOD <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('HOD')                    
      End                    
     End                      
      ELSE if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @AVP and Role = 'R' and @AVP IS NOT NULL and @AVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,AVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('AVP')                    
      End                    
     End               
                   
     /* Zeba    */              
                   
                       
                   
                   
                   
                   
                   
     /*  Zeba */              
              
                
     else if(rtrim(@HOD) <> '' And @HOD is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HOD and Role ='R' and @HOD IS NOT NULL and @HOD <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('HOD')                    
      End                    
     End                   
     else if(rtrim(@SrAVP) <> '' And @SrAVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrAVP and Role = 'R' and @SrAVP IS NOT NULL and @SrAVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrAVP')                    
      End                    
     End                    
     else if(rtrim(@VP) <> '' And @VP is Not NULL)                     
     Begin   
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HOD and Role ='R' and @HOD IS NOT NULL and @HOD <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('HOD')                    
      End                   
      else if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @VP and Role = 'R' and @VP IS NOT NULL and @VP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,VP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('VP')                    
      End                    
     End                    
     else if(rtrim(@SrVP) <> '' And @SrVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrVP  and Role = 'R' and @SrVP IS NOT NULL and @SrVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrVP')                    
      End                    
     End                    
     else if(rtrim(@SrAVPIT) <> '' And @SrAVPIT is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrAVPIT')                    
      End                    
     End                    
--     Else--goes to head IT                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITCSO and Role = 'R' and @HeadITCSO IS NOT NULL and @HeadITCSO <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
--      End                    
--     End                    
                    
    End                    
                    
    Else if(@Role = 'Vice PresidentSr. Assistant Vice President')                    
    Begin  
      if(rtrim(@HOD) <> '' And @HOD is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HOD and Role ='R' and @HOD IS NOT NULL and @HOD <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('HOD')                    
      End                    
     End              
     ELSE if(rtrim(@VP) <> '' And @VP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @VP and Role = 'R' and @VP IS NOT NULL and @VP <> '')                    
      Begin                    
   Insert into tbl_RequestRecApr                    
       Select @Request_Id,VP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('VP')                    
      End                    
     End                    
     else if(rtrim(@SrVP) <> '' And @SrVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrVP  and Role = 'R' and @SrVP IS NOT NULL and @SrVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrVP')                    
      End                    
     End                    
     else if(rtrim(@SrAVPIT) <> '' And @SrAVPIT is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
  print('SrAVPIT')                    
      End                    
     End                    
--     Else--goes to head IT       
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITCSO and Role = 'R' and @HeadITCSO IS NOT NULL and @HeadITCSO <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
--      End                    
--     End                    
                    
    End                    
                    
   End                    
             
 End                    
                    
                    
else if(@Type = 'OR')                    
 Begin                    
  if(@Category = 'BRANCH')                    
   Begin                    
    Declare @OBranchHead varchar(20)                    
    Declare @OClusterHead varchar(20)                    
    Declare @ORegionalHead varchar(20)                    
    Declare @OZonalHead Varchar(20)                    
    Declare @OHeadITBranch Varchar(20)                    
                    
    set @OBranchHead = (Select BH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OClusterHead = (Select CH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @ORegionalHead = (Select RH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OZonalHead = (Select ZH from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OHeadITBranch = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
                    
                    
    if(@Role = 'BranchHead')                    
    Begin                    
     if(rtrim(@OBranchHead) <> '' And @OBranchHead is Not NULL )                    
   Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OBranchHead and Role = 'OR' and @OBranchHead IS NOT NULL and @OBranchHead <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,BH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('OBH')                    
      End                    
     End                    
     else if(rtrim(@OClusterHead) <> '' AND @OClusterHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OClusterHead and Role = 'OR' and @OClusterHead IS NOT NULL and @OClusterHead <> '')                    
       Begin                  
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,CH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('OCH')                    
       End                    
      End                    
     else if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ORegionalHead and Role = 'OR' and @ORegionalHead IS NOT NULL and @ORegionalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('ORH')                    
       End                  
      End                    
     else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)         
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('OZH')                    
       End                    
      End                    
--     else --goes to head It                    
--      Begin                    
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')                    
--       Begin                    
--        Insert into tbl_RequestRecApr                    
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
--       End                    
--      End                    
                    
    End                    
                         
    Else if (@Role = 'ClusterHead')                    
    Begin                    
     if(rtrim(@OClusterHead) <> '' AND @OClusterHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OClusterHead and Role = 'OR' and @OClusterHead IS NOT NULL and @OClusterHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,CH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('OCH')                    
       End                    
      End                    
     else if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ORegionalHead and Role = 'OR' and @ORegionalHead IS NOT NULL and @ORegionalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('ORH')                    
       End                    
      End                    
     else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))               
        print('OZH')                    
       End                    
      End                    
--     else --goes to head It                    
--      Begin                    
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')                    
--       Begin                    
--        Insert into tbl_RequestRecApr                    
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
--       End   
--      End                    
    End                    
                       
    Else if (@Role = 'RegionalHead')                    
    Begin                    
     if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ORegionalHead and Role = 'OR' and @ORegionalHead IS NOT NULL and @ORegionalHead <> '')                    
       Begin                   
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('ORH')                    
       End                    
      End                    
     else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('OZH')                    
       End                    
      End                    
--     else --goes to head It                    
--      Begin                    
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')                    
--       Begin                    
--        Insert into tbl_RequestRecApr                    
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
--       End                    
--      End                    
    End                    
                        
    Else if (@Role = 'ZonalHead')                    
    Begin                    
     if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)                    
      Begin                    
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')                    
       Begin                    
        Insert into tbl_RequestRecApr                    
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                    
        print('OZH')                    
       End                    
      End                    
--     else --goes to head It                    
--      Begin                    
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')                    
--       Begin                    
--        Insert into tbl_RequestRecApr                    
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
--       End                    
--      End                    
    End                    
                    
   End                    
                    
  else if(@Category = 'CSO')                    
   Begin                    
                    
    Declare @OAVP varchar(20)               
    Declare @OHOD varchar(20)                   
    Declare @OSrAVP varchar(20)                    
    Declare @OVP varchar(20)                    
    Declare @OSrVP Varchar(20)                    
    Declare @OSrAVPIT Varchar(20)                    
    Declare @OHeadITCSO Varchar(20)                    
                    
    set @OAVP = (Select AVP from tbl_EmpTree where Emp_Id = @Requested_By)               
    set @OHOD = (Select Senior from tbl_EmpTree where Emp_Id = @Requested_By)                   
    set @OSrAVP = (Select SrAVP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OVP = (Select VP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OSrVP = (Select SrVP from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OSrAVPIT = (Select SrAVPIT from tbl_EmpTree where Emp_Id = @Requested_By)                    
    set @OHeadITCSO = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
                    
                    
    if(@Role = 'A.V.P.Sr. Assistant Vice President All')                    
    Begin                    
     if(rtrim(@OAVP) <> '' And @OAVP is Not NULL)                    
     Begin                    
      if NOT EXISTS  (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OAVP and Role ='OR' and @OAVP IS NOT NULL and @OAVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,AVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('AVP')                    
      End                    
     End                 
                   
   /*Zeba */               
                  
      else if(rtrim(@OHOD) <> '' And @OHOD is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHOD and Role ='OR' and @OHOD IS NOT NULL and @OHOD <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,Senior,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('HOD')                    
      End                    
     End                   
                   
  /* zeba*/                
                 
     else if(rtrim(@OSrAVP) <> '' And @OSrAVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrAVP and Role ='OR' and @OSrAVP IS NOT NULL and @OSrAVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrAVP')                    
      End                    
     End                    
     else if(rtrim(@OVP) <> '' And @OVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OVP and Role ='OR' and @OVP IS NOT NULL and @OVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,VP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('VP')                    
      End                    
     End                    
     else if(rtrim(@OSrVP) <> '' And @OSrVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrVP and Role ='OR' and @OSrVP IS NOT NULL and @OSrVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrVP')                    
      End                    
     End                    
     else if(rtrim(@OSrAVPIT) <> '' And @OSrAVPIT is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrAVPIT and Role ='OR' and @OSrAVPIT IS NOT NULL and @OSrAVPIT <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrAVPIT')                    
      End                    
     End                    
--     Else--goes to head IT                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITCSO and Role ='OR' and @OHeadITCSO IS NOT NULL and @OHeadITCSO <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
--      End                    
--     End                    
                    
    End                    
                    
    Else if(@Role = 'Vice PresidentSr. Assistant Vice President')                    
    Begin                    
   if(rtrim(@OVP) <> '' And @OVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OVP and Role ='OR' and @OVP IS NOT NULL and @OVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,VP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('VP')                    
      End                    
     End                    
     else if(rtrim(@OSrVP) <> '' And @OSrVP is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrVP and Role ='OR' and @OSrVP IS NOT NULL and @OSrVP <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrVP')                    
      End                    
     End                    
     else if(rtrim(@OSrAVPIT) <> '' And @OSrAVPIT is Not NULL)                     
     Begin                    
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrAVPIT and Role ='OR' and @OSrAVPIT IS NOT NULL and @OSrAVPIT <> '')                    
      Begin                    
       Insert into tbl_RequestRecApr                    
       Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
       print('SrAVPIT')                    
      End                    
     End                    
--     Else--goes to head IT                    
--     Begin                    
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITCSO and Role ='OR' and @OHeadITCSO IS NOT NULL and @OHeadITCSO <> '')                    
--      Begin                    
--       Insert into tbl_RequestRecApr                    
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
--      End                    
--     End                    
                    
    End                    
                    
   End                    
 End                    
                    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetRecApr_Backup
-- --------------------------------------------------
CREATE proc [dbo].[USP_GetRecApr_Backup]      
@Type char(20),      
@Category char(20),      
@Role varchar(100),      
@Request_Id int,      
@Requested_By varchar(20)      
As      
      
      
Begin      
--print(@Request_Id)Print(@RequesterBrCd)Print(@Type) Print(@Category)print(@Designation)print(@Department)print(@Sub_Department)      
      
if(@Type = 'R')      
 Begin      
  if(@Category = 'BRANCH')      
   Begin      
    Declare @BranchHead varchar(20)      
    Declare @ClusterHead varchar(20)      
    Declare @RegionalHead varchar(20)      
    Declare @ZonalHead Varchar(20)      
    Declare @HeadITBranch Varchar(20)      
      
    set @BranchHead = (Select BH from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @ClusterHead = (Select CH from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @RegionalHead = (Select RH from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @ZonalHead = (Select ZH from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @HeadITBranch = (Select HeadIT from tbl_EmpTree Where Emp_Id =@Requested_By)      
      
    if(@Role = 'BranchHead')      
    Begin      
     if(rtrim(@BranchHead) <> '' And @BranchHead is Not NULL )      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @BranchHead and Role = 'R' and @BranchHead IS NOT NULL and @BranchHead <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,BH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('BH')      
      End      
     End      
     else if(rtrim(@ClusterHead) <> '' AND @ClusterHead is Not NULL)      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ClusterHead and Role = 'R' and @ClusterHead IS NOT NULL and @ClusterHead <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,CH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('CH')      
      End      
     End      
     else if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @RegionalHead and Role = 'R' and @RegionalHead IS NOT NULL and @RegionalHead <> '')           
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('RH')      
      End      
     End      
     else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('ZH')      
      End      
     End      
--     else --goes to head It      
--     Begin      
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')      
--      Begin      
--       Insert into tbl_RequestRecApr      
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By       
--      End      
--     End      
      
    End      
           
    Else if (@Role = 'ClusterHead')      
    Begin      
     if(rtrim(@ClusterHead) <> '' AND @ClusterHead is Not NULL)      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ClusterHead and Role = 'R' and @ClusterHead IS NOT NULL and @ClusterHead <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,CH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('CH')      
      End      
     End      
     else if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @RegionalHead and Role = 'R' and @RegionalHead IS NOT NULL and @RegionalHead <> '')           
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('RH')      
      End      
     End      
     else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('ZH')      
      End      
     End      
--     else --goes to head It      
--     Begin      
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')      
--      Begin      
--       Insert into tbl_RequestRecApr      
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By       
--      End      
--     End      
      
    End      
         
    Else if (@Role = 'RegionalHead')      
    Begin      
     if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @RegionalHead and Role = 'R' and @RegionalHead IS NOT NULL and @RegionalHead <> '')           
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('RH')      
      End      
     End      
     else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('ZH')      
      End      
     End      
--     else --goes to head It      
--     Begin      
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')      
--      Begin      
--       Insert into tbl_RequestRecApr      
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By       
--      End      
--     End      
      
    End      
          
    Else if (@Role = 'ZonalHead')      
    Begin      
     if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ZonalHead and Role = 'R' and @ZonalHead IS NOT NULL and @ZonalHead <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('ZH')      
      End      
     End      
--     else --goes to head It      
--     Begin      
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITBranch and Role = 'R' and @HeadITBranch IS NOT NULL and @HeadITBranch <> '')      
--      Begin      
--       Insert into tbl_RequestRecApr      
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By       
--      End      
--     End      
    End      
      
   End      
      
  else if(@Category = 'CSO')      
   Begin      
      
    Declare @AVP varchar(20)      
    Declare @SrAVP varchar(20)      
    Declare @VP varchar(20)      
    Declare @SrVP Varchar(20)      
    Declare @SrAVPIT Varchar(20)      
    Declare @HeadITCSO Varchar(20)      
      
    set @AVP = (Select AVP from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @SrAVP = (Select SrAVP from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @VP = (Select VP from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @SrVP = (Select SrVP from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @HeadITCSO = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)      
      
      
    if(@Role = 'A.V.P.Sr. Assistant Vice President All')      
    Begin      
     if(rtrim(@AVP) <> '' And @AVP is Not NULL)      
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @AVP and Role = 'R' and @AVP IS NOT NULL and @AVP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,AVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('AVP')      
      End      
     End      
     else if(rtrim(@SrAVP) <> '' And @SrAVP is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrAVP and Role = 'R' and @SrAVP IS NOT NULL and @SrAVP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,SrAVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('SrAVP')      
      End      
     End      
     else if(rtrim(@VP) <> '' And @VP is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @VP and Role = 'R' and @VP IS NOT NULL and @VP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,VP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('VP')      
      End      
     End      
     else if(rtrim(@SrVP) <> '' And @SrVP is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrVP  and Role = 'R' and @SrVP IS NOT NULL and @SrVP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,SrVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('SrVP')      
      End      
     End      
     else if(rtrim(@SrAVPIT) <> '' And @SrAVPIT is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('SrAVPIT')      
      End      
     End      
--     Else--goes to head IT      
--     Begin      
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITCSO and Role = 'R' and @HeadITCSO IS NOT NULL and @HeadITCSO <> '')      
--      Begin      
--       Insert into tbl_RequestRecApr      
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))       
--      End      
--     End      
      
    End      
      
    Else if(@Role = 'Vice PresidentSr. Assistant Vice President')      
    Begin      
     if(rtrim(@VP) <> '' And @VP is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @VP and Role = 'R' and @VP IS NOT NULL and @VP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,VP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('VP')      
      End      
     End      
     else if(rtrim(@SrVP) <> '' And @SrVP is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrVP  and Role = 'R' and @SrVP IS NOT NULL and @SrVP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,SrVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('SrVP')      
      End      
     End      
     else if(rtrim(@SrAVPIT) <> '' And @SrAVPIT is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('SrAVPIT')      
      End      
     End      
--     Else--goes to head IT      
--     Begin      
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @HeadITCSO and Role = 'R' and @HeadITCSO IS NOT NULL and @HeadITCSO <> '')      
--      Begin      
--       Insert into tbl_RequestRecApr      
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))       
--      End      
--     End      
      
    End      
      
   End      
      
 End      
      
      
else if(@Type = 'OR')      
 Begin      
  if(@Category = 'BRANCH')      
   Begin      
    Declare @OBranchHead varchar(20)      
    Declare @OClusterHead varchar(20)      
    Declare @ORegionalHead varchar(20)      
    Declare @OZonalHead Varchar(20)      
    Declare @OHeadITBranch Varchar(20)      
      
    set @OBranchHead = (Select BH from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @OClusterHead = (Select CH from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @ORegionalHead = (Select RH from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @OZonalHead = (Select ZH from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @OHeadITBranch = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)      
      
      
    if(@Role = 'BranchHead')      
    Begin      
     if(rtrim(@OBranchHead) <> '' And @OBranchHead is Not NULL )      
   Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OBranchHead and Role = 'OR' and @OBranchHead IS NOT NULL and @OBranchHead <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,BH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('OBH')      
      End      
     End      
     else if(rtrim(@OClusterHead) <> '' AND @OClusterHead is Not NULL)      
      Begin      
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OClusterHead and Role = 'OR' and @OClusterHead IS NOT NULL and @OClusterHead <> '')      
       Begin      
        Insert into tbl_RequestRecApr      
        Select @Request_Id,CH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
        print('OCH')      
       End      
      End      
     else if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)      
      Begin      
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ORegionalHead and Role = 'OR' and @ORegionalHead IS NOT NULL and @ORegionalHead <> '')      
       Begin      
        Insert into tbl_RequestRecApr      
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
        print('ORH')      
       End      
      End      
     else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)      
      Begin      
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')      
       Begin      
        Insert into tbl_RequestRecApr      
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
        print('OZH')      
       End      
      End      
--     else --goes to head It      
--      Begin      
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')      
--       Begin      
--        Insert into tbl_RequestRecApr      
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By      
--       End      
--      End      
      
    End      
           
    Else if (@Role = 'ClusterHead')      
    Begin      
     if(rtrim(@OClusterHead) <> '' AND @OClusterHead is Not NULL)      
      Begin      
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OClusterHead and Role = 'OR' and @OClusterHead IS NOT NULL and @OClusterHead <> '')      
       Begin      
        Insert into tbl_RequestRecApr      
        Select @Request_Id,CH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
        print('OCH')      
       End      
      End      
     else if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)      
      Begin      
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ORegionalHead and Role = 'OR' and @ORegionalHead IS NOT NULL and @ORegionalHead <> '')      
       Begin      
        Insert into tbl_RequestRecApr      
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
        print('ORH')      
       End      
      End      
     else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)      
      Begin      
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')      
       Begin      
        Insert into tbl_RequestRecApr      
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
        print('OZH')      
       End      
      End      
--     else --goes to head It      
--      Begin      
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')      
--       Begin      
--        Insert into tbl_RequestRecApr      
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By      
--       End      
--      End      
    End      
         
    Else if (@Role = 'RegionalHead')      
    Begin      
     if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)      
      Begin      
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @ORegionalHead and Role = 'OR' and @ORegionalHead IS NOT NULL and @ORegionalHead <> '')      
       Begin      
        Insert into tbl_RequestRecApr      
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
        print('ORH')      
       End      
      End      
     else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)      
      Begin      
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')      
       Begin      
        Insert into tbl_RequestRecApr      
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
        print('OZH')      
       End      
      End      
--     else --goes to head It      
--      Begin      
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')      
--       Begin      
--        Insert into tbl_RequestRecApr      
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By      
--       End      
--      End      
    End      
          
    Else if (@Role = 'ZonalHead')      
    Begin      
     if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)      
      Begin      
       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OZonalHead and Role = 'OR' and @OZonalHead IS NOT NULL and @OZonalHead <> '')      
       Begin      
        Insert into tbl_RequestRecApr      
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))      
        print('OZH')      
       End      
      End      
--     else --goes to head It      
--      Begin      
--       if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITBranch and Role = 'OR' and @OHeadITBranch IS NOT NULL and @OHeadITBranch <> '')      
--       Begin      
--        Insert into tbl_RequestRecApr      
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By      
--       End      
--      End      
    End      
      
   End      
      
  else if(@Category = 'CSO')      
   Begin      
      
    Declare @OAVP varchar(20)      
    Declare @OSrAVP varchar(20)      
    Declare @OVP varchar(20)      
    Declare @OSrVP Varchar(20)      
    Declare @OSrAVPIT Varchar(20)      
    Declare @OHeadITCSO Varchar(20)      
      
    set @OAVP = (Select AVP from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @OSrAVP = (Select SrAVP from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @OVP = (Select VP from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @OSrVP = (Select SrVP from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @OSrAVPIT = (Select SrAVPIT from tbl_EmpTree where Emp_Id = @Requested_By)      
    set @OHeadITCSO = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)      
      
      
    if(@Role = 'A.V.P.Sr. Assistant Vice President All')      
    Begin      
     if(rtrim(@OAVP) <> '' And @OAVP is Not NULL)      
     Begin      
      if NOT EXISTS  (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OAVP and Role ='OR' and @OAVP IS NOT NULL and @OAVP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,AVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('AVP')      
      End      
     End      
     else if(rtrim(@OSrAVP) <> '' And @OSrAVP is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrAVP and Role ='OR' and @OSrAVP IS NOT NULL and @OSrAVP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,SrAVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('SrAVP')      
      End      
     End      
     else if(rtrim(@OVP) <> '' And @OVP is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OVP and Role ='OR' and @OVP IS NOT NULL and @OVP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,VP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('VP')      
      End      
     End      
     else if(rtrim(@OSrVP) <> '' And @OSrVP is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrVP and Role ='OR' and @OSrVP IS NOT NULL and @OSrVP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,SrVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('SrVP')      
      End      
     End      
     else if(rtrim(@OSrAVPIT) <> '' And @OSrAVPIT is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrAVPIT and Role ='OR' and @OSrAVPIT IS NOT NULL and @OSrAVPIT <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('SrAVPIT')      
      End      
     End      
--     Else--goes to head IT      
--     Begin      
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITCSO and Role ='OR' and @OHeadITCSO IS NOT NULL and @OHeadITCSO <> '')      
--      Begin      
--       Insert into tbl_RequestRecApr      
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
--      End      
--     End      
      
    End      
      
    Else if(@Role = 'Vice PresidentSr. Assistant Vice President')      
    Begin      
   if(rtrim(@OVP) <> '' And @OVP is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OVP and Role ='OR' and @OVP IS NOT NULL and @OVP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,VP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('VP')      
      End      
     End      
     else if(rtrim(@OSrVP) <> '' And @OSrVP is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrVP and Role ='OR' and @OSrVP IS NOT NULL and @OSrVP <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,SrVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('SrVP')      
      End      
     End      
     else if(rtrim(@OSrAVPIT) <> '' And @OSrAVPIT is Not NULL)       
     Begin      
      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OSrAVPIT and Role ='OR' and @OSrAVPIT IS NOT NULL and @OSrAVPIT <> '')      
      Begin      
       Insert into tbl_RequestRecApr      
       Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
       print('SrAVPIT')      
      End      
     End      
--     Else--goes to head IT      
--     Begin      
--      if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @OHeadITCSO and Role ='OR' and @OHeadITCSO IS NOT NULL and @OHeadITCSO <> '')      
--      Begin      
--       Insert into tbl_RequestRecApr      
--       Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))      
--      End      
--     End      
      
    End      
      
   End      
 End      
      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetRecApr_New
-- --------------------------------------------------
--[USP_GetRecApr] 'R','CSO','A.V.P.Sr. Assistant Vice President All','11360','E59389'      
CREATE proc [dbo].[USP_GetRecApr_New]-- 'R'   ,'branch','BranchHead','7883','E37859'                   
@Type char(20),                        
@Category char(20),                        
@Role varchar(100),                        
@Request_Id int,                        
@Requested_By varchar(20)                        
As                        
Begin     
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
                       
--print(@Request_Id)Print(@RequesterBrCd)Print(@Type) Print(@Category)print(@Designation)print(@Department)print(@Sub_Department)                        
                        
if(@Type = 'R')                        
 Begin                        
  if(@Category= 'BRANCH' or @Category='CSO'  )                        
   Begin                        
    Declare @BranchHead varchar(20)                        
    Declare @ClusterHead varchar(20)                        
    Declare @RegionalHead varchar(20)                        
    Declare @ZonalHead Varchar(20)                        
    Declare @HeadITBranch Varchar(20)    
        
    Declare @EmpSenior Varchar(20)                        
                        
    set @BranchHead = (Select BH from tbl_EmpTree where Emp_Id = @Requested_By)                        
    set @ClusterHead = (Select CH from tbl_EmpTree where Emp_Id = @Requested_By)                        
    set @RegionalHead = (Select RH from tbl_EmpTree where Emp_Id = @Requested_By)                        
    set @ZonalHead = (Select ZH from tbl_EmpTree where Emp_Id = @Requested_By)                        
    set @HeadITBranch = (Select HeadIT from tbl_EmpTree Where Emp_Id =@Requested_By)                        
    set @EmpSenior = (Select Senior from tbl_EmpTree Where Emp_Id =@Requested_By)                        
    if(@Role = 'DepartmentHOD')                        
    Begin                       
        
     if(rtrim(@EmpSenior) <> '' AND @EmpSenior is Not NULL)                        
     Begin                        
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @EmpSenior and Role = 'R' and @EmpSenior IS NOT NULL and @EmpSenior <> '')                        
      Begin              
      --department Hod            
       Insert into tbl_RequestRecApr                        
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By --and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                        
       print('SR')                        
       --Narendra Kekan  
       
       --Insert into tbl_RequestRecApr                        
       --Select top 1 @Request_Id,'E69242','R' from tbl_EmpTree            
      End                        
     End                
    End                        
                             
    Else if (@Role = 'CIO')                        
    Begin                        
      Insert into tbl_RequestRecApr                        
       Select top 1 @Request_Id,'E63575','R' from tbl_EmpTree   
    End                        
                           
    Else if (@Role = 'CEO')                        
    Begin                     
     Insert into tbl_RequestRecApr                        
     Select top 1 @Request_Id,'P01015','R' from tbl_EmpTree            
    End                        
                            
    Else if (@Role = 'Director')                        
    Begin                        
     Insert into tbl_RequestRecApr                        
     Select top 1 @Request_Id,'D00002','R' from tbl_EmpTree            
    End                        
                        
   End                        
                        
        
 End                        
                        
                        
               
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetRecApr_New_12072018
-- --------------------------------------------------
--[USP_GetRecApr] 'R','CSO','A.V.P.Sr. Assistant Vice President All','11360','E59389'      
Create proc [dbo].[USP_GetRecApr_New_12072018]-- 'R'   ,'branch','BranchHead','7883','E37859'                   
@Type char(20),                        
@Category char(20),                        
@Role varchar(100),                        
@Request_Id int,                        
@Requested_By varchar(20)                        
As                        
Begin     
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
                       
--print(@Request_Id)Print(@RequesterBrCd)Print(@Type) Print(@Category)print(@Designation)print(@Department)print(@Sub_Department)                        
                        
if(@Type = 'R')                        
 Begin                        
  if(@Category= 'BRANCH' or @Category='CSO'  )                        
   Begin                        
    Declare @BranchHead varchar(20)                        
    Declare @ClusterHead varchar(20)                        
    Declare @RegionalHead varchar(20)                        
    Declare @ZonalHead Varchar(20)                        
    Declare @HeadITBranch Varchar(20)    
        
    Declare @EmpSenior Varchar(20)                        
                        
    set @BranchHead = (Select BH from tbl_EmpTree where Emp_Id = @Requested_By)                        
    set @ClusterHead = (Select CH from tbl_EmpTree where Emp_Id = @Requested_By)                        
    set @RegionalHead = (Select RH from tbl_EmpTree where Emp_Id = @Requested_By)                        
    set @ZonalHead = (Select ZH from tbl_EmpTree where Emp_Id = @Requested_By)                        
    set @HeadITBranch = (Select HeadIT from tbl_EmpTree Where Emp_Id =@Requested_By)                        
    set @EmpSenior = (Select Senior from tbl_EmpTree Where Emp_Id =@Requested_By)                        
    if(@Role = 'DepartmentHOD')                        
    Begin                       
        
     if(rtrim(@EmpSenior) <> '' AND @EmpSenior is Not NULL)                        
     Begin                        
      if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = @EmpSenior and Role = 'R' and @EmpSenior IS NOT NULL and @EmpSenior <> '')                        
      Begin              
      --department Hod            
       Insert into tbl_RequestRecApr                        
       Select @Request_Id,Senior,'R' from tbl_EmpTree where Emp_Id = @Requested_By --and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))                        
       print('SR')                        
       --Narendra Kekan  
       Insert into tbl_RequestRecApr                        
       Select top 1 @Request_Id,'E69242','R' from tbl_EmpTree            
      End                        
     End                
    End                        
                             
    Else if (@Role = 'CIO')                        
    Begin                        
      Insert into tbl_RequestRecApr                        
       Select top 1 @Request_Id,'E63575','R' from tbl_EmpTree   
    End                        
                           
    Else if (@Role = 'CEO')                        
    Begin                     
     Insert into tbl_RequestRecApr                        
     Select top 1 @Request_Id,'P01015','R' from tbl_EmpTree            
    End                        
                            
    Else if (@Role = 'Director')                        
    Begin                        
     Insert into tbl_RequestRecApr                        
     Select top 1 @Request_Id,'D00002','R' from tbl_EmpTree            
    End                        
                        
   End                        
                        
        
 End                        
                        
                        
               
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetRecApr_WITH_MULTIPLE_ENTRIES
-- --------------------------------------------------
CREATE proc [dbo].[USP_GetRecApr_WITH_MULTIPLE_ENTRIES]  
@Type char(20),  
@Category char(20),  
@Role varchar(100),  
@Request_Id int,  
@Requested_By varchar(20)  
As  
  
  
Begin  

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


--print(@Request_Id)Print(@RequesterBrCd)Print(@Type) Print(@Category)print(@Designation)print(@Department)print(@Sub_Department)  
  
if(@Type = 'R')  
 Begin  
  if(@Category = 'BRANCH')  
   Begin  
    Declare @BranchHead varchar(20)  
    Declare @ClusterHead varchar(20)  
    Declare @RegionalHead varchar(20)  
    Declare @ZonalHead Varchar(20)  
  
    set @BranchHead = (Select BH from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @ClusterHead = (Select CH from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @RegionalHead = (Select RH from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @ZonalHead = (Select ZH from tbl_EmpTree where Emp_Id = @Requested_By)  
  
    if(@Role = 'BranchHead')  
    Begin  
      if(rtrim(@BranchHead) <> '' And @BranchHead is Not NULL )  
       Begin  
        Insert into tbl_RequestRecApr   
        Select @Request_Id,BH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('BH')  
       End  
  
      else if(rtrim(@ClusterHead) <> '' AND @ClusterHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,CH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('CH')  
       End  
  
      else if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('RH')  
       End  
      else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('ZH')  
       End  
--      else --goes to head It  
--       Begin  
--        Insert into tbl_RequestRecApr  
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By   
--       End  
  
    End  
       
     Else if (@Role = 'ClusterHead')  
     Begin  
       if(rtrim(@ClusterHead) <> '' AND @ClusterHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,CH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('CH')  
       End  
  
      else if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('RH')  
       End  
      else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('ZH')  
       End  
--      else --goes to head It  
--       Begin  
--        Insert into tbl_RequestRecApr  
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By  
--       End  
  
     End  
     
     Else if (@Role = 'RegionalHead')  
     Begin  
      if(rtrim(@RegionalHead) <> '' AND @RegionalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,RH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('RH')  
       End  
      else if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('ZH')  
       End  
--      else --goes to head It  
--       Begin  
--        Insert into tbl_RequestRecApr  
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By  
--       End  
     End  
      
     Else if (@Role = 'ZonalHead')  
     Begin  
       if(rtrim(@ZonalHead) <> '' AND @ZonalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,ZH,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('ZH')  
       End  
--       else --goes to head It  
--       Begin  
--        Insert into tbl_RequestRecApr  
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By  
--       End  
     End  
  
   End  
  
  else if(@Category = 'CSO')  
   Begin  
  
    Declare @AVP varchar(20)  
    Declare @SrAVP varchar(20)  
    Declare @VP varchar(20)  
    Declare @SrVP Varchar(20)  
    Declare @SrAVPIT Varchar(20)  
  
    set @AVP = (Select AVP from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @SrAVP = (Select SrAVP from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @VP = (Select VP from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @SrVP = (Select SrVP from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree where Emp_Id = @Requested_By)  
  
  
    if(@Role = 'A.V.P.Sr. Assistant Vice President All')  
    Begin  
     if(rtrim(@AVP) <> '' And @AVP is Not NULL)  
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,AVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('AVP')  
     End  
     else if(rtrim(@SrAVP) <> '' And @SrAVP is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,SrAVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('SrAVP')  
     End  
     else if(rtrim(@VP) <> '' And @VP is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,VP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('VP')  
     End  
     else if(rtrim(@SrVP) <> '' And @SrVP is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,SrVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('SrVP')  
     End  
     else if(rtrim(@SrAVPIT) <> '' And @SrAVPIT is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('SrAVPIT')  
     End  
--     Else--goes to head IT  
--     Begin  
--     Insert into tbl_RequestRecApr  
--     Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
--     End  
  
    End  
  
  
   Else if(@Role = 'Vice PresidentSr. Assistant Vice President')  
    Begin  
       
      if(rtrim(@VP) <> '' And @VP is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,VP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('VP')  
     End  
     else if(rtrim(@SrVP) <> '' And @SrVP is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,SrVP,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('SrVP')  
     End  
     else if(rtrim(@SrAVPIT) <> '' And @SrAVPIT is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('SrAVPIT')  
     End  
  
--     Else--goes to head IT  
--     Begin  
--     Insert into tbl_RequestRecApr  
--     Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
--     End  
  
    End  
  
   End  
  
 End  
  
  
else if(@Type = 'OR')  
 Begin  
  if(@Category = 'BRANCH')  
   Begin  
    Declare @OBranchHead varchar(20)  
    Declare @OClusterHead varchar(20)  
    Declare @ORegionalHead varchar(20)  
    Declare @OZonalHead Varchar(20)  
  
    set @OBranchHead = (Select BH from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @OClusterHead = (Select CH from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @ORegionalHead = (Select RH from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @OZonalHead = (Select ZH from tbl_EmpTree where Emp_Id = @Requested_By)  
  
    if(@Role = 'BranchHead')  
    Begin  
      if(rtrim(@OBranchHead) <> '' And @OBranchHead is Not NULL )  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,BH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('OBH')  
       End  
  
      else if(rtrim(@OClusterHead) <> '' AND @OClusterHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,CH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('OCH')  
       End  
  
      else if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('ORH')  
       End  
      else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('OZH')  
       End  
--      else --goes to head It  
--       Begin  
--        Insert into tbl_RequestRecApr  
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By  
--       End  
  
    End  
       
     Else if (@Role = 'ClusterHead')  
     Begin  
        if(rtrim(@OClusterHead) <> '' AND @OClusterHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,CH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('OCH')  
       End  
  
      else if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('ORH')  
       End  
      else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('OZH')  
       End  
--      else --goes to head It  
--       Begin  
--        Insert into tbl_RequestRecApr  
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By  
--       End  
  
     End  
     
     Else if (@Role = 'RegionalHead')  
     Begin  
      if(rtrim(@ORegionalHead) <> '' AND @ORegionalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,RH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('ORH')  
       End  
      else if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('OZH')  
       End  
--      else --goes to head It  
--       Begin  
--        Insert into tbl_RequestRecApr  
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By  
--       End  
     End  
      
     Else if (@Role = 'ZonalHead')  
     Begin  
       if(rtrim(@OZonalHead) <> '' AND @OZonalHead is Not NULL)  
       Begin  
        Insert into tbl_RequestRecApr  
        Select @Request_Id,ZH,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code not in (select branch_cd from tbl_CSO_Branch(nolock))  
        print('OZH')  
       End  
--       else --goes to head It  
--       Begin  
--        Insert into tbl_RequestRecApr  
--        Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By  
--       End  
     End  
  
   End  
  
  else if(@Category = 'CSO')  
   Begin  
  
    Declare @OAVP varchar(20)  
    Declare @OSrAVP varchar(20)  
    Declare @OVP varchar(20)  
    Declare @OSrVP Varchar(20)  
    Declare @OSrAVPIT Varchar(20)  
  
    set @OAVP = (Select AVP from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @OSrAVP = (Select SrAVP from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @OVP = (Select VP from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @OSrVP = (Select SrVP from tbl_EmpTree where Emp_Id = @Requested_By)  
    set @OSrAVPIT = (Select SrAVPIT from tbl_EmpTree where Emp_Id = @Requested_By)  
  
  
    if(@Role = 'A.V.P.Sr. Assistant Vice President All')  
    Begin  
     if(rtrim(@OAVP) <> '' And @OAVP is Not NULL)  
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,AVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('AVP')  
     End  
     else if(rtrim(@OSrAVP) <> '' And @OSrAVP is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,SrAVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('SrAVP')  
     End  
     else if(rtrim(@OVP) <> '' And @OVP is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,VP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('VP')  
     End  
     else if(rtrim(@OSrVP) <> '' And @OSrVP is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,SrVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('SrVP')  
     End  
     else if(rtrim(@OSrAVPIT) <> '' And @OSrAVPIT is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('SrAVPIT')  
     End  
--     Else--goes to head IT  
--     Begin  
--     Insert into tbl_RequestRecApr  
--     Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
--     End  
  
    End  
  
  
   Else if(@Role = 'Vice PresidentSr. Assistant Vice President')  
    Begin  
       
      if(rtrim(@OVP) <> '' And @OVP is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,VP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('VP')  
     End  
     else if(rtrim(@OSrVP) <> '' And @OSrVP is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,SrVP,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('SrVP')  
     End  
     else if(rtrim(@OSrAVPIT) <> '' And @OSrAVPIT is Not NULL)   
     Begin  
      Insert into tbl_RequestRecApr  
      Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))  
      print('SrAVPIT')  
     End  
  
--     Else--goes to head IT  
--     Begin  
--     Insert into tbl_RequestRecApr  
--     Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))   
--     End  
  
    End  
  
   End  
 End  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetRecommender
-- --------------------------------------------------


CREATE Procedure [dbo].[USP_GetRecommender]
(
@Option char(20),
@Request_Id int
)

As
Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


--	Select distinct(Emp_no),Emp_Name,Designation,Department,Branch_Cd,EmailAdd
--			 from Emp_Info
 if(@Option = 'Recommender')
	Begin
--		 Select Distinct(EI.Emp_no),EI.Emp_Name,EI.Designation,EI.Department,EI.Branch_Cd,EI.EmailAdd
--		 from tbl_requestRecApr RRA
--			Inner  Join Emp_Info EI
--		 On RRA.Emp_Code = EI.Emp_no  and RRA.Request_Id = @Request_Id and RRA.[Role] = 'R'

		 Select Distinct(EI.Emp_no),EI.Emp_Name,EI.Designation,EI.Department,EI.Branch_Cd,EI.EmailAdd
				 from tbl_requestRecApr RRA
					Inner  Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no  
					Inner Join tbl_RequestMaster RM on RRA.Request_Id = RM.Request_Id
				Where RRA.Request_Id = @Request_Id and RRA.[Role] = 'R' and RRA.Emp_Code <> RM.Requested_By
	End

		
--		create table #temp
--		(
--			emp_code char(10),
--			emp_name varchar(255),
--			branch_cd varchar(100),
--			emailadd nvarchar(100)
--		)
--		insert into #temp(emp_code,emp_name,branch_cd,emailadd) values('E05207','Megha Ramesh Wangane','HO','megha.wangane@angelbroking.com')
--		insert into #temp(emp_code,emp_name,branch_cd,emailadd)values('E33588','Anil Namdeo','HO','anil.namdeo@angelbroking.com')
--		select Emp_Code,Emp_Name,branch_Cd,EmailAdd from #temp

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetRecommenderAndApprover
-- --------------------------------------------------
  
  
CREATE Procedure [dbo].[USP_GetRecommenderAndApprover]  
(  
@Option char(20),  
@Request_Id int  
)  
  
As  
Begin 

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


 
  
Declare @branch_cd nvarchar(255)  
set @branch_cd =(select branch_cd from emp_info where emp_no = (select requested_by from tbl_requestmaster where request_id = @Request_Id))  
  
Declare @Category char(20)  
if(@branch_cd in (select branch_cd from tbl_CSO_Branch(nolock)))  
 Begin  
  set @Category = 'CSO'   
 End  
Else  
 Begin  
  set @Category = 'BRANCH'  
End  
  
  
Declare @Department nvarchar(200)  
set @Department = (Select department from emp_info where emp_no = (select requested_by from tbl_requestmaster where request_id = @Request_Id))  
  
    
Declare @Estimasted_Total_price float  
set @Estimasted_Total_price =(Select Estimated_Total_Price from tbl_RequestMaster where Request_Id = @Request_Id)  
  
   
 if(@Option = 'Recommender')  
  
  Begin  
  
-------------------------------------------------------------------  
     select U_Role  
     from tbl_recommendation_limitmaster   
     where @Estimasted_Total_price between Rec_limitFrom and Rec_LimitTo  
     And category=@Category  
--------------------------------------------------------      
-------if other info of the recommender is needed then just uncomment the below code and comment the above code--------   
  
--     select U_Role into #Recommenders  
--      from tbl_recommendation_limitmaster   
--     where @Estimasted_Total_price between Rec_limitFrom and Rec_LimitTo  
--     And category=@Category  
--    Select emp_no,emp_name,designation,department,Branch_cd   
--    from emp_info  
--    where designation in  (select U_Role from #Recommenders) and department=@Department  
  
--------------------------------------------------------------------  
  
      
  End  
  
 else if (@Option = 'Approver')  
  Begin  
     select U_Role  
     from tbl_Approval_LimitMaster  
     where @Estimasted_Total_price between Apr_limitFrom and Apr_LimitTo  
     And category=@Category  
-----------------------------  
----half left fro here  to work on it-----  
--     select designation  
--     from emp_info  
--     where emp_no=(select Recommended_By from tbl_requestmaster where request_id=@Request_Id)   
  
  
  
--------------------  
  
  End  
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetReqdetails_PO
-- --------------------------------------------------










CREATE proc [dbo].[Usp_GetReqdetails_PO]      
(      
@Request_Id nVarchar(max)  
)      
as      
      
Begin


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


Declare @Query nvarchar(max)
Set  @Query = 'select RM.Request_Id As[Request Id],RM.User_Remark As[User Remark],
				CPM.Product_Name As[Item Name],PMM.Model_Name As [Model Name],
				CONVERT(INT, RM.Model_Quantity)-CONVERT(INT, RM.Model_Quantity_Assigned)  As [Model Quantity To Purchase]
				from Tbl_RequestMaster RM 
				Left Outer Join tbl_CapexProductmaster CPM on RM.Item_Code = CPM.Product_Code
				Left Outer Join tbl_ProductModelMaster PMM on RM.Model_No = PMM.Model_Id						 
				where  RM.Request_Id in ('+@Request_Id+') and RM.Status_Code=''A'''

Print(@Query)
Exec(@Query)


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getRequestLimit
-- --------------------------------------------------





CREATE proc [dbo].[usp_getRequestLimit]
@User_ID as varchar(15)

as
	Begin
	 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
	
	

declare @Category char(10)
declare @BranchCode char(20)

set @BranchCode=(select branch_cd from emp_info where emp_no =@User_ID)
if(@BranchCode in ('ACM','AKSTR','CSO','BOK','HO','CALNT'))
Begin
	Set @Category='CSO'
End
else
Begin
	Set @Category='Branch'
End



declare @U_Role char(100)
declare @Dep char(150)

set @U_Role=(Select Designation From Emp_Info where Emp_No=@User_ID and Status='A')

if(@U_Role not in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager','Associate Director',' Sr. Assistant Vice President','Head'))
Begin
	set @U_Role='User'
End

if  (@User_ID= 'E72600')

begin 
		set @U_Role='Regional Head'  
		--print @U_Role
end


set @Dep=(Select Department From Emp_Info where Emp_No=@User_ID and Status='A')
	if(@Dep <>'IT')
	Begin
		set @Dep='ALL' --If Department is not IT then assume any other Department i.e say ALL
	End 


if(@U_Role='User' and @Category='Branch')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='User' and Category='Branch' and Department='ALL'
	End
else if(@U_Role='Regional Head')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='Regional Head' and Category='Branch' and Department='ALL'
	End
else if(@U_Role='Regional Manager')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='Regional Manager' and Category='Branch' and Department='ALL'
	End
else if(@U_Role='Zonal Head')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='Zonal Head' and Category='Branch' and Department='ALL'
	End
else if(@U_Role='Zonal Manager')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='Zonal Manager' and Category='Branch' and Department='ALL'
	End

else if(@U_Role='Associate Director')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='Associate Director' and Category='Branch' and Department='IT'
	End
else if(@U_Role='User' and @Category='CSO')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='User' and Category='CSO' and Department='ALL'
	End
else if(@U_Role='Sr. Assistant Vice President' )
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role = 'Sr. Assistant Vice President' and  Category='CSO' and Department='IT'
	End
else if(@U_Role='Head' )
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role = 'Head' and Category='CSO' and Department='IT'
	End
else if(@U_Role='Associate Director')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role = 'Associate Director' and Category='CSO' and Department='IT'
	End


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getRequestLimit_10012018
-- --------------------------------------------------





Create  proc [dbo].[usp_getRequestLimit_10012018]
@User_ID as varchar(15)

as
	Begin
	 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
	
	

declare @Category char(10)
declare @BranchCode char(20)

set @BranchCode=(select branch_cd from emp_info where emp_no =@User_ID)
if(@BranchCode in ('ACM','AKSTR','CSO','BOK','HO','CALNT'))
Begin
	Set @Category='CSO'
End
else
Begin
	Set @Category='Branch'
End



declare @U_Role char(100)
declare @Dep char(150)

set @U_Role=(Select Designation From Emp_Info where Emp_No=@User_ID and Status='A')

if(@U_Role not in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager','Associate Director',' Sr. Assistant Vice President','Head'))
Begin
	set @U_Role='User'
End



set @Dep=(Select Department From Emp_Info where Emp_No=@User_ID and Status='A')
	if(@Dep <>'IT')
	Begin
		set @Dep='ALL' --If Department is not IT then assume any other Department i.e say ALL
	End 


if(@U_Role='User' and @Category='Branch')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='User' and Category='Branch' and Department='ALL'
	End
else if(@U_Role='Regional Head')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='Regional Head' and Category='Branch' and Department='ALL'
	End
else if(@U_Role='Regional Manager')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='Regional Manager' and Category='Branch' and Department='ALL'
	End
else if(@U_Role='Zonal Head')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='Zonal Head' and Category='Branch' and Department='ALL'
	End
else if(@U_Role='Zonal Manager')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='Zonal Manager' and Category='Branch' and Department='ALL'
	End

else if(@U_Role='Associate Director')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='Associate Director' and Category='Branch' and Department='IT'
	End
else if(@U_Role='User' and @Category='CSO')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role ='User' and Category='CSO' and Department='ALL'
	End
else if(@U_Role='Sr. Assistant Vice President' )
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role = 'Sr. Assistant Vice President' and  Category='CSO' and Department='IT'
	End
else if(@U_Role='Head' )
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role = 'Head' and Category='CSO' and Department='IT'
	End
else if(@U_Role='Associate Director')
	Begin
		Select LimitFrom,LimitTo 
		From Tbl_UserLimit
		Where U_Role = 'Associate Director' and Category='CSO' and Department='IT'
	End


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetReviewer
-- --------------------------------------------------

-- =============================================
-- Author:		Suraj Patil
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE USP_GetReviewer
	
AS
BEGIN
		select * from Tbl_ReviewerMaster where isdelete = 0 order by TypeOfReviewer
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetUserDetails
-- --------------------------------------------------
CREATE proc [dbo].[usp_GetUserDetails]        
(        
@User_id char(10)        
)        
As        
Begin  

      
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
--        
--  if @User_id='E07260'      
--  begin        
-- set @User_id='P00226'      
--  end       
        
 -- if @User_id='E31119'      
 -- begin        
 --set @User_id='E22062'      
 -- end       
         
  select Emp_no AS [Emp_No],Emp_Name AS [Emp_Name],Designation AS [Designation],Branch_cd AS [Branch_cd]        
   from Emp_Info        
  where emp_no = @User_id and Status='A'        
          
  Select Role AS [Role]        
  FROM tbl_ITUsers        
  WHERE Emp_Id = @User_id        
        
        
        
  Declare @Sep_Date Datetime        
  Declare @Access_Status varchar(50)        
        
  Set @Sep_Date = (select Separation_Date As [Separation_Date]         
    from Emp_Info        
    where Emp_No = @User_id)        
        
  IF (ISNULL(@Sep_Date,'') <> '')        
  Begin        
   If(Convert(Datetime,Convert(varchar(11),Convert(datetime,@Sep_Date),113)) > Convert(Datetime,Convert(varchar(11),Convert(datetime,getdate()),113)))         
   Begin        
    Set @Access_Status = 'Allow'        
    print('Allow')        
   End        
   Else         
   Begin        
     Set @Access_Status = 'Disallow'        
    print('Disallow')        
   End        
  End        
           
  Else        
  Begin        
   Set @Access_Status = 'Allow'        
    print('AllowDirectly')        
  End         
         
  Select @Access_Status As [Access_Status]                 
         
        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetUserDetails_05Feb2020
-- --------------------------------------------------
CREATE proc [dbo].[usp_GetUserDetails_05Feb2020]        
(        
@User_id char(10)        
)        
As        
Begin  

      
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
--        
--  if @User_id='E07260'      
--  begin        
-- set @User_id='P00226'      
--  end       
        
 -- if @User_id='E31119'      
 -- begin        
 --set @User_id='E22062'      
 -- end       
         
  select Emp_no AS [Emp_No],Emp_Name AS [Emp_Name],Designation AS [Designation],Branch_cd AS [Branch_cd]        
   from Emp_Info        
  where emp_no = @User_id and Status='A'        
          
  Select Role AS [Role]        
  FROM [196.1.115.239].[Harmony].DBO.tbl_ITUsers        
  WHERE Emp_Id = @User_id        
        
        
        
  Declare @Sep_Date Datetime        
  Declare @Access_Status varchar(50)        
        
  Set @Sep_Date = (select Separation_Date As [Separation_Date]         
    from Emp_Info        
    where Emp_No = @User_id)        
        
  IF (ISNULL(@Sep_Date,'') <> '')        
  Begin        
   If(Convert(Datetime,Convert(varchar(11),Convert(datetime,@Sep_Date),113)) > Convert(Datetime,Convert(varchar(11),Convert(datetime,getdate()),113)))         
   Begin        
    Set @Access_Status = 'Allow'        
    print('Allow')        
   End        
   Else         
   Begin        
     Set @Access_Status = 'Disallow'        
    print('Disallow')        
   End        
  End        
           
  Else        
  Begin        
   Set @Access_Status = 'Allow'        
    print('AllowDirectly')        
  End         
         
  Select @Access_Status As [Access_Status]        
        
        
          
         
        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IncrModelQuantityAssigned
-- --------------------------------------------------



CREATE Procedure [dbo].[USP_IncrModelQuantityAssigned]
(
@Request_Id  int
)
as    
Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

declare @MdlQtyAssigned char(10)

set @MdlQtyAssigned =(Select Model_Quantity_Assigned From tbl_RequestMaster Where Request_Id=@Request_Id )
	
	

	Update tbl_RequestMaster
	set Model_Quantity_Assigned=@MdlQtyAssigned+1
	where Request_Id=@Request_Id

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_InformReq
-- --------------------------------------------------
CREATE Proc [dbo].[USP_InformReq] 
 @Requested_By varchar(20)
As

Begin


 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


Select A.Request_Id,B.Request_Id,A.Item_Code,A.Model_No,A.Estimated_total_Price,A.Requested_By,B.Emp_Code,B.[Role]
from tbl_RequestMaster A join tbl_RequestRecApr B on A.Request_Id = B.Request_Id
Where A.Request_Id <  '499' and A.Status_Code = 'P' and A.Requested_By = @Requested_By order by A.Request_ID

Select emailadd from emp_info where Emp_no in (Select A.Requested_By
from tbl_RequestMaster A join tbl_RequestRecApr B on A.Request_Id = B.Request_Id
Where A.Request_Id <  '499' and A.Status_Code = 'P' and A.Requested_By = @Requested_By) 



End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITAssetRequest
-- --------------------------------------------------
  
--SELECT * FROM   tbl_RequestMaster WHERE REQUEST_ID=4622
CREATE proc [dbo].[usp_ITAssetRequest]  --'4622','e01089','TEST','r'
@Request_Id int ,  
@Rec_By varchar(15),  
@User_Remark varchar(5000),  
--@Access_Code char(50),  
@Status char(15)  
as  

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

  
Declare @Status_Code char(20)  
Set @Status_Code =(Select Status_Code From tbl_RequestMaster Where Request_Id=@Request_Id)  
Declare @Limit float  
Set @Limit = (Select Estimated_Total_Price From tbl_RequestMaster Where Request_Id=@Request_Id)  
Declare @Desig char(50)  
Set @Desig =(Select Designation from Emp_Info where Emp_no=@Rec_By)  
  
  
  
  
--if(@Access_Code='CSO')  
--Begin  
-- Set @Access_Code='True'  
--End  
--Else  
--Begin  
-- Set @Access_Code='False'  
--End  
  
if(@Status='Recommended')  
begin  
--L1R Level--------  
  
 if(@Status_Code='P' and @Desig in('Executive Director','Chief Strategy Officer','Executive Director-CFO') and @Limit Between '2500000' and '5000000')  
  Begin  
   update tbl_RequestMaster set   
   User_Remark=@User_Remark,  
   Recommended_By=@Rec_By,   
   Recommended_Datetime =getdate(),  
   --CSO=@Access_Code,  
   Status_Code='L1R',  
   Level1_Recommended_By=@Rec_By,  
   Level1_Recommended_Datetime=getdate()  
   where Request_Id = @Request_Id   
  
   ---Log---  
--   update tbl_RequestMasterLog set   
--   User_Remark=@User_Remark,  
--   Recommended_By=@Rec_By,   
--   Recommended_Datetime =getdate(),  
--   CSO=@Access_Code,  
--   Status_Code='L1R',  
--   Level1_Recommended_By=@Rec_By,  
--   Level1_Recommended_Datetime=getdate()  
--   where Request_Id = @Request_Id      
   ---Log---  
  End  
  
 Else  
  Begin  
  
 update tbl_RequestMaster set   
 User_Remark=@User_Remark,  
 Recommended_By=@Rec_By,  
 Recommended_Datetime =getdate(),  
 --CSO=@Access_Code,  
 Status_Code='R'  
 where Request_Id = @Request_Id   
  
 ---Log---  
--  update tbl_RequestMasterLog set   
-- User_Remark=@User_Remark,  
-- Recommended_By=@Rec_By,  
-- Recommended_Datetime =getdate(),  
-- CSO=@Access_Code,  
-- Status_Code='R'  
-- where Request_Id = @Request_Id   
 ---Log---  
  end  
declare @Request_Id1 nvarchar(max)                    
Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster where Request_Id=@Request_Id)           
 
PRINT  @Request_Id1
          
EXECUTE Usp_Mailer_Options '1',@Request_Id1  
End  
else if(@Status='Rejected')  
begin  
 update tbl_RequestMaster set   
 User_Remark=@User_Remark,  
 Recommended_By=@Rec_By,  
 Recommended_Datetime =getdate(),  
 --CSO=@Access_Code,  
 Status_Code='Rej'  
 where Request_Id = @Request_Id   
  
  
 ---Log---  
-- update tbl_RequestMasterLog set   
-- User_Remark=@User_Remark,  
-- Recommended_By=@Rec_By,  
-- Recommended_Datetime =getdate(),  
-- CSO=@Access_Code,  
-- Status_Code='Rej'  
-- where Request_Id = @Request_Id   
   
 ---Log---  
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITAssetRequest_Approval
-- --------------------------------------------------

CREATE proc [dbo].[usp_ITAssetRequest_Approval]  
@Request_Id int ,  
@Apr_By varchar(15),  
@User_Remark varchar(5000),  
--@Access_Code char(50),  
@Status char(15),
@ITheadRmk varchar(100) =null 
as  

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

  
Declare @Status_Code char(20)  
Set @Status_Code =(Select Status_Code From tbl_RequestMaster Where Request_Id=@Request_Id)  
Declare @Limit float  
Set @Limit = (Select Estimated_Total_Price From tbl_RequestMaster Where Request_Id=@Request_Id)  
Declare @Desig char(50)  
Set @Desig =(Select Designation from Emp_Info where Emp_no=@Apr_By)  
  
  
--if(@Access_Code='CSO')  
--Begin  
-- Set @Access_Code='True'  
--End  
--Else  
--Begin  
-- Set @Access_Code='False'  
--End  
  
if(@Status='Approved')  
 Begin  
  if(@Status_Code='R' and @Desig in ('Executive Director','Associate Director') and @Limit Between '1000000' and '2500000')  
  Begin  
   update tbl_RequestMaster set   
   User_Remark=@User_Remark,  
   Approved_By=@Apr_By,  
   Approved_Datetime =getdate(),  
   --CSO=@Access_Code,  
   Status_Code='L1A',  
   Level1_Approved_By=@Apr_By,  
   Level1_Approved_Datetime=getdate(),
   ITHeadRemarks = @ITheadRmk
   where Request_Id = @Request_Id   
  
  ---Log---  
--   update tbl_RequestMasterLog set   
--   User_Remark=@User_Remark,  
--   Approved_By=@Apr_By,  
--   Approved_Datetime =getdate(),  
--   CSO=@Access_Code,  
--   Status_Code='L1A',  
--   Level1_Approved_By=@Apr_By,  
--   Level1_Approved_Datetime=getdate()  
--   where Request_Id = @Request_Id   
  ---Log---  
  End  
 Else If(@Status_Code='L1A' and @Desig in ('Chief Strategy Officer','Executive Director-CFO') and @Limit Between '1000000' and '2500000')  
   Begin  
     update tbl_RequestMaster set   
     User_Remark=@User_Remark,  
     Approved_By=@Apr_By,  
     Approved_Datetime =getdate(),  
     --CSO=@Access_Code,  
     Status_Code='A',
	 ITHeadRemarks = @ITheadRmk  
     where Request_Id = @Request_Id   
  
   ---Log---  
--     update tbl_RequestMasterLog set   
--     User_Remark=@User_Remark,  
--     Approved_By=@Apr_By,  
--     Approved_Datetime =getdate(),  
--     CSO=@Access_Code,  
--     Status_Code='A'  
--     where Request_Id = @Request_Id   
  
   ---Log---   
   End  
 Else If(@Status_Code='R' and @Desig in ('Executive Director','Chief Strategy Officer','Executive Director-CFO') and @Limit Between '2500000' and '5000000')  
   Begin  
     update tbl_RequestMaster set   
      User_Remark=@User_Remark,  
      Approved_By=@Apr_By,  
      Approved_Datetime =getdate(),  
      --CSO=@Access_Code,  
      Status_Code='L1A',  
      Level1_Approved_By=@Apr_By,  
      Level1_Approved_Datetime=getdate(),
	  ITHeadRemarks = @ITheadRmk  
      where Request_Id = @Request_Id   
  
   ---Log---  
--     update tbl_RequestMasterLog set   
--      User_Remark=@User_Remark,  
--      Approved_By=@Apr_By,  
--      Approved_Datetime =getdate(),  
--      CSO=@Access_Code,  
--      Status_Code='L1A',  
--      Level1_Approved_By=@Apr_By,  
--      Level1_Approved_Datetime=getdate()  
--      where Request_Id = @Request_Id   
   ---Log---  
   End  
 Else  
  
  begin  
   update tbl_RequestMaster set   
   User_Remark=@User_Remark,  
   Approved_By=@Apr_By,  
   Approved_Datetime =getdate(),  
   --CSO=@Access_Code,  
   Status_Code='A',
   ITHeadRemarks = @ITheadRmk  
   where Request_Id = @Request_Id   
  
  ---Log---  
--   update tbl_RequestMasterLog set   
--   User_Remark=@User_Remark,  
--   Approved_By=@Apr_By,  
--   Approved_Datetime =getdate(),  
--   CSO=@Access_Code,  
--   Status_Code='A'  
--   where Request_Id = @Request_Id   
    
  ---Log---  
  
  
 ---Exec USP_ITAssetsData @Request_Id,'','','','','','','','','1','0','','','','','','','','S','','',''  
  
 --Insert above aproved request into tbl_ITAssetsData To generate Bill  
--  
-- Declare @qty As Int   
-- Declare @Count As Int    
--  
-- Set @Count=0  
-- Set @qty = (Select Model_quantity From tbl_RequestMaster Where Request_Id = @Request_Id)  
--  
--  
-- While (@Count < @qty)  
-- Begin  
--  Exec USP_ITAssetsData @Request_Id,'','','','','','','','','1','0','','','','','','','','S','','',''  
--    
--  Set @Count = @Count + 1  
-- End  
  
 end  
 
declare @Request_Id1 nvarchar(max)                      
Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster where Request_Id=@Request_Id)             
   
--PRINT  @Request_Id1  
            
EXECUTE Usp_Mailer_Options '1',@Request_Id1     
 
 
End  
else if(@Status='Rejected')  
begin  
 update tbl_RequestMaster set   
 User_Remark=@User_Remark,  
 Approved_By=@Apr_By,  
 Approved_Datetime =getdate(),  
 --CSO=@Access_Code,  
 Status_Code='Rej',
 ITHeadRemarks = @ITheadRmk  
 where Request_Id = @Request_Id   
  
---Log---  
-- update tbl_RequestMasterLog set   
-- User_Remark=@User_Remark,  
-- Approved_By=@Apr_By,  
-- Approved_Datetime =getdate(),  
-- CSO=@Access_Code,  
-- Status_Code='Rej'  
-- where Request_Id = @Request_Id   
---Log---  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITAssetRequest_Approval29Nov2018
-- --------------------------------------------------
CREATE proc [dbo].[usp_ITAssetRequest_Approval29Nov2018]  
@Request_Id int ,  
@Apr_By varchar(15),  
@User_Remark varchar(5000),  
--@Access_Code char(50),  
@Status char(15)  
as  

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

  
Declare @Status_Code char(20)  
Set @Status_Code =(Select Status_Code From tbl_RequestMaster Where Request_Id=@Request_Id)  
Declare @Limit float  
Set @Limit = (Select Estimated_Total_Price From tbl_RequestMaster Where Request_Id=@Request_Id)  
Declare @Desig char(50)  
Set @Desig =(Select Designation from Emp_Info where Emp_no=@Apr_By)  
  
  
--if(@Access_Code='CSO')  
--Begin  
-- Set @Access_Code='True'  
--End  
--Else  
--Begin  
-- Set @Access_Code='False'  
--End  
  
if(@Status='Approved')  
 Begin  
  if(@Status_Code='R' and @Desig in ('Executive Director','Associate Director') and @Limit Between '1000000' and '2500000')  
  Begin  
   update tbl_RequestMaster set   
   User_Remark=@User_Remark,  
   Approved_By=@Apr_By,  
   Approved_Datetime =getdate(),  
   --CSO=@Access_Code,  
   Status_Code='L1A',  
   Level1_Approved_By=@Apr_By,  
   Level1_Approved_Datetime=getdate()  
   where Request_Id = @Request_Id   
  
  ---Log---  
--   update tbl_RequestMasterLog set   
--   User_Remark=@User_Remark,  
--   Approved_By=@Apr_By,  
--   Approved_Datetime =getdate(),  
--   CSO=@Access_Code,  
--   Status_Code='L1A',  
--   Level1_Approved_By=@Apr_By,  
--   Level1_Approved_Datetime=getdate()  
--   where Request_Id = @Request_Id   
  ---Log---  
  End  
 Else If(@Status_Code='L1A' and @Desig in ('Chief Strategy Officer','Executive Director-CFO') and @Limit Between '1000000' and '2500000')  
   Begin  
     update tbl_RequestMaster set   
     User_Remark=@User_Remark,  
     Approved_By=@Apr_By,  
     Approved_Datetime =getdate(),  
     --CSO=@Access_Code,  
     Status_Code='A'  
     where Request_Id = @Request_Id   
  
   ---Log---  
--     update tbl_RequestMasterLog set   
--     User_Remark=@User_Remark,  
--     Approved_By=@Apr_By,  
--     Approved_Datetime =getdate(),  
--     CSO=@Access_Code,  
--     Status_Code='A'  
--     where Request_Id = @Request_Id   
  
   ---Log---   
   End  
 Else If(@Status_Code='R' and @Desig in ('Executive Director','Chief Strategy Officer','Executive Director-CFO') and @Limit Between '2500000' and '5000000')  
   Begin  
     update tbl_RequestMaster set   
      User_Remark=@User_Remark,  
      Approved_By=@Apr_By,  
      Approved_Datetime =getdate(),  
      --CSO=@Access_Code,  
      Status_Code='L1A',  
      Level1_Approved_By=@Apr_By,  
      Level1_Approved_Datetime=getdate()  
      where Request_Id = @Request_Id   
  
   ---Log---  
--     update tbl_RequestMasterLog set   
--      User_Remark=@User_Remark,  
--      Approved_By=@Apr_By,  
--      Approved_Datetime =getdate(),  
--      CSO=@Access_Code,  
--      Status_Code='L1A',  
--      Level1_Approved_By=@Apr_By,  
--      Level1_Approved_Datetime=getdate()  
--      where Request_Id = @Request_Id   
   ---Log---  
   End  
 Else  
  
  begin  
   update tbl_RequestMaster set   
   User_Remark=@User_Remark,  
   Approved_By=@Apr_By,  
   Approved_Datetime =getdate(),  
   --CSO=@Access_Code,  
   Status_Code='A'  
   where Request_Id = @Request_Id   
  
  ---Log---  
--   update tbl_RequestMasterLog set   
--   User_Remark=@User_Remark,  
--   Approved_By=@Apr_By,  
--   Approved_Datetime =getdate(),  
--   CSO=@Access_Code,  
--   Status_Code='A'  
--   where Request_Id = @Request_Id   
    
  ---Log---  
  
  
 ---Exec USP_ITAssetsData @Request_Id,'','','','','','','','','1','0','','','','','','','','S','','',''  
  
 --Insert above aproved request into tbl_ITAssetsData To generate Bill  
--  
-- Declare @qty As Int   
-- Declare @Count As Int    
--  
-- Set @Count=0  
-- Set @qty = (Select Model_quantity From tbl_RequestMaster Where Request_Id = @Request_Id)  
--  
--  
-- While (@Count < @qty)  
-- Begin  
--  Exec USP_ITAssetsData @Request_Id,'','','','','','','','','1','0','','','','','','','','S','','',''  
--    
--  Set @Count = @Count + 1  
-- End  
  
 end  
 
declare @Request_Id1 nvarchar(max)                      
Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster where Request_Id=@Request_Id)             
   
--PRINT  @Request_Id1  
            
EXECUTE Usp_Mailer_Options '1',@Request_Id1     
 
 
End  
else if(@Status='Rejected')  
begin  
 update tbl_RequestMaster set   
 User_Remark=@User_Remark,  
 Approved_By=@Apr_By,  
 Approved_Datetime =getdate(),  
 --CSO=@Access_Code,  
 Status_Code='Rej'  
 where Request_Id = @Request_Id   
  
---Log---  
-- update tbl_RequestMasterLog set   
-- User_Remark=@User_Remark,  
-- Approved_By=@Apr_By,  
-- Approved_Datetime =getdate(),  
-- CSO=@Access_Code,  
-- Status_Code='Rej'  
-- where Request_Id = @Request_Id   
---Log---  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITASSETS_ERROR
-- --------------------------------------------------

CREATE PROC [dbo].[USP_ITASSETS_ERROR]

@RID As Char(20),
@Date As Datetime,
@Error AS Varchar(500),
@Line As Varchar(50)

AS 
Begin

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


	Insert Into ITASSETS_ERROR
	Values (@RID,@Date,@Error,@Line)

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ItPurchaseOrder
-- --------------------------------------------------
  
--CREATED BY:  
  
--MODIFIED BY:ZEBA RAJE  
  
  
CREATE PROC [dbo].[USP_ItPurchaseOrder] (@Fld_RequestId       NVARCHAR(max),  
                                         @Fld_VendorId        INT,  
                                         @Fld_VendorName      VARCHAR(200),  
                                         @Fld_PurchaseOrderNo VARCHAR(100),  
                                         @Fld_ShipTo          VARCHAR(500),  
                                         @Fld_ShippingMethod  VARCHAR(500),  
                                         @Fld_OrderTerms      VARCHAR(500),  
                                         @Fld_CompID          INT,  
                                         @Fld_Pid             INT,  
                                         @POBranch            VARCHAR(500),  
                                         @PODeliveryTime      VARCHAR(500),  
                                         @Userid              CHAR(20))  
AS  
  BEGIN  
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  
      --if (select count(*) from tbl_ItRequestPurchaseOrder(nolock) where Fld_PId = @Fld_Pid) = 0                                          
      --Begin                      
      ---------------------insert--------------------------------                                         
      --IF EXISTS (SELECT *    ---ZEBA  
      --           FROM   tbl_ItRequestPurchaseOrder  
      --           WHERE  Fld_RequestId = @Fld_RequestId)  
      --  BEGIN  
      --      UPDATE tbl_ItRequestPurchaseOrder  
      --      SET    Fld_VendorId = @Fld_VendorId,  
      --             Fld_VendorName = @Fld_VendorName,  
      --             Fld_PurchaseOrderNo = @Fld_PurchaseOrderNo,  
      --             Fld_ShipTo = @Fld_ShipTo,  
      --             Fld_ShippingMethod = @Fld_ShippingMethod,  
      --             Fld_OrderTerms = @Fld_OrderTerms,  
      --             Fld_DeliveryDate = Getdate(),  
      --             Fld_CompID = @Fld_CompID,  
      --             Fld_Pid = @Fld_Pid,  
      --             POBranch = POBranch,  
      --             PODeliveryTime = @PODeliveryTime,  
      --             --Generated_By    
      --             Generated_By = @Userid,  
      --             --Generated_Date    
      --             Generated_Date = Getdate(),  
      --             --Modified_By    
      --             Modified_By = @Userid,  
      --             --Modified_Date    
      --             Modified_Date = Getdate(),  
      --             --Set Po_Status as New i.e N    
      --             PO_Status = 'NPO'  
      --      WHERE  Fld_RequestId = @Fld_RequestId  
      --  END  
      --ELSE  
        BEGIN -----ZEBA  
          
            INSERT INTO tbl_ItRequestPurchaseOrder  
            VALUES      ( @Fld_RequestId,  
                          @Fld_VendorId,  
                          @Fld_VendorName,  
                          @Fld_PurchaseOrderNo,  
                          @Fld_ShipTo,  
                          @Fld_ShippingMethod,  
                          @Fld_OrderTerms,  
                          Getdate(),  
                          @Fld_CompID,  
                          @Fld_Pid,  
                          @POBranch,  
                          @PODeliveryTime,  
                          --Generated_By    
                          @Userid,  
                          --Generated_Date    
                          Getdate(),  
                          --Modified_By    
                          @Userid,  
                          --Modified_Date    
                          Getdate(),  
                          --Set Po_Status as New i.e N    
                          'NPO' )  
        END  
  
      ------------------------Insert Into Log ie tbl_ITRequestPurchaseorder_Log-------------    
      --NOTE That We Need To get "EXISTING" PID    
      -- from the tbl_Itrequestpurchaseorder to enter the SAME in tbl_ItRequestPurchaseOrder_Log    
      --Note That here PID is Taken Directly    
      --Declare @Modified_By char(20)     
      --Set @Modified_By = @Userid    
      --Modified_Date is Taken Directly    
      INSERT INTO tbl_ItRequestPurchaseOrder_Log  
                (Fld_RequestId,  
                   Fld_VendorId,  
                   Fld_VendorName,  
                   Fld_PurchaseOrderNo,  
                   Fld_ShipTo,  
                   Fld_ShippingMethod,  
                   Fld_OrderTerms,  
                   Fld_DeliveryDate,  
                   Fld_CompID,  
                   Fld_Pid,  
                   POBranch,  
                   PODeliveryTime,  
                   Modified_By,  
                   Modified_Date,  
                   PO_Status)  
      VALUES      ( @Fld_RequestId,  
                    @Fld_VendorId,  
                    @Fld_VendorName,  
                    @Fld_PurchaseOrderNo,  
                    @Fld_ShipTo,  
                    @Fld_ShippingMethod,  
                    @Fld_OrderTerms,  
                    Getdate(),  
                    @Fld_CompID,  
                    @Fld_Pid,  
                    @POBranch,  
                    @PODeliveryTime,  
                    --Modified_by    
                    @Userid,  
                    --Modified_Date    
                    Getdate(),  
                    --Set Po_Status as New i.e N    
                    'NPO' )  
  ----------------------------------------    
  --end                                          
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ITRecommandedPerson1
-- --------------------------------------------------


CREATE proc [dbo].[Usp_ITRecommandedPerson1]      
(      
@UserName char(40)      
)      
as   

      SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

      
select emp_no,emp_name from emp_info  where department='IT' AND status='A'
and branch_cd in(select branch_cd from emp_info where emp_no=@UserName) order by emp_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ITRecommandedPerson2
-- --------------------------------------------------


CREATE proc [dbo].[Usp_ITRecommandedPerson2]           

As
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

 
select distinct (emp_no),emp_name 
from emp_info  
where department='IT' AND status='A'
order by emp_name

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequest_Forwarded
-- --------------------------------------------------
---modified by:Zeba       
      --  [usp_ITRequest_Forwarded] ''
CREATE  Procedure [dbo].[usp_ITRequest_Forwarded]        
@Branch varchar(255)                                              
as        
Begin        
Declare @Query nvarchar(max)  

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

       
        
Set @Query= 'select A.Request_Id As[Request Id], A.Request_Date As [Request Date],B.Product_Name As[Product Name],C.Model_Name As[Model Name],A.Model_Quantity As [Model Quantity],        
  A.Model_Quantity_Assigned As [Model Quantity Assigned],D.Emp_Name As[Requested by],D.Department As [Department],D.Branch_cd As[Request Branch Code],E.BRANCH As[Request Branch Name],        
  F.Emp_Name As [Recommended By],A.Recommended_Datetime As [Recommended Date],        
  G.Emp_Name As [Approved By],A.Approved_Datetime As[Approved Date]        
  From tbl_requestMaster A left outer Join tbl_CapexProductMaster B on A.Item_code=B.Product_Code        
         Inner Join tbl_ProductModelMaster C on A.Model_no=C.Model_Id        
        Inner join         
        (Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info         
         UNION ALL         
        Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D        
         on A.Requested_By=D.Emp_No        
        left outer Join  risk.dbo.branches E on D.branch_cd=E.BRANCH_CODE --zeba      
         LEFT OUTER Join Emp_Info F on A.Recommended_By=F.Emp_No        
         Inner Join Emp_Info G on A.Approved_By =G.Emp_No        
  Where A.Status_code=''A'''        
   
print(@Query)       
        
if (@Branch <> '')        
Begin        
 Set @Query = @Query + ' And D.Branch_cd = '''+@Branch+''''        
End        
        
Set @Query = @Query + ' order by A.Request_Id Desc '         
        
Exec(@Query)        
        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequest_Forwarded_test
-- --------------------------------------------------
  
  
  
CREATE Procedure [dbo].[usp_ITRequest_Forwarded_test]  
@Branch varchar(255)                                        
as  
Begin  
Declare @Query nvarchar(max)   

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

  
Set @Query= 'select A.Request_Id As[Request Id], A.Request_Date As [Request Date],B.Product_Name As[Product Name],C.Model_Name As[Model Name],A.Model_Quantity As [Model Quantity],  
  A.Model_Quantity_Assigned As [Model Quantity Assigned],D.Emp_Name As[Requested by],D.Department As [Department],D.Branch_cd As[Request Branch Code],E.BRANCH As[Request Branch Name],  
  F.Emp_Name As [Recommended By],A.Recommended_Datetime As [Recommended Date],  
  G.Emp_Name As [Approved By],A.Approved_Datetime As[Approved Date]  
  From tbl_requestMaster A left outer Join tbl_CapexProductMaster B on A.Item_code=B.Product_Code  
         Inner Join tbl_ProductModelMaster C on A.Model_no=C.Model_Id  
        Inner join   
        (Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info   
         UNION ALL   
        Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D  
         on A.Requested_By=D.Emp_No  
         Inner Join BOBranch E on D.branch_cd=E.BRANCH_CODE  
         Inner Join Emp_Info F on A.Recommended_By=F.Emp_No  
         Inner Join Emp_Info G on A.Approved_By =G.Emp_No  
  Where A.Status_code=''A'''  
  
  
if (@Branch <> '')  
Begin  
 Set @Query = @Query + ' And D.Branch_cd = '''+@Branch+''''  
End  
  
Set @Query = @Query + ' order by A.Request_Id Desc '   
  
Exec(@Query)  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequest_Forwarded_test1
-- --------------------------------------------------
    
    
    
CREATE Procedure [dbo].[usp_ITRequest_Forwarded_test1]    
@Branch varchar(255)                                          
as    
Begin    
Declare @Query nvarchar(max)   

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  
    
Set @Query= 'select A.Request_Id As[Request Id], A.Request_Date As [Request Date],B.Product_Name As[Product Name],C.Model_Name As[Model Name],A.Model_Quantity As [Model Quantity],    
  A.Model_Quantity_Assigned As [Model Quantity Assigned],D.Emp_Name As[Requested by],D.Department As [Department],D.Branch_cd As[Request Branch Code],E.BRANCH As[Request Branch Name],    
  F.Emp_Name As [Recommended By],A.Recommended_Datetime As [Recommended Date],    
  G.Emp_Name As [Approved By],A.Approved_Datetime As[Approved Date]    
  From tbl_requestMaster A left outer Join tbl_CapexProductMaster B on A.Item_code=B.Product_Code    
         Inner Join tbl_ProductModelMaster C on A.Model_no=C.Model_Id    
        Inner join     
        (Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info     
         UNION ALL     
        Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D    
         on A.Requested_By=D.Emp_No    
         left outer Join BOBranch E on D.branch_cd=E.BRANCH_CODE    
         Inner Join Emp_Info F on A.Recommended_By=F.Emp_No    
         Inner Join Emp_Info G on A.Approved_By =G.Emp_No    
  Where A.Status_code=''A'''    
    
    
if (@Branch <> '')    
Begin    
 Set @Query = @Query + ' And D.Branch_cd = '''+@Branch+''''    
End    
    
Set @Query = @Query + ' order by A.Request_Id Desc '     
    
Exec(@Query)    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestAdminView
-- --------------------------------------------------
  
  
  
  
  
  
  
CREATE proc [dbo].[USP_ITRequestAdminView]  
  
@Request_Id char(10),  
@Item_Code char(10),   
@Model_No char(10),   
@FromDate varchar(20),  
@ToDate varchar(20)    
         
as          
  
Begin  
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
  
  
 Declare @Query as varchar(max)  
  
 set @Query='select A.Request_Id As [RequestId], B.Product_name As [Item Name], C.Model_Name As [Model Name],        
  A.Model_Quantity As [Model Quantity], A.Estimated_Total_Price As [Estimated Total Price],        
  D.Emp_Name As [Requested By],E.Branch_Cd As [Requester Branch Code],A.Request_Date As [Request Date],    
   A.User_Remark As [User Remark],j.EMP_NAME as [Reviewed By],i.ReviewDate as [Reviewed Date],        
  --(select emp_name from [10.0.1.106].prms.dbo.client_master with(nolock) where emp_id=A.[Recommended_By]) as [Recommended By],    
  (select emp_name from  risk.dbo.emp_info with(nolock) where emp_no=A.[Recommended_By]) as [Recommended By],    
  A.Recommended_DateTime As [Recommended Datetime],        
  G.Emp_Name As [Approved By], A.Approved_Datetime As [Approved Datetime ],        
  H.Status_Name As[status],k.Remark as [Review Remark],k.ReviewDate as [Review Date]         
  From tbl_RequestMaster A with(nolock)         
   Left outer join tbl_CapexProductMaster B with(nolock) on A.Item_Code=B.Product_Code        
   Left outer join tbl_ProductModelMaster C with(nolock) on A.Model_No=C.Model_Id        
   Left outer join emp_info D with(nolock) on A.Requested_By=D.Emp_no        
   Left Outer join emp_info E with(nolock) on A.Requested_By = E.Emp_no        
   Left outer join emp_info F with(nolock) on A.Recommended_By=F.Emp_no        
   Left outer join emp_info G with(nolock) on A.Approved_By=G.Emp_no        
   Left outer join tbl_StatusMaster H with(nolock) on A.status_Code=H.Status_Code    
    Left outer join (select ReviewedBy,ReviewDate,Request_Id from Tbl_ReviewRemarks) i on A.Request_Id=i.Request_Id      
    Left outer join emp_info j with(nolock) on i.ReviewedBy=J.Emp_no      
         inner join Tbl_ReviewRemarks k on A.Request_Id = k.Request_Id  

  where 1=1'  
  
  
 if(@Request_Id <> '')  
 Begin  
  set @Query=@Query + ' and A.Request_Id='''+@Request_Id+''''  
 End  
   
 if(@Item_Code <> '' and @Model_No <> '')  
 Begin  
  Set @Query=@Query +' and A.Item_Code='''+@Item_Code+''' and A.Model_No='''+@Model_No +''''  
 End  
  
  
 if(@FromDate <> '' and  @ToDate<>'')  
 Begin  
  set @Query=@Query +'and A.Request_Date Between  Convert(Datetime,'''+@FromDate+''') and Convert(Datetime,'''+@ToDate+''')'  
 end  
   
   
  
  
  
  
 exec (@Query)  
 Print @Query  
End  
  
  
  
  
--Select * from tbl_requestMaster  
--Select * from tbl_StatusMaster

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ITRequestCondition
-- --------------------------------------------------
CREATE proc [dbo].[Usp_ITRequestCondition]    
(    
@TC1 as varchar(500),    
@TC2 as varchar(500),    
@TC3 as varchar(500),    
@TC4 as varchar(500),    
@TC5 as varchar(500)    
)    
as  

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  
    
update tbl_ITRequestCondition set Fld_condition=@TC1 where Fld_srno='1'    
update tbl_ITRequestCondition set Fld_condition=@TC2 where Fld_srno='2'    
update tbl_ITRequestCondition set Fld_condition=@TC3 where Fld_srno='3'    
update tbl_ITRequestCondition set Fld_condition=@TC4 where Fld_srno='4'    
update tbl_ITRequestCondition set Fld_condition=@TC5 where Fld_srno='5'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestLogger
-- --------------------------------------------------
-- =============================================                
-- Author:  Suraj Patil                
-- Create date: 17-01-2017                
-- Description: IT Assets request logging for approval             
/*          
USP_ITRequestLogger '','100066','200116','1','E62250','test entry','1','2350'             
*/          
-- =============================================                
CREATE PROCEDURE [dbo].[USP_ITRequestLogger]                 
 @IT_Engineer char(10),                                                                                                                                                                                                                             
 @Item_Code char(10),                                                                                                                                                                                                 
 @Model_No char(10),                                                                                                                                                   
 @Model_Quantity char(10),                                                                                                                                                                                        
 @Requested_By varchar(8),                                                                                                       
 @User_Remark varchar(200),                                                                                                                                                        
 @Justification_Id char(10),                                         
 @Estimated_Total_Price int,
 @IT_Recommended_Name varchar(100)=null            
 AS                
BEGIN                
  insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,                                    
  Justification_id,CSO,Status_Code,Estimated_Total_Price,Model_Quantity_Assigned,IT_Recommended_Name)                                    
  values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,getdate(),@Requested_By,@User_Remark,                                    
  @Justification_Id,'false','InReview',@Estimated_Total_Price,'0',@IT_Recommended_Name)                
            
  Declare @Request_Id as int            
  Declare @Reviewer_ID as Varchar(25)            
  Declare @Reviewer_Name as Varchar(25)            
  declare @Branch_cd as Varchar(25)            
  Declare @Reviewer_Email as Varchar(1000)            
  Declare @Rerequester_Email as Varchar(1000)            
  Declare @Rerequester_Name as Varchar(25)            
  Declare @Model_Name as Varchar(25)            
  Declare @Item_Name as Varchar(25)            
            
  select @Rerequester_Name = Emp_name from risk.dbo.emp_info where emp_no = @Requested_By            
  set @Request_Id =0            
            
  select @Request_Id= max(Request_Id) from tbl_RequestMaster where Requested_By = @Requested_By              
  --select @Rerequester_Email = email,@Branch_cd = Branch_cd from risk.dbo.emp_info where emp_no = @Requested_By              
 select @Rerequester_Email = a.email, @Branch_cd = b.access_code           
 from risk.dbo.emp_info a           
 left join           
 (select access_code,username from  risk.dbo.user_login where username = @Requested_By     )b           
 on a.emp_no = b.username           
 where  a.emp_no = @Requested_By              
          
  if @Branch_cd ='CSO'            
  begin            
   select @Reviewer_ID = Reviewer,@Reviewer_Email = Reviewer_Email,@Reviewer_Name=Reviewer_Name from Tbl_ReviewerMaster where TypeOfReviewer = 'CSO' and isdelete = 0            
  end            
  else            
  begin            
   select @Reviewer_ID = Reviewer,@Reviewer_Email = Reviewer_Email,@Reviewer_Name=Reviewer_Name from Tbl_ReviewerMaster where TypeOfReviewer = 'other' and isdelete = 0            
  end            
  SELECT @Model_Name =  Model_Name FROM tbl_ProductModelMaster where model_id = @Model_No  and Product_Code =@Item_Code            
  --select Model_Name FROM tbl_ProductModelMaster where model_id = '200003'            
  select @Item_Name=PRODUCT_NAME from TBL_CAPEXPRODUCTMASTER where PRODUCT_CODE =@Item_Code            
              
 select @Request_Id as Request_Id,@Requested_By as Requested_By ,getdate() as Request_Date,@Item_Name as Item_Name,@Model_Name as Model_Name,            
  @Model_Quantity as Model_Quantity, case when @Justification_Id = 1 then 'New Hiring' else 'Replacement' end  as Justification_Remark,@User_Remark  as User_Remark,            
  @Reviewer_ID  as Reviewer_ID,@Reviewer_Email as Reviewer_Email,@Reviewer_Name as Reviewer_Name ,            
  @Rerequester_Email as Rerequester_Email, @Rerequester_Name as Rerequester_Name,@Estimated_Total_Price as Estimated_Total_Price           
          
          
          
          
          
          
  --------------------------------Email to reviewer Logic start -----------------------------------        
  declare @EMAIL_TO as varchar(1000)=@Reviewer_Email        
  declare @EMAIL_CC as varchar(1000)=''        
  declare @SUB as varchar(1000)=cast(@Request_Id as varchar(500)) +':- IT Assets New Request'        
  declare @HTML as varchar(max)=''        
   declare  @content as varchar(max)= ''        
    set @content = @content + '<HTML><HEAD><TITLE>' + cast(@Request_Id as varchar(500))  + ': New IT Assets request</TITLE><STYLE TYPE=''text/css''>';        
    set @content = @content + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana;
     background-color: #efefef; text-align: left; height: 18px;}';        
    set @content = @content + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;}';        
    set @content = @content + '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}';        
    set @content = @content + '</STYLE></HEAD><Body>';        
    set @content = @content + 'Dear ' + @Reviewer_Name  + ',';        
    set @content = @content + '<br>';        
        
    set @content = @content + '<p>This is to inform you that the following request has been raised by user (' +  @Rerequester_Name  + ').<br> The details are</p><br>';        
        
    set @content = @content + '<center><table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''600''><caption>IT Assets Request Details</caption>';        
    set @content = @content + '<tr width=''100''><td> Request ID :- </td><td> ' + cast(@Request_Id as varchar(500))  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Requested By:- </td><td> ' +  @Requested_By  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Request Date:- </td><td>' +  cast(GETDATE() as varchar(500))  + '</td></tr>';        
    set @content = @content + '<tr width=''100''><td> Item Name :-    </td><td colspan=''2''>' +  @Item_Name  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Model Name :-      </td><td > ' +  @Model_Name  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Quantity :-      </td><td > ' +  @Model_Quantity  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Estimated Price:-  </td><td> ' +  cast(@Estimated_Total_Price as varchar(500))  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td>Reason For Requirement:-  </td><td > ' +  case when @Justification_Id = 1 then 'New Hiring' else 'Replacement' end  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td>User Remark:-  </td><td colspan=''5''>' +  @User_Remark  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td>Current Status:-  </td><td colspan=''5''> Pending For Review </td></tr>';        
    set @content = @content + '</table></center><br><br>';        
        
    set @content = @content + '<p> Would request you to kindly review the same by clicking on Okey button in your respective ITPMS login</p><br>';        
        
        
    set @content = @content + '<P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>';        
    set @content = @content + 'Thanks & Regards,<br>IT Team </Body> </html>';        
          
          
          
          
          
  EXEC msdb.dbo.sp_send_dbmail                                       
  @profile_name = 'ITasset@angelbroking.com',                                       
  @recipients = @EMAIL_TO,                                       
  @copy_recipients = @EMAIL_CC,                                       
  --@blind_copy_recipients = 'suraj.patil@angelbroking.com', --; Sanjay.Ghosh@AngelBroking.Com',                                       
  @subject = @SUB,                                      
  @body = @content,                        
  @body_format = 'HTML'              
  --------------------------------Email to reviewer Logic End -----------------------------------        
  
  
   --------------------------------Email to requester Logic start -----------------------------------        
  declare @EMAIL_TO_requester as varchar(1000)= @Rerequester_Email
  declare @EMAIL_CC_requester as varchar(1000)=''        
  declare @SUB_requester as varchar(1000)=cast(@Request_Id as varchar(500)) +':- IT Assets New Request'        
  declare @HTML_requester as varchar(max)=''        
   declare  @content_requester as varchar(max)= ''        
    set @content_requester = @content_requester + '<HTML><HEAD><TITLE>' + cast(@Request_Id as varchar(500))  + ': New IT Assets request</TITLE><STYLE TYPE=''text/css''>';        
    set @content_requester = @content_requester + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid;
 font-family: Verdana;
     background-color: #efefef; text-align: left; height: 18px;}';        
    set @content_requester = @content_requester + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;}';        
    set @content_requester = @content_requester + '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}';        
    set @content_requester = @content_requester + '</STYLE></HEAD><Body>';        
    set @content_requester = @content_requester + 'Dear ' + @Rerequester_Name  + ',';        
    set @content_requester = @content_requester + '<br>';        
        
    set @content_requester = @content_requester + '<p>Your request has been submitted successfully and it is in review process. Once it is reviewed by IT team the request will be forwarded to your HODs recommendation and for IT approval.<br>
	TAT for providing material as per user requirement is 7-12 working days after the "Final Approval"</p><br>';        

        
    set @content_requester = @content_requester + '<center><table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''600''><caption>IT Assets Request Details</caption>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Request ID :- </td><td> ' + cast(@Request_Id as varchar(500))  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Requested By:- </td><td> ' +  @Requested_By  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Request Date:- </td><td>' +  cast(GETDATE() as varchar(500))  + '</td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Item Name :-    </td><td colspan=''2''>' +  @Item_Name  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Model Name :-      </td><td > ' +  @Model_Name  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Quantity :-      </td><td > ' +  @Model_Quantity  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Estimated Price:-  </td><td> ' +  cast(@Estimated_Total_Price as varchar(500))  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td>Reason For Requirement:-  </td><td > ' +  case when @Justification_Id = 1 then 'New Hiring' else 'Replacement' end  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td>User Remark:-  </td><td colspan=''5''>' +  @User_Remark  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td>Current Status:-  </td><td colspan=''5''> Pending For Review </td></tr>';        
    set @content_requester = @content_requester + '</table></center><br><br>';        
        
    set @content_requester = @content_requester + '<P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>';        
    set @content_requester = @content_requester + 'Thanks & Regards,<br>IT Team </Body> </html>';        
          
          
          
          
          
  EXEC msdb.dbo.sp_send_dbmail                                       
  @profile_name = 'ITasset@angelbroking.com',                                       
  @recipients = @EMAIL_TO_requester,                                       
  @copy_recipients = @EMAIL_CC_requester,                                       
  --@blind_copy_recipients = 'suraj.patil@angelbroking.com', --; Sanjay.Ghosh@AngelBroking.Com',                                       
  @subject = @SUB_requester,                                      
  @body = @content_requester,                        
  @body_format = 'HTML'              
  --------------------------------Email to requester Logic End -----------------------------------        
          
              
              
           
                 
                 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestLogger_14Feb2019
-- --------------------------------------------------
                
-- =============================================                
-- Author:  Suraj Patil                
-- Create date: 17-01-2017                
-- Description: IT Assets request logging for approval             
/*          
USP_ITRequestLogger '','100066','200116','1','E62250','test entry','1','2350'             
*/          
-- =============================================                
Create PROCEDURE [dbo].[USP_ITRequestLogger_14Feb2019]                 
 @IT_Engineer char(10),                                                                                                                                                                                                                             
 @Item_Code char(10),                                                                                                                                                                                                 
 @Model_No char(10),                                                                                                                                                   
 @Model_Quantity char(10),                                                                                                                                                                                        
 @Requested_By varchar(8),                                                                                                       
 @User_Remark varchar(200),                                                                                                                                                        
 @Justification_Id char(10),                                         
 @Estimated_Total_Price int,
 @IT_Recommended_Name varchar(100)=null            
 AS                
BEGIN                
  insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,                                    
  Justification_id,CSO,Status_Code,Estimated_Total_Price,Model_Quantity_Assigned,IT_Recommended_Name)                                    
  values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,getdate(),@Requested_By,@User_Remark,                                    
  @Justification_Id,'false','InReview',@Estimated_Total_Price,'0',@IT_Recommended_Name)                
            
  Declare @Request_Id as int            
  Declare @Reviewer_ID as Varchar(25)            
  Declare @Reviewer_Name as Varchar(25)            
  declare @Branch_cd as Varchar(25)            
  Declare @Reviewer_Email as Varchar(1000)            
  Declare @Rerequester_Email as Varchar(1000)            
  Declare @Rerequester_Name as Varchar(25)            
  Declare @Model_Name as Varchar(25)            
  Declare @Item_Name as Varchar(25)            
            
  select @Rerequester_Name = Emp_name from risk.dbo.emp_info where emp_no = @Requested_By            
  set @Request_Id =0            
            
  select @Request_Id= max(Request_Id) from tbl_RequestMaster where Requested_By = @Requested_By              
  --select @Rerequester_Email = email,@Branch_cd = Branch_cd from risk.dbo.emp_info where emp_no = @Requested_By              
 select @Rerequester_Email = a.email, @Branch_cd = b.access_code           
 from risk.dbo.emp_info a           
 left join           
 (select access_code,username from  risk.dbo.user_login where username = @Requested_By     )b           
 on a.emp_no = b.username           
 where  a.emp_no = @Requested_By              
          
  if @Branch_cd ='CSO'            
  begin            
   select @Reviewer_ID = Reviewer,@Reviewer_Email = Reviewer_Email,@Reviewer_Name=Reviewer_Name from Tbl_ReviewerMaster where TypeOfReviewer = 'CSO' and isdelete = 0            
  end            
  else            
  begin            
   select @Reviewer_ID = Reviewer,@Reviewer_Email = Reviewer_Email,@Reviewer_Name=Reviewer_Name from Tbl_ReviewerMaster where TypeOfReviewer = 'other' and isdelete = 0            
  end            
  SELECT @Model_Name =  Model_Name FROM tbl_ProductModelMaster where model_id = @Model_No  and Product_Code =@Item_Code            
  --select Model_Name FROM tbl_ProductModelMaster where model_id = '200003'            
  select @Item_Name=PRODUCT_NAME from TBL_CAPEXPRODUCTMASTER where PRODUCT_CODE =@Item_Code            
              
 select @Request_Id as Request_Id,@Requested_By as Requested_By ,getdate() as Request_Date,@Item_Name as Item_Name,@Model_Name as Model_Name,            
  @Model_Quantity as Model_Quantity, case when @Justification_Id = 1 then 'New Hiring' else 'Replacement' end  as Justification_Remark,@User_Remark  as User_Remark,            
  @Reviewer_ID  as Reviewer_ID,@Reviewer_Email as Reviewer_Email,@Reviewer_Name as Reviewer_Name ,            
  @Rerequester_Email as Rerequester_Email, @Rerequester_Name as Rerequester_Name,@Estimated_Total_Price as Estimated_Total_Price           
          
          
          
          
          
          
  --------------------------------Email to reviewer Logic start -----------------------------------        
  declare @EMAIL_TO as varchar(1000)=@Reviewer_Email        
  declare @EMAIL_CC as varchar(1000)=''        
  declare @SUB as varchar(1000)=cast(@Request_Id as varchar(500)) +':- IT Assets New Request'        
  declare @HTML as varchar(max)=''        
   declare  @content as varchar(max)= ''        
    set @content = @content + '<HTML><HEAD><TITLE>' + cast(@Request_Id as varchar(500))  + ': New IT Assets request</TITLE><STYLE TYPE=''text/css''>';        
    set @content = @content + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana;
     background-color: #efefef; text-align: left; height: 18px;}';        
    set @content = @content + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;}';        
    set @content = @content + '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}';        
    set @content = @content + '</STYLE></HEAD><Body>';        
    set @content = @content + 'Dear ' + @Reviewer_Name  + ',';        
    set @content = @content + '<br>';        
        
    set @content = @content + '<p>This is to inform you that the following request has been raised by user (' +  @Rerequester_Name  + ').<br> The details are</p><br>';        
        
    set @content = @content + '<center><table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''600''><caption>IT Assets Request Details</caption>';        
    set @content = @content + '<tr width=''100''><td> Request ID :- </td><td> ' + cast(@Request_Id as varchar(500))  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Requested By:- </td><td> ' +  @Requested_By  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Request Date:- </td><td>' +  cast(GETDATE() as varchar(500))  + '</td></tr>';        
    set @content = @content + '<tr width=''100''><td> Item Name :-    </td><td colspan=''2''>' +  @Item_Name  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Model Name :-      </td><td > ' +  @Model_Name  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Quantity :-      </td><td > ' +  @Model_Quantity  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Estimated Price:-  </td><td> ' +  cast(@Estimated_Total_Price as varchar(500))  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td>Reason For Requirement:-  </td><td > ' +  case when @Justification_Id = 1 then 'New Hiring' else 'Replacement' end  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td>User Remark:-  </td><td colspan=''5''>' +  @User_Remark  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td>Current Status:-  </td><td colspan=''5''> Pending For Review </td></tr>';        
    set @content = @content + '</table></center><br><br>';        
        
    set @content = @content + '<p> Would request you to kindly review the same by clicking on Okey button in your respective ITPMS login</p><br>';        
        
        
    set @content = @content + '<P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>';        
    set @content = @content + 'Thanks & Regards,<br>IT Team </Body> </html>';        
          
          
          
          
          
  EXEC msdb.dbo.sp_send_dbmail                                       
  @profile_name = 'ITasset@angelbroking.com',                                       
  @recipients = @EMAIL_TO,                                       
  @copy_recipients = @EMAIL_CC,                                       
  --@blind_copy_recipients = 'suraj.patil@angelbroking.com', --; Sanjay.Ghosh@AngelBroking.Com',                                       
  @subject = @SUB,                                      
  @body = @content,                        
  @body_format = 'HTML'              
  --------------------------------Email to reviewer Logic End -----------------------------------        
  
  
   --------------------------------Email to requester Logic start -----------------------------------        
  declare @EMAIL_TO_requester as varchar(1000)= @Rerequester_Email
  declare @EMAIL_CC_requester as varchar(1000)=''        
  declare @SUB_requester as varchar(1000)=cast(@Request_Id as varchar(500)) +':- IT Assets New Request'        
  declare @HTML_requester as varchar(max)=''        
   declare  @content_requester as varchar(max)= ''        
    set @content_requester = @content_requester + '<HTML><HEAD><TITLE>' + cast(@Request_Id as varchar(500))  + ': New IT Assets request</TITLE><STYLE TYPE=''text/css''>';        
    set @content_requester = @content_requester + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana;
     background-color: #efefef; text-align: left; height: 18px;}';        
    set @content_requester = @content_requester + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;}';        
    set @content_requester = @content_requester + '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}';        
    set @content_requester = @content_requester + '</STYLE></HEAD><Body>';        
    set @content_requester = @content_requester + 'Dear ' + @Rerequester_Name  + ',';        
    set @content_requester = @content_requester + '<br>';        
        
    set @content_requester = @content_requester + '<p>Your request has been submitted successfully and it is in review process. Once it is reviewed by IT team the request will be forwarded to your HODs recommendation and for IT approval.</p><br>';        
        
    set @content_requester = @content_requester + '<center><table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''600''><caption>IT Assets Request Details</caption>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Request ID :- </td><td> ' + cast(@Request_Id as varchar(500))  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Requested By:- </td><td> ' +  @Requested_By  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Request Date:- </td><td>' +  cast(GETDATE() as varchar(500))  + '</td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Item Name :-    </td><td colspan=''2''>' +  @Item_Name  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Model Name :-      </td><td > ' +  @Model_Name  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Quantity :-      </td><td > ' +  @Model_Quantity  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Estimated Price:-  </td><td> ' +  cast(@Estimated_Total_Price as varchar(500))  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td>Reason For Requirement:-  </td><td > ' +  case when @Justification_Id = 1 then 'New Hiring' else 'Replacement' end  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td>User Remark:-  </td><td colspan=''5''>' +  @User_Remark  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td>Current Status:-  </td><td colspan=''5''> Pending For Review </td></tr>';        
    set @content_requester = @content_requester + '</table></center><br><br>';        
        
    set @content_requester = @content_requester + '<P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>';        
    set @content_requester = @content_requester + 'Thanks & Regards,<br>IT Team </Body> </html>';        
          
          
          
          
          
  EXEC msdb.dbo.sp_send_dbmail                                       
  @profile_name = 'ITasset@angelbroking.com',                                       
  @recipients = @EMAIL_TO_requester,                                       
  @copy_recipients = @EMAIL_CC_requester,                                       
  --@blind_copy_recipients = 'suraj.patil@angelbroking.com', --; Sanjay.Ghosh@AngelBroking.Com',                                       
  @subject = @SUB_requester,                                      
  @body = @content_requester,                        
  @body_format = 'HTML'              
  --------------------------------Email to requester Logic End -----------------------------------        
          
              
              
              
                 
                 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestLogger_21112018
-- --------------------------------------------------
                
-- =============================================                
-- Author:  Suraj Patil                
-- Create date: 17-01-2017                
-- Description: IT Assets request logging for approval             
/*          
USP_ITRequestLogger '','100066','200116','1','E62250','test entry','1','2350'             
*/          
-- =============================================                
Create PROCEDURE [dbo].[USP_ITRequestLogger_21112018]                 
 @IT_Engineer char(10),                                                                                                                                                                                                                             
 @Item_Code char(10),                                                                                                                                                                                                 
 @Model_No char(10),                                                                                                                                                   
 @Model_Quantity char(10),                                                                                                                                                                                        
 @Requested_By varchar(8),                                                                                                       
 @User_Remark varchar(200),                                                                                                                                                        
 @Justification_Id char(10),                                         
 @Estimated_Total_Price int              
 AS                
BEGIN                
  insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,                                    
  Justification_id,CSO,Status_Code,Estimated_Total_Price,Model_Quantity_Assigned)                                    
  values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,getdate(),@Requested_By,@User_Remark,                                    
  @Justification_Id,'false','InReview',@Estimated_Total_Price,'0')                
            
  Declare @Request_Id as int            
  Declare @Reviewer_ID as Varchar(25)            
  Declare @Reviewer_Name as Varchar(25)            
  declare @Branch_cd as Varchar(25)            
  Declare @Reviewer_Email as Varchar(1000)            
  Declare @Rerequester_Email as Varchar(1000)            
  Declare @Rerequester_Name as Varchar(25)            
  Declare @Model_Name as Varchar(25)            
  Declare @Item_Name as Varchar(25)            
            
  select @Rerequester_Name = Emp_name from risk.dbo.emp_info where emp_no = @Requested_By            
  set @Request_Id =0            
            
  select @Request_Id= max(Request_Id) from tbl_RequestMaster where Requested_By = @Requested_By              
  --select @Rerequester_Email = email,@Branch_cd = Branch_cd from risk.dbo.emp_info where emp_no = @Requested_By              
 select @Rerequester_Email = a.email, @Branch_cd = b.access_code           
 from risk.dbo.emp_info a           
 left join           
 (select access_code,username from  risk.dbo.user_login where username = @Requested_By     )b           
 on a.emp_no = b.username           
 where  a.emp_no = @Requested_By              
          
  if @Branch_cd ='CSO'            
  begin            
   select @Reviewer_ID = Reviewer,@Reviewer_Email = Reviewer_Email,@Reviewer_Name=Reviewer_Name from Tbl_ReviewerMaster where TypeOfReviewer = 'CSO' and isdelete = 0            
  end            
  else            
  begin            
   select @Reviewer_ID = Reviewer,@Reviewer_Email = Reviewer_Email,@Reviewer_Name=Reviewer_Name from Tbl_ReviewerMaster where TypeOfReviewer = 'other' and isdelete = 0            
  end            
  SELECT @Model_Name =  Model_Name FROM tbl_ProductModelMaster where model_id = @Model_No  and Product_Code =@Item_Code            
  --select Model_Name FROM tbl_ProductModelMaster where model_id = '200003'            
  select @Item_Name=PRODUCT_NAME from TBL_CAPEXPRODUCTMASTER where PRODUCT_CODE =@Item_Code            
              
 select @Request_Id as Request_Id,@Requested_By as Requested_By ,getdate() as Request_Date,@Item_Name as Item_Name,@Model_Name as Model_Name,            
  @Model_Quantity as Model_Quantity, case when @Justification_Id = 1 then 'New Hiring' else 'Replacement' end  as Justification_Remark,@User_Remark  as User_Remark,            
  @Reviewer_ID  as Reviewer_ID,@Reviewer_Email as Reviewer_Email,@Reviewer_Name as Reviewer_Name ,            
  @Rerequester_Email as Rerequester_Email, @Rerequester_Name as Rerequester_Name,@Estimated_Total_Price as Estimated_Total_Price           
          
          
          
          
          
          
  --------------------------------Email to reviewer Logic start -----------------------------------        
  declare @EMAIL_TO as varchar(1000)=@Reviewer_Email        
  declare @EMAIL_CC as varchar(1000)=''        
  declare @SUB as varchar(1000)=cast(@Request_Id as varchar(500)) +':- IT Assets New Request'        
  declare @HTML as varchar(max)=''        
   declare  @content as varchar(max)= ''        
    set @content = @content + '<HTML><HEAD><TITLE>' + cast(@Request_Id as varchar(500))  + ': New IT Assets request</TITLE><STYLE TYPE=''text/css''>';        
    set @content = @content + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana;
     background-color: #efefef; text-align: left; height: 18px;}';        
    set @content = @content + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;}';        
    set @content = @content + '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}';        
    set @content = @content + '</STYLE></HEAD><Body>';        
    set @content = @content + 'Dear ' + @Reviewer_Name  + ',';        
    set @content = @content + '<br>';        
        
    set @content = @content + '<p>This is to inform you that the following request has been raised by user (' +  @Rerequester_Name  + ').<br> The details are</p><br>';        
        
    set @content = @content + '<center><table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''600''><caption>IT Assets Request Details</caption>';        
    set @content = @content + '<tr width=''100''><td> Request ID :- </td><td> ' + cast(@Request_Id as varchar(500))  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Requested By:- </td><td> ' +  @Requested_By  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Request Date:- </td><td>' +  cast(GETDATE() as varchar(500))  + '</td></tr>';        
    set @content = @content + '<tr width=''100''><td> Item Name :-    </td><td colspan=''2''>' +  @Item_Name  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Model Name :-      </td><td > ' +  @Model_Name  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Quantity :-      </td><td > ' +  @Model_Quantity  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td> Estimated Price:-  </td><td> ' +  cast(@Estimated_Total_Price as varchar(500))  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td>Reason For Requirement:-  </td><td > ' +  case when @Justification_Id = 1 then 'New Hiring' else 'Replacement' end  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td>User Remark:-  </td><td colspan=''5''>' +  @User_Remark  + ' </td></tr>';        
    set @content = @content + '<tr width=''100''><td>Current Status:-  </td><td colspan=''5''> Pending For Review </td></tr>';        
    set @content = @content + '</table></center><br><br>';        
        
    set @content = @content + '<p> Would request you to kindly review the same by clicking on Okey button in your respective ITPMS login</p><br>';        
        
        
    set @content = @content + '<P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>';        
    set @content = @content + 'Thanks & Regards,<br>IT Team </Body> </html>';        
          
          
          
          
          
  EXEC msdb.dbo.sp_send_dbmail                                       
  @profile_name = 'ITasset@angelbroking.com',                                       
  @recipients = @EMAIL_TO,                                       
  @copy_recipients = @EMAIL_CC,                                       
  --@blind_copy_recipients = 'suraj.patil@angelbroking.com', --; Sanjay.Ghosh@AngelBroking.Com',                                       
  @subject = @SUB,                                      
  @body = @content,                        
  @body_format = 'HTML'              
  --------------------------------Email to reviewer Logic End -----------------------------------        
  
  
   --------------------------------Email to requester Logic start -----------------------------------        
  declare @EMAIL_TO_requester as varchar(1000)= @Rerequester_Email
  declare @EMAIL_CC_requester as varchar(1000)=''        
  declare @SUB_requester as varchar(1000)=cast(@Request_Id as varchar(500)) +':- IT Assets New Request'        
  declare @HTML_requester as varchar(max)=''        
   declare  @content_requester as varchar(max)= ''        
    set @content_requester = @content_requester + '<HTML><HEAD><TITLE>' + cast(@Request_Id as varchar(500))  + ': New IT Assets request</TITLE><STYLE TYPE=''text/css''>';        
    set @content_requester = @content_requester + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana;
     background-color: #efefef; text-align: left; height: 18px;}';        
    set @content_requester = @content_requester + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;}';        
    set @content_requester = @content_requester + '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}';        
    set @content_requester = @content_requester + '</STYLE></HEAD><Body>';        
    set @content_requester = @content_requester + 'Dear ' + @Rerequester_Name  + ',';        
    set @content_requester = @content_requester + '<br>';        
        
    set @content_requester = @content_requester + '<p>Your request has been submitted successfully and it is in review process. Once it is reviewed by IT team the request will be forwarded to your HODs recommendation and for IT approval.</p><br>';        
        
    set @content_requester = @content_requester + '<center><table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''600''><caption>IT Assets Request Details</caption>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Request ID :- </td><td> ' + cast(@Request_Id as varchar(500))  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Requested By:- </td><td> ' +  @Requested_By  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Request Date:- </td><td>' +  cast(GETDATE() as varchar(500))  + '</td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Item Name :-    </td><td colspan=''2''>' +  @Item_Name  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Model Name :-      </td><td > ' +  @Model_Name  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Quantity :-      </td><td > ' +  @Model_Quantity  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td> Estimated Price:-  </td><td> ' +  cast(@Estimated_Total_Price as varchar(500))  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td>Reason For Requirement:-  </td><td > ' +  case when @Justification_Id = 1 then 'New Hiring' else 'Replacement' end  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td>User Remark:-  </td><td colspan=''5''>' +  @User_Remark  + ' </td></tr>';        
    set @content_requester = @content_requester + '<tr width=''100''><td>Current Status:-  </td><td colspan=''5''> Pending For Review </td></tr>';        
    set @content_requester = @content_requester + '</table></center><br><br>';        
        
    set @content_requester = @content_requester + '<P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>';        
    set @content_requester = @content_requester + 'Thanks & Regards,<br>IT Team </Body> </html>';        
          
          
          
          
          
  EXEC msdb.dbo.sp_send_dbmail                                       
  @profile_name = 'ITasset@angelbroking.com',                                       
  @recipients = @EMAIL_TO_requester,                                       
  @copy_recipients = @EMAIL_CC_requester,                                       
  --@blind_copy_recipients = 'suraj.patil@angelbroking.com', --; Sanjay.Ghosh@AngelBroking.Com',                                       
  @subject = @SUB_requester,                                      
  @body = @content_requester,                        
  @body_format = 'HTML'              
  --------------------------------Email to requester Logic End -----------------------------------        
          
              
              
              
                 
                 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster
-- --------------------------------------------------
      
---[USP_ITRequestMaster]   null,'100022','200075','1','E57616','System get Hang & Jammed every time.','1',2250         
      
CREATE Proc [dbo].[USP_ITRequestMaster]                                                                                                   
(                     
 @IT_Engineer char(10),                                                                                                                                                                                                           
 @Item_Code char(10),                                                                                                                                                                               
 @Model_No char(10),                                                                                                                                 
 @Model_Quantity char(10),                                                                                                                                                                      
 @Requested_By varchar(8),                                                                                     
 @User_Remark varchar(200),                                                                                                                                      
 @Justification_Id char(10),                       
 @Estimated_Total_Price int                                                                                                                               
)                                                                                                        
as                                                                    
Begin 


    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
                 
                    
--  Declare @CSO  bit                  
  Declare @Status_Code char(10)                  
  Declare @Request_Date DateTime                  
  Declare @Model_Quantity_Assigned As char(10)                  
                  
                  
set @Request_Date= getdate()                      
set @Status_Code='P'                  
set @Model_Quantity_Assigned='0'                  
                  
                  
                   
                   
-----------first Make an entry in tbl_RequestMaster----------                  
                  
  insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,                  
         Justification_id,CSO,Status_Code,Estimated_Total_Price,Model_Quantity_Assigned)                  
                              
 values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,                  
    @Justification_Id,'false',@Status_Code,@Estimated_Total_Price,@Model_Quantity_Assigned)            
                                                            
------------------------------------------------                  
                  
--get current request_id                  
 Declare @Request_Id int         
 --getbranchcode of Requester                  
  Declare @RequesterBrCd nvarchar(255)                  
--onbasis of branchcode of Requester decide whether he belongs to Branch OR CSO Category                  
  Declare @Category char(20)                  
--get Designation of the Requester                  
  Declare @Designation varchar(255)                  
--get department of the requester                  
  Declare @Department nvarchar(200)                  
--get Sub_Department of the requester                  
  Declare @Sub_Department varchar(150)                  
                  
Set @Request_Id = (select max(Request_Id) As Request_Id from tbl_RequestMaster  where Requested_By = @Requested_By)                  
    
set @RequesterBrCd = (select Branch_Cd from Emp_Info where Emp_No = @Requested_By)                  
                  
 if(@RequesterBrCd not in(select branch_cd from tbl_CSO_Branch(nolock)) )                  
  Begin                  
   Set @Category = 'BRANCH'                  
  End       
                  
 else if (@RequesterBrCd in (select branch_cd from tbl_CSO_Branch(nolock)) )                  
  Begin                  
   Set @Category = 'CSO'                  
  End                  
                  
Set @Designation = (Select Designation from emp_info where Emp_No = @Requested_By)                  
                  
Set @Department = (Select Department from emp_info where Emp_No = @Requested_By)                  
                  
Set @Sub_Department = (Select Sub_Department from emp_info where Emp_No = @Requested_By)                  
                  
----                  
Declare @SrAVPIT varchar(20)                  
Declare @HeadIT varchar(20)                  
Declare @ADIT varchar(20)                 
Declare @ED varchar(20)                  
Declare @EDCFO varchar(20)                  
Declare @CSO varchar(20)                  
                  
Set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree Where Emp_Id = @Requested_By)                  
Set @HeadIT = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                  
Set @ADIT = (Select ADIT from tbl_EmpTree Where Emp_Id = @Requested_By)                  
Set @ED = (Select ED from tbl_EmpTree Where Emp_Id = @Requested_By)                  
Set @EDCFO = (Select EDCFO from tbl_EmpTree Where Emp_Id = @Requested_By)                  
Set @CSO = (Select CSO from tbl_EmpTree Where Emp_Id = @Requested_By)                  
----                  
                  
                  
----------------get Recommenders------------------------                  
                  select U_Role,Category,Department into #Recommenders                  
                  from tbl_Recommendation_LimitMaster                  
                  where @Estimated_Total_Price between Rec_limitFrom and Rec_LimitTo                  
                 And Category=@Category                  
                  
                  -- Select * from #Recommenders                            
       
      
    --Cursor                   
       Declare @CR_U_Role varchar(50)                  
    Declare @CR_Category varchar(50)                  
    Declare @CR_Department varchar(50)                  
    --Declare @Request_Id_Rec int                  
    --Declare @Recommender varchar(25)                  
    Declare Rec Cursor for                  
    Select * from #Recommenders                  
                  
                  
    OPEN Rec                  
    FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                  
    While(@@fetch_status=0)                  
      Begin                  
                  
       --Set @Request_Id_Rec = ''                  
       --Set @Recommender = ''                  
                        
       print 'Recommended'             
       print @CR_U_Role                  
       print @CR_Category                  
       print @CR_Department                  
                  
       if(@CR_Category = 'BRANCH')                  
        Begin                    
                        
         if(@CR_U_Role = 'Branch Head')                  
          Begin                         
           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By                        
                    
          End                  
--         else if(@CR_U_Role = 'Branch Manager')                  
--          Begin                  
--           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By                          
--          End                   
         else if(@CR_U_Role = 'Cluster Head')                  
          Begin                  
           Exec USP_GetRecApr 'R',@Category,'ClusterHead',@Request_Id,@Requested_By                  
          End                  
         else if(@CR_U_Role = 'Zonal Head')                  
          Begin                  
           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                          
        End                  
--         else if(@CR_U_Role = 'Zonal Manager')                  
--          Begin                  
--           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                                 
--          End                          
    else if(@CR_U_Role = 'Regional Head')                  
          Begin                  
           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By                  
          End                  
--         else if(@CR_U_Role = 'Regional Manager')                  
--          Begin                  
--           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By                         
--          End          
         else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')                  
          Begin                  
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                  
           -- Begin                  
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')                  
            Begin                  
             Insert into tbl_RequestRecApr                  
             Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                  
            End                  
           -- End                           
                            
          End                  
         else if(@CR_U_Role = 'Executive Director')                  
          Begin                  
           --if(@Requested_By ='P00104')                  
           -- Begin                  
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')                  
            Begin                  
             Insert into tbl_RequestRecApr                  
             Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
            End                  
           -- End                  
           End                  
         else if(@CR_U_Role = 'Executive Director-CFO')                  
          Begin                  
           --if(@Requested_By ='P00104')                  
           -- Begin                  
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')                  
            Begin                  
             Insert into tbl_RequestRecApr                  
             Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                   
            End                   
           -- End                        
          End                  
         else if(@CR_U_Role = 'Chief Strategy Officer')                  
          Begin                  
           --if(@Requested_By ='P00104')                  
           -- Begin                  
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')                  
            Begin                  
             Insert into tbl_RequestRecApr                  
             Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                  
            End                  
           -- End                  
         End                  
        End                  
                  
       else if (@CR_Category = 'CSO')                  
        Begin                  
                  
         if(@CR_U_Role = 'A.V.P.')                  
          Begin                  
           --if HOD should also see the request then add  HOD here. 
           print 'USP_GetRecApr'
           Exec USP_GetRecApr 'R',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By                  
                  
          End                  
--         else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'ALL')                  
--          Begin                   
--           ---DoNothing                     
--          End                  
         else if(@CR_U_Role = 'Vice President')                  
          Begin                  
           --if HOD should also see the request then add  HOD here.                   
           Exec USP_GetRecApr 'R',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By                  
          End                  
--         else if(@CR_U_Role = 'Sr. Vice President')                  
--          Begin                  
--           --DoNothing                           
--          End                  
        else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'IT')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
        else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
        else if(@CR_U_Role = 'Associate Director')                  
     Begin                  
                             
           --select * from emp_info where emp_no ='P00104'                  
           --OR                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'R' and @ADIT IS NOT NULL and @ADIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ADIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
          End                  
          End                  
        else if(@CR_U_Role = 'Executive Director')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
        else if(@CR_U_Role = 'Executive Director-CFO')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')                  
           Begin        
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
        else if(@CR_U_Role = 'Chief Strategy Officer')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
                  
                  
        End                         
                  
         FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                  
                  
                  
      End                  
                    
   Close Rec                  
   deallocate Rec                   

                             
                                              
                  
----------------------------------------------------------------------------------------------------------------                  
                  
---------------get Approver--------------------------------                  
                  
   Select U_Role,Category,Department into #Approver                  
   From tbl_Approval_LimitMaster                  
   Where @Estimated_Total_Price Between Apr_LimitFrom and Apr_LimitTo                  
   And Category = @Category                  
                  
                  -- Select * from #Approver                                   
    --Cursor                   
       Declare @CA_U_Role varchar(50)                  
    Declare @CA_Category varchar(50)                  
    Declare @CA_Department varchar(50)                  
    --Declare @Request_Id_Apr int                  
    --Declare @Approver varchar(25)                  
                  
    Declare Apr Cursor for                  
    Select * from #Approver                  
                  
                  
    OPEN Apr                  
    FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                  
    While(@@fetch_status=0)                  
      Begin                  
       --Set @Request_Id_Rec = ''                  
--       print @CA_U_Role                  
--       print @CA_Category                  
--       print @CA_Department                  
                  
       if(@CA_Category = 'BRANCH')                  
        Begin                  
                  
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                  
           Begin                  
   Insert into tbl_RequestRecApr                  
            Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                   
           End                  
          End                  
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                  
          Begin                  
           --select * from emp_info where emp_no ='P00104'                  
           --OR                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                   
           End                  
                             
          End                  
         else if(@CA_U_Role ='Executive Director')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By                   
           End                  
                  
          End                  
       else if(@CA_U_Role ='Executive Director-CFO')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
     Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                   
           End                  
          End                  
         else if(@CA_U_Role ='Chief Strategy Officer')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                  
           End                   
          End                  
         else if(@CA_U_Role ='CMD')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                  
           Insert into tbl_RequestRecApr                  
           Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'                  
          End                  
                    
                  
        End                  
                  
      else if(@CA_Category = 'CSO')                  
        Begin                  
                  
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
         else if(@CA_U_Role ='Executive Director')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
         else if(@CA_U_Role ='Executive Director-CFO')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr               
            Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
         else if(@CA_U_Role ='Chief Strategy Officer')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
         else if(@CA_U_Role ='CMD')                  
          Begin                  
 if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                  
           End                  
          End                  
                  
              
      End                  
                   
         FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                  
                  
      End                  
   Close Apr                  
   deallocate Apr                   
                              
                  
----------------get OTHERS Recommenders ------------------------                  
                  select U_Role,Category,Department into #OtherRecommenders                  
                  from tbl_Recommendation_LimitMaster                  
                  where @Estimated_Total_Price between B_ReclimitFrom and B_RecLimitTo                  
                 And Category=@Category                  
                  
 -- Select * from #OtherRecommenders                            
                                           
                  
                             
    --Cursor                   
       Declare @COR_U_Role varchar(50)                  
    Declare @COR_Category varchar(50)                  
    Declare @COR_Department varchar(50)                  
    --Declare @Request_Id_Rec int                  
    --Declare @Recommender varchar(25)              
    Declare ORec Cursor for                  
    Select * from #OtherRecommenders                  
                  
                  
    OPEN ORec                  
    FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                  
    While(@@fetch_status=0)                  
      Begin                  
                  
       --Set @Request_Id_Rec = ''                  
       --Set @Recommender = ''                  
  
--                  
       print @COR_U_Role                  
       print @COR_Category                  
       print @COR_Department                  
                  
       if(@COR_Category = 'BRANCH')                  
        Begin                    
                        
         if(@COR_U_Role = 'Branch Head')                  
          Begin                         
           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                        
                    
          End                  
--         else if(@COR_U_Role = 'Branch Manager')                  
--          Begin                  
--           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                                             
--          End                   
         else if(@COR_U_Role = 'Cluster Head')                  
          Begin                  
           Exec USP_GetRecApr 'OR',@Category,'ClusterHead',@Request_Id,@Requested_By                  
          End                  
         else if(@COR_U_Role = 'Zonal Head')                  
          Begin                  
           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                          
          End                  
--         else if(@COR_U_Role = 'Zonal Manager')                  
--          Begin                  
--           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                                 
--          End                  
         else if(@COR_U_Role = 'Regional Head')                  
          Begin                  
           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                  
          End                  
--         else if(@CR_U_Role = 'Regional Manager')                  
--          Begin                  
--           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                      
--          End                  
         else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                  
          Begin                  
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                  
           -- Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                  
           End                  
           -- End                           
                            
          End                  
         else if(@COR_U_Role = 'Executive Director')          
          Begin                  
           --if(@Requested_By ='P00104')                  
           -- Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                  
           End                  
           -- End                  
           End                  
         else if(@COR_U_Role = 'Executive Director-CFO')                  
          Begin                  
           --if(@Requested_By ='P00104')                  
           -- Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr            
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                  
           End                  
           -- End             
          End                  
         else if(@COR_U_Role = 'Chief Strategy Officer')                  
          Begin                  
           --if(@Requested_By ='P00104')                  
           -- Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                  
           End                  
           -- End                  
         End                  
        End                  
                  
       else if (@COR_Category = 'CSO')                  
        Begin                  
                  
         if(@COR_U_Role = 'A.V.P.')            
          Begin                  
           Exec USP_GetRecApr 'OR',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By                  
          End                  
--         else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'ALL')                  
--          Begin                   
--   DoNothing                          
--          End                  
         else if(@COR_U_Role = 'Vice President' OR @COR_U_Role = 'Sr. Vice President')                  
          Begin                  
           Exec USP_GetRecApr 'OR',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By                  
          End                  
--         else if(@COR_U_Role = 'Sr. Vice President')                  
--          Begin                  
--           DoNothing                           
--          End                  
        else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'IT')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'OR' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
        else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
     End                  
          End                  
        else if(@COR_U_Role = 'Associate Director')                  
          Begin                  
                             
           --select * from emp_info where emp_no ='P00104'                  
           --OR                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OR' and @ADIT IS NOT NULL and @ADIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ADIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                  
           End                  
          End                  
        else if(@COR_U_Role = 'Executive Director')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
    End                  
          End                  
        else if(@COR_U_Role = 'Executive Director-CFO')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
        else if(@COR_U_Role = 'Chief Strategy Officer')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
                  
                  
        End                         
                  
         FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                  
                  
                  
      End                  
                    
   Close ORec                  
   deallocate ORec                   
                              
                  
----------------------------------------------------------------------------------------------------------------                  
                  
---------------get OTHER Approver--------------------------------                  
                  
   Select U_Role,Category,Department into #OtherApprover                  
   From tbl_Approval_LimitMaster                  
   Where @Estimated_Total_Price Between B_AprLimitFrom and B_AprLimitTo                  
   And Category = @Category                  
                  
                  -- Select * from #OtherApprover                                   
    --Cursor                   
       Declare @COA_U_Role varchar(50)                  
    Declare @COA_Category varchar(50)                  
    Declare @COA_Department varchar(50)                  
    --Declare @Request_Id_Apr int                  
    --Declare @Approver varchar(25)                  
                  
    Declare OApr Cursor for                  
    Select * from #OtherApprover                  
                  
                  
    OPEN OApr                  
    FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                  
    While(@@fetch_status=0)                  
      Begin                  
       --Set @Request_Id_Rec = ''                  
       print @COA_U_Role                  
       print @COA_Category                  
       print @COA_Department                  
                  
  if(@COA_Category = 'BRANCH')                  
        Begin                  
                  
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                  
           End                  
          End                  
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                  
          Begin                  
           --select * from emp_info where emp_no ='P00104'                  
           --OR                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                  
           End                  
                             
          End                  
         else if(@COA_U_Role ='Executive Director')                  
          Begin                  
          if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                  
           End                  
          End                  
         else if(@COA_U_Role ='Executive Director-CFO')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                  
           End                  
          End                  
         else if(@COA_U_Role ='Chief Strategy Officer')                  
Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                  
End                  
          End                  
         else if(@COA_U_Role ='CMD')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'                  
           End                  
          End                  
                    
                  
        End                  
                  
      else if(@COA_Category = 'CSO')                  
        Begin                  
                  
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
     Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
         else if(@COA_U_Role ='Executive Director')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
         else if(@COA_U_Role ='Executive Director-CFO')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                  
           Begin                   
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
         else if(@COA_U_Role ='Chief Strategy Officer')                  
          Begin                  
     if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
           End                  
          End                  
         else if(@COA_U_Role ='CMD')                  
          Begin                  
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                  
           Begin                  
            Insert into tbl_RequestRecApr                  
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                  
           End                 
          End                  
                  
                  
        End                  
                   
         FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                  
                  
      End                  
   Close OApr                  
   deallocate OApr                   
                              
----------------------------------------------------------------------------------------------------------                  
                

  --added by sandeep on 09 Apr 2015 for depository--
       declare @cnt int ,@SubDepartment varchar(50)       
       set @SubDepartment=(select sub_department from emp_info with(nolock) where emp_no=@Requested_By)
       if(@SubDepartment='Depository')
       Begin
        Insert into tbl_RequestRecApr
        select @Request_Id,'P00235','R'
        
        Insert into tbl_RequestRecApr
        select @Request_Id,'E63575','A'
       End
       
       
       --Ended by sandeep        
                  
Select @Request_Id As [Request_Id]                  
     
declare @Request_Id1 nvarchar(max)                  
Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster where Requested_By = @Requested_By)         
        
EXECUTE Usp_Mailer_Options '1',@Request_Id1                      
                                                                
                                                               
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_17012017
-- --------------------------------------------------
        
---[USP_ITRequestMaster]   null,'100022','200075','1','E57616','System get Hang & Jammed every time.','1',2250           
        
CREATE Proc [dbo].[USP_ITRequestMaster_17012017]
(                       
 @IT_Engineer char(10),                                                                                                                                                                                                             
 @Item_Code char(10),                                                                                                                                                                                 
 @Model_No char(10),                                                                                                                                   
 @Model_Quantity char(10),                                                                                                                                                                        
 @Requested_By varchar(8),                                                                                       
 @User_Remark varchar(200),                                                                                                                                        
 @Justification_Id char(10),                         
 @Estimated_Total_Price int                                                                                                                                 
)                                                                                                          
as                                                                      
Begin   
  
  
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
                   
                      
--  Declare @CSO  bit                    
  Declare @Status_Code char(10)                    
  Declare @Request_Date DateTime                    
  Declare @Model_Quantity_Assigned As char(10)                    
                    
                    
set @Request_Date= getdate()                        
set @Status_Code='P'                    
set @Model_Quantity_Assigned='0'                    
                    
                    
                     
                     
-----------first Make an entry in tbl_RequestMaster----------                    
                    
  insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,                    
         Justification_id,CSO,Status_Code,Estimated_Total_Price,Model_Quantity_Assigned)                    
                                
 values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,                    
    @Justification_Id,'false',@Status_Code,@Estimated_Total_Price,@Model_Quantity_Assigned)              
                                                              
------------------------------------------------                    
                    
--get current request_id                    
 Declare @Request_Id int           
 --getbranchcode of Requester                    
  Declare @RequesterBrCd nvarchar(255)                    
--onbasis of branchcode of Requester decide whether he belongs to Branch OR CSO Category                    
  Declare @Category char(20)                    
--get Designation of the Requester                    
  Declare @Designation varchar(255)                    
--get department of the requester                    
  Declare @Department nvarchar(200)                    
--get Sub_Department of the requester                    
  Declare @Sub_Department varchar(150)                    
                    
Set @Request_Id = (select max(Request_Id) As Request_Id from tbl_RequestMaster  where Requested_By = @Requested_By)                    
      
set @RequesterBrCd = (select Branch_Cd from Emp_Info where Emp_No = @Requested_By)           
                    
 if(@RequesterBrCd not in(select branch_cd from tbl_CSO_Branch(nolock)) )                    
  Begin                    
   Set @Category = 'BRANCH'                    
  End         
                    
 else if (@RequesterBrCd in (select branch_cd from tbl_CSO_Branch(nolock)) )                    
  Begin                    
   Set @Category = 'CSO'                    
  End                    
                    
Set @Designation = (Select Designation from emp_info where Emp_No = @Requested_By)                    
                    
Set @Department = (Select Department from emp_info where Emp_No = @Requested_By)                    
                    
Set @Sub_Department = (Select Sub_Department from emp_info where Emp_No = @Requested_By)                    
                    
----                    
Declare @SrAVPIT varchar(20)                    
Declare @HeadIT varchar(20)                    
Declare @ADIT varchar(20)                   
Declare @ED varchar(20)                    
Declare @EDCFO varchar(20)                    
Declare @CSO varchar(20)                    
                    
Set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
Set @HeadIT = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
Set @ADIT = (Select ADIT from tbl_EmpTree Where Emp_Id = @Requested_By)                    
Set @ED = (Select ED from tbl_EmpTree Where Emp_Id = @Requested_By)                    
Set @EDCFO = (Select EDCFO from tbl_EmpTree Where Emp_Id = @Requested_By)                    
Set @CSO = (Select CSO from tbl_EmpTree Where Emp_Id = @Requested_By)                    
----                    
                    
                    
----------------get Recommenders------------------------                    
                  select U_Role,Category,Department into #Recommenders                    
                  from tbl_Recommendation_LimitMaster                    
                  where @Estimated_Total_Price between Rec_limitFrom and Rec_LimitTo                    
                 And Category=@Category                    
                    
                  -- Select * from #Recommenders                              
         
        
    --Cursor                     
       Declare @CR_U_Role varchar(50)                    
    Declare @CR_Category varchar(50)                    
    Declare @CR_Department varchar(50)                    
    --Declare @Request_Id_Rec int                    
    --Declare @Recommender varchar(25)                    
    Declare Rec Cursor for                    
    Select * from #Recommenders                    
                    
                    
    OPEN Rec                    
    FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                    
    While(@@fetch_status=0)                    
      Begin                    
                    
       --Set @Request_Id_Rec = ''                    
       --Set @Recommender = ''                    
                          
       print 'Recommended'               
       print @CR_U_Role                    
       print @CR_Category                    
       print @CR_Department                    
                    
       if(@CR_Category = 'BRANCH')                    
        Begin                      
                          
         if(@CR_U_Role = 'Branch Head')                    
          Begin                           
           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By                          
                      
          End                    
--         else if(@CR_U_Role = 'Branch Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By                            
--          End                     
         else if(@CR_U_Role = 'Cluster Head')                    
          Begin                    
           Exec USP_GetRecApr 'R',@Category,'ClusterHead',@Request_Id,@Requested_By                    
          End                    
         else if(@CR_U_Role = 'Zonal Head')                    
          Begin                    
           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                            
        End                    
--         else if(@CR_U_Role = 'Zonal Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                                   
--          End                            
    else if(@CR_U_Role = 'Regional Head')                    
          Begin                    
           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By                    
          End                    
--         else if(@CR_U_Role = 'Regional Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By                           
--          End            
         else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')                    
          Begin                    
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                    
           -- Begin                    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
            Begin                    
             Insert into tbl_RequestRecApr                    
             Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                    
            End                    
           -- End                             
                              
          End                    
         else if(@CR_U_Role = 'Executive Director')                    
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')                    
            Begin                    
             Insert into tbl_RequestRecApr                    
             Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By                      
            End                    
           -- End                    
           End                    
         else if(@CR_U_Role = 'Executive Director-CFO')                    
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
            Begin                    
             Insert into tbl_RequestRecApr                    
             Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                     
            End                     
           -- End                          
          End                    
         else if(@CR_U_Role = 'Chief Strategy Officer')                    
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')                    
            Begin                    
             Insert into tbl_RequestRecApr                    
             Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                
            End                    
           -- End                    
         End                    
        End                    
                    
       else if (@CR_Category = 'CSO')                    
        Begin                    
                    
         if(@CR_U_Role = 'A.V.P.')                    
          Begin                    
           --if HOD should also see the request then add  HOD here.   
           print 'USP_GetRecApr'  
           Exec USP_GetRecApr 'R',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By                    
                    
          End                    
--         else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'ALL')                    
--          Begin                     
--           ---DoNothing                       
--          End                    
         else if(@CR_U_Role = 'Vice President')                    
          Begin                    
           --if HOD should also see the request then add  HOD here.                     
           Exec USP_GetRecApr 'R',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By                    
          End                    
--         else if(@CR_U_Role = 'Sr. Vice President')                    
--          Begin                    
--           --DoNothing                             
--          End                    
        else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@CR_U_Role = 'Associate Director')                    
     Begin                    
                               
           --select * from emp_info where emp_no ='P00104'                    
           --OR                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'R' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
          End                    
          End                    
        else if(@CR_U_Role = 'Executive Director')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
       Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@CR_U_Role = 'Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin          
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@CR_U_Role = 'Chief Strategy Officer')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
                    
                    
        End                           
                    
         FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                    
                    
                    
      End                    
                      
   Close Rec                    
   deallocate Rec                     
  
                               
                                                
                    
----------------------------------------------------------------------------------------------------------------                    
                    
---------------get Approver--------------------------------                    
                    
   Select U_Role,Category,Department into #Approver                    
   From tbl_Approval_LimitMaster                    
   Where @Estimated_Total_Price Between Apr_LimitFrom and Apr_LimitTo                    
   And Category = @Category                    
                    
                  -- Select * from #Approver                                     
    --Cursor                     
       Declare @CA_U_Role varchar(50)                    
    Declare @CA_Category varchar(50)                    
    Declare @CA_Department varchar(50)                    
    --Declare @Request_Id_Apr int                    
    --Declare @Approver varchar(25)                    
                    
    Declare Apr Cursor for                    
    Select * from #Approver                    
                    
                    
    OPEN Apr                    
    FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                    
    While(@@fetch_status=0)                    
      Begin                    
       --Set @Request_Id_Rec = ''                    
--       print @CA_U_Role                    
--       print @CA_Category                    
--       print @CA_Department                    
                    
       if(@CA_Category = 'BRANCH')                    
        Begin                    
                    
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
   Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                     
           End                    
          End                    
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                    
          Begin                    
           --select * from emp_info where emp_no ='P00104'                    
           --OR                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                     
           End                    
                               
          End                    
         else if(@CA_U_Role ='Executive Director')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By                     
           End                    
                    
          End                    
       else if(@CA_U_Role ='Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
     Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                     
           End                    
          End                    
         else if(@CA_U_Role ='Chief Strategy Officer')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                     
          End                    
         else if(@CA_U_Role ='CMD')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                    
           Insert into tbl_RequestRecApr                    
           Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'                    
          End                    
                      
                    
        End                    
                    
      else if(@CA_Category = 'CSO')                    
        Begin                    
                    
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
        End                    
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@CA_U_Role ='Executive Director')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@CA_U_Role ='Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                 
            Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@CA_U_Role ='Chief Strategy Officer')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@CA_U_Role ='CMD')                    
          Begin                    
 if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                    
           End                    
          End                    
                    
                
      End                    
                     
         FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                    
                    
      End                    
   Close Apr                    
   deallocate Apr                     
                                
                    
----------------get OTHERS Recommenders ------------------------                    
                  select U_Role,Category,Department into #OtherRecommenders                    
                  from tbl_Recommendation_LimitMaster                    
                  where @Estimated_Total_Price between B_ReclimitFrom and B_RecLimitTo                    
   And Category=@Category                    
                    
 -- Select * from #OtherRecommenders                              
                                             
                    
                               
    --Cursor                     
       Declare @COR_U_Role varchar(50)                    
    Declare @COR_Category varchar(50)                    
    Declare @COR_Department varchar(50)                    
    --Declare @Request_Id_Rec int                    
    --Declare @Recommender varchar(25)                
    Declare ORec Cursor for                    
    Select * from #OtherRecommenders                    
                    
                    
    OPEN ORec                    
    FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                    
    While(@@fetch_status=0)                    
      Begin                    
                    
       --Set @Request_Id_Rec = ''                    
       --Set @Recommender = ''                    
    
--                    
       print @COR_U_Role                    
       print @COR_Category                    
       print @COR_Department                    
                    
       if(@COR_Category = 'BRANCH')                    
        Begin                      
                          
         if(@COR_U_Role = 'Branch Head')                    
          Begin                           
           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                          
                      
          End                    
--         else if(@COR_U_Role = 'Branch Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                                               
--          End                     
         else if(@COR_U_Role = 'Cluster Head')                    
          Begin                    
           Exec USP_GetRecApr 'OR',@Category,'ClusterHead',@Request_Id,@Requested_By                    
          End                    
         else if(@COR_U_Role = 'Zonal Head')                    
          Begin                    
           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                            
          End                    
--         else if(@COR_U_Role = 'Zonal Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                                   
--          End                    
         else if(@COR_U_Role = 'Regional Head')                    
          Begin                    
           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                    
          End                    
--         else if(@CR_U_Role = 'Regional Manager')                    
--          Begin                    
--           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                        
--          End                    
         else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                    
          Begin                    
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                    
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
           -- End                             
                              
          End                    
         else if(@COR_U_Role = 'Executive Director')            
          Begin              
           --if(@Requested_By ='P00104')                    
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
           -- End                    
           End                    
         else if(@COR_U_Role = 'Executive Director-CFO')                    
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr              
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
           -- End               
          End                    
         else if(@COR_U_Role = 'Chief Strategy Officer')                    
          Begin                    
           --if(@Requested_By ='P00104')                    
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
           -- End                    
         End                    
        End                    
                    
       else if (@COR_Category = 'CSO')                    
        Begin                    
                    
         if(@COR_U_Role = 'A.V.P.')              
          Begin                    
           Exec USP_GetRecApr 'OR',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By                    
          End                    
--         else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'ALL')                    
--          Begin                     
--   DoNothing                            
--          End                    
         else if(@COR_U_Role = 'Vice President' OR @COR_U_Role = 'Sr. Vice President')                    
          Begin                    
           Exec USP_GetRecApr 'OR',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By                    
          End                    
--         else if(@COR_U_Role = 'Sr. Vice President')                    
--          Begin                    
--           DoNothing                             
--          End                    
        else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'OR' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
     End                    
          End                    
        else if(@COR_U_Role = 'Associate Director')                    
          Begin                    
                               
           --select * from emp_info where emp_no ='P00104'                    
           --OR                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OR' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                    
           End                    
          End                    
        else if(@COR_U_Role = 'Executive Director')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
    End                    
          End                    
        else if(@COR_U_Role = 'Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
        else if(@COR_U_Role = 'Chief Strategy Officer')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
                    
                    
        End                           
                    
         FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                    
                    
                    
      End                    
                      
   Close ORec                    
   deallocate ORec                     
                                
                    
----------------------------------------------------------------------------------------------------------------                    
                    
---------------get OTHER Approver--------------------------------                    
                    
   Select U_Role,Category,Department into #OtherApprover                    
   From tbl_Approval_LimitMaster                    
   Where @Estimated_Total_Price Between B_AprLimitFrom and B_AprLimitTo                    
   And Category = @Category                    
                    
                  -- Select * from #OtherApprover                                     
    --Cursor                     
       Declare @COA_U_Role varchar(50)                    
    Declare @COA_Category varchar(50)                    
    Declare @COA_Department varchar(50)                    
    --Declare @Request_Id_Apr int                    
    --Declare @Approver varchar(25)                    
                    
    Declare OApr Cursor for                    
    Select * from #OtherApprover                    
                    
                    
    OPEN OApr                    
    FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                    
    While(@@fetch_status=0)                    
      Begin                    
       --Set @Request_Id_Rec = ''                    
       print @COA_U_Role                    
       print @COA_Category                    
       print @COA_Department                    
                    
  if(@COA_Category = 'BRANCH')                    
        Begin                    
                    
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
          End                    
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                    
          Begin                    
           --select * from emp_info where emp_no ='P00104'                    
           --OR                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
                               
          End                    
         else if(@COA_U_Role ='Executive Director')                    
          Begin                    
          if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
          End                    
         else if(@COA_U_Role ='Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                    
           End                    
          End                    
         else if(@COA_U_Role ='Chief Strategy Officer')                    
Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                    
End                    
          End                    
         else if(@COA_U_Role ='CMD')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'                    
           End                    
          End                    
                      
                    
        End                    
                    
      else if(@COA_Category = 'CSO')                    
        Begin                    
                    
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
     Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@COA_U_Role ='Executive Director')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@COA_U_Role ='Executive Director-CFO')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                    
           Begin                     
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@COA_U_Role ='Chief Strategy Officer')                    
          Begin                    
     if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                     
           End                    
          End                    
         else if(@COA_U_Role ='CMD')                    
          Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                    
           Begin                    
            Insert into tbl_RequestRecApr                    
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                    
           End                   
          End                    
                    
                    
        End                    
                     
         FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                    
                    
      End                    
   Close OApr                    
   deallocate OApr                     
                                
----------------------------------------------------------------------------------------------------------                    
                  
  
  --added by sandeep on 09 Apr 2015 for depository--  
       declare @cnt int ,@SubDepartment varchar(50)         
       set @SubDepartment=(select sub_department from emp_info with(nolock) where emp_no=@Requested_By)  
       if(@SubDepartment='Depository')  
       Begin  
        Insert into tbl_RequestRecApr  
        select @Request_Id,'P00235','R'  
          
        Insert into tbl_RequestRecApr  
        select @Request_Id,'E63575','A'  
       End  
         
         
       --Ended by sandeep          
                    
Select @Request_Id As [Request_Id]                    
       
declare @Request_Id1 nvarchar(max)                    
Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster where Requested_By = @Requested_By)           
          
EXECUTE Usp_Mailer_Options '1',@Request_Id1                        
                                                                  
                                                                 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_AdminRequester
-- --------------------------------------------------
    
    
CREATE Proc [dbo].[USP_ITRequestMaster_AdminRequester]                                                                                          
(    
 @Branchcode nvarchar(255),     
 @IT_Engineer char(10),                                                                                                                                                                                         
 @Item_Code char(10),                                                                                                                                                                 
 @Model_No char(10),                                                                                                                   
 @Model_Quantity char(10),                                                                                                                                                        
 @Requested_By varchar(8),                                                                       
 @User_Remark varchar(200),                                                                                                                                                                    
 --@Recommended_By char(10),                                                                                                                        
 @Justification_Id char(10),         
 @Estimated_Total_Price int,
 @IT_Recommended_Name varchar(100)=null                                                  
 --@CSO bit,                                                                                                                        
)                                                                                          
as                                                      
    
Begin   

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
 
                                    
    
      
  --Declare @CSO  bit    
  Declare @Status_Code char(10)    
  Declare   @Request_Date DateTime    
  Declare @Model_Quantity_Assigned As char(10)    
     
set @Request_Date= getdate()        
    
set @Status_Code='P'    
set @Model_Quantity_Assigned='0'    
      
                                             
 insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,    
        AdminReq_forBranch,Justification_id,CSO,Status_Code,Estimated_Total_Price,    
        Model_Quantity_Assigned,IT_Recommended_Name)    
               
values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,    
  @Branchcode,@Justification_Id,'false',@Status_Code,@Estimated_Total_Price,    
  @Model_Quantity_Assigned,@IT_Recommended_Name)         
                                                    
     
 ----Log----    
--insert into tbl_RequestMasterLog(Item_Code,Model_No,Model_Quantity,Request_date,    
--        Requested_By,User_Remark,Justification_id,CSO,Status_Code,Estimated_Total_Price)    
--               
--values  (@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,    
--   @Justification_Id,'false',@Status_Code,@Estimated_Total_Price)                                                                  
 ----Log----        
    
------------------------------------------------    
    
--get current request_id    
 Declare @Request_Id int
 Declare @Request_Id1 int       
--getbranchcode of Requester    
  Declare @RequesterBrCd nvarchar(255)    
--onbasis of branchcode of Requester decide whether he belongs to Branch OR CSO Category    
  Declare @Category char(20)    
--get Designation of the Requester    
  Declare @Designation varchar(255)    
--get department of the requester    
  Declare @Department nvarchar(200)    
--get Sub_Department of the requester    
  Declare @Sub_Department varchar(150) 
   
    
Set @Request_Id = (select max(Request_Id) As Request_Id from tbl_RequestMaster  where Requested_By = @Requested_By) 
    

Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster)   
  
EXECUTE Usp_Mailer_Options '1',@Request_Id1      
  
    
set @RequesterBrCd = (select Branch_Cd from Emp_Info where Emp_No = @Requested_By)    
    
 if(@RequesterBrCd not in(select branch_cd from tbl_CSO_Branch(nolock)) )    
  Begin    
   Set @Category = 'BRANCH'    
  End    
    
 else if (@RequesterBrCd in (select branch_cd from tbl_CSO_Branch(nolock)) )    
  Begin    
   Set @Category = 'CSO'    
  End    
    
Set @Designation = (Select Designation from emp_info where Emp_No = @Requested_By)    
    
Set @Department = (Select Department from emp_info where Emp_No = @Requested_By)    
    
Set @Sub_Department = (Select Sub_Department from emp_info where Emp_No = @Requested_By)    
    
----    
Declare @SrAVPIT varchar(20)    
Declare @HeadIT varchar(20)    
Declare @ADIT varchar(20)    
Declare @ED varchar(20)    
Declare @EDCFO varchar(20)    
Declare @CSO varchar(20)    
    
Set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree Where Emp_Id = @Requested_By)    
Set @HeadIT = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)    
Set @ADIT = (Select ADIT from tbl_EmpTree Where Emp_Id = @Requested_By)    
Set @ED = (Select ED from tbl_EmpTree Where Emp_Id = @Requested_By)    
Set @EDCFO = (Select EDCFO from tbl_EmpTree Where Emp_Id = @Requested_By)    
Set @CSO = (Select CSO from tbl_EmpTree Where Emp_Id = @Requested_By)    
----    
    
    
----------------get Recommenders------------------------    
                  select U_Role,Category,Department into #Recommenders    
                  from tbl_Recommendation_LimitMaster    
                  where @Estimated_Total_Price between Rec_limitFrom and Rec_LimitTo    
                 And Category=@Category    
    
                  -- Select * from #Recommenders              
                             
    
               
    --Cursor     
       Declare @CR_U_Role varchar(50)    
    Declare @CR_Category varchar(50)    
    Declare @CR_Department varchar(50)    
    --Declare @Request_Id_Rec int    
    --Declare @Recommender varchar(25)    
    Declare Rec Cursor for    
    Select * from #Recommenders    
    
    
    OPEN Rec    
    FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department    
    While(@@fetch_status=0)    
      Begin    
    
       --Set @Request_Id_Rec = ''    
       --Set @Recommender = ''    
          
--    
--       print @CR_U_Role    
--       print @CR_Category    
--       print @CR_Department    
    
       if(@CR_Category = 'BRANCH')    
        Begin      
          
         if(@CR_U_Role = 'Branch Head')    
          Begin           
           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By          
      
          End    
--         else if(@CR_U_Role = 'Branch Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By            
--          End     
         else if(@CR_U_Role = 'Cluster Head')    
          Begin    
           Exec USP_GetRecApr 'R',@Category,'ClusterHead',@Request_Id,@Requested_By    
          End    
         else if(@CR_U_Role = 'Zonal Head')    
          Begin    
           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By            
          End    
--         else if(@CR_U_Role = 'Zonal Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                   
--          End    
         else if(@CR_U_Role = 'Regional Head')    
          Begin    
           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By    
          End    
--         else if(@CR_U_Role = 'Regional Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By           
--          End    
         else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')    
          Begin    
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))    
           -- Begin    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')    
            Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By    
          End    
           -- End             
              
          End    
         else if(@CR_U_Role = 'Executive Director')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')    
            Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By      
            End    
           -- End    
           End    
         else if(@CR_U_Role = 'Executive Director-CFO')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')    
            Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By     
            End     
           -- End          
          End    
         else if(@CR_U_Role = 'Chief Strategy Officer')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')    
            Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By    
            End    
           -- End    
         End    
        End    
    
       else if (@CR_Category = 'CSO')    
        Begin    
    
         if(@CR_U_Role = 'A.V.P.')    
          Begin    
           --if HOD should also see the request then add  HOD here.     
           Exec USP_GetRecApr 'R',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By    
    
          End    
--         else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'ALL')    
--          Begin     
--           ---DoNothing       
--          End    
         else if(@CR_U_Role = 'Vice President')    
          Begin    
           --if HOD should also see the request then add  HOD here.     
           Exec USP_GetRecApr 'R',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By    
          End    
--         else if(@CR_U_Role = 'Sr. Vice President')    
--          Begin    
--           --DoNothing             
--          End    
        else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@CR_U_Role = 'Associate Director')    
          Begin    
               
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'R' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@CR_U_Role = 'Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@CR_U_Role = 'Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@CR_U_Role = 'Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
    
    
        End           
    
         FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department    
    
    
      End    
      
   Close Rec    
   deallocate Rec     
                
    
----------------------------------------------------------------------------------------------------------------    
    
---------------get Approver--------------------------------    
    
   Select U_Role,Category,Department into #Approver    
   From tbl_Approval_LimitMaster    
   Where @Estimated_Total_Price Between Apr_LimitFrom and Apr_LimitTo    
   And Category = @Category    
    
                  -- Select * from #Approver                     
    --Cursor     
       Declare @CA_U_Role varchar(50)    
    Declare @CA_Category varchar(50)    
    Declare @CA_Department varchar(50)    
    --Declare @Request_Id_Apr int    
    --Declare @Approver varchar(25)    
    
    Declare Apr Cursor for    
    Select * from #Approver    
    
    
    OPEN Apr    
    FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department    
    While(@@fetch_status=0)    
      Begin    
       --Set @Request_Id_Rec = ''    
--       print @CA_U_Role    
--       print @CA_Category    
--       print @CA_Department    
    
       if(@CA_Category = 'BRANCH')    
        Begin    
    
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
           End    
          End    
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')    
          Begin    
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
           End    
               
          End    
         else if(@CA_U_Role ='Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
           End    
    
          End    
         else if(@CA_U_Role ='Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
           End    
          End    
         else if(@CA_U_Role ='Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By    
           End     
          End    
         else if(@CA_U_Role ='CMD')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'    
          End    
      
    
        End    
    
      else if(@CA_Category = 'CSO')    
        Begin    
    
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@CA_U_Role ='Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@CA_U_Role ='Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@CA_U_Role ='Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@CA_U_Role ='CMD')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'    
           End    
          End    
    
    
        End    
     
         FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department    
    
      End    
   Close Apr    
   deallocate Apr     
                
    
----------------get OTHERS Recommenders ------------------------    
                  select U_Role,Category,Department into #OtherRecommenders    
                  from tbl_Recommendation_LimitMaster    
                  where @Estimated_Total_Price between B_ReclimitFrom and B_RecLimitTo    
                 And Category=@Category    
    
                  -- Select * from #OtherRecommenders              
                             
    
               
    --Cursor     
       Declare @COR_U_Role varchar(50)    
    Declare @COR_Category varchar(50)    
    Declare @COR_Department varchar(50)    
    --Declare @Request_Id_Rec int    
    --Declare @Recommender varchar(25)    
    Declare ORec Cursor for    
    Select * from #OtherRecommenders    
    
    
    OPEN ORec    
    FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department    
    While(@@fetch_status=0)    
      Begin    
    
       --Set @Request_Id_Rec = ''    
       --Set @Recommender = ''    
          
--    
--       print @COR_U_Role    
--       print @COR_Category    
--       print @COR_Department    
    
       if(@COR_Category = 'BRANCH')    
        Begin      
          
         if(@COR_U_Role = 'Branch Head')    
          Begin           
           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By          
      
          End    
--         else if(@COR_U_Role = 'Branch Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                               
--          End     
         else if(@COR_U_Role = 'Cluster Head')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'ClusterHead',@Request_Id,@Requested_By    
          End    
         else if(@COR_U_Role = 'Zonal Head')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By            
          End    
--         else if(@COR_U_Role = 'Zonal Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                   
--          End    
         else if(@COR_U_Role = 'Regional Head')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By    
          End    
--         else if(@CR_U_Role = 'Regional Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By            
--          End    
         else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')    
          Begin    
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))    
           -- Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
           -- End             
              
          End    
         else if(@COR_U_Role = 'Executive Director')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
           -- End    
           End    
         else if(@COR_U_Role = 'Executive Director-CFO')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
           -- End          
          End    
         else if(@COR_U_Role = 'Chief Strategy Officer')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
           -- End    
         End    
        End    
    
       else if (@COR_Category = 'CSO')    
        Begin    
    
         if(@COR_U_Role = 'A.V.P.')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By    
          End    
--         else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'ALL')    
--          Begin     
--           DoNothing            
--          End    
         else if(@COR_U_Role = 'Vice President' OR @COR_U_Role = 'Sr. Vice President')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By    
          End    
--         else if(@COR_U_Role = 'Sr. Vice President')    
--          Begin    
--           DoNothing             
--          End    
        else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'OR' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@COR_U_Role = 'Associate Director')    
          Begin    
               
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OR' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
           End    
          End    
        else if(@COR_U_Role = 'Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@COR_U_Role = 'Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@COR_U_Role = 'Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
    
    
        End           
    
         FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department    
    
    
      End    
      
   Close ORec    
   deallocate ORec     
                
    
----------------------------------------------------------------------------------------------------------------    
    
---------------get OTHER Approver--------------------------------    
    
   Select U_Role,Category,Department into #OtherApprover    
   From tbl_Approval_LimitMaster    
   Where @Estimated_Total_Price Between B_AprLimitFrom and B_AprLimitTo    
   And Category = @Category    
    
                  -- Select * from #OtherApprover                     
    --Cursor     
       Declare @COA_U_Role varchar(50)    
    Declare @COA_Category varchar(50)    
    Declare @COA_Department varchar(50)    
    --Declare @Request_Id_Apr int    
    --Declare @Approver varchar(25)    
    
    Declare OApr Cursor for    
    Select * from #OtherApprover    
    
    
    OPEN OApr    
    FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department    
    While(@@fetch_status=0)    
      Begin    
       --Set @Request_Id_Rec = ''    
--       print @COA_U_Role    
--       print @COA_Category    
--       print @COA_Department    
    
       if(@COA_Category = 'BRANCH')    
        Begin    
    
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
          End    
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')    
          Begin    
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
               
          End    
         else if(@COA_U_Role ='Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
          End    
         else if(@COA_U_Role ='Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
          End    
         else if(@COA_U_Role ='Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
          End    
         else if(@COA_U_Role ='CMD')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'    
           End    
          End    
      
    
        End    
    
      else if(@COA_Category = 'CSO')    
        Begin    
    
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@COA_U_Role ='Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
        Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@COA_U_Role ='Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin     
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@COA_U_Role ='Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@COA_U_Role ='CMD')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'    
           End    
          End    
    
    
        End    
     
         FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department    
    
      End    
   Close OApr    
   deallocate OApr     
                
----------------------------------------------------------------------------------------------------------    
    
    
Select @Request_Id As [Request_Id]    
    
    
                                                  
                                                 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_AdminRequester_21112018
-- --------------------------------------------------
    
    
Create Proc [dbo].[USP_ITRequestMaster_AdminRequester_21112018]                                                                                          
(    
 @Branchcode nvarchar(255),     
 @IT_Engineer char(10),                                                                                                                                                                                         
 @Item_Code char(10),                                                                                                                                                                 
 @Model_No char(10),                                                                                                                   
 @Model_Quantity char(10),                                                                                                                                                        
 @Requested_By varchar(8),                                                                       
 @User_Remark varchar(200),                                                                                                                                                                    
 --@Recommended_By char(10),                                                                                                                        
 @Justification_Id char(10),         
 @Estimated_Total_Price int                                                  
 --@CSO bit,                                                                                                                        
)                                                                                          
as                                                      
    
Begin   

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
 
                                    
    
      
  --Declare @CSO  bit    
  Declare @Status_Code char(10)    
  Declare   @Request_Date DateTime    
  Declare @Model_Quantity_Assigned As char(10)    
     
set @Request_Date= getdate()        
    
set @Status_Code='P'    
set @Model_Quantity_Assigned='0'    
      
                                             
 insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,    
        AdminReq_forBranch,Justification_id,CSO,Status_Code,Estimated_Total_Price,    
        Model_Quantity_Assigned)    
               
values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,    
  @Branchcode,@Justification_Id,'false',@Status_Code,@Estimated_Total_Price,    
  @Model_Quantity_Assigned)         
                                                    
     
 ----Log----    
--insert into tbl_RequestMasterLog(Item_Code,Model_No,Model_Quantity,Request_date,    
--        Requested_By,User_Remark,Justification_id,CSO,Status_Code,Estimated_Total_Price)    
--               
--values  (@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,    
--   @Justification_Id,'false',@Status_Code,@Estimated_Total_Price)                                                                  
 ----Log----        
    
------------------------------------------------    
    
--get current request_id    
 Declare @Request_Id int
 Declare @Request_Id1 int       
--getbranchcode of Requester    
  Declare @RequesterBrCd nvarchar(255)    
--onbasis of branchcode of Requester decide whether he belongs to Branch OR CSO Category    
  Declare @Category char(20)    
--get Designation of the Requester    
  Declare @Designation varchar(255)    
--get department of the requester    
  Declare @Department nvarchar(200)    
--get Sub_Department of the requester    
  Declare @Sub_Department varchar(150) 
   
    
Set @Request_Id = (select max(Request_Id) As Request_Id from tbl_RequestMaster  where Requested_By = @Requested_By) 
    

Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster)   
  
EXECUTE Usp_Mailer_Options '1',@Request_Id1      
  
    
set @RequesterBrCd = (select Branch_Cd from Emp_Info where Emp_No = @Requested_By)    
    
 if(@RequesterBrCd not in(select branch_cd from tbl_CSO_Branch(nolock)) )    
  Begin    
   Set @Category = 'BRANCH'    
  End    
    
 else if (@RequesterBrCd in (select branch_cd from tbl_CSO_Branch(nolock)) )    
  Begin    
   Set @Category = 'CSO'    
  End    
    
Set @Designation = (Select Designation from emp_info where Emp_No = @Requested_By)    
    
Set @Department = (Select Department from emp_info where Emp_No = @Requested_By)    
    
Set @Sub_Department = (Select Sub_Department from emp_info where Emp_No = @Requested_By)    
    
----    
Declare @SrAVPIT varchar(20)    
Declare @HeadIT varchar(20)    
Declare @ADIT varchar(20)    
Declare @ED varchar(20)    
Declare @EDCFO varchar(20)    
Declare @CSO varchar(20)    
    
Set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree Where Emp_Id = @Requested_By)    
Set @HeadIT = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)    
Set @ADIT = (Select ADIT from tbl_EmpTree Where Emp_Id = @Requested_By)    
Set @ED = (Select ED from tbl_EmpTree Where Emp_Id = @Requested_By)    
Set @EDCFO = (Select EDCFO from tbl_EmpTree Where Emp_Id = @Requested_By)    
Set @CSO = (Select CSO from tbl_EmpTree Where Emp_Id = @Requested_By)    
----    
    
    
----------------get Recommenders------------------------    
                  select U_Role,Category,Department into #Recommenders    
                  from tbl_Recommendation_LimitMaster    
                  where @Estimated_Total_Price between Rec_limitFrom and Rec_LimitTo    
                 And Category=@Category    
    
                  -- Select * from #Recommenders              
                             
    
               
    --Cursor     
       Declare @CR_U_Role varchar(50)    
    Declare @CR_Category varchar(50)    
    Declare @CR_Department varchar(50)    
    --Declare @Request_Id_Rec int    
    --Declare @Recommender varchar(25)    
    Declare Rec Cursor for    
    Select * from #Recommenders    
    
    
    OPEN Rec    
    FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department    
    While(@@fetch_status=0)    
      Begin    
    
       --Set @Request_Id_Rec = ''    
       --Set @Recommender = ''    
          
--    
--       print @CR_U_Role    
--       print @CR_Category    
--       print @CR_Department    
    
       if(@CR_Category = 'BRANCH')    
        Begin      
          
         if(@CR_U_Role = 'Branch Head')    
          Begin           
           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By          
      
          End    
--         else if(@CR_U_Role = 'Branch Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By            
--          End     
         else if(@CR_U_Role = 'Cluster Head')    
          Begin    
           Exec USP_GetRecApr 'R',@Category,'ClusterHead',@Request_Id,@Requested_By    
          End    
         else if(@CR_U_Role = 'Zonal Head')    
          Begin    
           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By            
          End    
--         else if(@CR_U_Role = 'Zonal Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                   
--          End    
         else if(@CR_U_Role = 'Regional Head')    
          Begin    
           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By    
          End    
--         else if(@CR_U_Role = 'Regional Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By           
--          End    
         else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')    
          Begin    
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))    
           -- Begin    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')    
            Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By    
          End    
           -- End             
              
          End    
         else if(@CR_U_Role = 'Executive Director')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')    
            Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By      
            End    
           -- End    
           End    
         else if(@CR_U_Role = 'Executive Director-CFO')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')    
            Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By     
            End     
           -- End          
          End    
         else if(@CR_U_Role = 'Chief Strategy Officer')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')    
            Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By    
            End    
           -- End    
         End    
        End    
    
       else if (@CR_Category = 'CSO')    
        Begin    
    
         if(@CR_U_Role = 'A.V.P.')    
          Begin    
           --if HOD should also see the request then add  HOD here.     
           Exec USP_GetRecApr 'R',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By    
    
          End    
--         else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'ALL')    
--          Begin     
--           ---DoNothing       
--          End    
         else if(@CR_U_Role = 'Vice President')    
          Begin    
           --if HOD should also see the request then add  HOD here.     
           Exec USP_GetRecApr 'R',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By    
          End    
--         else if(@CR_U_Role = 'Sr. Vice President')    
--          Begin    
--           --DoNothing             
--          End    
        else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@CR_U_Role = 'Associate Director')    
          Begin    
               
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'R' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@CR_U_Role = 'Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@CR_U_Role = 'Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@CR_U_Role = 'Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
    
    
        End           
    
         FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department    
    
    
      End    
      
   Close Rec    
   deallocate Rec     
                
    
----------------------------------------------------------------------------------------------------------------    
    
---------------get Approver--------------------------------    
    
   Select U_Role,Category,Department into #Approver    
   From tbl_Approval_LimitMaster    
   Where @Estimated_Total_Price Between Apr_LimitFrom and Apr_LimitTo    
   And Category = @Category    
    
                  -- Select * from #Approver                     
    --Cursor     
       Declare @CA_U_Role varchar(50)    
    Declare @CA_Category varchar(50)    
    Declare @CA_Department varchar(50)    
    --Declare @Request_Id_Apr int    
    --Declare @Approver varchar(25)    
    
    Declare Apr Cursor for    
    Select * from #Approver    
    
    
    OPEN Apr    
    FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department    
    While(@@fetch_status=0)    
      Begin    
       --Set @Request_Id_Rec = ''    
--       print @CA_U_Role    
--       print @CA_Category    
--       print @CA_Department    
    
       if(@CA_Category = 'BRANCH')    
        Begin    
    
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
           End    
          End    
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')    
          Begin    
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
           End    
               
          End    
         else if(@CA_U_Role ='Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
           End    
    
          End    
         else if(@CA_U_Role ='Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
           End    
          End    
         else if(@CA_U_Role ='Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By    
           End     
          End    
         else if(@CA_U_Role ='CMD')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'    
          End    
      
    
        End    
    
      else if(@CA_Category = 'CSO')    
        Begin    
    
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@CA_U_Role ='Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@CA_U_Role ='Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@CA_U_Role ='Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@CA_U_Role ='CMD')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'    
           End    
          End    
    
    
        End    
     
         FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department    
    
      End    
   Close Apr    
   deallocate Apr     
                
    
----------------get OTHERS Recommenders ------------------------    
                  select U_Role,Category,Department into #OtherRecommenders    
                  from tbl_Recommendation_LimitMaster    
                  where @Estimated_Total_Price between B_ReclimitFrom and B_RecLimitTo    
                 And Category=@Category    
    
                  -- Select * from #OtherRecommenders              
                             
    
               
    --Cursor     
       Declare @COR_U_Role varchar(50)    
    Declare @COR_Category varchar(50)    
    Declare @COR_Department varchar(50)    
    --Declare @Request_Id_Rec int    
    --Declare @Recommender varchar(25)    
    Declare ORec Cursor for    
    Select * from #OtherRecommenders    
    
    
    OPEN ORec    
    FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department    
    While(@@fetch_status=0)    
      Begin    
    
       --Set @Request_Id_Rec = ''    
       --Set @Recommender = ''    
          
--    
--       print @COR_U_Role    
--       print @COR_Category    
--       print @COR_Department    
    
       if(@COR_Category = 'BRANCH')    
        Begin      
          
         if(@COR_U_Role = 'Branch Head')    
          Begin           
           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By          
      
          End    
--         else if(@COR_U_Role = 'Branch Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                               
--          End     
         else if(@COR_U_Role = 'Cluster Head')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'ClusterHead',@Request_Id,@Requested_By    
          End    
         else if(@COR_U_Role = 'Zonal Head')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By            
          End    
--         else if(@COR_U_Role = 'Zonal Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                   
--          End    
         else if(@COR_U_Role = 'Regional Head')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By    
          End    
--         else if(@CR_U_Role = 'Regional Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By            
--          End    
         else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')    
          Begin    
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))    
           -- Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
           -- End             
              
          End    
         else if(@COR_U_Role = 'Executive Director')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
           -- End    
           End    
         else if(@COR_U_Role = 'Executive Director-CFO')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
           -- End          
          End    
         else if(@COR_U_Role = 'Chief Strategy Officer')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
           -- End    
         End    
        End    
    
       else if (@COR_Category = 'CSO')    
        Begin    
    
         if(@COR_U_Role = 'A.V.P.')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By    
          End    
--         else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'ALL')    
--          Begin     
--           DoNothing            
--          End    
         else if(@COR_U_Role = 'Vice President' OR @COR_U_Role = 'Sr. Vice President')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By    
          End    
--         else if(@COR_U_Role = 'Sr. Vice President')    
--          Begin    
--           DoNothing             
--          End    
        else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'OR' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@COR_U_Role = 'Associate Director')    
          Begin    
               
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OR' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
           End    
          End    
        else if(@COR_U_Role = 'Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@COR_U_Role = 'Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
        else if(@COR_U_Role = 'Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
    
    
        End           
    
         FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department    
    
    
      End    
      
   Close ORec    
   deallocate ORec     
                
    
----------------------------------------------------------------------------------------------------------------    
    
---------------get OTHER Approver--------------------------------    
    
   Select U_Role,Category,Department into #OtherApprover    
   From tbl_Approval_LimitMaster    
   Where @Estimated_Total_Price Between B_AprLimitFrom and B_AprLimitTo    
   And Category = @Category    
    
                  -- Select * from #OtherApprover                     
    --Cursor     
       Declare @COA_U_Role varchar(50)    
    Declare @COA_Category varchar(50)    
    Declare @COA_Department varchar(50)    
    --Declare @Request_Id_Apr int    
    --Declare @Approver varchar(25)    
    
    Declare OApr Cursor for    
    Select * from #OtherApprover    
    
    
    OPEN OApr    
    FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department    
    While(@@fetch_status=0)    
      Begin    
       --Set @Request_Id_Rec = ''    
--       print @COA_U_Role    
--       print @COA_Category    
--       print @COA_Department    
    
       if(@COA_Category = 'BRANCH')    
        Begin    
    
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
          End    
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')    
          Begin    
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
               
          End    
         else if(@COA_U_Role ='Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
          End    
         else if(@COA_U_Role ='Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
          End    
         else if(@COA_U_Role ='Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
           End    
          End    
         else if(@COA_U_Role ='CMD')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'    
           End    
          End    
      
    
        End    
    
      else if(@COA_Category = 'CSO')    
        Begin    
    
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@COA_U_Role ='Executive Director')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
        Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@COA_U_Role ='Executive Director-CFO')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')    
           Begin     
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@COA_U_Role ='Chief Strategy Officer')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))     
           End    
          End    
         else if(@COA_U_Role ='CMD')    
          Begin    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')    
           Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'    
           End    
          End    
    
    
        End    
     
         FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department    
    
      End    
   Close OApr    
   deallocate OApr     
                
----------------------------------------------------------------------------------------------------------    
    
    
Select @Request_Id As [Request_Id]    
    
    
                                                  
                                                 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_AdminRequester_WITH_MULTIPLE_ENTRIES
-- --------------------------------------------------


CREATE Proc [dbo].[USP_ITRequestMaster_AdminRequester_WITH_MULTIPLE_ENTRIES]                                                                                          
(    
@Branchcode nvarchar(255),     
@IT_Engineer char(10),                                                                                                                                                                                         
@Item_Code char(10),                                                                                                                                                                 
@Model_No char(10),                                                                                                                   
@Model_Quantity char(10),                                                                                                                                                        
@Requested_By varchar(8),                                                                       
@User_Remark varchar(200),                                                                                                                                                                    
--@Recommended_By char(10),                                                                                                                        
@Justification_Id char(10),         
@Estimated_Total_Price int                                                  
--@CSO bit,                                                                                                                        
)                                                                                          
as                                                      

Begin  


   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  



Declare @CSO  bit    
Declare @Status_Code char(10)    
Declare   @Request_Date DateTime    
Declare @Model_Quantity_Assigned As char(10)    

set @Request_Date= getdate()        

set @Status_Code='P'    
set @Model_Quantity_Assigned='0'    


insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,    
AdminReq_forBranch,Justification_id,CSO,Status_Code,Estimated_Total_Price,    
Model_Quantity_Assigned)    

values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,    
@Branchcode,@Justification_Id,'false',@Status_Code,@Estimated_Total_Price,    
@Model_Quantity_Assigned)         


----Log----    
--insert into tbl_RequestMasterLog(Item_Code,Model_No,Model_Quantity,Request_date,    
--        Requested_By,User_Remark,Justification_id,CSO,Status_Code,Estimated_Total_Price)    
--               
--values  (@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,    
--   @Justification_Id,'false',@Status_Code,@Estimated_Total_Price)                                                                  
----Log----        

------------------------------------------------    

--get current request_id    
Declare @Request_Id int    
Declare @Request_Id1 int
--getbranchcode of Requester    
Declare @RequesterBrCd nvarchar(255)    
--onbasis of branchcode of Requester decide whether he belongs to Branch OR CSO Category    
Declare @Category char(20)    
--get Designation of the Requester    
Declare @Designation varchar(255)    
--get department of the requester    
Declare @Department nvarchar(200)    
--get Sub_Department of the requester    
Declare @Sub_Department varchar(150)    

Set @Request_Id = (select max(Request_Id) As Request_Id from tbl_RequestMaster  where Requested_By = @Requested_By)    


Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster)   

EXECUTE Usp_Mailer_Options '1',@Request_Id1  



set @RequesterBrCd = (select Branch_Cd from Emp_Info where Emp_No = @Requested_By)    

if(@RequesterBrCd not in(select branch_cd from tbl_CSO_Branch(nolock)))    
Begin    
Set @Category = 'BRANCH'    
End    

else if (@RequesterBrCd in (select branch_cd from tbl_CSO_Branch(nolock)))    
Begin    
Set @Category = 'CSO'    
End    

Set @Designation = (Select Designation from emp_info where Emp_No = @Requested_By)    

Set @Department = (Select Department from emp_info where Emp_No = @Requested_By)    

Set @Sub_Department = (Select Sub_Department from emp_info where Emp_No = @Requested_By)    

----------------get Recommenders------------------------    
select U_Role,Category,Department into #Recommenders    
from tbl_Recommendation_LimitMaster    
where @Estimated_Total_Price between Rec_limitFrom and Rec_LimitTo    
And Category=@Category    

-- Select * from #Recommenders              



--Cursor     
Declare @CR_U_Role varchar(50)    
Declare @CR_Category varchar(50)    
Declare @CR_Department varchar(50)    
--Declare @Request_Id_Rec int    
--Declare @Recommender varchar(25)    
Declare Rec Cursor for    
Select * from #Recommenders    


OPEN Rec    
FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department    
While(@@fetch_status=0)    
Begin    

--Set @Request_Id_Rec = ''    
--Set @Recommender = ''    

--    
--       print @CR_U_Role    
--       print @CR_Category    
--       print @CR_Department    

if(@CR_Category = 'BRANCH')    
Begin      

if(@CR_U_Role = 'Branch Head')    
Begin           
Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By          

End    
--         else if(@CR_U_Role = 'Branch Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By            
--          End     
else if(@CR_U_Role = 'Cluster Head')    
Begin    
Exec USP_GetRecApr 'R',@Category,'ClusterHead',@Request_Id,@Requested_By    
End    
else if(@CR_U_Role = 'Zonal Head')    
Begin    
Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By            
End    
--         else if(@CR_U_Role = 'Zonal Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                   
--          End    
else if(@CR_U_Role = 'Regional Head')    
Begin    
Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By    
End    
--         else if(@CR_U_Role = 'Regional Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By           
--          End    
else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')    
Begin    
--if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))    
-- Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By    
-- End             

End    
else if(@CR_U_Role = 'Executive Director')    
Begin    
--if(@Requested_By ='P00104')    
-- Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By         
-- End    
End    
else if(@CR_U_Role = 'Executive Director-CFO')    
Begin    
--if(@Requested_By ='P00104')    
-- Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By      
-- End          
End    
else if(@CR_U_Role = 'Chief Strategy Officer')    
Begin    
--if(@Requested_By ='P00104')    
-- Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By              
-- End    
End    
End    

else if (@CR_Category = 'CSO')    
Begin    

if(@CR_U_Role = 'A.V.P.')    
Begin    
--if HOD should also see the request then add  HOD here.     
Exec USP_GetRecApr 'R',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By    

End    
--         else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'ALL')    
--          Begin     
--           ---DoNothing       
--          End    
else if(@CR_U_Role = 'Vice President')    
Begin    
--if HOD should also see the request then add  HOD here.     
Exec USP_GetRecApr 'R',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By    
End    
--         else if(@CR_U_Role = 'Sr. Vice President')    
--          Begin    
--           --DoNothing             
--          End    
else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'IT')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@CR_U_Role = 'Associate Director')    
Begin    

--select * from emp_info where emp_no ='P00104'    
--OR    
Insert into tbl_RequestRecApr    
Select @Request_Id,ADIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@CR_U_Role = 'Executive Director')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@CR_U_Role = 'Executive Director-CFO')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@CR_U_Role = 'Chief Strategy Officer')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    


End           

FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department    


End    

Close Rec    
deallocate Rec     


----------------------------------------------------------------------------------------------------------------    

---------------get Approver--------------------------------    

Select U_Role,Category,Department into #Approver    
From tbl_Approval_LimitMaster    
Where @Estimated_Total_Price Between Apr_LimitFrom and Apr_LimitTo    
And Category = @Category    

-- Select * from #Approver                     
--Cursor     
Declare @CA_U_Role varchar(50)    
Declare @CA_Category varchar(50)    
Declare @CA_Department varchar(50)    
--Declare @Request_Id_Apr int    
--Declare @Approver varchar(25)    

Declare Apr Cursor for    
Select * from #Approver    


OPEN Apr    
FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department    
While(@@fetch_status=0)    
Begin    
--Set @Request_Id_Rec = ''    
--       print @CA_U_Role    
--       print @CA_Category    
--       print @CA_Department    

if(@CA_Category = 'BRANCH')    
Begin    

if(@CA_U_Role = 'Head' and @CA_Department = 'IT')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
End    
else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')    
Begin    
--select * from emp_info where emp_no ='P00104'    
--OR    
Insert into tbl_RequestRecApr    
Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By     

End    
else if(@CA_U_Role ='Executive Director')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By     

End    
else if(@CA_U_Role ='Executive Director-CFO')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
End    
else if(@CA_U_Role ='Chief Strategy Officer')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
End    
else if(@CA_U_Role ='CMD')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'    
End    


End    

else if(@CA_Category = 'CSO')    
Begin    

if(@CA_U_Role = 'Head' and @CA_Department = 'IT')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@CA_U_Role ='Executive Director')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@CA_U_Role ='Executive Director-CFO')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@CA_U_Role ='Chief Strategy Officer')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@CA_U_Role ='CMD')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))  and [Status] = 'A'    
End    


End    

FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department    

End    
Close Apr    
deallocate Apr     


----------------get OTHERS Recommenders ------------------------    
select U_Role,Category,Department into #OtherRecommenders    
from tbl_Recommendation_LimitMaster    
where @Estimated_Total_Price between B_ReclimitFrom and B_RecLimitTo    
And Category=@Category    

-- Select * from #OtherRecommenders              



--Cursor     
Declare @COR_U_Role varchar(50)    
Declare @COR_Category varchar(50)    
Declare @COR_Department varchar(50)    
--Declare @Request_Id_Rec int    
--Declare @Recommender varchar(25)    
Declare ORec Cursor for    
Select * from #OtherRecommenders    


OPEN ORec    
FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department    
While(@@fetch_status=0)    
Begin    

--Set @Request_Id_Rec = ''    
--Set @Recommender = ''    

--    
--       print @COR_U_Role    
--       print @COR_Category    
--       print @COR_Department    

if(@COR_Category = 'BRANCH')    
Begin      

if(@COR_U_Role = 'Branch Head')    
Begin           
Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By          

End    
--         else if(@COR_U_Role = 'Branch Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                               
--          End     
else if(@COR_U_Role = 'Cluster Head')    
Begin    
Exec USP_GetRecApr 'OR',@Category,'ClusterHead',@Request_Id,@Requested_By    
End    
else if(@COR_U_Role = 'Zonal Head')    
Begin    
Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By            
End    
--         else if(@COR_U_Role = 'Zonal Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                   
--          End    
else if(@COR_U_Role = 'Regional Head')    
Begin    
Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By    
End    
--         else if(@CR_U_Role = 'Regional Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By            
--          End    
else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')    
Begin    
--if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))    
-- Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
-- End             

End    
else if(@COR_U_Role = 'Executive Director')    
Begin    
--if(@Requested_By ='P00104')    
-- Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
-- End    
End    
else if(@COR_U_Role = 'Executive Director-CFO')    
Begin    
--if(@Requested_By ='P00104')    
-- Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
-- End          
End    
else if(@COR_U_Role = 'Chief Strategy Officer')    
Begin    
--if(@Requested_By ='P00104')    
-- Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
-- End    
End    
End    

else if (@COR_Category = 'CSO')    
Begin    

if(@COR_U_Role = 'A.V.P.')    
Begin    
Exec USP_GetRecApr 'OR',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By    
End    
--         else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'ALL')    
--          Begin     
--           DoNothing            
--          End    
else if(@COR_U_Role = 'Vice President' OR @COR_U_Role = 'Sr. Vice President')    
Begin    
Exec USP_GetRecApr 'OR',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By    
End    
--         else if(@COR_U_Role = 'Sr. Vice President')    
--          Begin    
--           DoNothing             
--          End    
else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'IT')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@COR_U_Role = 'Associate Director')    
Begin    
--select * from emp_info where emp_no ='P00104'    
--OR    
Insert into tbl_RequestRecApr    
Select @Request_Id,ADIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@COR_U_Role = 'Executive Director')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@COR_U_Role = 'Executive Director-CFO')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@COR_U_Role = 'Chief Strategy Officer')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    


End           

FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department    


End    

Close ORec    
deallocate ORec     


----------------------------------------------------------------------------------------------------------------    

---------------get OTHER Approver--------------------------------    

Select U_Role,Category,Department into #OtherApprover    
From tbl_Approval_LimitMaster    
Where @Estimated_Total_Price Between B_AprLimitFrom and B_AprLimitTo    
And Category = @Category    

-- Select * from #OtherApprover                     
--Cursor     
Declare @COA_U_Role varchar(50)    
Declare @COA_Category varchar(50)    
Declare @COA_Department varchar(50)    
--Declare @Request_Id_Apr int    
--Declare @Approver varchar(25)    

Declare OApr Cursor for    
Select * from #OtherApprover    


OPEN OApr    
FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department    
While(@@fetch_status=0)    
Begin    
--Set @Request_Id_Rec = ''    
--       print @COA_U_Role    
--       print @COA_Category    
--       print @COA_Department    

if(@COA_Category = 'BRANCH')    
Begin    

if(@COA_U_Role = 'Head' and @COA_Department = 'IT')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
End    
else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')    
Begin    
--select * from emp_info where emp_no ='P00104'    
--OR    
Insert into tbl_RequestRecApr    
Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    

End    
else if(@COA_U_Role ='Executive Director')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    

End    
else if(@COA_U_Role ='Executive Director-CFO')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
End    
else if(@COA_U_Role ='Chief Strategy Officer')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
End    
else if(@COA_U_Role ='CMD')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'    
End    


End    

else if(@COA_Category = 'CSO')    
Begin    

if(@COA_U_Role = 'Head' and @COA_Department = 'IT')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@COA_U_Role ='Executive Director')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@COA_U_Role ='Executive Director-CFO')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@COA_U_Role ='Chief Strategy Officer')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
End    
else if(@COA_U_Role ='CMD')    
Begin    
Insert into tbl_RequestRecApr    
Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))  and [Status] = 'A'    
End    


End    

FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department    

End    
Close OApr    
deallocate OApr     

----------------------------------------------------------------------------------------------------------    


Select @Request_Id As [Request_Id]    




End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_Approval_N_New
-- --------------------------------------------------

/*
USP_ITRequestMaster_Approval_N_New 'BRANCH','A','E39377'

*/
CREATE Procedure [dbo].[USP_ITRequestMaster_Approval_N_New]                      
(@Accesscode char(25),@Type varchar(5),@UserID varchar(15))                       
as                      
Begin     


   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
                 
                      
Declare @Query as nvarchar(max)                      
                      
                      
                      
set @Query= 'select a.* into #directcases from
(select * from tbl_RequestMaster where status_code=''P'') a inner join 
(select * from tbl_RequestRecApr where role=''A'' and request_id not in (select request_id from tbl_RequestRecApr b where b.role=''R''))b
on a.request_id=b.request_id where Request_date>=''2013-10-01 15:38:30.293'';
select Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],          
A.Estimated_Total_Price as[Estimated_Total_Price],          
D.Emp_Name As [Requested_By],D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],          
D.Department As[Department],D.Sr_Name As[HOD],A.User_Remark As [User_Remark],          
A.Estimated_Total_Price as EstimatedTotal,f.Remark as [Review Remark],f.ReviewDate as [Review Date]         
--,F.Status_Name As [Status_Name]          
from tbl_RequestMaster A          
Left Outer Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code          
Left Outer Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id          
inner join          
(Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info          
UNION ALL          
Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D          
on A.Requested_By = D.emp_no          
Left Outer Join tbl_RequestRecApr E on A.Request_Id = E.Request_Id          
   inner join Tbl_ReviewRemarks F on A.Request_Id = F.Request_Id  
where E.Emp_Code = '''+@UserID+''' And E.Role = ''A''          
and ISNULL(A.Approved_By,'''') <> '''+ @UserID +'''      
 and   A.Status_Code in (''R'',''L1A'')       
and E.Emp_Code <> A.Requested_By 
union
select Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],          
A.Estimated_Total_Price as[Estimated_Total_Price],          
D.Emp_Name As [Requested_By],D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],          
D.Department As[Department],D.Sr_Name As[HOD],A.User_Remark As [User_Remark],          
A.Estimated_Total_Price as EstimatedTotal,f.Remark as [Review Remark],f.ReviewDate as [Review Date]                    
--,F.Status_Name As [Status_Name]          
from #directcases A          
Left Outer Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code          
Left Outer Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id          
inner join          
(Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info          
UNION ALL          
Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D          
on A.Requested_By = D.emp_no          
Left Outer Join tbl_RequestRecApr E on A.Request_Id = E.Request_Id
   inner join Tbl_ReviewRemarks F on A.Request_Id = F.Request_Id            
where E.Emp_Code = '''+@UserID+''' And E.Role = ''A''          
and ISNULL(A.Approved_By,'''') <> '''+ @UserID +'''      
 and   A.Status_Code in (''P'')       
and E.Emp_Code <> A.Requested_By 
'          
                  
if ( @Type='A')                      
 begin                       
  if(@Accesscode='Branch')                      
                      
   Begin                      
    Set @Query = @Query + ' And D.Branch_Cd not in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'                         
    Print(@Query)                      
    Exec(@Query)                        
                      
   End                      
                      
    else if(@AccessCode='CSO')                      
    Begin                      
    Set @Query = @Query + ' And D.Branch_Cd  in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'                         
    Print(@Query)                      
    Exec(@Query)                       
    End                      
                      
  End             
End                      
---------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_Approval_N_New_bk_29Dec2017
-- --------------------------------------------------
create Procedure [dbo].[USP_ITRequestMaster_Approval_N_New_bk_29Dec2017]                      
(@Accesscode char(25),@Type varchar(5),@UserID varchar(15))                       
as                      
Begin     


   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
                 
                      
Declare @Query as nvarchar(max)                      
                      
                      
                      
set @Query= 'select a.* into #directcases from
(select * from tbl_RequestMaster where status_code=''P'') a inner join 
(select * from tbl_RequestRecApr where role=''A'' and request_id not in (select request_id from tbl_RequestRecApr b where b.role=''R''))b
on a.request_id=b.request_id where Request_date>=''2013-10-01 15:38:30.293'';
select Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],          
A.Estimated_Total_Price as[Estimated_Total_Price],          
D.Emp_Name As [Requested_By],D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],          
D.Department As[Department],D.Sr_Name As[HOD],A.User_Remark As [User_Remark],          
A.Estimated_Total_Price as EstimatedTotal           
--,F.Status_Name As [Status_Name]          
from tbl_RequestMaster A          
Left Outer Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code          
Left Outer Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id          
inner join          
(Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info          
UNION ALL          
Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D          
on A.Requested_By = D.emp_no          
Left Outer Join tbl_RequestRecApr E on A.Request_Id = E.Request_Id          
where E.Emp_Code = '''+@UserID+''' And E.Role = ''A''          
and ISNULL(A.Approved_By,'''') <> '''+ @UserID +'''      
 and   A.Status_Code in (''R'',''L1A'')       
and E.Emp_Code <> A.Requested_By 
union
select Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],          
A.Estimated_Total_Price as[Estimated_Total_Price],          
D.Emp_Name As [Requested_By],D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],          
D.Department As[Department],D.Sr_Name As[HOD],A.User_Remark As [User_Remark],          
A.Estimated_Total_Price as EstimatedTotal           
--,F.Status_Name As [Status_Name]          
from #directcases A          
Left Outer Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code          
Left Outer Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id          
inner join          
(Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info          
UNION ALL          
Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D          
on A.Requested_By = D.emp_no          
Left Outer Join tbl_RequestRecApr E on A.Request_Id = E.Request_Id          
where E.Emp_Code = '''+@UserID+''' And E.Role = ''A''          
and ISNULL(A.Approved_By,'''') <> '''+ @UserID +'''      
 and   A.Status_Code in (''P'')       
and E.Emp_Code <> A.Requested_By 
'          
                  
if ( @Type='A')                      
 begin                       
  if(@Accesscode='Branch')                      
                      
   Begin                      
    Set @Query = @Query + ' And D.Branch_Cd not in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'                         
    --Print(@Query)                      
    Exec(@Query)                        
                      
   End                      
                      
    else if(@AccessCode='CSO')                      
    Begin                      
    Set @Query = @Query + ' And D.Branch_Cd  in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'                         
    Print(@Query)                      
    Exec(@Query)                       
    End                      
                      
  End             
End                      
---------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_Approval_N_New27Nov2018
-- --------------------------------------------------

/*
USP_ITRequestMaster_Approval_N_New 'BRANCH','A','E39377'

*/
CREATE Procedure [dbo].[USP_ITRequestMaster_Approval_N_New27Nov2018]                      
(@Accesscode char(25),@Type varchar(5),@UserID varchar(15))                       
as                      
Begin     


   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
                 
                      
Declare @Query as nvarchar(max)                      
                      
                      
                      
set @Query= 'select a.* into #directcases from
(select * from tbl_RequestMaster where status_code=''P'') a inner join 
(select * from tbl_RequestRecApr where role=''A'' and request_id not in (select request_id from tbl_RequestRecApr b where b.role=''R''))b
on a.request_id=b.request_id where Request_date>=''2013-10-01 15:38:30.293'';
select Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],          
A.Estimated_Total_Price as[Estimated_Total_Price],          
D.Emp_Name As [Requested_By],D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],          
D.Department As[Department],D.Sr_Name As[HOD],A.User_Remark As [User_Remark],          
A.Estimated_Total_Price as EstimatedTotal,f.Remark as [Review Remark],f.ReviewDate as [Review Date]         
--,F.Status_Name As [Status_Name]          
from tbl_RequestMaster A          
Left Outer Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code          
Left Outer Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id          
inner join          
(Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info          
UNION ALL          
Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D          
on A.Requested_By = D.emp_no          
Left Outer Join tbl_RequestRecApr E on A.Request_Id = E.Request_Id          
   inner join Tbl_ReviewRemarks F on A.Request_Id = F.Request_Id  
where E.Emp_Code = '''+@UserID+''' And E.Role = ''A''          
and ISNULL(A.Approved_By,'''') <> '''+ @UserID +'''      
 and   A.Status_Code in (''R'',''L1A'')       
and E.Emp_Code <> A.Requested_By 
union
select Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],          
A.Estimated_Total_Price as[Estimated_Total_Price],          
D.Emp_Name As [Requested_By],D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],          
D.Department As[Department],D.Sr_Name As[HOD],A.User_Remark As [User_Remark],          
A.Estimated_Total_Price as EstimatedTotal,f.Remark as [Review Remark],f.ReviewDate as [Review Date]                    
--,F.Status_Name As [Status_Name]          
from #directcases A          
Left Outer Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code          
Left Outer Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id          
inner join          
(Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info          
UNION ALL          
Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D          
on A.Requested_By = D.emp_no          
Left Outer Join tbl_RequestRecApr E on A.Request_Id = E.Request_Id
   inner join Tbl_ReviewRemarks F on A.Request_Id = F.Request_Id            
where E.Emp_Code = '''+@UserID+''' And E.Role = ''A''          
and ISNULL(A.Approved_By,'''') <> '''+ @UserID +'''      
 and   A.Status_Code in (''P'')       
and E.Emp_Code <> A.Requested_By 
'          
                  
if ( @Type='A')                      
 begin                       
  if(@Accesscode='Branch')                      
                      
   Begin                      
    Set @Query = @Query + ' And D.Branch_Cd not in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'             
    Print(@Query)                      
    Exec(@Query)                        
                      
   End                      
                      
    else if(@AccessCode='CSO')                      
    Begin                      
    Set @Query = @Query + ' And D.Branch_Cd  in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'                         
    Print(@Query)                      
    Exec(@Query)                       
    End                      
                      
  End             
End                      
---------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_New
-- --------------------------------------------------
                  
---[USP_ITRequestMaster]   null,'100022','200075','1','E57616','System get Hang & Jammed every time.','1',2250                     
                  
CREATE Proc [dbo].[USP_ITRequestMaster_New]          
(                                 
 @IT_Engineer char(10),                                                                                                                                                                                                                       
 @Item_Code char(10),                                                                                                                                                                                           
 @Model_No char(10),                                                                                                                                             
 @Model_Quantity char(10),                                                                                                                                                                                  
 @Requested_By varchar(8),                                                                                                 
 @User_Remark varchar(200),                                                                                                                                                  
 @Justification_Id char(10),                                   
 @Estimated_Total_Price int,          
 @Request_Id int                                                                                                                                                      
)                                                                                                                    
as                                                                                
Begin             
            
            
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
                             
                                
--  Declare @CSO  bit                              
  Declare @Status_Code char(10)                              
  Declare @Request_Date DateTime                              
  Declare @Model_Quantity_Assigned As char(10)                              
                              
                              
set @Request_Date= getdate()                                  
set @Status_Code='P'                              
set @Model_Quantity_Assigned='0'                              
                              
                              
                               
                               
-----------first Make an entry in tbl_RequestMaster----------                              
                              
 -- insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,                              
 --        Justification_id,CSO,Status_Code,Estimated_Total_Price,Model_Quantity_Assigned)                              
                                          
 --values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,                              
 --   @Justification_Id,'false',@Status_Code,@Estimated_Total_Price,@Model_Quantity_Assigned)            
 update tbl_RequestMaster        
 set  Status_Code = 'P'        
 where Request_Id = @Request_Id        
                                                                        
------------------------------------------------                              
                              
--get current request_id                              
--commented by suraj start          
 --Declare @Request_Id int                     
--commented by suraj start          
 --getbranchcode of Requester                              
  Declare @RequesterBrCd nvarchar(255)                              
--onbasis of branchcode of Requester decide whether he belongs to Branch OR CSO Category                              
  Declare @Category char(20)                              
--get Designation of the Requester                              
  Declare @Designation varchar(255)                              
--get department of the requester                              
Declare @Department nvarchar(200)                              
--get Sub_Department of the requester                              
  Declare @Sub_Department varchar(150)                              
                              
--Set @Request_Id = (select max(Request_Id) As Request_Id from tbl_RequestMaster  where Requested_By = @Requested_By)                  
                
set @RequesterBrCd = (select Branch_Cd from Emp_Info where Emp_No = @Requested_By)                     
                              
 if(@RequesterBrCd not in(select branch_cd from tbl_CSO_Branch(nolock)) )                              
  Begin                              
   Set @Category = 'BRANCH'                              
  End                   

 else if (@RequesterBrCd in (select branch_cd from tbl_CSO_Branch(nolock)) )                              
  Begin                              
   Set @Category = 'CSO'                              
  End                              
                              
Set @Designation = (Select Designation from emp_info where Emp_No = @Requested_By)                              
                              
Set @Department = (Select Department from emp_info where Emp_No = @Requested_By)                              
                              
Set @Sub_Department = (Select Sub_Department from emp_info where Emp_No = @Requested_By)                              
                              
----                              
Declare @SrAVPIT varchar(20)                              
Declare @HeadIT varchar(20)                              
Declare @ADIT varchar(20)                             
Declare @ED varchar(20)                              
Declare @EDCFO varchar(20)                              
Declare @CSO varchar(20)                              
                              
Set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree Where Emp_Id = @Requested_By)                              
--Set @HeadIT = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                              
--Set @HeadIT = case when @Estimated_Total_Price <= 50000 then 'E69243' else 'E63575' end  
Set @HeadIT = 'E69242'

Set @ADIT = (Select ADIT from tbl_EmpTree Where Emp_Id = @Requested_By)                              
Set @ED = (Select ED from tbl_EmpTree Where Emp_Id = @Requested_By)                              
Set @EDCFO = (Select EDCFO from tbl_EmpTree Where Emp_Id = @Requested_By)                              
Set @CSO = (Select CSO from tbl_EmpTree Where Emp_Id = @Requested_By)                              
----                              
                              
                              
----------------get Recommenders------------------------                              
                  select U_Role,Category,Department into #Recommenders                              
                  from tbl_Recommendation_LimitMaster_new                              
                  where @Estimated_Total_Price between Rec_limitFrom and Rec_LimitTo                              
                 And Category=@Category                              
                              
                  -- Select * from #Recommenders                                        
                   
                  
    --Cursor                               
       Declare @CR_U_Role varchar(50)                              
    Declare @CR_Category varchar(50)                              
    Declare @CR_Department varchar(50)                              
    --Declare @Request_Id_Rec int                              
    --Declare @Recommender varchar(25)                              
    Declare Rec Cursor for                              
    Select * from #Recommenders                              
                              
                            
    OPEN Rec                              
    FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                              
    While(@@fetch_status=0)                              
      Begin                              
                              
       --Set @Request_Id_Rec = ''                   
       --Set @Recommender = ''                              
                                    
       print 'Recommended'                         
       print @CR_U_Role                              
       print @CR_Category            
       print @CR_Department                              
                              
       if(@CR_Category = 'BRANCH')                              
        Begin                                
                                    
         if(@CR_U_Role = 'DepartmentHOD')                   
          Begin                                     
           Exec USP_GetRecApr_new 'R',@Category,'DepartmentHOD',@Request_Id,@Requested_By                                    
                                
          End       
                                                
         else if(@CR_U_Role = 'CIO')                              
          Begin                              
           Exec USP_GetRecApr_new 'R',@Category,'CIO',@Request_Id,@Requested_By                              
          End                              
         else if(@CR_U_Role = 'CEO')                              
          Begin                              
           Exec USP_GetRecApr_new 'R',@Category,'CEO',@Request_Id,@Requested_By                                      
        End                                  
		else if(@CR_U_Role = 'Director')                              
          Begin                              
           Exec USP_GetRecApr_new 'R',@Category,'Director',@Request_Id,@Requested_By                              
          End                              

                     
        -- else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')                              
        --  Begin                              
        --   --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                              
        --   -- Begin                              
        --    if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
        --    Begin                              
        --     Insert into tbl_RequestRecApr                              
        --     Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                              
        --    End                              
        --   -- End                                       
                                        
        --  End                              
        -- else if(@CR_U_Role = 'Executive Director')                              
        --  Begin                              
        --   --if(@Requested_By ='P00104')                              
        --   -- Begin                              
        --    if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')                              
        --    Begin                              
        --     Insert into tbl_RequestRecApr                              
        --     Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By                                
        --    End                              
        --   -- End                              
        --   End                              
        -- else if(@CR_U_Role = 'Executive Director-CFO')                              
        --  Begin                              
        --   --if(@Requested_By ='P00104')          
        --   -- Begin                              
        --    if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
        --    Begin                              
        --     Insert into tbl_RequestRecApr                                     Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                               
        --    End                               
        --   -- End                                    
        --  End                              
        -- else if(@CR_U_Role = 'Chief Strategy Officer')                              
        --  Begin                              
        --   --if(@Requested_By ='P00104')                              
        --   -- Begin                              
        --    if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')                              
        --    Begin                              
        --     Insert into tbl_RequestRecApr                              
        --     Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                          
        --    End                              
        --   -- End                              
        -- End                              
        End                              
                              
       else if (@CR_Category = 'CSO')                              
        Begin                              
                              
         if(@CR_U_Role = 'DepartmentHOD')                   
          Begin                                     
           Exec USP_GetRecApr_new 'R',@Category,'DepartmentHOD',@Request_Id,@Requested_By                                    
                                
          End       
                                                
         else if(@CR_U_Role = 'CIO')                              
          Begin                              
           Exec USP_GetRecApr_new 'R',@Category,'CIO',@Request_Id,@Requested_By                              
          End                              
         else if(@CR_U_Role = 'CEO')                              
          Begin                              
           Exec USP_GetRecApr_new 'R',@Category,'CEO',@Request_Id,@Requested_By                                      
        End                                  
		else if(@CR_U_Role = 'Director')                              
          Begin                              
           Exec USP_GetRecApr_new 'R',@Category,'Director',@Request_Id,@Requested_By                              
          End                               
                              
                              
        End                                     
                              
         FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                              
                                                          
      End                              
                                
   Close Rec                              
   deallocate Rec                               
            
                                         
                                                          
                              
----------------------------------------------------------------------------------------------------------------                              
                              
---------------get Approver--------------------------------                             
                              
   Select U_Role,Category,Department into #Approver                              
   From tbl_Approval_LimitMaster                              
   Where @Estimated_Total_Price Between Apr_LimitFrom and Apr_LimitTo                              
   And Category = @Category                              
                              
                  -- Select * from #Approver                                               
    --Cursor                               
       Declare @CA_U_Role varchar(50)                              
    Declare @CA_Category varchar(50)           
    Declare @CA_Department varchar(50)                              
    --Declare @Request_Id_Apr int                              
    --Declare @Approver varchar(25)                              
                              
    Declare Apr Cursor for                              
    Select * from #Approver                              
                              
                              
    OPEN Apr                              
    FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                              
    While(@@fetch_status=0)                              
      Begin                              
       --Set @Request_Id_Rec = ''                              
--       print @CA_U_Role                              
--       print @CA_Category                              
--   print @CA_Department                              
                              
       if(@CA_Category = 'BRANCH')                              
        Begin                              
                              
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
   Insert into tbl_RequestRecApr                              
            Select @Request_Id,@HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
          End                              
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                              
          Begin                              
           --select * from emp_info where emp_no ='P00104'                              
           --OR                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
                                         
          End                              
         else if(@CA_U_Role ='Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                              
           Begin         
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
                              
          End                              
       else if(@CA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                   
            Insert into tbl_RequestRecApr                              
     Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
          End                              
         else if(@CA_U_Role ='Chief Strategy Officer')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
         Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                               
          End                              
         else if(@CA_U_Role ='CMD')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Insert into tbl_RequestRecApr                              
           Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'                              
          End                              
                                
                              
        End                              
                              
else if(@CA_Category = 'CSO')                              
        Begin                              
                              
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,@HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
        End                              
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                           
            Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='Chief Strategy Officer')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='CMD')                              
          Begin                              
 if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                              
           End                              
          End                              
                              
                          
      End                              
                               
         FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                              
                              
      End                              
   Close Apr                              
   deallocate Apr                               
                            
                              
----------------get OTHERS Recommenders ------------------------                              
                  select U_Role,Category,Department into #OtherRecommenders                              
                  from tbl_Recommendation_LimitMaster                              
                  where @Estimated_Total_Price between B_ReclimitFrom and B_RecLimitTo                              
   And Category=@Category                              
                              
 -- Select * from #OtherRecommenders                                        
                                                       
                              
                                         
    --Cursor                               
       Declare @COR_U_Role varchar(50)                              
    Declare @COR_Category varchar(50)                              
    Declare @COR_Department varchar(50)                            
    --Declare @Request_Id_Rec int                              
    --Declare @Recommender varchar(25)                          
    Declare ORec Cursor for                              
    Select * from #OtherRecommenders                              
                              
                              
    OPEN ORec                              
    FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                              
    While(@@fetch_status=0)                              
      Begin                              
                              
       --Set @Request_Id_Rec = ''                              
       --Set @Recommender = ''                              
              
--                              
       print @COR_U_Role                              
       print @COR_Category                              
       print @COR_Department             
                              
       if(@COR_Category = 'BRANCH')                              
        Begin                                
                                    
         if(@COR_U_Role = 'Branch Head')                              
          Begin                                     
           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                                    
                                
          End                              
--         else if(@COR_U_Role = 'Branch Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                                                         
--          End                               
         else if(@COR_U_Role = 'Cluster Head')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'ClusterHead',@Request_Id,@Requested_By                              
          End                              
         else if(@COR_U_Role = 'Zonal Head')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                                      
          End                              
--         else if(@COR_U_Role = 'Zonal Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                                             
--          End                              
         else if(@COR_U_Role = 'Regional Head')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                              
          End                              
--         else if(@CR_U_Role = 'Regional Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                   
--          End                              
         else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                              
          Begin                              
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                              
           -- Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                                       
                                        
          End                              
         else if(@COR_U_Role = 'Executive Director')                      
          Begin                        
           --if(@Requested_By ='P00104')                              
           -- Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                              
           End                              
         else if(@COR_U_Role = 'Executive Director-CFO')                              
          Begin                              
           --if(@Requested_By ='P00104')                              
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                        
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                         
          End                              
         else if(@COR_U_Role = 'Chief Strategy Officer')                              
          Begin                              
           --if(@Requested_By ='P00104')                              
           -- Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                              
         End                              
        End                              
                              
       else if (@COR_Category = 'CSO')                              
        Begin                              
                              
         if(@COR_U_Role = 'A.V.P.')                        
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By                              
          End                
--         else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'ALL')                              
--          Begin                               
--   DoNothing                                      
--          End                              
         else if(@COR_U_Role = 'Vice President' OR @COR_U_Role = 'Sr. Vice President')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By                              
          End                              
--         else if(@COR_U_Role = 'Sr. Vice President')                              
--          Begin                              
--           DoNothing                                       
--          End                              
        else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'OR' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
        else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                                End                              
          End                              
        else if(@COR_U_Role = 'Associate Director')                              
          Begin                              
                                         
           --select * from emp_info where emp_no ='P00104'                              
           --OR                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OR' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                              
           End                              
          End                              
        else if(@COR_U_Role = 'Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
    End                              
          End               
        else if(@COR_U_Role = 'Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
        else if(@COR_U_Role = 'Chief Strategy Officer')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
                              
                              
        End                                     
                              
         FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                              
                              
                              
      End                              
                                
   Close ORec                              
   deallocate ORec                               
                                          
                              
----------------------------------------------------------------------------------------------------------------                              
                              
---------------get OTHER Approver--------------------------------                              
                              
   Select U_Role,Category,Department into #OtherApprover                              
   From tbl_Approval_LimitMaster                              
   Where @Estimated_Total_Price Between B_AprLimitFrom and B_AprLimitTo                            
   And Category = @Category                              
                              
                  -- Select * from #OtherApprover                                               
    --Cursor                               
       Declare @COA_U_Role varchar(50)                              
    Declare @COA_Category varchar(50)                              
    Declare @COA_Department varchar(50)                              
    --Declare @Request_Id_Apr int                              
    --Declare @Approver varchar(25)                              
                              
    Declare OApr Cursor for                              
    Select * from #OtherApprover                              
                              
                              
    OPEN OApr                              
    FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                              
    While(@@fetch_status=0)                              
      Begin                              
       --Set @Request_Id_Rec = ''                              
       print @COA_U_Role                              
       print @COA_Category                              
       print @COA_Department                              
                              
  if(@COA_Category = 'BRANCH')                              
        Begin                              
                  
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
          End                              
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                              
          Begin                              
           --select * from emp_info where emp_no ='P00104'                              
           --OR                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
                      
          End                      
         else if(@COA_U_Role ='Executive Director')                              
          Begin                              
          if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
          End                              
         else if(@COA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
End                              
         else if(@COA_U_Role ='Chief Strategy Officer')                              
Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
End                              
          End                              
         else if(@COA_U_Role ='CMD')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'           
           End                              
          End                              
                                
                              
        End                              
                              else if(@COA_Category = 'CSO')                              
        Begin                              
                              
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
     Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                  
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
 else if(@COA_U_Role ='Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@COA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                               
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@COA_U_Role ='Chief Strategy Officer')                              
          Begin                              
     if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
  End                              
         else if(@COA_U_Role ='CMD')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
   Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                              
           End                             
          End                              
                              
                              
        End                              
                               
         FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                              
                              
      End                              
   Close OApr                              
   deallocate OApr                               
                                          
----------------------------------------------------------------------------------------------------------                              
                            
            
  --added by sandeep on 09 Apr 2015 for depository--            
       declare @cnt int ,@SubDepartment varchar(50)                   
       set @SubDepartment=(select sub_department from emp_info with(nolock) where emp_no=@Requested_By)            
       if(@SubDepartment='Depository')            
       Begin            
        Insert into tbl_RequestRecApr            
        select @Request_Id,'P00235','R'            
           
        --replaced by suraj start           
        --Insert into tbl_RequestRecApr            
        --select @Request_Id,'E63575','A'  
        if @Estimated_Total_Price <= 50000  
  begin  
   Insert into tbl_RequestRecApr              
   select @Request_Id,'E69243','A'              
        end  
        else  
        begin  
   Insert into tbl_RequestRecApr              
   select @Request_Id,'E63575','A'              
        end  
        
                    
       End            
                   
                                       
      
                   
       --Ended by sandeep                    
                              
--Select @Request_Id As [Request_Id]                              
                 
Select @Request_Id As [Request_Id]                          
             
declare @Request_Id1 nvarchar(max)                          
Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster where Requested_By = @Requested_By)                 
                
EXECUTE Usp_Mailer_Options '1',@Request_Id1                              
                                                                                                                                             
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_New_10Jul2018
-- --------------------------------------------------
                  
---[USP_ITRequestMaster]   null,'100022','200075','1','E57616','System get Hang & Jammed every time.','1',2250                     
                  
Create Proc [dbo].[USP_ITRequestMaster_New_10Jul2018]          
(                                 
 @IT_Engineer char(10),                                                                                                                                                                                                                       
 @Item_Code char(10),                                                                                                                                                                                           
 @Model_No char(10),                                                                                                                                             
 @Model_Quantity char(10),                                                                                                                                                                                  
 @Requested_By varchar(8),                                                                                                 
 @User_Remark varchar(200),                                                                                                                                                  
 @Justification_Id char(10),                                   
 @Estimated_Total_Price int,          
 @Request_Id int                                                                                                                                                      
)                                                                                                                    
as                                                                                
Begin             
            
            
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
                             
                                
--  Declare @CSO  bit                              
  Declare @Status_Code char(10)                              
  Declare @Request_Date DateTime                              
  Declare @Model_Quantity_Assigned As char(10)                              
                              
                              
set @Request_Date= getdate()                                  
set @Status_Code='P'                              
set @Model_Quantity_Assigned='0'                              
                              
                              
                               
                               
-----------first Make an entry in tbl_RequestMaster----------                              
                              
 -- insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,                              
 --        Justification_id,CSO,Status_Code,Estimated_Total_Price,Model_Quantity_Assigned)                              
                                          
 --values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,                              
 --   @Justification_Id,'false',@Status_Code,@Estimated_Total_Price,@Model_Quantity_Assigned)            
 update tbl_RequestMaster        
 set  Status_Code = 'P'        
 where Request_Id = @Request_Id        
                                                                        
------------------------------------------------                              
                              
--get current request_id                              
--commented by suraj start          
 --Declare @Request_Id int                     
--commented by suraj start          
 --getbranchcode of Requester                              
  Declare @RequesterBrCd nvarchar(255)                              
--onbasis of branchcode of Requester decide whether he belongs to Branch OR CSO Category                              
  Declare @Category char(20)                              
--get Designation of the Requester                              
  Declare @Designation varchar(255)                              
--get department of the requester                              
Declare @Department nvarchar(200)                              
--get Sub_Department of the requester                              
  Declare @Sub_Department varchar(150)                              
                              
--Set @Request_Id = (select max(Request_Id) As Request_Id from tbl_RequestMaster  where Requested_By = @Requested_By)                  
                
set @RequesterBrCd = (select Branch_Cd from Emp_Info where Emp_No = @Requested_By)                     
                              
 if(@RequesterBrCd not in(select branch_cd from tbl_CSO_Branch(nolock)) )                              
  Begin                              
   Set @Category = 'BRANCH'                              
  End                   
                              
 else if (@RequesterBrCd in (select branch_cd from tbl_CSO_Branch(nolock)) )                              
  Begin                              
   Set @Category = 'CSO'                              
  End                              
                              
Set @Designation = (Select Designation from emp_info where Emp_No = @Requested_By)                              
                              
Set @Department = (Select Department from emp_info where Emp_No = @Requested_By)                              
                              
Set @Sub_Department = (Select Sub_Department from emp_info where Emp_No = @Requested_By)                              
                              
----                              
Declare @SrAVPIT varchar(20)                              
Declare @HeadIT varchar(20)                              
Declare @ADIT varchar(20)                             
Declare @ED varchar(20)                              
Declare @EDCFO varchar(20)                              
Declare @CSO varchar(20)                              
                              
Set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree Where Emp_Id = @Requested_By)                              
--Set @HeadIT = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                              
--Set @HeadIT = case when @Estimated_Total_Price <= 50000 then 'E69243' else 'E63575' end  
Set @HeadIT = 'E69242'

Set @ADIT = (Select ADIT from tbl_EmpTree Where Emp_Id = @Requested_By)                              
Set @ED = (Select ED from tbl_EmpTree Where Emp_Id = @Requested_By)                              
Set @EDCFO = (Select EDCFO from tbl_EmpTree Where Emp_Id = @Requested_By)                              
Set @CSO = (Select CSO from tbl_EmpTree Where Emp_Id = @Requested_By)                              
----                              
                              
                              
----------------get Recommenders------------------------                              
                  select U_Role,Category,Department into #Recommenders                              
                  from tbl_Recommendation_LimitMaster                              
                  where @Estimated_Total_Price between Rec_limitFrom and Rec_LimitTo                              
                 And Category=@Category                              
                              
                  -- Select * from #Recommenders                                        
                   
                  
    --Cursor                               
       Declare @CR_U_Role varchar(50)                              
    Declare @CR_Category varchar(50)                              
    Declare @CR_Department varchar(50)                              
    --Declare @Request_Id_Rec int                              
    --Declare @Recommender varchar(25)                              
    Declare Rec Cursor for                              
    Select * from #Recommenders                              
                              
                            
    OPEN Rec                              
    FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                              
    While(@@fetch_status=0)                              
      Begin                              
                              
       --Set @Request_Id_Rec = ''                   
       --Set @Recommender = ''                              
                                    
       print 'Recommended'                         
       print @CR_U_Role                              
       print @CR_Category            
       print @CR_Department                              
                              
       if(@CR_Category = 'BRANCH')                              
        Begin                                
                                    
         if(@CR_U_Role = 'Branch Head')                   
          Begin                                     
           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By                                    
                                
          End                              
--         else if(@CR_U_Role = 'Branch Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By                                      
--          End                               
         else if(@CR_U_Role = 'Cluster Head')                              
          Begin                              
           Exec USP_GetRecApr 'R',@Category,'ClusterHead',@Request_Id,@Requested_By                              
          End                              
         else if(@CR_U_Role = 'Zonal Head')                              
          Begin                              
           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                                      
        End                              
--         else if(@CR_U_Role = 'Zonal Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                                             
--          End                                      
    else if(@CR_U_Role = 'Regional Head')                              
          Begin                              
           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By                              
          End                              
--         else if(@CR_U_Role = 'Regional Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By                                     
--          End                      
         else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')                              
          Begin                              
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                              
           -- Begin                              
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
            Begin                              
             Insert into tbl_RequestRecApr                              
             Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                              
            End                              
           -- End                                       
                                        
          End                              
         else if(@CR_U_Role = 'Executive Director')                              
          Begin                              
           --if(@Requested_By ='P00104')                              
           -- Begin                              
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')                              
            Begin                              
             Insert into tbl_RequestRecApr                              
             Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By                                
            End                              
           -- End                              
           End                              
         else if(@CR_U_Role = 'Executive Director-CFO')                              
          Begin                              
           --if(@Requested_By ='P00104')          
           -- Begin                              
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
            Begin                              
             Insert into tbl_RequestRecApr                                     Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                               
            End                               
           -- End                                    
          End                              
         else if(@CR_U_Role = 'Chief Strategy Officer')                              
          Begin                              
           --if(@Requested_By ='P00104')                              
           -- Begin                              
            if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')                              
            Begin                              
             Insert into tbl_RequestRecApr                              
             Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                          
            End                              
           -- End                              
         End                              
        End                              
                              
       else if (@CR_Category = 'CSO')                              
        Begin                              
                              
         if(@CR_U_Role = 'A.V.P.')                              
          Begin                              
           --if HOD should also see the request then add  HOD here.             
           print 'USP_GetRecApr'            
           Exec USP_GetRecApr 'R',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By                              
                              
          End                              
--         else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'ALL')                              
--          Begin                               
--           ---DoNothing                                 
--          End                              
         else if(@CR_U_Role = 'Vice President')                              
          Begin                              
           --if HOD should also see the request then add  HOD here.                               
           Exec USP_GetRecApr 'R',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By                              
          End                              
--         else if(@CR_U_Role = 'Sr. Vice President')                              
--          Begin                              
--           --DoNothing                                       
--          End                              
        else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'IT')                              
          Begin                              
        if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'R' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                     
          End                              
        else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
        else if(@CR_U_Role = 'Associate Director')                              
     Begin                              
                                         
    --select * from emp_info where emp_no ='P00104'                              
           --OR                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'R' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                   
          End                              
          End                              
        else if(@CR_U_Role = 'Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
       Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
        else if(@CR_U_Role = 'Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                    
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
        else if(@CR_U_Role = 'Chief Strategy Officer')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')                              
         Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
                              
                              
        End                                     
                              
         FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                              
                                                          
      End                              
                                
   Close Rec                              
   deallocate Rec                               
            
                                         
                                                          
                              
----------------------------------------------------------------------------------------------------------------                              
                              
---------------get Approver--------------------------------                             
                              
   Select U_Role,Category,Department into #Approver                              
   From tbl_Approval_LimitMaster                              
   Where @Estimated_Total_Price Between Apr_LimitFrom and Apr_LimitTo                              
   And Category = @Category                              
                              
                  -- Select * from #Approver                                               
    --Cursor                               
       Declare @CA_U_Role varchar(50)                              
    Declare @CA_Category varchar(50)           
    Declare @CA_Department varchar(50)                              
    --Declare @Request_Id_Apr int                              
    --Declare @Approver varchar(25)                              
                              
    Declare Apr Cursor for                              
    Select * from #Approver                              
                              
                              
    OPEN Apr                              
    FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                              
    While(@@fetch_status=0)                              
      Begin                              
       --Set @Request_Id_Rec = ''                              
--       print @CA_U_Role                              
--       print @CA_Category                              
--   print @CA_Department                              
                              
       if(@CA_Category = 'BRANCH')                              
        Begin                              
                              
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
   Insert into tbl_RequestRecApr                              
            Select @Request_Id,@HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
          End                              
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                              
          Begin                              
           --select * from emp_info where emp_no ='P00104'                              
           --OR                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
                                         
          End                              
         else if(@CA_U_Role ='Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                              
           Begin         
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
                              
          End                              
       else if(@CA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                   
            Insert into tbl_RequestRecApr                              
     Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
          End                              
         else if(@CA_U_Role ='Chief Strategy Officer')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
         Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                               
          End                              
         else if(@CA_U_Role ='CMD')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Insert into tbl_RequestRecApr                              
           Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'                              
          End                              
                                
                              
        End                              
                              
else if(@CA_Category = 'CSO')                              
        Begin                              
                              
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,@HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
        End                              
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                           
            Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='Chief Strategy Officer')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='CMD')                              
          Begin                              
 if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                              
           End                              
          End                              
                              
                          
      End                              
                               
         FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                              
                              
      End                              
   Close Apr                              
   deallocate Apr                               
                            
                              
----------------get OTHERS Recommenders ------------------------                              
                  select U_Role,Category,Department into #OtherRecommenders                              
                  from tbl_Recommendation_LimitMaster                              
                  where @Estimated_Total_Price between B_ReclimitFrom and B_RecLimitTo                              
   And Category=@Category                              
                              
 -- Select * from #OtherRecommenders                                        
                                                       
                              
                                         
    --Cursor                               
       Declare @COR_U_Role varchar(50)                              
    Declare @COR_Category varchar(50)                              
    Declare @COR_Department varchar(50)                            
    --Declare @Request_Id_Rec int                              
    --Declare @Recommender varchar(25)                          
    Declare ORec Cursor for                              
    Select * from #OtherRecommenders                              
                              
                              
    OPEN ORec                              
    FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                              
    While(@@fetch_status=0)                              
      Begin                              
                              
       --Set @Request_Id_Rec = ''                              
       --Set @Recommender = ''                              
              
--                              
       print @COR_U_Role                              
       print @COR_Category                              
       print @COR_Department             
                              
       if(@COR_Category = 'BRANCH')                              
        Begin                                
                                    
         if(@COR_U_Role = 'Branch Head')                              
          Begin                                     
           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                                    
                                
          End                              
--         else if(@COR_U_Role = 'Branch Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                                                         
--          End                               
         else if(@COR_U_Role = 'Cluster Head')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'ClusterHead',@Request_Id,@Requested_By                              
          End                              
         else if(@COR_U_Role = 'Zonal Head')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                                      
          End                              
--         else if(@COR_U_Role = 'Zonal Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                                             
--          End                              
         else if(@COR_U_Role = 'Regional Head')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                              
          End                              
--         else if(@CR_U_Role = 'Regional Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                   
--          End                              
         else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                              
          Begin                              
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                              
           -- Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                                       
                                        
          End                              
         else if(@COR_U_Role = 'Executive Director')                      
          Begin                        
           --if(@Requested_By ='P00104')                              
           -- Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                              
           End                              
         else if(@COR_U_Role = 'Executive Director-CFO')                              
          Begin                              
           --if(@Requested_By ='P00104')                              
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                        
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                         
          End                              
         else if(@COR_U_Role = 'Chief Strategy Officer')                              
          Begin                              
           --if(@Requested_By ='P00104')                              
           -- Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                              
         End                              
        End                              
                              
       else if (@COR_Category = 'CSO')                              
        Begin                              
                              
         if(@COR_U_Role = 'A.V.P.')                        
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By                              
          End                
--         else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'ALL')                              
--          Begin                               
--   DoNothing                                      
--          End                              
         else if(@COR_U_Role = 'Vice President' OR @COR_U_Role = 'Sr. Vice President')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By                              
          End                              
--         else if(@COR_U_Role = 'Sr. Vice President')                              
--          Begin                              
--           DoNothing                                       
--          End                              
        else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'OR' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
        else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                                End                              
          End                              
        else if(@COR_U_Role = 'Associate Director')                              
          Begin                              
                                         
           --select * from emp_info where emp_no ='P00104'                              
           --OR                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OR' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                              
           End                              
          End                              
        else if(@COR_U_Role = 'Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
    End                              
          End               
        else if(@COR_U_Role = 'Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
        else if(@COR_U_Role = 'Chief Strategy Officer')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
                              
                              
        End                                     
                              
         FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                              
                              
                              
      End                              
                                
   Close ORec                              
   deallocate ORec                               
                                          
                              
----------------------------------------------------------------------------------------------------------------                              
                              
---------------get OTHER Approver--------------------------------                              
                              
   Select U_Role,Category,Department into #OtherApprover                              
   From tbl_Approval_LimitMaster                              
   Where @Estimated_Total_Price Between B_AprLimitFrom and B_AprLimitTo                            
   And Category = @Category                              
                              
                  -- Select * from #OtherApprover                                               
    --Cursor                               
       Declare @COA_U_Role varchar(50)                              
    Declare @COA_Category varchar(50)                              
    Declare @COA_Department varchar(50)                              
    --Declare @Request_Id_Apr int                              
    --Declare @Approver varchar(25)                              
                              
    Declare OApr Cursor for                              
    Select * from #OtherApprover                              
                              
                              
    OPEN OApr                              
    FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                              
    While(@@fetch_status=0)                              
      Begin                              
       --Set @Request_Id_Rec = ''                              
       print @COA_U_Role                              
       print @COA_Category                              
       print @COA_Department                              
                              
  if(@COA_Category = 'BRANCH')                              
        Begin                              
                  
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
          End                              
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                              
          Begin                              
           --select * from emp_info where emp_no ='P00104'                              
           --OR                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
                      
          End                      
         else if(@COA_U_Role ='Executive Director')                              
          Begin                              
          if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
          End                              
         else if(@COA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
End                              
         else if(@COA_U_Role ='Chief Strategy Officer')                              
Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
End                              
          End                              
         else if(@COA_U_Role ='CMD')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'           
           End                              
          End                              
                                
                              
        End                              
                              else if(@COA_Category = 'CSO')                              
        Begin                              
                              
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
     Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                  
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
 else if(@COA_U_Role ='Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@COA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                               
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@COA_U_Role ='Chief Strategy Officer')                              
          Begin                              
     if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
  End                              
         else if(@COA_U_Role ='CMD')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
   Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                              
           End                             
          End                              
                              
                              
        End                              
                               
         FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                              
                              
      End                              
   Close OApr                              
   deallocate OApr                               
                                          
----------------------------------------------------------------------------------------------------------                              
                            
            
  --added by sandeep on 09 Apr 2015 for depository--            
       declare @cnt int ,@SubDepartment varchar(50)                   
       set @SubDepartment=(select sub_department from emp_info with(nolock) where emp_no=@Requested_By)            
       if(@SubDepartment='Depository')            
       Begin            
        Insert into tbl_RequestRecApr            
        select @Request_Id,'P00235','R'            
           
        --replaced by suraj start           
        --Insert into tbl_RequestRecApr            
        --select @Request_Id,'E63575','A'  
        if @Estimated_Total_Price <= 50000  
  begin  
   Insert into tbl_RequestRecApr              
   select @Request_Id,'E69243','A'              
        end  
        else  
        begin  
   Insert into tbl_RequestRecApr              
   select @Request_Id,'E63575','A'              
        end  
        
                    
       End            
                   
                                       
      
                   
       --Ended by sandeep                    
                              
--Select @Request_Id As [Request_Id]                              
                 
Select @Request_Id As [Request_Id]                          
             
declare @Request_Id1 nvarchar(max)                          
Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster where Requested_By = @Requested_By)                 
                
EXECUTE Usp_Mailer_Options '1',@Request_Id1                              
                                                                                                                                             
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_New_10Jul2018ToBeLive
-- --------------------------------------------------
                  
---[USP_ITRequestMaster]   null,'100022','200075','1','E57616','System get Hang & Jammed every time.','1',2250                     
                  
Create Proc [dbo].[USP_ITRequestMaster_New_10Jul2018ToBeLive]          
(                                 
 @IT_Engineer char(10),                                                                                                                                                                                                                       
 @Item_Code char(10),                                                                                                                                                                                           
 @Model_No char(10),                                                                                                                                             
 @Model_Quantity char(10),                                                                                                                                                                                  
 @Requested_By varchar(8),                                                                                                 
 @User_Remark varchar(200),                                                                                                                                                  
 @Justification_Id char(10),                                   
 @Estimated_Total_Price int,          
 @Request_Id int                                                                                                                                                      
)                                                                                                                    
as                                                                                
Begin             
            
            
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
                             
                                
--  Declare @CSO  bit                              
  Declare @Status_Code char(10)                              
  Declare @Request_Date DateTime                              
  Declare @Model_Quantity_Assigned As char(10)                              
                              
                              
set @Request_Date= getdate()                                  
set @Status_Code='P'                              
set @Model_Quantity_Assigned='0'                              
                              
                              
                               
                               
-----------first Make an entry in tbl_RequestMaster----------                              
                              
 -- insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,                              
 --        Justification_id,CSO,Status_Code,Estimated_Total_Price,Model_Quantity_Assigned)                              
                                          
 --values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,                              
 --   @Justification_Id,'false',@Status_Code,@Estimated_Total_Price,@Model_Quantity_Assigned)            
 update tbl_RequestMaster        
 set  Status_Code = 'P'        
 where Request_Id = @Request_Id        
                                                                        
------------------------------------------------                              
                              
--get current request_id                              
--commented by suraj start          
 --Declare @Request_Id int                     
--commented by suraj start          
 --getbranchcode of Requester                              
  Declare @RequesterBrCd nvarchar(255)                              
--onbasis of branchcode of Requester decide whether he belongs to Branch OR CSO Category                              
  Declare @Category char(20)                              
--get Designation of the Requester                              
  Declare @Designation varchar(255)                              
--get department of the requester                              
Declare @Department nvarchar(200)                              
--get Sub_Department of the requester                              
  Declare @Sub_Department varchar(150)                              
                              
--Set @Request_Id = (select max(Request_Id) As Request_Id from tbl_RequestMaster  where Requested_By = @Requested_By)                  
                
set @RequesterBrCd = (select Branch_Cd from Emp_Info where Emp_No = @Requested_By)                     
                              
 if(@RequesterBrCd not in(select branch_cd from tbl_CSO_Branch(nolock)) )                              
  Begin                              
   Set @Category = 'BRANCH'                              
  End                   

 else if (@RequesterBrCd in (select branch_cd from tbl_CSO_Branch(nolock)) )                              
  Begin                              
   Set @Category = 'CSO'                              
  End                              
                              
Set @Designation = (Select Designation from emp_info where Emp_No = @Requested_By)                              
                              
Set @Department = (Select Department from emp_info where Emp_No = @Requested_By)                              
                              
Set @Sub_Department = (Select Sub_Department from emp_info where Emp_No = @Requested_By)                              
                              
----                              
Declare @SrAVPIT varchar(20)                              
Declare @HeadIT varchar(20)                              
Declare @ADIT varchar(20)                             
Declare @ED varchar(20)                              
Declare @EDCFO varchar(20)                              
Declare @CSO varchar(20)                              
                              
Set @SrAVPIT = (Select SrAVPIT from tbl_EmpTree Where Emp_Id = @Requested_By)                              
--Set @HeadIT = (Select HeadIT from tbl_EmpTree Where Emp_Id = @Requested_By)                              
--Set @HeadIT = case when @Estimated_Total_Price <= 50000 then 'E69243' else 'E63575' end  
Set @HeadIT = 'E69242'

Set @ADIT = (Select ADIT from tbl_EmpTree Where Emp_Id = @Requested_By)                              
Set @ED = (Select ED from tbl_EmpTree Where Emp_Id = @Requested_By)                              
Set @EDCFO = (Select EDCFO from tbl_EmpTree Where Emp_Id = @Requested_By)                              
Set @CSO = (Select CSO from tbl_EmpTree Where Emp_Id = @Requested_By)                              
----                              
                              
                              
----------------get Recommenders------------------------                              
                  select U_Role,Category,Department into #Recommenders                              
                  from tbl_Recommendation_LimitMaster_new                              
                  where @Estimated_Total_Price between Rec_limitFrom and Rec_LimitTo                              
                 And Category=@Category                              
                              
                  -- Select * from #Recommenders                                        
                   
                  
    --Cursor                               
       Declare @CR_U_Role varchar(50)                              
    Declare @CR_Category varchar(50)                              
    Declare @CR_Department varchar(50)                              
    --Declare @Request_Id_Rec int                              
    --Declare @Recommender varchar(25)                              
    Declare Rec Cursor for                              
    Select * from #Recommenders                              
                              
                            
    OPEN Rec                              
    FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                              
    While(@@fetch_status=0)                              
      Begin                              
                              
       --Set @Request_Id_Rec = ''                   
       --Set @Recommender = ''                              
                                    
       print 'Recommended'                         
       print @CR_U_Role                              
       print @CR_Category            
       print @CR_Department                              
                              
       if(@CR_Category = 'BRANCH')                              
        Begin                                
                                    
         if(@CR_U_Role = 'DepartmentHOD')                   
          Begin                                     
           Exec USP_GetRecApr_new 'R',@Category,'DepartmentHOD',@Request_Id,@Requested_By                                    
                                
          End       
                                                
         else if(@CR_U_Role = 'CIO')                              
          Begin                              
           Exec USP_GetRecApr 'R',@Category,'CIO',@Request_Id,@Requested_By                              
          End                              
         else if(@CR_U_Role = 'CEO')                              
          Begin                              
           Exec USP_GetRecApr 'R',@Category,'CEO',@Request_Id,@Requested_By                                      
        End                                  
		else if(@CR_U_Role = 'Director')                              
          Begin                              
           Exec USP_GetRecApr 'R',@Category,'Director',@Request_Id,@Requested_By                              
          End                              

                     
        -- else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')                              
        --  Begin                              
        --   --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                              
        --   -- Begin                              
        --    if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'R' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
        --    Begin                              
        --     Insert into tbl_RequestRecApr                              
        --     Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By                              
        --    End                              
        --   -- End                                       
                                        
        --  End                              
        -- else if(@CR_U_Role = 'Executive Director')                              
        --  Begin                              
        --   --if(@Requested_By ='P00104')                              
        --   -- Begin                              
        --    if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'R' and @ED IS NOT NULL and @ED <> '')                              
        --    Begin                              
        --     Insert into tbl_RequestRecApr                              
        --     Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By                                
        --    End                              
        --   -- End                              
        --   End                              
        -- else if(@CR_U_Role = 'Executive Director-CFO')                              
        --  Begin                              
        --   --if(@Requested_By ='P00104')          
        --   -- Begin                              
        --    if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'R' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
        --    Begin                              
        --     Insert into tbl_RequestRecApr                                     Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                               
        --    End                               
        --   -- End                                    
        --  End                              
        -- else if(@CR_U_Role = 'Chief Strategy Officer')                              
        --  Begin                              
        --   --if(@Requested_By ='P00104')                              
        --   -- Begin                              
        --    if NOT EXISTS (Select @Request_Id,Emp_Code,'R' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'R' and @CSO IS NOT NULL and @CSO <> '')                              
        --    Begin                              
        --     Insert into tbl_RequestRecApr                              
        --     Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By                          
        --    End                              
        --   -- End                              
        -- End                              
        End                              
                              
       else if (@CR_Category = 'CSO')                              
        Begin                              
                              
         if(@CR_U_Role = 'DepartmentHOD')                   
          Begin                                     
           Exec USP_GetRecApr_new 'R',@Category,'DepartmentHOD',@Request_Id,@Requested_By                                    
                                
          End       
                                                
         else if(@CR_U_Role = 'CIO')                              
          Begin                              
           Exec USP_GetRecApr_new 'R',@Category,'CIO',@Request_Id,@Requested_By                              
          End                              
         else if(@CR_U_Role = 'CEO')                              
          Begin                              
           Exec USP_GetRecApr_new 'R',@Category,'CEO',@Request_Id,@Requested_By                                      
        End                                  
		else if(@CR_U_Role = 'Director')                              
          Begin                              
           Exec USP_GetRecApr_new 'R',@Category,'Director',@Request_Id,@Requested_By                              
          End                               
                              
                              
        End                                     
                              
         FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department                              
                                                          
      End                              
                                
   Close Rec                              
   deallocate Rec                               
            
                                         
                                                          
                              
----------------------------------------------------------------------------------------------------------------                              
                              
---------------get Approver--------------------------------                             
                              
   Select U_Role,Category,Department into #Approver                              
   From tbl_Approval_LimitMaster                              
   Where @Estimated_Total_Price Between Apr_LimitFrom and Apr_LimitTo                              
   And Category = @Category                              
                              
                  -- Select * from #Approver                                               
    --Cursor                               
       Declare @CA_U_Role varchar(50)                              
    Declare @CA_Category varchar(50)           
    Declare @CA_Department varchar(50)                              
    --Declare @Request_Id_Apr int                              
    --Declare @Approver varchar(25)                              
                              
    Declare Apr Cursor for                              
    Select * from #Approver                              
                              
                              
    OPEN Apr                              
    FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                              
    While(@@fetch_status=0)                              
      Begin                              
       --Set @Request_Id_Rec = ''                              
--       print @CA_U_Role                              
--       print @CA_Category                              
--   print @CA_Department                              
                              
       if(@CA_Category = 'BRANCH')                              
        Begin                              
                              
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
   Insert into tbl_RequestRecApr                              
            Select @Request_Id,@HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
          End                              
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                              
          Begin                              
           --select * from emp_info where emp_no ='P00104'                              
           --OR                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
                                         
          End                              
         else if(@CA_U_Role ='Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                              
           Begin         
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
                              
          End                              
       else if(@CA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                   
            Insert into tbl_RequestRecApr                              
     Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                               
           End                              
          End                              
         else if(@CA_U_Role ='Chief Strategy Officer')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
         Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                               
          End                              
         else if(@CA_U_Role ='CMD')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Insert into tbl_RequestRecApr                              
           Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'                              
          End                              
                                
                              
        End                              
                              
else if(@CA_Category = 'CSO')                              
        Begin                              
                              
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'A' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,@HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
        End                              
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'A' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'A' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'A' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                           
            Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='Chief Strategy Officer')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'A' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@CA_U_Role ='CMD')                              
          Begin                              
 if NOT EXISTS (Select @Request_Id,Emp_Code,'A' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'A' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                              
           End                              
          End                              
                              
                          
      End                              
                               
         FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department                              
                              
      End                              
   Close Apr                              
   deallocate Apr                               
                            
                              
----------------get OTHERS Recommenders ------------------------                              
                  select U_Role,Category,Department into #OtherRecommenders                              
                  from tbl_Recommendation_LimitMaster                              
                  where @Estimated_Total_Price between B_ReclimitFrom and B_RecLimitTo                              
   And Category=@Category                              
                              
 -- Select * from #OtherRecommenders                                        
                                                       
                              
                                         
    --Cursor                               
       Declare @COR_U_Role varchar(50)                              
    Declare @COR_Category varchar(50)                              
    Declare @COR_Department varchar(50)                            
    --Declare @Request_Id_Rec int                              
    --Declare @Recommender varchar(25)                          
    Declare ORec Cursor for                              
    Select * from #OtherRecommenders                              
                              
                              
    OPEN ORec                              
    FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                              
    While(@@fetch_status=0)                              
      Begin                              
                              
       --Set @Request_Id_Rec = ''                              
       --Set @Recommender = ''                              
              
--                              
       print @COR_U_Role                              
       print @COR_Category                              
       print @COR_Department             
                              
       if(@COR_Category = 'BRANCH')                              
        Begin                                
                                    
         if(@COR_U_Role = 'Branch Head')                              
          Begin                                     
           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                                    
                                
          End                              
--         else if(@COR_U_Role = 'Branch Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                                                         
--          End                               
         else if(@COR_U_Role = 'Cluster Head')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'ClusterHead',@Request_Id,@Requested_By                              
          End                              
         else if(@COR_U_Role = 'Zonal Head')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                                      
          End                              
--         else if(@COR_U_Role = 'Zonal Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                                             
--          End                              
         else if(@COR_U_Role = 'Regional Head')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                              
          End                              
--         else if(@CR_U_Role = 'Regional Manager')                              
--          Begin                              
--           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By                   
--          End                              
         else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                              
          Begin                              
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))                              
           -- Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                                       
                                        
          End                              
         else if(@COR_U_Role = 'Executive Director')                      
          Begin                        
           --if(@Requested_By ='P00104')                              
           -- Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                              
           End                              
         else if(@COR_U_Role = 'Executive Director-CFO')                              
          Begin                              
           --if(@Requested_By ='P00104')                              
           -- Begin                    
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                        
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                         
          End                              
         else if(@COR_U_Role = 'Chief Strategy Officer')                              
          Begin                              
           --if(@Requested_By ='P00104')                              
           -- Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
           -- End                              
         End                              
        End                              
                              
       else if (@COR_Category = 'CSO')                              
        Begin                              
                              
         if(@COR_U_Role = 'A.V.P.')                        
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By                              
          End                
--         else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'ALL')                              
--          Begin                               
--   DoNothing                                      
--          End                              
         else if(@COR_U_Role = 'Vice President' OR @COR_U_Role = 'Sr. Vice President')                              
          Begin                              
           Exec USP_GetRecApr 'OR',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By                              
          End                              
--         else if(@COR_U_Role = 'Sr. Vice President')                              
--          Begin                              
--           DoNothing                                       
--          End                              
        else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @SrAVPIT and Role = 'OR' and @SrAVPIT IS NOT NULL and @SrAVPIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
        else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OR' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                                End                              
          End                              
        else if(@COR_U_Role = 'Associate Director')                              
          Begin                              
                                         
           --select * from emp_info where emp_no ='P00104'                              
           --OR                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OR' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                              
           End                              
          End                              
        else if(@COR_U_Role = 'Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OR' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
    End                              
          End               
        else if(@COR_U_Role = 'Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OR' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
        else if(@COR_U_Role = 'Chief Strategy Officer')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OR' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OR' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
                              
                              
        End                                     
                              
         FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department                              
                              
                              
      End                              
                                
   Close ORec                              
   deallocate ORec                               
                                          
                              
----------------------------------------------------------------------------------------------------------------                              
                              
---------------get OTHER Approver--------------------------------                              
                              
   Select U_Role,Category,Department into #OtherApprover                              
   From tbl_Approval_LimitMaster                              
   Where @Estimated_Total_Price Between B_AprLimitFrom and B_AprLimitTo                            
   And Category = @Category                              
                              
                  -- Select * from #OtherApprover                                               
    --Cursor                               
       Declare @COA_U_Role varchar(50)                              
    Declare @COA_Category varchar(50)                              
    Declare @COA_Department varchar(50)                              
    --Declare @Request_Id_Apr int                              
    --Declare @Approver varchar(25)                              
                              
    Declare OApr Cursor for                              
    Select * from #OtherApprover                              
                              
                              
    OPEN OApr                              
    FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                              
    While(@@fetch_status=0)                              
      Begin                              
       --Set @Request_Id_Rec = ''                              
       print @COA_U_Role                              
       print @COA_Category                              
       print @COA_Department                              
                              
  if(@COA_Category = 'BRANCH')                              
        Begin                              
                  
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
          End                              
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                              
          Begin                              
           --select * from emp_info where emp_no ='P00104'                              
           --OR                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
                      
          End                      
         else if(@COA_U_Role ='Executive Director')                              
          Begin                              
          if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
          End                              
         else if(@COA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
           End                              
End                              
         else if(@COA_U_Role ='Chief Strategy Officer')                              
Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By                              
End                              
          End                              
         else if(@COA_U_Role ='CMD')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'           
           End                              
          End                              
                                
                              
        End                              
                              else if(@COA_Category = 'CSO')                              
        Begin                              
                              
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @HeadIT and Role = 'OA' and @HeadIT IS NOT NULL and @HeadIT <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
     Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ADIT and Role = 'OA' and @ADIT IS NOT NULL and @ADIT <> '')                              
           Begin                  
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
 else if(@COA_U_Role ='Executive Director')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @ED and Role = 'OA' and @ED IS NOT NULL and @ED <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@COA_U_Role ='Executive Director-CFO')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @EDCFO and Role = 'OA' and @EDCFO IS NOT NULL and @EDCFO <> '')                              
           Begin                               
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
          End                              
         else if(@COA_U_Role ='Chief Strategy Officer')                              
          Begin                              
     if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and  Emp_Code = @CSO and Role = 'OA' and @CSO IS NOT NULL and @CSO <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
            Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))                               
           End                              
  End                              
         else if(@COA_U_Role ='CMD')                              
          Begin                              
           if NOT EXISTS (Select @Request_Id,Emp_Code,'OA' from tbl_RequestRecApr where Request_Id = @Request_Id and Emp_Code = 'D00002' and Role = 'OA' and Emp_Code IS NOT NULL and Emp_Code <> '')                              
           Begin                              
            Insert into tbl_RequestRecApr                              
   Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))   and [Status] = 'A'                              
           End                             
          End                              
                              
                              
        End                              
                               
         FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department                              
                              
      End                              
   Close OApr                              
   deallocate OApr                               
                                          
----------------------------------------------------------------------------------------------------------                              
                            
            
  --added by sandeep on 09 Apr 2015 for depository--            
       declare @cnt int ,@SubDepartment varchar(50)                   
       set @SubDepartment=(select sub_department from emp_info with(nolock) where emp_no=@Requested_By)            
       if(@SubDepartment='Depository')            
       Begin            
        Insert into tbl_RequestRecApr            
        select @Request_Id,'P00235','R'            
           
        --replaced by suraj start           
        --Insert into tbl_RequestRecApr            
        --select @Request_Id,'E63575','A'  
        if @Estimated_Total_Price <= 50000  
  begin  
   Insert into tbl_RequestRecApr              
   select @Request_Id,'E69243','A'              
        end  
        else  
        begin  
   Insert into tbl_RequestRecApr              
   select @Request_Id,'E63575','A'              
        end  
        
                    
       End            
                   
                                       
      
                   
       --Ended by sandeep                    
                              
--Select @Request_Id As [Request_Id]                              
                 
Select @Request_Id As [Request_Id]                          
             
declare @Request_Id1 nvarchar(max)                          
Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster where Requested_By = @Requested_By)                 
                
EXECUTE Usp_Mailer_Options '1',@Request_Id1                              
                                                                                                                                             
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_Report_N_New
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[USP_ITRequestMaster_Report_N_New]    
(@ACCESSCODE CHAR(25),@TYPE VARCHAR(5),@USERID VARCHAR(15))    
AS    
BEGIN 



   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
   
--if(@UserID='P00226')          
--begin         
--  set @Type='A'        
--end        
DECLARE @QUERY AS NVARCHAR(MAX)    
SET @QUERY =     
   'select Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],    
   A.Estimated_Total_Price as[Estimated_Total_Price],D.Emp_Name As [Requested_By],    
   D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],D.Department As[Department],    
   D.Sr_Name As[HOD],A.User_Remark As [User_Remark],f.Remark as [Review Remark],f.ReviewDate as [Review Date]--,F.Status_Name As [Status_Name]    
   from tbl_RequestMaster A    
   inner Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code    
   inner Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id    
   inner join    
   (Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info    
   UNION ALL    
   Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D    
   on A.Requested_By = D.emp_no    
   inner join tbl_RequestRecApr E on A.Request_Id = E.Request_Id   
   inner join Tbl_ReviewRemarks F on A.Request_Id = F.Request_Id     
   where E.Emp_Code = '''+@UserID+''' And E.Role = '''+@Type+'''    
   and ISNULL(A.Recommended_By,'''') <> '''+ @UserID +''' and    
   A.Status_Code in (''P'',''L1R'') and E.Emp_Code <> A.Requested_By '    
              
IF ( @TYPE='R')               
BEGIN               
    IF( @ACCESSCODE='BRANCH')    
    BEGIN    
    SET @QUERY = @QUERY + ' AND D.BRANCH_CD NOT IN (SELECT BRANCH_CD FROM TBL_CSO_BRANCH(NOLOCK)) ORDER BY A.REQUEST_ID DESC'    
    PRINT(@QUERY)    
    --EXEC(@QUERY)    
    END    
ELSE IF(@ACCESSCODE='CSO')              
    BEGIN    
    SET @QUERY = @QUERY + ' AND D.BRANCH_CD IN (SELECT BRANCH_CD FROM TBL_CSO_BRANCH(NOLOCK)) ORDER BY A.REQUEST_ID DESC'    
    --PRINT(@QUERY)    
    END    
END     
PRINT(@QUERY)         
EXEC(@QUERY)              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITREQUESTMASTER_REPORT_N_NEW_04Mar2014
-- --------------------------------------------------
 CREATE PROCEDURE [dbo].[USP_ITREQUESTMASTER_REPORT_N_NEW_04Mar2014]    
(@ACCESSCODE CHAR(25),@TYPE VARCHAR(5),@USERID VARCHAR(15))    
AS    
BEGIN   


   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 




 
--if(@UserID='P00226')          
--begin         
--  set @Type='A'        
--end        
DECLARE @QUERY AS NVARCHAR(MAX)    
SET @QUERY =     
   'select Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],    
   A.Estimated_Total_Price as[Estimated_Total_Price],D.Emp_Name As [Requested_By],    
   D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],D.Department As[Department],    
   D.Sr_Name As[HOD],A.User_Remark As [User_Remark]--,F.Status_Name As [Status_Name]    
   from tbl_RequestMaster A    
   inner Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code    
   inner Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id    
   inner join    
   (Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info    
   UNION ALL    
   Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D    
   on A.Requested_By = D.emp_no    
   inner join tbl_RequestRecApr E on A.Request_Id = E.Request_Id    
   where E.Emp_Code = '''+@UserID+''' And E.Role = '''+@Type+'''    
   and ISNULL(A.Recommended_By,'''') <> '''+ @UserID +''' and    
   A.Status_Code in (''P'',''L1R'') and E.Emp_Code <> A.Requested_By '    
              
IF ( @TYPE='R')               
BEGIN               
    IF( @ACCESSCODE='BRANCH')    
    BEGIN    
    SET @QUERY = @QUERY + ' AND D.BRANCH_CD NOT IN (SELECT BRANCH_CD FROM TBL_CSO_BRANCH(NOLOCK)) ORDER BY A.REQUEST_ID DESC'    
    PRINT(@QUERY)    
    --EXEC(@QUERY)    
    END    
ELSE IF(@ACCESSCODE='CSO')              
    BEGIN    
    SET @QUERY = @QUERY + ' AND D.BRANCH_CD IN (SELECT BRANCH_CD FROM TBL_CSO_BRANCH(NOLOCK)) ORDER BY A.REQUEST_ID DESC'    
    --PRINT(@QUERY)    
    END    
END            
PRINT(@QUERY)  
EXEC(@QUERY)              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_Report_N_New_bk_29Dec2017
-- --------------------------------------------------
create PROCEDURE [dbo].[USP_ITRequestMaster_Report_N_New_bk_29Dec2017]    
(@ACCESSCODE CHAR(25),@TYPE VARCHAR(5),@USERID VARCHAR(15))    
AS    
BEGIN 



   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
   
--if(@UserID='P00226')          
--begin         
--  set @Type='A'        
--end        
DECLARE @QUERY AS NVARCHAR(MAX)    
SET @QUERY =     
   'select Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],    
   A.Estimated_Total_Price as[Estimated_Total_Price],D.Emp_Name As [Requested_By],    
   D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],D.Department As[Department],    
   D.Sr_Name As[HOD],A.User_Remark As [User_Remark]--,F.Status_Name As [Status_Name]    
   from tbl_RequestMaster A    
   inner Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code    
   inner Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id    
   inner join    
   (Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info    
   UNION ALL    
   Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D    
   on A.Requested_By = D.emp_no    
   inner join tbl_RequestRecApr E on A.Request_Id = E.Request_Id    
   where E.Emp_Code = '''+@UserID+''' And E.Role = '''+@Type+'''    
   and ISNULL(A.Recommended_By,'''') <> '''+ @UserID +''' and    
   A.Status_Code in (''P'',''L1R'') and E.Emp_Code <> A.Requested_By '    
              
IF ( @TYPE='R')               
BEGIN               
    IF( @ACCESSCODE='BRANCH')    
    BEGIN    
    SET @QUERY = @QUERY + ' AND D.BRANCH_CD NOT IN (SELECT BRANCH_CD FROM TBL_CSO_BRANCH(NOLOCK)) ORDER BY A.REQUEST_ID DESC'    
    PRINT(@QUERY)    
    --EXEC(@QUERY)    
    END    
ELSE IF(@ACCESSCODE='CSO')              
    BEGIN    
    SET @QUERY = @QUERY + ' AND D.BRANCH_CD IN (SELECT BRANCH_CD FROM TBL_CSO_BRANCH(NOLOCK)) ORDER BY A.REQUEST_ID DESC'    
    --PRINT(@QUERY)    
    END    
END     
PRINT(@QUERY)         
EXEC(@QUERY)              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_WITH_MULTIPLE_ENTRIES
-- --------------------------------------------------
    
    
    
CREATE Proc [dbo].[USP_ITRequestMaster_WITH_MULTIPLE_ENTRIES]                                                                                     
(       
 @IT_Engineer char(10),                                                                                                                                                                                             
 @Item_Code char(10),                                                                                                                                                                 
 @Model_No char(10),                                                                                                                   
 @Model_Quantity char(10),                                                                                                                                                        
 @Requested_By varchar(8),                                                                       
 @User_Remark varchar(200),                                                                                                                        
 @Justification_Id char(10),         
 @Estimated_Total_Price int                                                                                                                 
)                                                                                          
as                                                      
Begin   

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

  
      
  Declare @CSO  bit    
  Declare @Status_Code char(10)    
  Declare @Request_Date DateTime    
  Declare @Model_Quantity_Assigned As char(10)    
    
    
set @Request_Date= getdate()        
set @Status_Code='P'    
set @Model_Quantity_Assigned='0'    
    
    
     
     
-----------first Make an entry in tbl_RequestMaster----------    
    
  insert into tbl_RequestMaster(IT_Engineer,Item_Code,Model_No,Model_Quantity,Request_date,Requested_By,User_Remark,    
         Justification_id,CSO,Status_Code,Estimated_Total_Price,Model_Quantity_Assigned)    
                
 values  (@IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,@Request_Date,@Requested_By,@User_Remark,    
    @Justification_Id,'false',@Status_Code,@Estimated_Total_Price,@Model_Quantity_Assigned)         
                                                     
------------------------------------------------    
    
--get current request_id    
 Declare @Request_Id int
 Declare @Request_Id1 int    
--getbranchcode of Requester    
  Declare @RequesterBrCd nvarchar(255)    
--onbasis of branchcode of Requester decide whether he belongs to Branch OR CSO Category    
  Declare @Category char(20)    
--get Designation of the Requester    
  Declare @Designation varchar(255)    
--get department of the requester    
  Declare @Department nvarchar(200)    
--get Sub_Department of the requester    
  Declare @Sub_Department varchar(150)    
    
Set @Request_Id = (select max(Request_Id) As Request_Id from tbl_RequestMaster  where Requested_By = @Requested_By)    


Set @Request_Id1 = (select max(Request_Id) As Request_Id from tbl_RequestMaster)   
  
EXECUTE Usp_Mailer_Options '1',@Request_Id1  


   
set @RequesterBrCd = (select Branch_Cd from Emp_Info where Emp_No = @Requested_By)    
    
 if(@RequesterBrCd not in(select branch_cd from tbl_CSO_Branch(nolock)))    
  Begin    
   Set @Category = 'BRANCH'    
  End    
    
 else if (@RequesterBrCd in (select branch_cd from tbl_CSO_Branch(nolock)))    
  Begin    
   Set @Category = 'CSO'    
  End    
    
Set @Designation = (Select Designation from emp_info where Emp_No = @Requested_By)    
    
Set @Department = (Select Department from emp_info where Emp_No = @Requested_By)    
    
Set @Sub_Department = (Select Sub_Department from emp_info where Emp_No = @Requested_By)    
    
----------------get Recommenders------------------------    
                  select U_Role,Category,Department into #Recommenders    
                  from tbl_Recommendation_LimitMaster    
                  where @Estimated_Total_Price between Rec_limitFrom and Rec_LimitTo    
                 And Category=@Category    
    
                  -- Select * from #Recommenders              
                             
    
             
    --Cursor     
       Declare @CR_U_Role varchar(50)    
    Declare @CR_Category varchar(50)    
    Declare @CR_Department varchar(50)    
    --Declare @Request_Id_Rec int    
    --Declare @Recommender varchar(25)    
    Declare Rec Cursor for    
    Select * from #Recommenders    
    
    
    OPEN Rec    
    FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department    
    While(@@fetch_status=0)    
      Begin    
    
       --Set @Request_Id_Rec = ''    
       --Set @Recommender = ''    
          
--    
--       print @CR_U_Role    
--       print @CR_Category    
--       print @CR_Department    
    
       if(@CR_Category = 'BRANCH')    
        Begin      
          
         if(@CR_U_Role = 'Branch Head')    
          Begin           
           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By          
      
          End    
--         else if(@CR_U_Role = 'Branch Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'BranchHead',@Request_Id,@Requested_By            
--          End     
         else if(@CR_U_Role = 'Cluster Head')    
          Begin    
           Exec USP_GetRecApr 'R',@Category,'ClusterHead',@Request_Id,@Requested_By    
          End    
         else if(@CR_U_Role = 'Zonal Head')    
          Begin    
           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By            
          End    
--         else if(@CR_U_Role = 'Zonal Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'ZonalHead',@Request_Id,@Requested_By                   
--          End    
         else if(@CR_U_Role = 'Regional Head')    
          Begin    
           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By    
          End    
--         else if(@CR_U_Role = 'Regional Manager')    
--          Begin    
--           Exec USP_GetRecApr 'R',@Category,'RegionalHead',@Request_Id,@Requested_By           
--          End    
         else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')    
          Begin    
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))    
           -- Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By    
           -- End             
              
          End    
         else if(@CR_U_Role = 'Executive Director')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By         
           -- End    
           End    
         else if(@CR_U_Role = 'Executive Director-CFO')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By      
           -- End          
          End    
         else if(@CR_U_Role = 'Chief Strategy Officer')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
            Insert into tbl_RequestRecApr    
            Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By              
           -- End    
         End    
        End    
    
       else if (@CR_Category = 'CSO')    
        Begin    
    
         if(@CR_U_Role = 'A.V.P.')    
          Begin    
           --if HOD should also see the request then add  HOD here.     
           Exec USP_GetRecApr 'R',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By    
    
          End    
--         else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'ALL')    
--          Begin     
--           ---DoNothing       
--          End    
         else if(@CR_U_Role = 'Vice President')    
          Begin    
           --if HOD should also see the request then add  HOD here.     
          Exec USP_GetRecApr 'R',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By    
          End    
--         else if(@CR_U_Role = 'Sr. Vice President')    
--          Begin    
--           --DoNothing             
--          End    
        else if(@CR_U_Role = 'Sr. Assistant Vice President' and @CR_Department = 'IT')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,SrAVPIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
        else if(@CR_U_Role = 'Head' and @CR_Department = 'IT')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,HeadIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
        else if(@CR_U_Role = 'Associate Director')    
          Begin    
               
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ADIT,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
        else if(@CR_U_Role = 'Executive Director')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ED,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
        else if(@CR_U_Role = 'Executive Director-CFO')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,EDCFO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
        else if(@CR_U_Role = 'Chief Strategy Officer')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,CSO,'R' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
    
    
        End           
    
         FETCH Rec into @CR_U_Role,@CR_Category,@CR_Department    
    
    
      End    
      
   Close Rec    
   deallocate Rec     
                
    
----------------------------------------------------------------------------------------------------------------    
    
---------------get Approver--------------------------------    
    
   Select U_Role,Category,Department into #Approver    
   From tbl_Approval_LimitMaster    
   Where @Estimated_Total_Price Between Apr_LimitFrom and Apr_LimitTo    
   And Category = @Category    
    
                  -- Select * from #Approver                     
    --Cursor     
       Declare @CA_U_Role varchar(50)    
    Declare @CA_Category varchar(50)    
    Declare @CA_Department varchar(50)    
    --Declare @Request_Id_Apr int    
    --Declare @Approver varchar(25)    
    
    Declare Apr Cursor for    
    Select * from #Approver    
    
    
    OPEN Apr    
    FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department    
    While(@@fetch_status=0)    
      Begin    
       --Set @Request_Id_Rec = ''    
--       print @CA_U_Role    
--       print @CA_Category    
--       print @CA_Department    
    
       if(@CA_Category = 'BRANCH')    
        Begin    
    
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
          End    
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')    
          Begin    
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
               
          End    
         else if(@CA_U_Role ='Executive Director')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
    
          End    
         else if(@CA_U_Role ='Executive Director-CFO')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
          End    
         else if(@CA_U_Role ='Chief Strategy Officer')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By     
          End    
         else if(@CA_U_Role ='CMD')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'    
          End    
      
    
        End    
    
      else if(@CA_Category = 'CSO')    
        Begin    
    
         if(@CA_U_Role = 'Head' and @CA_Department = 'IT')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,HeadIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
         else if(@CA_U_Role ='Associate Director' and @CA_Department = 'IT')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ADIT,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
         else if(@CA_U_Role ='Executive Director')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ED,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
         else if(@CA_U_Role ='Executive Director-CFO')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,EDCFO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
         else if(@CA_U_Role ='Chief Strategy Officer')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,CSO,'A' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
         else if(@CA_U_Role ='CMD')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,Emp_No,'A' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))  and [Status] = 'A'    
          End    
    
    
        End    
     
         FETCH Apr into @CA_U_Role,@CA_Category,@CA_Department    
    
      End    
   Close Apr    
   deallocate Apr     
                
    
----------------get OTHERS Recommenders ------------------------    
                  select U_Role,Category,Department into #OtherRecommenders    
                  from tbl_Recommendation_LimitMaster    
                  where @Estimated_Total_Price between B_ReclimitFrom and B_RecLimitTo    
                 And Category=@Category    
    
                  -- Select * from #OtherRecommenders              
                             
    
               
    --Cursor     
       Declare @COR_U_Role varchar(50)    
    Declare @COR_Category varchar(50)    
    Declare @COR_Department varchar(50)    
    --Declare @Request_Id_Rec int    
    --Declare @Recommender varchar(25)    
    Declare ORec Cursor for    
    Select * from #OtherRecommenders    
    
    
    OPEN ORec    
    FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department    
    While(@@fetch_status=0)    
      Begin    
    
       --Set @Request_Id_Rec = ''    
       --Set @Recommender = ''    
          
--    
--       print @COR_U_Role    
--       print @COR_Category    
--       print @COR_Department    
    
       if(@COR_Category = 'BRANCH')    
        Begin      
          
         if(@COR_U_Role = 'Branch Head')    
          Begin           
           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By          
      
          End    
--         else if(@COR_U_Role = 'Branch Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'BranchHead',@Request_Id,@Requested_By                               
--          End     
         else if(@COR_U_Role = 'Cluster Head')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'ClusterHead',@Request_Id,@Requested_By    
          End    
         else if(@COR_U_Role = 'Zonal Head')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By            
          End    
--         else if(@COR_U_Role = 'Zonal Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'ZonalHead',@Request_Id,@Requested_By                   
--          End    
         else if(@COR_U_Role = 'Regional Head')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By    
          End    
--         else if(@CR_U_Role = 'Regional Manager')    
--          Begin    
--           Exec USP_GetRecApr 'OR',@Category,'RegionalHead',@Request_Id,@Requested_By            
--          End    
         else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')    
          Begin    
           --if(@Designation in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager'))    
           -- Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           -- End             
              
          End    
         else if(@COR_U_Role = 'Executive Director')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           -- End    
           End    
         else if(@COR_U_Role = 'Executive Director-CFO')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           -- End          
          End    
         else if(@COR_U_Role = 'Chief Strategy Officer')    
          Begin    
           --if(@Requested_By ='P00104')    
           -- Begin    
             Insert into tbl_RequestRecApr    
             Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By    
           -- End    
         End    
        End    
    
       else if (@COR_Category = 'CSO')    
        Begin    
    
         if(@COR_U_Role = 'A.V.P.')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'A.V.P.Sr. Assistant Vice President All',@Request_Id,@Requested_By    
          End    
--         else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'ALL')    
--          Begin     
--           DoNothing            
--          End    
         else if(@COR_U_Role = 'Vice President' OR @COR_U_Role = 'Sr. Vice President')    
          Begin    
           Exec USP_GetRecApr 'OR',@Category,'Vice PresidentSr. Assistant Vice President',@Request_Id,@Requested_By    
          End    
--         else if(@COR_U_Role = 'Sr. Vice President')    
--          Begin    
--           DoNothing             
--          End    
        else if(@COR_U_Role = 'Sr. Assistant Vice President' and @COR_Department = 'IT')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,SrAVPIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
        else if(@COR_U_Role = 'Head' and @COR_Department = 'IT')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,HeadIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
        else if(@COR_U_Role = 'Associate Director')    
          Begin    
               
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ADIT,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
        else if(@COR_U_Role = 'Executive Director')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ED,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
        else if(@COR_U_Role = 'Executive Director-CFO')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,EDCFO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
        else if(@COR_U_Role = 'Chief Strategy Officer')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,CSO,'OR' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
    
    
        End           
    
         FETCH ORec into @COR_U_Role,@COR_Category,@COR_Department    
    
    
      End    
      
   Close ORec    
   deallocate ORec     
                
    
----------------------------------------------------------------------------------------------------------------    
    
---------------get OTHER Approver--------------------------------    
    
   Select U_Role,Category,Department into #OtherApprover    
   From tbl_Approval_LimitMaster    
   Where @Estimated_Total_Price Between B_AprLimitFrom and B_AprLimitTo    
   And Category = @Category    
    
                  -- Select * from #OtherApprover                     
    --Cursor     
       Declare @COA_U_Role varchar(50)    
    Declare @COA_Category varchar(50)    
    Declare @COA_Department varchar(50)    
    --Declare @Request_Id_Apr int    
    --Declare @Approver varchar(25)    
    
    Declare OApr Cursor for    
    Select * from #OtherApprover    
    
    
    OPEN OApr    
    FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department    
    While(@@fetch_status=0)    
      Begin    
       --Set @Request_Id_Rec = ''    
--       print @COA_U_Role    
--       print @COA_Category    
--       print @COA_Department    
    
       if(@COA_Category = 'BRANCH')    
        Begin    
    
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
          End    
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')    
          Begin    
           --select * from emp_info where emp_no ='P00104'    
           --OR    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
               
          End    
         else if(@COA_U_Role ='Executive Director')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
    
          End    
         else if(@COA_U_Role ='Executive Director-CFO')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
          End    
         else if(@COA_U_Role ='Chief Strategy Officer')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By    
          End    
    else if(@COA_U_Role ='CMD')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002'  and [Status] = 'A'    
          End    
      
    
        End    
    
      else if(@COA_Category = 'CSO')    
        Begin    
    
         if(@COA_U_Role = 'Head' and @COA_Department = 'IT')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,HeadIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
         else if(@COA_U_Role ='Associate Director' and @COA_Department = 'IT')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ADIT,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
         else if(@COA_U_Role ='Executive Director')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,ED,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
         else if(@COA_U_Role ='Executive Director-CFO')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,EDCFO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
         else if(@COA_U_Role ='Chief Strategy Officer')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,CSO,'OA' from tbl_EmpTree where Emp_Id = @Requested_By and Branch_Code in (select branch_cd from tbl_CSO_Branch(nolock))    
          End    
         else if(@COA_U_Role ='CMD')    
          Begin    
           Insert into tbl_RequestRecApr    
           Select @Request_Id,Emp_No,'OA' from Emp_Info where Emp_No = 'D00002' and branch_cd in (select branch_cd from tbl_CSO_Branch(nolock))  and [Status] = 'A'    
          End    
    
    
        End    
     
         FETCH OApr into @COA_U_Role,@COA_Category,@COA_Department    
    
      End    
   Close OApr    
   deallocate OApr     
                
----------------------------------------------------------------------------------------------------------    
    
    
Select @Request_Id As [Request_Id]    
    
    
                                                  
                                                 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestTrackerView
-- --------------------------------------------------
    
    --USP_ITRequestTrackerView 'E39377','','','','',''
    
    
  --(select emp_name from [196.1.115.158].prms.dbo.client_master where emp_id=A.[Recommended_By]) as [Recommended By]  
    
      
      
      
      
      
      
CREATE proc [dbo].[USP_ITRequestTrackerView]      
      
@Requested_by char(10),      
@Request_Id char(10),      
@Item_Code char(10),       
@Model_No char(10),       
@FromDate varchar(20),      
@ToDate varchar(20)        
             
as              
      
Begin   
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
  
     
      
 Declare @Query as varchar(max)      
      
 set @Query='select A.Request_Id As [RequestId], B.Product_name As [Item Name], C.Model_Name As [Model Name],      
  A.Model_Quantity As [Model Quantity], A.Estimated_Total_Price As [Estimated Total Price],      
  D.Emp_Name As [Requested By],E.Branch_Cd As [Requester Branch Code],A.Request_Date As [Request Date],  
   A.User_Remark As [User Remark],j.EMP_NAME as [Reviewed By],i.ReviewDate as [Reviewed Date],      
  --(select emp_name from [10.0.1.106].prms.dbo.client_master with(nolock) where emp_id=A.[Recommended_By]) as [Recommended By],  
  (select emp_name from  risk.dbo.emp_info with(nolock) where emp_no=A.[Recommended_By]) as [Recommended By],  
  A.Recommended_DateTime As [Recommended Datetime],      
  G.Emp_Name As [Approved By], A.Approved_Datetime As [Approved Datetime ],      
  H.Status_Name As[status]      
  From tbl_RequestMaster A with(nolock)       
   Left outer join tbl_CapexProductMaster B with(nolock) on A.Item_Code=B.Product_Code      
   Left outer join tbl_ProductModelMaster C with(nolock) on A.Model_No=C.Model_Id      
   Left outer join emp_info D with(nolock) on A.Requested_By=D.Emp_no      
   Left Outer join emp_info E with(nolock) on A.Requested_By = E.Emp_no      
   Left outer join emp_info F with(nolock) on A.Recommended_By=F.Emp_no      
   Left outer join emp_info G with(nolock) on A.Approved_By=G.Emp_no      
   Left outer join tbl_StatusMaster H with(nolock) on A.status_Code=H.Status_Code  
    Left outer join (select ReviewedBy,ReviewDate,Request_Id from Tbl_ReviewRemarks) i on A.Request_Id=i.Request_Id    
    Left outer join emp_info j with(nolock) on i.ReviewedBy=J.Emp_no    
  where A.Requested_By=rtrim('''+@Requested_by+''')'      
      
      
 if(@Request_Id <> '')      
 Begin      
  set @Query=@Query + ' and A.Request_Id='''+@Request_Id+''''      
 End      
       
 if(@Item_Code <> '' and @Model_No <> '')      
 Begin      
  Set @Query=@Query +' and A.Item_Code='''+@Item_Code+''' and A.Model_No='''+@Model_No +''''      
 End      
      
      
 if(@FromDate <> '' and  @ToDate<>'')      
 Begin      
  set @Query=@Query +'and A.Request_Date Between  Convert(Datetime,'''+@FromDate+''') and Convert(Datetime,'''+@ToDate+''')'      
 end      
       
 exec (@Query)      
 Print @Query      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequestView
-- --------------------------------------------------
  
  
  
  
  
CREATE proc [dbo].[usp_ITRequestView](@Requested_By varchar(7))          
as  
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
  
  
  
--backup  
--  
--Select A.Request_Id As [Request Id],  
--convert(varchar(11),A.Request_Date,103) as [Request Date],  
--B.Item_Name As [Item Name],  
--C.Model_name As [Model Name],  
--A.Model_Quantity as [Model Quantity],  
--D.department As [Department]  
--from  tbl_RequestMaster(nolock) A  
--inner join tbl_ItemMaster B On  
--A.Item_Code=B.Item_code  
--inner join tbl_ModelMaster C On  
--A.Model_No=C.Model_No  
--inner join Emp_Info D On  
--A.Requested_By=D.emp_no  
--where A.Status_Code = 'P' and A.Requested_By=@Requested_By   
--Order by A.Request_Id Desc   
  
  
  
Select A.Request_Id As [Request Id],  
convert(varchar(11),A.Request_Date,103) as [Request Date],  
B.Product_Name As [Item Name],  
C.Model_Name As [Model Name],  
A.Model_Quantity as [Model Quantity],  
D.department As [Department]  
  
--(select top 1 u_role from tbl_recommendation_limitmaster where rec_limitto > A.Estimated_Total_Price  
--intersect  
--select top 1 u_role from tbl_recommendation_limitmaster where rec_limitfrom < A.Estimated_Total_Price) As [For Recommendation]  
  
from  tbl_RequestMaster(nolock) A  
inner join tbl_CapexProductMaster B On  
A.Item_Code=B.Product_Code  
inner join tbl_ProductModelMaster C On  
A.Model_No=C.Model_Id  
inner join Emp_Info D On  
A.Requested_By=D.emp_no  
where A.Status_Code in ('P','InReview') and A.Requested_By=@Requested_By  
Order by A.Request_Id Desc   
  
  
--select u_role from tbl_recommendation_limitmaster where rec_limitto > A.Estimated_Total_Price  
--intersect  
--select u_role from tbl_recommendation_limitmaster where rec_limitfrom < A.Estimated_Total_Price  
--  
--select* from tbl_requestmaster

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequestView_AdminRequester
-- --------------------------------------------------





CREATE proc [dbo].[usp_ITRequestView_AdminRequester](@Requested_By varchar(7))        
as

Begin


   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


Select A.Request_Id As [Request Id],convert(varchar(11),A.Request_Date,103) as [Request Date],
B.Product_Name As [Item Name],C.Model_Name As [Model Name],A.Model_Quantity as [Model Quantity],
D.department As [Department],A.AdminReq_forBranch As [For Branch]

--(select top 1 u_role from tbl_recommendation_limitmaster where rec_limitto > A.Estimated_Total_Price
--intersect
--select top 1 u_role from tbl_recommendation_limitmaster where rec_limitfrom < A.Estimated_Total_Price) As [For Recommendation]

from  tbl_RequestMaster(nolock) A
inner join tbl_CapexProductMaster B On A.Item_Code=B.Product_Code
inner join tbl_ProductModelMaster C On A.Model_No=C.Model_Id
inner join Emp_Info D On A.Requested_By=D.emp_no
where A.Status_Code = 'P' and A.Requested_By=@Requested_By
Order by A.Request_Id Desc 


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ITTaxes
-- --------------------------------------------------
--created by :  
--modified by:Zeba Raje  
  
CREATE PROC [dbo].[Usp_ITTaxes] (@Fld_RequestID NVARCHAR(max),  
                                @Fld_Excise    FLOAT,  
                                @Fld_Edn_Cess  FLOAT,  
                                @Fld_CST       FLOAT,  
                                @Fld_VAT       FLOAT,  
                                @Fld_Service   FLOAT,  
                                @Fld_Frieght   FLOAT,  
                                @Fld_Octroi    FLOAT,  
                                @Fld_Discount  FLOAT,  
                                @Fld_Status    VARCHAR(10),  
                                @Userid        CHAR(20))  
AS  
    --delete from tbl_it_Taxes where Fld_RequestId = @Fld_RequestID    
    --IF EXISTS (SELECT *  
    --           FROM   tbl_it_Taxes  
    --           WHERE  fld_requestid = @Fld_RequestID)  
    --  BEGIN  
    --      UPDATE tbl_it_Taxes  
    --      SET    Fld_Excise = @Fld_Excise,  
    --             Fld_Edn_Cess = @Fld_Edn_Cess,  
    --             Fld_CST = @Fld_CST,  
    --             Fld_VAT = @Fld_VAT,  
    --             Fld_Service = @Fld_Service,  
    --             Fld_Frieght = @Fld_Frieght,  
    --             Fld_Octroi = @Fld_Octroi,  
    --             Fld_Discount = @Fld_Discount,  
    --             Fld_Status = @Fld_Status,  
    --             Generated_By = @Userid,  
    --             Generated_Date = Getdate(),  
    --             Modified_By = @Userid,  
    --             Modified_Date = Getdate()  
    --      WHERE  Fld_RequestID = @Fld_RequestID  
    --  END  
    --ELSE  
      BEGIN  
          INSERT INTO tbl_it_Taxes  
          VALUES      ( @Fld_RequestID,  
                        @Fld_Excise,  
                        @Fld_Edn_Cess,  
                        @Fld_CST,  
                        @Fld_VAT,  
                        @Fld_Service,  
                        @Fld_Frieght,  
                        @Fld_Octroi,  
                        @Fld_Discount,  
                        @Fld_Status,  
                        --Genetated_By    
                        @Userid,  
                        --Generated_Date    
                        Getdate(),  
                        --Modifiied_by    
                        @Userid,  
                        --Modified_Date    
                        Getdate() )  
      END  
  
    ------------------------Insert into Log ie tbl_it_taxes_log-------------------------    
    --Note    
    INSERT INTO tbl_it_Taxes_Log  
    VALUES      ( @Fld_RequestID,  
                  @Fld_Excise,  
                  @Fld_Edn_Cess,  
                  @Fld_CST,  
                  @Fld_VAT,  
                  @Fld_Service,  
                  @Fld_Frieght,  
                  @Fld_Octroi,  
                  @Fld_Discount,  
                  @Fld_Status,  
                  --Modified_By    
                  @Userid,  
                  --Modified_Date    
                  Getdate() )  
-----------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Mailer_Options
-- --------------------------------------------------
        
CREATE proc [dbo].[Usp_Mailer_Options]                           
@option varchar(10),                               
@Request_ID1 varchar(8)                               
                                
as                               
    
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
   
                    
DECLARE @BODY1 NVARCHAR(max)                               
DECLARE @BODY2 NVARCHAR(max)                               
DECLARE @BODY3 NVARCHAR(max)                               
DECLARE @BODY4 NVARCHAR(max)                    
DECLARE @BODY5 NVARCHAR(max)                
DECLARE @BODY6 NVARCHAR(max)                               
DECLARE @BODY7 NVARCHAR(max)                               
DECLARE @HTMLBODY NVARCHAR(max)                               
DECLARE @HTMLBODY1 NVARCHAR(max)                               
DECLARE @HTMLBODY2 NVARCHAR(max)                    
DECLARE @HTMLBODY3 NVARCHAR(max)                    
DECLARE @HTMLBODY5 NVARCHAR(max)                    
DECLARE @HTMLBODY4 NVARCHAR(max)                 
 DECLARE @HTMLBODY6 NVARCHAR(max)                
DECLARE @HTMLBODY7 NVARCHAR(max)                 
                 
DECLARE @HTML NVARCHAR(max)                  
DECLARE @HTML1 NVARCHAR(max)                               
DECLARE @HTML2 NVARCHAR(max)                               
DECLARE @SUB NVARCHAR(max)                               
DECLARE @EMAILID NVARCHAR(max)                               
DECLARE @EMAILIDBM NVARCHAR(max)                               
DECLARE @EMAILIDQC NVARCHAR(max)                               
DECLARE @EMAILTRAINER VARCHAR(500)                               
DECLARE @CNT INT                               
DECLARE @COUNT INT                               
DECLARE @TOTAL INT                                 
DECLARE @TRID INT                               
DECLARE @ETO VARCHAR(100)                               
DECLARE @EMP VARCHAR(10)                               
DECLARE @EMPMAIL VARCHAR(500)                               
DECLARE @MODULE VARCHAR(100)                               
DECLARE @REGION VARCHAR(100)                               
DECLARE @REASON VARCHAR(500)                               
declare @requested_by varchar(437)                       
declare @Category char(10)                            
declare @BranchCode char(20)                            
declare @U_Role char(100)                            
declare @Estimated_Total_Price float                            
Declare @RecommenderList nvarchar(max)                            
Declare @ApproverList nvarchar(max)                      
Declare @status nvarchar(max)                
                    
                 
                
                
set @status =(select status_code from tbl_requestmaster where request_id=@Request_ID1)                
print @status                
                           
set @BranchCode=(Select e.branch_cd From Emp_Info e                      
inner join    tbl_requestmaster r on r.requested_by=e.Emp_No where r.request_id= @Request_ID1 and e.status='A')                            
if(@BranchCode in (select branch_cd from tbl_CSO_Branch(nolock)))                        
                      
Begin                            
 Set @Category='CSO'                            
End                            
else                            
Begin                            
  Set @Category='Branch'                            
End                             
                       
                      
set @U_Role=(Select e.Designation From Emp_Info e                      
inner join    tbl_requestmaster r on r.requested_by=e.Emp_No where r.request_id= @Request_ID1 and e.status='A')                        
                       
 if(@U_Role not in ('Regional Head','Regional Manager','Zonal Head','Zonal Manager','Associate Director',' Sr. Assistant Vice President','Head'))                            
Begin                            
 set @U_Role='User'                            
End                            
                            
Set @Estimated_Total_Price = (Select Estimated_total_Price From tbl_RequestMaster Where Request_Id = @Request_Id1)                            
                      
Set @RecommenderList = (Select substring( ( SELECT ', ' + rtrim(U_Role)                             
      FROM tbl_recommendation_LimitMaster                             
      Where @Estimated_Total_Price between Rec_LimitFrom and Rec_LimitTo and Category = @Category                             
      FOR XML path(''), elements),2,500))                             
                    
Set @ApproverList = (Select substring( ( SELECT ', ' + rtrim(U_Role)                             
     FROM tbl_Approval_LimitMaster                      
        Where @Estimated_Total_Price between Apr_LimitFrom and Apr_LimitTo and Category = @Category                             
     FOR XML path(''), elements),2,500))               
Set @ApproverList = (Select Replace (@ApproverList,'Head','Head-IT'))                            
                     
insert into newreq                      
Select @U_Role As [Request Initiated By],@Estimated_Total_Price As[Requested Item Amount],                            
 @RecommenderList As [Who Can Recommend],@ApproverList As [Who Can Approve]                        
                         
Select Distinct(EI.Emp_no) As [Emp_No],EI.Emp_Name As [Emp_Name],EI.Department As [Department],                                 
EI.Designation As [Designation],EI.Branch_Cd As [BranchCode],EI.EmailAdd As [EmailAdd],PHONE As [ContactNumber], Requested_By                
into #recomender                                 
from tbl_requestRecApr RRA                                 
Inner Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no                               
Inner Join tbl_RequestMaster RM On RRA.Request_Id = RM.Request_Id                                 
where RRA.Request_Id = @Request_ID1 and RRA.[Role] = 'R' and RRA.Emp_Code <> RM.Requested_By                                 
                                
Select Distinct(EI.Emp_no) As [Emp_No],EI.Emp_Name As [Emp_Name],EI.Department As [Department],                                 
EI.Designation As [Designation],EI.Branch_Cd As [BranchCode],EI.EmailAdd As [EmailAdd],PHONE As [ContactNumber] , Requested_By                              
into #Approval                               
from tbl_requestRecApr RRA                             
Inner  Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no                               
Inner Join tbl_RequestMaster RM On RRA.Request_Id = RM.Request_Id                                 
where RRA.Request_Id = @Request_ID1 and RRA.[Role] = 'A' and RRA.Emp_Code <> RM.Requested_By                              
                                
                    
 select RM.Request_Id As [Request_Id],EI.Emp_Name As [Requested_By], Convert(varchar(11),RM.Request_Date,113) As [Request_Date],                      
     CPM.Product_name As [Item_Name],PMM.Model_Name As [Model_Name],                      
     RM.Model_Quantity As [Quantity],RM.Estimated_Total_Price As [Estimated_Total_Price],                      
     JM.Justification_Name As [Justification_Remark],RM.User_remark As [User_Remark],ISNULL(Recommended_by,'') As [Recommended_By],                
     ISNULL(Recommended_datetime,'') as [Recommended_On],ISNULL(approved_by,'') as [Approbved_By],ISNULL(approved_datetime,'') as [Approved_On],                
     EI2.emailadd As [Requested_By_EmailAdd]                    
     into #newrequestmail                      
    from tbl_RequestMaster RM                      
    Left Outer Join Emp_Info EI on RM.Requested_By = EI.Emp_No                      
    Left Outer Join tbl_CapexProductMaster CPM on RM.Item_Code = CPM.Product_Code                      
    Left Outer Join tbl_ProductModelMaster PMM on RM.Model_No = PMM.Model_Id                      
    Left Outer Join tbl_JustificationMaster JM on RM.Justification_Id = JM.Justification_Id                      
    Left Outer Join Emp_Info EI2 on RM.Requested_By = EI2.Emp_no                         Where RM.Request_Id = @Request_ID1                     
                               
                               
                               
   select RM.Request_Id As [Request_Id],EI.Emp_Name As [Requested_By], Convert(varchar(11),RM.Request_Date,113) As [Request_Date],                      
     CPM.Product_name As [Item_Name],PMM.Model_Name As [Model_Name],                      
     RM.Model_Quantity As [Quantity],RM.Estimated_Total_Price As [Estimated_Total_Price],                      
     JM.Justification_Name As [Justification_Remark],RM.User_remark As [User_Remark],ISNULL(Recommended_by,'') As [Recommended_By],                
     ISNULL(Recommended_datetime,'') as [Recommended_On]          
     into #RECOMMENDER                      
    from tbl_RequestMaster RM                  
    Left Outer Join Emp_Info EI on RM.Requested_By = EI.Emp_No                      
    Left Outer Join tbl_CapexProductMaster CPM on RM.Item_Code = CPM.Product_Code                      
    Left Outer Join tbl_ProductModelMaster PMM on RM.Model_No = PMM.Model_Id                      
    Left Outer Join tbl_JustificationMaster JM on RM.Justification_Id = JM.Justification_Id                      
    Left Outer Join Emp_Info EI2 on RM.Requested_By = EI2.Emp_no                      
   Where RM.Request_Id = @Request_ID1           
                               
                               
                
                
         select RM.Request_Id As [Request_Id],EI.Emp_Name As [Requested_By], Convert(varchar(11),RM.Request_Date,113) As [Request_Date],                      
     CPM.Product_name As [Item_Name],PMM.Model_Name As [Model_Name],                      
     RM.Model_Quantity As [Quantity],RM.Estimated_Total_Price As [Estimated_Total_Price],                      
     JM.Justification_Name As [Justification_Remark],RM.User_remark As [User_Remark],ISNULL(Recommended_by,'') As [Recommended_By],                
     ISNULL(Recommended_datetime,'') as [Recommended_On],ISNULL(approved_by,'') as [Approbved_By],          
     ISNULL(approved_datetime,'') as [Approved_On],                
     EI2.emailadd As [Requested_By_EmailAdd]                    
     into #APPROVER                      
    from tbl_RequestMaster RM                      
    Left Outer Join Emp_Info EI on RM.Requested_By = EI.Emp_No                      
    Left Outer Join tbl_CapexProductMaster CPM on RM.Item_Code = CPM.Product_Code                      
    Left Outer Join tbl_ProductModelMaster PMM on RM.Model_No = PMM.Model_Id                      
    Left Outer Join tbl_JustificationMaster JM on RM.Justification_Id = JM.Justification_Id                      
    Left Outer Join Emp_Info EI2 on RM.Requested_By = EI2.Emp_no                      
   Where RM.Request_Id = @Request_ID1           
                               
                               
                               
                               
                               
select @EMPMAIL=ei.[EmailAdd],@EMAILID=RM.[EmailAdd]--+';Fatima.Kazi@angelbroking.com'        
,        
@requested_by=ei.emp_name                            
from #recomender  rm                                
join  Emp_Info EI On Rm.requested_by = EI.Emp_no                                 
                                
if(@option='1')                               
                                
BEGIN                        
if(@status='P' and @status is not null)                
begin                
                    
EXEC [DBA_ConvertQueryInHTMP_Page]                                
'Select [Request_Id],[Requested_By],[Request_Date],[Item_Name],[Model_Name],[Quantity],[Estimated_Total_Price],[Justification_Remark],[User_Remark]                    
from   #newrequestmail  WITH (NOLOCK)',@HTMLBODY4 OUTPUT                     
                    
SELECT @BODY4 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;"><BR/>                               
Dear '+@requested_by+',<BR/><BR/> Management has finalized an Authorization Policy for approval of various expenses based on the amount                    
and the purpose for which they are incurred.                    
<BR/></td></tr></table>'                               
                    
SELECT @BODY5 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;"><BR/>                  
According the new policy every request should get first recommend from users departmental or business                    
head and then get approve by IT Management Team.                    
<BR/></td></tr></table>'                               
                    
EXEC [DBA_ConvertQueryInHTMP_Page]                                
'Select U_Role,Requested_amount,who_can_recommend,who_can_approve                             
from   newreq  WITH (NOLOCK)',@HTMLBODY3 OUTPUT                               
Delete   newreq                                
                                
SELECT @BODY3 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;"><BR/>                               
<BR/> As per amount of your request following are details of approvals require.<BR/><BR/></td></tr></table>'                               
                              
                           
EXEC [DBA_ConvertQueryInHTMP_Page]                                
'Select[Emp_No],[Emp_Name],[Department] ,[Designation],[BranchCode],[EmailAdd],[ContactNumber]                               
from  #recomender  WITH (NOLOCK)',@HTMLBODY OUTPUT                               
DROP TABLE #recomender                                
                                
SELECT @BODY1 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;"><BR/>                            
<BR/> For Your Request List of Recommenders and Approvers, any of them can approve your request<BR/><BR/></td></tr></table>'                               
                              
                                
EXEC [DBA_ConvertQueryInHTMP_Page]                                
'Select[Emp_No],[Emp_Name],[Department] ,[Designation],[BranchCode],[EmailAdd],[ContactNumber]                               
from  #Approval  WITH (NOLOCK)',@HTMLBODY1 OUTPUT                                 
DROP TABLE #Approval                              
                                
select @body2='<br/><br/>'                
                
End                
                
else if(@status='R' and @status is not null)                
begin                
EXEC [DBA_ConvertQueryInHTMP_Page]                                
'Select [Request_Id],[Requested_By],[Request_Date],[Item_Name],[Model_Name],[Quantity],[Estimated_Total_Price],[Justification_Remark],[User_Remark],                    
[Recommended_By],[Recommended_On]                
from   #RECOMMENDER  WITH (NOLOCK)',@HTMLBODY4 OUTPUT                     
DROP TABLE  #RECOMMENDER           
                  
SELECT @BODY4 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;"><BR/>                               
Dear '+@requested_by+',<BR/><BR/> Your following request has been approved.                     
<BR/></td></tr></table>'                 
                
end                
                
else if(@status='A' and @status is not null)                
begin                
                
EXEC [DBA_ConvertQueryInHTMP_Page]                                
'Select [Request_Id],[Requested_By],[Request_Date],[Item_Name],[Model_Name],[Quantity],[Estimated_Total_Price],[Justification_Remark],[User_Remark],                    
[Recommended_By],[Recommended_On],[Approbved_By],[Approved_On]                
from   #APPROVER  WITH (NOLOCK)',@HTMLBODY4 OUTPUT                     
 DROP TABLE #APPROVER           
           
                    
SELECT @BODY4= '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;"><BR/>                               
Dear '+@requested_by+',<BR/><BR/> Your following request has been approved.                     
<BR/></td></tr></table>'                 
end                
END                              
                                
--SELECT @HTML = @BODY1+@HTMLBODY+@BODY2+@HTMLBODY1                                
SELECT @HTML = isnull(@BODY4,'')+isnull(@BODY5,'')+isnull(@HTMLBODY4,'')+ISNULL(@BODY3, '')+ISNULL(@HTMLBODY3, '')+ISNULL(@BODY1, '')+ISNULL(@HTMLBODY, '')+ISNULL(@BODY2, '')+ISNULL(@HTMLBODY1, '')     
                
                
                
SELECT @SUB = @Request_ID1+' - IT Assets New Request'                              
                              
EXEC msdb.dbo.sp_send_dbmail                               
@profile_name = 'ITasset@angelbroking.com',                               
@recipients = @EMPMAIL,                               
@copy_recipients = @EMAILID,                               
@blind_copy_recipients = 'zeba.raje@angelbroking.com', --; Sanjay.Ghosh@AngelBroking.Com',                               
@subject = @SUB,                              
@body = @HTML,                
@body_format = 'HTML'                
--@reply_to='zeba.raje@angelbroking.com'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Mis_PO_Report
-- --------------------------------------------------


CREATE proc [dbo].[Usp_Mis_PO_Report]
@FrmDate datetime,
@ToDate datetime,
@Branch varchar(100),
@Vendor Varchar(100),
@PONO varchar(200),
@Option varchar(20)
as

Begin
 If(@Option = '1')
 Begin
 
 
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

    
	Declare @TDate As Varchar(12)
	Declare @FDate As Varchar(12)

 	Set @TDate = Convert(Datetime, Convert(Varchar(12),Convert(Datetime,@ToDate),113)) 
	Set @FDate = Convert(Datetime, Convert(Varchar(12),Convert(Datetime,@FrmDate),113))


  Declare @Query varchar(Max)
  
  set @Query='select Fld_PurchaseOrderNo as [PONO],compName as [Companyname] ,  Fld_VendorName as [VendorName] ,
              Fld_ShipTo as [ShipTo], Fld_ShippingMethod as [ShippingMethod],Fld_OrderTerms as [Orderterms],
              POBranch as [BranchCode]
			  From dbo.tbl_ItRequestPurchaseOrder PO , dbo.tbl_it_AngelGroupofCompaniesMaster CM
              where CM.CompID=PO.Fld_CompId' 
--
--
--set @Query='select Fld_PurchaseOrderNo as [PONO],compName as [Companyname] ,  Fld_VendorName as [VendorName] ,
--            Fld_ShipTo as [ShipTo], Fld_ShippingMethod as [ShippingMethod],Fld_OrderTerms as [Orderterms],
--            POBranch as [BranchCode] from dbo.tbl_ItRequestPurchaseOrder PO , dbo.tbl_it_AngelGroupofCompaniesMaster CM
--            where CM.CompID=PO.Fld_CompId  and Convert(Datetime, Convert(Varchar(12),Convert(Datetime, PO.Generated_Date),113))
--			Between ''' + @FDate + ''' And ''' + @TDate + ''''
 If(@ToDate <> '' and @FrmDate <> '')
     Begin
		print(@Query)
      set @Query=@Query + ' and Convert(Datetime,convert(varchar(12),PO.Generated_Date,113)) between (''' + Convert(varchar(12),@FrmDate,113) + ''') and (''' + Convert(varchar(12),@ToDate,113) +''')'
   End

	print (@Query)

 If(@Branch <> '')
    Begin
     Set @Query = @Query + ' and PO.POBranch= ''' + @Branch + ''' '
    End

If(@Vendor <> '')
	Begin
		Set @Query = @Query + ' And PO.Fld_VendorId = '''+ @Vendor + ''''
	End

 If(@PONO  <> '')
    Begin
      Set @Query = @Query + ' and PO.Fld_PurchaseOrderNo= ''' + @PONO + ''' '
    End


	set @Query = @Query + 'Order By PO.Generated_Date'
	print (@Query)
	Exec (@Query)
End

Else if(@Option ='2')
Begin
   select Fld_RequestId,PO_Status As [POStatus]
  from dbo.tbl_ItRequestPurchaseOrder where Fld_PurchaseOrderNo=@PONO
End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ModelMasterAllinOne
-- --------------------------------------------------




CREATE Proc [dbo].[USP_ModelMasterAllinOne] 
(
@Option char(20),
@ModelCode CHAR(20),
@ModelName varchar(100),
@ProductCode CHAR(20),
@UnitPrice FLOAT,
@Userid char(20)
)
As
Begin


   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 




if(@Option = 'ProductDetails')
	Begin
		Select Product_Name,Product_Code 
		From tbl_CapexProductMaster 
		Where Flag='1'

	End

else if (@Option = 'ModelDetails')
	Begin
		Select Model_Name,Model_Id
		FROM tbl_ProductModelMaster
		WHERE  Product_Code =@ProductCode AND  Flag='1'

	END
	
	else if (@Option = 'ModelName')
	Begin
		SELECT Model_Id,Model_Name,Unit_Price
		FROM tbl_ProductModelMaster
		WHERE  Model_Id =@ModelCode AND  Flag='1'

	End



else if(@Option = 'GetDetails')
	Begin

	Declare @Query nvarchar(max)
	Set @Query = 'SELECT PMM.Model_Id AS [Model Id],PMM.Model_Name AS [Model Name],
						CPM.Product_Name AS [Product Name],PMM.Unit_Price AS [Unit Price],
						[Status] = CASE PMM.Flag
						WHEN ''1'' THEN ''ACTIVE''
						WHEN ''0'' THEN ''DISABLE''
						END
					FROM tbl_ProductModelMaster PMM 
					LEFT OUTER JOIN tbl_CapexProductMaster CPM ON PMM.Product_Code = CPM.Product_Code
					WHERE 1=1'

	if(@ModelCode <> '')
	set @Query = @Query + ' And PMM.Model_Id = '''+ @ModelCode+''''
	PRINT (@Query)
	IF(@ProductCode <> '')
	set @Query = @Query + ' And PMM.Product_Code = '''+ @ProductCode+''''
	PRINT(@Query)
	Exec(@Query)
	
	End

else if (@Option = 'CheckExistingAdd')
	Begin
		Select	Model_Name
				from tbl_ProductModelMaster
				where Model_Name = @ModelName
				
	End

else if (@Option = 'CheckExistingEdit')
	Begin
		Select	Model_Name
				from tbl_ProductModelMaster
				where Model_Name = @ModelName
				
	End

else if (@Option = 'CheckExistingDelete')
	Begin
		Select Model_Id,Model_Name
				from tbl_ProductModelMaster
				where Model_Id = @ModelCode
				
	End

else if(@Option = 'Add')
	Begin
		Insert into tbl_ProductModelMaster(Model_Id,Model_Name,Product_Code,Unit_Price,Flag,Added_By,Added_On,Modified_By,Modified_Date)
				Values(@ModelCode,@ModelName,@ProductCode,@UnitPrice,'1',@Userid,getdate(),@Userid,getdate())
				
				
			----------Make An entry in log----------
			INSERT INTO tbl_ProductModelMaster_Log(Model_Id,Model_Name,Product_Code,Unit_Price,Flag,Added_By,
											Added_On,Modified_By,Modified_Date)
			SELECT Model_Id,Model_Name,Product_Code,Unit_Price,Flag,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_ProductModelMaster
			WHERE Model_Id = @ModelCode
			------------------------------------					
				
	End

else if (@Option = 'Edit')
	Begin
		Update tbl_ProductModelMaster
			set Model_Name = @ModelName,
				--Product_Code = @Address1 ,
				Unit_Price = @UnitPrice,
				Modified_By = @Userid,
				Modified_Date = GETDATE()
			Where Model_Id = @ModelCode
			
			
			----------Make An entry in log----------
			INSERT INTO tbl_ProductModelMaster_Log(Model_Id,Model_Name,Product_Code,Unit_Price,Flag,Added_By,
											Added_On,Modified_By,Modified_Date)
			SELECT Model_Id,Model_Name,Product_Code,Unit_Price,Flag,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_ProductModelMaster
			WHERE Model_Id = @ModelCode
			------------------------------------				
			
	End

else if(@Option = 'Delete')
	Begin
		Update tbl_ProductModelMaster
			set Flag= '0',
				Modified_By = @Userid,
				Modified_Date = getdate()
			Where Model_Id = @ModelCode
			
			
			
			----------Make An entry in log----------
			INSERT INTO tbl_ProductModelMaster_Log(Model_Id,Model_Name,Product_Code,Unit_Price,Flag,Added_By,
											Added_On,Modified_By,Modified_Date)
			SELECT Model_Id,Model_Name,Product_Code,Unit_Price,Flag,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_ProductModelMaster
			WHERE Model_Id = @ModelCode
			------------------------------------				
			
	End





End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PORequests
-- --------------------------------------------------







CREATE  Procedure [dbo].[USP_PORequests]
As
Begin



   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 



	Select distinct(RM.Request_Id) As [Request Id],CPM.Product_Name As [Item Name],
			PMM.Model_Name As [Model Name],SID.Warranty_Type As [Warranty Type],
			EI.Emp_Name As [Requested by],SM.Status_Name As [Status of Request]
		from tbl_RequestMaster RM 
			Left Outer Join tbl_CapexProductMaster CPM on RM.Item_Code = CPM.Product_code
			Left Outer Join tbl_ProductModelMaster PMM on RM.Model_No = PMM.Model_Id
			Left Outer Join Emp_Info EI on RM.Requested_By = EI.Emp_No
			Left Outer Join tbl_StatusMaster SM on RM.status_code = SM.status_Code
			Left Outer Join tbl_stockinventorydetails SID on RM.request_Id= SID.Request_Id and RM.Status_Code = SID.Assign_Type
		Where RM.Status_Code='PO'






End

-- Convert(int,RM.Model_Quantity) - Convert (int,RM.Model_Quantity_Assigned)  This Is the Model Quantity To Be Purchased

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ProbInGenPO
-- --------------------------------------------------
CREATE Proc [dbo].[USP_ProbInGenPO]
@Fld_PurchaseOrderNo Varchar(100)

As

Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


--
--USP_ProbInGenPO 'AKT/MUM/28/12/201062'

Declare @Request_Id nvarchar(MAX)
Set @Request_Id = (Select Fld_requestId From tbl_ITRequestPurchaseOrder Where Fld_PurchaseOrderNo = @Fld_PurchaseOrderNo)

Delete From tbl_ITRequestPurchaseOrder Where Fld_RequestId = @Request_Id
Delete From tbl_ITRequestPurchaseOrder_Log Where Fld_RequestId = @Request_Id

Delete From tbl_IT_Taxes Where Fld_RequestId = @Request_Id
Delete From tbl_IT_Taxes_Log Where Fld_RequestId = @Request_Id


Declare @Query nvarchar(MAX)
Set @Query = 'Delete from tbl_StockInventoryDetails Where Request_Id in ('+@Request_Id+')
			  Delete from tbl_StockInventoryDetails_Log Where Request_Id in ('+@Request_Id+')'

Exec(@Query)

Declare @Query2 nvarchar(MAX)
Set @Query2 = 'Update tbl_RequestMaster
				Set Status_Code = ''A'',
				Model_Quantity_Assigned = ''0''
				Where Request_Id in ('+@Request_Id+')' 
Exec(@Query2)



--Declare @Request_Id nvarchar(MAX)
--Set @Request_Id = (Select Fld_requestId From tbl_ITRequestPurchaseOrder Where Fld_PurchaseOrderNo = @Fld_PurchaseOrderNo)
--
--Select * From tbl_ITRequestPurchaseOrder Where Fld_RequestId = @Request_Id
--Select * From tbl_ITRequestPurchaseOrder_Log Where Fld_RequestId = @Request_Id
--
--Select *  From tbl_IT_Taxes Where Fld_RequestId = @Request_Id
--Select  * From tbl_IT_Taxes_Log Where Fld_RequestId = @Request_Id
--
--
--Declare @Query nvarchar(MAX)
--Set @Query = 'Select *  from tbl_StockInventoryDetails Where Request_Id in ('+@Request_Id+')
--			  Select * from tbl_StockInventoryDetails_Log Where Request_Id in ('+@Request_Id+')'
--Exec(@Query)
--
--
--Declare @Query2 nvarchar(MAX)
--Set @Query2 = 'Select * From  tbl_RequestMaster
--				Where Request_Id in ('+@Request_Id+')' 
--Exec(@Query2)





End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RecommendationOther
-- --------------------------------------------------
    
    /*
    USP_RecommendationOther 'BRANCH','R','E39377'
    
    */
    
    
CREATE Procedure [dbo].[USP_RecommendationOther]    
(@Accesscode char(25),@Type varchar(5),@UserID varchar(15))                                            
    
As    
    
    
Begin 

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

   
Declare @Query as nvarchar(max)    
set @Query= 'select  Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],
A.Estimated_Total_Price as[Estimated_Total_Price],D.Emp_Name As [Requested_By],D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],D.Department As[Department],D.Sr_Name As[HOD],A.User_Remark As [User_Remark],f.Remark as [Review Remark],f.ReviewDate as [Review Date]--,F.Status_Name As [Status_Name]    
                  from tbl_RequestMaster A    
                        Left Outer Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code     
                        Left Outer Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id     
                        inner join     
      (Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info     
       UNION ALL     
      Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D    
       on A.Requested_By = D.emp_no    
      Left Outer Join tbl_RequestRecApr E on A.Request_Id = E.Request_Id    
         inner join Tbl_ReviewRemarks F on A.Request_Id = F.Request_Id    

     where E.Emp_Code = '''+@UserID+''' And E.Role = ''OR''     
      and ISNULL(A.Recommended_By,'''') <> '''+ @UserID +''' and      
      A.Status_Code in (''P'',''L1R'') and E.Emp_Code <> A.Requested_By '    
       
    
    
if ( @Type='R')     
begin     
    
      if( @Accesscode='BRANCH')    
      Begin    
--      
  Set @Query = @Query + ' And D.Branch_Cd not in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'       
   Print(@Query)    
   Exec(@Query)    
      
      End    
      else if(@AccessCode='CSO')    
      Begin    
   Set @Query = @Query + ' And D.Branch_Cd  in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'       
   Print(@Query)    
   Exec(@Query)    
    
   End    
End    
    
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RecommendationOther_bk_29Dec2017
-- --------------------------------------------------
    
    
    
    
create Procedure [dbo].[USP_RecommendationOther_bk_29Dec2017]    
(@Accesscode char(25),@Type varchar(5),@UserID varchar(15))                                            
    
As    
    
    
Begin 

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

   
Declare @Query as nvarchar(max)    
set @Query= 'select  Distinct(A.Request_Id) As [Request_Id],convert(varchar(11),A.Request_Date,103) As [Request_Date],B.Product_Name As[Item_Name],C.Model_Name As [Model_Name],A.Model_quantity As [Model_Quantity],
A.Estimated_Total_Price as[Estimated_Total_Price],D.Emp_Name As [Requested_By],D.Emp_No as [Requester_No],D.Branch_cd As[Branch_cd],D.Department As[Department],D.Sr_Name As[HOD],A.User_Remark As [User_Remark]--,F.Status_Name As [Status_Name]    
                  from tbl_RequestMaster A    
                        Left Outer Join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code     
                        Left Outer Join tbl_ProductModelMaster C on A.Model_No=C.Model_Id     
                        inner join     
      (Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_info     
       UNION ALL     
      Select Emp_No,Emp_Name,Branch_Cd,Department,Sr_Name from Emp_Info_Sep)D    
       on A.Requested_By = D.emp_no    
      Left Outer Join tbl_RequestRecApr E on A.Request_Id = E.Request_Id    
     where E.Emp_Code = '''+@UserID+''' And E.Role = ''OR''     
      and ISNULL(A.Recommended_By,'''') <> '''+ @UserID +''' and      
      A.Status_Code in (''P'',''L1R'') and E.Emp_Code <> A.Requested_By '    
       
    
    
if ( @Type='R')     
begin     
    
      if( @Accesscode='BRANCH')    
      Begin    
--      
  Set @Query = @Query + ' And D.Branch_Cd not in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'       
   Print(@Query)    
   Exec(@Query)    
      
      End    
      else if(@AccessCode='CSO')    
      Begin    
   Set @Query = @Query + ' And D.Branch_Cd  in (select branch_cd from tbl_CSO_Branch(nolock)) Order By A.Request_Id desc'       
   Print(@Query)    
   Exec(@Query)    
    
   End    
End    
    
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RecommenderSeparationMail
-- --------------------------------------------------

CREATE Proc[dbo].[USP_RecommenderSeparationMail]
As


Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

--------------------------------------------------------------------------------------------------
--As ConvertQueryInHTMP_PageComman does work the first time so the following lines are excuted
--just for the purpose of making it to work it has no releation with this sp
Declare @HTMLBODY_TEST varchar(max)
exec ConvertQueryInHTMP_PageComman 'Select * from tbl_CapexMaster', @HTMLBODY_TEST output
--------------------------------------------------------------------------------------------------

Select distinct RM.Request_Id As [Request_Id],RECAPR.Emp_Code As [SepRec_EmpCode],EmpS.Emp_Name As [SepRec_Name],
		Convert(Varchar(11),EmpS.Separation_Date,113) As [SepRec_Date],EmpS.Senior As [SepRecHOD_EmpCode],
	(CASE WHEN EmpS.Senior <> '' THEN (Select Emp_Name From Emp_Info Where Emp_no = EmpS.Senior)
		ELSE '' END) As [SepRecHOD_Name],
	(CASE WHEN EmpS.Senior <> '' THEN (Select EmailAdd From Emp_info Where Emp_No = EmpS.Senior)
		ELSE '' END) As[SepRecHOD_Email],
	(CASE WHEN RM.Requested_by <> '' THEN (Select Emp_Name From Emp_Info Where Emp_No = RM.Requested_by)
		ELSE '' End) As [RequestedBy],
	(CASE WHEN ISNULL(Item_Code,'') <> '' THEN (Select Product_Name from tbl_CapexProductMaster where Item_Code = Product_Code) ELSE '' END) As [ItemName],
	(CASE WHEN ISNULL(Model_No,'') <> '' THEN (Select Model_Name from tbl_ProductModelMaster where Model_No = Model_Id) ELSE '' END) As [ModelName],
	RM.Model_Quantity As [ModelQuantity],RM.Estimated_Total_Price As [EstimatedTotalPrice],
	(Case WHEN ISNULL(RM.Status_Code,'')<> '' THEN (Select Status_Name From tbl_StatusMaster Where Status_Code = RM.Status_Code) ELSE '' END) As [Status],
	(Case WHEN ISNULL(RM.Requested_by,'')<> '' THEN (Select Branch_Cd from Emp_info where Emp_No = RM.Requested_By) ELSE '' END)As [RequesterbranchCode]
	
Into #Temp
From tbl_RequestRecApr RECAPR ,tbl_RequestMaster RM,Emp_Info_Sep EmpS
Where RECAPR.Request_Id=RM.Request_Id And Role = 'R' and  RECAPR.Emp_Code = EmpS.Emp_No
And RM.Status_Code  in  ('P','L1R') 

------------------------------------------------------------------------------------------------------
--This Part is Used to get data from #Temp on daily basis for Veriftcation
Declare @HTMLBODY_GetTempData1 varchar(max)
Declare @HTMLBODY_GetTempDataFinal varchar(Max)
exec ConvertQueryInHTMP_PageComman 'Select * From #Temp', @HTMLBODY_GetTempData1 output

Set @HTMLBODY_GetTempDataFinal='<HTML><HEAD><TITLE>Requester Separation Report</TITLE><STYLE TYPE=''text/css''>' +

								'.MyTable th{width: auto; border-right: white 1px solid; border-top: white 1px solid;' +
								' font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4;border-bottom: white 1px solid;'+
								' font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;};'+
								'.MyTable th{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left:'+    
								'white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;};' +



								'.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid;' +
								' font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4;border-bottom: white 1px solid;'+
								' font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;};'+
								'.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left:'+    
								'white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;};' +
								'.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color:'+	        
								'#3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;};'+
								'</STYLE></HEAD><Body> '+@HTMLBODY_GetTempData1+'</Body></HTML>'
EXEC msdb.dbo.sp_send_dbmail                         
	@profile_name = 'ITassets',                                               
	@recipients='vishal.malagi@angelbroking.com' , -- Put this As @recipients testing-- vishal.malagi@angeltrade.com; Live--@Rec_EmailAdd                                       
	@subject = 'Recommender Separation Temp Data',                        
	@body = @HTMLBODY_GetTempDataFinal,                        
	@body_format = 'HTML' 

---------------------------------------------------------------------------------------------------------


if((Select Count(*) From #Temp) > 0)
Begin
	--Either We can update tbl_requestRecApr By Replacing
	-- Separating recommender with new recommender(i.e Separating Recommender's HOD)

	--	Update tbl_RequestRecApr
	--	Set Emp_Code = #Temp.SepRecHOD_EmpCode
	--	From tbl_RequestRecApr,#Temp
	--	Where tbl_RequestRecApr.Emp_Code = #Temp.SepRec_EmpCode

	--OR insert new Recommmender (i.e Separating Recommender's HOD) directly
	 
	Insert into tbl_RequestRecApr(Request_Id,Emp_Code,Role)
	Select distinct #Temp.Request_Id,SepRecHOD_Empcode,'R'
	from #Temp

	---
	Declare @SepRecHOD_EmpCode Varchar(20)
	Declare @SepRecHOD_Name Varchar(150)
	Declare @SepRecHOD_Email Varchar(100)



	Declare RecSep Cursor for
	Select Distinct SepRecHOD_EmpCode,SepRecHOD_Name,SepRecHOD_Email
	From #Temp 
	Where SepRecHOD_Name <> ''

	OPEN RecSep
	Fetch RecSep into @SepRecHOD_EmpCode,@SepRecHOD_Name,@SepRecHOD_Email
	While(@@fetch_Status = 0)
	Begin
	--

	Declare @HTMLBODY1 nvarchar(max)
	Declare @HTMLBODY2 nvarchar(max)
	Declare @HTMLBODY3 nvarchar(max)

	Set @HTMLBODY1 = ''
	Set @HTMLBODY2 = ''
	Set @HTMLBODY2 = ''



	Declare @Query1 nvarchar(max)
	Set @Query1 = 'Select Distinct SepRec_EmpCode,SepRec_Name,SepRec_Date
					 from #Temp where SepRecHOD_EmpCode='''+@SepRecHOD_EmpCode+''''
	exec ConvertQueryInHTMP_PageComman @Query1, @HTMLBODY1 output


	Declare @Query2 nvarchar(max)
	Set @Query2 = 'Select Distinct Request_Id,ItemName,ModelName,ModelQuantity,EstimatedTotalPrice,
							RequestedBy,RequesterbranchCode
					 from #Temp where SepRecHOD_EmpCode='''+@SepRecHOD_EmpCode+''''
	exec ConvertQueryInHTMP_PageComman @Query2, @HTMLBODY2 output

	Declare @Request_ID varchar(Max)
	
	Set @Request_ID = (Select substring( ( SELECT DISTINCT ',' + rtrim(Request_Id) 
						FROM #Temp 
						Where SepRecHOD_EmpCode=@SepRecHOD_EmpCode
						FOR XML path(''), elements),2,500)) 

		
		If(@HTMLBODY1 IS NOT NULL AND @HTMLBODY1 <> '')
		Begin
			set @HTMLBODY1 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' width: ''1000''  cellpadding=''0'' cellspacing=''0''><caption>Separated List Of Recommenders</caption>')
			set @HTMLBODY1 = Replace(@HTMLBODY1,'SepRec_EmpCode','Recommender EmpCode')
			set @HTMLBODY1 = Replace(@HTMLBODY1,'SepRec_Name','Recommender Name')
			set @HTMLBODY1 = Replace(@HTMLBODY1,'SepRec_Date','Separation Date')
			--Set @HTMLBODY3 = @HTMLBODY3 + @HTMLBODY1
		End

		If(@HTMLBODY2 IS NOT NULL AND @HTMLBODY2 <> '')
		Begin
			set @HTMLBODY2 = Replace(@HTMLBODY2,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' width: ''1000''  cellpadding=''0'' cellspacing=''0''><caption>Separated Recommender''s Request Details</caption>')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'Request_Id','Request Id')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'ItemName','Item Name')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'ModelName','Model Name')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'ModelQuantity','Model Quantity')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'EstimatedTotalPrice','Estimated Total Price')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'RequestedBy','Requested By')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'RequesterbranchCode','Requester branch Code')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'UserRemark','User Remark')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'RecommendedBy','Recommended By')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'RecommendedDatetime','Recommended Datetime')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'ApprovedBy','Approved By')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'ApprovedDatetime','Approved Datetime')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'<th>UserRemark</th>','<th width=''250px''>UserRemark</th>')
			--Set @HTMLBODY3 = @HTMLBODY3 + '<br> <br>' + @HTMLBODY2
			
		End
			
		If(@HTMLBODY1 IS NOT NULL AND @HTMLBODY1 <> '')
		Begin
		
			Set @HTMLBODY3 = '<HTML><HEAD><TITLE>Recommender Separation Report</TITLE><STYLE TYPE=''text/css''>' +

							'.MyTable th{width: auto; border-right: white 1px solid; border-top: white 1px solid;' +
		' font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4;border-bottom: white 1px solid;'+
		' font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;};'+
		'.MyTable th{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left:'+    
		'white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;};' +



		'.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid;' +
		' font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4;border-bottom: white 1px solid;'+
		' font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;};'+
		'.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left:'+    
		'white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;};' +
		'.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color:'+	        
		'#3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;};'+
						'</STYLE></HEAD><Body> Dear, ' + @SepRecHOD_Name + ' <br> <p align="left"> Below is 
		the List of Recommender''s who have been Seperated. </p> <br> '+ @HTMLBODY1 + '<br> <br>
		<p align="left"> The Request Details that has to be Recommended on behalf of the above employees are as follows : <br> <br>
		'+@HTMLBODY2+'<br> <br>
														
		Kindly
		<a href ="https://196.1.115.172/itassestssystem/Login.aspx?content=RecSep&RecSepToHODRecRequestID='+@Request_ID+'"> Click Here </a> &nbsp;
		to Recommend / Reject the above Requests. <br><br>
		<p style=''background-color:Aliceblue;font-family:arial;color:steelblue;font-size:15px; width:550px''>
			<i><b><u>NOTE : </u></b><br>&nbsp;&nbsp;&nbsp;
			If the <b>Click Here</b> link does not open then perform the following steps in Outlook : <br> &nbsp;&nbsp;&nbsp;
			1.Go to Tools.<br>&nbsp;&nbsp;&nbsp;
			2.Select Options<br>&nbsp;&nbsp;&nbsp;
			3.Under Preferences Tab Click on junk-Mail... Button.<br>&nbsp;&nbsp;&nbsp;
			4.Under options Tab uncheck Disable links and other functionality in phishing <br>&nbsp;&nbsp;&nbsp;&nbsp;  message.(recommended)checkbox.<br>&nbsp;&nbsp;&nbsp;
			5.Click on Apply Button.
			6.Click on OK Button.<br>&nbsp;&nbsp;&nbsp;
			7.Again Click on OK Button.<br><br>&nbsp;&nbsp;&nbsp;
			</p></i>
		This is a system-generated e-mail, please do not reply to this email.<br><br>	
		Thanks and Regards,<br>
		IT Team.	



							<br><center><Div><center>' +
	--						@HTMLBODY3
						+ '</center></Div></center></Body></HTML>'
		End

		Select @HTMLBODY3   


		If(@HTMLBODY3 IS NOT NULL)
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'ITassets',                                           
				@recipients=@SepRecHOD_Email, -- Put this As @recipients  testing vishal.malagi@angeltrade.com; Live @SepRecHOD_Email                    
				@copy_recipients ='fatima.kazi@angelbroking.com',  
				@blind_copy_recipients = 'vishal.malagi@angelbroking.com',                       
				@subject = 'Recommender Separation Report',                        
				@body = @HTMLBODY3,                        
				@body_format = 'HTML'         
	    End 




	--
	Fetch RecSep into @SepRecHOD_EmpCode,@SepRecHOD_Name,@SepRecHOD_Email

	End

	Close RecSep
	deallocate RecSep


End



Drop Table #Temp



End

--Test
--http://172.29.22.6/ITASSETSSYSTEM/Login.aspx
--Live
--https://196.1.115.172/itassestssystem/Login.aspx

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ReqRecAprSeparation
-- --------------------------------------------------

CREATE proc [dbo].[USP_ReqRecAprSeparation]
@Option int,
@Requested_By char(20)
As
Begin

if(@Option = 1)--Requester is Seperated
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


	Select RECAPR.Emp_code As [Rec_EmpCode],
		(CASE WHEN ISNULL(RECAPR.Emp_code,'') <> '' 
			THEN (Select Emp_Name From Emp_Info Where Emp_No = RECAPR.Emp_code 
				UNION ALL 
				Select Emp_Name From Emp_Info_Sep Where Emp_No = RECAPR.Emp_code)
			 ELSE ''
			 END) As [Rec_Name],
			 RM.Requested_By As [ReqSep_EmpCode],
			EmpS.Emp_Name As [ReqSep_Name],EmpS.Senior As [ReqSepSr_EmpCode],EmpS.Sr_name As [ReqSepSr_Name],
		Count(distinct RM.Request_Id) As [Request_Count] 
	From tbl_RequestMaster RM , tbl_requestRecApr RECAPR, Emp_info_Sep EmpS
	Where RM.Request_Id = RECAPR.request_Id And RM.Status_Code not in  ('C','CA','CAFromPO','Rej') 
			and RM.Requested_By = EmpS.Emp_No
		And RECAPR.Role = 'R' And RM.Request_Id > '793'
	GROUP BY RECAPR.Emp_code,EmpS.Senior,EmpS.Sr_name,RM.Requested_By,EmpS.Emp_Name
	--order by RECAPR.Emp_code

End

Else if (@Option = 2)--Recommender is Seperated
Begin
	Select RECAPR.Emp_code As [RecSep_EmpCode],
			EmpS.Emp_Name As [RecSep_Name],EmpS.Senior As [RecSepSr_EmpCode],EmpS.Sr_name As [RecSepSr_Name],
			RM.Requested_By As [Req_EmpCode],
		(CASE WHEN ISNULL(RM.Requested_By,'') <> ''
			 THEN (Select Emp_Name From Emp_Info Where Emp_No = RM.Requested_By
				UNION ALL
				Select Emp_Name From Emp_Info_Sep Where Emp_No = RM.Requested_By)
			 ELSE '' 
			END)  As [Req_Name],
			Count(distinct RM.Request_Id) As [Request_Count] 
	From tbl_RequestMaster RM,tbl_RequestrecApr RECAPR, Emp_info_Sep EmpS
	Where  RM.Request_Id = RecApr.Request_Id and RM.Status_Code in ('P','L1R')
		and RecApr.Emp_Code = EmpS.Emp_No
		and RECAPR.Role = 'R' And RM.Request_Id > '793'
	GROUP BY RECAPR.Emp_code,RM.Requested_By,EmpS.Emp_Name,EmpS.Senior,EmpS.Sr_name
	--order by RECAPR.Emp_code

End

Else if (@Option = 3)--Approver is Seperated
Begin

		Select RECAPR.Emp_code As [AprSep_EmpCode],
			EmpS.Emp_Name  As [AprSep_Name],EmpS.Senior As [AprSepSr_EmpCode],EmpS.Sr_name As [AprSepSr_Name],
				RM.Requested_By As [Req_EmpCode],
		(CASE WHEN ISNULL(RM.Requested_By,'') <> ''
			 THEN (Select Emp_Name From Emp_Info Where Emp_No = RM.Requested_By
					UNION ALL
					Select Emp_Name From Emp_Info Where Emp_No = RM.Requested_By)
			ELSE '' 
			END)As [Req_Name],
			Count(Distinct RM.Request_Id) As [Request_Count] 
	From tbl_RequestMaster RM,tbl_RequestrecApr RECAPR, Emp_info_Sep EmpS
		Where  RM.Request_Id = RecApr.Request_Id and RM.Status_Code in ('R','L1A')
			and RecApr.Emp_Code = EmpS.Emp_No
			and RecApr.Role = 'A' And RM.Request_Id > '793'
	GROUP BY RECAPR.Emp_code,RM.Requested_By,EmpS.Emp_Name,EmpS.Senior,EmpS.Sr_name
	--order by RECAPR.Emp_code
	
End

Else if (@Option = 4)
Begin
			Select RM.Request_Id As [RequestId],
			(Case WHEN ISNULL(Item_Code,'') <> '' THEN (Select Product_Name from tbl_CapexProductMaster where Item_Code = Product_Code) ELSE '' END) As [ItemName],
			(Case WHEN ISNULL(Model_No,'') <> '' THEN (Select Model_Name from tbl_ProductModelMaster where Model_No = Model_Id) ELSE '' END) As [ModelName],
			RM.Model_Quantity As [ModelQuantity],RM.Estimated_Total_Price As [EstimatedTotalPrice],
			(Case WHEN ISNULL(Status_Code,'')<> '' THEN (Select Status_Name From tbl_StatusMaster Where Status_Code = RM.Status_Code) ELSE '' END) As [Status],
			(Case WHEN ISNULL(Requested_By,'') <> '' THEN (Select Emp_Name From emp_info where Emp_No = Requested_By) ELSE '' END) As [RequestedBy],
			(Case WHEN ISNULL(Requested_by,'')<> '' THEN (Select Branch_Cd from Emp_info where Emp_No = Requested_By) ELSE '' END)As [RequesterbranchCode],
			--RM.User_Remark As [UserRemark],
			(Case WHEN ISNULL(Recommended_By,'') <> '' THEN (Select Emp_Name From emp_info where Emp_No = Recommended_By)ELSE '' END) As [RecommendedBy],
			ISNULL(RM.Recommended_DateTime,'') As [RecommendedDatetime],
			(Case WHEN ISNULL(Approved_By,'') <> '' THEN (Select Emp_Name From emp_info where Emp_No = Approved_By ) ELSE '' END) As [ApprovedBy],
			ISNULL(RM.Approved_Datetime,'') As [ApprovedDatetime]
		 from tbl_RequestMaster RM
	Where RM.Status_Code not in  ('C','CA','CAFromPO','Rej') and RM.Requested_By = @Requested_By And RM.Request_Id > '793'

	
End

Else if (@Option = 5)
Begin
		Select RM.Request_Id As [RequestId],
			(Case WHEN ISNULL(Item_Code,'') <> '' THEN (Select Product_Name from tbl_CapexProductMaster where Item_Code = Product_Code) ELSE '' END) As [ItemName],
			(Case WHEN ISNULL(Model_No,'') <> '' THEN (Select Model_Name from tbl_ProductModelMaster where Model_No = Model_Id) ELSE '' END) As [ModelName],
			RM.Model_Quantity As [ModelQuantity],RM.Estimated_Total_Price As [EstimatedTotalPrice],
			(Case WHEN ISNULL(Status_Code,'')<> '' THEN (Select Status_Name From tbl_StatusMaster Where Status_Code = RM.Status_Code) ELSE '' END) As [Status],
			ISNULL((Case WHEN ISNULL(Requested_By,'') <> '' THEN (Select Emp_Name From emp_info where Emp_No = Requested_By) ELSE '' END),'') As [RequestedBy],
			(Case WHEN ISNULL(Requested_by,'')<> '' THEN (Select Branch_Cd from Emp_info where Emp_No = Requested_By) ELSE '' END)As [RequesterbranchCode]--,
			--RM.User_Remark As [UserRemark]
		 from tbl_RequestMaster RM
	Where  RM.Status_Code in ('P','L1R') and RM.Requested_By = @Requested_By And RM.Request_Id > '793'

End

Else if (@Option = 6)
Begin
		Select RM.Request_Id As [RequestId],
			(Case WHEN ISNULL(Item_Code,'') <> '' THEN (Select Product_Name from tbl_CapexProductMaster where Item_Code = Product_Code) ELSE '' END) As [ItemName],
			(Case WHEN ISNULL(Model_No,'') <> '' THEN (Select Model_Name from tbl_ProductModelMaster where Model_No = Model_Id) ELSE '' END) As [ModelName],
			RM.Model_Quantity As [ModelQuantity],RM.Estimated_Total_Price As [EstimatedTotalPrice],
			(Case WHEN ISNULL(Status_Code,'')<> '' THEN (Select Status_Name From tbl_StatusMaster Where Status_Code = RM.Status_Code) ELSE '' END) As [Status],
			ISNULL((Case WHEN ISNULL(Requested_By,'') <> '' THEN (Select Emp_Name From emp_info where Emp_No = Requested_By) ELSE '' END),'') As [RequestedBy],
			(Case WHEN ISNULL(Requested_by,'')<> '' THEN (Select Branch_Cd from Emp_info where Emp_No = Requested_By) ELSE '' END)As [RequesterbranchCode],
			--RM.User_Remark As [UserRemark],
			(Case WHEN ISNULL(Recommended_By,'') <> '' THEN (Select Emp_Name From emp_info where Emp_No = Recommended_By)ELSE '' END) As [RecommendedBy],
			RM.Recommended_DateTime As [RecommendedDatetime]
		 from tbl_RequestMaster RM,tbl_RequestrecApr RecApr
		Where  RM.Status_Code in ('R','L1A')and RM.Requested_By = @Requested_By And RM.Request_Id > '793'
End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RequesterSeparationMail
-- --------------------------------------------------

CREATE Proc[dbo].[USP_RequesterSeparationMail]
As


Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


--------------------------------------------------------------------------------------------------
--As ConvertQueryInHTMP_PageComman does work the first time so the following lines are excuted
--just for the purpose of making it to work it has no releation with this sp
Declare @HTMLBODY_TEST varchar(max)
exec ConvertQueryInHTMP_PageComman 'Select * from tbl_CapexMaster', @HTMLBODY_TEST output
--------------------------------------------------------------------------------------------------



Select distinct RM.Request_Id As [Request_Id],Emps.Emp_No As [SepReq_EmpCode],Emps.Emp_Name As [SepReq_Name],
		Convert(Varchar(11),EmpS.Separation_Date,113) As [SepReq_Date],
	   RECAPR.Emp_Code As [Rec_EmpCode],
	(CASE WHEN RECAPR.Emp_Code <> '' THEN ISNULL((Select Emp_Name from Emp_info Where Emp_No = RECAPR.Emp_Code),'')
		ELSE '' END) As [Rec_Name],
	(CASE WHEN RECAPR.Emp_Code <> '' THEN ISNULL((Select EmailAdd from Emp_info Where Emp_No = RECAPR.Emp_Code),'')
		ELSE '' END) As [Rec_EmailAdd],
	(CASE WHEN ISNULL(Item_Code,'') <> '' THEN (Select Product_Name from tbl_CapexProductMaster where Item_Code = Product_Code) ELSE '' END) As [ItemName],
	(CASE WHEN ISNULL(Model_No,'') <> '' THEN (Select Model_Name from tbl_ProductModelMaster where Model_No = Model_Id) ELSE '' END) As [ModelName],
	RM.Model_Quantity As [ModelQuantity],RM.Estimated_Total_Price As [EstimatedTotalPrice],
	(Case WHEN ISNULL(RM.Status_Code,'')<> '' THEN (Select Status_Name From tbl_StatusMaster Where Status_Code = RM.Status_Code) ELSE '' END) As [Status],
	(Case WHEN ISNULL(RM.Requested_by,'')<> '' THEN (Select Branch_Cd from Emp_info_Sep where Emp_No = RM.Requested_By) ELSE '' END)As [RequesterbranchCode],
	RM.User_Remark As [UserRemark],
	(Case WHEN ISNULL(Recommended_By,'') <> '' THEN (Select Emp_Name From emp_info where Emp_No = RM.Recommended_By)ELSE '' END) As [RecommendedBy],
	ISNULL(RM.Recommended_DateTime,'') As [RecommendedDatetime],
	(Case WHEN ISNULL(Approved_By,'') <> '' THEN (Select Emp_Name From emp_info where Emp_No = RM.Approved_By) ELSE '' END) As [ApprovedBy],
	ISNULL(RM.Approved_Datetime,'') As [ApprovedDatetime] 
Into #Temp
From tbl_RequestRecApr RECAPR ,tbl_RequestMaster RM,Emp_Info_Sep EmpS
Where RECAPR.Request_Id=RM.Request_Id And Role = 'R' and  RM.Requested_By = EmpS.Emp_No
--And RM.Status_Code not in  ('C','CA','CAFromPO','Rej') 
And RM.Status_Code in  ('P','L1R') 


------------------------------------------------------------------------------------------------------
--This Part is Used to get data from #Temp on daily basis for Veriftcation
Declare @HTMLBODY_GetTempData1 varchar(max)
Declare @HTMLBODY_GetTempDataFinal varchar(Max)
exec ConvertQueryInHTMP_PageComman 'Select * From #Temp', @HTMLBODY_GetTempData1 output

Set @HTMLBODY_GetTempDataFinal='<HTML><HEAD><TITLE>Requester Separation Report</TITLE><STYLE TYPE=''text/css''>' +

								'.MyTable th{width: auto; border-right: white 1px solid; border-top: white 1px solid;' +
								' font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4;border-bottom: white 1px solid;'+
								' font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;};'+
								'.MyTable th{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left:'+    
								'white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;};' +



								'.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid;' +
								' font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4;border-bottom: white 1px solid;'+
								' font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;};'+
								'.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left:'+    
								'white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;};' +
								'.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color:'+	        
								'#3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;};'+
								'</STYLE></HEAD><Body> '+@HTMLBODY_GetTempData1+'</Body></HTML>'
EXEC msdb.dbo.sp_send_dbmail                         
	@profile_name = 'ITasset@angelbroking.com',                                               
	@recipients='vishal.malagi@angelbroking.com' , -- Put this As @recipients testing-- vishal.malagi@angeltrade.com; Live--@Rec_EmailAdd                                       
	@subject = 'Requester Separation Temp Data',                        
	@body = @HTMLBODY_GetTempDataFinal,                        
	@body_format = 'HTML' 

---------------------------------------------------------------------------------------------------------


if ((Select Count(*) From #Temp) > 0)
Begin
	Declare @Rec_EmpCode Varchar(20)
	Declare @Rec_Name Varchar(150)
	Declare @Rec_EmailAdd Varchar(100)



	Declare ReqSep Cursor for
	Select Distinct Rec_EmpCode,Rec_Name,Rec_EmailAdd
	From #Temp 
	Where Rec_Name <> ''

	OPEN ReqSep
	Fetch ReqSep into @Rec_EmpCode,@Rec_Name,@Rec_EmailAdd
	While(@@fetch_Status = 0)
	Begin
	--

	Declare @HTMLBODY1 nvarchar(max)
	Declare @HTMLBODY2 nvarchar(max)
	Declare @HTMLBODY3 nvarchar(max)

	Set @HTMLBODY1 = ''
	Set @HTMLBODY2 = ''
	Set @HTMLBODY3 = ''




	Declare @Query1 nvarchar(max)
	Set @Query1 = 'Select Distinct SepReq_EmpCode,SepReq_Name,SepReq_Date 
					From #Temp Where Rec_EmpCode='''+@Rec_EmpCode+''''
	exec ConvertQueryInHTMP_PageComman @Query1, @HTMLBODY1 output

	Declare @Query2 nvarchar(max)
	Set @Query2 = 'Select Distinct Request_Id,ItemName,ModelName,ModelQuantity,EstimatedTotalPrice,SepReq_Name,RequesterbranchCode
					 from #Temp where Rec_EmpCode='''+@Rec_EmpCode+''''
	exec ConvertQueryInHTMP_PageComman @Query2, @HTMLBODY2 output


	Declare @Request_ID varchar(Max)
	
	Set @Request_ID = (Select substring( ( SELECT DISTINCT ',' + rtrim(Request_Id) 
						FROM #Temp 
						Where Rec_EmpCode=@Rec_EmpCode
						FOR XML path(''), elements),2,500)) 





		If(@HTMLBODY1 IS NOT NULL AND @HTMLBODY1 <> '')
		Begin
			set @HTMLBODY1 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' width: ''1000''  cellpadding=''0'' cellspacing=''0''><caption>Separated List Of Requesters</caption>')
			set @HTMLBODY1 = Replace(@HTMLBODY1,'SepReq_EmpCode','Requester EmpCode')
			set @HTMLBODY1 = Replace(@HTMLBODY1,'SepReq_Name','Requester Name')
			set @HTMLBODY1 = Replace(@HTMLBODY1,'SepReq_Date','Separation Date')
			--Set @HTMLBODY3 = @HTMLBODY3 + @HTMLBODY1
		End

		If(@HTMLBODY2 IS NOT NULL AND @HTMLBODY2 <> '')
		Begin
			set @HTMLBODY2 = Replace(@HTMLBODY2,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' width: ''1000''  cellpadding=''0'' cellspacing=''0''><caption>Separated Requester''s Request Details</caption>')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'Request_Id','Request Id')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'ItemName','Item Name')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'ModelName','Model Name')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'ModelQuantity','Model Quantity')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'EstimatedTotalPrice','Estimated Total Price')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'SepReq_Name','Requested By')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'RequesterbranchCode','Requester branch Code')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'UserRemark','User Remark')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'RecommendedBy','Recommended By')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'RecommendedDatetime','Recommended Datetime')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'ApprovedBy','Approved By')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'ApprovedDatetime','Approved Datetime')
			set @HTMLBODY2 = Replace(@HTMLBODY2,'<th>UserRemark</th>','<th width=''250px''>UserRemark</th>')
			--Set @HTMLBODY3 = @HTMLBODY3 + '<br> <br>' + @HTMLBODY2
			
		End
			
		If(@HTMLBODY1 IS NOT NULL AND @HTMLBODY1 <> '')
		Begin
		
			Set @HTMLBODY3 = '<HTML><HEAD><TITLE>Requester Separation Report</TITLE><STYLE TYPE=''text/css''>' +

							'.MyTable th{width: auto; border-right: white 1px solid; border-top: white 1px solid;' +
		' font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4;border-bottom: white 1px solid;'+
		' font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;};'+
		'.MyTable th{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left:'+    
		'white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;};' +



		'.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid;' +
		' font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4;border-bottom: white 1px solid;'+
		' font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;};'+
		'.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left:'+    
		'white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef;};' +
		'.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color:'+	        
		'#3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;};'+
						'</STYLE></HEAD><Body> Dear, ' + @Rec_Name + ' <br> <p align="left"> Below is 
		the List of Requester''s who have been Seperated. </p> <br> '+ @HTMLBODY1 + '<br>
		<p align="left"> The Request Details requested by the above employees are as follows : <br> <br>
		'+@HTMLBODY2+'<br><br>
				
		Kindly
	<a href ="https://196.1.115.172/itassestssystem/Login.aspx?content=ReqSep&ReqSepToRecRequestID='+@Request_ID+'"> Click Here </a> &nbsp; 
	   to Recommend / Reject the above Requests. <br><br>
	<p style=''background-color:Aliceblue;font-family:arial;color:steelblue;font-size:15px; width:550px''>
	<i><b><u>NOTE : </u></b><br>&nbsp;&nbsp;&nbsp;
	If the <b>Click Here</b> link does not open then perform the following steps in Outlook : <br> &nbsp;&nbsp;&nbsp;
	1.Go to Tools.<br>&nbsp;&nbsp;&nbsp;
	2.Select Options<br>&nbsp;&nbsp;&nbsp;
	3.Under Preferences Tab Click on junk-Mail... button.<br>&nbsp;&nbsp;&nbsp;
	4.Under options Tab uncheck Disable links and other functionality in phishing <br>&nbsp;&nbsp;&nbsp;&nbsp;  message.(recommended)checkbox.<br>&nbsp;&nbsp;&nbsp;
	5.Click on Apply Button.
	6.Click on OK button.<br>&nbsp;&nbsp;&nbsp;
	7.Again Click on OK button.<br><br>&nbsp;&nbsp;&nbsp;
	</p></i>
	This is a system-generated e-mail, please do not reply to this email.<br><br>	
	Thanks and Regards,<br>
	Angel Inhouse Support Team.
	</Body></HTML>'
		End

		Select @HTMLBODY3   


		If(@HTMLBODY3 IS NOT NULL)
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'ITasset@angelbroking.com',                                               
				@recipients=@Rec_EmailAdd , -- Put this As @recipients testing-- vishal.malagi@angeltrade.com; Live--@Rec_EmailAdd                 
				@copy_recipients ='tejas.gurudu@angelbroking.com',   
				@blind_copy_recipients = 'ravi.gupta@angelbroking.com',                        
				@subject = 'Requester Separation Report',                        
				@body = @HTMLBODY3,                        
				@body_format = 'HTML'    
   
	    End 




	--
	Fetch ReqSep into @Rec_EmpCode,@Rec_Name,@Rec_EmailAdd

	End

	Close ReqSep
	deallocate ReqSep

End


Drop Table #Temp



End


--Test
--http://172.29.22.6/ITASSETSSYSTEM/Login.aspx
--Live
--https://196.1.115.172/itassestssystem/Login.aspx

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_RequestGRP_Report
-- --------------------------------------------------


--Usp_RequestGRP_Report '', '','','PFA','2'
--Usp_RequestGRP_Report '', '','E07260','PO','4'

CREATE proc [dbo].[Usp_RequestGRP_Report]--Usp_RequestGRP_Report '', '','','','1'

@RequestId as  int,
@UserRole as varchar(20),
@RequestedBy as varchar(20),
@Type as varchar(20),
@Option as int 

as
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 



   If(@Option ='1')
   Begin
	      Select ISNULL(SUM(ISNULL(Recommendation,0)),0) AS [Recommendation],  
		   ISNULL(SUM(ISNULL(Approval,0)),0) AS [Approval],      
		   ISNULL(SUM(ISNULL(Approved,0)),0) AS [Approved],    
		   ISNULL(SUM(ISNULL(PO,0)),0) AS [PO] ,     
		   ISNULL(SUM(ISNULL(CloseR,0)),0) AS [CloseR], 
           ISNULL(SUM(ISNULL(Rejected,0)),0) AS [Rejected], 
	       ISNULL(SUM(ISNULL(Recommendation+Approval+Approved+PO+CloseR+Rejected,0)),0) As [Total]         
				From        
					(        
					 Select Request_Id,      
					  (Case When Status_Code in ('P') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As Recommendation,   
					  (Case When Status_Code in ('R','L1R') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As Approval,      
					  (Case When Status_Code in ('A','L1A') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As Approved, 
                      (Case When Status_Code in ('PO','MPO','NPO','CAFromPO') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As PO,
                      (Case When Status_Code in ('C') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As CloseR,  
                      (Case When Status_Code in ('Rej') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As Rejected 
					   From tbl_RequestMaster
				       Where 1=1 
					   group by Request_Id ,Status_Code
					) T  
       End  

     Else If(@Option ='3')
       Begin
	      Select ISNULL(SUM(ISNULL(Recommendation,0)),0) AS [Recommendation],  
		   ISNULL(SUM(ISNULL(Approval,0)),0) AS [Approval],      
		   ISNULL(SUM(ISNULL(Approved,0)),0) AS [Approved],    
		   ISNULL(SUM(ISNULL(PO,0)),0) AS [PO] ,     
		   ISNULL(SUM(ISNULL(CloseR,0)),0) AS [CloseR], 
           ISNULL(SUM(ISNULL(Rejected,0)),0) AS [Rejected], 
	       ISNULL(SUM(ISNULL(Recommendation+Approval+Approved+PO+CloseR+Rejected,0)),0) As [Total]         
				From        
					(        
					 Select Request_Id,      
					  (Case When Status_Code in ('P') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As Recommendation,   
					  (Case When Status_Code in ('R','L1R') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As Approval,      
					  (Case When Status_Code in ('A','L1A') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As Approved, 
                      (Case When Status_Code in ('PO','MPO','NPO','CAFromPO') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As PO,
                      (Case When Status_Code in ('C') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As CloseR,  
                      (Case When Status_Code in ('Rej') Then Count(ISNULL(Request_Id,0)) Else 0 End ) As Rejected 
					   From tbl_RequestMaster
				       Where Requested_By=@RequestedBy
					   group by Request_Id ,Status_Code
					) T  
       End  

	


   Else If(@Option='2')
    Begin
      If(rtrim(@Type)='PFR')
	   Begin
			select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code='P' order by A.Request_Id
       End

      Else If((@Type)='PFA')
        Begin
            select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code in ('R','L1R') order by A.Request_Id
        End

      Else If((@Type)='A')
        Begin
            select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code in ('A','L1A') order by A.Request_Id
        End

        Else If((@Type)='PO')
          Begin
			select A.Request_Id As [RID],PO.Fld_PurchaseOrderNo As [PONumber],B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
				Left Outer Join tbl_ITRequestPurchaseOrder PO on PO.Fld_RequestID like ( '%' + '''' + CAST(A.Request_ID AS Varchar(20)) + '''' + '%') 
			where A.Status_Code in ('PO','MPO','NPO','CAFromPO') order by A.Request_Id
         End

        Else If((@Type)='RC')
          Begin
            select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code in ('C') order by A.Request_Id
        End

        Else If((@Type)='RR')
         Begin
            select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code in ('REJ') order by A.Request_Id
         End

        Else If((@Type)='Total')
         Begin
            select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code in ('P', 'R','L1R','A','L1A','PO','MPO','NPO','CAFromPO','C','REJ','REJ') order by A.Request_Id
         End
     End	

   Else If(@Option='4')
     Begin
      If(rtrim(@Type)='PFR')
	   Begin
			select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code='P' and  A.Requested_By=@RequestedBy order by A.Request_Id
       End

     Else If((@Type)='PFA')
        Begin
            select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code in ('R','L1R') and  A.Requested_By=@RequestedBy order by A.Request_Id
        End

      Else If((@Type)='A')
        Begin
            select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code in ('A','L1A') and  A.Requested_By=@RequestedBy order by A.Request_Id
        End

        Else If((@Type)='PO')
        Begin
			select A.Request_Id As [RID],PO.Fld_PurchaseOrderNo As [PONumber],B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
				Left Outer Join tbl_ITRequestPurchaseOrder PO on PO.Fld_RequestID like ( '%' + '''' + CAST(A.Request_ID AS Varchar(20)) + '''' + '%') 
			where A.Status_Code in ('PO','MPO','NPO','CAFromPO') order by A.Request_Id
        End

        Else If((@Type)='RC')
        Begin
            select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code in ('C') and  A.Requested_By=@RequestedBy order by A.Request_Id
        End

        Else If((@Type)='RR')
        Begin
            select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code in ('REJ') and  A.Requested_By=@RequestedBy order by A.Request_Id
        End

        Else If((@Type)='Total')
        Begin
            select A.Request_Id As [RID], B.Product_name As [ItemName], C.Model_Name As [ModelName],
			A.Model_Quantity As [ModelQuantity], A.Estimated_Total_Price As [EstimatedTotalPrice],
			D.Emp_Name As [RequestedBy],E.Branch_Cd As [RequesterBranchCode], Convert(varchar(12),A.Request_Date,113) As [RequestDate], A.User_Remark As [UserRemark],
			F.Emp_Name As [RecommendedBy],Convert(varchar(12),A.Recommended_DateTime,113) As [RecommendedDatetime],
			G.Emp_Name As [ApprovedBy], Convert(varchar(12),A.Approved_Datetime,113) As [ApprovedDatetime],
			H.Status_Name As[Status]
			From tbl_RequestMaster A 
				Left outer join tbl_CapexProductMaster B on A.Item_Code=B.Product_Code
				Left outer join tbl_ProductModelMaster C on A.Model_No=C.Model_Id
				Left outer join emp_info D on A.Requested_By=D.Emp_no
				Left Outer Join emp_info E on A.Requested_by = E.Emp_no
				Left outer join emp_info F on A.Recommended_By=F.Emp_no
				Left outer join emp_info G on A.Approved_By=G.Emp_no
				Left outer join tbl_StatusMaster H on A.status_Code=H.Status_Code
			where A.Status_Code in ('P', 'R','L1R','A','L1A','PO','MPO','NPO','CAFromPO','C','REJ','REJ')  and  A.Requested_By=@RequestedBy order by A.Request_Id
        End
     End	          
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendToIOVMS
-- --------------------------------------------------

CREATE Proc [dbo].[USP_SendToIOVMS]
@PurchaseOrderNo varchar(100),
@Request_Id Varchar(Max),
@Emp_Id varchar(20)

As

BEGIN

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 



DECLARE @ReceivedBy varchar(10)
DECLARE @Sno int                            
DECLARE @NewSno varchar(3)                            
DECLARE @PrevBatchNo varchar(20)                            
DECLARE @CurrBatchNo varchar(20)                  
DECLARE @Currdate varchar(8)                            
DECLARE @LenEmp int 

--create Table #tbl_Invoice_data1(BAtchGenBy varchar(20),cso_batch_date datetime)

SET @ReceivedBy=@Emp_Id
SET @LenEmp=LEN(@ReceivedBy)                            
SET @Currdate=CONVERT(varchar(10),GETDATE(),112)                            

SELECT TOP 1 @PrevBatchNo=ltrim(rtrim(IOVMS_RefNo)) FROM tbl_IntegrationITAIOVMS with (nolock)
WHERE LEFT(ltrim(rtrim(IOVMS_RefNo)),@LenEmp)=@ReceivedBy   
AND CONVERT(varchar(10),Generated_Date,112) = CONVERT(varchar(10),GETDATE(),112)     
ORDER BY IOVMS_RefNo DESC                         
              
--PRINT @PrevBatchNo                
                          
IF ISNULL(@PrevBatchNo,'')=''                            
	BEGIN                            
	  SET @CurrBatchNo=rtrim(@ReceivedBy)+@Currdate+'001'                            
	END                            
ELSE                             
	BEGIN                            
	  SET @Sno=cast(RIGHT(@PrevBatchNo,3) AS INT)+1                            
	                              
		IF (len(@Sno) = 1)                            
		   BEGIN                            
				SET @NewSno='00'+cast(@Sno AS CHAR)                            
		   END                       
	  	ELSE                            
			IF (len(@Sno) = 2)
				BEGIN                            
					SET @NewSno='0'+cast(@Sno AS CHAR)                            
			    END                       
			ELSE
				BEGIN                            
					SET @NewSno=cast(@Sno AS CHAR)                            
				END                                     
	  SET @CurrBatchNo=rtrim(@ReceivedBy)+@Currdate+@NewSno                            
	END  

--  print @CurrBatchNo

 INSERT INTO tbl_IntegrationITAIOVMS
		(IOVMS_RefNo,PurchaseOrderNo,Request_Id,Generated_By,Generated_Date) 
 VALUES	(@CurrBatchNo,@PurchaseOrderNo,@Request_Id,@Emp_Id,getdate())


Select @CurrBatchNo As [IOVMS_RefNo]
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ShowRecAprDetails
-- --------------------------------------------------
CREATE Proc [dbo].[USP_ShowRecAprDetails]        
@User_ID varchar(20),        
@Request_Id int        
        
As        
        
Begin   
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
  
  
       
        
declare @Category char(10)        
declare @BranchCode char(20)        
        
set @BranchCode=(select branch_cd from emp_info where emp_no =@User_ID)        
if(@BranchCode in (select branch_cd from tbl_CSO_Branch(nolock)))        
Begin        
 Set @Category='CSO'        
End        
else        
Begin        
 Set @Category='Branch'        
End        


if(@Category='CSO')
Begin        

Select Distinct 'Reviewer' As [Recommender And Approver],EI.Emp_no As [Emp_No],      
EI.Emp_Name As [Emp_Name],EI.Department As [Department],        
  EI.Designation As [Designation],EI.Branch_Cd As [Branch Code],      
  EI.EmailAdd As [EmailAdd]--,PHONE As [Contact Number]        
from       
  Emp_Info EI where emp_no=(select Reviewer from tbl_reviewermaster where typeofReviewer='CSO' and isdelete=0)
union all
      
Select Distinct 'Recommender' As [Recommender And Approver],EI.Emp_no As [Emp_No],      
EI.Emp_Name As [Emp_Name],EI.Department As [Department],        
  EI.Designation As [Designation],EI.Branch_Cd As [Branch Code],      
  EI.EmailAdd As [EmailAdd]--,PHONE As [Contact Number]        
from tbl_requestRecApr RRA        
Inner  Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no          
Inner Join tbl_RequestMaster RM On RRA.Request_Id = RM.Request_Id        
where RRA.Request_Id = @Request_Id and RRA.[Role] = 'R' and RRA.Emp_Code <> RM.Requested_By        
        
UNION ALL        
        
Select Distinct 'Approver' As [Recommender And Approver],      
EI.Emp_no  As [Emp_No],EI.Emp_Name As [Emp_Name],EI.Department As [Department],        
  EI.Designation As [Designation],EI.Branch_Cd As [Branch Code],EI.EmailAdd As [EmailAdd]      
  --PHONE As [Contact Number]        
from tbl_requestRecApr RRA        
Inner  Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no          
Inner Join tbl_RequestMaster RM On RRA.Request_Id = RM.Request_Id        
where RRA.Request_Id = @Request_Id and RRA.[Role] = 'A' and RRA.Emp_Code <> RM.Requested_By        
End  
else 
Begin
Select Distinct 'Reviewer' As [Recommender And Approver],EI.Emp_no As [Emp_No],      
EI.Emp_Name As [Emp_Name],EI.Department As [Department],        
  EI.Designation As [Designation],EI.Branch_Cd As [Branch Code],      
  EI.EmailAdd As [EmailAdd]--,PHONE As [Contact Number]        
from       
  Emp_Info EI where emp_no=(select Reviewer from tbl_reviewermaster where typeofReviewer='other' and isdelete=0)
  
union all
      
Select Distinct 'Recommender' As [Recommender And Approver],EI.Emp_no As [Emp_No],      
EI.Emp_Name As [Emp_Name],EI.Department As [Department],        
  EI.Designation As [Designation],EI.Branch_Cd As [Branch Code],      
  EI.EmailAdd As [EmailAdd]--,PHONE As [Contact Number]        
from tbl_requestRecApr RRA        
Inner  Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no          
Inner Join tbl_RequestMaster RM On RRA.Request_Id = RM.Request_Id        
where RRA.Request_Id = @Request_Id and RRA.[Role] = 'R' and RRA.Emp_Code <> RM.Requested_By        
        
UNION ALL        
        
Select Distinct 'Approver' As [Recommender And Approver],      
EI.Emp_no  As [Emp_No],EI.Emp_Name As [Emp_Name],EI.Department As [Department],        
  EI.Designation As [Designation],EI.Branch_Cd As [Branch Code],EI.EmailAdd As [EmailAdd]      
  --PHONE As [Contact Number]        
from tbl_requestRecApr RRA        
Inner  Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no          
Inner Join tbl_RequestMaster RM On RRA.Request_Id = RM.Request_Id        
where RRA.Request_Id = @Request_Id and RRA.[Role] = 'A' and RRA.Emp_Code <> RM.Requested_By    
  
  --Tbl_ReviewRemarks
End      
        
        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ShowRecAprDetails_test
-- --------------------------------------------------
CREATE Proc [dbo].[USP_ShowRecAprDetails_test]    
@User_ID varchar(20),    
@Request_Id int    
    
As    
    
Begin  

     SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

    
declare @Category char(10)    
declare @BranchCode char(20)    
    
set @BranchCode=(select branch_cd from emp_info where emp_no ='E08232')    
if(@BranchCode in ('HO','ACM','AKSTR','BOK','CSO','CALNT','PMOS'))    
Begin    
 Set @Category='CSO'    
End    
else    
Begin    
 Set @Category='Branch'    
End    
    
    
Select Distinct 'Recommender' As [Recommender And Approver],EI.Emp_no As [Emp_No],  
EI.Emp_Name As [Emp_Name],EI.Department As [Department],    
  EI.Designation As [Designation],EI.Branch_Cd As [Branch Code],  
  EI.EmailAdd As [EmailAdd],PHONE As [Contact Number]    
from tbl_requestRecApr RRA    
Inner  Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no      
Inner Join tbl_RequestMaster RM On RRA.Request_Id = RM.Request_Id    
where RRA.Request_Id = 2298 and RRA.[Role] = 'R' and RRA.Emp_Code <> RM.Requested_By    
    
UNION ALL    
    
Select Distinct 'Approver' As [Recommender And Approver],EI.Emp_no  As [Emp_No],  
EI.Emp_Name As [Emp_Name],EI.Department As [Department],    
  EI.Designation As [Designation],EI.Branch_Cd As [Branch Code],  
  EI.EmailAdd As [EmailAdd],PHONE As [Contact Number]    
from tbl_requestRecApr RRA    
Inner  Join Emp_Info EI On RRA.Emp_Code = EI.Emp_no      
Inner Join tbl_RequestMaster RM On RRA.Request_Id = RM.Request_Id    
where RRA.Request_Id = @Request_Id and RRA.[Role] = 'A' and RRA.Emp_Code <> RM.Requested_By    
    
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_StatusClose
-- --------------------------------------------------


CREATE  Procedure [dbo].[USP_StatusClose]
(
@option char(20),
@Request_Id  INT,
@Userid CHAR(20)
)
as    
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


if(@option = 'Close')
Begin

	Update tbl_RequestMaster
	set Status_Code='C',
		Req_CompletedBy = @Userid,
		Req_CompletedDate = GETDATE()
	where Request_Id=@Request_Id
End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_StatusReassignORPO
-- --------------------------------------------------








CREATE Procedure [dbo].[USP_StatusReassignORPO]
(
@option char(20),
@Request_Id  INT,
@Userid CHAR(20)
)
as    
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


if(@option = 'ReAssigned')
Begin
--
--	Update tbl_RequestMaster
--	set Status_Code='Reassign'
--	where Request_Id=@Request_Id
---Note that on reassigan we are setting status as closed 
	Update tbl_RequestMaster
	set Status_Code='C',
		Req_CompletedBy = @Userid,
		Req_CompletedDate = GETDATE()
	where Request_Id=@Request_Id
End

else if (@option ='Bill')
Begin
	update tbl_RequestMaster
	set Model_Quantity_Assigned=Model_Quantity,
		Status_code='PO'
	Where Request_Id=@Request_Id
End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Stockdetails
-- --------------------------------------------------




CREATE proc [dbo].[Usp_Stockdetails](@Product_Name varchar(500))        
as
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

--print @Product_Name
declare @str1 varchar(2000)
set @str1='select CPM.Product_Name As [Item Name],PMM.Model_Name As [Model Name],VM.VendorName As [Vendor Name],
		SID.warranty_Fromdate As [warranty Fromdate],SID.Warranty_Todate As [Warranty Todate] ,SID.Warranty_Type As [Warranty Type],
		SID.Inventory_no As [Inventory No]
	from tbl_stockInventoryDetails SID
	left outer join tbl_CapexProductMaster CPM on  SID.Product_code=CPM.Product_code
	left outer join tbl_ProductModelMaster PMM on  SID.Model_id=PMM.Model_Id
	left outer join tbl_it_vendormaster VM on SID.Vendor_Code=VM.VendorCode
	where SID.Product_Code in (Select Product_code From tbl_CapexProductMaster where Product_name in ('''+@Product_Name+'''))
	and SID.status=''1'''
--print @Product_Name
print @str1

exec (@str1)
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_Emp_info
-- --------------------------------------------------
--select * into emp_info_31jan2020 from emp_info  
CREATE proc [dbo].[Usp_Update_Emp_info]          
   
-----------------------------------------------------------------------  
--Created By : Vishal Malagi  
--Created On : 24 DEC 2010  
--Description : Update Information into emp_info From [196.1.115.239].[Harmony].dbo.VLMSInhouse   
--     Of Only Active Employee   
--Execution Time : Daily 11:00 PM   
-----------------------------------------------------------------------  
  
As  
  
Begin  
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
        
 Truncate table emp_info  
  
 Insert into dbo.emp_info (Emp_NO,EMP_NAME,Senior,Sr_name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,  
  Department,Sub_Department,Designation,Location_Address,[LEVEL],categorydesc,  
  Branch_Cd,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,  
  [STATUS],[Address],City,[State],Account_No,pincode,Functional_Head,flgCSOBranch,  
  tpdlgcode,LOBDESC,UpdDate  
  )  
 select isnull([Emp_No],''),isnull(EMP_NAME,''),isnull([HOD_No],''),isnull([HOD_Name],''),isnull([Div_Name],''),  
  isnull(SBU,''),0 LOB,isnull(Zone,''),isnull(Region,''),isnull(Location,''),  
  isnull(Attendence_Location,''),isnull(Department,''),isnull([Sub_Department],''),  
  isnull(Designation,''),isnull([LocationAddress],''),'' [LEVEL],  
  isnull(categorydesc,''),isnull(Cost_Center,''),isnull([Join_Date],0),  
  isnull([Last_Working_Date],0),isnull(email_add,''),case when(isnull(Gender,'')='Male') then 'M' else 'F' end,isnull(Birth_Date,0),  
  isnull(PHONE,''),isnull(JOIN_DATE,0),'A' [Status],isnull([Personal_Address],''),'' City,  
  isnull([State],''),isnull([BankAccountNumber],''),isnull(pinCode,''),'' HOD,  
  '' flgCSOBranch ,'' tpdlgcode,isnull(LOB,''),getdate()   
 from [ABVSHRMS].DarwinBoxMiddleware.dbo.tbl_EmployeeMaster where emp_no!='DBADMIN001'   
 and (last_working_Date is null or last_working_date >=getdate())  
 --from [196.1.115.239].[Harmony].dbo.VLMSInhouse  
 --Where [STATUS] = 'A'  
  
 insert into tbl_EmpTree_Log  
 select 'Usp_Update_Emp_info','emp_info',count(*),getdate() from emp_info with (nolock)  
  
  
 Truncate table emp_info_Sep  
  
 Insert into dbo.emp_info_Sep   
  (Emp_NO,EMP_NAME,Senior,Sr_name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,  
  Department,Sub_Department,Designation,Location_Address,[LEVEL],categorydesc,  
  Branch_Cd,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,  
  [STATUS],[Address],City,[State],Account_No,pincode,Functional_Head,flgCSOBranch,  
  tpdlgcode,LOBDESC,UpdDate  
  )  
 select isnull([Emp_No],''),isnull(EMP_NAME,''),isnull([HOD_No],''),isnull([HOD_Name],''),isnull([Div_Name],''),  
  isnull(SBU,''),0 LOB,isnull(Zone,''),isnull(Region,''),isnull(Location,''),  
  isnull(Attendence_Location,''),isnull(Department,''),isnull([Sub_Department],''),  
  isnull(Designation,''),isnull([LocationAddress],''),'' [LEVEL],  
  isnull(categorydesc,''),isnull(Cost_Center,''),isnull([Join_Date],0),  
  isnull([Last_Working_Date],0),isnull(email_add,''),case when(isnull(Gender,'')='Male') then 'M' else 'F' end,isnull(Birth_Date,0),  
  isnull(PHONE,''),isnull(JOIN_DATE,0),'A' [Status],isnull([Personal_Address],''),'' City,  
  isnull([State],''),isnull([BankAccountNumber],''),isnull(pinCode,''),'' HOD,  
  '' flgCSOBranch ,'' tpdlgcode,isnull(LOB,''),getdate()  
 --from [196.1.115.239].[Harmony].dbo.VLMSInhouse  
 from [ABVSHRMS].DarwinBoxMiddleware.dbo.tbl_EmployeeMaster where emp_no!='DBADMIN001'  
 and (last_working_Date is null or last_working_date >=getdate())  
 --from [196.1.115.239].[Harmony].dbo.VLMSInhouse  
 --Where [STATUS] <> 'A'  
  
 insert into tbl_EmpTree_Log  
 select 'Usp_Update_Emp_info','emp_info_Sep',count(*),getdate() from emp_info_Sep with (nolock)  
  
--this Update is For Baroda region   
--As the There Was no regional Manager For Baroda Region  
--so As Per Discussion With Fatima Kazi Mr.D. Bala Murali Krishna who was Sr.Assistant Vice President  
--has been updated as Regional Manager  
--Update Emp_Info   
--set Designation = 'Regional Manager'  
--Where Emp_No = 'E30958'  
-------------------------------  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_Emp_info_28jan2020
-- --------------------------------------------------

CREATE proc [dbo].[Usp_Update_Emp_info_28jan2020]        
 
-----------------------------------------------------------------------
--Created By	: Vishal Malagi
--Created On	: 24 DEC 2010
--Description	: Update Information into emp_info From [196.1.115.239].[Harmony].dbo.VLMSInhouse 
--					Of Only Active Employee 
--Execution Time : Daily 11:00 PM 
-----------------------------------------------------------------------

As

Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


	Truncate table emp_info

	Insert into dbo.emp_info (Emp_NO,EMP_NAME,Senior,Sr_name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,
		Department,Sub_Department,Designation,Location_Address,[LEVEL],categorydesc,
		Branch_Cd,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,
		[STATUS],[Address],City,[State],Account_No,pincode,Functional_Head,flgCSOBranch,
		tpdlgcode,LOBDESC,UpdDate
		)
	select isnull([Emp No],''),isnull(EMP_NAME,''),isnull([HOD No],''),isnull([HOD Name],''),isnull([Company Name],''),
		isnull(SBU,''),isnull(Lob,''),isnull(Zone,''),isnull(Region,''),isnull(Location,''),
		isnull(AttendanceLoc,''),isnull(Department,''),isnull([Sub Department],''),
		isnull(Designation,''),isnull([Location Address],''),isnull([LEVEL],''),
		isnull(categorydesc,''),isnull(Costcode,''),isnull([Join Date],0),
		isnull([Separation Date],0),isnull(emailadd,''),isnull(sex,''),isnull(BirthDate,0),
		isnull(PHONE,''),isnull(JOINDATE,0),isnull([STATUS],''),isnull([Address],''),isnull(City,''),
		isnull([State],''),isnull([Account No],''),isnull(pincode,''),isnull([Functional Head],''),
		isnull(flgCSOBranch,''),isnull(tpdlgcode,''),isnull(LOBDESC,''),getdate()
	from [196.1.115.239].[Harmony].dbo.VLMSInhouse
	Where [STATUS] = 'A'

	insert into tbl_EmpTree_Log
	select 'Usp_Update_Emp_info','emp_info',count(*),getdate() from emp_info with (nolock)


	Truncate table emp_info_Sep

	Insert into dbo.emp_info_Sep 
		(Emp_NO,EMP_NAME,Senior,Sr_name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,
		Department,Sub_Department,Designation,Location_Address,[LEVEL],categorydesc,
		Branch_Cd,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,
		[STATUS],[Address],City,[State],Account_No,pincode,Functional_Head,flgCSOBranch,
		tpdlgcode,LOBDESC,UpdDate
		)
	select isnull([Emp No],''),isnull(EMP_NAME,''),isnull([HOD No],''),isnull([HOD Name],''),isnull([Company Name],''),
		isnull(SBU,''),isnull(Lob,''),isnull(Zone,''),isnull(Region,''),isnull(Location,''),
		isnull(AttendanceLoc,''),isnull(Department,''),isnull([Sub Department],''),
		isnull(Designation,''),isnull([Location Address],''),isnull([LEVEL],''),
		isnull(categorydesc,''),isnull(Costcode,''),isnull([Join Date],0),
		isnull([Separation Date],0),isnull(emailadd,''),isnull(sex,''),isnull(BirthDate,0),
		isnull(PHONE,''),isnull(JOINDATE,0),isnull([STATUS],''),isnull([Address],''),isnull(City,''),
		isnull([State],''),isnull([Account No],''),isnull(pincode,''),isnull([Functional Head],''),
		isnull(flgCSOBranch,''),isnull(tpdlgcode,''),isnull(LOBDESC,''),getdate()
	from [196.1.115.239].[Harmony].dbo.VLMSInhouse
	Where [STATUS] <> 'A'

	insert into tbl_EmpTree_Log
	select 'Usp_Update_Emp_info','emp_info_Sep',count(*),getdate() from emp_info_Sep with (nolock)

--this Update is For Baroda region 
--As the There Was no regional Manager For Baroda Region
--so As Per Discussion With Fatima Kazi Mr.D. Bala Murali Krishna who was Sr.Assistant Vice President
--has been updated as Regional Manager
--Update Emp_Info 
--set Designation = 'Regional Manager'
--Where Emp_No = 'E30958'
-------------------------------
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_Emp_info_31Jan2020
-- --------------------------------------------------

CREATE proc [dbo].[Usp_Update_Emp_info_31Jan2020]        
 
-----------------------------------------------------------------------
--Created By	: Vishal Malagi
--Created On	: 24 DEC 2010
--Description	: Update Information into emp_info From [196.1.115.239].[Harmony].dbo.VLMSInhouse 
--					Of Only Active Employee 
--Execution Time : Daily 11:00 PM 
-----------------------------------------------------------------------

As

Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


	Truncate table emp_info

	Insert into dbo.emp_info (Emp_NO,EMP_NAME,Senior,Sr_name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,
		Department,Sub_Department,Designation,Location_Address,[LEVEL],categorydesc,
		Branch_Cd,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,
		[STATUS],[Address],City,[State],Account_No,pincode,Functional_Head,flgCSOBranch,
		tpdlgcode,LOBDESC,UpdDate
		)
	select isnull([Emp No],''),isnull(EMP_NAME,''),isnull([HOD No],''),isnull([HOD Name],''),isnull([Company Name],''),
		isnull(SBU,''),isnull(Lob,''),isnull(Zone,''),isnull(Region,''),isnull(Location,''),
		isnull(AttendanceLoc,''),isnull(Department,''),isnull([Sub Department],''),
		isnull(Designation,''),isnull([Location Address],''),isnull([LEVEL],''),
		isnull(categorydesc,''),isnull(Costcode,''),isnull([Join Date],0),
		isnull([Separation Date],0),isnull(emailadd,''),isnull(sex,''),isnull(BirthDate,0),
		isnull(PHONE,''),isnull(JOINDATE,0),isnull([STATUS],''),isnull([Address],''),isnull(City,''),
		isnull([State],''),isnull([Account No],''),isnull(pincode,''),isnull([Functional Head],''),
		isnull(flgCSOBranch,''),isnull(tpdlgcode,''),isnull(LOBDESC,''),getdate()
	from [196.1.115.239].[Harmony].dbo.VLMSInhouse
	Where [STATUS] = 'A'

	insert into tbl_EmpTree_Log
	select 'Usp_Update_Emp_info','emp_info',count(*),getdate() from emp_info with (nolock)


	Truncate table emp_info_Sep

	Insert into dbo.emp_info_Sep 
		(Emp_NO,EMP_NAME,Senior,Sr_name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,
		Department,Sub_Department,Designation,Location_Address,[LEVEL],categorydesc,
		Branch_Cd,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,
		[STATUS],[Address],City,[State],Account_No,pincode,Functional_Head,flgCSOBranch,
		tpdlgcode,LOBDESC,UpdDate
		)
	select isnull([Emp No],''),isnull(EMP_NAME,''),isnull([HOD No],''),isnull([HOD Name],''),isnull([Company Name],''),
		isnull(SBU,''),isnull(Lob,''),isnull(Zone,''),isnull(Region,''),isnull(Location,''),
		isnull(AttendanceLoc,''),isnull(Department,''),isnull([Sub Department],''),
		isnull(Designation,''),isnull([Location Address],''),isnull([LEVEL],''),
		isnull(categorydesc,''),isnull(Costcode,''),isnull([Join Date],0),
		isnull([Separation Date],0),isnull(emailadd,''),isnull(sex,''),isnull(BirthDate,0),
		isnull(PHONE,''),isnull(JOINDATE,0),isnull([STATUS],''),isnull([Address],''),isnull(City,''),
		isnull([State],''),isnull([Account No],''),isnull(pincode,''),isnull([Functional Head],''),
		isnull(flgCSOBranch,''),isnull(tpdlgcode,''),isnull(LOBDESC,''),getdate()
	from [196.1.115.239].[Harmony].dbo.VLMSInhouse
	Where [STATUS] <> 'A'

	insert into tbl_EmpTree_Log
	select 'Usp_Update_Emp_info','emp_info_Sep',count(*),getdate() from emp_info_Sep with (nolock)

--this Update is For Baroda region 
--As the There Was no regional Manager For Baroda Region
--so As Per Discussion With Fatima Kazi Mr.D. Bala Murali Krishna who was Sr.Assistant Vice President
--has been updated as Regional Manager
--Update Emp_Info 
--set Designation = 'Regional Manager'
--Where Emp_No = 'E30958'
-------------------------------
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_tbl_ITUsers
-- --------------------------------------------------
-----------------------------------------------------------------------              
--Created By : Vishal Malagi              
--Created On : 24 DEC 2010              
--Description : Update Information into tbl_ITUsers on [196.1.115.239]            
--Modified By:Zeba             
--     From [196.1.115.239].[Harmony].dbo.VLMSInhouse               
--     Of Only Active Employee so that the IT Assets System Link can be seen from Harmony.              
--Execution Time : Daily 11:00 PM               
--Modified By:Sandeep Rai to Give Access of master&admin to sachin Deshmuke E54243 21 Feb 2014      
--Modified By:Suraj Patil to Give Access of master&admin to ('E69243','E49843')    
-----------------------------------------------------------------------           
          
          
CREATE PROC [dbo].[Usp_Update_tbl_ITUsers]            
             
AS            
  BEGIN      
      
     SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
            
      DELETE FROM tbl_ITUsers            
            
      INSERT INTO tbl_ITUsers            
      SELECT [Emp_NO],            
             'CSO',            
             'ITA',            
             'U',            
             '',            
             Getdate(),            
             '',            
             Getdate()            
      FROM   emp_info            
     -- WHERE  [STATUS] = 'A'            
            
      UPDATE tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ( 'E02037', 'E03446', 'E05626', 'E07260',            
                         'E36621', 'E22062', 'E23109', 'E30253',            
                         'E30251', 'E31422', 'P00212', 'P00226',            
                         'P00227', 'E42230','E42730','E44436','E54243','E54604','E65083' )        
      UPDATE tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ( select Reviewer from Tbl_ReviewerMaster where isdelete = 0 )          
          
      UPDATE tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ('E00875','E74725','E77654','E71505','E04863','E80113')   
          
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_tbl_ITUsers_01Jul2019
-- --------------------------------------------------
CREATE PROC [dbo].[Usp_Update_tbl_ITUsers_01Jul2019]            
             
AS            
  BEGIN      
      
     SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
            
      DELETE FROM [196.1.115.239].Harmony.dbo.tbl_ITUsers            
            
      INSERT INTO [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SELECT [Emp No],            
             'CSO',            
             'ITA',            
             'U',            
             '',            
             Getdate(),            
             '',            
             Getdate()            
      FROM   [196.1.115.239].Harmony.dbo.VLMSInhouse            
      WHERE  [STATUS] = 'A'            
            
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ( 'E02037', 'E03446', 'E05626', 'E07260',            
                         'E36621', 'E22062', 'E23109', 'E30253',            
                         'E30251', 'E31422', 'P00212', 'P00226',            
                         'P00227', 'E42230','E42730','E44436','E54243','E54604','E65083' )        
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ( select Reviewer from Tbl_ReviewerMaster where isdelete = 0 )          
          
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ('E00875','E74725','E77654','E71505')   
          
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_tbl_ITUsers_05Feb2020
-- --------------------------------------------------
-----------------------------------------------------------------------              
--Created By : Vishal Malagi              
--Created On : 24 DEC 2010              
--Description : Update Information into tbl_ITUsers on [196.1.115.239]            
--Modified By:Zeba             
--     From [196.1.115.239].[Harmony].dbo.VLMSInhouse               
--     Of Only Active Employee so that the IT Assets System Link can be seen from Harmony.              
--Execution Time : Daily 11:00 PM               
--Modified By:Sandeep Rai to Give Access of master&admin to sachin Deshmuke E54243 21 Feb 2014      
--Modified By:Suraj Patil to Give Access of master&admin to ('E69243','E49843')    
-----------------------------------------------------------------------           
          
          
CREATE PROC [dbo].[Usp_Update_tbl_ITUsers_05Feb2020]            
             
AS            
  BEGIN      
      
     SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
            
      DELETE FROM [196.1.115.239].Harmony.dbo.tbl_ITUsers            
            
      INSERT INTO [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SELECT [Emp No],            
             'CSO',            
             'ITA',            
             'U',            
             '',            
             Getdate(),            
             '',            
             Getdate()            
      FROM   [196.1.115.239].Harmony.dbo.VLMSInhouse            
      WHERE  [STATUS] = 'A'            
            
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ( 'E02037', 'E03446', 'E05626', 'E07260',            
                         'E36621', 'E22062', 'E23109', 'E30253',            
                         'E30251', 'E31422', 'P00212', 'P00226',            
                         'P00227', 'E42230','E42730','E44436','E54243','E54604','E65083' )        
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ( select Reviewer from Tbl_ReviewerMaster where isdelete = 0 )          
          
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ('E00875','E74725','E77654','E71505','E04863','E80113')   
          
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_tbl_ITUsers_06Mar2019
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------              
--Created By : Vishal Malagi              
--Created On : 24 DEC 2010              
--Description : Update Information into tbl_ITUsers on [196.1.115.239]            
--Modified By:Zeba             
--     From [196.1.115.239].[Harmony].dbo.VLMSInhouse               
--     Of Only Active Employee so that the IT Assets System Link can be seen from Harmony.              
--Execution Time : Daily 11:00 PM               
--Modified By:Sandeep Rai to Give Access of master&admin to sachin Deshmuke E54243 21 Feb 2014      
--Modified By:Suraj Patil to Give Access of master&admin to ('E69243','E49843')    
-----------------------------------------------------------------------           
          
          
CREATE PROC [dbo].[Usp_Update_tbl_ITUsers_06Mar2019]            
             
AS            
  BEGIN      
      
     SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
            
      DELETE FROM [196.1.115.239].Harmony.dbo.tbl_ITUsers            
            
      INSERT INTO [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SELECT [Emp No],            
             'CSO',            
             'ITA',            
             'U',            
             '',            
             Getdate(),            
             '',            
             Getdate()            
      FROM   [196.1.115.239].Harmony.dbo.VLMSInhouse            
      WHERE  [STATUS] = 'A'            
            
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ( 'E02037', 'E03446', 'E05626', 'E07260',            
                         'E36621', 'E22062', 'E23109', 'E30253',            
                         'E30251', 'E31422', 'P00212', 'P00226',            
                         'P00227', 'E42230','E42730','E44436','E54243','E54604','E65083' )        
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ( select Reviewer from Tbl_ReviewerMaster where isdelete = 0 )          
          
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ('E00875','E74725')   
          
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_tbl_ITUsers_18jul2019
-- --------------------------------------------------
-----------------------------------------------------------------------              
--Created By : Vishal Malagi              
--Created On : 24 DEC 2010              
--Description : Update Information into tbl_ITUsers on [196.1.115.239]            
--Modified By:Zeba             
--     From [196.1.115.239].[Harmony].dbo.VLMSInhouse               
--     Of Only Active Employee so that the IT Assets System Link can be seen from Harmony.              
--Execution Time : Daily 11:00 PM               
--Modified By:Sandeep Rai to Give Access of master&admin to sachin Deshmuke E54243 21 Feb 2014      
--Modified By:Suraj Patil to Give Access of master&admin to ('E69243','E49843')    
-----------------------------------------------------------------------           
          
          
CREATE PROC [dbo].[Usp_Update_tbl_ITUsers_18jul2019]            
             
AS            
  BEGIN      
      
     SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
            
      DELETE FROM [196.1.115.239].Harmony.dbo.tbl_ITUsers            
            
      INSERT INTO [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SELECT [Emp No],            
             'CSO',            
             'ITA',            
             'U',            
             '',            
             Getdate(),            
             '',            
             Getdate()            
      FROM   [196.1.115.239].Harmony.dbo.VLMSInhouse            
      WHERE  [STATUS] = 'A'            
            
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ( 'E02037', 'E03446', 'E05626', 'E07260',            
                         'E36621', 'E22062', 'E23109', 'E30253',            
                         'E30251', 'E31422', 'P00212', 'P00226',            
                         'P00227', 'E42230','E42730','E44436','E54243','E54604','E65083' )        
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ( select Reviewer from Tbl_ReviewerMaster where isdelete = 0 )          
          
      UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers            
      SET    [Role] = 'ADM'            
      WHERE  Emp_Id IN ('E00875','E74725','E77654','E71505','E04863')   
          
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_VLMS_RolemasterEquity
-- --------------------------------------------------
  

CREATE proc [dbo].[Usp_Update_VLMS_RolemasterEquity]          

   

-----------------------------------------------------------------------  

--Created By : Vishal Malagi  

--Created On : 24 DEC 2010  

--Description : Update Information into VLMS_RolemasterEquity  

--     From [196.1.115.239].[Harmony].dbo.VLMS_RolemasterEquity   

--Execution Time : Daily 11:00 PM   

-----------------------------------------------------------------------  

  

As  

  

Begin  

  

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   

  

  

 Truncate table VLMS_RolemasterEquity  



select distinct branch_cd,newbranch_cd into #NewHarmonyBranch from MIDDLEWARE.Harmony.dbo.VLMSMimansa_New with(nolock) 



  

 Insert VLMS_RolemasterEquity (PID,biBranch,HarmonyCostCode,Zone,Region,costCodeHead,codeSpecification,  

          commentsIfOthers,branchHead,clusterHead,regionalHead,regionalCommHead,zonalHead,  

          franchiseeHead,comments,lastUpdatedEmpNo,lastUpdatedDate,lastUpdatedEmpNoComm,  

          lastUpdatedDateComm,flgEquiComm,owner1,owner2,flgdel,hrmEmpNo,InsertionDate,  

          BranchCoordinator,RegionalCoordinator,RegionalSalesManager,[Shared resource cord],  

          [Area Sales Manager])  

 Select PID,newbranch_cd,HarmonyCostCode,Zone,Region,costCodeHead,codeSpecification,  

          commentsIfOthers,branchHead,clusterHead,regionalHead,regionalCommHead,zonalHead,  

          franchiseeHead,comments,lastUpdatedEmpNo,lastUpdatedDate,lastUpdatedEmpNoComm,  

          lastUpdatedDateComm,flgEquiComm,owner1,owner2,flgdel,hrmEmpNo,InsertionDate,  

          BranchCoordinator,RegionalCoordinator,RegionalSalesManager,[Shared resource cord],  

          [Area Sales Manager]   

 from MIDDLEWARE.[Harmony].dbo.VLMS_RolemasterEquity v inner join 

 #NewHarmonyBranch e

 on v.bibranch=e.branch_cd --where newBranch_cd='Akstr6'

  



  

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateInventory_onCloseRequest
-- --------------------------------------------------





----To Added Added_By And Addedon By Cols


CREATE Procedure [dbo].[USP_UpdateInventory_onCloseRequest]
(
@Request_Id  int,
@Warranty_Fromdate datetime,
@Warranty_Todate datetime,
@Bill_No char(20),
@Challan_No char(20),
@Userid char(10)

)
As 
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


update tbl_stockinventorydetails
set Warranty_Fromdate = @Warranty_Fromdate,
	Warranty_Todate = @Warranty_Todate,
	Bill_No = @Bill_No,
	Challan_No= @Challan_No,
	Modified_By = @Userid,
	Modified_Date = getdate()
Where Request_Id=@Request_Id And Assign_Type='PO'

End

-------After Completeion of PO Request make an entry in log about Warranty_Fromdate,Warranty_Todate,Bill_No,Challan_No---------------





insert into tbl_stockinventorydetails_log(Inventory_No,Product_Code,Model_Id,Vendor_Code,Warranty_Type,
											Warranty_Fromdate,Warranty_Todate,
										Assign_type,Assign_To,Assign_ToDept,Assign_ToBranch,Assign_Date,
										Assign_By,Request_Id,Status,Product_Desc,Part_No,Unit_Price,
											Bill_No,Challan_No,
										Bill_Orderby,Bill_Orderdate,Modified_By,Modified_Date)

select Inventory_No,Product_Code,Model_Id,Vendor_Code,Warranty_Type,
		Warranty_Fromdate,Warranty_Todate,
		Assign_type,Assign_To,Assign_ToDept,
		Assign_ToBranch,Assign_Date,Assign_By,Request_Id,Status,Product_Desc,Part_No,Unit_Price,
		Bill_No,Challan_No,
		Bill_Orderby,Bill_Orderdate,Modified_By,Modified_Date
from tbl_stockinventorydetails 
where Request_Id=@Request_Id And Assign_Type='PO'

-------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateInventory_onReassign
-- --------------------------------------------------





CREATE  Procedure [dbo].[USP_UpdateInventory_onReassign]
(
@Request_Id  int,
@User char(10),
@Inventory_No int
)
As 
Begin


   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


update tbl_stockinventorydetails
set Assign_Type='Stock',
	Assign_To=(Select Requested_by From tbl_RequestMaster Where Request_Id=@Request_Id),
	Assign_ToDept='',
	Assign_ToBranch='',
	Assign_Date=getdate(),
	Assign_By=@User,
	Request_Id=@Request_Id,
	Status='0'
Where Inventory_No=@Inventory_No





------Add To Log Table i.e tbl_StockInventoryDetails-----------------
insert into tbl_stockinventorydetails_log(Inventory_No,Product_Code,Model_Id,Vendor_Code,Warranty_Type,
										Assign_type,Assign_To,Assign_ToDept,Assign_ToBranch,Assign_Date,
										Assign_By,Request_Id,Status,Product_Desc,Part_No,Unit_Price,
										Bill_Orderby,Bill_Orderdate,Modified_By,Modified_Date)

select Inventory_No,Product_Code,Model_Id,Vendor_Code,Warranty_Type,Assign_type,Assign_To,Assign_ToDept,
		Assign_ToBranch,Assign_Date,Assign_By,Request_Id,Status,Product_Desc,Part_No,Unit_Price,
		Bill_Orderby,Bill_Orderdate,Modified_By,Modified_Date
from tbl_stockinventorydetails 
where Inventory_No = @Inventory_No





-----------------------------

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateInvOnCancelPO
-- --------------------------------------------------


CREATE   Proc [dbo].[USP_UpdateInvOnCancelPO] 
(
@Request_Id INT,
@User_id char(10)

)
As 
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 




Update tbl_stockinventorydetails
	Set	
		--Modified_by
		Modified_By = @User_id,
		--Modified_Date
		Modified_Date = getdate(),
		Status = '2'
	Where Request_Id=@Request_Id and Assign_Type='PO'



-------------------insert in log i.e tbl_stockinventirydetails_log----------------

insert into tbl_stockinventorydetails_log(Inventory_No,Product_Code,Model_Id,Vendor_Code,Warranty_Type,
										Assign_type,Assign_To,Assign_ToDept,Assign_ToBranch,Assign_Date,
										Assign_By,Request_Id,Status,Product_Desc,Part_No,Unit_Price,
										Bill_Orderby,Bill_Orderdate,Modified_By,Modified_Date)

select Inventory_No,Product_Code,Model_Id,Vendor_Code,Warranty_Type,Assign_type,Assign_To,Assign_ToDept,
		Assign_ToBranch,Assign_Date,Assign_By,Request_Id,Status,Product_Desc,Part_No,Unit_Price,
		Bill_Orderby,Bill_Orderdate,Modified_By,Modified_Date
from tbl_stockinventorydetails 
where Request_Id=@Request_Id And Assign_Type='PO'


-------------------------------------------------------------



End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateInvOnModifyPO
-- --------------------------------------------------






--Note That @User_id is taken but not used since need to confirm as to update billoerder_by and billorder_date


CREATE Proc [dbo].[USP_UpdateInvOnModifyPO] 
(
@User_id char(10),
@Vendor_Code int,
@Warranty_Type char(80),
--@Model_Id char(20),
@Request_Id int,
@Inventory_No int,
@Product_Desc varchar(500),
@part_no char(20),
@Unit_Price float


)
As 
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 



Declare @Product_Code char(20)
Declare @Model_Id char(20)

set @Product_Code=(select item_Code from tbl_requestmaster where Request_id = @Request_Id)
set @Model_Id = (select Model_No from tbl_requestmaster where Request_id = @Request_Id)

Update tbl_stockinventorydetails
	Set	Product_Code = @Product_Code,
		Model_Id = @Model_Id,
		Vendor_Code = @Vendor_Code ,
		--Modified_by
		Modified_By = @User_id,
		--Modified_Date
		Modified_Date = getdate(),
		Warranty_Type= @Warranty_Type,
		Product_Desc = @Product_Desc,	
		Part_No = @part_no ,
		Unit_Price = @Unit_Price,
		Bill_Orderby = @User_id,
		Bill_Orderdate = getdate() 
	Where Inventory_No = @Inventory_No and Request_Id=@Request_Id and Assign_Type='PO'




-------------------insert in log i.e tbl_stockinventirydetails_log----------------

insert into tbl_stockinventorydetails_log(Inventory_No,Product_Code,Model_Id,Vendor_Code,Warranty_Type,
										Assign_type,Assign_To,Assign_ToDept,Assign_ToBranch,Assign_Date,
										Assign_By,Request_Id,Status,Product_Desc,Part_No,Unit_Price,
										Bill_Orderby,Bill_Orderdate,Modified_By,Modified_Date)

select Inventory_No,Product_Code,Model_Id,Vendor_Code,Warranty_Type,Assign_type,Assign_To,Assign_ToDept,
		Assign_ToBranch,Assign_Date,Assign_By,Request_Id,Status,Product_Desc,Part_No,Unit_Price,
		Bill_Orderby,Bill_Orderdate,Modified_By,Modified_Date
from tbl_stockinventorydetails 
where Inventory_No = @Inventory_No and Request_Id=@Request_Id And Assign_Type='PO'


-------------------------------------------------------------



End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateItPurchaseOrder
-- --------------------------------------------------




CREATE Proc [dbo].[USP_UpdateItPurchaseOrder]                                    
(                                      
@Fld_RequestId nvarchar(max),                
@Fld_VendorId int,                
@Fld_VendorName varchar(200),                
@Fld_PurchaseOrderNo varchar(100),                
@Fld_ShipTo varchar(500),                
@Fld_ShippingMethod varchar(500),                
@Fld_OrderTerms varchar(500),                
@Fld_CompID int,        
--@Fld_Pid int,    
@POBranch varchar(500),
@PODeliveryTime varchar(500),
@Userid char(20)        
)                                      
as                                     
        
Begin  

        
           SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
     
                                    
              
---------------------Update--------------------------------    
Update tbl_ItRequestPurchaseOrder
set Fld_VendorId = @Fld_VendorId,
	Fld_VendorName = @Fld_VendorName,
	Fld_ShipTo = @Fld_ShipTo,
    Fld_ShippingMethod = @Fld_ShippingMethod, 
	Fld_OrderTerms = @Fld_OrderTerms,
	Fld_CompID = @Fld_CompID,
	POBranch = @POBranch,
	PODeliveryTime = @PODeliveryTime,
	--Generated_By is same as original person entered it
	--Generated_date is same as original person entered it
	Modified_By=@Userid,
	Modified_Date=getdate(),
	---set Po_Status as modified i.e M
	PO_Status = 'MPO'

Where Fld_PurchaseOrderNo = @Fld_PurchaseOrderNo and Fld_RequestId =@Fld_RequestId            

------------------------------------



------------------------Insert Into Log ie tbl_ITRequestPurchaseorder_Log-------------
--NOTE That We Need To get "EXISTING" PID
-- from the tbl_Itrequestpurchaseorder to enter the SAME in tbl_ItRequestPurchaseOrder_Log

Declare @Pid int
Set @Pid = (Select Fld_PID from  tbl_ItRequestPurchaseOrder Where Fld_RequestID=@Fld_RequestId )

--Declare @Modified_By char(20) 
--Set @Modified_By = @Userid
--Modified_Date is Taken Directly


insert into tbl_ItRequestPurchaseOrder_Log (Fld_RequestId,Fld_VendorId,Fld_VendorName,Fld_PurchaseOrderNo,Fld_ShipTo,
											Fld_ShippingMethod,Fld_OrderTerms,Fld_DeliveryDate,Fld_CompID,Fld_Pid,
											POBranch,PODeliveryTime,Modified_By,Modified_Date,PO_Status)



 values                                       
 (                                       
@Fld_RequestId,                
@Fld_VendorId,                 
@Fld_VendorName,                 
@Fld_PurchaseOrderNo,                 
@Fld_ShipTo,                 
@Fld_ShippingMethod ,                
@Fld_OrderTerms,                     
getdate(),          
@Fld_CompID, 
       
@Pid,
    
@POBranch,
@PODeliveryTime,

--Modified_by
@Userid,
--Modified_Date
getdate(),
---set Po_Status as modified i.e M
'MPO'                                
)  

----------------------------------------

                                    
                                
 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateItPurchaseOrderoOnCancelRequest
-- --------------------------------------------------








CREATE Proc [dbo].[USP_UpdateItPurchaseOrderoOnCancelRequest]                                    
(                                      
@Fld_RequestId nvarchar(max),                
@Userid char(20)        
)                                      
as                                     
        
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

         
 Declare @Pid int
Set @Pid = (Select Fld_PID from  tbl_ItRequestPurchaseOrder Where Fld_RequestID=@Fld_RequestId )                                 
              
---------------------Update--------------------------------    
Update tbl_ItRequestPurchaseOrder
set Modified_By = @Userid,
	Modified_Date = getdate(), 
	PO_Status = 'CAPO'
Where Fld_RequestId =@Fld_RequestId            

------------------------------------



------------------------Insert Into Log ie tbl_ITRequestPurchaseorder_Log-------------



Insert into tbl_ItRequestPurchaseOrder_Log (Fld_requestId,Fld_VendorId,Fld_VendorName,Fld_PurchaseOrderNo,fld_ShipTo,
											Fld_ShippingMethod,Fld_orderTerms,Fld_DeliveryDate,Fld_CompID,Fld_PId,
											POBranch,PODeliveryTime,Modified_By,Modified_date,PO_Status)



select Fld_requestId,Fld_VendorId,Fld_VendorName,Fld_PurchaseOrderNo,fld_ShipTo,
		Fld_ShippingMethod,Fld_orderTerms,Fld_DeliveryDate,Fld_CompID,Fld_PId,
		POBranch,PODeliveryTime,Modified_By,Modified_date,PO_Status
From tbl_ItRequestPurchaseOrder where Fld_RequestId=@Fld_RequestId

----------------------------------------

                                    
                                
 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateItPurchaseOrderoOnCloseRequest
-- --------------------------------------------------









CREATE Proc [dbo].[USP_UpdateItPurchaseOrderoOnCloseRequest]                                    
(                                      
@Fld_RequestId nvarchar(max),                
@Userid char(20)        
)                                      
as                                     
        
Begin

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


         
 Declare @Pid int
Set @Pid = (Select Fld_PID from  tbl_ItRequestPurchaseOrder Where Fld_RequestID=@Fld_RequestId )                                 
              
---------------------Update--------------------------------    
Update tbl_ItRequestPurchaseOrder
set Modified_By = @Userid,
	Modified_Date = getdate(),
	PO_Status = 'CPO'
Where Fld_RequestId =@Fld_RequestId            

------------------------------------



------------------------Insert Into Log ie tbl_ITRequestPurchaseorder_Log-------------



Insert into tbl_ItRequestPurchaseOrder_Log (Fld_requestId,Fld_VendorId,Fld_VendorName,Fld_PurchaseOrderNo,fld_ShipTo,
											Fld_ShippingMethod,Fld_orderTerms,Fld_DeliveryDate,Fld_CompID,Fld_PId,
											POBranch,PODeliveryTime,Modified_By,Modified_date,PO_Status)



select Fld_requestId,Fld_VendorId,Fld_VendorName,Fld_PurchaseOrderNo,fld_ShipTo,
		Fld_ShippingMethod,Fld_orderTerms,Fld_DeliveryDate,Fld_CompID,Fld_PId,
		POBranch,PODeliveryTime,Modified_By,Modified_date,PO_Status
From tbl_ItRequestPurchaseOrder where Fld_RequestId=@Fld_RequestId

----------------------------------------

                                    
                                
 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_UpdateITTaxesonModifyPO
-- --------------------------------------------------





CREATE proc [dbo].[Usp_UpdateITTaxesonModifyPO]      
(      
@Fld_RequestID nvarchar(max),      
@Fld_Excise Float,      
@Fld_Edn_Cess Float,      
@Fld_CST Float,      
@Fld_VAT Float,      
@Fld_Service Float,      
@Fld_Frieght Float,      
@Fld_Octroi Float,      
@Fld_Discount Float,      
@Fld_Status Varchar(10),
@Userid char(20)   
)      
as   
  Begin
     SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

  
  
  -----------------------Update---------------------------

	  update tbl_it_Taxes                                          
		set Fld_Excise=@Fld_Excise,  
		 Fld_Edn_Cess=@Fld_Edn_Cess,  
		 Fld_CST=@Fld_CST,  
		 Fld_VAT=@Fld_VAT,  
		 Fld_Service=@Fld_Service,  
		 Fld_Frieght=@Fld_Frieght,  
		 Fld_Octroi=@Fld_Octroi,  
		 Fld_Discount=@Fld_Discount,  
		 Fld_Status=@Fld_Status,
		--Generated_By is same
		--Generated_date is same
		Modified_By=@Userid,
		Modified_Date=getdate()              
		 where Fld_RequestId = @Fld_RequestId   

---------------------------------------------


------------------------Insert into Log ie tbl_it_taxes_log-------------------------

--Note
insert into tbl_it_Taxes_Log values
(
@Fld_RequestID,      
@Fld_Excise,      
@Fld_Edn_Cess,      
@Fld_CST,      
@Fld_VAT,      
@Fld_Service,      
@Fld_Frieght,      
@Fld_Octroi,      
@Fld_Discount,      
@Fld_Status,
--Modified_By
@Userid,
--Modified_date
getdate() 
)

-----------------------------------------
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateReviewer
-- --------------------------------------------------
-- =============================================  
-- Author:  Suraj Patil  
-- Create date: 31/01/2017  
-- Description: <Description,,>  
/*  
USP_UpdateReviewer 'Branch','E62250','E62250'  
*/  
-- =============================================  
CREATE PROCEDURE USP_UpdateReviewer  
 @Type as varchar(100),  
 @Ecode  as varchar(100),  
 @updated_by as varchar(100)  
AS  
BEGIN  
 declare @cnt as int = 0   
 if @Type = 'Branch'  
 begin  
  set @Type = 'other'  
 end  
   
 select @cnt=COUNT(1) from Tbl_ReviewerMaster where isdelete = 0 and TypeOfReviewer = @Type  
 if @cnt =0   
 begin  
  select 'User Not Found'  
 end  
 else  
 begin  
   
   
  declare   
  @Reviewer_Email as varchar(100),  
  @Reviewer_Name as varchar(100)  
    
  select @Reviewer_Name = Emp_name,@Reviewer_Email = email from risk.dbo.emp_info where emp_no = @ecode  
   
  update Tbl_ReviewerMaster   
  set isdelete = 1  
  where isdelete = 0 and TypeOfReviewer = @Type  
    
    
  insert into Tbl_ReviewerMaster(  
  Reviewer,Reviewer_Email,TypeOfReviewer,  
  isdelete,ModifiedOn,  
  ModifiedBy,Reviewer_Name)  
  values  
  (  
  @Ecode,@Reviewer_Email,@Type,0,GETDATE(),@updated_by,@Reviewer_Name  
  )  
   UPDATE tbl_ITUsers        
      SET    [Role] = 'ADM'        
      WHERE  Emp_Id IN ( select Reviewer from Tbl_ReviewerMaster where isdelete = 0 )     
    
  select 'Success'  
    
 end  
   
   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateReviewer_05Feb2020
-- --------------------------------------------------
-- =============================================  
-- Author:  Suraj Patil  
-- Create date: 31/01/2017  
-- Description: <Description,,>  
/*  
USP_UpdateReviewer 'Branch','E62250','E62250'  
*/  
-- =============================================  
CREATE PROCEDURE USP_UpdateReviewer_05Feb2020  
 @Type as varchar(100),  
 @Ecode  as varchar(100),  
 @updated_by as varchar(100)  
AS  
BEGIN  
 declare @cnt as int = 0   
 if @Type = 'Branch'  
 begin  
  set @Type = 'other'  
 end  
   
 select @cnt=COUNT(1) from Tbl_ReviewerMaster where isdelete = 0 and TypeOfReviewer = @Type  
 if @cnt =0   
 begin  
  select 'User Not Found'  
 end  
 else  
 begin  
   
   
  declare   
  @Reviewer_Email as varchar(100),  
  @Reviewer_Name as varchar(100)  
    
  select @Reviewer_Name = Emp_name,@Reviewer_Email = email from risk.dbo.emp_info where emp_no = @ecode  
   
  update Tbl_ReviewerMaster   
  set isdelete = 1  
  where isdelete = 0 and TypeOfReviewer = @Type  
    
    
  insert into Tbl_ReviewerMaster(  
  Reviewer,Reviewer_Email,TypeOfReviewer,  
  isdelete,ModifiedOn,  
  ModifiedBy,Reviewer_Name)  
  values  
  (  
  @Ecode,@Reviewer_Email,@Type,0,GETDATE(),@updated_by,@Reviewer_Name  
  )  
   UPDATE [196.1.115.239].Harmony.dbo.tbl_ITUsers        
      SET    [Role] = 'ADM'        
      WHERE  Emp_Id IN ( select Reviewer from Tbl_ReviewerMaster where isdelete = 0 )     
    
  select 'Success'  
    
 end  
   
   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateReviewStatus
-- --------------------------------------------------
-- =============================================        
-- Author:  Suraj Patil        
-- Create date: 25/01/2017        
-- Description: Update Review Status   
/*
USP_UpdateReviewStatus 16989,1,'test reject','E62250'
*/     
-- =============================================        
CREATE PROCEDURE [dbo].[USP_UpdateReviewStatus]        
 @Request_Id as int,        
 @ReviewStatus as int,        
 @remark as varchar(max),
 @ReviewedBy as varchar(100)          
AS        
BEGIN        
 --Tbl_ReviewRemarks        
 declare @cnt as int = 0        
  declare @IT_Engineer char(10), @Item_Code char(10),@Model_No char(10),        
  @Model_Quantity char(10),@Requested_By varchar(8),        
  @User_Remark varchar(200),@Justification_Id char(10),@Estimated_Total_Price int         
          
  select         
  @IT_Engineer = IT_Engineer,@Item_Code = Item_Code ,@Model_No = Model_No,        
  @Model_Quantity = Model_Quantity,@Requested_By = Requested_By,        
  @User_Remark = User_Remark,@Justification_Id = Justification_Id,        
  @Estimated_Total_Price = Estimated_Total_Price        
  from tbl_RequestMaster where Request_Id = @Request_Id         
           
 select @cnt = COUNT(1) from Tbl_ReviewRemarks where Request_Id =@Request_Id        
 if @cnt=0        
 begin        
  insert into Tbl_ReviewRemarks(Request_Id,Remark,ReviewDate,ReviewedBy)        
  values(@Request_Id,@remark,GETDATE(),@ReviewedBy)        
 end        
 else        
 begin        
  update  Tbl_ReviewRemarks        
  set Remark = @remark,        
  ReviewDate = getdate(),
  ReviewedBy = @ReviewedBy
  where request_id = @request_id--(Request_Id,Remark,ReviewDate)        
 end        
 --Review status = 1 means Approved by approver        
 if @ReviewStatus = 1        
 begin        
  --USP_ITRequestMaster_new        
   exec USP_ITRequestMaster_new  @IT_Engineer,@Item_Code,@Model_No,@Model_Quantity,@Requested_By,@User_Remark,@Justification_Id,@Estimated_Total_Price,@Request_Id        
           
 end        
 else        
 begin        
         
  update tbl_RequestMaster       
  set Status_Code = 'Rej'        
  where Request_Id = @Request_Id        
          
            
  declare @Requester_Email as varchar(100)='',        
  @Requester_Name as varchar(100)='',        
  @Item_Name as varchar(100)='',        
  @Model_Name as varchar(100)=''        
          
  select @Requester_Email = email,@Requester_Name = Emp_name from risk.dbo.emp_info where emp_no = @Requested_By             
  select @Item_Name=PRODUCT_NAME from TBL_CAPEXPRODUCTMASTER where PRODUCT_CODE =@Item_Code         
  SELECT @Model_Name =  Model_Name FROM tbl_ProductModelMaster where model_id = @Model_No  and Product_Code =@Item_Code            
            
            
            
            
     --------------------------------Rejection Email Logic start -----------------------------------          
    declare @EMAIL_TO as varchar(1000)=@Requester_Email          
    declare @EMAIL_CC as varchar(1000)=''          
    declare @SUB as varchar(1000)=cast(@Request_Id as varchar(500)) +':- IT Assets New Request'          
    declare @HTML as varchar(max)=''          
    declare  @content as varchar(max)= ''          
    set @content = @content + '<HTML><HEAD><TITLE>' + cast(@Request_Id as varchar(500))  + ': New IT Assets request</TITLE><STYLE TYPE=''text/css''>';          
    set @content = @content + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdan
  
    
      
a; background-color: #efefef; text-align: left; height: 18px;}';          
    set @content = @content + '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em;  border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #e
  
    
      
fefef;}';          
    set @content = @content + '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}';          
    set @content = @content + '</STYLE></HEAD><Body>';          
    set @content = @content + 'Dear ' + @Requester_Name  + ',';          
    set @content = @content + '<br>';          
        
    set @content = @content + '<p>This is to inform you that the request raised by you has been rejected at the reviewer Approval level, Because of Reason mentioned below<br>The details of your request raised are</p><br>';          
        
    set @content = @content + '<center><table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''600''><caption>IT Assets Request Details</caption>';          
    set @content = @content + '<tr width=''100''><td> Request ID :- </td><td> ' + cast(@Request_Id as varchar(500))  + ' </td></tr>';          
    set @content = @content + '<tr width=''100''><td> Requested By:- </td><td> ' +  @Requested_By  + ' </td></tr>';          
    set @content = @content + '<tr width=''100''><td> Request Date:- </td><td>' +  cast(GETDATE() as varchar(500))  + '</td></tr>';          
    set @content = @content + '<tr width=''100''><td> Item Name :-    </td><td colspan=''2''>' +  @Item_Name  + ' </td></tr>';          
    set @content = @content + '<tr width=''100''><td> Model Name :-      </td><td > ' +  @Model_Name  + ' </td></tr>';          
    set @content = @content + '<tr width=''100''><td> Quantity :-      </td><td > ' +  @Model_Quantity  + ' </td></tr>';          
    set @content = @content + '<tr width=''100''><td> Estimated Price:-  </td><td> ' +  cast(@Estimated_Total_Price as varchar(500))  + ' </td></tr>';          
    set @content = @content + '<tr width=''100''><td>Reason For Requirement:-  </td><td > ' +  case when @Justification_Id = 1 then 'New Hiring' else 'Replacement' end  + ' </td></tr>';          
    set @content = @content + '<tr width=''100''><td>User Remark:-  </td><td colspan=''5''>' +  @User_Remark  + ' </td></tr>';          
    set @content = @content + '<tr width=''100''><td>Rejection Reson:-  </td><td colspan=''5''> '+@remark+'</td></tr>';          
    set @content = @content + '<tr width=''100''><td>Reviewer:-  </td><td colspan=''5''> '+@ReviewedBy+'</td></tr>';          
    set @content = @content + '</table></center><br><br>';          
        
    --set @content = @content + '<p> Would request you to kindly review the same by clicking on Okey button in your respective ITPMS login</p><br>';          
        
        
    set @content = @content + '<P>This is a system-generated e-mail, please do not reply to this email.</p><br><br>';          
    set @content = @content + 'Thanks & Regards,<br>IT Team </Body> </html>';          
        
        
        
        
        
    EXEC msdb.dbo.sp_send_dbmail                                         
    @profile_name = 'ITasset@angelbroking.com',                                         
    @recipients = @EMAIL_TO,                                         
    @copy_recipients = @EMAIL_CC,                                         
    --@blind_copy_recipients = 'suraj.patil@angelbroking.com', --; Sanjay.Ghosh@AngelBroking.Com',                                         
    @subject = @SUB,                                        
    @body = @content,                          
    @body_format = 'HTML'                
   --------------------------------Rejection Email Logic End -----------------------------------          
            
            
            
           
 end         
         
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_UserMasterAllinOne
-- --------------------------------------------------
CREATE proc [dbo].[Usp_UserMasterAllinOne] 
(
@Option CHAR(20),
@EmpId CHAR(20),
@Application CHAR(50),
@AccessType CHAR(20),
@Role CHAR(10),
@Userid CHAR(20)
 
)

AS
BEGIN


   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


	IF(@Option = 'CheckExisting')
		BEGIN
				SELECT  Emp_Id
				FROM tbl_ITUsers
				WHERE Emp_Id = @EmpId
		END
		
		ELSE IF (@Option = 'GetDetails')
			BEGIN
					SELECT  *
					FROM tbl_ITUsers
					WHERE Emp_Id = @EmpId
			END
				
	ELSE IF (@Option = 'Add')	
		BEGIN
			INSERT INTO tbl_ITUsers (Emp_Id,Access_Type,Application,Role,Added_By,Added_On,Modified_By,Modified_Date)
			VALUES (@EmpId,@AccessType,@Application,@Role,@Userid,GETDATE(),@Userid,GETDATE())
			
			----------Make An entry in log----------
			INSERT INTO dbo.tbl_ITUsers_log(Emp_Id,Access_Type,Application,Role,Added_By,Added_On,
											Modified_By,Modified_Date)
			SELECT Emp_Id,Access_Type,Application,Role,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_ITUsers
			WHERE Emp_Id = @EmpId
			------------------------------------
			
			
		END
		
		ELSE IF (@Option = 'Edit')
		Begin  
			UPDATE tbl_ITUsers 
				SET Access_Type = @AccessType,
					APPLICATION = @Application,
					ROLE = @Role,
					Modified_By = @Userid ,
					Modified_Date = GETDATE()
				WHERE Emp_Id = @EmpId	
				
			----------Make An entry in log----------
			INSERT INTO dbo.tbl_ITUsers_log(Emp_Id,Access_Type,Application,Role,Added_By,Added_On,
											Modified_By,Modified_Date)
			SELECT Emp_Id,Access_Type,Application,Role,Added_By,Added_On,Modified_By,Modified_Date
			FROM tbl_ITUsers
			WHERE Emp_Id = @EmpId
			------------------------------------				
		END
		
		

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_UserMasterAllinOne_05feb2020
-- --------------------------------------------------






CREATE proc [dbo].[Usp_UserMasterAllinOne_05feb2020] 
(
@Option CHAR(20),
@EmpId CHAR(20),
@Application CHAR(50),
@AccessType CHAR(20),
@Role CHAR(10),
@Userid CHAR(20)
 
)

AS
BEGIN


   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 


	IF(@Option = 'CheckExisting')
		BEGIN
				SELECT  Emp_Id
				FROM [196.1.115.239].[Harmony].DBO.tbl_ITUsers
				WHERE Emp_Id = @EmpId
		END
		
		ELSE IF (@Option = 'GetDetails')
			BEGIN
					SELECT  *
					FROM [196.1.115.239].[Harmony].DBO.tbl_ITUsers
					WHERE Emp_Id = @EmpId
			END
				
	ELSE IF (@Option = 'Add')	
		BEGIN
			INSERT INTO [196.1.115.239].[Harmony].DBO.tbl_ITUsers (Emp_Id,Access_Type,Application,Role,Added_By,Added_On,Modified_By,Modified_Date)
			VALUES (@EmpId,@AccessType,@Application,@Role,@Userid,GETDATE(),@Userid,GETDATE())
			
			----------Make An entry in log----------
			INSERT INTO dbo.tbl_ITUsers_log(Emp_Id,Access_Type,Application,Role,Added_By,Added_On,
											Modified_By,Modified_Date)
			SELECT Emp_Id,Access_Type,Application,Role,Added_By,Added_On,Modified_By,Modified_Date
			FROM [196.1.115.239].[Harmony].DBO.tbl_ITUsers
			WHERE Emp_Id = @EmpId
			------------------------------------
			
			
		END
		
		ELSE IF (@Option = 'Edit')
		Begin  
			UPDATE [196.1.115.239].[Harmony].DBO.tbl_ITUsers 
				SET Access_Type = @AccessType,
					APPLICATION = @Application,
					ROLE = @Role,
					Modified_By = @Userid ,
					Modified_Date = GETDATE()
				WHERE Emp_Id = @EmpId	
				
			----------Make An entry in log----------
			INSERT INTO dbo.tbl_ITUsers_log(Emp_Id,Access_Type,Application,Role,Added_By,Added_On,
											Modified_By,Modified_Date)
			SELECT Emp_Id,Access_Type,Application,Role,Added_By,Added_On,Modified_By,Modified_Date
			FROM [196.1.115.239].[Harmony].DBO.tbl_ITUsers
			WHERE Emp_Id = @EmpId
			------------------------------------				
		END
		
		

END
  



--Select * FROM [196.1.115.239].[Harmony].DBO.tbl_ITUsers

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_VendorMasterAllinOne
-- --------------------------------------------------
  
  
  
CREATE Proc [dbo].[USP_VendorMasterAllinOne]         
(        
@Option char(20),        
@VendorCode int,        
@VendorName varchar(200),        
@Address1 VARCHAR(200),        
@Address2 VARCHAR(200),        
@Address3 VARCHAR(200),        
@Userid char(20) ,
@CompanyID int=null       
)        
As        
Begin 

    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

if(@Option = 'FillDetails')        
 Begin        
  Select VendorName,VendorCode         
  From tbl_it_VendorMaster         
  Where Status='A' order by VendorName       
        
 End        
        
else if (@Option = 'GetVendorDetails')        
 Begin        
  Select VendorCode,VendorName,Address1,Address2,Address3,CompanyID         
  From tbl_it_VendorMaster         
  Where  VendorCode =@VendorCode and Status='A'  order by VendorName       
 End        
        
        
        
else if(@Option = 'GetDetails')        
 Begin  
 Declare @Query nvarchar(max)        
 Set @Query = 'SELECT VendorCode AS [Vendor Code],VendorName AS [Vendor Name],Address1+Address2+Address3 AS [Address],        
      [Status]= CASE Status         
      WHEN ''A'' THEN ''Active''        
      WHEN ''D'' THEN ''Disable''         
      End         
    from tbl_it_VendorMaster        
    Where 1=1 order by VendorName'        
PRINT(@Query)        
 IF(@VendorCode <> -1)    
 BEGIN      
  SET @Query= REPLACE ( @Query , 'order by VendorName' , '' )  
  SET @Query = @Query + ' And VendorCode ='+CONVERT(VARCHAR(20),@VendorCode)+ 'order by VendorName'        
  --PRINT(@Query)            
 END         
 Exec(@Query) 
End        
        
else if (@Option = 'CheckExistingAdd')        
 Begin        
  Select VendorName        
    from tbl_it_VendorMaster        
    where VendorName = @VendorName    
    order by VendorName      
            
 End        
        
--else if (@Option = 'CheckExistingEdit')        
-- Begin        
--  Select VendorName        
--    from tbl_it_VendorMaster        
--    where VendorName = @VendorName        
--            
-- End        
        
else if (@Option = 'CheckExistingDelete')        
 Begin        
  Select VendorCode,VendorName        
    from tbl_it_VendorMaster        
    where VendorCode = @VendorCode        
    order by VendorName      
 End        
        
else if(@Option = 'Add')        
 begin      
 if not exists (select * from tbl_it_VendorMaster Where  VendorCode =@VendorCode and Status='A' )      
    
  Insert into tbl_it_VendorMaster(VendorCode,VendorName,Address1,Address2,Address3,Status,Added_By,Added_On,Modified_By,Modified_Date,CompanyID)        
    Values(@VendorCode,@VendorName,@Address1,@Address2,@Address3,'A',@Userid,getdate(),@Userid,getdate(),@CompanyID)        
            
   ----------Make An entry in log----------        
   INSERT INTO tbl_it_VendorMaster_Log(VendorCode,VendorName,Address1,Address2,Address3,Status,        
           Added_By,Added_On,Modified_By,Modified_Date,CompanyID)        
   SELECT VendorCode,VendorName,Address1,Address2,Address3,Status,Added_By,Added_On,Modified_By,Modified_Date,CompanyID        
   FROM tbl_it_VendorMaster        
   WHERE VendorCode = @VendorCode        
   ------------------------------------             
 End        
     
        
        
else if (@Option = 'Edit')        
BEGIN
  if exists (select * from tbl_it_VendorMaster Where  VendorCode =@VendorCode and Status='A' )      
  begin      
  Update tbl_it_VendorMaster        
   set VendorName = @VendorName,        
    Address1 = @Address1 ,        
    Address2 = @Address2,        
    Address3  = @Address3,        
    Modified_By = @Userid,        
    Modified_Date = GETDATE(),
    CompanyID = @CompanyID       
   Where VendorCode = @VendorCode        
           
   ----------Make An entry in log----------        
   INSERT INTO tbl_it_VendorMaster_Log(VendorCode,VendorName,Address1,Address2,Address3,Status,        
           Added_By,Added_On,Modified_By,Modified_Date,CompanyID)        
   SELECT VendorCode,VendorName,Address1,Address2,Address3,Status,Added_By,Added_On,Modified_By,Modified_Date ,CompanyID       
   FROM tbl_it_VendorMaster        
   WHERE VendorCode = @VendorCode        
   ------------------------------------           
END
 End        
        
else if(@Option = 'Delete')        
 Begin        
  Update tbl_it_VendorMaster        
   set Status= 'D',        
    Modified_By = @Userid,        
    Modified_Date = getdate()        
   Where VendorCode = @VendorCode  
           
   ----------Make An entry in log----------        
   INSERT INTO tbl_it_VendorMaster_Log(VendorCode,VendorName,Address1,Address2,Address3,Status,        
     Added_By,Added_On,Modified_By,Modified_Date,CompanyID)        
   SELECT VendorCode,VendorName,Address1,Address2,Address3,Status,Added_By,Added_On,Modified_By,Modified_Date ,CompanyID       
   FROM tbl_it_VendorMaster        
   WHERE VendorCode = @VendorCode        
   ------------------------------------   
 End  
       
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_VendorMasterAllinOne_test
-- --------------------------------------------------
  
  
  
  
  
  
  
  
  
CREATE Proc [dbo].[USP_VendorMasterAllinOne_test]   
(  
@Option char(20),  
@VendorCode int,  
@VendorName varchar(200),  
@Address1 VARCHAR(200),  
@Address2 VARCHAR(200),  
@Address3 VARCHAR(200),  
@Userid char(20)  
)  
As  
Begin  


     SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

  
  
if(@Option = 'FillDetails')  
 Begin  
  Select VendorName,VendorCode   
  From tbl_it_VendorMaster   
  Where Status='A'  
  
 End  
  
else if (@Option = 'GetVendorDetails')  
 Begin  
  Select VendorCode,VendorName,Address1,Address2,Address3   
  From tbl_it_VendorMaster   
  Where  VendorCode =@VendorCode and Status='A'  
 End  
  
  
  
else if(@Option = 'GetDetails')  
 Begin  
  
 Declare @Query nvarchar(max)  
 Set @Query = 'SELECT VendorCode AS [Vendor Code],VendorName AS [Vendor Name],Address1+Address2+Address3 AS [Address],  
      [Status]= CASE Status   
      WHEN ''A'' THEN ''Active''  
      WHEN ''D'' THEN ''Disable''   
      End   
    from tbl_it_VendorMaster  
    Where 1=1'  
PRINT(@Query)  
 if(@VendorCode <> '')  
 set @Query = @Query + ' And VendorCode ='+CONVERT(VARCHAR(20),@VendorCode)  
 --PRINT(@Query)  
  
 Exec(@Query)  
   
 End  
  
else if (@Option = 'CheckExistingAdd')  
 Begin  
  Select VendorName  
    from tbl_it_VendorMaster  
    where VendorName = @VendorName  
      
 End  
  
--else if (@Option = 'CheckExistingEdit')  
-- Begin  
--  Select VendorName  
--    from tbl_it_VendorMaster  
--    where VendorName = @VendorName  
--      
-- End  
  
else if (@Option = 'CheckExistingDelete')  
 Begin  
  Select VendorCode,VendorName  
    from tbl_it_VendorMaster  
    where VendorCode = @VendorCode  
      
 End  
  
else if(@Option = 'Add')  
 Begin  
  Insert into tbl_it_VendorMaster(VendorCode,VendorName,Address1,Address2,Address3,Status,Added_By,Added_On,Modified_By,Modified_Date)  
    Values(@VendorCode,@VendorName,@Address1,@Address2,@Address3,'A',@Userid,getdate(),@Userid,getdate())  
      
   ----------Make An entry in log----------  
   INSERT INTO tbl_it_VendorMaster_Log(VendorCode,VendorName,Address1,Address2,Address3,Status,  
           Added_By,Added_On,Modified_By,Modified_Date)  
   SELECT VendorCode,VendorName,Address1,Address2,Address3,Status,Added_By,Added_On,Modified_By,Modified_Date  
   FROM tbl_it_VendorMaster  
   WHERE VendorCode = @VendorCode  
   ------------------------------------       
 End  
  
else if (@Option = 'Edit')  
 Begin  
  Update tbl_it_VendorMaster  
   set VendorName = @VendorName,  
    Address1 = @Address1 ,  
    Address2 = @Address2,  
    Address3  = @Address3,  
    Modified_By = @Userid,  
    Modified_Date = GETDATE()  
   Where VendorCode = @VendorCode  
     
   ----------Make An entry in log----------  
   INSERT INTO tbl_it_VendorMaster_Log(VendorCode,VendorName,Address1,Address2,Address3,Status,  
           Added_By,Added_On,Modified_By,Modified_Date)  
   SELECT VendorCode,VendorName,Address1,Address2,Address3,Status,Added_By,Added_On,Modified_By,Modified_Date  
   FROM tbl_it_VendorMaster  
   WHERE VendorCode = @VendorCode  
   ------------------------------------     
     
     
 End  
  
else if(@Option = 'Delete')  
 Begin  
  Update tbl_it_VendorMaster  
   set Status= 'D',  
    Modified_By = @Userid,  
    Modified_Date = getdate()  
   Where VendorCode = @VendorCode  
     
     
   ----------Make An entry in log----------  
   INSERT INTO tbl_it_VendorMaster_Log(VendorCode,VendorName,Address1,Address2,Address3,Status,  
           Added_By,Added_On,Modified_By,Modified_Date)  
   SELECT VendorCode,VendorName,Address1,Address2,Address3,Status,Added_By,Added_On,Modified_By,Modified_Date  
   FROM tbl_it_VendorMaster  
   WHERE VendorCode = @VendorCode  
   ------------------------------------     
     
 End  
  
  
  
  
  
End

GO

-- --------------------------------------------------
-- TABLE dbo.br
-- --------------------------------------------------
CREATE TABLE [dbo].[br]
(
    [BRANCH_CD] NVARCHAR(255) NOT NULL,
    [FLGCSOBRanch] NCHAR(6) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.darwintmp
-- --------------------------------------------------
CREATE TABLE [dbo].[darwintmp]
(
    [id] BIGINT NOT NULL,
    [Emp_no] VARCHAR(20) NULL,
    [Emp_Name] VARCHAR(100) NULL,
    [Hod_no] VARCHAR(100) NULL,
    [Hod_name] VARCHAR(100) NULL,
    [Div_Code] VARCHAR(100) NULL,
    [Div_name] VARCHAR(100) NULL,
    [SBU] VARCHAR(100) NULL,
    [LOB_Code] VARCHAR(100) NULL,
    [LOB] VARCHAR(100) NULL,
    [Department_Code] VARCHAR(100) NULL,
    [Department] VARCHAR(100) NULL,
    [Sub_Department_Code] VARCHAR(100) NULL,
    [Sub_Department] VARCHAR(100) NULL,
    [CategoryDesc] VARCHAR(100) NULL,
    [Channel] VARCHAR(100) NULL,
    [Functional_Code] VARCHAR(100) NULL,
    [Functional_Role] VARCHAR(100) NULL,
    [Designation] VARCHAR(100) NULL,
    [Zone] VARCHAR(100) NULL,
    [Region] VARCHAR(100) NULL,
    [Location] VARCHAR(100) NULL,
    [Attendence_Location] VARCHAR(100) NULL,
    [Cost_Center] VARCHAR(100) NULL,
    [Email_Add] VARCHAR(100) NULL,
    [Join_Date] DATETIME NULL,
    [Phone] VARCHAR(15) NULL,
    [Last_Working_Date] DATETIME NULL,
    [Separation_Reason] VARCHAR(500) NULL,
    [Birth_Date] DATETIME NULL,
    [PAN] VARCHAR(10) NULL,
    [UID] VARCHAR(20) NULL,
    [Client_Code] VARCHAR(15) NULL,
    [Personal_Address] VARCHAR(500) NULL,
    [HOD] VARCHAR(20) NULL,
    [Grade] VARCHAR(20) NULL,
    [Band] VARCHAR(20) NULL,
    [Absconding] VARCHAR(100) NULL,
    [Absconding_from] VARCHAR(100) NULL,
    [Creation_Date] DATETIME NULL,
    [Created_By] VARCHAR(100) NULL,
    [Updatation_Date] DATETIME NULL,
    [Updated_by] VARCHAR(100) NULL,
    [Status] VARCHAR(10) NULL,
    [BankAccountNumber] VARCHAR(50) NULL,
    [ShiftName] VARCHAR(50) NULL,
    [DomainId] VARCHAR(100) NULL,
    [EmployeeFirstName] VARCHAR(50) NULL,
    [EmployeeLastName] VARCHAR(50) NULL,
    [BankName] VARCHAR(200) NULL,
    [Gender] VARCHAR(10) NULL,
    [PinCode] VARCHAR(10) NULL,
    [LocationAddress] VARCHAR(200) NULL,
    [PersonalEmailId] VARCHAR(100) NULL,
    [State] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Emp
-- --------------------------------------------------
CREATE TABLE [dbo].[Emp]
(
    [Emp_Id] VARCHAR(20) NOT NULL,
    [Emp_Name] VARCHAR(150) NOT NULL,
    [Desig] VARCHAR(255) NOT NULL,
    [Senior] VARCHAR(20) NOT NULL,
    [Sr_Name] VARCHAR(150) NOT NULL,
    [Branch_Code] VARCHAR(100) NOT NULL,
    [Join_Date] DATETIME NOT NULL,
    [Sep_Date] DATETIME NOT NULL,
    [Emp_Region] VARCHAR(50) NOT NULL,
    [Emp_Zone] VARCHAR(50) NOT NULL,
    [Emp_Br_Region] VARCHAR(50) NOT NULL,
    [Emp_Br_Zone] VARCHAR(50) NOT NULL,
    [BH] VARCHAR(20) NOT NULL,
    [CH] VARCHAR(20) NOT NULL,
    [RH] VARCHAR(20) NOT NULL,
    [ZH] VARCHAR(20) NOT NULL,
    [RSM] VARCHAR(20) NOT NULL,
    [ASM] VARCHAR(20) NOT NULL,
    [AVP] VARCHAR(20) NOT NULL,
    [SrAVP] VARCHAR(20) NOT NULL,
    [VP] VARCHAR(20) NOT NULL,
    [SrVP] VARCHAR(20) NOT NULL,
    [SrAVPIT] VARCHAR(20) NOT NULL,
    [HeadIT] VARCHAR(20) NOT NULL,
    [ADIT] VARCHAR(20) NOT NULL,
    [ED] VARCHAR(20) NOT NULL,
    [EDCFO] VARCHAR(20) NOT NULL,
    [CSO] VARCHAR(20) NOT NULL,
    [UpdateDate] DATETIME NOT NULL,
    [SrUpdateDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.emp_info
-- --------------------------------------------------
CREATE TABLE [dbo].[emp_info]
(
    [Emp_NO] VARCHAR(6) NOT NULL DEFAULT '',
    [EMP_NAME] VARCHAR(150) NOT NULL DEFAULT '',
    [Senior] VARCHAR(6) NOT NULL DEFAULT '',
    [Sr_name] VARCHAR(150) NOT NULL DEFAULT '',
    [Company] NVARCHAR(50) NOT NULL DEFAULT '',
    [SBU] VARCHAR(50) NOT NULL DEFAULT '',
    [Lob] INT NOT NULL DEFAULT ((0)),
    [Zone] VARCHAR(50) NOT NULL DEFAULT '',
    [Region] VARCHAR(50) NOT NULL DEFAULT '',
    [Location] VARCHAR(50) NOT NULL DEFAULT '',
    [AttendanceLoc] VARCHAR(100) NOT NULL DEFAULT '',
    [Department] NVARCHAR(200) NOT NULL DEFAULT '',
    [Sub_Department] VARCHAR(150) NOT NULL DEFAULT '',
    [Designation] VARCHAR(255) NOT NULL DEFAULT '',
    [Location_Address] VARCHAR(5000) NOT NULL DEFAULT '',
    [LEVEL] VARCHAR(50) NOT NULL DEFAULT '',
    [categorydesc] VARCHAR(50) NOT NULL DEFAULT '',
    [Branch_Cd] NVARCHAR(255) NOT NULL DEFAULT '',
    [Join_Date] DATETIME NOT NULL DEFAULT ((0)),
    [Separation_Date] DATETIME NOT NULL DEFAULT ((0)),
    [emailadd] VARCHAR(100) NOT NULL DEFAULT '',
    [sex] VARCHAR(1) NOT NULL DEFAULT '',
    [BirthDate] DATETIME NOT NULL DEFAULT ((0)),
    [PHONE] VARCHAR(50) NOT NULL DEFAULT '',
    [JOINDATE] DATETIME NOT NULL DEFAULT ((0)),
    [STATUS] CHAR(1) NOT NULL DEFAULT '',
    [Address] VARCHAR(500) NULL DEFAULT '',
    [City] VARCHAR(100) NOT NULL DEFAULT '',
    [State] NVARCHAR(25) NOT NULL DEFAULT '',
    [Account_No] VARCHAR(20) NOT NULL DEFAULT '',
    [pincode] VARCHAR(20) NOT NULL DEFAULT '',
    [Functional_Head] VARCHAR(500) NOT NULL DEFAULT '',
    [flgCSOBranch] NCHAR(6) NOT NULL DEFAULT '',
    [tpdlgcode] NVARCHAR(50) NOT NULL DEFAULT '',
    [LOBDESC] VARCHAR(100) NOT NULL DEFAULT '',
    [UpdDate] DATETIME NOT NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.emp_info_Sep
-- --------------------------------------------------
CREATE TABLE [dbo].[emp_info_Sep]
(
    [Emp_NO] VARCHAR(6) NOT NULL DEFAULT '',
    [EMP_NAME] VARCHAR(150) NOT NULL DEFAULT '',
    [Senior] VARCHAR(6) NOT NULL DEFAULT '',
    [Sr_name] VARCHAR(150) NOT NULL DEFAULT '',
    [Company] NVARCHAR(50) NOT NULL DEFAULT '',
    [SBU] VARCHAR(50) NOT NULL DEFAULT '',
    [Lob] INT NOT NULL DEFAULT ((0)),
    [Zone] VARCHAR(50) NOT NULL DEFAULT '',
    [Region] VARCHAR(50) NOT NULL DEFAULT '',
    [Location] VARCHAR(50) NOT NULL DEFAULT '',
    [AttendanceLoc] VARCHAR(100) NOT NULL DEFAULT '',
    [Department] NVARCHAR(200) NOT NULL DEFAULT '',
    [Sub_Department] VARCHAR(150) NOT NULL DEFAULT '',
    [Designation] VARCHAR(255) NOT NULL DEFAULT '',
    [Location_Address] VARCHAR(5000) NOT NULL DEFAULT '',
    [LEVEL] VARCHAR(50) NOT NULL DEFAULT '',
    [categorydesc] VARCHAR(50) NOT NULL DEFAULT '',
    [Branch_Cd] NVARCHAR(255) NOT NULL DEFAULT '',
    [Join_Date] DATETIME NOT NULL DEFAULT ((0)),
    [Separation_Date] DATETIME NOT NULL DEFAULT ((0)),
    [emailadd] VARCHAR(100) NOT NULL DEFAULT '',
    [sex] VARCHAR(1) NOT NULL DEFAULT '',
    [BirthDate] DATETIME NOT NULL DEFAULT ((0)),
    [PHONE] VARCHAR(50) NOT NULL DEFAULT '',
    [JOINDATE] DATETIME NOT NULL DEFAULT ((0)),
    [STATUS] CHAR(1) NOT NULL DEFAULT '',
    [Address] VARCHAR(500) NULL DEFAULT '',
    [City] VARCHAR(100) NOT NULL DEFAULT '',
    [State] NVARCHAR(25) NOT NULL DEFAULT '',
    [Account_No] VARCHAR(20) NOT NULL DEFAULT '',
    [pincode] VARCHAR(20) NOT NULL DEFAULT '',
    [Functional_Head] VARCHAR(500) NOT NULL DEFAULT '',
    [flgCSOBranch] NCHAR(6) NOT NULL DEFAULT '',
    [tpdlgcode] NVARCHAR(50) NOT NULL DEFAULT '',
    [LOBDESC] VARCHAR(100) NOT NULL DEFAULT '',
    [UpdDate] DATETIME NOT NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITASSETS_ERROR
-- --------------------------------------------------
CREATE TABLE [dbo].[ITASSETS_ERROR]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Login_ID] CHAR(20) NULL,
    [Date] DATETIME NULL,
    [Error] VARCHAR(500) NULL,
    [Line] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mySampleTable
-- --------------------------------------------------
CREATE TABLE [dbo].[mySampleTable]
(
    [ID1] INT NULL,
    [ID2] INT NULL,
    [SomeData] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newreq
-- --------------------------------------------------
CREATE TABLE [dbo].[newreq]
(
    [U_Role] VARCHAR(538) NULL,
    [Requested_amount] INT NULL,
    [who_can_recommend] VARCHAR(456) NULL,
    [who_can_approve] VARCHAR(456) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.region
-- --------------------------------------------------
CREATE TABLE [dbo].[region]
(
    [Code] VARCHAR(255) NULL,
    [Name] VARCHAR(255) NULL,
    [FRANCHISEE] VARCHAR(255) NULL,
    [REG_CODE] VARCHAR(255) NULL,
    [REGION] VARCHAR(255) NULL,
    [ADMIN] VARCHAR(255) NULL,
    [regioncode] VARCHAR(10) NULL,
    [nbranchcode] VARCHAR(10) NULL,
    [ctcl_region] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.t
-- --------------------------------------------------
CREATE TABLE [dbo].[t]
(
    [RecID] BIGINT NULL,
    [Emp_NO] VARCHAR(6) NOT NULL,
    [EMP_NAME] VARCHAR(150) NOT NULL,
    [Designation] VARCHAR(255) NOT NULL,
    [Senior] VARCHAR(6) NOT NULL,
    [Sr_name] VARCHAR(150) NOT NULL,
    [Branch_Cd] NVARCHAR(255) NOT NULL,
    [join_date] DATETIME NOT NULL,
    [Separation_Date] DATETIME NOT NULL,
    [Emp_Region] VARCHAR(50) NOT NULL,
    [Emp_Zone] VARCHAR(50) NOT NULL,
    [Emp_branch_Region] VARCHAR(100) NULL,
    [Emp_branch_Zone] VARCHAR(100) NULL,
    [branchHead] VARCHAR(510) NOT NULL,
    [clusterHead] VARCHAR(510) NOT NULL,
    [regionalHead] VARCHAR(510) NOT NULL,
    [zonalHead] VARCHAR(510) NOT NULL,
    [RegionalSalesManager] VARCHAR(100) NOT NULL,
    [Area Sales Manager] VARCHAR(100) NOT NULL,
    [SrAVPIT] VARCHAR(1) NOT NULL,
    [HeadIT] VARCHAR(6) NOT NULL,
    [ADIT] VARCHAR(6) NOT NULL,
    [EDCFO] VARCHAR(6) NOT NULL,
    [CSO] VARCHAR(6) NOT NULL,
    [UpdateDate] DATETIME NOT NULL,
    [SrUpdateDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Approval_LimitMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Approval_LimitMaster]
(
    [U_Role] CHAR(100) NOT NULL,
    [Category] CHAR(20) NOT NULL,
    [Department] CHAR(150) NOT NULL,
    [Apr_LimitFrom] FLOAT NOT NULL,
    [Apr_LimitTo] FLOAT NOT NULL,
    [B_AprLimitFrom] FLOAT NOT NULL,
    [B_AprLimitTo] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Approval_LimitMaster_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Approval_LimitMaster_Log]
(
    [U_Role] CHAR(100) NOT NULL,
    [Category] CHAR(20) NOT NULL,
    [Department] CHAR(150) NOT NULL,
    [Apr_LimitFrom] FLOAT NOT NULL,
    [Apr_LimitTo] FLOAT NOT NULL,
    [B_AprLimitFrom] FLOAT NOT NULL,
    [B_AprLimitTo] FLOAT NOT NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CapexMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CapexMaster]
(
    [Capex_Code] CHAR(20) NOT NULL,
    [Capex_Type] VARCHAR(200) NOT NULL,
    [Flag] BIT NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CapexMaster_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CapexMaster_Log]
(
    [Capex_Code] CHAR(20) NULL,
    [Capex_Type] VARCHAR(200) NULL,
    [Flag] BIT NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CapexProductMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CapexProductMaster]
(
    [Capex_Code] CHAR(20) NULL,
    [Product_Code] CHAR(20) NOT NULL,
    [Product_Name] VARCHAR(200) NOT NULL,
    [Vendor_Code] CHAR(20) NULL,
    [Flag] BIT NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CapexProductMaster_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CapexProductMaster_Log]
(
    [Capex_Code] CHAR(20) NULL,
    [Product_Code] CHAR(20) NULL,
    [Product_Name] VARCHAR(200) NULL,
    [Vendor_Code] CHAR(20) NULL,
    [Flag] BIT NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CSO_Branch
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CSO_Branch]
(
    [branch_cd] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CSO_Branch_test
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CSO_Branch_test]
(
    [branch_cd] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_EMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_EMP]
(
    [Emp_Id] VARCHAR(20) NOT NULL,
    [Emp_Name] VARCHAR(150) NOT NULL,
    [Desig] VARCHAR(255) NOT NULL,
    [Senior] VARCHAR(20) NOT NULL,
    [Sr_Name] VARCHAR(150) NOT NULL,
    [Branch_Code] VARCHAR(100) NOT NULL,
    [Join_Date] DATETIME NOT NULL,
    [Sep_Date] DATETIME NOT NULL,
    [Emp_Region] VARCHAR(50) NOT NULL,
    [Emp_Zone] VARCHAR(50) NOT NULL,
    [Emp_Br_Region] VARCHAR(50) NOT NULL,
    [Emp_Br_Zone] VARCHAR(50) NOT NULL,
    [BH] VARCHAR(20) NOT NULL,
    [CH] VARCHAR(20) NOT NULL,
    [RH] VARCHAR(20) NOT NULL,
    [ZH] VARCHAR(20) NOT NULL,
    [RSM] VARCHAR(20) NOT NULL,
    [ASM] VARCHAR(20) NOT NULL,
    [AVP] VARCHAR(20) NOT NULL,
    [SrAVP] VARCHAR(20) NOT NULL,
    [VP] VARCHAR(20) NOT NULL,
    [SrVP] VARCHAR(20) NOT NULL,
    [SrAVPIT] VARCHAR(20) NOT NULL,
    [HeadIT] VARCHAR(20) NOT NULL,
    [ADIT] VARCHAR(20) NOT NULL,
    [ED] VARCHAR(20) NOT NULL,
    [EDCFO] VARCHAR(20) NOT NULL,
    [CSO] VARCHAR(20) NOT NULL,
    [UpdateDate] DATETIME NOT NULL,
    [SrUpdateDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EmpTree
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EmpTree]
(
    [Emp_Id] VARCHAR(20) NOT NULL DEFAULT '',
    [Emp_Name] VARCHAR(150) NOT NULL DEFAULT '',
    [Desig] VARCHAR(255) NOT NULL DEFAULT '',
    [Senior] VARCHAR(20) NOT NULL DEFAULT '',
    [Sr_Name] VARCHAR(150) NOT NULL DEFAULT '',
    [Branch_Code] VARCHAR(100) NOT NULL DEFAULT '',
    [Join_Date] DATETIME NOT NULL DEFAULT ((0)),
    [Sep_Date] DATETIME NOT NULL DEFAULT ((0)),
    [Emp_Region] VARCHAR(50) NOT NULL DEFAULT '',
    [Emp_Zone] VARCHAR(50) NOT NULL DEFAULT '',
    [Emp_Br_Region] VARCHAR(75) NULL DEFAULT '',
    [Emp_Br_Zone] VARCHAR(75) NULL DEFAULT '',
    [BH] VARCHAR(20) NOT NULL DEFAULT '',
    [CH] VARCHAR(20) NOT NULL DEFAULT '',
    [RH] VARCHAR(20) NOT NULL DEFAULT '',
    [ZH] VARCHAR(20) NOT NULL DEFAULT '',
    [RSM] VARCHAR(20) NOT NULL DEFAULT '',
    [ASM] VARCHAR(20) NOT NULL DEFAULT '',
    [AVP] VARCHAR(20) NOT NULL DEFAULT '',
    [SrAVP] VARCHAR(20) NOT NULL DEFAULT '',
    [VP] VARCHAR(20) NOT NULL DEFAULT '',
    [SrVP] VARCHAR(20) NOT NULL DEFAULT '',
    [SrAVPIT] VARCHAR(20) NOT NULL DEFAULT '',
    [HeadIT] VARCHAR(150) NULL DEFAULT '',
    [ADIT] VARCHAR(20) NOT NULL DEFAULT '',
    [ED] VARCHAR(20) NOT NULL DEFAULT '',
    [EDCFO] VARCHAR(20) NOT NULL DEFAULT '',
    [CSO] VARCHAR(20) NOT NULL DEFAULT '',
    [UpdateDate] DATETIME NOT NULL DEFAULT ((0)),
    [SrUpdateDate] DATETIME NOT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EmpTree_05feb2020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EmpTree_05feb2020]
(
    [Emp_Id] VARCHAR(20) NOT NULL,
    [Emp_Name] VARCHAR(150) NOT NULL,
    [Desig] VARCHAR(255) NOT NULL,
    [Senior] VARCHAR(20) NOT NULL,
    [Sr_Name] VARCHAR(150) NOT NULL,
    [Branch_Code] VARCHAR(100) NOT NULL,
    [Join_Date] DATETIME NOT NULL,
    [Sep_Date] DATETIME NOT NULL,
    [Emp_Region] VARCHAR(50) NOT NULL,
    [Emp_Zone] VARCHAR(50) NOT NULL,
    [Emp_Br_Region] VARCHAR(75) NULL,
    [Emp_Br_Zone] VARCHAR(75) NULL,
    [BH] VARCHAR(20) NOT NULL,
    [CH] VARCHAR(20) NOT NULL,
    [RH] VARCHAR(20) NOT NULL,
    [ZH] VARCHAR(20) NOT NULL,
    [RSM] VARCHAR(20) NOT NULL,
    [ASM] VARCHAR(20) NOT NULL,
    [AVP] VARCHAR(20) NOT NULL,
    [SrAVP] VARCHAR(20) NOT NULL,
    [VP] VARCHAR(20) NOT NULL,
    [SrVP] VARCHAR(20) NOT NULL,
    [SrAVPIT] VARCHAR(20) NOT NULL,
    [HeadIT] VARCHAR(150) NULL,
    [ADIT] VARCHAR(20) NOT NULL,
    [ED] VARCHAR(20) NOT NULL,
    [EDCFO] VARCHAR(20) NOT NULL,
    [CSO] VARCHAR(20) NOT NULL,
    [UpdateDate] DATETIME NOT NULL,
    [SrUpdateDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EmpTree_Arch
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EmpTree_Arch]
(
    [Emp_Id] VARCHAR(20) NOT NULL,
    [Emp_Name] VARCHAR(150) NOT NULL,
    [Desig] VARCHAR(255) NOT NULL,
    [Senior] VARCHAR(20) NOT NULL,
    [Sr_Name] VARCHAR(150) NOT NULL,
    [Branch_Code] VARCHAR(100) NOT NULL,
    [Join_Date] DATETIME NOT NULL,
    [Sep_Date] DATETIME NOT NULL,
    [Emp_Region] VARCHAR(50) NOT NULL,
    [Emp_Zone] VARCHAR(50) NOT NULL,
    [Emp_Br_Region] VARCHAR(50) NOT NULL,
    [Emp_Br_Zone] VARCHAR(50) NOT NULL,
    [BH] VARCHAR(20) NOT NULL,
    [CH] VARCHAR(20) NOT NULL,
    [RH] VARCHAR(20) NOT NULL,
    [ZH] VARCHAR(20) NOT NULL,
    [RSM] VARCHAR(20) NOT NULL,
    [ASM] VARCHAR(20) NOT NULL,
    [AVP] VARCHAR(20) NOT NULL,
    [SrAVP] VARCHAR(20) NOT NULL,
    [VP] VARCHAR(20) NOT NULL,
    [SrVP] VARCHAR(20) NOT NULL,
    [SrAVPIT] VARCHAR(20) NOT NULL,
    [HeadIT] VARCHAR(20) NOT NULL,
    [ADIT] VARCHAR(20) NOT NULL,
    [ED] VARCHAR(20) NOT NULL,
    [EDCFO] VARCHAR(20) NOT NULL,
    [CSO] VARCHAR(20) NOT NULL,
    [UpdateDate] DATETIME NOT NULL DEFAULT ((0)),
    [SrUpdateDate] DATETIME NOT NULL DEFAULT ((0)),
    [CreateDate] DATETIME NOT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EmpTree_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EmpTree_Log]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Process_Name] VARCHAR(50) NOT NULL,
    [Table_Name] VARCHAR(50) NOT NULL,
    [Records] INT NOT NULL,
    [Process_Time] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EmpTree_Prev
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EmpTree_Prev]
(
    [Emp_Id] VARCHAR(20) NOT NULL,
    [Emp_Name] VARCHAR(150) NOT NULL,
    [Desig] VARCHAR(255) NOT NULL,
    [Senior] VARCHAR(20) NOT NULL,
    [Sr_Name] VARCHAR(150) NOT NULL,
    [Branch_Code] VARCHAR(100) NOT NULL,
    [Join_Date] DATETIME NOT NULL,
    [Sep_Date] DATETIME NOT NULL,
    [Emp_Region] VARCHAR(50) NOT NULL,
    [Emp_Zone] VARCHAR(50) NOT NULL,
    [Emp_Br_Region] VARCHAR(50) NOT NULL,
    [Emp_Br_Zone] VARCHAR(50) NOT NULL,
    [BH] VARCHAR(20) NOT NULL,
    [CH] VARCHAR(20) NOT NULL,
    [RH] VARCHAR(20) NOT NULL,
    [ZH] VARCHAR(20) NOT NULL,
    [RSM] VARCHAR(20) NOT NULL,
    [ASM] VARCHAR(20) NOT NULL,
    [AVP] VARCHAR(20) NOT NULL,
    [SrAVP] VARCHAR(20) NOT NULL,
    [VP] VARCHAR(20) NOT NULL,
    [SrVP] VARCHAR(20) NOT NULL,
    [SrAVPIT] VARCHAR(20) NOT NULL,
    [HeadIT] VARCHAR(20) NOT NULL,
    [ADIT] VARCHAR(20) NOT NULL,
    [ED] VARCHAR(20) NOT NULL,
    [EDCFO] VARCHAR(20) NOT NULL,
    [CSO] VARCHAR(20) NOT NULL,
    [UpdateDate] DATETIME NOT NULL,
    [SrUpdateDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IntegrationITAIOVMS
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IntegrationITAIOVMS]
(
    [IOVMS_RefNo] VARCHAR(MAX) NULL,
    [PurchaseOrderNo] VARCHAR(100) NULL,
    [Request_Id] VARCHAR(MAX) NULL,
    [Generated_By] VARCHAR(20) NULL,
    [Generated_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_AngelGroupofCompaniesMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_AngelGroupofCompaniesMaster]
(
    [CompId] INT NOT NULL,
    [compName] VARCHAR(50) NULL,
    [status] VARCHAR(20) NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_AngelGroupofCompaniesMaster_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_AngelGroupofCompaniesMaster_Log]
(
    [CompId] INT NULL,
    [compName] VARCHAR(50) NULL,
    [status] VARCHAR(20) NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_Taxes
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_Taxes]
(
    [Fld_RequestID] NVARCHAR(MAX) NULL,
    [Fld_Excise] FLOAT NULL,
    [Fld_Edn_Cess] FLOAT NULL,
    [Fld_CST] FLOAT NULL,
    [Fld_VAT] FLOAT NULL,
    [Fld_Service] FLOAT NULL,
    [Fld_Frieght] FLOAT NULL,
    [Fld_Octroi] FLOAT NULL,
    [Fld_Discount] FLOAT NULL,
    [Fld_Status] VARCHAR(10) NULL,
    [Generated_By] CHAR(20) NULL,
    [Generated_Date] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_Taxes_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_Taxes_log]
(
    [Fld_RequestID] NVARCHAR(MAX) NULL,
    [Fld_Excise] FLOAT NULL,
    [Fld_Edn_Cess] FLOAT NULL,
    [Fld_CST] FLOAT NULL,
    [Fld_VAT] FLOAT NULL,
    [Fld_Service] FLOAT NULL,
    [Fld_Frieght] FLOAT NULL,
    [Fld_Octroi] FLOAT NULL,
    [Fld_Discount] FLOAT NULL,
    [Fld_Status] VARCHAR(10) NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_vendormaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_vendormaster]
(
    [VendorCode] INT NOT NULL,
    [VendorName] VARCHAR(250) NULL,
    [Address1] VARCHAR(200) NULL,
    [Address2] VARCHAR(200) NULL,
    [Address3] VARCHAR(200) NULL,
    [Status] CHAR(2) NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL,
    [CompanyID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_vendormaster_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_vendormaster_Log]
(
    [VendorCode] INT NULL,
    [VendorName] VARCHAR(250) NULL,
    [Address1] VARCHAR(200) NULL,
    [Address2] VARCHAR(200) NULL,
    [Address3] VARCHAR(200) NULL,
    [Status] CHAR(2) NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL,
    [CompanyID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITAssestsRoleMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITAssestsRoleMaster]
(
    [Role_Id] CHAR(25) NOT NULL,
    [Role_Name] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITRequestCondition
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITRequestCondition]
(
    [Fld_srno] INT NOT NULL,
    [Fld_condition] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ItRequestPurchaseOrder
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ItRequestPurchaseOrder]
(
    [Fld_RequestId] NVARCHAR(MAX) NULL,
    [Fld_VendorId] INT NULL,
    [Fld_VendorName] VARCHAR(200) NULL,
    [Fld_PurchaseOrderNo] VARCHAR(100) NULL,
    [Fld_ShipTo] VARCHAR(500) NULL,
    [Fld_ShippingMethod] VARCHAR(500) NULL,
    [Fld_OrderTerms] VARCHAR(500) NULL,
    [Fld_DeliveryDate] DATETIME NULL,
    [Fld_CompID] INT NULL,
    [Fld_PId] INT NULL,
    [POBranch] VARCHAR(500) NULL,
    [PODeliveryTime] VARCHAR(500) NULL,
    [Generated_By] CHAR(20) NULL,
    [Generated_Date] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL,
    [PO_Status] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ItRequestPurchaseOrder_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ItRequestPurchaseOrder_Log]
(
    [Fld_RequestId] NVARCHAR(MAX) NULL,
    [Fld_VendorId] INT NULL,
    [Fld_VendorName] VARCHAR(200) NULL,
    [Fld_PurchaseOrderNo] VARCHAR(100) NULL,
    [Fld_ShipTo] VARCHAR(500) NULL,
    [Fld_ShippingMethod] VARCHAR(500) NULL,
    [Fld_OrderTerms] VARCHAR(500) NULL,
    [Fld_DeliveryDate] DATETIME NULL,
    [Fld_CompID] INT NULL,
    [Fld_PId] INT NULL,
    [POBranch] VARCHAR(500) NULL,
    [PODeliveryTime] VARCHAR(500) NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL,
    [PO_Status] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITUsers
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITUsers]
(
    [Emp_Id] CHAR(20) NOT NULL,
    [Access_Type] CHAR(20) NULL,
    [Application] CHAR(20) NULL,
    [Role] CHAR(5) NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITUsers_05feb2020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITUsers_05feb2020]
(
    [Emp_Id] CHAR(20) NOT NULL,
    [Access_Type] CHAR(20) NULL,
    [Application] CHAR(20) NULL,
    [Role] CHAR(5) NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITUsers_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITUsers_Log]
(
    [Emp_Id] CHAR(20) NULL,
    [Access_Type] CHAR(20) NULL,
    [Application] CHAR(20) NULL,
    [Role] CHAR(5) NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_JustificationMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_JustificationMaster]
(
    [Justification_Id] CHAR(10) NOT NULL,
    [Justification_Name] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ProductModelMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ProductModelMaster]
(
    [Model_Id] CHAR(20) NOT NULL,
    [Model_Name] VARCHAR(100) NOT NULL,
    [Product_Code] CHAR(20) NOT NULL,
    [Unit_Price] FLOAT NOT NULL,
    [Flag] BIT NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ProductModelMaster_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ProductModelMaster_Log]
(
    [Model_Id] CHAR(20) NULL,
    [Model_Name] VARCHAR(100) NULL,
    [Product_Code] CHAR(20) NULL,
    [Unit_Price] FLOAT NULL,
    [Flag] BIT NULL,
    [Added_By] CHAR(20) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_RecommanderMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_RecommanderMaster]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [Recommander] VARCHAR(25) NOT NULL,
    [Recommander_Email] VARCHAR(100) NOT NULL,
    [TypeOfRecommandation] VARCHAR(30) NOT NULL,
    [isdelete] INT NULL,
    [ModifiedOn] DATETIME NULL,
    [ModifiedBy] VARCHAR(30) NULL,
    [Recommander_Name] VARCHAR(60) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Recommendation_LimitMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Recommendation_LimitMaster]
(
    [U_Role] CHAR(100) NOT NULL,
    [Category] CHAR(20) NOT NULL,
    [Department] CHAR(150) NOT NULL,
    [Rec_LimitFrom] FLOAT NOT NULL,
    [Rec_LimitTo] FLOAT NOT NULL,
    [B_RecLimitFrom] FLOAT NOT NULL,
    [B_RecLimitTo] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Recommendation_LimitMaster_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Recommendation_LimitMaster_Log]
(
    [U_Role] CHAR(100) NOT NULL,
    [Category] CHAR(20) NOT NULL,
    [Department] CHAR(150) NOT NULL,
    [Rec_LimitFrom] FLOAT NOT NULL,
    [Rec_LimitTo] FLOAT NOT NULL,
    [B_RecLimitFrom] FLOAT NOT NULL,
    [B_RecLimitTo] FLOAT NOT NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Recommendation_LimitMaster_new
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Recommendation_LimitMaster_new]
(
    [U_Role] CHAR(100) NOT NULL,
    [Category] CHAR(20) NOT NULL,
    [Department] CHAR(150) NOT NULL,
    [Rec_LimitFrom] FLOAT NOT NULL,
    [Rec_LimitTo] FLOAT NOT NULL,
    [B_RecLimitFrom] FLOAT NOT NULL,
    [B_RecLimitTo] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RequestMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RequestMaster]
(
    [Request_Id] INT IDENTITY(1,1) NOT NULL,
    [IT_Engineer] CHAR(10) NULL,
    [Item_Code] CHAR(10) NOT NULL,
    [Model_No] CHAR(10) NOT NULL,
    [Model_Quantity] CHAR(10) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Requested_By] CHAR(10) NOT NULL,
    [User_Remark] VARCHAR(500) NULL,
    [AdminReq_ForBranch] NVARCHAR(255) NULL,
    [Recommended_By] CHAR(10) NULL,
    [Recommended_Datetime] DATETIME NULL,
    [Approved_By] CHAR(10) NULL,
    [Approved_Datetime] DATETIME NULL,
    [Justification_Id] CHAR(10) NULL,
    [CSO] BIT NOT NULL,
    [Status_Code] CHAR(10) NOT NULL,
    [Estimated_Total_Price] INT NULL,
    [Level1_Recommended_By] CHAR(10) NULL,
    [Level1_Recommended_Datetime] DATETIME NULL,
    [Level1_Approved_By] CHAR(10) NULL,
    [Level1_Approved_Datetime] DATETIME NULL,
    [Model_Quantity_Assigned] CHAR(10) NULL,
    [Req_CompletedBy] CHAR(20) NULL,
    [Req_CompletedDate] DATETIME NULL,
    [IT_Recommended_Name] VARCHAR(100) NULL,
    [ITHeadRemarks] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RequestMaster_02Apr2019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RequestMaster_02Apr2019]
(
    [Request_Id] INT IDENTITY(1,1) NOT NULL,
    [IT_Engineer] CHAR(10) NULL,
    [Item_Code] CHAR(10) NOT NULL,
    [Model_No] CHAR(10) NOT NULL,
    [Model_Quantity] CHAR(10) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Requested_By] CHAR(10) NOT NULL,
    [User_Remark] VARCHAR(500) NULL,
    [AdminReq_ForBranch] NVARCHAR(255) NULL,
    [Recommended_By] CHAR(10) NULL,
    [Recommended_Datetime] DATETIME NULL,
    [Approved_By] CHAR(10) NULL,
    [Approved_Datetime] DATETIME NULL,
    [Justification_Id] CHAR(10) NULL,
    [CSO] BIT NOT NULL,
    [Status_Code] CHAR(10) NOT NULL,
    [Estimated_Total_Price] INT NULL,
    [Level1_Recommended_By] CHAR(10) NULL,
    [Level1_Recommended_Datetime] DATETIME NULL,
    [Level1_Approved_By] CHAR(10) NULL,
    [Level1_Approved_Datetime] DATETIME NULL,
    [Model_Quantity_Assigned] CHAR(10) NULL,
    [Req_CompletedBy] CHAR(20) NULL,
    [Req_CompletedDate] DATETIME NULL,
    [IT_Recommended_Name] VARCHAR(100) NULL,
    [ITHeadRemarks] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RequestMaster_03sep2020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RequestMaster_03sep2020]
(
    [Request_Id] INT IDENTITY(1,1) NOT NULL,
    [IT_Engineer] CHAR(10) NULL,
    [Item_Code] CHAR(10) NOT NULL,
    [Model_No] CHAR(10) NOT NULL,
    [Model_Quantity] CHAR(10) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Requested_By] CHAR(10) NOT NULL,
    [User_Remark] VARCHAR(500) NULL,
    [AdminReq_ForBranch] NVARCHAR(255) NULL,
    [Recommended_By] CHAR(10) NULL,
    [Recommended_Datetime] DATETIME NULL,
    [Approved_By] CHAR(10) NULL,
    [Approved_Datetime] DATETIME NULL,
    [Justification_Id] CHAR(10) NULL,
    [CSO] BIT NOT NULL,
    [Status_Code] CHAR(10) NOT NULL,
    [Estimated_Total_Price] INT NULL,
    [Level1_Recommended_By] CHAR(10) NULL,
    [Level1_Recommended_Datetime] DATETIME NULL,
    [Level1_Approved_By] CHAR(10) NULL,
    [Level1_Approved_Datetime] DATETIME NULL,
    [Model_Quantity_Assigned] CHAR(10) NULL,
    [Req_CompletedBy] CHAR(20) NULL,
    [Req_CompletedDate] DATETIME NULL,
    [IT_Recommended_Name] VARCHAR(100) NULL,
    [ITHeadRemarks] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_requestmaster_11Mar2019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_requestmaster_11Mar2019]
(
    [Request_Id] INT IDENTITY(1,1) NOT NULL,
    [IT_Engineer] CHAR(10) NULL,
    [Item_Code] CHAR(10) NOT NULL,
    [Model_No] CHAR(10) NOT NULL,
    [Model_Quantity] CHAR(10) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Requested_By] CHAR(10) NOT NULL,
    [User_Remark] VARCHAR(500) NULL,
    [AdminReq_ForBranch] NVARCHAR(255) NULL,
    [Recommended_By] CHAR(10) NULL,
    [Recommended_Datetime] DATETIME NULL,
    [Approved_By] CHAR(10) NULL,
    [Approved_Datetime] DATETIME NULL,
    [Justification_Id] CHAR(10) NULL,
    [CSO] BIT NOT NULL,
    [Status_Code] CHAR(10) NOT NULL,
    [Estimated_Total_Price] INT NULL,
    [Level1_Recommended_By] CHAR(10) NULL,
    [Level1_Recommended_Datetime] DATETIME NULL,
    [Level1_Approved_By] CHAR(10) NULL,
    [Level1_Approved_Datetime] DATETIME NULL,
    [Model_Quantity_Assigned] CHAR(10) NULL,
    [Req_CompletedBy] CHAR(20) NULL,
    [Req_CompletedDate] DATETIME NULL,
    [IT_Recommended_Name] VARCHAR(100) NULL,
    [ITHeadRemarks] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_requestmaster_12Mar2019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_requestmaster_12Mar2019]
(
    [Request_Id] INT IDENTITY(1,1) NOT NULL,
    [IT_Engineer] CHAR(10) NULL,
    [Item_Code] CHAR(10) NOT NULL,
    [Model_No] CHAR(10) NOT NULL,
    [Model_Quantity] CHAR(10) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Requested_By] CHAR(10) NOT NULL,
    [User_Remark] VARCHAR(500) NULL,
    [AdminReq_ForBranch] NVARCHAR(255) NULL,
    [Recommended_By] CHAR(10) NULL,
    [Recommended_Datetime] DATETIME NULL,
    [Approved_By] CHAR(10) NULL,
    [Approved_Datetime] DATETIME NULL,
    [Justification_Id] CHAR(10) NULL,
    [CSO] BIT NOT NULL,
    [Status_Code] CHAR(10) NOT NULL,
    [Estimated_Total_Price] INT NULL,
    [Level1_Recommended_By] CHAR(10) NULL,
    [Level1_Recommended_Datetime] DATETIME NULL,
    [Level1_Approved_By] CHAR(10) NULL,
    [Level1_Approved_Datetime] DATETIME NULL,
    [Model_Quantity_Assigned] CHAR(10) NULL,
    [Req_CompletedBy] CHAR(20) NULL,
    [Req_CompletedDate] DATETIME NULL,
    [IT_Recommended_Name] VARCHAR(100) NULL,
    [ITHeadRemarks] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_requestmaster_19Mar2019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_requestmaster_19Mar2019]
(
    [Request_Id] INT IDENTITY(1,1) NOT NULL,
    [IT_Engineer] CHAR(10) NULL,
    [Item_Code] CHAR(10) NOT NULL,
    [Model_No] CHAR(10) NOT NULL,
    [Model_Quantity] CHAR(10) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Requested_By] CHAR(10) NOT NULL,
    [User_Remark] VARCHAR(500) NULL,
    [AdminReq_ForBranch] NVARCHAR(255) NULL,
    [Recommended_By] CHAR(10) NULL,
    [Recommended_Datetime] DATETIME NULL,
    [Approved_By] CHAR(10) NULL,
    [Approved_Datetime] DATETIME NULL,
    [Justification_Id] CHAR(10) NULL,
    [CSO] BIT NOT NULL,
    [Status_Code] CHAR(10) NOT NULL,
    [Estimated_Total_Price] INT NULL,
    [Level1_Recommended_By] CHAR(10) NULL,
    [Level1_Recommended_Datetime] DATETIME NULL,
    [Level1_Approved_By] CHAR(10) NULL,
    [Level1_Approved_Datetime] DATETIME NULL,
    [Model_Quantity_Assigned] CHAR(10) NULL,
    [Req_CompletedBy] CHAR(20) NULL,
    [Req_CompletedDate] DATETIME NULL,
    [IT_Recommended_Name] VARCHAR(100) NULL,
    [ITHeadRemarks] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RequestMaster_new
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RequestMaster_new]
(
    [Request_Id] INT IDENTITY(1,1) NOT NULL,
    [IT_Engineer] CHAR(10) NULL,
    [Item_Code] CHAR(10) NOT NULL,
    [Model_No] CHAR(10) NOT NULL,
    [Model_Quantity] CHAR(10) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Requested_By] CHAR(10) NOT NULL,
    [User_Remark] VARCHAR(500) NULL,
    [AdminReq_ForBranch] NVARCHAR(255) NULL,
    [Recommended_By] CHAR(10) NULL,
    [Recommended_Datetime] DATETIME NULL,
    [Approved_By] CHAR(10) NULL,
    [Approved_Datetime] DATETIME NULL,
    [Justification_Id] CHAR(10) NULL,
    [CSO] BIT NOT NULL,
    [Status_Code] CHAR(10) NOT NULL,
    [Estimated_Total_Price] INT NULL,
    [Level1_Recommended_By] CHAR(10) NULL,
    [Level1_Recommended_Datetime] DATETIME NULL,
    [Level1_Approved_By] CHAR(10) NULL,
    [Level1_Approved_Datetime] DATETIME NULL,
    [Model_Quantity_Assigned] CHAR(10) NULL,
    [Req_CompletedBy] CHAR(20) NULL,
    [Req_CompletedDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RequestMaster04jan2018
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RequestMaster04jan2018]
(
    [Request_Id] INT IDENTITY(1,1) NOT NULL,
    [IT_Engineer] CHAR(10) NULL,
    [Item_Code] CHAR(10) NOT NULL,
    [Model_No] CHAR(10) NOT NULL,
    [Model_Quantity] CHAR(10) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Requested_By] CHAR(10) NOT NULL,
    [User_Remark] VARCHAR(500) NULL,
    [AdminReq_ForBranch] NVARCHAR(255) NULL,
    [Recommended_By] CHAR(10) NULL,
    [Recommended_Datetime] DATETIME NULL,
    [Approved_By] CHAR(10) NULL,
    [Approved_Datetime] DATETIME NULL,
    [Justification_Id] CHAR(10) NULL,
    [CSO] BIT NOT NULL,
    [Status_Code] CHAR(10) NOT NULL,
    [Estimated_Total_Price] INT NULL,
    [Level1_Recommended_By] CHAR(10) NULL,
    [Level1_Recommended_Datetime] DATETIME NULL,
    [Level1_Approved_By] CHAR(10) NULL,
    [Level1_Approved_Datetime] DATETIME NULL,
    [Model_Quantity_Assigned] CHAR(10) NULL,
    [Req_CompletedBy] CHAR(20) NULL,
    [Req_CompletedDate] DATETIME NULL,
    [IT_Recommended_Name] VARCHAR(100) NULL,
    [ITHeadRemarks] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RequestRecApr
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RequestRecApr]
(
    [Request_Id] INT NULL,
    [Emp_Code] VARCHAR(25) NULL,
    [Role] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RequestRecApr_04feb2020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RequestRecApr_04feb2020]
(
    [Request_Id] INT NULL,
    [Emp_Code] VARCHAR(25) NULL,
    [Role] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RequestRecApr_16042019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RequestRecApr_16042019]
(
    [Request_Id] INT NULL,
    [Emp_Code] VARCHAR(25) NULL,
    [Role] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RequestRecApr_22Apr2019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RequestRecApr_22Apr2019]
(
    [Request_Id] INT NULL,
    [Emp_Code] VARCHAR(25) NULL,
    [Role] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RequestRecApr17Jan2019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RequestRecApr17Jan2019]
(
    [Request_Id] INT NULL,
    [Emp_Code] VARCHAR(25) NULL,
    [Role] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ReviewerMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ReviewerMaster]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [Reviewer] VARCHAR(25) NOT NULL,
    [Reviewer_Email] VARCHAR(100) NOT NULL,
    [TypeOfReviewer] VARCHAR(30) NOT NULL,
    [isdelete] INT NULL,
    [ModifiedOn] DATETIME NULL,
    [ModifiedBy] VARCHAR(30) NULL,
    [Reviewer_Name] VARCHAR(60) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ReviewRemarks
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ReviewRemarks]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [Request_Id] INT NULL,
    [Remark] VARCHAR(MAX) NULL,
    [ReviewDate] DATETIME NULL,
    [ReviewedBy] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_StatusMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_StatusMaster]
(
    [Status_Code] CHAR(10) NOT NULL,
    [Status_Name] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_stockInventoryDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_stockInventoryDetails]
(
    [Inventory_No] INT IDENTITY(1,1) NOT NULL,
    [Request_Id] INT NULL,
    [Product_Code] CHAR(10) NOT NULL,
    [Model_Id] CHAR(20) NOT NULL,
    [Vendor_Code] INT NOT NULL,
    [Added_BY] CHAR(10) NULL,
    [Added_On] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL,
    [Warranty_Type] CHAR(80) NULL,
    [Warranty_Fromdate] DATETIME NULL,
    [Warranty_Todate] DATETIME NULL,
    [Assign_Type] VARCHAR(100) NULL,
    [Assign_To] CHAR(20) NULL,
    [Assign_ToDept] VARCHAR(100) NULL,
    [Assign_ToBranch] VARCHAR(100) NULL,
    [Assign_Date] DATETIME NULL,
    [Assign_By] CHAR(20) NULL,
    [Status] CHAR(1) NULL,
    [Product_desc] VARCHAR(500) NULL,
    [Part_No] CHAR(20) NULL,
    [Unit_Price] FLOAT NULL,
    [Bill_No] CHAR(20) NULL,
    [Challan_No] CHAR(20) NULL,
    [Bill_Orderby] CHAR(20) NULL,
    [Bill_Orderdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_stockInventoryDetails_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_stockInventoryDetails_Log]
(
    [Inventory_No] INT NOT NULL,
    [Request_Id] INT NULL,
    [Product_Code] CHAR(10) NOT NULL,
    [Model_Id] CHAR(20) NOT NULL,
    [Vendor_Code] INT NOT NULL,
    [Warranty_Type] CHAR(80) NULL,
    [Warranty_Fromdate] DATETIME NULL,
    [Warranty_Todate] DATETIME NULL,
    [Assign_Type] VARCHAR(100) NULL,
    [Assign_To] CHAR(20) NULL,
    [Assign_ToDept] VARCHAR(100) NULL,
    [Assign_ToBranch] VARCHAR(100) NULL,
    [Assign_Date] DATETIME NULL,
    [Assign_By] CHAR(20) NULL,
    [Status] CHAR(1) NULL,
    [Product_desc] VARCHAR(500) NULL,
    [Part_No] CHAR(20) NULL,
    [Unit_Price] FLOAT NULL,
    [Bill_No] CHAR(20) NULL,
    [Challan_No] CHAR(20) NULL,
    [Bill_Orderby] CHAR(20) NULL,
    [Bill_Orderdate] DATETIME NULL,
    [Modified_By] CHAR(20) NULL,
    [Modified_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UserLimit
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UserLimit]
(
    [U_Role] CHAR(100) NOT NULL,
    [Category] CHAR(20) NOT NULL,
    [Department] CHAR(150) NOT NULL,
    [LimitFrom] FLOAT NOT NULL,
    [LimitTo] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Testemp
-- --------------------------------------------------
CREATE TABLE [dbo].[Testemp]
(
    [Emp_NO] VARCHAR(6) NULL,
    [EMP_NAME] VARCHAR(150) NULL,
    [Senior] VARCHAR(6) NULL,
    [Sr_name] VARCHAR(150) NULL,
    [Company] NVARCHAR(50) NULL,
    [SBU] VARCHAR(50) NULL,
    [Lob] INT NULL,
    [Zone] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Location] VARCHAR(50) NULL,
    [AttendanceLoc] VARCHAR(100) NULL,
    [Department] NVARCHAR(200) NULL,
    [Sub_Department] VARCHAR(150) NULL,
    [Designation] VARCHAR(255) NULL,
    [Location_Address] VARCHAR(5000) NULL,
    [LEVEL] VARCHAR(50) NULL,
    [categorydesc] VARCHAR(50) NULL,
    [Branch_Cd] NVARCHAR(255) NULL,
    [Join_Date] DATETIME NULL,
    [Separation_Date] DATETIME NULL,
    [emailadd] VARCHAR(100) NULL,
    [sex] VARCHAR(1) NULL,
    [BirthDate] DATETIME NULL,
    [PHONE] VARCHAR(50) NULL,
    [JOINDATE] DATETIME NULL,
    [STATUS] CHAR(1) NULL,
    [Address] VARCHAR(500) NULL,
    [City] VARCHAR(100) NULL,
    [State] NVARCHAR(25) NULL,
    [Account_No] VARCHAR(20) NULL,
    [pincode] VARCHAR(20) NULL,
    [Functional_Head] VARCHAR(500) NULL,
    [flgCSOBranch] NCHAR(6) NULL,
    [tpdlgcode] NVARCHAR(50) NULL,
    [LOBDESC] VARCHAR(100) NULL,
    [UpdDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VLMS_RolemasterEquity
-- --------------------------------------------------
CREATE TABLE [dbo].[VLMS_RolemasterEquity]
(
    [PID] INT NOT NULL,
    [biBranch] VARCHAR(510) NULL,
    [HarmonyCostCode] VARCHAR(510) NULL,
    [Zone] VARCHAR(100) NULL,
    [Region] VARCHAR(100) NULL,
    [costCodeHead] VARCHAR(510) NULL,
    [codeSpecification] VARCHAR(200) NULL,
    [commentsIfOthers] VARCHAR(510) NULL,
    [branchHead] VARCHAR(510) NULL,
    [clusterHead] VARCHAR(510) NULL,
    [regionalHead] VARCHAR(510) NULL,
    [regionalCommHead] VARCHAR(510) NULL,
    [zonalHead] VARCHAR(510) NULL,
    [franchiseeHead] VARCHAR(510) NULL,
    [comments] VARCHAR(500) NULL,
    [lastUpdatedEmpNo] VARCHAR(10) NULL,
    [lastUpdatedDate] DATETIME NULL,
    [lastUpdatedEmpNoComm] VARCHAR(50) NULL,
    [lastUpdatedDateComm] DATETIME NULL,
    [flgEquiComm] CHAR(10) NULL,
    [owner1] VARCHAR(10) NULL,
    [owner2] VARCHAR(10) NULL,
    [flgdel] BIT NULL,
    [hrmEmpNo] VARCHAR(50) NULL,
    [InsertionDate] DATETIME NULL,
    [BranchCoordinator] VARCHAR(100) NULL,
    [RegionalCoordinator] VARCHAR(100) NULL,
    [RegionalSalesManager] VARCHAR(100) NULL,
    [Shared resource cord] VARCHAR(100) NULL,
    [Area Sales Manager] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.bobranch
-- --------------------------------------------------
CREATE view bobranch  
  as  
    select BRANCH_CODE,BRANCH,Long_Name,Address1,Address2,City,State,Nation,Zip,Phone1,Phone2,Fax,Email,Remote,Security_Net,Money_Net,Excise_Reg,Contact_Person,prefix=''  
    from  risk.dbo.branches with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.tbl_CSO_Branch_test1
-- --------------------------------------------------
create view [tbl_CSO_Branch_test1]
as
select * from [tbl_CSO_Branch]

GO

